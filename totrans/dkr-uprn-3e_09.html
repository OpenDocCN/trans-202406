<html><head></head><body><section data-pdf-bookmark="Chapter 8. Exploring Docker Compose" data-type="chapter" epub:type="chapter"><div class="chapter" id="docker_compose">&#13;
<h1><span class="label">Chapter 8. </span>Exploring Docker Compose</h1>&#13;
&#13;
&#13;
<p>At this point, you should<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="about multiple-container projects" data-type="indexterm" id="idm46803140876992"/><a data-primary="Linux containers" data-secondary="multiple-container projects" data-seealso="Docker Compose" data-type="indexterm" id="idm46803140875904"/><a data-primary="Compose" data-see="Docker Compose" data-type="indexterm" id="idm46803140874816"/> have a good feel for the <code>docker</code> command and how to use it to build, launch, monitor, and debug your applications. Once you are comfortable working with individual containers, it won’t be long before you’ll want to share your projects and start building more complex projects that require multiple containers to function properly. This is particularly the case in development environments, where running a whole stack of containers can easily simulate many production environments on your local machine.</p>&#13;
&#13;
<p>If you’re running a whole stack of containers, however, every container needs to be run with the proper setup to ensure that the underlying application is configured correctly and will run as expected. Getting these settings correct every time can be challenging, especially when you are not the person who originally wrote the application. To help with this during development, people often resort to trying to write shell scripts that can build and run multiple containers consistently. Although this works, it can become difficult to understand for a newcomer and hard to maintain as the project changes over time. It’s also not necessarily repeatable between projects.</p>&#13;
&#13;
<p>To help address this problem,<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="about" data-type="indexterm" id="idm46803140872544"/><a data-primary="Docker Desktop" data-primary-sortas="docker-a" data-secondary="Docker Compose included" data-type="indexterm" id="idm46803140871296"/><a data-primary="documentation" data-secondary="Docker Compose" data-tertiary="installation" data-type="indexterm" id="idm46803140870080"/><a data-primary="resources online" data-secondary="Docker Compose documentation" data-tertiary="installation" data-type="indexterm" id="idm46803140868864"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="documentation" data-tertiary="installation" data-type="indexterm" id="idm46803140867584"/> Docker, Inc., released a tool primarily aimed at developers called Docker Compose. This tool is included with Docker Desktop, but you can also install it by following the <a href="https://docs.docker.com/compose/install">online installation directions</a>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Docker Compose was originally<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="about" data-tertiary="version 1 versus version 2" data-type="indexterm" id="idm46803140864064"/><a data-primary="Go language" data-secondary="Docker Compose version 2" data-secondary-sortas="docker-a" data-type="indexterm" id="idm46803140862480"/><a data-primary="plug-ins for Docker" data-secondary="Docker Compose version 2" data-type="indexterm" id="idm46803140861248"/><a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="version" data-type="indexterm" id="idm46803140860288"/><a data-primary="version of Docker Compose displayed" data-type="indexterm" id="idm46803140859072"/> a separate application written in Python that was run using the command <code>docker-compose</code>. This command is referred to as Docker Compose version 1 and has recently been replaced with Docker Compose version 2. Docker Compose v2 was completely rewritten in Go, as a Docker client plug-in. If <code>docker compose version</code> returns a result, then you have the plug-in installed. If not, we highly recommend that you take a little time to install it now.</p>&#13;
</div>&#13;
&#13;
<p>Docker Compose is an incredibly useful tool that can streamline all sorts of development tasks that have traditionally been very cumbersome and error prone. It can easily be leveraged to help developers quickly spin up complicated application stacks, compile applications without the need for setting up complex local development environments, and much more.</p>&#13;
&#13;
<p>In this chapter, we’ll do a run-through of how to use Compose to its best advantage. <a data-primary="Git" data-secondary="cloning a Git repository" data-tertiary="Compose examples" data-type="indexterm" id="idm46803140856624"/><a data-primary="cloning a Git repository" data-secondary="Compose examples" data-type="indexterm" id="idm46803140855408"/><a data-primary="Rocket.Chat" data-secondary="cloning Git repository" data-type="indexterm" id="idm46803140854448"/><a data-primary="MongoDB datastore" data-secondary="cloning Git repository" data-type="indexterm" id="idm46803140853504"/><a data-primary="ChatOps (Hubot)" data-secondary="cloning Git repository" data-type="indexterm" id="idm46803140852560"/><a data-primary="Hubot ChatOps" data-secondary="cloning Git repository" data-type="indexterm" id="idm46803140851616"/>We’ll be using a GitHub repository in all of the following examples. If you want to run the examples as we go through them, you should run the following command to download the code, if you didn’t already do that in <a data-type="xref" href="ch06.html#exploring_docker">Chapter 6</a>:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>git<code class="w"> </code>clone<code class="w"> </code>https://github.com/spkane/rocketchat-hubot-demo.git<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--config<code class="w"> </code>core.autocrlf<code class="o">=</code>input<code class="w"/></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>In the example, shell script and <em>docker-compose.yaml</em> files below some lines have been truncated to fit in the margins. Make sure that you use the files from this Git repository if you plan to try these examples yourself.</p>&#13;
</div>&#13;
&#13;
<p>This repository contains the configuration we’ll need to launch a complete web service that includes a MongoDB datastore, the open source Rocket.Chat communications server, a Hubot <a href="https://goo.gl/hKT3QW">ChatOps</a> bot, and a <code>zmachine-api</code> instance for a little surprise entertainment value.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Configuring Docker Compose" data-type="sect1"><div class="sect1" id="idm46803140826016">&#13;
<h1>Configuring Docker Compose</h1>&#13;
&#13;
<p>Before we dive into using the <code>docker compose</code> command,<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="shell scripting versus Compose" data-type="indexterm" id="ch08-shellvs"/><a data-primary="shell scripting versus Compose" data-type="indexterm" id="ch08-shellvs2"/> it is useful to see the kind of ad hoc tooling it replaces. So let’s take a moment to look at a shell script that could be used to build and deploy a local copy of our service for development and local testing via Docker. This output is long and detailed, but it’s important to prove the point about why Docker Compose is a huge leap over shell scripting.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>We do not recommend running this shell script. It is simply an example, and in your environment, it may not work or may leave things in an odd state.</p>&#13;
</div>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="ch">#!/bin/bash</code>&#13;
&#13;
<code class="c1"># This is here just to keep people from really running this.</code>&#13;
<code class="nb">exit</code><code class="w"> </code><code class="m">1</code><code class="w"/>&#13;
&#13;
<code class="c1"># The actual script</code>&#13;
<code class="c1">#</code>&#13;
<code class="c1"># Note: This has not been updated to directly mirror the docker-compose file</code>&#13;
<code class="c1">#       since it is just intended to make a point.</code>&#13;
&#13;
<code class="nb">set</code><code class="w"> </code>-e<code class="w"/>&#13;
<code class="nb">set</code><code class="w"> </code>-u<code class="w"/>&#13;
&#13;
<code class="k">if</code><code class="w"> </code><code class="o">[</code><code class="w"> </code><code class="nv">$#</code><code class="w"> </code>-ne<code class="w"> </code><code class="m">0</code><code class="w"> </code><code class="o">]</code><code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"> </code><code class="o">[</code><code class="w"> </code><code class="si">${</code><code class="nv">1</code><code class="si">}</code><code class="w"> </code><code class="o">==</code><code class="w"> </code><code class="s2">"down"</code><code class="w"> </code><code class="o">]</code><code class="p">;</code><code class="w"> </code><code class="k">then</code><code class="w"/>&#13;
<code class="w">  </code>docker<code class="w"> </code>rm<code class="w"> </code>-f<code class="w"> </code>hubot<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
<code class="w">  </code>docker<code class="w"> </code>rm<code class="w"> </code>-f<code class="w"> </code>zmachine<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
<code class="w">  </code>docker<code class="w"> </code>rm<code class="w"> </code>-f<code class="w"> </code>rocketchat<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
<code class="w">  </code>docker<code class="w"> </code>rm<code class="w"> </code>-f<code class="w"> </code>mongo-init-replica<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
<code class="w">  </code>docker<code class="w"> </code>rm<code class="w"> </code>-f<code class="w"> </code>mongo<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
<code class="w">  </code>docker<code class="w"> </code>network<code class="w"> </code>rm<code class="w"> </code>botnet<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
<code class="w">  </code><code class="nb">echo</code><code class="w"> </code><code class="s2">"Environment torn down…"</code><code class="w"/>&#13;
<code class="w">  </code><code class="nb">exit</code><code class="w"> </code><code class="m">0</code><code class="w"/>&#13;
<code class="k">fi</code><code class="w"/>&#13;
&#13;
<code class="c1"># Global Settings</code>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">PORT</code><code class="o">=</code><code class="s2">"3000"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">ROOT_URL</code><code class="o">=</code><code class="s2">"http://127.0.0.1:3000"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">MONGO_URL</code><code class="o">=</code><code class="s2">"mongodb://mongo:27017/rocketchat"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">MONGO_OPLOG_URL</code><code class="o">=</code><code class="s2">"mongodb://mongo:27017/local"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">MAIL_URL</code><code class="o">=</code><code class="s2">"smtp://smtp.email"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">RESPOND_TO_DM</code><code class="o">=</code><code class="s2">"true"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">HUBOT_ALIAS</code><code class="o">=</code><code class="s2">". "</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">LISTEN_ON_ALL_PUBLIC</code><code class="o">=</code><code class="s2">"true"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">ROCKETCHAT_AUTH</code><code class="o">=</code><code class="s2">"password"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">ROCKETCHAT_URL</code><code class="o">=</code><code class="s2">"rocketchat:3000"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">ROCKETCHAT_ROOM</code><code class="o">=</code><code class="s2">""</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">ROCKETCHAT_USER</code><code class="o">=</code><code class="s2">"hubot"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">ROCKETCHAT_PASSWORD</code><code class="o">=</code><code class="s2">"bot-pw!"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">BOT_NAME</code><code class="o">=</code><code class="s2">"bot"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">EXTERNAL_SCRIPTS</code><code class="o">=</code><code class="s2">"hubot-help,hubot-diagnostics,hubot-zmachine"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">HUBOT_ZMACHINE_SERVER</code><code class="o">=</code><code class="s2">"http://zmachine:80"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">HUBOT_ZMACHINE_ROOMS</code><code class="o">=</code><code class="s2">"zmachine"</code><code class="w"/>&#13;
<code class="nb">export</code><code class="w"> </code><code class="nv">HUBOT_ZMACHINE_OT_PREFIX</code><code class="o">=</code><code class="s2">"ot"</code><code class="w"/>&#13;
&#13;
docker<code class="w"> </code>build<code class="w"> </code>-t<code class="w"> </code>spkane/mongo:4.4<code class="w"> </code>./mongodb/docker<code class="w"/>&#13;
&#13;
docker<code class="w"> </code>push<code class="w"> </code>spkane/mongo:4.4<code class="w"/>&#13;
docker<code class="w"> </code>pull<code class="w"> </code>spkane/zmachine-api:latest<code class="w"/>&#13;
docker<code class="w"> </code>pull<code class="w"> </code>rocketchat/rocket.chat:5.0.4<code class="w"/>&#13;
docker<code class="w"> </code>pull<code class="w"> </code>rocketchat/hubot-rocketchat:latest<code class="w"/>&#13;
&#13;
docker<code class="w"> </code>rm<code class="w"> </code>-f<code class="w"> </code>hubot<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
docker<code class="w"> </code>rm<code class="w"> </code>-f<code class="w"> </code>zmachine<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
docker<code class="w"> </code>rm<code class="w"> </code>-f<code class="w"> </code>rocketchat<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
docker<code class="w"> </code>rm<code class="w"> </code>-f<code class="w"> </code>mongo-init-replica<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
docker<code class="w"> </code>rm<code class="w"> </code>-f<code class="w"> </code>mongo<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
&#13;
docker<code class="w"> </code>network<code class="w"> </code>rm<code class="w"> </code>botnet<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
&#13;
docker<code class="w"> </code>network<code class="w"> </code>create<code class="w"> </code>-d<code class="w"> </code>bridge<code class="w"> </code>botnet<code class="w"/>&#13;
&#13;
docker<code class="w"> </code>container<code class="w"> </code>run-d<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--name<code class="o">=</code>mongo<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--network<code class="o">=</code>botnet<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--restart<code class="w"> </code>unless-stopped<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-v<code class="w"> </code><code class="k">$(</code><code class="nb">pwd</code><code class="k">)</code>/mongodb/data/db:/data/db<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>spkane/mongo:4.4<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>mongod<code class="w"> </code>--oplogSize<code class="w"> </code><code class="m">128</code><code class="w"> </code>--replSet<code class="w"> </code>rs0<code class="w"/>&#13;
sleep<code class="w"> </code><code class="m">5</code><code class="w"/>&#13;
docker<code class="w"> </code>container<code class="w"> </code>run-d<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--name<code class="o">=</code>mongo-init-replica<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--network<code class="o">=</code>botnet<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>spkane/mongo:4.4<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code><code class="s1">'mongo mongo/rocketchat --eval "rs.initiate({ _id: ''rs0'', members: [ { … '</code><code class="w"/>&#13;
sleep<code class="w"> </code><code class="m">5</code><code class="w"/>&#13;
docker<code class="w"> </code>container<code class="w"> </code>run-d<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--name<code class="o">=</code>rocketchat<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--network<code class="o">=</code>botnet<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--restart<code class="w"> </code>unless-stopped<code class="w">  </code><code class="se">\</code>&#13;
<code class="w">  </code>-v<code class="w"> </code><code class="k">$(</code><code class="nb">pwd</code><code class="k">)</code>/rocketchat/data/uploads:/app/uploads<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-p<code class="w"> </code><code class="m">3000</code>:3000<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">PORT</code><code class="o">=</code><code class="si">${</code><code class="nv">PORT</code><code class="si">}</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">ROOT_URL</code><code class="o">=</code><code class="si">${</code><code class="nv">ROOT_URL</code><code class="si">}</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">MONGO_URL</code><code class="o">=</code><code class="si">${</code><code class="nv">MONGO_URL</code><code class="si">}</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">MONGO_OPLOG_URL</code><code class="o">=</code><code class="si">${</code><code class="nv">MONGO_OPLOG_URL</code><code class="si">}</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">MAIL_URL</code><code class="o">=</code><code class="si">${</code><code class="nv">MAIL_URL</code><code class="si">}</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>rocketchat/rocket.chat:5.0.4<code class="w"/>&#13;
docker<code class="w"> </code>container<code class="w"> </code>run-d<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--name<code class="o">=</code>zmachine<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--network<code class="o">=</code>botnet<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--restart<code class="w"> </code>unless-stopped<code class="w">  </code><code class="se">\</code>&#13;
<code class="w">  </code>-v<code class="w"> </code><code class="k">$(</code><code class="nb">pwd</code><code class="k">)</code>/zmachine/saves:/root/saves<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-v<code class="w"> </code><code class="k">$(</code><code class="nb">pwd</code><code class="k">)</code>/zmachine/zcode:/root/zcode<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-p<code class="w"> </code><code class="m">3002</code>:80<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>spkane/zmachine-api:latest<code class="w"/>&#13;
docker<code class="w"> </code>container<code class="w"> </code>run-d<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--name<code class="o">=</code>hubot<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--network<code class="o">=</code>botnet<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--restart<code class="w"> </code>unless-stopped<code class="w">  </code><code class="se">\</code>&#13;
<code class="w">  </code>-v<code class="w"> </code><code class="k">$(</code><code class="nb">pwd</code><code class="k">)</code>/hubot/scripts:/home/hubot/scripts<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-p<code class="w"> </code><code class="m">3001</code>:8080<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">RESPOND_TO_DM</code><code class="o">=</code><code class="s2">"true"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">HUBOT_ALIAS</code><code class="o">=</code><code class="s2">". "</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">LISTEN_ON_ALL_PUBLIC</code><code class="o">=</code><code class="s2">"true"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">ROCKETCHAT_AUTH</code><code class="o">=</code><code class="s2">"password"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">ROCKETCHAT_URL</code><code class="o">=</code><code class="s2">"rocketchat:3000"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">ROCKETCHAT_ROOM</code><code class="o">=</code><code class="s2">""</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">ROCKETCHAT_USER</code><code class="o">=</code><code class="s2">"hubot"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">ROCKETCHAT_PASSWORD</code><code class="o">=</code><code class="s2">"bot-pw!"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">BOT_NAME</code><code class="o">=</code><code class="s2">"bot"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">EXTERNAL_SCRIPTS</code><code class="o">=</code><code class="s2">"hubot-help,hubot-diagnostics,hubot-zmachine"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">HUBOT_ZMACHINE_SERVER</code><code class="o">=</code><code class="s2">"http://zmachine:80"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">HUBOT_ZMACHINE_ROOMS</code><code class="o">=</code><code class="s2">"zmachine"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>-e<code class="w"> </code><code class="nv">HUBOT_ZMACHINE_OT_PREFIX</code><code class="o">=</code><code class="s2">"ot"</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>rocketchat/hubot-rocketchat:latest<code class="w"/>&#13;
<code class="nb">echo</code><code class="w"> </code><code class="s2">"Environment setup…"</code><code class="w"/>&#13;
<code class="nb">exit</code><code class="w"> </code><code class="m">0</code><code class="w"/></pre>&#13;
&#13;
<p>At this point, you can probably follow most of this script pretty easily. As you may already have noticed, this is a hassle to read, is not very flexible, will be a pain to edit, and might fail unexpectedly in several places. If we were to follow shell script best practices and handle all the possible errors here in an effort to guarantee that it was repeatable, it would also be two to three times as long as it already is. Without a lot of work extracting common functionality for error handling, you’d also have to rewrite much of that logic every time you have a new project like this. This is not a very good way to approach a process that you need to work every time you use it. This is where good tooling comes in. You can accomplish the same thing with Docker Compose while also making it significantly more repeatable and easier to read, understand, and maintain.</p>&#13;
&#13;
<p>In contrast to this messy shell script,<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="configuring" data-type="indexterm" id="ch08-conf"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="configuring" data-tertiary="docker-compose.yaml" data-type="indexterm" id="ch08-conf2"/><a data-primary="docker-compose.yaml" data-primary-sortas="docker-z" data-type="indexterm" id="ch08-conf3"/><a data-primary="MongoDB datastore" data-secondary="docker-compose.yaml" data-type="indexterm" id="ch08-conf4"/><a data-primary="Rocket.Chat" data-secondary="configuration management" data-tertiary="docker-compose.yaml" data-type="indexterm" id="ch08-conf5"/><a data-primary="ChatOps (Hubot)" data-secondary="docker-compose.yaml" data-type="indexterm" id="ch08-conf6"/><a data-primary="Hubot ChatOps" data-secondary="docker-compose.yaml" data-type="indexterm" id="ch08-conf7"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="docker-compose.yaml" data-type="indexterm" id="ch08-conf8"/><a data-primary="YAML files for Compose configuration" data-seealso="docker-compose.yaml" data-type="indexterm" id="idm46803139974640"/> which is very repetitive and prone to breaking, Docker Compose is typically configured with a single, declarative <a href="https://yaml.org">YAML</a> file for each project, named <em>docker-compose.yaml</em>. This configuration file is very easy to read and will work in a very repeatable fashion so that each user has the same experience when they run it. Here you can see an example <em>docker-compose.yaml</em> file that could be used to replace the preceding brittle shell script:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="s">'3'</code><code class="w"/>&#13;
<code class="nt">services</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">mongo</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">build</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">context</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">../mongodb/docker</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">spkane/mongo:4.4</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">restart</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">unless-stopped</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">environment</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_REPLICA_SET_MODE</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">primary</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_REPLICA_SET_NAME</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">rs0</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_PORT_NUMBER</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">27017</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_INITIAL_PRIMARY_HOST</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mongodb</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_INITIAL_PRIMARY_PORT_NUMBER</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">27017</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_ADVERTISED_HOSTNAME</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mongo</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_ENABLE_JOURNAL</code><code class="p">:</code><code class="w"> </code><code class="s">"true"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ALLOW_EMPTY_PASSWORD</code><code class="p">:</code><code class="w"> </code><code class="s">"yes"</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1"># Port 27017 already exposed by upstream</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1"># See the newer upstream Dockerfile:</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1"># https://github.com/bitnami/containers/blob/</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1"># f9fb3f8a6323fb768fd488c77d4f111b1330bd0e/bitnami/</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1"># mongodb/5.0/debian-11/Dockerfile#L52</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">networks</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">botnet</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">rocketchat</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">rocketchat/rocket.chat:5.0.4</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">restart</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">unless-stopped</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">traefik.enable</code><code class="p">:</code><code class="w"> </code><code class="s">"true"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">traefik.http.routers.rocketchat.rule</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Host(`127.0.0.1`)</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">traefik.http.routers.rocketchat.tls</code><code class="p">:</code><code class="w"> </code><code class="s">"false"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">traefik.http.routers.rocketchat.entrypoints</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">volumes</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"../rocketchat/data/uploads:/app/uploads"</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">environment</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROOT_URL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http://127.0.0.1:3000</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">PORT</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">3000</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGO_URL</code><code class="p">:</code><code class="w"> </code><code class="s">"mongodb://mongo:27017/rocketchat?replicaSet=rs0"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGO_OPLOG_URL</code><code class="p">:</code><code class="w"> </code><code class="s">"mongodb://mongo:27017/local?replicaSet=rs0"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">DEPLOY_METHOD</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">docker</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">depends_on</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">mongo</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">service_healthy</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">3000:3000</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">networks</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">botnet</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">zmachine</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">spkane/zmachine-api:latest</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">restart</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">unless-stopped</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">volumes</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"../zmachine/saves:/root/saves"</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"../zmachine/zcode:/root/zcode"</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">depends_on</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">rocketchat</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">expose</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"80"</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">networks</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">botnet</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">hubot</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">rocketchat/hubot-rocketchat:latest</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">restart</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">unless-stopped</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">volumes</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"../hubot/scripts:/home/hubot/scripts"</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">environment</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">RESPOND_TO_DM</code><code class="p">:</code><code class="w"> </code><code class="s">"true"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ALIAS</code><code class="p">:</code><code class="w"> </code><code class="s">".</code><code class="nv"> </code><code class="s">"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">LISTEN_ON_ALL_PUBLIC</code><code class="p">:</code><code class="w"> </code><code class="s">"true"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_AUTH</code><code class="p">:</code><code class="w"> </code><code class="s">"password"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_URL</code><code class="p">:</code><code class="w"> </code><code class="s">"rocketchat:3000"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_ROOM</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_USER</code><code class="p">:</code><code class="w"> </code><code class="s">"hubot"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_PASSWORD</code><code class="p">:</code><code class="w"> </code><code class="s">"bot-pw!"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">BOT_NAME</code><code class="p">:</code><code class="w"> </code><code class="s">"bot"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">EXTERNAL_SCRIPTS</code><code class="p">:</code><code class="w"> </code><code class="s">"hubot-help,hubot-diagnostics,hubot-zmachine"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ZMACHINE_SERVER</code><code class="p">:</code><code class="w"> </code><code class="s">"http://zmachine:80"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ZMACHINE_ROOMS</code><code class="p">:</code><code class="w"> </code><code class="s">"zmachine"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ZMACHINE_OT_PREFIX</code><code class="p">:</code><code class="w"> </code><code class="s">"ot"</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">depends_on</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">zmachine</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">3001:8080</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">networks</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">botnet</code><code class="w"/>&#13;
<code class="nt">networks</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">botnet</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">driver</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bridge</code><code class="w"/></pre>&#13;
&#13;
<p>The <em>docker-compose.yaml</em> file makes it easy to describe all the important requirements for each of your services and how they need to communicate with one another. And we get a lot of validation and logic checking for free that we didn’t even have time to write into our shell script and that we’d probably get wrong on occasion, no matter how careful we are.</p>&#13;
&#13;
<p>So, what did we tell Compose to do in that YAML file? The first line of our file simply tells Docker Compose what version of the <a href="https://docs.docker.com/compose/compose-file">Compose configuration language</a> this file was designed for:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="s">'3'</code><code class="w"/></pre>&#13;
&#13;
<p>The rest of our document is divided into two sections: <code>services</code> and <code>networks</code>.</p>&#13;
&#13;
<p>For starters, let’s take a quick look at the <code>networks</code> section. In this <em>docker-compose.yaml</em> file, we are defining a single, named Docker network:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">networks</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">botnet</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">driver</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bridge</code><code class="w"/></pre>&#13;
&#13;
<p>This is a very simple configuration that tells Docker Compose to create a single network, named <code>botnet</code>, using the (default) bridge driver, which will bridge the Docker network with the host’s networking stack.</p>&#13;
&#13;
<p>The <code>services</code> section is the most important part of the configuration and tells Docker Compose what applications you want to launch. Here, the <code>services</code> section defines five services: <code>mongo</code>, <code>mongo-init-replica</code>, <code>rocketchat</code>, <code>zmachine</code>, and <code>hubot</code>. Each named service then contains sections that tell Docker how to build, configure, and launch that service.</p>&#13;
&#13;
<p>If you take a look at the <code>mongo</code> service, you will see that the first subsection is called <code>build</code> and contains a <code>context</code> key. This informs Docker Compose that it can build this image and that the files required for the build are located in the <em>../../mongodb/docker</em> directory, which is two levels above the directory containing the <em>docker-compose.yaml</em> file:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">build</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">context</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">../../mongodb/docker</code><code class="w"/></pre>&#13;
&#13;
<p>If you look at the <em>Dockerfile</em> in the <em>mongodb/docker</em> directory, you will see this:</p>&#13;
&#13;
<pre data-code-language="docker" data-type="programlisting"><code class="k">FROM</code><code class="w"> </code><code class="s">mongo:4.4</code><code class="w"/>&#13;
&#13;
<code class="k">COPY</code><code class="w"> </code>docker-healthcheck<code class="w"> </code>/usr/local/bin/<code class="w"/>&#13;
&#13;
<code class="c"># Useful Information:</code><code class="w"/>&#13;
<code class="c"># https://docs.docker.com/engine/reference/builder/#healthcheck</code><code class="w"/>&#13;
<code class="c"># https://docs.docker.com/compose/compose-file/#healthcheck</code><code class="w"/>&#13;
<code class="k">HEALTHCHECK</code><code class="w"> </code><code class="k">CMD</code><code class="w"> </code><code class="p">[</code><code class="s2">"docker-healthcheck"</code><code class="p">]</code><code class="w"/></pre>&#13;
&#13;
<p>Take a moment to look at the <code>HEALTHCHECK</code> line. This tells Docker  what command should be run to check the health of the container. Docker will not take action based on this health check, but it will report the health so that other things can make use of this information. If you are curious, feel free to take a look at the <code>docker-healthcheck</code> script in the <em>mongodb/docker</em> directory.</p>&#13;
&#13;
<p>The next setting, <code>image</code>, defines the image tag that you want either to apply to your build or to download (if you’re not building an image) and then run:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">spkane/mongo:4.4</code><code class="w"/></pre>&#13;
&#13;
<p>With the <code>restart</code> option, you tell Docker when you want it to restart your containers. In most cases, you’ll want Docker to restart your containers any time that you have not specifically stopped them:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">restart</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">unless-stopped</code><code class="w"/></pre>&#13;
&#13;
<p>Next, you will see an <code>environment</code> section. This is where you can define any environment variables that you want to pass into your container:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">environment</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_REPLICA_SET_MODE</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">primary</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_REPLICA_SET_NAME</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">rs0</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_PORT_NUMBER</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">27017</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_INITIAL_PRIMARY_HOST</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mongodb</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_INITIAL_PRIMARY_PORT_NUMBER</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">27017</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_ADVERTISED_HOSTNAME</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mongo</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">MONGODB_ENABLE_JOURNAL</code><code class="p">:</code><code class="w"> </code><code class="s">"true"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ALLOW_EMPTY_PASSWORD</code><code class="p">:</code><code class="w"> </code><code class="s">"yes"</code><code class="w"/></pre>&#13;
&#13;
<p>The final subsection for the <code>mongo</code> service, <code>networks</code>, tells Docker Compose which network this container should be attached to:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">networks</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">botnet</code><code class="w"/></pre>&#13;
&#13;
<p>At this point, let’s jump down to the <code>rocketchat</code> service. This service does not have a <code>build</code> subsection; instead, it only defines an image tag that tells Docker Compose that it cannot build this image and must instead try to pull and launch a preexisting Docker image with the defined tag.</p>&#13;
&#13;
<p>The first new subsection that you will notice in this service is called <code>volumes</code>.</p>&#13;
&#13;
<p>A lot of services have at least some data that should be persisted during development, despite the ephemeral nature of containers. To accomplish this, it is easiest to mount a local directory into the containers. The <code>volumes</code> section allows you to list all the local directories that you would like to have mounted into a container, and define where they go. This command will bind-mount <em>../rocketchat/data/uploads</em> into <em>/app/uploads</em> inside the container:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">volumes</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"../rocketchat/data/uploads:/app/uploads"</code><code class="w"/></pre>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>You may have noticed that we do not define a <code>volume</code> for MongoDB, which might seem a bit counterintuitive. Although a bind-mounted volume would be useful to store the database files in, MongoDB will fail to write to the native Windows filesystem, so we leave this out to achieve the broadest compatibility and instead let the database write into the container for this development use case.</p>&#13;
&#13;
<p>The primary result of this is that when you delete the container using a command like <code>docker compose down</code>, all of the data in the MongoDB instance will be lost.</p>&#13;
&#13;
<p>We could easily solve this MongoDB storage problem by using a <a href="https://docs.docker.com/storage/volumes/#create-and-manage-volumes">data volume container</a>, but this example is specifically using bind mounts for the volumes.</p>&#13;
</div>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>In almost all cases, you should not use host-based local storage for containers in production. This can be very convenient in development since you are using a single host, but in production, your containers will often be deployed to whatever node has space and resources, and will lose access to files stored on a single host’s filesystem. In production, if you need stateful storage, you have to leverage things like network-based storage, Kubernetes Persistent Volumes, etc.</p>&#13;
</div>&#13;
&#13;
<p>In the <code>environment</code> section for the <code>rocketchat</code> service, you will see that the value for the <code>MONGO_URL</code> does not use an IP address or fully qualified domain name. This is because all of these services are running on the same Docker network, and Docker Compose configures each container so that it can find the others via their service names. This means that we can easily configure URLs like this to simply point at the service name and internal port for the container we need to connect to. And, if we rearrange things, these names will continue to point to the right container in our stack. They are also nice because they make it quite explicit to the reader what the dependency is for that container:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">environment</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="l-Scalar-Plain">…</code><code class="w"/>&#13;
<code class="w">      </code><code class="l-Scalar-Plain">MONGO_URL</code><code class="p-Indicator">:</code><code class="w"> </code><code class="s">"mongodb://mongo:27017/rocketchat?replicaSet=rs0"</code><code class="w"/>&#13;
<code class="w">      </code><code class="l-Scalar-Plain">…</code><code class="w"/></pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>The <em>docker-compose.yaml</em> file can also refer to environment variables using the <code>${VARIABLE_NAME}</code> format, which makes it possible to pull in secrets without actually storing them in this file. Docker Compose also supports an <a href="https://docs.docker.com/compose/env-file"><em>.env</em></a> file, which can be very useful for handling secrets and environment variables that change between developers, for &#13;
<span class="keep-together">example.</span></p>&#13;
</div>&#13;
&#13;
<p>The <code>depends_on</code> section defines a container that must be running before this container can be started. By default, <code>docker compose</code> only ensures that the container is running, not that it is healthy; however, you can leverage the <code>HEALTHCHECK</code> functionality in Docker, and the condition statement in Docker Compose, to require that the dependent service be healthy before Docker Compose brings the new service up. It is important to remember that this only impacts startup. Docker will report services that become unhealthy later on, but it does not take any action to correct the situation unless the container exits, in which case, Docker will restart the container if it is configured to do so:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">depends_on</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">mongo</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">service_healthy</code><code class="w"/></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>We discuss Docker’s health-check functionality in more detail in <a data-type="xref" href="ch06.html#health_checks">“Container Health Checks”</a>. You can also find more information in the documentation for <a href="https://dockr.ly/2MYnLZL">Docker</a> and <a href="https://dockr.ly/2wt366J">Docker Compose</a>.</p>&#13;
</div>&#13;
&#13;
<p>The <code>ports</code> subsection allows you to define all the ports that you want to be mapped from the container to the host:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">3000:3000</code><code class="w"/></pre>&#13;
&#13;
<p>The <code>zmachine</code> service uses only one new subsection, called <code>expose</code>. This section allows us to tell Docker that we want to expose this port to the other containers on the Docker network but not to the underlying host. This is why you do not provide a host port to map this port to:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">expose</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"80"</code><code class="w"/></pre>&#13;
&#13;
<p>You might notice at this point that, while we expose a port for <code>zmachine</code>, we didn’t expose a port in the <code>mongo</code> service. It wouldn’t have hurt anything to expose the <code>mongo</code> port, but we didn’t need to because it is already exposed by the upstream <a href="https://github.com/docker-library/mongo/blob/58bdba62b65b1d1e1ea5cbde54c1682f120e0676/3.2/Dockerfile#L95"><code>mongo</code> <em>Dockerfile</em></a>. This is sometimes a little opaque. <code>docker image history</code> on the built image can be helpful here.</p>&#13;
&#13;
<p>Here we’ve used an example that is complex enough to expose you to some of the power of Docker Compose, but it is by no means exhaustive. There is a great deal else that you can configure in a <em>docker-compose.yaml</em> file, including security settings, resource quotas, and much more. <a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="documentation" data-tertiary="configuration" data-type="indexterm" id="idm46803138993424"/><a data-primary="documentation" data-secondary="Docker Compose" data-tertiary="configuration" data-type="indexterm" id="idm46803138991904"/><a data-primary="resources online" data-secondary="Docker Compose documentation" data-tertiary="configuration" data-type="indexterm" id="idm46803138990688"/>You can find a lot of detailed information about configuration for Compose in the <a href="https://docs.docker.com/compose/compose-file">official Docker Compose documentation</a>.<a data-startref="ch08-shellvs" data-type="indexterm" id="idm46803138988752"/><a data-startref="ch08-shellvs2" data-type="indexterm" id="idm46803138988048"/><a data-startref="ch08-conf" data-type="indexterm" id="idm46803138987376"/><a data-startref="ch08-conf2" data-type="indexterm" id="idm46803138986704"/><a data-startref="ch08-conf3" data-type="indexterm" id="idm46803138966672"/><a data-startref="ch08-conf4" data-type="indexterm" id="idm46803138966064"/><a data-startref="ch08-conf5" data-type="indexterm" id="idm46803138965456"/><a data-startref="ch08-conf6" data-type="indexterm" id="idm46803138964848"/><a data-startref="ch08-conf7" data-type="indexterm" id="idm46803138964240"/><a data-startref="ch08-conf8" data-type="indexterm" id="idm46803138963632"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Launching Services" data-type="sect1"><div class="sect1" id="idm46803140824432">&#13;
<h1>Launching Services</h1>&#13;
&#13;
<p>We configured a set of services<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="launching services" data-type="indexterm" id="ch08-laun"/><a data-primary="MongoDB datastore" data-secondary="launching services" data-type="indexterm" id="ch08-laun2"/><a data-primary="Rocket.Chat" data-secondary="launching services" data-type="indexterm" id="ch08-laun3"/><a data-primary="ChatOps (Hubot)" data-secondary="launching services" data-type="indexterm" id="ch08-laun4"/><a data-primary="Hubot ChatOps" data-secondary="launching services" data-type="indexterm" id="ch08-laun5"/><a data-primary="services" data-secondary="Docker Compose launching services" data-type="indexterm" id="ch08-laun6"/> for our application in the YAML file. That tells Compose what we’re going to launch and how to configure it. So, let’s get it up and running! <a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="about" data-tertiary="work in docker-compose.yaml directory" data-type="indexterm" id="idm46803138954480"/><a data-primary="docker-compose.yaml" data-primary-sortas="docker-z" data-secondary="work in same directory" data-type="indexterm" id="idm46803138953024"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="docker-compose.yaml" data-tertiary="work in same directory" data-type="indexterm" id="idm46803138951808"/>To run our first Docker Compose command, we need to be sure that we are in the same directory as the <em>docker-compose.yaml</em> file:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code><code class="nb">cd</code><code class="w"> </code>rocketchat-hubot-demo/compose<code class="w"/></pre>&#13;
&#13;
<p>Once you are in the correct directory, you can confirm that the configuration is correct by running the following:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>config<code class="w"/></pre>&#13;
&#13;
<p>If everything is fine, the command<a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="config" data-type="indexterm" id="idm46803138930432"/><a data-primary="docker-compose.yaml" data-primary-sortas="docker-z" data-secondary="displaying via docker compose config" data-type="indexterm" id="idm46803138946400"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="docker-compose.yaml" data-tertiary="displaying via docker compose config" data-type="indexterm" id="idm46803138945312"/> will print out your configuration file. If there is a problem, the command will print an error with details about the problem, like so:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">services.mongo Additional property builder is not allowed</pre>&#13;
&#13;
<p>You can build any containers that you need by using the <code>build</code> option. Any services that use images will be skipped:<a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="build" data-type="indexterm" id="idm46803138907072"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>build<code class="w"/>&#13;
&#13;
<code class="go"> =&gt; [internal] load build definition from Dockerfile                      0.0s</code>&#13;
<code class="go"> =&gt; =&gt; transferring dockerfile: 32B                                       0.0s</code>&#13;
<code class="go"> =&gt; [internal] load .dockerignore                                         0.0s</code>&#13;
<code class="go"> =&gt; =&gt; transferring context: 2B                                           0.0s</code>&#13;
<code class="go"> =&gt; [internal] load metadata for docker.io/bitnami/mongodb:4.4            1.2s</code>&#13;
<code class="go"> =&gt; [auth] bitnami/mongodb:pull token for registry-1.docker.io            0.0s</code>&#13;
<code class="go"> =&gt; [internal] load build context                                         0.0s</code>&#13;
<code class="go"> =&gt; =&gt; transferring context: 40B                                          0.0s</code>&#13;
<code class="go"> =&gt; [1/2] FROM docker.io/bitnami/mongodb:4.4@sha256:9162…ae209            0.0s</code>&#13;
<code class="go"> =&gt; CACHED [2/2] COPY docker-healthcheck /usr/local/bin/                  0.0s</code>&#13;
<code class="go"> =&gt; exporting to image                                                    0.0s</code>&#13;
<code class="go"> =&gt; =&gt; exporting layers                                                   0.0s</code>&#13;
<code class="go"> =&gt; =&gt; writing image sha256:a6ef…da808                                    0.0s</code>&#13;
<code class="go"> =&gt; =&gt; naming to docker.io/spkane/mongo:4.4                               0.0s</code></pre>&#13;
&#13;
<p>You can start up your web service in the background by running the following command:<a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="up" data-tertiary="-d for background web service" data-type="indexterm" id="idm46803138859664"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>up<code class="w"> </code>-d<code class="w"/>&#13;
&#13;
<code class="go">[+] Running 5/5</code>&#13;
<code class="go"> ⠿ Network compose_botnet                  Created                        0.0s</code>&#13;
<code class="go"> ⠿ Container compose-mongo-1               Healthy                       62.0s</code>&#13;
<code class="go"> ⠿ Container compose-rocketchat-1          Started                       62.3s</code>&#13;
<code class="go"> ⠿ Container compose-zmachine-1            Started                       62.5s</code>&#13;
<code class="go"> ⠿ Container compose-hubot-1               Started                       62.6s</code></pre>&#13;
&#13;
<p>Docker Compose prefixes the network and container names with a project name. By default, this is the name of the directory that contains your <em>docker-compose.yaml</em> file. Since this command was run in a directory named <em>compose</em>, you can see that everything starts with <code>compose</code> as the project name.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p><em>Windows users</em>: when you first <a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="about" data-tertiary="Windows users first invoking services" data-type="indexterm" id="idm46803138816928"/><a data-primary="Windows running Docker" data-secondary="Compose services first invoked" data-type="indexterm" id="idm46803138813632"/><a data-primary="services" data-secondary="Docker Compose launching services" data-tertiary="Windows" data-type="indexterm" id="idm46803138812720"/>bring up the services, Windows may prompt you to authorize <em>vpnkit</em>, and Docker Desktop for Windows may also prompt you to share your disk. You must click both the “Allow access” and the “Share it” buttons for the network and volume shares to work and everything to come up properly.</p>&#13;
</div>&#13;
&#13;
<p>Once everything comes up, we can take a quick look at the logs for all of the services (<a data-type="xref" href="#figure8-1">Figure 8-1</a>):<a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="logs" data-type="indexterm" id="idm46803138801424"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="logs" data-type="indexterm" id="idm46803138800176"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>logs<code class="w"/></pre>&#13;
&#13;
<figure><div class="figure" id="figure8-1">&#13;
<img alt="docker compose logs output" src="assets/dur3_0801.png"/>&#13;
<h6><span class="label">Figure 8-1. </span><code>docker compose logs</code> output</h6>&#13;
</div></figure>&#13;
&#13;
<p>You can’t see it well in print here, but if you’re following along, note that all of the logs are color coded by service and interlaced by the time Docker received the log lines. This makes it a lot easier to follow what’s happening, even though several services are logging messages at once.</p>&#13;
&#13;
<p>It can take Rocket.Chat a little<a data-primary="Rocket.Chat" data-secondary="about startup" data-type="indexterm" id="idm46803138773408"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="Rocket.Chat" data-tertiary="about startup" data-type="indexterm" id="idm46803138772432"/><a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="logs" data-tertiary="rocketchat" data-type="indexterm" id="idm46803138769168"/> while to set up the database and be ready to accept connections. Once the Rocket.Chat logs print a line that contains <code>SERVER RUNNING</code>, things should be ready to go:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>logs<code class="w"> </code>rocketchat<code class="w"> </code><code class="p">|</code><code class="w"> </code>grep<code class="w"> </code><code class="s2">"SERVER RUNNING"</code><code class="w"/>&#13;
&#13;
<code class="go">compose-rocketchat-1  | |                SERVER RUNNING                |</code></pre>&#13;
&#13;
<p>At this point, we have successfully launched a reasonably complex application that makes up a stack of containers. We’ll take a look at this simple application now so that you can see what we built and get a more complete understanding of the Compose tooling. While this next section does not strictly have anything to do with Docker itself, it is intended to show you how easy it is to use Docker Compose to set up complex and fully functioning web services.<a data-startref="ch08-laun" data-type="indexterm" id="idm46803138709344"/><a data-startref="ch08-laun2" data-type="indexterm" id="idm46803138708736"/><a data-startref="ch08-laun3" data-type="indexterm" id="idm46803138708128"/><a data-startref="ch08-laun4" data-type="indexterm" id="idm46803138738768"/><a data-startref="ch08-laun5" data-type="indexterm" id="idm46803138738096"/><a data-startref="ch08-laun6" data-type="indexterm" id="idm46803138737424"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Exploring Rocket.Chat" data-type="sect1"><div class="sect1" id="idm46803138962896">&#13;
<h1>Exploring Rocket.Chat</h1>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>In this section, we’re going to diverge<a data-primary="Rocket.Chat" data-secondary="exploring" data-type="indexterm" id="ch08-rc"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="Rocket.Chat" data-tertiary="exploring" data-type="indexterm" id="ch08-rc2"/> from Docker for a moment and take a look at Rocket.Chat. We’ll spend a few pages on it so that you know enough about it that you can hopefully start to appreciate how much easier it is to set up a complex environment using Docker Compose. Feel free to skip down to <a data-type="xref" href="#exercise_dc">“Exercising Docker Compose”</a>, if you would like.</p>&#13;
</div>&#13;
&#13;
<p>We’ll shortly dig further into what’s happening behind the scenes of our setup. But to do that effectively, we should now take a brief moment to explore the application stack we built. <a data-primary="Rocket.Chat" data-secondary="about" data-type="indexterm" id="idm46803138703472"/><a href="https://rocket.chat">Rocket.Chat</a>, the primary application we launched with Docker Compose, is an open source chat client/server application. <a data-primary="Rocket.Chat" data-secondary="Admin Info screen via browser" data-type="indexterm" id="ch08-admininfo"/>To see how it works, let’s launch a web browser and navigate to <a class="bare" href="http://127.0.0.1:3000"><em class="hyperlink">http://127.0.0.1:3000</em></a>.</p>&#13;
&#13;
<p>When you get there, you see the Admin Info screen for Rocket.Chat (<a data-type="xref" href="#figure8-2">Figure 8-2</a>).</p>&#13;
&#13;
<figure><div class="figure" id="figure8-2">&#13;
<img alt="Rocket.Chat Admin Info screen" src="assets/dur3_0802.png"/>&#13;
<h6><span class="label">Figure 8-2. </span>Rocket.Chat Admin Info screen</h6>&#13;
</div></figure>&#13;
&#13;
<p>Fill out the form like this:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Full name: <strong><code>student</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Username: <strong><code>student</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Email: <strong><code>student@example.com</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Password: <strong><code>student-pw!</code></strong></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Then click the blue Next button.</p>&#13;
&#13;
<p>You then see the Organization Info screen (<a data-type="xref" href="#figure8-3">Figure 8-3</a>).</p>&#13;
&#13;
<figure><div class="figure" id="figure8-3">&#13;
<img alt="Rocket.Chat Organization Info screen" src="assets/dur3_0803.png"/>&#13;
<h6><span class="label">Figure 8-3. </span>Rocket.Chat Organization Info screen</h6>&#13;
</div></figure>&#13;
&#13;
<p>The specifics of this form are not critical, but you can fill it in something like this:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Organization name: <strong><code>training</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Organization type: <strong><code>Community</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Organization industry: <strong><code>Education</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Organization size: <strong><code>1-10 people</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Country: <strong><code>United States</code></strong></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Then click the blue Next button.</p>&#13;
&#13;
<p>At this point, you see the Register Your Server screen (<a data-type="xref" href="#figure8-4">Figure 8-4</a>).</p>&#13;
&#13;
<figure><div class="figure" id="figure8-4">&#13;
<img alt="Rocket.Chat Register Your Server screen" src="assets/dur3_0804.png"/>&#13;
<h6><span class="label">Figure 8-4. </span>Rocket.Chat Register Your Server screen</h6>&#13;
</div></figure>&#13;
&#13;
<p>You can simply delete and uncheck everything and then click the small blue “Continue as standalone” link. You then see the Standalone Server Configuration screen (<a data-type="xref" href="#figure8-5">Figure 8-5</a>).</p>&#13;
&#13;
<figure><div class="figure" id="figure8-5">&#13;
<img alt="Rocket.Chat Standalone Server Confirmation screen" src="assets/dur3_0805.png"/>&#13;
<h6><span class="label">Figure 8-5. </span>Rocket.Chat Standalone Server Confirmation screen</h6>&#13;
</div></figure>&#13;
&#13;
<p>Click the blue Confirm button.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>If you are using <code>localhost</code> or something other than 127.0.0.1 to reach Rocket.Chat in your browser, you may get a pop-up window asking if you would like to update the <code>SITE_URL</code>. In most cases, go ahead and let it update that value so that it matches what you are using.<a data-startref="ch08-admininfo" data-type="indexterm" id="idm46803138669520"/></p>&#13;
</div>&#13;
&#13;
<p>Congratulations—you are now logged in to a fully functional chat client, but you aren’t done yet. The Docker Compose configuration launched an instance of a <a href="https://hubot.github.com">Hubot</a> chat assistant and the mysterious zmachine, so let’s take a look at those.</p>&#13;
&#13;
<p>Since the Rocket.Chat server is brand new, it doesn’t yet have a user that our bot can use. Let’s remedy that.<a data-primary="Rocket.Chat" data-secondary="user added" data-type="indexterm" id="ch08-usead"/><a data-primary="Hubot ChatOps" data-secondary="added as user to Rocket.Chat" data-type="indexterm" id="ch08-usead2"/><a data-primary="ChatOps (Hubot)" data-secondary="added as user to Rocket.Chat" data-type="indexterm" id="ch08-usead3"/><a data-primary="Rocket.Chat" data-secondary="Administration panel" data-type="indexterm" id="idm46803138663296"/></p>&#13;
&#13;
<p>Start by clicking the top of the left sidebar, where you see a purple box with the letter <em>S</em> in it. Click Administration in the pop-up menu (<a data-type="xref" href="#figure8-6">Figure 8-6</a>).</p>&#13;
&#13;
<figure><div class="figure" id="figure8-6">&#13;
<img alt="Rocket.Chat Administration sidebar" src="assets/dur3_0806.png"/>&#13;
<h6><span class="label">Figure 8-6. </span>Rocket.Chat Administration sidebar</h6>&#13;
</div></figure>&#13;
&#13;
<p>In the Administration panel, click Users (<a data-type="xref" href="#figure8-7">Figure 8-7</a>).</p>&#13;
&#13;
<figure><div class="figure" id="figure8-7">&#13;
<img alt="Rocket.Chat User screen" src="assets/dur3_0807.png"/>&#13;
<h6><span class="label">Figure 8-7. </span>Rocket.Chat User screen</h6>&#13;
</div></figure>&#13;
&#13;
<p>On the top-far-right side of the screen, click the New button to display the Add User screen (<a data-type="xref" href="#figure8-8">Figure 8-8</a>).</p>&#13;
&#13;
<figure><div class="figure" id="figure8-8">&#13;
<img alt="Rocket.Chat Add User screen" src="assets/dur3_0808.png"/>&#13;
<h6><span class="label">Figure 8-8. </span>Rocket.Chat Add User screen</h6>&#13;
</div></figure>&#13;
&#13;
<p>Fill out the form as follows:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Name: <strong><code>hubot</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Username: <strong><code>hubot</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Email: <strong><code>hubot@example.com</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Click: <strong><code>Verified</code> (Blue)</strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Password: <strong><code>bot-pw!</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Roles: <strong><code>bot</code></strong></p>&#13;
</li>&#13;
<li>&#13;
<p>Disable: <strong><code>Send welcome email</code> (Gray)</strong></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Click Save to create the user.</p>&#13;
&#13;
<p>To ensure that the bot can log in, we also need to disable two-factor authentication, which is enabled by default. To do this, click Settings at the bottom of the Administration sidebar on the left side of your browser (<a data-type="xref" href="#figure8-9">Figure 8-9</a>).</p>&#13;
&#13;
<figure><div class="figure" id="figure8-9">&#13;
<img alt="Rocket.Chat Administration settings" src="assets/dur3_0809.png"/>&#13;
<h6><span class="label">Figure 8-9. </span>Rocket.Chat Administration settings</h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">The Settings screen is displayed (<a data-type="xref" href="#figure8-10">Figure 8-10</a>).</p>&#13;
&#13;
<figure><div class="figure" id="figure8-10">&#13;
<img alt="Rocket.Chat Accounts settings" src="assets/dur3_0810.png"/>&#13;
<h6><span class="label">Figure 8-10. </span>Rocket.Chat Accounts settings</h6>&#13;
</div></figure>&#13;
&#13;
<p>In the new text search bar, type <code><strong>totp</strong></code>, then click the Open button under Accounts.</p>&#13;
&#13;
<p>You should now see a long list of settings (<a data-type="xref" href="#figure8-11">Figure 8-11</a>).</p>&#13;
&#13;
<figure><div class="figure" id="figure8-11">&#13;
<img alt="Rocket.Chat TOTP settings" src="assets/dur3_0811.png"/>&#13;
<h6><span class="label">Figure 8-11. </span>Rocket.Chat TOTP settings</h6>&#13;
</div></figure>&#13;
&#13;
<p>Scroll down to the Two Factor Authentication section, expand it, and then deselect the Enable Two Factor Authentication option.</p>&#13;
&#13;
<p>Once you have done this, click “Save changes.”</p>&#13;
&#13;
<p>At the top of the left side of the Administration panel, click the X to close the panel (<a data-type="xref" href="#figure8-12">Figure 8-12</a>).<a data-primary="Rocket.Chat" data-secondary="Administration panel" data-tertiary="closing" data-type="indexterm" id="idm46803138627136"/></p>&#13;
&#13;
<figure><div class="figure" id="figure8-12">&#13;
<img alt="Rocket.Chat close Administration panel" src="assets/dur3_0812.png"/>&#13;
<h6><span class="label">Figure 8-12. </span>Rocket.Chat close Administration panel</h6>&#13;
</div></figure>&#13;
&#13;
<p>In the left side panel under Channels, click “general” (<a data-type="xref" href="#figure8-13">Figure 8-13</a>).<a data-primary="Rocket.Chat" data-secondary="general channel" data-type="indexterm" id="idm46803138622640"/></p>&#13;
&#13;
<figure><div class="figure" id="figure8-13">&#13;
<img alt="Rocket.Chat General channel" src="assets/dur3_0813.png"/>&#13;
<h6><span class="label">Figure 8-13. </span>Rocket.Chat general channel</h6>&#13;
</div></figure>&#13;
&#13;
<p>And finally, if you don’t already see a message in the channel that “Hubot has joined the channel,” go ahead and tell Docker Compose to restart the Hubot container. This will force Hubot to try and log into the chat server again, now that there is a user for the service to use:<a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="restart user" data-type="indexterm" id="idm46803138619248"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>restart<code class="w"> </code>hubot<code class="w"/>&#13;
<code class="go">Restarting unix_hubot_1 … done</code></pre>&#13;
&#13;
<p>If everything went according to plan, you should now be able to navigate back to your web browser and send commands to Hubot in the chat window.<a data-startref="ch08-usead" data-type="indexterm" id="idm46803138601120"/><a data-startref="ch08-usead2" data-type="indexterm" id="idm46803138600512"/><a data-startref="ch08-usead3" data-type="indexterm" id="idm46803138599904"/></p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Hubot should auto-join the General channel when it logs into the server, but just in case, you can send the following message in the General channel to explicitly invite Hubot:<a data-primary="Rocket.Chat" data-secondary="invite user" data-type="indexterm" id="idm46803138614128"/><a data-primary="Hubot ChatOps" data-secondary="invitation from Rocket.Chat" data-type="indexterm" id="idm46803138613152"/><a data-primary="ChatOps (Hubot)" data-secondary="invitation from Rocket.Chat" data-type="indexterm" id="idm46803138612240"/></p>&#13;
&#13;
<pre data-type="programlisting">/invite @hubot</pre>&#13;
&#13;
<p>You may get a message from the internal admin <code>rocket.cat</code> that says “@hubot is already in here.” This is perfectly fine.</p>&#13;
</div>&#13;
&#13;
<p>The environment variables used<a data-primary="Hubot ChatOps" data-secondary="help for list of commands" data-type="indexterm" id="idm46803138593088"/><a data-primary="ChatOps (Hubot)" data-secondary="help for list of commands" data-type="indexterm" id="idm46803138592144"/> to configure Hubot defined its alias as a period. So you can now try typing <code>. help</code> to test that the bot is responding. If everything is working, you should get a list of commands that the bot understands and will respond to:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">&gt; . help&#13;
. adapter - Reply with the adapter&#13;
. echo &lt;text&gt; - Reply back with &lt;text&gt;&#13;
. help - Displays all of the help commands that this bot knows about.&#13;
. help &lt;query&gt; - Displays all help commands that match &lt;query&gt;.&#13;
. ping - Reply with pong&#13;
. time - Reply with current time&#13;
…</pre>&#13;
&#13;
<p>Finally, try typing the following:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">. ping</pre>&#13;
&#13;
<p>Hubot should respond with <code>PONG</code>.</p>&#13;
&#13;
<p>If you type:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">. time</pre>&#13;
&#13;
<p>then Hubot will tell you what the time is set to on the server.</p>&#13;
&#13;
<p>So, for one last diversion, try creating<a data-primary="Hubot ChatOps" data-secondary="Colossal Cave Adventure game" data-type="indexterm" id="idm46803138536400"/><a data-primary="ChatOps (Hubot)" data-secondary="Colossal Cave Adventure game" data-type="indexterm" id="idm46803138535888"/><a data-primary="Rocket.Chat" data-secondary="create new chat channel" data-type="indexterm" id="idm46803138535040"/><a data-primary="Colossal Cave Adventure game" data-type="indexterm" id="idm46803138542368"/> a new chat channel by typing <code>/create <span class="keep-together">zmachine</span></code> in the chat window. You should now be able to click on the new <code>zmachine</code> channel in the left sidebar and invite Hubot with the chat command <code>/invite @hubot</code>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>When you do this, Hubot might say:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">There's no game for zmachine!</pre>&#13;
&#13;
<p>This is nothing to be concerned about.</p>&#13;
</div>&#13;
&#13;
<p>Next, try typing the following commands into the chat window to play a chat-based version of the famous game <a href="https://en.wikipedia.org/wiki/Interactive_fiction#Adventure"><em>Colossal Cave Adventure</em></a>:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">. z start adventure&#13;
&#13;
more&#13;
look&#13;
go east&#13;
examine keys&#13;
get keys&#13;
&#13;
. z save firstgame&#13;
. z stop&#13;
. z start adventure&#13;
. z restore firstgame&#13;
&#13;
inventory</pre>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Interactive fiction can be addictive and a huge time sink. You have been warned. That being said, if you aren’t already familiar with it and are interested in learning more, take a look at some of these resources:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://en.wikipedia.org/wiki/Interactive_fiction">Definition of interactive fiction</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://davidgriffith.gitlab.io/frotz">Emulator</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://ganelson.github.io/inform-website">Development</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/IrOLh">Games</a><sup><a data-type="noteref" href="ch08.html#idm46803138496976" id="idm46803138496976-marker">1</a></sup></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://ifcomp.org">Competition</a></p>&#13;
</li>&#13;
</ul>&#13;
</div>&#13;
&#13;
<p>You’ve now seen how easy it can be to configure, launch, and manage complex web services that require multiple components to accomplish their jobs using Docker Compose. In the next section, we will explore a few more of the features that Docker Compose includes.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>You could avoid much of the <a data-primary="MongoDB datastore" data-secondary="preconfigured Rocket.Chat database" data-type="indexterm" id="idm46803138471984"/><a data-primary="Rocket.Chat" data-secondary="setup via MongoDB with preconfigured database" data-type="indexterm" id="idm46803138471040"/>Rocket.Chat setup by providing MongoDB with a preconfigured Rocket.Chat database, but it felt important to remove any magic from this example to make it clearer how everything fits together.<a data-startref="ch08-rc" data-type="indexterm" id="idm46803138470000"/><a data-startref="ch08-rc2" data-type="indexterm" id="idm46803138469328"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Exercising Docker Compose" data-type="sect1"><div class="sect1" id="exercise_dc">&#13;
<h1>Exercising Docker Compose</h1>&#13;
&#13;
<p>Now that you have the full<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="exercising" data-type="indexterm" id="ch08-exer"/> Rocket.Chat stack running and understand what the application is doing, we can dig in to get a little more insight into how the services are running. Some of the common Docker commands are also exposed as Compose commands, but for a specific stack rather than a single container or all of the containers on a host. You can run <code>docker compose top</code> to see an overview of your containers and the processes that are running in them:<a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="top" data-type="indexterm" id="idm46803138453200"/><a data-primary="processes" data-secondary="overview of containers" data-tertiary="docker compose top" data-type="indexterm" id="idm46803138452112"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>top<code class="w"/>&#13;
&#13;
<code class="go">compose-hubot-1</code>&#13;
<code class="go">UID  PID   … CMD</code>&#13;
<code class="go">1001 73342 … /usr/bin/qemu-x86_64 /bin/sh /bin/sh -c node -e "console.l…"</code>&#13;
<code class="go">1001 73459 … /usr/bin/qemu-x86_64 /usr/local/bin/node node node_modules/…</code>&#13;
&#13;
<code class="go">compose-mongo-1</code>&#13;
<code class="go">UID  PID   … CMD</code>&#13;
<code class="go">1001 71243 … /usr/bin/qemu-x86_64 /opt/bitnami/mongodb/bin/mongod /opt/…</code>&#13;
&#13;
<code class="go">compose-rocketchat-1</code>&#13;
<code class="go">UID   PID   … CMD</code>&#13;
<code class="go">65533 71903 … /usr/bin/qemu-x86_64 /usr/local/bin/node node main.js</code>&#13;
&#13;
<code class="go">compose-zmachine-1</code>&#13;
<code class="go">UID  PID   … CMD</code>&#13;
<code class="go">root 71999 … /usr/bin/qemu-x86_64 /usr/local/bin/node node /root/src/server.js</code>&#13;
<code class="go">root 75078 … /usr/bin/qemu-x86_64 /root/src/../frotz/dfrotz /root/src/…</code></pre>&#13;
&#13;
<p>Similar to how you would normally enter a running Linux container using the <code>docker container exec</code> command,<a data-primary="Linux containers" data-secondary="inside a running container" data-tertiary="docker compose exec" data-type="indexterm" id="idm46803138400560"/><a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="exec" data-type="indexterm" id="idm46803138399440"/> you can run commands inside containers via the Docker Compose tooling using the <code>docker compose exec</code> command. Because <code>docker compose</code> is a newer tool, it provides some convenient shortcuts over the standard <code>docker</code> commands. In the case of <code>docker compose exec</code>, you do not need to pass in <code>-i -t</code>, and you can use the Docker Compose service name instead of trying to remember the container ID or name:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code><code class="nb">exec</code><code class="w"> </code>mongo<code class="w"> </code>bash<code class="w"/>&#13;
&#13;
<code class="go">I have no name!@0078134f9370:/$ mongo</code>&#13;
<code class="go">MongoDB shell version v4.4.15</code>&#13;
<code class="go">connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;…</code>&#13;
<code class="go">Implicit session: session { "id" : UUID("daec9543-bb9c-4e8c-ba6b…") }</code>&#13;
<code class="go">MongoDB server version: 4.4.15</code>&#13;
<code class="go">…</code>&#13;
<code class="go">rs0:PRIMARY&gt; exit</code>&#13;
<code class="go">bye</code>&#13;
<code class="go">I have no name!@0078134f9370:/$ exit</code>&#13;
<code class="go">exit</code></pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p><code>docker compose logs</code> and <code>docker compose exec</code> are probably<a data-primary="debugging" data-secondary="Docker Compose" data-type="indexterm" id="idm46803138428848"/><a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="logs" data-type="indexterm" id="idm46803138427840"/> the most useful commands for troubleshooting. If Docker Compose cannot build your image or start your container at all, you will need to fall back to the standard <code>docker</code> commands to debug your image and container, as we discussed in <a data-type="xref" href="ch04.html#broken_builds">“Troubleshooting Broken Builds”</a> and <a data-type="xref" href="ch06.html#inside_containers">“Getting Inside a Running Container”</a>.</p>&#13;
</div>&#13;
&#13;
<p>You can also use Docker Compose to <code>start</code> and <code>stop</code> and, in most environments, <code>pause</code> and <code>unpause</code> either a single container or all of your containers, depending on what you need:<a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="stop" data-type="indexterm" id="idm46803138377616"/><a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="start" data-type="indexterm" id="idm46803138376368"/><a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="pause" data-type="indexterm" id="idm46803138375152"/><a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="unpause" data-type="indexterm" id="idm46803138373936"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>stop<code class="w"> </code>zmachine<code class="w"/>&#13;
<code class="go">[+] Running 1/1</code>&#13;
<code class="go"> ⠿ Container compose-zmachine-1  Stopped                                  0.3s</code>&#13;
<code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>start<code class="w"> </code>zmachine<code class="w"/>&#13;
<code class="go">[+] Running 2/2</code>&#13;
<code class="go"> ⠿ Container compose-mongo-1     Healthy                                  0.5s</code>&#13;
<code class="go"> ⠿ Container compose-zmachine-1  Started                                  0.4s</code>&#13;
<code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>pause<code class="w"/>&#13;
<code class="go">[+] Running 4/0</code>&#13;
<code class="go"> ⠿ Container compose-mongo-1       Paused                                 0.0s</code>&#13;
<code class="go"> ⠿ Container compose-zmachine-1    Paused                                 0.0s</code>&#13;
<code class="go"> ⠿ Container compose-rocketchat-1  Paused                                 0.0s</code>&#13;
<code class="go"> ⠿ Container compose-hubot-1       Paused                                 0.0s</code>&#13;
<code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>unpause<code class="w"/>&#13;
<code class="go">[+] Running 4/0</code>&#13;
<code class="go"> ⠿ Container compose-zmachine-1    Unpaused                               0.0s</code>&#13;
<code class="go"> ⠿ Container compose-hubot-1       Unpaused                               0.0s</code>&#13;
<code class="go"> ⠿ Container compose-rocketchat-1  Unpaused                               0.0s</code>&#13;
<code class="go"> ⠿ Container compose-mongo-1       Unpaused                               0.0s</code></pre>&#13;
&#13;
<p>Finally, when you want to tear everything down and delete all the containers created by Docker Compose, you can run the following command:<a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="down" data-type="indexterm" id="idm46803138324608"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>down<code class="w"/>&#13;
<code class="go">[+] Running 5/5</code>&#13;
<code class="go"> ⠿ Container compose-hubot-1       Removed                               10.4s</code>&#13;
<code class="go"> ⠿ Container compose-zmachine-1    Removed                                0.1s</code>&#13;
<code class="go"> ⠿ Container compose-rocketchat-1  Removed                                0.6s</code>&#13;
<code class="go"> ⠿ Container compose-mongo-1       Removed                                0.9s</code>&#13;
<code class="go"> ⠿ Network compose_botnet          Removed                                0.1s</code></pre>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>When you delete the MongoDB <a data-primary="MongoDB datastore" data-secondary="container deleted with docker compose down" data-type="indexterm" id="idm46803138307792"/>container using the <code>docker compose down</code> command, all data in the MongoDB instance will be lost.<a data-startref="ch08-exer" data-type="indexterm" id="idm46803138306368"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Managing Configuration" data-type="sect1"><div class="sect1" id="idm46803138734608">&#13;
<h1>Managing Configuration</h1>&#13;
&#13;
<p>Docker Compose offers a few important<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="configuring" data-tertiary="managing configuration" data-type="indexterm" id="ch08-manag"/><a data-primary="docker-compose.yaml" data-primary-sortas="docker-z" data-secondary="managing configuration" data-type="indexterm" id="ch08-manag2"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="docker-compose.yaml" data-tertiary="configuration management" data-type="indexterm" id="ch08-manag3"/> capabilities that can help you significantly improve the flexibility of your <em>docker-compose.yaml</em> files. In this section, we will explore how you can avoid hardcoding many configuration values into your <em>docker-compose.yaml</em> files while still making them easy to use by default.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Default Values" data-type="sect2"><div class="sect2" id="idm46803138249440">&#13;
<h2>Default Values</h2>&#13;
&#13;
<p>If we take a look at the <em>services:rocketchat:environment</em> section of the <em>docker-compose.yaml</em> file, we will see something like this:<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="configuring" data-tertiary="default values" data-type="indexterm" id="ch08-def"/><a data-primary="docker-compose.yaml" data-primary-sortas="docker-z" data-secondary="managing configuration" data-tertiary="default values" data-type="indexterm" id="ch08-def2"/><a data-primary="Rocket.Chat" data-secondary="configuration management" data-tertiary="default values" data-type="indexterm" id="ch08-def3"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="docker-compose.yaml" data-tertiary="configuration default values" data-type="indexterm" id="ch08-def4"/></p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">environment</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">RESPOND_TO_DM</code><code class="p">:</code><code class="w"> </code><code class="s">"true"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ALIAS</code><code class="p">:</code><code class="w"> </code><code class="s">".</code><code class="nv"> </code><code class="s">"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">LISTEN_ON_ALL_PUBLIC</code><code class="p">:</code><code class="w"> </code><code class="s">"true"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_AUTH</code><code class="p">:</code><code class="w"> </code><code class="s">"password"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_URL</code><code class="p">:</code><code class="w"> </code><code class="s">"rocketchat:3000"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_ROOM</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_USER</code><code class="p">:</code><code class="w"> </code><code class="s">"hubot"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_PASSWORD</code><code class="p">:</code><code class="w"> </code><code class="s">"bot-pw!"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">BOT_NAME</code><code class="p">:</code><code class="w"> </code><code class="s">"bot"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">EXTERNAL_SCRIPTS</code><code class="p">:</code><code class="w"> </code><code class="s">"hubot-help,hubot-diagnostics,hubot-zmachine"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ZMACHINE_SERVER</code><code class="p">:</code><code class="w"> </code><code class="s">"http://zmachine:80"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ZMACHINE_ROOMS</code><code class="p">:</code><code class="w"> </code><code class="s">"zmachine"</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ZMACHINE_OT_PREFIX</code><code class="p">:</code><code class="w"> </code><code class="s">"ot"</code><code class="w"/></pre>&#13;
&#13;
<p>Now, if we look at <em>docker-compose-defaults.yaml</em> inside the same directory, we will see that this same section looks like this:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">    </code><code class="nt">environment</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">RESPOND_TO_DM</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_RESPOND_TO_DM:-true}</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ALIAS</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_ALIAS:-. }</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">LISTEN_ON_ALL_PUBLIC</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_LISTEN_ON_ALL_PUBLIC:-true}</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_AUTH</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_ROCKETCHAT_AUTH:-password}</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_URL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_ROCKETCHAT_URL:-rocketchat:3000}</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_ROOM</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_ROCKETCHAT_ROOM:-}</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_USER</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_ROCKETCHAT_USER:-hubot}</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ROCKETCHAT_PASSWORD</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_ROCKETCHAT_PASSWORD:-bot-pw!}</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">BOT_NAME</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_BOT_NAME:-bot}</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">EXTERNAL_SCRIPTS</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_EXTERNAL_SCRIPTS:-hubot-help,</code><code class="w"/>&#13;
<code class="w">                          </code><code class="l-Scalar-Plain">hubot-diagnostics,hubot-zmachine}</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ZMACHINE_SERVER</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_ZMACHINE_SERVER:-http://zmachine:80}</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ZMACHINE_ROOMS</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_ZMACHINE_ROOMS:-zmachine}</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">HUBOT_ZMACHINE_OT_PREFIX</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_ZMACHINE_OT_PREFIX:-ot}</code><code class="w"/></pre>&#13;
&#13;
<p>This is using a technique called<a data-primary="variable interpolation" data-type="indexterm" id="idm46803138173696"/> <a href="https://docs.docker.com/compose/compose-file/#interpolation"><em>variable interpolation</em></a> that Docker Compose has borrowed directly from many common Unix shells, like <code>bash</code>.</p>&#13;
&#13;
<p>In the original file, the environment variable <code>ROCKETCHAT_PASSWORD</code> is hardcoded to the value <code>"bot-pw!"</code>:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">      </code><code class="nt">ROCKETCHAT_PASSWORD</code><code class="p">:</code><code class="w"> </code><code class="s">"bot-pw!"</code><code class="w"/></pre>&#13;
&#13;
<p>By using this new approach,<a data-primary="environment variables" data-secondary="configuration via" data-tertiary="Docker Compose" data-type="indexterm" id="idm46803137938800"/><a data-primary="configuration" data-secondary="environment variables" data-tertiary="Docker Compose" data-type="indexterm" id="idm46803137937712"/> we are stating that we want <code>ROCKETCHAT_PASSWORD</code> to be set to the value of the <code>HUBOT_ROCKETCHAT_PASSWORD</code> variable if it is set in the user’s environment, and if it is not, then <code>ROCKETCHAT_PASSWORD</code> should be set to the default value of <code>bot-pw!</code>:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">      </code><code class="nt">ROCKETCHAT_PASSWORD</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_ROCKETCHAT_PASSWORD:-bot-pw!}</code><code class="w"/></pre>&#13;
&#13;
<p>This provides us with a great deal of flexibility since we can now make almost everything configurable while still providing reasonable defaults for the most common use case. We can easily test this out by running <code>docker compose up</code> with the new file:<a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="up" data-tertiary="-d for background web service" data-type="indexterm" id="idm46803137910848"/><a data-primary="docker compose" data-primary-sortas="docker-z" data-secondary="up" data-tertiary="-f for configuration file" data-type="indexterm" id="idm46803137909456"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>-f<code class="w"> </code>docker-compose-defaults.yaml<code class="w"> </code>up<code class="w"> </code>-d<code class="w"/>&#13;
&#13;
<code class="go">[+] Running 5/5</code>&#13;
<code class="go"> ⠿ Network compose_botnet          Created                                0.0s</code>&#13;
<code class="go"> ⠿ Container compose-mongo-1       Healthy                               31.0s</code>&#13;
<code class="go"> ⠿ Container compose-rocketchat-1  Started                               31.2s</code>&#13;
<code class="go"> ⠿ Container compose-zmachine-1    Started                               31.5s</code>&#13;
<code class="go"> ⠿ Container compose-hubot-1       Started                               31.8s</code></pre>&#13;
&#13;
<p>By default, this will result in the exact same stack that we spun up earlier. However, we could easily make changes to it now by simply setting one or more environment variables in our terminal before running our <code>docker compose</code> commands:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>-f<code class="w"> </code>docker-compose-defaults.yaml<code class="w"> </code>down<code class="w"/>&#13;
<code class="go">…</code>&#13;
&#13;
<code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>-f<code class="w"> </code>docker-compose-defaults.yaml<code class="w"> </code>config<code class="w"> </code><code class="p">|</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>grep<code class="w"> </code>ROCKETCHAT_PASSWORD<code class="w"/>&#13;
&#13;
<code class="go">      ROCKETCHAT_PASSWORD: bot-pw!</code>&#13;
&#13;
<code class="gp">$ </code><code class="nv">HUBOT_ROCKETCHAT_PASSWORD</code><code class="o">=</code><code class="s2">"my-unique-pw"</code><code class="w"> </code>docker<code class="w"> </code>compose<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>-f<code class="w"> </code>docker-compose-defaults.yaml<code class="w"> </code>config<code class="w"> </code><code class="p">|</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>grep<code class="w"> </code>ROCKETCHAT_PASSWORD<code class="w"/>&#13;
&#13;
<code class="go">      ROCKETCHAT_PASSWORD: my-unique-pw</code></pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>In the examples here, Docker Compose will treat an empty environment variable exactly the same as one that is set to an empty string. If an empty string is a valid value in your use case, then you will want to modify the format of the variable substitution line so that it looks like this: <code>${VARIABLE_NAME-default-value}</code>. <a data-primary="variable interpolation" data-secondary="documentation" data-type="indexterm" id="idm46803137802752"/><a data-primary="documentation" data-secondary="Docker Compose" data-tertiary="variable interpolation" data-type="indexterm" id="idm46803137801840"/><a data-primary="resources online" data-secondary="Docker Compose documentation" data-tertiary="variable interpolation" data-type="indexterm" id="idm46803137800624"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="documentation" data-tertiary="variable interpolation" data-type="indexterm" id="idm46803137799392"/>We recommend reading through <a href="https://docs.docker.com/compose/compose-file/#interpolation">the documentation for this feature</a> so that you understand all the possibilities.</p>&#13;
</div>&#13;
&#13;
<p>This is pretty nice, but what if we don’t want to provide a default value at all and instead want to force the user to set something? We can do this pretty easily as well.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Some readers might be uncomfortable with the fact that we are passing in the password as part of the command line, since those passwords might be viewable in the system process list, etc., but don’t worry—we will address that in just a few minutes.<a data-startref="ch08-def" data-type="indexterm" id="idm46803137829696"/><a data-startref="ch08-def2" data-type="indexterm" id="idm46803137828992"/><a data-startref="ch08-def3" data-type="indexterm" id="idm46803137828320"/><a data-startref="ch08-def4" data-type="indexterm" id="idm46803137827648"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mandatory Values" data-type="sect2"><div class="sect2" id="idm46803138248816">&#13;
<h2>Mandatory Values</h2>&#13;
&#13;
<p>To set a mandatory value, we simply<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="configuring" data-tertiary="mandatory values" data-type="indexterm" id="idm46803137825104"/><a data-primary="docker-compose.yaml" data-primary-sortas="docker-z" data-secondary="managing configuration" data-tertiary="mandatory values" data-type="indexterm" id="idm46803137823584"/><a data-primary="Rocket.Chat" data-secondary="configuration management" data-tertiary="mandatory values" data-type="indexterm" id="idm46803137822096"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="docker-compose.yaml" data-tertiary="configuration mandatory values" data-type="indexterm" id="idm46803137820816"/> need to alter the variable substitution line a bit. It seems like a bad idea to pass in a default password, so let’s go ahead and make that value required.</p>&#13;
&#13;
<p>In the <em>docker-compose-defaults.yaml</em> file, <code>ROCKETCHAT_PASSWORD</code> is defined like this:<a data-primary=":- in docker-compose.yaml" data-type="indexterm" id="idm46803137789344"/><a data-primary="docker-compose.yaml" data-primary-sortas="docker-z" data-secondary=":- operator" data-type="indexterm" id="idm46803137788736"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary=":- operator" data-type="indexterm" id="idm46803137787648"/></p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">      </code><code class="nt">ROCKETCHAT_PASSWORD</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${HUBOT_ROCKETCHAT_PASSWORD:-bot-pw!}</code><code class="w"/></pre>&#13;
&#13;
<p>In the newer <em>docker-compose-env.yaml</em> file, we can see that it is defined like this:<a data-primary=":? in docker-compose.yaml" data-type="indexterm" id="idm46803137770256"/><a data-primary="docker-compose.yaml" data-primary-sortas="docker-z" data-secondary=":? operator" data-type="indexterm" id="idm46803137769648"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary=":? operator" data-type="indexterm" id="idm46803137768560"/></p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="w">      </code><code class="nt">ROCKETCHAT_PASSWORD</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="l-Scalar-Plain">${HUBOT_ROCKETCHAT_PASSWORD:?HUBOT_ROCKETCHAT_PASSWORD must be set!}</code><code class="w"/></pre>&#13;
&#13;
<p>Instead of containing a default value, this approach defines an error string if the variable is not set to a nonempty string in the environment. If we try to simply spin up these services now, we will get an error message:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>-f<code class="w"> </code>docker-compose-env.yaml<code class="w"> </code>up<code class="w"> </code>-d<code class="w"/>&#13;
&#13;
<code class="go">invalid interpolation format for</code>&#13;
<code class="go">  services.hubot.environment.ROCKETCHAT_PASSWORD.</code>&#13;
<code class="go">You may need to escape any $ with another $.</code>&#13;
<code class="go">required variable HUBOT_ROCKETCHAT_PASSWORD is missing a value:</code>&#13;
<code class="go">  HUBOT_ROCKETCHAT_PASSWORD must be set!</code></pre>&#13;
&#13;
<p>The output gives us a few hints about what might be wrong, but the last two lines are pretty clear, and the final message is the exact error message that we defined, so it can be set to whatever makes the most sense in the situation.</p>&#13;
&#13;
<p>If we go ahead and pass in our own password, then everything spins up just fine:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code><code class="nv">HUBOT_ROCKETCHAT_PASSWORD</code><code class="o">=</code><code class="s2">"a-b3tt3r-pw"</code><code class="w"> </code>docker<code class="w"> </code>compose<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>-f<code class="w"> </code>docker-compose-env.yaml<code class="w"> </code>up<code class="w"> </code>-d<code class="w"/>&#13;
&#13;
<code class="go">[+] Running 5/5</code>&#13;
<code class="go"> ⠿ Network compose_botnet          Created                      0.0s</code>&#13;
<code class="go"> ⠿ Container compose-mongo-1       Healthy                     31.0s</code>&#13;
<code class="go"> ⠿ Container compose-rocketchat-1  Started                     31.3s</code>&#13;
<code class="go"> ⠿ Container compose-zmachine-1    Started                     31.5s</code>&#13;
<code class="go"> ⠿ Container compose-hubot-1       Started                     31.8s</code>&#13;
&#13;
<code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>-f<code class="w"> </code>docker-compose-env.yaml<code class="w"> </code>down<code class="w"/>&#13;
<code class="go">…</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The dotenv File" data-type="sect2"><div class="sect2" id="idm46803137826256">&#13;
<h2>The dotenv File</h2>&#13;
&#13;
<p>Passing in a single environment variable<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="configuring" data-tertiary=".env (dotenv) file" data-tertiary-sortas="env" data-type="indexterm" id="ch08-dot"/><a data-primary="docker-compose.yaml" data-primary-sortas="docker-z" data-secondary="managing configuration" data-tertiary=".env (dotenv) file" data-tertiary-sortas="env" data-type="indexterm" id="ch08-dot2"/><a data-primary=".env (dotenv) configuration file" data-primary-sortas="env" data-type="indexterm" id="ch08-dot3"/><a data-primary="dotenv (.env) configuration file" data-type="indexterm" id="ch08-dot4"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="docker-compose.yaml" data-tertiary="configuration .env (dotenv) file" data-type="indexterm" id="ch08-dot5"/><a data-primary=".env (dotenv) configuration file" data-type="indexterm" id="ch08-dot6"/> is not that difficult, but if you need to pass in a lot of custom values, or even one real secret, then setting them in the local terminal isn’t ideal. This is where the <em>.env</em> (<em>dotenv</em>) file can be very useful.</p>&#13;
&#13;
<p>The <em>.env</em> file is a <a href="https://www.dotenv.org/docs/security/env">special file standard</a> that is intended to be parsed by programs that need additional configuration information that is specific to the local environment.</p>&#13;
&#13;
<p>In the preceding use case, we must set a password to spin up our Docker Compose environment. We can pass in the environment every time, but this isn’t ideal for at least a few reasons. It would be nice if we could set it in a way that is reasonably secure for a single-user environment and that will also make our lives a bit easier and less error prone.</p>&#13;
&#13;
<p>In essence, a <em>.env</em> file is simply a list of key/value pairs. <a data-primary="secrets" data-secondary=".env (dotenv) file" data-secondary-sortas="env" data-type="indexterm" id="idm46803137640352"/><a data-primary="Git" data-secondary=".gitignore for files containing secrets" data-secondary-sortas="gitignore" data-type="indexterm" id="idm46803137639104"/><a data-primary="secrets" data-secondary="git .gitignore file" data-type="indexterm" id="idm46803137637920"/>Since this file is intended to be unique to the local environment and will often contain at least one secret, we should start by ensuring that we will never accidentally commit these files into our revision control system. To do this with <code>git</code>, we can simply make sure that our <em>.gitignore</em> file includes <em>.env</em>, which, in this case, it already does:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>grep<code class="w"> </code>.env<code class="w"> </code>../.gitignore<code class="w"/>&#13;
<code class="go">.env</code></pre>&#13;
&#13;
<p>Assuming that we are on a single-user system,<a data-primary=".env (dotenv) configuration file" data-primary-sortas="env" data-secondary="same directory as docker-compose.yaml" data-type="indexterm" id="idm46803137601648"/><a data-primary="dotenv (.env) configuration file" data-secondary="same directory as docker-compose.yaml" data-type="indexterm" id="idm46803137600560"/><a data-primary=".env (dotenv) configuration file" data-secondary="same directory as docker-compose.yaml" data-type="indexterm" id="idm46803137615552"/> we can now safely create a <em>.env</em> file in the same directory that contains our <em>docker-compose.yaml</em> file(s).</p>&#13;
&#13;
<p>For this example, let’s go ahead and make the contents of our <em>.env</em> file look like this:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">HUBOT_ROCKETCHAT_PASSWORD=th2l@stPW!</pre>&#13;
&#13;
<p>We could add many more key/value pairs to this file, but to keep things simple, we are only focusing on this one password. If you run <code>git status</code> after creating this file, you should notice that <code>git</code> is completely ignoring the new file, which is exactly what we want:<a data-primary="Git" data-secondary=".gitignore for files containing secrets" data-secondary-sortas="gitignore" data-tertiary="git status confirming" data-type="indexterm" id="idm46803137590128"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>git<code class="w"> </code>status<code class="w"/>&#13;
<code class="go">On branch main</code>&#13;
<code class="go">Your branch is up to date with 'origin/main'.</code>&#13;
&#13;
<code class="go">nothing to commit, working tree clean</code></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>A <em>.env</em> file is not a Unix shell script. <a data-primary=".env (dotenv) configuration file" data-primary-sortas="env" data-secondary="values not in quotation marks" data-type="indexterm" id="idm46803137572864"/><a data-primary="dotenv (.env) configuration file" data-secondary="values not in quotation marks" data-type="indexterm" id="idm46803137571680"/><a data-primary=".env (dotenv) configuration file" data-secondary="values not in quotation marks" data-type="indexterm" id="idm46803137550624"/>There are subtle but important differences between this format and how you might define variables in a standard shell script. The most important one is that, in most circumstances, you should not surround values with quotation marks.</p>&#13;
</div>&#13;
&#13;
<p>In the previous section, when we ran <code>docker compose -f docker-compose-env.yaml up -d</code> without setting the <code>HUBOT_ROCKETCHAT_PASSWORD</code>, we got an error, but if we try this again after creating the <em>.env</em> file, things should work just fine:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code>-f<code class="w"> </code>docker-compose-env.yaml<code class="w"> </code>up<code class="w"> </code>-d<code class="w"/>&#13;
&#13;
<code class="go">[+] Running 5/5</code>&#13;
<code class="go"> ⠿ Network compose_botnet          Created                      0.0s</code>&#13;
<code class="go"> ⠿ Container compose-mongo-1       Healthy                     31.1s</code>&#13;
<code class="go"> ⠿ Container compose-rocketchat-1  Started                     31.3s</code>&#13;
<code class="go"> ⠿ Container compose-zmachine-1    Started                     31.5s</code>&#13;
<code class="go"> ⠿ Container compose-hubot-1       Started                     31.8s</code></pre>&#13;
&#13;
<p class="pagebreak-before">Let’s confirm that the value that has been assigned to <code>ROCKETCHAT_PASSWORD</code> is what we set it to in the <em>.env</em> file:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>compose<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>-f<code class="w"> </code>docker-compose-env.yaml<code class="w"> </code>config<code class="w"> </code><code class="p">|</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>grep<code class="w"> </code>ROCKETCHAT_PASSWORD<code class="w"/>&#13;
&#13;
<code class="go">      ROCKETCHAT_PASSWORD: th2l@stPW!</code></pre>&#13;
&#13;
<p>We can see that the value is indeed set to what we defined in the <em>.env</em> file. This is because Docker Compose will always read in the key/value pairs that are defined in a <em>.env</em> file that lives in the same directory as the <em>docker-compose.yaml</em> file that we are using.</p>&#13;
&#13;
<p>It is important to understand the precedence that is in effect here. <a data-primary="docker-compose.yaml" data-primary-sortas="docker-z" data-secondary="managing configuration" data-tertiary="docker-compose.yaml then .env then environment variables" data-type="indexterm" id="idm46803137468816"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="configuring" data-tertiary="docker-compose.yaml then .env then environment variables" data-type="indexterm" id="idm46803137465168"/><a data-primary=".env (dotenv) configuration file" data-primary-sortas="env" data-secondary="docker-compose.yaml then .env then environment variables" data-type="indexterm" id="idm46803137463712"/><a data-primary="dotenv (.env) configuration file" data-secondary="docker-compose.yaml then .env then environment variables" data-type="indexterm" id="idm46803137462560"/><a data-primary="environment variables" data-secondary="docker-compose.yaml then .env then environment variables" data-type="indexterm" id="idm46803137461680"/><a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="docker-compose.yaml" data-tertiary="docker-compose.yaml then .env then environment variables" data-type="indexterm" id="idm46803137460768"/><a data-primary=".env (dotenv) configuration file" data-secondary="docker-compose.yaml then .env then environment variables" data-type="indexterm" id="idm46803137459232"/>The very first thing that Docker Compose does is read all the defaults that are set in the <em>docker-compose.yaml</em> file. It then reads the <em>.env</em> file and overrides any of the defaults, which are values defined in the file. Then it finally looks at any environment variables that are set in the local environment and overwrites values previously defined with these.</p>&#13;
&#13;
<p>This means that the defaults in the file should be the most common settings, then each user can define their common changes in the local <em>.env</em> file, and finally, they can rely on local environment variables when they need to make an unusual change for a specific use case. Using these features with Docker Compose helps ensure that you can build a very repeatable process that still contains enough flexibility to cover most common workflows.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>There are additional features of Docker Compose that we do not cover, like<a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="override files" data-type="indexterm" id="idm46803137455296"/> <a href="https://docs.docker.com/compose/extends">override files</a>. <a data-primary="Docker Compose" data-primary-sortas="docker-a" data-secondary="documentation" data-type="indexterm" id="idm46803137453264"/><a data-primary="documentation" data-secondary="Docker Compose" data-type="indexterm" id="idm46803137451984"/><a data-primary="resources online" data-secondary="Docker Compose documentation" data-type="indexterm" id="idm46803137451040"/>As you start to use Docker Compose more, it is worth your time to review the <a href="https://docs.docker.com/compose">documentation</a> so that you are aware of any additional features that might be useful for your projects.<a data-startref="ch08-manag" data-type="indexterm" id="idm46803137449216"/><a data-startref="ch08-manag2" data-type="indexterm" id="idm46803137448512"/><a data-startref="ch08-manag3" data-type="indexterm" id="idm46803137431840"/><a data-startref="ch08-dot" data-type="indexterm" id="idm46803137431232"/><a data-startref="ch08-dot2" data-type="indexterm" id="idm46803137430624"/><a data-startref="ch08-dot3" data-type="indexterm" id="idm46803137430016"/><a data-startref="ch08-dot4" data-type="indexterm" id="idm46803137429376"/><a data-startref="ch08-dot5" data-type="indexterm" id="idm46803137428704"/><a data-startref="ch08-dot6" data-type="indexterm" id="idm46803137428032"/></p>&#13;
</div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Wrap-Up" data-type="sect1"><div class="sect1" id="idm46803137632112">&#13;
<h1>Wrap-Up</h1>&#13;
&#13;
<p>You should now have a very good feel for the types of things you can accomplish with Docker Compose and how you can use this tool to decrease the toil and increase the repeatability of your development environments.</p>&#13;
&#13;
<p>In the next chapter, we will explore some of the tools that are available to help you scale Docker inside your data center and in the cloud.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm46803138496976"><sup><a href="ch08.html#idm46803138496976-marker">1</a></sup> Full URL: <a class="bare" href="https://ifarchive.org/indexes/if-archiveXgamesXzcode.html"><em class="hyperlink">https://ifarchive.org/indexes/if-archiveXgamesXzcode.html</em></a></p></div></div></section></body></html>