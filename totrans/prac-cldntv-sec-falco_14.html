<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Using Falco for Cloud Security"><div class="chapter" id="using_falco_for_cloud_se">
<h1><span class="label">Chapter 11. </span>Using Falco for Cloud Security</h1>
<p><a contenteditable="false" data-primary="cloud security" data-type="indexterm" id="ch11.html0"/>Now that you’ve learned all you need to know about configuring and running Falco, it’s time to focus on an important topic that can have a huge impact on your security posture: cloud security.</p>
<p>If you are reading this book, there is a good chance that some of your software (or all of it!) runs in the cloud. Since AWS is the leading provider of cloud services, there is also a good chance that your software is running there.</p>
<p>Public clouds are great environments to run software. Their support for elasticity, flexibility, and automation makes building and running apps easier and more efficient. However, cloud-based apps and the data they use are exposed to attacks from the whole planet. They are also exposed to misconfigurations, mistakes, and malicious behavior from internal teams.</p>
<p>A comprehensive security posture needs to take many domains into account, including applications, users (external and internal), and data. Failing to properly protect any one of these domains will result in gaps and therefore in risk. For example, protecting workloads that run in containers and hosts (which you can do effectively with Falco) is not beneficial unless you also cover the cloud infrastructure where these workloads run.</p>
<p>Fortunately, Falco can bridge this gap and help you achieve the coverage you need. Let’s learn how!</p>
<section data-type="sect1" data-pdf-bookmark="Why Falco for AWS Security?"><div class="sect1" id="why_falco_for_aws_securityquestion_mark">
<h1>Why Falco for AWS Security?</h1>
<p><a contenteditable="false" data-primary="cloud security" data-secondary="reasons for using Falco for" data-type="indexterm" id="idm45324223893904"/>Cloud security is a fertile and constantly evolving space with many implementation options. Architecturally, most of those options fall into two basic categories:</p>
<ol>
<li><p>Tools that query cloud APIs or watch cloud data stores to detect misconfigurations or vulnerabilities</p></li>
<li><p>Tools that stream cloud logs into a backend, index them, and let you query them</p></li>
</ol>
<p>If your goal is to detect threats in cloud-based software, tools in category 1 won’t be very useful. Polling is great for detecting gaps and validating compliance, but lacks the real-time nature required to detect threats and respond quickly. Category 2 tools are powerful, but also tremendously expensive (especially in environments like the public cloud, where tons of logs are produced) and not friendly to deploy and use.</p>
<p>The Falco runtime security approach provides a very effective solution to this problem. Falco’s philosophy is based on three key concepts. First, it parses data in a streaming fashion to detect threats in real time. Second, it implements detection on top of an engine that is lightweight to run and easy to deploy. Third, it offers a compact rule language that is quick to learn but flexible and expressive. This philosophy, as you’ve seen throughout the book, is very effective with system calls and works equally well when applied to logs like those produced by AWS CloudTrail.</p>
<p>Falco consumes few resources and, most importantly, analyzes the data in a streaming way—no need to perform expensive copies or wait until the data is indexed. Falco looks at your data in real time and notifies you of problems in seconds. Getting it up and running takes only a few minutes, as you saw in <a data-type="xref" href="part01.xhtml#i_the_basics">Part I</a> of this book, and adopting it for both cloud logs and system calls allows a unified approach to threat detection. Let’s look at how it works.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Falco’s Architecture and AWS Security"><div class="sect1" id="falcoapostrophes_architecture_and_aws_s">
<h1>Falco’s Architecture and AWS Security</h1>
<p><a contenteditable="false" data-primary="architecture of Falco" data-secondary="AWS security and" data-type="indexterm" id="ch11.html1"/><a contenteditable="false" data-primary="cloud security" data-secondary="Falco’s architecture and" data-type="indexterm" id="ch11.html2"/>When deployed in the context of AWS infrastructure security, Falco implements detections on top of a specific data source: the logs generated by AWS CloudTrail. The way this works is shown in <a data-type="xref" href="#the_high_level_architecture_of_a_falco">Figure 11-1</a>.</p>
<figure><div id="the_high_level_architecture_of_a_falco" class="figure">
<img src="Images/pcns_1101.png" alt="" width="600" height="99"/>
<h6><span class="label">Figure 11-1. </span>The high-level architecture of a Falco deployment for AWS security</h6>
</div></figure>
<p><a contenteditable="false" data-primary="CloudTrail" data-type="indexterm" id="idm45324223879360"/>CloudTrail is a log aggregation service offered by Amazon. It collects logs from hundreds of AWS services and stores them in S3, using a consistent and well-documented format. CloudTrail is easy to set up and offers a coherent layer that insulates the customer from the complexities of collecting logs of users’ and services’ activity.</p>
<p>CloudTrail events are entries in JSON files that CloudTrail writes in the S3 bucket at regular intervals. Falco understands how to read and parse these events thanks to the CloudTrail plugin (<a data-type="xref" href="#event_collection_with_the_cloudtrail_pl">Figure 11-2</a>), which is created and maintained by the Falco community. (If you need a refresher on what Falco plugins are and how they work, see <a data-type="xref" href="ch04.xhtml#data_source">Chapter 4</a>.)</p>
<figure><div id="event_collection_with_the_cloudtrail_pl" class="figure">
<img src="Images/pcns_1102.png" alt="" width="600" height="313"/>
<h6><span class="label">Figure 11-2. </span>Event collection with the CloudTrail plugin</h6>
</div></figure>
<p>In addition to offering multiple methods to collect CloudTrail logs (more on each of these methods later in the chapter), the CloudTrail plugin extends Falco with AWS-specific fields, which you can use to create rules like this one:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">rule</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Console Login Without MFA</code><code class="w"/>
<code class="w">  </code><code class="nt">desc</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Detect a console login without MFA.</code><code class="w"/>
<code class="w">  </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">&gt;</code><code class="w"/>
<code class="w">    </code><code class="no">ct.name="ConsoleLogin" and ct.error=""</code><code class="w"/>
<code class="w">    </code><code class="no">and ct.user.identitytype!="AssumedRole" </code><code class="w"/>
<code class="w">    </code><code class="no">and json.value[/responseElements/ConsoleLogin]="Success"</code><code class="w"/>
<code class="w">    </code><code class="no">and json.value[/additionalEventData/MFAUsed]="No"</code><code class="w"/>
<code class="w">  </code><code class="nt">output</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">&gt;</code><code class="w"/>
<code class="w">    </code><code class="no">Detected a console login without MFA </code><code class="w"/>
<code class="w">    </code><code class="no">(requesting user=%ct.user, requesting IP=%ct.srcip, AWS region=%ct.region)</code><code class="w"/>
<code class="w">  </code><code class="nt">priority</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CRITICAL</code><code class="w"/>
<code class="w">  </code><code class="nt">source</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">aws_cloudtrail</code><code class="w"/></pre>
<p>Once Falco’s CloudTrail plugin is configured with a CloudTrail trail as an input, Falco will continuously analyze the trail’s upcoming data, providing real-time anomaly and threat detection. It’s like having a security camera for your cloud activity!</p>
<section data-type="sect2" data-pdf-bookmark="Detection Examples"><div class="sect2" id="detection_examples">
<h2>Detection Examples</h2>
<p><a contenteditable="false" data-primary="cloud security" data-secondary="detection examples" data-type="indexterm" id="idm45324223839168"/>Here are some of the things you can detect with Falco when it’s configured for AWS security:</p>
<ul>
<li><p>Someone logs into the AWS console without multifactor authentication (MFA).</p></li>
<li><p>Someone deactivates MFA for the root user.</p></li>
<li><p>Someone creates a new AWS user or group.</p></li>
<li><p>Someone runs instances in a nonapproved region.</p></li>
<li><p>Someone changes the permissions of an S3 bucket.</p></li>
<li><p>Someone disables CloudTrail logging.</p></li>
</ul>
<p>For the full list, refer to the CloudTrail <a href="https://oreil.ly/beQYF">rules file</a>.<a contenteditable="false" data-primary="" data-startref="ch11.html2" data-type="indexterm" id="idm45324223866256"/><a contenteditable="false" data-primary="" data-startref="ch11.html1" data-type="indexterm" id="idm45324223864848"/></p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Configuring and Running Falco for CloudTrail Security"><div class="sect1" id="configuring_and_running_falco_for_cloud">
<h1>Configuring and Running Falco for CloudTrail Security</h1>
<p><a contenteditable="false" data-primary="cloud security" data-secondary="configuring/running Falco for CloudTrail security" data-type="indexterm" id="ch11.html3"/><a contenteditable="false" data-primary="CloudTrail" data-secondary="configuring/running Falco for CloudTrail security" data-type="indexterm" id="ch11.html4"/>This part of the chapter will outline approaches to setting up cloud security using Falco, describe the components, and guide you through configuring everything properly. As we mentioned, Falco’s integration with CloudTrail happens through the <a href="https://oreil.ly/OWVgb">CloudTrail plugin</a>. The plugin can be configured to receive log files in three different ways:</p>
<ul>
<li><p>A Simple Queue Service (SQS) queue that passes along Simple Notification Service (SNS) notifications about new log files</p></li>
<li><p>An S3 bucket</p></li>
<li><p>A local filesystem path</p></li>
</ul>
<p>Of these three methods, the first one is what you will use in the vast majority of production situations, so we will focus on it first.</p>
<section data-type="sect2" data-pdf-bookmark="Receiving Log Files Through an SQS Queue"><div class="sect2" id="receiving_log_files_through_an_sqs_queu">
<h2>Receiving Log Files Through an SQS Queue</h2>
<p><a contenteditable="false" data-primary="CloudTrail" data-secondary="receiving log files through an SQS queue" data-type="indexterm" id="ch11.html5"/><a contenteditable="false" data-primary="log files" data-type="indexterm" id="ch11.html6"/><a contenteditable="false" data-primary="SQS" data-see="Simple Queue Service" data-type="indexterm" id="idm45324223759872"/><a contenteditable="false" data-primary="Simple Queue Service (SQS)" data-secondary="receiving log files through an SQS queue" data-type="indexterm" id="ch11.html7"/>This deployment method consists of leveraging SQS to notify Falco when new CloudTrail logs are produced. Falco monitors the SQS queue and parses new logs in real time when they arrive. The process is depicted in <a data-type="xref" href="#sqs_queue_collection_diagram">Figure 11-3</a>.</p>
<figure><div id="sqs_queue_collection_diagram" class="figure">
<img src="Images/pcns_1103.png" alt="" width="600" height="191"/>
<h6><span class="label">Figure 11-3. </span>SQS queue collection diagram</h6>
</div></figure>
<p>The process of setting up Falco in this configuration involves three steps:</p>
<ol>
<li><p>Creating the CloudTrail trail and configuring it with an SNS topic. The SNS topic detects changes to the S3 bucket where the trail is depositing the files and broadcasts them to the world.</p></li>
<li><p>Creating the SQS queue and attaching it to the SNS topic. This creates an endpoint that Falco can use to detect the arrival of new data.</p></li>
<li><p>Configuring Falco to receive the logs using the SQS queue.</p></li>
</ol>
<p>We will guide you with step-by-step instructions to set all of this up, so you have full knowledge of the moving parts. Before doing that, however, we’ll show you the easy shortcut: a Terraform module that will do the work for you.</p>
<section data-type="sect3" data-pdf-bookmark="Terraform-based deployment"><div class="sect3" id="terraform_based_deployment">
<h3>Terraform-based deployment</h3>
<p><a contenteditable="false" data-primary="Simple Queue Service (SQS)" data-secondary="Terraform-based deployment" data-type="indexterm" id="idm45324223748304"/><a contenteditable="false" data-primary="Terraform" data-type="indexterm" id="idm45324223746848"/>You can find the Terraform module on <a href="https://oreil.ly/4qvQX">GitHub</a>. Clone the repository to your local machine and then execute the following commands:</p>
<pre data-type="programlisting">$ <strong>cd examples/single-account</strong>
$ <strong>terraform init</strong>
$ <strong>terraform validate</strong>
$ <strong>terraform apply</strong></pre>
<p>If all goes well, you should get output that looks like this:</p>
<pre data-type="programlisting">Apply complete! Resources: 14 added, 0 changed, 0 destroyed.
  
Outputs:
  
cloudtrail_sns_subscribed_sqs_arn = "arn:aws:sqs:<em>ZZZZ</em>"
cloudtrail_sns_subscribed_sqs_url = "https://sqs.<em>&lt;REGION&gt;</em>.amazonaws.com/.../
<em>&lt;QUEUE_NAME&gt;</em>"</pre>
<p>You can now use <code><em>&lt;QUEUE_NAME&gt;</em></code> in your <em>falco.yaml</em> file:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">plugins</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cloudtrail</code><code class="w">
</code><code class="w">    </code><code class="nt">library_path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">libcloudtrail.so</code><code class="w">
</code><code class="w">    </code><code class="nt">init_config</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">"</code><code class="w">
</code><code class="w">    </code><code class="nt">open_params</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">sqs://</code><em><code class="s">&lt;QUEUE_NAME&gt;</code></em><code class="s">"</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">json</code><code class="w">
</code><code class="w">    </code><code class="nt">library_path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">libjson.so</code><code class="w">
</code><code class="w">    </code><code class="nt">init_config</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">"</code><code class="w">
</code><code class="nt">load_plugins</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="nv">cloudtrail</code><code class="p-Indicator">,</code><code class="w"> </code><code class="nv">json</code><code class="p-Indicator">]</code></pre>
<p>Next, configure the <code>rules_file</code> section of <em>falco.yaml</em> to load the CloudTrail rules:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">rules_file</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">/etc/falco/aws_cloudtrail_rules.yaml</code><code class="w"/></pre>
<p>and you’re ready to launch Falco!</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Manual deployment"><div class="sect3" id="manual_deployment">
<h3>Manual deployment</h3>
<p><a contenteditable="false" data-primary="Simple Queue Service (SQS)" data-secondary="manual deployment" data-type="indexterm" id="ch11.html8"/>Here are the steps to follow to set up Falco with an SQS queue if you don’t want to use the Terraform script. The first step is to create the trail. You can do this as follows:</p>
<ol>
<li><p>Go to the CloudTrail section of the AWS console.</p></li>
<li><p>Click “Create trail.”</p></li>
<li><p>Name the trail <em>Falco.</em></p></li>
<li><p>As the storage location, you can either pick an existing trail or tell AWS to create a new one.</p></li>
<li><p>Uncheck “Log file SSE-KMS encryption.” SSE encryption is something you should definitely use as a good practice, but configuring it goes beyond the scope of this chapter.</p></li>
<li><p>Check “SNS notification delivery.”</p></li>
<li><p>Under “Create a new SNS topic,” select New and name the topic <em>falco-cloudtrail-logs</em>.</p></li>
<li><p>Click Next.</p></li>
<li><p>The “Choose log events” page lets you pick which logs you want to capture. The default settings are enough for Falco to operate properly. Checking “Data events” or “Exclude Amazon RDS Data API events” will allow you, if you desire, to craft more granular rules on data events, like S3 bucket-level and object-level access.</p></li>
<li><p>Click Next.</p></li>
<li><p>Click “Create trail.”</p></li>
</ol>
<p>Next, create the SQS queue:</p>
<ol>
<li><p>Go to the SQS section of the AWS console.</p></li>
<li><p>Click “Create queue.”</p></li>
<li><p>Name the queue <em>falco-queue</em>.</p></li>
<li><p>The default access policy will work as is with Falco. However, consider implementing a less privileged access policy, for example using the <a href="https://oreil.ly/fyxDD">AWS Policy <span class="keep-together">Generator</span></a>.</p></li>
<li><p>Click “Create queue” at the bottom of the page. This will bring you to the <em>falco-queue</em> details page.</p></li>
<li><p>Click “Subscribe to Amazon SNS topic.”</p></li>
<li><p>Select the topic whose name ends in <em>falco-cloudtrail-logs</em>.</p></li>
<li><p>Click Save.</p></li>
</ol>
<p>Now you need to configure Falco. This involves setting up AWS authentication and configuring Falco itself. To read log files from an S3 bucket or SNS notifications from an SQS queue Falco needs authentication credentials, and it needs to be configured with an AWS region. Falco relies on the same authentication mechanisms used by the <a href="https://oreil.ly/DmUSL">AWS Go SDK</a>: environment variables or shared configuration files. Configure these as follows:</p>
<dl>
<dt>Environment variables</dt>
<dd><p>Specify the AWS region with <code>AWS_REGION=<em>xxx</em></code>, the access key ID with <code>AWS_ACCESS_KEY_ID=<em>xxx</em></code>, and the secret key with <code>AWS_SECRET_ACCESS_KEY=<em>xxx</em></code>. Here’s a sample command line:</p>
<pre data-type="programlisting">AWS_DEFAULT_REGION=us-west-1 \
AWS_ACCESS_KEY_ID=<em>xxx</em> \
AWS_SECRET_ACCESS_KEY=<em>xxx</em> \
falco -c <em>&lt;path-to-falco.yaml&gt;</em> -r <em>&lt;path-to-falco-rules&gt;</em></pre></dd>
<dt>Shared configuration files</dt>
<dd><p>Specify the AWS region in a file at <em>$HOME/.aws/config</em> and the credentials in a file at <em>$HOME/.aws/credentials</em>. Here are some examples of what these files will look like:</p>
<pre data-type="programlisting"><strong>$HOME/.aws/config</strong>
[default]
region = us-west-1
  
<strong>$HOME/.aws/credentials</strong>
[default]
aws_access_key_id=<em>&lt;YOUR-AWS-ACCESS-KEY-ID-HERE&gt;</em>
aws_secret_access_key=<em>&lt;YOUR-AWS-SECRET-ACCESS-KEY-HERE&gt;</em></pre></dd>
</dl>
<p>Now, set up Falco itself:</p>
<ol>
<li><p>Add the following snippet to <em>falco.yaml</em> to configure SQS-based log collection:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">plugins</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cloudtrail</code><code class="w"/>
<code class="w">    </code><code class="nt">library_path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">libcloudtrail.so</code><code class="w"/>
<code class="w">    </code><code class="nt">init_config</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="w"/>
<code class="w">    </code><code class="nt">open_params</code><code class="p">:</code><code class="w"> </code><code class="s">"sqs://falco-queue"</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">json</code><code class="w"/>
<code class="w">    </code><code class="nt">library_path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">libjson.so</code><code class="w"/>
<code class="w">    </code><code class="nt">init_config</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="w"/>
<code class="nt">load_plugins</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="nv">cloudtrail</code><code class="p-Indicator">,</code><code class="w"> </code><code class="nv">json</code><code class="p-Indicator">]</code><code class="w"/></pre></li>
<li><p>Configure the <code>rules_file</code> section of <em>falco.yaml</em> to load the CloudTrail rules:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">rules_file</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">/etc/falco/aws_cloudtrail_rules.yaml</code><code class="w"/></pre></li>
<li><p>Start Falco.</p></li>
</ol>
<p><em>Et voilà:</em> your AWS infrastructure is now protected<a contenteditable="false" data-primary="" data-startref="ch11.html8" data-type="indexterm" id="idm45324223541584"/>!<a contenteditable="false" data-primary="" data-startref="ch11.html7" data-type="indexterm" id="idm45324223540176"/><a contenteditable="false" data-primary="" data-startref="ch11.html6" data-type="indexterm" id="idm45324223483024"/><a contenteditable="false" data-primary="" data-startref="ch11.html5" data-type="indexterm" id="idm45324223481648"/></p>
</div></section>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Reading Events from an S3 Bucket or the Local Filesystem"><div class="sect2" id="reading_events_from_an_sthree_bucket_or">
<h2>Reading Events from an S3 Bucket or the Local Filesystem</h2>
<p><a contenteditable="false" data-primary="CloudTrail" data-secondary="reading events from an S3 bucket or local filesystem" data-type="indexterm" id="ch11.html9"/>While the SQS-based setup is recommended for real-time detection, Falco can also read CloudTrail logs directly from the S3 bucket or from a copy of the logs stored in the local filesystem. While the SQS setup processes “live” logs as they arrive, the S3 and local filesystem setups read stored data. This means they effectively operate in the past and cause Falco to exit when they reach the end of the currently stored data. This approach can be valuable for a couple of reasons. First, it allows you to iterate quickly during rule development. Second, it allows you to run Falco “back in time” on CloudTrail logs that have already been stored (even if they’ve been stored for a long time). Curious if (or when) somebody has changed the permissions of a bucket during the last three weeks? Point Falco to the logs and you can find out easily!</p>
<p>Let’s take a look at how to run Falco in this mode.</p>
<section data-type="sect3" data-pdf-bookmark="S3 bucket"><div class="sect3" id="sthree_bucket">
<h3>S3 bucket</h3>
<p><a contenteditable="false" data-primary="S3 bucket, reading CloudTrail logs from" data-type="indexterm" id="idm45324223469920"/>First, you need to set up AWS authentication. We just described how to do this for SQS access, and it works exactly the same for S3, so just go back and follow the steps at the end of the previous section.</p>
<p>Once you’ve configured AWS authentication, add the following snippet to <em>falco.yaml</em>:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">plugins</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cloudtrail</code><code class="w"/>
<code class="w">    </code><code class="nt">library_path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">libcloudtrail.so</code><code class="w"/>
<code class="w">    </code><code class="nt">init_config</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">s3DownloadConcurrency</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">64</code><code class="w"/>
<code class="w">    </code><code class="nt">open_params</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">&gt;</code><code class="w"/>
<code class="w">        </code><code class="no">s3://my-s3-bucket/AWSLogs/411571310278/CloudTrail/us-west-1/2021/09/23/</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">json</code><code class="w"/>
<code class="w">    </code><code class="nt">library_path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">libjson.so</code><code class="w"/>
<code class="w">    </code><code class="nt">init_config</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="w"/>
<code class="w">    </code><code class="nt">load_plugins</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="nv">cloudtrail</code><code class="p-Indicator">,</code><code class="w"> </code><code class="nv">json</code><code class="p-Indicator">]</code><code class="w"/></pre>
<p>Note how the <code>open_params</code> key is just the URI of the trail location on S3, which you can easily obtain by navigating to the data in the S3 console and then clicking “Copy S3 URI.” You don’t need to specify the whole bucket; you can point to a subdirectory or even a specific log file.</p>
<p>Now you need to configure the <code>rules_file</code> section of <em>falco.yaml</em> to load the CloudTrail rules:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">rules_file</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">/etc/falco/aws_cloudtrail_rules.yaml</code><code class="w"/></pre>
<p>After that, you can just run Falco. It will process every file below the provided S3 URI and return when it’s done.</p>
<p>Parsing the logs from a machine outside AWS, such as your laptop, might be pretty slow, because the machine needs to download the data in order to process it. You can speed things up by increasing the download concurrency (<code>s3DownloadConcurrency</code> in the <code>init_config</code> key), or predownload the data locally using the AWS CLI and then point Falco to the local logs (which we’ll describe next).</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Local filesystem path"><div class="sect3" id="local_filesystem_path">
<h3>Local filesystem path</h3>
<p>You can process CloudTrail logs stored in the local filesystem by putting the following configuration in <em>falco.yaml</em>:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">plugins</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cloudtrail</code><code class="w"/>
<code class="w">    </code><code class="nt">library_path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">libcloudtrail.so</code><code class="w"/>
<code class="w">    </code><code class="nt">init_config</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="w"/>
<code class="w">    </code><code class="nt">open_params</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">&gt;</code><code class="w"/>
<code class="w">        </code><code class="no">/home/user/cloudtrail-logs/059797578166_CloudTrail_us-east-1_2021...</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">json</code><code class="w"/>
<code class="w">    </code><code class="nt">library_path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">libjson.so</code><code class="w"/>
<code class="w">    </code><code class="nt">init_config</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="w"/>
<code class="w">    </code><code class="nt">load_plugins</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="nv">cloudtrail</code><code class="p-Indicator">,</code><code class="w"> </code><code class="nv">json</code><code class="p-Indicator">]</code><code class="w"/></pre>
<p>You can point to a single file or to a directory, in which case Falco will recursively read all of the files in the directory.</p>
<p>You will also need to edit the <code>rules_file</code> section of <em>falco.yaml</em> to load the CloudTrail rules:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">rules_file</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">/etc/falco/aws_cloudtrail_rules.yaml</code><code class="w"/></pre>
<p>Once you’ve done that, just run Falco. It will process all of the files and exit when it’s done<a contenteditable="false" data-primary="" data-startref="ch11.html9" data-type="indexterm" id="idm45324223249136"/>.<a contenteditable="false" data-primary="" data-startref="ch11.html4" data-type="indexterm" id="idm45324223247792"/><a contenteditable="false" data-primary="" data-startref="ch11.html3" data-type="indexterm" id="idm45324223210000"/></p>
</div></section>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Extending Falco’s AWS Ruleset"><div class="sect1" id="extending_falcoapostrophes_aws_ruleset">
<h1>Extending Falco’s AWS Ruleset</h1>
<p><a contenteditable="false" data-primary="cloud security" data-secondary="extending Falco’s AWS ruleset" data-type="indexterm" id="idm45324223206912"/><a contenteditable="false" data-primary="rulesets" data-secondary="extending Falco’s AWS ruleset" data-type="indexterm" id="idm45324223205568"/>Falco comes with a powerful set of CloudTrail-based rules. However, if you need customization, the CloudTrail plugin exports a rich set of fields that you can use to craft your own rules with a high level of granularity.</p>
<p>Writing Falco rules will be extensively covered in <a data-type="xref" href="ch13.xhtml#writing_falco_rules">Chapter 13</a>. However, since that chapter is primarily focused on system call–based rules, here are a couple of tips that will help you get started with cloud rules development:</p>
<ul>
<li><p>CloudTrail rules need to include the following key: <code>source: aws_cloudtrail</code>. This tells Falco that the fields in the rule condition and output must come from the CloudTrail plugin.</p></li>
<li><p>You can obtain a list of fields you can use in a CloudTrail rule by using the <code>--list=aws_cloudtrail</code> Falco command-line switch. Also, take a look at <a data-type="xref" href="ch06.xhtml#cloudtrail_filter_class_fields">Table 6-10</a> in <a data-type="xref" href="ch06.xhtml#fields_and_filters">Chapter 6</a>.</p></li>
</ul>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What About Other Clouds?"><div class="sect1" id="what_about_other_cloudsquestion_mark">
<h1>What About Other Clouds?</h1>
<p><a contenteditable="false" data-primary="cloud security" data-secondary="for clouds other than AWS" data-secondary-sortas="clouds" data-type="indexterm" id="idm45324223178656"/>AWS is a very important player in cloud computing, so Falco added support for it first. However, at the time of writing the Falco community was working on adding support for both Microsoft Azure and Google Cloud Platform. Expect more clouds to be added in the long term!</p>
<p>If you want to find out if Falco supports your cloud, check out the <a href="https://oreil.ly/W20tv">plugins repository on GitHub</a>.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="conclusion-id000010">
<h1>Conclusion</h1>
<p>In this chapter, you learned that Falco is about more than system calls and containers, and how you can employ it to protect your cloud software and vastly improve your security posture. In the next chapter we will switch to the output side and show you how to collect and treat Falco events.<a contenteditable="false" data-primary="" data-startref="ch11.html0" data-type="indexterm" id="idm45324223173664"/></p>
</div></section>
</div></section></div></body></html>