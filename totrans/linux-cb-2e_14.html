<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. Building a Linux Firewall with firewalld"><div class="chapter" id="cha-firewalld">
<h1><span class="label">Chapter 14. </span>Building a Linux Firewall with firewalld</h1>


<p>This chapter covers the basics of using firewalld to build host firewalls.
Individual hosts have different requirements. For example, a server has
to allow different types of incoming connection requests, and a PC running no
services does not have to accept any connection requests. A laptop that is used
to access multiple networks needs dynamic firewall management.</p>






<section data-type="sect1" class="orm:non-recipe" data-pdf-bookmark="firewalld Overview"><div class="sect1" id="ch14-overview">
<h1>firewalld Overview</h1>

<p>firewalld, like <a data-type="indexterm" data-primary="firewalld" data-secondary="overview" id="firewalld-overview"/><a data-type="indexterm" data-primary="firewalls" data-secondary="firewalld" data-see="firewalld" id="idm46466156473272"/>all firewalls, has a very long list of capabilities. We will
mainly learn about using <a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="purpose of" id="firewalld-zone-purpose"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="purpose of" id="zone-purpose"/>firewalld <em>zones</em> to control traffic entering our
systems. A zone is a container for a level of trust; for example, some zones
allow all manner of incoming connection requests, and some are very restrictive.
Each network interface on a system may be assigned only one zone, and one zone
may be assigned to multiple interfaces.</p>
<div data-type="note" epub:type="note"><h1>Networking Knowledge Required</h1>
<p>The most <a data-type="indexterm" data-primary="networking" data-secondary="resources for information" id="idm46466156466600"/>important networking concepts to understand are ports, services, TCP, UDP, port forwarding, masquerade, routing, and IP addressing.
You will understand how to configure your firewall when you understand these.
If you need some coaching on computer networking, try <em>Networking Fundamentals</em>
by Gordon Davies (Packt Publishing), or <em>Networking All-in-One For Dummies</em>, 7th Edition by
Doug Lowe (For Dummies). If you have an <a href="https://oreil.ly/mEsNB">O’Reilly Learning Platform subscription</a>,
you will find a wealth of great information.</p>
</div>

<p>The traditional Linux firewall is built with<a data-type="indexterm" data-primary="netfilter" id="idm46466156464392"/> the <em>netfilter</em> packet-filtering
framework in the Linux kernel, which filters incoming and outgoing network traffic,
and <em>iptables</em>, which <a data-type="indexterm" data-primary="iptables" id="idm46466156463368"/>is the software used to create and manage tables of rules to
filter your traffic.</p>

<p>Times change, <a data-type="indexterm" data-primary="ufw (Uncomplicated Firewall)" id="idm46466156460216"/><a data-type="indexterm" data-primary="nftables" id="idm46466156458744"/>and iptables is being replaced by newer rules managers, such
as <em>ufw</em> (Uncomplicated Firewall), <em>nftables</em> (Netfilter tables), and
<em>firewalld</em> (firewall daemon). firewalld, like iptables and nftables, uses tables
of rules to manage traffic filtering. It provides both a command-line interface and
a nice<a data-type="indexterm" data-primary="firewall-config interface" id="idm46466156456424"/> graphical interface, <em>firewall-config</em>. firewalld is a frontend to both
iptables and nftables. nftables is a significant improvement over iptables and
is intended to be the default backend for firewalld, but in some Linux distributions
iptables is still the default. Set your preferred backend in
<em>/etc/firewalld/firewalld.conf</em> with the <em>FirewallBackend</em> option
(<a data-type="xref" href="#rec-firewall-backend">Recipe 14.4</a>).</p>

<p>firewalld comes with<a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="purpose of" data-startref="firewalld-zone-purpose" id="idm46466156453080"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="purpose of" data-startref="zone-purpose" id="idm46466156451752"/> predefined sets of rules, called <em>zones</em>, for different
use cases, such as a machine running no services, a machine running services,
and different zones for different network interfaces on the same machine. You can
edit these zones to suit your own requirements.</p>

<p>firewalld zones <a data-type="indexterm" data-primary="services" data-secondary="in firewalld" data-secondary-sortas="firewalld" id="idm46466156448888"/>manage <em>services</em>, which are configurations for common
services such as ssh, imaps, and rsync. Most of the predefined services
include only the standard port assignments. You may edit these as you need and
create your own custom zones.</p>

<p>firewalld is integrated with NetworkManager, so you don’t have to worry about
managing dynamic connections, like when you tote your laptop all over and connect
to different networks.</p>
<div data-type="note" epub:type="note"><h1>The NetworkManager Service</h1>
<p>NetworkManager <a data-type="indexterm" data-primary="NetworkManager" id="idm46466156443768"/>has been an important part of Linux since 2004. NetworkManager
replaced a hodgepodge of cumbersome network client tools and
manages all of your network interfaces and network connections. If you’re not
familiar with NetworkManager, see
<a href="https://oreil.ly/hkqaq">GNOME NetworkManager</a>.</p>
</div>

<p>If you are running public servers on a commercial hosting service, your firewall
setup depends on what your service provider supports. Protecting public servers,
such as web servers and online storefronts, whether they are remotely hosted or
in your own datacenter, requires a great deal of skill and care that is beyond
the scope of this book. Do please get in-depth study and training, or <a data-type="indexterm" data-primary="firewalld" data-secondary="overview" data-startref="firewalld-overview" id="idm46466156446600"/>hire
experts.</p>








<section data-type="sect2" class="orm:non-recipe" data-pdf-bookmark="How Firewalls Work"><div class="sect2" id="idm46466156441032">
<h2>How Firewalls Work</h2>

<p>Once <a data-type="indexterm" data-primary="firewalls" data-secondary="operational overview" id="firewalls-operation"/>upon a time, Ubuntu Linux did not ship with a firewall, because the default
installation had no public services, and therefore no listening network ports.
The reasoning was that with no listening ports there were no points of attack.
Fortunately, this decision was reversed in later releases, because users make
changes, even the most experts users make mistakes, and attackers are always
discovering new vulnerabilities. Security is a multilayered process.</p>

<p>Let’s look at how firewalls work. The basic principle is deny all, allow only as
needed.</p>

<p>A network service, such as an SSH server, needs to open a network port to enable
remote users to log in. You are allowing other people into your system. The
default port <a data-type="indexterm" data-primary="sshd" data-secondary="ports" id="idm46466156433864"/><a data-type="indexterm" data-primary="ports" data-secondary="sshd" id="idm46466156434888"/>for <em>sshd</em> is TCP port 22. You can see all the listening ports on
your system with <a data-type="indexterm" data-primary="netstat command" id="idm46466156432328"/>the <em>netstat</em> command. This snippet shows what the SSH port
looks like:</p>
<pre>$ <strong>sudo netstat -untap | sed '2p;/ssh/!d'</strong>
Proto Recv-Q Send-Q Local Address  Foreign Address  State   PID/Program name
tcp        0      0 0.0.0.0:22     0.0.0.0:*        LISTEN  1296/sshd: /usr/sbi
tcp6       0      0 :::22          :::*             LISTEN  1296/sshd: /usr/sbi
</pre>

<p>This example shows that there is not an active connection because the Foreign Address
fields are all zeroes and the State is LISTEN. <em>sshd</em> is listening for incoming IPv4 and
IPv6 connections on all network interfaces and all IP addresses on TCP port 22.
The combination of IP address and port number is an address that tells the Linux
kernel where to send SSH packets.</p>

<p>This example shows an active SSH connection, with the ESTABLISHED State. It
lists the local address and port that the remote machine is connected to, and the
foreign address and port of the remote machine (the Recv-Q and Send-Q columns have been removed for clarity):</p>
<pre class="codeblock-small">$ <strong>sudo netstat -untap | sed '2p;/ssh/!d'</strong>
Proto  Local Address     Foreign Address      State       PID/Program name
tcp    0.0.0.0:22        0.0.0.0:*            LISTEN      1296/sshd: /usr/sbi
tcp    192.168.1.97:22   192.168.1.91:56142   ESTABLISHED 13784/sshd: duchess
tcp6   :::22             :::*                 LISTEN      1296/sshd: /usr/sbi</pre>

<p>There are several ways to control which TCP/IP packets can access a
particular IP address and port. Most servers have configuration
options to listen only on particular network interfaces or IP addresses, and to
accept requests from specific addresses and address ranges. A firewall adds
additional controls, and it is a best practice to use<a data-type="indexterm" data-primary="firewalls" data-secondary="operational overview" data-startref="firewalls-operation" id="idm46466156425032"/> both.</p>
</div></section>













<section data-type="sect2" class="orm:non-recipe" data-pdf-bookmark="Network Ports and Numbering"><div class="sect2" id="idm46466156440568">
<h2>Network Ports and Numbering</h2>

<p>There <a data-type="indexterm" data-primary="networking" data-secondary="ports, numbering" id="network-port-number"/><a data-type="indexterm" data-primary="ports" data-secondary="numbering" id="ports-number"/>are 65,536 possible network ports on a Linux system, numbered 0-65535,
and many of them are reserved for specific services. 0 is reserved and not used.
You can see all of these in the <em>/etc/services</em> file, which is on every Linux.
See the
<a href="https://oreil.ly/CF0bF">IANA Service Name and Transport Protocol Port Number Registry</a>
for the complete official list.</p>

<p class="pagebreak-before less_space">This is how the port numbering ranges are organized:</p>

<ul>
<li>
<p>0-1023 are called<a data-type="indexterm" data-primary="well-known ports" id="idm46466156419592"/> the <em>well-known ports</em>. These are system ports for common
services, such as FTPS (secure file sharing), SSH (secure remote login), NTP
(Network Time Protocol), POP3 (email), HTTPS (encrypted web server), and so on.</p>
</li>
<li>
<p>1024-49151 are <a data-type="indexterm" data-primary="registered ports" id="idm46466156414856"/>the <em>registered ports</em>, which are for additional services.</p>
</li>
<li>
<p>49152-65535 are <a data-type="indexterm" data-primary="ephemeral ports" id="idm46466156412632"/><a data-type="indexterm" data-primary="private ports" id="idm46466156411752"/><a data-type="indexterm" data-primary="dynamic ports" id="idm46466156411144"/>the <em>ephemeral ports</em>, also called private ports and dynamic
ports. These are used by your system to complete connections with remote
services. For example, when you are web surfing, it looks like this in
<em>netstat</em> (the Recv-Q and Send-Q columns have been removed for clarity):</p>
</li>
</ul>
<pre class="codeblock-small">$ <strong>sudo netstat -untap</strong>
Proto  Local Address         Foreign Address    State        PID/Program name
[...]
tcp    192.168.43.234:50586  72.21.91.66:443    ESTABLISHED  2798/firefox
tcp    192.168.43.234:38262  52.36.174.147:443  ESTABLISHED  6481/chrome
tcp    192.168.43.234:53232  99.86.33.45:443    ESTABLISHED  2798/firefox
[...]
</pre>

<p>This illustrates a response to an outgoing request from your computer. When you
visit a website you initiate the connection request, and the remote web server
sends responses to ephemeral network ports on your system. The first connection
on the list is connected to the example local computer at IP address
192.168.43.234, port 50586. The Foreign Address is the remote server’s IP address
and port. The state ESTABLISHED means it is connected to another machine. When
the session is finished, after closing the web browser, port 50586 is released
and ready to be used again.</p>

<p>Ephemeral ports are not listening ports for services. Connections to ephemeral
ports are temporary, and are created only as replies to an outgoing connection
request from your computer, such as visiting a website. A firewall can block
ephemeral ports, but then you have no access to hosts or sites outside of<a data-type="indexterm" data-primary="networking" data-secondary="ports, numbering" data-startref="network-port-number" id="idm46466156402552"/><a data-type="indexterm" data-primary="ports" data-secondary="numbering" data-startref="ports-number" id="idm46466156401880"/> your
computer.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.1 Querying Which Firewall Is Running"><div class="sect1" id="idm46466156475864">
<h1>14.1 Querying Which Firewall Is Running</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156404344">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="firewalls" data-secondary="determining active" id="firewalls-active"/>need to know which firewall your Linux system is using.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156399704">
<h2>Solution</h2>

<p>Start with the documentation for your particular Linux distribution, as most
Linuxes install with a firewall. The <a data-type="indexterm" data-primary="iptables" id="idm46466156397688"/><a data-type="indexterm" data-primary="nftables" id="idm46466156397304"/><a data-type="indexterm" data-primary="ufw (Uncomplicated Firewall)" id="idm46466156396920"/>three most common are
<em>iptables</em> (Internet Protocol tables), <em>ufw</em> (Uncomplicated Firewall), and
<em>nftables</em> (Netfilter tables). All three manage filter rules on the netfilter
framework, which is part of the Linux kernel.</p>

<p>Then see what systemd says. This example shows that nftables is running:</p>
<pre>$ <strong>systemctl status nftables.service</strong>
    ● nftables.service - Netfilter Tables
     Loaded: loaded (/usr/lib/systemd/system/nftables.service; disabled; vendor&gt;
     Active: active (exited) since Sat 2020-10-17 13:15:05 PDT; 4s ago
       Docs: man:nft(8)
    Process: 3276 ExecStart=/sbin/nft -f /etc/sysconfig/nftables.conf (code=exi&gt;
   Main PID: 3276 (code=exited, status=0/SUCCESS)
   [...]
</pre>

<p>This shows firewalld is running:</p>
<pre>$ <strong>systemctl status firewalld.service</strong>
● firewalld.service - firewalld - dynamic firewall daemon
Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor&gt;
     Active: active (running) since Sat 2020-10-17 12:36:20 PDT; 37min ago
       Docs: man:firewalld(1)
   Main PID: 775 (firewalld)
      Tasks: 2 (limit: 4665)
     Memory: 40.9M
     [...]
</pre>

<p>This example checks for ufw and shows that it is installed but inactive:</p>
<pre>$ <strong>systemctl status ufw.service</strong>
● ufw.service - Uncomplicated firewall
     Loaded: loaded (/lib/systemd/system/ufw.service; disabled; vendor preset:
enabled)
     Active: inactive (dead)
       Docs: man:ufw(8)
</pre>

<p>If any of them are not installed, you will see a message to that effect.</p>

<p>You could remove ufw and nftables, or mask them so that they cannot be
started:</p>
<pre>$ <strong>sudo systemctl stop ufw.service</strong>
$ <strong>sudo systemctl mask ufw.service</strong>
</pre>
<pre>$ <strong>sudo systemctl stop nftables.service</strong>
$ <strong>sudo systemctl mask nftables.service</strong>
</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156384296">
<h2>Discussion</h2>

<p>It is best to run only one firewall, unless you enjoy untangling conflicting
firewall<a data-type="indexterm" data-primary="firewalls" data-secondary="determining active" data-startref="firewalls-active" id="idm46466156381688"/> rules.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156398792">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch04.xhtml#cha-systemd">Chapter 4</a></p>
</li>
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.2 Installing firewalld"><div class="sect1" id="idm46466156376520">
<h1>14.2 Installing firewalld</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156375416">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="firewalld" data-secondary="installing" id="firewalld-install"/><a data-type="indexterm" data-primary="installing" data-secondary="firewalld" id="install-firewalld"/> need to install firewalld on your Linux system.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156371800">
<h2>Solution</h2>

<p>If firewalld is not on your system, install the <em>firewalld</em> package, and install
<em>firewall-config</em> to get the nice graphical interface.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156368904">
<h2>Discussion</h2>

<p>So far, the major Linux distributions, thankfully, all use the same package names,
<em>firewalld</em> and <em>firewall-config</em>.</p>

<p>firewalld may or may not start automatically after installation, depending on
your Linux distribution. It must be running to create and test rules.</p>

<p>If possible, disable your machine’s network connection until you have completed
your initial firewalld configuration. Disconnect<a data-type="indexterm" data-primary="networking" data-secondary="disconnecting" id="idm46466156362920"/><a data-type="indexterm" data-primary="disconnecting from network" id="idm46466156364888"/> from your network
by clicking the NetworkManager applet, which is installed by default on most
Linux distributions (<a data-type="xref" href="#fig-firewalld-2">Figure 14-1</a>).</p>

<figure><div id="fig-firewalld-2" class="figure">
<img src="Images/lcb2_1401.png" alt="Disconnecting from the network." width="340" height="335"/>
<h6><span class="label">Figure 14-1. </span>Disconnect from the network with NetworkManager</h6>
</div></figure>

<p>Or use <a data-type="indexterm" data-primary="nmcli command" id="idm46466156360104"/>the <em>nmcli</em> command. The following example finds and disconnects a WiFi
connection. Use the CONNECTION name in your command:</p>
<pre>$ <strong>nmcli device status</strong>
DEVICE  TYPE  STATE        CONNECTION
wlan0   wifi  connected    ACCESS_POINTE

$ <strong>nmcli connection down ACCESS_POINTE</strong>
Connection 'ACCESS_POINTE' successfully deactivated
(D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/4)</pre>

<p>Restore the connection:</p>
<pre>$ <strong>nmcli connection up ACCESS_POINTE</strong>
Connection successfully activated
(D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/7)</pre>

<p>Manage<a data-type="indexterm" data-primary="systemctl command" data-secondary="firewalld management" id="idm46466156354648"/> firewalld the usual way with systemd.
Here are the <a data-type="indexterm" data-primary="firewalld" data-secondary="installing" data-startref="firewalld-install" id="idm46466156352600"/><a data-type="indexterm" data-primary="installing" data-secondary="firewalld" data-startref="install-firewalld" id="idm46466156351512"/>commands:</p>

<ul>
<li>
<p><em>systemctl status firewalld.service</em></p>
</li>
<li>
<p><em>sudo systemctl enable firewalld.service</em></p>
</li>
<li>
<p><em>sudo systemctl start firewalld.service</em></p>
</li>
<li>
<p><em>sudo systemctl stop firewalld.service</em></p>
</li>
<li>
<p><em>sudo systemctl restart firewalld.service</em></p>
</li>
</ul>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156368440">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch04.xhtml#cha-systemd">Chapter 4</a></p>
</li>
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
<li>
<p>The <a data-type="xref" href="app01.xhtml#appendix">Appendix</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.3 Finding Your firewalld Version"><div class="sect1" id="idm46466156339160">
<h1>14.3 Finding Your firewalld Version</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156338312">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="firewalld" data-secondary="version, determining" id="idm46466156336664"/> need the version number of your installed firewalld.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156335528">
<h2>Solution</h2>

<p>Query the installed package with your package manager, or <a data-type="indexterm" data-primary="firewall-cmd command" id="idm46466156332712"/>use <em>firewall-cmd</em>:</p>
<pre>$ <strong>sudo firewall-cmd --version</strong>
0.9.3</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156331240">
<h2>Discussion</h2>

<p>firewalld must be running for the <em>firewall-cmd</em> command to work. If it is not
running you will see a “FirewallD is not running” message.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156329208">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.4 Configuring iptables or nftables as the firewalld Backend"><div class="sect1" id="rec-firewall-backend">
<h1>14.4 Configuring iptables or nftables as the firewalld Backend</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156324312">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="firewalld" data-secondary="iptables/nftables, configuring as backend" id="idm46466156322840"/><a data-type="indexterm" data-primary="iptables" data-secondary="configuring as firewalld backend" id="idm46466156321992"/><a data-type="indexterm" data-primary="nftables" data-secondary="configuring as firewalld backend" id="idm46466156321144"/><a data-type="indexterm" data-primary="configuring" data-secondary="firewalld" data-tertiary="backend" id="idm46466156320296"/>want to choose your own firewalld backend, either iptables or nftables.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156318632">
<h2>Solution</h2>

<p>Edit <em>/etc/firewalld/firewalld.conf</em> with your preference:</p>
<pre>FirewallBackend=nftables</pre>

<p>Or:</p>
<pre>FirewallBackend=iptables</pre>

<p>Then restart firewalld.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156314680">
<h2>Discussion</h2>

<p>You may need to install your preferred backend.</p>

<p>Even if you don’t care which one your system uses, you should use
nftables because that is what the firewalld developers are actively working on.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156313080">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="#ch14-overview">“firewalld Overview”</a></p>
</li>
<li>
<p>The <a href="https://oreil.ly/xO5eS">nftables backend blog post</a> by the firewalld developers has detailed information about the two
backends and future development.</p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.5 Listing All Zones and All Services Managed by &#10;Each Zone"><div class="sect1" id="rec-list-zones">
<h1>14.5 Listing All Zones and All Services Managed by 
<span class="keep-together">Each Zone</span></h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156306072">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="listing" id="firewalld-zone-list"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="listing" id="zone-list"/><a data-type="indexterm" data-primary="listing" data-secondary="firewalld zones" id="list-firewalld-zone"/>want to see all the available zones in your firewalld configuration and
the services that each zone manages.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156299880">
<h2>Solution</h2>

<p>List the default zone:</p>
<pre>$ <strong>firewall-cmd --get-default-zone</strong>
public
</pre>

<p>List all zones:</p>
<pre>$ <strong>firewall-cmd --get-zones</strong>
block dmz drop external home internal public trusted work</pre>

<p>List all active zones, the zones currently in use:</p>
<pre>$ <strong>firewall-cmd --get-active-zones</strong>
internal
  interfaces: eth1
work
  interfaces: wlan0</pre>

<p>List the configuration of a zone:</p>
<pre>$ <strong>sudo firewall-cmd --zone=public --list-all</strong>
public
  target: default
  icmp-block-inversion: no
  interfaces:
  sources:
  services: dhcpv6-client ipp ipp-client mdns ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:</pre>

<p>List the configurations of all zones:</p>
<pre>$ <strong>sudo firewall-cmd --list-all-zones</strong>
[...]</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156299496">
<h2>Discussion</h2>

<p>firewalld zones define levels of trust for network connections. Each zone
contains the zone description and other items as shown in the preceding example
for the <em>public</em> zone. Zone files are in XML format, and must have the <em>.xml</em>
file extension. Look in <em>/usr/lib/firewalld/zones</em> to see their source files.</p>

<p class="pagebreak-before less_space">The following list defines zone options:</p>

<ul>
<li>
<p><em>target:</em> defines the default action for packets that do not match any rules.
It takes one of four values: <em>default</em>, <em>ACCEPT</em>, <em>DROP</em>, or
<em>REJECT</em>. For example, when connection requests for dhcpv6-client,
ipp, ipp-client, mdns, or ssh packets arrive in the example <em>public</em> zone, they are
accepted. Any packets that do not match the allowed services are rejected by
the <em>default</em> target, and it sends reject messages.</p>

<ul>
<li>
<p><em>ACCEPT</em> accepts all packets that are not explicitly blocked by rules.</p>
</li>
<li>
<p><em>DROP</em> silently drops all packets not explicitly allowed.</p>
</li>
<li>
<p><em>REJECT</em> is similar to <em>DROP</em>, except that it also sends reject messages.</p>
</li>
</ul>
</li>
<li>
<p><em>icmp-block-inversion</em> inverts your ICMP requests settings. Any requests that
are blocked are changed to unblocked, and unblocked requests are inverted to
blocked. It is usually set to <em>no</em>.</p>
</li>
<li>
<p><em>interfaces:</em> defines the network interface or interfaces that this zone is
applied to. Each interface may be bound to only one zone, and you may use the same
zone on multiple interfaces.</p>
</li>
<li>
<p><em>source:</em> takes IP and MAC addresses, and IP address ranges. For example, you
can accept only packets from your local network, from specific hosts, or block
hosts or networks.</p>
</li>
<li>
<p><em>services:</em> is the list of services managed by this zone.</p>
</li>
<li>
<p><em>ports:</em> list port numbers managed by this zone.</p>
</li>
<li>
<p><em>protocols:</em> list additional TCP protocols managed by this zone, as shown in
<em>/etc/protocols</em>.</p>
</li>
<li>
<p><em>masquerade:</em> is either <em>yes</em> or <em>no</em>. Masquerading is for sharing an
IPv4 internet connection. Set it to <em>no</em> on all hosts except routers.</p>
</li>
<li>
<p><em>forward-ports:</em> is for forwarding packets that come in on one port to another
port.</p>
</li>
<li>
<p><em>source-ports:</em> is for listing source ports.</p>
</li>
<li>
<p><em>icmp-blocks:</em> is for listing ICMP types to block.</p>
</li>
<li>
<p><em>rich rules</em> are custom rules that you <a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="listing" data-startref="firewalld-zone-list" id="idm46466156261512"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="listing" data-startref="zone-list" id="idm46466156260184"/><a data-type="indexterm" data-primary="listing" data-secondary="firewalld zones" data-startref="list-firewalld-zone" id="idm46466156259096"/>write.</p>
</li>
</ul>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156286536">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
<li>
<p><em>man 5 firewalld.zone</em></p>
</li>
<li>
<p><em>man 1 firewall-cmd</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.6 Listing and Querying Services"><div class="sect1" id="idm46466156252232">
<h1>14.6 Listing and Querying Services</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156251336">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="firewalld" data-secondary="services, listing" id="firewalld-service-list"/><a data-type="indexterm" data-primary="services" data-secondary="in firewalld" data-tertiary="listing" data-secondary-sortas="firewalld" id="service-firewalld-list"/><a data-type="indexterm" data-primary="listing" data-secondary="firewalld services" id="list-firewalld-service"/>want to see a list of services that firewalld supports.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156245608">
<h2>Solution</h2>

<p>Use <a data-type="indexterm" data-primary="firewall-cmd command" id="idm46466156243720"/>the <em>firewall-cmd</em> command:</p>
<pre>$ <strong>sudo firewall-cmd --get-services</strong>
RH-Satellite-6 amanda-client amanda-k5-client amqp amqps apcupsd audit bacula
bacula-client bb bgp bitcoin bitcoin-rpc bitcoin-testnet bitcoin-testnet-rpc
bittorrent-lsd ceph ceph-mon cfengine cockpit condor-collector ctdb dhcp dhcpv6
[...]
</pre>

<p>That is rather a big glob. Convert it to nice tidy single column:</p>
<pre>$ <strong>sudo firewall-cmd --get-services| xargs -n1</strong>
RH-Satellite-6
amanda-client
amanda-k5-client
amqp
amqps
apcupsd
[...]</pre>

<p>Create more columns with <em>xargs -n2</em>, <em>xargs -n3</em>, and so on.</p>

<p>firewalld services can be more than simple port addressing. For example, the
<em>bittorrent-lsd</em> service includes two destination IP addresses:</p>
<pre>$ <strong>sudo firewall-cmd --info-service bittorrent-lsd</strong>
bittorrent-lsd
  ports: 6771/udp
  protocols:
  source-ports:
  modules:
  destination: ipv4:239.192.152.143 ipv6:ff15::efc0:988f
  includes:
  helpers:</pre>

<p>The <em>ceph-mon</em> service opens two listening ports:</p>
<pre>$ <strong>sudo firewall-cmd --info-service ceph-mon</strong>
ceph-mon
  ports: 3300/tcp 6789/tcp
  [...]</pre>

<p>You may edit any of the predefined services to meet your requirements.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156245048">
<h2>Discussion</h2>

<p>When you’re adding services to a zone, use their names exactly as they appear
in the list.
You <a data-type="indexterm" data-primary="firewalld" data-secondary="services, listing" data-startref="firewalld-service-list" id="idm46466156230760"/><a data-type="indexterm" data-primary="services" data-secondary="in firewalld" data-tertiary="listing" data-secondary-sortas="firewalld" data-startref="service-firewalld-list" id="idm46466156230120"/><a data-type="indexterm" data-primary="listing" data-secondary="firewalld services" data-startref="list-firewalld-service" id="idm46466156229224"/>can create your own custom service; see
“Add a Service” in the <a href="https://oreil.ly/kvMYY">firewalld <span class="keep-together">documentation</span></a>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156228200">
<h2>See Also</h2>

<ul class="no-space-list">
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
<li>
<p>“Add a Service” in the <a href="https://oreil.ly/kvMYY">firewalld documentation</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.7 Selecting and Setting Zones"><div class="sect1" id="rec-host-firewall">
<h1>14.7 Selecting and Setting Zones</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156219880">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="selecting/setting" id="firewalld-zone-select"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="selecting/setting" id="zone-select"/><a data-type="indexterm" data-primary="selecting" data-secondary="firewalld zones" id="select-firewalld-zone"/> want to know how to select and set the right zone.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156214728">
<h2>Solution</h2>

<p>The firewalld zone you select depends on which services your machine is running.
If your machine is not running any network services and needs only a
network connection, use the <em>drop</em> or the <em>block</em> zone. The <em>drop</em> zone is
the most restrictive, dropping all incoming connections requests, and allowing
replies only to connections initiated from the computer. <em>block</em> is like
<em>drop</em>, except it sends rejection messages.</p>

<p>The other zones are configured differently on the different Linux distros, so
you need to see how they are configured on your system, like this example for
the <em>work</em> zone:</p>
<pre>$ <strong>sudo firewall-cmd --zone=work --list-all</strong>
work
  target: default
  icmp-block-inversion: no
  interfaces:
  sources:
  services: dhcpv6-client ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:</pre>

<p>You must <a data-type="indexterm" data-primary="binding zones (firewalld) to network interfaces" id="idm46466156210376"/>bind a zone to a network interface. The following example assigns the
<em>work</em> zone to eth0, then verifies it:</p>
<pre>$ <strong>sudo firewall-cmd --zone=work --permanent --change-interface=eth0</strong>
success

$ <strong>sudo firewall-cmd --zone=work --list-interfaces</strong>
eth0
</pre>

<p>If you prefer to test changes before making them permanent, omit the
<em>--permanent</em> option. This creates a <em>runtime</em> configuration, and the change is
immediately applied. Runtime changes are lost when firewalld is restarted and
when you run <em>firewall-cmd --reload</em>. Convert runtime changes to permanent:</p>
<pre>$ <strong>sudo firewall-cmd --runtime-to-permanent</strong></pre>

<p>It is not necessary to reload the firewalld configuration when you bind a zone to
a network interface or restart firewalld.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156201688">
<h2>Discussion</h2>

<p>How <a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="predefined" id="firewalld-zone-predefined"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="predefined" id="zone-predefined"/>do you know which zone to select? These are the predefined zones that come
with firewalld on Ubuntu 20.04, in order from most restrictive to least
restrictive. Zones may be configured a little differently on your Linux; see
<a data-type="xref" href="#rec-list-zones">Recipe 14.5</a> to learn how view your zone configurations.</p>

<p>The following list describes the default zones:</p>
<dl>
<dt><em>drop</em></dt>
<dd>
<p>All <a data-type="indexterm" data-primary="drop zone (firewalld)" id="idm46466156193688"/>unsolicited incoming network packets are dropped, and there is no
reply. Only incoming packets that are replies to connections initiated from your
computer are allowed. This is the strongest protection when you are connected to an
untrusted network and don’t need to allow access for incoming SSH connections,
shared files, or any other external connection requests.</p>
</dd>
<dt><em>block</em></dt>
<dd>
<p>Any <a data-type="indexterm" data-primary="block zone (firewalld)" id="idm46466156191160"/>incoming network connections are rejected with an
<em>icmp-host-prohibited</em> message for IPv4, and <em>icmp6-adm-prohibited</em> for IPv6. Only
network connections initiated from your system are allowed.</p>
</dd>
<dt><em>public</em></dt>
<dd>
<p>Incoming<a data-type="indexterm" data-primary="public zone (firewalld)" id="idm46466156187528"/> dhcpv6-client, ipp, ipp-client, mdns, and ssh
connections are accepted, all others are blocked.</p>
</dd>
<dt><em>external</em></dt>
<dd>
<p>This is <a data-type="indexterm" data-primary="external zone (firewalld)" id="idm46466156186216"/>for a simple internet gateway, combining a firewall and
simple routing. Only incoming SSH connections are accepted, and IPv4 masqerading
is enabled for sharing an internet connection.</p>
</dd>
<dt><em>dmz</em></dt>
<dd>
<p>For <a data-type="indexterm" data-primary="dmz zone (firewalld)" id="idm46466156182744"/>computers in your demilitarized zone that are publicly accessible.
Only incoming SSH connections are accepted. (A DMZ is a separate network segment
on your network for internet-facing servers.)</p>
</dd>
<dt><em>work</em></dt>
<dd>
<p>Only <a data-type="indexterm" data-primary="work zone (firewalld)" id="idm46466156180152"/>incoming ssh and dhcpv6-client connections are accepted.</p>
</dd>
<dt><em>home</em></dt>
<dd>
<p>Only <a data-type="indexterm" data-primary="home zone (firewalld)" id="idm46466156177464"/>incoming ssh, mdns samba-client, and dhcpv6-client
connection requests are accepted.</p>
</dd>
<dt><em>internal</em></dt>
<dd>
<p>Only <a data-type="indexterm" data-primary="internal zone (firewalld)" id="idm46466156175240"/>incoming ssh, mdns, samba-client, and dhcpv6-client
connection requests are accepted.</p>
</dd>
<dt><em>trusted</em></dt>
<dd>
<p>All <a data-type="indexterm" data-primary="trusted zone (firewalld)" id="idm46466156172824"/>network connection requests are accepted.</p>
</dd>
</dl>

<p>You may customize any of these <a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="predefined" data-startref="firewalld-zone-predefined" id="idm46466156171512"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="predefined" data-startref="zone-predefined" id="idm46466156169944"/><a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="selecting/setting" data-startref="firewalld-zone-select" id="idm46466156168856"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="selecting/setting" data-startref="zone-select" id="idm46466156167336"/><a data-type="indexterm" data-primary="selecting" data-secondary="firewalld zones" data-startref="select-firewalld-zone" id="idm46466156165992"/>zones or create new zones; see <a data-type="xref" href="#rec-custom-zones">Recipe 14.9</a>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156201400">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="#rec-custom-zones">Recipe 14.9</a></p>
</li>
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.8 Changing the Default firewalld Zone"><div class="sect1" id="idm46466156221048">
<h1>14.8 Changing the Default firewalld Zone</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156157736">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="changing default" id="idm46466156156488"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="changing default" id="idm46466156155400"/><a data-type="indexterm" data-primary="default firewalld zones" data-secondary="changing" id="idm46466156154552"/><a data-type="indexterm" data-primary="changing" data-secondary="default firewalld zones" id="idm46466156153544"/> don’t like your default firewalld zone and want to change it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156152184">
<h2>Solution</h2>

<p>Verify your current default:</p>
<pre>$ <strong>firewall-cmd --get-default-zone</strong>
internal
</pre>

<p>Suppose you want <em>drop</em> as your default, because it is the most restrictive.
Set the new default with the <em>firewall-cmd</em> command:</p>
<pre>$ <strong>sudo firewall-cmd --set-default-zone drop</strong>
success
</pre>

<p>It is not necessary to reload the firewalld configuration or restart firewalld
when you use this command.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156146600">
<h2>Discussion</h2>

<p>You may assign zones with <a data-type="indexterm" data-primary="NetworkManager" data-secondary="firewalld zones, assigning" id="idm46466156145336"/>NetworkManager (<a data-type="xref" href="#sec-networkman-firewalld">Recipe 14.11</a>).
NetworkManager assigns the default zone to all connections that you do not
explicitly assign a zone to.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156143160">
<h2>See Also</h2>

<ul>
<li>
<p>The Discussion in <a data-type="xref" href="#rec-host-firewall">Recipe 14.7</a> to learn about firewalld zones</p>
</li>
<li>
<p><a data-type="xref" href="#sec-networkman-firewalld">Recipe 14.11</a></p>
</li>
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.9 Customizing firewalld Zones"><div class="sect1" id="rec-custom-zones">
<h1>14.9 Customizing firewalld Zones</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156134776">
<h2>Problem</h2>

<p>None <a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="customizing" id="firewalld-zone-custom"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="customizing" id="zone-custom"/><a data-type="indexterm" data-primary="customizing" data-secondary="firewalld zones" id="custom-firewalld-zone"/>of the default zones meet your needs, and you want to modify the predefined
zones.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156129208">
<h2>Solution</h2>

<p>Suppose you like the <em>internal</em> zone, but the default configuration isn’t quite what you
want. The current configuration allows <em>ssh</em>, <em>mdns</em>, <em>samba-client</em>, and <em>dhcpv6-client</em>:</p>
<pre>$ <strong>firewall-cmd --zone=internal --list-all</strong>
internal
  target: default
  icmp-block-inversion: no
  interfaces:
  sources:
  services: ssh mdns samba-client dhcpv6-client
[...]</pre>

<p>The following example shows how to remove <em>samba-client</em> because you don’t use
Samba:</p>
<pre>$ <strong>sudo firewall-cmd --remove-service=samba-client --zone=internal</strong>
success
</pre>

<p>You are running a small local 389 Directory server, so you need to add the LDAPS
service:</p>
<pre>$ <strong>sudo firewall-cmd --zone=internal --add-service=ldaps</strong>
success</pre>

<p>These are temporary changes that will not survive a reboot or configuration reload.
However, they are immediately applied so that you can test them. Test your changes,
and if everything works as expected, make the changes permanent:</p>
<pre>$ <strong>sudo firewall-cmd --runtime-to-permanent</strong>
success
</pre>

<p class="pagebreak-before less_space">To discard the changes, do not use <em>--runtime-to-permanent</em>. Instead, use
<em>--reload</em> to discard the runtime changes and revert to your original
configuration:</p>
<pre>$ <strong>sudo firewall-cmd --reload</strong>
success
</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156128664">
<h2>Discussion</h2>

<p><em>--reload</em> does not interrupt any active connections.</p>

<p><em>--complete-reload</em> reloads firewalld completely, including reloading kernel
modules, and terminates active connections. This is a good option when your
runtime changes are so messed up you want to <a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="customizing" data-startref="firewalld-zone-custom" id="idm46466156114440"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="customizing" data-startref="zone-custom" id="idm46466156112664"/><a data-type="indexterm" data-primary="customizing" data-secondary="firewalld zones" data-startref="custom-firewalld-zone" id="idm46466156111416"/>start over.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156109384">
<h2>See Also</h2>

<ul>
<li>
<p>The Discussion in <a data-type="xref" href="#rec-host-firewall">Recipe 14.7</a> to learn about firewalld zones</p>
</li>
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
<li>
<p><a data-type="xref" href="ch04.xhtml#cha-systemd">Chapter 4</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.10 Creating a New Zone"><div class="sect1" id="idm46466156103096">
<h1>14.10 Creating a New Zone</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156101944">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="creating" id="firewalld-zone-create"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="creating" id="zone-create"/> want to create a new custom zone.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156097368">
<h2>Solution</h2>

<p>Create an XML containing your zone configuration, then reload firewalld and it
is ready to use.</p>

<p>The following example creates a zone for local name services, with DNS and DHCP
servers on the same machine, and SSH access. The example file is named
<em>/etc/firewalld/zones/names.xml</em>:</p>

<pre data-type="programlisting">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;zone&gt;
  &lt;short&gt;Name Services&lt;/short&gt;
  &lt;description&gt;
    DNS and DHCP servers for the local network, IPv4 only.
  &lt;/description&gt;
  &lt;service name="dns"/&gt;
  &lt;service name="dhcp"/&gt;
  &lt;service name="ssh"/&gt;
&lt;/zone&gt;</pre>

<p>Run the <em>sudo firewall-cmd --get-zones</em> command, and your new zone will not
be listed. Add the <em>--permanent</em> option to see any new zones that are not yet
read by firewalld, and now the new “names” zone appears. Zone names are the filenames without the <em>.xml</em> extension:</p>
<pre>$ <strong>sudo firewall-cmd --permanent --get-zones</strong>
block dmz drop external home internal names public trusted work</pre>

<p>Reload firewalld:</p>
<pre>$ <strong>sudo firewall-cmd --reload</strong>
success</pre>

<p>Now firewalld can read it, and you can see it with the other zones:</p>
<pre>$ <strong>sudo firewall-cmd --get-zones</strong>
block dmz drop external home internal names public trusted work</pre>

<p>And list its configuration:</p>
<pre>$ <strong>sudo firewall-cmd --zone=names --list-all</strong>
names
  target: default
  icmp-block-inversion: no
  interfaces:
  sources:
  services: dhcp dns ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:</pre>

<p>Your new zone is ready to use, and you can modify it just like any other zone.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156096744">
<h2>Discussion</h2>

<p>See <em>man 5 firewalld.zone</em> to learn about configuration options and see
the source files for the predefined zones in <em>/usr/lib/firewalld/zones/</em> to use
as examples. The only files that go in <em>/etc/firewalld/zones/</em>
are user custom files.</p>

<p>Remove a zone by deleting its <em>.xml</em> file, and then reload<a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="removing" id="idm46466156081752"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="removing" id="idm46466156080776"/><a data-type="indexterm" data-primary="removing" data-secondary="firewalld zones" id="idm46466156079928"/><a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="creating" data-startref="firewalld-zone-create" id="idm46466156078888"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="creating" data-startref="zone-create" id="idm46466156077272"/> firewalld.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156075016">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 5 firewalld.zone</em></p>
</li>
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
<li>
<p><a data-type="xref" href="#rec-custom-zones">Recipe 14.9</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.11 Integrating NetworkManager and firewalld"><div class="sect1" id="sec-networkman-firewalld">
<h1>14.11 Integrating NetworkManager and firewalld</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156068424">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="NetworkManager" data-secondary="firewalld integration" id="networkmanager-firewalld"/><a data-type="indexterm" data-primary="firewalld" data-secondary="NetworkManager integration" id="firewalld-networkmanager"/>travel between multiple networks, such as multiple work locations, coffee
shops, hotels, and coworking locations. You need to know how to set up
NetworkManager to keep up with these changes and always ensure that new
connections are assigned to the correct firewall zone.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156064360">
<h2>Solution</h2>

<p>NetworkManager includes firewalld integration. When you connect
to a new network, NetworkManager assigns it to your default firewalld zone.</p>

<p>You may assign a nondefault zone to a particular connection with NetworkManager.
If you have the NetworkManager applet in your panel, click it to bring up the
Edit Connections dialog (<a data-type="xref" href="#fig-network-man-edit">Figure 14-2</a>).</p>

<figure class="width-50"><div id="fig-network-man-edit" class="figure">
<img src="Images/lcb2_1402.png" alt="Editing connections in NetworkManager." width="357" height="443"/>
<h6><span class="label">Figure 14-2. </span>Editing network connections in NetworkManager</h6>
</div></figure>

<p>Or, run the <em>nm-connection-editor</em> command to open the editor. Click Edit
Connections, click the connection you want to edit, and click
the gear icon to open the editor. This opens the editing dialog
(<a data-type="xref" href="#fig-network-man-edit-2">Figure 14-3</a>).</p>

<figure><div id="fig-network-man-edit-2" class="figure">
<img src="Images/lcb2_1403.png" alt="Changing the firewall zone." width="500" height="434"/>
<h6><span class="label">Figure 14-3. </span>Changing the firewall zone</h6>
</div></figure>

<p>Go to the General tab and use the Firewall Zone drop-down menu to select the zone
you want for that connection. Save your change and you’re<a data-type="indexterm" data-primary="NetworkManager" data-secondary="firewalld integration" data-startref="networkmanager-firewalld" id="idm46466156052440"/><a data-type="indexterm" data-primary="firewalld" data-secondary="NetworkManager integration" data-startref="firewalld-networkmanager" id="idm46466156054056"/> finished.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156064104">
<h2>See Also</h2>

<ul>
<li>
<p>The Discussion in <a data-type="xref" href="#rec-host-firewall">Recipe 14.7</a> to learn about firewalld zones</p>
</li>
<li>
<p><a data-type="xref" href="#rec-custom-zones">Recipe 14.9</a></p>
</li>
<li>
<p><a href="https://oreil.ly/pvrwj">NetworkManager Reference Manual</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.12 Allowing or Blocking Specific Ports"><div class="sect1" id="idm46466156044872">
<h1>14.12 Allowing or Blocking Specific Ports</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156043896">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="firewalld" data-secondary="ports, allowing/blocking" id="firewalld-port-allowblock"/><a data-type="indexterm" data-primary="ports" data-secondary="allowing/blocking" id="ports-allowblock"/><a data-type="indexterm" data-primary="allowing ports" id="allow-port"/><a data-type="indexterm" data-primary="blocking" data-secondary="ports" id="block-port"/>are using nonstandard ports, for example, port 2022 for your SSH server. You
want to block port 22 and allow port 2022.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156037672">
<h2>Solution</h2>

<p>Any port that is not specifically allowed is denied for all firewalld zones,
except the <em>trusted</em> zone, which allows everything. If you were using the default
SSH service, which uses TCP port 22, first remove port 22 from the relevant zone,
then add port 2022, then reload firewalld. In this example the nonstandard port
is assigned to the <em>work</em> zone:</p>
<pre>$ <strong>sudo firewall-cmd --zone=work --remove-port=22/tcp</strong>
success
$ <strong>sudo firewall-cmd --zone=work --add-port=2022/tcp</strong>
success
</pre>

<p>Verify by listing the zone configuration:</p>
<pre>$ <strong>sudo firewall-cmd --list-all --zone=work</strong>
work
  target: default
  icmp-block-inversion: no
  interfaces:
  sources:
  services: ssh
  ports:2022/tcp
[...]
</pre>

<p>When you are satisfied, make your changes permanent:</p>
<pre>$ <strong>sudo firewall-cmd --runtime-to-permanent</strong>
</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156037208">
<h2>Discussion</h2>

<p>If you see a message like “Warning: NOT_ENABLED: 22:tcp” when you try to remove
that port, that means it was not enabled for that zone, and you can go ahead and
add your new port.</p>

<p>When you use a nonstandard port, clients connecting to the service must specify
that port number. For example, for SSH:</p>
<pre>$ <strong>ssh -p 2022 <i>server1</i></strong></pre>

<p>How do you know what ports to use? Every service has its own default ports,
which you will find in the service’s documentation, and in the <em>/etc/services</em>
file. You may use nonstandard ports, and they must be unused ports between
1024 and 49151. Record your changes in <em>/etc/services</em>. You also need to set your
nonstandard ports in the configuration for your server. See
<a data-type="xref" href="ch12.xhtml#rec-secure-server-ssh">Recipe 12.3</a> for an <a data-type="indexterm" data-primary="firewalld" data-secondary="ports, allowing/blocking" data-startref="firewalld-port-allowblock" id="idm46466156023128"/><a data-type="indexterm" data-primary="ports" data-secondary="allowing/blocking" data-startref="ports-allowblock" id="idm46466156024600"/><a data-type="indexterm" data-primary="allowing ports" data-startref="allow-port" id="idm46466156021512"/><a data-type="indexterm" data-primary="blocking" data-secondary="ports" data-startref="block-port" id="idm46466156020664"/>example.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156029704">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
<li>
<p><a data-type="xref" href="ch12.xhtml#rec-secure-server-ssh">Recipe 12.3</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.13 Blocking IP Addresses with Rich Rules"><div class="sect1" id="idm46466156014696">
<h1>14.13 Blocking IP Addresses with Rich Rules</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156013496">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="firewalld" data-secondary="IP addresses, blocking" id="firewalld-ip-block"/><a data-type="indexterm" data-primary="IP addresses" data-secondary="blocking" id="ip-block"/><a data-type="indexterm" data-primary="blocking" data-secondary="IP addresses" id="block-ip"/><a data-type="indexterm" data-primary="rich rules" id="rich-rule"/>want to block certain IP addresses.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156007448">
<h2>Solution</h2>

<p>Create a <em>rich rule</em>,  which defines the address to be blocked, and the target,
which in the example is <em>reject</em>. The following example blocks a single address,
and is added to the internal zone:</p>
<pre>$ <strong>sudo firewall-cmd --zone=internal \
 --add-rich-rule='rule family="ipv4" source address=192.168.1.91 reject'</strong>
success</pre>

<p>Test it by pinging from the blocked host. The blocked host should see the
“Destination Port Unreachable” message.</p>

<p>If you do not want to keep the rule, run <em>sudo firewall-cmd --reload</em> to delete
it.</p>

<p>To make it permanent, use the <em>--runtime-to-permanent</em> option:</p>
<pre>$ <strong>sudo firewall-cmd --runtime-to-permanent</strong>
</pre>

<p>List the rich rules in a zone:</p>
<pre>$ <strong>sudo firewall-cmd --zone=internal --list-rich-rules</strong>
rule family='ipv4' source address='192.168.1.91' reject
</pre>

<p>To delete a permanent rich rule, use the <em>--remove-rich-rule</em> option:</p>
<pre>$ <strong>sudo firewall-cmd --zone=internal \
        --remove-rich-rule="rule family='ipv4' \
        source address='192.168.1.91' reject"</strong>
success
</pre>

<p>You don’t have to completely block the offending host, but you can apply blocks to

<span class="keep-together">specific</span> services. The following example blocks the source address only for the
SSH 
<span class="keep-together">service</span>:</p>
<pre>$ <strong>sudo firewall-cmd --zone=internal --add-rich-rule='rule family="ipv4" \
 source address=192.168.1.91 service name="ssh" protocol=tcp reject'</strong>
success</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156006424">
<h2>Discussion</h2>

<p>You may create multiple rich rules in a zone, though be careful to avoid conflicts.</p>

<p>Once upon a time, a person I had the dubious pleasure of working with thought it
was funny to practice penetration testing on his coworkers. Our team
ran a number of test servers on our workstations and made them available to the
team. Our wannabe pen-tester was so annoying, we all blocked him at our<a data-type="indexterm" data-primary="firewalld" data-secondary="IP addresses, blocking" data-startref="firewalld-ip-block" id="idm46466155992168"/><a data-type="indexterm" data-primary="IP addresses" data-secondary="blocking" data-startref="ip-block" id="idm46466155990840"/><a data-type="indexterm" data-primary="blocking" data-secondary="IP addresses" data-startref="block-ip" id="idm46466155989592"/><a data-type="indexterm" data-primary="rich rules" data-startref="rich-rule" id="idm46466155988248"/> firewalls.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155991256">
<h2>See Also</h2>

<ul class="no-space-list">
<li>
<p>The Discussion in <a data-type="xref" href="#rec-host-firewall">Recipe 14.7</a> to learn about firewalld zones and
options</p>
</li>
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
<li>
<p><em>man 5 firewalld.richlanguage</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="14.14 Changing a Zone Default Target"><div class="sect1" id="idm46466155979880">
<h1>14.14 Changing a Zone Default Target</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155978776">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="firewalld" data-secondary="zones" data-tertiary="changing default target" id="idm46466155977480"/><a data-type="indexterm" data-primary="zones (firewalld)" data-secondary="changing default target" id="idm46466155976392"/><a data-type="indexterm" data-primary="changing" data-secondary="default target for zones" id="idm46466155975544"/><a data-type="indexterm" data-primary="default firewalld zones" data-secondary="targets, changing" id="idm46466155974568"/><a data-type="indexterm" data-primary="targets (firewalld zones), changing default" id="idm46466155973496"/>want to change the default target for a zone.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155972168">
<h2>Solution</h2>

<p>List the current target:</p>
<pre>$ <strong>sudo firewall-cmd --zone=internal --list-all</strong>
internal
  target: ACCEPT
[...]</pre>

<p>Change it from <em>ACCEPT</em> to <em>REJECT</em>, then reload and verify:</p>
<pre>$ <strong>sudo firewall-cmd --permanent --zone=internal --set-target=REJECT</strong>
success

$ <strong>sudo firewall-cmd --reload</strong>

$ <strong>firewall-cmd --zone=names --list-all</strong>
names
  target: %%REJECT%%
[...]</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155966104">
<h2>Discussion</h2>

<p>The zone target defines the default action for packets that do not match
any rules. It takes one of four values: <em>default</em>, <em>ACCEPT</em>, <em>DROP</em>, or
<em>REJECT</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155962680">
<h2>See Also</h2>

<ul class="no-space-list">
<li>
<p><a href="https://firewalld.org"><em class="hyperlink">https://firewalld.org</em></a></p>
</li>
<li>
<p>The Discussion in <a data-type="xref" href="#rec-list-zones">Recipe 14.5</a> to learn about firewalld zones</p>
</li>
<li>
<p><a data-type="xref" href="#sec-networkman-firewalld">Recipe 14.11</a></p>
</li>
</ul>
</div></section>





</div></section>







</div></section></div></body></html>