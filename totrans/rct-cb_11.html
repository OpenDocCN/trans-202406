<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Progressive Web Applications" class="calibre4"><div class="preface" id="chapter11">
<h1 class="calibre9"><span class="label">Chapter 11. </span>Progressive Web Applications</h1>


<p class="author1">Progressive web applications (PWAs) are web applications that try to behave like locally installed applications.<a data-type="indexterm" data-primary="progressive web applications (PWAs)" id="ix_PWA" class="calibre6"/> They can work
offline, integrate with the native notification system, and have the ability to run long background processes, which can continue
even after you leave the website. They’re called <em class="calibre7">progressive</em> because they smoothly downgrade their functionality
if some feature is not available in the current browser.<a data-type="indexterm" data-primary="PWAs" data-see="progressive web applications" id="idm46634379257784" class="calibre6"/></p>

<p class="author1">This chapter focuses almost exclusively on one feature of PWAs: service workers. You will occasionally encounter the term
<em class="calibre7">progressive web application</em> used to describe any JavaScript-rich browser application. The truth is that unless that application uses
service workers, it isn’t a PWA.<a data-type="indexterm" data-primary="service workers" id="idm46634379255736" class="calibre6"/></p>

<p class="author1">Service workers are, in effect, a locally installed server for the application. The backend server is a software distribution
mechanism and a provider of live data services, but the service worker is really in charge because it provides access to the
network. It can choose to satisfy network requests from its own local cache. If the network is not available, it can choose to
replace network resources with local placeholders. It can even queue data updates offline and synchronize with the backend server
when the network connection reappears.</p>

<p class="author1">This is a good topic for the final chapter because it has been the most enjoyable chapter to write. Service workers are one of the
most fascinating features found in modern browsers. We hope you have fun.</p>






<section data-type="sect1" data-pdf-bookmark="Create Service Workers with Workbox" class="calibre4"><div class="preface" id="ch11-01">
<h1 class="calibre17">Create Service Workers with Workbox</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634379251848">
<h2 class="calibre27">Problem</h2>

<p class="author1">PWAs can work even when you’re offline.<a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="creating service workers using Workbox" id="ix_PWAcrserwk" class="calibre6"/><a data-type="indexterm" data-primary="caching" data-secondary="code or content by PWAs" id="idm46634379248792" class="calibre6"/> They can cache any content or code they require, and the
cache will survive the user refreshing the page. They can run background operations independently of the code that runs in the
browser.</p>

<p class="author1">PWAs can do this because of <em class="calibre7">service workers</em>. Service workers are a kind of web worker.<a data-type="indexterm" data-primary="web workers" id="idm46634379246712" class="calibre6"/> A <em class="calibre7">web worker</em> is a piece of JavaScript
that runs in a separate thread from the JavaScript running in a web page. Service workers are specialized web workers that can
intercept network traffic between a web page and the server, giving them a tremendous amount of control over the page that registers
them. You can think of a service worker as a kind of local proxy service that’s available even when you’ve disconnected from the
network.</p>

<p class="author1">Service workers are most often used to cache content locally. Browsers will cache most content they see, but a service worker can do
so much more aggressively. For example, hitting force-refresh in a browser will often force it to reload assets from the network.
But the force-refresh function will not affect service workers, no matter how many times a user uses it.</p>

<p class="author1">You can see a service worker in operation in <a data-type="xref" href="#ch11_image_1" class="calibre6">Figure 11-1</a>.</p>

<figure class="calibre29"><div id="ch11_image_1" class="figure">
<img src="Images/recb_1101.png" alt="" class="calibre193"/>
<h6 class="calibre30"><span class="firstname">Figure 11-1. </span>A service worker will intercept all network requests</h6>
</div></figure>

<p class="author1">In this case, the service worker will cache files the first time they are downloaded. If the page asks for the <em class="calibre7">logo.svg</em> file more
than once, the service worker will return it from its private cache rather than from the network.</p>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">How a service worker <a data-type="indexterm" data-primary="caching" data-secondary="strategies" id="idm46634379238808" class="calibre6"/>caches data and how it decides if it needs to return data from its cache or the network is called a
<em class="calibre7">strategy</em>.<a data-type="indexterm" data-primary="strategies (caching)" id="idm46634379237176" class="calibre6"/> We will look at various standard strategies in this chapter.</p>
</div>

<p class="author1">Service workers are stored on the server as separate JavaScript files, and the browser will download and install them from a URL.
There is nothing to prevent you from handcrafting a service worker and storing it in the public folder of your application, but
there are several problems with writing service workers from scratch.</p>

<p class="author1">First, service workers are notoriously difficult to create. Not only can they include complex code, but they also have complex
life cycles. It’s far too easy to write a service worker that fails to load or caches the wrong files. Even worse, it’s possible to
write a service worker that will isolate your application from the network.</p>

<p class="author1">Second, you can use service workers to precache application code.<a data-type="indexterm" data-primary="service workers" data-secondary="using to precache application code" id="idm46634379234280" class="calibre6"/><a data-type="indexterm" data-primary="caching" data-secondary="using service workers to precache application code" id="idm46634379233240" class="calibre6"/> For a React application, this is a fantastic feature. Instead of
downloading several hundred kilobytes of JavaScript, a service worker can return it all in a split second from a local cache, which
means that your application can start almost immediately, even on a low-powered device with a bad network connection.</p>

<p class="author1">But code caching has its own set of problems. <a data-type="indexterm" data-primary="caching" data-secondary="problems with code caching" id="idm46634379231352" class="calibre6"/>Let’s say we have a React application that includes the following generated JavaScript
files:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ ls build/static/js/</code>
<code class="go">2.d106afb5.chunk.js             2.d106afb5.chunk.js.map</code>
<code class="go">3.9e79b289.chunk.js.map         main.095e14c4.chunk.js.map</code>
<code class="go">runtime-main.b175c5d9.js.map    2.d106afb5.chunk.js.LICENSE.txt</code>
<code class="go">3.9e79b289.chunk.js             main.095e14c4.chunk.js</code>
<code class="go">runtime-main.b175c5d9.js</code>
<code class="go">$</code></pre>

<p class="author1">If we want to precache these files, the service worker will need to know the names. That’s because it will download the files in
the background, even before the browser has asked for them. So if you create a service worker by hand, you will need to include the
names of each of the files that it will precache.</p>

<p class="author1">But then what happens if you make a small change to your source code and then re-build the application?</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn run build</code>
<code class="go">$ ls build/static/js/</code>
<code class="go">2.d106afb5.chunk.js             2.d106afb5.chunk.js.map</code>
<code class="go">3.9e79b289.chunk.js.map         main.f5b66cc7.chunk.js.map</code>
<code class="go">runtime-main.b175c5d9.js.map    2.d106afb5.chunk.js.LICENSE.txt</code>
<code class="go">3.9e79b289.chunk.js             main.f5b66cc7.chunk.js</code>
<code class="go">runtime-main.b175c5d9.js</code>
<code class="go">$</code></pre>

<p class="author1">The filenames <em class="calibre7">change</em>, which means you will now have to update the service worker script with the latest generated filenames.</p>

<p class="author1">How can you create stable service workers that are always in sync with the latest application code?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634379251224">
<h2 class="calibre27">Solution</h2>

<p class="author1">We’re going to use a set of tools from<a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" id="ix_serwkcr" class="calibre6"/><a data-type="indexterm" data-primary="Workbox, creating service workers with" id="ix_Wkbx" class="calibre6"/> Google called <a href="https://oreil.ly/9dPXh" class="calibre6">Workbox</a>. The Workbox tools
allow you to generate service workers that are up-to-date with your latest application files.</p>

<p class="author1">Workbox includes a set of standard strategies to handle the details of common service worker use cases.<a data-type="indexterm" data-primary="strategies (caching)" data-secondary="in Workbox" id="idm46634379143224" class="calibre6"/> If you want to precache your application, you can do so with a single line of code into Workbox.</p>

<p class="author1">To see how to use Workbox, consider the application you can see in <a data-type="xref" href="#ch11_image_2" class="calibre6">Figure 11-2</a>.</p>

<figure class="calibre29"><div id="ch11_image_2" class="figure">
<img src="Images/recb_1102.png" alt="" class="calibre194"/>
<h6 class="calibre30"><span class="firstname">Figure 11-2. </span>Our example application has two pages</h6>
</div></figure>

<p class="author1">It’s a simple two-page application based on the default application generated by <code class="calibre21">create-react-app</code>. We’re going to build a service
worker that will precache all of the application’s code and files.</p>

<p class="author1">We’ll begin by installing a <a data-type="indexterm" data-primary="Workbox, creating service workers with" data-secondary="installing Workbox libraries" id="idm46634379137496" class="calibre6"/><a data-type="indexterm" data-primary="workbox-routing library" id="idm46634379136440" class="calibre6"/><a data-type="indexterm" data-primary="workbox-precaching library" id="idm46634379135768" class="calibre6"/><a data-type="indexterm" data-primary="workbox-core library" id="idm46634379135080" class="calibre6"/>few of the libraries from Workbox:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn add workbox-core</code>
<code class="go">$ yarn add workbox-precaching</code>
<code class="go">$ yarn add workbox-routing</code></pre>

<p class="author1">You will see what each of these libraries is for as we build the service worker.</p>

<p class="author1">In our application, we will create a new file for the service worker called <em class="calibre7">service-worker.js</em>. We can place this file in the same
directory as the rest of the application code:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">clientsClaim</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-core'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">precacheAndRoute</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-precaching'</code>

<code class="nx">clientsClaim</code><code class="go">()</code>

<code class="nx">precacheAndRoute</code><code class="go">(</code><code class="nx">self</code><code class="go">.</code><code class="nx">__WB_MANIFEST</code><code class="go">)</code></pre>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">If we were creating a service worker by hand, we would have to create it in the same directory we use to store other static
content. For example, in a <code class="calibre21">create-react-app</code> application, we would have to create it in the <em class="calibre7">public</em> directory.</p>
</div>

<p class="author1">Our service worker will precache all of the application code.<a data-type="indexterm" data-primary="caching" data-secondary="service workers pre-caching all application code" id="idm46634379066456" class="calibre6"/> That means it will automatically cache any CSS, JavaScript, HTML, and
images that are part of the 
<span class="firstname">application</span>.</p>

<p class="author1">The service worker calls the <code class="calibre21">clientsClaim</code> function from <em class="calibre7">workbox-core</em>, which will make the service worker the controller for all
clients within its scope.<a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" data-tertiary="calling clientsClaim function from workbox-core" id="idm46634379062952" class="calibre6"/> A <em class="calibre7">client</em> is a web page, and the <em class="calibre7">scope</em> is any web page with a URL within the same path as the service
worker. Workbox will generate our service worker at <em class="calibre7">https://host/service-worker.js</em>, which means the service worker will be the
controller for all pages that begin with <em class="calibre7">https://host/</em>.</p>

<p class="author1">The <code class="calibre21">precacheAndRoute</code> function will handle all of the gory details of the precaching process. It will create and manage the local cache, and it will intercept network requests for application files and load them from the local cache rather than the 
<span class="firstname">network</span>.</p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">Service workers will function only if loaded with HTTPS.<a data-type="indexterm" data-primary="HTTPS" data-secondary="loading service workers with" id="idm46634379057048" class="calibre6"/> Most browsers make an exception for sites loaded from <em class="calibre7">localhost</em>.
For security reasons, browsers will not run service workers in private tabs.</p>
</div>

<p class="author1">As we’ve created our service worker, we need to register it from the main application code.<a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" data-tertiary="registering service workers" id="idm46634379054936" class="calibre6"/> Registration is a complex process, but
the good news is that it’s almost always the same. Once you’ve written the registration code for one application, you can copy it,
unchanged, to another. Also, if you are building your application using the <em class="calibre7">cra-template-pwa</em> template, it will generate the registration code for you.<sup class="calibre34"><a data-type="noteref" id="idm46634379052936-marker" href="ch11.xhtml#idm46634379052936" class="calibre35">1</a></sup></p>

<p class="author1">It is still worth understanding the details of the registration process; it will give you insight into the life cycle of a service
worker. That will make it a lot easier to understand any seemingly odd behavior that occurs after you deploy your application.</p>

<p class="author1">Create a new file called <em class="calibre7">registerWorker.js</em> in the main source directory of the 
<span class="firstname">application</span>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">register</code> <code class="o">=</code> <code class="go">(</code><code class="nx">pathToWorker</code><code class="go">,</code> <code class="nx">onInstall</code><code class="go">,</code> <code class="nx">onUpdate</code><code class="go">,</code> <code class="nx">onError</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="c">// We will write this code shortly</code>
<code class="go">}</code>

<code class="kr">const</code> <code class="nx">registerWorker</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">register</code><code class="go">(</code>
    <code class="s">'/service-worker.js'</code><code class="go">,</code>
    <code class="go">(</code><code class="nx">reg</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="go">.</code><code class="nx">info</code><code class="go">(</code><code class="s">'Service worker installed'</code><code class="go">,</code> <code class="nx">reg</code><code class="go">),</code>
    <code class="go">(</code><code class="nx">reg</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="go">.</code><code class="nx">info</code><code class="go">(</code><code class="s">'Service worker updated'</code><code class="go">,</code> <code class="nx">reg</code><code class="go">),</code>
    <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="go">.</code><code class="nx">error</code><code class="go">(</code><code class="s">'Service worker failed'</code><code class="go">,</code> <code class="nx">err</code><code class="go">)</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">registerWorker</code></pre>

<p class="author1">Leave the <code class="calibre21">register</code> function empty for now.</p>

<p class="author1">We will call the <code class="calibre21">registerWorker</code> function <a data-type="indexterm" data-primary="registerWorker function" id="idm46634378960744" class="calibre6"/>from the <em class="calibre7">index.js</em> file in our application:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">ReactDOM</code> <code class="nx">from</code> <code class="s">'react-dom'</code>
<code class="kr">import</code> <code class="s">'./index.css'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'./App'</code>
<code class="kr">import</code> <code class="nx">registerWorker</code> <code class="nx">from</code> <code class="s">'./registerWorker'</code>

<code class="nx">ReactDOM</code><code class="go">.</code><code class="nx">render</code><code class="go">(</code>
  <code class="go">&lt;</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">App</code> <code class="go">/&gt;</code>
  <code class="go">&lt;/</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;,</code>
  <code class="nb">document</code><code class="go">.</code><code class="nx">getElementById</code><code class="go">(</code><code class="s">'root'</code><code class="go">)</code>
<code class="go">)</code>

<code class="nx">registerWorker</code><code class="go">()</code></pre>

<p class="author1">The <code class="calibre21">registerWorker</code> function will call <code class="calibre21">register</code> with <a data-type="indexterm" data-primary="register function" id="idm46634378846312" class="calibre6"/>the path of our generated service worker: <em class="calibre7">service-worker.js</em>.</p>

<p class="author1">We can now start to write the <code class="calibre21">register</code> function:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">register</code> <code class="o">=</code> <code class="go">(</code><code class="nx">pathToWorker</code><code class="go">,</code> <code class="nx">onInstall</code><code class="go">,</code> <code class="nx">onUpdate</code><code class="go">,</code> <code class="nx">onError</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code>
    <code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">NODE_ENV</code> <code class="o">===</code> <code class="s">'production'</code> <code class="o">&amp;&amp;</code>
    <code class="s">'serviceWorker'</code> <code class="kr">in</code> <code class="nx">navigator</code>
  <code class="go">)</code> <code class="go">{</code>
    <code class="kr">const</code> <code class="nx">publicUrl</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">URL</code><code class="go">(</code>
      <code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">PUBLIC_URL</code><code class="go">,</code>
      <code class="nb">window</code><code class="go">.</code><code class="nx">location</code><code class="go">.</code><code class="nx">href</code>
    <code class="go">)</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">publicUrl</code><code class="go">.</code><code class="nx">origin</code> <code class="o">!==</code> <code class="nb">window</code><code class="go">.</code><code class="nx">location</code><code class="go">.</code><code class="nx">origin</code><code class="go">)</code> <code class="go">{</code>
      <code class="kr">return</code>
    <code class="go">}</code>

    <code class="c">// Do the loading and registering here</code>
  <code class="go">}</code>
<code class="go">}</code></pre>

<p class="author1">We’ll check that we’re in <em class="calibre7">production</em> mode and that the browser can run service workers.<a data-type="indexterm" data-primary="browsers" data-secondary="checking ability to run service workers" id="idm46634378841320" class="calibre6"/> The <em class="calibre7">progressive</em> in <em class="calibre7">progressive web
application</em> means that we should always check that a feature is available before using it. Almost all browsers (with the notable
exception of Internet Explorer) support service workers, but we can skip the service worker entirely if a browser doesn’t. It will
mean that the application will lose its ability to work offline, but other than that, the application should still work.</p>

<p class="author1">We also add an extra check to ensure we are running on the specified <code class="calibre21">PUBLIC URL</code> of the application, which will avoid cross-domain
issues that arise when loading code from content distribution networks.<sup class="calibre34"><a data-type="noteref" id="idm46634378758840-marker" href="ch11.xhtml#idm46634378758840" class="calibre35">2</a></sup></p>

<p class="author1">Now we can download<a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" data-tertiary="downloading and registering service worker" id="idm46634378756760" class="calibre6"/> and register the service worker:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">register</code> <code class="o">=</code> <code class="go">(</code><code class="nx">pathToWorker</code><code class="go">,</code> <code class="nx">onInstall</code><code class="go">,</code> <code class="nx">onUpdate</code><code class="go">,</code> <code class="nx">onError</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code>
    <code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">NODE_ENV</code> <code class="o">===</code> <code class="s">'production'</code> <code class="o">&amp;&amp;</code>
    <code class="s">'serviceWorker'</code> <code class="kr">in</code> <code class="nx">navigator</code>
  <code class="go">)</code> <code class="go">{</code>
    <code class="kr">const</code> <code class="nx">publicUrl</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">URL</code><code class="go">(</code>
      <code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">PUBLIC_URL</code><code class="go">,</code>
      <code class="nb">window</code><code class="go">.</code><code class="nx">location</code><code class="go">.</code><code class="nx">href</code>
    <code class="go">)</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">publicUrl</code><code class="go">.</code><code class="nx">origin</code> <code class="o">!==</code> <code class="nb">window</code><code class="go">.</code><code class="nx">location</code><code class="go">.</code><code class="nx">origin</code><code class="go">)</code> <code class="go">{</code>
      <code class="kr">return</code>
    <code class="go">}</code>

    <code class="nb">window</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'load'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">try</code> <code class="go">{</code>
        <code class="kr">const</code> <code class="nx">registration</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">navigator</code><code class="go">.</code><code class="nx">serviceWorker</code><code class="go">.</code><code class="nx">register</code><code class="go">(</code>
          <code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">PUBLIC_URL</code> <code class="o">+</code> <code class="nx">pathToWorker</code>
        <code class="go">)</code>

        <code class="c">// Code to check progress goes here</code>
      <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
        <code class="kr">if</code> <code class="go">(</code><code class="nx">onError</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">onError</code><code class="go">(</code><code class="nx">err</code><code class="go">)</code>
        <code class="go">}</code>
      <code class="go">}</code>
    <code class="go">})</code>
  <code class="go">}</code>
<code class="go">}</code></pre>

<p class="author1">Once we know the web <a data-type="indexterm" data-primary="navigator.serviceWorker.register function" id="idm46634378752504" class="calibre6"/><a data-type="indexterm" data-primary="register function" id="idm46634378751896" class="calibre6"/>page is loaded, we can register the service worker with the <code class="calibre21">navigator.serviceWorker.register</code> function,
passing it the full URL of the service worker: <em class="calibre7"><a href="https://host/service-worker.js" class="calibre6"><em class="calibre7">https://host/service-worker.js</em></a></em>.</p>

<p class="author1">It returns a <em class="calibre7">registration</em> object, which can be used to track and manage the service worker. <a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" data-tertiary="registration object" id="idm46634378628248" class="calibre6"/>For example, you can use the
registration object to find out when the service worker is updated or installed:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">register</code> <code class="o">=</code> <code class="go">(</code><code class="nx">pathToWorker</code><code class="go">,</code> <code class="nx">onInstall</code><code class="go">,</code> <code class="nx">onUpdate</code><code class="go">,</code> <code class="nx">onError</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code>
    <code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">NODE_ENV</code> <code class="o">===</code> <code class="s">'production'</code> <code class="o">&amp;&amp;</code>
    <code class="s">'serviceWorker'</code> <code class="kr">in</code> <code class="nx">navigator</code>
  <code class="go">)</code> <code class="go">{</code>
    <code class="kr">const</code> <code class="nx">publicUrl</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">URL</code><code class="go">(</code>
      <code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">PUBLIC_URL</code><code class="go">,</code>
      <code class="nb">window</code><code class="go">.</code><code class="nx">location</code><code class="go">.</code><code class="nx">href</code>
    <code class="go">)</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">publicUrl</code><code class="go">.</code><code class="nx">origin</code> <code class="o">!==</code> <code class="nb">window</code><code class="go">.</code><code class="nx">location</code><code class="go">.</code><code class="nx">origin</code><code class="go">)</code> <code class="go">{</code>
      <code class="kr">return</code>
    <code class="go">}</code>

    <code class="nb">window</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'load'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">try</code> <code class="go">{</code>
        <code class="kr">const</code> <code class="nx">registration</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">navigator</code><code class="go">.</code><code class="nx">serviceWorker</code><code class="go">.</code><code class="nx">register</code><code class="go">(</code>
          <code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">PUBLIC_URL</code> <code class="o">+</code> <code class="nx">pathToWorker</code>
        <code class="go">)</code>

        <code class="nx">registration</code><code class="go">.</code><code class="nx">onupdatefound</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="kr">const</code> <code class="nx">worker</code> <code class="o">=</code> <code class="nx">registration</code><code class="go">.</code><code class="nx">installing</code>
          <code class="kr">if</code> <code class="go">(</code><code class="nx">worker</code><code class="go">)</code> <code class="go">{</code>
            <code class="nx">worker</code><code class="go">.</code><code class="nx">onstatechange</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
              <code class="kr">if</code> <code class="go">(</code><code class="nx">worker</code><code class="go">.</code><code class="nx">state</code> <code class="o">===</code> <code class="s">'installed'</code><code class="go">)</code> <code class="go">{</code>
                <code class="kr">if</code> <code class="go">(</code><code class="nx">navigator</code><code class="go">.</code><code class="nx">serviceWorker</code><code class="go">.</code><code class="nx">controller</code><code class="go">)</code> <code class="go">{</code>
                  <code class="kr">if</code> <code class="go">(</code><code class="nx">onUpdate</code><code class="go">)</code> <code class="go">{</code>
                    <code class="nx">onUpdate</code><code class="go">(</code><code class="nx">registration</code><code class="go">)</code>
                  <code class="go">}</code>
                <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
                  <code class="kr">if</code> <code class="go">(</code><code class="nx">onInstall</code><code class="go">)</code> <code class="go">{</code>
                    <code class="nx">onInstall</code><code class="go">(</code><code class="nx">registration</code><code class="go">)</code>
                  <code class="go">}</code>
                <code class="go">}</code>
              <code class="go">}</code>
            <code class="go">}</code>
          <code class="go">}</code>
        <code class="go">}</code>
      <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
        <code class="kr">if</code> <code class="go">(</code><code class="nx">onError</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">onError</code><code class="go">(</code><code class="nx">err</code><code class="go">)</code>
        <code class="go">}</code>
      <code class="go">}</code>
    <code class="go">})</code>
  <code class="go">}</code>
<code class="go">}</code></pre>

<p class="author1">The <code class="calibre21">onupdatefound</code> handler runs when the browser starts to install the service worker.<a data-type="indexterm" data-primary="browsers" data-secondary="installing service worker" id="idm46634378623448" class="calibre6"/><a data-type="indexterm" data-primary="onupdatefound handler" id="idm46634378622552" class="calibre6"/> Once the browser has installed the service
worker, we can check 
<span class="firstname"><code class="calibre21">navigator.serviceWorker.controller</code></span> to see if a previous service worker is still running.<a data-type="indexterm" data-primary="navigator.serviceWorker.controller" id="idm46634378353704" class="calibre6"/> If not, we know that
this is a fresh installation and not an update.</p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">One of the most confusing things about service workers is the way that they are updated.<a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" data-tertiary="updating of service workers" id="idm46634378351784" class="calibre6"/> If an old service worker is
already in control of a page, the browser will put the new service worker into a <em class="calibre7">waiting</em> state, which means it will do <em class="calibre7">absolutely
nothing</em> until the old service worker stops. A service worker stops when the user closes all the pages that it controls.
Consequently, if you update your service worker, you will not run the new code until you open, close, and then open the page again.</p>
</div>

<p class="author1">This process can be confusing for anyone manually testing a new service worker 
<span class="firstname">feature</span>.</p>

<p class="author1">Before we build the application, we will need to configure the build tools to convert our <em class="calibre7">service-worker.js</em> source file into a
densely written service worker script.<a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" data-tertiary="converting service-worker.js file to service worker" id="idm46634378347000" class="calibre6"/></p>

<p class="author1">If you’re building your application with Webpack, you should install the Workbox Webpack Plugin:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn install -D workbox-webpack-plugin</code></pre>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">You will not need <a data-type="indexterm" data-primary="Workbox Webpack Plugin" id="idm46634378320776" class="calibre6"/><a data-type="indexterm" data-primary="Webpack" data-secondary="Workbox Webpack Plugin" id="idm46634378320104" class="calibre6"/>to install the Workbox Webpack Plugin or configure its use if you created your application with
<code class="calibre21">create-react-app</code>, which includes and configures the plugin for you.</p>
</div>

<p class="author1">You can then add the following to your <em class="calibre7">webpack.config.js</em> configuration:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="go">{</code> <code class="nx">InjectManifest</code> <code class="go">}</code> <code class="o">=</code> <code class="nx">require</code><code class="go">(</code><code class="s">'workbox-webpack-plugin'</code><code class="go">)</code>

<code class="nx">module</code><code class="go">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="go">{</code>
  <code class="go">....</code>
  <code class="nx">plugins</code><code class="o">:</code> <code class="go">[</code>
    <code class="go">....</code>
    <code class="kr">new</code> <code class="nx">InjectManifest</code><code class="go">({</code>
      <code class="nx">swSrc</code><code class="o">:</code> <code class="s">'./src/service-worker.js'</code><code class="go">,</code>
    <code class="go">}),</code>
  <code class="go">],</code>
<code class="go">}</code></pre>

<p class="author1">This configuration will tell Webpack to generate a service worker from the <em class="calibre7">src/service-worker.js</em> file.<a data-type="indexterm" data-primary="Webpack" data-secondary="generating service worker from src/service-worker.js" id="idm46634378230104" class="calibre6"/> It will also generate a
file called <em class="calibre7">asset-manifest.json</em> in your built application, which will list all of the application files.<a data-type="indexterm" data-primary="JSON" data-secondary="asset-manifest.json file" id="idm46634378228616" class="calibre6"/><a data-type="indexterm" data-primary="asset-manifest.json file" id="idm46634378227672" class="calibre6"/> The service worker will
use the information in <em class="calibre7">asset-manifest.json</em> when it’s precaching the application.</p>

<p class="author1">Now you build the application:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn run build</code></pre>

<p class="author1">In your <em class="calibre7">build</em> directory, you will see a generated <em class="calibre7">service-worker.js</em> file and the <em class="calibre7">asset-manifest.json</em> file:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">asset-manifest.json  logo192.png        service-worker.js.map</code>
<code class="go">favicon.ico          manifest.json      static</code>
<code class="go">index.html           robots.txt</code>
<code class="go">logo512.png          service-worker.js</code></pre>

<p class="author1">The <em class="calibre7">asset-manifest.json</em> file will contain something like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">{</code>
  <code class="s">"files"</code><code class="o">:</code> <code class="go">{</code>
    <code class="s">"main.css"</code><code class="o">:</code> <code class="s">"/static/css/main.8c8b27cf.chunk.css"</code><code class="go">,</code>
    <code class="s">"main.js"</code><code class="o">:</code> <code class="s">"/static/js/main.f5b66cc7.chunk.js"</code><code class="go">,</code>
    <code class="s">"main.js.map"</code><code class="o">:</code> <code class="s">"/static/js/main.f5b66cc7.chunk.js.map"</code><code class="go">,</code>
    <code class="s">"runtime-main.js"</code><code class="o">:</code> <code class="s">"/static/js/runtime-main.b175c5d9.js"</code><code class="go">,</code>
    <code class="s">"runtime-main.js.map"</code><code class="o">:</code> <code class="s">"/static/js/runtime-main.b175c5d9.js.map"</code><code class="go">,</code>
    <code class="s">"static/js/2.d106afb5.chunk.js"</code><code class="o">:</code> <code class="s">"/static/js/2.d106afb5.chunk.js"</code><code class="go">,</code>
    <code class="s">"static/js/2.d106afb5.chunk.js.map"</code><code class="o">:</code> <code class="s">"/static/js/2.d106afb5.chunk.js.map"</code><code class="go">,</code>
    <code class="s">"static/js/3.9e79b289.chunk.js"</code><code class="o">:</code> <code class="s">"/static/js/3.9e79b289.chunk.js"</code><code class="go">,</code>
    <code class="s">"static/js/3.9e79b289.chunk.js.map"</code><code class="o">:</code> <code class="s">"/static/js/3.9e79b289.chunk.js.map"</code><code class="go">,</code>
    <code class="s">"index.html"</code><code class="o">:</code> <code class="s">"/index.html"</code><code class="go">,</code>
    <code class="s">"service-worker.js"</code><code class="o">:</code> <code class="s">"/service-worker.js"</code><code class="go">,</code>
    <code class="s">"service-worker.js.map"</code><code class="o">:</code> <code class="s">"/service-worker.js.map"</code><code class="go">,</code>
    <code class="s">"static/css/main.8c8b27cf.chunk.css.map"</code><code class="o">:</code>
        <code class="s">"/static/css/main.8c8b27cf.chunk.css.map"</code><code class="go">,</code>
    <code class="s">"static/js/2.d106afb5.chunk.js.LICENSE.txt"</code><code class="o">:</code>
        <code class="s">"/static/js/2.d106afb5.chunk.js.LICENSE.txt"</code><code class="go">,</code>
    <code class="s">"static/media/logo.6ce24c58.svg"</code><code class="o">:</code> <code class="s">"/static/media/logo.6ce24c58.svg"</code>
  <code class="go">},</code>
  <code class="s">"entrypoints"</code><code class="o">:</code> <code class="go">[</code>
    <code class="s">"static/js/runtime-main.b175c5d9.js"</code><code class="go">,</code>
    <code class="s">"static/js/2.d106afb5.chunk.js"</code><code class="go">,</code>
    <code class="s">"static/css/main.8c8b27cf.chunk.css"</code><code class="go">,</code>
    <code class="s">"static/js/main.f5b66cc7.chunk.js"</code>
  <code class="go">]</code>
<code class="go">}</code></pre>

<p class="author1">You can now run the application. You can’t just start the development server with this:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn run start</code></pre>

<p class="author1">That will only run the application in development mode, and the service worker will not start. You will need to run a server on the
contents of the <em class="calibre7">build</em> directory. The simplest way to do this is by installing the <em class="calibre7">serve</em> package globally and then running it
against the <em class="calibre7">build</em> directory:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install -s serve</code>
<code class="go">$ serve -s build/</code>
<code class="go">   ┌──────────────────────────────────────────────────┐</code>
<code class="go">   │                                                  │</code>
<code class="go">   │   Serving!                                       │</code>
<code class="go">   │                                                  │</code>
<code class="go">   │   - Local:            http://localhost:5000      │</code>
<code class="go">   │   - On Your Network:  http://192.168.1.14:5000   │</code>
<code class="go">   │                                                  │</code>
<code class="go">   │   Copied local address to clipboard!             │</code>
<code class="go">   │                                                  │</code>
<code class="go">   └──────────────────────────────────────────────────┘</code></pre>

<p class="author1">The <code class="calibre21">-s</code> option is for running SPAs. If the server can’t find a matching file, it will return the
<em class="calibre7">build/index.html</em> file.</p>

<p class="author1">You can now open<a data-type="indexterm" data-primary="browsers" data-secondary="service worker running in" id="idm46634378023736" class="calibre6"/> a browser at <em class="calibre7">http://localhost:5000</em>. The application will appear, and if you open the developer tools and switch to
the Application tab, under Service Workers, you should see the <em class="calibre7">service-worker.js</em> script running (see <a data-type="xref" href="#ch11_image_3" class="calibre6">Figure 11-3</a>).</p>

<figure class="calibre29"><div id="ch11_image_3" class="figure">
<img src="Images/recb_1103.png" alt="" class="calibre195"/>
<h6 class="calibre30"><span class="firstname">Figure 11-3. </span>The service worker installed and running in the application</h6>
</div></figure>

<p class="author1">The service worker will download all of the application files into a local cache so that the next time the page is loaded, the files
will come from the local cache rather than the server.<a data-type="indexterm" data-primary="caching" data-secondary="service worker downloading app files into local cache" id="idm46634378017944" class="calibre6"/> You can see this happen if you switch to the <em class="calibre7">Network</em> tab in developer tools
and then reload the page (see <a data-type="xref" href="#ch11_image_4" class="calibre6">Figure 11-4</a>). The service worker will supply each of the network responses, except those that fall
outside its scope. Any file that belongs at the site level rather than page level, such as <em class="calibre7">favicon</em> icons, will still be downloaded
in the usual way.</p>

<figure class="calibre29"><div id="ch11_image_4" class="figure">
<img src="Images/recb_1104.png" alt="" class="calibre196"/>
<h6 class="calibre30"><span class="firstname">Figure 11-4. </span>After refresh, the files are downloaded using the service worker</h6>
</div></figure>

<p class="author1">The service worker is returning the files from a local cache.<a data-type="indexterm" data-primary="caching" data-secondary="service worker returning files from local cache" id="idm46634377976680" class="calibre6"/> If you are using Chrome, you can see the cache on the Application
tab. For Firefox, you will find it on the Storage tab (see <a data-type="xref" href="#ch11_image_5" class="calibre6">Figure 11-5</a>).</p>

<figure class="calibre29"><div id="ch11_image_5" class="figure">
<img src="Images/recb_1105.png" alt="" class="calibre197"/>
<h6 class="calibre30"><span class="firstname">Figure 11-5. </span>A cache stores the files locally</h6>
</div></figure>

<p class="author1">The cache doesn’t contain a copy of <em class="calibre7">all</em> the application files, only those that the application has requested. In this way, it will
avoid downloading files that are not needed and will download files into the cache only after the browser or the application code
has requested them.</p>

<p class="author1">So the first time you load the application, the cache might be empty. It depends on when the service worker becomes active. If the
page loads <em class="calibre7">before</em> the service worker is active, the service worker won’t intercept the network requests and cache the responses.
As a result, you might have to refresh a page before you see the caches appear.<a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" data-tertiary="proving files are coming from service worker" id="idm46634377970312" class="calibre6"/></p>

<p class="author1">To prove that the files are genuinely coming from the service worker, you can stop the server and refresh the web page. Even though
the server is no longer there, the page should load as usual (see <a data-type="xref" href="#ch11_image_6" class="calibre6">Figure 11-6</a>).</p>

<figure class="calibre29"><div id="ch11_image_6" class="figure">
<img src="Images/recb_1106.png" alt="" class="calibre198"/>
<h6 class="calibre30"><span class="firstname">Figure 11-6. </span>Even without the server running, you can refresh the page</h6>
</div></figure>

<p class="author1">You should now think of the React application as a local application rather than a network application. It’s served from the service
worker rather than the backend server. It will even let you get to navigate to page 2 (see <a data-type="xref" href="#ch11_image_7" class="calibre6">Figure 11-7</a>).</p>

<figure class="calibre29"><div id="ch11_image_7" class="figure">
<img src="Images/recb_1107.png" alt="" class="calibre199"/>
<h6 class="calibre30"><span class="firstname">Figure 11-7. </span>You can still navigate between pages even when the server is offline</h6>
</div></figure>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">Using code splitting <a data-type="indexterm" data-primary="code splitting" data-secondary="interfering with offline functionality" id="idm46634377961080" class="calibre6"/>can interfere with some offline functionality. If the code to display page 2 in the example
application was stored in a separate JavaScript file that was not initially loaded, the browser will not return it from the local
cache. It will be available once the browser has visited that page when the server is online.</p>
</div>

<p class="author1">While we are looking at page 2, we can examine a current problem with the service worker.<a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" data-tertiary="problem loading page 2 with server offline" id="idm46634377958968" class="calibre6"/> Make sure the server is <em class="calibre7">not</em> running, and
navigate to page 2. It should load normally. Then reload the page. Instead of seeing page 2, you will get an error page from the
browser (see <a data-type="xref" href="#ch11_image_8" class="calibre6">Figure 11-8</a>).</p>

<figure class="calibre29"><div id="ch11_image_8" class="figure">
<img src="Images/recb_1108.png" alt="" class="calibre200"/>
<h6 class="calibre30"><span class="firstname">Figure 11-8. </span>Page 2 will not reload when the server is offline</h6>
</div></figure>

<p class="author1">We can reload the front page of the application while offline, so why isn’t this true for page 2? It’s because this is an SPA. When we navigate to page 2, the browser isn’t loading a new web page from the server; instead, it uses the history API
to update the URL in the address bar and then modify the DOM to show page 2.</p>

<p class="author1">However, when you reload the page, the browser will make a new request to the server for <em class="calibre7">http://localhost:5000/page2</em>. When the
server is running, it will return the contents of <em class="calibre7">index.html</em> for all page requests, and the React router will render the components
to look like page 2.</p>

<p class="author1">This process falls apart when the server is no longer online. The service worker will not be able to respond to a request for
<em class="calibre7">http://localhost:5000/page2</em> using cached data. There is nothing in the cache for <em class="calibre7">page2</em>. So, it will forward the request to the
server, which is no longer running. That’s why you get the error page.</p>

<p class="author1">We can fix this by adding a little more code to <em class="calibre7">service-worker.js</em>:<sup class="calibre34"><a data-type="noteref" id="idm46634377919384-marker" href="ch11.xhtml#idm46634377919384" class="calibre35">3</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">clientsClaim</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-core'</code>
<code class="kr">import</code> <code class="go">{</code>
  <code class="nx">createHandlerBoundToURL</code><code class="go">,</code>
  <code class="nx">precacheAndRoute</code><code class="go">,</code>
<code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-precaching'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">registerRoute</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-routing'</code>

<code class="nx">clientsClaim</code><code class="go">()</code>

<code class="nx">precacheAndRoute</code><code class="go">(</code><code class="nx">self</code><code class="go">.</code><code class="nx">__WB_MANIFEST</code><code class="go">)</code>

<code class="kr">const</code> <code class="nx">fileExtensionRegexp</code> <code class="o">=</code> <code class="kr">new</code> <code class="nb">RegExp</code><code class="go">(</code><code class="s">'/[^/?]+\.[^/]+$'</code><code class="go">)</code>
<code class="nx">registerRoute</code><code class="go">(({</code> <code class="nx">request</code><code class="go">,</code> <code class="nx">url</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">request</code><code class="go">.</code><code class="nx">mode</code> <code class="o">!==</code> <code class="s">'navigate'</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">return</code> <code class="kr">false</code>
  <code class="go">}</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">url</code><code class="go">.</code><code class="nx">pathname</code><code class="go">.</code><code class="nx">startsWith</code><code class="go">(</code><code class="s">'/_'</code><code class="go">))</code> <code class="go">{</code>
    <code class="kr">return</code> <code class="kr">false</code>
  <code class="go">}</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">url</code><code class="go">.</code><code class="nx">pathname</code><code class="go">.</code><code class="nx">match</code><code class="go">(</code><code class="nx">fileExtensionRegexp</code><code class="go">))</code> <code class="go">{</code>
    <code class="kr">return</code> <code class="kr">false</code>
  <code class="go">}</code>
  <code class="kr">return</code> <code class="kr">true</code>
<code class="go">},</code> <code class="nx">createHandlerBoundToURL</code><code class="go">(</code><code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">PUBLIC_URL</code> <code class="o">+</code> <code class="s">'/index.html'</code><code class="go">))</code></pre>

<p class="author1">We are now registering an explicit <em class="calibre7">route</em> using <code class="calibre21">workbox-routing</code>. <a data-type="indexterm" data-primary="workbox-routing library" id="idm46634377840696" class="calibre6"/><a data-type="indexterm" data-primary="routing" data-secondary="registering explicit route using workbox-routing" id="idm46634377840136" class="calibre6"/><a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" data-tertiary="registering route handler" id="idm46634377839096" class="calibre6"/>A route decides how the service worker will deal with requests
for a set of paths. We’re registering a new route using a filter function and a handler in the previous example code. The filter
function is the first value passed to the <code class="calibre21">registerRoute</code> call. It will return true if this route deals with a given request. The
filter function in the preceding code will deal with any navigation requests to new web pages. So if you open the browser at
<em class="calibre7">http://localhost:5000/</em> or <em class="calibre7">http://localhost:5000/page2</em>, this route will return the same cached copy of <em class="calibre7">index.html</em>.</p>

<p class="author1">The function <code class="calibre21">createHandlerBoundToURL</code> will create a handler to treat any of these requests as if they were requests for
<em class="calibre7">http://localhost:5000/index.html</em>, which means that if we reload the application while we’re on page 2, the service worker should
load the HTML the same way it does when we are on the front page.</p>

<p class="author1">Let’s try this. After saving the change to <em class="calibre7">service-worker.js</em>, rebuild the application:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn run build</code></pre>

<p class="author1">Now make sure that your local server is running:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ serve -s build/</code></pre>

<p class="author1">Open the browser at <em class="calibre7">http://localhost:5000</em>, and you should see the application. If you check the developer tools, you will find that
it has loaded the new version of the service worker, but the old version of the service worker is still running (see <a data-type="xref" href="#ch11_image_9" class="calibre6">Figure 11-9</a>).</p>

<figure class="calibre29"><div id="ch11_image_9" class="figure">
<img src="Images/recb_1109.png" alt="" class="calibre201"/>
<h6 class="calibre30"><span class="firstname">Figure 11-9. </span>The old and new service workers are both visible in the tools</h6>
</div></figure>

<p class="author1">The previous version of the service worker is still in control of the application.<a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" data-tertiary="re-opening application to activate new worker" id="idm46634377786456" class="calibre6"/> The browser has installed the new service worker, but it’s in a <em class="calibre7">waiting</em> state. It won’t take over until the old service work disappears, and that will happen if you close down the tab and then reopen it (see <a data-type="xref" href="#ch11_image_10" class="calibre6">Figure 11-10</a>).</p>

<figure class="calibre29"><div id="ch11_image_10" class="figure">
<img src="Images/recb_1110.png" alt="" class="calibre202"/>
<h6 class="calibre30"><span class="firstname">Figure 11-10. </span>Reopen the application to activate the new worker</h6>
</div></figure>

<p class="author1">If you now stop your local server and navigate to page 2, you should be able to reload it with no problems (see <a data-type="xref" href="#ch11_image_11" class="calibre6">Figure 11-11</a>).</p>

<figure class="calibre29"><div id="ch11_image_11" class="figure">
<img src="Images/recb_1107.png" alt="" class="calibre199"/>
<h6 class="calibre30"><span class="firstname">Figure 11-11. </span>Once you’ve registered a route handler, you can reload page 2</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634379176328">
<h2 class="calibre27">Discussion</h2>

<p class="author1">We’ve gone into quite a lot of depth in this recipe, looking at how to create, register, and use service workers. In the following
recipe, you will see that you can automatically generate a lot of this code when you first build the application. But it’s still
worth digging into the messy details of how service workers operate. It helps to understand the life cycle of a worker: how a browser
installs a service worker and how it becomes active.</p>

<p class="author1">We have found that service workers can confuse anyone who is manually testing the code. If the browser is still running an old
version of a service worker, it may still be running an old version of your application. This confusion can lead to failed test
reports because an old bug might still appear to be there. Once you understand how new service workers load and how old service
workers disappear, you can quickly diagnose the problem.</p>

<p class="author1">Out-of-date service workers are not an issue with automated browser tests, which will tend to run in a <em class="calibre7">clean</em> state at the start of
a test, with no caches or running service workers.</p>

<p class="author1">Progressive web applications with service workers are a kind of hybrid between a local application and a remote application.<a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="with service workers, hybrid between local and remote application" id="idm46634377766024" class="calibre6"/> The server becomes
a distribution server for an application that is installed locally. When the application is updated, it will install a new version
in the browser, but that new application will not typically become available until the browser reopens it.</p>

<p class="author1">Now that we’ve gone through service workers in a detailed way, we can look at how you can quickly add them to a new
application.</p>

<p class="author1">You can download the source for this
recipe from the <a href="https://oreil.ly/su224" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="Workbox, creating service workers with" data-startref="ix_Wkbx" id="idm46634377763080" class="calibre6"/><a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="creating service workers using Workbox" data-startref="ix_PWAcrserwk" id="idm46634377762104" class="calibre6"/><a data-type="indexterm" data-primary="service workers" data-secondary="creating using Workbox" data-startref="ix_serwkcr" id="idm46634377760904" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Build a PWA with Create React App" class="calibre4"><div class="preface" id="ch11-02">
<h1 class="calibre17">Build a PWA with Create React App</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634377758248">
<h2 class="calibre27">Problem</h2>

<p class="author1">You need two things before <a data-type="indexterm" data-primary="create-react-app tool" data-secondary="building progressive web applications" id="ix_CRAbldPWA" class="calibre6"/><a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="building with create-react-app" id="ix_PwAbldCRA" class="calibre6"/>you can run service workers in your application. First, you need a service worker, and <a data-type="xref" href="#ch11-01" class="calibre6">“Create Service Workers with Workbox”</a> looked at how the Workbox library would help simplify the creation and management of service workers. Second, you need code
that will register the service worker in your application. Although complex to create, you can copy registration code to new
applications with few changes.</p>

<p class="author1">However, as patterns evolve in the use of service workers, it would be helpful to avoid the need to create our own registration
code. How can we do that?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634377815288">
<h2 class="calibre27">Solution</h2>

<p class="author1">We will look at how to use templates in <code class="calibre21">create-react-app</code> to build an application that includes service workers.<a data-type="indexterm" data-primary="service workers" data-secondary="PWA including, building with create-react-app" id="ix_serwkCRA" class="calibre6"/><a data-type="indexterm" data-primary="create-react-app tool" data-secondary="building progressive web applications" data-tertiary="using templates" id="idm46634377811736" class="calibre6"/></p>

<p class="author1">Even if you don’t intend to use <code class="calibre21">create-react-app</code>, it can be worth generating an application with it and then reusing the service
worker code in your project.</p>

<p class="author1">We briefly saw how to use application templates in <a data-type="xref" href="ch01_split_000.xhtml#chapter01" class="calibre6">Chapter 1</a> when we generated TypeScript projects with <code class="calibre21">create-react-app</code>.
Templates are the boilerplate code that <code class="calibre21">create-react-app</code> uses when it generates a new application.</p>

<p class="author1">If we want to create a progressive web application, we can do it by typing the 
<span class="firstname">following</span>:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npx create-react-app appname --template cra-template-pwa</code></pre>
<div data-type="tip" class="calibre25">
<p class="author1">If you want to create a TypeScript application, replace <code class="calibre21">cra-template-pwa</code> with <code class="calibre21">cra-template-pwa-typescript</code>.</p>
</div>

<p class="author1">If we do that, it will generate a React application in a new folder called <em class="calibre7">appname</em>. The application will look virtually the same
as any other CRA application, but it will install several Workbox libraries. It will add two additional source files. In the <em class="calibre7">src</em>
directory, you will find an example <em class="calibre7">service-worker.js</em> script:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">clientsClaim</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-core'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">ExpirationPlugin</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-expiration'</code>
<code class="kr">import</code> <code class="go">{</code>
  <code class="nx">precacheAndRoute</code><code class="go">,</code>
  <code class="nx">createHandlerBoundToURL</code><code class="go">,</code>
<code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-precaching'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">registerRoute</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-routing'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">StaleWhileRevalidate</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-strategies'</code>

<code class="nx">clientsClaim</code><code class="go">()</code>

<code class="nx">precacheAndRoute</code><code class="go">(</code><code class="nx">self</code><code class="go">.</code><code class="nx">__WB_MANIFEST</code><code class="go">)</code>

<code class="kr">const</code> <code class="nx">fileExtensionRegexp</code> <code class="o">=</code> <code class="kr">new</code> <code class="nb">RegExp</code><code class="go">(</code><code class="s">'/[^/?]+\.[^/]+$'</code><code class="go">)</code>
<code class="nx">registerRoute</code><code class="go">(({</code> <code class="nx">request</code><code class="go">,</code> <code class="nx">url</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">request</code><code class="go">.</code><code class="nx">mode</code> <code class="o">!==</code> <code class="s">'navigate'</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">return</code> <code class="kr">false</code>
  <code class="go">}</code>

  <code class="kr">if</code> <code class="go">(</code><code class="nx">url</code><code class="go">.</code><code class="nx">pathname</code><code class="go">.</code><code class="nx">startsWith</code><code class="go">(</code><code class="s">'/_'</code><code class="go">))</code> <code class="go">{</code>
    <code class="kr">return</code> <code class="kr">false</code>
  <code class="go">}</code>

  <code class="kr">if</code> <code class="go">(</code><code class="nx">url</code><code class="go">.</code><code class="nx">pathname</code><code class="go">.</code><code class="nx">match</code><code class="go">(</code><code class="nx">fileExtensionRegexp</code><code class="go">))</code> <code class="go">{</code>
    <code class="kr">return</code> <code class="kr">false</code>
  <code class="go">}</code>

  <code class="kr">return</code> <code class="kr">true</code>
<code class="go">},</code> <code class="nx">createHandlerBoundToURL</code><code class="go">(</code><code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">PUBLIC_URL</code> <code class="o">+</code> <code class="s">'/index.html'</code><code class="go">))</code>

<code class="nx">registerRoute</code><code class="go">(</code>
  <code class="go">({</code> <code class="nx">url</code> <code class="go">})</code> <code class="o">=&gt;</code>
    <code class="nx">url</code><code class="go">.</code><code class="nx">origin</code> <code class="o">===</code> <code class="nx">self</code><code class="go">.</code><code class="nx">location</code><code class="go">.</code><code class="nx">origin</code> <code class="o">&amp;&amp;</code>
    <code class="nx">url</code><code class="go">.</code><code class="nx">pathname</code><code class="go">.</code><code class="nx">endsWith</code><code class="go">(</code><code class="s">'.png'</code><code class="go">),</code>
  <code class="kr">new</code> <code class="nx">StaleWhileRevalidate</code><code class="go">({</code>
    <code class="nx">cacheName</code><code class="o">:</code> <code class="s">'images'</code><code class="go">,</code>
    <code class="nx">plugins</code><code class="o">:</code> <code class="go">[</code><code class="kr">new</code> <code class="nx">ExpirationPlugin</code><code class="go">({</code> <code class="nx">maxEntries</code><code class="o">:</code> <code class="mi">50</code> <code class="go">})],</code>
  <code class="go">})</code>
<code class="go">)</code>

<code class="nx">self</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'message'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">event</code><code class="go">.</code><code class="nx">data</code> <code class="o">&amp;&amp;</code> <code class="nx">event</code><code class="go">.</code><code class="nx">data</code><code class="go">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s">'SKIP_WAITING'</code><code class="go">)</code> <code class="go">{</code>
    <code class="nx">self</code><code class="go">.</code><code class="nx">skipWaiting</code><code class="go">()</code>
  <code class="go">}</code>
<code class="go">})</code></pre>

<p class="author1">The service worker is similar to the one we created in <a data-type="xref" href="#ch11-01" class="calibre6">“Create Service Workers with Workbox”</a>.</p>

<p class="author1">You will also find a new file in the <em class="calibre7">src</em> directory called <em class="calibre7">serviceWorkerRegistration.js</em>. This file is very long, so we won’t
include the contents here. But it serves the same purpose as the <em class="calibre7">registerWorker.js</em> script we wrote in <a data-type="xref" href="#ch11-01" class="calibre6">“Create Service Workers with Workbox”</a>. It registers the
service worker as the controller of the application. The <em class="calibre7">serviceWorkerRegistration.js</em> file is valuable, even if you don’t intend
to use <code class="calibre21">create-react-app</code> for your application. It has several additional features that the registration code in the previous recipe
did not. For example, suppose you are running on <em class="calibre7">localhost</em>. In that case, it will unregister any service workers that look like
they belong to a different application, which is helpful if you’re working on several React applications.</p>

<p class="author1">Even though the service worker and the registration code are created for you in your new application, they won’t actually be
configured. In the <em class="calibre7">index.js</em> file, you will find that the application will actually unregister any service workers:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">ReactDOM</code> <code class="nx">from</code> <code class="s">'react-dom'</code>
<code class="kr">import</code> <code class="s">'./index.css'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'./App'</code>
<code class="kr">import</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">serviceWorkerRegistration</code> <code class="nx">from</code> <code class="s">'./serviceWorkerRegistration'</code>
<code class="kr">import</code> <code class="nx">reportWebVitals</code> <code class="nx">from</code> <code class="s">'./reportWebVitals'</code>

<code class="nx">ReactDOM</code><code class="go">.</code><code class="nx">render</code><code class="go">(</code>
  <code class="go">&lt;</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">App</code> <code class="go">/&gt;</code>
  <code class="go">&lt;/</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;,</code>
  <code class="nb">document</code><code class="go">.</code><code class="nx">getElementById</code><code class="go">(</code><code class="s">'root'</code><code class="go">)</code>
<code class="go">)</code>

<code class="nx">serviceWorkerRegistration</code><code class="go">.</code><code class="nx">unregister</code><code class="go">()</code>

<code class="nx">reportWebVitals</code><code class="go">()</code></pre>

<p class="author1">If you want to enable the <em class="calibre7">service-worker.js</em> script, you will need to change <code class="calibre21">serviceWor⁠kerRegistration.unregister</code> to
<code class="calibre21">serviceWorkerRegistration.register</code>.</p>

<p class="author1">The <code class="calibre21">register</code> function allows you to pass callbacks into the registration process so that you can track the current status of the
service worker installation. To do this, pass an object with <code class="calibre21">onInstall</code> and <code class="calibre21">onUpdate</code> functions:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">serviceWorkerRegistration</code><code class="go">.</code><code class="nx">register</code><code class="go">({</code>
  <code class="nx">onInstall</code><code class="o">:</code> <code class="go">(</code><code class="nx">registration</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'Service worker installed'</code><code class="go">)</code>
  <code class="go">},</code>
  <code class="nx">onUpdate</code><code class="o">:</code> <code class="go">(</code><code class="nx">registration</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'Service worker updated'</code><code class="go">)</code>
  <code class="go">},</code>
<code class="go">})</code></pre>

<p class="author1">The callbacks are helpful if you want to defer some processing until after the browser has installed the service worker or if you
would like to run code when the new service worker is an update to a previous one. If <code class="calibre21">onUpdate</code> is called, you will know that your
new service worker is waiting for an old service worker to disappear.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634377814664">
<h2 class="calibre27">Discussion</h2>

<p class="author1"><a data-type="xref" href="#ch11-01" class="calibre6">“Create Service Workers with Workbox”</a> helps you understand how service workers operate. When you are finally building a real application,
templated code will be far more polished and feature-rich.<a data-type="indexterm" data-primary="service workers" data-secondary="PWA including, building with create-react-app" data-startref="ix_serwkCRA" id="idm46634377376952" class="calibre6"/></p>

<p class="author1">You can download the source for this
recipe from the <a href="https://oreil.ly/hHAC9" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="create-react-app tool" data-secondary="building progressive web applications" data-startref="ix_CRAbldPWA" id="idm46634377374632" class="calibre6"/><a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="building with create-react-app" data-startref="ix_PwAbldCRA" id="idm46634377373384" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Cache Third-Party Resources" class="calibre4"><div class="preface" id="ch11-03">
<h1 class="calibre17">Cache Third-Party Resources</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634377234824">
<h2 class="calibre27">Problem</h2>

<p class="author1">Many of the resources used in a modern application come from third-party servers: payment libraries, fonts, images, etc.<a data-type="indexterm" data-primary="caching" data-secondary="third-party resource caching by service workers" id="ix_cache3rd" class="calibre6"/><a data-type="indexterm" data-primary="third-party resource caching" id="ix_thrdres" class="calibre6"/><a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="caching third-party resources" id="ix_PWAcacthrd" class="calibre6"/> Third-party
resources can consume a lot of bandwidth and might grow in size over time. If they come from slow servers, then they might slow down
your application in a way that’s out of your control.<sup class="calibre34"><a data-type="noteref" id="idm46634377229464-marker" href="ch11.xhtml#idm46634377229464" class="calibre35">4</a></sup></p>

<p class="author1">Is it possible to use a service worker to cache third-party resources?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634377227992">
<h2 class="calibre27">Solution</h2>

<p class="author1">Service workers have limited scope because they are allowed to control pages only within the same URL path. <a data-type="indexterm" data-primary="service workers" data-secondary="caching third-party resources" id="ix_serwkcach3rd" class="calibre6"/>That’s why service
workers are generally at the root of an application; it allows them to control every page.</p>

<p class="author1">But there is no such limitation on the URLs that they are allowed to contact. They can talk to any endpoint that your page or code
can. That means you can start to cache resources that come from third-party servers.</p>

<p class="author1">The application you can see in <a data-type="xref" href="#ch11_image_12" class="calibre6">Figure 11-12</a> is using a font downloaded from Google Fonts.</p>

<figure class="calibre29"><div id="ch11_image_12" class="figure">
<img src="Images/recb_1112.png" alt="" class="calibre203"/>
<h6 class="calibre30"><span class="firstname">Figure 11-12. </span>An application with a Google font—beautiful!</h6>
</div></figure>

<p class="author1">The font was added using these two lines in the header of the page:</p>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;link</code> <code class="na">rel=</code><code class="s">"preconnect"</code> <code class="na">href=</code><code class="s">"https://fonts.gstatic.com"</code><code class="nt">&gt;</code>
<code class="nt">&lt;link</code> <code class="na">href=</code><code class="s">"https://fonts.googleapis.com/css2?family=Fascinate&amp;display=swap"</code>
      <code class="na">rel=</code><code class="s">"stylesheet"</code><code class="nt">&gt;</code></pre>

<p class="author1">The first <code class="calibre21">link</code> imports the web font, and the second imports the associated stylesheet.</p>

<p class="author1">To cache this in the application, we will first need to register a service worker. The example application was created with the
<em class="calibre7">cra-template-pwa</em> template, so we will need to call the <code class="calibre21">register</code> function in the <em class="calibre7">index.js</em> file:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">ReactDOM</code> <code class="nx">from</code> <code class="s">'react-dom'</code>
<code class="kr">import</code> <code class="s">'./index.css'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'./App'</code>
<code class="kr">import</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">serviceWorkerRegistration</code> <code class="nx">from</code> <code class="s">'./serviceWorkerRegistration'</code>
<code class="kr">import</code> <code class="nx">reportWebVitals</code> <code class="nx">from</code> <code class="s">'./reportWebVitals'</code>

<code class="nx">ReactDOM</code><code class="go">.</code><code class="nx">render</code><code class="go">(</code>
  <code class="go">&lt;</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">App</code> <code class="go">/&gt;</code>
  <code class="go">&lt;/</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;,</code>
  <code class="nb">document</code><code class="go">.</code><code class="nx">getElementById</code><code class="go">(</code><code class="s">'root'</code><code class="go">)</code>
<code class="go">)</code>

<code class="nx">serviceWorkerRegistration</code><code class="go">.</code><code class="nx">register</code><code class="go">()</code>

<code class="nx">reportWebVitals</code><code class="go">()</code></pre>

<p class="author1">We will now add some routes into the <em class="calibre7">service-worker.js</em> script, which contains the service worker for the application. The service
worker uses the Workbox library.</p>

<p class="author1">We need to cache the stylesheet and the downloadable font.</p>

<p class="author1">We saw in <a data-type="xref" href="#ch11-01" class="calibre6">“Create Service Workers with Workbox”</a> that we could precache the application code, which is such a common requirement that Workbox
lets you do it with a single line of code:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">precacheAndRoute</code><code class="go">(</code><code class="nx">self</code><code class="go">.</code><code class="nx">__WB_MANIFEST</code><code class="go">)</code></pre>

<p class="author1">This command will create a route that will cache any application code locally. We need to do a little more work if we want to cache
third-party resources.<a data-type="indexterm" data-primary="routing" data-secondary="route to cache third-party resource" id="idm46634377086936" class="calibre6"/> Let’s create a route to cache the stylesheet:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">registerRoute</code><code class="go">(</code>
  <code class="go">({</code> <code class="nx">url</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="nx">url</code><code class="go">.</code><code class="nx">origin</code> <code class="o">===</code> <code class="s">'https://fonts.googleapis.com'</code>
  <code class="c">// TODO Add handler</code>
<code class="go">)</code></pre>

<p class="author1">When we call <code class="calibre21">registerRoute</code>, we have to pass it a filter function and a handler.<a data-type="indexterm" data-primary="registerRoute function" id="idm46634377073320" class="calibre6"/> The filter function is given a request object and
returns true if the handler should process it. The handler is a function that decides how to satisfy the request. It might look in a
local cache, pass the request onto the network, or do some combination of the two.</p>

<p class="author1">Handlers are quite complex functions to build, but they typically follow some standard <em class="calibre7">strategy</em>, such as checking the cache before
downloading a file from the network.<a data-type="indexterm" data-primary="strategies (caching)" data-secondary="stale-while-revalidate" id="idm46634377071144" class="calibre6"/> Workbox has functions that will provide implementations of several strategies.<a data-type="indexterm" data-primary="stale-while-revalidate strategy" id="idm46634377070040" class="calibre6"/></p>

<p class="author1">When we’re downloading stylesheets, we’ll use a <a href="https://oreil.ly/Ct1K3" class="calibre6"><code class="calibre21">stale-while-revalidate</code> strategy</a>, which means that when the browser wants to download the Google stylesheet, we will send a request for the stylesheet and
also check the local cache to see if we already have a copy of the stylesheet file. If not, we’ll wait for the stylesheet network
request to return. This strategy is helpful if you make frequent requests for a resource but don’t care if you have the latest
version. We’ll prefer to use the cached version of the stylesheet because that will be faster. But we will also always request a new
version of the stylesheet from the network. We’ll cache whatever comes back from Google, so even if we don’t get the latest version
of the stylesheet this time, we will the next time we load it.</p>

<p class="author1">This is how we create a handler for the <code class="calibre21">stale-while-revalidate</code> strategy:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">registerRoute</code><code class="go">(</code>
  <code class="go">({</code> <code class="nx">url</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="nx">url</code><code class="go">.</code><code class="nx">origin</code> <code class="o">===</code> <code class="s">'https://fonts.googleapis.com'</code><code class="go">,</code>
  <code class="kr">new</code> <code class="nx">StaleWhileRevalidate</code><code class="go">({</code>
    <code class="nx">cacheName</code><code class="o">:</code> <code class="s">'stylesheets'</code><code class="go">,</code>
  <code class="go">})</code>
<code class="go">)</code></pre>

<p class="author1">The <code class="calibre21">StaleWhileRevalidate</code> function will return a handler function that will cache the stylesheet in a cache called <code class="calibre21">stylesheets</code>.</p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">When loading third-party requests, you might find that your request might fail with a cross-origin resource sharing (CORS) error.<a data-type="indexterm" data-primary="CORS (cross-origin resource sharing)" id="idm46634376971896" class="calibre6"/><a data-type="indexterm" data-primary="cross-origin resource sharing (CORS) errors" id="idm46634376971224" class="calibre6"/><a data-type="indexterm" data-primary="errors" data-secondary="cross-origin resource sharing (CORS)" id="idm46634376970520" class="calibre6"/>
This error can occur even if the third-party resource is returned with a valid CORS header because the <code class="calibre21">GET</code> request comes from
JavaScript code rather than the HTML of the page. You can fix it by setting the <code class="calibre21">crossorigin</code> to <code class="calibre21">anonymous</code> on the HTML element
using the resource, for example, the <code class="calibre21">link</code> reference that is downloading a stylesheet.</p>
</div>

<p class="author1">We could apply the same strategy when downloading the Google font. But font files can be large, and the <code class="calibre21">stale-while-revalidate</code>
strategy will always download the latest version of the resource, even if it does so only to update the local cache.</p>

<p class="author1">Instead, we’ll use a <a href="https://oreil.ly/c8aa5" class="calibre6"><em class="calibre7">cache-first</em> strategy</a>.<a data-type="indexterm" data-primary="cache-first strategy" id="idm46634376965064" class="calibre6"/><a data-type="indexterm" data-primary="strategies (caching)" data-secondary="cache-first" id="idm46634376964328" class="calibre6"/> In a cache-first
strategy, we first check the cache for the resource, and if it’s there, we use it. If we don’t find the resource locally, we will
send a network request. This is a helpful strategy for large resources. It does have a downside: you will download a new
version of the resource only if the cache doesn’t contain it. That means you might never be able to download any updated 
<span class="firstname">versions</span>.</p>

<p class="author1">For that reason, we usually configure the cache-first strategy to cache resources for only a given period. If the handler finds the
resource in the local cache but it’s too old, it will request the resource from the network and then cache the updated version.</p>

<p class="author1">Whatever we cache, we’ll be using until the cache times out. So if there’s some temporary problem on the third-party server and we
receive a <code class="calibre21">500</code> status,<sup class="calibre34"><a data-type="noteref" id="idm46634376960472-marker" href="ch11.xhtml#idm46634376960472" class="calibre35">5</a></sup> we don’t want to cache the response. So, we will also need to check the
status before we decide to cache a response.</p>

<p class="author1">The following code shows how we will register a route to cache the Google font:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">registerRoute</code><code class="go">(</code>
  <code class="go">({</code> <code class="nx">url</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="nx">url</code><code class="go">.</code><code class="nx">origin</code> <code class="o">===</code> <code class="s">'https://fonts.gstatic.com'</code><code class="go">,</code>
  <code class="kr">new</code> <code class="nx">CacheFirst</code><code class="go">({</code>
    <code class="nx">cacheName</code><code class="o">:</code> <code class="s">'fonts'</code><code class="go">,</code>
    <code class="nx">plugins</code><code class="o">:</code> <code class="go">[</code>
      <code class="kr">new</code> <code class="nx">CacheableResponsePlugin</code><code class="go">({</code>
        <code class="nx">statuses</code><code class="o">:</code> <code class="go">[</code><code class="mi">0</code><code class="go">,</code> <code class="mi">200</code><code class="go">],</code>
      <code class="go">}),</code>
      <code class="kr">new</code> <code class="nx">ExpirationPlugin</code><code class="go">({</code>
        <code class="nx">maxAgeSeconds</code><code class="o">:</code> <code class="mi">60</code> <code class="o">*</code> <code class="mi">60</code> <code class="o">*</code> <code class="mi">24</code> <code class="o">*</code> <code class="mi">7</code><code class="go">,</code>
        <code class="nx">maxEntries</code><code class="o">:</code> <code class="mi">5</code><code class="go">,</code>
      <code class="go">}),</code>
    <code class="go">],</code>
  <code class="go">})</code>
<code class="go">)</code></pre>

<p class="author1">This code will cache up to five font files in a local cache called <code class="calibre21">fonts</code>. The cached copies will time out after a week, and we will cache the response only if the status is either <code class="calibre21">200</code> or <code class="calibre21">0</code>. A <code class="calibre21">0</code> status indicates a cross-origin issue with the request, and in
this case, we cache the response. A CORS error will not go away without a code change, and if we cache the error, we will avoid
sending future requests that are doomed to fail.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634377227048">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Third-party resource caching can significantly improve the performance of your application, but much more importantly, it will make
resources available when your application is offline. It doesn’t matter too much if the application cannot read something cosmetic
like a font file. Still, if you’re using third-party code to generate a payment form, it would be helpful to keep doing so, even if
the user’s device is temporarily off the network.</p>

<p class="author1">You can download the source for this recipe
from the <a href="https://oreil.ly/QaFYG" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="caching" data-secondary="third-party resource caching by service workers" data-startref="ix_cache3rd" id="idm46634376878776" class="calibre6"/><a data-type="indexterm" data-primary="third-party resource caching" data-startref="ix_thrdres" id="idm46634376877400" class="calibre6"/><a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="caching third-party resources" data-startref="ix_PWAcacthrd" id="idm46634376876488" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Automatically Reload Workers" class="calibre4"><div class="preface" id="ch11-04">
<h1 class="calibre17">Automatically Reload Workers</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634376873656">
<h2 class="calibre27">Problem</h2>

<p class="author1">The way that service workers are updated can be confusing for anyone using or testing an application.<a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="reloading workers automatically" id="ix_PWArelwk" class="calibre6"/><a data-type="indexterm" data-primary="service workers" data-secondary="automatically reloading" id="ix_serwkautorel" class="calibre6"/> If we make a change to a
service worker, the application will download the new version and set its status to Installed (see <a data-type="xref" href="#ch11_image_13" class="calibre6">Figure 11-13</a>).</p>

<figure class="calibre29"><div id="ch11_image_13" class="figure">
<img src="Images/recb_1109.png" alt="" class="calibre201"/>
<h6 class="calibre30"><span class="firstname">Figure 11-13. </span>The updated worker is installed, but the old version is still running</h6>
</div></figure>

<p class="author1">The old service worker will go away only if the user closes the tab and then reopens it. The old worker disappears, and the new
worker can stop waiting and start running (see <a data-type="xref" href="#ch11_image_14" class="calibre6">Figure 11-14</a>).</p>

<figure class="calibre29"><div id="ch11_image_14" class="figure">
<img src="Images/recb_1110.png" alt="" class="calibre202"/>
<h6 class="calibre30"><span class="firstname">Figure 11-14. </span>The new worker will start only if you close and re-open the application</h6>
</div></figure>

<p class="author1">The service worker may be caching the application’s code, so if the service worker does not start running, it will not download the
latest code from the server. You might find that you are using an old version of the entire client application. To run the new
application, you need to reload the page (to install the new worker) and then close and reopen the tab (removing the old worker and
starting the new one).</p>

<p class="author1">Testers will soon get used to this slightly odd sequence, but the same is not true for real users. In reality, the fact that new
code will only update the next-but-one time that it’s available is usually not a big problem. It <em class="calibre7">can</em> be a problem if you have
made a significant change to the code, such as an update to an API.<sup class="calibre34"><a data-type="noteref" id="idm46634376861112-marker" href="ch11.xhtml#idm46634376861112" class="calibre35">6</a></sup></p>

<p class="author1">In some cases, you want to use the new code immediately. Is there a way to clear out the old service workers and upgrade to the new
version of the application?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634376859864">
<h2 class="calibre27">Solution</h2>

<p class="author1">There are two things that we need to do to switch to a new service worker:</p>

<p class="author1">If you’ve created your application with <code class="calibre21">create-react-app</code> or<a data-type="indexterm" data-primary="cra-template-pwa" id="idm46634376856888" class="calibre6"/> you are using the code from the <em class="calibre7">cra-template-pwa</em>
template,<sup class="calibre34"><a data-type="noteref" id="idm46634376855640-marker" href="ch11.xhtml#idm46634376855640" class="calibre35">7</a></sup> then you will be registering your service worker, using the
<code class="calibre21">serviceWorkerRegistration.register</code> function.<a data-type="indexterm" data-primary="serviceWorkerRegistration.register function" id="idm46634376853592" class="calibre6"/><a data-type="indexterm" data-primary="register function" id="idm46634376852792" class="calibre6"/> For example, you might have code in the <em class="calibre7">index.js</em> file of your application that looks
like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">ReactDOM</code> <code class="nx">from</code> <code class="s">'react-dom'</code>
<code class="kr">import</code> <code class="s">'./index.css'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'./App'</code>
<code class="kr">import</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">serviceWorkerRegistration</code> <code class="nx">from</code> <code class="s">'./serviceWorkerRegistration'</code>
<code class="kr">import</code> <code class="nx">reportWebVitals</code> <code class="nx">from</code> <code class="s">'./reportWebVitals'</code>

<code class="nx">ReactDOM</code><code class="go">.</code><code class="nx">render</code><code class="go">(</code>
  <code class="go">&lt;</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">App</code> <code class="go">/&gt;</code>
  <code class="go">&lt;/</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;,</code>
  <code class="nb">document</code><code class="go">.</code><code class="nx">getElementById</code><code class="go">(</code><code class="s">'root'</code><code class="go">)</code>
<code class="go">)</code>

<code class="nx">serviceWorkerRegistration</code><code class="go">.</code><code class="nx">register</code><code class="go">()</code>

<code class="nx">reportWebVitals</code><code class="go">()</code></pre>

<p class="author1">Even if you’ve written your own registration code, you will likely have something similar.</p>

<p class="author1">The <code class="calibre21">serviceWorkerRegistration.register</code> function allows you to pass a couple of callbacks, which will tell you when a service
worker has been installed or updated:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">serviceWorkerRegistration</code><code class="go">.</code><code class="nx">register</code><code class="go">({</code>
  <code class="nx">onInstall</code><code class="o">:</code> <code class="go">(</code><code class="nx">registration</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{},</code>
  <code class="nx">onUpdate</code><code class="o">:</code> <code class="go">(</code><code class="nx">registration</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{},</code>
<code class="go">})</code></pre>

<p class="author1">The callbacks receive a <em class="calibre7">registration</em> object: a wrapper for the service worker that the browser has just installed or updated.<a data-type="indexterm" data-primary="registration object" id="idm46634376741848" class="calibre6"/></p>

<p class="author1">A service worker is installed when it is downloaded. But if an existing service worker is running, the new service worker will wait
for the old service worker to disappear.<a data-type="indexterm" data-primary="onUpdate function" id="idm46634376740664" class="calibre6"/> If a service worker is waiting, the <code class="calibre21">onUpdate</code> function will be called.</p>

<p class="author1">We want to automatically remove the old service worker whenever the <code class="calibre21">onUpdate</code> function is called. That will allow the new service
worker to start operating.</p>

<p class="author1">Service workers are a specialized form of <em class="calibre7">web worker</em>. <a data-type="indexterm" data-primary="web workers" id="idm46634376737816" class="calibre6"/>A web worker is a piece of JavaScript that runs in a separate thread from
the JavaScript running in the web page. You communicate with all web workers by posting asynchronous messages to them. Service
workers can intercept network requests because the browser will convert network requests into messages.</p>

<p class="author1">So, we can ask a service worker to run an arbitrary piece of code by sending it a message.<a data-type="indexterm" data-primary="messages" data-secondary="making service worker respond to" id="idm46634376733912" class="calibre6"/> We can make our service worker respond to
messages by giving it a message event listener:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">self</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'message'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="c">// handle messages here</code>
<code class="go">})</code></pre>

<p class="author1">The <code class="calibre21">self</code> variable contains the global scope for the service worker.<a data-type="indexterm" data-primary="self variable" id="idm46634376720920" class="calibre6"/> It’s like <code class="calibre21">window</code> is for page code.</p>

<p class="author1">The page code can send a message to the new service worker, telling it that we want it to stop waiting and replace the old service
worker:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">serviceWorkerRegistration</code><code class="go">.</code><code class="nx">register</code><code class="go">({</code>
  <code class="nx">onUpdate</code><code class="o">:</code> <code class="go">(</code><code class="nx">registration</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">registration</code><code class="go">.</code><code class="nx">waiting</code><code class="go">.</code><code class="nx">postMessage</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'SKIP_WAITING'</code> <code class="go">})</code>
  <code class="go">},</code>
<code class="go">})</code></pre>

<p class="author1"><code class="calibre21">registration.waiting</code> is a reference<a data-type="indexterm" data-primary="registration.waiting" id="idm46634376635720" class="calibre6"/> to the service worker, and <code class="calibre21">registration.wait⁠ing.postMessage</code> will send it a message.</p>

<p class="author1">When the browser installs a new version of a service worker but the old service worker is still running, the application code will
send a <code class="calibre21">SKIP_WAITING</code> message to the new service worker.<a data-type="indexterm" data-primary="SKIP_WAITING message to new service worker" id="idm46634376633640" class="calibre6"/></p>

<p class="author1">Service workers have a built-in function called <code class="calibre21">skipWaiting</code>, which will kill the old service worker and allow the new one to
take over. So, we can call <code class="calibre21">skipWaiting</code> in the service worker, when it receives a <code class="calibre21">SKIP_WAITING</code> message:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">self</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'message'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">event</code><code class="go">.</code><code class="nx">data</code> <code class="o">&amp;&amp;</code> <code class="nx">event</code><code class="go">.</code><code class="nx">data</code><code class="go">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s">'SKIP_WAITING'</code><code class="go">)</code> <code class="go">{</code>
    <code class="nx">self</code><code class="go">.</code><code class="nx">skipWaiting</code><code class="go">()</code>
  <code class="go">}</code>
<code class="go">})</code></pre>

<p class="author1">If the application is now updated, the new service worker will immediately replace the old service worker.</p>

<p class="author1">There’s just one step remaining: we need to reload the page so that we can download the new application code through the new
service worker. This means that the updated version of the <em class="calibre7">index.js</em> file in the application looks like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">ReactDOM</code> <code class="nx">from</code> <code class="s">'react-dom'</code>
<code class="kr">import</code> <code class="s">'./index.css'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'./App'</code>
<code class="kr">import</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">serviceWorkerRegistration</code> <code class="nx">from</code> <code class="s">'./serviceWorkerRegistration'</code>
<code class="kr">import</code> <code class="nx">reportWebVitals</code> <code class="nx">from</code> <code class="s">'./reportWebVitals'</code>

<code class="nx">ReactDOM</code><code class="go">.</code><code class="nx">render</code><code class="go">(</code>
  <code class="go">&lt;</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">App</code> <code class="go">/&gt;</code>
  <code class="go">&lt;/</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;,</code>
  <code class="nb">document</code><code class="go">.</code><code class="nx">getElementById</code><code class="go">(</code><code class="s">'root'</code><code class="go">)</code>
<code class="go">)</code>

<code class="nx">serviceWorkerRegistration</code><code class="go">.</code><code class="nx">register</code><code class="go">({</code>
  <code class="nx">onUpdate</code><code class="o">:</code> <code class="go">(</code><code class="nx">registration</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">registration</code><code class="go">.</code><code class="nx">waiting</code><code class="go">.</code><code class="nx">postMessage</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'SKIP_WAITING'</code> <code class="go">})</code>
    <code class="nb">window</code><code class="go">.</code><code class="nx">location</code><code class="go">.</code><code class="nx">reload</code><code class="go">()</code>
  <code class="go">},</code>
<code class="go">})</code>

<code class="nx">reportWebVitals</code><code class="go">()</code></pre>

<p class="author1">Once you’ve installed this new version of the code, the application will automatically update itself each time the application
changes. Instead of seeing the old service worker alongside a patiently waiting version of the new service worker, you will instead
just see the newly loaded version (see <a data-type="xref" href="#ch11_image_15" class="calibre6">Figure 11-15</a>).</p>

<figure class="calibre29"><div id="ch11_image_15" class="figure">
<img src="Images/recb_1110.png" alt="" class="calibre202"/>
<h6 class="calibre30"><span class="firstname">Figure 11-15. </span>The new service worker will now immediately replace the old version</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634376858920">
<h2 class="calibre27">Discussion</h2>

<p class="author1">By adding a page reload, you will find that the page “blinks” when the new code is downloading. If you have a large application,
this might be jarring for the user, so you might choose to ask the user if they want to upgrade to the new version of the
application before reloading. Gmail does this whenever a significant update is available.</p>

<p class="author1">You can download the source for this recipe from
the <a href="https://oreil.ly/Lbal7" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="service workers" data-secondary="automatically reloading" data-startref="ix_serwkautorel" id="idm46634376432152" class="calibre6"/><a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="reloading workers automatically" data-startref="ix_PWArelwk" id="idm46634376430872" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Add Notifications" class="calibre4"><div class="preface" id="ch11-05">
<h1 class="calibre17">Add Notifications</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634376427992">
<h2 class="calibre27">Problem</h2>

<p class="author1">One of the advantages of service workers, and web workers in general, is that they don’t stop running just because the user leaves
the page. <a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="adding notifications" id="ix_PWAnoti" class="calibre6"/>If a service worker performs a slow operation, it will continue to run in the background, so long as the browser itself is
still running. That means you can leave the page or close the tab and be sure that your worker will have time to finish.<a data-type="indexterm" data-primary="web workers" data-secondary="background tasks in" id="idm46634376424872" class="calibre6"/><a data-type="indexterm" data-primary="service workers" data-secondary="background tasks in" id="idm46634376423928" class="calibre6"/></p>

<p class="author1">However, what if the user wants to know when the background task has finally finished? Service workers don’t have any visual
interface. They might control web pages, but they can’t update them. The only way that a web page and a service worker can
communicate is by sending messages.</p>

<p class="author1">Given that service workers have no visual interface, how can they let us know when something important has happened?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634376421496">
<h2 class="calibre27">Solution</h2>

<p class="author1">We’re going to create notifications from a service worker.<a data-type="indexterm" data-primary="notifications from service workers" id="ix_notiserwk" class="calibre6"/><a data-type="indexterm" data-primary="service workers" data-secondary="creating notifications from" id="ix_serwknoti" class="calibre6"/> Our example application (see <a data-type="xref" href="#ch11_image_16" class="calibre6">Figure 11-16</a>) will start a long-running
process, taking around 20 seconds, when you click the button.</p>

<figure class="calibre29"><div id="ch11_image_16" class="figure">
<img src="Images/recb_1116.png" alt="" class="calibre204"/>
<h6 class="calibre30"><span class="firstname">Figure 11-16. </span>The example application starts a slow process when you click the button</h6>
</div></figure>

<p class="author1">The user will have to grant permission to be sent a completion notification (see <a data-type="xref" href="#ch11_image_17" class="calibre6">Figure 11-17</a>). If they deny permission, the
background task will still run, but they won’t see anything when it’s complete.<a data-type="indexterm" data-primary="notifications from service workers" data-secondary="user granting permissions for" id="idm46634376412360" class="calibre6"/></p>

<figure class="calibre29"><div id="ch11_image_17" class="figure">
<img src="Images/recb_1117.png" alt="" class="calibre200"/>
<h6 class="calibre30"><span class="firstname">Figure 11-17. </span>You will have to grant permission to receive notifications</h6>
</div></figure>
<div data-type="tip" class="calibre25">
<p class="author1">Notifications have a poor reputation. You usually see them when a site wants to spam you with information. In general, if
you’re using notifications, it’s best to defer asking for permission until it’s apparent to the user why you want it. Avoid asking
for permission to send notifications when the page first loads because the user will have no idea why you want to send them.</p>
</div>

<p class="author1">The service worker will then run some code that will pause for 20 seconds, and then it will<a data-type="indexterm" data-primary="notifications from service workers" data-secondary="notification of task finishing" id="idm46634376407288" class="calibre6"/> display a notification (see <a data-type="xref" href="#ch11_image_18" class="calibre6">Figure 11-18</a>).</p>

<figure class="calibre29"><div id="ch11_image_18" class="figure">
<img src="Images/recb_1118.png" alt="" class="calibre205"/>
<h6 class="calibre30"><span class="firstname">Figure 11-18. </span>The notification that appears when the task is finished</h6>
</div></figure>

<p class="author1">Let’s start to look at the code. In the <code class="calibre21">App</code> component, we’ll add a button to run the background but make sure we make it
visible only if the browser supports service workers:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">startTask</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Start task here</code>
  <code class="go">}</code>
  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">header</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-header"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">img</code> <code class="na">src</code><code class="o">=</code><code class="go">{</code><code class="nx">logo</code><code class="go">}</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-logo"</code> <code class="na">alt</code><code class="o">=</code><code class="s">"logo"</code> <code class="go">/&gt;</code>
        <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code>
          <code class="nx">Edit</code> <code class="go">&lt;</code><code class="nt">code</code><code class="go">&gt;</code><code class="nx">src</code><code class="o">/</code><code class="nx">App</code><code class="go">.</code><code class="nx">js</code><code class="go">&lt;/</code><code class="nt">code</code><code class="go">&gt;</code> <code class="nx">and</code> <code class="nx">save</code> <code class="nx">to</code> <code class="nx">reload</code><code class="go">.</code>
        <code class="go">&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
        <code class="go">{</code><code class="s">'serviceWorker'</code> <code class="kr">in</code> <code class="nx">navigator</code> <code class="o">&amp;&amp;</code> <code class="go">(</code>
          <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{</code><code class="nx">startTask</code><code class="go">}&gt;</code><code class="nx">Do</code> <code class="nx">slow</code> <code class="nx">thing</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">)}</code>
      <code class="go">&lt;/</code><code class="nt">header</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code></pre>

<p class="author1">When the user clicks the button, they will call the <code class="calibre21">startTask</code> function. We can ask for permission to show notifications in
there:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">startTask</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">Notification</code><code class="go">.</code><code class="nx">requestPermission</code><code class="go">((</code><code class="nx">permission</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">navigator</code><code class="go">.</code><code class="nx">serviceWorker</code><code class="go">.</code><code class="nx">ready</code><code class="go">.</code><code class="nx">then</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">notifyMe</code> <code class="o">=</code> <code class="nx">permission</code> <code class="o">===</code> <code class="s">'granted'</code>
      <code class="c">// Then run task</code>
    <code class="go">})</code>
  <code class="go">})</code>
<code class="go">}</code></pre>

<p class="author1">If the user grants permission, the <code class="calibre21">permission</code> string will have the value <code class="calibre21">granted</code>, which will set the <code class="calibre21">notifyMe</code> variable to
<code class="calibre21">true</code>. We can run the task in the service worker and tell it whether it’s allowed to send a notification when it’s complete.</p>

<p class="author1">We cannot talk to service workers directly.<a data-type="indexterm" data-primary="notifications from service workers" data-secondary="posting messages to service workers" id="idm46634376124344" class="calibre6"/> Instead, we have to post messages because service workers run in a separate thread from
web page code.</p>

<p class="author1">We can get the current service worker controlling the page from <code class="calibre21">navigator.serviceWorker.controller</code>. <a data-type="indexterm" data-primary="navigator.serviceWorker.controller" id="idm46634376122392" class="calibre6"/>So, we can send a message to
the service worker like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">startTask</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">Notification</code><code class="go">.</code><code class="nx">requestPermission</code><code class="go">((</code><code class="nx">permission</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">navigator</code><code class="go">.</code><code class="nx">serviceWorker</code><code class="go">.</code><code class="nx">ready</code><code class="go">.</code><code class="nx">then</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">notifyMe</code> <code class="o">=</code> <code class="nx">permission</code> <code class="o">===</code> <code class="s">'granted'</code>
      <code class="nx">navigator</code><code class="go">.</code><code class="nx">serviceWorker</code><code class="go">.</code><code class="nx">controller</code><code class="go">.</code><code class="nx">postMessage</code><code class="go">({</code>
        <code class="nx">type</code><code class="o">:</code> <code class="s">'DO_SLOW_THING'</code><code class="go">,</code>
        <code class="nx">notifyMe</code><code class="go">,</code>
      <code class="go">})</code>
    <code class="go">})</code>
  <code class="go">})</code>
<code class="go">}</code></pre>

<p class="author1">In the example application, our service is in <em class="calibre7">service-worker.js</em>.<a data-type="indexterm" data-primary="messages" data-secondary="service workers receiving" id="idm46634376097704" class="calibre6"/> It can receive messages by adding a <code class="calibre21">message</code> event handler:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">self</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'message'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="go">...</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">event</code><code class="go">.</code><code class="nx">data</code> <code class="o">&amp;&amp;</code> <code class="nx">event</code><code class="go">.</code><code class="nx">data</code><code class="go">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s">'DO_SLOW_THING'</code><code class="go">)</code> <code class="go">{</code>
    <code class="c">// Code for slow task here</code>
  <code class="go">}</code>
<code class="go">})</code></pre>

<p class="author1">In a service worker, <code class="calibre21">self</code> refers to the global scope object.<a data-type="indexterm" data-primary="self variable" id="idm46634376019496" class="calibre6"/> It’s the equivalent of <code class="calibre21">window</code> in web page code. Let’s simulate a
slow task, with a call to <code class="calibre21">setTimeout</code>, which will wait for 20 seconds before sending a message to the console:<sup class="calibre34"><a data-type="noteref" id="idm46634376018072-marker" href="ch11.xhtml#idm46634376018072" class="calibre35">8</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">self</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'message'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="go">...</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">event</code><code class="go">.</code><code class="nx">data</code> <code class="o">&amp;&amp;</code> <code class="nx">event</code><code class="go">.</code><code class="nx">data</code><code class="go">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s">'DO_SLOW_THING'</code><code class="go">)</code> <code class="go">{</code>
    <code class="nx">setTimeout</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'Slow thing finished!'</code><code class="go">)</code>
      <code class="c">// TODO: Send notification here</code>
    <code class="go">},</code> <code class="mi">20000</code><code class="go">)</code>
  <code class="go">}</code>
<code class="go">})</code></pre>

<p class="author1">All that’s left to do now is show the notification.<a data-type="indexterm" data-primary="notifications from service workers" data-secondary="showing notification with registration object" id="idm46634376014728" class="calibre6"/> We can do this with the service worker’s <em class="calibre7">registration</em> object,<a data-type="indexterm" data-primary="registration object" data-secondary="showNotification method" id="idm46634375960136" class="calibre6"/> which has a
<code class="calibre21">showNotification</code> method:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">self</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'message'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="go">...</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">event</code><code class="go">.</code><code class="nx">data</code> <code class="o">&amp;&amp;</code> <code class="nx">event</code><code class="go">.</code><code class="nx">data</code><code class="go">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s">'DO_SLOW_THING'</code><code class="go">)</code> <code class="go">{</code>
    <code class="nx">setTimeout</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'Slow thing finished!'</code><code class="go">)</code>
      <code class="kr">if</code> <code class="go">(</code><code class="nx">event</code><code class="go">.</code><code class="nx">data</code><code class="go">.</code><code class="nx">notifyMe</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">self</code><code class="go">.</code><code class="nx">registration</code><code class="go">.</code><code class="nx">showNotification</code><code class="go">(</code><code class="s">'Slow thing finished!'</code><code class="go">,</code> <code class="go">{</code>
          <code class="nx">body</code><code class="o">:</code> <code class="s">'Now get on with your life'</code><code class="go">,</code>
          <code class="nx">icon</code><code class="o">:</code> <code class="s">'/logo512.png'</code><code class="go">,</code>
          <code class="nx">vibrate</code><code class="o">:</code> <code class="go">[</code><code class="mi">100</code><code class="go">,</code> <code class="mi">100</code><code class="go">,</code> <code class="mi">100</code><code class="go">,</code> <code class="mi">200</code><code class="go">,</code> <code class="mi">200</code><code class="go">,</code> <code class="mi">200</code><code class="go">,</code> <code class="mi">100</code><code class="go">,</code> <code class="mi">100</code><code class="go">,</code> <code class="mi">100</code><code class="go">],</code>
          <code class="c">// tag: 'some-id-if-you-do-not-want-duplicates'</code>
        <code class="go">})</code>
      <code class="go">}</code>
    <code class="go">},</code> <code class="mi">20000</code><code class="go">)</code>
  <code class="go">}</code>
<code class="go">})</code></pre>

<p class="author1">Notice that we check <code class="calibre21">event.data.notifyMe</code> before attempting to show a notification; this is the variable we added to the message in
the web page code.<a data-type="indexterm" data-primary="event.data.notifyMe" id="idm46634375956072" class="calibre6"/></p>

<p class="author1">The notification takes a <code class="calibre21">title</code> and an <code class="calibre21">options</code> object.<a data-type="indexterm" data-primary="notifications from service workers" data-secondary="title and options" id="idm46634375834104" class="calibre6"/> The options allow you to modify the behavior of the notification. In this
case, we’re giving it some body text and an icon and setting a vibration sequence.<a data-type="indexterm" data-primary="vibration for notifications" id="idm46634375832776" class="calibre6"/> If the user’s device supports them, they should
feel a set of <em class="calibre7">dot-dot-dot-dash-dash-dash-dot-dot-dot</em> vibrations when the notification appears.</p>

<p class="author1">There’s also a <code class="calibre21">tag</code> option, which we’ve commented out in the example code.<a data-type="indexterm" data-primary="notifications from service workers" data-secondary="tag option" id="idm46634375830872" class="calibre6"/> We can use the <code class="calibre21">tag</code> to uniquely identify a notification
and prevent the user from receiving the same notification multiple times. If you omit it, each call to <code class="calibre21">showNotification</code> will make a new
notification appear.</p>

<p class="author1">To try the code, you will first need to build the application because service workers will run only in production mode:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn run build</code></pre>

<p class="author1">You will then need to run a server on the contents of the generated <em class="calibre7">build</em> directory. You can do this by installing the <em class="calibre7">serve</em>
module and then running this command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ serve -s build</code></pre>

<p class="author1">If you open the application at <em class="calibre7">http://localhost:5000</em> and click the button, the slow process will start. You can then go to a
different page or close the tab, and the slow task will continue running. It will stop only if you close the browser.</p>

<p class="author1">After 20 seconds, you should see a notification appear that looks similar to <a data-type="xref" href="#ch11_image_19" class="calibre6">Figure 11-19</a>.</p>

<figure class="calibre29"><div id="ch11_image_19" class="figure">
<img src="Images/recb_1118.png" alt="" class="calibre205"/>
<h6 class="calibre30"><span class="firstname">Figure 11-19. </span>A notification as it appears on a Mac</h6>
</div></figure>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">It’s tempting to access your server from a mobile device to check that the vibrations work in the notification.<a data-type="indexterm" data-primary="HTTPS" data-secondary="loading service workers with" id="idm46634375760744" class="calibre6"/><a data-type="indexterm" data-primary="localhost" data-secondary="service workers on" id="idm46634375759800" class="calibre6"/> Be aware that
service workers are enabled only if you access <em class="calibre7">localhost</em> or are using HTTPS. If you want to test your application over HTTPS,
see <a data-type="xref" href="ch07.xhtml#ch07-03" class="calibre6">“Enable HTTPS”</a> to enable it on a server.</p>
</div>

<p class="author1">Given that notifications can appear after you’ve closed the page, it’s helpful if you give the user a simple way of navigating back
to your application.<a data-type="indexterm" data-primary="notifications from service workers" data-secondary="notification-click handler" id="idm46634375756824" class="calibre6"/> You can do this by adding a notification-click handler to your service worker. If a service worker creates a
notification and the user clicks it, the browser will send a <code class="calibre21">notificationclick</code> event to the service worker. You can create a
handler for it like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">self</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'notificationclick'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">event</code><code class="go">.</code><code class="nx">notification</code><code class="go">.</code><code class="nx">close</code><code class="go">()</code>
  <code class="c">// TODO Go back to the application</code>
<code class="go">})</code></pre>

<p class="author1">You can close the notification by calling <code class="calibre21">event.notification.close</code>. But how do you send the user back to the React application?<a data-type="indexterm" data-primary="notifications from service workers" data-secondary="sending user back to React application" id="idm46634375814024" class="calibre6"/></p>

<p class="author1">The service worker is the controller of zero or more browser tabs, which are called its <em class="calibre7">clients</em>.<a data-type="indexterm" data-primary="browsers" data-secondary="service worker clients" id="idm46634375812072" class="calibre6"/><a data-type="indexterm" data-primary="clients and servers" data-secondary="service worker clients" id="idm46634375811096" class="calibre6"/> These are tabs whose network
requests are intercepted by the service worker. <a data-type="indexterm" data-primary="self.clients" id="idm46634375810024" class="calibre6"/>You can get access to the list of clients using <code class="calibre21">self.clients</code>. This object has a
utility function called <code class="calibre21">openWindow</code> that can be used to open a new tab in the browser:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">self</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'notificationclick'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">event</code><code class="go">.</code><code class="nx">notification</code><code class="go">.</code><code class="nx">close</code><code class="go">()</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">self</code><code class="go">.</code><code class="nx">clients</code><code class="go">.</code><code class="nx">openWindow</code><code class="go">)</code> <code class="go">{</code>
    <code class="nx">self</code><code class="go">.</code><code class="nx">clients</code><code class="go">.</code><code class="nx">openWindow</code><code class="go">(</code><code class="s">'/'</code><code class="go">)</code>
  <code class="go">}</code>
<code class="go">})</code></pre>

<p class="author1">If the user now clicks the notification, the browser will return them to the front page of the React application.</p>

<p class="author1">But we can do a little better than that. If the user has switched to a different tab but the React application is still open, we
can switch the focus back to the correct tab.</p>

<p class="author1">To do this, we will need to get hold of an array of each of the open tabs that our service worker controls.<a data-type="indexterm" data-primary="browsers" data-secondary="open tabs controlled by service worker" id="idm46634375629976" class="calibre6"/> Then we can look to see
if any match the correct path. If we find one, we can switch focus to that tab:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">self</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'notificationclick'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">event</code><code class="go">.</code><code class="nx">notification</code><code class="go">.</code><code class="nx">close</code><code class="go">()</code>

  <code class="nx">event</code><code class="go">.</code><code class="nx">waitUntil</code><code class="go">(</code>
    <code class="nx">self</code><code class="go">.</code><code class="nx">clients</code>
      <code class="go">.</code><code class="nx">matchAll</code><code class="go">({</code>
        <code class="nx">type</code><code class="o">:</code> <code class="s">'window'</code><code class="go">,</code>
      <code class="go">})</code>
      <code class="go">.</code><code class="nx">then</code><code class="go">((</code><code class="nx">clientList</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
        <code class="kr">const</code> <code class="nx">returnPath</code> <code class="o">=</code> <code class="s">'/'</code>

        <code class="kr">const</code> <code class="nx">tab</code> <code class="o">=</code> <code class="nx">clientList</code><code class="go">.</code><code class="nx">find</code><code class="go">((</code><code class="nx">t</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="kr">return</code> <code class="nx">t</code><code class="go">.</code><code class="nx">url</code> <code class="o">===</code> <code class="nx">self</code><code class="go">.</code><code class="nx">location</code><code class="go">.</code><code class="nx">origin</code> <code class="o">+</code> <code class="nx">returnPath</code>
        <code class="go">})</code>
        <code class="kr">if</code> <code class="go">(</code><code class="nx">tab</code> <code class="o">&amp;&amp;</code> <code class="s">'focus'</code> <code class="kr">in</code> <code class="nx">tab</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">tab</code><code class="go">.</code><code class="nx">focus</code><code class="go">()</code>
        <code class="go">}</code> <code class="kr">else</code> <code class="kr">if</code> <code class="go">(</code><code class="nx">self</code><code class="go">.</code><code class="nx">clients</code><code class="go">.</code><code class="nx">openWindow</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">self</code><code class="go">.</code><code class="nx">clients</code><code class="go">.</code><code class="nx">openWindow</code><code class="go">(</code><code class="nx">returnPath</code><code class="go">)</code>
        <code class="go">}</code>
      <code class="go">})</code>
  <code class="go">)</code>
<code class="go">})</code></pre>

<p class="author1">If we click the notification, we will switch back to an open tab rather than always create a new one (see <a data-type="xref" href="#ch11_image_20" class="calibre6">Figure 11-20</a>).</p>

<figure class="calibre29"><div id="ch11_image_20" class="figure">
<img src="Images/recb_1120.png" alt="" class="calibre206"/>
<h6 class="calibre30"><span class="firstname">Figure 11-20. </span>The notification can switch back to our application if it’s still open</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634376419912">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Notifications are a great way of keeping the user informed about important events. The critical thing is to clarify <em class="calibre7">why</em> they
should agree to receive notifications and then send them only if something significant has happened.</p>

<p class="author1">You can download the source for this recipe from
the <a href="https://oreil.ly/ZkcrR" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="notifications from service workers" data-startref="ix_notiserwk" id="idm46634375476056" class="calibre6"/><a data-type="indexterm" data-primary="service workers" data-secondary="creating notifications from" data-startref="ix_serwknoti" id="idm46634375475080" class="calibre6"/><a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="adding notifications" data-startref="ix_PWAnoti" id="idm46634375473896" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Make Offline Changes with Background Sync" class="calibre4"><div class="preface" id="ch11-06">
<h1 class="calibre17">Make Offline Changes with Background Sync</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634375470968">
<h2 class="calibre27">Problem</h2>

<p class="author1">Imagine<a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="making offline changes using background sync" id="ix_PWAoffl" class="calibre6"/><a data-type="indexterm" data-primary="offline changes, making with background sync" id="ix_offlnchg" class="calibre6"/> someone is using an application in a place where a network connection is not available, for example, on a subway
train.<sup class="calibre34"><a data-type="noteref" id="idm46634375467048-marker" href="ch11.xhtml#idm46634375467048" class="calibre35">9</a></sup> Precaching of application code means that
there should be no problem opening an application without a network connection. The user can also move from page to page, and
everything should appear 
<span class="firstname">normal</span>.<a data-type="indexterm" data-primary="networks" data-secondary="background sync queuing requests when server unavailable" id="ix_ntqueue" class="calibre6"/></p>

<p class="author1">But what if they do something that will send data to a server? What if they try to post a message?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634375463528">
<h2 class="calibre27">Solution</h2>

<p class="author1"><em class="calibre7">Background sync</em> is a way of queuing network requests when the server is not available and then resending them automatically at a
later time.<a data-type="indexterm" data-primary="background sync" id="ix_bkgrnd" class="calibre6"/></p>

<p class="author1">Our example application will send some data to a backend server when the user clicks a button (see <a data-type="xref" href="#ch11_image_21" class="calibre6">Figure 11-21</a>).</p>

<figure class="calibre29"><div id="ch11_image_21" class="figure">
<img src="Images/recb_1121.png" alt="" class="calibre200"/>
<h6 class="calibre30"><span class="firstname">Figure 11-21. </span>The example application sends data to the server when the user clicks a button</h6>
</div></figure>

<p class="author1">To start the application, you will first need to build it with this command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn run build</code></pre>

<p class="author1">The example project includes this server in <em class="calibre7">server/index.js</em>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="go">(</code><code class="s">'express'</code><code class="go">)</code>
<code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="go">()</code>

<code class="nx">app</code><code class="go">.</code><code class="nx">use</code><code class="go">(</code><code class="nx">express</code><code class="go">.</code><code class="nx">json</code><code class="go">())</code>
<code class="nx">app</code><code class="go">.</code><code class="nx">use</code><code class="go">(</code><code class="nx">express</code><code class="go">.</code><code class="kr">static</code><code class="go">(</code><code class="s">'build'</code><code class="go">))</code>

<code class="nx">app</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/endpoint'</code><code class="go">,</code> <code class="go">(</code><code class="nx">request</code><code class="go">,</code> <code class="nx">response</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'Server received data'</code><code class="go">,</code> <code class="nx">request</code><code class="go">.</code><code class="nx">body</code><code class="go">)</code>
  <code class="nx">response</code><code class="go">.</code><code class="nx">send</code><code class="go">(</code><code class="s">'OK'</code><code class="go">)</code>
<code class="go">})</code>

<code class="nx">app</code><code class="go">.</code><code class="nx">listen</code><code class="go">(</code><code class="mi">8000</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'Launched on port 8000!'</code><code class="go">))</code></pre>

<p class="author1">The server will deliver content from the <em class="calibre7">build</em> directory, where the generated code is published. It also displays the data from
any <code class="calibre21">POST</code> requests sent to <em class="calibre7">http://localhost:8000/endpoint</em>.</p>

<p class="author1">You can start the server with this command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ node server</code></pre>

<p class="author1">If you now open the application in a browser at <em class="calibre7">http://localhost:8000</em> and click the button on the front page a few times, you will
see data appearing in the server 
<span class="firstname">window</span>:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ node server</code>
<code class="go">Launched on port 8000!</code>
<code class="go">Server received data { timeIs: '2021-05-09T18:59:37.280Z' }</code>
<code class="go">Server received data { timeIs: '2021-05-09T18:59:37.720Z' }</code>
<code class="go">Server received data { timeIs: '2021-05-09T18:59:38.064Z' }</code>
<code class="go">Server received data { timeIs: '2021-05-09T18:59:38.352Z' }</code></pre>

<p class="author1">This is the application code that sends data to the server. It uses the <code class="calibre21">fetch</code> function to <code class="calibre21">POST</code> the current time when the
button is pressed:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">logo</code> <code class="nx">from</code> <code class="s">'./logo.svg'</code>
<code class="kr">import</code> <code class="s">'./App.css'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">sendData</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">const</code> <code class="nx">options</code> <code class="o">=</code> <code class="go">{</code>
      <code class="nx">method</code><code class="o">:</code> <code class="s">'POST'</code><code class="go">,</code>
      <code class="nx">body</code><code class="o">:</code> <code class="nx">JSON</code><code class="go">.</code><code class="nx">stringify</code><code class="go">({</code> <code class="nx">timeIs</code><code class="o">:</code> <code class="kr">new</code> <code class="nb">Date</code><code class="go">()</code> <code class="go">}),</code>
      <code class="nx">headers</code><code class="o">:</code> <code class="go">{</code>
        <code class="s">'Content-Type'</code><code class="o">:</code> <code class="s">'application/json'</code><code class="go">,</code>
      <code class="go">},</code>
    <code class="go">}</code>
    <code class="nx">fetch</code><code class="go">(</code><code class="s">'/endpoint'</code><code class="go">,</code> <code class="nx">options</code><code class="go">)</code>
  <code class="go">}</code>
  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">header</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-header"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">img</code> <code class="na">src</code><code class="o">=</code><code class="go">{</code><code class="nx">logo</code><code class="go">}</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-logo"</code> <code class="na">alt</code><code class="o">=</code><code class="s">"logo"</code> <code class="go">/&gt;</code>
        <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code>
          <code class="nx">Edit</code> <code class="go">&lt;</code><code class="nt">code</code><code class="go">&gt;</code><code class="nx">src</code><code class="o">/</code><code class="nx">App</code><code class="go">.</code><code class="nx">js</code><code class="go">&lt;/</code><code class="nt">code</code><code class="go">&gt;</code> <code class="nx">and</code> <code class="nx">save</code> <code class="nx">to</code> <code class="nx">reload</code><code class="go">.</code>
        <code class="go">&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{</code><code class="nx">sendData</code><code class="go">}&gt;</code><code class="nx">Send</code> <code class="nx">data</code> <code class="nx">to</code> <code class="nx">server</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">header</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">If you now stop the server, clicking the button on the web page will generate a series of failed network requests, as shown in <a data-type="xref" href="#ch11_image_22" class="calibre6">Figure 11-22</a>.</p>

<figure class="calibre29"><div id="ch11_image_22" class="figure">
<img src="Images/recb_1122.png" alt="" class="calibre207"/>
<h6 class="calibre30"><span class="firstname">Figure 11-22. </span>If the server cannot be contacted, the network requests fail</h6>
</div></figure>

<p class="author1">Stopping the server simulates what would happen if the user was temporarily out of network contact and then tried to send data from
the application.</p>

<p class="author1">We can fix this problem using service workers. A service worker can intercept the network requests made by a web page in a
progressive web application. In the other recipes in this chapter, we have used service workers to handle network failures by
returning locally cached versions of files. We now need to handle data going in the opposite direction: from the browser to the
server.</p>

<p class="author1">We need to cache the <code class="calibre21">POST</code> requests that we try to send to the server and then resend them when we are back in contact with the
server.</p>

<p class="author1">To do this, we will use the <code class="calibre21">workbox-background-sync</code> library. <em class="calibre7">Background sync</em> is an API for diverting network requests onto a
queue in those cases where we cannot contact the server.<a data-type="indexterm" data-primary="workbox-background-sync library" id="idm46634375075336" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="Background Sync" id="idm46634375074776" class="calibre6"/> It’s a complex API, and not all browsers support it.</p>

<p class="author1">The <code class="calibre21">workbox-background-sync</code> library makes the API far easier to use, and it will also work on browsers like Firefox that don’t
support Background Sync natively.<a data-type="indexterm" data-primary="service workers" data-secondary="queuing network requests with Background Sync" id="ix_serwkBkgrSy" class="calibre6"/></p>

<p class="author1">The service worker for the example application is in the <em class="calibre7">service-worker.js</em> file. We can add background syncing by adding this
code:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">NetworkOnly</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-strategies'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">BackgroundSyncPlugin</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'workbox-background-sync'</code>

<code class="c">// Other service worker code here....</code>

<code class="nx">registerRoute</code><code class="go">(</code>
  <code class="c">//endpoint/,</code>
  <code class="kr">new</code> <code class="nx">NetworkOnly</code><code class="go">({</code>
    <code class="nx">plugins</code><code class="o">:</code> <code class="go">[</code>
      <code class="kr">new</code> <code class="nx">BackgroundSyncPlugin</code><code class="go">(</code><code class="s">'endPointQueue1'</code><code class="go">,</code> <code class="go">{</code>
        <code class="nx">maxRetentionTime</code><code class="o">:</code> <code class="mi">24</code> <code class="o">*</code> <code class="mi">60</code><code class="go">,</code>
      <code class="go">}),</code>
    <code class="go">],</code>
  <code class="go">}),</code>
  <code class="s">'POST'</code>
<code class="go">)</code></pre>

<p class="author1">This code will register a new <em class="calibre7">route</em> in the service worker, saying how to deal with network requests to particular URLs. In this
case, we are creating a route to handle all requests to <em class="calibre7">http://localhost:8000/endpoint</em>. We’re using a regular expression to match
the path. We’re then using a <a href="https://oreil.ly/rLqLq" class="calibre6">Network Only</a> strategy, which means that the browser will send all requests to the service worker, and all responses will come from the network.<a data-type="indexterm" data-primary="Network Only strategy" id="idm46634375030104" class="calibre6"/><a data-type="indexterm" data-primary="strategies (caching)" data-secondary="Network Only" id="idm46634375029432" class="calibre6"/>
But we’re configuring that strategy to use the background sync plugin. The third parameter in the route says that it is
interested only in <code class="calibre21">POST</code> requests to the 
<span class="firstname">endpoint</span>.</p>

<p class="author1">When the application sends a <code class="calibre21">POST</code> request to <em class="calibre7">http://localhost:8000/endpoint</em>, the service worker intercepts it. The service worker
will forward the request to the server, and if successful, it will return the response to the web page. If the server is
unavailable, the service worker will return a network error to the web page and then add the network request to a retry queue called
<code class="calibre21">endPointQueue1</code>.</p>

<p class="author1">Workbox stores queues in indexed databases within the browser. Setting the <code class="calibre21">maxRe⁠tentionTime</code> to <em class="calibre7">24 * 60</em> stores the requests in
the database for a maximum of one day.</p>

<p class="author1">The <code class="calibre21">workbox-background-sync</code> library will resend the requests in the queue whenever it thinks the server might have become
available, for example, if the network connection comes online. Retries will also happen every few minutes.<a data-type="indexterm" data-primary="workbox-background-sync library" data-secondary="resending requests to queue" id="idm46634375022808" class="calibre6"/></p>

<p class="author1">If you restart the server and then wait about five minutes, you should see the failed network requests appearing in the server:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ node server</code>
<code class="go">Launched on port 8000!</code>
<code class="go">Server received data { timeIs: '2021-05-09T21:26:11.068Z' }</code>
<code class="go">Server received data { timeIs: '2021-05-09T21:02:44.647Z' }</code>
<code class="go">Server received data { timeIs: '2021-05-09T21:02:45.647Z' }</code></pre>

<p class="author1">You can force Chrome to resend the requests immediately if you open the Application tab in the developer tools, select the service
worker, and then send a sync message to <code class="calibre21">workbox-background-sync:endPointQueue1</code> (as shown in <a data-type="xref" href="#ch11_image_23" class="calibre6">Figure 11-23</a>).</p>

<figure class="calibre29"><div id="ch11_image_23" class="figure">
<img src="Images/recb_1123.png" alt="" class="calibre208"/>
<h6 class="calibre30"><span class="firstname">Figure 11-23. </span>Forcing a sync to occur in Chrome</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634375462584">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Background sync is a tremendously powerful feature, but you need to think carefully before enabling it.<a data-type="indexterm" data-primary="background sync" data-secondary="cautions with" id="idm46634374989544" class="calibre6"/> The order in which the
client code sends requests will not necessarily be the order they are processed at the server.<a data-type="indexterm" data-primary="service workers" data-secondary="queuing network requests with Background Sync" data-startref="ix_serwkBkgrSy" id="idm46634374988312" class="calibre6"/></p>

<p class="author1">The exact order will probably not matter if you are creating a simple set of resources with <code class="calibre21">POST</code> requests. For example, if you buy
books from an online bookstore, it doesn’t matter what sequence you buy them in.</p>

<p class="author1">But if you create dependent resources or apply multiple updates to the same resource,⁠<sup class="calibre34"><a data-type="noteref" id="idm46634375015192-marker" href="ch11.xhtml#idm46634375015192" class="calibre35">10</a></sup> then you need to careful. If you amend your credit card number to <em class="calibre7">1111 1111 1111
1111</em> and then to <em class="calibre7">2222 2222 2222 2222</em>, the order of updates will completely change the final result.</p>

<p class="author1">You can download the source for this recipe
from the <a href="https://oreil.ly/NFVAY" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="networks" data-secondary="background sync queuing requests when server unavailable" data-startref="ix_ntqueue" id="idm46634375012568" class="calibre6"/><a data-type="indexterm" data-primary="offline changes, making with background sync" data-startref="ix_offlnchg" id="idm46634375011320" class="calibre6"/><a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="making offline changes using background sync" data-startref="ix_PWAoffl" id="idm46634375010408" class="calibre6"/><a data-type="indexterm" data-primary="background sync" data-startref="ix_bkgrnd" id="idm46634375009208" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Add a Custom Installation UI" class="calibre4"><div class="preface" id="ch11-07">
<h1 class="calibre17">Add a Custom Installation UI</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634375001352">
<h2 class="calibre27">Problem</h2>

<p class="author1">PWAs behave, in many ways, like locally installed applications.<a data-type="indexterm" data-primary="installation UI (custom) for PWAs" id="ix_instUI" class="calibre6"/><a data-type="indexterm" data-primary="UIs (user interfaces)" data-secondary="custom installation UI for PWAs" id="ix_UIPWA" class="calibre6"/><a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="adding custom installation UI" id="ix_PWAcusUI" class="calibre6"/> You <em class="calibre7">can</em> install them alongside other
applications on a desktop machine or a mobile device. Many 
<span class="firstname">browsers</span> allow you to create a shortcut on the current device to launch your 
<span class="firstname">application</span> in a separate window. If you’re using a desktop machine, you can add the shortcut to the dock or launch menus.<a data-type="indexterm" data-primary="browsers" data-secondary="installation of PWAs" id="idm46634374993976" class="calibre6"/> If
you’re on a mobile device, you can add the application to the home screen.</p>

<p class="author1">But many users miss the fact that that they can install PWAs, a situation that is not helped by the low-key interface used in
browsers to indicate that installation is possible (see <a data-type="xref" href="#ch11_image_24" class="calibre6">Figure 11-24</a>).</p>

<figure class="calibre29"><div id="ch11_image_24" class="figure">
<img src="Images/recb_1124.png" alt="" class="calibre209"/>
<h6 class="calibre30"><span class="firstname">Figure 11-24. </span>PWAs are installed with a small button in the address bar</h6>
</div></figure>

<p class="author1">Browsers do this to maximize the amount of screen estate available for your website. However, if you think that a local installation
would be helpful to your users, you might choose to add a custom installation UI. But how can you do that?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634374904408">
<h2 class="calibre27">Solution</h2>

<p class="author1">Some browsers<sup class="calibre34"><a data-type="noteref" id="idm46634374902744-marker" href="ch11.xhtml#idm46634374902744" class="calibre35">11</a></sup> will generate a JavaScript <code class="calibre21">beforeinstallprompt</code> event <a data-type="indexterm" data-primary="beforeinstallprompt event" id="idm46634374901640" class="calibre6"/>if they detect that your application is a fully fledged PWA.<sup class="calibre34"><a data-type="noteref" id="idm46634374900808-marker" href="ch11.xhtml#idm46634374900808" class="calibre35">12</a></sup></p>

<p class="author1">You can capture this event and use it to display your custom installation UI.</p>

<p class="author1">Create a component called <em class="calibre7">MyInstaller.js</em> and add this code:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">React</code><code class="go">,</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>

<code class="kr">const</code> <code class="nx">MyInstaller</code> <code class="o">=</code> <code class="go">({</code> <code class="nx">children</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">installEvent</code><code class="go">,</code> <code class="nx">setInstallEvent</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nb">window</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'beforeinstallprompt'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">event</code><code class="go">.</code><code class="nx">preventDefault</code><code class="go">()</code>
      <code class="nx">setInstallEvent</code><code class="go">(</code><code class="nx">event</code><code class="go">)</code>
    <code class="go">})</code>
  <code class="go">},</code> <code class="go">[])</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;&gt;</code>
      <code class="go">{</code><code class="nx">installEvent</code> <code class="o">&amp;&amp;</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">button</code>
          <code class="na">onClick</code><code class="o">=</code><code class="go">{</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
            <code class="nx">installEvent</code><code class="go">.</code><code class="nx">prompt</code><code class="go">()</code>
            <code class="nx">await</code> <code class="nx">installEvent</code><code class="go">.</code><code class="nx">userChoice</code>
            <code class="nx">setInstallEvent</code><code class="go">(</code><code class="kr">null</code><code class="go">)</code>
          <code class="go">}}</code>
        <code class="go">&gt;</code>
          <code class="nx">Install</code> <code class="kr">this</code> <code class="nx">app</code><code class="o">!</code>
        <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">)}</code>
      <code class="go">{</code><code class="nx">children</code><code class="go">}</code>
    <code class="go">&lt;/&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">MyInstaller</code></pre>

<p class="author1">This component will capture the <code class="calibre21">onbeforeinstallprompt</code> event<a data-type="indexterm" data-primary="onbeforeinstallprompt event" id="idm46634374895608" class="calibre6"/> and store it in the <code class="calibre21">installEvent</code> variable. It then uses the
existence of the event to display a custom user interface. In the code here, it displays a simple button on the screen. You can then
insert this component into your application, for example:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">MyInstaller</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">header</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-header"</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">img</code> <code class="na">src</code><code class="o">=</code><code class="go">{</code><code class="nx">logo</code><code class="go">}</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-logo"</code> <code class="na">alt</code><code class="o">=</code><code class="s">"logo"</code> <code class="go">/&gt;</code>
          <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code>
            <code class="nx">Edit</code> <code class="go">&lt;</code><code class="nt">code</code><code class="go">&gt;</code><code class="nx">src</code><code class="o">/</code><code class="nx">App</code><code class="go">.</code><code class="nx">js</code><code class="go">&lt;/</code><code class="nt">code</code><code class="go">&gt;</code> <code class="nx">and</code> <code class="nx">save</code> <code class="nx">to</code> <code class="nx">reload</code><code class="go">.</code>
          <code class="go">&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">a</code>
            <code class="na">className</code><code class="o">=</code><code class="s">"App-link"</code>
            <code class="na">href</code><code class="o">=</code><code class="s">"https://reactjs.org"</code>
            <code class="na">target</code><code class="o">=</code><code class="s">"_blank"</code>
            <code class="na">rel</code><code class="o">=</code><code class="s">"noopener noreferrer"</code>
          <code class="go">&gt;</code>
            <code class="nx">Learn</code> <code class="nx">React</code>
          <code class="go">&lt;/</code><code class="nt">a</code><code class="go">&gt;</code>
        <code class="go">&lt;/</code><code class="nt">header</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">MyInstaller</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code></pre>

<p class="author1">If you now build and run the application:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn run build</code>
<code class="go">$ serve -s build</code></pre>

<p class="author1">you will see the install button at the top of the front page (see <a data-type="xref" href="#ch11_image_25" class="calibre6">Figure 11-25</a>). You won’t see the install button if you run the
application with the development server, like this:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn run start</code></pre>

<figure class="calibre29"><div id="ch11_image_25" class="figure">
<img src="Images/recb_1125.png" alt="" class="calibre210"/>
<h6 class="calibre30"><span class="firstname">Figure 11-25. </span>The custom install button appears at the top of the page</h6>
</div></figure>

<p class="author1">That’s because the application will qualify as a PWA only if it has a service worker running.<a data-type="indexterm" data-primary="service workers" id="idm46634374619736" class="calibre6"/> The service
worker will run only in production code.</p>

<p class="author1">If you click the Install button, the <code class="calibre21">MyInstaller</code> component will run the <code class="calibre21">installE⁠vent.prompt</code> method.<a data-type="indexterm" data-primary="installEvent.prompt method" id="idm46634374617688" class="calibre6"/> This will display the
usual installation dialog (see <a data-type="xref" href="#ch11_image_26" class="calibre6">Figure 11-26</a>).</p>

<figure class="calibre29"><div id="ch11_image_26" class="figure">
<img src="Images/recb_1126.png" alt="" class="calibre211"/>
<h6 class="calibre30"><span class="firstname">Figure 11-26. </span>The install prompt will appear when you click the custom install button</h6>
</div></figure>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">If your device has already installed the application, the browser will not fire the <code class="calibre21">onbeforeinstallprompt</code> event.<a data-type="indexterm" data-primary="onbeforeinstallprompt event" id="idm46634374592136" class="calibre6"/></p>
</div>

<p class="author1">If the user chooses to install the application, it will launch a separate application window.<sup class="calibre34"><a data-type="noteref" id="idm46634374590808-marker" href="ch11.xhtml#idm46634374590808" class="calibre35">13</a></sup> If<a data-type="indexterm" data-primary="browsers" data-secondary="launch icon for PWA" id="idm46634374589896" class="calibre6"/> they are using a desktop machine, a finder or explorer window might appear,
with a launch icon for the application that can be added to the dock or launch menus on your machine (see <a data-type="xref" href="#ch11_image_27" class="calibre6">Figure 11-27</a>). On a mobile
device, the icon will appear on the home screen.</p>

<figure class="calibre29"><div id="ch11_image_27" class="figure">
<img src="Images/recb_1127.png" alt="" class="calibre212"/>
<h6 class="calibre30"><span class="firstname">Figure 11-27. </span>The browser will create a launch icon for the application</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634374903816">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Local installation is an excellent feature for users who want to run your application often. In our experience, many users don’t
realize that the installation option is available for some sites, so adding a custom interface is a good idea. However, you should
be wary of creating an intrusive interface if you think your users are likely to be one-time visitors. It’s probably also best
to avoid triggering the appearance of the instance automatically when the page loads. Doing so is likely to irritate your users and
deter them from returning to your site.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/Dbmpc" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="installation UI (custom) for PWAs" data-startref="ix_instUI" id="idm46634374626776" class="calibre6"/><a data-type="indexterm" data-primary="UIs (user interfaces)" data-secondary="custom installation UI for PWAs" data-startref="ix_UIPWA" id="idm46634374625800" class="calibre6"/><a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="adding custom installation UI" data-startref="ix_PWAcusUI" id="idm46634374624568" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Provide Offline Responses" class="calibre4"><div class="preface" id="ch11-08">
<h1 class="calibre17">Provide Offline Responses</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634374621640">
<h2 class="calibre27">Problem</h2>

<p class="author1">You won’t want to cache all third-party resources in your application; it would take too much space.<a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="providing offline responses" id="ix_PWAofflres" class="calibre6"/><a data-type="indexterm" data-primary="offline responses, providing" id="ix_offlnres" class="calibre6"/><a data-type="indexterm" data-primary="third-party resource caching" id="idm46634374568024" class="calibre6"/> That means there will be times
when your code will be unable to load all the resources it needs. For example, you can see in <a data-type="xref" href="#ch11_image_28" class="calibre6">Figure 11-28</a> an application we created
in an earlier chapter that displayed a series of images from a third-party image site.</p>

<figure class="calibre29"><div id="ch11_image_28" class="figure">
<img src="Images/recb_1128.png" alt="" class="calibre213"/>
<h6 class="calibre30"><span class="firstname">Figure 11-28. </span>The application displays images from <span class="firstname">http://picsum.photos</span></h6>
</div></figure>

<p class="author1">You can use a service worker to cache all of this application’s code to work offline.<a data-type="indexterm" data-primary="service workers" data-secondary="caching application code to work offline" id="idm46634374562904" class="calibre6"/> You probably wouldn’t want to cache the
third-party images because there will be too many. That means that if you disconnect from the network, the application will still
open but without images (see <a data-type="xref" href="#ch11_image_29" class="calibre6">Figure 11-29</a>).</p>

<figure class="calibre29"><div id="ch11_image_29" class="figure">
<img src="Images/recb_1129.png" alt="" class="calibre213"/>
<h6 class="calibre30"><span class="firstname">Figure 11-29. </span>If you’re offline, the images won’t load</h6>
</div></figure>

<p class="author1">It would be helpful to replace the missing image with a locally served replacement. That way, when the user is offline, they will
still see a placeholder image.</p>

<p class="author1">This is a particular case of a general problem: you may want to have placeholder files when a sizable external file is unavailable.
You might want to replace video files, audio files, or even complete web pages with some temporary replacement.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634374557080">
<h2 class="calibre27">Solution</h2>

<p class="author1">To solve this problem, we’ll use a couple of service worker techniques that together will return a local replacement with a cached
file.</p>

<p class="author1">Let’s say we want to replace all failed image loads with the replacement image shown in <a data-type="xref" href="#ch11_image_30" class="calibre6">Figure 11-30</a>.</p>

<figure class="calibre29"><div id="ch11_image_30" class="figure">
<img src="Images/recb_1130.png" alt="" class="calibre214"/>
<h6 class="calibre30"><span class="firstname">Figure 11-30. </span>Replacement for images that fail to load</h6>
</div></figure>

<p class="author1">The first thing we need to do is make sure that the image file is available in the local cache. We’ll add the image to static files
used by the application, but we can’t rely on the replacement image being cached automatically. Precaching will store any files we
download from the server. We will not need the placeholder image until the network is offline, so we will have to use <em class="calibre7">cache
warming</em> to load the image into a local cache explicitly.</p>

<p class="author1">In the service worker, we’re going to run some code as soon as the service worker is installed. We can do this by adding an
<code class="calibre21">install</code> event handler:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">self</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'install'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="c">// Cache image here</code>
<code class="go">})</code></pre>

<p class="author1">We can explicitly open a local cache—which we’ll call <code class="calibre21">fallback</code>—and then add the file to it from the network:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">self</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'install'</code><code class="go">,</code> <code class="go">(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">event</code><code class="go">.</code><code class="nx">waitUntil</code><code class="go">(</code>
    <code class="nx">caches</code><code class="go">.</code><code class="nx">open</code><code class="go">(</code><code class="s">'fallback'</code><code class="go">).</code><code class="nx">then</code><code class="go">((</code><code class="nx">cache</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">cache</code><code class="go">.</code><code class="nx">add</code><code class="go">(</code><code class="s">'/comingSoon.png'</code><code class="go">)</code>
    <code class="go">})</code>
  <code class="go">)</code>
<code class="go">})</code></pre>

<p class="author1">You can use this technique if you ever want to cache files when your application is installed, which is helpful for files that will
be needed when you’re offline but that are not immediately loaded by the application.</p>

<p class="author1">Now that we have the replacement image stored, we need to return it when the real images are not available. We’ll need to add code
that will run when network requests fail.<a data-type="indexterm" data-primary="catch handler" id="idm46634374447128" class="calibre6"/> We can do this with a <em class="calibre7">catch handler</em>. <a data-type="indexterm" data-primary="strategies (caching)" data-secondary="catch handler executed when Workbox strategy fails" id="idm46634374446120" class="calibre6"/>A catch handler is executed when a Workbox strategy fails:<sup class="calibre34"><a data-type="noteref" id="idm46634374444984-marker" href="ch11.xhtml#idm46634374444984" class="calibre35">14</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">setCatchHandler</code><code class="go">(({</code> <code class="nx">event</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">event</code><code class="go">.</code><code class="nx">request</code><code class="go">.</code><code class="nx">destination</code> <code class="o">===</code> <code class="s">'image'</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">return</code> <code class="nx">caches</code><code class="go">.</code><code class="nx">match</code><code class="go">(</code><code class="s">'/comingSoon.png'</code><code class="go">)</code>
  <code class="go">}</code>
  <code class="kr">return</code> <code class="nx">Response</code><code class="go">.</code><code class="nx">error</code><code class="go">()</code>
<code class="go">})</code></pre>

<p class="author1">The catch handler receives the failed request object. We could check the URL of the request, but it is better to check the request’s
<code class="calibre21">destination</code>. The destination is the thing that will consume the file, and the destination is helpful when selecting a placeholder
for the file. If the destination is <code class="calibre21">image</code>, the request happened because the browser was trying to load an <code class="calibre21">img</code> element. Here are
some other examples of request destinations:</p>
<table class="calibre10">

<thead class="calibre11">
<tr class="calibre12">
<th class="calibre13">Destination</th>
<th class="calibre13">Generated by</th>
</tr>
</thead>
<tbody class="calibre14">
<tr class="calibre12">
<td class="calibre15"><p class="author1">“”</p></td>
<td class="calibre15"><p class="author1">JavaScript network requests</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1">“audio”</p></td>
<td class="calibre15"><p class="author1">Loading an &lt;audio&gt;</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1">“document”</p></td>
<td class="calibre15"><p class="author1">Navigation to a web page</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1">“embed”</p></td>
<td class="calibre15"><p class="author1">Loading an &lt;embed&gt;</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1">“font”</p></td>
<td class="calibre15"><p class="author1">Loading a font in CSS</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1">“frame”</p></td>
<td class="calibre15"><p class="author1">Loading a &lt;frame&gt;</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1">“iframe”</p></td>
<td class="calibre15"><p class="author1">Loading an&lt;iframe&gt;</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1">“image”</p></td>
<td class="calibre15"><p class="author1">Loading an &lt;img&gt;, /favicon.ico, SVG &lt;image&gt;, or a CSS image</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1">“object”</p></td>
<td class="calibre15"><p class="author1">Loading an &lt;object&gt;</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1">“script”</p></td>
<td class="calibre15"><p class="author1">Loading a &lt;script&gt;</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1">“serviceworker”</p></td>
<td class="calibre15"><p class="author1">Loading a service worker</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1">“sharedworker”</p></td>
<td class="calibre15"><p class="author1">Loading a shared worker</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1">“style”</p></td>
<td class="calibre15"><p class="author1">Loading CSS</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1">“video”</p></td>
<td class="calibre15"><p class="author1">Loading a &lt;video&gt;</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1">“worker”</p></td>
<td class="calibre15"><p class="author1">Loading a worker</p></td>
</tr>
</tbody>
</table>

<p class="author1">If our catch handler is called, we will return the <em class="calibre7">comingSoon.png</em> image from the cache. We’re using <code class="calibre21">caches.match</code> to find the
file in any of the available caches.<a data-type="indexterm" data-primary="caches.match" id="idm46634374345608" class="calibre6"/></p>

<p class="author1">But now that we have a catch handler, we need to make sure that we define a Workbox strategy for every request. If not, a failed
request might not trigger the catch handler. If we set a default handler, it will apply a strategy to every request not handled in
some other way:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">setDefaultHandler</code><code class="go">(</code><code class="kr">new</code> <code class="nx">NetworkOnly</code><code class="go">())</code></pre>

<p class="author1">This command will ensure that the service worker forwards all requests to the network unless some more specific handler is defined.</p>

<p class="author1">Each of the <code class="calibre21">img</code> tags on the page will generate a request with a destination of <code class="calibre21">image</code>. The default handler will forward them to a
third-party server, which will cause an error because the application can’t contact the network. The catch handler will then return
the replacement image file to each <code class="calibre21">img</code> element. You can see the result of this process in <a data-type="xref" href="#ch11_image_31" class="calibre6">Figure 11-31</a>.</p>

<figure class="calibre29"><div id="ch11_image_31" class="figure">
<img src="Images/recb_1131.png" alt="" class="calibre215"/>
<h6 class="calibre30"><span class="firstname">Figure 11-31. </span>When offline, all images are replaced by a placeholder</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634374556136">
<h2 class="calibre27">Discussion</h2>

<p class="author1">This technique is beneficial for large media files that are difficult or impossible to cache locally. If, for example, you have
built an application to play podcasts, you could replace a missing episode with a short audio clip, explaining that the episode will be available only when you are next online.</p>

<p class="author1">Warming the cache with files can increase the time needed for the service worker to install. For this reason, if you’re warming a
cache with reasonably large files, you should also add this line to your service worker:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="o">*</code> <code class="nx">as</code> <code class="nx">navigationPreload</code> <code class="nx">from</code> <code class="s">'workbox-navigation-preload'</code>
<code class="go">...</code>
<code class="nx">navigationPreload</code><code class="go">.</code><code class="nx">enable</code><code class="go">()</code></pre>

<p class="author1"><em class="calibre7">Navigation preload</em> is a browser optimization that will run network requests in the background if they begin when a service worker
is installing.<a data-type="indexterm" data-primary="navigation preload" id="idm46634374306024" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="navigation preload optimization" id="idm46634374305416" class="calibre6"/> Not all browsers support navigation preload, but the <code class="calibre21">workbox-navigation-preload</code> library will use it if it’s
available.<a data-type="indexterm" data-primary="workbox-navigation-preload library" id="idm46634374304024" class="calibre6"/></p>

<p class="author1">You can download the source for this
recipe from the <a href="https://oreil.ly/5nN80" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-secondary="providing offline responses" data-startref="ix_PWAofflres" id="idm46634374302248" class="calibre6"/><a data-type="indexterm" data-primary="offline responses, providing" data-startref="ix_offlnres" id="idm46634374270920" class="calibre6"/><a data-type="indexterm" data-primary="progressive web applications (PWAs)" data-startref="ix_PWA" id="idm46634374270008" class="calibre6"/></p>
</div></section>





</div></section>







<div data-type="footnotes" class="calibre49"><p data-type="footnote" id="idm46634379052936" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634379052936-marker" class="calibre35">1</a></sup> See <a data-type="xref" href="#ch11-02" class="calibre6">“Build a PWA with Create React App”</a>.</p><p data-type="footnote" id="idm46634378758840" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634378758840-marker" class="calibre35">2</a></sup> The code we will build here is a simplified version of the code in the <code class="calibre21">cra-template-pwa</code> library. For further information, see <a href="https://oreil.ly/dKJE0" class="calibre6">this issue on GitHub</a>.</p><p data-type="footnote" id="idm46634377919384" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634377919384-marker" class="calibre35">3</a></sup> This code is based on the example service worker is <code class="calibre21">cra-template-pwa</code>, which we will look at in the following recipe.</p><p data-type="footnote" id="idm46634377229464" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634377229464-marker" class="calibre35">4</a></sup> A recent project we worked on relied on a third-party payment library. When we were testing the application’s performance, the payment library was by far the slowest component, not simply because it was large but because its server often took several 100 ms to start downloading the code.</p><p data-type="footnote" id="idm46634376960472" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634376960472-marker" class="calibre35">5</a></sup> “Internal Server Error.”</p><p data-type="footnote" id="idm46634376861112" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634376861112-marker" class="calibre35">6</a></sup> This is not the case if you use semantic versioning of API endpoints.</p><p data-type="footnote" id="idm46634376855640" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634376855640-marker" class="calibre35">7</a></sup> See <a data-type="xref" href="#ch11-02" class="calibre6">“Build a PWA with Create React App”</a>.</p><p data-type="footnote" id="idm46634376018072" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634376018072-marker" class="calibre35">8</a></sup> You will see the message in Chrome. You will not see it if you use Firefox because Firefox does not give service workers access to the JavaScript console.</p><p data-type="footnote" id="idm46634375467048" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634375467048-marker" class="calibre35">9</a></sup> Admittedly, more and more subways now have mobile repeater stations.</p><p data-type="footnote" id="idm46634375015192" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634375015192-marker" class="calibre35">10</a></sup> In a RESTful API, you would probably perform updates with a PUT or PATCH request.</p><p data-type="footnote" id="idm46634374902744" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634374902744-marker" class="calibre35">11</a></sup> At the time of writing, Chrome, Edge, and Samsung Internet support this event.</p><p data-type="footnote" id="idm46634374900808" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634374900808-marker" class="calibre35">12</a></sup> You can check if your application meets the requirements of a PWA by running the Lighthouse tool in Chrome Developer Tools. Not only will it tell you if your application qualifies, it will also give you reasons why, if it doesn’t.</p><p data-type="footnote" id="idm46634374590808" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634374590808-marker" class="calibre35">13</a></sup> While it will create a separate application window, it will disappear if you close the web browser. If you launch the application directly, it will also launch the web browser if it’s not already running.</p><p data-type="footnote" id="idm46634374444984" class="calibre50"><sup class="calibre51"><a href="ch11.xhtml#idm46634374444984-marker" class="calibre35">14</a></sup> For more details about the Workbox library, see the other recipes in this chapter.</p></div></div></section></div></body></html>