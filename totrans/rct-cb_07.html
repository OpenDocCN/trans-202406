<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Security" class="calibre4"><div class="preface" id="chapter07">
<h1 class="calibre9"><span class="label">Chapter 7. </span>Security</h1>


<p class="author1">In this chapter, we look at various ways of securing your application.<a data-type="indexterm" data-primary="security" id="ix_secure" class="calibre6"/> We’ll look at common patterns for integrating your
application with standard security systems. We’ll look at how you can audit your code for several common security flaws.<a data-type="indexterm" data-primary="WebAuthn" id="idm46634404203960" class="calibre6"/> In several
recipes in this chapter, we will use the WebAuthn API to integrate an application with security devices, such as fingerprint sensors
and physical tokens. WebAuthn is an exciting and underused technology that can increase your application’s security and enhance the
user’s experience.</p>






<section data-type="sect1" data-pdf-bookmark="Secure Requests, Not Routes" class="calibre4"><div class="preface" id="ch07-01">
<h1 class="calibre17">Secure Requests, Not Routes</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634404201288">
<h2 class="calibre27">Problem</h2>

<p class="author1"><a data-type="xref" href="ch02.xhtml#ch02-06" class="calibre6">“Create Secured Routes”</a> showed how you could use React Router to create secured routes. That means if the user tries to get to
specific paths within your application, you can force them to submit a login form before seeing the contents of that page.<a data-type="indexterm" data-primary="security" data-secondary="secured routes and" id="idm46634404199016" class="calibre6"/><a data-type="indexterm" data-primary="routing" data-secondary="secured routes" id="idm46634404198072" class="calibre6"/></p>

<p class="author1">The secured routes approach is a good, reasonably general approach when you are first building an application. However, some
applications don’t fall so easily into this static model of security. Some pages will be secure, and some will be insecure.<a data-type="indexterm" data-primary="APIs" data-secondary="secured" id="ix_APIssec" class="calibre6"/><a data-type="indexterm" data-primary="security" data-secondary="secured API approach" id="ix_secureAPI" class="calibre6"/> But in
many applications, it’s easier to secure data services rather than pages. What matters is not which page you are on but the data you
are viewing.</p>

<p class="author1">All of these complexities are usually straightforward to define at the API level. But it’s the kind of complexity that you don’t
want to reproduce in the logic of your frontend client. For these reasons, the simple approach of marking some routes secure and
others as insecure is not good enough.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634404192744">
<h2 class="calibre27">Solution</h2>

<p class="author1">If defining routes as secure or insecure is not sufficient for your client’s security, you might want to consider controlling access
to your application by using the security responses you receive from the backend server.</p>

<p class="author1">With this approach, you begin by assuming the user can go anywhere in your app. <a data-type="indexterm" data-primary="errors" data-secondary="unauthorized access" id="idm46634404190168" class="calibre6"/>You don’t worry about secure routes and insecure
routes. You just have routes. If a user visits a path that contains private data, the API server will return an error, typically an
HTTP status 401 (Unauthorized). When the error occurs, the security redirects the user to a login form.<a data-type="indexterm" data-primary="HTTP status 401 (Unauthorized)" id="idm46634404188760" class="calibre6"/><a data-type="indexterm" data-primary="Unauthorized (HTTP status)" id="idm46634404188120" class="calibre6"/></p>

<p class="author1">With this approach, the API server drives the policy of what is private and what is public. If the security policies change, you
only need to modify the code on the API server without changing the client code.</p>

<p class="author1">Let’s take a look at the code for the original secured-routes recipe again.<a data-type="indexterm" data-primary="SecurityProvider components" id="idm46634404186408" class="calibre6"/> In our application, we inject a <code class="calibre21">SecurityProvider</code>,
which controls the security of all of its child components. In the example application, we do this in the <em class="calibre7">App.js</em> file:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="s">'./App.css'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">BrowserRouter</code><code class="go">,</code> <code class="nx">Route</code><code class="go">,</code> <code class="nx">Switch</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-router-dom'</code>
<code class="kr">import</code> <code class="nx">Public</code> <code class="nx">from</code> <code class="s">'./Public'</code>
<code class="kr">import</code> <code class="nx">Private1</code> <code class="nx">from</code> <code class="s">'./Private1'</code>
<code class="kr">import</code> <code class="nx">Private2</code> <code class="nx">from</code> <code class="s">'./Private2'</code>
<code class="kr">import</code> <code class="nx">Home</code> <code class="nx">from</code> <code class="s">'./Home'</code>
<code class="kr">import</code> <code class="nx">SecurityProvider</code> <code class="nx">from</code> <code class="s">'./SecurityProvider'</code>
<code class="kr">import</code> <code class="nx">SecureRoute</code> <code class="nx">from</code> <code class="s">'./SecureRoute'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">BrowserRouter</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">SecurityProvider</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">Switch</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">Route</code> <code class="na">exact</code> <code class="na">path</code><code class="o">=</code><code class="s">"/"</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">Home</code> <code class="go">/&gt;</code>
            <code class="go">&lt;/</code><code class="nt">Route</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">SecureRoute</code> <code class="na">path</code><code class="o">=</code><code class="s">"/private1"</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">Private1</code> <code class="go">/&gt;</code>
            <code class="go">&lt;/</code><code class="nt">SecureRoute</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">SecureRoute</code> <code class="na">path</code><code class="o">=</code><code class="s">"/private2"</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">Private2</code> <code class="go">/&gt;</code>
            <code class="go">&lt;/</code><code class="nt">SecureRoute</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">Route</code> <code class="na">exact</code> <code class="na">path</code><code class="o">=</code><code class="s">"/public"</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">Public</code> <code class="go">/&gt;</code>
            <code class="go">&lt;/</code><code class="nt">Route</code><code class="go">&gt;</code>
          <code class="go">&lt;/</code><code class="nt">Switch</code><code class="go">&gt;</code>
        <code class="go">&lt;/</code><code class="nt">SecurityProvider</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">BrowserRouter</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">You can see that the application has simple <code class="calibre21">Routes</code> and <code class="calibre21">SecuredRoutes</code>. <a data-type="indexterm" data-primary="authentication" data-secondary="for secured routes" data-secondary-sortas="secured" id="idm46634404180600" class="calibre6"/>If an unauthenticated user tries to access a secured
route, they are redirected to the login form, as you can see in <a data-type="xref" href="#ch07_image_1" class="calibre6">Figure 7-1</a>.</p>

<figure class="calibre29"><div id="ch07_image_1" class="figure">
<img src="Images/recb_0214.png" alt="" class="calibre63"/>
<h6 class="calibre30"><span class="firstname">Figure 7-1. </span>When you first access a secured route, you see a login form</h6>
</div></figure>

<p class="author1">Once they are logged in (see <a data-type="xref" href="#ch07_image_2" class="calibre6">Figure 7-2</a>), they can access the secured content.</p>

<figure class="calibre29"><div id="ch07_image_2" class="figure">
<img src="Images/recb_0215.png" alt="" class="calibre64"/>
<h6 class="calibre30"><span class="firstname">Figure 7-2. </span>Once you are logged in, secured routes are visible</h6>
</div></figure>

<p class="author1">If we want to base our security upon the security of the backend API, we’ll begin by replacing all of the <code class="calibre21">SecuredRoutes</code> with
simple <code class="calibre21">Routes</code>. The application simply doesn’t know, until the API server tells it, which data is private and public. For the
example app in this recipe, we’ll have two pages on the application that contain a mix of public and private data. The Transactions
page will read secure data from the server. The Offers page will read insecure data from the server. Here is the new version of our
<em class="calibre7">App.js</em> file:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="s">'./App.css'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">BrowserRouter</code><code class="go">,</code> <code class="nx">Route</code><code class="go">,</code> <code class="nx">Switch</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-router-dom'</code>
<code class="kr">import</code> <code class="nx">Transactions</code> <code class="nx">from</code> <code class="s">'./Transactions'</code>
<code class="kr">import</code> <code class="nx">Offers</code> <code class="nx">from</code> <code class="s">'./Offers'</code>
<code class="kr">import</code> <code class="nx">Home</code> <code class="nx">from</code> <code class="s">'./Home'</code>
<code class="kr">import</code> <code class="nx">SecurityProvider</code> <code class="nx">from</code> <code class="s">'./SecurityProvider'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">BrowserRouter</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">SecurityProvider</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">Switch</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">Route</code> <code class="na">exact</code> <code class="na">path</code><code class="o">=</code><code class="s">"/"</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">Home</code> <code class="go">/&gt;</code>
            <code class="go">&lt;/</code><code class="nt">Route</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">Route</code> <code class="na">exact</code> <code class="na">path</code><code class="o">=</code><code class="s">"/transactions"</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">Transactions</code> <code class="go">/&gt;</code>
            <code class="go">&lt;/</code><code class="nt">Route</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">Route</code> <code class="na">exact</code> <code class="na">path</code><code class="o">=</code><code class="s">"/offers"</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">Offers</code> <code class="go">/&gt;</code>
            <code class="go">&lt;/</code><code class="nt">Route</code><code class="go">&gt;</code>
          <code class="go">&lt;/</code><code class="nt">Switch</code><code class="go">&gt;</code>
        <code class="go">&lt;/</code><code class="nt">SecurityProvider</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">BrowserRouter</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">We’ll also need to make a change to our <code class="calibre21">SecurityProvider</code>.<a data-type="indexterm" data-primary="SecurityProvider components" data-secondary="changing for API security model" id="idm46634403783224" class="calibre6"/> In an API security model, the client begins by assuming that all data is
public, which is the opposite of the secured-routes approach, which assumes you don’t have access until you prove that you do by
logging in.<a data-type="indexterm" data-primary="login/logout" data-secondary="placing in SecurityProvider" id="idm46634403878632" class="calibre6"/></p>

<p class="author1">This means our new <code class="calibre21">SecurityProvider</code> has to default its initial logged-in state to <code class="calibre21">true</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">SecurityContext</code> <code class="nx">from</code> <code class="s">'./SecurityContext'</code>
<code class="kr">import</code> <code class="nx">Login</code> <code class="nx">from</code> <code class="s">'./Login'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>

<code class="kr">const</code> <code class="nx">SecurityProvider</code> <code class="o">=</code> <code class="go">(</code><code class="nx">props</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loggedIn</code><code class="go">,</code> <code class="nx">setLoggedIn</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">SecurityContext</code><code class="go">.</code><code class="na">Provider</code>
      <code class="na">value</code><code class="o">=</code><code class="go">{{</code>
        <code class="nx">login</code><code class="o">:</code> <code class="nx">async</code> <code class="go">(</code><code class="nx">username</code><code class="go">,</code> <code class="nx">password</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/api/login'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">username</code><code class="go">,</code> <code class="nx">password</code> <code class="go">})</code>
          <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
        <code class="go">},</code>
        <code class="nx">logout</code><code class="o">:</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/api/logout'</code><code class="go">)</code>
          <code class="kr">return</code> <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
        <code class="go">},</code>
        <code class="nx">onFailure</code><code class="go">()</code> <code class="go">{</code>
          <code class="kr">return</code> <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
        <code class="go">},</code>
        <code class="nx">loggedIn</code><code class="go">,</code>
      <code class="go">}}</code>
    <code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">loggedIn</code> <code class="o">?</code> <code class="nx">props</code><code class="go">.</code><code class="nx">children</code> <code class="o">:</code> <code class="go">&lt;</code><code class="nt">Login</code> <code class="go">/&gt;}</code>
    <code class="go">&lt;/</code><code class="nt">SecurityContext</code><code class="go">.</code><code class="na">Provider</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">SecurityProvider</code></pre>

<p class="author1">We’ve also made several other changes:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">The code that decides whether the user should see the <code class="calibre21">Login</code> form is now in the <code class="calibre21">SecurityProvider</code>. This code used to live
inside the <code class="calibre21">SecuredRoute</code> component, but now we display it centrally.</p>
</li>
<li class="calibre8">
<p class="author1">We’ve replaced the dummy username/password checks with calls to the backend services called <em class="calibre7">/api/login</em> and
<em class="calibre7">/api/logout</em>. It would be best if you replaced these with whatever security code applies to your system.</p>
</li>
<li class="calibre8">
<p class="author1">The <code class="calibre21">SecurityProvider</code> now provides a new function called <code class="calibre21">onFailure</code>, which simply marks the person as logged out.</p>
</li>
</ul>

<p class="author1">When you call this function, it forces the user to log in. If we no longer have secured routes, at what point do we perform the
security checks? We do them in the API calls themselves.</p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">In a real application, you would want to add code that deals with an invalid login attempt.<a data-type="indexterm" data-primary="login/logout" data-secondary="invalid login attempts" id="idm46634403581624" class="calibre6"/> To keep the code short, we’ve
omitted any special handling here. A failed login will simply leave you in the login form without any error messages.</p>
</div>

<p class="author1">Let’s look at our new Transactions page, as defined in <em class="calibre7">src/Transactions.js</em>. This component reads the transactions data and
displays it on the screen:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">useTransactions</code> <code class="nx">from</code> <code class="s">'./useTransactions'</code>

<code class="kr">const</code> <code class="nx">Transactions</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">{</code> <code class="nx">data</code><code class="o">:</code> <code class="nx">transactions</code> <code class="go">}</code> <code class="o">=</code> <code class="nx">useTransactions</code><code class="go">()</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Transactions</code><code class="go">&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">main</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">table</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">thead</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">tr</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">th</code><code class="go">&gt;</code><code class="nb">Date</code><code class="go">&lt;/</code><code class="nt">th</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">th</code><code class="go">&gt;</code><code class="nx">Amount</code><code class="go">&lt;/</code><code class="nt">th</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">th</code><code class="go">&gt;</code><code class="nx">Description</code><code class="go">&lt;/</code><code class="nt">th</code><code class="go">&gt;</code>
            <code class="go">&lt;/</code><code class="nt">tr</code><code class="go">&gt;</code>
          <code class="go">&lt;/</code><code class="nt">thead</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">tbody</code><code class="go">&gt;</code>
            <code class="go">{</code><code class="nx">transactions</code> <code class="o">&amp;&amp;</code>
              <code class="nx">transactions</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">trx</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code>
                <code class="go">&lt;</code><code class="nt">tr</code><code class="go">&gt;</code>
                  <code class="go">&lt;</code><code class="nt">td</code><code class="go">&gt;{</code><code class="nx">trx</code><code class="go">.</code><code class="nx">date</code><code class="go">}&lt;/</code><code class="nt">td</code><code class="go">&gt;</code>
                  <code class="go">&lt;</code><code class="nt">td</code><code class="go">&gt;{</code><code class="nx">trx</code><code class="go">.</code><code class="nx">amount</code><code class="go">}&lt;/</code><code class="nt">td</code><code class="go">&gt;</code>
                  <code class="go">&lt;</code><code class="nt">td</code><code class="go">&gt;{</code><code class="nx">trx</code><code class="go">.</code><code class="nx">description</code><code class="go">}&lt;/</code><code class="nt">td</code><code class="go">&gt;</code>
                <code class="go">&lt;/</code><code class="nt">tr</code><code class="go">&gt;</code>
              <code class="go">))}</code>
          <code class="go">&lt;/</code><code class="nt">tbody</code><code class="go">&gt;</code>
        <code class="go">&lt;/</code><code class="nt">table</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">main</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Transactions</code></pre>

<p class="author1">The <code class="calibre21">useTransactions</code> hook contains the network code to read data from the server. It’s inside this hook that we need to add our
check for a <a data-type="indexterm" data-primary="HTTP status 401 (Unauthorized)" id="idm46634403575832" class="calibre6"/><a data-type="indexterm" data-primary="Unauthorized (HTTP status)" id="idm46634403575224" class="calibre6"/>401 (Unauthorized) response from the server:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>
<code class="kr">import</code> <code class="nx">useSecurity</code> <code class="nx">from</code> <code class="s">'./useSecurity'</code>

<code class="kr">const</code> <code class="nx">useTransactions</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">security</code> <code class="o">=</code> <code class="nx">useSecurity</code><code class="go">()</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">transactions</code><code class="go">,</code> <code class="nx">setTransactions</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">([])</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">try</code> <code class="go">{</code>
        <code class="kr">const</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'/api/transactions'</code><code class="go">)</code>
        <code class="nx">setTransactions</code><code class="go">(</code><code class="nx">result</code><code class="go">.</code><code class="nx">data</code><code class="go">)</code>
      <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
        <code class="kr">const</code> <code class="nx">status</code> <code class="o">=</code> <code class="nx">err</code><code class="go">.</code><code class="nx">response</code> <code class="o">&amp;&amp;</code> <code class="nx">err</code><code class="go">.</code><code class="nx">response</code><code class="go">.</code><code class="nx">status</code>
        <code class="kr">if</code> <code class="go">(</code><code class="nx">status</code> <code class="o">===</code> <code class="mi">401</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">security</code><code class="go">.</code><code class="nx">onFailure</code><code class="go">()</code>
        <code class="go">}</code>
        <code class="c">// Handle other exceptions here (consider a shared</code>
        <code class="c">// error handler -- see elsewhere in the book)</code>
      <code class="go">}</code>
    <code class="go">})()</code>
  <code class="go">},</code> <code class="go">[])</code>

  <code class="kr">return</code> <code class="go">{</code> <code class="nx">data</code><code class="o">:</code> <code class="nx">transactions</code> <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">useTransactions</code></pre>

<p class="author1">In the example application, we’re using the <code class="calibre21">axios</code> library to contact the server. <code class="calibre21">axios</code> handles HTTP errors such as <code class="calibre21">401</code> (the
HTTP status for Unauthorized) as exceptions. That makes it a little clearer which code is dealing with an unexpected response. If
you were using a different API standard, like GraphQL, you would be able to deal with security errors in an analogous way by
examining the contents of the error object that GraphQL returns.</p>

<p class="author1">In the event<a data-type="indexterm" data-primary="SecurityProvider components" data-secondary="onFailure function" id="idm46634403321928" class="calibre6"/> that there’s an unauthorized response from the server, the <code class="calibre21">useTransac⁠tions</code> hook makes a call to the <code class="calibre21">onFailure</code>
function in the <code class="calibre21">SecurityPro⁠vider</code>.</p>

<p class="author1">We’ll build the Offers page in the same way. The <em class="calibre7">src/Offers.js</em> component will format the <code class="calibre21">offers</code> data from the server:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">useOffers</code> <code class="nx">from</code> <code class="s">'./useOffers'</code>

<code class="kr">const</code> <code class="nx">Offers</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">{</code> <code class="nx">data</code><code class="o">:</code> <code class="nx">offers</code> <code class="go">}</code> <code class="o">=</code> <code class="nx">useOffers</code><code class="go">()</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Offers</code><code class="go">&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">main</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">ul</code><code class="go">&gt;</code>
          <code class="go">{</code><code class="nx">offers</code> <code class="o">&amp;&amp;</code>
            <code class="nx">offers</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">offer</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">&lt;</code><code class="nt">li</code> <code class="na">className</code><code class="o">=</code><code class="s">"offer"</code><code class="go">&gt;{</code><code class="nx">offer</code><code class="go">}&lt;/</code><code class="nt">li</code><code class="go">&gt;)}</code>
        <code class="go">&lt;/</code><code class="nt">ul</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">main</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Offers</code></pre>

<p class="author1">And the code that reads the data is inside the <em class="calibre7">src/useOffers.js</em> hook:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>
<code class="kr">import</code> <code class="nx">useSecurity</code> <code class="nx">from</code> <code class="s">'./useSecurity'</code>

<code class="kr">const</code> <code class="nx">useOffers</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">security</code> <code class="o">=</code> <code class="nx">useSecurity</code><code class="go">()</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">offers</code><code class="go">,</code> <code class="nx">setOffers</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">([])</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">try</code> <code class="go">{</code>
        <code class="kr">const</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'/api/offers'</code><code class="go">)</code>
        <code class="nx">setOffers</code><code class="go">(</code><code class="nx">result</code><code class="go">.</code><code class="nx">data</code><code class="go">)</code>
      <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
        <code class="kr">const</code> <code class="nx">status</code> <code class="o">=</code> <code class="nx">err</code><code class="go">.</code><code class="nx">response</code> <code class="o">&amp;&amp;</code> <code class="nx">err</code><code class="go">.</code><code class="nx">response</code><code class="go">.</code><code class="nx">status</code>
        <code class="kr">if</code> <code class="go">(</code><code class="nx">status</code> <code class="o">===</code> <code class="mi">401</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">security</code><code class="go">.</code><code class="nx">onFailure</code><code class="go">()</code>
        <code class="go">}</code>
        <code class="c">// Handle other exceptions here (consider a shared</code>
        <code class="c">// error handler -- see elsewhere in the book)</code>
      <code class="go">}</code>
    <code class="go">})()</code>
  <code class="go">},</code> <code class="go">[])</code>

  <code class="kr">return</code> <code class="go">{</code> <code class="nx">data</code><code class="o">:</code> <code class="nx">offers</code> <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">useOffers</code></pre>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">Even though the <em class="calibre7">/api/offers</em> endpoint is not secured, we still have code that checks for security errors.<a data-type="indexterm" data-primary="APIs" data-secondary="secured" data-tertiary="treating all endpoints as secured" id="idm46634403012328" class="calibre6"/> One consequence
of the API security approach is that you have to treat all endpoints as secure, just in case they become secure in the future.</p>
</div>

<p class="author1">Let’s try our example application. We’ll begin by opening the front page (see <a data-type="xref" href="#ch07_image_3" class="calibre6">Figure 7-3</a>).</p>

<figure class="calibre29"><div id="ch07_image_3" class="figure">
<img src="Images/recb_0703.png" alt="" class="calibre113"/>
<h6 class="calibre30"><span class="firstname">Figure 7-3. </span>The front page of the application</h6>
</div></figure>

<p class="author1">If we click the Offers link, we see the offers read from the server (see <a data-type="xref" href="#ch07_image_4" class="calibre6">Figure 7-4</a>). This data is unsecured, and the application
doesn’t ask us to log in.</p>

<figure class="calibre29"><div id="ch07_image_4" class="figure">
<img src="Images/recb_0704.png" alt="" class="calibre114"/>
<h6 class="calibre30"><span class="firstname">Figure 7-4. </span>If we click the Offers link, we can see the contents</h6>
</div></figure>

<p class="author1">If we now go back to the home page and click the Transactions link, the application asks us to log in (see <a data-type="xref" href="#ch07_image_5" class="calibre6">Figure 7-5</a>). The
transactions page has attempted to download transaction data from the server, which resulted in a 401 (Unauthorized) response. The
code catches this as an exception and calls the <code class="calibre21">onFailure</code> function in the 
<span class="firstname">SecurityProvider</span>, which then displays the login form
(see <a data-type="xref" href="#ch07_image_5" class="calibre6">Figure 7-5</a>).</p>

<figure class="calibre29"><div id="ch07_image_5" class="figure">
<img src="Images/recb_0705.png" alt="" class="calibre63"/>
<h6 class="calibre30"><span class="firstname">Figure 7-5. </span>If we try to access the Transactions page, we are asked to log in</h6>
</div></figure>

<p class="author1">If we log in, the application sends our username and password to the server. Assuming that doesn’t result in an error, the
<code class="calibre21">SecurityProvider</code> hides the login form, the Transactions page is re-rendered, and the data is now able to be read as we’ve
logged in (see <a data-type="xref" href="#ch07_image_6" class="calibre6">Figure 7-6</a>).</p>

<figure class="calibre29"><div id="ch07_image_6" class="figure">
<img src="Images/recb_0706.png" alt="" class="calibre115"/>
<h6 class="calibre30"><span class="firstname">Figure 7-6. </span>Once we log in, we can see the Transactions page</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634404191800">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Our example app now contains nothing to indicate which APIs are secured and which are unsecured. The server now handles all of that
work. The API endpoints are entirely in charge of the security of the application.</p>

<p class="author1">Using this approach, you should apply the same security handling to all API calls.<a data-type="indexterm" data-primary="hooks" data-secondary="extracting API calls into custom hooks" id="idm46634402878888" class="calibre6"/> One of the benefits of extracting API calls into
custom hooks is that the hooks can share the security code. Hooks can call other hooks, and a common approach is to create hooks
that act as general-purpose <code class="calibre21">GET</code> and <code class="calibre21">POST</code> calls.<sup class="calibre34"><a data-type="noteref" id="idm46634402876760-marker" href="ch07.xhtml#idm46634402876760" class="calibre35">1</a></sup> A general-purpose
<code class="calibre21">GET</code> hook could not only handle access failures but also include request cancellations, debouncing (Recipes <a href="ch05.xhtml#ch05-03" class="calibre6">5.3</a> and <a href="ch05.xhtml#ch05-06" class="calibre6">5.6</a>), and shared error handling (<a data-type="xref" href="ch04.xhtml#ch04-01" class="calibre6">“Build a Centralized Error Handler”</a>).</p>

<p class="author1">Another advantage to the secured API approach is that it’s possible to disable security in some circumstances entirely. For example,
during development, you can do away with the need for developers to have an identity provider configured. You can also choose to
have different security configurations in different deployments.</p>

<p class="author1">Finally, for automated testing systems, like Cypress, which can simulate network responses, you can split the testing of application
functionality from nonfunctional security testing. It’s a good idea to have additional server-only security tests that are separate
from the UI tests to ensure that the server is secure in its own right.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/ByWVZ" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="APIs" data-secondary="secured" data-startref="ix_APIssec" id="idm46634402870680" class="calibre6"/><a data-type="indexterm" data-primary="security" data-secondary="secured API approach" data-startref="ix_secureAPI" id="idm46634402869400" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Authenticate with Physical Tokens" class="calibre4"><div class="preface" id="ch07-02">
<h1 class="calibre17">Authenticate with Physical Tokens</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634402866632">
<h2 class="calibre27">Problem</h2>

<p class="author1">Usernames and passwords are not always enough; they might be stolen or guessed.<a data-type="indexterm" data-primary="security" data-secondary="authenticating with physical tokens" id="ix_secureauthphys" class="calibre6"/><a data-type="indexterm" data-primary="tokens" data-secondary="physical, authenticating with" id="ix_tokphy" class="calibre6"/><a data-type="indexterm" data-primary="authentication" data-secondary="using physical tokens" id="ix_authphytk" class="calibre6"/> So some users might only use applications that
provide additional security.</p>

<p class="author1">An increasing number of systems now provide <em class="calibre7">two-factor authentication</em>. A two-factor system requires the user to log in with a form
and then provide some additional information.<a data-type="indexterm" data-primary="two-factor authentication" id="ix_twoauth" class="calibre6"/> The additional information might be a code sent to them by an SMS text message. Or it might be an application on their phone that generates a one-time password. Or, perhaps most securely, it might involve the use of a physical
hardware device, like a <a href="https://www.yubico.com" class="calibre6">YubiKey</a>, which is attached to the computer when required and pressed.<a data-type="indexterm" data-primary="YubiKeys" id="idm46634402857992" class="calibre6"/></p>

<p class="author1">These physical tokens work using public-key cryptography, which generates a public key for use with a given application and encrypts
strings using a private key.<a data-type="indexterm" data-primary="public-key cryptography" id="idm46634402856728" class="calibre6"/> An application can send a random “challenge” string to the device, generating a signature using the
private key. The application can then use the public key to check that the string was signed correctly.</p>

<p class="author1">But how do you integrate them with your React application?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634402855160">
<h2 class="calibre27">Solution</h2>

<p class="author1"><em class="calibre7">Web Authentication</em> (also known as <em class="calibre7">WebAuthn</em>) is a widely supported<sup class="calibre34"><a data-type="noteref" id="idm46634402851832-marker" href="ch07.xhtml#idm46634402851832" class="calibre35">2</a></sup> W3C standard that allows a browser to communicate with a physical device, like a YubiKey.<a data-type="indexterm" data-primary="WebAuthn" id="ix_WebAuth" class="calibre6"/></p>

<p class="author1">There are two <em class="calibre7">flows</em> in web authentication.<a data-type="indexterm" data-primary="flows in web authentication" id="idm46634402848936" class="calibre6"/> The first is called <em class="calibre7">attestation</em>.<a data-type="indexterm" data-primary="attestation (WebAuthn)" id="idm46634402847688" class="calibre6"/> During attestation, a user registers a security
device with an application. <a data-type="indexterm" data-primary="assertion (WebAuthn)" id="idm46634402846824" class="calibre6"/>During <em class="calibre7">assertion</em>, the user can verify their identity to log in to a system.</p>

<p class="author1">First, let’s look at attestation. During this flow, the user registers a physical device against their account.<a data-type="indexterm" data-primary="WebAuthn" data-secondary="attestation" id="idm46634402845192" class="calibre6"/> That means that
the user should always be logged in during attestation.</p>

<p class="author1">The code for this recipe includes a dummy Node server, which you can run from the <em class="calibre7">server</em> directory within the application:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ cd server</code>
<code class="go">$ npm install</code>
<code class="go">$ npm run start</code></pre>

<p class="author1">There are three steps to attestation:</p>
<ol class="calibre116">
<li class="calibre8">
<p class="author1">The server generates an attestation request, saying what kind of device is 
<span class="firstname">acceptable</span>.</p>
</li>
<li class="calibre8">
<p class="author1">The user connects the device and activates it, probably by pressing a button on it.</p>
</li>
<li class="calibre8">
<p class="author1">A response is generated from the device, which includes the public key, and is then returned to the server, where it can be stored against the user’s account.</p>
</li>

</ol>

<p class="author1">We can tell if the browser supports WebAuthn by checking for the existence of 
<span class="firstname"><code class="calibre21">window.PublicKeyCredential</code></span>. If it exists, you’re
good to go.</p>

<p class="author1">There is an endpoint at <em class="calibre7">/startRegister</em>, which will create the attestation request on the server. So we’ll begin by calling
that:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>
<code class="go">...</code>
<code class="c">// Ask to start registering a physical token for the current user</code>
<code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/startRegister'</code><code class="go">)</code></pre>

<p class="author1">This is what an attestation request looks like:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">{</code>
    <code class="s">"rpName"</code><code class="o">:</code> <code class="s">"Physical Token Server"</code><code class="go">,</code>
    <code class="s">"rpID"</code><code class="o">:</code> <code class="s">"localhost"</code><code class="go">,</code>
    <code class="s">"userID"</code><code class="o">:</code> <code class="s">"1234"</code><code class="go">,</code>
    <code class="s">"userName"</code><code class="o">:</code> <code class="s">"freda"</code><code class="go">,</code>
    <code class="s">"excludeCredentials"</code><code class="o">:</code> <code class="go">[</code>
        <code class="go">{</code><code class="s">"id"</code><code class="o">:</code> <code class="s">"existingKey1"</code><code class="go">,</code> <code class="s">"type"</code><code class="o">:</code> <code class="s">"public-key"</code><code class="go">}</code>
    <code class="go">],</code>
    <code class="s">"authenticatorSelection"</code><code class="o">:</code> <code class="go">{</code>
        <code class="s">"userVerification"</code><code class="o">:</code> <code class="s">"discouraged"</code>
    <code class="go">},</code>
    <code class="s">"extensions"</code><code class="o">:</code> <code class="go">{</code>
        <code class="s">"credProps"</code><code class="o">:</code> <code class="kr">true</code>
    <code class="go">}</code>
<code class="go">}</code></pre>

<p class="author1">Some of the attributes begin with the letters <code class="calibre21">rp...</code>, which stands for <em class="calibre7">relying party</em>. The relying party is the application that
generated the request.<a data-type="indexterm" data-primary="relying party (rp)" id="idm46634402644408" class="calibre6"/><a data-type="indexterm" data-primary="rp (relying party)" id="idm46634402643880" class="calibre6"/></p>

<p class="author1">The <code class="calibre21">rpName</code> is a free-form text string that describes the application. You should set the <code class="calibre21">rpId</code> to the current domain name. Here
it’s <code class="calibre21">localhost</code> because we’re running on a development server. The <code class="calibre21">userID</code> is a string that uniquely identifies the user. The
<code class="calibre21">userName</code> is the name of the user.</p>

<p class="author1"><code class="calibre21">excludeCredentials</code> is an interesting attribute. Users might record multiple devices against their accounts. This value lists the
devices that are already recorded to avoid the user registering the same device twice. If you attempt to register the same device
more than once, the browser will immediately throw an exception saying that the device has been registered elsewhere.</p>

<p class="author1">The <code class="calibre21">authenticatorSelection</code> allows you to set various options about what the user needs to do when they activate their device. Here
we’re setting <code class="calibre21">userVerification</code> to <code class="calibre21">false</code> to prevent the user from performing any additional steps (such as entering a PIN) when
activating their device. Consequently, when asked to plug in their device, the user will insert it into the USB socket and press the
button, with nothing else needed.</p>

<p class="author1">The <code class="calibre21">credProps</code> extension asks the device to return additional credential properties, which might be helpful to the server.</p>

<p class="author1">Once the server has generated the attestation request, we need to ask the user to connect their security device. We do this with a
browser function called:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">navigator</code><code class="go">.</code><code class="nx">credentials</code><code class="go">.</code><code class="nx">create</code><code class="go">()</code></pre>

<p class="author1">The <code class="calibre21">create</code> function accepts an attestation request object. Unfortunately, the data within the object needs to be in a variety of
low-level binary forms, such as byte arrays. We can make our life significantly easier by installing a library from GitHub called
<code class="calibre21">webauthn-json</code>, which lets you use<a data-type="indexterm" data-primary="webauthn-json" data-secondary="installing from GitHub" id="idm46634402631624" class="calibre6"/><a data-type="indexterm" data-primary="JSON" data-secondary="webauth-json library" id="idm46634402602008" class="calibre6"/> JSON to specify the request:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install "@github/webauthn-json"</code></pre>

<p class="author1">We can then pass the contents of the WebAuthn request to the GitHub version of the <code class="calibre21">create</code> function:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">create</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@github/webauthn-json'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>
<code class="go">...</code>
<code class="c">// Ask to start registering a physical token for the current user</code>
<code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/startRegister'</code><code class="go">)</code>
<code class="c">// Pass the WebAuthn config to webauthn-json 'create' function</code>
<code class="kr">const</code> <code class="nx">attestation</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">create</code><code class="go">({</code> <code class="nx">publicKey</code><code class="o">:</code> <code class="nx">response</code><code class="go">.</code><code class="nx">data</code> <code class="go">})</code></pre>

<p class="author1">This is the point where the browser asks the user to insert and activate their security device (see <a data-type="xref" href="#ch07_image_7" class="calibre6">Figure 7-7</a>).</p>

<figure class="calibre29"><div id="ch07_image_7" class="figure">
<img src="Images/recb_0707.png" alt="" class="calibre117"/>
<h6 class="calibre30"><span class="firstname">Figure 7-7. </span>The browser asks for the token when <code class="calibre21">create</code> is called</h6>
</div></figure>

<p class="author1">The <code class="calibre21">create</code> function resolves to an <em class="calibre7">attestation object</em>, which you can think of as the registration information for the device.<a data-type="indexterm" data-primary="registration" data-secondary="physical token for authentication" id="idm46634402510888" class="calibre6"/>
The server can use the attestation object to verify the user’s identity when they log in. We need to record the attestation object
against the user’s account. We’ll do that by posting it back to an endpoint on the example server at <em class="calibre7">/register</em>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">create</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@github/webauthn-json'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>
<code class="go">...</code>
<code class="c">// Ask to start registering a physical token for the current user</code>
<code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/startRegister'</code><code class="go">)</code>
<code class="c">// Pass the WebAuthn config to webauthn-json 'create' function</code>
<code class="kr">const</code> <code class="nx">attestation</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">create</code><code class="go">({</code> <code class="nx">publicKey</code><code class="o">:</code> <code class="nx">response</code><code class="go">.</code><code class="nx">data</code> <code class="go">})</code>
<code class="c">// Send the details of the physical YubiKey to be stored against the user</code>
<code class="kr">const</code> <code class="nx">attestationResponse</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/register'</code><code class="go">,</code> <code class="go">{</code>
  <code class="nx">attestation</code><code class="go">,</code>
<code class="go">})</code></pre>

<p class="author1">That’s the overview of how we register a new device for a user. But where do we put that in the code?</p>

<p class="author1">The example application has an Account page (see <a data-type="xref" href="#ch07_image_8" class="calibre6">Figure 7-8</a>), and we’ll add a button in there to register a new key.<a data-type="indexterm" data-primary="WebAuthn" data-secondary="registration code for new device" id="idm46634402433016" class="calibre6"/></p>

<figure class="calibre29"><div id="ch07_image_8" class="figure">
<img src="Images/recb_0708.png" alt="" class="calibre118"/>
<h6 class="calibre30"><span class="firstname">Figure 7-8. </span>We’ll add a button to the account page to register a new device</h6>
</div></figure>

<p class="author1">Here is the registration code in place:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">Logout</code> <code class="nx">from</code> <code class="s">'./Logout'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">create</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@github/webauthn-json'</code>

<code class="kr">const</code> <code class="nx">Private2</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">busy</code><code class="go">,</code> <code class="nx">setBusy</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">message</code><code class="go">,</code> <code class="nx">setMessage</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Private2"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Account</code> <code class="nx">page</code><code class="go">&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>

      <code class="go">{</code><code class="nb">window</code><code class="go">.</code><code class="nx">PublicKeyCredential</code> <code class="o">&amp;&amp;</code> <code class="go">(</code>
        <code class="go">&lt;&gt;</code>
          <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code><code class="nx">Register</code> <code class="kr">new</code> <code class="nx">hardware</code> <code class="nx">key</code><code class="go">&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">button</code>
            <code class="na">onClick</code><code class="o">=</code><code class="go">{</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
              <code class="nx">setBusy</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
              <code class="kr">try</code> <code class="go">{</code>
                <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/startRegister'</code><code class="go">)</code>
                <code class="nx">setMessage</code><code class="go">(</code><code class="s">'Send response'</code><code class="go">)</code>
                <code class="kr">const</code> <code class="nx">attestation</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">create</code><code class="go">({</code>
                  <code class="nx">publicKey</code><code class="o">:</code> <code class="nx">response</code><code class="go">.</code><code class="nx">data</code><code class="go">,</code>
                <code class="go">})</code>
                <code class="nx">setMessage</code><code class="go">(</code><code class="s">'Create attestation'</code><code class="go">)</code>
                <code class="kr">const</code> <code class="nx">attestationResponse</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code>
                  <code class="s">'/register'</code><code class="go">,</code>
                  <code class="go">{</code>
                    <code class="nx">attestation</code><code class="go">,</code>
                  <code class="go">}</code>
                <code class="go">)</code>
                <code class="nx">setMessage</code><code class="go">(</code><code class="s">'registered!'</code><code class="go">)</code>
                <code class="kr">if</code> <code class="go">(</code>
                  <code class="nx">attestationResponse</code><code class="go">.</code><code class="nx">data</code> <code class="o">&amp;&amp;</code>
                  <code class="nx">attestationResponse</code><code class="go">.</code><code class="nx">data</code><code class="go">.</code><code class="nx">verified</code>
                <code class="go">)</code> <code class="go">{</code>
                  <code class="nx">alert</code><code class="go">(</code><code class="s">'New key registered'</code><code class="go">)</code>
                <code class="go">}</code>
              <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
                <code class="nx">setMessage</code><code class="go">(</code><code class="s">''</code> <code class="o">+</code> <code class="nx">err</code><code class="go">)</code>
              <code class="go">}</code> <code class="kr">finally</code> <code class="go">{</code>
                <code class="nx">setBusy</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
              <code class="go">}</code>
            <code class="go">}}</code>
            <code class="na">disabled</code><code class="o">=</code><code class="go">{</code><code class="nx">busy</code><code class="go">}</code>
          <code class="go">&gt;</code>
            <code class="nx">Register</code>
          <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">&lt;/&gt;</code>
      <code class="go">)}</code>
      <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Account-message"</code><code class="go">&gt;{</code><code class="nx">message</code><code class="go">}&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">Logout</code> <code class="go">/&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Private2</code></pre>

<p class="author1">If we click the registration button on the account page, the browser asks us to connect the security device (see <a data-type="xref" href="#ch07_image_9" class="calibre6">Figure 7-9</a>). Once
we do that, the application sends the device’s credentials to the server and then tells us it has recorded a new device against our
account (see <a data-type="xref" href="#ch07_image_10" class="calibre6">Figure 7-10</a>).</p>

<figure class="calibre29"><div id="ch07_image_9" class="figure">
<img src="Images/recb_0707.png" alt="" class="calibre117"/>
<h6 class="calibre30"><span class="firstname">Figure 7-9. </span>When you choose to register a new device, you are asked to activate it</h6>
</div></figure>

<figure class="calibre29"><div id="ch07_image_10" class="figure">
<img src="Images/recb_0710.png" alt="" class="calibre119"/>
<h6 class="calibre30"><span class="firstname">Figure 7-10. </span>We are told when a new device is registered</h6>
</div></figure>

<p class="author1">The next flow we need to think about is assertion. Assertion happens when a user verifies their identity when logging in.<a data-type="indexterm" data-primary="WebAuthn" data-secondary="assertion" id="idm46634402120440" class="calibre6"/></p>

<p class="author1">The steps are pretty similar to attestation:</p>
<ol class="calibre116">
<li class="calibre8">
<p class="author1">The application asks the server to create an assertion request.</p>
</li>
<li class="calibre8">
<p class="author1">The user converts that request into an assertion object by activating their security device.</p>
</li>
<li class="calibre8">
<p class="author1">The server checks the assertion against its stored credentials to prove the person is who they say they are.</p>
</li>

</ol>

<p class="author1">Let’s begin with the first stage when we create an assertion request. This is what an assertion request looks like:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">{</code>
    <code class="s">"allowCredentials"</code><code class="o">:</code> <code class="go">[</code>
        <code class="go">{</code><code class="s">"id"</code><code class="o">:</code> <code class="s">"existingTokenID"</code><code class="go">,</code> <code class="s">"type"</code><code class="o">:</code> <code class="s">"public-key"</code><code class="go">}</code>
    <code class="go">],</code>
    <code class="s">"attestation"</code><code class="o">:</code> <code class="s">"direct"</code><code class="go">,</code>
    <code class="s">"extensions"</code><code class="o">:</code> <code class="go">{</code>
        <code class="s">"credProps"</code><code class="o">:</code> <code class="kr">true</code><code class="go">,</code>
    <code class="go">},</code>
    <code class="s">"rpID"</code><code class="o">:</code> <code class="s">"localhost"</code><code class="go">,</code>
    <code class="s">"timeout"</code><code class="o">:</code> <code class="mi">60000</code><code class="go">,</code>
    <code class="s">"challenge"</code><code class="o">:</code> <code class="s">"someRandomString"</code>
<code class="go">}</code></pre>

<p class="author1">The <code class="calibre21">allowCredentials</code> attribute is an array of registered devices that will be acceptable. The browser will use this array to check
that the user has connected the correct device.</p>

<p class="author1">The assertion request also includes a <code class="calibre21">challenge</code> string: a randomly generated string the device will need to create a signature
with its private key. The server will check this signature with the public key to ensure that we used the correct device.</p>

<p class="author1">The <code class="calibre21">timeout</code> specifies how long the user will have to prove their identity.</p>

<p class="author1">The example server generates an assertion request when you call the <em class="calibre7">/startVerify</em> endpoint with a specified user ID:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>
<code class="go">...</code>
<code class="c">// Ask for a challenge to verify user userID</code>
<code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/startVerify'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">userID</code> <code class="go">})</code></pre>

<p class="author1">We can then pass<a data-type="indexterm" data-primary="webauthn-json" data-secondary="get function, assertion request passed to" id="idm46634401968024" class="calibre6"/> the assertion request to the <code class="calibre21">get</code> webauthn-json function, which will ask the user to verify their identity by
connecting an acceptable device (see <a data-type="xref" href="#ch07_image_11" class="calibre6">Figure 7-11</a>):</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">get</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@github/webauthn-json'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>
<code class="go">...</code>
<code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/startVerify'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">userID</code> <code class="go">})</code>
<code class="kr">const</code> <code class="nx">assertion</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">get</code><code class="go">({</code> <code class="nx">publicKey</code><code class="o">:</code> <code class="nx">response</code><code class="go">.</code><code class="nx">data</code> <code class="go">})</code></pre>

<figure class="calibre29"><div id="ch07_image_11" class="figure">
<img src="Images/recb_0711.png" alt="" class="calibre120"/>
<h6 class="calibre30"><span class="firstname">Figure 7-11. </span>The <code class="calibre21">get</code> function asks the user to connect the device</h6>
</div></figure>

<p class="author1">The <code class="calibre21">get</code> function returns an assertion object, which contains a signature for the challenge string sent back to the server’s
<em class="calibre7">/verify</em> endpoint to check the signature. The response to that call will tell us if the user has correctly verified their
identity:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">get</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@github/webauthn-json'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>
<code class="go">...</code>
<code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/startVerify'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">userID</code> <code class="go">})</code>
<code class="kr">const</code> <code class="nx">assertion</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">get</code><code class="go">({</code> <code class="nx">publicKey</code><code class="o">:</code> <code class="nx">response</code><code class="go">.</code><code class="nx">data</code> <code class="go">})</code>
<code class="kr">const</code> <code class="nx">resp2</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/verify'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">userID</code><code class="go">,</code> <code class="nx">assertion</code> <code class="go">})</code>
<code class="kr">if</code> <code class="go">(</code><code class="nx">resp2</code><code class="go">.</code><code class="nx">data</code> <code class="o">&amp;&amp;</code> <code class="nx">resp2</code><code class="go">.</code><code class="nx">data</code><code class="go">.</code><code class="nx">verified</code><code class="go">)</code> <code class="go">{</code>
  <code class="c">// User is verified</code>
<code class="go">}</code></pre>

<p class="author1">Where do we put this code in the application?</p>

<p class="author1">The example application is based on the secured-routes recipe.<sup class="calibre34"><a data-type="noteref" id="idm46634401908472-marker" href="ch07.xhtml#idm46634401908472" class="calibre35">3</a></sup> It contains a 
<span class="firstname"><code class="calibre21">SecurityProvider</code></span>,
which manages the security for all of its child components. The <code class="calibre21">SecurityProvider</code> provides a <code class="calibre21">login</code> function, which is called with
the username and password when the user submits a login form. We’ll put the verification code in here:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">SecurityContext</code> <code class="nx">from</code> <code class="s">'./SecurityContext'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">get</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@github/webauthn-json'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>

<code class="kr">const</code> <code class="nx">SecurityProvider</code> <code class="o">=</code> <code class="go">(</code><code class="nx">props</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loggedIn</code><code class="go">,</code> <code class="nx">setLoggedIn</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">SecurityContext</code><code class="go">.</code><code class="na">Provider</code>
      <code class="na">value</code><code class="o">=</code><code class="go">{{</code>
        <code class="nx">login</code><code class="o">:</code> <code class="nx">async</code> <code class="go">(</code><code class="nx">username</code><code class="go">,</code> <code class="nx">password</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/login'</code><code class="go">,</code> <code class="go">{</code>
            <code class="nx">username</code><code class="go">,</code>
            <code class="nx">password</code><code class="go">,</code>
          <code class="go">})</code>
          <code class="kr">const</code> <code class="go">{</code> <code class="nx">data</code> <code class="go">}</code> <code class="o">=</code> <code class="nx">response</code>
          <code class="kr">if</code> <code class="go">(</code><code class="nx">data</code><code class="go">.</code><code class="nx">twoFactorNeeded</code><code class="go">)</code> <code class="go">{</code>
            <code class="kr">const</code> <code class="nx">userID</code> <code class="o">=</code> <code class="nx">data</code><code class="go">.</code><code class="nx">userID</code>
            <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/startVerify'</code><code class="go">,</code> <code class="go">{</code>
              <code class="nx">userID</code><code class="go">,</code>
            <code class="go">})</code>
            <code class="kr">const</code> <code class="nx">assertion</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">get</code><code class="go">({</code> <code class="nx">publicKey</code><code class="o">:</code> <code class="nx">response</code><code class="go">.</code><code class="nx">data</code> <code class="go">})</code>
            <code class="kr">const</code> <code class="nx">resp2</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/verify'</code><code class="go">,</code> <code class="go">{</code>
              <code class="nx">userID</code><code class="go">,</code>
              <code class="nx">assertion</code><code class="go">,</code>
            <code class="go">})</code>
            <code class="kr">if</code> <code class="go">(</code><code class="nx">resp2</code><code class="go">.</code><code class="nx">data</code> <code class="o">&amp;&amp;</code> <code class="nx">resp2</code><code class="go">.</code><code class="nx">data</code><code class="go">.</code><code class="nx">verified</code><code class="go">)</code> <code class="go">{</code>
              <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
            <code class="go">}</code>
          <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
            <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
          <code class="go">}</code>
        <code class="go">},</code>
        <code class="nx">logout</code><code class="o">:</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/logout'</code><code class="go">)</code>
          <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
        <code class="go">},</code>
        <code class="nx">loggedIn</code><code class="go">,</code>
      <code class="go">}}</code>
    <code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">props</code><code class="go">.</code><code class="nx">children</code><code class="go">}</code>
    <code class="go">&lt;/</code><code class="nt">SecurityContext</code><code class="go">.</code><code class="na">Provider</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>
<code class="kr">export</code> <code class="kr">default</code> <code class="nx">SecurityProvider</code></pre>

<p class="author1">We first send the username and password to the <em class="calibre7">/login</em> endpoint. If the user has registered a security device, the response to
the <em class="calibre7">/login</em> will have a <code class="calibre21">twoFactorNeeded</code> attribute set to true. We can call the <em class="calibre7">/startVerify</em> endpoint with the user’s
ID and use the resulting assertion request to ask the user to activate their device. We can send the assertion back to the server. And
if all is well, we set <code class="calibre21">loggedIn</code> to true, and the user will then see the page.</p>

<p class="author1">Let’s look at it in action. We’ll assume we’ve already registered the device against our account. We open the application and click the Account page (see <a data-type="xref" href="#ch07_image_12" class="calibre6">Figure 7-12</a>).</p>

<figure class="calibre29"><div id="ch07_image_12" class="figure">
<img src="Images/recb_0712.png" alt="" class="calibre121"/>
<h6 class="calibre30"><span class="firstname">Figure 7-12. </span>When the application opens, click the Account link</h6>
</div></figure>

<p class="author1">The Account page is secured, so we’re asked for a username and password (see <a data-type="xref" href="#ch07_image_13" class="calibre6">Figure 7-13</a>.) In the example application, you can enter
<strong class="calibre22"><code class="calibre23">freda</code></strong> as the username and <strong class="calibre22"><code class="calibre23">mypassword</code></strong> as the password.</p>

<figure class="calibre29"><div id="ch07_image_13" class="figure">
<img src="Images/recb_0713.png" alt="" class="calibre122"/>
<h6 class="calibre30"><span class="firstname">Figure 7-13. </span>The login form appears</h6>
</div></figure>

<p class="author1">Once we’ve entered the username and password, the browser asks us to connect the security device (see <a data-type="xref" href="#ch07_image_14" class="calibre6">Figure 7-14</a>).</p>

<figure class="calibre29"><div id="ch07_image_14" class="figure">
<img src="Images/recb_0714.png" alt="" class="calibre123"/>
<h6 class="calibre30"><span class="firstname">Figure 7-14. </span>The browser asks the user to activate their security device</h6>
</div></figure>

<p class="author1">If they connect their device and activate it, the user can see the secured page (see <a data-type="xref" href="#ch07_image_15" class="calibre6">Figure 7-15</a>).</p>

<figure class="calibre29"><div id="ch07_image_15" class="figure">
<img src="Images/recb_0715.png" alt="" class="calibre118"/>
<h6 class="calibre30"><span class="firstname">Figure 7-15. </span>The Account page is visible once the user has verified their identity</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634402853576">
<h2 class="calibre27">Discussion</h2>

<p class="author1">As you can probably tell, WebAuthn is quite a complex API. It uses quite obscure language (<em class="calibre7">attestation</em> for <em class="calibre7">registration</em>, and
<em class="calibre7">assertion</em> for <em class="calibre7">verification</em>) and uses some low-level data types, which fortunately the GitHub <code class="calibre21">webauthn-json</code> allows us to avoid.<a data-type="indexterm" data-primary="registration" id="idm46634401505816" class="calibre6"/><a data-type="indexterm" data-primary="verification" id="idm46634401505080" class="calibre6"/><a data-type="indexterm" data-primary="assertion (WebAuthn)" id="idm46634401504408" class="calibre6"/><a data-type="indexterm" data-primary="attestation (WebAuthn)" id="idm46634401503736" class="calibre6"/><a data-type="indexterm" data-primary="webauthn-json" data-secondary="avoiding use of low-level data types with" id="idm46634401503064" class="calibre6"/></p>

<p class="author1">The complexity lives on the server. The example server in the downloadable source code uses a library called SimpleWebAuthn to
handle most of the cryptological <em class="calibre7">stuff</em> for us.<a data-type="indexterm" data-primary="SimpleWebAuthn library" id="idm46634401501240" class="calibre6"/> If you are planning on using SimpleWebAuthn for the server side of your
application, be aware that there is also a client SimpleWebAuthn library that works with it. We’ve avoided using it in the example
client source to avoid making our code too SimpleWebAuthn-specific.</p>

<p class="author1">If you implement two-factor authentication, you will need to think about what you will do if a user loses their security device.
Technically, all you will have to do to re-enable their account is remove the device that’s registered against their name. But it
would be best to be extremely careful. A typical attack against two-factor authentication is to call the service desk and pretend to
be a user who has lost their token.</p>

<p class="author1">Instead, you will need to create a sufficiently rigorous process that will check the identity of any person asking for an account
reset.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/Diy5D" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="two-factor authentication" data-startref="ix_twoauth" id="idm46634401497576" class="calibre6"/><a data-type="indexterm" data-primary="security" data-secondary="authenticating with physical tokens" data-startref="ix_secureauthphys" id="idm46634401496600" class="calibre6"/><a data-type="indexterm" data-primary="tokens" data-secondary="physical, authenticating with" data-startref="ix_tokphy" id="idm46634401495416" class="calibre6"/><a data-type="indexterm" data-primary="authentication" data-secondary="using physical tokens" data-startref="ix_authphytk" id="idm46634401494232" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Enable HTTPS" class="calibre4"><div class="preface" id="ch07-03">
<h1 class="calibre17">Enable HTTPS</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634401491464">
<h2 class="calibre27">Problem</h2>

<p class="author1">HTTPS is often used in production environments, but there are circumstances where it can be helpful to use HTTPS during development.<a data-type="indexterm" data-primary="security" data-secondary="enabling HTTPS" id="ix_secureHTT" class="calibre6"/><a data-type="indexterm" data-primary="HTTPS" data-secondary="enabling" id="ix_HTTPS" class="calibre6"/>
Some networked services will only work from within pages secured with HTTPS. WebAuthn will only work remotely with
HTTPS.<sup class="calibre34"><a data-type="noteref" id="idm46634401487224-marker" href="ch07.xhtml#idm46634401487224" class="calibre35">4</a></sup> Numerous bugs and other issues can creep into your code if
your application uses a proxy server with HTTPS.</p>

<p class="author1">Enabling HTTPS on production servers is now relatively straightforward,<sup class="calibre34"><a data-type="noteref" id="idm46634401485080-marker" href="ch07.xhtml#idm46634401485080" class="calibre35">5</a></sup> but how do you enable
HTTPS on a development server?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634401483352">
<h2 class="calibre27">Solution</h2>

<p class="author1">If you’ve created your application with <code class="calibre21">create-react-app</code>, you can enable HTTPS by:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">Generating a self-signed SSL certificate</p>
</li>
<li class="calibre8">
<p class="author1">Registering the certificate with your development server</p>
</li>
</ul>

<p class="author1">To generate a self-signed certificate, we need to understand a little about how HTTPS works.<a data-type="indexterm" data-primary="certificates" data-secondary="self-signed SSL certificates, generating" id="idm46634401478072" class="calibre6"/><a data-type="indexterm" data-primary="self-signed certificates" id="idm46634401477000" class="calibre6"/><a data-type="indexterm" data-primary="SSL certificates" data-secondary="self-signed, generating" id="idm46634401476360" class="calibre6"/></p>

<p class="author1">HTTPS is just HTTP that is tunneled through an encrypted Secure Sockets Layer (SSL) connection.<a data-type="indexterm" data-primary="Secure Sockets Layer (SSL)" id="idm46634401474920" class="calibre6"/><a data-type="indexterm" data-primary="SSL (Secure Sockets Layer)" id="idm46634401474248" class="calibre6"/> When a browser connects to an HTTPS
address, it opens a connection to a secure socket on the server.<sup class="calibre34"><a data-type="noteref" id="idm46634401473368-marker" href="ch07.xhtml#idm46634401473368" class="calibre35">6</a></sup> The server has to
provide a certificate from an organization the browser trusts. If the browser accepts the certificate, it will then send encrypted
data to the secure socket on the server, which will then be decrypted on the server and forwarded to an HTTP server.</p>

<p class="author1">The main difficulty setting up an HTTPS server is getting a certificate that a web browser will trust.<a data-type="indexterm" data-primary="root certificates" id="idm46634401471928" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="root certificates" id="idm46634401471224" class="calibre6"/> Browsers maintain a set of
<em class="calibre7">root certificates</em>.<a data-type="indexterm" data-primary="certificates" data-secondary="root" id="idm46634401469720" class="calibre6"/> These are certificates that large, trustworthy organizations issue. When an HTTPS server presents a certificate
to a browser, that certificate must be signed by one of the browser’s root 
<span class="firstname">certificates</span>.</p>

<p class="author1">If we want to generate an SSL certificate, we will first need to create a root certificate and tell the browser to trust it. Then we
must generate a certificate for our development server that has been signed by the root certificate.</p>

<p class="author1">If this sounds complicated, it’s because it is.</p>

<p class="author1">Let’s begin by creating a root certificate. To do this, you will need a tool called OpenSSL installed on your machine.<a data-type="indexterm" data-primary="OpenSSL tool" id="idm46634401466040" class="calibre6"/></p>

<p class="author1">We’ll use the <code class="calibre21">openssl</code> command to create a key file.<a data-type="indexterm" data-primary="public-key cryptography" data-secondary="generating RSA private key" id="idm46634401464456" class="calibre6"/> It will ask you for a passphrase, which you will have to enter twice:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ openssl genrsa -des3 -out mykey.key 2048</code>
<code class="go">Generating RSA private key, 2048 bit long modulus</code>
<code class="go">.......................................................+++</code>
<code class="go">.................................+++</code>
<code class="go">e is 65537 (0x10001)</code>
<code class="go">Enter pass phrase for mykey.key:</code>
<code class="go">Verifying - Enter pass phrase for mykey.key:</code>
<code class="go">$</code></pre>

<p class="author1">The <em class="calibre7">mykey.key</em> file now contains a private key, which can be used for encrypting data. We can use the key file to create a
certificate file. A certificate file contains information about an organization and an end date after which it is no longer valid.</p>

<p class="author1">You can create a certificate<a data-type="indexterm" data-primary="certificates" data-secondary="creating with openssl" id="idm46634401454872" class="calibre6"/> using the following command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ openssl req -x509 -new -nodes -key mykey.key -sha256 -days 2048 -out mypem.pem</code>
<code class="go">Enter pass phrase for mykey.key:</code>
<code class="go">You are about to be asked to enter information that will be incorporated</code>
<code class="go">into your certificate request.</code>
<code class="go">What you are about to enter is what is called a Distinguished Name or a DN.</code>
<code class="go">There are quite a few fields but you can leave some blank</code>
<code class="go">For some fields there will be a default value,</code>
<code class="go">If you enter '.', the field will be left blank.</code>
<code class="go">-----</code>
<code class="go">Country Name (2 letter code) []:US</code>
<code class="go">State or Province Name (full name) []:Massachusetts</code>
<code class="go">Locality Name (eg, city) []:Cambridge</code>
<code class="go">Organization Name (eg, company) []:O'Reilly Media</code>
<code class="go">Organizational Unit Name (eg, section) []:Harmless scribes</code>
<code class="go">Common Name (eg, fully qualified host name) []:Local</code>
<code class="go">Email Address []:me@example.com</code>
<code class="go">$</code></pre>

<p class="author1">Here we are creating a certificate that will be valid for the next 2,048 days. The passphrase you are asked for is the one you set
when you created the <em class="calibre7">mykey.key</em> file. It doesn’t matter what you enter for the organization details, as you will be using it
only on your local machine.</p>

<p class="author1">The certificate is stored in a file called <em class="calibre7">mypem.pem</em>, and we need to install this file as a root certificate on our machine.<sup class="calibre34"><a data-type="noteref" id="idm46634401431416-marker" href="ch07.xhtml#idm46634401431416" class="calibre35">7</a></sup> There are several ways to install root certificates on your machine.<sup class="calibre34"><a data-type="noteref" id="idm46634401428680-marker" href="ch07.xhtml#idm46634401428680" class="calibre35">8</a></sup> You can use a root certificate to sign website
certificates, which is what we’ll do next.</p>

<p class="author1">We’ll create a<a data-type="indexterm" data-primary="certificates" data-secondary="certificate signing requests (CSRs)" id="idm46634401406856" class="calibre6"/><a data-type="indexterm" data-primary="CSRs (certificate signing requests)" id="idm46634401405816" class="calibre6"/> local key file, and a certificate signing request (CSR) file, with the following command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ openssl req -new -sha256 -nodes -out myprivate.csr -newkey rsa:2048 \</code>
<code class="go">-keyout myprivate.key \</code>
<code class="go">-subj "/C=US/ST=Massachusetts/L=Cambridge/O=O'Reilly \</code>
<code class="go">Media/OU=Harmless scribes/CN=Local/emailAddress=me@example.com"</code>
<code class="go">Generating a 2048 bit RSA private key</code>
<code class="go">....................+++</code>
<code class="go">..+++</code>
<code class="go">writing new private key to 'myprivate.key'</code>
<code class="go">-----</code>
<code class="go">$</code></pre>

<p class="author1">Next, create a file called <code class="calibre21">extfile.txt</code>, containing the following:</p>

<pre data-type="programlisting" data-code-language="text" class="calibre28">authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage=digitalSignature,nonRepudiation,keyEncipherment,dataEncipherment
subjectAltName=DNS:localhost</pre>

<p class="author1">We can now run a command that <a data-type="indexterm" data-primary="SSL certificates" data-secondary="generating for application" id="idm46634401383224" class="calibre6"/><a data-type="indexterm" data-primary="certificates" data-secondary="SSL, generating for application" id="idm46634401314520" class="calibre6"/>will generate an SSL certificate for our application:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ openssl x509 -req -in myprivate.csr -CA mypem.pem -CAkey mykey.key \</code>
<code class="go">-CAcreateserial -out \</code>
<code class="go">myprivate.crt -days 500 -sha256 -extfile ./extfile.txt</code>
<code class="go">Signature ok</code>
<code class="go">subject=/C=US/ST=Massachusetts/L=Cambridge/O=O'Reilly</code>
<code class="go">Media/OU=Harmless scribes/CN=Local/</code>
<code class="go">emailAddress=me@example.com</code>
<code class="go">Getting CA Private Key</code>
<code class="go">Enter pass phrase for mykey.key:</code>
<code class="go">$</code></pre>

<p class="author1">Remember, the passphrase is the one you created when you first created the <em class="calibre7">mykey.key</em> file.</p>

<p class="author1">The result of going through all of those steps is that we have two files that we can use to secure our development server:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">The <em class="calibre7">myprivate.crt</em> file is a certificate signed by the root certificate, which is the file that reassures the browser that it can
trust our application</p>
</li>
<li class="calibre8">
<p class="author1">The <em class="calibre7">myprivate.key</em> file will be used to encrypt connections between the development server and the browser.</p>
</li>
</ul>

<p class="author1">If you created your application with <code class="calibre21">create-react-app</code>, you could enable HTTPS by putting this in a <code class="calibre21">.env</code> file in your application
directory:</p>

<pre data-type="programlisting" data-code-language="text" class="calibre28">HTTPS=true
SSL_CRT_FILE=myprivate.crt
SSL_KEY_FILE=myprivate.key</pre>

<p class="author1">If you restart your server, you should be able to access your application at <em class="calibre7">https://localhost:3000</em> instead of
<em class="calibre7">http://localhost:3000</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634401482440">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Self-signed certificates are pretty complex things to create, but there are circumstances when they are required. <a data-type="indexterm" data-primary="SSL certificates" data-seealso="certificates" id="idm46634401257992" class="calibre6"/><a data-type="indexterm" data-primary="self-signed certificates" id="idm46634401257016" class="calibre6"/>However, even if
you don’t need to run HTTPS in your development environment, it can still be worth understanding what HTTPS is, how it works, and
why you should trust it.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/BAKAE" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="security" data-secondary="enabling HTTPS" data-startref="ix_secureHTT" id="idm46634401254872" class="calibre6"/><a data-type="indexterm" data-primary="HTTPS" data-secondary="enabling" data-startref="ix_HTTPS" id="idm46634401253592" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Authenticate with Fingerprints" class="calibre4"><div class="preface" id="ch07-04">
<h1 class="calibre17">Authenticate with Fingerprints</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634401250696">
<h2 class="calibre27">Problem</h2>

<p class="author1"><a data-type="xref" href="#ch07-02" class="calibre6">“Authenticate with Physical Tokens”</a> looked at how physical tokens, such as YubiKeys, can be used for two-factor authentication.<a data-type="indexterm" data-primary="security" data-secondary="authentication with fingerprints" id="ix_secureauthfngr" class="calibre6"/><a data-type="indexterm" data-primary="fingerprints, authenticating with" id="ix_fngrpr" class="calibre6"/><a data-type="indexterm" data-primary="authentication" data-secondary="using fingerprints" id="ix_authfngr" class="calibre6"/> But physical
tokens are still relatively rare and can be pretty expensive. Most people already have mobile devices, such as cell phones and
tablets. Many of those have built-in fingerprint sensors. But how can we get a React application to use a fingerprint sensor for
two-factor authentication?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634401244056">
<h2 class="calibre27">Solution</h2>

<p class="author1">We can use fingerprint sensors as WebAuthn authentication tokens.<a data-type="indexterm" data-primary="tokens" data-secondary="fingerprint sensors as WebAuthn tokens" id="ix_tknfngr" class="calibre6"/><a data-type="indexterm" data-primary="WebAuthn" data-secondary="using fingerprint sensors as tokens" id="ix_Webauthfngr" class="calibre6"/> They connect to the API in the same way, although several
configuration changes are required.</p>

<p class="author1">This recipe is based on <a data-type="xref" href="#ch07-02" class="calibre6">“Authenticate with Physical Tokens”</a> for using removable tokens for two-factor authentication. We saw in <a data-type="xref" href="#ch07-02" class="calibre6">“Authenticate with Physical Tokens”</a> that
there are two main flows in WebAuthn 
<span class="firstname">authentication</span>:</p>
<dl class="calibre18">
<dt class="calibre19">Attestation</dt>
<dd class="calibre20">
<p class="author1">In this flow, the user registers a device or token against their account. One way to do this is by pressing the
fingerprint sensor on their phone.</p>
</dd>
<dt class="calibre19">Assertion</dt>
<dd class="calibre20">
<p class="author1">In this flow, the user activates the device or token, and the server checks that it matches the device or token that
was previously registered.<a data-type="indexterm" data-primary="assertion (WebAuthn)" id="idm46634401202200" class="calibre6"/><a data-type="indexterm" data-primary="attestation (WebAuthn)" id="idm46634401201592" class="calibre6"/></p>
</dd>
</dl>

<p class="author1">Both attestation and assertion have three stages:</p>
<ol class="calibre116">
<li class="calibre8">
<p class="author1">The server generates a request.</p>
</li>
<li class="calibre8">
<p class="author1">The user uses the token, which generates a response.</p>
</li>
<li class="calibre8">
<p class="author1">The response is sent to the server.</p>
</li>

</ol>

<p class="author1">If we want to switch from using a removable physical token to using the built-in fingerprint sensor in a device, we will only need
to change the attestation request stage. <a data-type="indexterm" data-primary="YubiKeys" data-secondary="attestation request for" id="idm46634401196504" class="calibre6"/>The attestation request says what kind of token the browser can register for a user. For
removable physical tokens, like YubiKeys, we generated an attestation request that looked like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">{</code>
    <code class="s">"rpName"</code><code class="o">:</code> <code class="s">"Physical Token Server"</code><code class="go">,</code>
    <code class="s">"rpID"</code><code class="o">:</code> <code class="s">"localhost"</code><code class="go">,</code>
    <code class="s">"userID"</code><code class="o">:</code> <code class="s">"1234"</code><code class="go">,</code>
    <code class="s">"userName"</code><code class="o">:</code> <code class="s">"freda"</code><code class="go">,</code>
    <code class="s">"excludeCredentials"</code><code class="o">:</code> <code class="go">[</code>
        <code class="go">{</code><code class="s">"id"</code><code class="o">:</code> <code class="s">"existingKey1"</code><code class="go">,</code> <code class="s">"type"</code><code class="o">:</code> <code class="s">"public-key"</code><code class="go">}</code>
    <code class="go">],</code>
    <code class="s">"authenticatorSelection"</code><code class="o">:</code> <code class="go">{</code>
        <code class="s">"userVerification"</code><code class="o">:</code> <code class="s">"discouraged"</code>
    <code class="go">},</code>
    <code class="s">"extensions"</code><code class="o">:</code> <code class="go">{</code>
        <code class="s">"credProps"</code><code class="o">:</code> <code class="kr">true</code><code class="go">,</code>
    <code class="go">},</code>
<code class="go">}</code></pre>

<p class="author1">We need to change this slightly to allow the user to use a fingerprint sensor:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">{</code>
    <code class="s">"rpName"</code><code class="o">:</code> <code class="s">"Physical Token Server"</code><code class="go">,</code>
    <code class="s">"rpID"</code><code class="o">:</code> <code class="s">"localhost"</code><code class="go">,</code>
    <code class="s">"userID"</code><code class="o">:</code> <code class="s">"1234"</code><code class="go">,</code>
    <code class="s">"userName"</code><code class="o">:</code> <code class="s">"freda"</code><code class="go">,</code>
    <code class="s">"excludeCredentials"</code><code class="o">:</code> <code class="go">[</code>
        <code class="go">{</code><code class="s">"id"</code><code class="o">:</code> <code class="s">"existingKey1"</code><code class="go">,</code> <code class="s">"type"</code><code class="o">:</code> <code class="s">"public-key"</code><code class="go">}</code>
    <code class="go">],</code>
    <code class="s">"authenticatorSelection"</code><code class="o">:</code> <code class="go">{</code>
        <code class="s">"authenticatorAttachment"</code><code class="o">:</code> <code class="s">"platform"</code><code class="go">,</code>
        <code class="s">"userVerification"</code><code class="o">:</code> <code class="s">"required"</code>
    <code class="go">},</code>
    <code class="s">"attestation"</code><code class="o">:</code> <code class="s">"direct"</code><code class="go">,</code>
    <code class="s">"extensions"</code><code class="o">:</code> <code class="go">{</code>
        <code class="s">"credProps"</code><code class="o">:</code> <code class="kr">true</code><code class="go">,</code>
    <code class="go">},</code>
<code class="go">}</code></pre>

<p class="author1">The two requests are almost the same. The first change is in the authenticator selection.<a data-type="indexterm" data-primary="authenticators" id="idm46634401150200" class="calibre6"/><a data-type="indexterm" data-primary="platform authenticator" id="idm46634401149592" class="calibre6"/> We now want to use a <code class="calibre21">platform</code>
authenticator because fingerprint sensors are built into the device and not removable, which means we effectively limit the user to
their current physical device. In contrast, a YubiKey can be disconnected from one machine and then connected to another.</p>

<p class="author1">We’re also saying that we want to use direct attestation, which means we won’t require any additional verification. For example, we
won’t be asking the user to press the fingerprint sensor and then enter a PIN.</p>

<p class="author1">Beyond changing this initial attestation request object, all of the other code remains the same. Once a user responds to the
attestation request by pressing the fingerprint sensor, it will generate a public key that we can store against the user. When the
user logs back in and confirms their identity by pressing the fingerprint sensor, it will sign the challenge string in the same way
that a YubiKey would.</p>

<p class="author1">Therefore, if you’re going to support one type of authenticator, it’s worth allowing the user to use both fingerprint sensors and
removable tokens.</p>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">Unless a user has a removable token that also works on mobile devices—for example, by using Near-Field Communication

<span class="firstname">(NFC)—it’s</span> unlikely that any user will register both removable tokens and fingerprints.<a data-type="indexterm" data-primary="mobile devices" data-secondary="removable tokens and fingerprint sensors" id="idm46634401049352" class="calibre6"/><a data-type="indexterm" data-primary="NFC (Near-Field Communication)" id="idm46634401048344" class="calibre6"/><a data-type="indexterm" data-primary="Near-Field Communication (NFC)" id="idm46634401047704" class="calibre6"/> As soon as they have registered a
fingerprint, they won’t be able to log in and register a removable token, and vice versa.</p>
</div>

<p class="author1">Here is the updated component that allows a user to register a token:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">Logout</code> <code class="nx">from</code> <code class="s">'./Logout'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">create</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@github/webauthn-json'</code>

<code class="kr">const</code> <code class="nx">Private2</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">busy</code><code class="go">,</code> <code class="nx">setBusy</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">message</code><code class="go">,</code> <code class="nx">setMessage</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="kr">const</code> <code class="nx">registerToken</code> <code class="o">=</code> <code class="nx">async</code> <code class="go">(</code><code class="nx">startRegistrationEndpoint</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">setBusy</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
    <code class="kr">try</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="nx">startRegistrationEndpoint</code><code class="go">)</code>
      <code class="nx">setMessage</code><code class="go">(</code><code class="s">'Send response'</code><code class="go">)</code>
      <code class="kr">const</code> <code class="nx">attestation</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">create</code><code class="go">({</code> <code class="nx">publicKey</code><code class="o">:</code> <code class="nx">response</code><code class="go">.</code><code class="nx">data</code> <code class="go">})</code>
      <code class="nx">setMessage</code><code class="go">(</code><code class="s">'Create attestation'</code><code class="go">)</code>
      <code class="kr">const</code> <code class="nx">attestationResponse</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/register'</code><code class="go">,</code> <code class="go">{</code>
        <code class="nx">attestation</code><code class="go">,</code>
      <code class="go">})</code>
      <code class="nx">setMessage</code><code class="go">(</code><code class="s">'registered!'</code><code class="go">)</code>
      <code class="kr">if</code> <code class="go">(</code>
        <code class="nx">attestationResponse</code><code class="go">.</code><code class="nx">data</code> <code class="o">&amp;&amp;</code>
        <code class="nx">attestationResponse</code><code class="go">.</code><code class="nx">data</code><code class="go">.</code><code class="nx">verified</code>
      <code class="go">)</code> <code class="go">{</code>
        <code class="nx">alert</code><code class="go">(</code><code class="s">'New key registered'</code><code class="go">)</code>
      <code class="go">}</code>
    <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">setMessage</code><code class="go">(</code><code class="s">''</code> <code class="o">+</code> <code class="nx">err</code><code class="go">)</code>
    <code class="go">}</code> <code class="kr">finally</code> <code class="go">{</code>
      <code class="nx">setBusy</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">}</code>
  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Private2"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Account</code> <code class="nx">page</code><code class="go">&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>

      <code class="go">{</code><code class="nb">window</code><code class="go">.</code><code class="nx">PublicKeyCredential</code> <code class="o">&amp;&amp;</code> <code class="go">(</code>
        <code class="go">&lt;&gt;</code>
          <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code><code class="nx">Register</code> <code class="kr">new</code> <code class="nx">hardware</code> <code class="nx">key</code><code class="go">&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">button</code>
            <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">registerToken</code><code class="go">(</code><code class="s">'/startRegister'</code><code class="go">)}</code>
            <code class="na">disabled</code><code class="o">=</code><code class="go">{</code><code class="nx">busy</code><code class="go">}</code>
          <code class="go">&gt;</code>
            <code class="nx">Register</code> <code class="nx">Removable</code> <code class="nx">Token</code>
          <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">button</code>
            <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">registerToken</code><code class="go">(</code><code class="s">'/startFingerprint'</code><code class="go">)}</code>
            <code class="na">disabled</code><code class="o">=</code><code class="go">{</code><code class="nx">busy</code><code class="go">}</code>
          <code class="go">&gt;</code>
            <code class="nx">Register</code> <code class="nx">Fingerprint</code>
          <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">&lt;/&gt;</code>
      <code class="go">)}</code>
      <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Account-message"</code><code class="go">&gt;{</code><code class="nx">message</code><code class="go">}&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">Logout</code> <code class="go">/&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Private2</code></pre>

<p class="author1">We’re calling a slightly different endpoint when we want to register a fingerprint. Otherwise, the rest of the code remains the
same.</p>

<p class="author1">To try it, you’ll need to use a device with a fingerprint sensor. We can only use WebAuthn if we run the application on
<em class="calibre7">localhost</em> or a remote server using HTTPS.<a data-type="indexterm" data-primary="HTTPS" id="idm46634401037496" class="calibre6"/> To test this code from a mobile device, you will need to configure HTTPS on your
development server (see <a data-type="xref" href="#ch07-03" class="calibre6">“Enable HTTPS”</a>), or you will need to configure your device to proxy <em class="calibre7">localhost</em> connections to your development
machine (see <a data-type="xref" href="#ch07-07" class="calibre6">“Test on an Android Device”</a>).</p>

<p class="author1">To run the example application, you will need to change into the application directory and start the development server with the following:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm run start</code></pre>

<p class="author1">You will also need to run the API server. Open a separate terminal for this and then run it from the <em class="calibre7">server</em> subdirectory:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ cd server</code>
<code class="go">$ npm run start</code></pre>

<p class="author1">The development server will run on port 3000 and the API server on port 5000. The development server will proxy API requests to the
API server.</p>

<p class="author1">When you open the application, you should click the “Account page” link (see <a data-type="xref" href="#ch07_image_16" class="calibre6">Figure 7-16</a>).</p>

<figure class="calibre29"><div id="ch07_image_16" class="figure">
<img src="Images/recb_0716.png" alt="" class="calibre124"/>
<h6 class="calibre30"><span class="firstname">Figure 7-16. </span>Click the “Account page” link on the home page</h6>
</div></figure>

<p class="author1">The application will ask you to sign in. Enter the username <strong class="calibre22"><code class="calibre23">freda</code></strong> and the password <strong class="calibre22"><code class="calibre23">mypassword</code></strong> (see <a data-type="xref" href="#ch07_image_17" class="calibre6">Figure 7-17</a>). These values have been hardcoded in the example server.</p>

<figure class="calibre29"><div id="ch07_image_17" class="figure">
<img src="Images/recb_0717.png" alt="" class="calibre125"/>
<h6 class="calibre30"><span class="firstname">Figure 7-17. </span>Enter <strong class="calibre22"><code class="calibre23">freda/mypassword</code></strong> into the login form</h6>
</div></figure>

<p class="author1">You will now see two buttons for registering tokens against your account: one for removable tokens, the other for fingerprints (see
<a data-type="xref" href="#ch07_image_18" class="calibre6">Figure 7-18</a>).</p>

<figure class="calibre29"><div id="ch07_image_18" class="figure">
<img src="Images/recb_0718.png" alt="" class="calibre125"/>
<h6 class="calibre30"><span class="firstname">Figure 7-18. </span>There are buttons to register removable tokens and fingerprints</h6>
</div></figure>

<p class="author1">Press the button to register a fingerprint. Your mobile device will ask you to press the fingerprint sensor. Your fingerprint sensor
will generate a public key that the application can store against the <em class="calibre7">freda</em> account. A message box will appear to tell you when
this has been done, as shown in <a data-type="xref" href="#ch07_image_19" class="calibre6">Figure 7-19</a>.</p>

<figure class="calibre29"><div id="ch07_image_19" class="figure">
<img src="Images/recb_0719.png" alt="" class="calibre126"/>
<h6 class="calibre30"><span class="firstname">Figure 7-19. </span>The application will confirm when the token is registered</h6>
</div></figure>

<p class="author1">Now log out. When you log back in again, enter <strong class="calibre22"><code class="calibre23">freda</code></strong> and <strong class="calibre22"><code class="calibre23">mypassword</code></strong> in the form. The application will now ask you to confirm
your identity by pressing the fingerprint sensor, and it will then log you back in.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634401243144">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Built-in fingerprint sensors are much more common than removable tokens like YubiKeys.<a data-type="indexterm" data-primary="YubiKeys" data-secondary="built-in fingerprint sensors versus" id="idm46634400658392" class="calibre6"/> There is a difference in the usage pattern of
the two devices. YubiKeys can be moved from device to device, whereas fingerprints are typically limited to a single
device.<sup class="calibre34"><a data-type="noteref" id="idm46634400657128-marker" href="ch07.xhtml#idm46634400657128" class="calibre35">9</a></sup> Removable tokens, therefore, have
additional flexibility for users who might want to connect from several devices. The downside to removable devices is that they are
far easier to lose than a cell phone. In most cases, it is worth supporting both types of devices and leaving it to the users to
decide which option is best for them.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/m8hs6" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="WebAuthn" data-secondary="using fingerprint sensors as tokens" data-startref="ix_Webauthfngr" id="idm46634400654984" class="calibre6"/><a data-type="indexterm" data-primary="security" data-secondary="authentication with fingerprints" data-startref="ix_secureauthfngr" id="idm46634400653736" class="calibre6"/><a data-type="indexterm" data-primary="fingerprints, authenticating with" data-startref="ix_fngrpr" id="idm46634400652552" class="calibre6"/><a data-type="indexterm" data-primary="authentication" data-secondary="using fingerprints" data-startref="ix_authfngr" id="idm46634400635224" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Use Confirmation Logins" class="calibre4"><div class="preface" id="ch07-05">
<h1 class="calibre17">Use Confirmation Logins</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634400632328">
<h2 class="calibre27">Problem</h2>

<p class="author1">Sometimes a user might want to perform operations that are more dangerous or are not easily reversible.<a data-type="indexterm" data-primary="security" data-secondary="using confirmation logins" id="ix_secureconflg" class="calibre6"/><a data-type="indexterm" data-primary="confirmation logins" id="ix_cnfrlogin" class="calibre6"/><a data-type="indexterm" data-primary="login/logout" data-secondary="using confirmaion logins" id="ix_lginoutcnfr" class="calibre6"/> They might want to delete
data, remove a user account, or do something that will send an email. How do you prevent a malicious third party from carrying out
these operations if they find a logged-in but unattended machine?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634400626840">
<h2 class="calibre27">Solution</h2>

<p class="author1">Many systems force users to confirm their login credentials before being able to perform sensitive operations. You will most likely
want to do this for several operations, so it would be helpful if there was a way of doing the confirmation centrally.</p>

<p class="author1">We’ll base this recipe on the code for the secured routes in <a data-type="xref" href="ch02.xhtml#ch02-06" class="calibre6">“Create Secured Routes”</a>. In that recipe, we built a <code class="calibre21">SecurityProvider</code>
component that provided <code class="calibre21">login</code> and <code class="calibre21">logout</code> functions to <a data-type="indexterm" data-primary="SecurityProvider components" data-secondary="login and logout functions" id="idm46634400621752" class="calibre6"/>its child components:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">SecurityContext</code> <code class="nx">from</code> <code class="s">'./SecurityContext'</code>

<code class="kr">const</code> <code class="nx">SecurityProvider</code> <code class="o">=</code> <code class="go">(</code><code class="nx">props</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loggedIn</code><code class="go">,</code> <code class="nx">setLoggedIn</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">SecurityContext</code><code class="go">.</code><code class="na">Provider</code>
      <code class="na">value</code><code class="o">=</code><code class="go">{{</code>
        <code class="nx">login</code><code class="o">:</code> <code class="go">(</code><code class="nx">username</code><code class="go">,</code> <code class="nx">password</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="c">// Note to engineering team:</code>
          <code class="c">// Maybe make this more secure...</code>
          <code class="kr">if</code> <code class="go">(</code><code class="nx">username</code> <code class="o">===</code> <code class="s">'fred'</code> <code class="o">&amp;&amp;</code> <code class="nx">password</code> <code class="o">===</code> <code class="s">'password'</code><code class="go">)</code> <code class="go">{</code>
            <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
          <code class="go">}</code>
        <code class="go">},</code>
        <code class="nx">logout</code><code class="o">:</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">false</code><code class="go">),</code>
        <code class="nx">loggedIn</code><code class="go">,</code>
      <code class="go">}}</code>
    <code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">props</code><code class="go">.</code><code class="nx">children</code><code class="go">}</code>
    <code class="go">&lt;/</code><code class="nt">SecurityContext</code><code class="go">.</code><code class="na">Provider</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">SecurityProvider</code></pre>

<p class="author1">Components that needed to use the <code class="calibre21">login</code> and <code class="calibre21">logout</code> functions could access them<a data-type="indexterm" data-primary="useSecurity hook" id="idm46634400617320" class="calibre6"/> from the <code class="calibre21">useSecurity</code> hook:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">security</code> <code class="o">=</code> <code class="nx">useSecurity</code><code class="go">()</code>
<code class="go">...</code>
<code class="c">// Anywhere that we need to logout...</code>
<code class="nx">security</code><code class="go">.</code><code class="nx">logout</code><code class="go">()</code></pre>

<p class="author1">For this recipe, we’ll add an extra function to <code class="calibre21">SecurityProvider</code> that will allow a child component to confirm that the user is
logged in. Once they’ve provided the username and password, we allow them to perform the dangerous operation.</p>

<p class="author1">We could do this by creating a function that accepts a callback function containing the dangerous operation, which the application
calls after the user confirms their login details.<a data-type="indexterm" data-primary="SecurityProvider components" data-secondary="confirmLogin function" id="idm46634400561608" class="calibre6"/> This function will be easier to implement in the <code class="calibre21">SecurityProvider</code> but will have
some issues when we call it from a component. We could return a success/failure flag:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="c">// We WON'T do it like this</code>
<code class="nx">confirmLogin</code><code class="go">((</code><code class="nx">success</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">success</code><code class="go">)</code> <code class="go">{</code>
        <code class="c">// Do dangerous thing here</code>
    <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
        <code class="c">// Handle the user canceling the login</code>
    <code class="go">}</code>
<code class="go">})</code></pre>

<p class="author1">This approach has the disadvantage that if you forget to check the value of the <code class="calibre21">success</code> flag, the code will perform the dangerous
operation, even if the user cancels the login form.</p>

<p class="author1">Alternatively, we will have to pass two separate callbacks: one for success and one for cancellation:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="c">// We WON'T do it like this either</code>
<code class="nx">confirmLogin</code><code class="go">(</code>
    <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
        <code class="c">// Do dangerous thing here</code>
    <code class="go">},</code>
    <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
        <code class="c">// Handle the user canceling the login</code>
    <code class="go">});</code></pre>

<p class="author1">However, this code is a little ugly.</p>

<p class="author1">Instead, we’ll implement the code with a promise, which will make the implementation more complex, but it will simplify any code
that calls it.</p>

<p class="author1">This is a version of <code class="calibre21">SecurityProvider</code>, complete with the new <code class="calibre21">confirmLogin</code> 
<span class="firstname">function</span>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useRef</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">SecurityContext</code> <code class="nx">from</code> <code class="s">'./SecurityContext'</code>
<code class="kr">import</code> <code class="nx">LoginForm</code> <code class="nx">from</code> <code class="s">'./LoginForm'</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="go">(</code><code class="nx">props</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">showLogin</code><code class="go">,</code> <code class="nx">setShowLogin</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loggedIn</code><code class="go">,</code> <code class="nx">setLoggedIn</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="nx">resolver</code> <code class="o">=</code> <code class="nx">useRef</code><code class="go">()</code>
  <code class="kr">const</code> <code class="nx">rejecter</code> <code class="o">=</code> <code class="nx">useRef</code><code class="go">()</code>

  <code class="kr">const</code> <code class="nx">onLogin</code> <code class="o">=</code> <code class="nx">async</code> <code class="go">(</code><code class="nx">username</code><code class="go">,</code> <code class="nx">password</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Note to engineering team:</code>
    <code class="c">// Maybe make this more secure...</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">username</code> <code class="o">===</code> <code class="s">'fred'</code> <code class="o">&amp;&amp;</code> <code class="nx">password</code> <code class="o">===</code> <code class="s">'password'</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">}</code>
  <code class="kr">const</code> <code class="nx">onConfirmLogin</code> <code class="o">=</code> <code class="nx">async</code> <code class="go">(</code><code class="nx">username</code><code class="go">,</code> <code class="nx">password</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Note to engineering team:</code>
    <code class="c">// Same here...</code>
    <code class="kr">return</code> <code class="nx">username</code> <code class="o">===</code> <code class="s">'fred'</code> <code class="o">&amp;&amp;</code> <code class="nx">password</code> <code class="o">===</code> <code class="s">'password'</code>
  <code class="go">}</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">SecurityContext</code><code class="go">.</code><code class="na">Provider</code>
      <code class="na">value</code><code class="o">=</code><code class="go">{{</code>
        <code class="nx">login</code><code class="o">:</code> <code class="nx">onLogin</code><code class="go">,</code>
        <code class="nx">confirmLogin</code><code class="o">:</code> <code class="nx">async</code> <code class="go">(</code><code class="nx">callback</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="nx">setShowLogin</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
          <code class="kr">return</code> <code class="kr">new</code> <code class="nx">Promise</code><code class="go">((</code><code class="nx">res</code><code class="go">,</code> <code class="nx">rej</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
            <code class="nx">resolver</code><code class="go">.</code><code class="nx">current</code> <code class="o">=</code> <code class="nx">res</code>
            <code class="nx">rejecter</code><code class="go">.</code><code class="nx">current</code> <code class="o">=</code> <code class="nx">rej</code>
          <code class="go">})</code>
        <code class="go">},</code>
        <code class="nx">logout</code><code class="o">:</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">false</code><code class="go">),</code>
        <code class="nx">loggedIn</code><code class="go">,</code>
      <code class="go">}}</code>
    <code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">showLogin</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">LoginForm</code>
          <code class="na">onLogin</code><code class="o">=</code><code class="go">{</code><code class="nx">async</code> <code class="go">(</code><code class="nx">username</code><code class="go">,</code> <code class="nx">password</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
            <code class="kr">const</code> <code class="nx">valid</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">onConfirmLogin</code><code class="go">(</code><code class="nx">username</code><code class="go">,</code> <code class="nx">password</code><code class="go">)</code>
            <code class="kr">if</code> <code class="go">(</code><code class="nx">valid</code><code class="go">)</code> <code class="go">{</code>
              <code class="nx">setShowLogin</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
              <code class="nx">resolver</code><code class="go">.</code><code class="nx">current</code><code class="go">()</code>
            <code class="go">}</code>
          <code class="go">}}</code>
          <code class="na">onCancel</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="go">{</code>
            <code class="nx">setShowLogin</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
            <code class="nx">rejecter</code><code class="go">.</code><code class="nx">current</code><code class="go">()</code>
          <code class="go">}}</code>
        <code class="go">/&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="kr">null</code><code class="go">}</code>
      <code class="go">{</code><code class="nx">props</code><code class="go">.</code><code class="nx">children</code><code class="go">}</code>
    <code class="go">&lt;/</code><code class="nt">SecurityContext</code><code class="go">.</code><code class="na">Provider</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code></pre>

<p class="author1">If the user calls the <code class="calibre21">confirmLogin</code> function, the <code class="calibre21">SecurityProvider</code> will display a login form to allow the user to confirm their
username and password. The <code class="calibre21">confirmLo⁠gin</code> function returns a promise that will resolve only if the user types in the username and
password correctly.<a data-type="indexterm" data-primary="promises" data-secondary="returned by confirmLogin function" id="idm46634400318216" class="calibre6"/> If the user cancels the login form, the promise will be 
<span class="firstname">rejected</span>.</p>

<p class="author1">We’re not showing the details of the <code class="calibre21">LoginForm</code> component here, but you can find it in the downloadable source for this recipe.</p>

<p class="author1">Our example code here checks the username and password against static strings to see if they’re correct. In your version of the
code, you will replace this with a call to some security service.</p>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">When we call the <code class="calibre21">confirmLogin</code>, we’re storing the promise in a <em class="calibre7">ref</em>. Refs commonly point to elements in the DOM, but you can
use them to store any piece of state.<a data-type="indexterm" data-primary="refs" id="idm46634400006264" class="calibre6"/> Unlike <code class="calibre21">useState</code>, refs will update immediately. In general, it’s not good practice to use a
lot of refs in your code, and we’re only using them here so we can record the promise immediately, without waiting for a <code class="calibre21">useState</code>
operation to finish.</p>
</div>

<p class="author1">How would you use the <code class="calibre21">confirmLogin</code> function in practice? Let’s say we have a component that contains a button that performs some
dangerous operation:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">Logout</code> <code class="nx">from</code> <code class="s">'./Logout'</code>

<code class="kr">const</code> <code class="nx">Private1</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">message</code><code class="go">,</code> <code class="nx">setMessage</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="kr">const</code> <code class="nx">doDangerousThing</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">setMessage</code><code class="go">(</code><code class="s">'DANGEROUS ACTION!'</code><code class="go">)</code>
  <code class="go">}</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Private1"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Private</code> <code class="nx">page</code> <code class="mi">1</code><code class="go">&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">button</code>
        <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="nx">doDangerousThing</code><code class="go">()</code>
        <code class="go">}}</code>
      <code class="go">&gt;</code>
        <code class="nx">Do</code> <code class="nx">dangerous</code> <code class="nx">thing</code>
      <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">p</code> <code class="na">className</code><code class="o">=</code><code class="s">"message"</code><code class="go">&gt;{</code><code class="nx">message</code><code class="go">}&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">Logout</code> <code class="go">/&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Private1</code></pre>

<p class="author1">If we want the user to confirm their login details before performing this operation, we can first get hold of the context provided
by the <code class="calibre21">SecurityProvider</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">security</code> <code class="o">=</code> <code class="nx">useSecurity</code><code class="go">()</code></pre>

<p class="author1">In the code that performs the <a data-type="indexterm" data-primary="promises" data-secondary="returned by confirmLogin function" id="idm46634399930472" class="calibre6"/>dangerous operation, we can then <code class="calibre21">await</code> the promise returned by <code class="calibre21">confirmLogin</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">security</code> <code class="o">=</code> <code class="nx">useSecurity</code><code class="go">()</code>
<code class="go">...</code>
<code class="nx">await</code> <code class="nx">security</code><code class="go">.</code><code class="nx">confirmLogin</code><code class="go">()</code>
<code class="nx">setMessage</code><code class="go">(</code><code class="s">'DANGEROUS ACTION!'</code><code class="go">)</code></pre>

<p class="author1">The code following the call to <code class="calibre21">confirmLogin</code> will run only if the user provides the correct username and password.</p>

<p class="author1">If the user cancels the login dialog, the promise will be rejected, and we can handle the cancellation in a <code class="calibre21">catch</code> block.</p>

<p class="author1">Here is a modified version of the component performing dangerous code that now confirms the user’s login before proceeding:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">Logout</code> <code class="nx">from</code> <code class="s">'./Logout'</code>
<code class="kr">import</code> <code class="nx">useSecurity</code> <code class="nx">from</code> <code class="s">'./useSecurity'</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">security</code> <code class="o">=</code> <code class="nx">useSecurity</code><code class="go">()</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">message</code><code class="go">,</code> <code class="nx">setMessage</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="kr">const</code> <code class="nx">doDangerousThing</code> <code class="o">=</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">try</code> <code class="go">{</code>
      <code class="nx">await</code> <code class="nx">security</code><code class="go">.</code><code class="nx">confirmLogin</code><code class="go">()</code>
      <code class="nx">setMessage</code><code class="go">(</code><code class="s">'DANGEROUS ACTION!'</code><code class="go">)</code>
    <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">setMessage</code><code class="go">(</code><code class="s">'DANGEROUS ACTION CANCELLED!'</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">}</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Private1"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Private</code> <code class="nx">page</code> <code class="mi">1</code><code class="go">&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">button</code>
        <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="nx">doDangerousThing</code><code class="go">()</code>
        <code class="go">}}</code>
      <code class="go">&gt;</code>
        <code class="nx">Do</code> <code class="nx">dangerous</code> <code class="nx">thing</code>
      <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">p</code> <code class="na">className</code><code class="o">=</code><code class="s">"message"</code><code class="go">&gt;{</code><code class="nx">message</code><code class="go">}&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">Logout</code> <code class="go">/&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code></pre>

<p class="author1">If we try the code, we will first need to run the application from the app directory:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm run start</code></pre>

<p class="author1">When the application opens (see <a data-type="xref" href="#ch07_image_20" class="calibre6">Figure 7-20</a>), you will need to click Private Page 1.</p>

<figure class="calibre29"><div id="ch07_image_20" class="figure">
<img src="Images/recb_0720.png" alt="" class="calibre127"/>
<h6 class="calibre30"><span class="firstname">Figure 7-20. </span>Begin by clicking the Private Page 1 link</h6>
</div></figure>

<p class="author1">The application will then ask you to log in (see <a data-type="xref" href="#ch07_image_21" class="calibre6">Figure 7-21</a>.) You should log in with <em class="calibre7">fred/password</em>.</p>

<figure class="calibre29"><div id="ch07_image_21" class="figure">
<img src="Images/recb_0721.png" alt="" class="calibre63"/>
<h6 class="calibre30"><span class="firstname">Figure 7-21. </span>The page is secured, so you will need to log in</h6>
</div></figure>

<p class="author1">If you now click the button to perform the dangerous operation, you will need to confirm your credentials before continuing (as
shown in <a data-type="xref" href="#ch07_image_22" class="calibre6">Figure 7-22</a>).</p>

<figure class="calibre29"><div id="ch07_image_22" class="figure">
<img src="Images/recb_0722.png" alt="" class="calibre128"/>
<h6 class="calibre30"><span class="firstname">Figure 7-22. </span>You must confirm your login details before continuing</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634400625928">
<h2 class="calibre27">Discussion</h2>

<p class="author1">This recipe centralizes your confirmation code in the <code class="calibre21">SecurityProvider</code>, which has an advantage: not only does this lighten the
code in our components, but it means that user confirmation can take place inside custom hooks.<a data-type="indexterm" data-primary="SecurityProvider components" data-secondary="confirmation code centralized in, benefits of" id="idm46634399589096" class="calibre6"/> If you abstract a set of operations
into some hook-based service,<sup class="calibre34"><a data-type="noteref" id="idm46634399587928-marker" href="ch07.xhtml#idm46634399587928" class="calibre35">10</a></sup>
you can also include the confirmation logic in that service. As a result, your components will be completely unaware of which
operations are dangerous and which are not.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/zP75q" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="security" data-secondary="using confirmation logins" data-startref="ix_secureconflg" id="idm46634399584664" class="calibre6"/><a data-type="indexterm" data-primary="confirmation logins" data-startref="ix_cnfrlogin" id="idm46634399583416" class="calibre6"/><a data-type="indexterm" data-primary="login/logout" data-secondary="using confirmation logins" data-startref="ix_lginoutcnfr" id="idm46634399582472" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Use Single-Factor Authentication" class="calibre4"><div class="preface" id="ch07-06">
<h1 class="calibre17">Use Single-Factor Authentication</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634399559048">
<h2 class="calibre27">Problem</h2>

<p class="author1">We’ve already seen that removable tokens and fingerprints can be used in a two-factor authentication system to provide additional
security to a user’s account.<a data-type="indexterm" data-primary="tokens" data-secondary="using in single-factor authentication" id="ix_tknsnglfac" class="calibre6"/><a data-type="indexterm" data-primary="authentication" data-secondary="single-factor" id="ix_authsngl" class="calibre6"/><a data-type="indexterm" data-primary="single-factor authentication" id="ix_sngfacauth" class="calibre6"/><a data-type="indexterm" data-primary="security" data-secondary="using single-factor authentication" id="ix_secureSFA" class="calibre6"/></p>

<p class="author1">However, you can also use them as a simple login convenience. Many mobile applications allow a user to log in by pressing the
fingerprint sensor without entering a username or password.</p>

<p class="author1">How do you enable single-factor authentication for a React application?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634399551624">
<h2 class="calibre27">Solution</h2>

<p class="author1">Security tokens, such as fingerprint sensors and USB devices like YubiKeys, need to be recorded against a user account on the
server. The problem with single-factor authentication is that we don’t know who the user is supposed to be when they tap the
fingerprint sensor. In a two-factor system, they have just typed their username into a form. But in a single-factor system, we need
to know who the user is supposed to be when we create the assertion request.<sup class="calibre34"><a data-type="noteref" id="idm46634399549096-marker" href="ch07.xhtml#idm46634399549096" class="calibre35">11</a></sup></p>

<p class="author1">We can avoid this problem by setting a cookie in the browser containing the user ID <a data-type="indexterm" data-primary="cookies" data-secondary="user ID in" id="idm46634399547944" class="calibre6"/><a data-type="indexterm" data-primary="user IDs" data-secondary="setting cookie in browser with" id="idm46634399546968" class="calibre6"/>whenever a person with a token-enabled account
logs in.<sup class="calibre34"><a data-type="noteref" id="idm46634399545880-marker" href="ch07.xhtml#idm46634399545880" class="calibre35">12</a></sup></p>

<p class="author1">When the application displays the login form, the app can check for the existence of the cookie and then use it to create an
assertion request and ask the user for the security token. If the user does not want to use the token, they can cancel the request
and simply use the login form.<sup class="calibre34"><a data-type="noteref" id="idm46634399544376-marker" href="ch07.xhtml#idm46634399544376" class="calibre35">13</a></sup></p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">User IDs are often machine-generated internal keys, which contain no secure information. However, if your user IDs
are more easily identifiable, such as an email address, you should not use this approach.</p>
</div>

<p class="author1">We’re basing the code for this recipe on the secured routes code from <a data-type="xref" href="ch02.xhtml#ch02-06" class="calibre6">“Create Secured Routes”</a>. We manage all of our security through a wrapper
component called <code class="calibre21">SecurityProvider</code>. This provides child components with <code class="calibre21">login</code> and <code class="calibre21">logout</code> functions. We’ll <a data-type="indexterm" data-primary="SecurityProvider components" data-secondary="loginWithToken function" id="idm46634399538376" class="calibre6"/>add another functions called <code class="calibre21">loginWithToken</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">SecurityContext</code> <code class="nx">from</code> <code class="s">'./SecurityContext'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">get</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@github/webauthn-json'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>

<code class="kr">const</code> <code class="nx">SecurityProvider</code> <code class="o">=</code> <code class="go">(</code><code class="nx">props</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loggedIn</code><code class="go">,</code> <code class="nx">setLoggedIn</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">SecurityContext</code><code class="go">.</code><code class="na">Provider</code>
      <code class="na">value</code><code class="o">=</code><code class="go">{{</code>
        <code class="nx">login</code><code class="o">:</code> <code class="nx">async</code> <code class="go">(</code><code class="nx">username</code><code class="go">,</code> <code class="nx">password</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/login'</code><code class="go">,</code> <code class="go">{</code>
            <code class="nx">username</code><code class="go">,</code>
            <code class="nx">password</code><code class="go">,</code>
          <code class="go">})</code>
          <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
        <code class="go">},</code>
        <code class="nx">loginWithToken</code><code class="o">:</code> <code class="nx">async</code> <code class="go">(</code><code class="nx">userID</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/startVerify'</code><code class="go">,</code> <code class="go">{</code>
            <code class="nx">userID</code><code class="go">,</code>
          <code class="go">})</code>
          <code class="kr">const</code> <code class="nx">assertion</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">get</code><code class="go">({</code> <code class="nx">publicKey</code><code class="o">:</code> <code class="nx">response</code><code class="go">.</code><code class="nx">data</code> <code class="go">})</code>
          <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/verify'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">userID</code><code class="go">,</code> <code class="nx">assertion</code> <code class="go">})</code>
          <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
        <code class="go">},</code>
        <code class="nx">logout</code><code class="o">:</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">post</code><code class="go">(</code><code class="s">'/logout'</code><code class="go">)</code>
          <code class="nx">setLoggedIn</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
        <code class="go">},</code>
        <code class="nx">loggedIn</code><code class="go">,</code>
      <code class="go">}}</code>
    <code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">props</code><code class="go">.</code><code class="nx">children</code><code class="go">}</code>
    <code class="go">&lt;/</code><code class="nt">SecurityContext</code><code class="go">.</code><code class="na">Provider</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>
<code class="kr">export</code> <code class="kr">default</code> <code class="nx">SecurityProvider</code></pre>

<p class="author1">The <code class="calibre21">loginWithToken</code> accepts a <a data-type="indexterm" data-primary="user IDs" data-secondary="accepted by loginWithToken" id="idm46634399533832" class="calibre6"/>user ID and then asks the user to verify their identity with a token by:</p>
<ol class="calibre116">
<li class="calibre8">
<p class="author1">Calling a <code class="calibre21">startVerify</code> function on the server to create an assertion request<a data-type="indexterm" data-primary="assertion" id="idm46634399298776" class="calibre6"/></p>
</li>
<li class="calibre8">
<p class="author1">Passing the request to WebAuthn to ask the user to press the fingerprint sensor</p>
</li>
<li class="calibre8">
<p class="author1">Passing the generated assertion back to an endpoint called <code class="calibre21">verify</code> to check that the token is valid</p>
</li>

</ol>

<p class="author1">You will need to replace the <code class="calibre21">startVerify</code> and <code class="calibre21">verify</code> endpoints in your 
<span class="firstname">implementation</span>.</p>

<p class="author1">To call the <code class="calibre21">loginWithToken</code> function in <code class="calibre21">SecurityProvider</code>, we will need to find the current user’s ID from the cookies. <a data-type="indexterm" data-primary="cookies" id="idm46634399292104" class="calibre6"/><a data-type="indexterm" data-primary="user IDs" data-secondary="finding current user ID from cookies" id="idm46634399291400" class="calibre6"/><a data-type="indexterm" data-primary="js-cookie library" id="idm46634399290488" class="calibre6"/>We’ll do this by installing the <code class="calibre21">js-cookie</code> library:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install js-cookie</code></pre>

<p class="author1">This will allow us to read a <code class="calibre21">userID</code> cookie like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">Cookies</code> <code class="nx">from</code> <code class="s">'js-cookie'</code>
<code class="go">...</code>
<code class="kr">const</code> <code class="nx">userIDCookie</code> <code class="o">=</code> <code class="nx">Cookies</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'userID'</code><code class="go">)</code></pre>

<p class="author1">We can now use this code in a <code class="calibre21">Login</code> component, which will check for a <code class="calibre21">userID</code> cookie. If one exists, it will ask to log in by
token.<a data-type="indexterm" data-primary="login/logout" data-secondary="Login component checking for userID cookies" id="idm46634399277608" class="calibre6"/><a data-type="indexterm" data-primary="cookies" data-secondary="Login component checking for userID cookies" id="idm46634399276632" class="calibre6"/> Otherwise, it will allow the user to log in using a username and password:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">useSecurity</code> <code class="nx">from</code> <code class="s">'./useSecurity'</code>
<code class="kr">import</code> <code class="nx">Cookies</code> <code class="nx">from</code> <code class="s">'js-cookie'</code>

<code class="kr">const</code> <code class="nx">Login</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">{</code> <code class="nx">login</code><code class="go">,</code> <code class="nx">loginWithToken</code> <code class="go">}</code> <code class="o">=</code> <code class="nx">useSecurity</code><code class="go">()</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">username</code><code class="go">,</code> <code class="nx">setUsername</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">password</code><code class="go">,</code> <code class="nx">setPassword</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
  <code class="kr">const</code> <code class="nx">userIDCookie</code> <code class="o">=</code> <code class="nx">Cookies</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'userID'</code><code class="go">)</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">if</code> <code class="go">(</code><code class="nx">userIDCookie</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">loginWithToken</code><code class="go">(</code><code class="nx">userIDCookie</code><code class="go">)</code>
      <code class="go">}</code>
    <code class="go">})()</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">userIDCookie</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Login</code> <code class="nx">Page</code><code class="go">&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code><code class="nx">You</code> <code class="nx">need</code> <code class="nx">to</code> <code class="nx">log</code> <code class="kr">in</code><code class="go">.&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">label</code> <code class="na">htmlFor</code><code class="o">=</code><code class="s">"username"</code><code class="go">&gt;</code><code class="nx">Username</code><code class="o">:</code><code class="go">&lt;/</code><code class="nt">label</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">input</code>
        <code class="na">id</code><code class="o">=</code><code class="s">"username"</code>
        <code class="na">name</code><code class="o">=</code><code class="s">"username"</code>
        <code class="na">type</code><code class="o">=</code><code class="s">"text"</code>
        <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">username</code><code class="go">}</code>
        <code class="na">onChange</code><code class="o">=</code><code class="go">{(</code><code class="nx">evt</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">setUsername</code><code class="go">(</code><code class="nx">evt</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">)}</code>
      <code class="go">/&gt;</code>

      <code class="go">&lt;</code><code class="nt">br</code> <code class="go">/&gt;</code>
      <code class="go">&lt;</code><code class="nt">label</code> <code class="na">htmlFor</code><code class="o">=</code><code class="s">"password"</code><code class="go">&gt;</code><code class="nx">Password</code><code class="o">:</code><code class="go">&lt;/</code><code class="nt">label</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">input</code>
        <code class="na">id</code><code class="o">=</code><code class="s">"password"</code>
        <code class="na">name</code><code class="o">=</code><code class="s">"password"</code>
        <code class="na">type</code><code class="o">=</code><code class="s">"password"</code>
        <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">password</code><code class="go">}</code>
        <code class="na">onChange</code><code class="o">=</code><code class="go">{(</code><code class="nx">evt</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">setPassword</code><code class="go">(</code><code class="nx">evt</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">)}</code>
      <code class="go">/&gt;</code>

      <code class="go">&lt;</code><code class="nt">br</code> <code class="go">/&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">login</code><code class="go">(</code><code class="nx">username</code><code class="go">,</code> <code class="nx">password</code><code class="go">)}&gt;</code><code class="nx">Login</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Login</code></pre>

<p class="author1">Let’s try the example application. We must first start the development server from the application directory:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm run start</code></pre>

<p class="author1">Then in a separate terminal, we can start the example API server:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ cd server</code>
<code class="go">$ npm run start</code></pre>

<p class="author1">The development server runs on port 3000; the API server runs on port 5000.</p>

<p class="author1">When the application starts, click the link to the Account page (as shown in <a data-type="xref" href="#ch07_image_23" class="calibre6">Figure 7-23</a>).</p>

<figure class="calibre29"><div id="ch07_image_23" class="figure">
<img src="Images/recb_0723.png" alt="" class="calibre61"/>
<h6 class="calibre30"><span class="firstname">Figure 7-23. </span>When the app opens, click the link to the Account page</h6>
</div></figure>

<p class="author1">The application asks us to log in (see <a data-type="xref" href="#ch07_image_24" class="calibre6">Figure 7-24</a>). Use the username <strong class="calibre22"><code class="calibre23">freda</code></strong> and the password <strong class="calibre22"><code class="calibre23">mypassword</code></strong>.</p>

<figure class="calibre29"><div id="ch07_image_24" class="figure">
<img src="Images/recb_0724.png" alt="" class="calibre122"/>
<h6 class="calibre30"><span class="firstname">Figure 7-24. </span>Log in with <strong class="calibre22"><code class="calibre23">freda/mypassword</code></strong></h6>
</div></figure>

<p class="author1">The account page asks if we want to enable login with a fingerprint sensor or physical token (see <a data-type="xref" href="#ch07_image_25" class="calibre6">Figure 7-25</a>). You can register a
token and then log out.<a data-type="indexterm" data-primary="login/logout" data-secondary="enabling login with a token" id="idm46634398911704" class="calibre6"/></p>

<figure class="calibre29"><div id="ch07_image_25" class="figure">
<img src="Images/recb_0725.png" alt="" class="calibre129"/>
<h6 class="calibre30"><span class="firstname">Figure 7-25. </span>Choose to enable login with a physical token or fingerprint</h6>
</div></figure>

<p class="author1">The next time we log in, we will immediately see the request to activate a token (see <a data-type="xref" href="#ch07_image_26" class="calibre6">Figure 7-26</a>).</p>

<figure class="calibre29"><div id="ch07_image_26" class="figure">
<img src="Images/recb_0726.png" alt="" class="calibre130"/>
<h6 class="calibre30"><span class="firstname">Figure 7-26. </span>Once enabled, you can log in with just the token</h6>
</div></figure>

<p class="author1">If we activate the token, we will log in without providing a username and password.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634399550680">
<h2 class="calibre27">Discussion</h2>

<p class="author1">It’s important to note that single-factor authentication is about increasing convenience rather than security. Fingerprint sensors
are particularly convenient, as logging in literally involves moving one finger.</p>

<p class="author1">You should always provide the ability to fall back to using the login form. Doing so will not reduce the security of your
application, as a wily hacker could delete the cookie and fall back to using the form anyway.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/4ZDh6" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="tokens" data-secondary="using in single-factor authentication" data-startref="ix_tknsnglfac" id="idm46634398901832" class="calibre6"/><a data-type="indexterm" data-primary="authentication" data-secondary="single-factor" data-startref="ix_authsngl" id="idm46634398900536" class="calibre6"/><a data-type="indexterm" data-primary="single-factor authentication" data-startref="ix_sngfacauth" id="idm46634398861928" class="calibre6"/><a data-type="indexterm" data-primary="security" data-secondary="using single-factor authentication" data-startref="ix_secureSFA" id="idm46634398860968" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Test on an Android Device" class="calibre4"><div class="preface" id="ch07-07">
<h1 class="calibre17">Test on an Android Device</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634398858056">
<h2 class="calibre27">Problem</h2>

<p class="author1">You can perform most mobile browser testing with a desktop browser simulating the appearance of a mobile device (see <a data-type="xref" href="#ch07_image_27" class="calibre6">Figure 7-27</a>).<a data-type="indexterm" data-primary="testing" data-secondary="React app on Android device" id="ix_tstAnd" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="mobile" data-tertiary="testing" id="idm46634398854264" class="calibre6"/><a data-type="indexterm" data-primary="security" data-secondary="testing React app on Android device" id="ix_securetst" class="calibre6"/><a data-type="indexterm" data-primary="Android device, testing React app on" id="ix_Andrtst" class="calibre6"/><a data-type="indexterm" data-primary="mobile devices" data-secondary="testing React app on Android device" id="ix_mobdevtst" class="calibre6"/></p>

<figure class="calibre29"><div id="ch07_image_27" class="figure">
<img src="Images/recb_0727.png" alt="" class="calibre131"/>
<h6 class="calibre30"><span class="firstname">Figure 7-27. </span>You can use a desktop browser for most mobile testing</h6>
</div></figure>

<p class="author1">But there are times when it is best to test a React application on a physical mobile device, which is usually not a problem; the
mobile device can access the React application remotely using the IP address of the development machine.</p>

<p class="author1">There are, however, circumstances where that is not true:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">Your mobile device might not be able to connect to the same network as your development machine.</p>
</li>
<li class="calibre8">
<p class="author1">You might be using a technology, such as WebAuthn, that requires HTTPS for domains other than <em class="calibre7">localhost</em>.<a data-type="indexterm" data-primary="WebAuthn" data-secondary="requiring HTTPS for domains other than Localhost" id="idm46634398843912" class="calibre6"/><a data-type="indexterm" data-primary="HTTPS" id="idm46634398842808" class="calibre6"/><a data-type="indexterm" data-primary="localhost" data-secondary="configuring mobile device to access React app on" id="idm46634398842136" class="calibre6"/></p>
</li>
</ul>

<p class="author1">Is it possible to configure a mobile device to access a React app as if it is running on <em class="calibre7">localhost</em>, even though it is running on a
separate machine?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634398839864">
<h2 class="calibre27">Solution</h2>

<p class="author1">This recipe will look at how we can proxy the network on an Android-based device so that connections to <em class="calibre7">localhost</em> will go to the
server on your development machine.<a data-type="indexterm" data-primary="proxies" data-secondary="proxying network on Android-based device" id="idm46634398837592" class="calibre6"/></p>

<p class="author1">The first thing you’ll need is an Android device that has <a href="https://oreil.ly/fc5Fv" class="calibre6">USB debugging enabled</a>. You will also need a copy of the <a href="https://oreil.ly/BFeXr" class="calibre6">Android SDK</a> installed, which will allow you to use
a tool called the <em class="calibre7">Android Debug Bridge</em> (ADB). The ADB opens a communication channel between your development
machine and an Android device.<a data-type="indexterm" data-primary="Android Debug Bridge (adb) command" id="idm46634398834232" class="calibre6"/><a data-type="indexterm" data-primary="adb (Android Debug Bridge) command" id="idm46634398833512" class="calibre6"/></p>

<p class="author1">You will then need to connect your Android device to your development machine with a USB cable and ensure that the <code class="calibre21">adb</code> command is
available on your command path.<sup class="calibre34"><a data-type="noteref" id="idm46634398831896-marker" href="ch07.xhtml#idm46634398831896" class="calibre35">14</a></sup> You can then list the Android devices connected to your machine:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ adb devices</code>
<code class="go">* daemon not running; starting now at tcp:5037</code>
<code class="go">* daemon started successfully</code>
<code class="go">List of devices attached</code>
<code class="go">25PRIFFEJZWWDFWO        device</code>
<code class="go">$</code></pre>

<p class="author1">Here you can see there is a single device connected, with a device ID of <code class="calibre21">25PRIFFEJZWWDFWO</code>.</p>

<p class="author1">You can now use the <code class="calibre21">adb</code> command to configure a proxy on the Android device, which will redirect all HTTP traffic to its internal
port 3000:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ adb shell settings put global http_proxy localhost:3000</code></pre>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">If you have more than one Android device connected to your machine, you will need to specify its device ID with the <code class="calibre21">adb</code>
option <code class="calibre21">-s &lt;device-id&gt;</code>.</p>
</div>

<p class="author1">You will next need to tell <code class="calibre21">adb</code> to run a proxy service on the Android device, which will forward any traffic from port 3000 on the device to port 3000 on the development machine:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ adb reverse tcp:3000 tcp:3000</code></pre>

<p class="author1">If you now open a browser on the Android device<a data-type="indexterm" data-primary="browsers" data-secondary="mobile" data-tertiary="opening on Android device and connecting to localhost" id="idm46634398776504" class="calibre6"/> and tell it to go to <em class="calibre7">http://localhost:3000</em>, it will display the app running on your
development machine, as if it’s running inside the device (see <a data-type="xref" href="#ch07_image_28" class="calibre6">Figure 7-28</a>).</p>

<figure class="calibre29"><div id="ch07_image_28" class="figure">
<img src="Images/recb_0716.png" alt="" class="calibre124"/>
<h6 class="calibre30"><span class="firstname">Figure 7-28. </span>If you open a mobile browser to localhost, it will connect to the development machine</h6>
</div></figure>

<p class="author1">Once you have finished using the app, you will need to disable the proxy setting on the Android device.</p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">If you fail to disable the proxy on the Android device, it will no longer access the network.</p>
</div>

<p class="author1">You can do this by resetting the proxy back to <code class="calibre21">:0</code>:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ adb shell settings put global http_proxy :0</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634398839240">
<h2 class="calibre27">Discussion</h2>

<p class="author1">This recipe requires a lot of work the first time you use it because it involves installing an entire Android SDK on your
development machine. But then it will be straightforward to connect and disconnect real Android devices to your machine.<a data-type="indexterm" data-primary="testing" data-secondary="React app on Android device" data-startref="ix_tstAnd" id="idm46634398800088" class="calibre6"/><a data-type="indexterm" data-primary="security" data-secondary="testing React app on Android device" data-startref="ix_securetst" id="idm46634398798872" class="calibre6"/><a data-type="indexterm" data-primary="Android device, testing React app on" data-startref="ix_Andrtst" id="idm46634398811512" class="calibre6"/><a data-type="indexterm" data-primary="mobile devices" data-secondary="testing React app on Android device" data-startref="ix_mobdevtst" id="idm46634398810600" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Check Security with ESlint" class="calibre4"><div class="preface" id="ch07-08">
<h1 class="calibre17">Check Security with ESlint</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634398807416">
<h2 class="calibre27">Problem</h2>

<p class="author1">Just a few common coding issues frequently cause security threats in JavaScript.<a data-type="indexterm" data-primary="security" data-secondary="checking with eslint" id="ix_secureck" class="calibre6"/> You can decide to create a set of coding standards
that will avoid those errors. However, you will need to frequently review the standards to keep them up-to-date with the latest
changes in technology, and you will also need to introduce slow and expensive code review processes.</p>

<p class="author1">Is there a way to check for poor security practices in code that will not slow down your development processes?<a data-type="indexterm" data-primary="eslint" data-secondary="checking security with" id="ix_eslnt" class="calibre6"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634398802392">
<h2 class="calibre27">Solution</h2>

<p class="author1">One way to introduce security reviews is to try to automate them. One tool that will allow you to do this is <code class="calibre21">eslint</code>. If you’ve
created your application with a tool like <code class="calibre21">create-react-app</code>, you have probably already got <code class="calibre21">eslint</code> installed. In fact,
<code class="calibre21">create-react-app</code> runs <code class="calibre21">eslint</code> each time it restarts its development server. If you’ve ever seen coding issues highlighted in the
terminal, that output has come from <code class="calibre21">eslint</code>:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">Compiled with warnings.</code>

<code class="go">src/App.js</code>
<code class="go">  Line 5:9:  'x' is assigned a value but never used  no-unused-vars</code>

<code class="go">Search for the keywords to learn more about each warning.</code>
<code class="go">To ignore, add // eslint-disable-next-line to the line before.</code></pre>

<p class="author1">If you don’t have <code class="calibre21">eslint</code> installed, you can install it through <code class="calibre21">npm</code>:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install --save-dev eslint</code></pre>

<p class="author1">Once installed, you can initialize it like this:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ node_modules/.bin/eslint --init</code>
<code class="go">- How would you like to use ESLint? · problems</code>
<code class="go">- What type of modules does your project use? · esm</code>
<code class="go">- Which framework does your project use? · react</code>
<code class="go">- Does your project use TypeScript? · No / Yes</code>
<code class="go">- Where does your code run? · browser</code>
<code class="go">- What format do you want your config file to be in? · JavaScript</code>
<code class="go">Local ESLint installation not found.</code>
<code class="go">The config that you've selected requires the following dependencies:</code>

<code class="go">eslint-plugin-react@latest eslint@latest</code>
<code class="go">- Would you like to install them now with npm? · No / Yes</code>
<code class="go">$</code></pre>

<p class="author1">Remember: you don’t need to initialize <code class="calibre21">eslint</code> if you’re using <code class="calibre21">create-react-app</code>; it’s already done for you.</p>

<p class="author1">At this point, you could choose to write your own set of <code class="calibre21">eslint</code> rules to check for breaches of any security practices.<a data-type="indexterm" data-primary="eslint" data-secondary="checking security with" data-tertiary="installing plugin with security rules" id="idm46634398622600" class="calibre6"/> However,
it’s far easier to install an <code class="calibre21">eslint</code> plugin with a set of security rules already written for you.</p>

<p class="author1">For example, let’s install the <code class="calibre21">eslint-plugin-react-security</code> package, which is created and managed by <a href="https://slyk.io" class="calibre6">Slyk</a>:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install --save-dev eslint-plugin-react-security</code></pre>

<p class="author1">Once installed, we can enable this plugin by editing the <code class="calibre21">eslintConfig</code> section of <em class="calibre7">package.json</em> (if you’re using
<code class="calibre21">create-react-app</code>) or the <em class="calibre7">eslintrc*</em> file in your<a data-type="indexterm" data-primary="JSON" data-secondary="enabling eslint in package.json file" id="idm46634398556648" class="calibre6"/><a data-type="indexterm" data-primary="eslint" data-secondary="checking security with" data-tertiary="enabling eslint" id="idm46634398656232" class="calibre6"/> app 
<span class="firstname">directory</span>.</p>

<p class="author1">You should change it from this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="s">"eslintConfig"</code><code class="o">:</code> <code class="go">{</code>
  <code class="s">"extends"</code><code class="o">:</code> <code class="go">[</code>
    <code class="s">"react-app"</code><code class="go">,</code>
    <code class="s">"react-app/jest"</code>
  <code class="go">]</code>
<code class="go">},</code></pre>

<p class="author1">to this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="s">"eslintConfig"</code><code class="o">:</code> <code class="go">{</code>
  <code class="s">"extends"</code><code class="o">:</code> <code class="go">[</code>
    <code class="s">"react-app"</code><code class="go">,</code>
    <code class="s">"react-app/jest"</code>
  <code class="go">],</code>
  <code class="s">"plugins"</code><code class="o">:</code> <code class="go">[</code>
    <code class="s">"react-security"</code>
  <code class="go">],</code>
  <code class="s">"rules"</code><code class="o">:</code> <code class="go">{</code>
    <code class="s">"react-security/no-javascript-urls"</code><code class="o">:</code> <code class="s">"warn"</code><code class="go">,</code>
    <code class="s">"react-security/no-dangerously-set-innerhtml"</code><code class="o">:</code> <code class="s">"warn"</code><code class="go">,</code>
    <code class="s">"react-security/no-find-dom-node"</code><code class="o">:</code> <code class="s">"warn"</code><code class="go">,</code>
    <code class="s">"react-security/no-refs"</code><code class="o">:</code> <code class="s">"warn"</code>
  <code class="go">}</code>
<code class="go">},</code></pre>

<p class="author1">This change will enable four rules from the React Security plugin.</p>

<p class="author1">To check that they work, let’s add some code to an application that will contravene <a data-type="indexterm" data-primary="no-dangerously-set-innerhtml rule" id="idm46634398491384" class="calibre6"/><a data-type="indexterm" data-primary="eslint" data-secondary="checking security with" data-tertiary="no-dangerously-set-innerhtml rule" id="idm46634398490776" class="calibre6"/><a data-type="indexterm" data-primary="HTML" data-secondary="no-dangerously-set-innerhtml check in eslint" id="idm46634398489608" class="calibre6"/>the <em class="calibre7">no-dangerously-set-innerhtml</em> rule:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">logo</code> <code class="nx">from</code> <code class="s">'./logo.svg'</code>
<code class="kr">import</code> <code class="s">'./App.css'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">header</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-header"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">img</code> <code class="na">src</code><code class="o">=</code><code class="go">{</code><code class="nx">logo</code><code class="go">}</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-logo"</code> <code class="na">alt</code><code class="o">=</code><code class="s">"logo"</code> <code class="go">/&gt;</code>
        <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code>
          <code class="nx">Edit</code> <code class="go">&lt;</code><code class="nt">code</code><code class="go">&gt;</code><code class="nx">src</code><code class="o">/</code><code class="nx">App</code><code class="go">.</code><code class="nx">js</code><code class="go">&lt;/</code><code class="nt">code</code><code class="go">&gt;</code> <code class="nx">and</code> <code class="nx">save</code> <code class="nx">to</code> <code class="nx">reload</code><code class="go">.</code>
        <code class="go">&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">div</code>
          <code class="na">dangerouslySetInnerHTML</code><code class="o">=</code><code class="go">{{</code>
            <code class="nx">__html</code><code class="o">:</code> <code class="s">'&lt;p&gt;This is a bad idea&lt;/p&gt;'</code><code class="go">,</code>
          <code class="go">}}</code>
        <code class="go">/&gt;</code>
        <code class="go">&lt;</code><code class="nt">a</code>
          <code class="na">className</code><code class="o">=</code><code class="s">"App-link"</code>
          <code class="na">href</code><code class="o">=</code><code class="s">"https://reactjs.org"</code>
          <code class="na">target</code><code class="o">=</code><code class="s">"_blank"</code>
          <code class="na">rel</code><code class="o">=</code><code class="s">"noopener noreferrer"</code>
        <code class="go">&gt;</code>
          <code class="nx">Learn</code> <code class="nx">React</code>
        <code class="go">&lt;/</code><code class="nt">a</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">header</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">If you’ve installed <code class="calibre21">eslint</code> manually, you can now scan this file with:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ node_modules/.bin/eslint src/App.js</code></pre>

<p class="author1">If you’re using <code class="calibre21">create-react-app</code>, you just need to restart the server to ensure that it reloads the <code class="calibre21">eslint</code> config:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">Compiled with warnings.</code>

<code class="go">src/App.js</code>
<code class="go">  Line 12:16:  dangrouslySetInnerHTML prop usage detected</code>
<code class="go">               react-security/no-dangerously-set-innerhtml</code>

<code class="go">Search for the keywords to learn more about each warning.</code>
<code class="go">To ignore, add // eslint-disable-next-line to the line before.</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634398696472">
<h2 class="calibre27">Discussion</h2>

<p class="author1">If you have a team of developers, you might also want to run the <code class="calibre21">eslint</code> checks using a Git <em class="calibre7">pre-commit</em> hook to prevent developers
from ever checking in code that fails the audit.<a data-type="indexterm" data-primary="pre-commit hooks" id="idm46634398308856" class="calibre6"/><a data-type="indexterm" data-primary="eslint" data-secondary="checking security with" data-tertiary="running checks with Git pre-commit hooks" id="idm46634398308264" class="calibre6"/><a data-type="indexterm" data-primary="hooks" data-secondary="Git pre-commit hook" id="idm46634398307080" class="calibre6"/><a data-type="indexterm" data-primary="Git pre-commit hooks" id="idm46634398306136" class="calibre6"/> A Git hook will give faster feedback to the developer and prevent them from failing
the build for everyone else.</p>

<p class="author1">If you want to configure pre-commit hooks through your <em class="calibre7">package.json</em> file, consider installing <a href="https://oreil.ly/uEjix" class="calibre6">Husky code hooks</a>.</p>

<p class="author1">Another advantage of automating your security checks is that you can add them to your build-and-deploy pipeline. If you run the
checks at the start of the pipeline, you can reject a commit immediately and notify the developer.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/kvBcS" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="eslint" data-secondary="checking security with" data-startref="ix_eslnt" id="idm46634398316040" class="calibre6"/><a data-type="indexterm" data-primary="security" data-secondary="checking with eslint" data-startref="ix_secureck" id="idm46634398314760" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Make Login Forms Browser Friendly" class="calibre4"><div class="preface" id="ch07-09">
<h1 class="calibre17">Make Login Forms Browser Friendly</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634398283688">
<h2 class="calibre27">Problem</h2>

<p class="author1">Many security solutions rely on username/password forms, but several usability traps are easy to fall into when creating them.<a data-type="indexterm" data-primary="browsers" data-secondary="login forms that are browser friendly" id="ix_brwslogin" class="calibre6"/><a data-type="indexterm" data-primary="security" data-secondary="making login forms browser friendly" id="ix_securelogfrm" class="calibre6"/><a data-type="indexterm" data-primary="login/logout" data-secondary="making login forms browser friendly" id="ix_lginoutfrmbrw" class="calibre6"/> On
some devices, automated capitalization and autocorrect can corrupt usernames and passwords in an attempt to be helpful. Some
browsers will attempt to autocomplete username fields, but it is often unclear what rules they use, so autocomplete works on
some sites but not others.</p>

<p class="author1">What practices should you follow when building login forms so that they will work with the browser rather than against it?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634398277416">
<h2 class="calibre27">Solution</h2>

<p class="author1">Several HTML attributes can significantly improve the usability of your login forms.<a data-type="indexterm" data-primary="HTML" data-secondary="attributes to improve usability of login forms" id="idm46634398275368" class="calibre6"/></p>

<p class="author1">First, it can be useful to disable autocorrect for username fields. Autocorrect is frequently applied on mobile devices to
compensate for the small keyboards and the spelling mistakes that inevitably occur. But autocorrect is of little use when typing
usernames. <a data-type="indexterm" data-primary="autoCorrect attribute" id="idm46634398273768" class="calibre6"/>You can disable autocorrect using the <code class="calibre21">autoCorrect</code> attribute:</p>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;input</code> <code class="na">autoCorrect=</code><code class="s">"off"</code><code class="nt">/&gt;</code></pre>

<p class="author1">Next, if your username is an email address, consider setting the <code class="calibre21">type</code> to <code class="calibre21">email</code>, which might launch an email-specific keyboard on
mobile devices.<a data-type="indexterm" data-primary="email input type attribute" id="idm46634398251032" class="calibre6"/> Some browsers may even show recent email addresses in an autocomplete window or in the header of an email-specific
keyboard:</p>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"email"</code><code class="nt">/&gt;</code></pre>

<p class="author1">You might also consider using <code class="calibre21">j_username</code> as the <code class="calibre21">id</code> and <code class="calibre21">name</code> of the username field.<a data-type="indexterm" data-primary="j_username as id and name of username field" id="idm46634398199048" class="calibre6"/> Why? It’s because Java-based applications
commonly have fields named <code class="calibre21">j_username</code>, and so the user is likely to have provided a <code class="calibre21">j_username</code> value in the past. This increases
the likelihood that the browser might offer the email address in an autocomplete window:</p>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;input</code> <code class="na">id=</code><code class="s">"j_username"</code> <code class="na">name=</code><code class="s">"j_username"</code><code class="nt">/&gt;</code></pre>

<p class="author1">You can explicitly say that a field represents a username field, making it <em class="calibre7">very</em> likely that you will trigger an autocomplete
response from the browser:<a data-type="indexterm" data-primary="autoComplete attribute" id="idm46634398179816" class="calibre6"/></p>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;input</code> <code class="na">autoComplete=</code><code class="s">"username"</code><code class="nt">/&gt;</code></pre>

<p class="author1">Now, what to do about passwords?</p>

<p class="author1">First, always set the type to <code class="calibre21">password</code>:</p>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"password"</code><code class="nt">/&gt;</code></pre>

<p class="author1">Never be tempted to reproduce the visual appearance of a password field in some other way, for example, by custom CSS styling.<a data-type="indexterm" data-primary="password input type, avoiding on login forms" id="idm46634398146584" class="calibre6"/> Doing
so will prevent the browser from applying standard security features to the password field, such as disabling the copy function
inside it. Also, if you don’t set the type to <code class="calibre21">password</code>, the browser will not offer to store the value in its password manager.</p>

<p class="author1">There are two types of password fields: for current passwords (when logging in) and for new passwords (when signing up or changing a
password).</p>

<p class="author1">Why is this relevant? It’s because the HTML <code class="calibre21">autoComplete</code> attribute can indicate to the browser how you intend to use the password
field.</p>

<p class="author1">If it’s a login form, you will want to say that the password is a <code class="calibre21">current-password</code>:</p>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"password"</code> <code class="na">autoComplete=</code><code class="s">"current-password"</code><code class="nt">/&gt;</code></pre>

<p class="author1">If it’s a registration or change password form, you should set it to <code class="calibre21">new-password</code>:</p>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"password"</code> <code class="na">autoComplete=</code><code class="s">"new-password"</code><code class="nt">/&gt;</code></pre>

<p class="author1">This value will encourage the browser to autocomplete stored passwords in a login form. It will also trigger any built-in or
third-party password generation tools.</p>

<p class="author1">Finally, avoid <a data-type="indexterm" data-primary="wizard-style login screens, avoiding" id="idm46634398125896" class="calibre6"/>using wizard-style login screens (see <a data-type="xref" href="#ch07_image_29" class="calibre6">Figure 7-29</a> for an example from the <em class="calibre7">Washington Post</em>).</p>

<p class="author1">Browsers are less likely to recognize a single username field as a login form and so are less likely to offer to complete the
details for you.</p>

<figure class="calibre29"><div id="ch07_image_29" class="figure">
<img src="Images/recb_0729.png" alt="" class="calibre132"/>
<h6 class="calibre30"><span class="firstname">Figure 7-29. </span>Multistep forms can prevent a browser from using autocomplete</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634398276472">
<h2 class="calibre27">Discussion</h2>

<p class="author1">The <code class="calibre21">autocomplete</code> attribute has many other seldom-used values for several types of form fields, from address details and phone
numbers to credit card numbers. For further information, see the <a href="https://oreil.ly/TLHLF" class="calibre6">Mozilla development site</a>.<a data-type="indexterm" data-primary="browsers" data-secondary="login forms that are browser friendly" data-startref="ix_brwslogin" id="idm46634430178904" class="calibre6"/><a data-type="indexterm" data-primary="security" data-secondary="making login forms browser friendly" data-startref="ix_securelogfrm" id="idm46634430177688" class="calibre6"/><a data-type="indexterm" data-primary="login/logout" data-secondary="making login forms browser friendly" data-startref="ix_lginoutfrmbrw" id="idm46634398042408" class="calibre6"/><a data-type="indexterm" data-primary="security" data-startref="ix_secure" id="idm46634398041176" class="calibre6"/></p>
</div></section>





</div></section>







<div data-type="footnotes" class="calibre49"><p data-type="footnote" id="idm46634402876760" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634402876760-marker" class="calibre35">1</a></sup> Or, in the case of GraphQL, accessors and mutators.</p><p data-type="footnote" id="idm46634402851832" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634402851832-marker" class="calibre35">2</a></sup> With the notable exception of Internet Explorer.</p><p data-type="footnote" id="idm46634401908472" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634401908472-marker" class="calibre35">3</a></sup> See <a data-type="xref" href="ch02.xhtml#ch02-06" class="calibre6">“Create Secured Routes”</a>.</p><p data-type="footnote" id="idm46634401487224" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634401487224-marker" class="calibre35">4</a></sup> It is possible to get around this problem on Android devices by proxying your phone through your development machine. See <a data-type="xref" href="#ch07-07" class="calibre6">“Test on an Android Device”</a>.</p><p data-type="footnote" id="idm46634401485080" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634401485080-marker" class="calibre35">5</a></sup> See <a href="https://letsencrypt.org" class="calibre6">the Let’s Encrypt site</a>.</p><p data-type="footnote" id="idm46634401473368" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634401473368-marker" class="calibre35">6</a></sup> By default, this will be on port 443.</p><p data-type="footnote" id="idm46634401431416" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634401431416-marker" class="calibre35">7</a></sup> The <em class="calibre7">.pem</em> extension stands for Privacy-Enhanced Mail.<a data-type="indexterm" data-primary="PEM (Privacy-Enhanced Mail) format" id="idm46634401430520" class="calibre6"/><a data-type="indexterm" data-primary="Privacy-Enhanced Mail (PEM) format" id="idm46634401429752" class="calibre6"/> The PEM format was initially designed for use with email but is now used as a general certificate storage format.</p><p data-type="footnote" id="idm46634401428680" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634401428680-marker" class="calibre35">8</a></sup> For a detailed guide, see <a href="https://oreil.ly/9NN1H" class="calibre6">this tutorial from BounCA</a>.</p><p data-type="footnote" id="idm46634400657128" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634400657128-marker" class="calibre35">9</a></sup> An exception would be if the user has connected an external fingerprint sensor.</p><p data-type="footnote" id="idm46634399587928" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634399587928-marker" class="calibre35">10</a></sup> For an example of such a service, see the <code class="calibre21">useForum</code> hook in <a data-type="xref" href="ch05.xhtml#ch05-02" class="calibre6">“Refresh Automatically with State Counters”</a>.</p><p data-type="footnote" id="idm46634399549096" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634399549096-marker" class="calibre35">11</a></sup> The assertion request is needed when the browser asks the user to scan their fingerprint or activate their token. It includes a list of all acceptable devices and so will be unique to a given user.</p><p data-type="footnote" id="idm46634399545880" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634399545880-marker" class="calibre35">12</a></sup> A consequence of this approach is that the user will perform single-factor authentication on the browser only where they registered the token. If they use a different browser or have recently cleared their cookies, they will have to fall back to using the login form.</p><p data-type="footnote" id="idm46634399544376" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634399544376-marker" class="calibre35">13</a></sup> This assumes that you are using a cookie that is readable by JavaScript. It’s also possible to use an HTTP-only cookie, which only the server (or service workers) can read.<a data-type="indexterm" data-primary="cookies" data-secondary="HTTP-only" id="idm46634399543624" class="calibre6"/> If you use an HTTP-only cookie, you will need code on the server to check whether the user should provide a token.</p><p data-type="footnote" id="idm46634398831896" class="calibre50"><sup class="calibre51"><a href="ch07.xhtml#idm46634398831896-marker" class="calibre35">14</a></sup> You will need to locate the Android SDK installed on your machine. You can find the <code class="calibre21">adb</code> command in a subdirectory within this installation.</p></div></div></section></div></body></html>