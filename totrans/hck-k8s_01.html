<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" class="pagenumrestart" data-pdf-bookmark="Chapter 1. Introduction"><div class="chapter" id="intro">
<h1><span class="label">Chapter 1. </span>Introduction</h1>


<p>Join us as we explore the many perilous paths through a pod and into Kubernetes.
See the system from an adversary’s perspective: get to know the multitudinous
defensive approaches and their weaknesses, and revisit historical attacks on
cloud native systems through the piratical lens of your nemesis:
Dread Pirate Captain Hashjack.</p>

<p>Kubernetes<a data-type="indexterm" data-primary="security" data-secondary="Kubernetes" id="idm45302830562736"/> has grown rapidly, and has historically not been considered to be
“secure by default.” This is mainly due to security controls<a data-type="indexterm" data-primary="security controls" id="idm45302830561456"/> such as <a data-type="indexterm" data-primary="network policies" id="idm45302830560656"/><a data-type="indexterm" data-primary="policies" data-secondary="network security" id="idm45302830559952"/>network and pod<a data-type="indexterm" data-primary="Pod Security Policies (PSPs)" id="idm45302830558880"/><a data-type="indexterm" data-primary="PSPs (Pod Security Policies)" id="idm45302830558208"/><a data-type="indexterm" data-primary="policies" data-secondary="pod security" id="idm45302830557568"/> security
policies not being enabled by default on vanilla clusters.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>As authors we are infinitely grateful that our arc saw the
<em>cloud native enlightenment</em>, and we extend our heartfelt thanks to
the volunteers, core contributors, and <a href="https://www.cncf.io">Cloud Native Computing Foundation (CNCF)</a> <a data-type="indexterm" data-primary="Cloud Native Computing Foundation (CNCF)" id="idm45302830554576"/>members involved in the vision and delivery of Kubernetes.
Documentation and bug fixes don’t write themselves, and the incredible
selfless contributions that drive open source communities have never been
more freely given or more gratefully received.</p>
</div>

<p>Security controls are generally more difficult to get right than the complex
orchestration and distributed system functionality that Kubernetes is known for. To the security teams especially, we thank you for your hard work! This book
is a reflection on the pioneering voyage of the good ship Kubernetes, out on
the choppy and dangerous free seas of the internet.</p>






<section data-type="sect1" class="less_space pagebreak-before" data-pdf-bookmark="Setting the Scene"><div class="sect1" id="idm45302830552416">
<h1>Setting the Scene</h1>

<p>For the purposes of imaginative immersion: you have just become the
chief information security officer (CISO) of the start-up freight company <em>Boats, Cranes &amp; Trains Logistics</em>, herein referred to as BCTL, which has just completed its Kubernetes 
<span class="keep-together">migration.</span></p>
<div class="clear">
<figure class="informal no-frame width-35"><div id="captain" class="figure">
<img src="Images/haku_0000.png" alt="captain" width="1086" height="1103"/>
<h6/>
</div></figure>
<p>The company has been hacked before and is “taking security seriously.” You have the authority to do what needs to be done to keep the company afloat, figuratively and literally.</p>

<p>Welcome to the job! It’s your first day, and you have been alerted to a credible threat against your cloud systems. Container-hungry pirate and generally bad egg Captain Hashjack and their clandestine hacker crew are lining up for a raid on BCTL’s Kubernetes clusters.</p>
</div>

<p>If they gain access, they’ll mine Bitcoin or cryptolock any valuable data they can find. You have not yet threat modeled your clusters and applications, or hardened them against this kind of adversary, and so we will guide you on your journey to defend them from the salty Captain’s voyage to encode, exfiltrate, or plunder whatever
valuables they can find.</p>

<p>The BCTL cluster is a vanilla Kubernetes installation
using <a href="https://oreil.ly/ONVP7">kubeadm</a>
on a public cloud provider. Initially, all <a data-type="indexterm" data-primary="kubeadm" id="idm45302830817904"/>settings are at the defaults.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Historical<a data-type="indexterm" data-primary="threats" data-secondary="types" id="idm45302830815872"/> examples of marine control system<a data-type="indexterm" data-primary="marine control systems, Hackers movie" id="idm45302830814736"/><a data-type="indexterm" data-primary="Hackers movie" id="idm45302830814000"/> instability can be seen in the film <em>Hackers</em> (1995), where <em>Ellingson Mineral Company</em>’s oil tankers fall victim to an internal attack by the company’s CISO,
<a href="https://oreil.ly/F28aj">Eugene “The Plague” Belford</a>.</p>
</div>

<p>To demonstrate hardening a <a data-type="indexterm" data-primary="clusters" data-secondary="hardening" id="idm45302830810976"/>cluster, we’ll use an example insecure system.
It’s managed by the BCTL site reliability engineering (SRE) team, which means the team is responsible for
securing the Kubernetes master nodes. This increases the potential attack surface<a data-type="indexterm" data-primary="attack surface" data-secondary="clusters" id="idm45302830809616"/><a data-type="indexterm" data-primary="clusters" data-secondary="attack surface" id="idm45302830808672"/><a data-type="indexterm" data-primary="security" data-secondary="clusters, hardening" id="idm45302830807728"/> of the
cluster: a managed service hosts the control plane (master nodes and <code>etcd</code>) separately,
and their hardened configuration prevents some attacks (like a direct <code>etcd</code> compromise),
but both approaches depend on the secure configuration of the
cluster to protect your workloads.</p>

<p>Let’s talk about your cluster. The nodes<a data-type="indexterm" data-primary="clusters" data-secondary="nodes" id="idm45302830805440"/><a data-type="indexterm" data-primary="nodes" data-secondary="clusters, security and" id="idm45302830804464"/><a data-type="indexterm" data-primary="security" data-secondary="cluster nodes" id="idm45302830803520"/><a data-type="indexterm" data-primary="public traffic, proxying" id="idm45302830802576"/><a data-type="indexterm" data-primary="proxies" data-secondary="cluster nodes, public traffic" id="idm45302830801840"/> run in a private network segment, so public (internet) traffic cannot reach them
directly. Public traffic to your cluster is proxied through an internet-facing load <a data-type="indexterm" data-primary="load balancers" data-secondary="cluster nodes, proxying" id="idm45302830800576"/>balancer: this means that the ports on your nodes
are not directly accessible to the world unless targeted by the load balancer.</p>

<p>Running on the cluster there is a SQL datastore, as well as a frontend, API, and batch processor.</p>

<p>The hosted application—a booking service for your company’s clients—is deployed
in a single namespace using <a data-type="indexterm" data-primary="GitOps" id="idm45302830798320"/>GitOps, but without a network policy or
pod security policy as discussed in <a data-type="xref" href="ch08.xhtml#ch-policy">Chapter 8</a>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>GitOps is declarative configuration deployment<a data-type="indexterm" data-primary="configuration deployment, GitOps" id="idm45302830795520"/><a data-type="indexterm" data-primary="configuration" data-secondary="management" id="idm45302830794800"/> for applications: think of it
like traditional configuration management
for Kubernetes clusters. You can read more at <a href="https://oreil.ly/y36d0">gitops.tech</a>
and learn more on how to harden Git for GitOps in
<a href="https://oreil.ly/bJgjL">this whitepaper</a>.</p>
</div>

<p><a data-type="xref" href="#system-architecture-insecure">Figure 1-1</a> shows a network diagram of the system.<a data-type="indexterm" data-primary="network diagrams, model system" id="idm45302830790800"/><a data-type="indexterm" data-primary="system architecture" data-secondary="model system" id="idm45302830790064"/></p>

<figure><div id="system-architecture-insecure" class="figure">
<img src="Images/haku_0101.png" alt="System architecture diagram" width="1587" height="638"/>
<h6><span class="label">Figure 1-1. </span>The system architecture of your new company, BCTL</h6>
</div></figure>

<p>The cluster’s RBAC was configured by engineers who have since moved on. The inherited security support services have intrusion detection and hardening, but the team has been disabling them from time to time as they were “making too much noise.” We will discuss this configuration in depth as we press on with the voyage. But first, let’s explore how to predict security threats to your clusters.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Starting to Threat Model"><div class="sect1" id="threat-models-def">
<h1>Starting to Threat Model</h1>

<p>Understanding how a system is attacked is fundamental to defending it.
A threat <a data-type="indexterm" data-primary="threat modeling" id="idm45302830784480"/>model gives you a more complete understanding of a complex system, and
provides a framework for rationalising security and risk. Threat actors
categorize the potential adversaries that a system is configured to defend against.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>A threat model is like a fingerprint: every one is different. A threat model is based upon the impact of a system’s
compromise: a Raspberry Pi hobby cluster and your bank’s clusters hold different data, have different potential
attackers, and very different potential problems if broken into.</p>
</div>

<p>Threat modeling can reveal insights into your security program and configuration, but it doesn’t solve everything—see Mark Manning’s comments on CVEs in <a data-type="xref" href="#tweet-mark-manning">Figure 1-2</a>.
You should make sure you are following basic <a data-type="indexterm" data-primary="security" data-secondary="procedures, importance of" id="idm45302830780560"/>security hygiene (like patching and testing) before considering the more advanced and technical attacks that a threat model may reveal. The same is true for any security advice.</p>

<figure class="width-60"><div id="tweet-mark-manning" class="figure">
<img src="Images/haku_0102.png" alt="Mark Manning on CVEs" width="1256" height="1236"/>
<h6><span class="label">Figure 1-2. </span>Mark Manning’s insight on vulnerability assessment and CVEs</h6>
</div></figure>

<p>If your systems can be compromised by published CVEs and a copy of <a href="https://www.kali.org">Kali Linux</a>, a threat model will not help you!</p>








<section data-type="sect2" data-pdf-bookmark="Threat Actors"><div class="sect2" id="idm45302830775840">
<h2>Threat Actors</h2>

<p>Your threat actors are <a data-type="indexterm" data-primary="threat models" data-seealso="threat actors" id="idm45302830774112"/><a data-type="indexterm" data-primary="threat actors" id="thrt_act"/>either <em>casual</em> or <em>motivated</em>. Casual <a data-type="indexterm" data-primary="adversaries" data-secondary="casual" id="adver_cas"/>adversaries include:</p>

<ul>
<li>
<p>Vandals (the graffiti kids of the internet generation)</p>
</li>
<li>
<p>Accidental trespassers looking for treasure (which is usually your data)</p>
</li>
<li>
<p>Drive-by “script kiddies,” who will run any code they find on the internet if it claims to help them hack</p>
</li>
</ul>

<p>Casual attackers shouldn’t be a concern to most systems that are patched and well <a data-type="indexterm" data-primary="adversaries" data-secondary="casual" data-startref="adver_cas" id="idm45302830765984"/>configured.</p>

<p>Motivated individuals are the ones you should worry about. They include insiders like trusted employees, organized
crime syndicates operating out of less-well-policed states, and state-sponsored actors, who may overlap with
organized crime or sponsor it directly. “Internet crimes” are not well-covered by international laws and can be hard to police.</p>

<p><a data-type="xref" href="#pod-taxonomy-of-threat-actors">Table 1-1</a> can be used<a data-type="indexterm" data-primary="threat actors" data-secondary="types" id="thrt_act_typ"/> as a guide <a data-type="indexterm" data-primary="exploits" data-secondary="threat actors" id="idm45302830759376"/>threat modeling.</p>
<table id="pod-taxonomy-of-threat-actors">
<caption><span class="label">Table 1-1. </span>Taxonomy of threat actors</caption>
<thead>
<tr>
<th>Actor</th>
<th>Motivation</th>
<th>Capability</th>
<th>Sample attacks</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>Vandal: script kiddie, trespasser</p></td>
<td><p>Curiosity, personal fame.
</p><p>Fame from<a data-type="indexterm" data-primary="attackers" data-see="adversaries" id="idm45302830751680"/><a data-type="indexterm" data-primary="adversaries" data-secondary="motivations" id="advers_motivat"/><a data-type="indexterm" data-primary="adversaries" data-secondary="capabilities" id="advers_capabl"/><a data-type="indexterm" data-primary="adversaries" data-secondary="attack types, samples" id="advers_attk_typ"/><a data-type="indexterm" data-primary="attacks" data-secondary="types, samples" id="attack_typ_samp"/> bringing down service or compromising confidential dataset of a high-profile company.</p></td>
<td><p>Uses publicly available tools and applications (Nmap, Metasploit, CVE PoCs). Some experimentation. Attacks are poorly concealed. Low level of targeting.</p></td>
<td><p>Small-scale DOS.
</p><p>Plants trojans.
</p><p>Launches prepackaged exploits for access, crypto mining.</p></td>
</tr>
<tr>
<td><p>Motivated individual: political activist, thief, terrorist</p></td>
<td><p>Personal, political, or ideological gain.
</p><p>Personal gain to be had from exfiltrating
and selling large amounts of personal data for fraud, perhaps achieved
through manipulating code in version control or artifact storage, or
exploiting vulnerable applications from knowledge gained in ticketing
and wiki systems, OSINT, or other parts of the system.
</p><p>Personal kudos from DDOS of large public-facing web service.
</p><p>Defacement of the public-facing services through manipulation of code in version control or
public servers can spread political messages amongst a large audience.</p></td>
<td><p>May combine publicly available exploits in a targeted fashion. Modify
open source supply chains. Concealing attacks of minimal concern.</p></td>
<td><p>Phishing.
</p><p>DDOS.
</p><p>Exploit known vulnerabilities to obtain sensitive data
from systems for profit and intelligence or to deface websites.
</p><p>Compromise open source projects to embed code to exfiltrate environment variables
and Secrets when code is run by users. Exported values are used to gain
system access and perform crypto mining.</p></td>
</tr>
<tr>
<td><p>Insider: employee, external contractor, temporary worker</p></td>
<td><p>Discontent, profit.
</p><p>Personal gain to be had from exfiltrating and selling large
amounts of personal data for fraud, or making small alterations to
the integrity of data in order to bypass authentication for fraud.
</p><p>Encrypt data volumes for ransom.</p></td>
<td><p>Detailed knowledge of the system, understands how to exploit it, conceals actions.</p></td>
<td><p>Uses privileges to exfiltrate data (to sell on).
</p><p>Misconfiguration/”codebombs” to take service down as retribution.</p></td>
</tr>
<tr>
<td><p>Organized crime: syndicates, state-affiliated groups</p></td>
<td><p>Ransom, mass extraction of PII/credentials/PCI data.
</p><p>Manipulation of transactions for financial gain.
</p><p>High level of motivation to access datasets or modify applications to facilitate large-scale fraud.
</p><p>Crypto-ransomware, e.g., encrypt data volumes and demand cash.</p></td>
<td><p>Ability to devote considerable resources, hire “authors” to write tools and exploits required for their means. Some ability to bribe/coerce/intimidate individuals. Level of targeting varies. Conceals until goals are met.</p></td>
<td><p>Social engineering/phishing.
</p><p>Ransomware (becoming more targeted).
</p><p>Cryptojacking.
</p><p>RATs (in decline).
</p><p>Coordinated attacks using multiple exploits, possibly
using a single zero-day or assisted by a rogue individual to pivot through
infrastructure (e.g., Carbanak).</p></td>
</tr>
<tr>
<td><p>Cloud service insider: employee, external contractor, temporary worker</p></td>
<td><p>Personal gain, curiosity.
</p><p>Unknown level of motivation, access to data
should be restricted by cloud provider’s segregation of duties and
technical controls.</p></td>
<td><p>Depends on segregation of duties and technical
controls within cloud provider.</p></td>
<td><p>Access to or manipulation of datastores.</p></td>
</tr>
<tr>
<td><p>Foreign Intelligence Services (FIS): nation states</p></td>
<td><p>Intelligence
gathering, disrupt critical national infrastructure, unknown.
</p><p>May steal intellectual property, access sensitive systems, mine personal data en masse, or track down specific individuals through location data held by the system.</p></td>
<td><p>Disrupt or modify hardware/software supply chains. Ability
to infiltrate organizations/suppliers, call upon research programs,
develop multiple zero-days. Highly targeted. High levels of concealment.</p></td>
<td><p>Stuxnet (multiple zero-days, infiltration of 3 organizations including
2 PKI infrastructures with offline root CAs).
</p><p>SUNBURST (targeted supply
chain attack, infiltration of hundreds of organizations).</p></td>
</tr>
</tbody>
</table>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Threat actors can be a hybrid of different categories. Eugene Belford, for example, was an insider who used advanced
organized crime methods.</p>
</div>

<p>Captain Hashjack<a data-type="indexterm" data-primary="threat actors" data-secondary="types" data-startref="thrt_act_typ" id="idm45302830720496"/><a data-type="indexterm" data-primary="adversaries" data-secondary="motivations" data-startref="advers_motivat" id="idm45302830719216"/><a data-type="indexterm" data-primary="adversaries" data-secondary="capabilities" data-startref="advers_capabl" id="idm45302830718000"/><a data-type="indexterm" data-primary="adversaries" data-secondary="attack types, samples" data-startref="advers_attk_typ" id="idm45302830716784"/><a data-type="indexterm" data-primary="attacks" data-secondary="types" data-tertiary="samples" data-startref="attack_typ_samp" id="idm45302830715568"/> is a motivated criminal adversary with extortion or robbery in mind. We don’t approve of their tactics—they don’t play fair, and they are a cad and a bounder—so we shall do our utmost to thwart their unwelcome interventions.</p>

<p>The pirate crew has been scouting for any advantageous information they can find online, and have already performed
reconnaissance against BCTL. Using <a data-type="indexterm" data-primary="open source" data-secondary="OSINT" id="idm45302830713152"/><a data-type="indexterm" data-primary="OSINT (open source intelligence)" id="idm45302830712176"/>open source intelligence (OSINT) techniques like searching job postings and
LinkedIn skills of current staff, they have identified technologies in use at the organization. They know you use
Kubernetes, and they can guess which version <a data-type="indexterm" data-primary="threat actors" data-startref="thrt_act" id="idm45302830711104"/>you started on.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Your First Threat Model"><div class="sect2" id="idm45302830775216">
<h2>Your First Threat Model</h2>

<p>To threat model a Kubernetes cluster, you <a data-type="indexterm" data-primary="threat modeling" data-secondary="information gathering" id="thrt_mod_info"/>start with an architecture <a data-type="indexterm" data-primary="system architecture" data-secondary="threat modeling" id="idm45302830706960"/>view of the system as shown in <a data-type="xref" href="#intro-cluster-attack-vectors">Figure 1-3</a>. Gather as much information as possible to keep everybody aligned, but there’s a balance: ensure you don’t overwhelm people with too much information.</p>

<figure><div id="intro-cluster-attack-vectors" class="figure">
<img src="Images/haku_0103.png" alt="Example Kubernetes attack vectors" width="1451" height="1236"/>
<h6><span class="label">Figure 1-3. </span>Example Kubernetes attack vectors (<a href="https://oreil.ly/3b3ql">Aqua</a>)</h6>
</div></figure>
<div data-type="tip"><h6>Tip</h6>
<p>You can learn more about<a data-type="indexterm" data-primary="resources" data-secondary="threat modeling" id="idm45302830701104"/> threat modeling Kubernetes with ControlPlane’s O’Reilly course: <a href="https://oreil.ly/Aomcl">Kubernetes Threat Modeling</a>.</p>
</div>

<p>This initial diagram might show the entire system, or you may choose to scope only one small or important area
such as a particular pod, nodes, or the control plane.</p>

<p>A threat model’s “scope” is its target: the parts of the system we’re currently most interested in.</p>

<p>Next, <a data-type="indexterm" data-primary="attack vectors" id="idm45302830697616"/>you zoom in on your scoped area. Model the <a data-type="indexterm" data-primary="data flows, diagrams" id="dataflo_diag"/><a data-type="indexterm" data-primary="trust boundaries" data-secondary="threat modeling" id="idm45302830695744"/>data flows and trust boundaries between components in a data flow
diagram like <a data-type="xref" href="#intro-cluster-attack-vectors">Figure 1-3</a>. When deciding on trust boundaries, think about how Captain Hashjack
might try to attack components.</p>
<blockquote>
<p>An exhaustive list of possibilities is better than a partial list of feasibilities.</p>
<p data-type="attribution">Adam Shostack, <cite><em>Threat Modeling</em></cite></p>
</blockquote>

<p>Now that you know who you are defending against, you can enumerate some high-level threats against the system and start to
check if your security configuration is suitable to defend against them.</p>

<p>To generate possible threats you must internalize the attacker mindset: emulate
their instincts and preempt their tactics. The humble data flow diagram
in <a data-type="xref" href="#intro-k8s-dfd">Figure 1-4</a> is the defensive map of your silicon fortress,
and it must be able to withstand Hashjack and their murky ilk.</p>

<figure><div id="intro-k8s-dfd" class="figure">
<img src="Images/haku_0104.png" alt="Kubernetes data flow diagram" width="1801" height="774"/>
<h6><span class="label">Figure 1-4. </span>Kubernetes data flow diagram (<a href="https://oreil.ly/J8INO">GitHub</a>)</h6>
</div></figure>
<div data-type="tip"><h6>Tip</h6>
<p>Threat <a data-type="indexterm" data-primary="data flows, diagrams" data-startref="dataflo_diag" id="idm45302830685584"/>modeling should be performed with as many stakeholders as<a data-type="indexterm" data-primary="threat modeling" data-secondary="stakeholders" id="idm45302830684448"/><a data-type="indexterm" data-primary="stakeholders, threat modeling" id="idm45302830683504"/> possible (development, operations,
QA, product, business stakeholders, security) to ensure diversity of thought.</p>

<p>You should try to build the first version of a <a data-type="indexterm" data-primary="threat models" data-secondary="initial version" id="idm45302830682064"/>threat model without outside influence to allow fluid discussion and
organic idea generation. Then you can pull in external sources to cross-check the group’s thinking.</p>
</div>

<p>Now that you have all the information you can gather on your system, you brainstorm. Think of simplicity,
deviousness, and cunning. Any conceivable attack is in scope, and you will judge
the likelihood of the attack separately. Some people like to use scores and
weighted numbers for this, others prefer to rationalize the attack paths instead.</p>

<p>Capture your thoughts in a spreadsheet, mindmap, a list, or however makes sense to you. There are no rules, only
trying, learning, and iterating on your own version of the process. Try to categorize <a data-type="indexterm" data-primary="categorizing threats" id="idm45302830679264"/>threats, and make sure you can review your
captured data easily. Once you’ve done the first pass, consider what you’ve missed and have a quick second pass.</p>

<p>Then you’ve generated your initial threats—good job! Now it’s time to plot them on a graph so they’re easier to
understand. This is the job of an attack tree: the pirate’s treasure<a data-type="indexterm" data-primary="threat modeling" data-secondary="information gathering" data-startref="thrt_mod_info" id="idm45302830677664"/> map.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Attack Trees"><div class="sect1" id="idm45302830709440">
<h1>Attack Trees</h1>

<p>An attack tree<a data-type="indexterm" data-primary="attack trees" id="attck_tree"/><a data-type="indexterm" data-primary="threat modeling" data-secondary="attack trees" id="tm_attck_tree"/> shows potential infiltration vectors. <a data-type="xref" href="#intro-k8s-attack-tree">Figure 1-5</a> models how to take down the Kubernetes control plane.</p>

<p>Attack trees can be complex and span multiple pages, so you can start small like this branch of reduced scope.</p>

<p>This attack tree focuses on denial of service (DoS), which prevents (“denies”) access to the system (“service”). The
attacker’s goal is at the top of the diagram, and the routes available to them start at the root (bottom) of the tree.
The key on the left shows the shapes required for logical “OR” and “AND” nodes to be fulfilled, which build up to the
top of the tree: the negative outcome. Confusingly, attack trees can be bottom-up or top-down: in this book we
exclusively use bottom-up. We walk through attack trees later in this chapter.</p>

<figure><div id="intro-k8s-attack-tree" class="figure">
<img src="Images/haku_0105.png" alt="Kubernetes attack tree" width="1133" height="879"/>
<h6><span class="label">Figure 1-5. </span>Kubernetes attack tree (<a href="https://oreil.ly/J8INO">GitHub</a>)</h6>
</div></figure>
<div data-type="tip"><h6>Tip</h6>
<p><a href="https://oreil.ly/BnOKx">Kelly Shortridge</a>’s in-browser security decision tree tool <a href="https://oreil.ly/qALgH">Deciduous</a> can be used to<a data-type="indexterm" data-primary="Deciduous" id="idm45302830665088"/><a data-type="indexterm" data-primary="attack trees" data-secondary="Deciduous" id="idm45302830664352"/> generate these attack trees as code.</p>
</div>

<p>As we progress through the book, we’ll use these techniques to identify high-risk areas of Kubernetes and consider the
impact of successful <a data-type="indexterm" data-primary="attack trees" data-startref="attck_tree" id="idm45302830662608"/><a data-type="indexterm" data-primary="threat modeling" data-secondary="attack trees" data-startref="tm_attck_tree" id="idm45302830661632"/>attacks.</p>
<div data-type="tip"><h6>Tip</h6>
<p>A YAML deserialization <em>Billion laughs</em> attack in <a href="https://oreil.ly/8BOcs">CVE-2019-11253</a>
affected Kubernetes to v1.16.1 by attacking
the API server. It’s not covered on<a data-type="indexterm" data-primary="historical attacks, attack trees and" id="idm45302830658112"/><a data-type="indexterm" data-primary="attack trees" data-secondary="historical attacks and" id="idm45302830657344"/> this attack tree as it’s patched, but adding historical attacks to your attack
trees is a useful way to acknowledge their threat if you think there’s a high chance they’ll reoccur in your 
<span class="keep-together">system.</span></p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Example Attack Trees"><div class="sect1" id="idm45302830655280">
<h1>Example Attack Trees</h1>

<p>It’s also useful <a data-type="indexterm" data-primary="attack trees" data-secondary="legends" id="idm45302830653712"/>to draw attack trees to conceptualize how the system may be attacked and make the controls easier to
reason about. Fortunately, our initial threat model contains some useful examples.</p>

<p>These diagrams use a simple legend, described in <a data-type="xref" href="#pod-attack-tree-legend">Figure 1-6</a>.</p>

<figure><div id="pod-attack-tree-legend" class="figure">
<img src="Images/haku_0106.png" alt="Attack Tree Legend" width="230" height="405"/>
<h6><span class="label">Figure 1-6. </span>Attack tree legend</h6>
</div></figure>

<p>The “Goal” is an attacker’s objective, and what we are building the attack tree to understand how to prevent.</p>

<p>The logical “AND” and “OR” gates define which of the child nodes need completing to progress through them.</p>

<p>In <a data-type="xref" href="#pod-attack-tree-compromised-container">Figure 1-7</a> you see an attack tree starting with
a threat actor’s remote code execution in a<a data-type="indexterm" data-primary="attack trees" data-secondary="compromised containers" id="attck_tree_compcont"/> container.</p>

<figure><div id="pod-attack-tree-compromised-container" class="figure">
<img src="Images/haku_0107.png" alt="Attack Tree: Compromised Container" width="838" height="1333"/>
<h6><span class="label">Figure 1-7. </span>Attack tree: compromised container</h6>
</div></figure>

<p>You now know what you want to protect against and have some simple attack trees,
so you can quantify the controls you want to<a data-type="indexterm" data-primary="attack trees" data-secondary="compromised containers" data-startref="attck_tree_compcont" id="idm45302830642928"/> use.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Prior Art"><div class="sect1" id="PriorArt">
<h1>Prior Art</h1>

<p>At this point, your <a data-type="indexterm" data-primary="threat modeling" data-secondary="common techniques" id="idm45302830639584"/>team has generated a list of threats. We can now cross-reference them against some commonly used threat modeling techniques and attack <a data-type="indexterm" data-primary="STRIDE" id="idm45302830638304"/><a data-type="indexterm" data-primary="Microsoft Kubernetes Threat Matrix" id="idm45302830637632"/><a data-type="indexterm" data-primary="MITRE ATT&amp;CK Matrix for Containers" id="idm45302830636944"/><a data-type="indexterm" data-primary="OWASP Docker Top 10" id="idm45302830636256"/>data:</p>

<ul>
<li>
<p><a href="https://oreil.ly/M9rEq">STRIDE</a> (framework to enumerate possible threats)</p>
</li>
<li>
<p><a href="https://oreil.ly/YUaS3">Microsoft Kubernetes Threat Matrix</a></p>
</li>
<li>
<p><a href="https://oreil.ly/IV2TO">MITRE ATT&amp;CK® Matrix for Containers</a></p>
</li>
<li>
<p><a href="https://oreil.ly/1EySd">OWASP Docker Top 10</a></p>
</li>
</ul>

<p>This is also a good time to draw on<a data-type="indexterm" data-primary="threat models" data-secondary="preexisting" id="idm45302830629056"/><a data-type="indexterm" data-primary="Trail of Bits, threat models" id="idm45302830628080"/><a data-type="indexterm" data-primary="ControlPlane, threat models" id="idm45302830627344"/><a data-type="indexterm" data-primary="Atredis Partners, threat models" id="idm45302830626656"/><a data-type="indexterm" data-primary="Kubernetes Threat Model (Trail of Bits and Atredis Partners)" id="idm45302824878080"/><a data-type="indexterm" data-primary="NCC, threat models" id="idm45302824877472"/><a data-type="indexterm" data-primary="Threat Model and Controls (NCC)" id="idm45302824876800"/> preexisting, generalized threat models that may exist:</p>

<ul>
<li>
<p><a href="https://oreil.ly/EcBuQ">Trail of Bits</a> and <a href="https://oreil.ly/p6yeJ">Atredis Partners</a> <a href="https://oreil.ly/qNvIm">Kubernetes Threat Model</a> for the Kubernetes Security Audit Working Group (now <a href="https://oreil.ly/i8Yy0">SIG-security</a>) and <a href="https://oreil.ly/3WTvR">associated security findings</a>, examining the Kubernetes codebase and how to attack the orchestrator</p>
</li>
<li>
<p><a href="https://oreil.ly/nrx8O">ControlPlane’s</a> <a href="https://oreil.ly/L640h">Kubernetes Threat Model and Attack Trees</a> for the <a href="https://oreil.ly/ETgu4">CNCF Financial Services User Group</a>, considering a user’s usage and hardened configuration of 
<span class="keep-together">Kubernetes</span></p>
</li>
<li>
<p><a href="https://oreil.ly/HOeio">NCC’s</a> <a href="https://oreil.ly/J6VxA">Threat Model and Controls</a> looking at system configuration</p>
</li>
</ul>

<p>No threat model is ever complete. It is a point-in-time best effort from your stakeholders and should be regularly revised and updated, as the architecture, software, and external threats will continually change.</p>
<blockquote>
<p>Software is never finished. You can’t just stop working on it. It is part of an ecosystem that is moving.</p>
<p data-type="attribution">Moxie Marlinspike</p>
</blockquote>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="idm45302824863072">
<h1>Conclusion</h1>

<p>Now you are equipped with the basics: you know your adversary, Captain Hashjack, and their capabilities. You understand
what a threat model is, why it’s essential, and how to get to the point where you have a 360° view on your system. In this
chapter we further discussed threat actors and attack trees and walked through a concrete example. We have a model in
mind now so we’ll explore each of the main Kubernetes areas of interest. Let’s jump into the deep end: we start with the
pod.</p>
</div></section>







</div></section></div></body></html>