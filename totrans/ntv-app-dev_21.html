<html><head></head><body><section data-pdf-bookmark="Chapter 19. And Yet, We Persisted" data-type="chapter" epub:type="chapter"><div class="chapter" id="app_database">&#13;
<h1><span class="label">Chapter 19. </span>And Yet, We Persisted</h1>&#13;
&#13;
&#13;
<p>If we take stock of where we are with our app so far, it’s come along quite nicely. We’ve got some solid functionality. The data being pulled is backed by a portable format, specifically JSON, and it’s functionally sound. This is a great starting place to take our app further.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Detailing Our Books" data-type="sect1"><div class="sect1" id="idm46177204057512">&#13;
<h1>Detailing Our Books</h1>&#13;
&#13;
<p>First, we should add a new screen to show some more information on a book. Right now, there really isn’t a way to view anything of importance about our books other than the title. And guess what? Books have a TON of information about them. Everything from title, author, ISBN, the list goes on! In fact, some of the most usable information about a book is contained in this information.</p>&#13;
&#13;
<p>We know we’ll display a book. Specifically, the information currently available in our book model object, <code>Book</code>, is the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>title</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>authors</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>isbn</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>pageCount</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>fiction</code></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>That’s not tons of data, but it’s enough. Plus, we’re going to expand on this screen in a bit, but for now let’s add something quickly in Android and iOS.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Android" data-type="sect2"><div class="sect2" id="idm46177204048168">&#13;
<h2>Android</h2>&#13;
&#13;
<p>If<a data-primary="application persistence" data-secondary="Android" data-tertiary="adding detailed data to applications" data-type="indexterm" id="APandetail19"/><a data-primary="persistence" data-secondary="Android" data-tertiary="adding detailed data to applications" data-type="indexterm" id="Panddetail19"/><a data-primary="Android" data-secondary="persistence" data-tertiary="adding detailed data to applications" data-type="indexterm" id="Aperdetail19"/> you recall <a data-type="xref" href="ch02.html#topics_views">Chapter 2</a> and <a data-type="xref" href="ch15.html#app_setup">Chapter 15</a>, what follows should be very familiar.</p>&#13;
&#13;
<p>First, let’s define our layout using XML. We know we want to show each of the <code>Book</code> instances properties, so let’s just list them out in a vertical fashion that we’ll decorate programmatically. Again, we’ll want to make sure our <code>LinearLayout</code> is wrapped in a <code>ScrollView</code> so that we can show all our information regardless of screen size, device density, or accessibility settings like large font rendering.</p>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</code>&#13;
<code class="nt">&lt;ScrollView</code>&#13;
    <code class="na">xmlns:android=</code><code class="s">"http://schemas.android.com/apk/res/android"</code>&#13;
    <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
    <code class="na">android:layout_height=</code><code class="s">"match_parent"</code>&#13;
    <code class="na">android:background=</code><code class="s">"@android:color/white"</code><code class="nt">&gt;</code>&#13;
&#13;
  <code class="nt">&lt;LinearLayout</code>&#13;
      <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
      <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code>&#13;
      <code class="na">android:orientation=</code><code class="s">"vertical"</code><code class="nt">&gt;</code>&#13;
&#13;
    <code class="nt">&lt;TextView</code>&#13;
        <code class="na">android:id=</code><code class="s">"@+id/textview_title"</code>&#13;
        <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
        <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code> <code class="nt">/&gt;</code>&#13;
&#13;
    <code class="nt">&lt;TextView</code>&#13;
        <code class="na">android:id=</code><code class="s">"@+id/textview_authors"</code>&#13;
        <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
        <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code> <code class="nt">/&gt;</code>&#13;
&#13;
    <code class="nt">&lt;TextView</code>&#13;
        <code class="na">android:id=</code><code class="s">"@+id/textview_isbn"</code>&#13;
        <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
        <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code> <code class="nt">/&gt;</code>&#13;
&#13;
    <code class="nt">&lt;TextView</code>&#13;
        <code class="na">android:id=</code><code class="s">"@+id/textview_pagecount"</code>&#13;
        <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
        <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code> <code class="nt">/&gt;</code>&#13;
&#13;
    <code class="nt">&lt;TextView</code>&#13;
        <code class="na">android:id=</code><code class="s">"@+id/textview_isfiction"</code>&#13;
        <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
        <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code> <code class="nt">/&gt;</code>&#13;
&#13;
  <code class="nt">&lt;/LinearLayout&gt;</code>&#13;
&#13;
<code class="nt">&lt;/ScrollView&gt;</code></pre>&#13;
&#13;
<p>Let’s save the preceding code as <em>res/layout/activity_detail.xml</em>.</p>&#13;
&#13;
<p>Since we want these <code>TextViews</code> to show complete labels, we’ll introduce the concept of placeholder <code>Strings</code> in your <em>strings.xml</em> file. A placeholder string just accepts special formatting characters and allows them to be replaced with variables. Read up on Java’s <code>String.format</code> method for details.</p>&#13;
&#13;
<p>In <em>strings.xml</em>, let’s add some placeholders:</p>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;string</code> <code class="na">name=</code><code class="s">"detail_title"</code><code class="nt">&gt;</code>Book Title: %s<code class="nt">&lt;/string&gt;</code>&#13;
<code class="nt">&lt;string</code> <code class="na">name=</code><code class="s">"detail_authors"</code><code class="nt">&gt;</code>Book Authors: %s<code class="nt">&lt;/string&gt;</code>&#13;
<code class="nt">&lt;string</code> <code class="na">name=</code><code class="s">"detail_isbn"</code><code class="nt">&gt;</code>Book ISBN: %s<code class="nt">&lt;/string&gt;</code>&#13;
<code class="nt">&lt;string</code> <code class="na">name=</code><code class="s">"detail_pagecount"</code><code class="nt">&gt;</code>Book Page Count: %d<code class="nt">&lt;/string&gt;</code>&#13;
<code class="nt">&lt;string</code> <code class="na">name=</code><code class="s">"detail_isfiction"</code><code class="nt">&gt;</code>Book : %b<code class="nt">&lt;/string&gt;</code></pre>&#13;
&#13;
<p>Next, we need a UI controller to show, control, and modify the layout, as well as provide behavior instructions. In our case, an <code>Activity</code>.</p>&#13;
&#13;
<p>We’ll want to pass this UI controller some information about the <code>Book</code>, and in Android, this is where things can get contentious. An <code>Activity</code> is created programmatically and opaquely, but as described in <a data-type="xref" href="ch01.html#topics_ui_controllers">Chapter 1</a>, we can pass some primitive data via a <code>Bundle</code> instance with the <code>Intent</code> that starts the controller.</p>&#13;
&#13;
<p>For an example like this, you’ll find two schools of thought. Sometimes, one makes much more sense than the other, but a lot of the time it’s really up to you and your team. And feel free to experiment with other approaches besides those details—in fact our current teams use a very different, very custom approach to solve this problem that’s beyond the scope of this chapter.</p>&#13;
&#13;
<p>So, approach number 1: you can serialize the whole object and pass it along as a <code>String</code> (or <code>byte[]</code>) and deserialize it in the new controller. This makes things pretty straightforward, but remember that <code>Bundle</code> is limited to 1 MB in size and is shared between any number of operations, potentially ones you have no knowledge of.</p>&#13;
&#13;
<p>The second approach is to pass some kind of unique identifier, like an ID number or a URI, and then retrieve the information in full from another source, like a local database, JSON store, or even remote server.</p>&#13;
&#13;
<p>For simplicity for this example, and just for now, we’ll use the first approach. This <code>Activity</code> will expect a JSON <code>String</code> representing a serialized <code>Book</code> object in its <code>Intent</code> object as an “extra”—let’s call the <code>String</code> extra “BOOK_JSON” and save it in a constant. We’ll deserialize it during the <code>onCreate</code> callback and<a data-primary="Java" data-secondary="persistence" data-tertiary="adding detailed data to applications" data-type="indexterm" id="Jperdetail19"/><a data-primary="Kotlin" data-secondary="persistence" data-tertiary="adding detailed data to applications" data-type="indexterm" id="Kperdetail19"/> decorate our view with those properties.</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177203893272">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">BookDetailActivity</code> <code class="kd">extends</code> <code class="n">Activity</code> <code class="o">{</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOK_JSON</code> <code class="o">=</code> <code class="s">"BOOK_JSON"</code><code class="o">;</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">onCreate</code><code class="o">(</code><code class="n">Bundle</code> <code class="n">savedInstanceState</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="kd">super</code><code class="o">.</code><code class="na">onCreate</code><code class="o">(</code><code class="n">savedInstanceState</code><code class="o">);</code>&#13;
    <code class="n">setContentView</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">layout</code><code class="o">.</code><code class="na">activity_detail</code><code class="o">);</code>&#13;
&#13;
    <code class="c1">// get the book instance from the serialized string</code>&#13;
    <code class="n">String</code> <code class="n">json</code> <code class="o">=</code> <code class="n">getIntent</code><code class="o">().</code><code class="na">getStringExtra</code><code class="o">(</code><code class="n">BOOK_JSON</code><code class="o">);</code>&#13;
    <code class="n">Book</code> <code class="n">book</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Gson</code><code class="o">().</code><code class="na">fromJson</code><code class="o">(</code><code class="n">json</code><code class="o">,</code> <code class="n">Book</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
&#13;
    <code class="c1">// now decorate our detail view</code>&#13;
    <code class="n">Resources</code> <code class="n">resources</code> <code class="o">=</code> <code class="n">getResources</code><code class="o">();</code>&#13;
&#13;
    <code class="n">String</code> <code class="n">title</code> <code class="o">=</code> <code class="n">resources</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">string</code><code class="o">.</code><code class="na">detail_title</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">getTitle</code><code class="o">());</code>&#13;
    <code class="o">((</code><code class="n">TextView</code><code class="o">)</code> <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">textview_title</code><code class="o">)).</code><code class="na">setText</code><code class="o">(</code><code class="n">title</code><code class="o">);</code>&#13;
&#13;
    <code class="n">String</code> <code class="n">authors</code> <code class="o">=</code> <code class="n">TextUtils</code><code class="o">.</code><code class="na">join</code><code class="o">(</code><code class="s">", "</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">getAuthors</code><code class="o">());</code>&#13;
    <code class="n">authors</code> <code class="o">=</code> <code class="n">resources</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">string</code><code class="o">.</code><code class="na">detail_authors</code><code class="o">,</code> <code class="n">authors</code><code class="o">);</code>&#13;
    <code class="o">((</code><code class="n">TextView</code><code class="o">)</code> <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">textview_authors</code><code class="o">)).</code><code class="na">setText</code><code class="o">(</code><code class="n">authors</code><code class="o">);</code>&#13;
&#13;
    <code class="n">String</code> <code class="n">isbn</code> <code class="o">=</code> <code class="n">resources</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">string</code><code class="o">.</code><code class="na">detail_isbn</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">getIsbn</code><code class="o">());</code>&#13;
    <code class="o">((</code><code class="n">TextView</code><code class="o">)</code> <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">textview_isbn</code><code class="o">)).</code><code class="na">setText</code><code class="o">(</code><code class="n">isbn</code><code class="o">);</code>&#13;
&#13;
    <code class="n">String</code> <code class="n">pageCount</code> <code class="o">=</code> <code class="n">resources</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">string</code><code class="o">.</code><code class="na">detail_pagecount</code><code class="o">,</code>&#13;
    <code class="n">book</code><code class="o">.</code><code class="na">getPageCount</code><code class="o">());</code>&#13;
    <code class="o">((</code><code class="n">TextView</code><code class="o">)</code> <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">textview_pagecount</code><code class="o">)).</code><code class="na">setText</code><code class="o">(</code><code class="n">pageCount</code><code class="o">);</code>&#13;
&#13;
    <code class="n">String</code> <code class="n">fiction</code> <code class="o">=</code> <code class="n">resources</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">string</code><code class="o">.</code><code class="na">detail_isfiction</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">isFiction</code><code class="o">());</code>&#13;
    <code class="o">((</code><code class="n">TextView</code><code class="o">)</code> <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">textview_isfiction</code><code class="o">)).</code><code class="na">setText</code><code class="o">(</code><code class="n">fiction</code><code class="o">);</code>&#13;
&#13;
  <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">BookDetailActivity</code> <code class="p">:</code> <code class="n">Activity</code><code class="p">()</code> <code class="p">{</code>&#13;
&#13;
  <code class="n">companion</code> <code class="nb">object</code> <code class="p">{</code>&#13;
    <code class="n">val</code> <code class="n">BOOK_JSON</code> <code class="o">=</code> <code class="s2">"BOOK_JSON"</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="n">override</code> <code class="n">fun</code> <code class="n">onCreate</code><code class="p">(</code><code class="n">savedInstanceState</code><code class="p">:</code> <code class="n">Bundle</code><code class="err">?</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nb">super</code><code class="o">.</code><code class="n">onCreate</code><code class="p">(</code><code class="n">savedInstanceState</code><code class="p">)</code>&#13;
    <code class="n">setContentView</code><code class="p">(</code><code class="n">R</code><code class="o">.</code><code class="n">layout</code><code class="o">.</code><code class="n">activity_detail</code><code class="p">)</code>&#13;
    <code class="o">//</code> <code class="n">get</code> <code class="n">the</code> <code class="n">book</code> <code class="n">instance</code> <code class="kn">from</code> <code class="nn">the</code> <code class="nn">serialized</code> <code class="nn">string</code>&#13;
    <code class="n">val</code> <code class="n">json</code> <code class="o">=</code> <code class="n">intent</code><code class="o">.</code><code class="n">getStringExtra</code><code class="p">(</code><code class="n">BOOK_JSON</code><code class="p">)</code>&#13;
    <code class="n">val</code> <code class="n">book</code> <code class="o">=</code> <code class="n">Gson</code><code class="p">()</code><code class="o">.</code><code class="n">fromJson</code><code class="p">(</code><code class="n">json</code><code class="p">,</code> <code class="n">Book</code><code class="p">::</code><code class="n">class</code><code class="o">.</code><code class="n">java</code><code class="p">)</code>&#13;
    <code class="o">//</code> <code class="n">now</code> <code class="n">decorate</code> <code class="n">our</code> <code class="n">detail</code> <code class="n">view</code>&#13;
    <code class="n">textview_title</code><code class="o">.</code><code class="n">text</code> <code class="o">=</code> <code class="n">resources</code><code class="o">.</code><code class="n">getString</code><code class="p">(</code><code class="n">R</code><code class="o">.</code><code class="n">string</code><code class="o">.</code><code class="n">detail_title</code><code class="p">,</code> <code class="n">book</code><code class="o">.</code><code class="n">title</code><code class="p">)</code>&#13;
    <code class="n">textview_authors</code><code class="o">.</code><code class="n">text</code> <code class="o">=</code> <code class="n">resources</code><code class="o">.</code><code class="n">getString</code><code class="p">(</code><code class="n">R</code><code class="o">.</code><code class="n">string</code><code class="o">.</code><code class="n">detail_authors</code><code class="p">,</code>&#13;
      <code class="n">TextUtils</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="s2">", "</code><code class="p">,</code> <code class="n">book</code><code class="o">.</code><code class="n">authors</code><code class="p">))</code>&#13;
    <code class="n">textview_isbn</code><code class="o">.</code><code class="n">text</code> <code class="o">=</code> <code class="n">resources</code><code class="o">.</code><code class="n">getString</code><code class="p">(</code><code class="n">R</code><code class="o">.</code><code class="n">string</code><code class="o">.</code><code class="n">detail_isbn</code><code class="p">,</code> <code class="n">book</code><code class="o">.</code><code class="n">isbn</code><code class="p">)</code>&#13;
    <code class="n">textview_pagecount</code><code class="o">.</code><code class="n">text</code> <code class="o">=</code> <code class="n">resources</code><code class="o">.</code><code class="n">getString</code><code class="p">(</code><code class="n">R</code><code class="o">.</code><code class="n">string</code><code class="o">.</code><code class="n">detail_pagecount</code><code class="p">,</code>&#13;
    <code class="n">book</code><code class="o">.</code><code class="n">pageCount</code><code class="p">)</code>&#13;
    <code class="n">textview_isfiction</code><code class="o">.</code><code class="n">text</code> <code class="o">=</code> <code class="n">resources</code><code class="o">.</code><code class="n">getString</code><code class="p">(</code><code class="n">R</code><code class="o">.</code><code class="n">string</code><code class="o">.</code><code class="n">detail_isfiction</code><code class="p">,</code>&#13;
    <code class="n">book</code><code class="o">.</code><code class="n">isFiction</code><code class="p">)</code>&#13;
  <code class="p">}</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>Of course, let’s not forget to register this new <code>Activity</code> with our manifest:</p>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;activity</code> <code class="na">android:name=</code><code class="s">".BookDetailActivity"</code> <code class="nt">/&gt;</code></pre>&#13;
&#13;
<p>Great! We’ve got an <code>Activity</code> with a UI that will display all the details we have for a <code>Book</code> instance. Let’s jump back to the list view from <a data-type="xref" href="ch17.html#app_lists">Chapter 17</a> and wire up a tap event to pass the selected <code>Book</code> instance from the <code>BrowseContentActivity</code> to our new <code>BookDetailActivity</code>. First, we’ll want to make sure our row (just a <code>TextView</code> at the moment) has a <code>View.OnClickListener</code> to bundle up its associated <code>Book</code> instance and start the <code>BookDetailActivity</code>. We can do this once, in the creation phase—the <code>onCreateViewHolder</code> method. Since these <code>Views</code> are recycled, we just need to make sure we update that association with the appropriate book, which we can do in the bind and update cycle, represented by the <code>onBindViewHolder</code> method.</p>&#13;
&#13;
<p>Your new <code>BrowseBooksAdapter</code> should look like this:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177203294344">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code>&#13;
  <code class="nc">BrowseBooksAdapter</code> <code class="kd">extends</code> <code class="n">RecyclerView</code><code class="o">.</code><code class="na">Adapter</code><code class="o">&lt;</code><code class="n">BrowseBooksAdapter</code><code class="o">.</code><code class="na">ViewHolder</code><code class="o">&gt;</code> <code class="o">{</code>&#13;
&#13;
  <code class="kd">private</code> <code class="kd">final</code> <code class="n">BookDataSource</code> <code class="n">mSource</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="nf">BrowseBookAdapter</code><code class="o">(</code><code class="n">BookDataSource</code> <code class="n">source</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="kd">super</code><code class="o">();</code>&#13;
    <code class="n">mSource</code> <code class="o">=</code> <code class="n">source</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">public</code> <code class="n">ViewHolder</code> <code class="nf">onCreateViewHolder</code><code class="o">(</code><code class="n">ViewGroup</code> <code class="n">parent</code><code class="o">,</code> <code class="kt">int</code> <code class="n">viewType</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="k">new</code> <code class="nf">ViewHolder</code><code class="o">(</code><code class="k">new</code> <code class="n">TextView</code><code class="o">(</code><code class="n">parent</code><code class="o">.</code><code class="na">getContext</code><code class="o">()));</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">onBindViewHolder</code><code class="o">(</code><code class="n">ViewHolder</code> <code class="n">holder</code><code class="o">,</code> <code class="kt">int</code> <code class="n">position</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">Book</code> <code class="n">book</code> <code class="o">=</code> <code class="n">mSource</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">position</code><code class="o">);</code>&#13;
    <code class="n">holder</code><code class="o">.</code><code class="na">mTextView</code><code class="o">.</code><code class="na">setTag</code><code class="o">(</code><code class="n">book</code><code class="o">);</code>&#13;
    <code class="n">holder</code><code class="o">.</code><code class="na">mTextView</code><code class="o">.</code><code class="na">setText</code><code class="o">(</code><code class="n">book</code><code class="o">.</code><code class="na">getTitle</code><code class="o">());</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">public</code> <code class="kt">int</code> <code class="nf">getItemCount</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">mSource</code><code class="o">.</code><code class="na">size</code><code class="o">();</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">class</code> <code class="nc">ViewHolder</code> <code class="kd">extends</code> <code class="n">RecyclerView</code><code class="o">.</code><code class="na">ViewHolder</code> <code class="o">{</code>&#13;
    <code class="kd">private</code> <code class="n">TextView</code> <code class="n">mTextView</code><code class="o">;</code>&#13;
    <code class="kd">public</code> <code class="nf">ViewHolder</code><code class="o">(</code><code class="nd">@NonNull</code> <code class="n">View</code> <code class="n">itemView</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="kd">super</code><code class="o">(</code><code class="n">itemView</code><code class="o">);</code>&#13;
      <code class="n">mTextView</code> <code class="o">=</code> <code class="o">(</code><code class="n">TextView</code><code class="o">)</code> <code class="n">itemView</code><code class="o">;</code>&#13;
      <code class="n">mTextView</code><code class="o">.</code><code class="na">setOnClickListener</code><code class="o">(</code><code class="k">this</code><code class="o">::</code><code class="n">showBook</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
    <code class="kd">private</code> <code class="kt">void</code> <code class="nf">showBook</code><code class="o">(</code><code class="n">View</code> <code class="n">view</code><code class="o">)</code> <code class="o">{</code>&#13;
     <code class="n">Book</code> <code class="n">book</code> <code class="o">=</code> <code class="o">(</code><code class="n">Book</code><code class="o">)</code> <code class="n">view</code><code class="o">.</code><code class="na">getTag</code><code class="o">();</code>&#13;
     <code class="n">String</code> <code class="n">json</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Gson</code><code class="o">().</code><code class="na">toJson</code><code class="o">(</code><code class="n">book</code><code class="o">);</code>&#13;
     <code class="n">Intent</code> <code class="n">intent</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Intent</code><code class="o">(</code><code class="n">view</code><code class="o">.</code><code class="na">context</code><code class="o">,</code> <code class="n">BookDetailActivity</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
     <code class="n">intent</code><code class="o">.</code><code class="na">putExtra</code><code class="o">(</code><code class="n">BookDetailActivity</code><code class="o">.</code><code class="na">BOOK_JSON</code><code class="o">,</code> <code class="n">json</code><code class="o">);</code>&#13;
     <code class="n">view</code><code class="o">.</code><code class="na">getContext</code><code class="o">().</code><code class="na">startActivity</code><code class="o">(</code><code class="n">intent</code><code class="o">);</code>&#13;
   <code class="o">}</code>&#13;
  <code class="o">}</code>&#13;
&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">BrowseBooksAdapter</code><code class="p">(</code><code class="k">private</code> <code class="k">val</code> <code class="py">source</code><code class="p">:</code> <code class="n">BookDataSource</code><code class="p">)</code> <code class="p">:</code>&#13;
  <code class="n">RecyclerView</code><code class="p">.</code><code class="n">Adapter</code><code class="p">&lt;</code><code class="n">BrowseBooksAdapter</code><code class="p">.</code><code class="n">ViewHolder</code><code class="p">&gt;()</code> <code class="p">{</code>&#13;
&#13;
  <code class="k">override</code> <code class="k">fun</code> <code class="nf">onCreateViewHolder</code><code class="p">(</code><code class="n">parent</code><code class="p">:</code> <code class="n">ViewGroup</code><code class="p">,</code> <code class="n">viewType</code><code class="p">:</code> <code class="n">Int</code><code class="p">):</code> <code class="n">ViewHolder</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">ViewHolder</code><code class="p">(</code><code class="n">TextView</code><code class="p">(</code><code class="n">parent</code><code class="p">.</code><code class="n">context</code><code class="p">))</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">override</code> <code class="k">fun</code> <code class="nf">onBindViewHolder</code><code class="p">(</code><code class="n">holder</code><code class="p">:</code> <code class="n">ViewHolder</code><code class="p">,</code> <code class="n">position</code><code class="p">:</code> <code class="n">Int</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">book</code> <code class="p">=</code> <code class="n">source</code><code class="p">.</code><code class="k">get</code><code class="p">(</code><code class="n">position</code><code class="p">)</code>&#13;
    <code class="n">holder</code><code class="p">.</code><code class="n">textView</code><code class="p">.</code><code class="n">tag</code> <code class="p">=</code> <code class="n">book</code>&#13;
    <code class="n">holder</code><code class="p">.</code><code class="n">textView</code><code class="p">.</code><code class="n">text</code> <code class="p">=</code> <code class="n">book</code><code class="p">.</code><code class="n">title</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">override</code> <code class="k">fun</code> <code class="nf">getItemCount</code><code class="p">():</code> <code class="n">Int</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="n">source</code><code class="p">.</code><code class="n">size</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">class</code> <code class="nc">ViewHolder</code><code class="p">(</code><code class="n">itemView</code><code class="p">:</code> <code class="n">View</code><code class="p">)</code> <code class="p">:</code> <code class="n">RecyclerView</code><code class="p">.</code><code class="n">ViewHolder</code><code class="p">(</code><code class="n">itemView</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">textView</code><code class="p">:</code> <code class="n">TextView</code> <code class="p">=</code> <code class="n">itemView</code> <code class="k">as</code> <code class="n">TextView</code>&#13;
    <code class="n">init</code> <code class="p">{</code>&#13;
      <code class="n">textView</code><code class="p">.</code><code class="n">setOnClickListener</code> <code class="p">{</code> <code class="n">v</code> <code class="p">-&gt;</code> <code class="n">showBook</code><code class="p">(</code><code class="n">v</code><code class="p">)</code> <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">private</code> <code class="k">fun</code> <code class="nf">showBook</code><code class="p">(</code><code class="n">view</code><code class="p">:</code> <code class="n">View</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="k">val</code> <code class="py">book</code> <code class="p">=</code> <code class="n">view</code><code class="p">.</code><code class="n">tag</code> <code class="k">as</code> <code class="n">Book</code>&#13;
      <code class="k">val</code> <code class="py">json</code> <code class="p">=</code> <code class="n">Gson</code><code class="p">().</code><code class="n">toJson</code><code class="p">(</code><code class="n">book</code><code class="p">)</code>&#13;
      <code class="k">val</code> <code class="py">intent</code> <code class="p">=</code> <code class="n">Intent</code><code class="p">(</code><code class="n">view</code><code class="p">.</code><code class="n">context</code><code class="p">,</code> <code class="n">BookDetailActivity</code><code class="o">::</code><code class="k">class</code><code class="p">.</code><code class="n">java</code><code class="p">)</code>&#13;
      <code class="n">intent</code><code class="p">.</code><code class="n">putExtra</code><code class="p">(</code><code class="n">BookDetailActivity</code><code class="p">.</code><code class="n">BOOK_JSON</code><code class="p">,</code> <code class="n">json</code><code class="p">)</code>&#13;
      <code class="n">view</code><code class="p">.</code><code class="n">context</code><code class="p">.</code><code class="n">startActivity</code><code class="p">(</code><code class="n">intent</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>If you run the app now, whenever you tap a row from the list view, you should see a book detail screen show up with all the details we have about that book. Congratulations, you’ve just mastered one of the widely used patterns in Android specifically and UI programming generally! Take a moment to give yourself a pat on the back.<a data-primary="" data-startref="Kperdetail19" data-type="indexterm" id="idm46177203036600"/><a data-primary="" data-startref="Jperdetail19" data-type="indexterm" id="idm46177203035864"/><a data-primary="" data-startref="Aperdetail19" data-type="indexterm" id="idm46177203034952"/><a data-primary="" data-startref="Panddetail19" data-type="indexterm" id="idm46177202689016"/><a data-primary="" data-startref="APandetail19" data-type="indexterm" id="idm46177202688072"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="iOS" data-type="sect2"><div class="sect2" id="idm46177204047224">&#13;
<h2>iOS</h2>&#13;
&#13;
<p>Let’s<a data-primary="persistence" data-secondary="iOS" data-tertiary="adding detailed data to applications" data-type="indexterm" id="Piosdetail19"/><a data-primary="iOS" data-secondary="persistence" data-tertiary="adding detailed data to applications" data-type="indexterm" id="IOSpdet19"/><a data-primary="application persistence" data-secondary="iOS" data-tertiary="adding detailed data to applications" data-type="indexterm" id="APiosdetail19"/> start by opening up <em>Main.storyboard</em>. Drag a new View Controller object onto the canvas from the Library just like we did to add our other screens. This screen is sitting isolated from the rest of the app currently, so let’s connect it via a segue so we can transition to it later.</p>&#13;
&#13;
<p>This is an area storyboards excel. If you click on the table view cell inside the Catalog scene—the one we created in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch04.html#topics_user_input">Chapter 4, <em>User Input</em></a>—in the Document Outline within the storyboard editor, you can drag while holding down Control, and you’ll be able to wire up a segue <em>directly</em> to the table view cell itself.</p>&#13;
&#13;
<p>Inside the modal that’s presented, select <code>Show</code> as the segue type. If you build and run the app, you’ll see that tapping on a book within the catalog pushes a new view controller—that’s currently blank—onto the view stack. There is currently a bit of UI weirdness we need to fix, however. If you go back to the catalog view, you’ll notice our table view cell stays selected. Additionally, our view is fairly basic at this point—it’s just a white screen. Let’s fix it!</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Add some detail to yo’ detail so you can detail" data-type="sect3"><div class="sect3" id="idm46177202676936">&#13;
<h3>Add some detail to yo’ detail so you can detail</h3>&#13;
&#13;
<p>To fix both of those items, we need to create a custom view controller for our new scene. Add a new file to your project called <code>DetailViewController</code>. It should inherit from <code>UIViewController</code> like so:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">import</code> <code class="nc">UIKit</code>&#13;
&#13;
<code class="kd">class</code> <code class="nc">DetailViewController</code><code class="p">:</code> <code class="bp">UIViewController</code> <code class="p">{</code>&#13;
&#13;
&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Remembering our list from earlier and what our Android app currently has, we can recall we’re going to add a few views to our view controller. These will all be labels, so let’s go ahead and add some view outlets now; we can wire them up later in the storyboard editor.</p>&#13;
&#13;
<p>After adding view outlets, your view controller should now look like so:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">import</code> <code class="nc">UIKit</code>&#13;
&#13;
<code class="kd">class</code> <code class="nc">DetailViewController</code><code class="p">:</code> <code class="bp">UIViewController</code> <code class="p">{</code>&#13;
    <code class="kr">@IBOutlet</code> <code class="kd">var</code> <code class="nv">titleLabel</code><code class="p">:</code> <code class="bp">UILabel</code><code class="p">!</code>&#13;
    <code class="kr">@IBOutlet</code> <code class="kd">var</code> <code class="nv">authorsLabel</code><code class="p">:</code> <code class="bp">UILabel</code><code class="p">!</code>&#13;
    <code class="kr">@IBOutlet</code> <code class="kd">var</code> <code class="nv">isbnLabel</code><code class="p">:</code> <code class="bp">UILabel</code><code class="p">!</code>&#13;
    <code class="kr">@IBOutlet</code> <code class="kd">var</code> <code class="nv">pageCountLabel</code><code class="p">:</code> <code class="bp">UILabel</code><code class="p">!</code>&#13;
    <code class="kr">@IBOutlet</code> <code class="kd">var</code> <code class="nv">fictionLabel</code><code class="p">:</code> <code class="bp">UILabel</code><code class="p">!</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>We have a problem, though. How are we going to fill these properties?</p>&#13;
&#13;
<p>We know they’ll be coming from a book. So let’s create a method call <code>populate(from:)</code> that takes a <code>Book</code> argument we can use to set the text of our labels. We’ll use this in our catalog view controller to pass a <code>Book</code> object in during the segue. The final class with this method should look like so:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">import</code> <code class="nc">UIKit</code>&#13;
&#13;
<code class="kd">class</code> <code class="nc">DetailViewController</code><code class="p">:</code> <code class="bp">UIViewController</code> <code class="p">{</code>&#13;
    <code class="kr">@IBOutlet</code> <code class="kd">var</code> <code class="nv">titleLabel</code><code class="p">:</code> <code class="bp">UILabel</code><code class="p">!</code>&#13;
    <code class="kr">@IBOutlet</code> <code class="kd">var</code> <code class="nv">authorsLabel</code><code class="p">:</code> <code class="bp">UILabel</code><code class="p">!</code>&#13;
    <code class="kr">@IBOutlet</code> <code class="kd">var</code> <code class="nv">isbnLabel</code><code class="p">:</code> <code class="bp">UILabel</code><code class="p">!</code>&#13;
    <code class="kr">@IBOutlet</code> <code class="kd">var</code> <code class="nv">pageCountLabel</code><code class="p">:</code> <code class="bp">UILabel</code><code class="p">!</code>&#13;
    <code class="kr">@IBOutlet</code> <code class="kd">var</code> <code class="nv">fictionLabel</code><code class="p">:</code> <code class="bp">UILabel</code><code class="p">!</code>&#13;
&#13;
    <code class="kd">func</code> <code class="nf">populate</code><code class="p">(</code><code class="n">from</code> <code class="n">book</code><code class="p">:</code> <code class="n">Book</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">titleLabel</code><code class="p">.</code><code class="n">text</code> <code class="p">=</code> <code class="n">book</code><code class="p">.</code><code class="n">title</code>&#13;
&#13;
        <code class="c1">// Flatten our authors array to a string separated by commas</code>&#13;
        <code class="n">authorsLabel</code><code class="p">.</code><code class="n">text</code> <code class="p">=</code> <code class="n">book</code><code class="p">.</code><code class="n">authors</code><code class="p">.</code><code class="n">joined</code><code class="p">(</code><code class="n">separator</code><code class="p">:</code> <code class="s">", "</code><code class="p">)</code>&#13;
&#13;
        <code class="n">isbnLabel</code><code class="p">.</code><code class="n">text</code> <code class="p">=</code> <code class="n">book</code><code class="p">.</code><code class="n">isbn</code>&#13;
        <code class="n">pageCountLabel</code><code class="p">.</code><code class="n">text</code> <code class="p">=</code> <code class="n">book</code><code class="p">.</code><code class="n">pageCount</code><code class="p">.</code><code class="n">description</code>&#13;
&#13;
        <code class="c1">// Use our Bool value to display what kind of book it is</code>&#13;
        <code class="n">fictionLabel</code><code class="p">.</code><code class="n">text</code> <code class="p">=</code> <code class="n">book</code><code class="p">.</code><code class="n">fiction</code> <code class="p">?</code> <code class="s">"Fiction"</code> <code class="p">:</code> <code class="s">"Nonfiction"</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Let’s bounce back over to <code>CatalogViewController</code> and wire up this connection. If you’ll recall, our segue is automatically triggered because we wired it up to the table view cell itself. The preparation for the segue occurs in the view controller that triggered the segue. There is a special method we can override to add our custom preparation code: <code>prepare(for:sender:)</code>. It takes a <code>UISegue</code> object as the first parameter; this object contains the destination view controller, which happens to be our <code>DetailViewController</code> from before.</p>&#13;
&#13;
<p>Before we can use this method, though, we need to get an instance of the book for the cell that was tapped from our data source. To do this, we need to add a new method onto <code>ListDataSource</code> called <code>book(for:)</code> that will take an index path from the table view. Add the following method to <code>ListDataSource</code>:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">func</code> <code class="nf">book</code><code class="p">(</code><code class="k">for</code> <code class="n">indexPath</code><code class="p">:</code> <code class="n">IndexPath</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">Book</code> <code class="p">{</code>&#13;
	<code class="k">return</code> <code class="n">data</code><code class="p">[</code><code class="n">indexPath</code><code class="p">.</code><code class="n">row</code><code class="p">]</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Head back over to <code>CatalogViewController</code> and override <code>prepare(for:sender:)</code> to populate our destination view controller during our segue like so:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kr">override</code> <code class="kd">func</code> <code class="nf">prepare</code><code class="p">(</code><code class="k">for</code> <code class="n">segue</code><code class="p">:</code> <code class="bp">UIStoryboardSegue</code><code class="p">,</code> <code class="n">sender</code><code class="p">:</code> <code class="nb">Any</code><code class="p">?)</code> <code class="p">{</code>&#13;
	<code class="k">if</code> <code class="kd">let</code> <code class="nv">detailViewController</code> <code class="p">=</code> <code class="n">segue</code><code class="p">.</code><code class="n">destination</code> <code class="k">as</code><code class="p">?</code> <code class="n">DetailViewController</code><code class="p">,</code>&#13;
	   <code class="kd">let</code> <code class="nv">indexPath</code> <code class="p">=</code> <code class="n">tableView</code><code class="p">.</code><code class="n">indexPathForSelectedRow</code> <code class="p">{</code>&#13;
		<code class="n">detailViewController</code><code class="p">.</code><code class="n">populate</code><code class="p">(</code><code class="n">from</code><code class="p">:</code> <code class="n">dataSource</code><code class="p">.</code><code class="n">book</code><code class="p">(</code><code class="k">for</code><code class="p">:</code> <code class="n">indexPath</code><code class="p">))</code>&#13;
	<code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>There isn’t much to this method, but it’s extremely important to understand what’s going on. First, we check to see if our destination view controller type is <code>DetailViewController</code>. If it is, we continue forward in our <code>if</code> condition checking and make sure there is currently a selected row in the table view. These are both important checks because this method is called for <em>every</em> segue that’s triggered from this view controller. If both conditions are true, then we take the <code>DetailViewController</code> instance and call the method we created earlier to populate the book instance.</p>&#13;
&#13;
<p>Now, before we leave this file and head back over to our storyboard editor to wire things up, let’s add one more fix: let’s clear our table row selection. This doesn’t happen automatically because we’re using a standard <code>UIViewController</code> as our base class instead of a <code>UITableViewController</code>. We want this to happen whenever the view appears, which will provide a nice fade-out animation to provide context to our users as to what row they selected. As such, we’ll do this in the <code>viewDidAppear(_:)</code> method that’s part of our view controller life cycle.</p>&#13;
&#13;
<p>Our final <code>CatalogViewController</code> class should look like so:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">import</code> <code class="nc">UIKit</code>&#13;
&#13;
<code class="kd">class</code> <code class="nc">CatalogViewController</code><code class="p">:</code> <code class="bp">UIViewController</code> <code class="p">{</code>&#13;
&#13;
    <code class="kr">@IBOutlet</code> <code class="kr">weak</code> <code class="kd">var</code> <code class="nv">tableView</code><code class="p">:</code> <code class="bp">UITableView</code><code class="p">!</code>&#13;
    <code class="kr">lazy</code> <code class="kd">var</code> <code class="nv">dataSource</code><code class="p">:</code> <code class="n">ListDataSource</code> <code class="p">=</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="n">ListDataSource</code><code class="p">()</code>&#13;
    <code class="p">}()</code>&#13;
&#13;
    <code class="kr">override</code> <code class="kd">func</code> <code class="nf">viewDidLoad</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="kc">super</code><code class="p">.</code><code class="n">viewDidLoad</code><code class="p">()</code>&#13;
        <code class="n">tableView</code><code class="p">.</code><code class="n">dataSource</code> <code class="p">=</code> <code class="n">dataSource</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kr">override</code> <code class="kd">func</code> <code class="nf">viewDidAppear</code><code class="p">(</code><code class="kc">_</code> <code class="n">animated</code><code class="p">:</code> <code class="nb">Bool</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="kc">super</code><code class="p">.</code><code class="n">viewDidAppear</code><code class="p">(</code><code class="n">animated</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="kd">let</code> <code class="nv">indexPath</code> <code class="p">=</code> <code class="n">tableView</code><code class="p">.</code><code class="n">indexPathForSelectedRow</code> <code class="p">{</code>&#13;
            <code class="n">tableView</code><code class="p">.</code><code class="n">deselectRow</code><code class="p">(</code><code class="n">at</code><code class="p">:</code> <code class="n">indexPath</code><code class="p">,</code> <code class="n">animated</code><code class="p">:</code> <code class="kc">true</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kr">override</code> <code class="kd">func</code> <code class="nf">prepare</code><code class="p">(</code><code class="k">for</code> <code class="n">segue</code><code class="p">:</code> <code class="bp">UIStoryboardSegue</code><code class="p">,</code> <code class="n">sender</code><code class="p">:</code> <code class="nb">Any</code><code class="p">?)</code> <code class="p">{</code>&#13;
        <code class="k">if</code> <code class="kd">let</code> <code class="nv">detailViewController</code> <code class="p">=</code> <code class="n">segue</code><code class="p">.</code><code class="n">destination</code> <code class="k">as</code><code class="p">?</code> <code class="n">DetailViewController</code><code class="p">,</code>&#13;
           <code class="kd">let</code> <code class="nv">indexPath</code> <code class="p">=</code> <code class="n">tableView</code><code class="p">.</code><code class="n">indexPathForSelectedRow</code> <code class="p">{</code>&#13;
            <code class="n">detailViewController</code><code class="p">.</code><code class="n">populate</code><code class="p">(</code><code class="n">from</code><code class="p">:</code> <code class="n">dataSource</code><code class="p">.</code><code class="n">book</code><code class="p">(</code><code class="k">for</code><code class="p">:</code> <code class="n">indexPath</code><code class="p">))</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The last part of adding this view is fairly simple and similar to what we’ve done in the past. We need to add the labels for our new outlets in <code>DetailViewController</code> onto the scene. Feel free to arrange these however you’d like. Be creative! If you’d like to take a look at the sample project available on our GitHub repository, you can. In it, we’ve used stack views (from our Library picker) to create a view that expands and contracts automatically depending on the size of the screen. However, just dragging labels onto the view with some<a data-primary="Auto Layout" data-type="indexterm" id="idm46177202278456"/><a data-primary="views" data-secondary="iOS" data-tertiary="Auto Layout" data-type="indexterm" id="idm46177202277960"/><a data-primary="iOS" data-secondary="views" data-tertiary="Auto Layout" data-type="indexterm" id="idm46177202068024"/> Auto Layout constraints would suffice for this example. You might end up with something like that looks like <a data-type="xref" href="#detail">Figure 19-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="detail">&#13;
<img alt="You might notice some stretching between views thats perfectly normal" src="assets/nmdv_1901.png"/>&#13;
<h6><span class="label">Figure 19-1. </span>You might notice some stretching between views (that’s perfectly normal!)</h6>&#13;
</div></figure>&#13;
&#13;
<p>Let’s switch this scene to use our custom class <code>DetailViewController</code> by clicking to show the Identity inspector on the right side of the editor and switching from <code>UIViewController</code> to <code>DetailViewController</code>. Now, Control-drag from the view controller object in the document outline to each label and select the corresponding view outlet we coded earlier.</p>&#13;
&#13;
<p>If you build and run the project, you’ll see that after you click on an item in the catalog now, that item populates the book detail screen. Awesome!<a data-primary="" data-startref="APiosdetail19" data-type="indexterm" id="idm46177202061208"/><a data-primary="" data-startref="IOSpdet19" data-type="indexterm" id="idm46177202060232"/><a data-primary="" data-startref="Piosdetail19" data-type="indexterm" id="idm46177202059288"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Saving Books for Later" data-type="sect1"><div class="sect1" id="idm46177202675992">&#13;
<h1>Saving Books for Later</h1>&#13;
&#13;
<p>Now that we can see more information about our books, what happens if we find a particularly interesting book and want to save it for later? We could, of course, save it in memory within the application, but it wouldn’t last between application launches. We <em>could</em> save it to the filesystem using JSON, but you’ll find that will quickly become cumbersome and not very performant if we’re saving a large number of books. Don’t forget: the dataset we’re using for this example app is small, but the library we’re building this app for has a HUGE number of books available.</p>&#13;
&#13;
<p>Another major consideration is manipulating that information; things like sort and filter and pagination are easily accomplished using most persistence engines like Core Data, or any flavor of SQL, or Realm or Room, etc. The same cannot be said of a flat file store of JSON objects. Similarly, you’ll notice size start to become an issue when each file must reestablish structure, order, and key names for every object. For small or one-off data objects, a JSON file here and there can not only be fine but even preferable, but for a library of books we want the user to browse and curate, we need something a little more robust: a database.</p>&#13;
&#13;
<p>While we’re pondering the best approach available (hint: this chapter is about native persistence), let’s go ahead and add a button to toggle a book as a user favorite, which we’ll wire up later in the chapter.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Android" data-type="sect2"><div class="sect2" id="idm46177202054280">&#13;
<h2>Android</h2>&#13;
&#13;
<p>Since<a data-primary="application data" data-secondary="buttons" data-tertiary="Android" data-type="indexterm" id="idm46177202052712"/><a data-primary="application persistence" data-secondary="Android" data-tertiary="adding buttons to applications" data-type="indexterm" id="idm46177202051048"/><a data-primary="persistence" data-secondary="Android" data-tertiary="adding buttons to applications" data-type="indexterm" id="idm46177202049864"/><a data-primary="Android" data-secondary="persistence" data-tertiary="adding buttons to applications" data-type="indexterm" id="idm46177202048680"/><a data-primary="buttons, adding" data-secondary="Android" data-type="indexterm" id="idm46177202047496"/> we’re not using an <code>ActionBar</code> in our sample app, we’ll deviate slightly from iOS in that we’ll put our save button in the same UI as the informational <code>TextViews</code>. <span class="keep-together">Simply</span> add an XML <code>Button</code> to the end of the <code>LinearLayout</code> and give it an ID of <code>button_save</code>. If you’d like to differentiate it visually, use <code>android:layout_gravity="center"</code>, like so:</p>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;Button</code>&#13;
  <code class="na">android:id=</code><code class="s">"@+id/button_save"</code>&#13;
  <code class="na">android:layout_width=</code><code class="s">"wrap_content"</code>&#13;
  <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code>&#13;
  <code class="na">android:layout_gravity=</code><code class="s">"center"</code>&#13;
  <code class="na">android:text=</code><code class="s">"Mark as Favorite"</code> <code class="nt">/&gt;</code></pre>&#13;
&#13;
<p>Your new detail layout should look like this:</p>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</code>&#13;
<code class="nt">&lt;ScrollView</code>&#13;
    <code class="na">xmlns:android=</code><code class="s">"http://schemas.android.com/apk/res/android"</code>&#13;
    <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
    <code class="na">android:layout_height=</code><code class="s">"match_parent"</code><code class="nt">&gt;</code>&#13;
&#13;
  <code class="nt">&lt;LinearLayout</code>&#13;
      <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
      <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code>&#13;
      <code class="na">android:orientation=</code><code class="s">"vertical"</code><code class="nt">&gt;</code>&#13;
&#13;
    <code class="nt">&lt;TextView</code>&#13;
        <code class="na">android:id=</code><code class="s">"@+id/textview_title"</code>&#13;
        <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
        <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code> <code class="nt">/&gt;</code>&#13;
&#13;
    <code class="nt">&lt;TextView</code>&#13;
        <code class="na">android:id=</code><code class="s">"@+id/textview_authors"</code>&#13;
        <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
        <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code> <code class="nt">/&gt;</code>&#13;
&#13;
    <code class="nt">&lt;TextView</code>&#13;
        <code class="na">android:id=</code><code class="s">"@+id/textview_isbn"</code>&#13;
        <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
        <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code> <code class="nt">/&gt;</code>&#13;
&#13;
    <code class="nt">&lt;TextView</code>&#13;
        <code class="na">android:id=</code><code class="s">"@+id/textview_pagecount"</code>&#13;
        <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
        <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code> <code class="nt">/&gt;</code>&#13;
&#13;
    <code class="nt">&lt;TextView</code>&#13;
        <code class="na">android:id=</code><code class="s">"@+id/textview_isfiction"</code>&#13;
        <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
        <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code> <code class="nt">/&gt;</code>&#13;
&#13;
    <code class="nt">&lt;Button</code>&#13;
        <code class="na">android:id=</code><code class="s">"@+id/button_save"</code>&#13;
        <code class="na">android:layout_width=</code><code class="s">"wrap_content"</code>&#13;
        <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code>&#13;
        <code class="na">android:layout_gravity=</code><code class="s">"center"</code>&#13;
        <code class="na">android:text=</code><code class="s">"Mark as Favorite"</code> <code class="nt">/&gt;</code>&#13;
&#13;
  <code class="nt">&lt;/LinearLayout&gt;</code>&#13;
&#13;
<code class="nt">&lt;/ScrollView&gt;</code></pre>&#13;
&#13;
<p>We’ll wire up the tap behavior to save the detail a little later, after we’ve established a persistence layer. Stay tuned.</p>&#13;
&#13;
<p>So that was painless. Let’s do the same on iOS, which is slightly more painful.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="iOS" data-type="sect2"><div class="sect2" id="idm46177202032488">&#13;
<h2>iOS</h2>&#13;
&#13;
<p>Let’s<a data-primary="application data" data-secondary="buttons" data-tertiary="iOS" data-type="indexterm" id="idm46177201919688"/><a data-primary="iOS" data-secondary="persistence" data-tertiary="adding buttons to applications" data-type="indexterm" id="idm46177201918408"/><a data-primary="buttons, adding" data-secondary="iOS" data-type="indexterm" id="idm46177201917224"/><a data-primary="application persistence" data-secondary="iOS" data-tertiary="adding buttons to applications" data-type="indexterm" id="idm46177201916280"/><a data-primary="persistence" data-secondary="iOS" data-tertiary="adding buttons to applications" data-type="indexterm" id="idm46177201915096"/> add our button to the navigation bar. This is a pretty common place to put actions like this. Open up <em>Main.storyboard</em> and head over to the detail scene if you’re not already there. Search for “Navigation Item” in the Library and drag that over to the scene. This creates a navigation item that is associated with our view controller’s navigation bar that we can edit in the storyboard editor. Click on the navigation item—labeled “Title”—in the<a data-primary="Document Outline" data-type="indexterm" id="idm46177201912936"/> Document Outline of the editor. Show the<a data-primary="Attributes inspector" data-type="indexterm" id="idm46177201912040"/><a data-primary="Xcode" data-secondary="Attributes inspector" data-type="indexterm" id="idm46177201911368"/> Attributes inspector and clear the value in the Title field so that it’s blank. This will cause the object to change to Navigation Item in the Document Outline.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>If you select <code>Push</code> as the segue type, this is automatically added for you by Xcode because <code>Push</code> is a segue type for navigation controllers. However, that segue type is deprecated, which requires us to provide a bit more manual context when we create the scene to keep things inside the storyboard editor. We could, however, do all this in code as well, but it’s arguably easier in the storyboard editor. At a minimum, it helps us keep our UI setup in one place, as opposed to spread across code files and storyboards unnecessarily.</p>&#13;
</div>&#13;
&#13;
<p>Now, in the Library, search for “Bar Button Item” and drag that item onto the right side of the navigation bar in the scene. In the Attributes inspector for this item, change the title field from “Item” to “Save Book.” Your scene should look like <a data-type="xref" href="#save-book">Figure 19-2</a>.</p>&#13;
&#13;
<figure><div class="figure" id="save-book">&#13;
<img alt="Save Book button added to the navigation bar" src="assets/nmdv_1902.png"/>&#13;
<h6><span class="label">Figure 19-2. </span>“Save Book” button added to the navigation bar</h6>&#13;
</div></figure>&#13;
&#13;
<p>Let’s create an action for this new button.</p>&#13;
&#13;
<p>Open up the<a data-primary="Assistant editor" data-type="indexterm" id="idm46177201903352"/><a data-primary="Xcode" data-secondary="Assistant editor" data-type="indexterm" id="idm46177201902616"/> Assistant editor, which shows the code and interface side by side. Control-drag on the new button and drop the action inside the view controller below our <code>populate(for:)</code> method declaration at the very bottom of the class. This should create a new method inside of <code>DetailViewController</code> that looks like this:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kr">@IBAction</code> <code class="kd">func</code> <code class="nf">saveBook</code><code class="p">(</code><code class="kc">_</code> <code class="n">sender</code><code class="p">:</code> <code class="nb">Any</code><code class="p">)</code> <code class="p">{</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>If you build and run the project, you’ll see the button at the top right of screen in the book detail screen, but tapping it won’t do anything just yet. Let’s address that now.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Storing Books for Later" data-type="sect1"><div class="sect1" id="idm46177201891112">&#13;
<h1>Storing Books for Later</h1>&#13;
&#13;
<p>As mentioned before, we need to store our books for later. We need something performant due to the size of our library, something that lasts between launches, and something that will allow us to read and write data to and from. This is starting to sound like a data persistence layer.</p>&#13;
&#13;
<p>Gasp!</p>&#13;
&#13;
<p>If you’re building a cross-platform set of apps, like we are in this book, you’ll find this is a major area where the native components diverge. We could use a cross-platform solution, like Realm, but in the interests of staying true to each platform, we’re going to use the most common and supported options available for Android and iOS.</p>&#13;
&#13;
<p>First, before we talk about Android and iOS separately, let’s talk about our common goals with our data persistence layer. There are some requirements we have. The expected functionality is as such:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Tapping “Save Book” will save a book identifier to some sort of store.</p>&#13;
</li>&#13;
<li>&#13;
<p>This data store will be able to show a list of books from our returned identifiers that were saved.</p>&#13;
</li>&#13;
<li>&#13;
<p>The detail screen will indicate if a book is saved or not.</p>&#13;
</li>&#13;
<li>&#13;
<p>We will be able to delete books from our list that we’ve saved.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The first two items in that list are where Android and iOS will have the most different approaches. However, because we are using an MVC architecture, a lot of the code differences will be contained to the Model layer. The View and Controller layers (i.e., the last two items in that list of requirements) will continue to have code that is similar in terms of architecture.</p>&#13;
&#13;
<p>So, without further ado, let’s build a persistence layer.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Android" data-type="sect2"><div class="sect2" id="idm46177201841384">&#13;
<h2>Android</h2>&#13;
&#13;
<p>As<a data-primary="persistence" data-secondary="Android" data-tertiary="storing data" data-type="indexterm" id="Pandstore19"/><a data-primary="application persistence" data-secondary="Android" data-tertiary="storing data" data-type="indexterm" id="APandstor19"/><a data-primary="Android" data-secondary="persistence" data-tertiary="storing data" data-type="indexterm" id="Aperstore19"/> mentioned a couple times already, there are a number of ways to persist data using the Android framework, and at the time of the writing, Google suggests we use the Room library. However, we’re going to use SQLite for a couple reasons, the most important being that SQL is extremely mature, well-vetted, and accepted by the databasing community as the gold standard. We have access to SQLite only for local device persistence, but the same basic syntax, rules, and operations apply to all the major SQL databases, like PostgreSql, MySql, and MSSql. Of course you should feel free to experiment with other approaches, like Room. Realm is another popular choice, with the additional benefit of it being cross-platform.</p>&#13;
&#13;
<p>In any event, let’s see how we can build a persistence layer with SQLite. First, as with all relational database management systems, we need at least one table. In our example, we’re going to use three: one for <code>Book</code> instances, one for authors (that will be represented as <code>Strings</code>), and a single table to relate the two. The relational table is sometimes known as a through table, bridge table, pivot table, or join table, but it’s an extremely common paradigm and we think it is a great but simple example on how to use SQL.</p>&#13;
&#13;
<p>We’ll use SQL standard “create table” syntax. For the specifics of each keyword, check the dev docs, but we’ll present enough to get you up and running.</p>&#13;
&#13;
<pre data-code-language="sqlite3" data-type="programlisting"><code class="go">CREATE TABLE IF NOT EXISTS BOOKS (</code>&#13;
<code class="go">        ID INTEGER PRIMARY KEY AUTOINCREMENT,</code>&#13;
<code class="go">        TITLE TEXT,</code>&#13;
<code class="go">        ISBN TEXT,</code>&#13;
<code class="go">        PAGECOUNT INTEGER,</code>&#13;
<code class="go">        IS_FICTION INTEGER);</code></pre>&#13;
&#13;
<pre data-code-language="sqlite3" data-type="programlisting"><code class="go">CREATE TABLE IF NOT EXISTS AUTHORS (</code>&#13;
<code class="go">        ID INTEGER PRIMARY KEY AUTOINCREMENT,</code>&#13;
<code class="go">        NAME TEXT);</code></pre>&#13;
&#13;
<pre data-code-language="sqlite3" data-type="programlisting"><code class="go">CREATE TABLE IF NOT EXISTS BOOK_AUTHORS (</code>&#13;
<code class="go">        BOOK_ID INTEGER REFERENCES BOOKS(ID),</code>&#13;
<code class="go">        AUTHOR_ID INTEGER REFERENCES AUTHORS(ID))</code></pre>&#13;
&#13;
<p>You’ll want each of these tables created the first time your application is launched, so you have access to them immediately. If you recall the detail around <code>SqliteOpenHelper</code> back in <a data-type="xref" href="ch07.html#topics_databases">Chapter 7</a>, you might remember you can accomplish this with an overridden <code>onCreate</code> method. Remember, this will fire only once during the first app launch following install. Note further that it will not be invoked until the first time you use the subclass to get an instance of a database, with either <code>getReadableDatabase</code> or <code>getWritableDatabase</code>. For our examples, we’ll always prefer the latter, so we can update our data store.</p>&#13;
&#13;
<p>Here’s<a data-primary="Java" data-secondary="persistence" data-tertiary="storing data" data-type="indexterm" id="Jperstore19"/><a data-primary="Kotlin" data-secondary="persistence" data-tertiary="storing data" data-type="indexterm" id="Kpersstore19"/> what that might look like:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177201702328">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">DbHelper</code> <code class="kd">extends</code> <code class="n">SQLiteOpenHelper</code> <code class="o">{</code>&#13;
&#13;
  <code class="kd">public</code> <code class="nf">DbHelper</code><code class="o">(</code><code class="n">Context</code> <code class="n">context</code><code class="o">,</code> <code class="n">String</code> <code class="n">name</code><code class="o">,</code> <code class="n">SQLiteDatabase</code><code class="o">.</code><code class="na">CursorFactory</code> <code class="n">factory</code><code class="o">,</code>&#13;
  <code class="kt">int</code> <code class="n">version</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="kd">super</code><code class="o">(</code><code class="n">context</code><code class="o">,</code> <code class="n">name</code><code class="o">,</code> <code class="n">factory</code><code class="o">,</code> <code class="n">version</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">onCreate</code><code class="o">(</code><code class="n">SQLiteDatabase</code> <code class="n">database</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">database</code><code class="o">.</code><code class="na">execSQL</code><code class="o">(</code><code class="n">BOOKS_CREATE_TABLE</code><code class="o">);</code>&#13;
    <code class="n">database</code><code class="o">.</code><code class="na">execSQL</code><code class="o">(</code><code class="n">AUTHORS_CREATE_TABLE</code><code class="o">);</code>&#13;
    <code class="n">database</code><code class="o">.</code><code class="na">execSQL</code><code class="o">(</code><code class="n">BRIDGE_CREATE_TABLE</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">onUpgrade</code><code class="o">(</code><code class="n">SQLiteDatabase</code> <code class="n">database</code><code class="o">,</code> <code class="kt">int</code> <code class="n">i</code><code class="o">,</code> <code class="kt">int</code> <code class="n">i1</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="c1">// no op</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_TABLE_NAME</code> <code class="o">=</code> <code class="s">"BOOKS"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_COLUMN_TITLE</code> <code class="o">=</code> <code class="s">"TITLE"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_COLUMN_ISBN</code> <code class="o">=</code> <code class="s">"ISBN"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_COLUMN_PAGECOUNT</code> <code class="o">=</code> <code class="s">"PAGECOUNT"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_COLUMN_ISFICTION</code> <code class="o">=</code> <code class="s">"ISFICTION"</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">AUTHORS_TABLE_NAME</code> <code class="o">=</code> <code class="s">"AUTHORS"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">AUTHORS_COLUMN_ID</code> <code class="o">=</code> <code class="s">"ID"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">AUTHORS_COLUMN_NAME</code> <code class="o">=</code> <code class="s">"NAME"</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BRIDGE_TABLE_NAME</code> <code class="o">=</code> <code class="s">"BOOK_AUTHOR_BRIDGE"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BRIDGE_COLUMN_BOOK_ID</code> <code class="o">=</code> <code class="s">"BOOK_ID"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BRIDGE_COLUMN_AUTHOR_ID</code> <code class="o">=</code> <code class="s">"AUTHOR_ID"</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_CREATE_TABLE</code> <code class="o">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="o">+</code>&#13;
  <code class="n">BOOKS_TABLE_NAME</code> <code class="o">+</code>&#13;
    <code class="s">" ("</code> <code class="o">+</code>&#13;
      <code class="n">BOOKS_COLUMN_TITLE</code> <code class="o">+</code> <code class="s">" TEXT,"</code> <code class="o">+</code>&#13;
      <code class="n">BOOKS_COLUMN_ISBN</code> <code class="o">+</code> <code class="s">" TEXT,"</code> <code class="o">+</code>&#13;
      <code class="n">BOOKS_COLUMN_PAGECOUNT</code> <code class="o">+</code> <code class="s">" INTEGER,"</code> <code class="o">+</code>&#13;
      <code class="n">BOOKS_COLUMN_ISFICTION</code> <code class="o">+</code> <code class="s">" INTEGER);"</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">AUTHORS_CREATE_TABLE</code> <code class="o">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="o">+</code>&#13;
  <code class="n">AUTHORS_TABLE_NAME</code> <code class="o">+</code>&#13;
    <code class="s">" ("</code> <code class="o">+</code>&#13;
      <code class="n">AUTHORS_COLUMN_ID</code> <code class="o">+</code> <code class="s">" INTEGER PRIMARY KEY AUTOINCREMENT,"</code> <code class="o">+</code>&#13;
      <code class="n">AUTHORS_COLUMN_NAME</code> <code class="o">+</code> <code class="s">" TEXT)"</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BRIDGE_CREATE_TABLE</code> <code class="o">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="o">+</code>&#13;
  <code class="n">BRIDGE_TABLE_NAME</code> <code class="o">+</code>&#13;
    <code class="s">" ("</code> <code class="o">+</code>&#13;
      <code class="n">BRIDGE_COLUMN_BOOK_ID</code> <code class="o">+</code> <code class="s">" INTEGER REFERENCES BOOKS,"</code> <code class="o">+</code>&#13;
      <code class="n">BRIDGE_COLUMN_AUTHOR_ID</code> <code class="o">+</code> <code class="s">" INTEGER REFERENCES AUTHORS)"</code><code class="o">;</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">DbHelper</code><code class="p">(</code><code class="n">context</code><code class="p">:</code> <code class="n">Context</code><code class="p">,</code> <code class="n">name</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code> <code class="n">factory</code><code class="p">:</code> <code class="n">SQLiteDatabase</code><code class="p">.</code><code class="n">CursorFactory</code><code class="p">,</code>&#13;
<code class="n">version</code><code class="p">:</code> <code class="n">Int</code><code class="p">)</code> <code class="p">:</code>&#13;
  <code class="n">SQLiteOpenHelper</code><code class="p">(</code><code class="n">context</code><code class="p">,</code> <code class="n">name</code><code class="p">,</code> <code class="n">factory</code><code class="p">,</code> <code class="n">version</code><code class="p">)</code> <code class="p">{</code>&#13;
&#13;
  <code class="k">override</code> <code class="k">fun</code> <code class="nf">onCreate</code><code class="p">(</code><code class="n">database</code><code class="p">:</code> <code class="n">SQLiteDatabase</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">database</code><code class="p">.</code><code class="n">execSQL</code><code class="p">(</code><code class="n">BOOKS_CREATE_TABLE</code><code class="p">)</code>&#13;
    <code class="n">database</code><code class="p">.</code><code class="n">execSQL</code><code class="p">(</code><code class="n">AUTHORS_CREATE_TABLE</code><code class="p">)</code>&#13;
    <code class="n">database</code><code class="p">.</code><code class="n">execSQL</code><code class="p">(</code><code class="n">BRIDGE_CREATE_TABLE</code><code class="p">)</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">override</code> <code class="k">fun</code> <code class="nf">onUpgrade</code><code class="p">(</code><code class="n">database</code><code class="p">:</code> <code class="n">SQLiteDatabase</code><code class="p">,</code> <code class="n">i</code><code class="p">:</code> <code class="n">Int</code><code class="p">,</code> <code class="n">i1</code><code class="p">:</code> <code class="n">Int</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// no op</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="n">companion</code> <code class="k">object</code> <code class="err">{</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_TABLE_NAME</code> <code class="p">=</code> <code class="s">"BOOKS"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_COLUMN_TITLE</code> <code class="p">=</code> <code class="s">"TITLE"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_COLUMN_ISBN</code> <code class="p">=</code> <code class="s">"ISBN"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_COLUMN_PAGECOUNT</code> <code class="p">=</code> <code class="s">"PAGECOUNT"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_COLUMN_ISFICTION</code> <code class="p">=</code> <code class="s">"ISFICTION"</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">AUTHORS_TABLE_NAME</code> <code class="p">=</code> <code class="s">"AUTHORS"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">AUTHORS_COLUMN_ID</code> <code class="p">=</code> <code class="s">"ID"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">AUTHORS_COLUMN_NAME</code> <code class="p">=</code> <code class="s">"NAME"</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BRIDGE_TABLE_NAME</code> <code class="p">=</code> <code class="s">"BOOK_AUTHOR_BRIDGE"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BRIDGE_COLUMN_BOOK_ID</code> <code class="p">=</code> <code class="s">"BOOK_ID"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BRIDGE_COLUMN_AUTHOR_ID</code> <code class="p">=</code> <code class="s">"AUTHOR_ID"</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_CREATE_TABLE</code> <code class="p">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="p">+</code> <code class="n">BOOKS_TABLE_NAME</code> <code class="p">+</code>&#13;
    <code class="s">" ("</code> <code class="p">+</code>&#13;
        <code class="n">BOOKS_COLUMN_TITLE</code> <code class="p">+</code> <code class="s">" TEXT,"</code> <code class="p">+</code>&#13;
        <code class="n">BOOKS_COLUMN_ISBN</code> <code class="p">+</code> <code class="s">" TEXT,"</code> <code class="p">+</code>&#13;
        <code class="n">BOOKS_COLUMN_PAGECOUNT</code> <code class="p">+</code> <code class="s">" INTEGER,"</code> <code class="p">+</code>&#13;
        <code class="n">BOOKS_COLUMN_ISFICTION</code> <code class="p">+</code> <code class="s">" INTEGER);"</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">AUTHORS_CREATE_TABLE</code> <code class="p">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="p">+</code> <code class="n">AUTHORS_TABLE_NAME</code> <code class="p">+</code>&#13;
        <code class="s">" ("</code> <code class="p">+</code> <code class="n">AUTHORS_COLUMN_ID</code> <code class="p">+</code> <code class="s">" INTEGER PRIMARY KEY AUTOINCREMENT,"</code> <code class="p">+</code>&#13;
        <code class="n">AUTHORS_COLUMN_NAME</code> <code class="p">+</code> <code class="s">" TEXT)"</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BRIDGE_CREATE_TABLE</code> <code class="p">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="p">+</code> <code class="n">BRIDGE_TABLE_NAME</code> <code class="p">+</code>&#13;
    <code class="s">" ("</code> <code class="p">+</code>&#13;
        <code class="n">BRIDGE_COLUMN_BOOK_ID</code> <code class="p">+</code> <code class="s">" INTEGER REFERENCES BOOKS,"</code> <code class="p">+</code>&#13;
        <code class="n">BRIDGE_COLUMN_AUTHOR_ID</code> <code class="p">+</code> <code class="s">" INTEGER REFERENCES AUTHORS)"</code>&#13;
  <code class="p">}</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>So at this point, we’ve got a nice, shiny new database, but it’s empty—all of our data is still in <em>catalog.json</em>. Let’s remedy that. First, we know we’re going to need methods to read and write <code>Book</code> instances to and from the database, so let’s set that up. Maybe something like this:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177201338200">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">BookTransactions</code> <code class="o">{</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="n">Book</code> <code class="nf">read</code><code class="o">(</code><code class="n">SQLiteDatabase</code> <code class="n">database</code><code class="o">,</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">Cursor</code> <code class="n">cursor</code> <code class="o">=</code> <code class="n">database</code><code class="o">.</code><code class="na">query</code><code class="o">(</code>&#13;
        <code class="n">DbHelper</code><code class="o">.</code><code class="na">BOOKS_TABLE_NAME</code><code class="o">,</code> <code class="c1">// String name of the table query</code>&#13;
        <code class="kc">null</code><code class="o">,</code> <code class="c1">// String array of columns</code>&#13;
        <code class="n">DbHelper</code><code class="o">.</code><code class="na">BOOKS_COLUMN_ISBN</code> <code class="o">+</code> <code class="s">" = ?"</code><code class="o">,</code> <code class="c1">// String WHERE clause</code>&#13;
        <code class="k">new</code> <code class="n">String</code><code class="o">[]</code> <code class="o">{</code> <code class="n">isbn</code> <code class="o">},</code> <code class="c1">// String array of WHERE values</code>&#13;
        <code class="kc">null</code><code class="o">,</code> <code class="c1">// GROUP BY</code>&#13;
        <code class="kc">null</code><code class="o">,</code> <code class="c1">// HAVING</code>&#13;
        <code class="kc">null</code><code class="o">,</code> <code class="c1">// ORDER BY</code>&#13;
        <code class="s">"1"</code> <code class="c1">// String LIMIT</code>&#13;
    <code class="o">);</code>&#13;
    <code class="k">if</code> <code class="o">(</code><code class="n">cursor</code><code class="o">.</code><code class="na">moveToNext</code><code class="o">())</code> <code class="o">{</code>&#13;
      <code class="n">val</code> <code class="n">book</code> <code class="o">=</code> <code class="n">Book</code><code class="o">(</code>&#13;
       <code class="n">cursor</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="mi">0</code><code class="o">),</code>&#13;
       <code class="n">mutableListOf</code><code class="o">(),</code>&#13;
       <code class="n">isbn</code><code class="o">,</code>&#13;
       <code class="n">cursor</code><code class="o">.</code><code class="na">getInt</code><code class="o">(</code><code class="mi">2</code><code class="o">),</code>&#13;
       <code class="n">cursor</code><code class="o">.</code><code class="na">getInt</code><code class="o">(</code><code class="mi">3</code><code class="o">)</code> <code class="o">==</code> <code class="mi">1</code>&#13;
      <code class="o">)</code>&#13;
      <code class="n">readAuthors</code><code class="o">(</code><code class="n">database</code><code class="o">,</code> <code class="n">book</code><code class="o">);</code>&#13;
      <code class="k">return</code> <code class="nf">Book</code><code class="o">()</code>&#13;
    <code class="o">}</code>&#13;
    <code class="n">cursor</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
    <code class="k">return</code> <code class="nf">Book</code><code class="o">()</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">write</code><code class="o">(</code><code class="n">SQLiteDatabase</code> <code class="n">database</code><code class="o">,</code> <code class="n">Book</code> <code class="n">book</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">ContentValues</code> <code class="n">contentValues</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ContentValues</code><code class="o">();</code>&#13;
    <code class="n">contentValues</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">DbHelper</code><code class="o">.</code><code class="na">BOOKS_COLUMN_ISBN</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">getIsbn</code><code class="o">());</code>&#13;
    <code class="n">contentValues</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">DbHelper</code><code class="o">.</code><code class="na">BOOKS_COLUMN_TITLE</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">getTitle</code><code class="o">());</code>&#13;
    <code class="n">contentValues</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">DbHelper</code><code class="o">.</code><code class="na">BOOKS_COLUMN_PAGECOUNT</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">getPageCount</code><code class="o">());</code>&#13;
    <code class="n">contentValues</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">DbHelper</code><code class="o">.</code><code class="na">BOOKS_COLUMN_ISFICTION</code><code class="o">,</code> <code class="n">book</code><code class="o">.</code><code class="na">isFiction</code><code class="o">());</code>&#13;
    <code class="n">database</code><code class="o">.</code><code class="na">beginTransaction</code><code class="o">();</code>&#13;
    <code class="k">try</code> <code class="o">{</code>&#13;
      <code class="n">insertOrUpdate</code><code class="o">(</code>&#13;
          <code class="n">database</code><code class="o">,</code>&#13;
          <code class="n">DbHelper</code><code class="o">.</code><code class="na">BOOKS_TABLE_NAME</code><code class="o">,</code>&#13;
          <code class="n">contentValues</code><code class="o">,</code>&#13;
          <code class="n">DbHelper</code><code class="o">.</code><code class="na">BOOKS_COLUMN_ISBN</code> <code class="o">+</code> <code class="s">" = ? "</code><code class="o">,</code>&#13;
          <code class="k">new</code> <code class="n">String</code><code class="o">[]</code> <code class="o">{</code> <code class="n">book</code><code class="o">.</code><code class="na">getIsbn</code><code class="o">()</code> <code class="o">});</code>&#13;
      <code class="k">for</code> <code class="o">(</code><code class="n">String</code> <code class="n">author</code> <code class="o">:</code> <code class="n">book</code><code class="o">.</code><code class="na">getAuthors</code><code class="o">())</code> <code class="o">{</code>&#13;
        <code class="n">contentValues</code> <code class="o">=</code> <code class="k">new</code> <code class="n">ContentValues</code><code class="o">();</code>&#13;
        <code class="n">contentValues</code><code class="o">.</code><code class="na">put</code><code class="o">(</code><code class="n">DbHelper</code><code class="o">.</code><code class="na">AUTHORS_COLUMN_NAME</code><code class="o">,</code> <code class="n">author</code><code class="o">);</code>&#13;
        <code class="n">database</code><code class="o">.</code><code class="na">insertWithOnConflict</code><code class="o">(</code><code class="n">DbHelper</code><code class="o">.</code><code class="na">AUTHORS_TABLE_NAME</code><code class="o">,</code> <code class="kc">null</code><code class="o">,</code> <code class="n">contentValues</code><code class="o">,</code>&#13;
          <code class="n">SQLiteDatabase</code><code class="o">.</code><code class="na">CONFLICT_IGNORE</code><code class="o">);</code>&#13;
      <code class="o">}</code>&#13;
      <code class="n">database</code><code class="o">.</code><code class="na">setTransactionSuccessful</code><code class="o">();</code>&#13;
      <code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyTag"</code><code class="o">,</code> <code class="s">"wrote data to database"</code><code class="o">);</code>&#13;
    <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyTag"</code><code class="o">,</code> <code class="s">"there was a problem inserting data: "</code> <code class="o">+</code> <code class="n">e</code><code class="o">.</code><code class="na">getMessage</code><code class="o">());</code>&#13;
    <code class="o">}</code> <code class="k">finally</code> <code class="o">{</code>&#13;
      <code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyTag"</code><code class="o">,</code> <code class="s">"finally"</code><code class="o">);</code>&#13;
      <code class="n">database</code><code class="o">.</code><code class="na">endTransaction</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">boolean</code> <code class="nf">insertOrUpdate</code><code class="o">(</code><code class="n">SQLiteDatabase</code> <code class="n">database</code><code class="o">,</code> <code class="n">String</code> <code class="n">table</code><code class="o">,</code>&#13;
  <code class="n">ContentValues</code> <code class="n">values</code><code class="o">,</code>&#13;
    <code class="n">String</code> <code class="n">where</code><code class="o">,</code> <code class="n">String</code><code class="o">[]</code> <code class="n">args</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="kt">long</code> <code class="n">rowId</code> <code class="o">=</code> <code class="n">database</code><code class="o">.</code><code class="na">insertWithOnConflict</code><code class="o">(</code><code class="n">table</code><code class="o">,</code> <code class="kc">null</code><code class="o">,</code> <code class="n">values</code><code class="o">,</code>&#13;
    <code class="n">SQLiteDatabase</code><code class="o">.</code><code class="na">CONFLICT_IGNORE</code><code class="o">);</code>&#13;
    <code class="k">if</code> <code class="o">(</code><code class="n">rowId</code> <code class="o">&lt;</code> <code class="mi">0</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="n">database</code><code class="o">.</code><code class="na">update</code><code class="o">(</code><code class="n">table</code><code class="o">,</code> <code class="n">values</code><code class="o">,</code> <code class="n">where</code><code class="o">,</code> <code class="n">args</code><code class="o">);</code>&#13;
      <code class="k">return</code> <code class="kc">false</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
    <code class="k">return</code> <code class="kc">true</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">readAuthors</code><code class="o">(</code><code class="n">SQLiteDatabase</code> <code class="n">database</code><code class="o">,</code> <code class="n">Book</code> <code class="n">book</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">Cursor</code> <code class="n">cursor</code> <code class="o">=</code> <code class="n">database</code><code class="o">.</code><code class="na">query</code><code class="o">(</code>&#13;
        <code class="n">DbHelper</code><code class="o">.</code><code class="na">AUTHORS_TABLE_NAME</code>&#13;
            <code class="o">+</code> <code class="s">" join "</code>&#13;
            <code class="o">+</code> <code class="n">DbHelper</code><code class="o">.</code><code class="na">BRIDGE_TABLE_NAME</code>&#13;
            <code class="o">+</code> <code class="s">" on "</code>&#13;
            <code class="o">+</code> <code class="n">DbHelper</code><code class="o">.</code><code class="na">AUTHORS_TABLE_NAME</code> <code class="o">+</code> <code class="s">"."</code> <code class="o">+</code> <code class="n">DbHelper</code><code class="o">.</code><code class="na">AUTHORS_COLUMN_ID</code>&#13;
            <code class="o">+</code> <code class="s">" = "</code>&#13;
            <code class="o">+</code> <code class="n">DbHelper</code><code class="o">.</code><code class="na">BRIDGE_TABLE_NAME</code> <code class="o">+</code> <code class="s">"."</code> <code class="o">+</code> <code class="n">DbHelper</code><code class="o">.</code><code class="na">BRIDGE_COLUMN_AUTHOR_ID</code><code class="o">,</code>&#13;
              <code class="c1">// String name of the table query</code>&#13;
        <code class="k">new</code> <code class="n">String</code><code class="o">[]</code> <code class="o">{</code> <code class="n">DbHelper</code><code class="o">.</code><code class="na">AUTHORS_COLUMN_NAME</code> <code class="o">},</code> <code class="c1">// String array of columns</code>&#13;
        <code class="n">DbHelper</code><code class="o">.</code><code class="na">BRIDGE_COLUMN_AUTHOR_ID</code> <code class="o">+</code> <code class="s">" = ?"</code><code class="o">,</code> <code class="c1">// String WHERE clause</code>&#13;
        <code class="k">new</code> <code class="n">String</code><code class="o">[]</code> <code class="o">{</code> <code class="n">book</code><code class="o">.</code><code class="na">getIsbn</code><code class="o">()</code> <code class="o">},</code> <code class="c1">// String array of WHERE values</code>&#13;
        <code class="kc">null</code><code class="o">,</code> <code class="c1">// GROUP BY</code>&#13;
        <code class="kc">null</code><code class="o">,</code> <code class="c1">// HAVING</code>&#13;
        <code class="kc">null</code> <code class="c1">// ORDER BY</code>&#13;
    <code class="o">);</code>&#13;
    <code class="n">String</code><code class="o">[]</code> <code class="n">authors</code> <code class="o">=</code> <code class="k">new</code> <code class="n">String</code><code class="o">[</code><code class="n">cursor</code><code class="o">.</code><code class="na">getCount</code><code class="o">()];</code>&#13;
    <code class="kt">int</code> <code class="n">i</code> <code class="o">=</code> <code class="mi">0</code><code class="o">;</code>&#13;
    <code class="k">while</code> <code class="o">(!</code><code class="n">cursor</code><code class="o">.</code><code class="na">isAfterLast</code><code class="o">())</code> <code class="o">{</code>&#13;
      <code class="n">cursor</code><code class="o">.</code><code class="na">moveToNext</code><code class="o">();</code>&#13;
      <code class="n">authors</code><code class="o">[</code><code class="n">i</code><code class="o">++]</code> <code class="o">=</code> <code class="n">cursor</code><code class="o">.</code><code class="na">getString</code><code class="o">(</code><code class="mi">0</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
    <code class="n">book</code><code class="o">.</code><code class="na">setAuthors</code><code class="o">(</code><code class="n">authors</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="kotlin" data-type="programlisting"><code class="k">object</code> <code class="nc">BookTransactions</code> <code class="p">{</code>&#13;
&#13;
  <code class="k">fun</code> <code class="nf">read</code><code class="p">(</code><code class="n">database</code><code class="p">:</code> <code class="n">SQLiteDatabase</code><code class="p">,</code> <code class="n">isbn</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Book</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">cursor</code> <code class="p">=</code> <code class="n">database</code><code class="p">.</code><code class="n">query</code><code class="p">(</code>&#13;
        <code class="n">DbHelper</code><code class="p">.</code><code class="n">BOOKS_TABLE_NAME</code><code class="p">,</code>&#13;
        <code class="k">null</code> <code class="p">,</code>&#13;
        <code class="n">DbHelper</code><code class="p">.</code><code class="n">BOOKS_COLUMN_ISBN</code> <code class="p">+</code> <code class="s">" = ?"</code><code class="p">,</code>&#13;
        <code class="n">arrayOf</code><code class="p">(</code><code class="n">isbn</code><code class="p">),</code> <code class="k">null</code><code class="p">,</code> <code class="k">null</code><code class="p">,</code> <code class="k">null</code><code class="p">,</code> <code class="s">"1"</code>&#13;
    <code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">book</code> <code class="p">=</code> <code class="n">Book</code><code class="p">()</code>&#13;
    <code class="n">book</code><code class="p">.</code><code class="n">isbn</code> <code class="p">=</code> <code class="n">isbn</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">cursor</code><code class="p">.</code><code class="n">moveToNext</code><code class="p">())</code> <code class="p">{</code>&#13;
      <code class="n">book</code><code class="p">.</code><code class="n">title</code> <code class="p">=</code> <code class="n">cursor</code><code class="p">.</code><code class="n">getString</code><code class="p">(</code><code class="m">0</code><code class="p">)</code>&#13;
      <code class="n">book</code><code class="p">.</code><code class="n">pageCount</code> <code class="p">=</code> <code class="n">cursor</code><code class="p">.</code><code class="n">getInt</code><code class="p">(</code><code class="m">2</code><code class="p">)</code>&#13;
      <code class="n">book</code><code class="p">.</code><code class="n">isFiction</code> <code class="p">=</code> <code class="n">cursor</code><code class="p">.</code><code class="n">getInt</code><code class="p">(</code><code class="m">3</code><code class="p">)</code> <code class="p">==</code> <code class="m">1</code>&#13;
      <code class="n">readAuthors</code><code class="p">(</code><code class="n">database</code><code class="p">,</code> <code class="n">book</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">cursor</code><code class="p">.</code><code class="n">close</code><code class="p">()</code>&#13;
    <code class="k">return</code> <code class="n">book</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">fun</code> <code class="nf">write</code><code class="p">(</code><code class="n">database</code><code class="p">:</code> <code class="n">SQLiteDatabase</code><code class="p">,</code> <code class="n">book</code><code class="p">:</code> <code class="n">Book</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">var</code> <code class="py">contentValues</code> <code class="p">=</code> <code class="n">ContentValues</code><code class="p">()</code>&#13;
    <code class="n">contentValues</code><code class="p">.</code><code class="n">put</code><code class="p">(</code><code class="n">DbHelper</code><code class="p">.</code><code class="n">BOOKS_COLUMN_ISBN</code><code class="p">,</code> <code class="n">book</code><code class="p">.</code><code class="n">isbn</code><code class="p">)</code>&#13;
    <code class="n">contentValues</code><code class="p">.</code><code class="n">put</code><code class="p">(</code><code class="n">DbHelper</code><code class="p">.</code><code class="n">BOOKS_COLUMN_TITLE</code><code class="p">,</code> <code class="n">book</code><code class="p">.</code><code class="n">title</code><code class="p">)</code>&#13;
    <code class="n">contentValues</code><code class="p">.</code><code class="n">put</code><code class="p">(</code><code class="n">DbHelper</code><code class="p">.</code><code class="n">BOOKS_COLUMN_PAGECOUNT</code><code class="p">,</code> <code class="n">book</code><code class="p">.</code><code class="n">pageCount</code><code class="p">)</code>&#13;
    <code class="n">contentValues</code><code class="p">.</code><code class="n">put</code><code class="p">(</code><code class="n">DbHelper</code><code class="p">.</code><code class="n">BOOKS_COLUMN_ISFICTION</code><code class="p">,</code> <code class="n">book</code><code class="p">.</code><code class="n">isFiction</code><code class="p">)</code>&#13;
    <code class="n">database</code><code class="p">.</code><code class="n">beginTransaction</code><code class="p">()</code>&#13;
    <code class="k">try</code> <code class="p">{</code>&#13;
      <code class="n">insertOrUpdate</code><code class="p">(</code>&#13;
          <code class="n">database</code><code class="p">,</code>&#13;
          <code class="n">DbHelper</code><code class="p">.</code><code class="n">BOOKS_TABLE_NAME</code><code class="p">,</code>&#13;
          <code class="n">contentValues</code><code class="p">,</code>&#13;
          <code class="n">DbHelper</code><code class="p">.</code><code class="n">BOOKS_COLUMN_ISBN</code> <code class="p">+</code> <code class="s">" = ? "</code><code class="p">,</code>&#13;
          <code class="n">arrayOf</code><code class="p">(</code><code class="n">book</code><code class="p">.</code><code class="n">isbn</code><code class="p">))</code>&#13;
      <code class="k">for</code> <code class="p">(</code><code class="n">author</code> <code class="k">in</code> <code class="n">book</code><code class="p">.</code><code class="n">authors</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">contentValues</code> <code class="p">=</code> <code class="n">ContentValues</code><code class="p">()</code>&#13;
        <code class="n">contentValues</code><code class="p">.</code><code class="n">put</code><code class="p">(</code><code class="n">DbHelper</code><code class="p">.</code><code class="n">AUTHORS_COLUMN_NAME</code><code class="p">,</code> <code class="n">author</code><code class="p">)</code>&#13;
        <code class="n">database</code><code class="p">.</code><code class="n">insertWithOnConflict</code><code class="p">(</code><code class="n">DbHelper</code><code class="p">.</code><code class="n">AUTHORS_TABLE_NAME</code><code class="p">,</code> <code class="k">null</code><code class="p">,</code> <code class="n">contentValues</code><code class="p">,</code>&#13;
          <code class="n">SQLiteDatabase</code><code class="p">.</code><code class="n">CONFLICT_IGNORE</code><code class="p">)</code>&#13;
      <code class="p">}</code>&#13;
      <code class="n">database</code><code class="p">.</code><code class="n">setTransactionSuccessful</code><code class="p">()</code>&#13;
      <code class="n">Log</code><code class="p">.</code><code class="n">d</code><code class="p">(</code><code class="s">"MyTag"</code><code class="p">,</code> <code class="s">"wrote data to database"</code><code class="p">)</code>&#13;
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">e</code><code class="p">:</code> <code class="n">Exception</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="n">Log</code><code class="p">.</code><code class="n">d</code><code class="p">(</code><code class="s">"MyTag"</code><code class="p">,</code> <code class="s">"there was a problem inserting data: "</code> <code class="p">+</code> <code class="n">e</code><code class="p">.</code><code class="n">message</code><code class="p">)</code>&#13;
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>&#13;
      <code class="n">Log</code><code class="p">.</code><code class="n">d</code><code class="p">(</code><code class="s">"MyTag"</code><code class="p">,</code> <code class="s">"finally"</code><code class="p">)</code>&#13;
      <code class="n">database</code><code class="p">.</code><code class="n">endTransaction</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">fun</code> <code class="nf">insertOrUpdate</code><code class="p">(</code><code class="n">database</code><code class="p">:</code> <code class="n">SQLiteDatabase</code><code class="p">,</code> <code class="n">table</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code> <code class="n">values</code><code class="p">:</code> <code class="n">ContentValues</code><code class="p">,</code>&#13;
  <code class="k">where</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="n">args</code><code class="p">:</code> <code class="n">Array</code><code class="p">&lt;</code><code class="n">String</code><code class="p">&gt;):</code> <code class="n">Boolean</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">rowId</code> <code class="p">=</code> <code class="n">database</code><code class="p">.</code><code class="n">insertWithOnConflict</code><code class="p">(</code><code class="n">table</code><code class="p">,</code> <code class="k">null</code><code class="p">,</code> <code class="n">values</code><code class="p">,</code>&#13;
    <code class="n">SQLiteDatabase</code><code class="p">.</code><code class="n">CONFLICT_IGNORE</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">rowId</code> <code class="p">&lt;</code> <code class="m">0</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="n">database</code><code class="p">.</code><code class="n">update</code><code class="p">(</code><code class="n">table</code><code class="p">,</code> <code class="n">values</code><code class="p">,</code> <code class="k">where</code><code class="p">,</code> <code class="n">args</code><code class="p">)</code>&#13;
      <code class="k">return</code> <code class="k">false</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">return</code> <code class="k">true</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">fun</code> <code class="nf">readAuthors</code><code class="p">(</code><code class="n">database</code><code class="p">:</code> <code class="n">SQLiteDatabase</code><code class="p">,</code> <code class="n">book</code><code class="p">:</code> <code class="n">Book</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">cursor</code> <code class="p">=</code> <code class="n">database</code><code class="p">.</code><code class="n">query</code><code class="p">(</code>&#13;
        <code class="n">DbHelper</code><code class="p">.</code><code class="n">AUTHORS_TABLE_NAME</code>&#13;
            <code class="p">+</code> <code class="s">" join "</code>&#13;
            <code class="p">+</code> <code class="n">DbHelper</code><code class="p">.</code><code class="n">BRIDGE_TABLE_NAME</code>&#13;
            <code class="p">+</code> <code class="s">" on "</code>&#13;
            <code class="p">+</code> <code class="n">DbHelper</code><code class="p">.</code><code class="n">AUTHORS_TABLE_NAME</code> <code class="p">+</code> <code class="s">"."</code> <code class="p">+</code> <code class="n">DbHelper</code><code class="p">.</code><code class="n">AUTHORS_COLUMN_ID</code>&#13;
            <code class="p">+</code> <code class="s">" = "</code>&#13;
            <code class="p">+</code> <code class="n">DbHelper</code><code class="p">.</code><code class="n">BRIDGE_TABLE_NAME</code> <code class="p">+</code> <code class="s">"."</code> <code class="p">+</code> <code class="n">DbHelper</code><code class="p">.</code><code class="n">BRIDGE_COLUMN_AUTHOR_ID</code><code class="p">,</code>&#13;
              <code class="c1">// String name of the table query</code>&#13;
        <code class="n">arrayOf</code><code class="p">(</code><code class="n">DbHelper</code><code class="p">.</code><code class="n">AUTHORS_COLUMN_NAME</code><code class="p">),</code> <code class="c1">// String array of columns</code>&#13;
        <code class="n">DbHelper</code><code class="p">.</code><code class="n">BRIDGE_COLUMN_AUTHOR_ID</code> <code class="p">+</code> <code class="s">" = ?"</code><code class="p">,</code> <code class="c1">// String WHERE clause</code>&#13;
        <code class="n">arrayOf</code><code class="p">(</code><code class="n">book</code><code class="p">.</code><code class="n">isbn</code><code class="p">),</code> <code class="k">null</code><code class="p">,</code> <code class="k">null</code><code class="p">,</code> <code class="k">null</code>&#13;
    <code class="p">)</code>&#13;
    <code class="k">var</code> <code class="py">i</code> <code class="p">=</code> <code class="m">0</code>&#13;
    <code class="k">while</code> <code class="p">(!</code><code class="n">cursor</code><code class="p">.</code><code class="n">isAfterLast</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="n">cursor</code><code class="p">.</code><code class="n">moveToNext</code><code class="p">()</code>&#13;
      <code class="n">book</code><code class="p">.</code><code class="n">authors</code><code class="p">[</code><code class="n">i</code><code class="p">++]</code> <code class="p">=</code> <code class="n">cursor</code><code class="p">.</code><code class="n">getString</code><code class="p">(</code><code class="m">0</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">cursor</code><code class="p">.</code><code class="n">close</code><code class="p">()</code>&#13;
  <code class="p">}</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>Now that we’ve got helpers to read and write <code>Book</code> data, let’s update our <code>DbHelper</code> class to read out <em>catalog.json</em> during the single <code>onCreate</code> invocation and write those entries to the database!</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177200380088">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">DbHelper</code> <code class="kd">extends</code> <code class="n">SQLiteOpenHelper</code> <code class="o">{</code>&#13;
&#13;
  <code class="kd">private</code> <code class="n">Context</code> <code class="n">mContext</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="nf">DbHelper</code><code class="o">(</code><code class="n">Context</code> <code class="n">context</code><code class="o">,</code> <code class="n">String</code> <code class="n">name</code><code class="o">,</code> <code class="n">SQLiteDatabase</code><code class="o">.</code><code class="na">CursorFactory</code> <code class="n">factory</code><code class="o">,</code>&#13;
  <code class="kt">int</code> <code class="n">version</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="kd">super</code><code class="o">(</code><code class="n">context</code><code class="o">,</code> <code class="n">name</code><code class="o">,</code> <code class="n">factory</code><code class="o">,</code> <code class="n">version</code><code class="o">);</code>&#13;
    <code class="n">mContext</code> <code class="o">=</code> <code class="n">context</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">onCreate</code><code class="o">(</code><code class="n">SQLiteDatabase</code> <code class="n">database</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">database</code><code class="o">.</code><code class="na">execSQL</code><code class="o">(</code><code class="n">BOOKS_CREATE_TABLE</code><code class="o">);</code>&#13;
    <code class="n">database</code><code class="o">.</code><code class="na">execSQL</code><code class="o">(</code><code class="n">AUTHORS_CREATE_TABLE</code><code class="o">);</code>&#13;
    <code class="n">database</code><code class="o">.</code><code class="na">execSQL</code><code class="o">(</code><code class="n">BRIDGE_CREATE_TABLE</code><code class="o">);</code>&#13;
    <code class="n">InputStream</code> <code class="n">stream</code> <code class="o">=</code> <code class="kc">null</code><code class="o">;</code>&#13;
    <code class="k">try</code> <code class="o">{</code>&#13;
      <code class="n">stream</code> <code class="o">=</code> <code class="n">mContext</code><code class="o">.</code><code class="na">getAssets</code><code class="o">().</code><code class="na">open</code><code class="o">(</code><code class="s">"catalog.json"</code><code class="o">);</code>&#13;
      <code class="n">String</code> <code class="n">json</code> <code class="o">=</code> <code class="n">Files</code><code class="o">.</code><code class="na">getStringFromStream</code><code class="o">(</code><code class="n">stream</code><code class="o">);</code>&#13;
      <code class="n">Books</code> <code class="n">books</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Gson</code><code class="o">().</code><code class="na">fromJson</code><code class="o">(</code><code class="n">json</code><code class="o">,</code> <code class="n">Books</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
      <code class="k">for</code> <code class="o">(</code><code class="n">Book</code> <code class="n">book</code> <code class="o">:</code> <code class="n">books</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">BookTransactions</code><code class="o">.</code><code class="na">write</code><code class="o">(</code><code class="n">database</code><code class="o">,</code> <code class="n">book</code><code class="o">);</code>&#13;
      <code class="o">}</code>&#13;
    <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="n">e</code><code class="o">.</code><code class="na">printStackTrace</code><code class="o">();</code>&#13;
    <code class="o">}</code> <code class="k">finally</code> <code class="o">{</code>&#13;
      <code class="k">if</code> <code class="o">(</code><code class="n">stream</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
          <code class="n">stream</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
          <code class="n">e</code><code class="o">.</code><code class="na">printStackTrace</code><code class="o">();</code>&#13;
        <code class="o">}</code>&#13;
      <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
    <code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyApp"</code><code class="o">,</code> <code class="n">BookTransactions</code><code class="o">.</code><code class="na">read</code><code class="o">(</code><code class="n">database</code><code class="o">,</code> <code class="s">"978-0439136365"</code><code class="o">).</code><code class="na">getTitle</code><code class="o">());</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">onUpgrade</code><code class="o">(</code><code class="n">SQLiteDatabase</code> <code class="n">database</code><code class="o">,</code> <code class="kt">int</code> <code class="n">i</code><code class="o">,</code> <code class="kt">int</code> <code class="n">i1</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="c1">// no op</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_TABLE_NAME</code> <code class="o">=</code> <code class="s">"BOOKS"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_COLUMN_TITLE</code> <code class="o">=</code> <code class="s">"TITLE"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_COLUMN_ISBN</code> <code class="o">=</code> <code class="s">"ISBN"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_COLUMN_PAGECOUNT</code> <code class="o">=</code> <code class="s">"PAGECOUNT"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_COLUMN_ISFICTION</code> <code class="o">=</code> <code class="s">"ISFICTION"</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">AUTHORS_TABLE_NAME</code> <code class="o">=</code> <code class="s">"AUTHORS"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">AUTHORS_COLUMN_ID</code> <code class="o">=</code> <code class="s">"ID"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">AUTHORS_COLUMN_NAME</code> <code class="o">=</code> <code class="s">"NAME"</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BRIDGE_TABLE_NAME</code> <code class="o">=</code> <code class="s">"BOOK_AUTHOR_BRIDGE"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BRIDGE_COLUMN_BOOK_ID</code> <code class="o">=</code> <code class="s">"BOOK_ID"</code><code class="o">;</code>&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BRIDGE_COLUMN_AUTHOR_ID</code> <code class="o">=</code> <code class="s">"AUTHOR_ID"</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BOOKS_CREATE_TABLE</code> <code class="o">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="o">+</code>&#13;
    <code class="n">BOOKS_TABLE_NAME</code> <code class="o">+</code> <code class="s">" ("</code> <code class="o">+</code>&#13;
      <code class="n">BOOKS_COLUMN_TITLE</code> <code class="o">+</code> <code class="s">" TEXT,"</code> <code class="o">+</code>&#13;
      <code class="n">BOOKS_COLUMN_ISBN</code> <code class="o">+</code> <code class="s">" TEXT,"</code> <code class="o">+</code>&#13;
      <code class="n">BOOKS_COLUMN_PAGECOUNT</code> <code class="o">+</code> <code class="s">" INT,"</code> <code class="o">+</code>&#13;
      <code class="n">BOOKS_COLUMN_ISFICTION</code> <code class="o">+</code> <code class="s">" BOOL);"</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">AUTHORS_CREATE_TABLE</code> <code class="o">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="o">+</code>&#13;
    <code class="n">AUTHORS_TABLE_NAME</code> <code class="o">+</code> <code class="s">" ("</code> <code class="o">+</code>&#13;
      <code class="n">AUTHORS_COLUMN_ID</code> <code class="o">+</code> <code class="s">" INTEGER PRIMARY KEY AUTOINCREMENT,"</code> <code class="o">+</code>&#13;
      <code class="n">AUTHORS_COLUMN_NAME</code> <code class="o">+</code> <code class="s">" TEXT)"</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">BRIDGE_CREATE_TABLE</code> <code class="o">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="o">+</code>&#13;
  <code class="n">BRIDGE_TABLE_NAME</code> <code class="o">+</code>&#13;
    <code class="s">" ("</code> <code class="o">+</code>&#13;
      <code class="n">BRIDGE_COLUMN_BOOK_ID</code> <code class="o">+</code> <code class="s">" INTEGER REFERENCES BOOKS,"</code> <code class="o">+</code>&#13;
      <code class="n">BRIDGE_COLUMN_AUTHOR_ID</code> <code class="o">+</code> <code class="s">" INTEGER REFERENCES AUTHORS)"</code><code class="o">;</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p class="less_space pagebreak-before"><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">DbHelper</code><code class="p">(</code><code class="k">private</code> <code class="k">val</code> <code class="py">context</code><code class="p">:</code> <code class="n">Context</code><code class="p">,</code> <code class="n">name</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
<code class="n">factory</code><code class="p">:</code> <code class="n">SQLiteDatabase</code><code class="p">.</code><code class="n">CursorFactory</code><code class="p">,</code>&#13;
  <code class="n">version</code><code class="p">:</code> <code class="n">Int</code><code class="p">)</code> <code class="p">:</code> <code class="n">SQLiteOpenHelper</code><code class="p">(</code><code class="n">mContext</code><code class="p">,</code> <code class="n">name</code><code class="p">,</code> <code class="n">factory</code><code class="p">,</code> <code class="n">version</code><code class="p">)</code> <code class="p">{</code>&#13;
&#13;
  <code class="k">override</code> <code class="k">fun</code> <code class="nf">onCreate</code><code class="p">(</code><code class="n">database</code><code class="p">:</code> <code class="n">SQLiteDatabase</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">database</code><code class="p">.</code><code class="n">execSQL</code><code class="p">(</code><code class="n">BOOKS_CREATE_TABLE</code><code class="p">)</code>&#13;
    <code class="n">database</code><code class="p">.</code><code class="n">execSQL</code><code class="p">(</code><code class="n">AUTHORS_CREATE_TABLE</code><code class="p">)</code>&#13;
    <code class="n">database</code><code class="p">.</code><code class="n">execSQL</code><code class="p">(</code><code class="n">BRIDGE_CREATE_TABLE</code><code class="p">)</code>&#13;
    <code class="k">val</code> <code class="py">stream</code> <code class="p">=</code> <code class="n">context</code><code class="p">.</code><code class="n">assets</code><code class="p">.</code><code class="k">open</code><code class="p">(</code><code class="s">"catalog.json"</code><code class="p">)</code>&#13;
    <code class="n">stream</code><code class="p">.</code><code class="n">use</code> <code class="p">{</code> <code class="n">s</code> <code class="p">-&gt;</code>&#13;
      <code class="k">val</code> <code class="py">json</code> <code class="p">=</code> <code class="n">Files</code><code class="p">.</code><code class="n">getStringFromStream</code><code class="p">(</code><code class="n">s</code><code class="p">)</code>&#13;
      <code class="k">val</code> <code class="py">books</code> <code class="p">=</code> <code class="n">Gson</code><code class="p">().</code><code class="n">fromJson</code><code class="p">(</code><code class="n">json</code><code class="p">,</code> <code class="n">Books</code><code class="o">::</code><code class="k">class</code><code class="p">.</code><code class="n">java</code><code class="p">)</code>&#13;
      <code class="k">for</code> <code class="p">(</code><code class="n">book</code> <code class="k">in</code> <code class="n">books</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">BookTransactions</code><code class="p">.</code><code class="n">write</code><code class="p">(</code><code class="n">database</code><code class="p">,</code> <code class="n">book</code><code class="p">)</code>&#13;
      <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">override</code> <code class="k">fun</code> <code class="nf">onUpgrade</code><code class="p">(</code><code class="n">database</code><code class="p">:</code> <code class="n">SQLiteDatabase</code><code class="p">,</code> <code class="n">i</code><code class="p">:</code> <code class="n">Int</code><code class="p">,</code> <code class="n">i1</code><code class="p">:</code> <code class="n">Int</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// no op</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="n">companion</code> <code class="k">object</code> <code class="err">{</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_TABLE_NAME</code> <code class="p">=</code> <code class="s">"BOOKS"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_COLUMN_TITLE</code> <code class="p">=</code> <code class="s">"TITLE"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_COLUMN_ISBN</code> <code class="p">=</code> <code class="s">"ISBN"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_COLUMN_PAGECOUNT</code> <code class="p">=</code> <code class="s">"PAGECOUNT"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_COLUMN_ISFICTION</code> <code class="p">=</code> <code class="s">"ISFICTION"</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">AUTHORS_TABLE_NAME</code> <code class="p">=</code> <code class="s">"AUTHORS"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">AUTHORS_COLUMN_ID</code> <code class="p">=</code> <code class="s">"ID"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">AUTHORS_COLUMN_NAME</code> <code class="p">=</code> <code class="s">"NAME"</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BRIDGE_TABLE_NAME</code> <code class="p">=</code> <code class="s">"BOOK_AUTHOR_BRIDGE"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BRIDGE_COLUMN_BOOK_ID</code> <code class="p">=</code> <code class="s">"BOOK_ID"</code>&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BRIDGE_COLUMN_AUTHOR_ID</code> <code class="p">=</code> <code class="s">"AUTHOR_ID"</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BOOKS_CREATE_TABLE</code> <code class="p">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="p">+</code> <code class="n">BOOKS_TABLE_NAME</code> <code class="p">+</code>&#13;
    <code class="s">" ("</code> <code class="p">+</code>&#13;
        <code class="n">BOOKS_COLUMN_TITLE</code> <code class="p">+</code> <code class="s">" TEXT,"</code> <code class="p">+</code>&#13;
        <code class="n">BOOKS_COLUMN_ISBN</code> <code class="p">+</code> <code class="s">" TEXT,"</code> <code class="p">+</code>&#13;
        <code class="n">BOOKS_COLUMN_PAGECOUNT</code> <code class="p">+</code> <code class="s">" INT,"</code> <code class="p">+</code>&#13;
        <code class="n">BOOKS_COLUMN_ISFICTION</code> <code class="p">+</code> <code class="s">" BOOL);"</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">AUTHORS_CREATE_TABLE</code> <code class="p">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="p">+</code> <code class="n">AUTHORS_TABLE_NAME</code> <code class="p">+</code>&#13;
        <code class="s">" ("</code> <code class="p">+</code> <code class="n">AUTHORS_COLUMN_ID</code> <code class="p">+</code> <code class="s">" INTEGER PRIMARY KEY AUTOINCREMENT,"</code> <code class="p">+</code>&#13;
        <code class="n">AUTHORS_COLUMN_NAME</code> <code class="p">+</code> <code class="s">" TEXT)"</code>&#13;
&#13;
    <code class="n">const</code> <code class="k">val</code> <code class="py">BRIDGE_CREATE_TABLE</code> <code class="p">=</code> <code class="s">"CREATE TABLE IF NOT EXISTS "</code> <code class="p">+</code> <code class="n">BRIDGE_TABLE_NAME</code> <code class="p">+</code>&#13;
    <code class="s">" ("</code> <code class="p">+</code>&#13;
        <code class="n">BRIDGE_COLUMN_BOOK_ID</code> <code class="p">+</code> <code class="s">" INTEGER REFERENCES BOOKS,"</code> <code class="p">+</code>&#13;
        <code class="n">BRIDGE_COLUMN_AUTHOR_ID</code> <code class="p">+</code> <code class="s">" INTEGER REFERENCES AUTHORS)"</code>&#13;
  <code class="p">}</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>Now, the first time you get a <code>SqliteDatabase</code> instance from your <code>DbHelper</code> class, <code>onCreate</code> will run and you’ll populate your database from the <em>catalog.json</em> file you installed with the app in the <em>assets</em> special directory! Not bad!</p>&#13;
&#13;
<p>We’ve spent a lot of time building out our persistence layer. We’re at the point where we’re about to display our saved books, but before we do that, let’s see what things look like in iOS before we continue.<a data-primary="" data-startref="Kpersstore19" data-type="indexterm" id="idm46177199202888"/><a data-primary="" data-startref="Jperstore19" data-type="indexterm" id="idm46177199202024"/><a data-primary="" data-startref="Aperstore19" data-type="indexterm" id="idm46177199201080"/><a data-primary="" data-startref="Pandstore19" data-type="indexterm" id="idm46177198853960"/><a data-primary="" data-startref="APandstor19" data-type="indexterm" id="idm46177198853016"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="iOS" data-type="sect2"><div class="sect2" id="idm46177201840760">&#13;
<h2>iOS</h2>&#13;
&#13;
<p>For<a data-primary="iOS" data-secondary="persistence" data-tertiary="storing data" data-type="indexterm" id="IOSperstore19"/><a data-primary="application persistence" data-secondary="iOS" data-tertiary="storing data" data-type="indexterm" id="APiosstore19"/><a data-primary="persistence" data-secondary="iOS" data-tertiary="storing data" data-type="indexterm" id="Piosstore19"/> Android, we used a database with raw SQL calls to get our data. On iOS, we have another option that allows us to work directly inside of Swift without having to deal with raw SQL: Core Data.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Core Data" data-type="sect3"><div class="sect3" id="idm46177198845544">&#13;
<h3>Core Data</h3>&#13;
&#13;
<p>Let’s<a data-primary="Core Data" data-secondary="adding support for" data-type="indexterm" id="idm46177198844008"/> get this out of the way now: Core Data is not a database. Core Data is an <em>object graph</em> that just <em>happens</em> to use a database as its backing store. It’s a framework available for iOS (and other Apple platforms) that is meant to make working with the data model layer and its persistence seamless and (fairly) easy.</p>&#13;
&#13;
<p>It can be incredibly complex, but for 90% of use cases, it’s a great option for apps. It’s perfect for our application. Why don’t we add it to our project?</p>&#13;
&#13;
<p>To add support for Core Data to an existing project, there are a few things that you need:</p>&#13;
<ol>&#13;
<li>&#13;
<p>A data model file and any entities defined</p>&#13;
</li>&#13;
<li>&#13;
<p>A data controller that handles setting up the Core Data stack</p>&#13;
</li>&#13;
<li>&#13;
<p>Initialization logic in your app’s start-up logic</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Getting started with the model file" data-type="sect3"><div class="sect3" id="idm46177198837528">&#13;
<h3>Getting started with the model file</h3>&#13;
&#13;
<p>Our first item on the list, a data model file, is the easiest one to check off. Go to File &gt; New &gt; File in Xcode and scroll down a bit to the Core Data section. There, select Data Model and hit Next. Let’s name our model “LibraryModel” to keep things simple, but really you could name this model whatever you wanted. You should see a file named <em>LibraryModel.xcdatamodel</em>, in your project files.</p>&#13;
&#13;
<p>Core Data uses entities with associated attributes as backing objects. If you click on <em>LibraryModel.xcdatamodel</em> you’ll see an empty list of entities.</p>&#13;
&#13;
<p>We’re at an inflection point here.</p>&#13;
&#13;
<p>We could continue to use our existing <em>Book.swift</em> structure that we’ve been using already and create a separate entity that’s specific to saved books that just contains some kind of identifier (a unique string, for example). This has the benefit of keeping our Core Data stack lightweight. However, it treats Core Data more like a database and limits its true potential in managing the entirety of our model layer.</p>&#13;
&#13;
<p>Instead, we’re going to continue using our <em>catalog.json</em> file as the source of our library data, but only the first time the application starts. This allows us to use Core Data as a cache, of sorts, so we don’t have to read that entire file into memory whenever we want to view the library’s catalog.</p>&#13;
&#13;
<p>To<a data-primary="Core Data" data-secondary="adding entities to" data-type="indexterm" id="idm46177198830936"/> add an entity to Core Data, click the Add Entity button at the bottom of the screen. You’ll see an entity gets created with the generic name of “Entity” in the list of entities. Click to show the Entity inspector on the right side of the screen. Change the Entity name from “Entity” to “Book” and under Class, change the name to “BookManagedObject” to separate the actual file name of our managed object from our entity’s name. The reason for this is to allow us to recognize we are dealing with a Core Data–managed object whenever we deal with objects of the type <code>BookManagedObject</code>.</p>&#13;
&#13;
<p>The existing properties inside our <em>Book.swift</em> file need to be re-created as attributes inside of our <code>Book</code> entity. Do this by clicking the plus symbol under Attributes and adding each existing property and its associated type (e.g., <code>String</code>, <code>Int</code>, <code>Bool</code>, etc.) for each property inside our preexisting <code>Book</code> structure.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>For the <code>authors</code> property, you need to specify the type as “Transformable.” Then, with that attribute selected, in the Data Model inspector, set the Custom Class type to <code>[String]</code> to indicate in the generated file that it’s a <code>String</code> array.</p>&#13;
</div>&#13;
&#13;
<p>Now that we have our <code>Book</code> entity defined, let’s have Xcode generate our file for us. Select the book entity in the editor. Show the Data Model inspector and under Codegen change it from Class Definition to Category/Extension. Click Editor &gt; Create NSManagedObject Subclass in the menu bar and hit Next a few times for the default values.</p>&#13;
&#13;
<p>You’ll notice, once everything has been generated, that two new files were created: <em>BookManagedObject+CoreDataClass.swift</em> and <em>BookManagedObject+CoreDataProperties.swift</em>. The first file is technically unnecessary, so go ahead and drag it to the trash. The second file contains all the Core Data attributes we added as Swift properties decorated with <code>@NSManaged</code>. This is some syntactic sugar to let the compiler know Core Data is managing this particular property.</p>&#13;
&#13;
<p>We are going to use this extension eventually to add some functionality to our model. For now, though, let’s finish setting up the rest of our Core Data stack.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Initializing our stack" data-type="sect3"><div class="sect3" id="idm46177198836904">&#13;
<h3>Initializing our stack</h3>&#13;
&#13;
<p>There<a data-primary="Core Data" data-secondary="initializing the stack" data-type="indexterm" id="idm46177198817416"/> are three parts to the Core Data stack:</p>&#13;
<ol>&#13;
<li>&#13;
<p>The data model file, which we’ve just created. It holds our entity descriptions.</p>&#13;
</li>&#13;
<li>&#13;
<p>The persistent store container, which provides the link to our application and our persistent store. In this case, it will be backed by a SQLite database, but it could be XML or in-memory storage.</p>&#13;
</li>&#13;
<li>&#13;
<p>The managed object context, which is the “scratch pad” of sorts where all our <code>BookManagedObject</code> instances live while they’re active; this is what’s actually persisted to the database.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>We’ve taken care of (1) <em>LibraryModel.xcdatamodel</em> is our data model file. But, we still need to set up (2) and (3). Usually, our Core Data stack is initialized on app startup. We’ll wrap everything in a <code>DataController</code> object to make things a bit easier to work with as well.</p>&#13;
&#13;
<p>In Xcode, create a new Swift file named <code>DataController</code> and add it to your project. Here’s what <code>DataController</code> should look like:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">import</code> <code class="nc">Foundation</code>&#13;
<code class="kd">import</code> <code class="nc">CoreData</code>&#13;
&#13;
<code class="kd">class</code> <code class="nc">DataController</code> <code class="p">{</code>&#13;
    <code class="kd">var</code> <code class="nv">persistentContainer</code><code class="p">:</code> <code class="n">NSPersistentContainer</code>&#13;
&#13;
    <code class="kd">init</code><code class="p">(</code><code class="n">completion</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">()</code> <code class="p">-&gt;</code> <code class="p">())</code> <code class="p">{</code>&#13;
        <code class="n">persistentContainer</code> <code class="p">=</code> <code class="n">NSPersistentContainer</code><code class="p">(</code><code class="n">name</code><code class="p">:</code> <code class="s">"LibraryModel"</code><code class="p">)</code>&#13;
        <code class="n">persistentContainer</code><code class="p">.</code><code class="n">loadPersistentStores</code> <code class="p">{</code> <code class="p">(</code><code class="n">description</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
            <code class="k">if</code> <code class="kd">let</code> <code class="nv">error</code> <code class="p">=</code> <code class="n">error</code> <code class="p">{</code>&#13;
                <code class="bp">fatalError</code><code class="p">(</code><code class="s">"Core Data stack could not be loaded. </code><code class="si">\(</code><code class="n">error</code><code class="si">)</code><code class="s">"</code><code class="p">)</code>&#13;
            <code class="p">}</code>&#13;
&#13;
            <code class="c1">// Called once initialization of Core Data stack is complete</code>&#13;
            <code class="n">DispatchQueue</code><code class="p">.</code><code class="n">main</code><code class="p">.</code><code class="n">async</code> <code class="p">{</code>&#13;
                <code class="n">completion</code><code class="p">()</code>&#13;
            <code class="p">}</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Let’s walk through what’s happening here. First, we’re initializing our <code>DataController</code> with a completion handler in the <code>init(completion:)</code> method. This completion handler will be called after everything has been set up and allows the application startup to continue.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The store will load serially on whatever thread it’s called from. We can add the store asynchronously by adding a new description for the store when it boots up with the property <code>shouldAddStore<span class="keep-together">Asynchronously</span></code> set to <code>true</code>. For this example, however, we are not using this property to simplify the loading of the Core Data stack.</p>&#13;
</div>&#13;
&#13;
<p>Inside the initializer, we first assign the object’s instance variable, <code>persistentContainer</code>, to a new instance of an <code>NSPersistentContainer</code>. This container does a lot of the setup of linking the data model file and the persistent store coordinator. It’s the “glue” between these two objects. To create it, we pass in the name of our data model file, minus the extension. Once that is created, we take the persistent container object and call <code>loadPersistentStores(_:)</code> on it and pass in a closure with a bit of error checking. If the database can’t be connected, the model file can’t be read, or any number of errors, we call <code>fatalError</code> to kill the application. Finally, if the store was loaded correctly, we call <code>completion()</code>, which is the original closure we passed in during <code>DataController</code>’s initialization.</p>&#13;
&#13;
<p>We’ve got our persistent store set up, and through that process, we’ve also got our managed object context set up through the persistent container as a property. We’ll dive into how to use it in a bit. For now, let’s finish setting up our stack and use the <code>DataController</code> object we just created.</p>&#13;
&#13;
<p>Open up <em>AppDelegate.swift</em>. Add a new property called <code>dataController</code> with the type <code>DataController!</code>. Inside the <code>application(_:didFinishLaunchingWithOptions:)</code> method insert the following lines above the <code>return true</code> statement at the bottom:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="c1">// Initialize the Core Data stack</code>&#13;
<code class="n">dataController</code> <code class="p">=</code> <code class="n">DataController</code><code class="p">()</code> <code class="p">{</code>&#13;
	<code class="c1">// Override point to update user interface that initialization has completed</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Your <code>AppDelegate</code> should look mostly like this:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">class</code> <code class="nc">AppDelegate</code><code class="p">:</code> <code class="bp">UIResponder</code><code class="p">,</code> <code class="bp">UIApplicationDelegate</code> <code class="p">{</code>&#13;
&#13;
    <code class="kd">var</code> <code class="nv">window</code><code class="p">:</code> <code class="bp">UIWindow</code><code class="p">?</code>&#13;
    <code class="kd">var</code> <code class="nv">dataController</code><code class="p">:</code> <code class="n">DataController</code><code class="p">!</code>&#13;
&#13;
&#13;
    <code class="kd">func</code> <code class="nf">application</code><code class="p">(</code><code class="kc">_</code> <code class="n">application</code><code class="p">:</code> <code class="bp">UIApplication</code><code class="p">,</code>&#13;
        <code class="n">didFinishLaunchingWithOptions</code> <code class="n">launchOptions</code><code class="p">:</code> <code class="p">[</code><code class="bp">UIApplication</code><code class="p">.</code><code class="n">LaunchOptionsKey</code><code class="p">:</code>&#13;
        <code class="nb">Any</code><code class="p">]?)</code> <code class="p">-&gt;</code> <code class="nb">Bool</code> <code class="p">{</code>&#13;
&#13;
        <code class="c1">// Initialize the Core Data stack</code>&#13;
        <code class="n">dataController</code> <code class="p">=</code> <code class="n">DataController</code><code class="p">()</code> <code class="p">{</code>&#13;
            <code class="bp">print</code><code class="p">(</code><code class="s">"Core Data stack has been initialized."</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="k">return</code> <code class="kc">true</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="p">...</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>If you build and run the app, you’ll see the following text in Xcode’s console: <code>Core Data stack has been initialized.</code></p>&#13;
&#13;
<p>Yes! Our Core Data stack is up and running, however nothing is actually powered by Core Data right now. It’s still powered by <em>catalog.json</em>. Let’s switch from using the raw JSON file in our <code>ListDataSource</code> to using Core Data directly.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Switching from JSON to Core Data" data-type="sect3"><div class="sect3" id="idm46177198818392">&#13;
<h3>Switching from JSON to Core Data</h3>&#13;
&#13;
<p>We<a data-primary="Core Data" data-secondary="switching from JSON to" data-type="indexterm" id="CDswitch19"/><a data-primary="JSON (JavaScript Object Notation)" data-secondary="switching to Core Data from" data-type="indexterm" id="JSONswitch19"/> can do this by first creating a new extension on <code>BookManagedObject</code>. You can do this in a new file. Normal practice for Swift extensions is to have the file named something like <em>BookManagedObject+Extensions.swift</em>. Inside this file, we’ll create a new fetched results controller, which is essentially an object that controls the results of a Core Data fetch. Here’s what our extension should contain:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">import</code> <code class="nc">Foundation</code>&#13;
<code class="kd">import</code> <code class="nc">CoreData</code>&#13;
&#13;
<code class="kd">extension</code> <code class="nc">BookManagedObject</code> <code class="p">{</code>&#13;
    <code class="kd">class</code> <code class="nc">func</code> <code class="n">newCatalogResultsController</code><code class="p">(</code><code class="n">with</code> <code class="n">dataController</code><code class="p">:</code> <code class="n">DataController</code><code class="p">,</code>&#13;
      <code class="n">delegate</code><code class="p">:</code> <code class="bp">NSFetchedResultsControllerDelegate</code><code class="p">?)</code> <code class="p">-&gt;</code>&#13;
      <code class="bp">NSFetchedResultsController</code><code class="p">&lt;</code><code class="n">BookManagedObject</code><code class="p">&gt;</code> <code class="p">{</code>&#13;
        <code class="kd">let</code> <code class="nv">request</code> <code class="p">=</code> <code class="bp">NSFetchRequest</code><code class="p">&lt;</code><code class="n">BookManagedObject</code><code class="p">&gt;(</code><code class="n">entityName</code><code class="p">:</code> <code class="s">"Book"</code><code class="p">)</code>&#13;
&#13;
        <code class="c1">// Add a sort by title description to the fetch request</code>&#13;
        <code class="kd">let</code> <code class="nv">titleSort</code> <code class="p">=</code> <code class="bp">NSSortDescriptor</code><code class="p">(</code><code class="n">key</code><code class="p">:</code> <code class="s">"title"</code><code class="p">,</code> <code class="n">ascending</code><code class="p">:</code> <code class="kc">true</code><code class="p">)</code>&#13;
        <code class="n">request</code><code class="p">.</code><code class="n">sortDescriptors</code> <code class="p">=</code> <code class="p">[</code><code class="n">titleSort</code><code class="p">]</code>&#13;
&#13;
        <code class="kd">let</code> <code class="nv">context</code> <code class="p">=</code> <code class="n">dataController</code><code class="p">.</code><code class="n">persistentContainer</code><code class="p">.</code><code class="n">viewContext</code>&#13;
        <code class="kd">let</code> <code class="nv">fetchedResultsController</code> <code class="p">=</code>&#13;
          <code class="bp">NSFetchedResultsController</code><code class="p">(</code><code class="n">fetchRequest</code><code class="p">:</code> <code class="n">request</code><code class="p">,</code> <code class="n">managedObjectContext</code><code class="p">:</code> <code class="n">context</code><code class="p">,</code>&#13;
          <code class="n">sectionNameKeyPath</code><code class="p">:</code> <code class="kc">nil</code><code class="p">,</code> <code class="n">cacheName</code><code class="p">:</code> <code class="s">"catalog.cache"</code><code class="p">)</code>&#13;
&#13;
        <code class="c1">// Assign the delegate to handle updates</code>&#13;
        <code class="n">fetchedResultsController</code><code class="p">.</code><code class="n">delegate</code> <code class="p">=</code> <code class="n">delegate</code>&#13;
&#13;
        <code class="k">do</code> <code class="p">{</code>&#13;
            <code class="k">try</code> <code class="n">fetchedResultsController</code><code class="p">.</code><code class="n">performFetch</code><code class="p">()</code>&#13;
        <code class="p">}</code> <code class="k">catch</code> <code class="p">{</code>&#13;
            <code class="bp">fatalError</code><code class="p">(</code><code class="s">"Catalog fetch could not be completed. </code><code class="si">\(</code><code class="n">error</code><code class="si">)</code><code class="s">"</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="k">return</code> <code class="n">fetchedResultsController</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>There’s a lot going on here, but really only a few important things. First, we’re creating a new fetch request. Fetch requests are how we query Core Data for our model objects. We’re sorting this request by <code>title</code>, which seems like the most appropriate way to sort for a list of books. Next, we’re grabbing the <code>viewContext</code> as the managed object context we’re going to be operating on for this fetch. The <code>viewContext</code> is the context that operates on the main thread. It’s perfectly acceptable, and recommended, to view managed objects on the main thread. However, if we were writing objects, we’d be performing our actions on a background thread instead.</p>&#13;
&#13;
<p>After we get our context, we create a fetched results controller object of type <code>NSFetchedResultsController</code>. This is a purpose-built Core Data object used to power fetched objects and supply them to a data source like a table view data source or collection view data source. Eventually, we’ll have our <code>ListDataSource</code> adhere to the delegate protocol <code>NSFetchedResultsControllerDelegate</code> that we’re assigning here so it can receive updates and populate the table view, but for now, we’re just setting the property on <code>fetchedResultsController</code> to what’s passed in.</p>&#13;
&#13;
<p>Finally, we perform the actual fetch in Core Data with <code>performFetch()</code>. This method can <code>throw</code>, so it’s wrapped in a <code>try</code> block to capture any errors. For the sample app, we’re just calling <code>fatalError</code>, but in a production app, it would be important to catch the error and handle it appropriately or display messaging to the user.</p>&#13;
&#13;
<p>Let’s use this extension and wire up our data source.</p>&#13;
&#13;
<p>Head over to <code>ListDataSource</code>. We’re going to perform a few updates to this file. The first thing to update is to remove the <code>data</code> property we’ve been using to lazy load the JSON files. Replace that with a new <code>fetchedResultsController</code> property like so:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">var</code> <code class="nv">fetchedResultsController</code><code class="p">:</code> <code class="bp">NSFetchedResultsController</code><code class="p">&lt;</code><code class="n">BookManagedObject</code><code class="p">&gt;?</code></pre>&#13;
&#13;
<p>Next, we need to add a new method to <code>ListDataSource</code> called <code>fetchCatalogResults</code> that create our catalog fetched results controller we just created earlier. We’ll store this in our new property:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">func</code> <code class="nf">fetchCatalogResults</code><code class="p">(</code><code class="n">with</code> <code class="n">dataController</code><code class="p">:</code> <code class="n">DataController</code><code class="p">)</code> <code class="p">{</code>&#13;
	<code class="n">fetchedResultsController</code> <code class="p">=</code>&#13;
    <code class="n">BookManagedObject</code><code class="p">.</code><code class="n">newCatalogResultsController</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">dataController</code><code class="p">,</code> <code class="n">delegate</code><code class="p">:</code> <code class="kc">nil</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Next, we need to add a new method to <code>ListDataSource</code> called <code>fetchCatalogResults</code> that initializes an instance of the fetched results controller we created earlier. We then take that instance and store it in our new property like so:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">import</code> <code class="nc">UIKit</code>&#13;
<code class="kd">import</code> <code class="nc">CoreData</code>&#13;
&#13;
<code class="kd">class</code> <code class="nc">ListDataSource</code><code class="p">:</code> <code class="bp">NSObject</code> <code class="p">{</code>&#13;
    <code class="kd">var</code> <code class="nv">fetchedResultsController</code><code class="p">:</code> <code class="bp">NSFetchedResultsController</code><code class="p">&lt;</code><code class="n">BookManagedObject</code><code class="p">&gt;?</code>&#13;
&#13;
    <code class="kd">func</code> <code class="nf">fetchCatalogResults</code><code class="p">(</code><code class="n">with</code> <code class="n">dataController</code><code class="p">:</code> <code class="n">DataController</code><code class="p">,</code>&#13;
      <code class="n">delegate</code><code class="p">:</code> <code class="bp">NSFetchedResultsControllerDelegate</code><code class="p">?)</code> <code class="p">{</code>&#13;
        <code class="n">fetchedResultsController</code> <code class="p">=</code>&#13;
          <code class="n">BookManagedObject</code><code class="p">.</code><code class="n">newCatalogResultsController</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">dataController</code><code class="p">,</code> <code class="n">delegate</code><code class="p">:</code>&#13;
          <code class="n">delegate</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kd">func</code> <code class="nf">book</code><code class="p">(</code><code class="k">for</code> <code class="n">indexPath</code><code class="p">:</code> <code class="n">IndexPath</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="n">Book</code><code class="p">?</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="n">fetchedResultsController</code><code class="p">?.</code><code class="n">object</code><code class="p">(</code><code class="n">at</code><code class="p">:</code> <code class="n">indexPath</code><code class="p">).</code><code class="n">book</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
<code class="kd">extension</code> <code class="nc">ListDataSource</code><code class="p">:</code> <code class="bp">UITableViewDataSource</code> <code class="p">{</code>&#13;
    <code class="kd">func</code> <code class="nf">tableView</code><code class="p">(</code><code class="kc">_</code> <code class="n">tableView</code><code class="p">:</code> <code class="bp">UITableView</code><code class="p">,</code> <code class="n">numberOfRowsInSection</code> <code class="n">section</code><code class="p">:</code> <code class="nb">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">Int</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="n">fetchedResultsController</code><code class="p">?.</code><code class="n">sections</code><code class="p">?[</code><code class="n">section</code><code class="p">].</code><code class="n">numberOfObjects</code> <code class="p">??</code> <code class="mi">0</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kd">func</code> <code class="nf">tableView</code><code class="p">(</code><code class="kc">_</code> <code class="n">tableView</code><code class="p">:</code> <code class="bp">UITableView</code><code class="p">,</code>&#13;
        <code class="n">cellForRowAt</code> <code class="n">indexPath</code><code class="p">:</code> <code class="n">IndexPath</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="bp">UITableViewCell</code> <code class="p">{</code>&#13;
        <code class="c1">// Dequeue a table view cell</code>&#13;
        <code class="kd">let</code> <code class="nv">cell</code> <code class="p">=</code>&#13;
          <code class="n">tableView</code><code class="p">.</code><code class="n">dequeueReusableCell</code><code class="p">(</code><code class="n">withIdentifier</code><code class="p">:</code> <code class="s">"CatalogTableViewCell"</code><code class="p">,</code> <code class="k">for</code><code class="p">:</code>&#13;
          <code class="n">indexPath</code><code class="p">)</code>&#13;
&#13;
        <code class="c1">// Find the correct book based on the row being populated</code>&#13;
        <code class="k">guard</code> <code class="kd">let</code> <code class="nv">book</code> <code class="p">=</code> <code class="n">fetchedResultsController</code><code class="p">?.</code><code class="n">object</code><code class="p">(</code><code class="n">at</code><code class="p">:</code> <code class="n">indexPath</code><code class="p">)</code> <code class="k">else</code> <code class="p">{</code>&#13;
            <code class="bp">fatalError</code><code class="p">(</code><code class="s">"Could not retrieve book instance."</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="c1">// Populate the table view cell title label with the book title</code>&#13;
        <code class="n">cell</code><code class="p">.</code><code class="n">textLabel</code><code class="p">?.</code><code class="n">text</code> <code class="p">=</code> <code class="n">book</code><code class="p">.</code><code class="n">title</code>&#13;
&#13;
        <code class="k">return</code> <code class="n">cell</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>We’ve used <code>fetchedResultsController</code> to supply the results where possible. The only thing to note is that in the method <code>book(for:)</code> we grab a <code>BookManagedObject</code> but then convert that using the extension method we created earlier to make it a <code>Book</code> instance. We’ll continue to use <code>Book</code> instances throughout the view controller and view layers of our application instead of passed-around managed object instances directly.</p>&#13;
&#13;
<p>The only missing piece is to switch <code>CatalogViewController</code> over to use the new data source methods. We do this by calling <code>dataSource.fetchCatalogResults(with:delegate:)</code> in the lazy loaded property <code>dataSource</code> like so:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kr">lazy</code> <code class="kd">var</code> <code class="nv">dataSource</code><code class="p">:</code> <code class="n">ListDataSource</code> <code class="p">=</code> <code class="p">{</code>&#13;
	<code class="kd">let</code> <code class="nv">listDataSource</code> <code class="p">=</code> <code class="n">ListDataSource</code><code class="p">()</code>&#13;
	<code class="kd">let</code> <code class="nv">dataController</code> <code class="p">=</code> <code class="p">(</code><code class="bp">UIApplication</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">delegate</code> <code class="k">as</code><code class="p">?</code>&#13;
	<code class="n">AppDelegate</code><code class="p">)</code><code class="o">!</code><code class="p">.</code><code class="n">dataController</code><code class="p">!</code>&#13;
	<code class="n">listDataSource</code><code class="p">.</code><code class="n">fetchCatalogResults</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">dataController</code><code class="p">,</code> <code class="n">delegate</code><code class="p">:</code> <code class="kc">nil</code><code class="p">)</code>&#13;
	<code class="k">return</code> <code class="n">listDataSource</code>&#13;
<code class="p">}()</code></pre>&#13;
&#13;
<p>Build and run the application and you’ll see…nothing in the catalog results.</p>&#13;
&#13;
<p>If you’ll recall, we created our Core Data objects, but we <em>did not</em> populate it with data. A common approach for this with iOS apps is to bundle the application with either a database that’s been pre-populated or some sort of data to jump-start the application via the web or inside the app bundle. In this instance, we’re going to use our <em>catalog.json</em> to pre-populate the database if it didn’t exist before it was created.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Seeding the database" data-type="sect3"><div class="sect3" id="idm46177198533368">&#13;
<h3>Seeding the database</h3>&#13;
&#13;
<p>Open up the <code>DataController</code> we created earlier. Add the following code to the top of the <code>init(with:)</code> method along with a new variable called <code>shouldSeedDatabase</code>:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">var</code> <code class="nv">shouldSeedDatabase</code><code class="p">:</code> <code class="nb">Bool</code> <code class="p">=</code> <code class="kc">false</code>&#13;
&#13;
<code class="kd">init</code><code class="p">(</code><code class="n">completion</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">()</code> <code class="p">-&gt;</code> <code class="p">())</code> <code class="p">{</code>&#13;
	<code class="c1">// Check if the database exists</code>&#13;
	<code class="k">do</code> <code class="p">{</code>&#13;
		<code class="kd">let</code> <code class="nv">databaseUrl</code> <code class="p">=</code>&#13;
      <code class="k">try</code> <code class="n">FileManager</code><code class="p">.</code><code class="k">default</code><code class="p">.</code><code class="n">url</code><code class="p">(</code><code class="k">for</code><code class="p">:</code> <code class="p">.</code><code class="n">applicationSupportDirectory</code><code class="p">,</code> <code class="k">in</code><code class="p">:</code> <code class="p">.</code><code class="n">userDomainMask</code><code class="p">,</code>&#13;
      <code class="n">appropriateFor</code><code class="p">:</code> <code class="kc">nil</code><code class="p">,</code> <code class="n">create</code><code class="p">:</code> <code class="kc">false</code><code class="p">).</code><code class="n">appendingPathComponent</code><code class="p">(</code><code class="s">"LibraryModel.sqlite"</code><code class="p">)</code>&#13;
		<code class="n">shouldSeedDatabase</code> <code class="p">=</code> <code class="o">!</code><code class="n">FileManager</code><code class="p">.</code><code class="k">default</code><code class="p">.</code><code class="n">fileExists</code><code class="p">(</code><code class="n">atPath</code><code class="p">:</code>&#13;
	<code class="n">databaseUrl</code><code class="p">.</code><code class="n">path</code><code class="p">)</code>&#13;
	<code class="p">}</code> <code class="k">catch</code> <code class="p">{</code>&#13;
		<code class="n">shouldSeedDatabase</code> <code class="p">=</code> <code class="kc">true</code>&#13;
	<code class="p">}</code>&#13;
&#13;
	<code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>First, we grab the database path where it’s expected to be. Then, we set the variable <code>shouldSeedDatabase</code> to <code>true</code> if the database doesn’t exist yet. It’s a simple bit of logic, but useful. Now, let’s create the method that actually seeds the database. We’ll call it <code>seedData()</code>:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">private</code> <code class="kd">func</code> <code class="nf">seedData</code><code class="p">()</code> <code class="p">{</code>&#13;
	<code class="k">do</code> <code class="p">{</code>&#13;
		<code class="k">guard</code> <code class="kd">let</code> <code class="nv">rawCatalogData</code> <code class="p">=</code>&#13;
      <code class="k">try</code><code class="p">?</code> <code class="n">Data</code><code class="p">(</code><code class="n">contentsOf</code><code class="p">:</code>&#13;
      <code class="n">Bundle</code><code class="p">.</code><code class="n">main</code><code class="p">.</code><code class="n">bundleURL</code><code class="p">.</code><code class="n">appendingPathComponent</code><code class="p">(</code><code class="s">"catalog.json"</code><code class="p">))</code> <code class="k">else</code> <code class="p">{</code>&#13;
			<code class="k">return</code>&#13;
		<code class="p">}</code>&#13;
		<code class="kd">let</code> <code class="nv">books</code> <code class="p">=</code> <code class="k">try</code> <code class="n">JSONDecoder</code><code class="p">().</code><code class="n">decode</code><code class="p">([</code><code class="n">Book</code><code class="p">].</code><code class="kc">self</code><code class="p">,</code> <code class="n">from</code><code class="p">:</code> <code class="n">rawCatalogData</code><code class="p">)</code>&#13;
&#13;
		<code class="n">persistentContainer</code><code class="p">.</code><code class="n">performBackgroundTask</code> <code class="p">{</code> <code class="p">(</code><code class="n">managedObjectContext</code><code class="p">)</code> <code class="k">in</code>&#13;
			<code class="c1">// Loop through the books in the JSON and add to the database</code>&#13;
			<code class="n">books</code><code class="p">.</code><code class="n">forEach</code> <code class="p">{</code> <code class="p">(</code><code class="n">book</code><code class="p">)</code> <code class="k">in</code>&#13;
				<code class="kd">let</code> <code class="nv">bookManagedObject</code> <code class="p">=</code>&#13;
          <code class="n">BookManagedObject</code><code class="p">(</code><code class="n">context</code><code class="p">:</code> <code class="n">managedObjectContext</code><code class="p">)</code>&#13;
				<code class="n">bookManagedObject</code><code class="p">.</code><code class="n">title</code> <code class="p">=</code> <code class="n">book</code><code class="p">.</code><code class="n">title</code>&#13;
				<code class="n">bookManagedObject</code><code class="p">.</code><code class="n">authors</code> <code class="p">=</code> <code class="n">book</code><code class="p">.</code><code class="n">authors</code>&#13;
				<code class="n">bookManagedObject</code><code class="p">.</code><code class="n">isbn</code> <code class="p">=</code> <code class="n">book</code><code class="p">.</code><code class="n">isbn</code>&#13;
				<code class="n">bookManagedObject</code><code class="p">.</code><code class="n">pageCount</code> <code class="p">=</code> <code class="nb">Int16</code><code class="p">(</code><code class="n">book</code><code class="p">.</code><code class="n">pageCount</code><code class="p">)</code>&#13;
				<code class="n">bookManagedObject</code><code class="p">.</code><code class="n">fiction</code> <code class="p">=</code> <code class="n">book</code><code class="p">.</code><code class="n">fiction</code>&#13;
			<code class="p">}</code>&#13;
			<code class="k">do</code> <code class="p">{</code>&#13;
				<code class="k">try</code> <code class="n">managedObjectContext</code><code class="p">.</code><code class="n">save</code><code class="p">()</code>&#13;
			<code class="p">}</code> <code class="k">catch</code> <code class="p">{</code>&#13;
				<code class="bp">print</code><code class="p">(</code><code class="s">"Could not save managed object context. </code><code class="si">\(</code><code class="n">error</code><code class="si">)</code><code class="s">"</code><code class="p">)</code>&#13;
			<code class="p">}</code>&#13;
		<code class="p">}</code>&#13;
&#13;
	<code class="p">}</code> <code class="k">catch</code> <code class="p">{</code>&#13;
		<code class="bp">print</code><code class="p">(</code><code class="s">"Catalog.json was not found or is not decodable."</code><code class="p">)</code>&#13;
	<code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Let’s walk through what this code does.</p>&#13;
&#13;
<p>You might recognize this line. First, we grab our <em>catalog.json</em> file that exists in the application bundle. Next, we decode it from JSON into an array to <code>Book</code> objects. The next line, starting with <code>persistentContainer.performBackgroundTask</code>, uses the <code>NSPersistentContainer</code> we created as part of initializing our Core Data stack to perform a task in a background queue. This is important because it’s a task that writes to the persistent store, ultimately, and would block the main thread until it’s complete. We get an <code>NSManagedObjectContext</code> as part of calling this method, which, in turn, is used to create a new <code>BookManagedObject</code> as we loop through our <code>books</code> array from the JSON.</p>&#13;
&#13;
<p>Each <code>BookManagedObject</code> is created inside of the background managed object context. It’s important to note that really, it only exists in-memory at this point. It’s not until we actually <code>save()</code> on the managed object context that the objects and changes are persisted back through the persistent store coordinator and on through to the database if necessary.</p>&#13;
&#13;
<p>Running the application will not, however, populate the database. The reason for this is simple: the database already exists and this code checks to make sure it doesn’t before it’ll seed the database. The solution: delete the app from the iOS Simulator and then build and run the application again. If everything goes well, you’ll see, in our catalog view, a list of the same books as before, sorted by <code>title</code>.</p>&#13;
&#13;
<p>Whew. Breathe a sigh of relief. We’ve done it. We’re using a database just like in our Android app. However, we’ve taken it a bit further to get the full benefits of using Core Data over just a straight SQLite database. But, we’re not done yet! We need to take this database and utilize it for our original purpose: saving books for later. Let’s jump back on that part of the project!<a data-primary="" data-startref="Piosstore19" data-type="indexterm" id="idm46177197627480"/><a data-primary="" data-startref="APiosstore19" data-type="indexterm" id="idm46177197626616"/><a data-primary="" data-startref="IOSperstore19" data-type="indexterm" id="idm46177197625672"/><a data-primary="" data-startref="JSONswitch19" data-type="indexterm" id="idm46177197624728"/><a data-primary="" data-startref="CDswitch19" data-type="indexterm" id="idm46177197623784"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Saving Books" data-type="sect1"><div class="sect1" id="idm46177201890648">&#13;
<h1>Saving Books</h1>&#13;
&#13;
<p>So our persistence layer saves our books. If later we’re offered a remote service that can update our database with more books from the library, we have both the infrastructure and plumbing in place to do so. So what’s left? Remember that button we added earlier, to mark a <code>Book</code> instance as a favorite of the current user? Let’s hook that up now.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Android" data-type="sect2"><div class="sect2" id="idm46177197620824">&#13;
<h2>Android</h2>&#13;
&#13;
<p>As<a data-primary="application persistence" data-secondary="Android" data-tertiary="saving data" data-type="indexterm" id="idm46177197619032"/><a data-primary="persistence" data-secondary="Android" data-tertiary="saving data" data-type="indexterm" id="idm46177197617752"/><a data-primary="Android" data-secondary="persistence" data-tertiary="saving data" data-type="indexterm" id="idm46177197616536"/><a data-primary="Java" data-secondary="persistence" data-tertiary="saving data" data-type="indexterm" id="idm46177197615320"/> we’ve mentioned several times, there are several ways to accomplish this, and it’s very fair to assume someone might want to add a column to the <code>BOOKS</code> table in the database and set a <code>INTEGER</code> value of 0 (false) or 1 (true) there as the toggle is switched (unlike most SQL RDBMSs, SQLite does not have a boolean data type—typically integers are used in the pattern just described). In fact, in the long run, that’s probably how I’d do it to. However, for this example, we’re going to use an alternate approach, first for simplicity, but also to show another common and handy feature built in to the Android framework and discussed in <a data-type="xref" data-xrefstyle="chap-num-title" href="part01.html#part_1_tasks">Part I, <em>Tasks and Operations</em></a>, in <a data-type="xref" href="ch11.html#topics_preferences">Chapter 11</a>.</p>&#13;
&#13;
<p>As mentioned, <code>SharedPreferences</code> accepts as <code>Set</code> of <code>Strings</code>. This seems like an ideal data structure for this kind of work—we want a unique, unordered collection if book IDs (ISBN numbers) by which we can easily identify if a book is a favorite of the user or not. If toggling “on,” we add the ISBN to the <code>Set</code>—if toggling “off,” we remove it. Simple! At some point you might want to add a custom UI like a star that turns from gold to gray, or special styling in the list, but for now we’ll just update the text of the button to identify the current state.</p>&#13;
&#13;
<p>So first, let’s make a method that toggles a <code>Book</code> in the <code>Set&lt;String&gt;</code> we identify in <code>SharedPreferences</code>. Let’s assume we’ll define this function in the <code>BookDetailActivity</code> class and therefore have local access to a <code>Context</code> object (the activity itself) and all its accessors:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177197604888">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">private</code> <code class="kt">void</code> <code class="nf">toggleFavorite</code><code class="o">(</code><code class="n">Button</code> <code class="n">button</code><code class="o">,</code> <code class="n">String</code> <code class="n">isbn</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="n">SharedPreferences</code> <code class="n">preferences</code> <code class="o">=</code> <code class="n">getSharedPreferences</code><code class="o">(</code><code class="s">"prefs"</code><code class="o">,</code> <code class="n">Context</code><code class="o">.</code><code class="na">MODE_PRIVATE</code><code class="o">);</code>&#13;
  <code class="n">Set</code><code class="o">&lt;</code><code class="n">String</code><code class="o">&gt;</code> <code class="n">favorites</code> <code class="o">=</code> <code class="n">preferences</code><code class="o">.</code><code class="na">getStringSet</code><code class="o">(</code><code class="s">"favorites"</code><code class="o">,</code> <code class="k">new</code> <code class="n">HashSet</code><code class="o">&lt;&gt;());</code>&#13;
  <code class="k">if</code> <code class="o">(</code><code class="n">favorites</code><code class="o">.</code><code class="na">contains</code><code class="o">(</code><code class="n">isbn</code><code class="o">))</code> <code class="o">{</code>&#13;
    <code class="n">favorites</code><code class="o">.</code><code class="na">remove</code><code class="o">(</code><code class="n">isbn</code><code class="o">);</code>&#13;
    <code class="n">button</code><code class="o">.</code><code class="na">setText</code><code class="o">(</code><code class="s">"Mark as Favorite"</code><code class="o">);</code>&#13;
  <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
    <code class="n">favorites</code><code class="o">.</code><code class="na">add</code><code class="o">(</code><code class="n">isbn</code><code class="o">);</code>&#13;
    <code class="n">button</code><code class="o">.</code><code class="na">setText</code><code class="o">(</code><code class="s">"Remove from favorites"</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
  <code class="n">SharedPreferences</code><code class="o">.</code><code class="na">Editor</code> <code class="n">editor</code> <code class="o">=</code> <code class="n">preferences</code><code class="o">.</code><code class="na">edit</code><code class="o">();</code>&#13;
  <code class="n">editor</code><code class="o">.</code><code class="na">putStringSet</code><code class="o">(</code><code class="s">"favorites"</code><code class="o">,</code> <code class="n">favorites</code><code class="o">);</code>&#13;
  <code class="n">editor</code><code class="o">.</code><code class="na">apply</code><code class="o">();</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="k">private</code> <code class="k">fun</code> <code class="nf">toggleFavorite</code><code class="p">(</code><code class="n">button</code><code class="p">:</code> <code class="n">Button</code><code class="p">,</code> <code class="n">isbn</code><code class="p">:</code> <code class="n">String</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="k">val</code> <code class="py">preferences</code> <code class="p">=</code> <code class="n">getSharedPreferences</code><code class="p">(</code><code class="s">"prefs"</code><code class="p">,</code> <code class="n">Context</code><code class="p">.</code><code class="n">MODE_PRIVATE</code><code class="p">)</code>&#13;
  <code class="k">val</code> <code class="py">favorites</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">getStringSet</code><code class="p">(</code><code class="s">"favorites"</code><code class="p">,</code> <code class="n">HashSet</code><code class="p">())</code>&#13;
  <code class="n">favorites</code><code class="o">?.</code><code class="n">let</code> <code class="p">{</code>&#13;
   <code class="k">if</code> <code class="p">(</code><code class="n">it</code><code class="p">.</code><code class="n">contains</code><code class="p">(</code><code class="n">isbn</code><code class="p">))</code>&#13;
     <code class="n">it</code><code class="p">.</code><code class="n">remove</code><code class="p">(</code><code class="n">isbn</code><code class="p">)</code>&#13;
     <code class="n">button</code><code class="p">.</code><code class="n">text</code> <code class="p">=</code> <code class="s">"Mark as Favorite"</code>&#13;
   <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
     <code class="n">it</code><code class="p">.</code><code class="n">add</code><code class="p">(</code><code class="n">isbn</code><code class="p">)</code>&#13;
     <code class="n">button</code><code class="p">.</code><code class="n">text</code> <code class="p">=</code> <code class="s">"Remove from favorites"</code>&#13;
   <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
  <code class="k">val</code> <code class="py">editor</code> <code class="p">=</code> <code class="n">preferences</code><code class="p">.</code><code class="n">edit</code><code class="p">()</code>&#13;
  <code class="n">editor</code><code class="p">.</code><code class="n">putStringSet</code><code class="p">(</code><code class="s">"favorites"</code><code class="p">,</code> <code class="n">favorites</code><code class="p">)</code>&#13;
  <code class="n">editor</code><code class="p">.</code><code class="n">apply</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>We can add that method to the button in a click listener like so:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177197506792">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">button_save</code><code class="o">).</code><code class="na">setOnClickListener</code><code class="o">(</code><code class="n">view</code> <code class="o">-&gt;</code> <code class="n">toggleFavorite</code><code class="o">((</code><code class="n">Button</code><code class="o">)</code> <code class="n">view</code><code class="o">,</code>&#13;
  <code class="n">book</code><code class="o">.</code><code class="na">getIsbn</code><code class="o">()));</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="kotlin" data-type="programlisting"><code class="n">button_save</code><code class="p">.</code><code class="n">setOnClickListener</code> <code class="p">{</code> <code class="n">view</code> <code class="p">-&gt;</code> <code class="n">toggleFavorite</code><code class="p">(</code><code class="n">view</code> <code class="k">as</code> <code class="n">Button</code><code class="p">,</code> <code class="n">book</code><code class="p">.</code><code class="n">isbn</code><code class="p">)</code> <code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>That should do it! Run the app, pick a book from the list, and in the detail page, toggle the favorite setting. Since this value is stored in a persistent structure, the value will persist between app launches and power cycles.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What We’ve Learned" data-type="sect1"><div class="sect1" id="idm46177197275736">&#13;
<h1>What We’ve Learned</h1>&#13;
&#13;
<p>Congrats! We’ve got a diverse, if basic, set of functionality in our app. The application is usable and consistent between Android and iOS. In this chapter, we’ve learned about data persistence and how different it is in both platforms. Android has a much more approachable database approach to storing and accessing data, whereas iOS takes a more abstract method but offers considerably more functionality for free—albeit with considerable added complexity.</p>&#13;
&#13;
<p>Before we ride off into the sunset with our app, we need to take a look at one more aspect: networking. Let’s walk through the pitfalls and practices to adding some lightweight connectivity to this app in the next chapter.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>