<html><head></head><body><section data-pdf-bookmark="Chapter 7. Operators in Go with the Operator SDK" data-type="chapter" epub:type="chapter"><div class="chapter" id="operators_in_go_with_the_operator_sdk">&#13;
<h1><span class="label">Chapter 7. </span>Operators in Go with the Operator SDK</h1>&#13;
&#13;
&#13;
<p>While the Helm and Ansible Operators can be created quickly and easily, their functionality is ultimately limited by those underlying technologies. Advanced use cases, such as those that involve dynamically reacting to specific changes in the application or the cluster as a whole, require a more flexixble solution.</p>&#13;
&#13;
<p>The Operator SDK provides that flexibility by making it easy for developers to use the Go programming language, including its ecosystem of external libraries, in their Operators.<a data-primary="Go programming language" data-secondary="creating custom Operators using Operator SDK" data-type="indexterm" id="ix_GoOps"/></p>&#13;
&#13;
<p>As the process is slightly more involved than for the Helm or Ansible Operators, it makes sense to start with a summary of the high–level steps:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Create the necessary code that will tie in to Kubernetes and allow it to run the Operator as a controller.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create one or more CRDs to model the application’s underlying business logic and provide the API for users to interact with.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create a controller for each CRD to handle the lifecycle of its resources.</p>&#13;
</li>&#13;
<li>&#13;
<p>Build the Operator image and create the accompanying Kubernetes manifests to deploy the Operator and its RBAC components (service accounts, roles, etc.).</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>While you can write all these pieces manually, the Operator SDK provides commands that will automate the creation of much of the supporting code, allowing you to focus on implementing the actual business logic of the Operator.</p>&#13;
&#13;
<p>This chapter uses the Operator SDK to build the project skeleton for implementing an Operator in Go (see <a data-type="xref" href="ch04.html#the_operator_framework">Chapter 4</a> for instructions on the SDK installation). We will explore the files that need to be edited with custom application logic and discuss some common practices for Operator development. Once the Operator is ready, we’ll run it in development mode for testing and debugging.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Initializing the Operator" data-type="sect1"><div class="sect1" id="idm45261332586488">&#13;
<h1>Initializing the Operator</h1>&#13;
&#13;
<p>Since the Operator is written in Go, the project skeleton must adhere to the language conventions.<a data-primary="initializing the Operator" data-type="indexterm" id="idm45261332584936"/> In particular, the Operator code must be located in your <code>$GOPATH</code>. See the <a href="https://oreil.ly/2PU_Q"><code>GOPATH</code> documentation</a> for more information.</p>&#13;
&#13;
<p>The SDK’s <code>new</code> command creates the necessary base files for the Operator.<a data-primary="Operator SDK command" data-secondary="new" data-type="indexterm" id="idm45261332581848"/> If a specific Operator type is not specified, the command generates a Go-based Operator project:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
$ <strong>OPERATOR_NAME=visitors-operator</strong>&#13;
$ <strong>operator-sdk new $OPERATOR_NAME</strong>&#13;
INFO[0000] <code>Creating new Go operator 'visitors-operator'.</code>&#13;
INFO[0000] Created go.mod&#13;
INFO[0000] Created tools.go&#13;
INFO[0000] Created cmd/manager/main.go&#13;
INFO[0000] Created build/Dockerfile&#13;
INFO[0000] Created build/bin/entrypoint&#13;
INFO[0000] Created build/bin/user_setup&#13;
INFO[0000] Created deploy/service_account.yaml&#13;
INFO[0000] Created deploy/role.yaml&#13;
INFO[0000] Created deploy/role_binding.yaml&#13;
INFO[0000] Created deploy/operator.yaml&#13;
INFO[0000] Created pkg/apis/apis.go&#13;
INFO[0000] Created pkg/controller/controller.go&#13;
INFO[0000] Created version/version.go&#13;
INFO[0000] Created .gitignore&#13;
INFO[0000] Validating project&#13;
[...]  <a class="co" href="#c01-011" id="comarker1-011"><img alt="1" src="assets/1.png"/></a>&#13;
</pre>&#13;
<dl class="calloutlist">&#13;
 <dt><a class="co" href="#comarker1-011" id="c01-011"><img alt="1" src="assets/1.png"/></a></dt>&#13;
  <dd><p>The output is truncated for readability. The generation can take a few minutes as all of the Go dependencies are downloaded. The details of these dependencies will appear in the command output.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The SDK creates a new directory with the same name as <code>$OPERATOR_NAME</code>. The generation process produces hundreds of files, both generated and vendor files, that the Operator uses. Conveniently, you do not need to manually edit most of them. We will show you how to generate the files necessary to fulfill custom logic for an Operator in <a data-type="xref" href="#custom_res_defs">“Custom Resource Definitions”</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Operator Scope" data-type="sect1"><div class="sect1" id="idm45261332571128">&#13;
<h1>Operator Scope</h1>&#13;
&#13;
<p>One of the first decisions you need to make is the scope of the Operator.<a data-primary="scope of an Operator" data-type="indexterm" id="idm45261332569464"/> There are two options:</p>&#13;
<dl>&#13;
<dt>Namespaced</dt>&#13;
<dd>&#13;
<p>Limits the Operator to managing<a data-primary="namespaces" data-secondary="namespace scope for Operators" data-type="indexterm" id="idm45261332567032"/> resources in a single namespace</p>&#13;
</dd>&#13;
<dt>Cluster</dt>&#13;
<dd>&#13;
<p>Allows the Operator to manage resources across the entire cluster</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>By default, Operators that the SDK generates are namespace-scoped.</p>&#13;
&#13;
<p>While namespace-scoped Operators are often preferable, changing an SDK–generated Operator to be cluster-scoped is possible. Make the following changes to enable the Operator to work at the cluster level:</p>&#13;
<dl>&#13;
<dt><em>deploy/operator.yaml</em></dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Change the value of the <code>WATCH_NAMESPACE</code> variable to <code>""</code>, indicating all namespaces will be watched instead of only the namespace in which the Operator pod is deployed.<a data-primary="WATCH_NAMESPACE variable" data-type="indexterm" id="idm45261332559432"/></p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt><em>deploy/role.yaml</em></dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Change the <code>kind</code> from <code>Role</code> to <code>ClusterRole</code> to enable permissions outside of the Operator pod’s namespace.</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt><em>deploy/role_binding.yaml</em></dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Change the <code>kind</code> from <code>RoleBinding</code> to <code>ClusterRoleBinding</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Under <code>roleRef</code>, change the <code>kind</code> to <code>ClusterRole</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Under <code>subjects</code>, add the key <code>namespace</code> with the value being the namespace in which the Operator pod is deployed.</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Additionally, you need to update the generated CRDs (discussed in the following section) to indicate that the definition is cluster-scoped:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>In the <code>spec</code> section of the CRD file, change the <code>scope</code> field to <code>Cluster</code> instead of the default value of <code>Namespaced</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>In the <em>_types.go</em> file for the CRD, add the tag <code>// +genclient:nonNamespaced</code> above the struct for the CR (this will have the same name as the <code>kind</code> field you used to create it). This ensures that future calls to the Operator SDK to refresh the CRD will not reset the value to the default.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>For example, the following modifications to the <code>VisitorsApp</code> struct indicate that it is cluster-scoped:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object&#13;
</code><code>&#13;
</code><code class="c1">// VisitorsApp is the Schema for the visitorsapps API&#13;
</code><code class="c1">// +k8s:openapi-gen=true&#13;
</code><code class="c1">// +kubebuilder:subresource:status&#13;
</code><code class="c1">// +genclient:nonNamespaced  </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO1-1" id="co_operators_in_go_with_the_operator_sdk_CO1-1"><img alt="1" src="assets/1.png"/></a><code class="c1">&#13;
</code><code class="kd">type</code><code> </code><code class="nx">VisitorsApp</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO1-1" id="callout_operators_in_go_with_the_operator_sdk_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The tag must be before the resource type struct.</p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Custom Resource Definitions" data-type="sect1"><div class="sect1" id="custom_res_defs">&#13;
<h1>Custom Resource Definitions</h1>&#13;
&#13;
<p>In <a data-type="xref" href="ch06.html#adapter_operators">Chapter 6</a>, we discussed the role of CRDs when creating an Operator. <a data-primary="custom resource definitions (CRDs)" data-secondary="for Go Operator created using Operator SDK" data-type="indexterm" id="ix_CRDGo"/>You can add new CRDs to an Operator using the SDK’s <code>add api</code> command.<a data-primary="Operator SDK command" data-secondary="add" data-type="indexterm" id="idm45261332501064"/> This command, run from the Operator project root directory, generates the CRD for the Visitors Site example used in this book (using the arbitrary “example.com” for demonstration <span class="keep-together">purposes):</span></p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>operator-sdk</code><code> </code><code>add</code><code> </code><code>api</code><code> </code><code>--api-version</code><code class="o">=</code><code>example.com/v1</code><code> </code><code>--kind</code><code class="o">=</code><code>VisitorsApp</code></strong><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Generating</code><code> </code><code>api</code><code> </code><code>version</code><code> </code><code>example.com/v1</code><code> </code><code class="k">for</code><code> </code><code>kind</code><code> </code><code>VisitorsApp.</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Created</code><code> </code><code>pkg/apis/example/group.go</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Created</code><code> </code><code>pkg/apis/example/v1/visitorsapp_types.go</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Created</code><code> </code><code>pkg/apis/addtoscheme_example_v1.go</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Created</code><code> </code><code>pkg/apis/example/v1/register.go</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Created</code><code> </code><code>pkg/apis/example/v1/doc.go</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Created</code><code> </code><code>deploy/crds/example_v1_visitorsapp_cr.yaml</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0001</code><code class="o">]</code><code> </code><code>Created</code><code> </code><code>deploy/crds/example_v1_visitorsapp_crd.yaml</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0001</code><code class="o">]</code><code> </code><code>Running</code><code> </code><code>deepcopy</code><code> </code><code>code-generation</code><code> </code><code class="k">for</code><code> </code><code>Custom</code><code> </code><code>Resource</code><code> </code><code>group</code><code> </code><code>versions:</code><code>&#13;
  </code><code class="o">[</code><code>example:</code><code class="o">[</code><code>v1</code><code class="o">]</code><code>,</code><code> </code><code class="o">]</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0001</code><code class="o">]</code><code> </code><code>Code-generation</code><code> </code><code>complete.</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0001</code><code class="o">]</code><code> </code><code>Running</code><code> </code><code>OpenAPI</code><code> </code><code>code-generation</code><code> </code><code class="k">for</code><code> </code><code>Custom</code><code> </code><code>Resource</code><code> </code><code>group</code><code> </code><code>versions:</code><code>&#13;
  </code><code class="o">[</code><code>example:</code><code class="o">[</code><code>v1</code><code class="o">]</code><code>,</code><code> </code><code class="o">]</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0003</code><code class="o">]</code><code> </code><code>Created</code><code> </code><code>deploy/crds/example_v1_visitorsapp_crd.yaml</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0003</code><code class="o">]</code><code> </code><code>Code-generation</code><code> </code><code>complete.</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0003</code><code class="o">]</code><code> </code><code>API</code><code> </code><code>generation</code><code> </code><code>complete.</code><code>&#13;
</code></pre>&#13;
&#13;
<p>The command generates a number of files. In the following list, note how both the <code>api-version</code> and CR type name (<code>kind</code>) contribute to the generated names (file paths are relative to the Operator project root):</p>&#13;
<dl>&#13;
<dt><em>deploy/crds/example_v1_visitorsapp-cr.yaml</em></dt>&#13;
<dd>&#13;
<p>This is an example CR of the generated type. It is prepopulated with the appropriate <code>api-version</code> and <code>kind</code>, as well as a name for the resource. You’ll need to fill out the <code>spec</code> section with values relevant to the CRD you created.</p>&#13;
</dd>&#13;
<dt><em>deploy/crds/example_v1_visitorsapp_crd.yaml</em></dt>&#13;
<dd>&#13;
<p>This file is the beginning of a CRD manifest. The SDK generates many of the fields related to the name of the resource type (such as plural and list variations), but you’ll need to add in the custom fields specific to your resource type. <a data-type="xref" href="app02.html#appendix_crd_validation">Appendix B</a> goes into detail on fleshing out this file.</p>&#13;
</dd>&#13;
<dt><em>pkg/apis/example/v1/visitorsapp_types.go</em></dt>&#13;
<dd>&#13;
<p>This file contains a number of struct objects that the Operator codebase leverages. This file, unlike many of the generated Go files, is intended to be edited.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The <code>add api</code> command builds the appropriate skeleton code, but before you can use the resource type, you must define the set of configuration values that are specified when creating a new resource. You’ll also need to add a description of the fields the CR will use when reporting its status. You’ll add these sets of values in the definition template itself as well as the Go objects. The following two sections go into more detail about each step.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Defining the Go Types" data-type="sect2"><div class="sect2" id="idm45261332019832">&#13;
<h2>Defining the Go Types</h2>&#13;
&#13;
<p>In the <em>*_types.go</em> file (in this example, <em>visitorsapp_types.go</em>), there are two struct objects that<a data-primary="types.go file" data-type="indexterm" id="idm45261332017192"/> you need to address:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The spec object (in this example, <code>VisitorsAppSpec</code>) must include all possible configuration values that may be specified for resources of this type. Each configuration value is made up of the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The name of the variable as it will be referenced from within the Operator code (following Go conventions and beginning with a capital letter for language visibility purposes)</p>&#13;
</li>&#13;
<li>&#13;
<p>The Go type for the variable</p>&#13;
</li>&#13;
<li>&#13;
<p>The name of the field as it will be specified in the CR (in other words, the JSON or YAML manifest users will write to create the resource)</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p>The status object (in this example, <code>VisitorsAppStatus</code>) must include all possible values that the Operator may set to convey the state of the CR. Each value consists of the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The name of the variable as it will be referenced from within the Operator code (following Go conventions and beginning with a capital letter for visibility purposes)</p>&#13;
</li>&#13;
<li>&#13;
<p>The Go type for the variable</p>&#13;
</li>&#13;
<li>&#13;
<p>The name of the field as it will appear in the description of the CR (for example, when getting the resource with the <code>-o yaml</code> flag)</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The Visitors Site example supports the following values in its VisitorsApp CR:</p>&#13;
<dl>&#13;
<dt><code>Size</code></dt>&#13;
<dd>&#13;
<p>The number of backend replicas to create</p>&#13;
</dd>&#13;
<dt><code>Title</code></dt>&#13;
<dd>&#13;
<p>The text to display on the frontend web page</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>It is important to realize that despite the fact that you are using these values in different pods in the application, you are including them in a single CRD. From the end user’s perspective, they are attributes of the overall application. It is the Operator’s responsibility to determine how to use the values.</p>&#13;
&#13;
<p>The VisitorsApp CR uses the following values in the status of each resource:</p>&#13;
<dl>&#13;
<dt><code>BackendImage</code></dt>&#13;
<dd>&#13;
<p>Indicates the image and version used to deploy the backend pods</p>&#13;
</dd>&#13;
<dt><code>FrontendImage</code></dt>&#13;
<dd>&#13;
<p>Indicates the image and version used to deploy the frontend pod</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The following snippet from the <em>visitorsapp_types.go</em> file demonstrates these additions:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code> <code class="nx">VisitorsAppSpec</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="nx">Size</code>       <code class="kt">int32</code>  <code class="s">`json:"size"`</code>&#13;
    <code class="nx">Title</code>      <code class="kt">string</code> <code class="s">`json:"title"`</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">type</code> <code class="nx">VisitorsAppStatus</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="nx">BackendImage</code>  <code class="kt">string</code> <code class="s">`json:"backendImage"`</code>&#13;
    <code class="nx">FrontendImage</code> <code class="kt">string</code> <code class="s">`json:"frontendImage"`</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The remainder of the <em>visitorsapp_types.go</em> file does not require any further changes.</p>&#13;
&#13;
<p>After any change to a <em>*_types.go</em> file, you need to update any generated code that works with these objects<a data-primary="Operator SDK command" data-secondary="generate" data-type="indexterm" id="idm45261332255160"/> using the SDK’s <code>generate</code> command (from the project’s root directory):</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>operator-sdk</code><code> </code><code>generate</code><code> </code><code>k8s</code></strong><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Running</code><code> </code><code>deepcopy</code><code> </code><code>code-generation</code><code> </code><code class="k">for</code><code> </code><code>Custom</code><code> </code><code>Resource</code><code>&#13;
</code><code>group</code><code> </code><code>versions:</code><code> </code><code class="o">[</code><code>example:</code><code class="o">[</code><code>v1</code><code class="o">]</code><code>,</code><code> </code><code class="o">]</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Code-generation</code><code> </code><code>complete.</code><code>&#13;
</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The CRD Manifest" data-type="sect2"><div class="sect2" id="idm45261332239608">&#13;
<h2>The CRD Manifest</h2>&#13;
&#13;
<p>The additions to the types file are useful within the Operator code, but provide no insight to the end user creating the resource. Those additions are made to the CRD itself.<a data-primary="manifests" data-secondary="CRD manifest for Go language Operator" data-type="indexterm" id="idm45261332219336"/></p>&#13;
&#13;
<p>Similar to the types file, you’ll make the additions to the CRD in the <code>spec</code> and <code>status</code> sections. <a data-type="xref" href="app02.html#appendix_crd_validation">Appendix B</a> describes the process of editing these sections.<a data-primary="custom resource definitions (CRDs)" data-secondary="for Go Operator created using Operator SDK" data-startref="ix_CRDGo" data-type="indexterm" id="idm45261332235752"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Operator Permissions" data-type="sect1"><div class="sect1" id="idm45261332180744">&#13;
<h1>Operator Permissions</h1>&#13;
&#13;
<p>In addition to generating a CRD, the Operator SDK creates the RBAC resources the Operator needs to run.<a data-primary="role-based access control (RBAC)" data-secondary="for Operator in Go created using SDK" data-type="indexterm" id="idm45261332179112"/><a data-primary="permissions" data-secondary="defining for Operator in Go created using SDK" data-type="indexterm" id="idm45261332178200"/><a data-primary="Operator permissions" data-type="indexterm" id="idm45261332177288"/> The generated role is extremely permissive by default, <span class="keep-together">and you should</span> refine its granted permissions before you deploy the Operator to <span class="keep-together">production.</span> <a data-type="xref" href="app03.html#appendix_rbac">Appendix C</a> covers all of the RBAC-related files and talks about how to scope the permissions to what is applicable to the Operator.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Controller" data-type="sect1"><div class="sect1" id="idm45261332174008">&#13;
<h1>Controller</h1>&#13;
&#13;
<p>The CRD and its associated types file in Go define the inbound API through which users will communicate.<a data-primary="controllers" data-secondary="for Operator in Go created using SDK" data-type="indexterm" id="ix_ctrlGoOp"/> Inside of the Operator pod itself, you need a controller to watch for changes to CRs and react accordingly.</p>&#13;
&#13;
<p>Similar to adding a CRD, you use the SDK to generate the controller’s skeleton code. You’ll use the <code>api-version</code> and <code>kind</code> of the previously generated resource definition to scope the controller to that type. The following snippet continues the Visitors Site example:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>operator-sdk</code><code> </code><code>add</code><code> </code><code>controller</code><code> </code><code>--api-version</code><code class="o">=</code><code>example.com/v1</code><code> </code><code>--kind</code><code class="o">=</code><code>VisitorsApp</code></strong><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Generating</code><code> </code><code>controller</code><code> </code><code>version</code><code> </code><code>example.com/v1</code><code> </code><code class="k">for</code><code> </code><code>kind</code><code> </code><code>VisitorsApp.</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Created</code><code> </code><code>pkg/controller/visitorsapp/visitorsapp_controller.go</code><code>  </code><a class="co" href="#c01-022" id="comarker1-022"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Created</code><code> </code><code>pkg/controller/add_visitorsapp.go</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Controller</code><code> </code><code>generation</code><code> </code><code>complete.</code><code>&#13;
</code></pre>&#13;
<dl class="calloutlist">&#13;
 <dt><a class="co" href="#comarker1-022" id="c01-022"><img alt="1" src="assets/1.png"/></a></dt>&#13;
  <dd><p>Note the name of this file. It contains the Kubernetes controller that implements the Operator’s custom logic.</p></dd> </dl>&#13;
&#13;
<p>As with the CRD, this command generates a number of files. Of particular interest is the controller file, which is located and named according to the associated <code>kind</code>. You do not need to manually edit the other generated files.</p>&#13;
&#13;
<p>The controller is responsible for “reconciling” a specific resource. The notion of a single reconcile operation is consistent with the declarative model that Kubernetes follows. Instead of having explicit handling for events such as add, delete, or update, the controller is passed the current state of the resource. It is up to the controller to determine the set of changes to update reality to reflect the desired state described in the resource. More information on Kubernetes controllers is found <a href="https://oreil.ly/E_hau">in the official Kubernetes documentation</a>.</p>&#13;
&#13;
<p>In addition to the reconcile logic, the controller also needs to establish one or more “watches.” A watch indicates that Kubernetes should invoke this controller when changes to the “watched” resources occur. While the bulk of the Operator logic resides in the controller’s <code>Reconcile</code> function, the <code>add</code> function establishes the watches that will trigger reconcile events. The SDK adds two such watches in the generated controller.</p>&#13;
&#13;
<p>The first watch listens for changes to the primary resource that the controller monitors. The SDK generates this watch against resources of the same type as the <code>kind</code> parameter that was used when first generating the controller. In most cases, this does not need to be changed. The following snippet creates the watch for the VisitorsApp resource type:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// Watch for changes to primary resource VisitorsApp</code>&#13;
<code class="nx">err</code> <code class="p">=</code> <code class="nx">c</code><code class="p">.</code><code class="nx">Watch</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">source</code><code class="p">.</code><code class="nx">Kind</code><code class="p">{</code><code class="nx">Type</code><code class="p">:</code> <code class="o">&amp;</code><code class="nx">examplev1</code><code class="p">.</code><code class="nx">VisitorsApp</code><code class="p">{}},</code>&#13;
              <code class="o">&amp;</code><code class="nx">handler</code><code class="p">.</code><code class="nx">EnqueueRequestForObject</code><code class="p">{})</code>&#13;
<code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">err</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The second watch, or more accurately, series of watches, listens for changes to any child resources the Operator created to support the primary resource. For example, creating a VisitorsApp resource results in the creation of multiple deployment and service objects to support its function. The controller creates a watch for each of these child types, being careful to scope the watch to only child resources whose owner is of the same type as the primary resource. For example, the following code creates two watches, one for deployments and one for services whose parent resource is of the type VisitorsApp:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">err</code> <code class="p">=</code> <code class="nx">c</code><code class="p">.</code><code class="nx">Watch</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">source</code><code class="p">.</code><code class="nx">Kind</code><code class="p">{</code><code class="nx">Type</code><code class="p">:</code> <code class="o">&amp;</code><code class="nx">appsv1</code><code class="p">.</code><code class="nx">Deployment</code><code class="p">{}},</code>&#13;
              <code class="o">&amp;</code><code class="nx">handler</code><code class="p">.</code><code class="nx">EnqueueRequestForOwner</code><code class="p">{</code>&#13;
    <code class="nx">IsController</code><code class="p">:</code> <code class="kc">true</code><code class="p">,</code>&#13;
    <code class="nx">OwnerType</code><code class="p">:</code>    <code class="o">&amp;</code><code class="nx">examplev1</code><code class="p">.</code><code class="nx">VisitorsApp</code><code class="p">{},</code>&#13;
<code class="p">})</code>&#13;
<code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">err</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="nx">err</code> <code class="p">=</code> <code class="nx">c</code><code class="p">.</code><code class="nx">Watch</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">source</code><code class="p">.</code><code class="nx">Kind</code><code class="p">{</code><code class="nx">Type</code><code class="p">:</code> <code class="o">&amp;</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">Service</code><code class="p">{}},</code>&#13;
              <code class="o">&amp;</code><code class="nx">handler</code><code class="p">.</code><code class="nx">EnqueueRequestForOwner</code><code class="p">{</code>&#13;
    <code class="nx">IsController</code><code class="p">:</code> <code class="kc">true</code><code class="p">,</code>&#13;
    <code class="nx">OwnerType</code><code class="p">:</code>    <code class="o">&amp;</code><code class="nx">examplev1</code><code class="p">.</code><code class="nx">VisitorsApp</code><code class="p">{},</code>&#13;
<code class="p">})</code>&#13;
<code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">err</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>For the watches created in this snippet, there are two areas of interest:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The value for <code>Type</code> in the constructor indicates the child resource type that Kubernetes watches. Each child resource type needs its own watch.</p>&#13;
</li>&#13;
<li>&#13;
<p>The watches for each of the child resource types set the value for <code>OwnerType</code> to the primary resource type, scoping the watch and causing Kubernetes to trigger a reconcile on the parent resource. Without this, Kubernetes will trigger a reconcile on this controller for <em>all</em> service and deployment changes, regardless of whether or not they belong to the Operator.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Reconcile Function" data-type="sect2"><div class="sect2" id="reconcile_function">&#13;
<h2>The Reconcile Function</h2>&#13;
&#13;
<p>The <code>Reconcile</code> function, also known as the <em>reconcile loop</em>, is where the Operator’s logic resides.<a data-primary="Reconcile function (or reconcile loop)" data-type="indexterm" id="idm45261331908808"/> The purpose of this function is to resolve the actual state of the system against the desired state requested by the resource. More information to help you write this function is included in the next section.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>As Kubernetes invokes the <code>Reconcile</code> function multiple times throughout the lifecycle of a resource, it is important that the implementation be idempotent to prevent the creation of duplicate child resources. <a data-primary="idempotency" data-secondary="in Reconcile function implementations" data-type="indexterm" id="idm45261331906200"/>More information is found in <a data-type="xref" href="#idempotency">“Idempotency”</a>.</p>&#13;
</div>&#13;
&#13;
<p>The <code>Reconcile</code> function returns two objects: a <code>ReconcileResult</code> instance and an error (if one is encountered). <a data-primary="ReconcileResult instances" data-type="indexterm" id="idm45261331902920"/>These return values indicate whether or not Kubernetes should requeue the request. In other words, the Operator tells Kubernetes if the reconcile loop should execute again. The possible outcomes based on the return values are:</p>&#13;
<dl>&#13;
<dt><code>return reconcile.Result{}, nil</code></dt>&#13;
<dd>&#13;
<p>The reconcile process finished with no errors and does not require another pass through the reconcile loop.</p>&#13;
</dd>&#13;
<dt><code>return reconcile.Result{}, err</code></dt>&#13;
<dd>&#13;
<p>The reconcile failed due to an error and Kubernetes should requeue it to try again.</p>&#13;
</dd>&#13;
<dt><code>return reconcile.Result{Requeue: true}, nil</code></dt>&#13;
<dd>&#13;
<p>The reconcile did not encounter an error, but Kubernetes should requeue it to run for another iteration.</p>&#13;
</dd>&#13;
<dt><code>return reconcile.Result{RequeueAfter: time.Second*5}, nil</code></dt>&#13;
<dd>&#13;
<p>Similar to the previous result, but this will wait for the specified amount of time before requeuing the request. This approach is useful when there are multiple steps that must run serially, but may take some time to complete. For example, if a backend service needs a running database prior to starting, the reconcile can be requeued with a delay to give the database time to start. Once the database is running, the Operator does not requeue the reconcile request, and the rest of the steps continue.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Operator Writing Tips" data-type="sect1"><div class="sect1" id="idm45261332156760">&#13;
<h1>Operator Writing Tips</h1>&#13;
&#13;
<p>It is impossible to cover all of the conceivable uses and intricacies of Operators in a single book. The differences in application installation and upgrade alone are too many to enumerate, and those represent only the first two layers of the Operator Maturity Model. Instead, we will cover some general guidelines to get you started with the basic functions commonly performed by Operators.</p>&#13;
&#13;
<p>Since Go-based Operators make heavy use of the Go Kubernetes libraries, it may be useful to review <a href="https://godoc.org/k8s.io/api">the API documentation</a>. In particular, the core/v1 and apps/v1 modules are frequently used to interact with the common Kubernetes resources.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Retrieving the Resource" data-type="sect2"><div class="sect2" id="retrieving_resource">&#13;
<h2>Retrieving the Resource</h2>&#13;
&#13;
<p>The first step the <code>Reconcile</code> function typically performs is to retrieve the primary resource that triggered the reconcile request.<a data-primary="resources" data-secondary="retrieving primary resource triggering reconcile request" data-type="indexterm" id="idm45261331888744"/> The Operator SDK generates the code for this, which should look similar to the following from the Visitors Site example:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// Fetch the VisitorsApp instance&#13;
</code><code class="nx">instance</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">examplev1</code><code class="p">.</code><code class="nx">VisitorsApp</code><code class="p">{</code><code class="p">}</code><code>&#13;
</code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">client</code><code class="p">.</code><code class="nx">Get</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">TODO</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">request</code><code class="p">.</code><code class="nx">NamespacedName</code><code class="p">,</code><code> </code><code class="nx">instance</code><code class="p">)</code><code> </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO2-1" id="co_operators_in_go_with_the_operator_sdk_CO2-1"><img alt="1" src="assets/1.png"/></a><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO2-2" id="co_operators_in_go_with_the_operator_sdk_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="k">if</code><code> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">IsNotFound</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="k">return</code><code> </code><code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="kc">nil</code><code> </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO2-3" id="co_operators_in_go_with_the_operator_sdk_CO2-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
    </code><code class="p">}</code><code>&#13;
</code><code>    </code><code class="c1">// Error reading the object - requeue the request.&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO2-1" id="callout_operators_in_go_with_the_operator_sdk_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Populates the previously created VisitorsApp object with the values from the resource that triggered the reconcile.</p></dd>&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO2-2" id="callout_operators_in_go_with_the_operator_sdk_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The variable <code>r</code> is the reconciler object the <code>Reconcile</code> function is called on. It provides the client object, which is an authenticated client for the Kubernetes API.</p></dd>&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO2-3" id="callout_operators_in_go_with_the_operator_sdk_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>When a resource is deleted, Kubernetes still calls the <code>Reconcile</code> function, in which case the <code>Get</code> call returns an error. In this example, the Operator requires no further cleanup of deleted resources and simply returns that the reconcile was a success. We provide more information on handling deleted resources in <a data-type="xref" href="#child_resource_del">“Child Resource Deletion”</a>.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The retrieved instance serves two primary purposes:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Retrieving configuration values about the resource from its <code>Spec</code> field</p>&#13;
</li>&#13;
<li>&#13;
<p>Setting the current state of the resource using its <code>Status</code> field, and saving that updated information into Kubernetes</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In addition to the <code>Get</code> function, the client provides a function to update a resource’s values. When updating a resource’s <code>Status</code> field, you’ll use this function to persist the changes to the resource back into Kubernetes. The following snippet updates one of the fields in the previously retrieved VisitorsApp instance’s status and saves the changes back into Kubernetes:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">instance</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">BackendImage</code> <code class="p">=</code> <code class="s">"example"</code>&#13;
<code class="nx">err</code> <code class="o">:=</code> <code class="nx">r</code><code class="p">.</code><code class="nx">client</code><code class="p">.</code><code class="nx">Status</code><code class="p">().</code><code class="nx">Update</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">TODO</code><code class="p">(),</code> <code class="nx">instance</code><code class="p">)</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Child Resource Creation" data-type="sect2"><div class="sect2" id="idm45261331730664">&#13;
<h2>Child Resource Creation</h2>&#13;
&#13;
<p>One of the first tasks commonly implemented in an Operator is to deploy the resources necessary to get the application running.<a data-primary="resources" data-secondary="child resource creation for Operator in Go" data-type="indexterm" id="idm45261331718968"/> It is critical that this operation be idempotent; subsequent calls to the <code>Reconcile</code> function should ensure the resource is running rather than creating duplicate resources.<a data-primary="child resources" data-see="resources" data-type="indexterm" id="idm45261331717336"/><a data-primary="idempotency" data-secondary="child resource creation for Operator in Go" data-type="indexterm" id="idm45261331709320"/></p>&#13;
&#13;
<p>These child resources commonly include, but are not limited to, deployment and service objects. The handling for them is similar and straightforward: check to see if the resource is present in the namespace and, if it is not, create it.</p>&#13;
&#13;
<p>The following <a data-primary="deployment" data-secondary="checking for deployment object in target namespace" data-type="indexterm" id="idm45261331707288"/><a data-primary="namespaces" data-secondary="checking for deployment object in target namespace" data-type="indexterm" id="idm45261331706248"/>example snippet checks for the existence of a deployment in the target namespace:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">found</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">appsv1</code><code class="p">.</code><code class="nx">Deployment</code><code class="p">{</code><code class="p">}</code><code>&#13;
</code><code class="nx">findMe</code><code> </code><code class="o">:=</code><code> </code><code class="nx">types</code><code class="p">.</code><code class="nx">NamespacedName</code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="nx">Name</code><code class="p">:</code><code>      </code><code class="s">"myDeployment"</code><code class="p">,</code><code>  </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO3-1" id="co_operators_in_go_with_the_operator_sdk_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
    </code><code class="nx">Namespace</code><code class="p">:</code><code> </code><code class="nx">instance</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">,</code><code>  </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO3-2" id="co_operators_in_go_with_the_operator_sdk_CO3-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">client</code><code class="p">.</code><code class="nx">Get</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">TODO</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">findMe</code><code class="p">,</code><code> </code><code class="nx">found</code><code class="p">)</code><code>&#13;
</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="o">&amp;&amp;</code><code> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">IsNotFound</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="c1">// Creation logic </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO3-3" id="co_operators_in_go_with_the_operator_sdk_CO3-3"><img alt="3" src="assets/3.png"/></a><code class="c1">&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO3-1" id="callout_operators_in_go_with_the_operator_sdk_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The Operator knows the names of the child resources it created, or at least how to derive them (see <a data-type="xref" href="#child_resource_naming">“Child Resource Naming”</a> for a more in-depth discussion). In real use cases, <code>"myDeployment"</code> is replaced with the same name the Operator used when the deployment was created, taking care to ensure uniqueness relative to the namespace as appropriate.</p></dd>&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO3-2" id="callout_operators_in_go_with_the_operator_sdk_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The <code>instance</code> variable was set in the earlier snippet about resource retrieval and refers to the object representing the primary resource being reconciled.</p></dd>&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO3-3" id="callout_operators_in_go_with_the_operator_sdk_CO3-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>At this point, the child resource was not found and no further errors were retrieved from the Kubernetes API, so the resource creation logic should be <span class="keep-together">executed.</span></p></dd>&#13;
</dl>&#13;
&#13;
<p>The Operator creates resources by populating the necessary Kubernetes objects and using the client to request that they be created.<a data-primary="Kubernetes" data-secondary="Go client API" data-type="indexterm" id="idm45261331559224"/> Consult the Kubernetes Go client API for specifications on how to instantiate the resource for each type. You’ll find many of the desired specs in either the core/v1 or the apps/v1 module.</p>&#13;
&#13;
<p>As an example, the following snippet creates a deployment specification for the MySQL database used in the Visitors Site example application:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">labels</code><code> </code><code class="o">:=</code><code> </code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="s">"app"</code><code class="p">:</code><code>             </code><code class="s">"visitors"</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="s">"visitorssite_cr"</code><code class="p">:</code><code> </code><code class="nx">instance</code><code class="p">.</code><code class="nx">Name</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="s">"tier"</code><code class="p">:</code><code>            </code><code class="s">"mysql"</code><code class="p">,</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="nx">size</code><code> </code><code class="o">:=</code><code> </code><code class="nb">int32</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code>  </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO4-1" id="co_operators_in_go_with_the_operator_sdk_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
&#13;
</code><code class="nx">userSecret</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">EnvVarSource</code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="nx">SecretKeyRef</code><code class="p">:</code><code> </code><code class="o">&amp;</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">SecretKeySelector</code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="nx">LocalObjectReference</code><code class="p">:</code><code> </code><code class="nx">corev1</code><code class="p">.</code><code class="nx">LocalObjectReference</code><code class="p">{</code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="nx">mysqlAuthName</code><code class="p">(</code><code class="p">)</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">Key</code><code class="p">:</code><code> </code><code class="s">"username"</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="nx">passwordSecret</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">EnvVarSource</code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="nx">SecretKeyRef</code><code class="p">:</code><code> </code><code class="o">&amp;</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">SecretKeySelector</code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="nx">LocalObjectReference</code><code class="p">:</code><code> </code><code class="nx">corev1</code><code class="p">.</code><code class="nx">LocalObjectReference</code><code class="p">{</code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="nx">mysqlAuthName</code><code class="p">(</code><code class="p">)</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">Key</code><code class="p">:</code><code> </code><code class="s">"password"</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="nx">dep</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">appsv1</code><code class="p">.</code><code class="nx">Deployment</code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="nx">ObjectMeta</code><code class="p">:</code><code> </code><code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="nx">Name</code><code class="p">:</code><code>         </code><code class="s">"mysql-backend-service"</code><code class="p">,</code><code> </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO4-2" id="co_operators_in_go_with_the_operator_sdk_CO4-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
        </code><code class="nx">Namespace</code><code class="p">:</code><code>    </code><code class="nx">instance</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="nx">Spec</code><code class="p">:</code><code> </code><code class="nx">appsv1</code><code class="p">.</code><code class="nx">DeploymentSpec</code><code class="p">{</code><code>&#13;
</code><code>        </code><code class="nx">Replicas</code><code class="p">:</code><code> </code><code class="o">&amp;</code><code class="nx">size</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">Selector</code><code class="p">:</code><code> </code><code class="o">&amp;</code><code class="nx">metav1</code><code class="p">.</code><code class="nx">LabelSelector</code><code class="p">{</code><code>&#13;
</code><code>            </code><code class="nx">MatchLabels</code><code class="p">:</code><code> </code><code class="nx">labels</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="nx">Template</code><code class="p">:</code><code> </code><code class="nx">corev1</code><code class="p">.</code><code class="nx">PodTemplateSpec</code><code class="p">{</code><code>&#13;
</code><code>            </code><code class="nx">ObjectMeta</code><code class="p">:</code><code> </code><code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">{</code><code>&#13;
</code><code>                </code><code class="nx">Labels</code><code class="p">:</code><code> </code><code class="nx">labels</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="nx">Spec</code><code class="p">:</code><code> </code><code class="nx">corev1</code><code class="p">.</code><code class="nx">PodSpec</code><code class="p">{</code><code>&#13;
</code><code>                </code><code class="nx">Containers</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">Container</code><code class="p">{</code><code class="p">{</code><code>&#13;
</code><code>                    </code><code class="nx">Image</code><code class="p">:</code><code>  </code><code class="s">"mysql:5.7"</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="nx">Name</code><code class="p">:</code><code>   </code><code class="s">"visitors-mysql"</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="nx">Ports</code><code class="p">:</code><code>  </code><code class="p">[</code><code class="p">]</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">ContainerPort</code><code class="p">{</code><code class="p">{</code><code>&#13;
</code><code>                        </code><code class="nx">ContainerPort</code><code class="p">:</code><code>    </code><code class="mi">3306</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="nx">Name</code><code class="p">:</code><code>             </code><code class="s">"mysql"</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="p">}</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="nx">Env</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">EnvVar</code><code class="p">{</code><code> </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO4-3" id="co_operators_in_go_with_the_operator_sdk_CO4-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
                        </code><code class="p">{</code><code>&#13;
</code><code>                            </code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="s">"MYSQL_ROOT_PASSWORD"</code><code class="p">,</code><code>&#13;
</code><code>                            </code><code class="nx">Value</code><code class="p">:</code><code> </code><code class="s">"password"</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="p">{</code><code>&#13;
</code><code>                            </code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="s">"MYSQL_DATABASE"</code><code class="p">,</code><code>&#13;
</code><code>                            </code><code class="nx">Value</code><code class="p">:</code><code> </code><code class="s">"visitors"</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="p">{</code><code>&#13;
</code><code>                            </code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="s">"MYSQL_USER"</code><code class="p">,</code><code>&#13;
</code><code>                            </code><code class="nx">ValueFrom</code><code class="p">:</code><code> </code><code class="nx">userSecret</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="p">{</code><code>&#13;
</code><code>                            </code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="s">"MYSQL_PASSWORD"</code><code class="p">,</code><code>&#13;
</code><code>                            </code><code class="nx">ValueFrom</code><code class="p">:</code><code> </code><code class="nx">passwordSecret</code><code class="p">,</code><code>&#13;
</code><code>                        </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>                    </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>                </code><code class="p">}</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>            </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>        </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>    </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="nx">controllerutil</code><code class="p">.</code><code class="nx">SetControllerReference</code><code class="p">(</code><code class="nx">instance</code><code class="p">,</code><code> </code><code class="nx">dep</code><code class="p">,</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">scheme</code><code class="p">)</code><code> </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO4-4" id="co_operators_in_go_with_the_operator_sdk_CO4-4"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO4-1" id="callout_operators_in_go_with_the_operator_sdk_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>In many cases, the Operator would read the number of deployed pods from the primary resource’s spec. For simplicity, this is hardcoded to <code>1</code> in this example.</p></dd>&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO4-2" id="callout_operators_in_go_with_the_operator_sdk_CO4-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>This is the value used in the earlier snippet when you are attempting to see if the deployment exists.</p></dd>&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO4-3" id="callout_operators_in_go_with_the_operator_sdk_CO4-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>For this example, these are hardcoded values. Take care to generate randomized values as appropriate.</p></dd>&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO4-4" id="callout_operators_in_go_with_the_operator_sdk_CO4-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>This is, arguably, the most important line in the definition. It establishes the parent/child relationship between the primary resource (VisitorsApp) and the child (deployment). Kubernetes uses this relationship for certain operations, as you’ll see in the following section.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The structure of the Go representation of the deployment closely resembles the YAML definition. Again, consult the API documentation for the specifics on how to use the Go object models.</p>&#13;
&#13;
<p>Regardless of the child resource type (deployment, service, etc.), create it using the client:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">createMe</code> <code class="o">:=</code> <code class="c1">// Deployment instance from above</code>&#13;
&#13;
<code class="c1">// Create the service</code>&#13;
<code class="nx">err</code> <code class="p">=</code> <code class="nx">r</code><code class="p">.</code><code class="nx">client</code><code class="p">.</code><code class="nx">Create</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">TODO</code><code class="p">(),</code> <code class="nx">createMe</code><code class="p">)</code>&#13;
&#13;
<code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="c1">// Creation failed</code>&#13;
    <code class="k">return</code> <code class="o">&amp;</code><code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="nx">err</code>&#13;
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="c1">// Creation was successful</code>&#13;
    <code class="k">return</code> <code class="kc">nil</code><code class="p">,</code> <code class="kc">nil</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Child Resource Deletion" data-type="sect2"><div class="sect2" id="child_resource_del">&#13;
<h2>Child Resource Deletion</h2>&#13;
&#13;
<p>In most cases, deleting child resources is significantly simpler than creating them: Kubernetes will do it for you. <a data-primary="resources" data-secondary="child resource deletion for Operator in Go" data-type="indexterm" id="idm45261331138808"/>If the child resource’s owner type is correctly set to the primary resource, when the parent is deleted, Kubernetes garbage collection will automatically clean up all of its child resources.</p>&#13;
&#13;
<p>It is important to understand that when Kubernetes deletes a resource, it still calls the <code>Reconcile</code> function. Kubernetes garbage collection is still performed, and the Operator will not be able to retrieve the primary resource. See <a data-type="xref" href="#retrieving_resource">“Retrieving the Resource”</a> for an example of the code that checks for this situation.</p>&#13;
&#13;
<p>There are times, however, where specific cleanup logic is required. The approach in such instances is to block the deletion of the primary resource through the use of a <em>finalizer</em>.<a data-primary="finalizers" data-type="indexterm" id="idm45261331473768"/></p>&#13;
&#13;
<p>A finalizer is simply a series of strings on a resource. If one or more finalizers are present on a resource, the <code>metadata.deletionTimestamp</code> field of the object is populated, signifying the end user’s desire to delete the resource.<a data-primary="metadata.deletionTimestamp field" data-type="indexterm" id="idm45261331471992"/> However, Kubernetes will only perform the actual deletion once all of the finalizers are removed.</p>&#13;
&#13;
<p>Using this construct, you can block the garbage collection of a resource until the Operator has a chance to perform its own cleanup step. Once the Operator has finished with the necessary cleanup, it removes the finalizer, unblocking Kubernetes from performing its normal deletion steps.</p>&#13;
&#13;
<p>The following snippet demonstrates using a finalizer to provide a window in which the Operator can take pre-deletion steps. This code executes after the retrieval of the instance object, as outlined in <a data-type="xref" href="#retrieving_resource">“Retrieving the Resource”</a>:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="nx">finalizer</code><code> </code><code class="o">:=</code><code> </code><code class="s">"visitors.example.com"</code><code>&#13;
</code><code>&#13;
</code><code class="nx">beingDeleted</code><code> </code><code class="o">:=</code><code> </code><code class="nx">instance</code><code class="p">.</code><code class="nx">GetDeletionTimestamp</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code>  </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO5-1" id="co_operators_in_go_with_the_operator_sdk_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="k">if</code><code> </code><code class="nx">beingDeleted</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><code class="k">if</code><code> </code><code class="nx">contains</code><code class="p">(</code><code class="nx">instance</code><code class="p">.</code><code class="nx">GetFinalizers</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">finalizer</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>&#13;
</code><code>        </code><code class="c1">// Perform finalization logic. If this fails, leave the finalizer&#13;
</code><code>        </code><code class="c1">// intact and requeue the reconcile request to attempt the clean&#13;
</code><code>        </code><code class="c1">// up again without allowing Kubernetes to actually delete&#13;
</code><code>        </code><code class="c1">// the resource.&#13;
</code><code>&#13;
</code><code>        </code><code class="nx">instance</code><code class="p">.</code><code class="nx">SetFinalizers</code><code class="p">(</code><code class="nx">remove</code><code class="p">(</code><code class="nx">instance</code><code class="p">.</code><code class="nx">GetFinalizers</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">finalizer</code><code class="p">)</code><code class="p">)</code><code> </code><a class="co" href="#callout_operators_in_go_with_the_operator_sdk_CO5-2" id="co_operators_in_go_with_the_operator_sdk_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
        </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">client</code><code class="p">.</code><code class="nx">Update</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">TODO</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><code class="nx">instance</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>            </code><code class="k">return</code><code> </code><code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>        </code><code class="p">}</code><code>&#13;
</code><code>    </code><code class="p">}</code><code>&#13;
</code><code>    </code><code class="k">return</code><code> </code><code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="kc">nil</code><code>&#13;
</code><code class="p">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO5-1" id="callout_operators_in_go_with_the_operator_sdk_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The presence of a deletion timestamp indicates that a requested delete is being blocked by one or more finalizers.</p></dd>&#13;
<dt><a class="co" href="#co_operators_in_go_with_the_operator_sdk_CO5-2" id="callout_operators_in_go_with_the_operator_sdk_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Once the cleanup tasks have finished, the Operator removes the finalizer so Kubernetes can continue with the resource cleanup.</p></dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Child Resource Naming" data-type="sect2"><div class="sect2" id="child_resource_naming">&#13;
<h2>Child Resource Naming</h2>&#13;
&#13;
<p>While the end user provides the name of the CR when creating it, the Operator is responsible for generating the names of any child resources it creates.<a data-primary="naming conventions, for child resources created by Operators" data-type="indexterm" id="idm45261331340440"/><a data-primary="resources" data-secondary="child resource naming for Operator in Go" data-type="indexterm" id="idm45261331339768"/> Take into consideration the following principles when creating these names:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Resource names must be unique within a given namespace.</p>&#13;
</li>&#13;
<li>&#13;
<p>Child resource names should be dynamically generated. Hardcoding child resource names leads to conflicts if there are multiple resources of the CR type in the same namespace.</p>&#13;
</li>&#13;
<li>&#13;
<p>Child resource names must be reproducible and consistent. An Operator may need to access a resource’s children in a future iteration through the reconcile loop and must be able to reliably retrieve those resources by name.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Idempotency" data-type="sect2"><div class="sect2" id="idempotency">&#13;
<h2>Idempotency</h2>&#13;
&#13;
<p>One of the biggest hurdles many developers face when writing controllers is the idea that Kubernetes uses a <em>declarative</em> API.<a data-primary="idempotency" data-secondary="in Operators" data-type="indexterm" id="idm45261331057720"/> End users don’t issue commands that Kubernetes immediately fulfills. Instead, they request an end state that the cluster should achieve.</p>&#13;
&#13;
<p>As such, the interface for controllers (and by extension, Operators) doesn’t include imperative commands such as “add resource” or “change a configuration value.” Instead, Kubernetes simply asks the controller to reconcile the state of a resource. The Operator then determines what steps, if any, it will take to ensure that end state.</p>&#13;
&#13;
<p>Therefore, it is critical that Operators are <em>idempotent</em>. Multiple calls to reconcile an unchanged resource must produce the same effect each time.</p>&#13;
&#13;
<p>The following tips can help you ensure idempotency in your Operators:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Before creating child resources, check to see if they already exist. Remember, Kubernetes may call the reconcile loop for a variety of reasons beyond when a user first creates a CR.<a data-primary="Reconcile function (or reconcile loop)" data-secondary="idempotency in Operators" data-type="indexterm" id="idm45261331035480"/> Your controller should not duplicate the CR’s children on each iteration through the loop.</p>&#13;
</li>&#13;
<li>&#13;
<p>Changes to a resource’s spec (in other words, its configuration values) trigger the reconcile loop. Therefore, it is often not enough to simply check for the existence of expected child resources. The Operator also needs to verify that the child resource configuration matches what is defined in the parent resource at the time of reconciliation.</p>&#13;
</li>&#13;
<li>&#13;
<p>Reconciliation is not necessarily called for each change to the resource. It is possible that a single reconciliation may contain multiple changes. The Operator must be careful to ensure the entire state of the CR is represented by all of its child resources.</p>&#13;
</li>&#13;
<li>&#13;
<p>Just because an Operator does not need to make changes during a reconciliation request doesn’t mean it doesn’t need to update the CR’s <code>Status</code> field. Depending on what values are captured in the CR’s status, it may make sense to update these even if the Operator determines it doesn’t need to make any changes to the existing resources.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Operator Impact" data-type="sect2"><div class="sect2" id="idm45261331029960">&#13;
<h2>Operator Impact</h2>&#13;
&#13;
<p>It is important to be aware of the impact your Operator will have on the cluster. In most cases, your Operator will create one or more resources. It also needs to communicate with the cluster through the Kubernetes APIs. If the Operator incorrectly handles these operations, they can negatively affect the performance of the entire cluster.</p>&#13;
&#13;
<p>How best to handle this varies from Operator to Operator. There is no set of rules that you can run through to ensure your Operator doesn’t overburden your cluster. However, you can use the following guidelines as a starting point to analyze your Operator’s approach:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Be careful when making frequent calls to the Kubernetes API. Make sure you use sensible delays (on the order of seconds rather than milliseconds) when repeatedly checking the API for a certain state being met.</p>&#13;
</li>&#13;
<li>&#13;
<p>When possible, try not to block the reconcile method for long periods of time. <a data-primary="Reconcile function (or reconcile loop)" data-type="indexterm" id="idm45261331130072"/>If, for instance, you are waiting for a child resource to be available before continuing, consider triggering another reconcile after a delay (see <a data-type="xref" href="#reconcile_function">“The Reconcile Function”</a> for more information on triggering subsequent iterations through the reconcile loop). This approach allows Kubernetes to manage its resources instead of having a reconcile request wait for long periods of time.</p>&#13;
</li>&#13;
<li>&#13;
<p>If you are deploying a large number of resources, consider throttling the deployment requests across multiple iterations through the reconcile loop. Remember that other workloads are running concurrently on the cluster. Your Operator should not cause excessive stress on cluster resources by issuing many creation requests at once.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running an Operator Locally" data-type="sect1"><div class="sect1" id="idm45261331894488">&#13;
<h1>Running an Operator Locally</h1>&#13;
&#13;
<p>The Operator SDK provides a means of running an Operator outside of a running cluster. This helps speed up development and testing by removing the need to go through the image creation and hosting steps. The process running the Operator may be outside of the cluster, but Kubernetes will treat<a data-primary="testing" data-secondary="high-level steps for Operator testing" data-type="indexterm" id="idm45261331124712"/> it as it does any other controller.</p>&#13;
&#13;
<p>The high-level steps for testing an Operator are as follows:</p>&#13;
<ol>&#13;
<li>&#13;
<p><em>Deploy the CRD.</em> You only need to do this once, unless further changes to the CRD are needed.<a data-primary="custom resource definitions (CRDs)" data-secondary="deploying" data-type="indexterm" id="idm45261331121912"/> In those cases, run the <code>kubectl</code> <code>apply</code> command again (from the Operator project root directory) to apply any changes:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>deploy/crds/*_crd.yaml</code></strong><code>&#13;
</code></pre>&#13;
</li>&#13;
<li>&#13;
<p><em>Start the Operator in local mode.</em> The Operator SDK uses credentials from the <code>kubectl</code> configuration file to connect to the cluster and attach the Operator.<a data-primary="local mode, starting an Operator in" data-type="indexterm" id="idm45261330917816"/> The running process acts as if it were an Operator pod running inside of the cluster and writes logging information to standard output:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code class="nb">export </code><code class="nv">OPERATOR_NAME</code><code class="o">=</code><code>&lt;</code><code>operator-name&gt;</code></strong><code>&#13;
</code><code class="nv">$ </code><strong><code>operator-sdk</code><code> </code><code>up</code><code> </code><code class="nb">local</code><code> </code><code>--namespace</code><code> </code><code>default</code></strong><code>&#13;
</code></pre>&#13;
&#13;
<p>The <code>--namespace</code> flag indicates the namespace in which the Operator will appear to be running.<a data-primary="namespaces" data-secondary="indicating where Operator will be running" data-type="indexterm" id="idm45261330790168"/></p>&#13;
</li>&#13;
<li>&#13;
<p><em>Deploy an example resource.</em> The SDK generates an example CR along with the CRD. <a data-primary="resources" data-secondary="deploying example resource along with the CRD" data-type="indexterm" id="idm45261330788136"/>It is located in the same directory and is named similarly to the CRD, but with the filename ending in <em>_cr.yaml</em> instead to denote its function.</p>&#13;
&#13;
<p>In most cases, you’ll want to edit the <code>spec</code> section of this file to provide the relevant configuration values for your resource. Once the necessary changes are made, deploy the CR (from the project root directory) using <code>kubectl</code>:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>deploy/crds/*_cr.yaml</code></strong><code>&#13;
</code></pre>&#13;
</li>&#13;
<li>&#13;
<p><em>Stop the running Operator process.</em> Stop the<a data-primary="stopping the running Operator process" data-type="indexterm" id="idm45261330764856"/> Operator process by pressing <code>Ctrl+C</code>. Unless the Operator adds finalizers to the CR, this is safe to do before deleting the CR itself, as Kubernetes will use the parent/child relationships of its resources to clean up any dependent objects.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The process described here is useful for development purposes, but for production, Operators are delivered as images. See <a data-type="xref" href="app01.html#appendix_operator_as_deployment">Appendix A</a> for more information on how to build and deploy an Operator as a container inside the cluster.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Visitors Site Example" data-type="sect1"><div class="sect1" id="idm45261330760904">&#13;
<h1>Visitors Site Example</h1>&#13;
&#13;
<p>The codebase for the Visitors Site Operator is too large to include. You can find the fully built Operator available in <a href="https://github.com/kubernetes-operators-book/chapters/tree/master/ch07/visitors-operator">this book’s GitHub repository</a>.<a data-primary="Visitors Site sample application" data-secondary="VisitorsSite Operator" data-type="indexterm" id="idm45261330758344"/></p>&#13;
&#13;
<p>The Operator SDK generated many of the files in that repository. The files that were modified to run the Visitors Site application are:</p>&#13;
<dl>&#13;
<dt><em>deploy/crds/</em></dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>example_v1_visitorsapp_crd.yaml</em></p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>This file contains the CRD.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p><em>example_v1_visitorsapp_cr.yaml</em></p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>This file defines a CR with sensible example data.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt><em>pkg/apis/example/v1/visitorsapp_types.go</em></dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>This file contains Go objects that represent the CR, including its <code>spec</code> and <code>status</code> fields.</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt><em>pkg/controller/visitorsapp/</em></dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>backend.go</em>, <em>frontend.go</em>, <em>mysql.go</em></p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>These files contain all of the information specific to deploying those components of the Visitors Site. This includes the deployments and services that the Operator maintains, as well as the logic to handle updating existing resources when the end user changes the CR.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p><em>common.go</em></p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>This file contains utility methods used to ensure the deployments and services are running, creating them if necessary.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<ul class="less_space pagebreak-before">&#13;
<li>&#13;
<p><em>visitorsapp_controller.go</em></p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The Operator SDK initially generated this file, which was then modified for the Visitors Site–specific logic. The <code>Reconcile</code> method contains the majority of the changes; it drives the overall flow of the Operator by calling out to functions in the previously described files.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45261330720744">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>Writing an Operator requires a considerable amount of code to tie into Kubernetes as a controller. The Operator SDK eases development by generating much of this boilerplate code, letting you focus on the business logic aspects. The SDK also provides utilities for building and testing Operators, greatly reducing the effort needed to go from inception to a running Operator.<a data-primary="Go programming language" data-secondary="creating custom Operators using Operator SDK" data-startref="ix_GoOps" data-type="indexterm" id="idm45261330719224"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Resources" data-type="sect1"><div class="sect1" id="idm45261330717880">&#13;
<h1>Resources</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/IwYGV">Kubernetes CR documentation</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://godoc.org/k8s.io/api">Kubernetes API documentation</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>