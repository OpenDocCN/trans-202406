<html><head></head><body><section data-pdf-bookmark="Chapter 6. Solutions for Writing Operators" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_operator-solutions">&#13;
<h1><span class="label">Chapter 6. </span>Solutions for Writing Operators</h1>&#13;
&#13;
&#13;
<p>So<a data-primary="operators" data-see="also controllers and operators" data-type="indexterm" id="idm46336859420664"/> far we’ve had a look at custom controllers and operators on a conceptual level in <a data-type="xref" href="ch01.html#ch_controllers-operators">“Controllers and Operators”</a> and, in <a data-type="xref" href="ch05.html#ch_autocodegen">Chapter 5</a>, how to use Kubernetes code generators—a rather low-level way to deal with the topic. In this chapter we’ll walk through three solutions for<a data-primary="operators" data-secondary="writing custom" data-type="indexterm" id="idm46336859401576"/><a data-primary="controllers and operators" data-secondary="writing custom" data-type="indexterm" id="COcustom06"/> writing custom controllers and operators in detail and discuss some more alternatives.</p>&#13;
&#13;
<p>Using one of the solutions discussed in this chapter should help you to avoid writing a lot of repetitive code and enable you to focus on the business logic, rather than on boilerplate code. It should get you started more quickly and make you more <span class="keep-together">productive</span>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Operators in general, and the tools we discuss in this chapter specifically, are still rapidly evolving as of mid-2019. While we do our best, certain commands and/or their outputs you see shown here, may change. Take this into account, and make sure that you always use the latest version of the respective tool, keeping an eye on the respective issue trackers, mailing lists, and Slack channels.</p>&#13;
</div>&#13;
&#13;
<p>While there are resources available online that <a href="http://bit.ly/2ZC5fZT">compare</a> the solutions we discuss here, we will not recommend a specific solution to you. We do, however, encourage you to evaluate and compare them yourself and pick the one that is the best fit for your organization and environment.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak" data-pdf-bookmark="Preparation" data-type="sect1"><div class="sect1" id="idm46336859394872">&#13;
<h1>Preparation</h1>&#13;
&#13;
<p>We<a data-primary="operators" data-secondary="preparation for writing" data-type="indexterm" id="idm46336859393096"/> will be using <code>cnat</code> (cloud-native <code>at</code>, which we introduced in <a data-type="xref" href="ch01.html#mot-example">“A Motivational Example”</a>) as the running example for the different solutions in this chapter. If you want to follow along, note that we assume you:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Have Go version 1.12 or above installed and set up properly.</p>&#13;
</li>&#13;
<li>&#13;
<p>Have access to a Kubernetes cluster in version 1.12 or above—either locally through, for example, <code>kind</code> or <code>k3d</code>, or remotely through your favorite cloud provider—and <code>kubectl</code> configured to access it.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>git clone</code> our <a href="http://bit.ly/2N3R6U4">GitHub repository</a>. The complete, functioning source code and the necessary commands shown in the following sections are available there. Note that what we’re showing here is how things work from scratch. If you want to see the results rather than carrying out the steps yourself, you’re also welcome to clone the repository and run only the commands to install the CRD, install  the CR, and launch the custom controller.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>With these housekeeping items out of the way, let’s jump into writing operators: we will covers, the <code>sample-controller</code>, Kubebuilder, and the Operator SDK in this chapter.</p>&#13;
&#13;
<p>Ready? Let’s Go—pun intended!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Following sample-controller" data-type="sect1"><div class="sect1" id="cnat-client-go">&#13;
<h1>Following sample-controller</h1>&#13;
&#13;
<p>Let’s<a data-primary="operators" data-secondary="following sample-controller" data-type="indexterm" id="OPsample06"/><a data-primary="sample-controller" data-secondary="implementing operators following" data-type="indexterm" id="idm46336859379704"/> start off by implementing <code>cnat</code> based on the <a href="http://bit.ly/2UppsTN"><em>k8s.io/sample-controller</em></a>, which uses the <code>client-go</code> library <a href="http://bit.ly/2Yas9HK">directly</a>. The <code>sample-controller</code> uses the <a href="http://bit.ly/2Kw8I8U"><em>k8s.io/code-generator</em></a> to generate a typed client, informers, listers, and deep-copy functions. Whenever the API types change in your custom controller—for example, adding a new field in the custom resource—you have to use the <em>update-codegen.sh</em> script (see also its <a href="http://bit.ly/2Fq3Td1">source</a> in GitHub) to regenerate the aforementioned source files.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>You might have noticed <em>k8s.io</em> being used as the base URL throughout the book. We introduced its usage in <a data-type="xref" href="ch03.html#ch_client-go">Chapter 3</a>; as a reminder, it is really an alias for <em>kubernetes.io</em>, and in the context of Go package management it resolves to <em>github.com/kubernetes</em>. Note that <em>k8s.io</em> does not come with an automatic redirect. So, for example, <em>k8s.io/sample-controller</em> really means that you should be looking at <a href="http://bit.ly/2UppsTN"><em>github.com/kubernetes/sample-controller</em></a>, and so on.</p>&#13;
</div>&#13;
&#13;
<p>OK, let’s implement our <a href="http://bit.ly/2RpHhON"><code>cnat</code></a> operator using <code>client-go</code>, following the <code>sample-controller</code>. (See the <a href="http://bit.ly/2N3R6U4">corresponding directory in our repo</a>.)</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Bootstrapping" data-type="sect2"><div class="sect2" id="idm46336859365144">&#13;
<h2>Bootstrapping</h2>&#13;
&#13;
<p>To<a data-primary="sample-controller" data-secondary="bootstrapping" data-type="indexterm" id="idm46336859363480"/> begin, do a <strong><code>go get k8s.io/sample-controller</code></strong> to get the source and dependencies onto your system, which should be in <em>$GOPATH/src/k8s.io/sample-\controller</em>.</p>&#13;
&#13;
<p>If you start from scratch, copy the content of the <em>sample-controller</em> directory into a directory of your choice (for example, we use <em>cnat-client-go</em> in our repo), and you can run the following command sequence to build and run the base controller (with the default implementation, not the <code>cnat</code> business logic yet):</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="c"># build custom controller binary:</code>&#13;
<code class="nv">$ </code>go build -o cnat-controller .&#13;
&#13;
<code class="c"># launch custom controller locally:</code>&#13;
<code class="nv">$ </code>./cnat-controller -kubeconfig<code class="o">=</code><code class="nv">$HOME</code>/.kube/config</pre>&#13;
&#13;
<p>This command will launch the custom controller and wait for you to register the CRD and create a custom resource. Let’s do this now and see what happens. In<a data-primary="kubectl apply -f" data-type="indexterm" id="idm46336859356328"/> a second terminal session, enter:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl apply -f artifacts/examples/crd.yaml</pre>&#13;
&#13;
<p>Make<a data-primary="kubectl get crds" data-type="indexterm" id="idm46336859348200"/> sure the CRD is properly registered and available like so:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl get crds&#13;
NAME                            CREATED AT&#13;
foos.samplecontroller.k8s.io    2019-05-29T12:16:57Z</pre>&#13;
&#13;
<p>Note that you may see other CRDs here, depending on the Kubernetes distro you’re using; however, <em>foos.samplecontroller.k8s.io</em> should be listed, at least.</p>&#13;
&#13;
<p>Next, we create the example custom resource <em>foo.samplecontroller.k8s.io/example-foo</em> and check if the controller does its job:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl apply -f artifacts/examples/example-foo.yaml&#13;
foo.samplecontroller.k8s.io/example-foo created&#13;
&#13;
<code class="nv">$ </code>kubectl get po,rs,deploy,foo&#13;
NAME                                           READY   STATUS    RESTARTS   AGE&#13;
pod/example-foo-5b8c9679d8-xjhdf               1/1     Running   <code class="m">0</code>          67s&#13;
&#13;
NAME                                           DESIRED   CURRENT   READY AGE&#13;
replicaset.extensions/example-foo-5b8c9679d8   <code class="m">1</code>         <code class="m">1</code>         <code class="m">1</code>     67s&#13;
&#13;
NAME                                           READY   UP-TO-DATE   AVAILABLE   AGE&#13;
deployment.extensions/example-foo              1/1     <code class="m">1</code>            <code class="m">1</code>           67s&#13;
&#13;
NAME                                           AGE&#13;
foo.samplecontroller.k8s.io/example-foo        67s</pre>&#13;
&#13;
<p>Yay, it works as expected! We can now move on to implementing the actual <code>cnat</code>-specific business logic.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Business Logic" data-type="sect2"><div class="sect2" id="idm46336859364520">&#13;
<h2>Business Logic</h2>&#13;
&#13;
<p>To<a data-primary="sample-controller" data-secondary="business logic implementation" data-type="indexterm" id="SCbusiness06"/> kick off implementing the business logic, we first rename the existing directory <em>pkg/apis/samplecontroller</em> to <em>pkg/apis/cnat</em> and then create our own CRD and custom resource as  follows:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>cat artifacts/examples/cnat-crd.yaml&#13;
apiVersion: apiextensions.k8s.io/v1beta1&#13;
kind: CustomResourceDefinition&#13;
metadata:&#13;
  name: ats.cnat.programming-kubernetes.info&#13;
spec:&#13;
  group: cnat.programming-kubernetes.info&#13;
  version: v1alpha1&#13;
  names:&#13;
    kind: At&#13;
    plural: ats&#13;
  scope: Namespaced&#13;
&#13;
<code class="nv">$ </code>cat artifacts/examples/cnat-example.yaml&#13;
apiVersion: cnat.programming-kubernetes.info/v1alpha1&#13;
kind: At&#13;
metadata:&#13;
  labels:&#13;
    controller-tools.k8s.io: <code class="s2">"1.0"</code>&#13;
  name: example-at&#13;
spec:&#13;
  schedule: <code class="s2">"2019-04-12T10:12:00Z"</code>&#13;
  <code class="nb">command</code>: <code class="s2">"echo YAY"</code></pre>&#13;
&#13;
<p>Note that whenever the API types change—for example, when you add a new field to the <code>At</code> CRD—you have to execute the <em>update-codegen.sh</em> script, like so:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>./hack/update-codegen.sh</pre>&#13;
&#13;
<p>This will automatically generate the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>pkg/apis/cnat/v1alpha1/zz_generated.deepcopy.go</em></p>&#13;
</li>&#13;
<li>&#13;
<p><em>pkg/generated/*</em></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In terms of the business logic, we have two parts to implement in the operator:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>In <a href="http://bit.ly/31QosJw"><em>types.go</em></a> we modify the <code>AtSpec</code> struct to include the respective fields, such as <code>schedule</code> and <code>command</code>. Note that you must run <code>update-codegen.sh</code> whenever you change something here in order to regenerate dependent files.</p>&#13;
</li>&#13;
<li>&#13;
<p>In <a href="http://bit.ly/31MM4OS"><em>controller.go</em></a> we change the <code>NewController()</code> and <code>syncHandler()</code> functions as well as add helper functions, including creating pods and checking schedule time.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In <em>types.go</em>, note the three constants representing the three phases of the <code>At</code> resource: up until the scheduled time in <code>PENDING</code>, then <code>RUNNING</code> to completion, and finally in the <code>DONE</code> state:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// +genclient</code>&#13;
<code class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</code>&#13;
&#13;
<code class="kd">const</code> <code class="p">(</code>&#13;
    <code class="nx">PhasePending</code> <code class="p">=</code> <code class="s">"PENDING"</code>&#13;
    <code class="nx">PhaseRunning</code> <code class="p">=</code> <code class="s">"RUNNING"</code>&#13;
    <code class="nx">PhaseDone</code>    <code class="p">=</code> <code class="s">"DONE"</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="c1">// AtSpec defines the desired state of At</code>&#13;
<code class="kd">type</code> <code class="nx">AtSpec</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="c1">// Schedule is the desired time the command is supposed to be executed.</code>&#13;
    <code class="c1">// Note: the format used here is UTC time https://www.utctime.net</code>&#13;
    <code class="nx">Schedule</code> <code class="kt">string</code> <code class="s">`json:"schedule,omitempty"`</code>&#13;
    <code class="c1">// Command is the desired command (executed in a Bash shell) to be</code>&#13;
    <code class="c1">// executed.</code>&#13;
    <code class="nx">Command</code> <code class="kt">string</code> <code class="s">`json:"command,omitempty"`</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// AtStatus defines the observed state of At</code>&#13;
<code class="kd">type</code> <code class="nx">AtStatus</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="c1">// Phase represents the state of the schedule: until the command is</code>&#13;
    <code class="c1">// executed it is PENDING, afterwards it is DONE.</code>&#13;
    <code class="nx">Phase</code> <code class="kt">string</code> <code class="s">`json:"phase,omitempty"`</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Note the explicit usage of the build tags <code>+k8s:deepcopy-gen:interfaces</code> (refer to <a data-type="xref" href="ch05.html#ch_autocodegen">Chapter 5</a>) so that the respective sources are autogenerated.</p>&#13;
&#13;
<p>We are now in the position to implement the business logic of the custom controller. That is, we implement the state transitions between the three&#13;
phases—from <code>PhasePending</code> to <code>PhaseRunning</code> to <code>PhaseDone</code>—in <a href="http://bit.ly/31MM4OS">controller.go</a>.</p>&#13;
&#13;
<p>In <a data-type="xref" href="ch03.html#workqueue">“Work Queue”</a> we introduced and explained the work queue that <code>client-go</code> provides. We can now put this knowledge to work: in the <code>processNextWorkItem()</code> in <em>controller.go</em>—to be more precise, in <a href="http://bit.ly/2WYDbyi">lines 176 to 186</a>—you can find the following (generated) code:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="k">if</code> <code class="nx">when</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">c</code><code class="p">.</code><code class="nx">syncHandler</code><code class="p">(</code><code class="nx">key</code><code class="p">);</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="nx">c</code><code class="p">.</code><code class="nx">workqueue</code><code class="p">.</code><code class="nx">AddRateLimited</code><code class="p">(</code><code class="nx">key</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"error syncing '%s': %s, requeuing"</code><code class="p">,</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">())</code>&#13;
<code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="nx">when</code> <code class="o">!=</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">c</code><code class="p">.</code><code class="nx">workqueue</code><code class="p">.</code><code class="nx">AddAfter</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">when</code><code class="p">)</code>&#13;
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="c1">// Finally, if no error occurs we Forget this item so it does not</code>&#13;
    <code class="c1">// get queued again until another change happens.</code>&#13;
    <code class="nx">c</code><code class="p">.</code><code class="nx">workqueue</code><code class="p">.</code><code class="nx">Forget</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This snippet shows how our (yet-to-be-written) custom <code>syncHandler()</code> function (explained shortly) is invoked and covers these three cases:</p>&#13;
<ol>&#13;
<li>&#13;
<p>The first <code>if</code> branch requeues the item via the <code>AddRateLimited()</code> function call, handling transient errors.</p>&#13;
</li>&#13;
<li>&#13;
<p>The second branch, the <code>else if</code>, requeues the item via the <code>AddAfter()</code> function call to avoid hot-looping.</p>&#13;
</li>&#13;
<li>&#13;
<p>The last case, the <code>else</code>, is where the item has been processed successfully and is discarded via the <code>Forget()</code> function call.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Now that we’ve got a sound understanding of the generic handling, let’s move on to the business-logic-specific functionality. Key to it is the aforementioned <code>syncHandler()</code> function, where we are implementing the business logic of our custom controller. It has the following signature:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// syncHandler compares the actual state with the desired state and attempts</code>&#13;
<code class="c1">// to converge the two. It then updates the Status block of the At resource</code>&#13;
<code class="c1">// with the current status of the resource. It returns how long to wait</code>&#13;
<code class="c1">// until the schedule is due.</code>&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">c</code> <code class="o">*</code><code class="nx">Controller</code><code class="p">)</code> <code class="nx">syncHandler</code><code class="p">(</code><code class="nx">key</code> <code class="kt">string</code><code class="p">)</code> <code class="p">(</code><code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="o">...</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This <code>syncHandler()</code> function implements the following state transitions:<sup><a data-type="noteref" href="ch06.html#idm46336858995208" id="idm46336858995208-marker">1</a></sup></p>&#13;
&#13;
<pre class="small" data-code-language="go" data-type="programlisting"><code class="o">...</code>&#13;
<code class="c1">// If no phase set, default to pending (the initial phase):</code>&#13;
<code class="k">if</code> <code class="nx">instance</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="o">==</code> <code class="s">""</code> <code class="p">{</code>&#13;
    <code class="nx">instance</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="p">=</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhasePending</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Now let's make the main case distinction: implementing</code>&#13;
<code class="c1">// the state diagram PENDING -&gt; RUNNING -&gt; DONE</code>&#13;
<code class="k">switch</code> <code class="nx">instance</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="p">{</code>&#13;
<code class="k">case</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhasePending</code><code class="p">:</code>&#13;
    <code class="nx">klog</code><code class="p">.</code><code class="nx">Infof</code><code class="p">(</code><code class="s">"instance %s: phase=PENDING"</code><code class="p">,</code> <code class="nx">key</code><code class="p">)</code>&#13;
    <code class="c1">// As long as we haven't executed the command yet, we need</code>&#13;
    <code class="c1">// to check if it's time already to act:</code>&#13;
    <code class="nx">klog</code><code class="p">.</code><code class="nx">Infof</code><code class="p">(</code><code class="s">"instance %s: checking schedule %q"</code><code class="p">,</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">instance</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Schedule</code><code class="p">)</code>&#13;
    <code class="c1">// Check if it's already time to execute the command with a</code>&#13;
    <code class="c1">// tolerance of 2 seconds:</code>&#13;
    <code class="nx">d</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">timeUntilSchedule</code><code class="p">(</code><code class="nx">instance</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Schedule</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="nx">utilruntime</code><code class="p">.</code><code class="nx">HandleError</code><code class="p">(</code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Errorf</code><code class="p">(</code><code class="s">"schedule parsing failed: %v"</code><code class="p">,</code> <code class="nx">err</code><code class="p">))</code>&#13;
        <code class="c1">// Error reading the schedule - requeue the request:</code>&#13;
        <code class="k">return</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code> <code class="nx">err</code>&#13;
    <code class="p">}</code>&#13;
    <code class="nx">klog</code><code class="p">.</code><code class="nx">Infof</code><code class="p">(</code><code class="s">"instance %s: schedule parsing done: diff=%v"</code><code class="p">,</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">d</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">d</code> <code class="p">&gt;</code> <code class="mi">0</code> <code class="p">{</code>&#13;
        <code class="c1">// Not yet time to execute the command, wait until the</code>&#13;
        <code class="c1">// scheduled time</code>&#13;
        <code class="k">return</code> <code class="nx">d</code><code class="p">,</code> <code class="kc">nil</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nx">klog</code><code class="p">.</code><code class="nx">Infof</code><code class="p">(</code>&#13;
       <code class="s">"instance %s: it's time! Ready to execute: %s"</code><code class="p">,</code> <code class="nx">key</code><code class="p">,</code>&#13;
       <code class="nx">instance</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Command</code><code class="p">,</code>&#13;
    <code class="p">)</code>&#13;
    <code class="nx">instance</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="p">=</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhaseRunning</code>&#13;
<code class="k">case</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhaseRunning</code><code class="p">:</code>&#13;
    <code class="nx">klog</code><code class="p">.</code><code class="nx">Infof</code><code class="p">(</code><code class="s">"instance %s: Phase: RUNNING"</code><code class="p">,</code> <code class="nx">key</code><code class="p">)</code>&#13;
&#13;
    <code class="nx">pod</code> <code class="o">:=</code> <code class="nx">newPodForCR</code><code class="p">(</code><code class="nx">instance</code><code class="p">)</code>&#13;
&#13;
    <code class="c1">// Set At instance as the owner and controller</code>&#13;
    <code class="nx">owner</code> <code class="o">:=</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">NewControllerRef</code><code class="p">(</code>&#13;
        <code class="nx">instance</code><code class="p">,</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">SchemeGroupVersion</code><code class="p">.</code>&#13;
        <code class="nx">WithKind</code><code class="p">(</code><code class="s">"At"</code><code class="p">),</code>&#13;
    <code class="p">)</code>&#13;
    <code class="nx">pod</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">.</code><code class="nx">OwnerReferences</code> <code class="p">=</code> <code class="nb">append</code><code class="p">(</code><code class="nx">pod</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">.</code><code class="nx">OwnerReferences</code><code class="p">,</code> <code class="o">*</code><code class="nx">owner</code><code class="p">)</code>&#13;
&#13;
    <code class="c1">// Try to see if the pod already exists and if not</code>&#13;
    <code class="c1">// (which we expect) then create a one-shot pod as per spec:</code>&#13;
    <code class="nx">found</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">c</code><code class="p">.</code><code class="nx">kubeClientset</code><code class="p">.</code><code class="nx">CoreV1</code><code class="p">().</code><code class="nx">Pods</code><code class="p">(</code><code class="nx">pod</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">).</code>&#13;
        <code class="nx">Get</code><code class="p">(</code><code class="nx">pod</code><code class="p">.</code><code class="nx">Name</code><code class="p">,</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">GetOptions</code><code class="p">{})</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="o">&amp;&amp;</code> <code class="nx">errors</code><code class="p">.</code><code class="nx">IsNotFound</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nx">found</code><code class="p">,</code> <code class="nx">err</code> <code class="p">=</code> <code class="nx">c</code><code class="p">.</code><code class="nx">kubeClientset</code><code class="p">.</code><code class="nx">CoreV1</code><code class="p">().</code><code class="nx">Pods</code><code class="p">(</code><code class="nx">pod</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">).</code><code class="nx">Create</code><code class="p">(</code><code class="nx">pod</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code> <code class="nx">err</code>&#13;
        <code class="p">}</code>&#13;
        <code class="nx">klog</code><code class="p">.</code><code class="nx">Infof</code><code class="p">(</code><code class="s">"instance %s: pod launched: name=%s"</code><code class="p">,</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">pod</code><code class="p">.</code><code class="nx">Name</code><code class="p">)</code>&#13;
    <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="c1">// requeue with error</code>&#13;
        <code class="k">return</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code> <code class="nx">err</code>&#13;
    <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="nx">found</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="o">==</code> <code class="nx">corev1</code><code class="p">.</code><code class="nx">PodFailed</code> <code class="o">||</code>&#13;
        <code class="nx">found</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="o">==</code> <code class="nx">corev1</code><code class="p">.</code><code class="nx">PodSucceeded</code> <code class="p">{</code>&#13;
        <code class="nx">klog</code><code class="p">.</code><code class="nx">Infof</code><code class="p">(</code>&#13;
            <code class="s">"instance %s: container terminated: reason=%q message=%q"</code><code class="p">,</code>&#13;
            <code class="nx">key</code><code class="p">,</code> <code class="nx">found</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Reason</code><code class="p">,</code> <code class="nx">found</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Message</code><code class="p">,</code>&#13;
        <code class="p">)</code>&#13;
        <code class="nx">instance</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="p">=</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhaseDone</code>&#13;
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
        <code class="c1">// Don't requeue because it will happen automatically</code>&#13;
        <code class="c1">// when the pod status changes.</code>&#13;
        <code class="k">return</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code> <code class="kc">nil</code>&#13;
    <code class="p">}</code>&#13;
<code class="k">case</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhaseDone</code><code class="p">:</code>&#13;
    <code class="nx">klog</code><code class="p">.</code><code class="nx">Infof</code><code class="p">(</code><code class="s">"instance %s: phase: DONE"</code><code class="p">,</code> <code class="nx">key</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code> <code class="kc">nil</code>&#13;
<code class="k">default</code><code class="p">:</code>&#13;
    <code class="nx">klog</code><code class="p">.</code><code class="nx">Infof</code><code class="p">(</code><code class="s">"instance %s: NOP"</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code> <code class="kc">nil</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Update the At instance, setting the status to the respective phase:</code>&#13;
<code class="nx">_</code><code class="p">,</code> <code class="nx">err</code> <code class="p">=</code> <code class="nx">c</code><code class="p">.</code><code class="nx">cnatClientset</code><code class="p">.</code><code class="nx">CnatV1alpha1</code><code class="p">().</code><code class="nx">Ats</code><code class="p">(</code><code class="nx">instance</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">).</code>&#13;
    <code class="nx">UpdateStatus</code><code class="p">(</code><code class="nx">instance</code><code class="p">)</code>&#13;
<code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code> <code class="nx">err</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Don't requeue. We should be reconcile because either the pod or</code>&#13;
<code class="c1">// the CR changes.</code>&#13;
<code class="k">return</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code> <code class="kc">nil</code></pre>&#13;
&#13;
<p>Further, to set up informers and the controller at large, we implement the following in <code>NewController()</code>:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// NewController returns a new cnat controller</code>&#13;
<code class="kd">func</code> <code class="nx">NewController</code><code class="p">(</code>&#13;
    <code class="nx">kubeClientset</code> <code class="nx">kubernetes</code><code class="p">.</code><code class="nx">Interface</code><code class="p">,</code>&#13;
    <code class="nx">cnatClientset</code> <code class="nx">clientset</code><code class="p">.</code><code class="nx">Interface</code><code class="p">,</code>&#13;
    <code class="nx">atInformer</code> <code class="nx">informers</code><code class="p">.</code><code class="nx">AtInformer</code><code class="p">,</code>&#13;
    <code class="nx">podInformer</code> <code class="nx">corev1informer</code><code class="p">.</code><code class="nx">PodInformer</code><code class="p">)</code> <code class="o">*</code><code class="nx">Controller</code> <code class="p">{</code>&#13;
&#13;
    <code class="c1">// Create event broadcaster</code>&#13;
    <code class="c1">// Add cnat-controller types to the default Kubernetes Scheme so Events</code>&#13;
    <code class="c1">// can be logged for cnat-controller types.</code>&#13;
    <code class="nx">utilruntime</code><code class="p">.</code><code class="nx">Must</code><code class="p">(</code><code class="nx">cnatscheme</code><code class="p">.</code><code class="nx">AddToScheme</code><code class="p">(</code><code class="nx">scheme</code><code class="p">.</code><code class="nx">Scheme</code><code class="p">))</code>&#13;
    <code class="nx">klog</code><code class="p">.</code><code class="nx">V</code><code class="p">(</code><code class="mi">4</code><code class="p">).</code><code class="nx">Info</code><code class="p">(</code><code class="s">"Creating event broadcaster"</code><code class="p">)</code>&#13;
    <code class="nx">eventBroadcaster</code> <code class="o">:=</code> <code class="nx">record</code><code class="p">.</code><code class="nx">NewBroadcaster</code><code class="p">()</code>&#13;
    <code class="nx">eventBroadcaster</code><code class="p">.</code><code class="nx">StartLogging</code><code class="p">(</code><code class="nx">klog</code><code class="p">.</code><code class="nx">Infof</code><code class="p">)</code>&#13;
    <code class="nx">eventBroadcaster</code><code class="p">.</code><code class="nx">StartRecordingToSink</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">typedcorev1</code><code class="p">.</code><code class="nx">EventSinkImpl</code><code class="p">{</code>&#13;
        <code class="nx">Interface</code><code class="p">:</code> <code class="nx">kubeClientset</code><code class="p">.</code><code class="nx">CoreV1</code><code class="p">().</code><code class="nx">Events</code><code class="p">(</code><code class="s">""</code><code class="p">),</code>&#13;
    <code class="p">})</code>&#13;
    <code class="nx">source</code> <code class="o">:=</code> <code class="nx">corev1</code><code class="p">.</code><code class="nx">EventSource</code><code class="p">{</code><code class="nx">Component</code><code class="p">:</code> <code class="nx">controllerAgentName</code><code class="p">}</code>&#13;
    <code class="nx">recorder</code> <code class="o">:=</code> <code class="nx">eventBroadcaster</code><code class="p">.</code><code class="nx">NewRecorder</code><code class="p">(</code><code class="nx">scheme</code><code class="p">.</code><code class="nx">Scheme</code><code class="p">,</code> <code class="nx">source</code><code class="p">)</code>&#13;
&#13;
    <code class="nx">rateLimiter</code> <code class="o">:=</code> <code class="nx">workqueue</code><code class="p">.</code><code class="nx">DefaultControllerRateLimiter</code><code class="p">()</code>&#13;
    <code class="nx">controller</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="nx">Controller</code><code class="p">{</code>&#13;
        <code class="nx">kubeClientset</code><code class="p">:</code> <code class="nx">kubeClientset</code><code class="p">,</code>&#13;
        <code class="nx">cnatClientset</code><code class="p">:</code> <code class="nx">cnatClientset</code><code class="p">,</code>&#13;
        <code class="nx">atLister</code><code class="p">:</code>      <code class="nx">atInformer</code><code class="p">.</code><code class="nx">Lister</code><code class="p">(),</code>&#13;
        <code class="nx">atsSynced</code><code class="p">:</code>     <code class="nx">atInformer</code><code class="p">.</code><code class="nx">Informer</code><code class="p">().</code><code class="nx">HasSynced</code><code class="p">,</code>&#13;
        <code class="nx">podLister</code><code class="p">:</code>     <code class="nx">podInformer</code><code class="p">.</code><code class="nx">Lister</code><code class="p">(),</code>&#13;
        <code class="nx">podsSynced</code><code class="p">:</code>    <code class="nx">podInformer</code><code class="p">.</code><code class="nx">Informer</code><code class="p">().</code><code class="nx">HasSynced</code><code class="p">,</code>&#13;
        <code class="nx">workqueue</code><code class="p">:</code>     <code class="nx">workqueue</code><code class="p">.</code><code class="nx">NewNamedRateLimitingQueue</code><code class="p">(</code><code class="nx">rateLimiter</code><code class="p">,</code> <code class="s">"Ats"</code><code class="p">),</code>&#13;
        <code class="nx">recorder</code><code class="p">:</code>      <code class="nx">recorder</code><code class="p">,</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nx">klog</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"Setting up event handlers"</code><code class="p">)</code>&#13;
    <code class="c1">// Set up an event handler for when At resources change</code>&#13;
    <code class="nx">atInformer</code><code class="p">.</code><code class="nx">Informer</code><code class="p">().</code><code class="nx">AddEventHandler</code><code class="p">(</code><code class="nx">cache</code><code class="p">.</code><code class="nx">ResourceEventHandlerFuncs</code><code class="p">{</code>&#13;
        <code class="nx">AddFunc</code><code class="p">:</code> <code class="nx">controller</code><code class="p">.</code><code class="nx">enqueueAt</code><code class="p">,</code>&#13;
        <code class="nx">UpdateFunc</code><code class="p">:</code> <code class="kd">func</code><code class="p">(</code><code class="nx">old</code><code class="p">,</code> <code class="nx">new</code> <code class="kd">interface</code><code class="p">{})</code> <code class="p">{</code>&#13;
            <code class="nx">controller</code><code class="p">.</code><code class="nx">enqueueAt</code><code class="p">(</code><code class="nx">new</code><code class="p">)</code>&#13;
        <code class="p">},</code>&#13;
    <code class="p">})</code>&#13;
    <code class="c1">// Set up an event handler for when Pod resources change</code>&#13;
    <code class="nx">podInformer</code><code class="p">.</code><code class="nx">Informer</code><code class="p">().</code><code class="nx">AddEventHandler</code><code class="p">(</code><code class="nx">cache</code><code class="p">.</code><code class="nx">ResourceEventHandlerFuncs</code><code class="p">{</code>&#13;
        <code class="nx">AddFunc</code><code class="p">:</code> <code class="nx">controller</code><code class="p">.</code><code class="nx">enqueuePod</code><code class="p">,</code>&#13;
        <code class="nx">UpdateFunc</code><code class="p">:</code> <code class="kd">func</code><code class="p">(</code><code class="nx">old</code><code class="p">,</code> <code class="nx">new</code> <code class="kd">interface</code><code class="p">{})</code> <code class="p">{</code>&#13;
            <code class="nx">controller</code><code class="p">.</code><code class="nx">enqueuePod</code><code class="p">(</code><code class="nx">new</code><code class="p">)</code>&#13;
        <code class="p">},</code>&#13;
    <code class="p">})</code>&#13;
    <code class="k">return</code> <code class="nx">controller</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>There are two further helper functions we need in order to make it work: one calculates the time until the schedule, which looks like this:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code> <code class="nx">timeUntilSchedule</code><code class="p">(</code><code class="nx">schedule</code> <code class="kt">string</code><code class="p">)</code> <code class="p">(</code><code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">now</code> <code class="o">:=</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Now</code><code class="p">().</code><code class="nx">UTC</code><code class="p">()</code>&#13;
    <code class="nx">layout</code> <code class="o">:=</code> <code class="s">"2006-01-02T15:04:05Z"</code>&#13;
    <code class="nx">s</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Parse</code><code class="p">(</code><code class="nx">layout</code><code class="p">,</code> <code class="nx">schedule</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">time</code><code class="p">.</code><code class="nx">Duration</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code> <code class="nx">err</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">return</code> <code class="nx">s</code><code class="p">.</code><code class="nx">Sub</code><code class="p">(</code><code class="nx">now</code><code class="p">),</code> <code class="kc">nil</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>and the other creates a pod with the command to execute, using a <code>busybox</code> container image:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code> <code class="nx">newPodForCR</code><code class="p">(</code><code class="nx">cr</code> <code class="o">*</code><code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">At</code><code class="p">)</code> <code class="o">*</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">Pod</code> <code class="p">{</code>&#13;
    <code class="nx">labels</code> <code class="o">:=</code> <code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code>&#13;
        <code class="s">"app"</code><code class="p">:</code> <code class="nx">cr</code><code class="p">.</code><code class="nx">Name</code><code class="p">,</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">return</code> <code class="o">&amp;</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">Pod</code><code class="p">{</code>&#13;
        <code class="nx">ObjectMeta</code><code class="p">:</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">{</code>&#13;
            <code class="nx">Name</code><code class="p">:</code>      <code class="nx">cr</code><code class="p">.</code><code class="nx">Name</code> <code class="o">+</code> <code class="s">"-pod"</code><code class="p">,</code>&#13;
            <code class="nx">Namespace</code><code class="p">:</code> <code class="nx">cr</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">,</code>&#13;
            <code class="nx">Labels</code><code class="p">:</code>    <code class="nx">labels</code><code class="p">,</code>&#13;
        <code class="p">},</code>&#13;
        <code class="nx">Spec</code><code class="p">:</code> <code class="nx">corev1</code><code class="p">.</code><code class="nx">PodSpec</code><code class="p">{</code>&#13;
            <code class="nx">Containers</code><code class="p">:</code> <code class="p">[]</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">Container</code><code class="p">{</code>&#13;
                <code class="p">{</code>&#13;
                    <code class="nx">Name</code><code class="p">:</code>    <code class="s">"busybox"</code><code class="p">,</code>&#13;
                    <code class="nx">Image</code><code class="p">:</code>   <code class="s">"busybox"</code><code class="p">,</code>&#13;
                    <code class="nx">Command</code><code class="p">:</code> <code class="nx">strings</code><code class="p">.</code><code class="nx">Split</code><code class="p">(</code><code class="nx">cr</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Command</code><code class="p">,</code> <code class="s">" "</code><code class="p">),</code>&#13;
                <code class="p">},</code>&#13;
            <code class="p">},</code>&#13;
            <code class="nx">RestartPolicy</code><code class="p">:</code> <code class="nx">corev1</code><code class="p">.</code><code class="nx">RestartPolicyOnFailure</code><code class="p">,</code>&#13;
        <code class="p">},</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>We will be reusing these two helper functions and the basic flow of the business logic as presented here in the <code>syncHandler()</code> function later in this chapter, so make sure you familiarize yourself with their details.</p>&#13;
&#13;
<p>Note that from the point of the <code>At</code> resource, the pod is a secondary resource and the controller must make sure to clean those pods up or otherwise risk orphaned pods.</p>&#13;
&#13;
<p>Now, <code>sample-controller</code> is a good tool to learn how the sausage is made, but usually you want to focus on creating the business logic rather than dealing with the boilerplate code. For this, there are two related projects you can choose from: Kubebuilder and the Operator SDK. Let’s have a look at each and how <code>cnat</code> is implemented with them.<a data-primary="" data-startref="SCbusiness06" data-type="indexterm" id="idm46336857781592"/><a data-primary="" data-startref="OPsample06" data-type="indexterm" id="idm46336857780616"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubebuilder" data-type="sect1"><div class="sect1" id="kubebuilder">&#13;
<h1>Kubebuilder</h1>&#13;
&#13;
<p><a href="http://bit.ly/2I8w9mz">Kubebuilder</a>, owned<a data-primary="operators" data-secondary="implementing with Kubebuilder" data-type="indexterm" id="Okub06"/><a data-primary="Kubebuilder" data-secondary="additional resources" data-type="indexterm" id="idm46336857776184"/> and maintained by the Kubernetes Special Interest Group (SIG) API Machinery, is a tool and set of libraries enabling you to build operators in an easy and efficient manner. The best resource for a deep dive on Kubebuilder is the online <a href="https://book.kubebuilder.io">Kubebuilder book</a>, which walks you through its components and usage. We will, however, focus here on implementing our <a href="http://bit.ly/2RpHhON"><code>cnat</code></a> operator with Kubebuilder (see <a href="http://bit.ly/2Iv6pAS">the corresponding directory in our Git repository</a>).</p>&#13;
&#13;
<p>First, let’s make sure all the dependencies—that is, <a href="http://bit.ly/2x9Yrqq">dep</a>, <a href="http://bit.ly/2Y3JeCV">kustomize</a> (see <a data-type="xref" href="ch07.html#kustomize">“Kustomize”</a>), and <a href="http://bit.ly/32pQmfu">Kubebuilder itself</a>—are installed:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>dep version&#13;
dep:&#13;
 version     : v0.5.1&#13;
 build date  : 2019-03-11&#13;
 git <code class="nb">hash</code>    : faa6189&#13;
 go version  : go1.12&#13;
 go compiler : gc&#13;
 platform    : darwin/amd64&#13;
 features    : <code class="nv">ImportDuringSolve</code><code class="o">=</code><code class="nb">false</code>&#13;
&#13;
<code class="nv">$ </code>kustomize version&#13;
Version: <code class="o">{</code>KustomizeVersion:v2.0.3 GitCommit:a6f65144121d1955266b0cd836ce954c04122dc8&#13;
          BuildDate:2019-03-18T22:15:21+00:00 GoOs:darwin GoArch:amd64<code class="o">}</code>&#13;
&#13;
<code class="nv">$ </code>kubebuilder version&#13;
Version: version.Version<code class="o">{</code>&#13;
  KubeBuilderVersion:<code class="s2">"1.0.8"</code>,&#13;
  KubernetesVendor:<code class="s2">"1.13.1"</code>,&#13;
  GitCommit:<code class="s2">"1adf50ed107f5042d7472ba5ab50d5e1d357169d"</code>,&#13;
  BuildDate:<code class="s2">"2019-01-25T23:14:29Z"</code>, GoOs:<code class="s2">"unknown"</code>, GoArch:<code class="s2">"unknown"</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p>We’ll walk you through the steps for writing the <code>cnat</code> operator from scratch. First, create a directory of your choice (we use <em>cnat-kubebuilder</em> in our repo) that you’ll use as the base for all further commands.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>At<a data-primary="Kubebuilder" data-secondary="versions" data-type="indexterm" id="idm46336857744552"/> the time of this writing, Kubebuilder is moving to a new version (v2). Since it’s not stable yet, we show the commands and setup for (stable) <a href="https://book-v1.book.kubebuilder.io">version v1</a>.</p>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Bootstrapping" data-type="sect2"><div class="sect2" id="idm46336857742376">&#13;
<h2>Bootstrapping</h2>&#13;
&#13;
<p>To<a data-primary="Kubebuilder" data-secondary="bootstrapping" data-type="indexterm" id="idm46336857740296"/><a data-primary="Kubebuilder" data-secondary="commands" data-tertiary="kubebuilder init" data-type="indexterm" id="idm46336857739288"/> bootstrap the <code>cnat</code> operator, we use the <code>init</code> command like so (note that this can take several minutes, depending on your environment):</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubebuilder init <code class="se">\</code>&#13;
              --domain programming-kubernetes.info <code class="se">\</code>&#13;
              --license apache2 <code class="se">\</code>&#13;
              --owner <code class="s2">"Programming Kubernetes authors"</code>&#13;
Run <code class="sb">`</code>dep ensure<code class="sb">`</code> to fetch dependencies <code class="o">(</code>Recommended<code class="o">)</code> <code class="o">[</code>y/n<code class="o">]</code>?&#13;
y&#13;
dep ensure&#13;
Running make...&#13;
make&#13;
go generate ./pkg/... ./cmd/...&#13;
go fmt ./pkg/... ./cmd/...&#13;
go vet ./pkg/... ./cmd/...&#13;
go run vendor/sigs.k8s.io/controller-tools/cmd/controller-gen/main.go all&#13;
CRD manifests generated under <code class="s1">'config/crds'</code>&#13;
RBAC manifests generated under <code class="s1">'config/rbac'</code>&#13;
go <code class="nb">test</code> ./pkg/... ./cmd/... -coverprofile cover.out&#13;
?       github.com/mhausenblas/cnat-kubebuilder/pkg/apis        <code class="o">[</code>no <code class="nb">test </code>files<code class="o">]</code>&#13;
?       github.com/mhausenblas/cnat-kubebuilder/pkg/controller  <code class="o">[</code>no <code class="nb">test </code>files<code class="o">]</code>&#13;
?       github.com/mhausenblas/cnat-kubebuilder/pkg/webhook     <code class="o">[</code>no <code class="nb">test </code>files<code class="o">]</code>&#13;
?       github.com/mhausenblas/cnat-kubebuilder/cmd/manager     <code class="o">[</code>no <code class="nb">test </code>files<code class="o">]</code>&#13;
go build -o bin/manager github.com/mhausenblas/cnat-kubebuilder/cmd/manager</pre>&#13;
&#13;
<p>On completion of this command, Kubebuilder has scaffolded the operator, effectively generating a bunch of files, from the custom controller to a sample CRD. Your<a data-primary="Kubebuilder" data-secondary="base directory" data-type="indexterm" id="idm46336857640536"/> base directory should now look something like the following (excluding the huge <em>vendor</em> directory for clarity):</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>tree -I vendor&#13;
.&#13;
├── Dockerfile&#13;
├── Gopkg.lock&#13;
├── Gopkg.toml&#13;
├── Makefile&#13;
├── PROJECT&#13;
├── bin&#13;
│   └── manager&#13;
├── cmd&#13;
│   └── manager&#13;
│       └── main.go&#13;
├── config&#13;
│   ├── crds&#13;
│   ├── default&#13;
│   │   ├── kustomization.yaml&#13;
│   │   ├── manager_auth_proxy_patch.yaml&#13;
│   │   ├── manager_image_patch.yaml&#13;
│   │   └── manager_prometheus_metrics_patch.yaml&#13;
│   ├── manager&#13;
│   │   └── manager.yaml&#13;
│   └── rbac&#13;
│       ├── auth_proxy_role.yaml&#13;
│       ├── auth_proxy_role_binding.yaml&#13;
│       ├── auth_proxy_service.yaml&#13;
│       ├── rbac_role.yaml&#13;
│       └── rbac_role_binding.yaml&#13;
├── cover.out&#13;
├── hack&#13;
│   └── boilerplate.go.txt&#13;
└── pkg&#13;
    ├── apis&#13;
    │   └── apis.go&#13;
    ├── controller&#13;
    │   └── controller.go&#13;
    └── webhook&#13;
        └── webhook.go&#13;
&#13;
<code class="m">13</code> directories, <code class="m">22</code> files</pre>&#13;
&#13;
<p>Next, we<a data-primary="Kubebuilder" data-secondary="create api command" data-type="indexterm" id="idm46336857621304"/><a data-primary="Kubebuilder" data-secondary="commands" data-tertiary="kubebuilder create api" data-type="indexterm" id="idm46336857620456"/> create an API—that is, a custom controller—using the <code>create api</code> command (this should be faster than the previous command but still takes a little while):</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubebuilder create api <code class="se">\</code>&#13;
              --group cnat <code class="se">\</code>&#13;
              --version v1alpha1 <code class="se">\</code>&#13;
              --kind At&#13;
Create Resource under pkg/apis <code class="o">[</code>y/n<code class="o">]</code>?&#13;
y&#13;
Create Controller under pkg/controller <code class="o">[</code>y/n<code class="o">]</code>?&#13;
y&#13;
Writing scaffold <code class="k">for</code> you to edit...&#13;
pkg/apis/cnat/v1alpha1/at_types.go&#13;
pkg/apis/cnat/v1alpha1/at_types_test.go&#13;
pkg/controller/at/at_controller.go&#13;
pkg/controller/at/at_controller_test.go&#13;
Running make...&#13;
go generate ./pkg/... ./cmd/...&#13;
go fmt ./pkg/... ./cmd/...&#13;
go vet ./pkg/... ./cmd/...&#13;
go run vendor/sigs.k8s.io/controller-tools/cmd/controller-gen/main.go all&#13;
CRD manifests generated under <code class="s1">'config/crds'</code>&#13;
RBAC manifests generated under <code class="s1">'config/rbac'</code>&#13;
go <code class="nb">test</code> ./pkg/... ./cmd/... -coverprofile cover.out&#13;
?       github.com/mhausenblas/cnat-kubebuilder/pkg/apis        <code class="o">[</code>no <code class="nb">test </code>files<code class="o">]</code>&#13;
?       github.com/mhausenblas/cnat-kubebuilder/pkg/apis/cnat   <code class="o">[</code>no <code class="nb">test </code>files<code class="o">]</code>&#13;
ok      github.com/mhausenblas/cnat-kubebuilder/pkg/apis/cnat/v1alpha1  9.011s&#13;
?       github.com/mhausenblas/cnat-kubebuilder/pkg/controller  <code class="o">[</code>no <code class="nb">test </code>files<code class="o">]</code>&#13;
ok      github.com/mhausenblas/cnat-kubebuilder/pkg/controller/at       8.740s&#13;
?       github.com/mhausenblas/cnat-kubebuilder/pkg/webhook     <code class="o">[</code>no <code class="nb">test </code>files<code class="o">]</code>&#13;
?       github.com/mhausenblas/cnat-kubebuilder/cmd/manager     <code class="o">[</code>no <code class="nb">test </code>files<code class="o">]</code>&#13;
go build -o bin/manager github.com/mhausenblas/cnat-kubebuilder/cmd/manager</pre>&#13;
&#13;
<p>Let’s see what has changed, focusing on the two directories that have received updates and additions:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>tree config/ pkg/&#13;
config/&#13;
├── crds&#13;
│   └── cnat_v1alpha1_at.yaml&#13;
├── default&#13;
│   ├── kustomization.yaml&#13;
│   ├── manager_auth_proxy_patch.yaml&#13;
│   ├── manager_image_patch.yaml&#13;
│   └── manager_prometheus_metrics_patch.yaml&#13;
├── manager&#13;
│   └── manager.yaml&#13;
├── rbac&#13;
│   ├── auth_proxy_role.yaml&#13;
│   ├── auth_proxy_role_binding.yaml&#13;
│   ├── auth_proxy_service.yaml&#13;
│   ├── rbac_role.yaml&#13;
│   └── rbac_role_binding.yaml&#13;
└── samples&#13;
    └── cnat_v1alpha1_at.yaml&#13;
pkg/&#13;
├── apis&#13;
│   ├── addtoscheme_cnat_v1alpha1.go&#13;
│   ├── apis.go&#13;
│   └── cnat&#13;
│       ├── group.go&#13;
│       └── v1alpha1&#13;
│           ├── at_types.go&#13;
│           ├── at_types_test.go&#13;
│           ├── doc.go&#13;
│           ├── register.go&#13;
│           ├── v1alpha1_suite_test.go&#13;
│           └── zz_generated.deepcopy.go&#13;
├── controller&#13;
│   ├── add_at.go&#13;
│   ├── at&#13;
│   │   ├── at_controller.go&#13;
│   │   ├── at_controller_suite_test.go&#13;
│   │   └── at_controller_test.go&#13;
│   └── controller.go&#13;
└── webhook&#13;
    └── webhook.go&#13;
&#13;
<code class="m">11</code> directories, <code class="m">27</code> files</pre>&#13;
&#13;
<p>Note the addition of <em>cnat_v1alpha1_at.yaml</em> in <em>config/crds/</em>, which is the CRD, as well as <em>cnat_v1alpha1_at.yaml</em> (yes, the same name) in <em>config/samples/</em>, representing a custom resource example instance of the CRD. Further, in <em>pkg/</em> we see a number of new files, most importantly <em>apis/cnat/v1alpha1/at_types.go</em> and <em>controller/at/at_controller.go</em>, both of which we will modify next.</p>&#13;
&#13;
<p>Next, we<a data-primary="Kubebuilder" data-secondary="dedicated namespace creation" data-type="indexterm" id="idm46336857524504"/> create a dedicated namespace, <code>cnat</code>, in Kubernetes and use it as the default, setting the context as follows (as a good practice, always use a dedicated namespace, not the <code>default</code> one):</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl create ns cnat <code class="o">&amp;&amp;</code> <code class="se">\</code>&#13;
  kubectl config <code class="nb">set</code>-context <code class="k">$(</code>kubectl config current-context<code class="k">)</code> --namespace<code class="o">=</code>cnat</pre>&#13;
&#13;
<p>We<a data-primary="Kubebuilder" data-secondary="custom resource definition" data-type="indexterm" id="idm46336857533000"/> install the CRD with:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>make install&#13;
go run vendor/sigs.k8s.io/controller-tools/cmd/controller-gen/main.go all&#13;
CRD manifests generated under <code class="s1">'config/crds'</code>&#13;
RBAC manifests generated under <code class="s1">'config/rbac'</code>&#13;
kubectl apply -f config/crds&#13;
customresourcedefinition.apiextensions.k8s.io/ats.cnat.programming-kubernetes.info created</pre>&#13;
&#13;
<p>And<a data-primary="Kubebuilder" data-secondary="local operator launch" data-type="indexterm" id="idm46336857506904"/> now we can launch the operator locally:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>make run&#13;
go generate ./pkg/... ./cmd/...&#13;
go fmt ./pkg/... ./cmd/...&#13;
go vet ./pkg/... ./cmd/...&#13;
go run ./cmd/manager/main.go&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559152740.0550249,<code class="s2">"logger"</code>:<code class="s2">"entrypoint"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"setting up client for manager"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559152740.057556,<code class="s2">"logger"</code>:<code class="s2">"entrypoint"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"setting up manager"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559152740.1396701,<code class="s2">"logger"</code>:<code class="s2">"entrypoint"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Registering Components."</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559152740.1397,<code class="s2">"logger"</code>:<code class="s2">"entrypoint"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"setting up scheme"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559152740.139773,<code class="s2">"logger"</code>:<code class="s2">"entrypoint"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Setting up controller"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559152740.139831,<code class="s2">"logger"</code>:<code class="s2">"kubebuilder.controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Starting EventSource"</code>,<code class="s2">"controller"</code>:<code class="s2">"at-controller"</code>,&#13;
  <code class="s2">"source"</code>:<code class="s2">"kind source: /, Kind="</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559152740.139929,<code class="s2">"logger"</code>:<code class="s2">"kubebuilder.controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Starting EventSource"</code>,<code class="s2">"controller"</code>:<code class="s2">"at-controller"</code>,&#13;
  <code class="s2">"source"</code>:<code class="s2">"kind source: /, Kind="</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559152740.139971,<code class="s2">"logger"</code>:<code class="s2">"entrypoint"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"setting up webhooks"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559152740.13998,<code class="s2">"logger"</code>:<code class="s2">"entrypoint"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Starting the Cmd."</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559152740.244628,<code class="s2">"logger"</code>:<code class="s2">"kubebuilder.controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Starting Controller"</code>,<code class="s2">"controller"</code>:<code class="s2">"at-controller"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559152740.344791,<code class="s2">"logger"</code>:<code class="s2">"kubebuilder.controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Starting workers"</code>,<code class="s2">"controller"</code>:<code class="s2">"at-controller"</code>,<code class="s2">"worker count"</code>:1<code class="o">}</code></pre>&#13;
&#13;
<p>Leave<a data-primary="Kubebuilder" data-secondary="custom resource installation and validation" data-type="indexterm" id="idm46336857502568"/><a data-primary="kubectl apply -f" data-type="indexterm" id="idm46336857501656"/><a data-primary="kubectl get crds" data-type="indexterm" id="idm46336857501016"/> the terminal session running and, in a new session, install the CRD, validate it, and create the sample custom resource like so:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl apply -f config/crds/cnat_v1alpha1_at.yaml&#13;
customresourcedefinition.apiextensions.k8s.io/ats.cnat.programming-kubernetes.info&#13;
configured&#13;
&#13;
<code class="nv">$ </code>kubectl get crds&#13;
NAME                                   CREATED AT&#13;
ats.cnat.programming-kubernetes.info   2019-05-29T17:54:51Z&#13;
&#13;
<code class="nv">$ </code>kubectl apply -f config/samples/cnat_v1alpha1_at.yaml&#13;
at.cnat.programming-kubernetes.info/at-sample created</pre>&#13;
&#13;
<p>If you now look at the output of the session where <code>make run</code> runs, you should notice the following output:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">...&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559153311.659829,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Creating Deployment"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"name"</code>:<code class="s2">"at-sample-deployment"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559153311.678407,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Updating Deployment"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"name"</code>:<code class="s2">"at-sample-deployment"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559153311.6839428,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Updating Deployment"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"name"</code>:<code class="s2">"at-sample-deployment"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559153311.693443,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Updating Deployment"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"name"</code>:<code class="s2">"at-sample-deployment"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559153311.7023401,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Updating Deployment"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"name"</code>:<code class="s2">"at-sample-deployment"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1559153332.986961,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,#&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Updating Deployment"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"name"</code>:<code class="s2">"at-sample-deployment"</code><code class="o">}</code></pre>&#13;
&#13;
<p>This tells us that the overall setup was successful! Now that we’ve completed the scaffolding and successfully launched the <code>cnat</code> operator, we can move on to the actual core task: implementing the <code>cnat</code> business logic with Kubebuilder.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Business Logic" data-type="sect2"><div class="sect2" id="idm46336857741400">&#13;
<h2>Business Logic</h2>&#13;
&#13;
<p>For<a data-primary="Kubebuilder" data-secondary="business logic" data-type="indexterm" id="KBbusiness06"/> starters, we’ll change <a href="http://bit.ly/2N1jQNb"><em>config/crds/cnat_v1alpha1_at.yaml</em></a> and <a href="http://bit.ly/2Xs1F7c"><em>config/samples/cnat_v1alpha1_at.yaml</em></a> to our own definitions of the <code>cnat</code> CRD and custom resource values, re-using the same structures as in <a data-type="xref" href="#cnat-client-go">“Following sample-controller”</a>.</p>&#13;
&#13;
<p>In terms of the business logic, we have two parts to implement in the operator:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>In <a href="http://bit.ly/31KNLfO"><em>pkg/apis/cnat/v1alpha1/at_types.go</em></a> we modify the <code>AtSpec</code> struct to include the respective fields, such as <code>schedule</code> and <code>command</code>. Note that you must run <code>make</code> whenever you change something here in order to regenerate dependent files. Kubebuilder uses the Kubernetes generators (described in <a data-type="xref" href="ch05.html#ch_autocodegen">Chapter 5</a>) and ships its own set of generators (e.g., to generate the CRD manifest).</p>&#13;
</li>&#13;
<li>&#13;
<p>In <a href="http://bit.ly/2Iwormg"><em>pkg/controller/at/at_controller.go</em></a> we modify the <code>Reconcile(request reconcile.Request)</code> method to create a pod at the time defined in <code>Spec.Schedule</code>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In <em>at_types.go</em>:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">const</code> <code class="p">(</code>&#13;
    <code class="nx">PhasePending</code> <code class="p">=</code> <code class="s">"PENDING"</code>&#13;
    <code class="nx">PhaseRunning</code> <code class="p">=</code> <code class="s">"RUNNING"</code>&#13;
    <code class="nx">PhaseDone</code>    <code class="p">=</code> <code class="s">"DONE"</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="c1">// AtSpec defines the desired state of At</code>&#13;
<code class="kd">type</code> <code class="nx">AtSpec</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="c1">// Schedule is the desired time the command is supposed to be executed.</code>&#13;
    <code class="c1">// Note: the format used here is UTC time https://www.utctime.net</code>&#13;
    <code class="nx">Schedule</code> <code class="kt">string</code> <code class="s">`json:"schedule,omitempty"`</code>&#13;
    <code class="c1">// Command is the desired command (executed in a Bash shell) to be executed.</code>&#13;
    <code class="nx">Command</code> <code class="kt">string</code> <code class="s">`json:"command,omitempty"`</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// AtStatus defines the observed state of At</code>&#13;
<code class="kd">type</code> <code class="nx">AtStatus</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="c1">// Phase represents the state of the schedule: until the command is executed</code>&#13;
    <code class="c1">// it is PENDING, afterwards it is DONE.</code>&#13;
    <code class="nx">Phase</code> <code class="kt">string</code> <code class="s">`json:"phase,omitempty"`</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In <em>at_controller.go</em> we implement the state transition between the three phases, <code>PENDING</code> to <code>RUNNING</code> to <code>DONE</code>:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code> <code class="p">(</code><code class="nx">r</code> <code class="o">*</code><code class="nx">ReconcileAt</code><code class="p">)</code> <code class="nx">Reconcile</code><code class="p">(</code><code class="nx">req</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code> <code class="p">(</code><code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">reqLogger</code> <code class="o">:=</code> <code class="nx">log</code><code class="p">.</code><code class="nx">WithValues</code><code class="p">(</code><code class="s">"namespace"</code><code class="p">,</code> <code class="nx">req</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">,</code> <code class="s">"at"</code><code class="p">,</code> <code class="nx">req</code><code class="p">.</code><code class="nx">Name</code><code class="p">)</code>&#13;
    <code class="nx">reqLogger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"=== Reconciling At"</code><code class="p">)</code>&#13;
    <code class="c1">// Fetch the At instance</code>&#13;
    <code class="nx">instance</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">At</code><code class="p">{}</code>&#13;
    <code class="nx">err</code> <code class="o">:=</code> <code class="nx">r</code><code class="p">.</code><code class="nx">Get</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">TODO</code><code class="p">(),</code> <code class="nx">req</code><code class="p">.</code><code class="nx">NamespacedName</code><code class="p">,</code> <code class="nx">instance</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="k">if</code> <code class="nx">errors</code><code class="p">.</code><code class="nx">IsNotFound</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="c1">// Request object not found, could have been deleted after</code>&#13;
            <code class="c1">// reconcile request—return and don't requeue:</code>&#13;
            <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="kc">nil</code>&#13;
        <code class="p">}</code>&#13;
            <code class="c1">// Error reading the object—requeue the request:</code>&#13;
        <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="nx">err</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// If no phase set, default to pending (the initial phase):</code>&#13;
    <code class="k">if</code> <code class="nx">instance</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="o">==</code> <code class="s">""</code> <code class="p">{</code>&#13;
        <code class="nx">instance</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="p">=</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhasePending</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// Now let's make the main case distinction: implementing</code>&#13;
    <code class="c1">// the state diagram PENDING -&gt; RUNNING -&gt; DONE</code>&#13;
    <code class="k">switch</code> <code class="nx">instance</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="p">{</code>&#13;
    <code class="k">case</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhasePending</code><code class="p">:</code>&#13;
        <code class="nx">reqLogger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"Phase: PENDING"</code><code class="p">)</code>&#13;
        <code class="c1">// As long as we haven't executed the command yet, we need to check if</code>&#13;
        <code class="c1">// it's already time to act:</code>&#13;
        <code class="nx">reqLogger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"Checking schedule"</code><code class="p">,</code> <code class="s">"Target"</code><code class="p">,</code> <code class="nx">instance</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Schedule</code><code class="p">)</code>&#13;
        <code class="c1">// Check if it's already time to execute the command with a tolerance</code>&#13;
        <code class="c1">// of 2 seconds:</code>&#13;
        <code class="nx">d</code><code class="p">,</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">timeUntilSchedule</code><code class="p">(</code><code class="nx">instance</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Schedule</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="nx">reqLogger</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="s">"Schedule parsing failure"</code><code class="p">)</code>&#13;
            <code class="c1">// Error reading the schedule. Wait until it is fixed.</code>&#13;
            <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="nx">err</code>&#13;
        <code class="p">}</code>&#13;
        <code class="nx">reqLogger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"Schedule parsing done"</code><code class="p">,</code> <code class="s">"Result"</code><code class="p">,</code> <code class="s">"diff"</code><code class="p">,</code>&#13;
            <code class="nx">fmt</code><code class="p">.</code><code class="nx">Sprintf</code><code class="p">(</code><code class="s">"%v"</code><code class="p">,</code> <code class="nx">d</code><code class="p">))</code>&#13;
        <code class="k">if</code> <code class="nx">d</code> <code class="p">&gt;</code> <code class="mi">0</code> <code class="p">{</code>&#13;
            <code class="c1">// Not yet time to execute the command, wait until the scheduled time</code>&#13;
            <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="nx">RequeueAfter</code><code class="p">:</code> <code class="nx">d</code><code class="p">},</code> <code class="kc">nil</code>&#13;
        <code class="p">}</code>&#13;
        <code class="nx">reqLogger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"It's time!"</code><code class="p">,</code> <code class="s">"Ready to execute"</code><code class="p">,</code> <code class="nx">instance</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Command</code><code class="p">)</code>&#13;
        <code class="nx">instance</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="p">=</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhaseRunning</code>&#13;
    <code class="k">case</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhaseRunning</code><code class="p">:</code>&#13;
        <code class="nx">reqLogger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"Phase: RUNNING"</code><code class="p">)</code>&#13;
        <code class="nx">pod</code> <code class="o">:=</code> <code class="nx">newPodForCR</code><code class="p">(</code><code class="nx">instance</code><code class="p">)</code>&#13;
        <code class="c1">// Set At instance as the owner and controller</code>&#13;
        <code class="nx">err</code> <code class="o">:=</code> <code class="nx">controllerutil</code><code class="p">.</code><code class="nx">SetControllerReference</code><code class="p">(</code><code class="nx">instance</code><code class="p">,</code> <code class="nx">pod</code><code class="p">,</code> <code class="nx">r</code><code class="p">.</code><code class="nx">scheme</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="c1">// requeue with error</code>&#13;
            <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="nx">err</code>&#13;
        <code class="p">}</code>&#13;
        <code class="nx">found</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">Pod</code><code class="p">{}</code>&#13;
        <code class="nx">nsName</code> <code class="o">:=</code> <code class="nx">types</code><code class="p">.</code><code class="nx">NamespacedName</code><code class="p">{</code><code class="nx">Name</code><code class="p">:</code> <code class="nx">pod</code><code class="p">.</code><code class="nx">Name</code><code class="p">,</code> <code class="nx">Namespace</code><code class="p">:</code> <code class="nx">pod</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">}</code>&#13;
        <code class="nx">err</code> <code class="p">=</code> <code class="nx">r</code><code class="p">.</code><code class="nx">Get</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">TODO</code><code class="p">(),</code> <code class="nx">nsName</code><code class="p">,</code> <code class="nx">found</code><code class="p">)</code>&#13;
        <code class="c1">// Try to see if the pod already exists and if not</code>&#13;
        <code class="c1">// (which we expect) then create a one-shot pod as per spec:</code>&#13;
        <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="o">&amp;&amp;</code> <code class="nx">errors</code><code class="p">.</code><code class="nx">IsNotFound</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="nx">err</code> <code class="p">=</code> <code class="nx">r</code><code class="p">.</code><code class="nx">Create</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">TODO</code><code class="p">(),</code> <code class="nx">pod</code><code class="p">)</code>&#13;
            <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="c1">// requeue with error</code>&#13;
                <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="nx">err</code>&#13;
            <code class="p">}</code>&#13;
            <code class="nx">reqLogger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"Pod launched"</code><code class="p">,</code> <code class="s">"name"</code><code class="p">,</code> <code class="nx">pod</code><code class="p">.</code><code class="nx">Name</code><code class="p">)</code>&#13;
        <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
            <code class="c1">// requeue with error</code>&#13;
            <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="nx">err</code>&#13;
        <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="nx">found</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="o">==</code> <code class="nx">corev1</code><code class="p">.</code><code class="nx">PodFailed</code> <code class="o">||</code>&#13;
                  <code class="nx">found</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="o">==</code> <code class="nx">corev1</code><code class="p">.</code><code class="nx">PodSucceeded</code> <code class="p">{</code>&#13;
            <code class="nx">reqLogger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"Container terminated"</code><code class="p">,</code> <code class="s">"reason"</code><code class="p">,</code>&#13;
                <code class="nx">found</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Reason</code><code class="p">,</code> <code class="s">"message"</code><code class="p">,</code> <code class="nx">found</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Message</code><code class="p">)</code>&#13;
            <code class="nx">instance</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="p">=</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhaseDone</code>&#13;
        <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
            <code class="c1">// Don't requeue because it will happen automatically when the</code>&#13;
            <code class="c1">// pod status changes.</code>&#13;
            <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="kc">nil</code>&#13;
        <code class="p">}</code>&#13;
    <code class="k">case</code> <code class="nx">cnatv1alpha1</code><code class="p">.</code><code class="nx">PhaseDone</code><code class="p">:</code>&#13;
        <code class="nx">reqLogger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"Phase: DONE"</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="kc">nil</code>&#13;
    <code class="k">default</code><code class="p">:</code>&#13;
        <code class="nx">reqLogger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"NOP"</code><code class="p">)</code>&#13;
        <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="kc">nil</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// Update the At instance, setting the status to the respective phase:</code>&#13;
    <code class="nx">err</code> <code class="p">=</code> <code class="nx">r</code><code class="p">.</code><code class="nx">Status</code><code class="p">().</code><code class="nx">Update</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">TODO</code><code class="p">(),</code> <code class="nx">instance</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="nx">err</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// Don't requeue. We should be reconcile because either the pod</code>&#13;
    <code class="c1">// or the CR changes.</code>&#13;
    <code class="k">return</code> <code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="kc">nil</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Note here that the <code>Update</code> call at the end operates on the <em>/status</em> subresource (see <a data-type="xref" href="ch04.html#status-subresource">“Status subresource”</a>) instead of the whole CR. Hence, here we follow the best practice of a spec-status split.</p>&#13;
&#13;
<p>Now, once the CR <code>example-at</code> is created, we see the following output of the locally executed operator:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>make run&#13;
...&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063897.488535,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063897.488621,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: PENDING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063897.4886441,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Checking schedule"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Target"</code>:<code class="s2">"2019-04-12T10:12:00Z"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063897.488703,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Schedule parsing done"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Result"</code>:<code class="s2">"2019-04-12 10:12:00 +0000 UTC with a diff of 22.511336s"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063907.489264,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063907.489402,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: PENDING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063907.489428,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Checking schedule"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Target"</code>:<code class="s2">"2019-04-12T10:12:00Z"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063907.489486,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Schedule parsing done"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Result"</code>:<code class="s2">"2019-04-12 10:12:00 +0000 UTC with a diff of 12.510551s"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063917.490178,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063917.4902349,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: PENDING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063917.490247,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Checking schedule"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Target"</code>:<code class="s2">"2019-04-12T10:12:00Z"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063917.490278,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Schedule parsing done"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Result"</code>:<code class="s2">"2019-04-12 10:12:00 +0000 UTC with a diff of 2.509743s"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063927.492718,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063927.49283,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: PENDING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063927.492857,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Checking schedule"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Target"</code>:<code class="s2">"2019-04-12T10:12:00Z"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063927.492915,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Schedule parsing done"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Result"</code>:<code class="s2">"2019-04-12 10:12:00 +0000 UTC with a diff of -7.492877s"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063927.4929411,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"It's time!"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:&#13;
  <code class="s2">"example-at"</code>,<code class="s2">"Ready to execute"</code>:<code class="s2">"echo YAY"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063927.626236,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063927.626303,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: RUNNING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063928.07445,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Pod launched"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"name"</code>:<code class="s2">"example-at-pod"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063928.199562,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063928.199645,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: DONE"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063937.631733,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555063937.631783,<code class="s2">"logger"</code>:<code class="s2">"controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: DONE"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
...</pre>&#13;
&#13;
<p>To<a data-primary="kubectl get at,pods" data-type="indexterm" id="idm46336856482424"/> verify whether our custom controller has done its job, execute:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl get at,pods&#13;
NAME                                                  AGE&#13;
at.cnat.programming-kubernetes.info/example-at        11m&#13;
&#13;
NAME                 READY   STATUS        RESTARTS   AGE&#13;
pod/example-at-pod   0/1     Completed     <code class="m">0</code>          38s</pre>&#13;
&#13;
<p>Great! The <code>example-at-pod</code> has<a data-primary="kubectl logs example-at-pod" data-type="indexterm" id="idm46336855634104"/> been created, and now it’s time to see the result of the operation:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl logs example-at-pod&#13;
YAY</pre>&#13;
&#13;
<p>When you’re done developing the custom controller, using local mode as shown here, you’ll likely want to build a container image out of it. This custom controller container image can subsequently be used, for example, in a Kubernetes deployment. You can use the following command to generate the container image and push it into the repo <em>quay.io/pk/cnat</em>:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code><code class="nb">export </code><code class="nv">IMG</code><code class="o">=</code>quay.io/pk/cnat:v1&#13;
&#13;
<code class="nv">$ </code>make docker-build&#13;
&#13;
<code class="nv">$ </code>make docker-push</pre>&#13;
&#13;
<p>With this we move on to the Operator SDK, which shares some of Kubebuilder’s code base and APIs.<a data-primary="" data-startref="KBbusiness06" data-type="indexterm" id="idm46336855643544"/><a data-primary="" data-startref="Okub06" data-type="indexterm" id="idm46336855642696"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Operator SDK" data-type="sect1"><div class="sect1" id="operator-sdk">&#13;
<h1>The Operator SDK</h1>&#13;
&#13;
<p>To<a data-primary="operators" data-secondary="building with Operator SDK" data-type="indexterm" id="OPsdk06"/><a data-primary="Operator SDK" data-secondary="installing" data-type="indexterm" id="idm46336855651144"/> make it easier to build Kubernetes applications, CoreOS/Red Hat has put together the Operator Framework. Part of that is the <a href="http://bit.ly/2KtpK7D">Operator SDK</a>, which enables developers to build operators without requiring deep knowledge of Kubernetes APIs.</p>&#13;
&#13;
<p>The Operator SDK provides the tools to build, test, and package operators. While there is much more functionality available in the SDK, especially around testing, we focus here on implementing our <a href="http://bit.ly/2RpHhON"><code>cnat</code></a> operator with the SDK (see <a href="http://bit.ly/2FpCtE9">the corresponding directory in our Git repository</a>).</p>&#13;
&#13;
<p>First things first: make sure to <a href="http://bit.ly/2ZBQlCT">install the Operator SDK</a> and check if all dependencies are available:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>dep version&#13;
dep:&#13;
 version     : v0.5.1&#13;
 build date  : 2019-03-11&#13;
 git <code class="nb">hash</code>    : faa6189&#13;
 go version  : go1.12&#13;
 go compiler : gc&#13;
 platform    : darwin/amd64&#13;
 features    : <code class="nv">ImportDuringSolve</code><code class="o">=</code><code class="nb">false</code>&#13;
&#13;
 <code class="nv">$ </code>operator-sdk --version&#13;
operator-sdk version v0.6.0</pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Bootstrapping" data-type="sect2"><div class="sect2" id="idm46336855593720">&#13;
<h2>Bootstrapping</h2>&#13;
&#13;
<p>Now<a data-primary="Operator SDK" data-secondary="bootstrapping" data-type="indexterm" id="idm46336855592152"/> it’s time to bootstrap the <code>cnat</code> operator as follows:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>operator-sdk new cnat-operator <code class="o">&amp;&amp;</code> <code class="nb">cd </code>cnat-operator</pre>&#13;
&#13;
<p>Next, and very similar to Kubebuilder, we add an API—or simply put: initialize the custom controller like so:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>operator-sdk add api <code class="se">\</code>&#13;
               --api-version<code class="o">=</code>cnat.programming-kubernetes.info/v1alpha1 <code class="se">\</code>&#13;
               --kind<code class="o">=</code>At&#13;
&#13;
<code class="nv">$ </code>operator-sdk add controller <code class="se">\</code>&#13;
               --api-version<code class="o">=</code>cnat.programming-kubernetes.info/v1alpha1 <code class="se">\</code>&#13;
               --kind<code class="o">=</code>At</pre>&#13;
&#13;
<p>These commands generate the necessary boilerplate code as well as a number of helper functions, such as the deep-copy functions <code>DeepCopy()</code>, <code>DeepCopyInto()</code>, and <code>DeepCopyObject()</code>.</p>&#13;
&#13;
<p>Now<a data-primary="kubectl apply -f" data-type="indexterm" id="idm46336856311544"/><a data-primary="kubectl get crds" data-type="indexterm" id="idm46336856310808"/> we’re in a position to apply the autogenerated CRD to the Kubernetes cluster:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl apply -f deploy/crds/cnat_v1alpha1_at_crd.yaml&#13;
&#13;
<code class="nv">$ </code>kubectl get crds&#13;
NAME                                             CREATED AT&#13;
ats.cnat.programming-kubernetes.info             2019-04-01T14:03:33Z</pre>&#13;
&#13;
<p>Let’s launch our <code>cnat</code> custom controller locally. With this, it can start processing requests:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ OPERATOR_NAME</code><code class="o">=</code>cnatop operator-sdk up <code class="nb">local</code> --namespace <code class="s2">"cnat"</code>&#13;
INFO<code class="o">[</code>0000<code class="o">]</code> Running the operator locally.&#13;
INFO<code class="o">[</code>0000<code class="o">]</code> Using namespace cnat.&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041531.871706,<code class="s2">"logger"</code>:<code class="s2">"cmd"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Go Version: go1.12.1"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041531.871785,<code class="s2">"logger"</code>:<code class="s2">"cmd"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Go OS/Arch: darwin/amd64"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041531.8718028,<code class="s2">"logger"</code>:<code class="s2">"cmd"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Version of operator-sdk: v0.6.0"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041531.8739321,<code class="s2">"logger"</code>:<code class="s2">"leader"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Trying to become the leader."</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041531.8743382,<code class="s2">"logger"</code>:<code class="s2">"leader"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Skipping leader election; not running in a cluster."</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041536.1611362,<code class="s2">"logger"</code>:<code class="s2">"cmd"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Registering Components."</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041536.1622112,<code class="s2">"logger"</code>:<code class="s2">"kubebuilder.controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Starting EventSource"</code>,<code class="s2">"controller"</code>:<code class="s2">"at-controller"</code>,&#13;
  <code class="s2">"source"</code>:<code class="s2">"kind source: /, Kind="</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041536.162519,<code class="s2">"logger"</code>:<code class="s2">"kubebuilder.controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Starting EventSource"</code>,<code class="s2">"controller"</code>:<code class="s2">"at-controller"</code>,&#13;
  <code class="s2">"source"</code>:<code class="s2">"kind source: /, Kind="</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041539.978822,<code class="s2">"logger"</code>:<code class="s2">"metrics"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Skipping metrics Service creation; not running in a cluster."</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041539.978875,<code class="s2">"logger"</code>:<code class="s2">"cmd"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Starting the Cmd."</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041540.179469,<code class="s2">"logger"</code>:<code class="s2">"kubebuilder.controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Starting Controller"</code>,<code class="s2">"controller"</code>:<code class="s2">"at-controller"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555041540.280784,<code class="s2">"logger"</code>:<code class="s2">"kubebuilder.controller"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Starting workers"</code>,<code class="s2">"controller"</code>:<code class="s2">"at-controller"</code>,<code class="s2">"worker count"</code>:1<code class="o">}</code></pre>&#13;
&#13;
<p>Our custom controller will remain in this state until we create a CR, <em>ats.cnat.programming-kubernetes.info</em>. So let’s do that:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>cat deploy/crds/cnat_v1alpha1_at_cr.yaml&#13;
apiVersion: cnat.programming-kubernetes.info/v1alpha1&#13;
kind: At&#13;
metadata:&#13;
  name: example-at&#13;
spec:&#13;
  schedule: <code class="s2">"2019-04-11T14:56:30Z"</code>&#13;
  <code class="nb">command</code>: <code class="s2">"echo YAY"</code>&#13;
&#13;
<code class="nv">$ </code>kubectl apply -f deploy/crds/cnat_v1alpha1_at_cr.yaml&#13;
&#13;
<code class="nv">$ </code>kubectl get at&#13;
NAME                                             AGE&#13;
at.cnat.programming-kubernetes.info/example-at   54s</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Business Logic" data-type="sect2"><div class="sect2" id="idm46336855593256">&#13;
<h2>Business Logic</h2>&#13;
&#13;
<p>In<a data-primary="Operator SDK" data-secondary="business logic" data-type="indexterm" id="idm46336855401544"/> terms of the business logic, we have two parts to implement in the operator:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>In <a href="http://bit.ly/31Ip2sF"><em>pkg/apis/cnat/v1alpha1/at_types.go</em></a> we modify the <code>AtSpec</code> struct to include the respective fields, such as <code>schedule</code> and <code>command</code>, and use <code>operator-sdk generate k8s</code> to regenerate code, as well as using the <code>operator-sdk generate openapi</code> command for the OpenAPI bits.</p>&#13;
</li>&#13;
<li>&#13;
<p>In <a href="http://bit.ly/2Fpo5Mi"><em>pkg/controller/at/at_controller.go</em></a> we modify the <code>Reconcile(request reconcile.Request)</code> method to create a pod at the time defined in <code>Spec.Schedule</code>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The changes applied to the bootstrapped code in greater detail are as follows (focusing on the relevant bits). In <em>at_types.go</em>:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// AtSpec defines the desired state of At</code>&#13;
<code class="c1">// +k8s:openapi-gen=true</code>&#13;
<code class="kd">type</code> <code class="nx">AtSpec</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="c1">// Schedule is the desired time the command is supposed to be executed.</code>&#13;
    <code class="c1">// Note: the format used here is UTC time https://www.utctime.net</code>&#13;
    <code class="nx">Schedule</code> <code class="kt">string</code> <code class="s">`json:"schedule,omitempty"`</code>&#13;
    <code class="c1">// Command is the desired command (executed in a Bash shell) to be executed.</code>&#13;
    <code class="nx">Command</code> <code class="kt">string</code> <code class="s">`json:"command,omitempty"`</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// AtStatus defines the observed state of At</code>&#13;
<code class="c1">// +k8s:openapi-gen=true</code>&#13;
<code class="kd">type</code> <code class="nx">AtStatus</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
    <code class="c1">// Phase represents the state of the schedule: until the command is executed</code>&#13;
    <code class="c1">// it is PENDING, afterwards it is DONE.</code>&#13;
    <code class="nx">Phase</code> <code class="kt">string</code> <code class="s">`json:"phase,omitempty"`</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In <em>at_controller.go</em> we implement the state diagram for the three phases, <code>PENDING</code> to <code>RUNNING</code> to <code>DONE</code>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The <a href="http://bit.ly/2ZFtDKd"><code>controller-runtime</code></a> is another SIG API Machinery–owned project, aimed at providing a common set of low-level functionality for building controllers in the form of Go packages. See <a data-type="xref" href="ch04.html#ch_crds">Chapter 4</a> for more details.</p>&#13;
</div>&#13;
&#13;
<p>As both Kubebuilder and the Operator SDK share the controller runtime, the <code>Reconcile()</code> function is in fact the same:</p>&#13;
<pre data-code-language="go" data-type="programlisting">&#13;
<code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">r</code><code> </code><code class="o">*</code><code class="nx">ReconcileAt</code><code class="p">)</code><code> </code><code class="nx">Reconcile</code><code class="p">(</code><code class="nx">request</code><code> </code><code class="nx">reconcile</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code><code> </code><code class="p">(</code><code class="nx">reconcile</code><code class="p">.</code><code class="nx">Result</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>    </code><em><code class="nx">the</code><code class="o">-</code><code class="nx">same</code><code class="o">-</code><code class="nx">as</code><code class="o">-</code><code class="k">for</code><code class="o">-</code><code class="nx">kubebuilder</code></em><code>&#13;
</code><code class="p">}</code><code>&#13;
</code></pre>&#13;
&#13;
<p>Once the CR <code>example-at</code> is created, we see the following output of the locally executed operator:</p>&#13;
&#13;
<pre class="small" data-code-language="bash" data-type="programlisting"><code class="nv">$ OPERATOR_NAME</code><code class="o">=</code>cnatop operator-sdk up <code class="nb">local</code> --namespace <code class="s2">"cnat"</code>&#13;
INFO<code class="o">[</code>0000<code class="o">]</code> Running the operator locally.&#13;
INFO<code class="o">[</code>0000<code class="o">]</code> Using namespace cnat.&#13;
...&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044934.023597,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044934.023713,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: PENDING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044934.0237482,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Checking schedule"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:&#13;
  <code class="s2">"example-at"</code>,<code class="s2">"Target"</code>:<code class="s2">"2019-04-12T04:56:00Z"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044934.02382,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Schedule parsing done"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Result"</code>:<code class="s2">"2019-04-12 04:56:00 +0000 UTC with a diff of 25.976236s"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044934.148148,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044934.148224,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: PENDING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044934.148243,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Checking schedule"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Target"</code>:<code class="s2">"2019-04-12T04:56:00Z"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044934.1482902,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Schedule parsing done"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Result"</code>:<code class="s2">"2019-04-12 04:56:00 +0000 UTC with a diff of 25.85174s"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044944.1504588,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044944.150568,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: PENDING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044944.150599,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Checking schedule"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Target"</code>:<code class="s2">"2019-04-12T04:56:00Z"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044944.150663,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Schedule parsing done"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Result"</code>:<code class="s2">"2019-04-12 04:56:00 +0000 UTC with a diff of 15.84938s"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044954.385175,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044954.3852649,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: PENDING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044954.385288,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Checking schedule"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Target"</code>:<code class="s2">"2019-04-12T04:56:00Z"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044954.38534,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Schedule parsing done"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Result"</code>:<code class="s2">"2019-04-12 04:56:00 +0000 UTC with a diff of 5.614691s"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044964.518383,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044964.5184839,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: PENDING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044964.518566,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Checking schedule"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Target"</code>:<code class="s2">"2019-04-12T04:56:00Z"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044964.5186381,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Schedule parsing done"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Result"</code>:<code class="s2">"2019-04-12 04:56:00 +0000 UTC with a diff of -4.518596s"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044964.5186849,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"It's time!"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code>,&#13;
  <code class="s2">"Ready to execute"</code>:<code class="s2">"echo YAY"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044964.642559,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044964.642622,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: RUNNING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044964.911037,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044964.9111192,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: RUNNING"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044966.038684,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044966.038771,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: DONE"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044966.708663,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"=== Reconciling At"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
<code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1555044966.708749,<code class="s2">"logger"</code>:<code class="s2">"controller_at"</code>,&#13;
  <code class="s2">"msg"</code>:<code class="s2">"Phase: DONE"</code>,<code class="s2">"namespace"</code>:<code class="s2">"cnat"</code>,<code class="s2">"at"</code>:<code class="s2">"example-at"</code><code class="o">}</code>&#13;
...</pre>&#13;
&#13;
<p>Here you can see the three phases of our operator: <code>PENDING</code> until timestamp <code>1555044964.518566</code>, then <code>RUNNING</code>, then <code>DONE</code>.</p>&#13;
&#13;
<p>To validate the function of our custom controller and check the result of the operation, enter:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>kubectl get at,pods&#13;
NAME                                                  AGE&#13;
at.cnat.programming-kubernetes.info/example-at        23m&#13;
&#13;
NAME                 READY   STATUS        RESTARTS   AGE&#13;
pod/example-at-pod   0/1     Completed     <code class="m">0</code>          46s&#13;
&#13;
<code class="nv">$ </code>kubectl logs example-at-pod&#13;
YAY</pre>&#13;
&#13;
<p>When you’re done developing the custom controller, using local mode as shown here, you’ll likely want to build a container image out of it. This custom controller container image can subsequently be used, for example, in a Kubernetes deployment. You can use the following command to generate the container image:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>operator-sdk build <code class="nv">$REGISTRY</code>/PROJECT/IMAGE</pre>&#13;
&#13;
<p>Here<a data-primary="Operator SDK" data-secondary="additional resources" data-type="indexterm" id="idm46336854890280"/> are some further resources to learn more about the Operator SDK and examples around it:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="http://bit.ly/2RqkGSf">“A Complete Guide to Kubernetes Operator SDK”</a> by Toader Sebastian on <span class="keep-together">BanzaiCloud</span></p>&#13;
</li>&#13;
<li>&#13;
<p>Rob Szumski’s blog post <a href="http://bit.ly/2KvgHmu">“Building a Kubernetes Operator for Prometheus and Thanos”</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="http://bit.ly/31P7rPC">“Kubernetes Operator Development Guidelines for Improved Usability”</a> from CloudARK on ITNEXT</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>To wrap up this chapter, let’s look at some alternative ways to write custom controllers and operators.<a data-primary="" data-startref="OPsdk06" data-type="indexterm" id="idm46336855185112"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other Approaches" data-type="sect1"><div class="sect1" id="other-operator-approaches">&#13;
<h1>Other Approaches</h1>&#13;
&#13;
<p>In<a data-primary="operators" data-secondary="other approaches to writing" data-type="indexterm" id="idm46336854851944"/> addition to, or potentially in combination with, the approaches we’ve discussed, you might want to have a look at the following projects, libraries, and tools:</p>&#13;
<dl>&#13;
<dt><a href="https://metacontroller.app">Metacontroller</a></dt>&#13;
<dd>&#13;
<p>The<a data-primary="Metacontroller" data-type="indexterm" id="idm46336854848440"/> basic idea of Metacontroller is to provide you with a declarative specification of the state and changes, interfacing with JSON, based on a level-triggered reconciliation loop. That is, you receive JSON describing the observed state and return JSON describing your desired state. This is especially useful for rapid development of automation in dynamic scripting languages like Python or JavaScript. In addition to simple controllers, Metacontroller allows you to compose APIs into higher-level abstractions—for example, <a href="http://bit.ly/31KNTfi">BlueGreenDeployment</a>.</p>&#13;
</dd>&#13;
<dt><a href="https://kudo.dev">KUDO</a></dt>&#13;
<dd>&#13;
<p>Similar<a data-primary="KUDO" data-type="indexterm" id="idm46336854883128"/> to Metacontroller, KUDO provides a declarative approach to building Kubernetes operators, covering the entire application lifecycle. In a nutshell, it’s Mesosphere’s experience from Apache Mesos frameworks, ported to Kubernetes. KUDO is highly opinionated but also easy to use and requires little to no coding; essentially, all you have to specify is a collection of Kubernetes manifests with a built-in logic to define what is executed when.</p>&#13;
</dd>&#13;
<dt><a href="http://bit.ly/2J34faw">Rook operator kit</a></dt>&#13;
<dd>&#13;
<p>This<a data-primary="Rook operator kit" data-type="indexterm" id="idm46336854880120"/> is a common library for implementing operators. It originated from the Rook operator but has been spun out into a separate, independent project.</p>&#13;
</dd>&#13;
<dt><a href="http://bit.ly/2ZHc5h0">ericchiang/k8s</a></dt>&#13;
<dd>&#13;
<p>This<a data-primary="Chang, Eric" data-type="indexterm" id="idm46336854877416"/> is a slimmed-down Go client by Eric  Chiang generated using the Kubernetes protocol buffer support. It behaves similarly to the official Kubernetes <code>client-go</code>, but imports only two external dependencies. While it comes with certain limitations—for example, in terms of <a href="http://bit.ly/2ZBQIxh">cluster access configuration</a>—it is a simple-to-use Go package.</p>&#13;
</dd>&#13;
<dt><a href="http://bit.ly/2Fq3ojh"><code>kutil</code></a></dt>&#13;
<dd>&#13;
<p>AppsCode<a data-primary="kutil" data-type="indexterm" id="idm46336854828216"/> provides Kubernetes <code>client-go</code> add-ons via <code>kutil</code>.</p>&#13;
</dd>&#13;
<dt>CLI-client-based approaches</dt>&#13;
<dd>&#13;
<p>A<a data-primary="CLI-client based operator creation" data-type="indexterm" id="idm46336854825176"/><a data-primary="kubecuddler" data-type="indexterm" id="idm46336854824376"/> client-side approach, mainly for experimentation and testing, is to leverage <code>kubectl</code> programmatically (e.g., the <a href="http://bit.ly/2L3CDoi">kubecuddler</a> library).</p>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>While we focus on writing operators using the Go programming language in this book, you can write operators in other languages. Two<a data-primary="Flant’s Shell operator" data-type="indexterm" id="idm46336854821416"/><a data-primary="Zalando’s Kopf" data-type="indexterm" id="idm46336854820696"/> notable examples are Flant’s <a href="http://bit.ly/2ZxkZ0m">Shell-operator</a>, which enables you to write operators in good old shell scripts, and Zalando’s <a href="http://bit.ly/2WRXU6Q">Kopf (Kubernetes operators framework)</a>, a Python framework and a library.</p>&#13;
</div>&#13;
&#13;
<p>As mentioned at the beginning of this chapter, the operator field is rapidly evolving, and more and more practitioners are sharing their knowledge in the form of code and best practices, so keep an eye on new tooling here. Make sure to check out online resources and forums, such as the <code>#kubernetes-operators</code>, <code>#kubebuilder</code>, and <code>#client-go-docs</code> channels on the Kubernetes Slack, to learn about new approaches and/or discuss issues and receive help when you’re stuck.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Uptake and Future Directions" data-type="sect1"><div class="sect1" id="idm46336854816056">&#13;
<h1>Uptake and Future Directions</h1>&#13;
&#13;
<p>The jury is still out on which of the approaches to write operators will be the most popular and widely used. In the context of the Kubernetes project, there are activities in several SIGs when it comes to CRs and controllers. The main stakeholder is the SIG <a href="http://bit.ly/2RuTPEp">API Machinery</a>, which owns CRs and controllers and is responsible for the <a href="http://bit.ly/2I8w9mz">Kubebuilder</a> project. The Operator SDK has increased its efforts to align with the Kubebuilder API, so there’s a lot of overlap.<a data-primary="" data-startref="COcustom06" data-type="indexterm" id="idm46336854813048"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm46336854811816">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>In this chapter we had a look at different tools allowing you to write custom controllers and operators more efficiently. Traditionally, following the <code>sample-controller</code> was the only option out there, but with Kubebuilder and the Operator SDK you now have two options that allow you to focus on the business logic of your custom controller rather than dealing with boilerplate. And luckily these two tools share a lot of APIs and code, so moving from one to the other should not be too difficult.</p>&#13;
&#13;
<p>Now, let’s see how to deliver the results of our labor—that is, how to package and ship the controllers we’ve been writing.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm46336858995208"><sup><a href="ch06.html#idm46336858995208-marker">1</a></sup> We’re only showing the relevant sections here; the function itself has a lot of other boilerplate code we’re not concerned with for our purposes.</p></div></div></section></body></html>