<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 12. Consuming Falco Events"><div class="chapter" id="consuming_falco_events">
<h1><span class="label">Chapter 12. </span>Consuming Falco Events</h1>
<p><a contenteditable="false" data-primary="consuming Falco events" data-type="indexterm" id="ch12.html0"/><a contenteditable="false" data-primary="events" data-secondary="consuming" data-type="indexterm" id="ch12.html1"/>At this point, you’ve learned how to run and configure Falco. You understand how Falco can be used for runtime and cloud security and how it can detect a vast spectrum of threats. Now, it’s time to focus on what you can do with Falco’s detections. Consuming Falco’s output is the final piece of the puzzle and the subject of this chapter.</p>
<p>Alerts generated by Falco are helpful for observing and securing your production system, and we will give you some advice on how to use those alerts proficiently. The first part of the chapter is about tools that help you consume Falco’s outputs effectively. We will teach you how to get notified immediately when Falco detects a security threat, so your security team can react as soon as possible and take appropriate countermeasures. Finally, we’ll show you a mechanism for automatically responding to threats to speed up response times.</p>
<section data-type="sect1" data-pdf-bookmark="Working with Falco Outputs"><div class="sect1" id="working_with_falco_outputs">
<h1>Working with Falco Outputs</h1>
<p><a contenteditable="false" data-primary="consuming Falco events" data-secondary="working with Falco outputs" data-type="indexterm" id="ch12.html2"/><a contenteditable="false" data-primary="outputs" data-secondary="working with Falco outputs" data-type="indexterm" id="ch12.html3"/>A minimal Falco installation outputs a simple textual log that you can store for later consultation, but this is not very useful. Fortunately, more intelligent tools allow you to work with Falco’s outputs and expand its possibilities, and these are an important part of integrating Falco into your ecosystem.</p>
<p>This section will talk in detail about two tools that we have already mentioned in the book. The first, falco-exporter, is a tool designed to do one thing and do it well: produce metrics from Falco’s detected events. The second, Falcosidekick, is the Swiss Army knife of Falco outputs. It lets you aggregate data from multiple Falco sensors, filter the notifications, and forward them to any other application or platform in your environment.</p>
<section data-type="sect2" data-pdf-bookmark="falco-exporter"><div class="sect2" id="falco_exporter">
<h2>falco-exporter</h2>
<p><a contenteditable="false" data-primary="falco-exporter" data-type="indexterm" id="idm45324223159280"/><a contenteditable="false" data-primary="outputs" data-secondary="falco-exporter" data-type="indexterm" id="idm45324223158176"/>The <a href="https://oreil.ly/0j6EJ">falco-exporter project</a> provides a Prometheus metrics exporter for Falco output events. It consumes Falco outputs via a streamed gRPC API and exposes a metrics endpoint. The metrics include information on the number of triggered rules and detailed information on the priority and tags associated with the rules, as well as labels to identify each event’s origin, such as the hostname, namespace, and pod’s name. It also provides a preconfigured Grafana dashboard.<sup><a data-type="noteref" id="ch01fn16-marker" href="ch12.xhtml#ch01fn16">1</a></sup> falco-exporter is useful for when you only need metrics about security events. (By contrast, Falcosidekick can also export metrics, but it comes with many other functionalities and outputs.)</p>
<p>Before installing falco-exporter, ensure that Falco is installed and configured with the gRCP server and gRPC output enabled over a Unix socket (see <a data-type="xref" href="ch08.xhtml#grpc_output">“gRPC Output”</a> for a refresher).</p>
<section data-type="sect3" data-pdf-bookmark="Host installation"><div class="sect3" id="host_installation">
<h3>Host installation</h3>
<p><a contenteditable="false" data-primary="falco-exporter" data-secondary="host installation" data-type="indexterm" id="idm45324223149760"/>To install falco-exporter directly on the host, you have to download the latest version from the <a href="https://oreil.ly/rfK8e">releases page</a>, decompress the archive, and copy the executable file <em>falco-exporter</em> to your preferred location (e.g., <em>/usr/bin</em>). Whether you execute it manually or run it as a service is entirely up to you. The default options work out of the box with the gRPC Unix socket in <em>/var/run/falco.sock</em> (the default option for Falco). If you need to customize its options, run <code>falco-exporter --help</code> for assistance.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Running in a container"><div class="sect3" id="running_in_a_containe">
<h3>Running in a container</h3>
<p><a contenteditable="false" data-primary="containers" data-secondary="running falco-exporter in" data-type="indexterm" id="idm45324223143568"/><a contenteditable="false" data-primary="falco-exporter" data-secondary="running in a container" data-type="indexterm" id="idm45324223142176"/>To run falco-exporter in a container using Docker, use these commands:</p>
<pre data-type="programlisting">$ <strong>docker pull falcosecurity/falco-exporter:latest</strong>
$ <strong>docker run -v /var/run/falco.sock:/var/run/falco.sock \</strong>
<strong>    falcosecurity/falco-exporter:latest</strong></pre>
<p>The <code>docker run</code> command assumes that Falco is installed on the host and Falco’s gRPC Unix socket is present in <em>/var/run/falco.sock</em>.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Deploying to Kubernetes"><div class="sect3" id="deploying_to_kubernete">
<h3>Deploying to Kubernetes</h3>
<p><a contenteditable="false" data-primary="falco-exporter" data-secondary="deploying to Kubernetes" data-type="indexterm" id="idm45324223135536"/><a contenteditable="false" data-primary="Kubernetes" data-secondary="deploying falco-exporter to" data-type="indexterm" id="idm45324223134160"/>You can deploy falco-exporter to a Kubernetes cluster using either Helm or manifest files (see <a data-type="xref" href="ch09.xhtml#installing_falco">Chapter 9</a> for details on the two installation methods), but we recommend Helm. You first need to add the Falcosecurity charts repository:</p>
<pre data-type="programlisting">$ <strong>helm repo add falcosecurity https://falcosecurity.github.io/charts</strong>
$ <strong>helm repo update</strong></pre>
<p>Then, to install the chart, run:</p>
<pre data-type="programlisting">$ <strong>helm install falco-exporter falcosecurity/falco-exporter</strong></pre>
<p>For detailed instructions, see the <a href="https://oreil.ly/qkH5G">falco-exporter chart documentation</a>. If you want to use manifest files instead, follow the steps in the <a href="https://oreil.ly/lktaK">falco-exporter documentation</a>.</p> 
</div></section>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Falcosidekick"><div class="sect2" id="falcosidekick">
<h2>Falcosidekick</h2>
<p><a contenteditable="false" data-primary="Falcosidekick" data-type="indexterm" id="ch12.html4"/><a contenteditable="false" data-primary="outputs" data-secondary="Falcosidekick and" data-type="indexterm" id="ch12.html5"/>The <a href="https://oreil.ly/MVyRi">Falcosidekick project</a> provides a complete solution for connecting Falco to your ecosystem. It works on top of Falco’s output and allows you to forward its notifications to many other destinations (see <a data-type="xref" href="#the_falcosidekick_logo_left_parenthesis">Figure 12-1</a>). Falcosidekick can add custom fields to the notifications or filter events by priority (on a per-destination basis). In particular, supported outputs include platforms and applications for:</p>
<ul>
<li><p>Communication and collaboration</p></li>
<li><p>Metrics and observability</p></li>
<li><p>Alerting</p></li>
<li><p>Logging and storage</p></li>
<li><p>Function as a Service (FaaS) and serverless</p></li>
<li><p>Message queues and streaming</p></li>
</ul>
<figure><div id="the_falcosidekick_logo_left_parenthesis" class="figure">
<img src="Images/pcns_1201.png" alt="" width="600" height="228"/>
<h6><span class="label">Figure 12-1. </span>The Falcosidekick logo (left) and some of its supported notification destinations (right)</h6>
</div></figure>
<p class="pagebreak-before">Falcosidekick also allows you to use a side project, <a href="https://oreil.ly/o1pcB">falcosidekick-ui</a>, to visualize Falco events in a pleasant web UI (shown in <a data-type="xref" href="#the_falcosidekick_web_ui">Figure 12-2</a>). The web UI displays statistics about detected events and shows values in aggregate form and on a timeline. You can also filter for the events you are interested in and get all the event details quickly.</p>
<figure class="pagebreak-after"><div id="the_falcosidekick_web_ui" class="figure">
<img src="Images/pcns_1202.png" alt="" width="600" height="717"/>
<h6><span class="label">Figure 12-2. </span>The Falcosidekick web UI</h6>
</div></figure>
<p>Using Falcosidekick requires a small change in Falco’s configuration: before using it, enable JSON formatting and configure the HTTP output to send events to the Falcosidekick endpoint (it listens at port 2801 by default). See <a data-type="xref" href="ch08.xhtml#the_output_framework">Chapter 8</a> for Falco output configuration instructions and the Falcosidekick online documentation for specific details.</p>
<section data-type="sect3" data-pdf-bookmark="Host installation"><div class="sect3" id="host_installati">
<h3>Host installation</h3>
<p><a contenteditable="false" data-primary="Falcosidekick" data-secondary="host installation" data-type="indexterm" id="idm45324223106064"/>To install Falcosidekick directly on the host, download the latest version from the <a href="https://oreil.ly/ToAMj">releases page</a>, decompress the archive, and copy the executable file <em>falcosidekick</em> to your preferred location (e.g., <em>/usr/bin</em>). Whether to execute it manually or run it as a service is entirely up to you. You also need to create a YAML configuration file and pass its path as an argument. For example:</p>
<pre data-type="programlisting">$ <strong>falcosidekick -c falcosidekick_config.yaml</strong></pre>
<p>The Falcosidekick repository includes an example configuration file that you can start with. Falcosidekick also supports environment variables that you can use as an alternative or to override the configuration file values.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Running in a container"><div class="sect3" id="running_in_a_container">
<h3>Running in a container</h3>
<p><a contenteditable="false" data-primary="containers" data-secondary="running Falcosidekick in" data-type="indexterm" id="idm45324223099264"/><a contenteditable="false" data-primary="Falcosidekick" data-secondary="running in a container" data-type="indexterm" id="idm45324223097872"/>To run Falcosidekick in a container using Docker, use these commands:</p>
<pre data-type="programlisting">$ <strong>docker pull falcosecurity/falcosidekick:latest</strong>
$ <strong>docker run -d -p 2801:2801 falcosecurity/falcosidekick:latest</strong></pre>
<p>The <code>docker run</code> command assumes that Falco is installed on the host and that the HTTP output is configured to send events to port 2801. Using Docker’s <code>-e</code> option, you can use environment variables to pass configurations. Alternatively, use Docker’s <code>-v</code> option to give it a YAML configuration file.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Deploying to Kubernetes"><div class="sect3" id="deploying_to_kubernetes">
<h3>Deploying to Kubernetes</h3>
<p><a contenteditable="false" data-primary="Falcosidekick" data-secondary="deploying to Kubernetes" data-type="indexterm" id="idm45324223090784"/><a contenteditable="false" data-primary="Kubernetes" data-secondary="deploying Falcosidekick to" data-type="indexterm" id="idm45324223089408"/>As with falco-exporter, you can deploy Falcosidekick to a Kubernetes cluster using either Helm or manifest files. We recommend the Helm installation option, which comes in two variants. Before we explore them, if you haven’t already added the Falcosecurity charts repository to Helm, do it by running:</p>
<pre data-type="programlisting">$ <strong>helm repo add falcosecurity https://falcosecurity.github.io/charts</strong>
$ <strong>helm repo update</strong></pre>
<p class="pagebreak-before">Now you’re ready to deploy to your Kubernetes cluster. The first and more ordinary way to do this is when you already have Falco deployed and configured to send events to Falcosidekick and you just need to install the Falcosidekick chart:</p>
<pre data-type="programlisting">$ <strong>helm install falcosidekick falcosecurity/falcosidekick</strong></pre>
<p>The other variant allows you to deploy Falco and Falcosidekick in a single Helm installation that will automatically configure both charts to work together. It’s usually the most convenient solution. To do this, run:</p>
<pre data-type="programlisting">$ <strong>helm install falco falcosecurity/falco --set falcosidekick.enabled=true</strong></pre>
<p>Optionally, if you want to deploy the Falcosidekick web UI as well, add <code>--set webui.enabled=true</code> to the install command (regardless of which variant you choose).</p>
<p>You can find details on additional options in the <a href="https://oreil.ly/QaipZ">Falcosidekick chart documentation</a>. If you want to use manifest files instead, use the provided <a href="https://oreil.ly/fziYL">online examples</a>.<sup><a data-type="noteref" id="ch01fn17-marker" href="ch12.xhtml#ch01fn17">2</a></sup></p>
</div></section>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Observability and Analysis"><div class="sect1" id="observability_and_analysis">
<h1>Observability and Analysis</h1>
<p><a contenteditable="false" data-primary="consuming Falco events" data-secondary="observability and analysis" data-type="indexterm" id="idm45324223071136"/><a contenteditable="false" data-primary="observability" data-type="indexterm" id="idm45324223069744"/>Falco allows you to observe and analyze the security of your cloud-native environment. If you plan to leverage Falco’s detections for auditing or forensic purposes, you’ll usually want to store as much information as possible and make Falco’s results easily accessible and searchable. The tools described in this chapter offer you plenty of support.</p>
<p>Storing Falco events is like ingesting any other application logs. This means you can reuse your existing logging backend for Falco. Also, Falcosidekick can easily send Falco events to systems that allow you to store and analyze vast volumes of log data, like Elasticsearch and Splunk. Since you will likely use this approach for later analysis, we suggest keeping all events that Falco emits with no filtering.</p>
<p>You’ll probably also want to collect metrics, as this can help you detect errors and anomalies in your application. For instance, a metric reporting that a Falco rule regularly triggers on a particular machine may be a symptom of a security problem, a misconfiguration, or an implementation bug in your running application. A reliable tool for this purpose is falco-exporter: it exposes metrics, connects Falco to Prometheus, and also offers a ready-to-use Grafana dashboard (<a data-type="xref" href="#the_preconfigured_grafana_dashboard_for">Figure 12-3</a>).</p>
<figure><div id="the_preconfigured_grafana_dashboard_for" class="figure">
<img src="Images/pcns_1203.png" alt="" width="600" height="269"/>
<h6><span class="label">Figure 12-3. </span>The preconfigured Grafana dashboard for Falco events metrics provided by falco-exporter</h6>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Getting Notified"><div class="sect1" id="getting_notified">
<h1>Getting Notified</h1>
<p><a contenteditable="false" data-primary="consuming Falco events" data-secondary="getting notified" data-type="indexterm" id="idm45324223062864"/><a contenteditable="false" data-primary="notifications of security events" data-type="indexterm" id="idm45324223061488"/>Although storing and aggregating Falco events is fine for observability, it’s not helpful when you need to react promptly to a security event. You likely want to receive important notifications immediately and in the right place so that you or your team can take countermeasures or start investigating right away.</p>
<p>Falco’s built-in output channels do not provide a specific mechanism for immediate notifications, but Falcosidekick allows you to forward only important notifications. For example, let’s say you want to get notifications whenever an event triggers the <em>Sudo Potential Privilege Escalation</em> rule (which comes with <code>priority: CRITICAL</code>), but not for other, noisier rules with lower priority levels. Falcosidekick allows you to configure a minimum priority level at which you want to send events to a specific destination, and to adjust this configuration for each destination. It supports most on-call systems, like PagerDuty, Opsgenie, and Prometheus Alertmanager and can send notifications to most common communication platforms, including Slack, Mattermost, Rocket.Chat, Microsoft Teams, and Discord.</p>
<p>You can use Falcosidekick configurations to integrate Falco alerts into your existing environment easily. And because Falcosidekick allows you to forward Falco notifications to multiple destinations simultaneously, you can, for example, send the alerts to both PagerDuty and a Slack channel.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Responding to Threats"><div class="sect1" id="responding_to_threats">
<h1>Responding to Threats</h1>
<p><a contenteditable="false" data-primary="consuming Falco events" data-secondary="responding to threats" data-type="indexterm" id="idm45324223056560"/><a contenteditable="false" data-primary="response engines" data-type="indexterm" id="idm45324223055184"/><a contenteditable="false" data-primary="security incidents, responding to" data-type="indexterm" id="idm45324223054080"/><a contenteditable="false" data-primary="threats, responding to" data-type="indexterm" id="idm45324223052960"/>Another meaningful—and more sophisticated—way of consuming Falco events is to create systems that automatically take action in response to threats or security incidents. Implementing custom actions in response to threats is easier than you might think.</p>
<p>Although The Falco Project does not provide a specific tool for this purpose, a few emerging projects in the community are implementing this concept. Such systems are sometimes called <em>response engines</em> and usually specialize in managing threats in Kubernetes.</p>
<p>A response engine provides a straightforward mechanism to perform a predefined task when a Falco rule condition is violated. You can create a simple implementation using Falcosidekick to forward Falco notifications to a FaaS platform or serverless solution that, in turn, performs the required action. For example, you can automatically terminate a Kubernetes Pod whenever a Falco rule determines that the Pod is compromised, by implementing a cloud function that uses the Kubernetes API to delete the compromised Pod. <a data-type="xref" href="#example_of_a_functional_scheme_for_a_re">Figure 12-4</a> illustrates this approach and shows some cloud function providers supported by Falcosidekick.</p>
<figure><div id="example_of_a_functional_scheme_for_a_re" class="figure">
<img src="Images/pcns_1204.png" alt="" width="600" height="269"/>
<h6><span class="label">Figure 12-4. </span>Example of a functional scheme for a response engine for Kubernetes that uses Falcosidekick outputs to perform actions</h6>
</div></figure>
<p>You might want to be notified regardless of the rule’s priority level, but you will probably only want to perform actions for specific rules. For example, you might want only rules with a <code>CRITICAL</code> priority level to terminate Pods. Falcosidekick helps with this because it allows you to filter notifications based on their priority value, so you can control the information each destination receives.</p>
<p>We advise you to analyze your needs and design your response engine to meet them. Falco and tools like Falcosidekick will provide everything you need to support your solution.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="conclusion-id000011">
<h1>Conclusion</h1>
<p>This chapter concludes <a data-type="xref" href="part03.xhtml#iii_running_falco_in_production">Part III</a>. You’ve learned all the fundamental aspects of running Falco in production and can now configure and customize it for almost any need and scenario. You’ve also discovered how to consume Falco events properly and integrate them with your ecosystem.</p>
<p>In <a data-type="xref" href="part04.xhtml#iv_extending_falco">Part IV</a>, you will go beyond the knowledge of the average user and learn how to extend Falco to satisfy any advanced requirement.<a contenteditable="false" data-primary="" data-startref="ch12.html1" data-type="indexterm" id="idm45324223040864"/><a contenteditable="false" data-primary="" data-startref="ch12.html0" data-type="indexterm" id="idm45324223039488"/></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="ch01fn16"><sup><a href="ch12.xhtml#ch01fn16-marker">1</a></sup> A <a href="https://oreil.ly/2sVSm">Grafana dashboard</a> is a set of organized UI elements to visualize the data. Dashboard configurations can be stored in a file and shared. You can get most of the available dashboards from Grafana’s <a href="https://oreil.ly/F25kV">online gallery</a>.</p><p data-type="footnote" id="ch01fn17"><sup><a href="ch12.xhtml#ch01fn17-marker">2</a></sup> The actual URLs of the Falcosidekick example manifest files for Kubernetes may change from time to time, but you can always find them under the Falcosecurity GitHub organization. Note that any Helm chart can generate such files. Indeed, like Falco’s manifest files, Falcosidekick’s files are rendered starting from its chart<a contenteditable="false" data-primary="" data-startref="ch12.html5" data-type="indexterm" id="idm45324223078272"/><a contenteditable="false" data-primary="" data-startref="ch12.html4" data-type="indexterm" id="idm45324223076800"/>.<a contenteditable="false" data-primary="" data-startref="ch12.html3" data-type="indexterm" id="idm45324223075296"/><a contenteditable="false" data-primary="" data-startref="ch12.html2" data-type="indexterm" id="idm45324223073888"/></p></div></div></section></div></body></html>