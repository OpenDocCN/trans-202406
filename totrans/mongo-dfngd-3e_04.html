<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 3. Creating, Updating, and Deleting&#10;  Documents"><div class="chapter" id="chapter-3"><h1><span class="label">Chapter 3. </span>Creating, Updating, and <span class="keep-together">Deleting
  Documents</span></h1><p>This<a data-type="indexterm" data-primary="databases" data-secondary="moving data into and out of" data-seealso="documents" id="idm45882395394712"/> chapter covers the basics of moving data into and out of the
  database, including the following:</p><ul><li><p>Adding new documents to a collection</p></li><li><p>Removing documents from a collection</p></li><li><p>Updating existing documents</p></li><li><p>Choosing the correct level of safety versus speed for all of these
      operations</p></li></ul><section data-type="sect1" data-pdf-bookmark="Inserting Documents"><div class="sect1" id="sect1_d1e2315"><h1>Inserting Documents</h1><p>Inserts<a data-type="indexterm" data-primary="documents" data-secondary="inserting" id="Dinsert03"/> are the basic method for adding data to MongoDB.
    To<a data-type="indexterm" data-primary="inserts" data-secondary="single documents" id="idm45882395388648"/> insert a single document, use the collection’s
    <code>insertOne</code> method<a data-type="indexterm" data-primary="insertOne method" id="idm45882395387000"/>:</p><pre id="I_programlisting3_d1e2292" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">insertOne</code><code class="p">({</code><code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Stand by Me"</code><code class="p">})</code></pre><p><code>insertOne</code> will add an <code>"_id"</code> key to the document (if you do not supply
    one) and store the document in MongoDB.</p><section data-type="sect2" data-pdf-bookmark="insertMany"><div class="sect2" id="sect2_d1e2335"><h2>insertMany</h2><p>If you need to insert<a data-type="indexterm" data-primary="batch insert" id="idm45882395355128"/><a data-type="indexterm" data-primary="inserts" data-secondary="multiple documents" id="idm45882395354264"/> multiple documents into a collection, you can use
      <code>insertMany<a data-type="indexterm" data-primary="insertMany method" id="idm45882395317480"/></code>. This method enables you to pass an array of
      documents to the database. This is far more efficient because your code
      will not make a round trip to the database for each document inserted,
      but will insert them in bulk.</p><p>In the shell, you can try this out as follows:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">drop</code><code class="p">()</code>
<code class="kc">true</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">insertMany</code><code class="p">([{</code><code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Ghostbusters"</code><code class="p">},</code>
<code class="p">...</code>                        <code class="p">{</code><code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"E.T."</code><code class="p">},</code>
<code class="p">...</code>                        <code class="p">{</code><code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Blade Runner"</code><code class="p">}]);</code>
<code class="p">{</code>
      <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
       <code class="s2">"insertedIds"</code> <code class="o">:</code> <code class="p">[</code>
           <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"572630ba11722fac4b6b4996"</code><code class="p">),</code>
           <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"572630ba11722fac4b6b4997"</code><code class="p">),</code>
           <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"572630ba11722fac4b6b4998"</code><code class="p">)</code>
       <code class="p">]</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"572630ba11722fac4b6b4996"</code><code class="p">),</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Ghostbusters"</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"572630ba11722fac4b6b4997"</code><code class="p">),</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"E.T."</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"572630ba11722fac4b6b4998"</code><code class="p">),</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Blade Runner"</code> <code class="p">}</code></pre><p>Sending dozens, hundreds, or even thousands of documents at a time
      can make inserts significantly faster.</p><p><code>insertMany</code> is useful if you are inserting
      multiple documents into a single collection. If you are just importing
      raw data (e.g., from a data feed or MySQL), there are command-line tools
      like <em>mongoimport</em><a data-type="indexterm" data-primary="mongoimport command-line tool" id="idm45882395202472"/> that can be used instead of a batch insert. On<a data-type="indexterm" data-primary="data" data-secondary="importing" id="idm45882395201608"/><a data-type="indexterm" data-primary="munging data" id="idm45882395200568"/><a data-type="indexterm" data-primary="data" data-secondary="munging" id="idm45882395199736"/> the other hand, it is often handy to munge data before
      saving it to MongoDB (converting dates to the date type or adding a
      custom <code>"_id"</code>, for example). In such
      cases <code>insertMany</code> can be used for importing
      data, as well.</p><p>Current versions of MongoDB do not accept messages longer than 48
      MB, so there is a limit to how much can be inserted in a single batch
      insert. If you attempt to insert more than 48 MB, many drivers will
      split up the batch insert into multiple 48 MB batch inserts. Check your
      driver documentation for details.</p><p>When<a data-type="indexterm" data-primary="inserts" data-secondary="ordered versus unordered" id="idm45882395196488"/> performing a bulk insert using
      <code>insertMany</code>, if a document halfway through the
      array produces an error of some type, what happens depends on whether
      you have opted for ordered or unordered operations. As the second
      parameter to <code>insertMany</code> you may specify an
      options document. Specify <code>true</code> for
      the key <code>"ordered"</code> in the options
      document to ensure documents are inserted in the order they are
      provided. Specify <code>false</code> and MongoDB
      may reorder the inserts to increase performance. Ordered inserts is the
      default if no ordering is specified. For ordered inserts, the array
      passed to <code>insertMany</code> defines the insertion
      order. If a document produces an insertion error, no documents beyond
      that point in the array will be inserted. For unordered inserts, MongoDB
      will attempt to insert all documents, regardless of whether some
      insertions produce errors.</p><p>In this example, because ordered inserts is the default, only the
      first two documents will be inserted. The third document will produce an
      error, because you cannot insert two documents with the same <code>"_id"</code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">insertMany</code><code class="p">([</code>
    <code class="p">...</code> <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Top Gun"</code><code class="p">},</code>
    <code class="p">...</code> <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Back to the Future"</code><code class="p">},</code>
    <code class="p">...</code> <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Gremlins"</code><code class="p">},</code>
    <code class="p">...</code> <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Aliens"</code><code class="p">}])</code>
<code class="mi">2019</code><code class="o">-</code><code class="mi">04</code><code class="o">-</code><code class="mi">22</code><code class="nx">T12</code><code class="o">:</code><code class="mi">27</code><code class="o">:</code><code class="mf">57.278</code><code class="o">-</code><code class="mi">0400</code> <code class="nx">E</code> <code class="nx">QUERY</code>    <code class="p">[</code><code class="nx">js</code><code class="p">]</code> <code class="nx">BulkWriteError</code><code class="o">:</code> <code class="nx">write</code> 
<code class="nx">error</code> <code class="nx">at</code> <code class="nx">item</code> <code class="mi">2</code> <code class="k">in</code> <code class="nx">bulk</code> <code class="nx">operation</code> <code class="o">:</code>
<code class="nx">BulkWriteError</code><code class="p">({</code>
    <code class="s2">"writeErrors"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
            <code class="s2">"index"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"code"</code> <code class="o">:</code> <code class="mi">11000</code><code class="p">,</code>
            <code class="s2">"errmsg"</code> <code class="o">:</code> <code class="s2">"E11000 duplicate key error collection: </code>
<code class="s2">            test.movies index: _id_ dup key: { _id: 1.0 }"</code><code class="p">,</code>
            <code class="s2">"op"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Gremlins"</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">],</code>
    <code class="s2">"writeConcernErrors"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
    <code class="s2">"nInserted"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
    <code class="s2">"nUpserted"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"nMatched"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"nModified"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"nRemoved"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"upserted"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
<code class="p">})</code>
<code class="nx">BulkWriteError</code><code class="err">@</code><code class="nx">src</code><code class="o">/</code><code class="nx">mongo</code><code class="o">/</code><code class="nx">shell</code><code class="o">/</code><code class="nx">bulk_api</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">367</code><code class="o">:</code><code class="mi">48</code>
<code class="nx">BulkWriteResult</code><code class="o">/</code><code class="k">this</code><code class="p">.</code><code class="nx">toError</code><code class="err">@</code><code class="nx">src</code><code class="o">/</code><code class="nx">mongo</code><code class="o">/</code><code class="nx">shell</code><code class="o">/</code><code class="nx">bulk_api</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">332</code><code class="o">:</code><code class="mi">24</code>
<code class="nx">Bulk</code><code class="o">/</code><code class="k">this</code><code class="p">.</code><code class="nx">execute</code><code class="err">@</code><code class="nx">src</code><code class="o">/</code><code class="nx">mongo</code><code class="o">/</code><code class="nx">shell</code><code class="o">/</code><code class="nx">bulk_api</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">1186</code><code class="o">:</code><code class="mi">23</code>
<code class="nx">DBCollection</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">insertMany</code><code class="err">@</code><code class="nx">src</code><code class="o">/</code><code class="nx">mongo</code><code class="o">/</code><code class="nx">shell</code><code class="o">/</code><code class="nx">crud_api</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">314</code><code class="o">:</code><code class="mi">5</code>
<code class="err">@</code><code class="p">(</code><code class="nx">shell</code><code class="p">)</code><code class="o">:</code><code class="mi">1</code><code class="o">:</code><code class="mi">1</code></pre><p>If instead we specify unordered inserts, the first, second, and
      fourth documents in the array are inserted. The only insert that fails
      is the third document, again because of a duplicate <code>"_id"</code> error:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">insertMany</code><code class="p">([</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Sixteen Candles"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"The Terminator"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"The Princess Bride"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Scarface"</code><code class="p">}],</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"ordered"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">})</code>
<code class="mi">2019</code><code class="o">-</code><code class="mi">05</code><code class="o">-</code><code class="mi">01</code><code class="nx">T17</code><code class="o">:</code><code class="mi">02</code><code class="o">:</code><code class="mf">25.511</code><code class="o">-</code><code class="mi">0400</code> <code class="nx">E</code> <code class="nx">QUERY</code>    <code class="p">[</code><code class="nx">thread1</code><code class="p">]</code> <code class="nx">BulkWriteError</code><code class="o">:</code> <code class="nx">write</code>
<code class="nx">error</code> <code class="nx">at</code> <code class="nx">item</code> <code class="mi">2</code> <code class="k">in</code> <code class="nx">bulk</code> <code class="nx">operation</code> <code class="o">:</code>
<code class="nx">BulkWriteError</code><code class="p">({</code>
  <code class="s2">"writeErrors"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="p">{</code>
      <code class="s2">"index"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
      <code class="s2">"code"</code> <code class="o">:</code> <code class="mi">11000</code><code class="p">,</code>
      <code class="s2">"errmsg"</code> <code class="o">:</code> <code class="s2">"E11000 duplicate key error index: test.movies.$_id_</code>
<code class="s2">      dup key: { : 4.0 }"</code><code class="p">,</code>
      <code class="s2">"op"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code>
        <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"The Princess Bride"</code>
      <code class="p">}</code>
    <code class="p">}</code>
  <code class="p">],</code>
  <code class="s2">"writeConcernErrors"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
  <code class="s2">"nInserted"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code>
  <code class="s2">"nUpserted"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="s2">"nMatched"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="s2">"nModified"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="s2">"nRemoved"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="s2">"upserted"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
<code class="p">})</code>
<code class="nx">BulkWriteError</code><code class="err">@</code><code class="nx">src</code><code class="o">/</code><code class="nx">mongo</code><code class="o">/</code><code class="nx">shell</code><code class="o">/</code><code class="nx">bulk_api</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">367</code><code class="o">:</code><code class="mi">48</code>
<code class="nx">BulkWriteResult</code><code class="o">/</code><code class="k">this</code><code class="p">.</code><code class="nx">toError</code><code class="err">@</code><code class="nx">src</code><code class="o">/</code><code class="nx">mongo</code><code class="o">/</code><code class="nx">shell</code><code class="o">/</code><code class="nx">bulk_api</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">332</code><code class="o">:</code><code class="mi">24</code>
<code class="nx">Bulk</code><code class="o">/</code><code class="k">this</code><code class="p">.</code><code class="nx">execute</code><code class="err">@</code><code class="nx">src</code><code class="o">/</code><code class="nx">mongo</code><code class="o">/</code><code class="nx">shell</code><code class="o">/</code><code class="nx">bulk_api</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mf">1186.23</code>
<code class="nx">DBCollection</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">insertMany</code><code class="err">@</code><code class="nx">src</code><code class="o">/</code><code class="nx">mongo</code><code class="o">/</code><code class="nx">shell</code><code class="o">/</code><code class="nx">crud_api</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">314</code><code class="o">:</code><code class="mi">5</code>
<code class="err">@</code><code class="p">(</code><code class="nx">shell</code><code class="p">)</code><code class="o">:</code><code class="mi">1</code><code class="o">:</code><code class="mi">1</code></pre><p>If you study these examples closely, you might note that the
      output of these two calls to <code>insertMany</code> hints that other operations besides
      simply inserts might be supported for bulk writes. While
      <code>insertMany</code> does not support operations other
      than insert, MongoDB does support a Bulk Write API that enables you to
      batch together a number of operations of different types in one call.
      While that is beyond the scope of this chapter, you can read about the
      <a href="https://docs.mongodb.org/manual/core/bulk-write-operations/">Bulk
      Write API</a> in the MongoDB documentation.</p></div></section><section data-type="sect2" data-pdf-bookmark="Insert Validation"><div class="sect2" id="sect2_d1e2360"><h2>Insert Validation</h2><p>MongoDB<a data-type="indexterm" data-primary="inserts" data-secondary="validating" id="idm45882394922136"/> does minimal checks on data being inserted: it checks the
      document’s basic structure and adds an <code>"_id"</code> field if one
      does not exist. One of the basic structure checks is size: all documents
      must be smaller than 16 MB. This is a somewhat arbitrary limit (and may
      be raised in the future); it is mostly intended to prevent bad schema
      design and ensure consistent performance. To see the Binary JSON (BSON)
      size, in bytes, of the document <em><code>doc</code></em>, run
      <code>Object.bsonsize(<em><code>doc</code></em>)</code>
      from the shell.</p><p>To give you an idea of how much data 16 MB is, the entire text of
      <em>War and Peace</em> is just <span class="keep-together">3.14 MB</span>.</p><p>These minimal checks also mean that it is fairly easy to insert
      invalid data (if you are trying to). Thus, you should only allow trusted
      sources, such as your application servers, to connect to the database.
      All of the MongoDB drivers for major languages (and most of the minor
      ones, too) do check for a variety of invalid data (documents that are
      too large, contain non-UTF-8 strings, or use unrecognized types) before
      sending anything to the database.</p></div></section><section data-type="sect2" data-pdf-bookmark="insert"><div class="sect2" id="sect2_d1e2365"><h2>insert</h2><p>In versions of MongoDB prior to 3.0, <code>insert<a data-type="indexterm" data-primary="insert method" id="idm45882394598088"/></code> was the primary method for inserting
      documents into MongoDB. MongoDB drivers introduced a new CRUD
      API<a data-type="indexterm" data-primary="CRUD (create, read, update, and delete)" data-secondary="CRUD API" id="idm45882394596968"/> at the same time as the MongoDB 3.0 server release. As of
      MongoDB 3.2 the <em>mongo</em> shell also supports this API,
      which includes <code>insertOne</code> and
      <code>insertMany</code> as well as several other methods.
      The goal of the current CRUD API is to make the semantics of all CRUD
      operations consistent and clear across the drivers and the shell. While
      methods such as <code>insert</code> are still
      supported for backward compatibility, they should not be used in
      applications going forward. You should instead prefer
      <code>insertOne</code> and
      <code>insertMany</code> for creating<a data-type="indexterm" data-startref="Dinsert03" id="idm45882394592792"/> documents.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Removing Documents"><div class="sect1" id="sect1_d1e2400"><h1>Removing Documents</h1><p>Now<a data-type="indexterm" data-primary="documents" data-secondary="removing" id="idm45882394590312"/> that there’s data in our database, let’s delete it. The
    CRUD API provides <span class="keep-together"><code>deleteOne<a data-type="indexterm" data-primary="deleteOne method" id="idm45882394588328"/></code> and</span>
    <code>deleteMany</code> <a data-type="indexterm" data-primary="deleteMany method" id="idm45882394586792"/>for this purpose. Both of these methods take a filter
    document as their first parameter. The filter specifies a set of criteria
    to match against in removing documents. To delete the document with the
    <code><code>"_id"</code></code> value of <code>4</code>, we use <code>deleteOne</code> in
    the <em>mongo</em> shell as illustrated here: </p><pre id="I_programlisting3_d1e2379" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Top Gun"</code><code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Back to the Future"</code><code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Sixteen Candles"</code><code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"The Terminator"</code><code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Scarface"</code><code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">deleteOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">})</code>
<code class="p">{</code> <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"deletedCount"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Top Gun"</code><code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Back to the Future"</code><code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Sixteen Candles"</code><code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Scarface"</code><code class="p">}</code></pre><p>In this example, we used a filter that could only match one document
    since <code>"_id"</code> values are unique in a collection. However, we
    can also specify a filter that matches multiple documents in a collection.
    In this case, <code>deleteOne</code> will delete the first
    document found that matches the filter. Which document is found first
    depends on several factors, including the order in which the documents
    were inserted, what updates were made to the documents (for some storage
    engines), and what indexes are specified. As with any database operation,
    be sure you know what effect your use of
    <code>deleteOne</code> will have on your data.</p><p>To delete all the documents that match a filter, use
    <code>deleteMany</code>:</p><pre id="I_programlisting3_d1e2384" class="pagebreak-before" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Top Gun"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1986</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Back to the Future"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1985</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Sixteen Candles"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1984</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"The Terminator"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1984</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Scarface"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1983</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">deleteMany</code><code class="p">({</code><code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1984</code><code class="p">})</code>
<code class="p">{</code> <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"deletedCount"</code> <code class="o">:</code> <code class="mi">2</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Top Gun"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1986</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Back to the Future"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1985</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Scarface"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1983</code> <code class="p">}</code></pre><p>As a more realistic use case, suppose you want to remove every user
    from the <em>mailing.list</em> collection where the value for
    <code>"opt-out"</code> is <code>true</code>: </p><pre id="I_programlisting3_d1e2389" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">mailing</code><code class="p">.</code><code class="nx">list</code><code class="p">.</code><code class="nx">deleteMany</code><code class="p">({</code><code class="s2">"opt-out"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">})</code></pre><p>In versions of MongoDB prior to 3.0, <code>remove<a data-type="indexterm" data-primary="remove method" id="idm45882394151384"/></code> was the primary method for deleting documents.
    MongoDB drivers introduced the <code>deleteOne</code> and
    <code>deleteMany</code> methods at the same time as the
    MongoDB 3.0 server release, and the shell began supporting these methods
    in MongoDB 3.2. While <code>remove</code> is still
    supported for backward compatibility, you should use
    <code>deleteOne</code> and <code>deleteMany</code>
    in your applications. The current CRUD API provides a cleaner set of
    semantics and, especially for multidocument operations, helps application
    developers avoid a couple of common pitfalls with the previous API.</p><section data-type="sect2" data-pdf-bookmark="drop"><div class="sect2" id="sect2_d1e2439"><h2>drop</h2><p>It is possible to use <code>deleteMany</code> to
      remove all documents in a collection:</p><pre id="I_programlisting3_d1e2394" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Top Gun"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1986</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Back to the Future"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1985</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Sixteen Candles"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1984</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"The Terminator"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1984</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code> <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Scarface"</code><code class="p">,</code> <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">1983</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">deleteMany</code><code class="p">({})</code>
<code class="p">{</code> <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"deletedCount"</code> <code class="o">:</code> <code class="mi">5</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code></pre><p> Removing<a data-type="indexterm" data-primary="collections" data-secondary="dropping (clearing entire)" id="idm45882394133448"/> documents is usually a fairly quick operation. However,
      if you want to clear an entire collection, it is faster to<a data-type="indexterm" data-primary="drop method" id="idm45882394132200"/> <code>drop</code>
      it:</p><pre id="I_programlisting3_d1e2405" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">drop</code><code class="p">()</code>
<code class="kc">true</code></pre><p> and then recreate any indexes on the empty
      collection.</p><p>Once<a data-type="indexterm" data-primary="data" data-secondary="restoring deleted" id="idm45882393942280"/> data has been removed, it is gone forever. There is no
      way to undo a delete or drop operation or recover deleted documents,
      except, of course, by restoring a <span class="keep-together">previously</span> backed up version of the
      data. See <a data-type="xref" href="ch23.xhtml#chapter-backup">Chapter 23</a> for a detailed discussion of
      MongoDB backup and restore.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Updating Documents"><div class="sect1" id="sect1_d1e2484"><h1>Updating Documents</h1><p>Once<a data-type="indexterm" data-primary="documents" data-secondary="updating" id="Dupdate03"/><a data-type="indexterm" data-primary="updates" data-secondary="methods available" id="idm45882393950120"/> a document is stored in the database, it can be changed
    using one of several update methods: <code class="function">updateOne</code>, <code class="function">updateMany</code>, and <code class="function">replaceOne</code>. <code class="function">updateOne</code> and <code class="function">updateMany</code> each take a filter document as their
    first parameter and a modifier document, which describes changes to make,
    as the second parameter. <code class="function">replaceOne</code>
    also takes a filter as the first parameter, but as the second parameter
    <code class="function">replaceOne</code> expects a document with
    which it will replace the document matching the filter.</p><p>Updating<a data-type="indexterm" data-primary="updates" data-secondary="atomic" id="idm45882393937336"/> a document is atomic: if two updates happen at the same
    time, whichever one reaches the server first will be applied, and then the
    next one will be applied. Thus, conflicting updates can safely be sent in
    rapid-fire succession without any documents being corrupted: the last
    update will “win.” The Document Versioning pattern (see <a data-type="xref" href="ch09.xhtml#schemeDesignPatterns">“Schema Design Patterns”</a>) is worth considering if you don’t want
    the default behavior.</p><section data-type="sect2" data-pdf-bookmark="Document Replacement"><div class="sect2" id="sect2_d1e2501"><h2>Document Replacement</h2><p><code>replaceOne</code> <a data-type="indexterm" data-primary="replaceOne method" id="idm45882393932744"/>fully<a data-type="indexterm" data-primary="updates" data-secondary="replacing documents" id="idm45882393931752"/><a data-type="indexterm" data-primary="documents" data-secondary="replacing" id="idm45882393930616"/> replaces a matching document with a new one. This can be
      useful to do a<a data-type="indexterm" data-primary="schemas" data-secondary="migrating" id="idm45882393908760"/> dramatic schema migration (see <a data-type="xref" href="ch09.xhtml#chapter-app-design">Chapter 9</a> for scheme migration strategies). For
      example, suppose we are making major changes to a user document, which
      looks like the following:</p><pre id="I_programlisting3_d1e2481" data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2b9f67a1f631733d917a7a"</code><code class="p">),</code>
    <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
    <code class="s2">"friends"</code> <code class="o">:</code> <code class="mi">32</code><code class="p">,</code>
    <code class="s2">"enemies"</code> <code class="o">:</code> <code class="mi">2</code>
<code class="p">}</code></pre><p>We want to move the <code>"friends"</code>
      and <code>"enemies"</code> fields to a <code>"relationships"</code> subdocument. We can change the
      structure of the document in the shell and then replace the database’s
      version with a <code class="function">replaceOne</code>:</p><pre id="I_programlisting3_d1e2492" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="kd">var</code> <code class="nx">joe</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">});</code>
<code class="o">&gt;</code> <code class="nx">joe</code><code class="p">.</code><code class="nx">relationships</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"friends"</code> <code class="o">:</code> <code class="nx">joe</code><code class="p">.</code><code class="nx">friends</code><code class="p">,</code> <code class="s2">"enemies"</code> <code class="o">:</code> <code class="nx">joe</code><code class="p">.</code><code class="nx">enemies</code><code class="p">};</code>
<code class="p">{</code>
    <code class="s2">"friends"</code> <code class="o">:</code> <code class="mi">32</code><code class="p">,</code>
    <code class="s2">"enemies"</code> <code class="o">:</code> <code class="mi">2</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">joe</code><code class="p">.</code><code class="nx">username</code> <code class="o">=</code> <code class="nx">joe</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code>
<code class="s2">"joe"</code>
<code class="o">&gt;</code> <code class="k">delete</code> <code class="nx">joe</code><code class="p">.</code><code class="nx">friends</code><code class="p">;</code>
<code class="kc">true</code>
<code class="o">&gt;</code> <code class="k">delete</code> <code class="nx">joe</code><code class="p">.</code><code class="nx">enemies</code><code class="p">;</code>
<code class="kc">true</code>
<code class="o">&gt;</code> <code class="k">delete</code> <code class="nx">joe</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code>
<code class="kc">true</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">replaceOne</code><code class="p">({</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">},</code> <code class="nx">joe</code><code class="p">);</code></pre><p>Now, doing a <code class="function">findOne</code> shows
      that the structure of the document has been updated:</p><pre id="I_programlisting3_d1e2485" data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2b9f67a1f631733d917a7a"</code><code class="p">),</code>
    <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
    <code class="s2">"relationships"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"friends"</code> <code class="o">:</code> <code class="mi">32</code><code class="p">,</code>
        <code class="s2">"enemies"</code> <code class="o">:</code> <code class="mi">2</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>A common mistake is matching more than one document with the
      criteria and then creating a duplicate <code>"_id"</code> value with the second parameter. The
      database will throw an error for this, and no documents will be
      updated.</p><p>For example, suppose we create several documents with the same
      value for <code>"name"</code>, but we don’t
      realize it:</p><pre id="I_programlisting3_d1e2511" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">people</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2b9f67a1f631733d917a7b"</code><code class="p">),</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">65</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2b9f67a1f631733d917a7c"</code><code class="p">),</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">20</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2b9f67a1f631733d917a7d"</code><code class="p">),</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">49</code><code class="p">}</code></pre><p>Now, if it’s Joe #2’s birthday, we want to increment the value of
      his <code>"age"</code> key, so we might say
      this:</p><pre id="I_programlisting3_d1e2519" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">joe</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">people</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">20</code><code class="p">});</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2b9f67a1f631733d917a7c"</code><code class="p">),</code>
    <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
    <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">20</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">joe</code><code class="p">.</code><code class="nx">age</code><code class="o">++</code><code class="p">;</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">people</code><code class="p">.</code><code class="nx">replaceOne</code><code class="p">({</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">},</code> <code class="nx">joe</code><code class="p">);</code>
<code class="nx">E11001</code> <code class="nx">duplicate</code> <code class="nx">key</code> <code class="nx">on</code> <code class="nx">update</code></pre><p>What happened? When you do the update, the database will look for
      a document matching <code>{"name" : "joe"}</code>.
      The first one it finds will be the 65-year-old Joe. It will attempt to
      replace that document with the one in the <code class="varname">joe</code>
      variable, but there’s already a document in this collection with the
      same <code>"_id"</code>. Thus, the update will
      fail, because <code>"_id"</code> values must be
      unique. The best way to avoid this situation is to make sure that your
      update always specifies a unique document, perhaps by matching on a key
      like <code>"_id"</code>. For the preceding
      example, this would be the correct update to use:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">people</code><code class="p">.</code><code class="nx">replaceOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2b9f67a1f631733d917a7c"</code><code class="p">)},</code> <code class="nx">joe</code><code class="p">)</code></pre><p>Using <code>"_id"</code> for the filter will
      also be efficient since<code>"_id"</code> values
      form the basis for the primary index of a collection. We’ll cover
      primary and secondary indexes and how indexing affects updates and other
      operations more in <a data-type="xref" href="ch05.xhtml#chapter_d1e5128">Chapter 5</a>.</p></div></section><section data-type="sect2" data-pdf-bookmark="Using Update Operators"><div class="sect2" id="sect2_d1e2578"><h2>Using Update Operators</h2><p>Usually<a data-type="indexterm" data-primary="updates" data-secondary="using update operators" id="Uoper03"/> only certain portions of a document need to be updated.
      You can update specific fields in a document using atomic<a data-type="indexterm" data-primary="update operators" data-secondary="uses for" id="idm45882386883640"/> <em>update operators</em>. Update operators
      are special keys that can be used to specify complex update operations,
      such as altering, adding, or removing keys, and even manipulating arrays
      and embedded documents.</p><p>Suppose we’re keeping website analytics in a collection and want
      to increment a counter each time someone visits a page. We can use
      update operators to do this increment atomically. Each URL and its
      number of page views is stored in a document that looks like
      this:</p><pre id="I_programlisting3_d1e2562" data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b253b067525f35f94b60a31"</code><code class="p">),</code>
    <code class="s2">"url"</code> <code class="o">:</code> <code class="s2">"www.example.com"</code><code class="p">,</code>
    <code class="s2">"pageviews"</code> <code class="o">:</code> <code class="mi">52</code>
<code class="p">}</code></pre><p>Every time someone visits a page, we can find the page by its URL
      and<a data-type="indexterm" data-primary="update operators" data-secondary="incrementing values" id="idm45882386811576"/> use the <code>"$inc<a data-type="indexterm" data-primary="$inc modifier" data-primary-sortas="inc modifier" id="idm45882386809384"/>"</code> modifier to increment the value of the
      <code>"pageviews"</code> key:</p><pre id="I_programlisting3_d1e2580" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">analytics</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"url"</code> <code class="o">:</code> <code class="s2">"www.example.com"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$inc"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"pageviews"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">}})</code>
<code class="p">{</code> <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"matchedCount"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"modifiedCount"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code></pre><p>Now, if we do a <code class="function">findOne</code>, we
      see that <code>"pageviews"</code> has increased by
      one:</p><pre id="I_programlisting3_d1e2590" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">analytics</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b253b067525f35f94b60a31"</code><code class="p">),</code>
    <code class="s2">"url"</code> <code class="o">:</code> <code class="s2">"www.example.com"</code><code class="p">,</code>
    <code class="s2">"pageviews"</code> <code class="o">:</code> <code class="mi">53</code>
<code class="p">}</code></pre><p>When using operators, the value of <code>"_id"</code> cannot be changed. (Note that <code>"_id"</code> <em>can</em> be changed by
      using whole-document replacement.) Values for any other key, including
      other uniquely indexed keys, can be modified.</p><section data-type="sect3" data-pdf-bookmark="Getting started with the “$set” modifier"><div class="sect3" id="sect3_d1e2648"><h3>Getting started with the “$set” modifier</h3><p><code>"$set"</code> sets<a data-type="indexterm" data-primary="update operators" data-secondary="setting field values" id="idm45882386721080"/><a data-type="indexterm" data-primary="$set modifier" data-primary-sortas="set modifier" id="idm45882386719944"/> the value of a field. If the field does not yet exist,
        it will be created. This can be handy for<a data-type="indexterm" data-primary="schemas" data-secondary="updating" id="idm45882386718584"/> updating schemas or adding user-defined keys. For
        example, suppose you have a simple user profile stored as a document
        that looks something like the following:</p><pre id="I_programlisting3_d1e2675" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b253b067525f35f94b60a31"</code><code class="p">),</code>
    <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
    <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">30</code><code class="p">,</code>
    <code class="s2">"sex"</code> <code class="o">:</code> <code class="s2">"male"</code><code class="p">,</code>
    <code class="s2">"location"</code> <code class="o">:</code> <code class="s2">"Wisconsin"</code>
<code class="p">}</code></pre><p>This is a pretty bare-bones user profile. If the user wanted to
        store his favorite book in his profile, he could add it using <code>"$set"</code>:</p><pre id="I_programlisting3_d1e2682" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b253b067525f35f94b60a31"</code><code class="p">)},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"favorite book"</code> <code class="o">:</code> <code class="s2">"War and Peace"</code><code class="p">}})</code></pre><p>Now the document will have a <code>"favorite
        book"</code> key:</p><pre id="I_programlisting3_d1e2686" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b253b067525f35f94b60a31"</code><code class="p">),</code>
    <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
    <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">30</code><code class="p">,</code>
    <code class="s2">"sex"</code> <code class="o">:</code> <code class="s2">"male"</code><code class="p">,</code>
    <code class="s2">"location"</code> <code class="o">:</code> <code class="s2">"Wisconsin"</code><code class="p">,</code>
    <code class="s2">"favorite book"</code> <code class="o">:</code> <code class="s2">"War and Peace"</code>
<code class="p">}</code></pre><p>If the user decides that he actually enjoys a different book,
        <code>"$set"</code> can be used again to change
        the value:</p><pre id="I_programlisting3_d1e2693" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"favorite book"</code> <code class="o">:</code> <code class="s2">"Green Eggs and Ham"</code><code class="p">}})</code></pre><p><code>"$set"</code> can even change the
        type of the key it modifies. For instance, if our fickle user decides
        that he actually likes quite a few books, he can change the value of
        the <code>"favorite book"</code> key into an
        array:</p><pre id="I_programlisting3_d1e2704" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"favorite book"</code> <code class="o">:</code>
<code class="p">...</code>     <code class="p">[</code><code class="s2">"Cat's Cradle"</code><code class="p">,</code> <code class="s2">"Foundation Trilogy"</code><code class="p">,</code> <code class="s2">"Ender's Game"</code><code class="p">]}})</code></pre><p>If<a data-type="indexterm" data-primary="$unset modifier" data-primary-sortas="unset modifier" id="idm45882386513768"/><a data-type="indexterm" data-primary="update operators" data-secondary="removing field values" id="idm45882386422696"/> the user realizes that he actually doesn’t like
        reading, he can remove the key altogether with <code>"$unset"</code>:</p><pre id="I_programlisting3_d1e2722" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$unset"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"favorite book"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">}})</code></pre><p>Now the document will be the same as it was at the beginning of
        this example.</p><p>You<a data-type="indexterm" data-primary="embedded documents" data-secondary="changing/updating" id="idm45882386357688"/> can also use <code>"$set"</code>
        to reach in and change embedded documents:</p><pre id="I_programlisting3_d1e2732" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b253b067525f35f94b60a31"</code><code class="p">),</code>
    <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"A Blog Post"</code><code class="p">,</code>
    <code class="s2">"content"</code> <code class="o">:</code> <code class="s2">"..."</code><code class="p">,</code>
    <code class="s2">"author"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
        <code class="s2">"email"</code> <code class="o">:</code> <code class="s2">"joe@example.com"</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"author.name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"author.name"</code> <code class="o">:</code> <code class="s2">"joe schmoe"</code><code class="p">}})</code>

<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b253b067525f35f94b60a31"</code><code class="p">),</code>
    <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"A Blog Post"</code><code class="p">,</code>
    <code class="s2">"content"</code> <code class="o">:</code> <code class="s2">"..."</code><code class="p">,</code>
    <code class="s2">"author"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe schmoe"</code><code class="p">,</code>
        <code class="s2">"email"</code> <code class="o">:</code> <code class="s2">"joe@example.com"</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>You<a data-type="indexterm" data-primary="keys" data-secondary="adding, changing, or removing" id="idm45882386353944"/> must always use a <code>$</code>-modifier for adding, changing, or removing
        keys. A common error people make when starting out is to try to set
        the value of a key to some other value by doing an update that
        resembles this:</p><pre id="I_programlisting3_d1e2749" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"author.name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">},</code> 
<code class="p">...</code> <code class="p">{</code><code class="s2">"author.name"</code> <code class="o">:</code> <code class="s2">"joe schmoe"</code><code class="p">})</code></pre><p>This will result in an error. The update document must contain
        update operators. Previous versions of the CRUD API did not catch this
        type of error. Earlier update methods would simply complete a whole
        document replacement in such situations. It is this type of pitfall
        that led to the creation of a new CRUD API.</p></div></section><section data-type="sect3" data-pdf-bookmark="Incrementing and decrementing"><div class="sect3" id="sect3_d1e2740"><h3>Incrementing and decrementing</h3><p>The <code>"$inc"</code> operator<a data-type="indexterm" data-primary="$inc modifier" data-primary-sortas="inc modifier" id="idm45882386150808"/><a data-type="indexterm" data-primary="update operators" data-secondary="incrementing values" id="idm45882386149736"/> can be used to change the value for an existing key or
        to create a new key if it does not already exist. It’s useful for
        updating analytics, karma, votes, or anything else that has a
        changeable, numeric value.</p><p>Suppose we are creating a game collection where we want to save
        games and update scores as they change. When a user starts playing,
        say, a game of pinball, we can insert a document that identifies the
        game by name and the user playing it:</p><pre id="I_programlisting3_d1e2782" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">games</code><code class="p">.</code><code class="nx">insertOne</code><code class="p">({</code><code class="s2">"game"</code> <code class="o">:</code> <code class="s2">"pinball"</code><code class="p">,</code> <code class="s2">"user"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">})</code></pre><p>When the ball hits a bumper, the game should increment the
        player’s score. Since points in pinball are given out pretty freely,
        let’s say that the base unit of points a player can earn is 50. We can
        use the <code>"$inc"</code> modifier to add 50
        to the player’s score:</p><pre id="I_programlisting3_d1e2789" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">games</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"game"</code> <code class="o">:</code> <code class="s2">"pinball"</code><code class="p">,</code> <code class="s2">"user"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$inc"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"score"</code> <code class="o">:</code> <code class="mi">50</code><code class="p">}})</code></pre><p>If we look at the document after this update, we’ll see the
        following:</p><pre id="I_programlisting3_d1e2794" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">games</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
     <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">),</code>
     <code class="s2">"game"</code> <code class="o">:</code> <code class="s2">"pinball"</code><code class="p">,</code>
     <code class="s2">"user"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
     <code class="s2">"score"</code> <code class="o">:</code> <code class="mi">50</code>
<code class="p">}</code></pre><p>The <code>"score"</code> key did not
        already exist, so it was created by <code>"$inc"</code> and set to the increment amount:
        <code>50</code>.</p><p>If the ball lands in a “bonus” slot, we want to add 10,000 to
        the score. We can do this by passing a different value to <code>"$inc"</code>:</p><pre id="I_programlisting3_d1e2806" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">games</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"game"</code> <code class="o">:</code> <code class="s2">"pinball"</code><code class="p">,</code> <code class="s2">"user"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$inc"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"score"</code> <code class="o">:</code> <code class="mi">10000</code><code class="p">}})</code></pre><p>Now if we look at the game, we’ll see the following:</p><pre id="I_programlisting3_d1e2811" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">games</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
     <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">),</code>
     <code class="s2">"game"</code> <code class="o">:</code> <code class="s2">"pinball"</code><code class="p">,</code>
     <code class="s2">"user"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
     <code class="s2">"score"</code> <code class="o">:</code> <code class="mi">10050</code>
<code class="p">}</code></pre><p>The <code>"score"</code> key existed and
        had a numeric value, so the server added 10,000 to it.</p><p><code>"$inc"</code> is similar to <code>"$set"</code>, but it is designed for
        incrementing<a data-type="indexterm" data-primary="update operators" data-secondary="decrementing values" id="idm45882385927112"/> (and decrementing) numbers. <code>"$inc"</code> can be used only on values of type
        integer, long, double, or decimal. If it is used on any other type of
        value, it will fail. This includes types that many languages will
        automatically cast into numbers, like nulls, booleans, or strings of
        numeric characters:</p><pre id="I_programlisting3_d1e2828" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">strcounts</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="s2">"count"</code> <code class="o">:</code> <code class="s2">"1"</code><code class="p">})</code>
<code class="nx">WriteResult</code><code class="p">({</code> <code class="s2">"nInserted"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">})</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">strcounts</code><code class="p">.</code><code class="nx">update</code><code class="p">({},</code> <code class="p">{</code><code class="s2">"$inc"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"count"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">}})</code>
<code class="nx">WriteResult</code><code class="p">({</code>
  <code class="s2">"nMatched"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="s2">"nUpserted"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="s2">"nModified"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="s2">"writeError"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"code"</code> <code class="o">:</code> <code class="mi">16837</code><code class="p">,</code>
    <code class="s2">"errmsg"</code> <code class="o">:</code> <code class="s2">"Cannot apply $inc to a value of non-numeric type.</code>
<code class="s2">    {_id: ObjectId('5726c0d36855a935cb57a659')} has the field 'count' of</code>
<code class="s2">    non-numeric type String"</code>
  <code class="p">}</code>
<code class="p">})</code></pre><p>Also, the value of the <code>"$inc"</code>
        key must be a number. You cannot increment by a string, array, or
        other nonnumeric value. Doing so will give a “Modifier <code>"$inc"</code> allowed for numbers only” error
        message. To modify other types, use <code>"$set"</code> or one of the following array
        operators.</p></div></section><section data-type="sect3" data-pdf-bookmark="Array operators"><div class="sect3" id="sect3_d1e2828"><h3>Array operators</h3><p>An<a data-type="indexterm" data-primary="update operators" data-secondary="array operators" id="UOarray03"/> extensive class of update operators exists
        for<a data-type="indexterm" data-primary="arrays" data-secondary="manipulating" id="Aman03"/> manipulating arrays. Arrays are common and powerful
        data structures: not only are they lists that can be referenced by
        index, but they can also double as sets.</p><section data-type="sect4" data-pdf-bookmark="Adding elements"><div class="sect4" id="idm45882385814712"><h4>Adding elements</h4><p><code>"$push"</code> adds
          elements<a data-type="indexterm" data-primary="$push operator" data-primary-sortas="push operator" id="idm45882385813208"/><a data-type="indexterm" data-primary="array operators" data-secondary="adding elements" id="idm45882385812104"/> to the end of an array if the array exists and
          creates a new array if it does not. For example, suppose that we are
          storing blog posts and want to add a <code>"comments"</code> key containing an array. We can
          push a comment onto the nonexistent <code>"comments"</code> array, which will create the
          array and add the comment:</p><pre id="I_programlisting3_d1e2887" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">),</code>
    <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"A blog post"</code><code class="p">,</code>
    <code class="s2">"content"</code> <code class="o">:</code> <code class="s2">"..."</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"A blog post"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$push"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"comments"</code> <code class="o">:</code>
<code class="p">...</code>     <code class="p">{</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code> <code class="s2">"email"</code> <code class="o">:</code> <code class="s2">"joe@example.com"</code><code class="p">,</code>
<code class="p">...</code>     <code class="s2">"content"</code> <code class="o">:</code> <code class="s2">"nice post."</code><code class="p">}}})</code>
<code class="p">{</code> <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"matchedCount"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"modifiedCount"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">),</code>
    <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"A blog post"</code><code class="p">,</code>
    <code class="s2">"content"</code> <code class="o">:</code> <code class="s2">"..."</code><code class="p">,</code>
    <code class="s2">"comments"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
            <code class="s2">"email"</code> <code class="o">:</code> <code class="s2">"joe@example.com"</code><code class="p">,</code>
            <code class="s2">"content"</code> <code class="o">:</code> <code class="s2">"nice post."</code>
        <code class="p">}</code>
    <code class="p">]</code>
<code class="p">}</code></pre><p>Now, if we want to add another comment, we can simply use
          <code>"$push"</code> again:</p><pre id="I_programlisting3_d1e2894" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"A blog post"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$push"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"comments"</code> <code class="o">:</code>
<code class="p">...</code>     <code class="p">{</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"bob"</code><code class="p">,</code> <code class="s2">"email"</code> <code class="o">:</code> <code class="s2">"bob@example.com"</code><code class="p">,</code>
<code class="p">...</code>     <code class="s2">"content"</code> <code class="o">:</code> <code class="s2">"good post."</code><code class="p">}}})</code>
<code class="p">{</code> <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"matchedCount"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"modifiedCount"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">),</code>
    <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"A blog post"</code><code class="p">,</code>
    <code class="s2">"content"</code> <code class="o">:</code> <code class="s2">"..."</code><code class="p">,</code>
    <code class="s2">"comments"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
            <code class="s2">"email"</code> <code class="o">:</code> <code class="s2">"joe@example.com"</code><code class="p">,</code>
            <code class="s2">"content"</code> <code class="o">:</code> <code class="s2">"nice post."</code>
        <code class="p">},</code>
        <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"bob"</code><code class="p">,</code>
            <code class="s2">"email"</code> <code class="o">:</code> <code class="s2">"bob@example.com"</code><code class="p">,</code>
            <code class="s2">"content"</code> <code class="o">:</code> <code class="s2">"good post."</code>
        <code class="p">}</code>
    <code class="p">]</code>
<code class="p">}</code></pre><p>This is the “simple” form of <code>"push"</code>, but you can use it for more
          complex array operations as well. The MongoDB query language
          provides modifiers for some operators, including <code>"$push"</code>. You can push multiple values in
          one operation using<a data-type="indexterm" data-primary="$each modifier" data-primary-sortas="each modifier" id="idm45882385692968"/> the <code>"$each"</code>
          modifer for <code>"$push"</code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">stock</code><code class="p">.</code><code class="nx">ticker</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"GOOG"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$push"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"hourly"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"$each"</code> <code class="o">:</code> <code class="p">[</code><code class="mf">562.776</code><code class="p">,</code> <code class="mf">562.790</code><code class="p">,</code> <code class="mf">559.123</code><code class="p">]}}})</code></pre><p>This would push three new elements onto the array.</p><p>If<a data-type="indexterm" data-primary="$slice modifier" data-primary-sortas="slice modifier" id="idm45882385460936"/> you only want the array to grow to a certain length,
          you can use the <code>"$slice"</code> modifier
          with <code>"$push"</code> to prevent an array
          from growing beyond a certain size, effectively making a “top N”
          list of items:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"genre"</code> <code class="o">:</code> <code class="s2">"horror"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$push"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"top10"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"$each"</code> <code class="o">:</code> <code class="p">[</code><code class="s2">"Nightmare on Elm Street"</code><code class="p">,</code> <code class="s2">"Saw"</code><code class="p">],</code>
<code class="p">...</code>                        <code class="s2">"$slice"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">10</code><code class="p">}}})</code></pre><p>This example limits the array to the last 10 elements
          pushed.</p><p>If the array is smaller than 10 elements (after the push), all
          elements will be kept. If the array is larger than 10 elements, only
          the last 10 elements will be kept. Thus, <code>"$slice"</code> can be used to create a queue in
          a document.</p><p>Finally, you<a data-type="indexterm" data-primary="$sort modifier" data-primary-sortas="sort modifier" id="idm45882385421448"/> can apply the <code>"$sort"</code> modifier to <code>"$push"</code> operations before trimming:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">movies</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"genre"</code> <code class="o">:</code> <code class="s2">"horror"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$push"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"top10"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"$each"</code> <code class="o">:</code> <code class="p">[{</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Nightmare on Elm Street"</code><code class="p">,</code>
<code class="p">...</code>                                    <code class="s2">"rating"</code> <code class="o">:</code> <code class="mf">6.6</code><code class="p">},</code>
<code class="p">...</code>                                   <code class="p">{</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Saw"</code><code class="p">,</code> <code class="s2">"rating"</code> <code class="o">:</code> <code class="mf">4.3</code><code class="p">}],</code>
<code class="p">...</code>                        <code class="s2">"$slice"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">10</code><code class="p">,</code>
<code class="p">...</code>                        <code class="s2">"$sort"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"rating"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">}}}})</code></pre><p>This will sort all of the objects in the array by their
          <code>"rating"</code> field and then keep the
          first 10. Note that you must include <code>"$each"</code>; you cannot just <code>"$slice"</code> or <code>"$sort"</code> an array with <code>"$push"</code>.</p></div></section><section data-type="sect4" data-pdf-bookmark="Using arrays as sets"><div class="sect4" id="idm45882385814408"><h4>Using arrays as sets</h4><p>You<a data-type="indexterm" data-primary="$ne operator" data-primary-sortas="ne operator" id="idm45882385269224"/><a data-type="indexterm" data-primary="array operators" data-secondary="using arrays as sets" id="idm45882385268088"/> might want to treat an array as a set, only adding
          values if they are not present. This can be done using <code>"$ne"</code> in the query document. For example,
          to push an author onto a list of citations, but only if they aren’t
          already there, use the following:</p><pre id="I_programlisting3_d1e2913" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">papers</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"authors cited"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"$ne"</code> <code class="o">:</code> <code class="s2">"Richie"</code><code class="p">}},</code>
<code class="p">...</code> <code class="p">{</code><code class="nx">$push</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"authors cited"</code> <code class="o">:</code> <code class="s2">"Richie"</code><code class="p">}})</code></pre><p>This<a data-type="indexterm" data-primary="$addToSet operator" data-primary-sortas="addToSet operator" id="idm45882385174696"/> can also be done with <code>"$addToSet"</code>, which is useful for cases
          where <code>"$ne"</code> won’t work or where
          <code>"$addToSet"</code> describes what is
          happening better.</p><p>For example, suppose you have a document that represents a
          user. You might have a set of email addresses that they have
          added:</p><pre id="I_programlisting3_d1e2944" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">)})</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">),</code>
    <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
    <code class="s2">"emails"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="s2">"joe@example.com"</code><code class="p">,</code>
        <code class="s2">"joe@gmail.com"</code><code class="p">,</code>
        <code class="s2">"joe@yahoo.com"</code>
    <code class="p">]</code>
<code class="p">}</code></pre><p>When<a data-type="indexterm" data-primary="duplicates" data-secondary="preventing in arrays" id="idm45882385090584"/><a data-type="indexterm" data-primary="array operators" data-secondary="preventing duplicates" id="idm45882385132152"/> adding another address, you can use “<code>$addToSet"</code> to prevent duplicates:</p><pre id="I_programlisting3_d1e2951" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">)},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$addToSet"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"emails"</code> <code class="o">:</code> <code class="s2">"joe@gmail.com"</code><code class="p">}})</code>
<code class="p">{</code> <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"matchedCount"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"modifiedCount"</code> <code class="o">:</code> <code class="mi">0</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">)})</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">),</code>
    <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
    <code class="s2">"emails"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="s2">"joe@example.com"</code><code class="p">,</code>
        <code class="s2">"joe@gmail.com"</code><code class="p">,</code>
        <code class="s2">"joe@yahoo.com"</code><code class="p">,</code>
    <code class="p">]</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">)},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$addToSet"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"emails"</code> <code class="o">:</code> <code class="s2">"joe@hotmail.com"</code><code class="p">}})</code>
<code class="p">{</code> <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"matchedCount"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"modifiedCount"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">)})</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">),</code>
    <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
    <code class="s2">"emails"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="s2">"joe@example.com"</code><code class="p">,</code>
        <code class="s2">"joe@gmail.com"</code><code class="p">,</code>
        <code class="s2">"joe@yahoo.com"</code><code class="p">,</code>
        <code class="s2">"joe@hotmail.com"</code>
    <code class="p">]</code>
<code class="p">}</code></pre><p>You<a data-type="indexterm" data-primary="array operators" data-secondary="adding multiple unique values" id="idm45882385127848"/> can also use <code>"$addToSet"</code> in conjunction with <code>"$each"</code> to add multiple unique values,
          which cannot be done with the <code>"$ne"</code>/<code>"$push"</code> combination. For instance, you
          could use these operators if the user wanted to add more than one
          email address:</p><pre id="I_programlisting3_d1e2977" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">)},</code> 
<code class="p">...</code> <code class="p">{</code><code class="s2">"$addToSet"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"emails"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"$each"</code> <code class="o">:</code>
<code class="p">...</code>     <code class="p">[</code><code class="s2">"joe@php.net"</code><code class="p">,</code> <code class="s2">"joe@example.com"</code><code class="p">,</code> <code class="s2">"joe@python.org"</code><code class="p">]}}})</code>
<code class="p">{</code> <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"matchedCount"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"modifiedCount"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">)})</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">),</code>
    <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"joe"</code><code class="p">,</code>
    <code class="s2">"emails"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="s2">"joe@example.com"</code><code class="p">,</code>
        <code class="s2">"joe@gmail.com"</code><code class="p">,</code>
        <code class="s2">"joe@yahoo.com"</code><code class="p">,</code>
        <code class="s2">"joe@hotmail.com"</code>
        <code class="s2">"joe@php.net"</code>
        <code class="s2">"joe@python.org"</code>
    <code class="p">]</code>
<code class="p">}</code></pre></div></section><section data-type="sect4" data-pdf-bookmark="Removing elements"><div class="sect4" id="idm45882385128072"><h4>Removing elements</h4><p>There<a data-type="indexterm" data-primary="array operators" data-secondary="removing elements" id="idm45882384706248"/> are a few ways to remove elements from an array. If
          you want to treat the array like a queue or a stack, you
          can<a data-type="indexterm" data-primary="$pop operator" data-primary-sortas="pop operator" id="idm45882384917512"/> use <code>"$pop"</code>, which
          can remove elements from either end. <code>{"$pop" : {"<em><code>key</code></em>" :
          1}}</code> removes an element from the end of the array. <code>{"$pop" : {"<em><code>key</code></em>" :
          -1}}</code> removes it from the beginning.</p><p>Sometimes an element should be removed based on specific
          criteria, rather than its position in the array. <code>"$pull"</code> is<a data-type="indexterm" data-primary="$pull operator" data-primary-sortas="pull operator" id="idm45882384877864"/> used to remove elements of an array that match the
          given criteria. For example, suppose we have a list of things that
          need to be done, but not in any specific order:</p><pre id="I_programlisting3_d1e3031" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">lists</code><code class="p">.</code><code class="nx">insertOne</code><code class="p">({</code><code class="s2">"todo"</code> <code class="o">:</code> <code class="p">[</code><code class="s2">"dishes"</code><code class="p">,</code> <code class="s2">"laundry"</code><code class="p">,</code> <code class="s2">"dry cleaning"</code><code class="p">]})</code></pre><p>If we do the laundry first, we can remove it from the list
          with the following:</p><pre id="I_programlisting3_d1e3035" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">lists</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({},</code> <code class="p">{</code><code class="s2">"$pull"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"todo"</code> <code class="o">:</code> <code class="s2">"laundry"</code><code class="p">}})</code></pre><p>Now if we do a find, we’ll see that there are only two
          elements remaining in the array:</p><pre id="I_programlisting3_d1e3040" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">lists</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b2d75476cc613d5ee930164"</code><code class="p">),</code>
    <code class="s2">"todo"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="s2">"dishes"</code><code class="p">,</code>
        <code class="s2">"dry cleaning"</code>
    <code class="p">]</code>
<code class="p">}</code></pre><p>Pulling removes all matching documents, not just a single
          match. If you have an array that looks like <code>[1, 1, 2, 1]</code> and pull <code>1</code>, you’ll end up with a single-element
          array, <code>[2]</code>.</p><p>Array operators can be used only on keys with array values.
          For example, you cannot push onto an integer or pop off of a string.
          Use <code>"$set"</code> or <code>"$inc"</code> to modify scalar values.</p></div></section><section data-type="sect4" data-pdf-bookmark="Positional array modifications"><div class="sect4" id="idm45882384668456"><h4>Positional array modifications</h4><p>Array manipulation<a data-type="indexterm" data-primary="array operators" data-secondary="positional array modifications" id="idm45882384649976"/> becomes a little trickier when you have multiple
          values in an array and want to modify some of them. There are two
          ways to manipulate values in arrays: by position or by using
          the<a data-type="indexterm" data-primary="position operator ($)" id="idm45882384648424"/><a data-type="indexterm" data-primary="$ (dollar sign)" data-secondary="position operator" id="idm45882384647592"/> position operator (the <code>$</code> character).</p><p>Arrays use 0-based indexing, and elements can be selected as
          though their index were a document key. For example, suppose we have
          a document containing an array with a few embedded documents, such
          as a blog post with comments:</p><pre id="I_programlisting3_d1e3088" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">posts</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b329a216cc613d5ee930192"</code><code class="p">),</code>
    <code class="s2">"content"</code> <code class="o">:</code> <code class="s2">"..."</code><code class="p">,</code>
    <code class="s2">"comments"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
            <code class="s2">"comment"</code> <code class="o">:</code> <code class="s2">"good post"</code><code class="p">,</code>
            <code class="s2">"author"</code> <code class="o">:</code> <code class="s2">"John"</code><code class="p">,</code>
            <code class="s2">"votes"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">},</code>
        <code class="p">{</code>
            <code class="s2">"comment"</code> <code class="o">:</code> <code class="s2">"i thought it was too short"</code><code class="p">,</code>
            <code class="s2">"author"</code> <code class="o">:</code> <code class="s2">"Claire"</code><code class="p">,</code>
            <code class="s2">"votes"</code> <code class="o">:</code> <code class="mi">3</code>
        <code class="p">},</code>
        <code class="p">{</code>
            <code class="s2">"comment"</code> <code class="o">:</code> <code class="s2">"free watches"</code><code class="p">,</code>
            <code class="s2">"author"</code> <code class="o">:</code> <code class="s2">"Alice"</code><code class="p">,</code>
            <code class="s2">"votes"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">5</code>
        <code class="p">},</code>
        <code class="p">{</code>
            <code class="s2">"comment"</code> <code class="o">:</code> <code class="s2">"vacation getaways"</code><code class="p">,</code>
            <code class="s2">"author"</code> <code class="o">:</code> <code class="s2">"Lynn"</code><code class="p">,</code>
            <code class="s2">"votes"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">7</code>
        <code class="p">}</code>
    <code class="p">]</code>
<code class="p">}</code></pre><p>If we want to increment the number of votes for the first
          comment, we can say the following:</p><pre id="I_programlisting3_d1e3092" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"post"</code> <code class="o">:</code> <code class="nx">post_id</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$inc"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"comments.0.votes"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">}})</code></pre><p>In many cases, though, we don’t know what index of the array
          to modify without querying for the document first and examining it.
          To get around this, MongoDB has a positional operator, <code>$</code>, that figures out which element of the
          array the query document matched and updates that element. For
          example, if we have a user named John who updates his name to Jim,
          we can replace it in the comments by using the positional
          operator:</p><pre id="I_programlisting3_d1e3099" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"comments.author"</code> <code class="o">:</code> <code class="s2">"John"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"comments.$.author"</code> <code class="o">:</code> <code class="s2">"Jim"</code><code class="p">}})</code></pre><p>The positional operator updates only the first match. Thus, if
          John had left more than one comment, his name would be changed only
          for the first comment he left.</p></div></section><section data-type="sect4" data-pdf-bookmark="Updates using array filters"><div class="sect4" id="idm45882384493784"><h4>Updates using array filters</h4><p>MongoDB 3.6 introduced<a data-type="indexterm" data-primary="array operators" data-secondary="updates using array filters" id="idm45882384492904"/> another option for updating individual array
          elements: <code>arrayFilters</code>. This
          option enables us to modify array elements matching particular
          critera. For example, if we want to hide all comments with five or
          more down votes, we can do something like the
          following:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">(</code>
   <code class="p">{</code><code class="s2">"post"</code> <code class="o">:</code> <code class="nx">post_id</code> <code class="p">},</code>
   <code class="p">{</code> <code class="nx">$set</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"comments.$[elem].hidden"</code> <code class="o">:</code> <code class="kc">true</code> <code class="p">}</code> <code class="p">},</code>
   <code class="p">{</code>
     <code class="nx">arrayFilters</code><code class="o">:</code> <code class="p">[</code> <code class="p">{</code> <code class="s2">"elem.votes"</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$lte</code><code class="o">:</code> <code class="o">-</code><code class="mi">5</code> <code class="p">}</code> <code class="p">}</code> <code class="p">]</code>
   <code class="p">}</code>
<code class="p">)</code></pre><p>This command defines <code class="varname">elem</code> as the identifier
          for each matching element in the <code>"comments"</code> array. If the <code>votes</code> value for the comment identified by
          <code class="varname">elem</code> is less than or equal to <code>-5</code>, we will add a field called <code>"hidden"</code> to the <code>"comments"</code> document and set its
          value<a data-type="indexterm" data-startref="Aman03" id="idm45882384357624"/><a data-type="indexterm" data-startref="UOarray03" id="idm45882384356792"/><a data-type="indexterm" data-startref="Uoper03" id="idm45882384355960"/> to <code>true</code>.</p></div></section></div></section></div></section><section data-type="sect2" data-pdf-bookmark="Upserts"><div class="sect2" id="sect2_d1e3063"><h2>Upserts</h2><p>An<a data-type="indexterm" data-primary="upserts" id="idm45882384353256"/><a data-type="indexterm" data-primary="updates" data-secondary="using upserts" id="idm45882384352392"/> <em>upsert</em> is a special type of update.
      If no document is found that matches the filter, a new document will be
      created by combining the criteria and updated documents. If a matching
      document is found, it will be updated normally. Upserts can be handy
      because they can eliminate the need to “seed” your collection: you can
      often have the same code create and update documents.</p><p>Let’s go back to our example that records the number of views for
      each page of a website. Without an upsert, we might try to find the URL
      and increment the number of views or create a new document if the URL
      doesn’t exist. If we were to write this out as a JavaScript program it
      might look something like the following:</p><pre id="I_programlisting3_d1e3184" data-type="programlisting" data-code-language="javascript"><code class="c1">// check if we have an entry for this page</code>
<code class="nx">blog</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">analytics</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code><code class="nx">url</code> <code class="o">:</code> <code class="s2">"/blog"</code><code class="p">})</code>

<code class="c1">// if we do, add one to the number of views and save</code>
<code class="k">if</code> <code class="p">(</code><code class="nx">blog</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">blog</code><code class="p">.</code><code class="nx">pageviews</code><code class="o">++</code><code class="p">;</code>
  <code class="nx">db</code><code class="p">.</code><code class="nx">analytics</code><code class="p">.</code><code class="nx">save</code><code class="p">(</code><code class="nx">blog</code><code class="p">);</code>
<code class="p">}</code>
<code class="c1">// otherwise, create a new document for this page</code>
<code class="k">else</code> <code class="p">{</code>
  <code class="nx">db</code><code class="p">.</code><code class="nx">analytics</code><code class="p">.</code><code class="nx">insertOne</code><code class="p">({</code><code class="nx">url</code> <code class="o">:</code> <code class="s2">"/blog"</code><code class="p">,</code> <code class="nx">pageviews</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code>
<code class="p">}</code></pre><p>This means we are making a round trip to the database, plus
      sending an update or insert, every time someone visits a page. If we are
      running this code in multiple processes, we are also subject to a race
      condition where more than one document can be inserted for a given
      URL.</p><p>We can eliminate the race condition and cut down the amount of
      code by just sending an upsert to the database (the third parameter to
      <code class="function">updateOne</code><a data-type="indexterm" data-primary="updateOne method" id="idm45882384264296"/> and <code class="function">updateMany<a data-type="indexterm" data-primary="updateMany method" id="idm45882384262872"/></code> is an options document that enables us to
      specify this):</p><pre id="I_programlisting3_d1e3193" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">analytics</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"url"</code> <code class="o">:</code> <code class="s2">"/blog"</code><code class="p">},</code> <code class="p">{</code><code class="s2">"$inc"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"pageviews"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">}},</code> 
<code class="p">...</code> <code class="p">{</code><code class="s2">"upsert"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">})</code></pre><p>This line does exactly what the previous code block does, except
      it’s faster and atomic! The new document is created by using the
      criteria document as a base and applying any modifier documents to
      it.</p><p>For example, if you do an upsert that matches a key and increments
      to the value of that key, the increment will be applied to the
      match:</p><pre id="I_programlisting3_d1e3197" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"rep"</code> <code class="o">:</code> <code class="mi">25</code><code class="p">},</code> <code class="p">{</code><code class="s2">"$inc"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"rep"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">}},</code> <code class="p">{</code><code class="s2">"upsert"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">})</code>
<code class="nx">WriteResult</code><code class="p">({</code>
    <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="s2">"matchedCount"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"modifiedCount"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"upsertedId"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5a93b07aaea1cb8780a4cf72"</code><code class="p">)</code>
<code class="p">})</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5727b2a7223502483c7f3acd"</code><code class="p">)}</code> <code class="p">)</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5727b2a7223502483c7f3acd"</code><code class="p">),</code> <code class="s2">"rep"</code> <code class="o">:</code> <code class="mi">28</code> <code class="p">}</code></pre><p>The upsert creates a new document with a <code>"rep"</code> of <code>25</code>
      and then increments that by 3, giving us a document where <code>"rep"</code> is <code>28</code>. If the upsert option were not specified,
      <code>{"rep" : 25}</code> would not match any
      documents, so nothing would happen.</p><p>If we run the upsert again (with the criterion <code>{"rep" : 25}</code>), it will create another new
      document. This is because the criterion does not match the only document
      in the collection. (Its <code>"rep"</code> is
      <code>28</code>.)</p><p>Sometimes a field needs to be set when a document is created, but
      not changed on subsequent updates. This is what <code>"$setOnInsert<a data-type="indexterm" data-primary="$setOnInsert&#10;          modifier" data-primary-sortas="setOnInsert modifier" id="idm45882384079208"/>"</code> is for. <code>"$setOnInsert"</code> is an operator that only sets
      the value of a field when the document is being inserted. Thus, we could
      do something like this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({},</code> <code class="p">{</code><code class="s2">"$setOnInsert"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"createdAt"</code> <code class="o">:</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">()}},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"upsert"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="s2">"matchedCount"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"modifiedCount"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"upsertedId"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5727b4ac223502483c7f3ace"</code><code class="p">)</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5727b4ac223502483c7f3ace"</code><code class="p">),</code>
    <code class="s2">"createdAt"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2016-05-02T20:12:28.640Z"</code><code class="p">)</code>
<code class="p">}</code></pre><p>If we run this update again, it will match the existing document,
      nothing will be inserted, and so the <code>"createdAt"</code> field will not be changed:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({},</code> <code class="p">{</code><code class="s2">"$setOnInsert"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"createdAt"</code> <code class="o">:</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">()}},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"upsert"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">})</code>
<code class="p">{</code> <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"matchedCount"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"modifiedCount"</code> <code class="o">:</code> <code class="mi">0</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5727b4ac223502483c7f3ace"</code><code class="p">),</code>
    <code class="s2">"createdAt"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2016-05-02T20:12:28.640Z"</code><code class="p">)</code>
<code class="p">}</code></pre><p>Note that you generally do not need to keep a <code>"createdAt"</code> field, as <code>ObjectId</code>s contain a timestamp of when the
      document was created. However, <code>"$setOnInsert"</code> can be useful for creating
      padding, initializing counters, and for collections that do not use
      <code>ObjectId</code>s.</p><section data-type="sect3" data-pdf-bookmark="The save shell helper"><div class="sect3" id="sect3_d1e3129"><h3>The save shell helper</h3><p><code class="function">save<a data-type="indexterm" data-primary="mongo shell" data-secondary="save shell helper" id="idm45882383928344"/></code><a data-type="indexterm" data-primary="save shell helper" id="idm45882383884712"/> is a shell function that lets you insert a document if
        it doesn’t exist and update it if it does. It takes one argument: a
        document. If the document contains an <code>"_id"</code> key, <code class="function">save</code> will do an upsert. Otherwise, it will
        do an insert. <code>save</code> is really just a
        convenience function so that programmers can quickly modify documents
        in the shell:</p><pre id="I_programlisting3_d1e3248" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">testcol</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="o">&gt;</code> <code class="nx">x</code><code class="p">.</code><code class="nx">num</code> <code class="o">=</code> <code class="mi">42</code>
<code class="mi">42</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">testcol</code><code class="p">.</code><code class="nx">save</code><code class="p">(</code><code class="nx">x</code><code class="p">)</code></pre><p>Without <code class="function">save</code>, the last line
        would have been more<a data-type="indexterm" data-startref="Dupdate03" id="idm45882383803240"/> cumbersome:</p><pre data-type="programlisting">db.testcol.replaceOne({"_id" : x._id}, x)</pre></div></section></div></section><section data-type="sect2" data-pdf-bookmark="Updating Multiple Documents"><div class="sect2" id="sect2_d1e3162"><h2>Updating Multiple Documents</h2><p>So<a data-type="indexterm" data-primary="documents" data-secondary="updating multiple" id="idm45882383800616"/><a data-type="indexterm" data-primary="updates" data-secondary="multiple documents" id="idm45882383799480"/> far in this chapter we have used <code class="function">updateOne</code> to illustrate update operations.
      <span class="keep-together"><code class="function">updateOne</code> updates</span> only the first
      document found that matches the filter criteria. If there are more
      matching documents, they will remain unchanged. To modify all of the
      documents matching a filter, use <code class="function">updateMany<a data-type="indexterm" data-primary="updateMany method" id="idm45882383858840"/></code>. <code class="function">updateMany</code> follows the same semantics as
      <code class="function">updateOne</code> and takes the same
      parameters. The key difference is in the number of documents that might
      be changed.</p><p><code class="function">updateMany</code> provides a
      powerful tool for performing schema migrations or rolling out new
      features to certain users. Suppose, for example, we want to give a gift
      to every user who has a birthday on a certain day. We can use <code class="function">updateMany</code> to add a <code>"gift"</code> to their accounts. For example:</p><pre id="I_programlisting3_d1e3289" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">insertMany</code><code class="p">([</code>
<code class="p">...</code> <code class="p">{</code><code class="nx">birthday</code><code class="o">:</code> <code class="s2">"10/13/1978"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="nx">birthday</code><code class="o">:</code> <code class="s2">"10/13/1978"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="nx">birthday</code><code class="o">:</code> <code class="s2">"10/13/1978"</code><code class="p">}])</code>
<code class="p">{</code>
    <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="s2">"insertedIds"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5727d6fc6855a935cb57a65b"</code><code class="p">),</code>
        <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5727d6fc6855a935cb57a65c"</code><code class="p">),</code>
        <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5727d6fc6855a935cb57a65d"</code><code class="p">)</code>
    <code class="p">]</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">updateMany</code><code class="p">({</code><code class="s2">"birthday"</code> <code class="o">:</code> <code class="s2">"10/13/1978"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"gift"</code> <code class="o">:</code> <code class="s2">"Happy Birthday!"</code><code class="p">}})</code>
<code class="p">{</code> <code class="s2">"acknowledged"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"matchedCount"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="s2">"modifiedCount"</code> <code class="o">:</code> <code class="mi">3</code> <code class="p">}</code></pre><p>The call to <code class="function">updateMany</code> adds a
      <code>"gift"</code> field to each of the three
      documents we inserted into the <em>users</em> collection
      immediately before.</p></div></section><section data-type="sect2" data-pdf-bookmark="Returning Updated Documents"><div class="sect2" id="sect2_d1e3233"><h2>Returning Updated Documents</h2><p>For<a data-type="indexterm" data-primary="documents" data-secondary="returning updated" id="Dreturn03"/><a data-type="indexterm" data-primary="updates" data-secondary="returning updated documents" id="idm45882383698632"/> some use cases it is important to return the document
      modified. In earlier versions of MongoDB, <code class="function">findAndModify</code><a data-type="indexterm" data-primary="findAndModify method" id="idm45882383696664"/> was the method of choice in such situations. It is handy
      for manipulating queues and performing other operations that need
      get-and-set−style atomicity. However, <code class="function">findAndModify</code> is prone to user error because
      it’s a complex method combining the functionality of three different
      types of operations: delete, replace, and update (including
      upserts).</p><p>MongoDB 3.2 introduced three new collection methods to the shell
      to accommodate the functionality of <code class="function">findAndModify</code>, but with semantics that are
      easier to learn and remember: <code class="function">findOneAndDelete<a data-type="indexterm" data-primary="findOneAndDelete method" id="idm45882383692728"/></code>, <code class="function">findOneAndReplace<a data-type="indexterm" data-primary="findOneAndReplace method" id="idm45882383691176"/></code>, and <code class="function">findOneAndUpdate<a data-type="indexterm" data-primary="findOneAndUpdate method" id="idm45882383689656"/></code>. The primary difference between these methods
      and, for example, <code class="function">updateOne</code> is that
      they enable you to atomically get the value of a modified document.
      MongoDB 4.2 extended <code class="function">findOneAndUpdate</code> to accept an
      aggregation pipeline for the update. The pipeline can consist of the
      following stages: <code>$addFields</code> and its alias
      <code>$set</code>, <code>$project</code> and its alias
      <code>$unset</code>, and <code>$replaceRoot</code> and its
      alias <code>$replaceWith</code>.</p><p>Suppose we have a collection of processes run in a certain order.
      Each is represented with a document that has the following form:</p><pre id="I_programlisting3_d1e3357" data-type="programlisting" data-code-language="javascript">{
    "_id" : ObjectId(),
    "status" : "<em><code>state</code></em>",
    "priority" : <em><code>N</code></em>
}</pre><p><code>"status"</code> is a string that can
      be <code>"READY"</code>, <code>"RUNNING"</code>, or <code>"DONE"</code>. We need to find the job with the
      highest priority in the <code>"READY"</code>
      state, run the process function, and then update the status to <code>"DONE"</code>. We might try querying for the ready
      processes, sorting by priority, and updating the status of the
      highest-priority process to mark it as <span class="keep-together"><code>"RUNNING"</code>.
      Once</span> we have processed it, we update the status to <code>"DONE"</code>. This looks something like the
      following:</p><pre id="I_programlisting3_d1e3377" data-type="programlisting" data-code-language="javascript"><code class="kd">var</code> <code class="nx">cursor</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">processes</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"READY"</code><code class="p">});</code>
<code class="nx">ps</code> <code class="o">=</code> <code class="nx">cursor</code><code class="p">.</code><code class="nx">sort</code><code class="p">({</code><code class="s2">"priority"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">}).</code><code class="nx">limit</code><code class="p">(</code><code class="mi">1</code><code class="p">).</code><code class="nx">next</code><code class="p">();</code>
<code class="nx">db</code><code class="p">.</code><code class="nx">processes</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ps</code><code class="p">.</code><code class="nx">_id</code><code class="p">},</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"RUNNING"</code><code class="p">}});</code>
<code class="nx">do_something</code><code class="p">(</code><code class="nx">ps</code><code class="p">);</code>
<code class="nx">db</code><code class="p">.</code><code class="nx">processes</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ps</code><code class="p">.</code><code class="nx">_id</code><code class="p">},</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"DONE"</code><code class="p">}});</code></pre><p>This algorithm isn’t great because it is subject to a race
      condition. Suppose we have two threads running. If one thread (call it
      A) retrieved the document and another thread (call it B) retrieved the
      same document before A had updated its status to <span class="keep-together"><code>"RUNNING"</code>,
      then</span> both threads would be running the same process. We can
      avoid this by checking the result as part of the update query, but this
      becomes complex:</p><pre id="I_programlisting3_d1e3381" data-type="programlisting" data-code-language="javascript"><code class="kd">var</code> <code class="nx">cursor</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">processes</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"READY"</code><code class="p">});</code>
<code class="nx">cursor</code><code class="p">.</code><code class="nx">sort</code><code class="p">({</code><code class="s2">"priority"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">}).</code><code class="nx">limit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
<code class="k">while</code> <code class="p">((</code><code class="nx">ps</code> <code class="o">=</code> <code class="nx">cursor</code><code class="p">.</code><code class="nx">next</code><code class="p">())</code> <code class="o">!=</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">processes</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ps</code><code class="p">.</code><code class="nx">_id</code><code class="p">,</code> <code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"READY"</code><code class="p">},</code>
                              <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"RUNNING"</code><code class="p">}});</code>

    <code class="k">if</code> <code class="p">(</code><code class="nx">result</code><code class="p">.</code><code class="nx">modifiedCount</code> <code class="o">===</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">do_something</code><code class="p">(</code><code class="nx">ps</code><code class="p">);</code>
        <code class="nx">db</code><code class="p">.</code><code class="nx">processes</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ps</code><code class="p">.</code><code class="nx">_id</code><code class="p">},</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"DONE"</code><code class="p">}});</code>
        <code class="k">break</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">cursor</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">processes</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"READY"</code><code class="p">});</code>
    <code class="nx">cursor</code><code class="p">.</code><code class="nx">sort</code><code class="p">({</code><code class="s2">"priority"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">}).</code><code class="nx">limit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
<code class="p">}</code></pre><p>Also, depending on timing, one thread may end up doing all the
      work while another thread uselessly trails it. Thread A could always
      grab the process, and then B would try to get the same process, fail,
      and leave A to do all the work.</p><p>Situations like this are perfect for <code>findOneAndUpdate</code>. <code>findOneAndUpdate</code> can return the item and
      update it in a single operation. In this case, it looks like the
      following:</p><pre id="I_programlisting3_d1e3391" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">processes</code><code class="p">.</code><code class="nx">findOneAndUpdate</code><code class="p">({</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"READY"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"RUNNING"</code><code class="p">}},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"sort"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"priority"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">}})</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b3e7a18005cab32be6291f7"</code><code class="p">),</code>
    <code class="s2">"priority"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"READY"</code>
<code class="p">}</code></pre><p>Notice that the status is still <code>"READY"</code> in the returned document because the
      <span class="keep-together"><code>findOneAndUpdate</code> method</span> defaults to
      returning the state of the document before it was modified. It will
      return the updated document if we set the <code>"returnNewDocument"</code> field in the options
      document to <code>true</code>. An options document
      is passed as the third parameter to <code>findOneAndUpdate</code>:</p><pre id="I_programlisting3_d1e3396" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">processes</code><code class="p">.</code><code class="nx">findOneAndUpdate</code><code class="p">({</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"READY"</code><code class="p">},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"RUNNING"</code><code class="p">}},</code>
<code class="p">...</code> <code class="p">{</code><code class="s2">"sort"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"priority"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">},</code>
<code class="p">...</code>  <code class="s2">"returnNewDocument"</code><code class="o">:</code> <code class="kc">true</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b3e7a18005cab32be6291f7"</code><code class="p">),</code>
    <code class="s2">"priority"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"RUNNING"</code>
<code class="p">}</code></pre><p>Thus, the program becomes the following:</p><pre id="I_programlisting3_d1e3403" data-type="programlisting" data-code-language="javascript"><code class="nx">ps</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">processes</code><code class="p">.</code><code class="nx">findOneAndUpdate</code><code class="p">({</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"READY"</code><code class="p">},</code>
                                   <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"RUNNING"</code><code class="p">}},</code>
                                   <code class="p">{</code><code class="s2">"sort"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"priority"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">},</code>
                                    <code class="s2">"returnNewDocument"</code><code class="o">:</code> <code class="kc">true</code><code class="p">})</code>
<code class="nx">do_something</code><code class="p">(</code><code class="nx">ps</code><code class="p">)</code>
<code class="nx">db</code><code class="p">.</code><code class="nx">process</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ps</code><code class="p">.</code><code class="nx">_id</code><code class="p">},</code> <code class="p">{</code><code class="s2">"$set"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"status"</code> <code class="o">:</code> <code class="s2">"DONE"</code><code class="p">}})</code></pre><p>In addition to this one, there are two other methods you should be
      aware of. <span class="keep-together"><code>findOneAndReplace</code> takes</span> the same
      parameters and returns the document matching the filter either before or
      after the replacement, depending on the value of <code>returnNewDocument</code>. <code>findOneAndDelete</code> is similar except it does not
      take an update document as a parameter and has a subset of the options
      of the other two methods. <code>findOneAndDelete</code> returns the deleted<a data-type="indexterm" data-startref="Dreturn03" id="idm45882383109048"/> document.</p></div></section></div></section></div></section></div>



  </body></html>