<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. Performance" class="calibre4"><div class="preface" id="chapter10">
<h1 class="calibre9"><span class="label">Chapter 10. </span>Performance</h1>


<p class="author1">One of us had a computer science lecturer who began one class by saying, “You should never, ever, ever try to optimize your code.<a data-type="indexterm" data-primary="performance" id="ix_prfmc" class="calibre6"/>
But when you do optimize your code, here’s how you should do it.”</p>

<p class="author1">Premature optimization, as Donald Knuth once said, is the root of all evil. It would be best if you first made your code work. Then
make your code maintainable.<a data-type="indexterm" data-primary="optimizations" data-secondary="premature" id="idm46634384321208" class="calibre6"/> And only then—if you have a problem—should you worry about making your code fast. Slow code that works
will always beat fast code that doesn’t.</p>

<p class="author1">That said, there are times when performance can be a significant issue. If your application takes more than a few seconds to load,
you may lose users who will never return. Slow can become unusable on low-powered devices.<a data-type="indexterm" data-primary="performance" data-secondary="essentialist approach to" id="idm46634384319320" class="calibre6"/> This chapter will take what we like to
call an <em class="calibre7">essentialist</em> approach to performance. You should rarely tune your code, but when you do, you should tune the right code.
We look at various tools and techniques that will allow you to track down and measure performance bottlenecks so that if you do need
to apply performance fixes, they will be in the right place, and you will have some way of measuring the difference they make.</p>

<p class="author1">All performance fixes come at a cost. If you make your client code faster, it might cost more memory or more server time.<a data-type="indexterm" data-primary="optimizations" data-secondary="costs of" id="idm46634384316920" class="calibre6"/><a data-type="indexterm" data-primary="performance" data-secondary="fixes, cost of" id="idm46634384315944" class="calibre6"/> You will
almost always have to add more code and more complexity.</p>

<p class="author1">The recipes in this chapter follow the order in which we would suggest you approach performance problems. We begin with high-level
measurements in the browser and look at ways that you can objectively identify performance bottlenecks. If you find a bottleneck, we
will show you how you can use React’s built-in <code class="calibre21">Profiler</code> component to track down the individual components that are the source of the
problem.<a data-type="indexterm" data-primary="Profiler component" id="idm46634384313736" class="calibre6"/> We then look at lower-level and more precise ways of measuring performance down to the sub-millisecond level.</p>

<p class="author1">Only once you can precisely measure performance can you even think about improving the speed of your code.<a data-type="indexterm" data-primary="performance" data-secondary="measuring precisely" id="idm46634384312264" class="calibre6"/></p>

<p class="author1">We then show you just a few ways that you can improve the performance of your application. Some are simple, such as splitting
your code into smaller bundles or combining asynchronous network calls. Others are more complex, such as pre-rendering your pages on
a server.</p>

<p class="author1">In summary: this chapter is far more about performance measurement than performance tuning. Because you should never, ever, ever
optimize your code, but when you do, you should begin with measurement.</p>






<section data-type="sect1" data-pdf-bookmark="Use Browser Performance Tools" class="calibre4"><div class="preface" id="ch10-01">
<h1 class="calibre17">Use Browser Performance Tools</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634384408888">
<h2 class="calibre27">Problem</h2>

<p class="author1">It is worth delaying performance tuning until you know you have a problem.<a data-type="indexterm" data-primary="performance" data-secondary="measuring using browser performance tools" id="ix_prfmcmeabrws" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="using browser performance tools" id="ix_brwsprfto" class="calibre6"/> In a sense, the only time you have a problem is if a user
notices that your application isn’t performing. But if you wait until a user notices, that might be too late. For that reason, it would be helpful to have some objective measure for when an application needs tuning, something that realistically measures performance and isn’t just looking for code that could run faster. You can almost always make code faster, and many developers have wasted many hours tuning code that results in no noticeable effect on the user experience.</p>

<p class="author1">It would be helpful to have a tool that will focus on where you might need to optimize your code.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634384403592">
<h2 class="calibre27">Solution</h2>

<p class="author1">The best way to check for performance is by using a browser. In the end, the user’s experience is the only thing that matters. So, we
will look at the various in-browser tools that will provide objective measures and find potential bottlenecks in your code.</p>

<p class="author1">The first thing we will look at is a tool built into Chrome called Lighthouse.<a data-type="indexterm" data-primary="performance" data-secondary="measuring using browser performance tools" data-tertiary="Lighthouse" id="idm46634384400280" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="using browser performance tools" data-tertiary="Lighthouse" id="idm46634384399000" class="calibre6"/><a data-type="indexterm" data-primary="Lighthouse" id="ix_Lgths" class="calibre6"/></p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">Google produces an add-in for Firefox called Google Lighthouse. Although this works well, it is simply a frontend for the
Google Page Speed service, so you can use it only on public-facing web pages. However, you can use the Lighthouse extension in
Chrome on any page that Chrome can read.</p>
</div>

<p class="author1">The Lighthouse extension is a great way to check the basic road-worthiness of your application. As well as checking performance,
Lighthouse will look at the accessibility of your web page and whether you are following best practices for the web. It will check
whether your pages are optimized for search engine robots and will look to see if your web application meets the standards required
to consider it a progressive web application (see <a data-type="xref" href="#ch10_image_1" class="calibre6">Figure 10-1</a>).</p>

<figure class="calibre29"><div id="ch10_image_1" class="figure">
<img src="Images/recb_1001.png" alt="" class="calibre173"/>
<h6 class="calibre30"><span class="firstname">Figure 10-1. </span>The metrics checked by Lighthouse</h6>
</div></figure>

<p class="author1">You can run a Lighthouse audit in two ways: either on the command line or in a browser.<a data-type="indexterm" data-primary="browsers" data-secondary="measuring using browser performance tools" data-tertiary="metrics checked by Lighthouse" id="idm46634384391032" class="calibre6"/><a data-type="indexterm" data-primary="performance" data-secondary="using browser performance tools" data-tertiary="metrics checked by Lighthouse" id="idm46634384389688" class="calibre6"/></p>

<p class="author1">If you want to run audits on the<a data-type="indexterm" data-primary="Lighthouse" data-secondary="installing command-line" id="idm46634384388056" class="calibre6"/> command line, you will first need to install the Lighthouse command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install -g lighthouse</code></pre>

<p class="author1">You can then run an audit with the <code class="calibre21">lighthouse</code> command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ lighthouse http://localhost:3000</code></pre>

<p class="author1">The command-line version of Lighthouse is simply an automated script for the Google Chrome browser. It has the advantage that it
generates an HTML report of the audit, which makes it suitable for use on a continuous integration server.</p>

<p class="author1">You can also use Lighthouse interactively, within Google Chrome. It’s best to do this in an incognito window, as this will reduce
the likelihood of other extensions and storage interfering with the Lighthouse audit.<a data-type="indexterm" data-primary="Lighthouse" data-secondary="Lighthouse tab with Chrome DevTools" id="idm46634384383080" class="calibre6"/> Once you have started Chrome and opened your
application, go to developer tools and then switch to the Lighthouse tab (see <a data-type="xref" href="#ch10_image_2" class="calibre6">Figure 10-2</a>).</p>

<figure class="calibre29"><div id="ch10_image_2" class="figure">
<img src="Images/recb_1002.png" alt="" class="calibre174"/>
<h6 class="calibre30"><span class="firstname">Figure 10-2. </span>The Lighthouse tab with Chrome DevTools</h6>
</div></figure>

<p class="author1">Then click the Generate audit button. Lighthouse will refresh your page several times and perform a series of audits.<a data-type="indexterm" data-primary="performance" data-secondary="measuring using browser performance tools" data-tertiary="web vital measured by Lighthouse" id="idm46634384240264" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="using browser performance tools" data-tertiary="web vital measured by Lighthouse" id="idm46634384238968" class="calibre6"/><a data-type="indexterm" data-primary="Lighthouse" data-secondary="web vitals measured by performance audit" id="idm46634384237720" class="calibre6"/><a data-type="indexterm" data-primary="web vitals mesured by Lighthouse" id="idm46634384236744" class="calibre6"/> The
performance audit will concentrate on six different metrics (see <a data-type="xref" href="#ch10_image_3" class="calibre6">Figure 10-3</a>).</p>

<figure class="calibre29"><div id="ch10_image_3" class="figure">
<img src="Images/recb_1003.png" alt="" class="calibre175"/>
<h6 class="calibre30"><span class="firstname">Figure 10-3. </span>The six web vitals measured by the Lighthouse performance audit</h6>
</div></figure>

<p class="author1">These metrics are known as <em class="calibre7">web vitals</em>. The web vitals are metrics that you can use to track performance when applications are
running in production.</p>

<p class="author1">The <em class="calibre7">First Contentful Paint</em> (FCP) is the time taken for the browser to start to render content.<a data-type="indexterm" data-primary="web vitals mesured by Lighthouse" data-secondary="First Contentful Paint (FCP)" id="idm46634384275144" class="calibre6"/><a data-type="indexterm" data-primary="FCP (First Contentful Paint)" id="idm46634384274184" class="calibre6"/><a data-type="indexterm" data-primary="First Contentful Paint (FCP)" id="idm46634384273496" class="calibre6"/> The FCP will significantly affect
the user’s perception of performance. Before the FCP, the user will see only a blank screen, and if this lasts
for too long, the user might close down the browser and go elsewhere.</p>

<p class="author1">Lighthouse measures the time taken for the FCP and then compares that against the performance statistics Google
records globally. If your application is in the top 25% of FCPs globally, it will mark you as green. Currently, a green rating
means that the first content renders within two seconds. If you are within the top 75%, it will give you an orange grade, which means
your page started to render within four seconds. Lighthouse will give anything else a red grade.</p>

<p class="author1">The <em class="calibre7">Speed Index</em> (SI) measures how long it takes until your page stabilizes visually.<a data-type="indexterm" data-primary="SI (Speed Index)" id="idm46634384270712" class="calibre6"/><a data-type="indexterm" data-primary="Speed Index (SI)" id="idm46634384270008" class="calibre6"/><a data-type="indexterm" data-primary="web vitals mesured by Lighthouse" data-secondary="Speed Index (SI)" id="idm46634384269336" class="calibre6"/> It performs this check visually by recording
a video and checking for differences between frames.</p>

<p class="author1">Lighthouse will compare the SI metric to website performance globally. If the SI takes less than 4.3 seconds, you are in the top 25%
of web pages globally, and Lighthouse will give a green rating. If you take less than 5.8 seconds, you will be in the top 75%, and
Lighthouse will give you an orange rating. It will give everything else a red grade.</p>

<p class="author1">The <em class="calibre7">Largest Contentful Paint</em> (LCP) occurs when the browser’s viewport is completely loaded.<a data-type="indexterm" data-primary="LCP (Largest Contentful Paint)" id="idm46634384266520" class="calibre6"/><a data-type="indexterm" data-primary="Largest Contentful Paint (LCP)" id="idm46634384265784" class="calibre6"/><a data-type="indexterm" data-primary="web vitals mesured by Lighthouse" data-secondary="Largest Contentful Paint (LCP)" id="idm46634384265096" class="calibre6"/> Other content might still be loading
out of view, but the LCP is when the user will feel that the page is visible. To be rated green, the LCP needs to be within 2.5
seconds. It needs to be less than 4 seconds for an orange rating. Everything else is rated red. Server-side rendering can
significantly improve the LCP rating.</p>

<p class="author1"><em class="calibre7">Time to interactive</em> (TTI) is how long it takes before you can interact with the page using the mouse and keyboard.<a data-type="indexterm" data-primary="TTI (Time to interactive)" id="idm46634384217656" class="calibre6"/><a data-type="indexterm" data-primary="Time to interactive (TTI)" id="idm46634384217000" class="calibre6"/><a data-type="indexterm" data-primary="web vitals mesured by Lighthouse" data-secondary="Time to interactive (TTI)" id="idm46634384216312" class="calibre6"/> In React, this
happens after the first complete render, when React has attached the event handlers. You want this to be less than 3.8 seconds to
get a green rating. If you can get a TTI of 7.3 or less, you will be rated orange. Everything else is rated red. You can improve the
TTI by deferring the loading of third-party JavaScript or by code splitting.<sup class="calibre34"><a data-type="noteref" id="idm46634384214840-marker" href="ch10.xhtml#idm46634384214840" class="calibre35">1</a></sup></p>

<p class="author1"><em class="calibre7">Total blocking time</em> (TBT) is the sum of all <a data-type="indexterm" data-primary="Total blocking time (TBT)" id="idm46634384212776" class="calibre6"/><a data-type="indexterm" data-primary="TBT (Total blocking time)" id="idm46634384212008" class="calibre6"/><a data-type="indexterm" data-primary="web vitals mesured by Lighthouse" data-secondary="Total blocking time (TBT)" id="idm46634384211320" class="calibre6"/>blocking tasks that occur between the FCP and TTI. A blocking task is anything that takes longer than 50 ms. That’s about how long it takes to display a frame in a
movie, and anything longer than 50 ms starts to become noticeable. If you have too many blocking tasks, the browser will start to
feel like it’s freezing up. For this reason, the grades for TBT cover short periods. If TBT is less than 300 ms, Lighthouse will
grade your page as green. Anything up to 600 ms is orange, and everything else is graded red. A high TBT score will feel to the user
like the browser is being overloaded. TBT is generally improved by running less JavaScript code or reducing the number of scans of
the DOM.<a data-type="indexterm" data-primary="DOM" data-secondary="reducing number of scans to improve TBT" id="idm46634384209496" class="calibre6"/> The most effective technique is probably code splitting.<a data-type="indexterm" data-primary="code splitting" id="idm46634384208408" class="calibre6"/></p>

<p class="author1"><em class="calibre7">Cumulative Layout Shift</em> (CLS) is a measure of the <em class="calibre7">jumpiness</em> or visual stability of your web page.<a data-type="indexterm" data-primary="CLS (Cumulative Layout Shift)" id="idm46634384206520" class="calibre6"/><a data-type="indexterm" data-primary="Cumulative Layout Shift (CLS)" id="idm46634384205752" class="calibre6"/><a data-type="indexterm" data-primary="jumpiness" id="idm46634384205064" class="calibre6"/><a data-type="indexterm" data-primary="web vitals mesured by Lighthouse" data-secondary="Cumulative Layout Shift (CLS)" id="idm46634384204392" class="calibre6"/> If your application inserts
additional content that moves other content around during a page load, this will start to affect the CLS metric. The CLS is the
proportion of the page that moves during loading.</p>

<p class="author1">Not included in the Lighthouse report is the <em class="calibre7">First Input Delay</em> (FID) metric, which is how long it<a data-type="indexterm" data-primary="First Input Delay (FID)" id="idm46634384202264" class="calibre6"/><a data-type="indexterm" data-primary="web vitals mesured by Lighthouse" data-secondary="First Input Delay (FID)" id="idm46634384201560" class="calibre6"/> takes between a user sending an event to the page—such as by clicking a button—and the JavaScript handler receiving the event. You want an FID of no more than 300
ms. The FID is closely related to the TBT because blocking events are typically created by event handlers.</p>

<p class="author1">As well as providing an audit of the primary metrics of your page, the Lighthouse report will also include advice for how to fix any
problems it finds.</p>

<p class="author1">Lighthouse is an excellent starting point when checking for performance issues. It’s not an exhaustive check, but it will highlight
problems that you might not otherwise notice.</p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">Many factors (bandwidth, memory, CPU, and so on) can affect a Lighthouse audit, so expect your results to vary from run
to run.<a data-type="indexterm" data-primary="Lighthouse" data-secondary="many factors affecting performance audit" id="idm46634384197832" class="calibre6"/> Online services such as <a href="https://www.webpagetest.org" class="calibre6">WebPageTest</a> and <a href="https://gtmetrix.com" class="calibre6">GTmetrix</a> can run audits on your
application from various locations around the world, which will give you a more realistic view of your application’s speed than a
Lighthouse audit running against <em class="calibre7">http://localhost:3000</em>.</p>
</div>

<p class="author1">While Lighthouse is good at highlighting the existence of performance problems, it’s less helpful at finding the cause of those
problems. It might be that code for a web page is too large or too slow. It might be that the server is responding sluggishly. It
might even be a resource problem, such as low memory or large cache size.<a data-type="indexterm" data-primary="Lighthouse" data-startref="ix_Lgths" id="idm46634384193640" class="calibre6"/></p>

<p class="author1">To find out <em class="calibre7">why</em> a bottleneck exists, we can next visit the performance tools of the browser itself.<a data-type="indexterm" data-primary="performance" data-secondary="measuring using browser performance tools" data-tertiary="browser Performance tab" id="idm46634384191832" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="using browser performance tools" data-tertiary="Performance tab" id="idm46634384190552" class="calibre6"/></p>

<p class="author1">If you are using Firefox or Chrome, you can get to the performance console by opening your page in an incognito window and then going
to the <a data-type="indexterm" data-primary="Performance tab (in browser DevTools)" id="idm46634384188776" class="calibre6"/>Performance tab in the development tools (see <a data-type="xref" href="#ch10_image_4" class="calibre6">Figure 10-4</a>).</p>

<figure class="calibre29"><div id="ch10_image_4" class="figure">
<img src="Images/recb_1004.png" alt="" class="calibre176"/>
<h6 class="calibre30"><span class="firstname">Figure 10-4. </span>The Performance tab within the browser DevTools</h6>
</div></figure>

<p class="author1">The Performance tab is like the engine management system of the browser. There, you can track the memory usage, any CPU blockers, the number of elements within the DOM, and so on. To gather statistics, you will need to click the Record button on the toolbar and then interact with your page for a few seconds before stopping the recording. The performance system will trace everything you selected. In the example in <a data-type="xref" href="#ch10_image_5" class="calibre6">Figure 10-5</a>, you can see that a blocking operation (see TBT earlier) occurred when the
user clicked a button, and the browser blocked for 60.92 ms until the event handler returned.</p>

<figure class="calibre29"><div id="ch10_image_5" class="figure">
<img src="Images/recb_1005.png" alt="" class="calibre177"/>
<h6 class="calibre30"><span class="firstname">Figure 10-5. </span>Zooming in to investigate a long-running task</h6>
</div></figure>

<p class="author1">The Performance tab gives you all the statistics you are ever likely to want when performance tuning.<a data-type="indexterm" data-primary="Performance tab (in browser DevTools)" data-secondary="investigating long-running task" id="idm46634384180632" class="calibre6"/> It probably has far more
detail than you are ever likely to need.<a data-type="indexterm" data-primary="React Developer Tools" data-secondary="installing in Chrome or Firefox" id="idm46634384179496" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="using browser performance tools" data-tertiary="installing React Developer Tools" id="idm46634384178456" class="calibre6"/> For that reason, you might want to install the React Developer Tools, which are available for <a href="https://oreil.ly/vvCLp" class="calibre6">Chrome</a> and <a href="https://oreil.ly/mw1yn" class="calibre6">Firefox</a>.</p>

<p class="author1">When you install the React Developer Tools, you may find that they cannot run in incognito mode by default. It’s worth enabling them
to have access (see <a data-type="xref" href="#ch10_image_6" class="calibre6">Figure 10-6</a> for Chrome and <a data-type="xref" href="#ch10_image_7" class="calibre6">Figure 10-7</a> for Firefox).</p>

<figure class="calibre29"><div id="ch10_image_6" class="figure">
<img src="Images/recb_1006.png" alt="" class="calibre178"/>
<h6 class="calibre30"><span class="firstname">Figure 10-6. </span>Enabling React Dev Tools in incognito mode in Chrome</h6>
</div></figure>

<figure class="calibre29"><div id="ch10_image_7" class="figure">
<img src="Images/recb_1007.png" alt="" class="calibre179"/>
<h6 class="calibre30"><span class="firstname">Figure 10-7. </span>Enabling React Dev Tools in private mode in Firefox</h6>
</div></figure>

<p class="author1">In a similar way to the browser’s performance tools, the React Developer Tools need you to<a data-type="indexterm" data-primary="browsers" data-secondary="using browser performance tools" data-tertiary="recording performance sessions" id="idm46634384168648" class="calibre6"/> record a performance session by clicking
the Record button in the top left of the developer panel (see <a data-type="xref" href="#ch10_image_8" class="calibre6">Figure 10-8</a>).</p>

<figure class="calibre29"><div id="ch10_image_8" class="figure">
<img src="Images/recb_1008.png" alt="" class="calibre180"/>
<h6 class="calibre30"><span class="firstname">Figure 10-8. </span>The React Profiler tab in Chrome DevTools</h6>
</div></figure>

<p class="author1">Once you have recorded a session, the performance statistics will be displayed and related to the React components that rendered the
web page.<a data-type="indexterm" data-primary="React Developer Tools" data-secondary="installed in browser, performance statistics displayed" id="idm46634384163672" class="calibre6"/> If a component took a long time to display, you can hover over it in the performance results and see it highlighted on the
page (see <a data-type="xref" href="#ch10_image_9" class="calibre6">Figure 10-9</a>).</p>

<p class="author1">The React Developer Tools are often the best interactive tool to identify the underlying cause of a performance issue. But, as ever,
you should consider tuning performance only if a user or some higher-level tool such as Lighthouse discovers that a
performance bottleneck exists.</p>

<figure class="calibre29"><div id="ch10_image_9" class="figure">
<img src="Images/recb_1009.png" alt="" class="calibre181"/>
<h6 class="calibre30"><span class="firstname">Figure 10-9. </span>If you hover over a component in the flamegraph, it will be highlighted on the page</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634384402008">
<h2 class="calibre27">Discussion</h2>

<p class="author1">If you are taking an <em class="calibre7">essentialist</em> approach to performance, you should always begin in the browser, either by using the application
or by using one of the built-in tools or extensions we discuss here.<a data-type="indexterm" data-primary="performance" data-secondary="measuring using browser performance tools" data-startref="ix_prfmcmeabrws" id="idm46634384157976" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="using browser performance tools" data-startref="ix_brwsprfto" id="idm46634384156696" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Track Rendering with Profiler" class="calibre4"><div class="preface" id="ch10-02">
<h1 class="calibre17">Track Rendering with Profiler</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634384153816">
<h2 class="calibre27">Problem</h2>

<p class="author1">Browser tools provide a wealth of performance detail, and they should always be the first place you look to discover the cause of
underlying performance problems.<a data-type="indexterm" data-primary="performance" data-secondary="tracking rendering with Profiler" id="ix_prfctrkrnd" class="calibre6"/><a data-type="indexterm" data-primary="rendering" data-secondary="tracking with Profiler" id="ix_rndtrck" class="calibre6"/><a data-type="indexterm" data-primary="Profiler component" data-secondary="tracking rendering with" id="ix_Prfcmprnd" class="calibre6"/></p>

<p class="author1">Once you have identified a problem, it can be helpful to get more detailed performance statistics for a small part of the application.
The only way to boost performance is by gathering actual performance figures before and after a change. That can be difficult to do
with browser extensions because they will flood you with information about everything.</p>

<p class="author1">How do we get performance statistics for the part of the application we are tuning?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634384147144">
<h2 class="calibre27">Solution</h2>

<p class="author1">We are going to use the React <code class="calibre21">Profiler</code> component. You can wrap the <code class="calibre21">Profiler</code> component around any part of your application that you will
tune. <a data-type="indexterm" data-primary="Profiler component" data-secondary="tracking rendering with" data-tertiary="performance statistics recorded" id="idm46634384144280" class="calibre6"/>It will record performance statistics whenever React renders it and will tell you several vital pieces of information:</p>
<table class="calibre10">

<thead class="calibre11">
<tr class="calibre12">
<th class="calibre13">Statistic</th>
<th class="calibre13">Purpose</th>
</tr>
</thead>
<tbody class="calibre14">
<tr class="calibre12">
<td class="calibre15"><p class="author1">Phase</p></td>
<td class="calibre15"><p class="author1">Whether a mount or an update caused the render</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1">Actual duration</p></td>
<td class="calibre15"><p class="author1">How long the render would take to complete if no internal caching was applied</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1">Base duration</p></td>
<td class="calibre15"><p class="author1">How long the render took with caching</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1">Start time</p></td>
<td class="calibre15"><p class="author1">The number of milliseconds since the page loaded</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1">Commit time</p></td>
<td class="calibre15"><p class="author1">When the results of the render find their way into the browser’s DOM</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1">Interactions</p></td>
<td class="calibre15"><p class="author1">Any event handlers that we are currently tracing</p></td>
</tr>
</tbody>
</table>

<p class="author1">To see how the <code class="calibre21">Profiler</code> component works, let’s start <a data-type="indexterm" data-primary="Calendar application example, tracking rendering with Profiler" id="ix_Calapp" class="calibre6"/><a data-type="indexterm" data-primary="Profiler component" data-secondary="tracking rendering with" data-tertiary="example Calendar application" id="idm46634384128040" class="calibre6"/>to examine the example application you can see in <a data-type="xref" href="#ch10_image_10" class="calibre6">Figure 10-10</a>.</p>

<figure class="calibre29"><div id="ch10_image_10" class="figure">
<img src="Images/recb_1010.png" alt="" class="calibre182"/>
<h6 class="calibre30"><span class="firstname">Figure 10-10. </span>The example Calendar application</h6>
</div></figure>

<p class="author1">This is the code for the <code class="calibre21">App</code> component:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">unstable_trace</code> <code class="nx">as</code> <code class="nx">trace</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'scheduler/tracing'</code>
<code class="kr">import</code> <code class="s">'./App.css'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">({</code> <code class="nx">onRender</code> <code class="go">})</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">year</code><code class="go">,</code> <code class="nx">setYear</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="mi">2023</code><code class="go">)</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Year</code><code class="o">:</code> <code class="go">{</code><code class="nx">year</code><code class="go">}&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">setYear</code><code class="go">((</code><code class="nx">y</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">y</code> <code class="o">-</code> <code class="mi">1</code><code class="go">)}&gt;</code><code class="nx">Previous</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">setYear</code><code class="go">((</code><code class="nx">y</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">y</code> <code class="o">+</code> <code class="mi">1</code><code class="go">)}&gt;</code><code class="nx">Next</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">br</code> <code class="go">/&gt;</code>
      <code class="go">&lt;</code><code class="nt">YearCalendar</code> <code class="na">year</code><code class="o">=</code><code class="go">{</code><code class="nx">year</code><code class="go">}</code> <code class="na">onRender</code><code class="o">=</code><code class="go">{</code><code class="nx">onRender</code><code class="go">}</code> <code class="go">/&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">The application displays two buttons: one for moving forward a year and one for moving back.</p>

<p class="author1">We can begin by wrapping the buttons and the <a data-type="indexterm" data-primary="Profiler component" data-secondary="tracking rendering with" data-tertiary="wrapping Calendar app and buttons in Profiler" id="idm46634384119944" class="calibre6"/>calendar component in a <code class="calibre21">Profiler</code> component:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code><code class="go">,</code> <code class="nx">Profiler</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">unstable_trace</code> <code class="nx">as</code> <code class="nx">trace</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'scheduler/tracing'</code>
<code class="kr">import</code> <code class="s">'./App.css'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">({</code> <code class="nx">onRender</code> <code class="go">})</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">year</code><code class="go">,</code> <code class="nx">setYear</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="mi">2023</code><code class="go">)</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Year</code><code class="o">:</code> <code class="go">{</code><code class="nx">year</code><code class="go">}&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">Profiler</code> <code class="na">id</code><code class="o">=</code><code class="s">"app"</code> <code class="na">onRender</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="go">{}}&gt;</code>
        <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">setYear</code><code class="go">((</code><code class="nx">y</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">y</code> <code class="o">-</code> <code class="mi">1</code><code class="go">)}&gt;</code>
          <code class="nx">Previous</code>
        <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">setYear</code><code class="go">((</code><code class="nx">y</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">y</code> <code class="o">+</code> <code class="mi">1</code><code class="go">)}&gt;</code><code class="nx">Next</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">br</code> <code class="go">/&gt;</code>
        <code class="go">&lt;</code><code class="nt">YearCalendar</code> <code class="na">year</code><code class="o">=</code><code class="go">{</code><code class="nx">year</code><code class="go">}</code> <code class="na">onRender</code><code class="o">=</code><code class="go">{</code><code class="nx">onRender</code><code class="go">}</code> <code class="go">/&gt;</code>
      <code class="go">&lt;/</code><code class="nt">Profiler</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">The <code class="calibre21">Profiler</code> takes an <code class="calibre21">id</code> and a callback function <code class="calibre21">onRender</code>. Each time the <code class="calibre21">Profiler</code> is rendered, it sends back statistics to
the <code class="calibre21">onRender</code> function. <a data-type="indexterm" data-primary="Profiler component" data-secondary="tracking rendering with" data-tertiary="onRender function" id="idm46634383855320" class="calibre6"/><a data-type="indexterm" data-primary="onRender function" id="idm46634383854040" class="calibre6"/>So, let’s fill out the details of the <code class="calibre21">onRender</code> function a little more:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code><code class="go">,</code> <code class="nx">Profiler</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">unstable_trace</code> <code class="nx">as</code> <code class="nx">trace</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'scheduler/tracing'</code>
<code class="kr">import</code> <code class="s">'./App.css'</code>

<code class="kr">let</code> <code class="nx">renders</code> <code class="o">=</code> <code class="go">[]</code>
<code class="kr">let</code> <code class="nx">tracker</code> <code class="o">=</code> <code class="go">(</code>
  <code class="nx">id</code><code class="go">,</code>
  <code class="nx">phase</code><code class="go">,</code>
  <code class="nx">actualDuration</code><code class="go">,</code>
  <code class="nx">baseDuration</code><code class="go">,</code>
  <code class="nx">startTime</code><code class="go">,</code>
  <code class="nx">commitTime</code><code class="go">,</code>
  <code class="nx">interactions</code>
<code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">renders</code><code class="go">.</code><code class="nx">push</code><code class="go">({</code>
    <code class="nx">id</code><code class="go">,</code>
    <code class="nx">phase</code><code class="go">,</code>
    <code class="nx">actualDuration</code><code class="go">,</code>
    <code class="nx">baseDuration</code><code class="go">,</code>
    <code class="nx">startTime</code><code class="go">,</code>
    <code class="nx">commitTime</code><code class="go">,</code>
    <code class="nx">interactions</code><code class="o">:</code> <code class="nx">JSON</code><code class="go">.</code><code class="nx">stringify</code><code class="go">(</code><code class="nb">Array</code><code class="go">.</code><code class="nx">from</code><code class="go">(</code><code class="nx">interactions</code><code class="go">)),</code>
  <code class="go">})</code>
<code class="go">}</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">({</code> <code class="nx">onRender</code> <code class="go">})</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">year</code><code class="go">,</code> <code class="nx">setYear</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="mi">2023</code><code class="go">)</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">....</code>
      <code class="go">&lt;</code><code class="nt">Profiler</code> <code class="na">id</code><code class="o">=</code><code class="s">"app"</code> <code class="na">onRender</code><code class="o">=</code><code class="go">{</code><code class="nx">tracker</code><code class="go">}&gt;</code>
        <code class="go">....</code>
      <code class="go">&lt;/</code><code class="nt">Profiler</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="go">.</code><code class="nx">table</code><code class="go">(</code><code class="nx">renders</code><code class="go">)}&gt;</code><code class="nx">Stats</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code></pre>

<p class="author1">The <code class="calibre21">tracker</code> function will record each of the results from the <code class="calibre21">Profiler</code> in an array called <code class="calibre21">renders</code>.<a data-type="indexterm" data-primary="Profiler component" data-secondary="tracking rendering with" data-tertiary="tracker function" id="idm46634383848744" class="calibre6"/> We’ve also added a button to
the interface, which will display the renders in the console in tabular format whenever we click it.</p>

<p class="author1">If we reload the page and click the Previous and Next buttons a few times, followed by the Stats button, we will see the profile
statistics on the console (see <a data-type="xref" href="#ch10_image_11" class="calibre6">Figure 10-11</a>).</p>

<p class="author1">The data <a data-type="indexterm" data-primary="Profiler component" data-secondary="tracking rendering with" data-tertiary="render statistics in JavaScript console" id="idm46634383590216" class="calibre6"/>is in tabular format, which makes it a little easier to read. It also means that we can sort by any of the columns. We can
also copy the entire table and paste it into a spreadsheet for more analysis.</p>

<figure class="calibre29"><div id="ch10_image_11" class="figure">
<img src="Images/recb_1011.png" alt="" class="calibre183"/>
<h6 class="calibre30"><span class="firstname">Figure 10-11. </span>The render statistics displayed in the JavaScript console</h6>
</div></figure>

<p class="author1">You will notice that the <em class="calibre7">interactions</em> column is always an empty array. That’s because we are not currently tracking any event
handlers or other pieces of code. If we want to see which event handlers are currently running during a render, we can import a
tracing function and wrap it around any piece of code that we want to track. For example, this is how we can start to track the user
clicking the Previous button:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">unstable_trace</code> <code class="nx">as</code> <code class="nx">trace</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'scheduler/tracing'</code>
<code class="go">...</code>
<code class="go">&lt;</code><code class="nt">button</code>
  <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">trace</code><code class="go">(</code><code class="s">'previous button click'</code><code class="go">,</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">(),</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">setYear</code><code class="go">((</code><code class="nx">y</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">y</code> <code class="o">-</code> <code class="mi">1</code><code class="go">)</code>
    <code class="go">})</code>
  <code class="go">}}</code>
<code class="go">/&gt;</code></pre>

<p class="author1">The <code class="calibre21">trace</code> function takes a label, a timestamp, and a callback containing the code it is tracing.<a data-type="indexterm" data-primary="timestamps" data-secondary="trace function" id="idm46634383549144" class="calibre6"/><a data-type="indexterm" data-primary="Profiler component" data-secondary="tracking rendering with" data-tertiary="trace function" id="idm46634383548376" class="calibre6"/> The timestamp could be a date,
but it is often better to use the milliseconds returned from <code class="calibre21">performance.now()</code>.</p>

<p class="author1">If we reload<a data-type="indexterm" data-primary="JSON" data-secondary="traced interactions shown as JSON strings" id="idm46634383546088" class="calibre6"/> the web page, click Next a few times, and then click Previous a few times, we will start to see the interactions appearing
in the table of results (see <a data-type="xref" href="#ch10_image_12" class="calibre6">Figure 10-12</a>).</p>

<figure class="calibre29"><div id="ch10_image_12" class="figure">
<img src="Images/recb_1012.png" alt="" class="calibre184"/>
<h6 class="calibre30"><span class="firstname">Figure 10-12. </span>Traced interactions are shown as JSON strings within the results table</h6>
</div></figure>

<p class="author1">We stringify the output because <code class="calibre21">trace</code> stores interactions as JavaScript sets, which often don’t display correctly in the console.
Even though the interaction data looks truncated in the table, you can still copy the results. Here is the example of the data
returned by a single trace interaction:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">[</code>
    <code class="go">{</code>
        <code class="s">"__count"</code><code class="o">:</code><code class="mi">1</code><code class="go">,</code>
        <code class="s">"id"</code><code class="o">:</code><code class="mi">1</code><code class="go">,</code>
        <code class="s">"name"</code><code class="o">:</code><code class="s">"previous button click"</code><code class="go">,</code>
        <code class="s">"timestamp"</code><code class="o">:</code><code class="mi">4447.909999988042</code>
    <code class="go">}</code>
<code class="go">]</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634383437080">
<h2 class="calibre27">Discussion</h2>

<p class="author1">The <code class="calibre21">Profiler</code> component has been in React since version 16.4.3. The <code class="calibre21">trace</code> function is still experimental, but it is tremendously
powerful.<a data-type="indexterm" data-primary="Calendar application example, tracking rendering with Profiler" data-startref="ix_Calapp" id="idm46634383432968" class="calibre6"/> Although we are using it for only a simple event handler in our example, it can also provide real-world timing for
larger pieces of code, such as network requests. React container components will often have many network requests “in-flight” during
a render, and the <code class="calibre21">trace</code> function gives you the ability to see what was going on at the time of a particularly slow render. It will
also give you some idea of how many renders resulted from a whole chain of different network processes.</p>

<p class="author1">You can download the source for this recipe from
the <a href="https://oreil.ly/XhJLR" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="performance" data-secondary="tracking rendering with Profiler" data-startref="ix_prfctrkrnd" id="idm46634383429896" class="calibre6"/><a data-type="indexterm" data-primary="rendering" data-secondary="tracking with Profiler" data-startref="ix_rndtrck" id="idm46634383428648" class="calibre6"/><a data-type="indexterm" data-primary="Profiler component" data-secondary="tracking rendering with" data-startref="ix_Prfcmprnd" id="idm46634383427432" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Create Profiler Unit Tests" class="calibre4"><div class="preface" id="ch10-03">
<h1 class="calibre17">Create Profiler Unit Tests</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634383520136">
<h2 class="calibre27">Problem</h2>

<p class="author1">The React <code class="calibre21">Profiler</code> is a powerful tool.<a data-type="indexterm" data-primary="performance" data-secondary="creating Profiler unit tests" id="ix_prfmcPUnTst" class="calibre6"/><a data-type="indexterm" data-primary="Profiler component" data-secondary="creating Profiler unit tests" id="ix_PrfcmpUT" class="calibre6"/><a data-type="indexterm" data-primary="unit tests" data-secondary="creating Profiler unit tests" id="ix_untstProf" class="calibre6"/><a data-type="indexterm" data-primary="testing" data-secondary="creating unit tests that call Profiler" id="ix_tstUTProf" class="calibre6"/> It gives you access to the same profiling information that is available within the React
Developer Tools. It has the advantage that you can focus on the code that you are trying to optimize.</p>

<p class="author1">However, it still relies on the interactions that you make with the web page. You will want to test performance before and after you
make a code change. But how can you be sure that the timings you take before and after are measuring the same things? If you perform
a manual test, how can you guarantee that you will perform the same set of actions each time?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634383512120">
<h2 class="calibre27">Solution</h2>

<p class="author1">This recipe will look at how to create unit tests that call the <code class="calibre21">Profiler</code> code. Automated tests will allow us to create repeatable
performance tests that we can run to check that any optimizations we make are having a real impact on performance.<a data-type="indexterm" data-primary="optimizations" data-secondary="checking impact on performance" id="idm46634383509464" class="calibre6"/><a data-type="indexterm" data-primary="rendering" data-secondary="React components outside the browser in unit tests" id="idm46634383508472" class="calibre6"/></p>

<p class="author1">In a unit test, we can render a React component outside of a web browser because the<a data-type="indexterm" data-primary="React Testing library" data-secondary="providing headless DOM implementation" id="idm46634383507112" class="calibre6"/> Testing Library provides a headless
implementation of the DOM.</p>

<p class="author1">To see how to use the <code class="calibre21">Profiler</code>, we will take another <a data-type="indexterm" data-primary="Profiler component" data-secondary="creating Profiler unit tests" data-tertiary="example Calendar application" id="idm46634383505160" class="calibre6"/><a data-type="indexterm" data-primary="rendering" data-secondary="tracking performance with Profiler" id="ix_rndtrckProf" class="calibre6"/>look at the example calendar application (see <a data-type="xref" href="#ch10_image_13" class="calibre6">Figure 10-13</a>).</p>

<figure class="calibre29"><div id="ch10_image_13" class="figure">
<img src="Images/recb_1010.png" alt="" class="calibre182"/>
<h6 class="calibre30"><span class="firstname">Figure 10-13. </span>The example Calendar application</h6>
</div></figure>

<p class="author1">We can add a <code class="calibre21">Profiler</code> component to the main code for the <code class="calibre21">App</code> component and then allow any other code to pass in an <code class="calibre21">onRender</code> method <a data-type="indexterm" data-primary="Profiler component" data-secondary="creating Profiler unit tests" data-tertiary="adding Profiler to Calendar App component" id="idm46634383401272" class="calibre6"/>that can be used to track render performance:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code><code class="go">,</code> <code class="nx">Profiler</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">YearCalendar</code> <code class="nx">from</code> <code class="s">'./YearCalendar'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">unstable_trace</code> <code class="nx">as</code> <code class="nx">trace</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'scheduler/tracing'</code>
<code class="kr">import</code> <code class="s">'./App.css'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">({</code> <code class="nx">onRender</code> <code class="go">})</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">year</code><code class="go">,</code> <code class="nx">setYear</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="mi">2023</code><code class="go">)</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Year</code><code class="o">:</code> <code class="go">{</code><code class="nx">year</code><code class="go">}&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">Profiler</code> <code class="na">id</code><code class="o">=</code><code class="s">"app"</code> <code class="na">onRender</code><code class="o">=</code><code class="go">{</code><code class="nx">onRender</code> <code class="o">||</code> <code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{})}&gt;</code>
        <code class="go">&lt;</code><code class="nt">button</code>
          <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="go">{</code>
            <code class="nx">trace</code><code class="go">(</code><code class="s">'previous button click'</code><code class="go">,</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">(),</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
              <code class="nx">setYear</code><code class="go">((</code><code class="nx">y</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">y</code> <code class="o">-</code> <code class="mi">1</code><code class="go">)</code>
            <code class="go">})</code>
          <code class="go">}}</code>
        <code class="go">&gt;</code>
          <code class="nx">Previous</code>
        <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">setYear</code><code class="go">((</code><code class="nx">y</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">y</code> <code class="o">+</code> <code class="mi">1</code><code class="go">)}&gt;</code><code class="nx">Next</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">br</code> <code class="go">/&gt;</code>
        <code class="go">&lt;</code><code class="nt">YearCalendar</code> <code class="na">year</code><code class="o">=</code><code class="go">{</code><code class="nx">year</code><code class="go">}</code> <code class="na">onRender</code><code class="o">=</code><code class="go">{</code><code class="nx">onRender</code><code class="go">}</code> <code class="go">/&gt;</code>
      <code class="go">&lt;/</code><code class="nt">Profiler</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">We can also pass the <code class="calibre21">onRender</code> function down to child<a data-type="indexterm" data-primary="Profiler component" data-secondary="creating Profiler unit tests" data-tertiary="passing onRender function to child components" id="idm46634383396344" class="calibre6"/><a data-type="indexterm" data-primary="onRender function" id="idm46634383395208" class="calibre6"/> components to track their render performance. In the preceding code, we’re
passing <code class="calibre21">onRender</code> to <code class="calibre21">YearCalendar</code>, which can then use it in its own <code class="calibre21">Profiler</code> component or pass it further down the component
tree.</p>
<div data-type="tip" class="calibre25">
<p class="author1">You can avoid the need to pass the <code class="calibre21">onRender</code> to child components by creating a provider component that will inject the
<code class="calibre21">onRender</code> into the current context. We are not doing that here to keep the code simple. But there are various other examples using
providers elsewhere in the book. For example, see the <code class="calibre21">SecurityProvider</code> in <a data-type="xref" href="ch07.xhtml#ch07-01" class="calibre6">“Secure Requests, Not Routes”</a>.</p>
</div>

<p class="author1">The <code class="calibre21">Profiler</code> component must be given an <code class="calibre21">id</code> property and an <code class="calibre21">onRender</code> property. When the application is run normally, no
<code class="calibre21">onRender</code> property will be passed to the <code class="calibre21">App</code> component, so we need to provide a default function:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">&lt;</code><code class="nt">Profiler</code> <code class="na">id</code><code class="o">=</code><code class="s">'app'</code> <code class="na">onRender</code><code class="o">=</code><code class="go">{</code><code class="nx">onRender</code> <code class="o">||</code> <code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{})}&gt;</code></pre>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">The <code class="calibre21">Profiler</code> component is relatively lightweight and does not generally slow down the application’s performance. If you
forget to remove the <code class="calibre21">Profiler</code> from your code, it won’t matter. The 
<span class="firstname"><code class="calibre21">Profiler</code></span> runs only in development mode.<a data-type="indexterm" data-primary="Profiler component" data-secondary="creating Profiler unit tests" data-tertiary="building a unit test" id="idm46634383217064" class="calibre6"/> It will be removed
from the code when you create a production build.</p>
</div>

<p class="author1">We can now start to build a unit test:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">render</code><code class="go">,</code> <code class="nx">screen</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@testing-library/react'</code>
<code class="kr">import</code> <code class="nx">user</code> <code class="nx">from</code> <code class="s">'@testing-library/user-event'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'./App'</code>

<code class="kr">let</code> <code class="nx">renders</code> <code class="o">=</code> <code class="go">[]</code>
<code class="kr">let</code> <code class="nx">tracker</code> <code class="o">=</code> <code class="go">(</code>
  <code class="nx">id</code><code class="go">,</code>
  <code class="nx">phase</code><code class="go">,</code>
  <code class="nx">actualDuration</code><code class="go">,</code>
  <code class="nx">baseDuration</code><code class="go">,</code>
  <code class="nx">startTime</code><code class="go">,</code>
  <code class="nx">commitTime</code><code class="go">,</code>
  <code class="nx">interactions</code>
<code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">renders</code><code class="go">.</code><code class="nx">push</code><code class="go">({</code>
    <code class="nx">id</code><code class="go">,</code>
    <code class="nx">phase</code><code class="go">,</code>
    <code class="nx">actualDuration</code><code class="go">,</code>
    <code class="nx">baseDuration</code><code class="go">,</code>
    <code class="nx">startTime</code><code class="go">,</code>
    <code class="nx">commitTime</code><code class="go">,</code>
    <code class="nx">interactions</code><code class="o">:</code> <code class="nx">JSON</code><code class="go">.</code><code class="nx">stringify</code><code class="go">(</code><code class="nb">Array</code><code class="go">.</code><code class="nx">from</code><code class="go">(</code><code class="nx">interactions</code><code class="go">)),</code>
  <code class="go">})</code>
<code class="go">}</code>

<code class="kr">let</code> <code class="nx">startTime</code> <code class="o">=</code> <code class="mi">0</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'App'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">beforeEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">renders</code> <code class="o">=</code> <code class="go">[]</code>
    <code class="nx">startTime</code> <code class="o">=</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
  <code class="go">})</code>
  <code class="nx">afterEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'Time taken: '</code><code class="go">,</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code> <code class="o">-</code> <code class="nx">startTime</code><code class="go">)</code>
    <code class="nx">console</code><code class="go">.</code><code class="nx">table</code><code class="go">(</code><code class="nx">renders</code><code class="go">)</code>
  <code class="go">})</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should move between years'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">render</code><code class="go">(&lt;</code><code class="nt">App</code> <code class="na">onRender</code><code class="o">=</code><code class="go">{</code><code class="nx">tracker</code><code class="go">}</code> <code class="go">/&gt;)</code>
    <code class="nx">user</code><code class="go">.</code><code class="nx">click</code><code class="go">(</code><code class="nx">screen</code><code class="go">.</code><code class="nx">getByRole</code><code class="go">(</code><code class="s">'button'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">name</code><code class="o">:</code> <code class="sr">/previous/i</code> <code class="go">}))</code>
    <code class="nx">user</code><code class="go">.</code><code class="nx">click</code><code class="go">(</code><code class="nx">screen</code><code class="go">.</code><code class="nx">getByRole</code><code class="go">(</code><code class="s">'button'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">name</code><code class="o">:</code> <code class="sr">/previous/i</code> <code class="go">}))</code>
    <code class="nx">user</code><code class="go">.</code><code class="nx">click</code><code class="go">(</code><code class="nx">screen</code><code class="go">.</code><code class="nx">getByRole</code><code class="go">(</code><code class="s">'button'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">name</code><code class="o">:</code> <code class="sr">/previous/i</code> <code class="go">}))</code>
    <code class="nx">user</code><code class="go">.</code><code class="nx">click</code><code class="go">(</code><code class="nx">screen</code><code class="go">.</code><code class="nx">getByRole</code><code class="go">(</code><code class="s">'button'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">name</code><code class="o">:</code> <code class="sr">/next/i</code> <code class="go">}))</code>
    <code class="nx">user</code><code class="go">.</code><code class="nx">click</code><code class="go">(</code><code class="nx">screen</code><code class="go">.</code><code class="nx">getByRole</code><code class="go">(</code><code class="s">'button'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">name</code><code class="o">:</code> <code class="sr">/next/i</code> <code class="go">}))</code>
    <code class="nx">user</code><code class="go">.</code><code class="nx">click</code><code class="go">(</code><code class="nx">screen</code><code class="go">.</code><code class="nx">getByRole</code><code class="go">(</code><code class="s">'button'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">name</code><code class="o">:</code> <code class="sr">/next/i</code> <code class="go">}))</code>
  <code class="go">},</code> <code class="mi">30000</code><code class="go">)</code>
<code class="go">})</code></pre>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">Tests that last longer than five seconds are likely to breach the Jest timeout limit.<a data-type="indexterm" data-primary="timeouts" data-secondary="Jest timeout limit for tests" id="idm46634383207256" class="calibre6"/><a data-type="indexterm" data-primary="Jest testing library" data-secondary="timeout limit for tests" id="idm46634383206312" class="calibre6"/> The easiest way to avoid this limit is
by adding a timeout parameter to the <code class="calibre21">it</code> function call, as we do here, to set the timeout to 30,000 ms. You will need to adjust
this value according to the complexity of your test.</p>
</div>

<p class="author1">When you run this test, an enormous amount of data is captured in the console (see <a data-type="xref" href="#ch10_image_14" class="calibre6">Figure 10-14</a>).</p>

<figure class="calibre29"><div id="ch10_image_14" class="figure">
<img src="Images/recb_1014.png" alt="" class="calibre185"/>
<h6 class="calibre30"><span class="firstname">Figure 10-14. </span>The unit test will capture an enormous amount of rendering information</h6>
</div></figure>

<p class="author1">Notably, the test is <em class="calibre7">repeatable</em>. <a data-type="indexterm" data-primary="Profiler component" data-secondary="creating Profiler unit tests" data-tertiary="rendering information captured" id="idm46634382898472" class="calibre6"/>It will perform the same actions each time. We’ve found that unit tests tend to be far more consistent
than code run in the browser. Repeated runs of the previous test gave overall times of 2,100 ms +/– 20 ms. That’s a variation of less
than 1%. They also produced exactly 2,653 profile scores each time.</p>

<p class="author1">It’s unlikely that we’d get repeatable results in a browser with a manual test.</p>

<p class="author1">In the example here, we are simply displaying the capture results. In an actual performance situation, you might want to process the
results in some way to find the average render time of a particular component, for example. Then, when you start to tune the
component, you can be more confident that any performance gains result from actual performance changes rather than variations in the
browser’s behavior.<a data-type="indexterm" data-primary="rendering" data-secondary="tracking performance with Profiler" data-startref="ix_rndtrckProf" id="idm46634382895528" class="calibre6"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634383511176">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Even though we are writing this performance testing code in a Jest unit test, it is not a <em class="calibre7">test</em> in the same way that a<a data-type="indexterm" data-primary="Jest testing library" data-secondary="unit test for performance written in" id="idm46634382892552" class="calibre6"/> regular
functional test is; we are not performing any assertions. Assertions can still be helpful,<sup class="calibre34"><a data-type="noteref" id="idm46634382891336-marker" href="ch10.xhtml#idm46634382891336" class="calibre35">2</a></sup> but it is not good to write performance tests that assert
that some operation is faster than a given time. Performance tests are highly dependent upon the environment. If you write a test on
a development that asserts that something will take less than three seconds, you should not be surprised if it fails on an integration
server, where it took nine seconds.</p>

<p class="author1">If you do want to track performance automatically, you might consider adding regression checks.<a data-type="indexterm" data-primary="regression checks" id="idm46634382889688" class="calibre6"/> A regression check will record a set
of performance statistics in some central repository and record the ID of the environment that produced them. You can check that
future runs in the same environment are not significantly slower than historic runs in the same environment.</p>

<p class="author1">In general, though, it is better to report performance results rather than assert what you want the performance to be.</p>

<p class="author1">You can download the source for this recipe from
the <a href="https://oreil.ly/XhJLR" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="testing" data-secondary="creating unit tests that call Profiler" data-startref="ix_tstUTProf" id="idm46634382886952" class="calibre6"/><a data-type="indexterm" data-primary="unit tests" data-secondary="creating Profiler unit tests" data-startref="ix_untstProf" id="idm46634382885656" class="calibre6"/><a data-type="indexterm" data-primary="performance" data-secondary="creating Profiler unit tests" data-startref="ix_prfmcPUnTst" id="idm46634382884424" class="calibre6"/><a data-type="indexterm" data-primary="Profiler component" data-secondary="creating Profiler unit tests" data-startref="ix_PrfcmpUT" id="idm46634382883192" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Measure Time Precisely" class="calibre4"><div class="preface" id="ch10-04">
<h1 class="calibre17">Measure Time Precisely</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634382880520">
<h2 class="calibre27">Problem</h2>

<p class="author1">Once you get to the point where you need to optimize quite low-level JavaScript code, what should you use to measure performance?<a data-type="indexterm" data-primary="performance" data-secondary="measuring time precisely" id="ix_prfmctime" class="calibre6"/><a data-type="indexterm" data-primary="dates and time" data-secondary="measuring time precisely" id="ix_datmmetm" class="calibre6"/>
You could, for example, use the <code class="calibre21">Date()</code> function<a data-type="indexterm" data-primary="Date function" id="idm46634382875656" class="calibre6"/><a data-type="indexterm" data-primary="timestamps" data-secondary="creating at start and end of code with Date function" id="idm46634382874920" class="calibre6"/><a data-type="indexterm" data-primary="performance" data-secondary="measuring time precisely" data-tertiary="using Date function" id="idm46634382873944" class="calibre6"/> to create a timestamp at the start and end of some JavaScript code:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">beforeDate</code> <code class="o">=</code> <code class="kr">new</code> <code class="nb">Date</code><code class="go">()</code>
<code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="go">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">1000</code><code class="go">;</code> <code class="nx">i</code><code class="o">++</code><code class="go">)</code> <code class="go">{}</code>
<code class="kr">const</code> <code class="nx">afterDate</code> <code class="o">=</code> <code class="kr">new</code> <code class="nb">Date</code><code class="go">()</code>
<code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code>
  <code class="s">'1,000 loops took'</code><code class="go">,</code>
  <code class="nx">afterDate</code><code class="go">.</code><code class="nx">getTime</code><code class="go">()</code> <code class="o">-</code> <code class="nx">beforeDate</code><code class="go">.</code><code class="nx">getTime</code><code class="go">()</code>
<code class="go">)</code></pre>

<p class="author1">We can convert each date into milliseconds, so we can see how long it takes if we subtract one date from another.</p>

<p class="author1">This was such a common technique that the <code class="calibre21">console</code> object was given to new methods<a data-type="indexterm" data-primary="performance" data-secondary="measuring time precisely" data-tertiary="time and timeEnd functions" id="idm46634382844648" class="calibre6"/><a data-type="indexterm" data-primary="time function" id="idm46634382843560" class="calibre6"/><a data-type="indexterm" data-primary="timeEnd function" id="idm46634382842888" class="calibre6"/> called <code class="calibre21">time</code> and <code class="calibre21">timeEnd</code>, to make the code
shorter:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">console</code><code class="go">.</code><code class="nx">time</code><code class="go">(</code><code class="s">'1,000 loops'</code><code class="go">)</code>
<code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="go">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">1000</code><code class="go">;</code> <code class="nx">i</code><code class="o">++</code><code class="go">)</code> <code class="go">{}</code>
<code class="nx">console</code><code class="go">.</code><code class="nx">timeEnd</code><code class="go">(</code><code class="s">'1,000 loops'</code><code class="go">)</code></pre>

<p class="author1">The <code class="calibre21">time</code> function accepts a label parameter, and if we call <code class="calibre21">timeEnd</code> with the same label, it displays the results on the console.
Let’s run the code:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">1,000 loops: 0ms</code></pre>

<p class="author1">That’s a problem. React applications rarely contain long-running functions, so you typically need to optimize small pieces of
JavaScript code only if the browser calls them many times. For example, you might want to optimize game code that is rendering
animation on a screen.<a data-type="indexterm" data-primary="performance" data-secondary="measuring time precisely" data-tertiary="measuring less than milliseconds" id="idm46634382815096" class="calibre6"/> It can be hard to measure short pieces of code because they might run in less than a millisecond. We can’t
measure the performance with <code class="calibre21">Date</code> objects because they resolve down to the millisecond only, even though the machine’s internal
clock is far more precise than that.</p>

<p class="author1">We need something that we can use for measuring times of less than a millisecond.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634382879864">
<h2 class="calibre27">Solution</h2>

<p class="author1">We are going to use <code class="calibre21">performance.now()</code>. <a data-type="indexterm" data-primary="performance" data-secondary="measuring time precisely" data-tertiary="using performance.now function" id="ix_prfmcmetmnow" class="calibre6"/>This function call returns a high-resolution timestamp measured in fractions of
milliseconds. For example, if you open the Chrome console and type <code class="calibre21">performance.now()</code>, you will see something like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="o">&gt;</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
<code class="o">&lt;</code> <code class="mi">10131.62500000908</code></pre>

<p class="author1">The time is measured differently from the time in JavaScript dates. JavaScript dates measure time from January 1, 1970. Instead,
<code class="calibre21">performance.now()</code> measures time from when the current web page loaded.<sup class="calibre34"><a data-type="noteref" id="idm46634382807608-marker" href="ch10.xhtml#idm46634382807608" class="calibre35">3</a></sup></p>

<p class="author1">An interesting<a data-type="indexterm" data-primary="browsers" data-secondary="getting high-resolution time in Firefox" id="idm46634382806344" class="calibre6"/> thing happens if you try to run <code class="calibre21">performance.now()</code> inside Firefox:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="o">&gt;</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
<code class="o">&lt;</code> <code class="mi">4194</code></pre>

<p class="author1">By default, Firefox will return only whole numbers of milliseconds for 
<span class="firstname"><code class="calibre21">performance.now()</code></span>, effectively removing most of the
advantages of using it. Firefox rounds to the whole milliseconds because of security. Technically, if JavaScript can time tiny
amounts of code precisely, this can provide a signature for the browser.</p>

<p class="author1">You can enable high-resolution time within Firefox by opening <code class="calibre21">about:config</code>, searching for the property called
<code class="calibre21">privacy.reduceTimerPrecision</code>, and setting it to <code class="calibre21">false</code>. If you do this, you will start to get high-resolution times:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
<code class="mi">151405.8</code></pre>

<p class="author1">Be sure you disable this property if you want to avoid third parties using it to track you.</p>

<p class="author1">To go back to our example code, we can measure the time taken to perform loops like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">before0</code> <code class="o">=</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
<code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="go">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">1000</code><code class="go">;</code> <code class="nx">i</code><code class="o">++</code><code class="go">)</code> <code class="go">{}</code>
<code class="kr">const</code> <code class="nx">after0</code> <code class="o">=</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
<code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'1,000 loops took'</code><code class="go">,</code> <code class="nx">after0</code> <code class="o">-</code> <code class="nx">before0</code><code class="go">)</code>
<code class="kr">const</code> <code class="nx">before1</code> <code class="o">=</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
<code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="go">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">100000</code><code class="go">;</code> <code class="nx">i</code><code class="o">++</code><code class="go">)</code> <code class="go">{}</code>
<code class="kr">const</code> <code class="nx">after1</code> <code class="o">=</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
<code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'100,000 loops took'</code><code class="go">,</code> <code class="nx">after1</code> <code class="o">-</code> <code class="nx">before1</code><code class="go">)</code></pre>

<p class="author1">When we run this code, we see the following:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">1,000 loops took 0.03576700000007804</code>
<code class="go">100,000 loops took 1.6972319999999854</code></pre>

<p class="author1">These answers are far more precise and provide more information about the underlying performance of JavaScript. In this case, we can
see that adding more iterations to a loop does not scale linearly, which suggests that the JavaScript engine starts to optimize the
code on the fly once it realizes that each of the loop iterations is the same.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634382795736">
<h2 class="calibre27">Discussion</h2>

<p class="author1"><code class="calibre21">performance.now()</code> has several advantages over JavaScript dates.<a data-type="indexterm" data-primary="performance" data-secondary="measuring time precisely" data-tertiary="performance.now, advantages over dates" id="idm46634382441544" class="calibre6"/> Aside from the additional precision, it is unaffected by
clock changes, which is good if you decide to add some performance monitoring to long-running code. It also starts at zero when the
page starts to load, which is useful for optimizing page load times.</p>

<p class="author1">One word of caution when using <code class="calibre21">performance.now()</code>: be wary of using it to build some higher-level timing function. For example, we
once created a simple JavaScript generator function to make it a little easier to use <code class="calibre21">performance.now()</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">function</code><code class="o">*</code> <code class="nx">timekeeper</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">let</code> <code class="nx">now</code> <code class="o">=</code> <code class="mi">0</code>
  <code class="kr">while</code> <code class="go">(</code><code class="kr">true</code><code class="go">)</code> <code class="kr">yield</code> <code class="o">-</code><code class="nx">now</code> <code class="o">+</code> <code class="go">(</code><code class="nx">now</code> <code class="o">=</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">())</code>
<code class="go">}</code></pre>

<p class="author1">This function was created to avoid the need to calculate the difference between start and end times. Instead of writing this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">before0</code> <code class="o">=</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
<code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="go">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">1000</code><code class="go">;</code> <code class="nx">i</code><code class="o">++</code><code class="go">)</code> <code class="go">{}</code>
<code class="kr">const</code> <code class="nx">after0</code> <code class="o">=</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
<code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'1,000 loops took'</code><code class="go">,</code> <code class="nx">after0</code> <code class="o">-</code> <code class="nx">before0</code><code class="go">)</code>
<code class="kr">const</code> <code class="nx">before1</code> <code class="o">=</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
<code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="go">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">100000</code><code class="go">;</code> <code class="nx">i</code><code class="o">++</code><code class="go">)</code> <code class="go">{}</code>
<code class="kr">const</code> <code class="nx">after1</code> <code class="o">=</code> <code class="nx">performance</code><code class="go">.</code><code class="nx">now</code><code class="go">()</code>
<code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'100,000 loops took'</code><code class="go">,</code> <code class="nx">after1</code> <code class="o">-</code> <code class="nx">before1</code><code class="go">)</code></pre>

<p class="author1">we could instead write this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">t</code> <code class="o">=</code> <code class="nx">timekeeper</code><code class="go">()</code>
<code class="nx">t</code><code class="go">.</code><code class="nx">next</code><code class="go">()</code>
<code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="go">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">1000</code><code class="go">;</code> <code class="nx">i</code><code class="o">++</code><code class="go">)</code> <code class="go">{}</code>
<code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'1,000 loops took'</code><code class="go">,</code> <code class="nx">t</code><code class="go">.</code><code class="nx">next</code><code class="go">().</code><code class="nx">value</code><code class="go">)</code>
<code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="go">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">100000</code><code class="go">;</code> <code class="nx">i</code><code class="o">++</code><code class="go">)</code> <code class="go">{}</code>
<code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="s">'100,000 loops took'</code><code class="go">,</code> <code class="nx">t</code><code class="go">.</code><code class="nx">next</code><code class="go">().</code><code class="nx">value</code><code class="go">)</code></pre>

<p class="author1">No need for all of those ugly <code class="calibre21">before</code> and <code class="calibre21">after</code> variables. The time would reset to zero after each call to <code class="calibre21">t.next().value</code>,
doing away with the need for the calculation.</p>

<p class="author1">The problem? The act of wrapping the <code class="calibre21">performance.now()</code> call inside another function adds a significant amount of time to the
measure, destroying the precision of <code class="calibre21">performance.now()</code>:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">1,000 loops took 0.05978800000002593</code>
<code class="go">100,000 loops took 19.585223999999926</code></pre>

<p class="author1">In this case, even though it takes only 1.69 ms to run 100,000 loops, the function reports the time as over 19 ms.</p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">Never hide a call to <code class="calibre21">performance.now()</code> inside another function if you want it to be accurate.</p>
</div>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/baiOr" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="performance" data-secondary="measuring time precisely" data-tertiary="using performance.now function" data-startref="ix_prfmctimenow" id="idm46634382127704" class="calibre6"/><a data-type="indexterm" data-primary="performance" data-secondary="measuring time precisely" data-startref="ix_prfmctime" id="idm46634382126216" class="calibre6"/><a data-type="indexterm" data-primary="dates and time" data-secondary="measuring time precisely" data-startref="ix_datmmetm" id="idm46634382124984" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" class="calibre4" data-pdf-bookmark="Shrink Your App with Code Splitting"><div class="preface" id="ch10-05">
<h1 class="calibre17">Shrink Your App with Code Splitting</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634382083528">
<h2 class="calibre27">Problem</h2>

<p class="author1">One of the biggest drains on performance for<a data-type="indexterm" data-primary="performance" data-secondary="shrinking your app with code splitting" id="ix_prfmcshrcdsp" class="calibre6"/><a data-type="indexterm" data-primary="code splitting" data-secondary="shrinking your app with" id="ix_cdsplt" class="calibre6"/> an SPA is the amount of JavaScript code that needs to be downloaded
and run. Not only does the JavaScript take time to render, but the amount of network bandwidth required can slow your app down
significantly on devices connected to a mobile network.</p>

<p class="author1">Let’s consider the <em class="calibre7">synchronized routes</em> application<a data-type="indexterm" data-primary="synchronized routes application" id="idm46634382120424" class="calibre6"/><a data-type="indexterm" data-primary="routing" data-secondary="synchronized routes application" id="idm46634382119672" class="calibre6"/> we used in <a data-type="xref" href="ch02.xhtml#chapter02" class="calibre6">Chapter 2</a> (see <a data-type="xref" href="#ch10_image_15" class="calibre6">Figure 10-15</a>).</p>

<figure class="calibre29"><div id="ch10_image_15" class="figure">
<img src="Images/recb_1015.png" alt="" class="calibre55"/>
<h6 class="calibre30"><span class="firstname">Figure 10-15. </span>The synchronized routes application</h6>
</div></figure>

<p class="author1">The example application is tiny, but it contains some quite large JavaScript bundles:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ ls -l build/static/js</code>
<code class="go">total 1336</code>
<code class="go">-rw-r--r--  1 davidg  admin  161800 12:07 2.4db4d779.chunk.js</code>
<code class="go">-rw-r--r--  1 davidg  admin    1290 12:07 2.4db4d779.chunk.js.LICENSE.txt</code>
<code class="go">-rw-r--r--  1 davidg  admin  461100 12:07 2.4db4d779.chunk.js.map</code>
<code class="go">-rw-r--r--  1 davidg  admin    4206 12:07 3.307a63d5.chunk.js</code>
<code class="go">-rw-r--r--  1 davidg  admin    9268 12:07 3.307a63d5.chunk.js.map</code>
<code class="go">-rw-r--r--  1 davidg  admin    3082 12:07 main.e8a3e1cb.chunk.js</code>
<code class="go">-rw-r--r--  1 davidg  admin    6001 12:07 main.e8a3e1cb.chunk.js.map</code>
<code class="go">-rw-r--r--  1 davidg  admin    2348 12:07 runtime-main.67df5f2e.js</code>
<code class="go">-rw-r--r--  1 davidg  admin   12467 12:07 runtime-main.67df5f2e.js.map</code>
<code class="go">$</code></pre>

<p class="author1">The largest (<em class="calibre7">2.4db4d779.chunk.js</em>) contains the main React framework code, and the app-specific code is limited to the small
<em class="calibre7">main.e8a3e1cb.chunk.js</em> file. That means this application is about as small as a React application can be. Most React
applications will be significantly larger: often totaling 1 Mb in size, which will be a significant problem for users on slow
connections.</p>

<p class="author1">So, what can we do to reduce the size of JavaScript bundles in React?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634382045704">
<h2 class="calibre27">Solution</h2>

<p class="author1">We will use <em class="calibre7">code splitting</em>, which involves breaking the main code for our application into several smaller bundles. <a data-type="indexterm" data-primary="browsers" data-secondary="loading code bundles lazily" id="idm46634382043128" class="calibre6"/>The browser
will then load these bundles <em class="calibre7">lazily</em>. A particular bundle will load only when one of the components it contains is needed.<a data-type="indexterm" data-primary="lazy loading" id="idm46634382041672" class="calibre6"/></p>

<p class="author1">The example application we are using for this recipe is most certainly <em class="calibre7">not</em> one that requires code splitting. As with all
performance changes, you should only really try to split your code if doing so makes a significant change to web performance. We
will split the code in this application because it will be easier to see how it works.<a data-type="indexterm" data-primary="code splitting" data-secondary="shrinking your app with" data-tertiary="splittinc code with lazy function" id="idm46634382039896" class="calibre6"/><a data-type="indexterm" data-primary="lazy function" id="ix_lzyfnc" class="calibre6"/></p>

<p class="author1">We split code in React with a function called <code class="calibre21">lazy</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">lazy</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code></pre>

<p class="author1">The <code class="calibre21">lazy</code> function accepts a factory function, which, when called, will import a component.<a data-type="indexterm" data-primary="lazy function" data-secondary="returning placeholder component" id="idm46634382032936" class="calibre6"/> The <code class="calibre21">lazy</code> function returns a
placeholder component, which will do nothing until the browser renders it. The placeholder component will run the factory function
and dynamically load whichever bundle contains the actual component.</p>

<p class="author1">To see how this works, consider this component from our example application:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">NavLink</code><code class="go">,</code> <code class="nx">Redirect</code><code class="go">,</code> <code class="nx">Route</code><code class="go">,</code> <code class="nx">Switch</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-router-dom'</code>
<code class="kr">import</code> <code class="nx">People</code> <code class="nx">from</code> <code class="s">'./People'</code>
<code class="kr">import</code> <code class="nx">Offices</code> <code class="nx">from</code> <code class="s">'./Offices'</code>
<code class="kr">import</code> <code class="s">'./About.css'</code>

<code class="kr">const</code> <code class="nx">About</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">(</code>
  <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"About"</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"About-tabs"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">NavLink</code>
        <code class="na">to</code><code class="o">=</code><code class="s">"/about/people"</code>
        <code class="na">className</code><code class="o">=</code><code class="s">"About-tab"</code>
        <code class="na">activeClassName</code><code class="o">=</code><code class="s">"active"</code>
      <code class="go">&gt;</code>
        <code class="nx">People</code>
      <code class="go">&lt;/</code><code class="nt">NavLink</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">NavLink</code>
        <code class="na">to</code><code class="o">=</code><code class="s">"/about/offices"</code>
        <code class="na">className</code><code class="o">=</code><code class="s">"About-tab"</code>
        <code class="na">activeClassName</code><code class="o">=</code><code class="s">"active"</code>
      <code class="go">&gt;</code>
        <code class="nx">Offices</code>
      <code class="go">&lt;/</code><code class="nt">NavLink</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">Switch</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">Route</code> <code class="na">path</code><code class="o">=</code><code class="s">"/about/people"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">People</code> <code class="go">/&gt;</code>
      <code class="go">&lt;/</code><code class="nt">Route</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">Route</code> <code class="na">path</code><code class="o">=</code><code class="s">"/about/offices"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">Offices</code> <code class="go">/&gt;</code>
      <code class="go">&lt;/</code><code class="nt">Route</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">Redirect</code> <code class="na">to</code><code class="o">=</code><code class="s">"/about/people"</code> <code class="go">/&gt;</code>
    <code class="go">&lt;/</code><code class="nt">Switch</code><code class="go">&gt;</code>
  <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
<code class="go">)</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">About</code></pre>

<p class="author1">The browser will render the <code class="calibre21">People</code> and <code class="calibre21">Offices</code> components only when the user visits a given route. If the application is
currently on the path <em class="calibre7">/about/people</em>, the <code class="calibre21">Offices</code> component will not render, which means that we could potentially delay
loading the <code class="calibre21">Offices</code> component until later. We can do this with the <code class="calibre21">lazy</code> function.</p>

<p class="author1">We’ll replace the import of the <code class="calibre21">Offices</code> component with a call to <code class="calibre21">lazy</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="c">//import Offices from "./Offices"</code>
<code class="kr">const</code> <code class="nx">Offices</code> <code class="o">=</code> <code class="nx">lazy</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="kr">import</code><code class="go">(</code><code class="s">'./Offices'</code><code class="go">))</code></pre>

<p class="author1">The object now stored in the <code class="calibre21">Offices</code> variable will appear to the rest of the application as just another component. It’s a lazy
placeholder. Internally it contains a reference to the factory function, which it will call when the browser renders it.</p>

<p class="author1">If we try to refresh<a data-type="indexterm" data-primary="Suspense component" data-secondary="lazy loading error without" id="idm46634381819928" class="calibre6"/><a data-type="indexterm" data-primary="lazy loading" data-secondary="error without Suspense component" id="idm46634381819160" class="calibre6"/> the web page, we will see an error (see <a data-type="xref" href="#ch10_image_16" class="calibre6">Figure 10-16</a>).</p>

<figure class="calibre29"><div id="ch10_image_16" class="figure">
<img src="Images/recb_1016.png" alt="" class="calibre186"/>
<h6 class="calibre30"><span class="firstname">Figure 10-16. </span>You will get a lazy loading error if you forget to add a Suspense 
<span class="firstname">component</span></h6>
</div></figure>

<p class="author1">The placeholder will not wait for the actual component to load before returning. Instead, it will substitute some other HTML while
it is waiting for the actual component to load.</p>

<p class="author1">We can set this “loading” interface with the <code class="calibre21">Suspense</code> container:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">lazy</code><code class="go">,</code> <code class="nx">Suspense</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">NavLink</code><code class="go">,</code> <code class="nx">Redirect</code><code class="go">,</code> <code class="nx">Route</code><code class="go">,</code> <code class="nx">Switch</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-router-dom'</code>
<code class="kr">import</code> <code class="nx">People</code> <code class="nx">from</code> <code class="s">'./People'</code>
<code class="c">// import Offices from './Offices'</code>
<code class="kr">import</code> <code class="s">'./About.css'</code>

<code class="kr">const</code> <code class="nx">Offices</code> <code class="o">=</code> <code class="nx">lazy</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="kr">import</code><code class="go">(</code><code class="s">'./Offices'</code><code class="go">))</code>

<code class="kr">const</code> <code class="nx">About</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">(</code>
  <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"About"</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"About-tabs"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">NavLink</code>
        <code class="na">to</code><code class="o">=</code><code class="s">"/about/people"</code>
        <code class="na">className</code><code class="o">=</code><code class="s">"About-tab"</code>
        <code class="na">activeClassName</code><code class="o">=</code><code class="s">"active"</code>
      <code class="go">&gt;</code>
        <code class="nx">People</code>
      <code class="go">&lt;/</code><code class="nt">NavLink</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">NavLink</code>
        <code class="na">to</code><code class="o">=</code><code class="s">"/about/offices"</code>
        <code class="na">className</code><code class="o">=</code><code class="s">"About-tab"</code>
        <code class="na">activeClassName</code><code class="o">=</code><code class="s">"active"</code>
      <code class="go">&gt;</code>
        <code class="nx">Offices</code>
      <code class="go">&lt;/</code><code class="nt">NavLink</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">Suspense</code> <code class="na">fallback</code><code class="o">=</code><code class="go">{&lt;</code><code class="nt">div</code><code class="go">&gt;</code><code class="nx">Loading</code><code class="go">...&lt;/</code><code class="nt">div</code><code class="go">&gt;}&gt;</code>
      <code class="go">&lt;</code><code class="nt">Switch</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">Route</code> <code class="na">path</code><code class="o">=</code><code class="s">"/about/people"</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">People</code> <code class="go">/&gt;</code>
        <code class="go">&lt;/</code><code class="nt">Route</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">Route</code> <code class="na">path</code><code class="o">=</code><code class="s">"/about/offices"</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">Offices</code> <code class="go">/&gt;</code>
        <code class="go">&lt;/</code><code class="nt">Route</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">Redirect</code> <code class="na">to</code><code class="o">=</code><code class="s">"/about/people"</code> <code class="go">/&gt;</code>
      <code class="go">&lt;/</code><code class="nt">Switch</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">Suspense</code><code class="go">&gt;</code>
  <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
<code class="go">)</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">About</code></pre>

<p class="author1">The <code class="calibre21">lazy</code> placeholder will check its <a data-type="indexterm" data-primary="Suspense component" data-secondary="fallback component provided by" id="idm46634381803384" class="calibre6"/>context to find the <code class="calibre21">fallback</code> component provided by <code class="calibre21">Suspense</code>, and it will display this on
the page while waiting for the additional JavaScript bundle to load.</p>

<p class="author1">We are using a simple “Loading…” message here, but there’s no reason why you can’t instead show some fake replacement interface to
give the impression that the new component has loaded before it has. YouTube uses the same technique on its front page. When YouTube
is loading content, it displays a set of blocks and rectangles in place of the videos it’s about to load (see <a data-type="xref" href="#ch10_image_17" class="calibre6">Figure 10-17</a>). Videos
will often take two to three seconds to load, but this technique gives the user the impression that they load instantly.</p>

<figure class="calibre29"><div id="ch10_image_17" class="figure">
<img src="Images/recb_1017.png" alt="" class="calibre187"/>
<h6 class="calibre30"><span class="firstname">Figure 10-17. </span>YouTube renders a fake front page while loading recommendations</h6>
</div></figure>

<p class="author1">In our application, if you refresh the page now, you should see the application go back to normal, as shown in <a data-type="xref" href="#ch10_image_18" class="calibre6">Figure 10-18</a>.</p>

<figure class="calibre29"><div id="ch10_image_18" class="figure">
<img src="Images/recb_1015.png" alt="" class="calibre55"/>
<h6 class="calibre30"><span class="firstname">Figure 10-18. </span>Adding a <code class="calibre21">Suspense</code> component removes the error</h6>
</div></figure>

<p class="author1">Behind the scenes, the Webpack development server will split off the <code class="calibre21">Offices</code> code into a separate JavaScript bundle.</p>

<p class="author1">Webpack will also split out the bundles when you generate a build. It will use tree shaking to identify which components can safely
appear in which JavaScript bundles.</p>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1"><em class="calibre7">Tree shaking</em> is a process that<a data-type="indexterm" data-primary="tree shaking" id="idm46634381560584" class="calibre6"/> recursively analyzes which code files are imported by other files, starting from some
initial file, such as <em class="calibre7">index.js</em>. This allows Webpack to avoid adding code into a bundle that is never imported by any other code.
The calls to <code class="calibre21">React.lazy</code> will not be tracked by the tree shaking process, and so the lazily loaded code will not be included in the
initial JavaScript bundle. Webpack will instead run a separate tree shaking process for each lazily loaded file, which will result
in a large number of small code bundles in the production application.</p>
</div>

<p class="author1">If we generate a new build and then look at the generated JavaScript code, we will now see some extra files:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn build</code>
<code class="go">...Builds code</code>
<code class="go">$ ls -l build/static/js</code>
<code class="go">total 1352</code>
<code class="go">-rw-r--r--  1 davidg  admin     628 12:09 0.a30b3768.chunk.js</code>
<code class="go">-rw-r--r--  1 davidg  admin     599 12:09 0.a30b3768.chunk.js.map</code>
<code class="go">-rw-r--r--  1 davidg  admin  161801 12:09 3.f7664178.chunk.js</code>
<code class="go">-rw-r--r--  1 davidg  admin    1290 12:09 3.f7664178.chunk.js.LICENSE.txt</code>
<code class="go">-rw-r--r--  1 davidg  admin  461100 12:09 3.f7664178.chunk.js.map</code>
<code class="go">-rw-r--r--  1 davidg  admin    4206 12:09 4.a74be2bf.chunk.js</code>
<code class="go">-rw-r--r--  1 davidg  admin    9268 12:09 4.a74be2bf.chunk.js.map</code>
<code class="go">-rw-r--r--  1 davidg  admin    3095 12:09 main.e4de2e45.chunk.js</code>
<code class="go">-rw-r--r--  1 davidg  admin    6089 12:09 main.e4de2e45.chunk.js.map</code>
<code class="go">-rw-r--r--  1 davidg  admin    2361 12:09 runtime-main.9df06006.js</code>
<code class="go">-rw-r--r--  1 davidg  admin   12496 12:09 runtime-main.9df06006.js.map</code></pre>

<p class="author1">Because this is such a small application, this is unlikely to affect the performance, but let’s check anyway.</p>

<p class="author1">Loading performance is easiest to check using Chrome’s Lighthouse tool.<a data-type="indexterm" data-primary="Lighthouse" data-secondary="checking loading performance" id="idm46634381542248" class="calibre6"/><a data-type="indexterm" data-primary="code splitting" data-secondary="shrinking your app with" data-tertiary="app performance without/with code splitting" id="idm46634381541400" class="calibre6"/> You can see the performance of the original version of this
application in <a data-type="xref" href="#ch10_image_19" class="calibre6">Figure 10-19</a>.</p>

<figure class="calibre29"><div id="ch10_image_19" class="figure">
<img src="Images/recb_1019.png" alt="" class="calibre188"/>
<h6 class="calibre30"><span class="firstname">Figure 10-19. </span>The application’s performance without code splitting</h6>
</div></figure>

<p class="author1">If we add some<a data-type="indexterm" data-primary="lazy loading" data-secondary="performance gain from" id="idm46634381536968" class="calibre6"/> lazy loading, we do get a slight performance increase, primarily because of the time taken to complete the FCP (see <a data-type="xref" href="#ch10_image_20" class="calibre6">Figure 10-20</a>).</p>

<figure class="calibre29"><div id="ch10_image_20" class="figure">
<img src="Images/recb_1020.png" alt="" class="calibre189"/>
<h6 class="calibre30"><span class="firstname">Figure 10-20. </span>The application’s performance with code splitting</h6>
</div></figure>

<p class="author1">It’s not a massive increase in performance, but it does indicate that you can get some benefit from lazy loading even in tiny
applications.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634382044792">
<h2 class="calibre27">Discussion</h2>

<p class="author1">All optimizations have a price, but code splitting takes minimal effort to implement, and it’s the one that we find we use most
often.<a data-type="indexterm" data-primary="optimizations" data-secondary="cost of" id="idm46634381528888" class="calibre6"/><a data-type="indexterm" data-primary="code splitting" data-secondary="shrinking your app with" data-tertiary="low cost of code splitting" id="idm46634381527912" class="calibre6"/> It will often improve web-vitals metrics for FCP and TTI. You should avoid using it too aggressively because the 
<span class="firstname">framework</span> needs to do more work to download and evaluate each of the scripts. But for most reasonably large applications, you will get some
immediate benefit from splitting the code.</p>
<div data-type="tip" class="calibre25">
<p class="author1">It is often best to split code at the route level.<a data-type="indexterm" data-primary="routing" data-secondary="splitting code at route level" id="idm46634381524552" class="calibre6"/><a data-type="indexterm" data-primary="code splitting" data-secondary="shrinking your app with" data-tertiary="code splitting at route level" id="idm46634381523608" class="calibre6"/> Routes control which components are visible and so are a good place to
divide the code you need to load now from the code you need to load later. It will also mean that if anyone bookmarks a location in
your application, they will only download the code required for that location when they return to it.</p>
</div>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/Pj2Bu" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="performance" data-secondary="shrinking your app with code splitting" data-startref="ix_prfmcshrcdsp" id="idm46634381520664" class="calibre6"/><a data-type="indexterm" data-primary="code splitting" data-secondary="shrinking your app with" data-startref="ix_cdsplt" id="idm46634381519368" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Combine Network Promises" class="calibre4"><div class="preface" id="ch10-06">
<h1 class="calibre17">Combine Network Promises</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634381516472">
<h2 class="calibre27">Problem</h2>

<p class="author1">Many React applications<a data-type="indexterm" data-primary="performance" data-secondary="combining network promises" id="ix_prfccmbpr" class="calibre6"/><a data-type="indexterm" data-primary="promises" data-secondary="combining network promises" id="ix_prmscmbnt" class="calibre6"/><a data-type="indexterm" data-primary="networks" data-secondary="combining network promises" id="ix_ntcmbprm" class="calibre6"/> make asynchronous network calls, and a lot of application lethargy results from waiting for responses to
those asynchronous requests. The application is probably doing very little during those calls, so the application is not busy; it’s
just waiting.<a data-type="indexterm" data-primary="clients and servers" data-secondary="clients getting more complex, server APIs becoming simpler" id="idm46634381510744" class="calibre6"/><a data-type="indexterm" data-primary="servers" data-seealso="clients and servers" id="idm46634381509832" class="calibre6"/></p>

<p class="author1">Over time, client applications have become more complex, and server APIs have become simpler.<a data-type="indexterm" data-primary="serverless applications" id="idm46634381508392" class="calibre6"/> In the case of <em class="calibre7">serverless</em> applications,
the server APIs are so generic that no custom code is required, which leads to an increase in the number of API calls that the
client code makes.<sup class="calibre34"><a data-type="noteref" id="idm46634381506968-marker" href="ch10.xhtml#idm46634381506968" class="calibre35">4</a></sup></p>

<p class="author1">Let’s look at an example. We have an application that reads the details of several people from a backend API. The server has an
end point that, if a browser sends a <code class="calibre21">GET</code> request to <em class="calibre7">/people/1234</em>, will return the details of a person with the id of 1234. The
developer has written a hook to make these requests:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">get</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'./fakeios'</code>

<code class="kr">const</code> <code class="nx">usePeopleSlow</code> <code class="o">=</code> <code class="go">(...</code><code class="nx">ids</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">people</code><code class="go">,</code> <code class="nx">setPeople</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">([])</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">let</code> <code class="nx">didCancel</code> <code class="o">=</code> <code class="kr">false</code>
    <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">result</code> <code class="o">=</code> <code class="go">[]</code>
      <code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="go">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">ids</code><code class="go">.</code><code class="nx">length</code><code class="go">;</code> <code class="nx">i</code><code class="o">++</code><code class="go">)</code> <code class="go">{</code>
        <code class="kr">const</code> <code class="nx">id</code> <code class="o">=</code> <code class="nx">ids</code><code class="go">[</code><code class="nx">i</code><code class="go">]</code>
        <code class="nx">result</code><code class="go">.</code><code class="nx">push</code><code class="go">(</code><code class="nx">await</code> <code class="nx">get</code><code class="go">(</code><code class="s">'/people/'</code> <code class="o">+</code> <code class="nx">id</code><code class="go">))</code>
      <code class="go">}</code>
      <code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="nx">didCancel</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">setPeople</code><code class="go">(</code><code class="nx">result</code><code class="go">)</code>
      <code class="go">}</code>
    <code class="go">})()</code>
    <code class="kr">return</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">didCancel</code> <code class="o">=</code> <code class="kr">true</code>
    <code class="go">}</code>
    <code class="c">// eslint-disable-next-line react-hooks/exhaustive-deps</code>
  <code class="go">},</code> <code class="go">[...</code><code class="nx">ids</code><code class="go">])</code>

  <code class="kr">return</code> <code class="nx">people</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">usePeopleSlow</code></pre>

<p class="author1">The hook is called like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">peopleSlow</code> <code class="o">=</code> <code class="nx">usePeopleSlow</code><code class="go">(</code><code class="mi">1</code><code class="go">,</code> <code class="mi">2</code><code class="go">,</code> <code class="mi">3</code><code class="go">,</code> <code class="mi">4</code><code class="go">)</code></pre>

<p class="author1">The code calls the server for each ID. It waits for each response to complete before storing the results in an array. If the API
endpoint takes 5 seconds to respond, the <code class="calibre21">usePeopleSlow</code> hook will take 20 seconds to return all of the data.</p>

<p class="author1">Is there anything we can do to speed things up?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634381324136">
<h2 class="calibre27">Solution</h2>

<p class="author1">We will combine asynchronous promises so that multiple API requests can be in flight at the same time.</p>

<p class="author1">Most asynchronous request libraries work by returning promises. If you wait for a promise, it will return the payload of the
response. But in the example <code class="calibre21">usePeopleSlow</code> code earlier, these promises are waited for in sequence:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">result</code> <code class="o">=</code> <code class="go">[]</code>
<code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="go">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">ids</code><code class="go">.</code><code class="nx">length</code><code class="go">;</code> <code class="nx">i</code><code class="o">++</code><code class="go">)</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">id</code> <code class="o">=</code> <code class="nx">ids</code><code class="go">[</code><code class="nx">i</code><code class="go">]</code>
  <code class="nx">result</code><code class="go">.</code><code class="nx">push</code><code class="go">(</code><code class="nx">await</code> <code class="nx">get</code><code class="go">(</code><code class="s">'/people/'</code> <code class="o">+</code> <code class="nx">id</code><code class="go">))</code>
<code class="go">}</code></pre>

<p class="author1">The request for the second person is not even sent until the response for the first person is received, which is why a 5-second
delay results in a 20-second response time when we are reading the details of four people.</p>

<p class="author1">There is another way we can do this. We could send the requests without waiting and have all of them in-flight simultaneously. We then need to wait for all the responses, and when we receive the last one, we can return the data from the hook.<a data-type="indexterm" data-primary="promises" data-secondary="combining network promises" data-tertiary="parallelizing requests with Promise.all function" id="idm46634381173992" class="calibre6"/></p>

<p class="author1">You can make parallel requests with a JavaScript function called <code class="calibre21">Promise.all</code>.</p>

<p class="author1">The <code class="calibre21">Promise.all</code> function accepts a list of promises and combines them into a single promise. That means we could combine
several <code class="calibre21">get()</code> calls like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="go">[</code><code class="nx">res1</code><code class="go">,</code> <code class="nx">res2</code><code class="go">,</code> <code class="nx">res3</code><code class="go">]</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">Promise</code><code class="go">.</code><code class="nx">all</code><code class="go">(</code>
  <code class="nx">get</code><code class="go">(</code><code class="s">'/people/1'</code><code class="go">),</code>
  <code class="nx">get</code><code class="go">(</code><code class="s">'/people/2'</code><code class="go">),</code>
  <code class="nx">get</code><code class="go">(</code><code class="s">'/people/3'</code><code class="go">)</code>
<code class="go">)</code></pre>

<p class="author1"><code class="calibre21">Promise.all</code> combines not just promises, but also results. If you wait for an array of promises with <code class="calibre21">Promise.all</code>, you will<a data-type="indexterm" data-primary="promises" data-secondary="combining network promises" data-tertiary="receiving array of promises with Promise.all" id="idm46634381157304" class="calibre6"/> receive an array containing each of the 
<span class="firstname">promises</span>.</p>

<p class="author1">We can now write a new version of the <code class="calibre21">usePeopleSlow</code> hook, using <code class="calibre21">Promise.all</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">get</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'./fakeios'</code>

<code class="kr">const</code> <code class="nx">usePeopleFast</code> <code class="o">=</code> <code class="go">(...</code><code class="nx">ids</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">people</code><code class="go">,</code> <code class="nx">setPeople</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">([])</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">let</code> <code class="nx">didCancel</code> <code class="o">=</code> <code class="kr">false</code>
    <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">Promise</code><code class="go">.</code><code class="nx">all</code><code class="go">(</code>
        <code class="nx">ids</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">id</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">get</code><code class="go">(</code><code class="s">'/people/'</code> <code class="o">+</code> <code class="nx">id</code><code class="go">))</code>
      <code class="go">)</code>
      <code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="nx">didCancel</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">setPeople</code><code class="go">(</code><code class="nx">result</code><code class="go">)</code>
      <code class="go">}</code>
    <code class="go">})()</code>
    <code class="kr">return</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">didCancel</code> <code class="o">=</code> <code class="kr">true</code>
    <code class="go">}</code>
    <code class="c">// eslint-disable-next-line react-hooks/exhaustive-deps</code>
  <code class="go">},</code> <code class="go">[...</code><code class="nx">ids</code><code class="go">])</code>

  <code class="kr">return</code> <code class="nx">people</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">usePeopleFast</code></pre>

<p class="author1">The key to this code is these three lines:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">Promise</code><code class="go">.</code><code class="nx">all</code><code class="go">(</code>
  <code class="nx">ids</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">id</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">get</code><code class="go">(</code><code class="s">'/people/'</code> <code class="o">+</code> <code class="nx">id</code><code class="go">))</code>
<code class="go">)</code></pre>

<p class="author1">By <em class="calibre7">mapping</em> the <code class="calibre21">id</code>s into an array of the promises returned by network requests, we can wait for the <code class="calibre21">Promise.all</code> result and receive an array of all the responses.</p>

<p class="author1">If you time the two hooks, then <code class="calibre21">usePeopleFast</code> will read the details of four people in just over five seconds. Effectively, we have
made five requests in the time taken to make one. In the example application, these were the comparative timings of the two versions
of the code:</p>
<table class="calibre10">

<thead class="calibre11">
<tr class="calibre12">
<th class="calibre13">Version</th>
<th class="calibre13">Time Taken (ms)</th>
</tr>
</thead>
<tbody class="calibre14">
<tr class="calibre12">
<td class="calibre15"><p class="author1">usePeopleSlow</p></td>
<td class="calibre15"><p class="author1">5000.99999998929</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1">usePeopleFast</p></td>
<td class="calibre15"><p class="author1">20011.224999994738</p></td>
</tr>
</tbody>
</table>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634381323544">
<h2 class="calibre27">Discussion</h2>

<p class="author1">This approach will significantly improve performance if you have multiple independent asynchronous requests.<a data-type="indexterm" data-primary="asynchronous code" data-secondary="multiple asynchronous requests, performace gains for" id="idm46634380951944" class="calibre6"/> If you make many
parallel requests, then the browser, the network card, or the server might start to queue responses. However, it will still generate
a response more rapidly than a series of independent responses.</p>

<p class="author1">If you send parallel requests, it will intensify the load on the server, but this is unlikely to be a huge issue. First, as we just
noted, servers often queue requests when they are busy. Second, the server will still be performing the same total amount of
work. All you are doing is concentrating that work into a shorter period.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/LhVY8" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="performance" data-secondary="combining network promises" data-startref="ix_prfccmbpr" id="idm46634380948680" class="calibre6"/><a data-type="indexterm" data-primary="promises" data-secondary="combining network promises" data-startref="ix_prmscmbnt" id="idm46634380947432" class="calibre6"/><a data-type="indexterm" data-primary="networks" data-secondary="combining network promises" data-startref="ix_ntcmbprm" id="idm46634380946248" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Use Server-Side Rendering" class="calibre4"><div class="preface" id="ch10-07">
<h1 class="calibre17">Use Server-Side Rendering</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634380943384">
<h2 class="calibre27">Problem</h2>

<p class="author1">SPAs do a great job of making websites as feature-rich as desktop applications.<a data-type="indexterm" data-primary="rendering" data-secondary="using server-side rendering" id="ix_rndSSR" class="calibre6"/><a data-type="indexterm" data-primary="performance" data-secondary="using server-side rendering" id="ix_prfmcSSR" class="calibre6"/><a data-type="indexterm" data-primary="server-side rendering" id="ix_serrnd" class="calibre6"/> If you use an application
like Google Docs, the experience is almost indistinguishable from using a desktop word processor.<a data-type="indexterm" data-primary="Single-Page Applications (SPAs)" data-secondary="performance issues" id="idm46634380938104" class="calibre6"/></p>

<p class="author1">But all things come at a price. One of the major performance issues for SPAs is that the browser has to download a large bundle of
JavaScript code before it can build an interface. If you create a React application with a tool like <code class="calibre21">create-react-app</code>, the only
thing you will have in the body of the HTML is an empty <code class="calibre21">DIV</code> called <code class="calibre21">root</code>:</p>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"root"</code><code class="nt">&gt;&lt;/div&gt;</code></pre>

<p class="author1">That empty <code class="calibre21">DIV</code> is all the browser will see until the JavaScript engine downloads the code, runs it, and updates the DOM.</p>

<p class="author1">Even if we reduce the bundle size with code splitting and the browser has cached the JavaScript, it can still take a couple of
seconds to read the code and set up the 
<span class="firstname">interface</span>.</p>

<p class="author1">Building the entire interface from JavaScript means that SPAs typically suffer from two main issues. First, and most important,
the user experience can degrade, particularly for large React applications. Second, your application will have poor search
engine optimization (SEO). <a data-type="indexterm" data-primary="search engine optimization (SEO)" data-secondary="issues with Single Page Applications" id="idm46634380849160" class="calibre6"/>Search engine robots will often not wait for the JavaScript to render an interface when scanning your
site. They will download the basic HTML of the page and index its contents. For many business applications, this might not matter.
But if you are building, say, a shopping site, you will probably want as many of the pages indexed as possible to capture passing
traffic.</p>

<p class="author1">Therefore, it would be helpful if, instead of displaying an empty <code class="calibre21">DIV</code> when the HTML is loaded, we could begin by including the
initial HTML of our page <em class="calibre7">before</em> the browser downloads and runs the application’s JavaScript.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634380867560">
<h2 class="calibre27">Solution</h2>

<p class="author1">We will look at using server-side rendering to replace the empty <code class="calibre21">DIV</code> of a React page with a prerendered HTML version. We’ll be
able to do this because of the way that React interacts with the DOM of a web page.</p>

<p class="author1">When you render a component in React, you are not directly updating the DOM. Instead, when you run a<a data-type="indexterm" data-primary="DOM" data-secondary="render method updating virtual DOM" id="idm46634380863832" class="calibre6"/> piece of code
like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">ReactDOM</code><code class="go">.</code><code class="nx">render</code><code class="go">(</code>
  <code class="go">&lt;</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">App</code> <code class="go">/&gt;</code>
  <code class="go">&lt;/</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;,</code>
  <code class="nb">document</code><code class="go">.</code><code class="nx">getElementById</code><code class="go">(</code><code class="s">'root'</code><code class="go">)</code>
<code class="go">)</code></pre>

<p class="author1">the <code class="calibre21">render</code> method updates a virtual DOM, which, at intervals, we will synchronize with the actual HTML elements on the page. React
does this efficiently, so it will only update elements in the real DOM that don’t match the elements in the virtual DOM.<a data-type="indexterm" data-primary="DOM" data-secondary="updating real DOM elements not matching virtual DOM" id="idm46634380814232" class="calibre6"/></p>

<p class="author1">Server-side rendering works by rendering not to the React virtual DOM, but to a string.<a data-type="indexterm" data-primary="server-side rendering" data-secondary="rendering to a string, not to virtual DOM" id="idm46634380812872" class="calibre6"/> When the browser sends a request for the
HTML page to the server, we will render a version of the React contents to a string and then insert that string into the HTML,
before returning it to the browser. This means that the browser will immediately render HTML of the page before it even starts to
download the JavaScript of the application. Our server-side code will look something like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">let</code> <code class="nx">indexHTML</code> <code class="o">=</code> <code class="go">&lt;</code><code class="nt">contents</code> <code class="na">of</code> <code class="na">index.html</code><code class="go">&gt;</code>
<code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="go">&lt;</code><code class="nt">render</code> <code class="na">App</code> <code class="na">to</code> <code class="na">string</code><code class="go">&gt;</code>
<code class="nx">indexHTML</code> <code class="o">=</code> <code class="nx">indexHTML</code><code class="go">.</code><code class="nx">replace</code><code class="go">(</code>
  <code class="s">'&lt;div id="root"&gt;&lt;/div&gt;'</code><code class="go">,</code>
  <code class="err">`</code><code class="go">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"app"</code><code class="go">&gt;</code><code class="nx">$</code><code class="go">{</code><code class="nx">app</code><code class="go">}&lt;/</code><code class="nt">div</code><code class="go">&gt;</code><code class="err">`</code>
<code class="go">)</code>
<code class="nx">res</code><code class="go">.</code><code class="nx">contentType</code><code class="go">(</code><code class="s">'text/html'</code><code class="go">)</code>
<code class="nx">res</code><code class="go">.</code><code class="nx">status</code><code class="go">(</code><code class="mi">200</code><code class="go">)</code>
<code class="kr">return</code> <code class="nx">res</code><code class="go">.</code><code class="nx">send</code><code class="go">(</code><code class="nx">indexHTML</code><code class="go">)</code></pre>

<p class="author1">Let’s begin by creating an application with <code class="calibre21">create-react-app</code> to see how this works in more detail.<a data-type="indexterm" data-primary="SSR" data-see="server-side rendering" id="idm46634380809608" class="calibre6"/></p>

<p class="author1">There are many React tools and frameworks that support server-side rendering. <code class="calibre21">create-react-app</code> is <em class="calibre7">not</em> one of those tools.<a data-type="indexterm" data-primary="create-react-app tool" data-secondary="application created with, enabling SSR" id="idm46634380708232" class="calibre6"/> So looking at how to convert a <code class="calibre21">create-react-app</code> application will allow us to understand all the steps required to enable SSR in React:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npx create-react-app ssrapp</code></pre>

<p class="author1">We’ll be building a server to host the SSR code.<a data-type="indexterm" data-primary="servers" data-secondary="building server to host server-side rendering code" id="idm46634380662648" class="calibre6"/><a data-type="indexterm" data-primary="server-side rendering" data-secondary="building server to host code" id="idm46634380661544" class="calibre6"/> Let’s start by creating a folder for the server code:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ mkdir server</code></pre>

<p class="author1">We’ll build the server using Express. Our server code will be rendering the components of our application.</p>

<p class="author1">We’ll need some additional libraries that will be useful when loading the React components. In the main application directory (not
the <em class="calibre7">server</em> subdirectory), install the following:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install --save-dev ignore-styles url-loader @babel/register</code></pre>

<p class="author1">The <code class="calibre21">create-react-app</code> tool generates code that uses a lot of modern JavaScript features that are not available out of the box, so the first thing we’ll need to do in our server code is enable those JavaScript features for the server to run our React
components. Within the new <em class="calibre7">server</em> folder, create a file called <em class="calibre7">index.js</em> and put this into it:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">require</code><code class="go">(</code><code class="s">'ignore-styles'</code><code class="go">)</code>
<code class="nx">require</code><code class="go">(</code><code class="s">'url-loader'</code><code class="go">)</code>
<code class="nx">require</code><code class="go">(</code><code class="s">'file-loader'</code><code class="go">)</code>
<code class="nx">require</code><code class="go">(</code><code class="s">'regenerator-runtime/runtime'</code><code class="go">)</code>
<code class="nx">require</code><code class="go">(</code><code class="s">'@babel/register'</code><code class="go">)({</code>
  <code class="nx">ignore</code><code class="o">:</code> <code class="go">[</code><code class="sr">/(node_modules)/</code><code class="go">],</code>
  <code class="nx">presets</code><code class="o">:</code> <code class="go">[</code>
    <code class="s">'@babel/preset-env'</code><code class="go">,</code>
    <code class="go">[</code>
      <code class="s">'@babel/preset-react'</code><code class="go">,</code>
      <code class="go">{</code>
        <code class="nx">runtime</code><code class="o">:</code> <code class="s">'automatic'</code><code class="go">,</code>
      <code class="go">},</code>
    <code class="go">],</code>
  <code class="go">],</code>
  <code class="nx">plugins</code><code class="o">:</code> <code class="go">[],</code>
<code class="go">})</code>
<code class="nx">require</code><code class="go">(</code><code class="s">'./ssr'</code><code class="go">)</code></pre>

<p class="author1">This file will configure language features that we are going to use in the server code. We’re loading the <code class="calibre21">preset-react</code> Babel
plugin that is installed automatically in every <code class="calibre21">create-react-app</code> application.<a data-type="indexterm" data-primary="preset-react Babel plugin" id="idm46634380558920" class="calibre6"/> At the end of the script, we load a file called
<em class="calibre7">ssr.js</em>, where we’ll put our main server code.</p>

<p class="author1">Create the <em class="calibre7">server/ssr.js</em> file and add the following code to it:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">express</code> <code class="nx">from</code> <code class="s">'express'</code>
<code class="kr">import</code> <code class="nx">fs</code> <code class="nx">from</code> <code class="s">'fs'</code>
<code class="kr">import</code> <code class="nx">path</code> <code class="nx">from</code> <code class="s">'path'</code>

<code class="kr">const</code> <code class="nx">server</code> <code class="o">=</code> <code class="nx">express</code><code class="go">()</code>

<code class="nx">server</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code>
  <code class="sr">/.(js|css|map|ico|svg|png)$/</code><code class="go">,</code>
  <code class="nx">express</code><code class="go">.</code><code class="kr">static</code><code class="go">(</code><code class="nx">path</code><code class="go">.</code><code class="nx">resolve</code><code class="go">(</code><code class="nx">__dirname</code><code class="go">,</code> <code class="s">'../build'</code><code class="go">))</code>
<code class="go">)</code>

<code class="nx">server</code><code class="go">.</code><code class="nx">use</code><code class="go">(</code><code class="s">'*'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">(</code><code class="nx">req</code><code class="go">,</code> <code class="nx">res</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">let</code> <code class="nx">indexHTML</code> <code class="o">=</code> <code class="nx">fs</code><code class="go">.</code><code class="nx">readFileSync</code><code class="go">(</code>
    <code class="nx">path</code><code class="go">.</code><code class="nx">resolve</code><code class="go">(</code><code class="nx">__dirname</code><code class="go">,</code> <code class="s">'../build/index.html'</code><code class="go">),</code>
    <code class="go">{</code>
      <code class="nx">encoding</code><code class="o">:</code> <code class="s">'utf8'</code><code class="go">,</code>
    <code class="go">}</code>
  <code class="go">)</code>

  <code class="nx">res</code><code class="go">.</code><code class="nx">contentType</code><code class="go">(</code><code class="s">'text/html'</code><code class="go">)</code>
  <code class="nx">res</code><code class="go">.</code><code class="nx">status</code><code class="go">(</code><code class="mi">200</code><code class="go">)</code>

  <code class="kr">return</code> <code class="nx">res</code><code class="go">.</code><code class="nx">send</code><code class="go">(</code><code class="nx">indexHTML</code><code class="go">)</code>
<code class="go">})</code>

<code class="nx">server</code><code class="go">.</code><code class="nx">listen</code><code class="go">(</code><code class="mi">8000</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="err">`</code><code class="nx">Launched</code> <code class="nx">at</code> <code class="nx">http</code><code class="o">:</code><code class="c">//localhost:8000!`)</code>
<code class="go">})</code></pre>

<p class="author1">Our custom server will work similarly to the development server that comes with <code class="calibre21">create-react-app</code>. It creates a web server with
this line:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">server</code> <code class="o">=</code> <code class="nx">express</code><code class="go">()</code></pre>

<p class="author1">If the server receives a request for a JavaScript, stylesheet, or image file, it will look for the file in the <em class="calibre7">build</em> directory.
The <em class="calibre7">build</em> directory is where <code class="calibre21">create-react-app</code> generates the deployable version of our application:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">server</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code>
  <code class="sr">/.(js|css|map|ico|svg|png)$/</code><code class="go">,</code>
  <code class="nx">express</code><code class="go">.</code><code class="kr">static</code><code class="go">(</code><code class="nx">path</code><code class="go">.</code><code class="nx">resolve</code><code class="go">(</code><code class="nx">__dirname</code><code class="go">,</code> <code class="s">'../build'</code><code class="go">))</code>
<code class="go">)</code></pre>

<p class="author1">If we receive a request for anything else, we will return the contents of the <em class="calibre7">build/index.html</em> file:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">server</code><code class="go">.</code><code class="nx">use</code><code class="go">(</code><code class="s">'*'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">(</code><code class="nx">req</code><code class="go">,</code> <code class="nx">res</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="go">...</code>
<code class="go">})</code></pre>

<p class="author1">Finally, we start the server running on port 8000:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">server</code><code class="go">.</code><code class="nx">listen</code><code class="go">(</code><code class="mi">8000</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="err">`</code><code class="nx">Launched</code> <code class="nx">at</code> <code class="nx">http</code><code class="o">:</code><code class="c">//localhost:8000!`)</code>
<code class="go">})</code></pre>

<p class="author1">Before we can run this server, we need to build the application. We can do this with the following command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn run build</code></pre>

<p class="author1">Building the application generates all of the static files in the <em class="calibre7">build</em> directory that our server will need. We can now run the
server itself:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ node server</code>
<code class="go">Launched at http://localhost:8000!</code></pre>

<p class="author1">If we open a browser at <em class="calibre7">http://localhost:8000</em>, we will see our React application (see <a data-type="xref" href="#ch10_image_21" class="calibre6">Figure 10-21</a>).</p>

<figure class="calibre29"><div id="ch10_image_21" class="figure">
<img src="Images/recb_0101.png" alt="" class="calibre190"/>
<h6 class="calibre30"><span class="firstname">Figure 10-21. </span>The application running on our new server</h6>
</div></figure>

<p class="author1">So far, so good. But we aren’t actually doing any server-side rendering.<a data-type="indexterm" data-primary="server-side rendering" data-secondary="React code to load and render App component" id="idm46634380177768" class="calibre6"/> For that, we will need to load some React code to load and
render the <code class="calibre21">App</code> component:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">express</code> <code class="nx">from</code> <code class="s">'express'</code>
<code class="kr">import</code> <code class="nx">fs</code> <code class="nx">from</code> <code class="s">'fs'</code>
<code class="kr">import</code> <code class="nx">path</code> <code class="nx">from</code> <code class="s">'path'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">renderToString</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-dom/server'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'../src/App'</code>

<code class="kr">const</code> <code class="nx">server</code> <code class="o">=</code> <code class="nx">express</code><code class="go">()</code>

<code class="nx">server</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code>
  <code class="sr">/.(js|css|map|ico|svg|png)$/</code><code class="go">,</code>
  <code class="nx">express</code><code class="go">.</code><code class="kr">static</code><code class="go">(</code><code class="nx">path</code><code class="go">.</code><code class="nx">resolve</code><code class="go">(</code><code class="nx">__dirname</code><code class="go">,</code> <code class="s">'../build'</code><code class="go">))</code>
<code class="go">)</code>

<code class="nx">server</code><code class="go">.</code><code class="nx">use</code><code class="go">(</code><code class="s">'*'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">(</code><code class="nx">req</code><code class="go">,</code> <code class="nx">res</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">let</code> <code class="nx">indexHTML</code> <code class="o">=</code> <code class="nx">fs</code><code class="go">.</code><code class="nx">readFileSync</code><code class="go">(</code>
    <code class="nx">path</code><code class="go">.</code><code class="nx">resolve</code><code class="go">(</code><code class="nx">__dirname</code><code class="go">,</code> <code class="s">'../build/index.html'</code><code class="go">),</code>
    <code class="go">{</code>
      <code class="nx">encoding</code><code class="o">:</code> <code class="s">'utf8'</code><code class="go">,</code>
    <code class="go">}</code>
  <code class="go">)</code>

  <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">renderToString</code><code class="go">(&lt;</code><code class="nt">App</code> <code class="go">/&gt;)</code>

  <code class="nx">indexHTML</code> <code class="o">=</code> <code class="nx">indexHTML</code><code class="go">.</code><code class="nx">replace</code><code class="go">(</code>
    <code class="s">'&lt;div id="root"&gt;&lt;/div&gt;'</code><code class="go">,</code>
    <code class="err">`</code><code class="go">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"app"</code><code class="go">&gt;</code><code class="nx">$</code><code class="go">{</code><code class="nx">app</code><code class="go">}&lt;/</code><code class="nt">div</code><code class="go">&gt;</code><code class="err">`</code>
  <code class="go">)</code>

  <code class="nx">res</code><code class="go">.</code><code class="nx">contentType</code><code class="go">(</code><code class="s">'text/html'</code><code class="go">)</code>
  <code class="nx">res</code><code class="go">.</code><code class="nx">status</code><code class="go">(</code><code class="mi">200</code><code class="go">)</code>

  <code class="kr">return</code> <code class="nx">res</code><code class="go">.</code><code class="nx">send</code><code class="go">(</code><code class="nx">indexHTML</code><code class="go">)</code>
<code class="go">})</code>

<code class="nx">server</code><code class="go">.</code><code class="nx">listen</code><code class="go">(</code><code class="mi">8000</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="err">`</code><code class="nx">Launched</code> <code class="nx">at</code> <code class="nx">http</code><code class="o">:</code><code class="c">//localhost:8000!`)</code>
<code class="go">})</code></pre>

<p class="author1">This new code uses the <code class="calibre21">renderToString</code> function from React’s SSR library <code class="calibre21">react-dom/server</code>. <a data-type="indexterm" data-primary="server-side rendering" data-secondary="renderToString function" id="idm46634380172696" class="calibre6"/><a data-type="indexterm" data-primary="renderToString function" id="idm46634380171864" class="calibre6"/>The <code class="calibre21">renderToString</code> function does
what you would expect. Instead of rendering the <code class="calibre21">App</code> component into a virtual DOM, it simply renders it into a string. We can
replace the empty <code class="calibre21">DIV</code> in the <em class="calibre7">index.html</em> content with the HTML generated from the <code class="calibre21">App</code> component. If you restart the server and
then reload the web browser, you will <a data-type="indexterm" data-primary="server-side rendering" data-secondary="React application showing broken SVG image" id="idm46634380018568" class="calibre6"/>find that the application still works. Mostly (see <a data-type="xref" href="#ch10_image_22" class="calibre6">Figure 10-22</a>).</p>

<figure class="calibre29"><div id="ch10_image_22" class="figure">
<img src="Images/recb_1022.png" alt="" class="calibre191"/>
<h6 class="calibre30"><span class="firstname">Figure 10-22. </span>The React application showing a broken SVG image</h6>
</div></figure>

<p class="author1">Instead of seeing the rotating React logo, we instead see a broken image symbol. We can see what happens if we look at the
generated HTML returned by the server:</p>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"app"</code><code class="nt">&gt;</code>
  <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"App"</code> <code class="na">data-reactroot=</code><code class="s">""</code><code class="nt">&gt;</code>
    <code class="nt">&lt;header</code> <code class="na">class=</code><code class="s">"App-header"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"[object Object]"</code> <code class="na">class=</code><code class="s">"App-logo"</code> <code class="na">alt=</code><code class="s">"logo"</code><code class="nt">/&gt;</code>
      <code class="nt">&lt;p&gt;</code>Edit <code class="nt">&lt;code&gt;</code>src/App.js<code class="nt">&lt;/code&gt;</code> and save to reload.<code class="nt">&lt;/p&gt;</code>
      <code class="nt">&lt;a</code> <code class="na">class=</code><code class="s">"App-link"</code> <code class="na">href=</code><code class="s">"https://reactjs.org"</code>
         <code class="na">target=</code><code class="s">"_blank"</code> <code class="na">rel=</code><code class="s">"noopener noreferrer"</code><code class="nt">&gt;</code>
        Learn React
      <code class="nt">&lt;/a&gt;</code>
    <code class="nt">&lt;/header&gt;</code>
  <code class="nt">&lt;/div&gt;</code>
<code class="nt">&lt;/div&gt;</code></pre>

<p class="author1">Something odd has happened to the <code class="calibre21">img</code> element. Instead of rendering an SVG image, it tries to load the URL “[object Object].”
What’s happening here?</p>

<p class="author1">In the React code, we are loading the logo like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">logo</code> <code class="nx">from</code> <code class="s">'./logo.svg'</code>
<code class="go">...</code>
<code class="go">&lt;</code><code class="nt">img</code> <code class="na">src</code><code class="o">=</code><code class="go">{</code><code class="nx">logo</code><code class="go">}</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-logo"</code> <code class="na">alt</code><code class="o">=</code><code class="s">"logo"</code> <code class="go">/&gt;</code></pre>

<p class="author1">This code relies on some Webpack configuration from <code class="calibre21">create-react-app</code>. <a data-type="indexterm" data-primary="Webpack" data-secondary="svgr library replacing imports of SVG images" id="idm46634379970040" class="calibre6"/>When you access the application through the development
server, Webpack will use a library called <em class="calibre7">svgr</em> to replace any imports of SVG files with generated React components that contain
the raw SVG contents. <em class="calibre7">svgr</em> allows SVG images to be loaded just like any other React components. That’s what allows us to import
them as we might import a <em class="calibre7">.js</em> file.</p>

<p class="author1">However, in our hand-built server, we have no such Webpack configuration. Instead of going to the trouble of configuring Webpack, we
can avoid the problem by copying the <em class="calibre7">logo.svg</em> file to the <em class="calibre7">public</em> folder and then changing the <a data-type="indexterm" data-primary="server-side rendering" data-secondary="fixing React App code showing broken SVG image" id="idm46634379953144" class="calibre6"/>code in the <code class="calibre21">App</code> component to the following:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="c">// import logo from './logo.svg'</code>
<code class="kr">import</code> <code class="s">'./App.css'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">header</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-header"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">img</code> <code class="na">src</code><code class="o">=</code><code class="s">"/logo.svg"</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-logo"</code> <code class="na">alt</code><code class="o">=</code><code class="s">"logo"</code> <code class="go">/&gt;</code>
        <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code>
          <code class="nx">Edit</code> <code class="go">&lt;</code><code class="nt">code</code><code class="go">&gt;</code><code class="nx">src</code><code class="o">/</code><code class="nx">App</code><code class="go">.</code><code class="nx">js</code><code class="go">&lt;/</code><code class="nt">code</code><code class="go">&gt;</code> <code class="nx">and</code> <code class="nx">save</code> <code class="nx">to</code> <code class="nx">reload</code><code class="go">.</code>
        <code class="go">&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">a</code>
          <code class="na">className</code><code class="o">=</code><code class="s">"App-link"</code>
          <code class="na">href</code><code class="o">=</code><code class="s">"https://reactjs.org"</code>
          <code class="na">target</code><code class="o">=</code><code class="s">"_blank"</code>
          <code class="na">rel</code><code class="o">=</code><code class="s">"noopener noreferrer"</code>
        <code class="go">&gt;</code>
          <code class="nx">Learn</code> <code class="nx">React</code>
        <code class="go">&lt;/</code><code class="nt">a</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">header</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">If we now rebuild the application and restart the server:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ yarn build</code>
<code class="go">$ node server</code></pre>

<p class="author1">the SSR application will display the application correctly (see <a data-type="xref" href="#ch10_image_23" class="calibre6">Figure 10-23</a>).</p>

<figure class="calibre29"><div id="ch10_image_23" class="figure">
<img src="Images/recb_0101.png" alt="" class="calibre190"/>
<h6 class="calibre30"><span class="firstname">Figure 10-23. </span>The application now displays the SVG image correctly</h6>
</div></figure>

<p class="author1">There is actually just one step left, which we should implement. In the <em class="calibre7">src/index.js</em> file, we render the single-page version of
the application like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">ReactDOM</code><code class="go">.</code><code class="nx">render</code><code class="go">(</code>
  <code class="go">&lt;</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">App</code> <code class="go">/&gt;</code>
  <code class="go">&lt;/</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;,</code>
  <code class="nb">document</code><code class="go">.</code><code class="nx">getElementById</code><code class="go">(</code><code class="s">'root'</code><code class="go">)</code>
<code class="go">)</code></pre>

<p class="author1">Remember, this code will still run, even when we access our application through the SSR server. The browser will download the
prerendered version of the web page, and it will then download the JavaScript for the SPA. When the SPA code
runs, it will execute the preceding code from <em class="calibre7">index.js</em>. The browser still needs to load and run the JavaScript to make the
interface interactive.<a data-type="indexterm" data-primary="ReactDOM.render method" id="idm46634379667208" class="calibre6"/> The <code class="calibre21">ReactDOM.render</code> method may replace all of our prerendered HTML when it doesn’t need to. So if we replace
the call to <code class="calibre21">ReactDOM.render</code> with <code class="calibre21">ReactDOM.hydrate</code>, we will only replace the HTML in the DOM if it is different from the HTML in
the virtual DOM.<a data-type="indexterm" data-primary="ReactDOM.hydrate method" id="idm46634379665016" class="calibre6"/> For our server-side rendered page, the content of the static web page and the content of the virtual DOM should be
the same. The result is that <code class="calibre21">hydrate</code> will not update the elements on the page; it will just attach a set of event listeners to
make the page interactive.</p>

<p class="author1">So, we now have a server-side rendered application. <a data-type="indexterm" data-primary="server-side rendering" data-secondary="performance gain from" id="idm46634379663160" class="calibre6"/>But has it made the page load any faster?</p>

<p class="author1">The simplest way to test page load time is to run a Lighthouse performance audit within Chrome. Lighthouse, remember, performs a
basic audit of a web page, checking performance, accessibility, and a bunch of other features. It will give us a metric that we can
use to compare the two versions of the application.</p>

<p class="author1">When we tried this on a development laptop when accessing the ordinary React development server that comes bundled with
<code class="calibre21">create-react-app</code>, we got a performance grade of 91 out of 100 and a <em class="calibre7">first contentful paint</em> (FCP) time of 1.2 seconds (see <a data-type="xref" href="#ch10_image_24" class="calibre6">Figure 10-24</a>).</p>

<figure class="calibre29"><div id="ch10_image_24" class="figure">
<img src="Images/recb_1024.png" alt="" class="calibre175"/>
<h6 class="calibre30"><span class="firstname">Figure 10-24. </span>Base performance of the application, without server-side rendering</h6>
</div></figure>

<p class="author1">That’s not a bad performance score. But we are running a small React application.</p>

<p class="author1">What happens when we test the SSR version of the application? After all, the server will still have to spend some time rendering the
React code. Will it run any faster? You can see the results of our test in <a data-type="xref" href="#ch10_image_25" class="calibre6">Figure 10-25</a>.</p>

<p class="author1">The overall score has increased to 99 out of 100. <a data-type="indexterm" data-primary="FCP (First Contentful Paint)" id="idm46634379600376" class="calibre6"/><a data-type="indexterm" data-primary="First Contentful Paint (FCP)" id="idm46634379599704" class="calibre6"/>The time to FCP has dropped to 0.6 seconds: half that of our
original version. Also, if you load the original SPA version of the application in a browser and keep hitting Refresh, you will see
the page will often flash white for a moment before rendering the web page. The flash occurs because the downloaded HTML is just an
empty <code class="calibre21">DIV</code>, which the browser displays as a white page before the JavaScript can render the application.</p>

<figure class="calibre29"><div id="ch10_image_25" class="figure">
<img src="Images/recb_1025.png" alt="" class="calibre175"/>
<h6 class="calibre30"><span class="firstname">Figure 10-25. </span>Performance of the application with server-side rendering</h6>
</div></figure>

<p class="author1">Compare that to the SSR version of the application. If you keep hitting Refresh on the SSR version, the only thing you should notice
is that the rotation of the logo keeps resetting. You will see almost no flashing.</p>

<p class="author1">Even though there is still a render process occurring on the server, the time needed to render a string version of the HTML is less
than the time needed to render the same set of DOM elements.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634379661480">
<h2 class="calibre27">Discussion</h2>

<p class="author1">In this recipe, we have taken you through the basics of how you might set up basic server-side rendering for your application. The
details for <em class="calibre7">your</em> application are likely to vary quite a lot, dependent upon which additional libraries your application uses.</p>

<p class="author1">Most React applications use some form of routing, for example.<a data-type="indexterm" data-primary="routing" data-secondary="using react-router, additional code for server-side rendering" id="idm46634379653576" class="calibre6"/> If you are using <code class="calibre21">react-router</code>, then you will need to add some
additional code on the server side to handle the fact that different components will need to be rendered, based upon the path that
the browser has requested. <a data-type="indexterm" data-primary="StaticRouter" id="idm46634379651800" class="calibre6"/>For example, we can use the <code class="calibre21">StaticRouter</code> from <code class="calibre21">react-router</code> like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">StaticRouter</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-router-dom'</code>
<code class="go">...</code>
<code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">renderToString</code><code class="go">(</code>
  <code class="go">&lt;</code><code class="nt">StaticRouter</code> <code class="na">location</code><code class="o">=</code><code class="go">{</code><code class="nx">req</code><code class="go">.</code><code class="nx">originalUrl</code><code class="go">}</code> <code class="na">context</code><code class="o">=</code><code class="go">{{}}&gt;</code>
    <code class="go">&lt;</code><code class="nt">App</code> <code class="go">/&gt;</code>
  <code class="go">&lt;/</code><code class="nt">StaticRouter</code><code class="go">&gt;</code>
<code class="go">)</code></pre>

<p class="author1">The <code class="calibre21">StaticRouter</code> renders its child components for a single, specific route. In this case, we use the <code class="calibre21">originalURL</code> route from the
browser request. If the browser asks for <em class="calibre7">/person/1234</em>, the <code class="calibre21">StaticRouter</code> will render the <code class="calibre21">App</code> component for this route.
Notice that we can also use the <code class="calibre21">StaticRouter</code> to pass any additional context for the rest of the application. We could use the
context to pass content to the rest of the application.</p>

<p class="author1">If you are using code splitting in your application with <code class="calibre21">React.lazy</code>, you need to be aware that this will not work on the
server side.<a data-type="indexterm" data-primary="code splitting" data-secondary="using lazy function" id="idm46634379551960" class="calibre6"/><a data-type="indexterm" data-primary="lazy function" id="idm46634379550984" class="calibre6"/> Fortunately, there is a workaround. The <a href="https://oreil.ly/v8zan" class="calibre6">Loadable Components</a> library does the same job as <code class="calibre21">React.lazy</code>, but it can also run on the server side.<a data-type="indexterm" data-primary="Loadable Components library" id="idm46634379549048" class="calibre6"/> Therefore, Loadable Components gives you all of the advantages of server-side rendering with all the benefits of code splitting.</p>

<p class="author1">As with all optimizations, there is a price to pay with server-side rendering. It will require additional complexity in your code,
and it will also require additional load on your server.<a data-type="indexterm" data-primary="optimizations" data-secondary="server-side rendering, cost of" id="idm46634379547640" class="calibre6"/> You can deploy an SPA as static code on any web server.
That’s not true for server-side rendered code. It will need a JavaScript server and may well increase your cloud hosting costs.</p>

<p class="author1">Also, if you know from the outset that you want to use server-side rendering for your application, you should probably consider a
tool like Razzle or Next.js for your application and build server-side rendering from day one.<a data-type="indexterm" data-primary="Razzle" id="idm46634379545736" class="calibre6"/><a data-type="indexterm" data-primary="Next.js" id="idm46634379545032" class="calibre6"/></p>

<p class="author1">Finally, there are alternative approaches to SSR that can boost the performance of your web page without the need for server-side
rendering. Consider using Gatsby.<a data-type="indexterm" data-primary="Gatsby" data-secondary="prerendering pages at build time" id="idm46634379543800" class="calibre6"/> Gatsby can prerender your pages at <em class="calibre7">build time</em>, giving you many of the advantages of SSR without
needing server-side code.</p>

<p class="author1">You can download the source for this
recipe from the <a href="https://oreil.ly/Mfzex" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="rendering" data-secondary="using server-side rendering" data-startref="ix_rndSSR" id="idm46634379541176" class="calibre6"/><a data-type="indexterm" data-primary="performance" data-secondary="using server-side rendering" data-startref="ix_prfmcSSR" id="idm46634379539928" class="calibre6"/><a data-type="indexterm" data-primary="server-side rendering" data-startref="ix_serrnd" id="idm46634379538744" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Use Web Vitals" class="calibre4"><div class="preface" id="ch10-08">
<h1 class="calibre17">Use Web Vitals</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634379536376">
<h2 class="calibre27">Problem</h2>

<p class="author1">It is more important to have code that works and is readable than it is to have highly tuned code. <a data-type="indexterm" data-primary="performance" data-secondary="using web vitals" id="ix_prfmcWV" class="calibre6"/><a data-type="indexterm" data-primary="web vitals, tracking" id="ix_wbvtl" class="calibre6"/>Tuning, as we’ve seen, always
comes with an associated cost.</p>

<p class="author1">But if there <em class="calibre7">are</em> noticeable performance issues, it is essential to become aware of them and fix them as quickly as possible. Much
of the Internet relies upon <em class="calibre7">passing trade</em>. If people go to your website and it doesn’t immediately respond, they may leave and
never return.</p>

<p class="author1">Developers often track server performance using trackers—known as <em class="calibre7">beacons</em>—embedded within the code. If there’s a performance
issue, the beacons can generate an alert, and the developer can fix the problem before it affects a lot of users.</p>

<p class="author1">But how do we embed a tracking beacon into our client code?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634379529256">
<h2 class="calibre27">Solution</h2>

<p class="author1">We’re going to look at how to track <em class="calibre7">web vitals</em>. We mentioned web vitals in <a data-type="xref" href="#ch10-01" class="calibre6">“Use Browser Performance Tools”</a>. They are a small set
of metrics that measure your application’s most important performance features, such as<a data-type="indexterm" data-primary="CLS (Cumulative Layout Shift)" id="idm46634379525976" class="calibre6"/><a data-type="indexterm" data-primary="Cumulative Layout Shift (CLS)" id="idm46634379525336" class="calibre6"/><a data-type="indexterm" data-primary="jumpiness" id="idm46634379524648" class="calibre6"/> the <em class="calibre7">Cumulative Layout Shift</em> (CLS), which
measures how much your application jumps around when it first loads.</p>

<p class="author1">Several tools, such as the Lighthouse Chrome extension, track web vitals. The name <em class="calibre7">web vitals</em> is intended to remind you of vital
signs, like heart rate and blood pressure, because they tell you about an underlying issue that you need to address.</p>

<p class="author1">If you created your application with <code class="calibre21">create-react-app</code>, you probably already have code embedded that can automatically track the web
vitals of your application.<a data-type="indexterm" data-primary="reportWebVitals function" id="idm46634379521592" class="calibre6"/><a data-type="indexterm" data-primary="web vitals, tracking" data-secondary="reportWebVitals function" id="idm46634379520872" class="calibre6"/> If you look in the <em class="calibre7">src/index.js</em> file, you will see a call to report the web vitals at the end:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">ReactDOM</code> <code class="nx">from</code> <code class="s">'react-dom'</code>
<code class="kr">import</code> <code class="s">'./index.css'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'./App'</code>
<code class="kr">import</code> <code class="nx">reportWebVitals</code> <code class="nx">from</code> <code class="s">'./reportWebVitals'</code>

<code class="nx">ReactDOM</code><code class="go">.</code><code class="nx">render</code><code class="go">(</code>
  <code class="go">&lt;</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;</code>
    <code class="go">&lt;</code><code class="nt">App</code> <code class="go">/&gt;</code>
  <code class="go">&lt;/</code><code class="nt">React</code><code class="go">.</code><code class="na">StrictMode</code><code class="go">&gt;,</code>
  <code class="nb">document</code><code class="go">.</code><code class="nx">getElementById</code><code class="go">(</code><code class="s">'root'</code><code class="go">)</code>
<code class="go">)</code>

<code class="nx">reportWebVitals</code><code class="go">()</code></pre>

<p class="author1">The <code class="calibre21">reportWebVitals</code> function can be given a callback function that can be used to track the various metrics while the application
is running.<a data-type="indexterm" data-primary="console.log function" id="idm46634379450952" class="calibre6"/><a data-type="indexterm" data-primary="JSON" data-secondary="web vitals shown as JSON objects in JavaScript console" id="idm46634379450344" class="calibre6"/> For example, if you pass it <code class="calibre21">console.log</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">reportWebVitals</code><code class="go">(</code><code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">)</code></pre>

<p class="author1">you will then see metrics appearing in your JavaScript console as a series of JSON objects (see <a data-type="xref" href="#ch10_image_26" class="calibre6">Figure 10-26</a>).</p>

<figure class="calibre29"><div id="ch10_image_26" class="figure">
<img src="Images/recb_1026.png" alt="" class="calibre192"/>
<h6 class="calibre30"><span class="firstname">Figure 10-26. </span>The web vitals in the JavaScript console</h6>
</div></figure>

<p class="author1">This is not really how you are intended to track web vitals. A better option is to send the data back to some backend store.<a data-type="indexterm" data-primary="web vitals, tracking" data-secondary="sending data back to backend store" id="idm46634379442264" class="calibre6"/> For
example, you might choose to <code class="calibre21">POST</code> them to send API endpoint:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">reportWebVitals</code><code class="go">((</code><code class="nx">vital</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">fetch</code><code class="go">(</code><code class="s">'/trackVitals'</code><code class="go">,</code> <code class="go">{</code>
    <code class="nx">body</code><code class="o">:</code> <code class="nx">JSON</code><code class="go">.</code><code class="nx">stringify</code><code class="go">(</code><code class="nx">vital</code><code class="go">),</code>
    <code class="nx">method</code><code class="o">:</code> <code class="s">'POST'</code><code class="go">,</code>
    <code class="nx">keepalive</code><code class="o">:</code> <code class="kr">true</code><code class="go">,</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">Many browsers have a built-in function that is intended for use when recording vital measurements.<a data-type="indexterm" data-primary="web vitals, tracking" data-secondary="browser functions recording vitals" id="idm46634379415656" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="functions to use in recording vitals" id="idm46634379355032" class="calibre6"/> The browser will cancel normal
network requests, such as those made by calling <code class="calibre21">fetch</code>, if the user leaves the page. Given that the most important web vitals
happen when the page loads, it would be a pity to lose these metrics.<a data-type="indexterm" data-primary="navigator.sendBeacon function" id="idm46634379353512" class="calibre6"/> For that reason, you should consider using the <code class="calibre21">navigator.sendBeacon</code> function when it’s available:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">reportWebVitals</code><code class="go">((</code><code class="nx">vital</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">navigator</code><code class="go">.</code><code class="nx">sendBeacon</code><code class="go">)</code> <code class="go">{</code>
    <code class="nx">navigator</code><code class="go">.</code><code class="nx">sendBeacon</code><code class="go">(</code><code class="s">'/trackVitals'</code><code class="go">,</code> <code class="nx">JSON</code><code class="go">.</code><code class="nx">stringify</code><code class="go">(</code><code class="nx">vital</code><code class="go">))</code>
  <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
    <code class="nx">fetch</code><code class="go">(</code><code class="s">'/trackVitals'</code><code class="go">,</code> <code class="go">{</code>
      <code class="nx">body</code><code class="o">:</code> <code class="nx">JSON</code><code class="go">.</code><code class="nx">stringify</code><code class="go">(</code><code class="nx">vital</code><code class="go">),</code>
      <code class="nx">method</code><code class="o">:</code> <code class="s">'POST'</code><code class="go">,</code>
      <code class="nx">keepalive</code><code class="o">:</code> <code class="kr">true</code><code class="go">,</code>
    <code class="go">})</code>
  <code class="go">}</code>
<code class="go">})</code></pre>

<p class="author1">If the user briefly opens the page and then goes elsewhere, the <code class="calibre21">navigator.sendBeacon</code> will be allowed to complete its <code class="calibre21">POST</code>
request before dying.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634379528632">
<h2 class="calibre27">Discussion</h2>

<p class="author1">There are commercial tracking services available that you can use to record web vitals, such as <a href="https://sentry.io" class="calibre6">sentry.io</a>. If you
have a performance monitoring system installed, you might also be able to wire it up using web vitals to provide additional performance
monitoring for your system.<a data-type="indexterm" data-primary="Google Analytics, tracking web vitals with" id="idm46634379267032" class="calibre6"/></p>

<p class="author1">Finally, consider tracking web vitals with Google Analytics as described on the <a href="https://oreil.ly/wImZt" class="calibre6"><code class="calibre21">create-react-app</code> site</a>.<a data-type="indexterm" data-primary="performance" data-secondary="using web vitals" data-startref="ix_prfmcWV" id="idm46634379264936" class="calibre6"/><a data-type="indexterm" data-primary="web vitals, tracking" data-startref="ix_wbvtl" id="idm46634379263656" class="calibre6"/><a data-type="indexterm" data-primary="performance" data-startref="ix_prfmc" id="idm46634379262712" class="calibre6"/></p>
</div></section>





</div></section>







<div data-type="footnotes" class="calibre49"><p data-type="footnote" id="idm46634384214840" class="calibre50"><sup class="calibre51"><a href="ch10.xhtml#idm46634384214840-marker" class="calibre35">1</a></sup> See <a data-type="xref" href="#ch10-05" class="calibre6">“Shrink Your App with Code Splitting”</a>.</p><p data-type="footnote" id="idm46634382891336" class="calibre50"><sup class="calibre51"><a href="ch10.xhtml#idm46634382891336-marker" class="calibre35">2</a></sup> For example, by checking that the component is in a particular state before performing some action.</p><p data-type="footnote" id="idm46634382807608" class="calibre50"><sup class="calibre51"><a href="ch10.xhtml#idm46634382807608-marker" class="calibre35">3</a></sup> If you run it in Node, <code class="calibre21">performance.now()</code> measures the time from the start of the current process.</p><p data-type="footnote" id="idm46634381506968" class="calibre50"><sup class="calibre51"><a href="ch10.xhtml#idm46634381506968-marker" class="calibre35">4</a></sup> An exception to this is in the case of GraphQL services. In GraphQL, the client can make a complex query to the backend, and a standardized query resolver will “stitch together” the results of low-level queries on the server. GraphQL can produce faster network responses without needing to tune the client.</p></div></div></section></div></body></html>