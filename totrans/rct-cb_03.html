<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 3. Managing State" class="calibre4"><div class="preface" id="chapter03">
<h1 class="calibre9"><span class="label">Chapter 3. </span>Managing State</h1>


<p class="author1">When we manage state in React, we have to store data, but we also record data dependencies.<a data-type="indexterm" data-primary="state" id="ix_sta" class="calibre6"/> Dependencies are intrinsic to the way
that React works. They allow React to update the page efficiently and only when necessary.</p>

<p class="author1">Managing data dependencies, then, is the key to managing state in React. You will see throughout this chapter that most of the tools
and techniques we use are to ensure that we manage dependencies efficiently.</p>

<p class="author1">A key concept in the following recipes is a data reducer.<a data-type="indexterm" data-primary="data reducers" data-see="reducers" id="idm46634427711096" class="calibre6"/><a data-type="indexterm" data-primary="reducers" id="idm46634427710120" class="calibre6"/> A <em class="calibre7">reducer</em> is simply a function that receives a single object or an array
and then returns a modified copy. This simple concept is what lies behind much of the state management in React. We’ll look at how
React uses reducer functions natively and how we can use the Redux library to manage data application-wide with reducers.</p>

<p class="author1">We’ll also look at selector functions.<a data-type="indexterm" data-primary="selectors" id="idm46634427708152" class="calibre6"/> These allow us to drill into the state returned by reducers. Selectors help us ignore the
irrelevant data, and in doing so, they significantly improve the performance of our code.</p>

<p class="author1">Along the way, we’ll look at simple ways of checking whether you’re online, how to manage form data, and various other tips and
tricks to keep your application ticking along.</p>






<section data-type="sect1" data-pdf-bookmark="Use Reducers to Manage Complex State" class="calibre4"><div class="preface" id="ch03-01">
<h1 class="calibre17">Use Reducers to Manage Complex State</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634427704968">
<h2 class="calibre27">Problem</h2>

<p class="author1">Many React components are straightforward.<a data-type="indexterm" data-primary="state" data-secondary="complex, managing with reducers" id="ix_stacmpl" class="calibre6"/><a data-type="indexterm" data-primary="reducers" data-secondary="using to manage complex state" id="ix_redmgst" class="calibre6"/> They do little more than render a section of HTML and perhaps show a few properties.</p>

<p class="author1">However, some components can be more complicated. They might need to manage several pieces of internal state. For example, consider
the simple number game you can see in <a data-type="xref" href="#ch03_image_1" class="calibre6">Figure 3-1</a>.</p>

<figure class="calibre29"><div id="ch03_image_1" class="figure">
<img src="Images/recb_0301.png" alt="" class="calibre65"/>
<h6 class="calibre30"><span class="firstname">Figure 3-1. </span>A simple number puzzle</h6>
</div></figure>

<p class="author1">The component displays a series of numeric tiles, in a grid, with a single space. If the user clicks a tile next to the space, they
can move it. In this way, the user can rearrange the tiles until they are in the correct order from 1 to 8.</p>

<p class="author1">This component renders a small amount of HTML, but it will require some fairly complex logic and data. It will record the positions
of the tiles. It will need to know whether a user can move a given tile. It will need to know how to move the tile. It will need to
know whether the game is complete. It will also need to do other things, such as reset the game by shuffling the tiles.</p>

<p class="author1">It’s entirely possible to write all this code inside the component, but it will be harder to test it. You could use the React
Testing Library, but that is probably overkill, given that most of the code will have very little to do with rendering HTML.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634427695304">
<h2 class="calibre27">Solution</h2>

<p class="author1">If you have a component with some complex internal state or that needs to manipulate its state in complex ways, consider using a
reducer.</p>

<p class="author1">A reducer is a function <a data-type="indexterm" data-primary="objects" data-secondary="representing state" id="idm46634427692104" class="calibre6"/><a data-type="indexterm" data-primary="arrays" data-secondary="representing state" id="idm46634427691128" class="calibre6"/>that accepts two parameters:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">An object or array that represents a given state</p>
</li>
<li class="calibre8">
<p class="author1">An action that describes how you want to modify the state</p>
</li>
</ul>

<p class="author1">The function returns a new copy of the state we pass to it.</p>

<p class="author1">The action parameter can be whatever you want, but typically it is an object with a string <code class="calibre21">type</code> attribute and a <code class="calibre21">payload</code> with
additional information. You can think of the <code class="calibre21">type</code> as a command name and the <code class="calibre21">payload</code> as parameters to the command.</p>

<p class="author1">For example, if we number our tile positions from 0 (top-left) to 8 (bottom-right), we might tell the reducer to move whatever tile
is in the top-left corner with:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">{</code><code class="nx">type</code><code class="o">:</code> <code class="s">'move'</code><code class="go">,</code> <code class="nx">payload</code><code class="o">:</code> <code class="mi">0</code><code class="go">}</code></pre>

<p class="author1">We need an object or array that completely defines our game’s internal state. We could use a simple array of strings:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">[</code><code class="s">'1'</code><code class="go">,</code> <code class="s">'2'</code><code class="go">,</code> <code class="s">'3'</code><code class="go">,</code> <code class="kr">null</code><code class="go">,</code> <code class="s">'5'</code><code class="go">,</code> <code class="s">'6'</code><code class="go">,</code> <code class="s">'7'</code><code class="go">,</code> <code class="s">'8'</code><code class="go">,</code> <code class="s">'4'</code><code class="go">]</code></pre>

<p class="author1">That would represent the tiles laid out like this:</p>
<table class="calibre10">

<tbody class="calibre14">
<tr class="calibre12">
<td class="calibre15"><p class="author1">1</p></td>
<td class="calibre15"><p class="author1">2</p></td>
<td class="calibre15"><p class="author1">3</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"/>
<td class="calibre15"><p class="author1">5</p></td>
<td class="calibre15"><p class="author1">6</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1">7</p></td>
<td class="calibre15"><p class="author1">8</p></td>
<td class="calibre15"><p class="author1">4</p></td>
</tr>
</tbody>
</table>

<p class="author1">However, a slightly more flexible approach uses an object for our state and gives it an <code class="calibre21">items</code> attribute containing the current
tile layout:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">{</code>
    <code class="nx">items</code><code class="o">:</code> <code class="go">[</code><code class="s">'1'</code><code class="go">,</code> <code class="s">'2'</code><code class="go">,</code> <code class="s">'3'</code><code class="go">,</code> <code class="kr">null</code><code class="go">,</code> <code class="s">'5'</code><code class="go">,</code> <code class="s">'6'</code><code class="go">,</code> <code class="s">'7'</code><code class="go">,</code> <code class="s">'8'</code><code class="go">,</code> <code class="s">'4'</code><code class="go">]</code>
<code class="go">}</code></pre>

<p class="author1">Why would we do this? Because it will allow our reducer to return other state values, such as whether or not the game is complete:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">{</code>
    <code class="nx">items</code><code class="o">:</code> <code class="go">[</code><code class="s">'1'</code><code class="go">,</code> <code class="s">'2'</code><code class="go">,</code> <code class="s">'3'</code><code class="go">,</code> <code class="s">'4'</code><code class="go">,</code> <code class="s">'5'</code><code class="go">,</code> <code class="s">'6'</code><code class="go">,</code> <code class="s">'7'</code><code class="go">,</code> <code class="s">'8'</code><code class="go">,</code> <code class="kr">null</code><code class="go">],</code>
    <code class="nx">complete</code><code class="o">:</code> <code class="kr">true</code>
<code class="go">}</code></pre>

<p class="author1">We’ve decided on an action (<code class="calibre21">move</code>) and know how the state will be structured, which means we’ve done enough design to create a
test:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">reducer</code> <code class="nx">from</code> <code class="s">'./reducer'</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'reducer'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should be able to move 1 down if gap below'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">let</code> <code class="nx">state</code> <code class="o">=</code> <code class="go">{</code>
      <code class="nx">items</code><code class="o">:</code> <code class="go">[</code><code class="s">'1'</code><code class="go">,</code> <code class="s">'2'</code><code class="go">,</code> <code class="s">'3'</code><code class="go">,</code> <code class="kr">null</code><code class="go">,</code> <code class="s">'5'</code><code class="go">,</code> <code class="s">'6'</code><code class="go">,</code> <code class="s">'7'</code><code class="go">,</code> <code class="s">'8'</code><code class="go">,</code> <code class="s">'4'</code><code class="go">],</code>
    <code class="go">}</code>

    <code class="nx">state</code> <code class="o">=</code> <code class="nx">reducer</code><code class="go">(</code><code class="nx">state</code><code class="go">,</code> <code class="go">{</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'move'</code><code class="go">,</code> <code class="nx">payload</code><code class="o">:</code> <code class="mi">0</code> <code class="go">})</code>

    <code class="nx">expect</code><code class="go">(</code><code class="nx">state</code><code class="go">.</code><code class="nx">items</code><code class="go">).</code><code class="nx">toEqual</code><code class="go">([</code>
      <code class="kr">null</code><code class="go">,</code>
      <code class="s">'2'</code><code class="go">,</code>
      <code class="s">'3'</code><code class="go">,</code>
      <code class="s">'1'</code><code class="go">,</code>
      <code class="s">'5'</code><code class="go">,</code>
      <code class="s">'6'</code><code class="go">,</code>
      <code class="s">'7'</code><code class="go">,</code>
      <code class="s">'8'</code><code class="go">,</code>
      <code class="s">'4'</code><code class="go">,</code>
    <code class="go">])</code>
  <code class="go">})</code>

  <code class="nx">it</code><code class="go">(</code><code class="s">'should say when it is complete'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">let</code> <code class="nx">state</code> <code class="o">=</code> <code class="go">{</code>
      <code class="nx">items</code><code class="o">:</code> <code class="go">[</code><code class="s">'1'</code><code class="go">,</code> <code class="s">'2'</code><code class="go">,</code> <code class="s">'3'</code><code class="go">,</code> <code class="s">'4'</code><code class="go">,</code> <code class="s">'5'</code><code class="go">,</code> <code class="s">'6'</code><code class="go">,</code> <code class="s">'7'</code><code class="go">,</code> <code class="kr">null</code><code class="go">,</code> <code class="s">'8'</code><code class="go">],</code>
    <code class="go">}</code>

    <code class="nx">state</code> <code class="o">=</code> <code class="nx">reducer</code><code class="go">(</code><code class="nx">state</code><code class="go">,</code> <code class="go">{</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'move'</code><code class="go">,</code> <code class="nx">payload</code><code class="o">:</code> <code class="mi">8</code> <code class="go">})</code>

    <code class="nx">expect</code><code class="go">(</code><code class="nx">state</code><code class="go">.</code><code class="nx">complete</code><code class="go">).</code><code class="nx">toBe</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>

    <code class="nx">state</code> <code class="o">=</code> <code class="nx">reducer</code><code class="go">(</code><code class="nx">state</code><code class="go">,</code> <code class="go">{</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'move'</code><code class="go">,</code> <code class="nx">payload</code><code class="o">:</code> <code class="mi">5</code> <code class="go">})</code>

    <code class="nx">expect</code><code class="go">(</code><code class="nx">state</code><code class="go">.</code><code class="nx">complete</code><code class="go">).</code><code class="nx">toBe</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">In our first test scenario, we pass in the tiles’ locations in one state. Then we check that the reducer returns the tiles in a new
state.</p>

<p class="author1">In our second test, we perform two tile moves and then look for a <code class="calibre21">complete</code> attribute to tell us the game has ended.</p>

<p class="author1">OK, we’ve delayed looking at<a data-type="indexterm" data-primary="state" data-secondary="complex, managing with reducers" data-tertiary="reducer code" id="idm46634427495992" class="calibre6"/> the actual reducer code long enough:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">function</code> <code class="nx">trySwap</code><code class="go">(</code><code class="nx">newItems</code><code class="go">,</code> <code class="nx">position</code><code class="go">,</code> <code class="nx">t</code><code class="go">)</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">newItems</code><code class="go">[</code><code class="nx">t</code><code class="go">]</code> <code class="o">===</code> <code class="kr">null</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">const</code> <code class="nx">temp</code> <code class="o">=</code> <code class="nx">newItems</code><code class="go">[</code><code class="nx">position</code><code class="go">]</code>
    <code class="nx">newItems</code><code class="go">[</code><code class="nx">position</code><code class="go">]</code> <code class="o">=</code> <code class="nx">newItems</code><code class="go">[</code><code class="nx">t</code><code class="go">]</code>
    <code class="nx">newItems</code><code class="go">[</code><code class="nx">t</code><code class="go">]</code> <code class="o">=</code> <code class="nx">temp</code>
  <code class="go">}</code>
<code class="go">}</code>

<code class="kr">function</code> <code class="nx">arraysEqual</code><code class="go">(</code><code class="nx">a</code><code class="go">,</code> <code class="nx">b</code><code class="go">)</code> <code class="go">{</code>
  <code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="go">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">a</code><code class="go">.</code><code class="nx">length</code><code class="go">;</code> <code class="nx">i</code><code class="o">++</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">a</code><code class="go">[</code><code class="nx">i</code><code class="go">]</code> <code class="o">!==</code> <code class="nx">b</code><code class="go">[</code><code class="nx">i</code><code class="go">])</code> <code class="go">{</code>
      <code class="kr">return</code> <code class="kr">false</code>
    <code class="go">}</code>
  <code class="go">}</code>
  <code class="kr">return</code> <code class="kr">true</code>
<code class="go">}</code>

<code class="kr">const</code> <code class="nx">CORRECT</code> <code class="o">=</code> <code class="go">[</code><code class="s">'1'</code><code class="go">,</code> <code class="s">'2'</code><code class="go">,</code> <code class="s">'3'</code><code class="go">,</code> <code class="s">'4'</code><code class="go">,</code> <code class="s">'5'</code><code class="go">,</code> <code class="s">'6'</code><code class="go">,</code> <code class="s">'7'</code><code class="go">,</code> <code class="s">'8'</code><code class="go">,</code> <code class="kr">null</code><code class="go">]</code>

<code class="kr">function</code> <code class="nx">reducer</code><code class="go">(</code><code class="nx">state</code><code class="go">,</code> <code class="nx">action</code><code class="go">)</code> <code class="go">{</code>
  <code class="kr">switch</code> <code class="go">(</code><code class="nx">action</code><code class="go">.</code><code class="nx">type</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">case</code> <code class="s">'move'</code><code class="o">:</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">position</code> <code class="o">=</code> <code class="nx">action</code><code class="go">.</code><code class="nx">payload</code>
      <code class="kr">const</code> <code class="nx">newItems</code> <code class="o">=</code> <code class="go">[...</code><code class="nx">state</code><code class="go">.</code><code class="nx">items</code><code class="go">]</code>
      <code class="kr">const</code> <code class="nx">col</code> <code class="o">=</code> <code class="nx">position</code> <code class="o">%</code> <code class="mi">3</code>

      <code class="kr">if</code> <code class="go">(</code><code class="nx">position</code> <code class="o">&lt;</code> <code class="mi">6</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">trySwap</code><code class="go">(</code><code class="nx">newItems</code><code class="go">,</code> <code class="nx">position</code><code class="go">,</code> <code class="nx">position</code> <code class="o">+</code> <code class="mi">3</code><code class="go">)</code>
      <code class="go">}</code>
      <code class="kr">if</code> <code class="go">(</code><code class="nx">position</code> <code class="o">&gt;</code> <code class="mi">2</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">trySwap</code><code class="go">(</code><code class="nx">newItems</code><code class="go">,</code> <code class="nx">position</code><code class="go">,</code> <code class="nx">position</code> <code class="o">-</code> <code class="mi">3</code><code class="go">)</code>
      <code class="go">}</code>
      <code class="kr">if</code> <code class="go">(</code><code class="nx">col</code> <code class="o">&lt;</code> <code class="mi">2</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">trySwap</code><code class="go">(</code><code class="nx">newItems</code><code class="go">,</code> <code class="nx">position</code><code class="go">,</code> <code class="nx">position</code> <code class="o">+</code> <code class="mi">1</code><code class="go">)</code>
      <code class="go">}</code>
      <code class="kr">if</code> <code class="go">(</code><code class="nx">col</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">trySwap</code><code class="go">(</code><code class="nx">newItems</code><code class="go">,</code> <code class="nx">position</code><code class="go">,</code> <code class="nx">position</code> <code class="o">-</code> <code class="mi">1</code><code class="go">)</code>
      <code class="go">}</code>

      <code class="kr">return</code> <code class="go">{</code>
        <code class="go">...</code><code class="nx">state</code><code class="go">,</code>
        <code class="nx">items</code><code class="o">:</code> <code class="nx">newItems</code><code class="go">,</code>
        <code class="nx">complete</code><code class="o">:</code> <code class="nx">arraysEqual</code><code class="go">(</code><code class="nx">newItems</code><code class="go">,</code> <code class="nx">CORRECT</code><code class="go">),</code>
      <code class="go">}</code>
    <code class="go">}</code>
    <code class="kr">default</code><code class="o">:</code> <code class="go">{</code>
      <code class="kr">throw</code> <code class="kr">new</code> <code class="nb">Error</code><code class="go">(</code><code class="s">'Unknown action: '</code> <code class="o">+</code> <code class="nx">action</code><code class="go">.</code><code class="nx">type</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">reducer</code></pre>

<p class="author1">Our reducer currently recognizes a single action: <code class="calibre21">move</code>. The code in our <a href="https://oreil.ly/q85H3" class="calibre6">GitHub repository</a> also includes actions for <code class="calibre21">shuffle</code> and <code class="calibre21">reset</code>. The repository also has a more <a href="https://oreil.ly/yRNyU" class="calibre6">exhaustive set of tests</a> that we used to create the previous code.</p>

<p class="author1">But <em class="calibre7">none</em> of this code includes any React components. It’s pure JavaScript and so can be created and tested in isolation from the
outside world.</p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">Be careful to generate a new object in the reducer to represent the new state.<a data-type="indexterm" data-primary="objects" data-secondary="representing state" id="idm46634427244376" class="calibre6"/> Doing so ensures each new state completely
independent of those that came before it.</p>
</div>

<p class="author1">Now it’s time to wire up our reducer <a data-type="indexterm" data-primary="state" data-secondary="complex, managing with reducers" data-tertiary="wiring up reducer to React component" id="idm46634426914024" class="calibre6"/><a data-type="indexterm" data-primary="useReducer hook" id="idm46634426912744" class="calibre6"/>into a React component, with the <code class="calibre21">useReducer</code> hook:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useReducer</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">reducer</code> <code class="nx">from</code> <code class="s">'./reducer'</code>

<code class="kr">import</code> <code class="s">'./Puzzle.css'</code>

<code class="kr">const</code> <code class="nx">Puzzle</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">state</code><code class="go">,</code> <code class="nx">dispatch</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useReducer</code><code class="go">(</code><code class="nx">reducer</code><code class="go">,</code> <code class="go">{</code>
    <code class="nx">items</code><code class="o">:</code> <code class="go">[</code><code class="s">'4'</code><code class="go">,</code> <code class="s">'1'</code><code class="go">,</code> <code class="s">'2'</code><code class="go">,</code> <code class="s">'7'</code><code class="go">,</code> <code class="s">'6'</code><code class="go">,</code> <code class="s">'3'</code><code class="go">,</code> <code class="kr">null</code><code class="go">,</code> <code class="s">'5'</code><code class="go">,</code> <code class="s">'8'</code><code class="go">],</code>
  <code class="go">})</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-squares"</code><code class="go">&gt;</code>
        <code class="go">{</code><code class="nx">state</code><code class="go">.</code><code class="nx">items</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">s</code><code class="go">,</code> <code class="nx">i</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code>
          <code class="go">&lt;</code><code class="nt">div</code>
            <code class="na">className</code><code class="o">=</code><code class="go">{</code><code class="err">`</code><code class="nx">Puzzle</code><code class="o">-</code><code class="nx">square</code> <code class="nx">$</code><code class="go">{</code>
              <code class="nx">s</code> <code class="o">?</code> <code class="s">''</code> <code class="o">:</code> <code class="s">'Puzzle-square-empty'</code>
            <code class="go">}</code><code class="err">`</code><code class="go">}</code>
            <code class="na">key</code><code class="o">=</code><code class="go">{</code><code class="err">`</code><code class="nx">square</code><code class="o">-</code><code class="nx">$</code><code class="go">{</code><code class="nx">i</code><code class="go">}</code><code class="err">`</code><code class="go">}</code>
            <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'move'</code><code class="go">,</code> <code class="nx">payload</code><code class="o">:</code> <code class="nx">i</code> <code class="go">})}</code>
          <code class="go">&gt;</code>
            <code class="go">{</code><code class="nx">s</code><code class="go">}</code>
          <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="go">))}</code>
      <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-controls"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">button</code>
          <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-shuffle"</code>
          <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'shuffle'</code> <code class="go">})}</code>
        <code class="go">&gt;</code>
          <code class="nx">Shuffle</code>
        <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">button</code>
          <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-reset"</code>
          <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'reset'</code> <code class="go">})}</code>
        <code class="go">&gt;</code>
          <code class="nx">Reset</code>
        <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">state</code><code class="go">.</code><code class="nx">complete</code> <code class="o">&amp;&amp;</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-complete"</code><code class="go">&gt;</code><code class="nx">Complete</code><code class="o">!</code><code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">)}</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Puzzle</code></pre>

<p class="author1">Even though our puzzle component is doing something quite complicated, that actual React code is relatively short.</p>

<p class="author1">The <code class="calibre21">useReducer</code> accepts a<a data-type="indexterm" data-primary="arrays" data-secondary="returned by useReducer" id="idm46634426908104" class="calibre6"/> reducer function and a starting state, and it returns a two-element array:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">The first element in the array is the current state from the reducer</p>
</li>
<li class="calibre8">
<p class="author1">The second element is a <code class="calibre21">dispatch</code> function that allows us to send actions to the reducer.</p>
</li>
</ul>

<p class="author1">We display the tiles by looping through the strings in the array given by <code class="calibre21">state.items</code>.</p>

<p class="author1">If someone clicks a tile at position <code class="calibre21">i</code>, we send a <code class="calibre21">move</code> command to the reducer:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code><code class="nx">type</code><code class="o">:</code> <code class="s">'move'</code><code class="go">,</code> <code class="nx">payload</code><code class="o">:</code> <code class="nx">i</code><code class="go">})}</code></pre>

<p class="author1">The React component has no idea what it takes to move the tile. It doesn’t even know if it can move the tile at all. The component
sends the action to the reducer.</p>

<p class="author1">If the <code class="calibre21">move</code> action moves a tile, the component will automatically re-render the component with the tiles in their new positions.
If the game is complete, the component will know by the value of <code class="calibre21">state.complete</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">state</code><code class="go">.</code><code class="nx">complete</code> <code class="o">&amp;&amp;</code> <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">'Puzzle-complete'</code><code class="go">&gt;</code><code class="nx">Complete</code><code class="o">!</code><code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code></pre>

<p class="author1">We also added two buttons to run the <code class="calibre21">shuffle</code> and <code class="calibre21">reset</code> actions, which we omitted earlier but is in the <a href="https://oreil.ly/WmZ18" class="calibre6">GitHub repository</a>.</p>

<p class="author1">Now that we’ve created our component, let’s try it. When we first load the component, we see it in its initial state, as shown
in <a data-type="xref" href="#ch03_image_2" class="calibre6">Figure 3-2</a>.</p>

<figure class="calibre29"><div id="ch03_image_2" class="figure">
<img src="Images/recb_0302.png" alt="" class="calibre66"/>
<h6 class="calibre30"><span class="firstname">Figure 3-2. </span>The starting state of the game</h6>
</div></figure>

<p class="author1">If we click the tile labeled 7, it moves into the gap (see <a data-type="xref" href="#ch03_image_3" class="calibre6">Figure 3-3</a>).</p>

<figure class="calibre29"><div id="ch03_image_3" class="figure">
<img src="Images/recb_0303.png" alt="" class="calibre66"/>
<h6 class="calibre30"><span class="firstname">Figure 3-3. </span>After moving tile 7</h6>
</div></figure>

<p class="author1">If we click the Shuffle button, the reducer rearranges tiles randomly, as shown in <a data-type="xref" href="#ch03_image_4" class="calibre6">Figure 3-4</a>.</p>

<figure class="calibre29"><div id="ch03_image_4" class="figure">
<img src="Images/recb_0304.png" alt="" class="calibre66"/>
<h6 class="calibre30"><span class="firstname">Figure 3-4. </span>The Shuffle button moves tiles to random positions</h6>
</div></figure>

<p class="author1">And if we click Reset, the puzzle changes to the completed position, and the “Complete!” text appears (see <a data-type="xref" href="#ch03_image_5" class="calibre6">Figure 3-5</a>).</p>

<figure class="calibre29"><div id="ch03_image_5" class="figure">
<img src="Images/recb_0305.png" alt="" class="calibre67"/>
<h6 class="calibre30"><span class="firstname">Figure 3-5. </span>The Reset button moves the tiles to their correct positions</h6>
</div></figure>

<p class="author1">We bury all of the complexity inside the reducer function, where we can test it, and the component is simple and easy to maintain.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634427693720">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Reducers <a data-type="indexterm" data-primary="complexity, managing with reducers" id="idm46634426576488" class="calibre6"/><a data-type="indexterm" data-primary="reducers" data-secondary="using to manage complex state" data-tertiary="use cases" id="idm46634426575784" class="calibre6"/>are a way of managing complexity. You will typically use a reducer in either of these cases:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">You have a large amount of internal state to manage.</p>
</li>
<li class="calibre8">
<p class="author1">You need complex logic to manage the internal state of your component.</p>
</li>
</ul>

<p class="author1">If either of these things is correct, then a reducer can make your code significantly easier to manage.</p>

<p class="author1">However, be wary of using reducers for very small components. If your component has a simple state and little logic, you
probably don’t need the added complexity of a reducer.</p>

<p class="author1">Sometimes, even if you do have a complex state, there are alternative approaches. For example, if you are capturing and validating
data in a form, it might be better to create a validating form component (see <a data-type="xref" href="#ch03-03" class="calibre6">“Create and Validate Forms”</a>).</p>

<p class="author1">You need to ensure that your reducer does not have any side effects. Avoid, say, making network calls that update a server. If your
reducer has side effects, there is every chance that it might break. React (sneakily) might sometimes make additional calls to
your reducer in development mode to make sure that no side effects are happening. If you’re using a reducer and notice that React
calls your code twice when rendering a component, it means React is checking for bad behavior.</p>
<div data-type="tip" class="calibre25">
<p class="author1">With all of those provisos, reducers are an excellent tool at fighting complexity. They are integral to libraries such as
Redux, can easily be reused and combined, simplify components, and make your React code significantly easier to test.</p>
</div>

<p class="author1">You can download the source for this recipe from
the <a href="https://oreil.ly/q85H3" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="state" data-secondary="complex, managing with reducers" data-startref="ix_stacmpl" id="idm46634426506360" class="calibre6"/><a data-type="indexterm" data-primary="reducers" data-secondary="using to manage complex state" data-startref="ix_redmgst" id="idm46634426505064" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Create an Undo Feature" class="calibre4"><div class="preface" id="ch03-02">
<h1 class="calibre17">Create an Undo Feature</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634426502280">
<h2 class="calibre27">Problem</h2>

<p class="author1">Part of the promise of JavaScript-rich frameworks like React is that web applications can closely resemble desktop applications.<a data-type="indexterm" data-primary="state" data-secondary="implementing general undo function using undo-reducer" id="ix_staundo" class="calibre6"/><a data-type="indexterm" data-primary="Undo feature, creating" id="ix_Undo" class="calibre6"/><a data-type="indexterm" data-primary="reducers" data-secondary="using to implement undo function" id="ix_redundo" class="calibre6"/> One
common feature in desktop applications is the ability to undo an action. Some native components within React applications
automatically support an undo function. If you edit some text in a text area, and then press Cmd/Ctrl-Z, it will undo your edit. But
what about extending undo into custom components? How is it possible to track state changes without a large amount of code?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634426496520">
<h2 class="calibre27">Solution</h2>

<p class="author1">If a reducer function manages the state in your component, you can implement a quite general undo function using an undo-reducer.</p>

<p class="author1">Consider this piece of code from the <code class="calibre21">Puzzle</code> example from <a data-type="xref" href="#ch03-01" class="calibre6">“Use Reducers to Manage Complex State”</a>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="go">[</code><code class="nx">state</code><code class="go">,</code> <code class="nx">dispatch</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useReducer</code><code class="go">(</code><code class="nx">reducer</code><code class="go">,</code> <code class="go">{</code>
  <code class="nx">items</code><code class="o">:</code> <code class="go">[</code><code class="s">'4'</code><code class="go">,</code> <code class="s">'1'</code><code class="go">,</code> <code class="s">'2'</code><code class="go">,</code> <code class="s">'7'</code><code class="go">,</code> <code class="s">'6'</code><code class="go">,</code> <code class="s">'3'</code><code class="go">,</code> <code class="kr">null</code><code class="go">,</code> <code class="s">'5'</code><code class="go">,</code> <code class="s">'8'</code><code class="go">],</code>
<code class="go">})</code></pre>

<p class="author1">This code uses a reducer function (called <code class="calibre21">reducer</code>) and an initial state to manage the tiles in a number-puzzle game (see <a data-type="xref" href="#ch03_image_6" class="calibre6">Figure 3-6</a>).</p>

<figure class="calibre29"><div id="ch03_image_6" class="figure">
<img src="Images/recb_0301.png" alt="" class="calibre65"/>
<h6 class="calibre30"><span class="firstname">Figure 3-6. </span>A simple number puzzle game</h6>
</div></figure>

<p class="author1">If the user clicks the Shuffle button, the component updates the tile state by sending a <code class="calibre21">shuffle</code> action to the reducer:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">&lt;</code><code class="nt">button</code> <code class="na">className</code><code class="o">=</code><code class="s">'Puzzle-shuffle'</code>
        <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code><code class="nx">type</code><code class="o">:</code> <code class="s">'shuffle'</code><code class="go">})}&gt;</code><code class="nx">Shuffle</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code></pre>

<p class="author1">(For more details on what reducers are and when you should use them, see <a data-type="xref" href="#ch03-01" class="calibre6">“Use Reducers to Manage Complex State”</a>.)</p>

<p class="author1">We will create a new hook called <code class="calibre21">useUndoReducer</code>, which is a drop-in replacement for <code class="calibre21">useReducer</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="go">[</code><code class="nx">state</code><code class="go">,</code> <code class="nx">dispatch</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useUndoReducer</code><code class="go">(</code><code class="nx">reducer</code><code class="go">,</code> <code class="go">{</code>
  <code class="nx">items</code><code class="o">:</code> <code class="go">[</code><code class="s">'4'</code><code class="go">,</code> <code class="s">'1'</code><code class="go">,</code> <code class="s">'2'</code><code class="go">,</code> <code class="s">'7'</code><code class="go">,</code> <code class="s">'6'</code><code class="go">,</code> <code class="s">'3'</code><code class="go">,</code> <code class="kr">null</code><code class="go">,</code> <code class="s">'5'</code><code class="go">,</code> <code class="s">'8'</code><code class="go">],</code>
<code class="go">})</code></pre>

<p class="author1">The <code class="calibre21">useUndoReducer</code> hook will magically give our component the ability to go back in time:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">&lt;</code><code class="nt">button</code>
  <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-undo"</code>
  <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'undo'</code> <code class="go">})}</code>
<code class="go">&gt;</code>
  <code class="nx">Undo</code>
<code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code></pre>

<p class="author1">If we add this button to the component, it undoes the last action the user performed, as shown in <a data-type="xref" href="#ch03_image_7" class="calibre6">Figure 3-7</a>.</p>

<figure class="calibre29"><div id="ch03_image_7" class="figure">
<img src="Images/recb_0307.png" alt="" class="calibre68"/>
<h6 class="calibre30"><span class="firstname">Figure 3-7. </span>(1) Game in progress; (2) Make a move; (3) Click <em class="calibre7">Undo</em> to undo move</h6>
</div></figure>

<p class="author1">But how do we perform this magic? Although <code class="calibre21">useUndoReducer</code> is relatively easy to use, it’s somewhat harder to understand. But it’s
worth doing so that you can adjust the recipe to your requirements.</p>

<p class="author1">We can take advantage of the fact that all reducers work in the same way:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">The action defines what you want to do.</p>
</li>
<li class="calibre8">
<p class="author1">The reducer returns a fresh state after each action.</p>
</li>
<li class="calibre8">
<p class="author1">No side effects are allowed when calling the reducer.</p>
</li>
</ul>

<p class="author1">Also, reducers are just simple JavaScript functions that accept a state object and an action object.</p>

<p class="author1">Because reducers work in such a well-defined way, we can create a new reducer (an undo-reducer) that wraps around another reducer
function. Our undo-reducer will work as an intermediary. It will pass most actions through to the underlying reducer while keeping a
history of all previous states. If someone wants to undo an action, it will find the last state from its history and then return
that without calling the underlying reducer.</p>

<p class="author1">We’ll begin by creating a higher-order function that accepts one reducer and returns another:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">lodash</code> <code class="nx">from</code> <code class="s">'lodash'</code>

<code class="kr">const</code> <code class="nx">undo</code> <code class="o">=</code> <code class="go">(</code><code class="nx">reducer</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code><code class="nx">state</code><code class="go">,</code> <code class="nx">action</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">let</code> <code class="go">{</code>
    <code class="nx">undoHistory</code> <code class="o">=</code> <code class="go">[],</code>
    <code class="nx">undoActions</code> <code class="o">=</code> <code class="go">[],</code>
    <code class="go">...</code><code class="nx">innerState</code>
  <code class="go">}</code> <code class="o">=</code> <code class="nx">lodash</code><code class="go">.</code><code class="nx">cloneDeep</code><code class="go">(</code><code class="nx">state</code><code class="go">)</code>
  <code class="kr">switch</code> <code class="go">(</code><code class="nx">action</code><code class="go">.</code><code class="nx">type</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">case</code> <code class="s">'undo'</code><code class="o">:</code> <code class="go">{</code>
      <code class="kr">if</code> <code class="go">(</code><code class="nx">undoActions</code><code class="go">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">undoActions</code><code class="go">.</code><code class="nx">pop</code><code class="go">()</code>
        <code class="nx">innerState</code> <code class="o">=</code> <code class="nx">undoHistory</code><code class="go">.</code><code class="nx">pop</code><code class="go">()</code>
      <code class="go">}</code>
      <code class="kr">break</code>
    <code class="go">}</code>

    <code class="kr">case</code> <code class="s">'redo'</code><code class="o">:</code> <code class="go">{</code>
      <code class="kr">if</code> <code class="go">(</code><code class="nx">undoActions</code><code class="go">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">undoHistory</code> <code class="o">=</code> <code class="go">[...</code><code class="nx">undoHistory</code><code class="go">,</code> <code class="go">{</code> <code class="go">...</code><code class="nx">innerState</code> <code class="go">}]</code>
        <code class="nx">undoActions</code> <code class="o">=</code> <code class="go">[</code>
          <code class="go">...</code><code class="nx">undoActions</code><code class="go">,</code>
          <code class="nx">undoActions</code><code class="go">[</code><code class="nx">undoActions</code><code class="go">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="go">],</code>
        <code class="go">]</code>
        <code class="nx">innerState</code> <code class="o">=</code> <code class="nx">reducer</code><code class="go">(</code>
          <code class="nx">innerState</code><code class="go">,</code>
          <code class="nx">undoActions</code><code class="go">[</code><code class="nx">undoActions</code><code class="go">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="go">]</code>
        <code class="go">)</code>
      <code class="go">}</code>
      <code class="kr">break</code>
    <code class="go">}</code>

    <code class="kr">default</code><code class="o">:</code> <code class="go">{</code>
      <code class="nx">undoHistory</code> <code class="o">=</code> <code class="go">[...</code><code class="nx">undoHistory</code><code class="go">,</code> <code class="go">{</code> <code class="go">...</code><code class="nx">innerState</code> <code class="go">}]</code>
      <code class="nx">undoActions</code> <code class="o">=</code> <code class="go">[...</code><code class="nx">undoActions</code><code class="go">,</code> <code class="nx">action</code><code class="go">]</code>
      <code class="nx">innerState</code> <code class="o">=</code> <code class="nx">reducer</code><code class="go">(</code><code class="nx">innerState</code><code class="go">,</code> <code class="nx">action</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">}</code>
  <code class="kr">return</code> <code class="go">{</code> <code class="go">...</code><code class="nx">innerState</code><code class="go">,</code> <code class="nx">undoHistory</code><code class="go">,</code> <code class="nx">undoActions</code> <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">undo</code></pre>

<p class="author1">This reducer is quite a complex function, so it’s worth taking some time to understand what it does.</p>

<p class="author1">It creates a reducer function that keeps track of the actions and states we pass to it. Let’s say our game component sends an action
to shuffle the tiles in the game. Our reducer will first check if the action has the type <code class="calibre21">undo</code> or <code class="calibre21">redo</code>. It doesn’t. So it passes
the <code class="calibre21">shuffle</code> action to the underlying reducer that manages the tiles in our game (see <a data-type="xref" href="#ch03_image_8" class="calibre6">Figure 3-8</a>).</p>

<figure class="calibre29"><div id="ch03_image_8" class="figure">
<img src="Images/recb_0308.png" alt="" class="calibre69"/>
<h6 class="calibre30"><span class="firstname">Figure 3-8. </span>The undo-reducer passes most actions to the underlying reducer</h6>
</div></figure>

<p class="author1">As it passes the <code class="calibre21">shuffle</code> action through to the underlying reducer, the <code class="calibre21">undo</code> code keeps track of the existing state and the
<code class="calibre21">shuffle</code> action by adding them to the <code class="calibre21">undoHistory</code> and <code class="calibre21">undoActions</code>. It then returns the state of the underlying game reducer and
the <code class="calibre21">undoHistory</code> and <code class="calibre21">undoActions</code>.<a data-type="indexterm" data-primary="history" data-secondary="undoHistory function" id="idm46634426030712" class="calibre6"/><a data-type="indexterm" data-primary="actions" data-secondary="undoActions function" id="idm46634426029704" class="calibre6"/><a data-type="indexterm" data-primary="undoActions and undoHistory functions" id="idm46634426028760" class="calibre6"/></p>

<p class="author1">If our puzzle component sends in an <code class="calibre21">undo</code> action, the undo-reducer returns the previous state from the <code class="calibre21">undoHistory</code>, completely
bypassing the game’s own reducer function (see <a data-type="xref" href="#ch03_image_9" class="calibre6">Figure 3-9</a>).</p>

<figure class="calibre29"><div id="ch03_image_9" class="figure">
<img src="Images/recb_0309.png" alt="" class="calibre70"/>
<h6 class="calibre30"><span class="firstname">Figure 3-9. </span>For undo actions, the undo-reducer returns the latest historic state</h6>
</div></figure>

<p class="author1">Now let’s look at the <code class="calibre21">useUndoReducer</code> hook itself:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useReducer</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">undo</code> <code class="nx">from</code> <code class="s">'./undo'</code>

<code class="kr">const</code> <code class="nx">useUndoReducer</code> <code class="o">=</code> <code class="go">(</code><code class="nx">reducer</code><code class="go">,</code> <code class="nx">initialState</code><code class="go">)</code> <code class="o">=&gt;</code>
  <code class="nx">useReducer</code><code class="go">(</code><code class="nx">undo</code><code class="go">(</code><code class="nx">reducer</code><code class="go">),</code> <code class="nx">initialState</code><code class="go">)</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">useUndoReducer</code></pre>

<p class="author1">This <code class="calibre21">useUndoReducer</code> hook is a concise piece of code.<a data-type="indexterm" data-primary="useUndoReducer hook" id="idm46634425923128" class="calibre6"/> It’s simply a call to the built-in <code class="calibre21">useReducer</code> hook, but instead of passing
the reducer straight through, it passes <code class="calibre21">undo(reducer)</code>. The result is that your component uses an enhanced version of the reducer
you provide: one that can undo and redo actions.</p>

<p class="author1">Here is our updated <code class="calibre21">Puzzle</code> component (see <a data-type="xref" href="#ch03-01" class="calibre6">“Use Reducers to Manage Complex State”</a> for the original version):</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">reducer</code> <code class="nx">from</code> <code class="s">'./reducer'</code>
<code class="kr">import</code> <code class="nx">useUndoReducer</code> <code class="nx">from</code> <code class="s">'./useUndoReducer'</code>

<code class="kr">import</code> <code class="s">'./Puzzle.css'</code>

<code class="kr">const</code> <code class="nx">Puzzle</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">state</code><code class="go">,</code> <code class="nx">dispatch</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useUndoReducer</code><code class="go">(</code><code class="nx">reducer</code><code class="go">,</code> <code class="go">{</code>
    <code class="nx">items</code><code class="o">:</code> <code class="go">[</code><code class="s">'4'</code><code class="go">,</code> <code class="s">'1'</code><code class="go">,</code> <code class="s">'2'</code><code class="go">,</code> <code class="s">'7'</code><code class="go">,</code> <code class="s">'6'</code><code class="go">,</code> <code class="s">'3'</code><code class="go">,</code> <code class="kr">null</code><code class="go">,</code> <code class="s">'5'</code><code class="go">,</code> <code class="s">'8'</code><code class="go">],</code>
  <code class="go">})</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-squares"</code><code class="go">&gt;</code>
        <code class="go">{</code><code class="nx">state</code><code class="go">.</code><code class="nx">items</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">s</code><code class="go">,</code> <code class="nx">i</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code>
          <code class="go">&lt;</code><code class="nt">div</code>
            <code class="na">className</code><code class="o">=</code><code class="go">{</code><code class="err">`</code><code class="nx">Puzzle</code><code class="o">-</code><code class="nx">square</code> <code class="nx">$</code><code class="go">{</code>
              <code class="nx">s</code> <code class="o">?</code> <code class="s">''</code> <code class="o">:</code> <code class="s">'Puzzle-square-empty'</code>
            <code class="go">}</code><code class="err">`</code><code class="go">}</code>
            <code class="na">key</code><code class="o">=</code><code class="go">{</code><code class="err">`</code><code class="nx">square</code><code class="o">-</code><code class="nx">$</code><code class="go">{</code><code class="nx">i</code><code class="go">}</code><code class="err">`</code><code class="go">}</code>
            <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'move'</code><code class="go">,</code> <code class="nx">payload</code><code class="o">:</code> <code class="nx">i</code> <code class="go">})}</code>
          <code class="go">&gt;</code>
            <code class="go">{</code><code class="nx">s</code><code class="go">}</code>
          <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="go">))}</code>
      <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-controls"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">button</code>
          <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-shuffle"</code>
          <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'shuffle'</code> <code class="go">})}</code>
        <code class="go">&gt;</code>
          <code class="nx">Shuffle</code>
        <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">button</code>
          <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-reset"</code>
          <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'reset'</code> <code class="go">})}</code>
        <code class="go">&gt;</code>
          <code class="nx">Reset</code>
        <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-controls"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">button</code>
          <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-undo"</code>
          <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'undo'</code> <code class="go">})}</code>
        <code class="go">&gt;</code>
          <code class="nx">Undo</code>
        <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">button</code>
          <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-redo"</code>
          <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'redo'</code> <code class="go">})}</code>
        <code class="go">&gt;</code>
          <code class="nx">Redo</code>
        <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">state</code><code class="go">.</code><code class="nx">complete</code> <code class="o">&amp;&amp;</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Puzzle-complete"</code><code class="go">&gt;</code><code class="nx">Complete</code><code class="o">!</code><code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">)}</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Puzzle</code></pre>

<p class="author1">The only changes are that we use <code class="calibre21">useUndoReducer</code> instead of <code class="calibre21">useReducer</code>, and we’ve added a couple of buttons to call the “undo”
and “redo” actions.</p>

<p class="author1">If you now load the component and makes some changes, you can undo the changes one at a time, as shown in <a data-type="xref" href="#ch03_image_10" class="calibre6">Figure 3-10</a>.</p>

<figure class="calibre29"><div id="ch03_image_10" class="figure">
<img src="Images/recb_0301.png" alt="" class="calibre65"/>
<h6 class="calibre30"><span class="firstname">Figure 3-10. </span>With useUndoReducer, you can now send <em class="calibre7">undo</em> and <em class="calibre7">redo</em> actions</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634426495608">
<h2 class="calibre27">Discussion</h2>

<p class="author1">The undo-reducer shown here will work with reducers that accept and return state objects. If your reducer manages state using
arrays, you will have to modify the <code class="calibre21">undo</code> function.</p>

<p class="author1">Because it keeps a history of all previous states, you probably want to avoid using it if your state data is extensive or if you’re
using it in circumstances where it might make a huge number of changes. Otherwise, you might want to limit the maximum size of the
history.</p>

<p class="author1">Also, bear in mind that it maintains its history in memory. If a user reloads the entire page, then the history will disappear. It
should be possible to resolve this issue by persisting the global state in local storage whenever it changes.<a data-type="indexterm" data-primary="storage" data-secondary="persisting global state in local storage" id="idm46634425555032" class="calibre6"/></p>

<p class="author1">You can download the source for this recipe from the
<a href="https://oreil.ly/Oz27A" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="state" data-secondary="implementing general undo function using undo-reducer" data-startref="ix_staundo" id="idm46634425553016" class="calibre6"/><a data-type="indexterm" data-primary="reducers" data-secondary="using to implement undo function" data-startref="ix_redundo" id="idm46634425551640" class="calibre6"/><a data-type="indexterm" data-primary="Undo feature, creating" data-startref="ix_Undo" id="idm46634425550408" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Create and Validate Forms" class="calibre4"><div class="preface" id="ch03-03">
<h1 class="calibre17">Create and Validate Forms</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634425547912">
<h2 class="calibre27">Problem</h2>

<p class="author1">Most React applications use forms to some degree, and most applications take an ad-hoc approach to creating them.<a data-type="indexterm" data-primary="state" data-secondary="forms, creating and validating" id="ix_staform" class="calibre6"/><a data-type="indexterm" data-primary="forms" data-secondary="creating and validating" id="ix_frmcrval" class="calibre6"/> If a team is
building your application, you might find that some developers manage individual fields in separate state variables. Others will
choose to record form state in a single-value object, which is simpler to pass into and out of the form but can be tricky for each
field to update. Field validation often leads to spaghetti code, with some forms validating at submit time and others validating
dynamically as the user types. Some forms might show validation messages when the form first loads. In other forms, the messages
might appear only after the user has touched the fields.</p>

<p class="author1">These variations in design can lead to poor user experience and an inconsistent approach to writing code. In our experience working
with React teams, forms and form validation are common stumbling blocks for developers.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634425542408">
<h2 class="calibre27">Solution</h2>

<p class="author1">To apply some consistency to form development, we will create a <code class="calibre21">SimpleForm</code> component that we will wrap around one or more
<code class="calibre21">InputField</code> components. This is an example of the use of <code class="calibre21">SimpleForm</code> and <code class="calibre21">InputField</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="s">'./App.css'</code>
<code class="kr">import</code> <code class="nx">SimpleForm</code> <code class="nx">from</code> <code class="s">'./SimpleForm'</code>
<code class="kr">import</code> <code class="nx">InputField</code> <code class="nx">from</code> <code class="s">'./InputField'</code>

<code class="kr">const</code> <code class="nx">FormExample0</code> <code class="o">=</code> <code class="go">({</code> <code class="nx">onSubmit</code><code class="go">,</code> <code class="nx">onChange</code><code class="go">,</code> <code class="nx">initialValue</code> <code class="o">=</code> <code class="go">{}</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">formFields</code><code class="go">,</code> <code class="nx">setFormFields</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="nx">initialValue</code><code class="go">)</code>

  <code class="kr">const</code> <code class="go">[</code><code class="nx">valid</code><code class="go">,</code> <code class="nx">setValid</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">errors</code><code class="go">,</code> <code class="nx">setErrors</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">({})</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">onChange</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">onChange</code><code class="go">(</code><code class="nx">formFields</code><code class="go">,</code> <code class="nx">valid</code><code class="go">,</code> <code class="nx">errors</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">onChange</code><code class="go">,</code> <code class="nx">formFields</code><code class="go">,</code> <code class="nx">valid</code><code class="go">,</code> <code class="nx">errors</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"TheForm"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Single</code> <code class="nx">field</code><code class="go">&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">SimpleForm</code>
        <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">formFields</code><code class="go">}</code>
        <code class="na">onChange</code><code class="o">=</code><code class="go">{</code><code class="nx">setFormFields</code><code class="go">}</code>
        <code class="na">onValid</code><code class="o">=</code><code class="go">{(</code><code class="nx">v</code><code class="go">,</code> <code class="nx">errs</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="nx">setValid</code><code class="go">(</code><code class="nx">v</code><code class="go">)</code>
          <code class="nx">setErrors</code><code class="go">(</code><code class="nx">errs</code><code class="go">)</code>
        <code class="go">}}</code>
      <code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">InputField</code>
          <code class="na">name</code><code class="o">=</code><code class="s">"field1"</code>
          <code class="na">onValidate</code><code class="o">=</code><code class="go">{(</code><code class="nx">v</code><code class="go">)</code> <code class="o">=&gt;</code>
            <code class="o">!</code><code class="nx">v</code> <code class="o">||</code> <code class="nx">v</code><code class="go">.</code><code class="nx">length</code> <code class="o">&lt;</code> <code class="mi">3</code> <code class="o">?</code> <code class="s">'Too short!'</code> <code class="o">:</code> <code class="kr">null</code>
          <code class="go">}</code>
        <code class="go">/&gt;</code>

        <code class="go">&lt;</code><code class="nt">button</code>
          <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">onSubmit</code> <code class="o">&amp;&amp;</code> <code class="nx">onSubmit</code><code class="go">(</code><code class="nx">formFields</code><code class="go">)}</code>
          <code class="na">disabled</code><code class="o">=</code><code class="go">{</code><code class="o">!</code><code class="nx">valid</code><code class="go">}</code>
        <code class="go">&gt;</code>
          <code class="nx">Submit</code><code class="o">!</code>
        <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">SimpleForm</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">FormExample0</code></pre>

<p class="author1">We track the state <a data-type="indexterm" data-primary="state" data-secondary="forms, creating and validating" data-tertiary="tracking form state in formFields object" id="idm46634425535960" class="calibre6"/>of the form in a single object, <code class="calibre21">formFields</code>. Whenever we change a field in the form, the field will call
<code class="calibre21">onChange</code> on the <code class="calibre21">SimpleForm</code>. <a data-type="indexterm" data-primary="validation" data-secondary="simple form with field validation" id="idm46634425250392" class="calibre6"/>The <code class="calibre21">field1</code> field is validated using the <code class="calibre21">onValidate</code> method, and whenever the validation state
changes, the field calls the <code class="calibre21">onValid</code> method on the <code class="calibre21">SimpleForm</code>. Validation will occur only if the user has interacted with a
field: making it <em class="calibre7">dirty</em>.</p>

<p class="author1">You can see the form running in <a data-type="xref" href="#ch03_image_11" class="calibre6">Figure 3-11</a>.</p>

<p class="author1">There is no need to track individual field values. The form value object records individual field values with attributes derived
from the name of the field. The <code class="calibre21">InputField</code> handles the details of when to run the validation: it will update the form value and
decide when to display errors.</p>

<figure class="calibre29"><div id="ch03_image_11" class="figure">
<img src="Images/recb_0311.png" alt="" class="calibre71"/>
<h6 class="calibre30"><span class="firstname">Figure 3-11. </span>A simple form with field validation</h6>
</div></figure>

<p class="author1"><a data-type="xref" href="#ch03_image_12" class="calibre6">Figure 3-12</a> shows a slightly more complex example that uses the <code class="calibre21">SimpleForm</code> with several fields.</p>

<figure class="calibre29"><div id="ch03_image_12" class="figure">
<img src="Images/recb_0312.png" alt="" class="calibre72"/>
<h6 class="calibre30"><span class="firstname">Figure 3-12. </span>A more complex form</h6>
</div></figure>

<p class="author1">To create the <code class="calibre21">SimpleForm</code> and <code class="calibre21">InputField</code> components, we must first look at how they will communicate with each other. An
<code class="calibre21">InputField</code> component will need to tell the <code class="calibre21">SimpleForm</code> when its value has changed and whether or not the new value is valid. It
will do this with a context.<a data-type="indexterm" data-primary="contexts" data-secondary="FormContext example" id="idm46634425236520" class="calibre6"/></p>

<p class="author1">A <em class="calibre7">context</em> is a storage scope.<a data-type="indexterm" data-primary="storage" data-secondary="context as storage scope" id="idm46634425234712" class="calibre6"/> When a component stores values in a context, that value is visible to its subcomponents. The
<code class="calibre21">SimpleForm</code> will create a context called <code class="calibre21">FormCon⁠text</code> and use it to store a set of callback functions that any child component can
use to communicate with the form:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">createContext</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>

<code class="kr">const</code> <code class="nx">FormContext</code> <code class="o">=</code> <code class="nx">createContext</code><code class="go">({})</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">FormContext</code></pre>

<p class="author1">To see how <code class="calibre21">SimpleForm</code> works, let’s begin with a simplified version, which tracks only its subcomponents’ values, <a data-type="indexterm" data-primary="forms" data-secondary="creating and validating" data-tertiary="SimpleForm without validation" id="idm46634425212792" class="calibre6"/>without worrying
about validation just yet:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">React</code><code class="go">,</code> <code class="go">{</code> <code class="nx">useCallback</code><code class="go">,</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>

<code class="kr">import</code> <code class="s">'./SimpleForm.css'</code>
<code class="kr">import</code> <code class="nx">FormContext</code> <code class="nx">from</code> <code class="s">'./FormContext'</code>

<code class="kr">function</code> <code class="nx">updateWith</code><code class="go">(</code><code class="nx">oldValue</code><code class="go">,</code> <code class="nx">field</code><code class="go">,</code> <code class="nx">value</code><code class="go">)</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">newValue</code> <code class="o">=</code> <code class="go">{</code> <code class="go">...</code><code class="nx">oldValue</code> <code class="go">}</code>
  <code class="nx">newValue</code><code class="go">[</code><code class="nx">field</code><code class="go">]</code> <code class="o">=</code> <code class="nx">value</code>
  <code class="kr">return</code> <code class="nx">newValue</code>
<code class="go">}</code>

<code class="kr">const</code> <code class="nx">SimpleForm</code> <code class="o">=</code> <code class="go">({</code> <code class="nx">children</code><code class="go">,</code> <code class="nx">value</code><code class="go">,</code> <code class="nx">onChange</code><code class="go">,</code> <code class="nx">onValid</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">values</code><code class="go">,</code> <code class="nx">setValues</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="nx">value</code> <code class="o">||</code> <code class="go">{})</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">setValues</code><code class="go">(</code><code class="nx">value</code> <code class="o">||</code> <code class="go">{})</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">value</code><code class="go">])</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">onChange</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">onChange</code><code class="go">(</code><code class="nx">values</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">onChange</code><code class="go">,</code> <code class="nx">values</code><code class="go">])</code>

  <code class="kr">let</code> <code class="nx">setValue</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="go">(</code>
    <code class="go">(</code><code class="nx">field</code><code class="go">,</code> <code class="nx">v</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">setValues</code><code class="go">((</code><code class="nx">vs</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">updateWith</code><code class="go">(</code><code class="nx">vs</code><code class="go">,</code> <code class="nx">field</code><code class="go">,</code> <code class="nx">v</code><code class="go">)),</code>
    <code class="go">[</code><code class="nx">setValues</code><code class="go">]</code>
  <code class="go">)</code>
  <code class="kr">let</code> <code class="nx">getValue</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="go">((</code><code class="nx">field</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">values</code><code class="go">[</code><code class="nx">field</code><code class="go">],</code> <code class="go">[</code><code class="nx">values</code><code class="go">])</code>
  <code class="kr">let</code> <code class="nx">form</code> <code class="o">=</code> <code class="go">{</code>
    <code class="nx">setValue</code><code class="o">:</code> <code class="nx">setValue</code><code class="go">,</code>
    <code class="nx">value</code><code class="o">:</code> <code class="nx">getValue</code><code class="go">,</code>
  <code class="go">}</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"SimpleForm-container"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">FormContext</code><code class="go">.</code><code class="na">Provider</code> <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">form</code><code class="go">}&gt;</code>
        <code class="go">{</code><code class="nx">children</code><code class="go">}</code>
      <code class="go">&lt;/</code><code class="nt">FormContext</code><code class="go">.</code><code class="na">Provider</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">SimpleForm</code></pre>

<p class="author1">The final version of <code class="calibre21">SimpleForm</code> will have additional code for tracking validation and errors, but this cut-down form is easier to
understand.</p>

<p class="author1">The form is going to track all of its field values in the <code class="calibre21">values</code> object. The form creates two callback functions called <code class="calibre21">getValue</code>
and <code class="calibre21">setValue</code> and puts them into the context (as the <code class="calibre21">form</code> object), where subcomponents will find them. We put the <code class="calibre21">form</code> into
the context by wrapping a <code class="calibre21">&lt;FormContext.Provider&gt;</code> around the child components.</p>

<p class="author1">Notice that we have wrapped the <code class="calibre21">getValue</code> and <code class="calibre21">setValue</code> callbacks in <code class="calibre21">useCallback</code>, which prevents the component from creating a
new version of each function every time we render the <code class="calibre21">SimpleForm</code>.</p>

<p class="author1">Whenever a child component calls the <code class="calibre21">form.value()</code> function, it will receive the current value of the specified field. If a child
component calls <code class="calibre21">form.setValue()</code>, it will update that value.</p>

<p class="author1">Now let’s look at <a data-type="indexterm" data-primary="forms" data-secondary="creating and validating" data-tertiary="InputField component without validation" id="idm46634424998008" class="calibre6"/>a simplified version of the <code class="calibre21">InputField</code> component, again with any validation code removed to make it easier to
understand:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">React</code><code class="go">,</code> <code class="go">{</code> <code class="nx">useContext</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">FormContext</code> <code class="nx">from</code> <code class="s">'./FormContext'</code>

<code class="kr">import</code> <code class="s">'./InputField.css'</code>

<code class="kr">const</code> <code class="nx">InputField</code> <code class="o">=</code> <code class="go">(</code><code class="nx">props</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">form</code> <code class="o">=</code> <code class="nx">useContext</code><code class="go">(</code><code class="nx">FormContext</code><code class="go">)</code>

  <code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="nx">form</code><code class="go">.</code><code class="nx">value</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">return</code> <code class="s">'InputField should be wrapped in a form'</code>
  <code class="go">}</code>

  <code class="kr">const</code> <code class="go">{</code> <code class="nx">name</code><code class="go">,</code> <code class="nx">label</code><code class="go">,</code> <code class="go">...</code><code class="nx">otherProps</code> <code class="go">}</code> <code class="o">=</code> <code class="nx">props</code>

  <code class="kr">const</code> <code class="nx">value</code> <code class="o">=</code> <code class="nx">form</code><code class="go">.</code><code class="nx">value</code><code class="go">(</code><code class="nx">name</code><code class="go">)</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"InputField"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">label</code> <code class="na">htmlFor</code><code class="o">=</code><code class="go">{</code><code class="nx">name</code><code class="go">}&gt;{</code><code class="nx">label</code> <code class="o">||</code> <code class="nx">name</code><code class="go">}</code><code class="o">:</code><code class="go">&lt;/</code><code class="nt">label</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">input</code>
        <code class="na">id</code><code class="o">=</code><code class="go">{</code><code class="nx">name</code><code class="go">}</code>
        <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">value</code> <code class="o">||</code> <code class="s">''</code><code class="go">}</code>
        <code class="na">onChange</code><code class="o">=</code><code class="go">{(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="nx">form</code><code class="go">.</code><code class="nx">setValue</code><code class="go">(</code><code class="nx">name</code><code class="go">,</code> <code class="nx">event</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">)</code>
        <code class="go">}}</code>
        <code class="go">{</code><code class="na">...otherProps</code><code class="go">}</code>
      <code class="go">/&gt;{</code><code class="s">' '</code><code class="go">}</code>
      <code class="go">{}</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">InputField</code></pre>

<p class="author1">The <code class="calibre21">InputField</code> extracts the <code class="calibre21">form</code> object from the <code class="calibre21">FormContext</code>. If it cannot find a <code class="calibre21">form</code> object, it knows that we have not
wrapped it in a <code class="calibre21">SimpleForm</code> component. The <code class="calibre21">InputField</code> then renders an <code class="calibre21">input</code> field, setting its value to whatever is returned by
<code class="calibre21">form.value(name)</code>. If the user changes the field’s value, the <code class="calibre21">InputField</code> component sends the new value to
<code class="calibre21">form.setValue(name, event.target.value)</code>.</p>

<p class="author1">If you need a form field other than an <code class="calibre21">input</code>, you can wrap it in some component similar to the <code class="calibre21">InputField</code> shown here.</p>

<p class="author1">The validation code is just more of the same.<a data-type="indexterm" data-primary="forms" data-secondary="creating and validating" data-tertiary="SimpleForm with validation code" id="idm46634424678248" class="calibre6"/> In the same way that the form tracks its current value in the <code class="calibre21">values</code> state, it also
needs to track which fields are dirty and which are invalid. It then needs to pass callbacks for <code class="calibre21">setDirty</code>, <code class="calibre21">isDirty</code>, and
<code class="calibre21">setIn⁠valid</code>. These callbacks are used by the child fields when running their 
<span class="firstname"><code class="calibre21">onValidate</code></span> code.</p>

<p class="author1">Here is the final version of the <code class="calibre21">SimpleForm</code> component, including validation:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useCallback</code><code class="go">,</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">FormContext</code> <code class="nx">from</code> <code class="s">'./FormContext'</code>
<code class="kr">import</code> <code class="s">'./SimpleForm.css'</code>

<code class="kr">const</code> <code class="nx">SimpleForm</code> <code class="o">=</code> <code class="go">({</code> <code class="nx">children</code><code class="go">,</code> <code class="nx">value</code><code class="go">,</code> <code class="nx">onChange</code><code class="go">,</code> <code class="nx">onValid</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">values</code><code class="go">,</code> <code class="nx">setValues</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="nx">value</code> <code class="o">||</code> <code class="go">{})</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">dirtyFields</code><code class="go">,</code> <code class="nx">setDirtyFields</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">({})</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">invalidFields</code><code class="go">,</code> <code class="nx">setInvalidFields</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">({})</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">setValues</code><code class="go">(</code><code class="nx">value</code> <code class="o">||</code> <code class="go">{})</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">value</code><code class="go">])</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">onChange</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">onChange</code><code class="go">(</code><code class="nx">values</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">onChange</code><code class="go">,</code> <code class="nx">values</code><code class="go">])</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">onValid</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">onValid</code><code class="go">(</code>
        <code class="nb">Object</code><code class="go">.</code><code class="nx">keys</code><code class="go">(</code><code class="nx">invalidFields</code><code class="go">).</code><code class="nx">every</code><code class="go">((</code><code class="nx">i</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="o">!</code><code class="nx">invalidFields</code><code class="go">[</code><code class="nx">i</code><code class="go">]),</code>
        <code class="nx">invalidFields</code>
      <code class="go">)</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">onValid</code><code class="go">,</code> <code class="nx">invalidFields</code><code class="go">])</code>

  <code class="kr">const</code> <code class="nx">setValue</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="go">(</code>
    <code class="go">(</code><code class="nx">field</code><code class="go">,</code> <code class="nx">v</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">setValues</code><code class="go">((</code><code class="nx">vs</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">({</code> <code class="go">...</code><code class="nx">vs</code><code class="go">,</code> <code class="go">[</code><code class="nx">field</code><code class="go">]</code><code class="o">:</code> <code class="nx">v</code> <code class="go">})),</code>
    <code class="go">[</code><code class="nx">setValues</code><code class="go">]</code>
  <code class="go">)</code>
  <code class="kr">const</code> <code class="nx">getValue</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="go">((</code><code class="nx">field</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">values</code><code class="go">[</code><code class="nx">field</code><code class="go">],</code> <code class="go">[</code><code class="nx">values</code><code class="go">])</code>
  <code class="kr">const</code> <code class="nx">setDirty</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="go">(</code>
    <code class="go">(</code><code class="nx">field</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">setDirtyFields</code><code class="go">((</code><code class="nx">df</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">({</code> <code class="go">...</code><code class="nx">df</code><code class="go">,</code> <code class="go">[</code><code class="nx">field</code><code class="go">]</code><code class="o">:</code> <code class="kr">true</code> <code class="go">})),</code>
    <code class="go">[</code><code class="nx">setDirtyFields</code><code class="go">]</code>
  <code class="go">)</code>
  <code class="kr">const</code> <code class="nx">getDirty</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="go">(</code>
    <code class="go">(</code><code class="nx">field</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nb">Object</code><code class="go">.</code><code class="nx">keys</code><code class="go">(</code><code class="nx">dirtyFields</code><code class="go">).</code><code class="nx">includes</code><code class="go">(</code><code class="nx">field</code><code class="go">),</code>
    <code class="go">[</code><code class="nx">dirtyFields</code><code class="go">]</code>
  <code class="go">)</code>
  <code class="kr">const</code> <code class="nx">setInvalid</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="go">(</code>
    <code class="go">(</code><code class="nx">field</code><code class="go">,</code> <code class="nx">error</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">setInvalidFields</code><code class="go">((</code><code class="nx">i</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">({</code>
        <code class="go">...</code><code class="nx">i</code><code class="go">,</code>
        <code class="go">[</code><code class="nx">field</code><code class="go">]</code><code class="o">:</code> <code class="nx">error</code> <code class="o">?</code> <code class="nx">error</code> <code class="o">:</code> <code class="kr">undefined</code><code class="go">,</code>
      <code class="go">}))</code>
    <code class="go">},</code>
    <code class="go">[</code><code class="nx">setInvalidFields</code><code class="go">]</code>
  <code class="go">)</code>
  <code class="kr">const</code> <code class="nx">form</code> <code class="o">=</code> <code class="go">{</code>
    <code class="nx">setValue</code><code class="o">:</code> <code class="nx">setValue</code><code class="go">,</code>
    <code class="nx">value</code><code class="o">:</code> <code class="nx">getValue</code><code class="go">,</code>

    <code class="nx">setDirty</code><code class="o">:</code> <code class="nx">setDirty</code><code class="go">,</code>
    <code class="nx">isDirty</code><code class="o">:</code> <code class="nx">getDirty</code><code class="go">,</code>

    <code class="nx">setInvalid</code><code class="o">:</code> <code class="nx">setInvalid</code><code class="go">,</code>
  <code class="go">}</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"SimpleForm-container"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">FormContext</code><code class="go">.</code><code class="na">Provider</code> <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">form</code><code class="go">}&gt;</code>
        <code class="go">{</code><code class="nx">children</code><code class="go">}</code>
      <code class="go">&lt;/</code><code class="nt">FormContext</code><code class="go">.</code><code class="na">Provider</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">SimpleForm</code></pre>

<p class="author1">And this is the final version of the <code class="calibre21">InputField</code> component.<a data-type="indexterm" data-primary="forms" data-secondary="creating and validating" data-tertiary="InputField component with validation" id="idm46634424664968" class="calibre6"/><a data-type="indexterm" data-primary="validation" data-secondary="InputField component with validation" id="idm46634424663752" class="calibre6"/> Notice that the field is counted as <em class="calibre7">dirty</em> once it loses focus or its
value changes:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useContext</code><code class="go">,</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">FormContext</code> <code class="nx">from</code> <code class="s">'./FormContext'</code>

<code class="kr">import</code> <code class="s">'./InputField.css'</code>

<code class="kr">const</code> <code class="nx">splitCamelCase</code> <code class="o">=</code> <code class="go">(</code><code class="nx">s</code><code class="go">)</code> <code class="o">=&gt;</code>
  <code class="nx">s</code>
    <code class="go">.</code><code class="nx">replace</code><code class="go">(</code><code class="sr">/([a-z0-9])([A-Z0-9])/g</code><code class="go">,</code> <code class="s">'$1 $2'</code><code class="go">)</code>
    <code class="go">.</code><code class="nx">replace</code><code class="go">(</code><code class="sr">/^([a-z])/</code><code class="go">,</code> <code class="go">(</code><code class="nx">x</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">x</code><code class="go">.</code><code class="nx">toUpperCase</code><code class="go">())</code>

<code class="kr">const</code> <code class="nx">InputField</code> <code class="o">=</code> <code class="go">(</code><code class="nx">props</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">form</code> <code class="o">=</code> <code class="nx">useContext</code><code class="go">(</code><code class="nx">FormContext</code><code class="go">)</code>

  <code class="kr">const</code> <code class="go">[</code><code class="nx">error</code><code class="go">,</code> <code class="nx">setError</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="s">''</code><code class="go">)</code>

  <code class="kr">const</code> <code class="go">{</code> <code class="nx">onValidate</code><code class="go">,</code> <code class="nx">name</code><code class="go">,</code> <code class="nx">label</code><code class="go">,</code> <code class="go">...</code><code class="nx">otherProps</code> <code class="go">}</code> <code class="o">=</code> <code class="nx">props</code>

  <code class="kr">let</code> <code class="nx">value</code> <code class="o">=</code> <code class="nx">form</code><code class="go">.</code><code class="nx">value</code> <code class="o">&amp;&amp;</code> <code class="nx">form</code><code class="go">.</code><code class="nx">value</code><code class="go">(</code><code class="nx">name</code><code class="go">)</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">onValidate</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">setError</code><code class="go">(</code><code class="nx">onValidate</code><code class="go">(</code><code class="nx">value</code><code class="go">))</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">onValidate</code><code class="go">,</code> <code class="nx">value</code><code class="go">])</code>

  <code class="kr">const</code> <code class="nx">setInvalid</code> <code class="o">=</code> <code class="nx">form</code><code class="go">.</code><code class="nx">setInvalid</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">setInvalid</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">setInvalid</code><code class="go">(</code><code class="nx">name</code><code class="go">,</code> <code class="nx">error</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">setInvalid</code><code class="go">,</code> <code class="nx">name</code><code class="go">,</code> <code class="nx">error</code><code class="go">])</code>

  <code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="nx">form</code><code class="go">.</code><code class="nx">value</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">return</code> <code class="s">'InputField should be wrapped in a form'</code>
  <code class="go">}</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"InputField"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">label</code> <code class="na">htmlFor</code><code class="o">=</code><code class="go">{</code><code class="nx">name</code><code class="go">}&gt;{</code><code class="nx">label</code> <code class="o">||</code> <code class="nx">splitCamelCase</code><code class="go">(</code><code class="nx">name</code><code class="go">)}</code><code class="o">:</code><code class="go">&lt;/</code><code class="nt">label</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">input</code>
        <code class="na">id</code><code class="o">=</code><code class="go">{</code><code class="nx">name</code><code class="go">}</code>
        <code class="na">onBlur</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">form</code><code class="go">.</code><code class="nx">setDirty</code><code class="go">(</code><code class="nx">name</code><code class="go">)}</code>
        <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">value</code> <code class="o">||</code> <code class="s">''</code><code class="go">}</code>
        <code class="na">onChange</code><code class="o">=</code><code class="go">{(</code><code class="nx">event</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="nx">form</code><code class="go">.</code><code class="nx">setDirty</code><code class="go">(</code><code class="nx">name</code><code class="go">)</code>
          <code class="nx">form</code><code class="go">.</code><code class="nx">setValue</code><code class="go">(</code><code class="nx">name</code><code class="go">,</code> <code class="nx">event</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">)</code>
        <code class="go">}}</code>
        <code class="go">{</code><code class="na">...otherProps</code><code class="go">}</code>
      <code class="go">/&gt;{</code><code class="s">' '</code><code class="go">}</code>
      <code class="go">{</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"InputField-error"</code><code class="go">&gt;</code>
          <code class="go">{</code><code class="nx">form</code><code class="go">.</code><code class="nx">isDirty</code><code class="go">(</code><code class="nx">name</code><code class="go">)</code> <code class="o">&amp;&amp;</code> <code class="nx">error</code> <code class="o">?</code> <code class="nx">error</code> <code class="o">:</code> <code class="go">&lt;&gt;</code><code class="o">&amp;</code><code class="nx">nbsp</code><code class="go">;&lt;/&gt;}</code>
        <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">}</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">InputField</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634425541464">
<h2 class="calibre27">Discussion</h2>

<p class="author1">You can use this recipe to create many simple forms, and you can extend it for use with any React component. For example, if you are
using a third-party calendar or date picker, you would only need to wrap it in a component similar to <code class="calibre21">InputField</code> to use it inside
a <code class="calibre21">SimpleForm</code>.</p>

<p class="author1">This recipe doesn’t support forms within forms or arrays of forms.<a data-type="indexterm" data-primary="arrays" data-secondary="of forms" data-secondary-sortas="forms" id="idm46634424334136" class="calibre6"/> It should be possible to modify the <code class="calibre21">SimpleForm</code> component to
behave like an <code class="calibre21">InputField</code> to place one form inside another.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/gU03F" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="state" data-secondary="forms, creating and validating" data-startref="ix_staform" id="idm46634423850072" class="calibre6"/><a data-type="indexterm" data-primary="forms" data-secondary="creating and validating" data-startref="ix_frmcrval" id="idm46634423848776" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Measure Time with a Clock" class="calibre4"><div class="preface" id="ch03-04">
<h1 class="calibre17">Measure Time with a Clock</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634423845880">
<h2 class="calibre27">Problem</h2>

<p class="author1">Sometimes a React application needs to respond to the time of day.<a data-type="indexterm" data-primary="clock, measuring time with" id="ix_clock" class="calibre6"/><a data-type="indexterm" data-primary="time" data-secondary="measuring with a clock" id="ix_timeclk" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="React application responding to time of day" id="ix_statime" class="calibre6"/> It might only need to display the current time, or it might need
to poll a server at regular intervals or change its interface as day turns to night. But how do you cause your code to re-render as
the result of a time change? How do you avoid rendering components too often? And how do you do all that without overcomplicating your
code?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634423840296">
<h2 class="calibre27">Solution</h2>

<p class="author1">We’re going to create a <code class="calibre21">useClock</code> hook.<a data-type="indexterm" data-primary="useClock hook" id="ix_useClk" class="calibre6"/> The <code class="calibre21">useClock</code> hook will give us access to a formatted version of the current date and time
and automatically update the interface when the time changes. Here’s an example of the code in use, and <a data-type="xref" href="#ch03_image_13" class="calibre6">Figure 3-13</a> shows it
running:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">useClock</code> <code class="nx">from</code> <code class="s">'./useClock'</code>
<code class="kr">import</code> <code class="nx">ClockFace</code> <code class="nx">from</code> <code class="s">'./ClockFace'</code>

<code class="kr">import</code> <code class="s">'./Ticker.css'</code>

<code class="kr">const</code> <code class="nx">SimpleTicker</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">isTick</code><code class="go">,</code> <code class="nx">setTick</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>

  <code class="kr">const</code> <code class="nx">time</code> <code class="o">=</code> <code class="nx">useClock</code><code class="go">(</code><code class="s">'HH:mm:ss'</code><code class="go">)</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">setTick</code><code class="go">((</code><code class="nx">t</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="o">!</code><code class="nx">t</code><code class="go">)</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">time</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Ticker"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Ticker-clock"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Time</code> <code class="go">{</code><code class="nx">isTick</code> <code class="o">?</code> <code class="s">'Tick!'</code> <code class="o">:</code> <code class="s">'Tock!'</code><code class="go">}&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>
        <code class="go">{</code><code class="nx">time</code><code class="go">}</code>
        <code class="go">&lt;</code><code class="nt">br</code> <code class="go">/&gt;</code>
        <code class="go">&lt;</code><code class="nt">ClockFace</code> <code class="na">time</code><code class="o">=</code><code class="go">{</code><code class="nx">time</code><code class="go">}</code> <code class="go">/&gt;</code>
      <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">SimpleTicker</code></pre>

<figure class="calibre29"><div id="ch03_image_13" class="figure">
<img src="Images/recb_0313.png" alt="" class="calibre73"/>
<h6 class="calibre30"><span class="firstname">Figure 3-13. </span>The <code class="calibre21">SimpleTicker</code> over three seconds</h6>
</div></figure>

<p class="author1">The <code class="calibre21">time</code> variable contains the current time in the format <code class="calibre21">HH:mm:ss</code>. When the time changes, the value of the <code class="calibre21">isTick</code> state is
toggled between true and false and then used to display the word <em class="calibre7">Tick!</em> or <em class="calibre7">Tock!</em> We show the current time and then also display
the time with a <code class="calibre21">ClockFace</code> component.<a data-type="indexterm" data-primary="intervals" data-secondary="IntervalTicker for clock component" id="idm46634423718456" class="calibre6"/></p>

<p class="author1">As well as accepting a date and time format, <code class="calibre21">useClock</code> can take a number specifying the number of milliseconds between updates
(see <a data-type="xref" href="#ch03_image_14" class="calibre6">Figure 3-14</a>):</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">useClock</code> <code class="nx">from</code> <code class="s">'./useClock'</code>

<code class="kr">import</code> <code class="s">'./Ticker.css'</code>

<code class="kr">const</code> <code class="nx">IntervalTicker</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">isTick3</code><code class="go">,</code> <code class="nx">setTick3</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>

  <code class="kr">const</code> <code class="nx">tickThreeSeconds</code> <code class="o">=</code> <code class="nx">useClock</code><code class="go">(</code><code class="mi">3000</code><code class="go">)</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">setTick3</code><code class="go">((</code><code class="nx">t</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="o">!</code><code class="nx">t</code><code class="go">)</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">tickThreeSeconds</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Ticker"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Ticker-clock"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;{</code><code class="nx">isTick3</code> <code class="o">?</code> <code class="s">'3 Second Tick!'</code> <code class="o">:</code> <code class="s">'3 Second Tock!'</code><code class="go">}&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>
        <code class="go">{</code><code class="nx">tickThreeSeconds</code><code class="go">}</code>
      <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">IntervalTicker</code></pre>

<figure class="calibre29"><div id="ch03_image_14" class="figure">
<img src="Images/recb_0314.png" alt="" class="calibre74"/>
<h6 class="calibre30"><span class="firstname">Figure 3-14. </span>The <code class="calibre21">IntervalTicker</code> re-renders the component every three seconds</h6>
</div></figure>

<p class="author1">This version is more useful if you want to perform some task at regular intervals, such as polling a network service.<a data-type="indexterm" data-primary="polling a network service" id="idm46634423533912" class="calibre6"/></p>
<div data-type="tip" class="calibre25">
<p class="author1">To poll a network service, consider using a clock with <a data-type="xref" href="ch05.xhtml#ch05-01" class="calibre6">“Convert Network Calls to Hooks”</a>. If the current value of the clock is passed as a dependency
to a hook that makes network calls, the network call will be repeated every time the clock changes.</p>
</div>

<p class="author1">If you pass a numeric parameter to <code class="calibre21">useClock</code>, it will return a time string in ISO format like <code class="calibre21">2021-06-11T14:50:34.706</code>.</p>

<p class="author1">To build this hook, we will use a third-party library called <a href="https://momentjs.com" class="calibre6">Moment.js</a> to handle date and time formatting.<a data-type="indexterm" data-primary="dates and time" data-secondary="formatting library, MomentJS" id="idm46634423528648" class="calibre6"/><a data-type="indexterm" data-primary="MomentJS library" id="idm46634423527704" class="calibre6"/> If you would prefer to use another library, such as <a href="https://day.js.org" class="calibre6">Day.js</a>, it should be straightforward to 
<span class="firstname">convert</span>:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install moment</code></pre>

<p class="author1">This is the code for <code class="calibre21">useClock</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">moment</code> <code class="nx">from</code> <code class="s">'moment'</code>

<code class="kr">const</code> <code class="nx">useClock</code> <code class="o">=</code> <code class="go">(</code><code class="nx">formatOrInterval</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">format</code> <code class="o">=</code>
    <code class="kr">typeof</code> <code class="nx">formatOrInterval</code> <code class="o">===</code> <code class="s">'string'</code>
      <code class="o">?</code> <code class="nx">formatOrInterval</code>
      <code class="o">:</code> <code class="s">'YYYY-MM-DDTHH:mm:ss.SSS'</code>
  <code class="kr">const</code> <code class="nx">interval</code> <code class="o">=</code>
    <code class="kr">typeof</code> <code class="nx">formatOrInterval</code> <code class="o">===</code> <code class="s">'number'</code> <code class="o">?</code> <code class="nx">formatOrInterval</code> <code class="o">:</code> <code class="mi">500</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">response</code><code class="go">,</code> <code class="nx">setResponse</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code>
    <code class="nx">moment</code><code class="go">(</code><code class="kr">new</code> <code class="nb">Date</code><code class="go">()).</code><code class="nx">format</code><code class="go">(</code><code class="nx">format</code><code class="go">)</code>
  <code class="go">)</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">const</code> <code class="nx">newTimer</code> <code class="o">=</code> <code class="nx">setInterval</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">setResponse</code><code class="go">(</code><code class="nx">moment</code><code class="go">(</code><code class="kr">new</code> <code class="nb">Date</code><code class="go">()).</code><code class="nx">format</code><code class="go">(</code><code class="nx">format</code><code class="go">))</code>
    <code class="go">},</code> <code class="nx">interval</code><code class="go">)</code>

    <code class="kr">return</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="nx">clearInterval</code><code class="go">(</code><code class="nx">newTimer</code><code class="go">)</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">format</code><code class="go">,</code> <code class="nx">interval</code><code class="go">])</code>

  <code class="kr">return</code> <code class="nx">response</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">useClock</code></pre>

<p class="author1">We derive the date and time <code class="calibre21">format</code> and the required <em class="calibre7">ticking</em> <code class="calibre21">interval</code> from the 
<span class="firstname"><code class="calibre21">formatOrInterval</code></span> parameter passed to the hook.<a data-type="indexterm" data-primary="intervals" data-secondary="ticking interval format" id="idm46634423325880" class="calibre6"/> Then we create a timer with 
<span class="firstname"><code class="calibre21">setInterval</code></span>. This time will set the <code class="calibre21">response</code> value every <code class="calibre21">interval</code> milliseconds. When we set
the <code class="calibre21">response</code> string to a new time, any component that relies on <code class="calibre21">useClock</code> will re-render.</p>

<p class="author1">We need to make sure that we cancel any timers that are no longer in use. We can do this using a feature of the <code class="calibre21">useEffect</code> hook.<a data-type="indexterm" data-primary="useEffect hook" id="idm46634423321512" class="calibre6"/> If
we return a function at the end of our <code class="calibre21">useEffect</code> code, then that function will be called the next time <code class="calibre21">useEffect</code> needs to run.
So, we can use it to clear the old timer before creating a new one.</p>

<p class="author1">If we pass a new format or interval to <code class="calibre21">useClock</code>, it will cancel its old timer and respond using a new timer.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634423839704">
<h2 class="calibre27">Discussion</h2>

<p class="author1">This recipe is an example of how you can use hooks to solve a simple problem simply. React code (the clue is in the name) reacts to
dependency changes. Instead of thinking, “How can I run this piece of code every second?” the <code class="calibre21">useClock</code> hook allows you to write
code that depends on the current time and hides away all of the gnarly details of creating timers, updating state, and clearing
timers.</p>

<p class="author1">If you use the <code class="calibre21">useClock</code> hook several times in a component, then a time change can result in multiple renders. For example, if you
have two clocks that format the current time in 12-hour format (04:45) and 24-hour format (16:45), then your component will render
twice when the minute changes. An extra render once a minute is unlikely to have much of a performance impact.</p>

<p class="author1">You can also use the <code class="calibre21">useClock</code> hook inside other hooks. If you create a <code class="calibre21">useMessages</code> hook to retrieve messages from a server, you
can call <code class="calibre21">useClock</code> inside it to poll the server at regular intervals.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/hohKK" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="useClock hook" data-startref="ix_useClk" id="idm46634423312440" class="calibre6"/><a data-type="indexterm" data-primary="clock, measuring time with" data-startref="ix_clock" id="idm46634423311432" class="calibre6"/><a data-type="indexterm" data-primary="time" data-secondary="measuring with a clock" data-startref="ix_timeclk" id="idm46634423310472" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="React application responding to time of day" data-startref="ix_statime" id="idm46634423309256" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Monitor Online Status" class="calibre4"><div class="preface" id="ch03-05">
<h1 class="calibre17">Monitor Online Status</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634423306392">
<h2 class="calibre27">Problem</h2>

<p class="author1">Let’s say someone is using your application on their cell phone, and then they head into a subway with no data connection.<a data-type="indexterm" data-primary="online status, monitoring for application" id="ix_onli" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="monitoring online status" id="ix_stamononl" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="network connection, checking" id="idm46634423302696" class="calibre6"/> How can
you check that the network connection has disappeared? What’s a React-friendly way of updating your interface to either tell the
user that there’s a problem or disable some features that require network access?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634423301160">
<h2 class="calibre27">Solution</h2>

<p class="author1">We will <a data-type="indexterm" data-primary="useOnline hook" id="ix_useOnl" class="calibre6"/>create a hook called <code class="calibre21">useOnline</code> that will tell us whether we’re connected to a network.<a data-type="indexterm" data-primary="network connection, checking for browser" id="idm46634423297752" class="calibre6"/> We need code that runs when the
browser loses or regains a connection to the network. Fortunately, there are window/body-level events called <code class="calibre21">online</code> and 
<span class="firstname"><code class="calibre21">offline</code></span> that do exactly that.<a data-type="indexterm" data-primary="online and offline events" id="idm46634423295464" class="calibre6"/> When the <code class="calibre21">online</code> and <code class="calibre21">offline</code> events are triggered, the current network state will be given by
<code class="calibre21">navigator.onLine</code>, which will be set to <code class="calibre21">true</code> or <code class="calibre21">false</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>

<code class="kr">const</code> <code class="nx">useOnline</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">online</code><code class="go">,</code> <code class="nx">setOnline</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="nx">navigator</code><code class="go">.</code><code class="nx">onLine</code><code class="go">)</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nb">window</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">)</code> <code class="go">{</code>
      <code class="nb">window</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code><code class="s">'online'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="nx">setOnline</code><code class="go">(</code><code class="kr">true</code><code class="go">),</code> <code class="kr">false</code><code class="go">)</code>
      <code class="nb">window</code><code class="go">.</code><code class="nx">addEventListener</code><code class="go">(</code>
        <code class="s">'offline'</code><code class="go">,</code>
        <code class="go">()</code> <code class="o">=&gt;</code> <code class="nx">setOnline</code><code class="go">(</code><code class="kr">false</code><code class="go">),</code>
        <code class="kr">false</code>
      <code class="go">)</code>
    <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
      <code class="nb">document</code><code class="go">.</code><code class="nx">body</code><code class="go">.</code><code class="nx">ononline</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="nx">setOnline</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
      <code class="nb">document</code><code class="go">.</code><code class="nx">body</code><code class="go">.</code><code class="nx">onoffline</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="nx">setOnline</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[])</code>

  <code class="kr">return</code> <code class="nx">online</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">useOnline</code></pre>

<p class="author1">This hook manages its connection state in the <code class="calibre21">online</code> variable. When the hook is first run (notice the empty dependency array), we
register listeners to the browser’s online/offline events. When either of these events occurs, we can set the value of <code class="calibre21">online</code> to
<code class="calibre21">true</code> or <code class="calibre21">false</code>. If this is a change to the current value, then any component using this hook will re-render.</p>

<p class="author1">Here’s an example of the hook in action:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">useOnline</code> <code class="nx">from</code> <code class="s">'./useOnline'</code>
<code class="kr">import</code> <code class="s">'./App.css'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">online</code> <code class="o">=</code> <code class="nx">useOnline</code><code class="go">()</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Network</code> <code class="nx">Checker</code><code class="go">&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">span</code><code class="go">&gt;</code>
        <code class="nx">You</code> <code class="nx">are</code> <code class="nx">now</code><code class="go">....</code>
        <code class="go">{</code><code class="nx">online</code> <code class="o">?</code> <code class="go">(</code>
          <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-indicator-online"</code><code class="go">&gt;</code><code class="nx">ONLINE</code><code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="go">)</code> <code class="o">:</code> <code class="go">(</code>
          <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App-indicator-offline"</code><code class="go">&gt;</code><code class="nx">OFFLINE</code><code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="go">)}</code>
      <code class="go">&lt;/</code><code class="nt">span</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">If you run the app, the page will currently show as online. If you disconnect/reconnect your network, the message will switch to
OFFLINE and then back to ONLINE (see <a data-type="xref" href="#ch03_image_15" class="calibre6">Figure 3-15</a>).</p>

<figure class="calibre29"><div id="ch03_image_15" class="figure">
<img src="Images/recb_0315.png" alt="" class="calibre75"/>
<h6 class="calibre30"><span class="firstname">Figure 3-15. </span>The code re-renders when the network is switched off and back on again</h6>
</div></figure>
</div></section>













<section data-type="sect2" class="calibre4" data-pdf-bookmark="Discussion"><div class="preface" id="idm46634423028664">
<h2 class="calibre27">Discussion</h2>

<p class="author1">It’s important to note that this hook checks your browser’s connection to a network, not whether it connects to the broader Internet
or your server. If you would like to check that your server is running and available, you would have to write additional code.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/9hkSA" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="useOnline hook" data-startref="ix_useOnl" id="idm46634423025656" class="calibre6"/><a data-type="indexterm" data-primary="online status, monitoring for application" data-startref="ix_onli" id="idm46634423024648" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="monitoring online status" data-startref="ix_stamononl" id="idm46634423023608" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Manage Global State with Redux" class="calibre4"><div class="preface" id="ch03-06">
<h1 class="calibre17">Manage Global State with Redux</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634423020744">
<h2 class="calibre27">Problem</h2>

<p class="author1">In other recipes in this chapter, we’ve seen that you can manage complex component state with a pure JavaScript function called a
reducer.<a data-type="indexterm" data-primary="Redux library" data-secondary="managing global state with" id="ix_Rdx" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="global, managing with Redux" id="ix_staglo" class="calibre6"/> <em class="calibre7">Reducers</em> simplify components and make business logic more testable.<a data-type="indexterm" data-primary="reducers" data-secondary="global state management with Redux" id="ix_redglost" class="calibre6"/></p>

<p class="author1">But what if you have some data, such as a shopping basket, that needs to be accessed everywhere?<a data-type="indexterm" data-primary="shopping basket application example" id="ix_shop" class="calibre6"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634423013304">
<h2 class="calibre27">Solution</h2>

<p class="author1">We will use the Redux library to manage the global application state. Redux uses the same reducers we can give to the React
<code class="calibre21">useReducer</code> function, but they are used to manage a single state object for the entire application. Plus, there are many extensions
to Redux that solve common programming problems and develop and manage your application more quickly.</p>

<p class="author1">First, we need to install the Redux library:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install redux</code></pre>

<p class="author1">We will also install the React Redux library, which will make Redux far easier to use with React:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install react-redux</code></pre>

<p class="author1">We’re going to use Redux to build an application containing a shopping basket (see <a data-type="xref" href="#ch03_image_16" class="calibre6">Figure 3-16</a>).</p>

<figure class="calibre29"><div id="ch03_image_16" class="figure">
<img src="Images/recb_0316.png" alt="" class="calibre76"/>
<h6 class="calibre30"><span class="firstname">Figure 3-16. </span>When a customer buys a product, the application adds it to the basket</h6>
</div></figure>

<p class="author1">If a customer clicks a Buy button, the application adds the product to the basket. If they click the Buy button again, the quantity
in the basket is updated. The basket will appear in several places across the application, so it’s a good candidate for moving to
Redux. Here is the reducer function that we will use to manage the basket:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">reducer</code> <code class="o">=</code> <code class="go">(</code><code class="nx">state</code> <code class="o">=</code> <code class="go">{},</code> <code class="nx">action</code> <code class="o">=</code> <code class="go">{})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">switch</code> <code class="go">(</code><code class="nx">action</code><code class="go">.</code><code class="nx">type</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">case</code> <code class="s">'buy'</code><code class="o">:</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">basket</code> <code class="o">=</code> <code class="nx">state</code><code class="go">.</code><code class="nx">basket</code> <code class="o">?</code> <code class="go">[...</code><code class="nx">state</code><code class="go">.</code><code class="nx">basket</code><code class="go">]</code> <code class="o">:</code> <code class="go">[]</code>
      <code class="kr">const</code> <code class="nx">existing</code> <code class="o">=</code> <code class="nx">basket</code><code class="go">.</code><code class="nx">findIndex</code><code class="go">(</code>
        <code class="go">(</code><code class="nx">item</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">item</code><code class="go">.</code><code class="nx">productId</code> <code class="o">===</code> <code class="nx">action</code><code class="go">.</code><code class="nx">payload</code><code class="go">.</code><code class="nx">productId</code>
      <code class="go">)</code>
      <code class="kr">if</code> <code class="go">(</code><code class="nx">existing</code> <code class="o">!==</code> <code class="o">-</code><code class="mi">1</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">basket</code><code class="go">[</code><code class="nx">existing</code><code class="go">].</code><code class="nx">quantity</code> <code class="o">=</code> <code class="nx">basket</code><code class="go">[</code><code class="nx">existing</code><code class="go">].</code><code class="nx">quantity</code> <code class="o">+</code> <code class="mi">1</code>
      <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
        <code class="nx">basket</code><code class="go">.</code><code class="nx">push</code><code class="go">({</code> <code class="nx">quantity</code><code class="o">:</code> <code class="mi">1</code><code class="go">,</code> <code class="go">...</code><code class="nx">action</code><code class="go">.</code><code class="nx">payload</code> <code class="go">})</code>
      <code class="go">}</code>
      <code class="kr">return</code> <code class="go">{</code>
        <code class="go">...</code><code class="nx">state</code><code class="go">,</code>
        <code class="nx">basket</code><code class="go">,</code>
      <code class="go">}</code>
    <code class="go">}</code>
    <code class="kr">case</code> <code class="s">'clearBasket'</code><code class="o">:</code> <code class="go">{</code>
      <code class="kr">return</code> <code class="go">{</code>
        <code class="go">...</code><code class="nx">state</code><code class="go">,</code>
        <code class="nx">basket</code><code class="o">:</code> <code class="go">[],</code>
      <code class="go">}</code>
    <code class="go">}</code>
    <code class="kr">default</code><code class="o">:</code>
      <code class="kr">return</code> <code class="go">{</code> <code class="go">...</code><code class="nx">state</code> <code class="go">}</code>
  <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">reducer</code></pre>
<div data-type="tip" class="calibre25">
<p class="author1">We are creating a single reducer here. Once your application grows in size, you will probably want to split your reducer into
smaller reducers, which you can combine with the Redux <code class="calibre21">combineReduc⁠ers</code> <a href="https://oreil.ly/IVh7x" class="calibre6">function</a>.</p>
</div>

<p class="author1">The reducer function responds to <code class="calibre21">buy</code> and <code class="calibre21">clearBasket</code> actions. The <code class="calibre21">buy</code> action will either add a new item to the basket or
update the quantity of an existing item if one has a matching <code class="calibre21">productId</code>. The <code class="calibre21">clearBasket</code> action will set the basket back to an
empty array.</p>

<p class="author1">Now that we have a reducer function, we will use it to create a Redux <em class="calibre7">store</em>. The store is going to be our central repository for
the shared application state. To create a store, add these two lines to some top-level component such as <em class="calibre7">App.js</em>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">createStore</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'redux'</code>
<code class="kr">import</code> <code class="nx">reducer</code> <code class="nx">from</code> <code class="s">'./reducer'</code>

<code class="kr">const</code> <code class="nx">store</code> <code class="o">=</code> <code class="nx">createStore</code><code class="go">(</code><code class="nx">reducer</code><code class="go">)</code></pre>

<p class="author1">The store needs to be available globally in the app, and to do that, we need to inject it into the context of the components that
might need it. The React Redux library provides a component to inject the store in a component <a data-type="indexterm" data-primary="Provider context" id="idm46634422749992" class="calibre6"/>context called <code class="calibre21">Provider</code>:</p>

<pre data-type="programlisting" data-code-language="xml" class="calibre28"><code class="nt">&lt;Provider</code> <code class="na">store=</code><code class="s">{store}</code><code class="nt">&gt;</code>
  All the components inside here can access the store
<code class="nt">&lt;/Provider&gt;</code></pre>

<p class="author1">Here <a data-type="indexterm" data-primary="reducers" data-secondary="global state management with Redux" data-tertiary="reducer component for shopping basket app" id="idm46634422726104" class="calibre6"/>is the <em class="calibre7">reducer.js</em> component from the example application, which you can find in the <a href="https://oreil.ly/j90xI" class="calibre6">GitHub repository</a> for this book:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">reducer</code> <code class="o">=</code> <code class="go">(</code><code class="nx">state</code> <code class="o">=</code> <code class="go">{},</code> <code class="nx">action</code> <code class="o">=</code> <code class="go">{})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">switch</code> <code class="go">(</code><code class="nx">action</code><code class="go">.</code><code class="nx">type</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">case</code> <code class="s">'buy'</code><code class="o">:</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">basket</code> <code class="o">=</code> <code class="nx">state</code><code class="go">.</code><code class="nx">basket</code> <code class="o">?</code> <code class="go">[...</code><code class="nx">state</code><code class="go">.</code><code class="nx">basket</code><code class="go">]</code> <code class="o">:</code> <code class="go">[]</code>
      <code class="kr">const</code> <code class="nx">existing</code> <code class="o">=</code> <code class="nx">basket</code><code class="go">.</code><code class="nx">findIndex</code><code class="go">(</code>
        <code class="go">(</code><code class="nx">item</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">item</code><code class="go">.</code><code class="nx">productId</code> <code class="o">===</code> <code class="nx">action</code><code class="go">.</code><code class="nx">payload</code><code class="go">.</code><code class="nx">productId</code>
      <code class="go">)</code>
      <code class="kr">if</code> <code class="go">(</code><code class="nx">existing</code> <code class="o">!==</code> <code class="o">-</code><code class="mi">1</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">basket</code><code class="go">[</code><code class="nx">existing</code><code class="go">].</code><code class="nx">quantity</code> <code class="o">=</code> <code class="nx">basket</code><code class="go">[</code><code class="nx">existing</code><code class="go">].</code><code class="nx">quantity</code> <code class="o">+</code> <code class="mi">1</code>
      <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
        <code class="nx">basket</code><code class="go">.</code><code class="nx">push</code><code class="go">({</code> <code class="nx">quantity</code><code class="o">:</code> <code class="mi">1</code><code class="go">,</code> <code class="go">...</code><code class="nx">action</code><code class="go">.</code><code class="nx">payload</code> <code class="go">})</code>
      <code class="go">}</code>
      <code class="kr">return</code> <code class="go">{</code>
        <code class="go">...</code><code class="nx">state</code><code class="go">,</code>
        <code class="nx">basket</code><code class="go">,</code>
      <code class="go">}</code>
    <code class="go">}</code>
    <code class="kr">case</code> <code class="s">'clearBasket'</code><code class="o">:</code> <code class="go">{</code>
      <code class="kr">return</code> <code class="go">{</code>
        <code class="go">...</code><code class="nx">state</code><code class="go">,</code>
        <code class="nx">basket</code><code class="o">:</code> <code class="go">[],</code>
      <code class="go">}</code>
    <code class="go">}</code>
    <code class="kr">default</code><code class="o">:</code>
      <code class="kr">return</code> <code class="go">{</code> <code class="go">...</code><code class="nx">state</code> <code class="go">}</code>
  <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">reducer</code></pre>

<p class="author1">Now that the store is available to our components, how do we use it? React Redux allows you to access the store through hooks.<a data-type="indexterm" data-primary="useSelector hook" id="idm46634422736344" class="calibre6"/><a data-type="indexterm" data-primary="selectors" data-secondary="using to read global state" id="idm46634422735736" class="calibre6"/> If
you want to read the contents of the global state, you can use <code class="calibre21">useSelector</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">basket</code> <code class="o">=</code> <code class="nx">useSelector</code><code class="go">((</code><code class="nx">state</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">state</code><code class="go">.</code><code class="nx">basket</code><code class="go">)</code></pre>

<p class="author1">The <code class="calibre21">useSelector</code> hook accepts a function to extract part of the central state. Selectors are pretty efficient and will cause
your component to re-render only if the particular part of the state you are interested in changes.</p>

<p class="author1">If you need to submit an action to the central store, you <a data-type="indexterm" data-primary="actions" data-secondary="submitting to central store with useDispatch" id="idm46634422476168" class="calibre6"/><a data-type="indexterm" data-primary="useDispatch hook" id="idm46634422475224" class="calibre6"/>can do it with the 
<span class="firstname"><code class="calibre21">useDispatch</code></span> hook:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">dispatch</code> <code class="o">=</code> <code class="nx">useDispatch</code><code class="go">()</code></pre>

<p class="author1">This returns a <code class="calibre21">dispatch</code> function <a data-type="indexterm" data-primary="dispatch function" id="idm46634422462408" class="calibre6"/>that you can use to send actions to the store:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'clearBasket'</code> <code class="go">})</code></pre>

<p class="author1">These hooks work by extracting the store from the current context.<a data-type="indexterm" data-primary="Provider context" id="idm46634422451752" class="calibre6"/> If you forget to add a <code class="calibre21">Provider</code> to your application or try to
run <code class="calibre21">useSelector</code> or <code class="calibre21">useDispatch</code> outside of a <code class="calibre21">Provider</code> context, you will get an error, as shown in <a data-type="xref" href="#ch03_image_17" class="calibre6">Figure 3-17</a>.</p>

<figure class="calibre29"><div id="ch03_image_17" class="figure">
<img src="Images/recb_0317.png" alt="" class="calibre77"/>
<h6 class="calibre30"><span class="firstname">Figure 3-17. </span>If you forget to include a <code class="calibre21">Provider</code>, you will get this error</h6>
</div></figure>

<p class="author1">The completed <code class="calibre21">Basket</code> component <a data-type="indexterm" data-primary="shopping basket application example" data-secondary="Basket component" id="idm46634422420392" class="calibre6"/>reads and clears the app-wide shopping basket:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useDispatch</code><code class="go">,</code> <code class="nx">useSelector</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-redux'</code>

<code class="kr">import</code> <code class="s">'./Basket.css'</code>

<code class="kr">const</code> <code class="nx">Basket</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">basket</code> <code class="o">=</code> <code class="nx">useSelector</code><code class="go">((</code><code class="nx">state</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">state</code><code class="go">.</code><code class="nx">basket</code><code class="go">)</code>
  <code class="kr">const</code> <code class="nx">dispatch</code> <code class="o">=</code> <code class="nx">useDispatch</code><code class="go">()</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h2</code><code class="go">&gt;</code><code class="nx">Basket</code><code class="go">&lt;/</code><code class="nt">h2</code><code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">basket</code> <code class="o">&amp;&amp;</code> <code class="nx">basket</code><code class="go">.</code><code class="nx">length</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;&gt;</code>
          <code class="go">{</code><code class="nx">basket</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">item</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code>
            <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-item"</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-itemName"</code><code class="go">&gt;{</code><code class="nx">item</code><code class="go">.</code><code class="nx">name</code><code class="go">}&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-itemProductId"</code><code class="go">&gt;</code>
                <code class="go">{</code><code class="nx">item</code><code class="go">.</code><code class="nx">productId</code><code class="go">}</code>
              <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-itemPricing"</code><code class="go">&gt;</code>
                <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-itemQuantity"</code><code class="go">&gt;</code>
                  <code class="go">{</code><code class="nx">item</code><code class="go">.</code><code class="nx">quantity</code><code class="go">}</code>
                <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
                <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-itemPrice"</code><code class="go">&gt;{</code><code class="nx">item</code><code class="go">.</code><code class="nx">price</code><code class="go">}&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
              <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
            <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
          <code class="go">))}</code>
          <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'clearBasket'</code> <code class="go">})}&gt;</code>
            <code class="nx">Clear</code>
          <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">&lt;/&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="go">(</code>
        <code class="s">'Empty'</code>
      <code class="go">)}</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Basket</code></pre>

<p class="author1">To demonstrate some code adding items to the basket, here’s a <code class="calibre21">Boots</code> component <a data-type="indexterm" data-primary="shopping basket application example" data-secondary="adding items to basket using Boots component" id="idm46634422426328" class="calibre6"/>that allows a customer to buy a selection of products:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useDispatch</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-redux'</code>

<code class="kr">import</code> <code class="s">'./Boots.css'</code>

<code class="kr">const</code> <code class="nx">products</code> <code class="o">=</code> <code class="go">[</code>
  <code class="go">{</code>
    <code class="nx">productId</code><code class="o">:</code> <code class="s">'BE8290004'</code><code class="go">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s">'Ski boots'</code><code class="go">,</code>
    <code class="nx">description</code><code class="o">:</code> <code class="s">'Mondo 26.5. White.'</code><code class="go">,</code>
    <code class="nx">price</code><code class="o">:</code> <code class="mi">698.62</code><code class="go">,</code>
  <code class="go">},</code>
  <code class="go">{</code>
    <code class="nx">productId</code><code class="o">:</code> <code class="s">'PC6310098'</code><code class="go">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s">'Snowboard boots'</code><code class="go">,</code>
    <code class="nx">description</code><code class="o">:</code> <code class="s">'Mondo 27.5. Blue.'</code><code class="go">,</code>
    <code class="nx">price</code><code class="o">:</code> <code class="mi">825.59</code><code class="go">,</code>
  <code class="go">},</code>
  <code class="go">{</code>
    <code class="nx">productId</code><code class="o">:</code> <code class="s">'RR5430103'</code><code class="go">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s">'Mountaineering boots'</code><code class="go">,</code>
    <code class="nx">description</code><code class="o">:</code> <code class="s">'Mondo 27.3. Brown.'</code><code class="go">,</code>
    <code class="nx">price</code><code class="o">:</code> <code class="mi">634.98</code><code class="go">,</code>
  <code class="go">},</code>
<code class="go">]</code>

<code class="kr">const</code> <code class="nx">Boots</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">dispatch</code> <code class="o">=</code> <code class="nx">useDispatch</code><code class="go">()</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Boots"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h1</code><code class="go">&gt;</code><code class="nx">Boots</code><code class="go">&lt;/</code><code class="nt">h1</code><code class="go">&gt;</code>

      <code class="go">&lt;</code><code class="nt">dl</code> <code class="na">className</code><code class="o">=</code><code class="s">"Boots-products"</code><code class="go">&gt;</code>
        <code class="go">{</code><code class="nx">products</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">product</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code>
          <code class="go">&lt;&gt;</code>
            <code class="go">&lt;</code><code class="nt">dt</code><code class="go">&gt;{</code><code class="nx">product</code><code class="go">.</code><code class="nx">name</code><code class="go">}&lt;/</code><code class="nt">dt</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">dd</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;{</code><code class="nx">product</code><code class="go">.</code><code class="nx">description</code><code class="go">}&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code><code class="nx">$</code><code class="go">{</code><code class="nx">product</code><code class="go">.</code><code class="nx">price</code><code class="go">}&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">button</code>
                <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code>
                  <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'buy'</code><code class="go">,</code> <code class="nx">payload</code><code class="o">:</code> <code class="nx">product</code> <code class="go">})</code>
                <code class="go">}</code>
              <code class="go">&gt;</code>
                <code class="nx">Add</code> <code class="nx">to</code> <code class="nx">basket</code>
              <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
            <code class="go">&lt;/</code><code class="nt">dd</code><code class="go">&gt;</code>
          <code class="go">&lt;/&gt;</code>
        <code class="go">))}</code>
      <code class="go">&lt;/</code><code class="nt">dl</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Boots</code></pre>

<p class="author1">These two components may appear at very different locations in the component tree, but they share the same Redux store. As soon as a
customer adds a product to the basket, the <code class="calibre21">Basket</code> component will automatically update with the change (see <a data-type="xref" href="#ch03_image_18" class="calibre6">Figure 3-18</a>).</p>

<figure class="calibre29"><div id="ch03_image_18" class="figure">
<img src="Images/recb_0318.png" alt="" class="calibre76"/>
<h6 class="calibre30"><span class="firstname">Figure 3-18. </span>The Redux-React hooks make sure that when a user buys a product, the <code class="calibre21">Basket</code> is re-rendered</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634423012392">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Developers often use the Redux library with the React framework. For a long time, it seemed, almost every React application included
Redux by default. It’s probably true that Redux was often overused or used inappropriately. We have seen projects that have even
banned local state in favor of using Redux for <em class="calibre7">all</em> state. We believe this approach is a mistake. Redux is intended for central
application state management, not for simple component state. If you are storing data that is of concern to only one component, or
its subcomponents, you should probably not store it in Redux.</p>

<p class="author1">However, if your application manages some global application state, then Redux is still the tool of choice.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/j90xI" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="shopping basket application example" data-startref="ix_shop" id="idm46634421901016" class="calibre6"/><a data-type="indexterm" data-primary="Redux library" data-secondary="managing global state with" data-startref="ix_Rdx" id="idm46634421900040" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="global, managing with Redux" data-startref="ix_staglo" id="idm46634421898856" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Survive Page Reloads with Redux Persist" class="calibre4"><div class="preface" id="ch03-07">
<h1 class="calibre17">Survive Page Reloads with Redux Persist</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634421895992">
<h2 class="calibre27">Problem</h2>

<p class="author1">Redux is an <a data-type="indexterm" data-primary="state" data-secondary="surviving page reloads with Redux Persist" id="ix_stapgrel" class="calibre6"/><a data-type="indexterm" data-primary="page reloads, surviving with Redux Persist" id="ix_pgrel" class="calibre6"/><a data-type="indexterm" data-primary="Redux Persist, persisting state through page reloads" id="ix_ReduPer" class="calibre6"/>excellent way of managing the application state centrally. However, it does have a small problem: when you reload the
page, the entire state disappears (see <a data-type="xref" href="#ch03_image_19" class="calibre6">Figure 3-19</a>).</p>

<figure class="calibre29"><div id="ch03_image_19" class="figure">
<img src="Images/recb_0319.png" alt="" class="calibre78"/>
<h6 class="calibre30"><span class="firstname">Figure 3-19. </span>Redux state (left) is lost if the page is reloaded (right)</h6>
</div></figure>

<p class="author1">The state disappears because Redux keeps its state in memory. How do we prevent the state from disappearing?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634421887496">
<h2 class="calibre27">Solution</h2>

<p class="author1">We will use the Redux Persist library to keep a copy of the Redux state in local storage. To install Redux Persist, type the
following:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install redux-persist</code></pre>

<p class="author1">The first <a data-type="indexterm" data-primary="persisted reducers" id="idm46634421862168" class="calibre6"/><a data-type="indexterm" data-primary="reducers" data-secondary="persisted" id="idm46634421861672" class="calibre6"/>thing we need to do is create a <em class="calibre7">persisted reducer</em>, wrapped around our existing reducer:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">storage</code> <code class="nx">from</code> <code class="s">'redux-persist/lib/storage'</code>

<code class="kr">const</code> <code class="nx">persistConfig</code> <code class="o">=</code> <code class="go">{</code>
  <code class="nx">key</code><code class="o">:</code> <code class="s">'root'</code><code class="go">,</code>
  <code class="nx">storage</code><code class="go">,</code>
<code class="go">}</code>

<code class="kr">const</code> <code class="nx">persistedReducer</code> <code class="o">=</code> <code class="nx">persistReducer</code><code class="go">(</code><code class="nx">persistConfig</code><code class="go">,</code> <code class="nx">reducer</code><code class="go">)</code></pre>

<p class="author1">The <code class="calibre21">storage</code> specifies where we will persist the Redux state: it will be in <code class="calibre21">localStor⁠age</code> by default.<a data-type="indexterm" data-primary="storage" data-secondary="specifying for persistence of Redux state" id="idm46634421775928" class="calibre6"/> The <code class="calibre21">persistConfig</code> says
that we want to keep our state in a 
<span class="firstname"><code class="calibre21">localStorage</code></span> item called <code class="calibre21">persist:root</code>. When the Redux state changes, the <code class="calibre21">persistedReducer</code> will write a copy with <code class="calibre21">localStorage.setItem('persist:root', ...)</code>. We now need to create our Redux store with <code class="calibre21">persistedReducer</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">store</code> <code class="o">=</code> <code class="nx">createStore</code><code class="go">(</code><code class="nx">persistedReducer</code><code class="go">)</code></pre>

<p class="author1">We need to interject the Redux Persist code between the Redux store and the code that’s accessing the Redux store.<a data-type="indexterm" data-primary="PersistGate component" id="idm46634421769528" class="calibre6"/> We do that with a
component called <code class="calibre21">PersistGate</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">PersistGate</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'redux-persist/integration/react'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">persistStore</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'redux-persist'</code>

<code class="kr">const</code> <code class="nx">persistor</code> <code class="o">=</code> <code class="nx">persistStore</code><code class="go">(</code><code class="nx">store</code><code class="go">)</code>
<code class="go">...</code>
<code class="go">&lt;</code><code class="nt">Provider</code> <code class="na">store</code><code class="o">=</code><code class="go">{</code><code class="nx">store</code><code class="go">}&gt;</code>
  <code class="go">&lt;</code><code class="nt">PersistGate</code> <code class="na">loading</code><code class="o">=</code><code class="go">{&lt;</code><code class="nt">div</code><code class="go">&gt;</code><code class="nx">Loading</code><code class="go">...&lt;/</code><code class="nt">div</code><code class="go">&gt;}</code> <code class="na">persistor</code><code class="o">=</code><code class="go">{</code><code class="nx">persistor</code><code class="go">}&gt;</code>
    <code class="nx">Components</code> <code class="nx">live</code> <code class="kr">in</code> <code class="nx">here</code>
  <code class="go">&lt;/</code><code class="nt">PersistGate</code><code class="go">&gt;</code>
<code class="go">&lt;/</code><code class="nt">Provider</code><code class="go">&gt;</code></pre>

<p class="author1">The <code class="calibre21">PersistGate</code> must be <em class="calibre7">inside</em> the Redux <code class="calibre21">Provider</code> and <em class="calibre7">outside</em> the components that are going to use Redux.<a data-type="indexterm" data-primary="Provider context" data-secondary="PersistGate inside of" id="idm46634421651480" class="calibre6"/> The <code class="calibre21">PersistGate</code>
will watch for when the Redux state is lost and then reload it from <code class="calibre21">localStorage</code>. It might take a moment to reload the data, and
if you want to show that the UI is briefly busy, you can pass a <code class="calibre21">loading</code> component to the <code class="calibre21">PersistGate</code>: for example, an animated
spinner. The loading component will be displayed in place of its child components when Redux is reloading. If you don’t want a
loading component, you can set it to <code class="calibre21">null</code>.</p>

<p class="author1">Here is the final version of the modified <em class="calibre7">App.js</em> from the example app:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">BrowserRouter</code><code class="go">,</code> <code class="nx">Route</code><code class="go">,</code> <code class="nx">Switch</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-router-dom'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">Provider</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-redux'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">createStore</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'redux'</code>

<code class="kr">import</code> <code class="nx">Menu</code> <code class="nx">from</code> <code class="s">'./Menu'</code>
<code class="kr">import</code> <code class="nx">Home</code> <code class="nx">from</code> <code class="s">'./Home'</code>
<code class="kr">import</code> <code class="nx">Boots</code> <code class="nx">from</code> <code class="s">'./Boots'</code>
<code class="kr">import</code> <code class="nx">Basket</code> <code class="nx">from</code> <code class="s">'./Basket'</code>

<code class="kr">import</code> <code class="s">'./App.css'</code>
<code class="kr">import</code> <code class="nx">reducer</code> <code class="nx">from</code> <code class="s">'./reducer'</code>

<code class="kr">import</code> <code class="go">{</code> <code class="nx">persistStore</code><code class="go">,</code> <code class="nx">persistReducer</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'redux-persist'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">PersistGate</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'redux-persist/integration/react'</code>
<code class="kr">import</code> <code class="nx">storage</code> <code class="nx">from</code> <code class="s">'redux-persist/lib/storage'</code>

<code class="kr">const</code> <code class="nx">persistConfig</code> <code class="o">=</code> <code class="go">{</code>
  <code class="nx">key</code><code class="o">:</code> <code class="s">'root'</code><code class="go">,</code>
  <code class="nx">storage</code><code class="go">,</code>
<code class="go">}</code>

<code class="kr">const</code> <code class="nx">persistedReducer</code> <code class="o">=</code> <code class="nx">persistReducer</code><code class="go">(</code><code class="nx">persistConfig</code><code class="go">,</code> <code class="nx">reducer</code><code class="go">)</code>

<code class="kr">const</code> <code class="nx">store</code> <code class="o">=</code> <code class="nx">createStore</code><code class="go">(</code><code class="nx">persistedReducer</code><code class="go">)</code>

<code class="kr">const</code> <code class="nx">persistor</code> <code class="o">=</code> <code class="nx">persistStore</code><code class="go">(</code><code class="nx">store</code><code class="go">)</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">Provider</code> <code class="na">store</code><code class="o">=</code><code class="go">{</code><code class="nx">store</code><code class="go">}&gt;</code>
        <code class="go">&lt;</code><code class="nt">PersistGate</code>
          <code class="na">loading</code><code class="o">=</code><code class="go">{&lt;</code><code class="nt">div</code><code class="go">&gt;</code><code class="nx">Loading</code><code class="go">...&lt;/</code><code class="nt">div</code><code class="go">&gt;}</code>
          <code class="na">persistor</code><code class="o">=</code><code class="go">{</code><code class="nx">persistor</code><code class="go">}</code>
        <code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">BrowserRouter</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">Menu</code> <code class="go">/&gt;</code>
            <code class="go">&lt;</code><code class="nt">Switch</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">Route</code> <code class="na">exact</code> <code class="na">path</code><code class="o">=</code><code class="s">"/"</code><code class="go">&gt;</code>
                <code class="go">&lt;</code><code class="nt">Home</code> <code class="go">/&gt;</code>
              <code class="go">&lt;/</code><code class="nt">Route</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">Route</code> <code class="na">path</code><code class="o">=</code><code class="s">"/boots"</code><code class="go">&gt;</code>
                <code class="go">&lt;</code><code class="nt">Boots</code> <code class="go">/&gt;</code>
              <code class="go">&lt;/</code><code class="nt">Route</code><code class="go">&gt;</code>
            <code class="go">&lt;/</code><code class="nt">Switch</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">Basket</code> <code class="go">/&gt;</code>
          <code class="go">&lt;/</code><code class="nt">BrowserRouter</code><code class="go">&gt;</code>
        <code class="go">&lt;/</code><code class="nt">PersistGate</code><code class="go">&gt;</code>
      <code class="go">&lt;/</code><code class="nt">Provider</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">Now, when the user reloads the page, the Redux state survives, as shown in <a data-type="xref" href="#ch03_image_20" class="calibre6">Figure 3-20</a>.</p>

<figure class="calibre29"><div id="ch03_image_20" class="figure">
<img src="Images/recb_0320.png" alt="" class="calibre79"/>
<h6 class="calibre30"><span class="firstname">Figure 3-20. </span>Redux state before the reload (top) and after (bottom)</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634421886872">
<h2 class="calibre27">Discussion</h2>

<p class="author1">The Redux Persist library is a simple way of persisting Redux state through page reloads. If you have a substantial amount of Redux
data, you will need to be careful not to break the <code class="calibre21">localStorage</code> limit, which will vary from browser to browser but is typically
around 10 MB. However, if your Redux data is that size, you should consider offloading some of it to a server.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/K8U5J" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="Redux Persist, persisting state through page reloads" data-startref="ix_ReduPer" id="idm46634421385224" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="surviving page reloads with Redux Persist" data-startref="ix_stapgrel" id="idm46634421384120" class="calibre6"/><a data-type="indexterm" data-primary="page reloads, surviving with Redux Persist" data-startref="ix_pgrel" id="idm46634421382872" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Calculate Derived State with Reselect" class="calibre4"><div class="preface" id="ch03-08">
<h1 class="calibre17">Calculate Derived State with Reselect</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634421380216">
<h2 class="calibre27">Problem</h2>

<p class="author1">When you extract your application state into an external object with a tool like Redux, you often need to process the data in some
way before displaying it.<a data-type="indexterm" data-primary="state" data-secondary="derived, calculating with reselect" id="ix_stader" class="calibre6"/><a data-type="indexterm" data-primary="reselect library, calculating derived state" id="ix_resel" class="calibre6"/><a data-type="indexterm" data-primary="shopping basket application example" data-secondary="calculating derived state with reselect" id="ix_shopbsk" class="calibre6"/> For example, <a data-type="xref" href="#ch03_image_21" class="calibre6">Figure 3-21</a> shows an application we have used in a few recipes in this 
<span class="firstname">chapter</span>.</p>

<figure class="calibre29"><div id="ch03_image_21" class="figure">
<img src="Images/recb_0318.png" alt="" class="calibre76"/>
<h6 class="calibre30"><span class="firstname">Figure 3-21. </span>What’s the best method for calculating the total cost and tax of the basket?</h6>
</div></figure>

<p class="author1">What if we want to calculate the total cost of the items in the basket and then calculate the amount of sales tax to pay? We could
create a JavaScript function that reads through the basket items and calculates both, but that function would have to 
<span class="firstname">recalculate</span>
the values every time the basket renders. Is there a way of calculating derived values from the state that updates only when the
state changes?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634421369992">
<h2 class="calibre27">Solution</h2>

<p class="author1">The Redux developers have created a library specifically designed to derive values efficiently from state objects, called
<code class="calibre21">reselect</code>.</p>

<p class="author1">The <code class="calibre21">reselect</code> library creates selector functions.<a data-type="indexterm" data-primary="selectors" data-secondary="reselect library, calculating derived state" id="ix_selresel" class="calibre6"/> A <em class="calibre7">selector function</em> takes a single parameter—a state object—and returns a
processed version.</p>

<p class="author1">We’ve already seen one selector in <a data-type="xref" href="#ch03-06" class="calibre6">“Manage Global State with Redux”</a>. We used it to return the current basket from the central Redux
state:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">basket</code> <code class="o">=</code> <code class="nx">useSelector</code><code class="go">((</code><code class="nx">state</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">state</code><code class="go">.</code><code class="nx">basket</code><code class="go">)</code></pre>

<p class="author1">The <code class="calibre21">state =&gt; state.basket</code> is a selector function; it derives some value from a state object. The <code class="calibre21">reselect</code> library creates highly
efficient selector functions that can cache their results if the state they depend upon has not changed.</p>

<p class="author1">To install <code class="calibre21">reselect</code>, enter this command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install reselect</code></pre>

<p class="author1">Let’s begin by creating a selector function that will do the following:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">Count the total number of items in a basket</p>
</li>
<li class="calibre8">
<p class="author1">Calculate the total cost of all of the items</p>
</li>
</ul>

<p class="author1">We’ll call this function <code class="calibre21">summarizer</code>. Before we go into the details of how we’ll write it, we’ll begin by writing a test that will
show what it will need to do:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">it</code><code class="go">(</code><code class="s">'should be able to handle multiple products'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">actual</code> <code class="o">=</code> <code class="nx">summarizer</code><code class="go">({</code>
    <code class="nx">basket</code><code class="o">:</code> <code class="go">[</code>
      <code class="go">{</code> <code class="nx">productId</code><code class="o">:</code> <code class="s">'1234'</code><code class="go">,</code> <code class="nx">quantity</code><code class="o">:</code> <code class="mi">2</code><code class="go">,</code> <code class="nx">price</code><code class="o">:</code> <code class="mi">1.23</code> <code class="go">},</code>
      <code class="go">{</code> <code class="nx">productId</code><code class="o">:</code> <code class="s">'5678'</code><code class="go">,</code> <code class="nx">quantity</code><code class="o">:</code> <code class="mi">1</code><code class="go">,</code> <code class="nx">price</code><code class="o">:</code> <code class="mi">1.5</code> <code class="go">},</code>
    <code class="go">],</code>
  <code class="go">})</code>
  <code class="nx">expect</code><code class="go">(</code><code class="nx">actual</code><code class="go">).</code><code class="nx">toEqual</code><code class="go">({</code> <code class="nx">itemCount</code><code class="o">:</code> <code class="mi">3</code><code class="go">,</code> <code class="nx">cost</code><code class="o">:</code> <code class="mi">3.96</code> <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">So if we give it a state object, it will add up the quantities and costs and return an object containing the <code class="calibre21">itemCount</code> and <code class="calibre21">cost</code>.</p>

<p class="author1">We can create <a data-type="indexterm" data-primary="selectors" data-secondary="reselect library, calculating derived state" data-tertiary="summarizer selector" id="idm46634421245224" class="calibre6"/>a selector function called <code class="calibre21">summarizer</code> with the Reselect library like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">createSelector</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'reselect'</code>

<code class="kr">const</code> <code class="nx">summarizer</code> <code class="o">=</code> <code class="nx">createSelector</code><code class="go">(</code>
  <code class="go">(</code><code class="nx">state</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">state</code><code class="go">.</code><code class="nx">basket</code> <code class="o">||</code> <code class="go">[],</code>
  <code class="go">(</code><code class="nx">basket</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">({</code>
    <code class="nx">itemCount</code><code class="o">:</code> <code class="nx">basket</code><code class="go">.</code><code class="nx">reduce</code><code class="go">((</code><code class="nx">i</code><code class="go">,</code> <code class="nx">j</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">i</code> <code class="o">+</code> <code class="nx">j</code><code class="go">.</code><code class="nx">quantity</code><code class="go">,</code> <code class="mi">0</code><code class="go">),</code>
    <code class="nx">cost</code><code class="o">:</code> <code class="nx">basket</code><code class="go">.</code><code class="nx">reduce</code><code class="go">((</code><code class="nx">i</code><code class="go">,</code> <code class="nx">j</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">i</code> <code class="o">+</code> <code class="nx">j</code><code class="go">.</code><code class="nx">quantity</code> <code class="o">*</code> <code class="nx">j</code><code class="go">.</code><code class="nx">price</code><code class="go">,</code> <code class="mi">0</code><code class="go">),</code>
  <code class="go">})</code>
<code class="go">)</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">summarizer</code></pre>

<p class="author1">The <code class="calibre21">createSelector</code> function creates a selector function <em class="calibre7">based</em> on other selector functions. Each of the parameters passed to
it—except the last parameter—should be selector functions. We are passing just one:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">(</code><code class="nx">state</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">state</code><code class="go">.</code><code class="nx">basket</code> <code class="o">||</code> <code class="go">[]</code></pre>

<p class="author1">This code extracts the basket from the state.</p>

<p class="author1">The final parameter passed to <code class="calibre21">createSelector</code> (the <em class="calibre7">combiner</em>) is a function that derives a new value, based on the results of the
preceding selectors:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">(</code><code class="nx">basket</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">({</code>
  <code class="nx">itemCount</code><code class="o">:</code> <code class="nx">basket</code><code class="go">.</code><code class="nx">reduce</code><code class="go">((</code><code class="nx">i</code><code class="go">,</code> <code class="nx">j</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">i</code> <code class="o">+</code> <code class="nx">j</code><code class="go">.</code><code class="nx">quantity</code><code class="go">,</code> <code class="mi">0</code><code class="go">),</code>
  <code class="nx">cost</code><code class="o">:</code> <code class="nx">basket</code><code class="go">.</code><code class="nx">reduce</code><code class="go">((</code><code class="nx">i</code><code class="go">,</code> <code class="nx">j</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">i</code> <code class="o">+</code> <code class="nx">j</code><code class="go">.</code><code class="nx">quantity</code> <code class="o">*</code> <code class="nx">j</code><code class="go">.</code><code class="nx">price</code><code class="go">,</code> <code class="mi">0</code><code class="go">),</code>
<code class="go">})</code></pre>

<p class="author1">The <code class="calibre21">basket</code> value is the result of running the state through the first selector.</p>

<p class="author1">Why on Earth would anyone create functions this way? Isn’t it <em class="calibre7">way</em> more complicated than just creating a JavaScript function
manually, without the need to pass all of these functions to functions?</p>

<p class="author1">The answer is <em class="calibre7">efficiency</em>. Selectors will recalculate their values only when they need to.<a data-type="indexterm" data-primary="selectors" data-secondary="reselect library, calculating derived state" data-tertiary="efficiency of selectors" id="idm46634420965800" class="calibre6"/> State objects can be complex and might
have dozens of attributes. But we are interested only in the contents of the <code class="calibre21">basket</code> attribute, and we don’t want to have to
recalculate our costs if anything else changes.</p>

<p class="author1">What <code class="calibre21">reselect</code> does is work out when the value it returns is likely to have changed. Let’s say we call it one time, and it
calculates the <code class="calibre21">itemCount</code> and <code class="calibre21">value</code> like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">{</code><code class="nx">itemCount</code><code class="o">:</code> <code class="mi">3</code><code class="go">,</code> <code class="nx">cost</code><code class="o">:</code> <code class="mi">3.96</code><code class="go">}</code></pre>

<p class="author1">Then the user runs a bunch of commands that update personal preferences, posts a message to somebody, adds several things to their
wish list, and so on.</p>

<p class="author1">Each of the events might update the global application state. But the next time we run the <code class="calibre21">summarizer</code> function, it will return the
cached value that it produced before:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">{</code><code class="nx">itemCount</code><code class="o">:</code> <code class="mi">3</code><code class="go">,</code> <code class="nx">cost</code><code class="o">:</code> <code class="mi">3.96</code><code class="go">}</code></pre>

<p class="author1">Why? Because it knows that this value is dependent <em class="calibre7">only</em> upon the <code class="calibre21">basket</code> value in the global state. And if that hasn’t changed,
then it doesn’t need to recalculate the return value.</p>

<p class="author1">Because <code class="calibre21">reselect</code> allows us to build selector functions from other selector functions, we could build another <a data-type="indexterm" data-primary="selectors" data-secondary="reselect library, calculating derived state" data-tertiary="taxer selector" id="idm46634420940728" class="calibre6"/>selector called
<code class="calibre21">taxer</code> to calculate the basket’s sales tax:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">createSelector</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'reselect'</code>
<code class="kr">import</code> <code class="nx">summarizer</code> <code class="nx">from</code> <code class="s">'./summarizer'</code>

<code class="kr">const</code> <code class="nx">taxer</code> <code class="o">=</code> <code class="nx">createSelector</code><code class="go">(</code>
  <code class="nx">summarizer</code><code class="go">,</code>
  <code class="go">(</code><code class="nx">summary</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">summary</code><code class="go">.</code><code class="nx">cost</code> <code class="o">*</code> <code class="mi">0.07</code>
<code class="go">)</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">taxer</code></pre>

<p class="author1">The <code class="calibre21">taxer</code> selector uses the value returned by the <code class="calibre21">summarizer</code> function. It takes the <code class="calibre21">cost</code> of the <code class="calibre21">summarizer</code> result and
multiplies it by 7%. If the basket’s summarized total doesn’t change, then the <code class="calibre21">taxer</code> function will not need to update its result.</p>

<p class="author1">Now that we have the <code class="calibre21">summarizer</code> and <code class="calibre21">taxer</code> selectors, we can use them inside a component, just as we would any other selector
function:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useDispatch</code><code class="go">,</code> <code class="nx">useSelector</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-redux'</code>

<code class="kr">import</code> <code class="s">'./Basket.css'</code>
<code class="kr">import</code> <code class="nx">summarizer</code> <code class="nx">from</code> <code class="s">'./summarizer'</code>
<code class="kr">import</code> <code class="nx">taxer</code> <code class="nx">from</code> <code class="s">'./taxer'</code>

<code class="kr">const</code> <code class="nx">Basket</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">basket</code> <code class="o">=</code> <code class="nx">useSelector</code><code class="go">((</code><code class="nx">state</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">state</code><code class="go">.</code><code class="nx">basket</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">{</code> <code class="nx">itemCount</code><code class="go">,</code> <code class="nx">cost</code> <code class="go">}</code> <code class="o">=</code> <code class="nx">useSelector</code><code class="go">(</code><code class="nx">summarizer</code><code class="go">)</code>
  <code class="kr">const</code> <code class="nx">tax</code> <code class="o">=</code> <code class="nx">useSelector</code><code class="go">(</code><code class="nx">taxer</code><code class="go">)</code>
  <code class="kr">const</code> <code class="nx">dispatch</code> <code class="o">=</code> <code class="nx">useDispatch</code><code class="go">()</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">h2</code><code class="go">&gt;</code><code class="nx">Basket</code><code class="go">&lt;/</code><code class="nt">h2</code><code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">basket</code> <code class="o">&amp;&amp;</code> <code class="nx">basket</code><code class="go">.</code><code class="nx">length</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;&gt;</code>
          <code class="go">{</code><code class="nx">basket</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">item</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code>
            <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-item"</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-itemName"</code><code class="go">&gt;{</code><code class="nx">item</code><code class="go">.</code><code class="nx">name</code><code class="go">}&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-itemProductId"</code><code class="go">&gt;</code>
                <code class="go">{</code><code class="nx">item</code><code class="go">.</code><code class="nx">productId</code><code class="go">}</code>
              <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-itemPricing"</code><code class="go">&gt;</code>
                <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-itemQuantity"</code><code class="go">&gt;</code>
                  <code class="go">{</code><code class="nx">item</code><code class="go">.</code><code class="nx">quantity</code><code class="go">}</code>
                <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
                <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Basket-itemPrice"</code><code class="go">&gt;{</code><code class="nx">item</code><code class="go">.</code><code class="nx">price</code><code class="go">}&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
              <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
            <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
          <code class="go">))}</code>
          <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;{</code><code class="nx">itemCount</code><code class="go">}</code> <code class="nx">items</code><code class="go">&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code><code class="nx">Total</code><code class="o">:</code> <code class="nx">$</code><code class="go">{</code><code class="nx">cost</code><code class="go">.</code><code class="nx">toFixed</code><code class="go">(</code><code class="mi">2</code><code class="go">)}&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code><code class="nx">Sales</code> <code class="nx">tax</code><code class="o">:</code> <code class="nx">$</code><code class="go">{</code><code class="nx">tax</code><code class="go">.</code><code class="nx">toFixed</code><code class="go">(</code><code class="mi">2</code><code class="go">)}&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="go">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s">'clearBasket'</code> <code class="go">})}&gt;</code>
            <code class="nx">Clear</code>
          <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
        <code class="go">&lt;/&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="go">(</code>
        <code class="s">'Empty'</code>
      <code class="go">)}</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Basket</code></pre>

<p class="author1">When we run the code now, we see a summary at the bottom of the shopping basket, which will update whenever we buy a new product
(see <a data-type="xref" href="#ch03_image_22" class="calibre6">Figure 3-22</a>).</p>

<figure class="calibre29"><div id="ch03_image_22" class="figure">
<img src="Images/recb_0322.png" alt="" class="calibre76"/>
<h6 class="calibre30"><span class="firstname">Figure 3-22. </span>The selectors recalculate the total cost and sales tax only when the basket changes</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634421369096">
<h2 class="calibre27">Discussion</h2>

<p class="author1">The first time you meet selector functions, they can seem complicated and hard to understand. But it is worth taking the time to
understand them. There is nothing Redux-specific about them. There is no reason why you can’t also use them with non-Redux reducers.
Because they have no dependencies beyond the <code class="calibre21">reselect</code> library itself, they are easy to unit test. We include example tests in
the code for this chapter.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/U7SLr" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="selectors" data-secondary="reselect library, calculating derived state" data-startref="ix_selresel" id="idm46634420514424" class="calibre6"/><a data-type="indexterm" data-primary="shopping basket application example" data-secondary="calculating derived state with reselect" data-startref="ix_shopbsk" id="idm46634420513112" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="derived, calculating with reselect" data-startref="ix_stader" id="idm46634420511960" class="calibre6"/><a data-type="indexterm" data-primary="reselect library, calculating derived state" data-startref="ix_resel" id="idm46634420510776" class="calibre6"/><a data-type="indexterm" data-primary="state" data-startref="ix_sta" id="idm46634420509800" class="calibre6"/></p>
</div></section>





</div></section>







</div></section></div></body></html>