<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. View Models: Model Behavior"><div class="chapter" id="view_modelscolon_model_behavior">
<h1><span class="label">Chapter 11. </span>View Models: <em>Model Behavior</em></h1>
<figure class="informal"><div class="figure">
<img src="Images/f0435-01.png" alt="image" width="505" height="585"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="Android Jetpack" data-secondary="view models" data-see="view models" id="idm46053737904544"/><a data-type="indexterm" data-primary="Guessing Game app" data-secondary="view models" data-see="view models" id="idm46053737903120"/><a data-type="indexterm" data-primary="Tasks app" data-secondary="view models" data-see="view models" id="idm46053737901744"/><a data-type="indexterm" data-primary="view models" id="idm46053737900368"/><strong>As apps grow more complex, fragments have more to juggle.</strong></p>
<p>And if you’re not careful, this can lead to <strong>bloated code</strong> that tries to do everything. Business logic, navigation, controlling the UI, dealing with configuration changes…you name it, it’s in there. In this chapter, you’ll learn how to deal with this kind of situation using <strong>view models</strong>. You’ll discover <strong>how they simplify your activity and fragment code</strong>. You’ll find out <strong>how they survive configuration changes</strong>, keeping your app’s state safe and sound. Finally, we’ll show you how to build a <strong>view model factory</strong>, and when this might be needed.</p>
<section data-type="sect1" data-pdf-bookmark="Configuration changes revisited"><div class="sect1" id="configuration_changes_revisited">
<h1>Configuration changes revisited</h1>
<p><a data-type="indexterm" data-primary="Bundle" data-secondary="onSaveInstanceState() method" id="idm46053737895008"/><a data-type="indexterm" data-primary="configuration changes, view model’s handling of" id="idm46053737893248"/><a data-type="indexterm" data-primary="onSaveInstanceState() method" data-secondary="activities" id="idm46053737892320"/><a data-type="indexterm" data-primary="onSaveInstanceState() method" data-secondary="fragments" id="idm46053737891248"/>As you learned in <a data-type="xref" href="ch05.xhtml#the_activity_lifecyclecolon_being_an_act">Chapter 5</a>, Bad Things can happen when you rotate the screen while running an app. Changing the screen orientation is a configuration change, which causes Android to destroy and recreate the current activity. As a result, views and properties can lose their state and get reset:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0436-01.png" alt="image" width="600" height="127"/>
<h6/>
</div></figure>
<p>In <a data-type="xref" href="ch05.xhtml#the_activity_lifecyclecolon_being_an_act">Chapter 5</a>, you learned how to handle this using the activity’s <code>onSaveInstanceState</code> method. This method gets triggered before the activity gets destroyed, and it’s used to save any values that may get lost in a <code>Bundle</code>. When the activity gets recreated, you can use these saved values to restore the state of the activity’s views and properties.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#9D9EA0;">Fragments have an onSaveInstanceState method too. Even though we’ve only shown you how to use this approach with an activity, it works with fragments as well.</span></p>
</div>
<figure class="informal"><div class="figure">
<img src="Images/f0436-03.png" alt="image" width="600" height="155"/>
<h6/>
</div></figure>
<p>Using a <code>Bundle</code> to save state works well for relatively simple apps, but it’s not an ideal solution for more complicated ones. This is because <code>Bundle</code>s are only intended to hold a small amount of data, and only work with a limited number of types.</p>
<section data-type="sect2" data-pdf-bookmark="There are other problems, too"><div class="sect2" id="there_are_other_problemscomma_too">
<h2>There are other problems, too</h2>
<p>Another problem apps can have is that the activity and fragment code can quickly become bloated. The code may need to control navigation, update the UI, save state, and also include more general business logic to control the app’s behavior. Having all of this in one place makes the code longer, which can then be harder to read and maintain.</p>
<p>In this chapter we’re going to learn how to solve all of these problems using a <strong>view model</strong>.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Introducing the view model"><div class="sect1" id="introducing_the_view_model">
<h1>Introducing the view model</h1>
<p><a data-type="indexterm" data-primary="view models" data-secondary="reasons for using" id="idm46053737874560"/>A view model is a separate class that sits alongside the activity or fragment code. It’s responsible for all of the data that needs to be displayed on the screen, along with any business logic. Whenever a fragment needs to update its layout, it asks the view model for the latest values it needs to display, and if it needs access to some business logic, it calls the methods held in the view model.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0437-01.png" alt="image" width="404" height="146"/>
<h6/>
</div></figure>
<section data-type="sect2" data-pdf-bookmark="Why use a view model?"><div class="sect2" id="why_use_a_view_modelquestion_mark">
<h2>Why use a view model?</h2>
<p>There are a couple reasons why you might want to use a view model.</p>
<p>Using a view model simplifies your activity or fragment code. Your fragment no longer needs to include code relating to the app’s business logic as this is all held in a separate class. Instead, it can focus on things like updating the screen or navigation.</p>
<p>Another reason is that <strong>the view model can survive configuration changes</strong>. It doesn’t get destroyed when the user rotates the device screen, so the state of any variables doesn’t get lost. This lets you restore the state of your app without having having to store values in a <code>Bundle</code>.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0437-02.png" alt="image" width="600" height="230"/>
<h6/>
</div></figure>
<p>We’re going to find out how to use view models by building a word guessing game. Before we start writing the code, let’s go through how the game will work.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-id00164">
<h5>there are no Dumb Questions</h5>
<p><strong>Q: You said <code><strong>Bundle</strong></code>s are only intended to hold a limited number of data types. Does that mean there’s no way of adding extra types?</strong></p>
<p><strong>A:</strong> Technically, you can add extra types to a <code>Bundle</code> using an interface named <code>Parcelable</code>. We’re not teaching you this approach because we think it’s better to use a view model.</p>
<p>If you’re feeling curious, however, you can find out more about using <code>Parcelable</code> in the Android documentation.</p>
</div></aside>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What the guessing game will do"><div class="sect1" id="what_the_guessing_game_will_do">
<h1>What the guessing game will do</h1>
<p><a data-type="indexterm" data-primary="Guessing Game app" id="idm46053737856432"/><a data-type="indexterm" data-primary="view models" data-secondary="Guessing Game app" id="idm46053737855328"/>The aim of the Guessing Game app is for the user to try and guess a secret word.</p>
<p>When the game starts, it chooses a word at random from an array, and displays a blank for each of the word’s letters:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0438-01.png" alt="image" width="600" height="213"/>
<h6/>
</div></figure>
<p>The user suggests a letter that she thinks is in the secret word. If she guesses correctly, the game displays the letter where it appears in the secret word. If she guesses incorrectly, the game displays the incorrect guess, and she loses a life.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0438-02.png" alt="image" width="600" height="208"/>
<h6/>
</div></figure>
<p>The user continues to make guesses until she finds all of the letters, or runs out of lives. When this happens, a new screen appears, telling her what the secret word was, and whether she won or lost the game. She’s given the option to start another game.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0438-03.png" alt="image" width="393" height="255"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="How the app will be structured"><div class="sect1" id="how_the_app_will_be_structured">
<h1>How the app will be structured</h1>
<p><a data-type="indexterm" data-primary="activities" data-secondary="view model" id="idm46053737844848"/><a data-type="indexterm" data-primary="fragments" data-secondary="view model" id="idm46053737843440"/><a data-type="indexterm" data-primary="GameFragment" id="idm46053737842336"/><a data-type="indexterm" data-primary="ResultFragment" id="idm46053737841504"/>The app will contain a single activity (named <code>MainActivity</code>), which will be used to display the game’s fragments: <code>GameFragment</code> and <code>ResultFragment</code>.</p>
<p><code>GameFragment</code> is the game’s main screen. It will display blanks for the secret word’s letters, let the user make guesses, and show any wrong choices and the number of lives left.</p>
<p>When the game is over, <code>GameFragment</code> will use the Navigation component to navigate to <code>ResultFragment</code>, passing it a <code>String</code> for the result. <code>ResultFragment</code> will display the <code>String</code> and a button to let the user start a new game.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0439-01.png" alt="image" width="600" height="448"/>
<h6/>
</div></figure>
<p>We’ll go into more details about how the app is structured when we build it. First, let’s run through the steps we’ll take.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Here’s what we’re going to do"><div class="sect1" id="hereapostrophes_what_weapostroph-id00165">
<h1>Here’s what we’re going to do</h1>
<p><a data-type="indexterm" data-primary="GameViewModel" id="idm46053737831456"/><a data-type="indexterm" data-primary="ResultViewModel" id="idm46053737830208"/>Here are the steps that we’ll go through to write the app:</p>
<ol>
<li><p><strong>Write the basic game.</strong></p>
<p>We’ll create <code>GameFragment</code> and <code>ResultFragment</code>, write the game logic, and use the Navigation component to navigate between the two fragments.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0440-01.png" alt="image" width="600" height="223"/>
<h6/>
</div></figure></li>
<li><p><strong>Add a view model for GameFragment.</strong></p>
<p>We’ll create a view model, <code>GameViewModel</code>, to hold <code>GameFragment</code>’s game logic and data. This will simplify the <code>GameFragment</code> code, and ensure that the game survives configuration changes.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0440-02.png" alt="image" width="383" height="123"/>
<h6/>
</div></figure></li>
<li><p><strong>Add a view model for ResultFragment.</strong></p>
<p>We’ll add a second view model, <code>ResultViewModel</code>, for <code>ResultFragment</code> to use. This view model will hold the result of the game that the user’s just played.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0440-03.png" alt="image" width="390" height="123"/>
<h6/>
</div></figure></li>
</ol>
<section data-type="sect2" data-pdf-bookmark="Create the Guessing Game project"><div class="sect2" id="create_the_guessing_game_project">
<h2>Create the Guessing Game project</h2>
<p>We’re going to use a new project for the Guessing Game app, so create one now using the same steps you used in the previous chapters. Choose the Empty Activity option, enter a name of “Guessing Game” and a package name of “com.hfad.guessinggame”, and accept the default save location. Make sure the language is set to Kotlin and the minimum SDK is API 21 so it will run on most Android devices.</p>
<p>The Guessing Game app will use view binding to reference its views, and the Navigation component to navigate between its fragments. Let’s update the project and app <em>build.gradle</em> files to include these libraries.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Update the project build.gradle file…"><div class="sect1" id="update_the_project_builddotgradle_filehe">
<h1>Update the <u>project</u> build.gradle file…</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0441-01.png" alt="image" width="283" height="87"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="Safe Args plug-in" data-secondary="Guessing Game app" id="idm46053737809648"/><a data-type="indexterm" data-primary="view binding" data-secondary="Guessing Game app" id="idm46053737808368"/>We’re going to add a new variable to the project’s <em>build.gradle</em> file to specify which version of the Navigation component we’ll be using, along with a Safe Args classpath.</p>
<p>Open the file <em>GuessingGame/build.gradle</em>, and add the following lines (in bold) to the sections shown:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0441-02.png" alt="image" width="600" height="194"/>
<h6/>
</div></figure>
<section data-type="sect2" data-pdf-bookmark="…and update the app build.gradle file too"><div class="sect2" id="hellipand_update_the_app_builddotgradle">
<h2>…and update the <u>app</u> build.gradle file too</h2>
<p>In the app’s <em>build.gradle</em> file, we need to enable view binding, add a dependency to the Navigation component library, and apply the Safe Args plug-in so that we can pass arguments to fragments.</p>
<p>Open the file <em>GuessingGame/app/build.gradle</em>, and add the following lines (in bold) to the appropriate sections:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0441-03.png" alt="image" width="600" height="306"/>
<h6/>
</div></figure>
<p>Once you’ve made these changes, click on the Sync Now option to sync the changes you’ve made with the rest of your project.</p>
<p>Next, we’ll create the app’s fragments.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="The Guessing Game app has two fragments"><div class="sect1" id="the_guessing_game_app_has_two_fragments">
<h1>The Guessing Game app has two fragments</h1>
<p><a data-type="indexterm" data-primary="fragments" data-secondary="creating for Guessing Game app" id="idm46053737799616"/><a data-type="indexterm" data-primary="GameFragment" data-secondary="creating" id="idm46053737793312"/><a data-type="indexterm" data-primary="ResultFragment" data-secondary="creating" id="idm46053737792208"/>The Guessing Game app requires two fragments: <code>GameFragment</code> and <code>ResultFragment</code>. <code>GameFragment</code> is the app’s main screen, and <code>ResultFragment</code> will be used to display the result:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0442-02.png" alt="image" width="600" height="132"/>
<h6/>
</div></figure>
<p>Let’s go ahead and add the two fragments to the project.</p>
<section data-type="sect2" data-pdf-bookmark="Create GameFragment…"><div class="sect2" id="create_gamefragmenthellip">
<h2>Create GameFragment…</h2>
<p>We’ll add <code>GameFragment</code> to the project first.</p>
<p>Highlight the <em>com.hfad.guessinggame</em> package in the <em>app/src/main/java</em> folder, then go to File→New→Fragment→Fragment (Blank). Name the fragment “GameFragment”, name its layout “fragment_game”, and make sure the language is set to Kotlin.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0442-03.png" alt="image" width="144" height="103"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#9D9EA0;">Don’t worry about the code for these fragments just yet. We’ll update them after we’ve added them to a navigation graph.</span></p>
</div>
</div></section>
<section data-type="sect2" data-pdf-bookmark="…and then create ResultFragment"><div class="sect2" id="hellipand_then_create_resultfragment">
<h2>…and then create ResultFragment</h2>
<p>Next, add <code>ResultFragment</code> by highlighting the <em>com.hfad.guessinggame</em> package in the <em>app/src/main/java</em> folder again, and choosing File→New→Fragment→Fragment (Blank). This time, name the fragment “ResultFragment”, name its layout “fragment_result”, and make sure the language is set to Kotlin.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0442-04.png" alt="image" width="143" height="115"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#9D9EA0;">Don’t worry about the code for these fragments just yet. We’ll update them after we’ve added them to a navigation graph.</span></p>
</div>
<p>We’ll update the code for these two fragments a few pages ahead. Before that, we’ll add a navigation graph to the project, which will tell the app how to navigate between the two fragments.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="How navigation should work"><div class="sect1" id="how_navigation_should_work">
<h1>How navigation should work</h1>
<p><a data-type="indexterm" data-primary="Navigation component" data-secondary="navigation graph" id="idm46053737771344"/>As you know, a navigation graph tells Android about an app’s possible destinations, and how to navigate to them.</p>
<p>In the Guessing Game app, we want navigation to work as follows:</p>
<ol>
<li><p><strong>When the app gets launched, display GameFragment.</strong></p><figure class="informal"><div class="figure">
<img src="Images/f0443-02.png" alt="image" width="139" height="99"/>
<h6/>
</div></figure></li>
<li><p><strong>When a game is won or lost, GameFragment navigates to ResultFragment, passing it the result.</strong></p><figure class="informal"><div class="figure">
<img src="Images/f0443-03.png" alt="image" width="376" height="101"/>
<h6/>
</div></figure></li>
<li><p><strong>When the user clicks on the New Game button, navigate to GameFragment.</strong></p><figure class="informal"><div class="figure">
<img src="Images/f0443-04.png" alt="image" width="343" height="98"/>
<h6/>
</div></figure></li>
</ol>
<p>To implement this, we’ll add <code>GameFragment</code> and <code>ResultFragment</code> to a new navigation graph (which we’ll create), and specify that each fragment can navigate to the other.</p>
<p>We’ll also say that <code>GameFragment</code> will pass a <code>String</code> argument to <code>ResultFragment</code>, specifying a message that indicates whether the user has won or lost the game they’ve just played. <code>ResultFragment</code> will display this message when it’s navigated to.</p>
<section data-type="sect2" data-pdf-bookmark="Create the navigation graph"><div class="sect2" id="create_the_navigation_graph">
<h2>Create the navigation graph</h2>
<p>To create the navigation graph, select the <em>GuessingGame/app/src/main/res</em> folder in the project explorer, and then choose File→New→Android Resource File. When prompted, enter a file name of “nav_graph”, choose a resource type of “Navigation”, and click on OK. This creates a navigation graph named <em>nav_graph.xml</em>.</p>
<p>We need to update the navigation graph to include <code>GameFragment</code> and <code>ResultFragment</code>, along with navigation actions for each one. We’ll do this next.</p>
<blockquote>
<p><strong>The navigation graph holds details of all the app’s possible destinations, and how to get to them.</strong></p>
</blockquote>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Update the navigation graph"><div class="sect1" id="update_the_navigation_graph-id00166">
<h1>Update the navigation graph</h1>
<p>To update the navigation graph, open the file <em>nav_graph.xml</em> (if it’s not already open), switch to the Code view, and update its code to include the changes shown here (in bold):</p>
<figure class="informal"><div class="figure">
<img src="Images/f0444-02.png" alt="image" width="600" height="525"/>
<h6/>
</div></figure>
<p>Now that you’ve updated the navigation graph, let’s link it to <code>MainActivity</code> so that it displays each fragment when we navigate to it.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Display the current fragment in MainActivity’s layout"><div class="sect1" id="display_the_current_fragment_in_mainacti">
<h1>Display the current fragment in MainActivity’s layout</h1>
<p><a data-type="indexterm" data-primary="fragments" data-secondary="adding navigation host to display" id="idm46053737742640"/><a data-type="indexterm" data-primary="Navigation component" data-secondary="navigation host" data-tertiary="adding to MainActivity layout" id="idm46053737741376"/>To display each fragment, we need to add a navigation host to <code>MainActivity</code>’s layout that’s linked to the navigation graph we just created. We’ll do this using a <code>FragmentContainerView</code>, just as we did in previous chapters.</p>
<p>You’re already familiar with the code to do this, so update <em>activity_main.xml</em> so that it matches the code below:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0445-01.png" alt="image" width="600" height="245"/>
<h6/>
</div></figure>
<p>When you’ve updated the layout, open <em>MainActivity.kt</em> and make sure it matches the code shown here:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0445-02.png" alt="image" width="600" height="223"/>
<h6/>
</div></figure>
<p>That’s everything we need for <code>MainActivity</code>. Next, let’s update the code for the two fragments, starting with <code>GameFragment</code>.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Update GameFragment’s layout"><div class="sect1" id="update_gamefragmentapostrophes_layout">
<h1>Update GameFragment’s layout</h1>
<p><a data-type="indexterm" data-primary="GameFragment" data-secondary="adding views to" id="idm46053737733024"/><a data-type="indexterm" data-primary="layouts" data-secondary="adding views to fragment" id="idm46053737729840"/><a data-type="indexterm" data-primary="views" data-secondary="GameFragment" id="idm46053737728768"/><code>GameFragment</code> is the app’s main screen, and it’s what the user will use to play the guessing game. We need to add several views to its layout to enable this: three text views for the word to guess, the number of lives left and the incorrect guesses that have been made, an edit text for typing guesses into, and a button to make the guess.</p>
<p>Add these views to the layout by updating the code in <em>fragment_game.xml</em> so it matches the code shown below:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0446-02.png" alt="image" width="600" height="537"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img src="Images/f0447-02.png" alt="image" width="600" height="328"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="GameFragment" data-secondary="tasks of" id="idm46053737722144"/>That’s everything we need to include in <code>GameFragment</code>’s layout. Next, let’s tell the game how to behave by updating its Kotlin code.</p>
<section data-type="sect2" data-pdf-bookmark="What GameFragment needs to do"><div class="sect2" id="what_gamefragment_needs_to_do">
<h2>What GameFragment needs to do</h2>
<p>In the first version of the app, <em>GameFragment.kt</em> needs to include all of the code that’s needed to play the game, as well as updating the screen and enabling navigation. It needs to:</p>
<ul style="list-style-type:none;">
<li><p><span class="inlineimage"><img src="Images/star.png" alt="Images" width="17" height="17"/></span> <strong>Choose a word at random.</strong></p>
<p>We’ll provide it with a list of possible words to choose from.</p></li>
<li><p><span class="inlineimage"><img src="Images/star.png" alt="Images" width="17" height="17"/></span> <strong>Let the user guess a letter.</strong></p></li>
<li><p><span class="inlineimage"><img src="Images/star.png" alt="Images" width="17" height="17"/></span> <strong>Respond to the guess.</strong></p>
<p>If the user guesses correctly, <code>GameFragment</code> needs to add the letter to a list of correct guesses, and show where the letter appears in the word. If the guess is incorrect, it needs to add the guess to a <code>String</code> of incorrect guesses, and decrement the number of lives left.</p></li>
<li><p><span class="inlineimage"><img src="Images/star.png" alt="Images" width="17" height="17"/></span> <strong>Navigate to ResultFragment when the game is over.</strong></p></li>
</ul>
<p>All of this code is pure Kotlin, or Android code that you’ve seen before. We’ll show you the full code over the next few pages.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="The GameFragment.kt code"><div class="sect1" id="the_gamefragmentdotkt_code">
<h1>The GameFragment.kt code</h1>
<p>Here’s the code for <code>GameFragment</code>; update the code in <em>GameFragment.kt</em> so that it matches the code shown below:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0448-02.png" alt="image" width="600" height="580"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img src="Images/f0449-02.png" alt="image" width="600" height="610"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img src="Images/f0450-02.png" alt="image" width="600" height="559"/>
<h6/>
</div></figure>
<p>That’s all the code that we need for <code>GameFragment</code>. Next, let’s write the <code>ResultFragment</code> code.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Update ResultFragment’s layout"><div class="sect1" id="update_resultfragmentapostrophes_layout">
<h1>Update ResultFragment’s layout</h1>
<p><a data-type="indexterm" data-primary="ResultFragment" data-secondary="adding views to" id="idm46053737694720"/><a data-type="indexterm" data-primary="views" data-secondary="ResultFragment" id="idm46053737693264"/><code>ResultFragment</code> uses a text view to tell the user whether she’s won or lost the game she’s just played, and a button to let her start another game. We need to add both of these views to the fragment’s layout.</p>
<p>You’re already familiar with the code to do this, so open <em>fragment_result.xml</em>, and update it so that it matches the code shown below:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0451-02.png" alt="image" width="600" height="426"/>
<h6/>
</div></figure>
<section data-type="sect2" data-pdf-bookmark="We also need to update ResultFragment.kt"><div class="sect2" id="we_also_need_to_update_resultfragmentdot">
<h2>We also need to update ResultFragment.kt</h2>
<p>Once we’ve added the text view and button to <code>ResultFragment</code>’s layout, we need to specify their behavior in the fragment’s Kotlin code. We’ll update the text view’s text with the result, and we’ll also make the button navigate back to <code>GameFragment</code> when it’s clicked.</p>
<p>We’ll show you the code for <em>ResultFragment.kt</em> on the next page.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="The ResultFragment.kt code"><div class="sect1" id="the_resultfragmentdotkt_code">
<h1>The ResultFragment.kt code</h1>
<p>Here’s the code for <code>ResultFragment</code>; update <em>ResultFragment.kt</em> so it matches the code below:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0452-02.png" alt="image" width="600" height="579"/>
<h6/>
</div></figure>
<p>That’s all the code that we need for this version of the Guessing Game app. Let’s go through what happens when the code runs, and take the app for a test drive.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What happens when the app runs"><div class="sect1" id="what_happens_when_the_app_runs-id00167">
<h1>What happens when the app runs</h1>
<p><a data-type="indexterm" data-primary="makeGuess() method" id="idm46053737677888"/><a data-type="indexterm" data-primary="makeGuess() method" data-secondary="GameFragment" id="idm46053737676720"/><a data-type="indexterm" data-primary="updateScreen() method, GameFragment" id="idm46053737675616"/>The following things happen when the app runs:</p>
<ol>
<li><p><strong>The app is launched and GameFragment is displayed in MainActivity.</strong></p>
<p><code>GameFragment</code> sets <code>livesLeft</code> to 8, <code>correctGuesses</code> and <code>incorrectGuesses</code> to <code>""</code>, <code>secretWord</code> to a word it chooses at random, and <code>secretWordDisplay</code> to the value of <code>deriveSecretWordDisplay()</code>. It then calls its <code>updateScreen()</code> method, which displays the values of <code>livesLeft</code>, <code>incorrectGuesses</code>, and <code>secretWordDisplay</code>.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0453-02.png" alt="image" width="503" height="215"/>
<h6/>
</div></figure></li>
<li><p><strong>When the user makes a guess, GameFragment calls its makeGuess() method.</strong></p>
<p>The method checks if <code>secretWord</code> contains the letter the user has guessed. If it does, <code>makeGuess()</code> adds the letter to <code>correctGuesses</code> and updates <code>secretWordDisplay</code>. If it doesn’t, the method adds the letter to <code>incorrectGuesses</code>, and subtracts 1 from <code>livesLeft</code>. It then calls <code>updateScreen()</code> again so that the new values are displayed.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0453-03.png" alt="image" width="600" height="210"/>
<h6/>
</div></figure></li>
<li><p><strong>After each guess, GameFragment checks if isWon() or isLost() is true.</strong></p>
<p>These methods check if the user has guessed all the letters in the word, or if she has run out of lives. If either method returns <em>true</em>, <code>GameFragment</code> passes the result to <code>ResultFragment</code>, which displays the result.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0453-04.png" alt="image" width="600" height="162"/>
<h6/>
</div></figure></li>
</ol>
</div></section>
<section data-type="sect1" data-pdf-bookmark=" Test Drive"><div class="sect1" id="test_drive-id00168">
<h1><span class="inlineimage"><img src="Images/car.png" alt="Images" width="119" height="58"/></span> Test Drive</h1>
<p>When we run the app, <code>GameFragment</code> is displayed. It shows how many letters the secret word has, and how many lives we have.</p>
<p>We can make a guess by entering a letter in the edit text, and clicking the button. If we guess correctly, it places the letter in the secret word, but if we get it wrong, we lose a life.</p>
<p>If we guess all the letters or run out of lives, a message telling us whether we’ve won or lost is displayed in <code>ResultFragment</code>.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0454-02.png" alt="image" width="600" height="538"/>
<h6/>
</div></figure>
<p>The game seems to work, but what happens if we rotate the screen?</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="The game loses state when the screen rotates"><div class="sect1" id="the_game_loses_state_when_the_screen_rot">
<h1>The game loses state when the screen rotates</h1>
<p><a data-type="indexterm" data-primary="rotation of device" data-secondary="configuration changed by" id="idm46053737644736"/>There’s a problem with the game, however. If we rotate the screen when we’re in the middle of a game, the app loses its state and the game starts from the beginning.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0455-02.png" alt="image" width="600" height="441"/>
<h6/>
</div></figure>
<p>The game loses its state because rotating the screen changes the app’s configuration, so Android destroys the activity (and the fragment it displays) and immediately recreates it. This resets the game’s views and properties.</p>
<p>We <em>could</em> solve this problem using the fragment’s <code>onSaveInstanceState</code> method to save the state of any properties, as we did earlier in the book. This time, however, we’re going to fix it by <strong>implementing a view model</strong> instead.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="A view model holds business logic"><div class="sect1" id="a_view_model_holds_business_logic">
<h1>A view model holds business logic</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0456-01.png" alt="image" width="283" height="86"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="view models" data-secondary="reasons for using" id="idm46053737635968"/>As we said earlier, a view model is a separate class that sits alongside your activity or fragment code. It’s responsible for the data that needs to be displayed on the screen along with any business logic. In our Guessing Game app, for example, this means that the view model needs to hold the game’s properties—like the secret word the user needs to guess, and the number of lives left—and any methods that control how the game is played.</p>
<p>When you implement a view model, all of the code relating to the app’s data or business logic is moved out of the activity or fragment, and into the view model. Any code that controls the UI—such as displaying text, or getting user input—stays in the activity or fragment code.</p>
<p>This way of architecting Android apps follows a design principle known as <em>separation of concerns</em>. The app is split into different classes, where each class addresses a separate concern. A UI controller—the activity or fragment code—handles the UI, and the view model is responsible for the business logic and data:</p>
<blockquote>
<p><strong>Use a view model to simplify your activity and fragment code, and hold the state of any properties so that they survive configuration changes.</strong></p>
</blockquote>
<figure class="informal"><div class="figure">
<img src="Images/f0456-02.png" alt="image" width="600" height="114"/>
<h6/>
</div></figure>
<p>Using this sort of app architecture has two key advantages.</p>
<ul style="list-style-type:none;">
<li><p><span class="inlineimage"><img src="Images/star.png" alt="Images" width="17" height="17"/></span> <strong>It simplifies your activity and fragment code.</strong></p>
<p>Moving the app’s data and business logic into a view model means that there’s less activity and fragment code for you to maintain.</p></li>
<li><p><span class="inlineimage"><img src="Images/star.png" alt="Images" width="17" height="17"/></span> <strong>Your app survives configuration changes.</strong></p>
<p>The view model is a separate class that sits alongside your activity or fragment code. It’s not destroyed when you rotate the device screen, so the state of any properties held in the view model survives configuration changes without you having to add their values to a <code>Bundle</code>.</p></li>
</ul>
<p>Now that you’ve learned what using a view model buys you, let’s see how to add one to the Guessing Game app.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Add a view model dependency to the app build.gradle file…"><div class="sect1" id="add_a_view_model_dependency_to_the_app_b">
<h1>Add a view model dependency to the <u>app</u> build.gradle file…</h1>
<p><a data-type="indexterm" data-primary="GameFragment" data-secondary="GameViewModel" id="idm46053737617920"/><a data-type="indexterm" data-primary="GameViewModel" data-secondary="creating" id="idm46053737619808"/><a data-type="indexterm" data-primary="ViewModel class" id="idm46053737616464"/><a data-type="indexterm" data-primary="view models" data-secondary="GameFragment" id="idm46053737615728"/>The view model library is part of Android Jetpack, so you need to update the app’s <em>build.gradle</em> file to include it as a dependency.</p>
<p>Open the file <em>GuessingGame/app/build.gradle</em>, and add the following line (in bold) to the dependencies section:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0457-02.png" alt="image" width="600" height="111"/>
<h6/>
</div></figure>
<p>When prompted, sync your changes. You’re now ready to go ahead and create a view model.</p>
<section data-type="sect2" data-pdf-bookmark="…and create a view model"><div class="sect2" id="hellipand_create_a_view_model">
<h2>…and create a view model</h2>
<p>We’re going to create a view model named <code>GameViewModel</code>, which <code>GameFragment</code> will use for its game logic and data.</p>
<p>Select the <em>com.hfad.guessinggame</em> package in the <em>app/src/main/java</em> folder, then go to File→New→Kotlin Class/File. Name the file “GameViewModel” and choose the option to create a class.</p>
<p>When the <em>GameViewModel.kt</em> file has been created, update its code to match the code below (the changes are in bold):</p>
<figure class="informal"><div class="figure">
<img src="Images/f0457-03.png" alt="image" width="600" height="193"/>
<h6/>
</div></figure>
<p>As you can see, the <code>GameViewModel</code> class extends <code>androidx.lifecycle.ViewModel</code>. <code>ViewModel</code> is an abstract class that’s used to turn a plain old class into a card-carrying view model.</p>
<p>Now that we’ve added <code>GameViewModel</code> to the Guessing Game project and turned it into a view model, let’s write the rest of its code.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="The full code for GameViewModel.kt"><div class="sect1" id="the_full_code_for_gameviewmodeldotkt">
<h1>The full code for GameViewModel.kt</h1>
<p><a data-type="indexterm" data-primary="GameViewModel" data-secondary="code for" id="idm46053737601776"/>As you’ve already learned, the view model is responsible for an activity or fragment’s business logic and data. For the Guessing Game app, this means that we need to take all of <code>GameFragment</code>’s properties and methods that relate to how the game is played, and move them into <code>GameViewModel</code>. We’ll leave any code relating to navigation or the UI in <code>GameFragment</code>.</p>
<p>Here’s the full code for <em>GameViewModel.kt</em>; update the code to include the changes (in bold):</p>
<figure class="informal"><div class="figure">
<img src="Images/f0458-02.png" alt="image" width="600" height="471"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img src="Images/f0459-02.png" alt="image" width="600" height="573"/>
<h6/>
</div></figure>
<p>That’s everything that we need for <code>GameViewModel</code>. Next, let’s link it to <code>GameFragment</code>, and update the code for that fragment.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Create a GameViewModel object"><div class="sect1" id="create_a_gameviewmodel_object">
<h1>Create a GameViewModel object</h1>
<p><a data-type="indexterm" data-primary="GameViewModel" data-secondary="linking to fragment" id="idm46053737590864"/><a data-type="indexterm" data-primary="GameViewModel" data-secondary="ViewModelProvider" id="idm46053737587424"/><a data-type="indexterm" data-primary="ViewModel class" id="idm46053737586320"/><a data-type="indexterm" data-primary="viewModel property" id="idm46053737585488"/><a data-type="indexterm" data-primary="ViewModelProvider class" id="idm46053737584656"/>To link a view model to an activity or fragment, you need to add a <code>ViewModel</code> property to the code, and initialize it with a <code>ViewModel</code> object, which you need to create. The code looks like this:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0460-02.png" alt="image" width="600" height="313"/>
<h6/>
</div></figure>
<p>As you can see, the above code uses a <strong>view model provider</strong> to create the <code>ViewModel</code> object. So what does using this class do?</p>
<section data-type="sect2" data-pdf-bookmark="Use a ViewModelProvider to create view models"><div class="sect2" id="use_a_viewmodelprovider_to_create_view_m">
<h2>Use a ViewModelProvider to create view models</h2>
<p>As its name suggests, <code>ViewModelProvider</code> is a special class whose job is to provide activities and fragments with view models. It ensures that <strong>a new view model object only gets created if one doesn’t already exist</strong>.</p>
<p>As you already know, when the screen is rotated, any fragments that are displayed on the screen get destroyed and recreated. When this happens, the view model provider makes sure that the same view model object continues to be used. The view model keeps its state, so any properties that are used by the fragment don’t get reset.</p>
<p>The view model provider keeps hold of the view model so long as the activity or fragment stays alive. When a fragment is detached or removed from its activity, for example, the view model provider lets go of the fragment’s view model. The next time the view model provider is asked to provide a view model object, it creates a new one.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0460-03.png" alt="image" width="383" height="311"/>
<h6/>
</div></figure>
<p>Now that you’ve learned how to link a view model to a fragment, let’s update the <code>GameFragment</code> code.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="The updated code for GameFragment.kt"><div class="sect1" id="the_updated_code_for_gamefragmentdotkt">
<h1>The updated code for GameFragment.kt</h1>
<p><a data-type="indexterm" data-primary="GameFragment" data-secondary="code for" id="idm46053737571472"/>We need to remove the properties and methods from <code>GameFragment</code> that we moved to <code>GameViewModel</code>, and make the fragment use the view model instead.</p>
<p>Here’s the updated code for <code>GameFragment</code>; make sure that the file <em>GameFragment.kt</em> includes the changes shown below (in bold):</p>
<figure class="informal"><div class="figure">
<img src="Images/f0461-02.png" alt="image" width="600" height="605"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img src="Images/f0462-02.png" alt="image" width="600" height="577"/>
<h6/>
</div></figure>
<p>Those are all the changes that we need to make to <code>GameFragment</code>. Let’s go through what the code does when it runs, and take it for a test drive.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What happens when the app runs"><div class="sect1" id="what_happens_when_the_app_runs-id00169">
<h1>What happens when the app runs</h1>
<p>The following things happen when the app runs:</p>
<ol>
<li><p><strong>GameFragment asks the ViewModelProvider class for an instance of GameViewModel.</strong></p>
<p>The view model provider sees that there’s no existing <code>GameViewModel</code> object associated with the fragment, so it creates a new one.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0463-02.png" alt="image" width="600" height="111"/>
<h6/>
</div></figure></li>
<li><p><strong>The GameViewModel object is initialized.</strong></p>
<p>It sets <code>livesLeft</code> to 8, <code>correctGuesses</code> and <code>incorrectGuesses</code> to <code>""</code>, <code>secretWord</code> to a word it chooses at random, and <code>secretWordDisplay</code> to <code>deriveSecretWordDisplay()</code>.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0463-03.png" alt="image" width="418" height="141"/>
<h6/>
</div></figure></li>
<li><p><strong>GameFragment calls its updateScreen() method.</strong></p>
<p>The method accesses the <code>GameViewModel</code> object’s <code>secretWordDisplay</code>, <code>livesLeft</code>, and <code>incorrectGueses</code> properties, and shows them on the screen.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0463-04.png" alt="image" width="600" height="287"/>
<h6/>
</div></figure></li>
<li><p><strong>When the user makes a guess, GameFragment calls the GameViewModel object’s makeGuess() method.</strong></p>
<p>The method checks if <code>secretWord</code> contains the letter the user guesses. If it does, it adds the letter to <code>correctGuesses</code> and updates <code>secretWordDisplay</code>. If it doesn’t, it adds it to <code>incorrectGuesses</code>, and subtracts 1 from <code>livesLeft</code>.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0464-02.png" alt="image" width="600" height="122"/>
<h6/>
</div></figure></li>
<li><p><strong>GameFragment calls its updateScreen() method again.</strong></p>
<p>The method gets the updated property values from the <code>GameViewModel</code> object, and updates the screen.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0464-03.png" alt="image" width="600" height="268"/>
<h6/>
</div></figure></li>
<li><p><strong>After each guess, GameFragment checks if the view model’s isWon() or isLost() methods return true.</strong></p>
<p>If either method returns <em>true</em>, <code>GameFragment</code> passes the result to <code>ResultFragment</code>, which displays the result.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0464-04.png" alt="image" width="600" height="236"/>
<h6/>
</div></figure></li>
</ol>
</div></section>
<section data-type="sect1" data-pdf-bookmark=" Test Drive"><div class="sect1" id="test_drive-id00170">
<h1><span class="inlineimage"><img src="Images/car.png" alt="Images" width="119" height="58"/></span> Test Drive</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0465-01.png" alt="image" width="284" height="87"/>
<h6/>
</div></figure>
<p>When we run the app, <code>GameFragment</code> is displayed as before. If we start playing the game and rotate the screen, the game retains its state.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0465-02.png" alt="image" width="600" height="427"/>
<h6/>
</div></figure>
<p>You’ve now learned how to add a view model to your apps, and used it to avoid the problems that can occur when the user rotates the device screen. Before we go any further, let’s take a closer look at view models.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="view_models_up_close">
<h5><span class="inlineimage"><img src="Images/zooml.png" alt="Images" width="135" height="81"/></span> View Models Up Close</h5>
<p><a data-type="indexterm" data-primary="onCleared() method, view model’s overriding of" id="idm46053737519536"/><a data-type="indexterm" data-primary="ViewModel class" id="idm46053737518272"/>A view model is a separate class you write that’s responsible for a UI controller’s business logic and data. It extends the <code>androidx.lifecycle.ViewModel</code> class, and may optionally override a method named <code><strong>onCleared()</strong></code>. This method gets called just before the view model gets cleared away, and it gives you a chance to dispose of any resources:</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#9D9EA0;">The UI controller can be an activity or fragment.</span></p>
</div>
<pre data-type="programlisting">import androidx.lifecycle.ViewModel

class MyViewModel : ViewModel() {
    //Code to initialize the view model

    <strong>override fun onCleared() {</strong>
        <strong>//Code that runs when the view model is about to get cleared away</strong>
    <strong>}</strong>
}</pre>
<p>You create a view model object using the <code>ViewModelProvider</code> class, for example:</p>
<pre data-type="programlisting">viewModel = ViewModelProvider(this).get(MyViewModel::class.java)</pre>
<p>This creates a view model in the same scope as the UI controller. It ensures that a fresh view model <em>only</em> gets created if there’s not an existing one in the UI controller’s scope. This means that the view model survives configuration changes, so you don’t have to save the state of any instance variables in a separate <code>Bundle</code>.</p>
<p>The view model stays alive until its UI controller permanently goes away. If it’s linked to an activity, this is when the activity has finished: when it’s been destroyed and won’t be recreated. If it’s linked to a fragment, it’s when the fragment has been removed or detached from its parent activity.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0466-02.png" alt="image" width="268" height="328"/>
<h6/>
</div></figure>
<p>You can track when a view model has been created or cleared away using the <code><strong>android.util.Log</strong></code> class. This class lets you add messages to Android’s log (or logcat) that you can examine in Android Studio. The following code, for example, logs a message when the view model is cleared:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0466-03.png" alt="image" width="600" height="51"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="logcat, viewing" id="idm46053737503840"/><a data-type="indexterm" data-primary="Log class" id="idm46053737501936"/><a data-type="indexterm" data-primary="Log.i() method" id="idm46053737501088"/><a data-type="indexterm" data-primary="Log.wtf() method" id="idm46053737500256"/>The <code>Log</code> class includes several methods you can use to log different types of message. The <code>Log.i()</code> method lets you log information, for example, while <code>Log.e()</code> is used for recording errors.</p>
<p>Here is a list of the different <code>Log</code> methods you can use, and what they’re used for:</p>
<table class="border">
<tbody>
<tr>
<td>Log.v(String tag, String message)</td>
<td>Logs a verbose message.</td>
</tr>
<tr>
<td>Log.d(String tag, String message)</td>
<td>Logs a debug message.</td>
</tr>
<tr>
<td>Log.i(String tag, String message)</td>
<td>Logs an information message.</td>
</tr>
<tr>
<td>Log.w(String tag, String message)</td>
<td>Logs a warning message.</td>
</tr>
<tr>
<td>Log.e(String tag, String message)</td>
<td>Logs an error message.</td>
</tr>
</tbody>
</table>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#9D9EA0;">There’s also a Log.wtf() method you can use to report conditions that should never happen. According to the Android documentation, wtf means “What a Terrible Failure.” We know it really means “Welcome to Fiskidagurinn,” which refers to the Great Fish Day festival held annually in Dalvik, Iceland. Android developers can often be heard to say, “My virtual device just took 8 minutes to boot up. WTF??” as a tribute to the small town that gave its name to the standard Android executable bytecode format.</span></p>
</div>
<p>Each message is composed of a <code>String</code> tag you use to identify the source of the message, and the message itself. So the code:</p>
<pre data-type="programlisting">Log.i("MyViewModel", "ViewModel cleared")</pre>
<p>logs an information message that’s come from <code>MyViewModel</code>.</p>
<p>You can view the logcat in Android Studio by choosing the Logcat option at the bottom of the screen. This lets you filter by the different types of message, and search for text:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0467-02.png" alt="image" width="600" height="251"/>
<h6/>
</div></figure>
</div></aside>
</div></section>
<section data-type="sect1" data-pdf-bookmark="BE the View Model"><div class="sect1" id="be_the_view_model">
<h1>BE the View Model</h1>
<figure class="informal"><div class="figure">
<img src="Images/common04.png" alt="image" width="156" height="199"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="exercises" data-secondary="Be the . . ." id="idm46053737478688"/><a data-type="indexterm" data-primary="view models" data-secondary="exercises" id="idm46053737477504"/><strong>The code below describes a view model class named MyViewModel. Your job is to play like you’re the view model, and say what problems there are with this code and how they could be fixed.</strong></p>
<pre data-type="programlisting">package com.hfad.myapp

import androidx.lifecycle.ViewModel
import android.util.Log
import android.widget.TextView

class MyViewModel {
    val num = 2

    init {
        Log.i("MyViewModel", "ViewModel created")
    }

    override fun onCleared() {
        Log.i("MyViewModel", "ViewModel cleared")
    }

    fun calculation(val1: Int, val2: Int): Int {
        Log.i("MyViewModel", "Called Calculation")
        return (val1 + val2) * num
    }

    fun joinTogether(text1: TextView, text2: TextView): String {
        Log.i("MyViewModel", "Called JoinTogether")
        return ("${text1.text} ${text2.text}")
    }
}</pre>
<p><span class="inlineimage"><img src="Images/arr.png" alt="Images" width="101" height="9"/></span> <strong>Answers in <a data-type="xref" href="#be_the_view_model_solution">“BE the View Model Solution”</a>.</strong></p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="We’ve added a view model for GameFragment"><div class="sect1" id="weapostropheve_added_a_view_model_for_ga">
<h1>We’ve added a view model for GameFragment</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0469-01.png" alt="image" width="283" height="87"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="ResultFragment" data-secondary="view model for" id="idm46053737466752"/><a data-type="indexterm" data-primary="ResultViewModel" id="idm46053737465552"/><a data-type="indexterm" data-primary="ViewModel class" id="idm46053737464720"/><a data-type="indexterm" data-primary="view models" data-secondary="ResultFragment" id="idm46053737463888"/>So far, we’ve updated the Guessing Game app so that <code>GameFragment</code> uses a view model named <code>GameViewModel</code>, which is responsible for all of the fragment’s business logic and data. Using a view model in this way simplifies the code in <em>GameFragment.kt</em>, and means that the app doesn’t lose its state when the screen is rotated.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0469-02.png" alt="image" width="600" height="201"/>
<h6/>
</div></figure>
<section data-type="sect2" data-pdf-bookmark="ResultFragment needs a view model too"><div class="sect2" id="resultfragment_needs_a_view_model_too">
<h2>ResultFragment needs a view model too</h2>
<p>Each view model you create is associated with a single UI controller—an activity or fragment. This means that if we want <code>ResultFragment</code> to use a view model too, we need to create a new one for this fragment.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0469-03.png" alt="image" width="387" height="240"/>
<h6/>
</div></figure>
<p>Let’s do this now. Highlight the <em>com.hfad.guessinggame</em> package in the <em>app/src/main/java</em> folder, then go to File→New→Kotlin Class/File. Name the file “ResultViewModel” and choose the option to create a class.</p>
<p>When the <em>ResultViewModel.kt</em> file has been created, update its code to match ours below (our changes are in bold):</p>
<figure class="informal"><div class="figure">
<img src="Images/f0469-04.png" alt="image" width="600" height="191"/>
<h6/>
</div></figure>
<p>That’s the basic code you need to define a view model. So what other code do we need to add?</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="ResultViewModel needs to hold the result"><div class="sect1" id="resultviewmodel_needs_to_hold_the_result">
<h1>ResultViewModel needs to hold the result</h1>
<p><a data-type="indexterm" data-primary="argument constructor and view model factory" id="idm46053737448752"/><a data-type="indexterm" data-primary="ResultFragment" data-secondary="linking ResultViewModel to" id="idm46053737447728"/>As you may recall, <code>ResultFragment</code> displays a message in its layout that tells the user whether they’ve won or lost the game they’ve just played. This message is passed to <code>ResultFragment</code> by <code>GameFragment</code> when the game is over.</p>
<p>In the new version of the app, <code>ResultViewModel</code> is responsible for <code>ResultFragment</code>’s game logic and data, so we need to add a property to <code>ResultViewModel</code> to store the result. We’ll also use a <code>String</code> constructor to make sure this property gets set as soon as <code>ResultViewModel</code> gets created.</p>
<p>Here’s the full code for <em>ResultViewModel.kt</em>; update its code to include the changes below (in bold):</p>
<figure class="informal"><div class="figure">
<img src="Images/f0470-02.png" alt="image" width="600" height="182"/>
<h6/>
</div></figure>
<p>Next, we’ll update <code>ResultFragment</code> so that it uses the new view model.</p>
<section data-type="sect2" data-pdf-bookmark="We need to link ResultViewModel to ResultFragment"><div class="sect2" id="we_need_to_link_resultviewmodel_to_resul">
<h2>We need to link ResultViewModel to ResultFragment</h2>
<p>Earlier, we were able to add a <code>GameViewModel</code> reference to <code>GameFragment</code> using this code:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0470-03.png" alt="image" width="600" height="120"/>
<h6/>
</div></figure>
<p>This tells the view model provider to get the <code>GameViewModel</code> object that’s linked to the fragment, or create a new one if it doesn’t already exist.</p>
<p>The above approach, however, can’t be used to add a <code>ResultViewModel</code> reference to <code>ResultFragment</code>. This is because it <strong>only works for view models with a no argument constructor</strong>.</p>
<p>The code worked for <code>GameViewModel</code> because we could construct it without passing any arguments. The constructor for the <code>ResultViewModel</code> class, however, requires a <code>String</code>, so the above code won’t work.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="A view model factory creates view models"><div class="sect1" id="a_view_model_factory_creates_view_models">
<h1>A <u>view model factory</u> creates view models</h1>
<p><a data-type="indexterm" data-primary="view model factory" id="idm46053737427936"/><a data-type="indexterm" data-primary="ViewModelProvider class" id="idm46053737426432"/>An alternative way of creating a view model is to pass the view model provider a <strong>view model factory</strong>: a separate class whose sole purpose is to create and initialize view models. This approach means that the view model provider doesn’t have to worry about creating a view model by itself. Instead, it uses the view model factory.</p>
<p>While view model factories can be used for any sort of view model, they’re mostly used for ones whose constructors require arguments. This is because the view model provider can’t pass arguments to the constructor by itself: it needs a view model factory to do so.</p>
<p>Here’s how the view model factory will be used in the Guessing Game app:</p>
<blockquote>
<p><strong>Use a view model factory to create a view model that doesn’t have a no-argument constructor.</strong></p>
</blockquote>
<ol>
<li><p><strong>We’ll define a class named ResultViewModelFactory, which ResultFragment will use to create a factory object.</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0471-02.png" alt="image" width="471" height="154"/>
<h6/>
</div></figure></li>
<li><p><strong>ResultFragment will tell the view model provider to use the factory object.</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0471-03.png" alt="image" width="600" height="141"/>
<h6/>
</div></figure></li>
<li><p><strong>When the view model provider needs a new ResultViewModel object, it will use the ResultViewModelFactory.</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0471-04.png" alt="image" width="468" height="305"/>
<h6/>
</div></figure></li>
</ol>
<p>Let’s go ahead and add a factory class to the Guessing Game app.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Create the ResultViewModelFactory class"><div class="sect1" id="create_the_resultviewmodelfactory_class">
<h1>Create the ResultViewModelFactory class</h1>
<p><a data-type="indexterm" data-primary="create() method, ResultViewModelFactory’s override of" id="idm46053737412800"/><a data-type="indexterm" data-primary="ResultViewModelFactory class" id="idm46053737410640"/><a data-type="indexterm" data-primary="ViewModelProvider class" id="idm46053737409856"/>We’re going to add a view model factory class named <code>ResultViewModelFactory</code> to the Guessing Game app. This class will be used by the view model provider to create a <code>ResultViewModel</code> object.</p>
<p>To create the class, highlight the <em>com.hfad.guessinggame</em> package in the <em>app/src/main/java</em> folder, then go to File→New→Kotlin Class/File. Name the file “ResultViewModelFactory” and choose the option to create a class.</p>
<p>When the <em>ResultViewModelFactory.kt</em> file has been created, update its code to match ours below (our changes are in bold):</p>
<figure class="informal"><div class="figure">
<img src="Images/f0472-02.png" alt="image" width="600" height="433"/>
<h6/>
</div></figure>
<p>As you can see, the <code>ResultViewModelFactory</code> class implements an interface named <code>ViewModelProvider.Factory</code>, and overrides its <code>create()</code> method. This turns the class into a view model factory, which the view model provider can use to create a <code>ResultViewModel</code> object.</p>
<p>The above code is everything we need for <code>ResultViewModelFactory</code>. Let’s find out how to use it in our <code>ResultFragment</code> code.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="relax-id00171">
<h5><span class="inlineimage"><img src="Images/cup.png" alt="Images" width="124" height="107"/></span> Relax</h5>
<p><strong>All view model factory code is nearly identical.</strong></p>
<p>Don’t worry too much about the code details. All you really need to know is it creates a view model of a particular type, and passes an argument to its constructor.</p>
</div></aside>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Use the factory to create the view model"><div class="sect1" id="use_the_factory_to_create_the_view_model">
<h1>Use the factory to create the view model</h1>
<p><a data-type="indexterm" data-primary="onCreateView() method, fragments" data-secondary="view model properties" id="idm46053737393440"/><a data-type="indexterm" data-primary="viewModelFactory property" id="idm46053737392304"/><a data-type="indexterm" data-primary="viewModel property" id="idm46053737391440"/>As we said earlier, you use a view model factory to create a view model by passing the factory to the view model provider. The view model provider decides when a new view model object is required, and when necessary, uses the factory to create one.</p>
<p>The code to make the view model provider use a view model factory is virtually identical for every view model you want to create. It looks like this:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0473-02.png" alt="image" width="600" height="404"/>
<h6/>
</div></figure>
<p>As you can see, the above code defines two properties: <code>viewModel</code> and <code>viewModelFactory</code>. These are set in the fragment’s <code>onCreateView()</code> method.</p>
<p>In <code>onCreateView()</code>, the code uses the result <code>String</code> that’s passed to it from <code>GameFragment</code> to create a new <code>ResultViewModelFactory</code> object. It passes the factory to the view model provider, which uses it to get a <code>ResultViewModel</code> object.</p>
<p>Now that you know how to use a factory to link a view model to a fragment, let’s update the <code>ResultFragment</code> code.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0473-03.png" alt="image" width="489" height="325"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="The updated code for ResultFragment.kt"><div class="sect1" id="the_updated_code_for_resultfragmentdotkt">
<h1>The updated code for ResultFragment.kt</h1>
<p><a data-type="indexterm" data-primary="ResultFragment" data-secondary="code for" id="idm46053737379888"/>Here’s the full code for <code>ResultFragment</code>, so update the code in file <em>ResultFragment.kt</em> so it includes the changes shown below (in bold):</p>
<figure class="informal"><div class="figure">
<img src="Images/f0474-02.png" alt="image" width="600" height="600"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img src="Images/f0475-02.png" alt="image" width="600" height="211"/>
<h6/>
</div></figure>
<p>Those are all the changes that we need to make to <code>ResultFragment</code>. After some questions, we’ll go through what happens when the app runs.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-id00172">
<h5>there are no Dumb Questions</h5>
<p><strong>Q: Does</strong> <code><strong>ResultFragment</strong></code> <strong>really need its own view model?</strong></p>
<p><strong>A:</strong> We decided to use one so that we could separate out any game logic and data required by <code>ResultFragment</code>. This is only a result <code>String</code> in the current app, but it’s good practice in case the app gets more complicated. And let’s face it, it was a good excuse for us to teach you about using view model factories.</p>
<p><strong>Q: Why didn’t we use a factory when we created</strong> <code><strong>GameViewModel</strong></code><strong>?</strong></p>
<p><strong>A:</strong> Factories are only necessary when you need to create a view model that doesn’t have a no-arguments constructor. As <code>GameViewModel</code> uses the default constructor which has no arguments, we didn’t need to use a factory.</p>
<p><strong>Q: Could we still have used a factory for</strong> <code><strong>GameViewModel</strong></code> <strong>if we’d wanted to?</strong></p>
<p><strong>A:</strong> Yes. You can use factories to create any sort of view model, but if the view model has a no-argument constructor, you don’t need to use one.</p>
<p><strong>Q: Why did we need to add a constructor to</strong> <code><strong>ResultViewModel</strong></code><strong>?</strong></p>
<p><strong>A:</strong> So that we could set the result <code>String</code> as soon as the view model was created. This guarantees that the result <code>String</code> has a value whenever <code>ResultFragment</code> uses the view model.</p>
<p><strong>Q: Do you have to create view models using the</strong> <code><strong>ViewModelProvider</strong></code> <strong>class? What happens if you don’t?</strong></p>
<p><strong>A:</strong> Yes, you should always use the view model provider to create a view model object. The view model provider <em>only</em> creates a new view model object if one doesn’t already exist for the UI controller’s scope, which means that the view model survives configuration changes.</p>
<p>If you instantiate a view model without using the view model provider, it will get recreated each time the UI controller is destroyed and recreated. The view model would lose its state each time the device screen is rotated.</p>
<p><strong>Q: Can you unit test view models?</strong></p>
<p><strong>A:</strong> Yes! View models don’t refer to any of the screen’s views, so they can be unit tested independently of activities and fragments. You don’t have to run the app to test them.</p>
<p><strong>Q: Why didn’t we create a view model for</strong> <code><strong>MainActivity</strong></code><strong>?</strong></p>
<p><strong>A:</strong> In the Guessing Game app, <code>MainActivity</code> is only used to display the game’s fragments. As <code>MainActivity</code> doesn’t include any game logic or data, we didn’t need to create a view model for it.</p>
<p><strong>Q: Can two fragments share the same view model?</strong></p>
<p><strong>A:</strong> If you have two fragments in an activity that need to communicate with each other, you might want to add a single view model to the activity that the two fragments then have access to. You can find out more about this here:</p>
<p><em><a href="https://developer.android.com/topic/libraries/architecture/viewmodel">https://developer.android.com/topic/libraries/architecture/viewmodel</a></em></p>
</div></aside>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What happens when the app runs"><div class="sect1" id="what_happens_when_the_app_runs-id00173">
<h1>What happens when the app runs</h1>
<p>The following things happen when the app runs:</p>
<ol>
<li><p><strong>GameFragment asks the ViewModelProvider class for an instance of GameViewModel.</strong></p>
<p>The <code>GameViewModel</code> object is initialized, and chooses a word at random.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0476-02.png" alt="image" width="600" height="98"/>
<h6/>
</div></figure></li>
<li><p><strong>GameFragment interacts with the GameViewModel object.</strong></p>
<p>The <code>GameViewModel</code> object records any guesses the user has made, and keeps track of the number of lives left.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0476-03.png" alt="image" width="600" height="139"/>
<h6/>
</div></figure></li>
<li><p><strong>After each guess, GameFragment checks if the view model’s isWon() or isLost() methods return true.</strong></p>
<p>If either method is <em>true</em>, <code>GameFragment</code> navigates to <code>ResultFragment</code>, passing it the result.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0476-04.png" alt="image" width="600" height="232"/>
<h6/>
</div></figure></li>
<li><p><strong>ResultFragment creates a ResultViewModelFactory object, passing it the result String.</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0477-02.png" alt="image" width="518" height="156"/>
<h6/>
</div></figure></li>
<li><p><strong>ResultFragment asks the ViewModelProvider class for an instance of ResultViewModel.</strong></p>
<p>The <code>ViewModelProvider</code> class sees that there’s no existing <code>ResultViewModel</code> object, so it uses the <code>ResultViewModelFactory</code> to create one. The <code>ResultViewModel</code> object’s <code>result</code> property is initialized with the result <code>String</code>.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0477-03.png" alt="image" width="600" height="195"/>
<h6/>
</div></figure></li>
<li><p><strong>ResultFragment gets the result String from the ResultViewModel object, and displays it on the screen.</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0477-04.png" alt="image" width="600" height="279"/>
<h6/>
</div></figure></li>
</ol>
<p>Let’s take the app for a test drive.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark=" Test Drive"><div class="sect1" id="test_drive-id00174">
<h1><span class="inlineimage"><img src="Images/car.png" alt="Images" width="119" height="58"/></span> Test Drive</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0478-01.png" alt="image" width="284" height="86"/>
<h6/>
</div></figure>
<p>When we run the app, <code>GameFragment</code> is displayed as before.</p>
<p>If we guess all the letters or lose all our lives, the app navigates to <code>ResultFragment</code>. A message is displayed telling us whether we won or lost, and what the secret word was.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0478-02.png" alt="image" width="600" height="548"/>
<h6/>
</div></figure>
<p>The game behaves in the same way as it did before, but behind the scenes, it’s now using view models for its game logic and data.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="View Model Magnets"><div class="sect1" id="view_model_magnets">
<h1>View Model Magnets</h1>
<figure class="informal"><div class="figure">
<img src="Images/common02.png" alt="image" width="86" height="144"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="exercises" data-secondary="Magnets" id="idm46053737309056"/>Here’s the code to define a view model named <code>GiftViewModel</code>:</p>
<pre data-type="programlisting">import androidx.lifecycle.ViewModel

class GiftViewModel(budgetFrom: Int, budgetTo: Int) : ViewModel(){
    val from = budgetFrom
    val to = budgetTo
}</pre>
<p>See if you can piece together the code for the view model factory class that will be used to create <code>GiftViewModel</code> objects.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0479-01.png" alt="image" width="600" height="465"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="View Model Magnets Solution"><div class="sect1" id="view_model_magnets_solution">
<h1>View Model Magnets Solution</h1>
<figure class="informal"><div class="figure">
<img src="Images/common02.png" alt="image" width="86" height="144"/>
<h6/>
</div></figure>
<p>Here’s the code to define a view model named <code>GiftViewModel</code>:</p>
<pre data-type="programlisting">import androidx.lifecycle.ViewModel

class GiftViewModel(budgetFrom: Int, budgetTo: Int) : ViewModel(){
    val from = budgetFrom
    val to = budgetTo
}</pre>
<p>See if you can piece together the code for the view model factory class that will be used to create <code>GiftViewModel</code> objects.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0480-01.png" alt="image" width="600" height="315"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img src="Images/f0480-02.png" alt="image" width="600" height="125"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="BE the View Model Solution"><div class="sect1" id="be_the_view_model_solution">
<h1>BE the View Model Solution</h1>
<figure class="informal"><div class="figure">
<img src="Images/common04.png" alt="image" width="156" height="199"/>
<h6/>
</div></figure>
<p><strong>The code below describes a view model class named MyViewModel. Your job is to play like you’re the view model, and say what problems there are with this code and how they could be fixed.</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0481-01.png" alt="image" width="600" height="552"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Your Android Toolbox"><div class="sect1" id="your_android_toolbox-id00175">
<h1>Your Android Toolbox</h1>
<figure class="informal"><div class="figure">
<img src="Images/tools.png" alt="image" width="182" height="129"/>
<h6/>
</div></figure>
<p><strong>You’ve got <a data-type="xref" href="#view_modelscolon_model_behavior">Chapter 11</a> under your belt and now you’ve added view models to your toolbox.</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0482-01.png" alt="image" width="233" height="211"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="bullet_points-id00176">
<h5>Bullet Points</h5>
<ul>
<li><p>A view model simplifies your activity or fragment code by separating out any code relating to its business logic and data.</p></li>
<li><p>View models can survive configuration changes.</p></li>
<li><p>A view model is usually associated with a single UI controller.</p></li>
<li><p>The view model extends the class <code>androidx.lifecycle.ViewModel</code>.</p></li>
<li><p>Create a view model by calling the <code>ViewModelProvider</code> class <code>get()</code> method. This ensures that a view model is only created where one doesn’t already exist.</p></li>
<li><p>A view model stays alive until its UI controller permanently goes away. This is when the activity is finished, or the fragment is removed from its activity.</p></li>
<li><p>If a view model’s constructor requires arguments, you need to write an additional factory class for it. The <code>ViewModelProvider</code> class uses the factory each time it needs to create an instance of the view model.</p></li>
<li><p>The view model factory class must implement an interface named <code>ViewModelProvider.Factory</code>.</p></li>
</ul>
</div></aside>
</div></section>
</div></section></div></body></html>