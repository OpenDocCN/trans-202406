<html><head></head><body><section data-pdf-bookmark="Chapter 21. Implementing an Operator" data-type="chapter" epub:type="chapter"><div class="chapter" id="implementing_an_operator">&#13;
<h1><span class="label">Chapter 21. </span>Implementing an Operator</h1>&#13;
&#13;
&#13;
<p>A key tenet of Kubernetes is its ability to be extended beyond the core API by the operators of the system. Many (these authors included) believe this extensibility was a driving factor in the dominance of Kubernetes in the marketplace. As developers began to create applications that would run on Kubernetes, operators developed helper applications that knew how to call the Kubernetes API and automate much of the routine work they would need to do to keep the applications stable. Many of these applications were bash scripts or helper containers running in a cluster.</p>&#13;
&#13;
<p>In 2016, a <a data-primary="Operators" data-secondary="purpose of" data-type="indexterm" id="id1165"/>key group of Kubernetes contributors, led by CoreOS (now Red Hat), positioned an Operator pattern to allow for easier development and implementation of Kubernetes applications. The Operator pattern outlined a way to package, deploy, and maintain an application that is integrated with the Kubernetes API and client tooling such as <code>kubectl</code>. Using an Operator, an application developer could natively create an application that could run in Kubernetes, be integrated with the existing Kubernetes process, and embed institutional knowledge. This knowledge wasn’t limited to deploying the application but also allowed for smooth upgrades, reconciliation across disparate services, custom scaling processes, and embedding observability into the complex system, which drove the acceptance of the framework into the Kubernetes ecosystem.</p>&#13;
&#13;
<p>The goal of this chapter is not to teach you how to write an Operator. Numerous resources are available on this topic and have much more in-depth coverage than what can be covered in a single chapter. The goal here is to introduce the concept and explain when and why to implement an Operator into your environment while sharing some of the key considerations you will need to plan.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Operator Key Components" data-type="sect1"><div class="sect1" id="id270">&#13;
<h1>Operator Key Components</h1>&#13;
&#13;
<p>The <a href="https://oreil.ly/YG0gU">Operator Framework</a> itself is <a data-primary="Operators" data-secondary="components of" data-type="indexterm" id="operator-component"/>an open source toolkit with a well-defined software development kit (SDK), life-cycle management, and publication tooling. A few projects out there have been built around the concept of the Operator pattern and making it easier for the community to develop. The members of the API Machinery SIG in the Kubernetes community sponsored the development of kubebuilder to offer a base SDK for working with the two main components of an Operator: Custom Resource Definitions (CRDs) and controllers. Sponsored by Google as part of the community, kubebuilder is being positioned as the base SDK for all operators and other projects such as KUDO, KubeOps, and Kopf. Examples in this chapter will be based on kubebuilder syntax where specific code is discussed; however, the concepts are very similar in many of the Operator SDKs out there.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Custom Resource Definitions" data-type="sect1"><div class="sect1" id="id271">&#13;
<h1>Custom Resource Definitions</h1>&#13;
&#13;
<p>Often the <a data-primary="CRDs (custom resource definitions)" data-secondary="Operators and" data-type="indexterm" id="id1166"/>need to define complex application dependencies and resources using only native Kubernetes resources becomes challenging in actual practice. The platform engineers usually have to build complex yaml templates, with rendering pipelines and additional resources like jobs and init containers to manage much of the customization needed to run a large application. However, the Custom Resource Definition allows developers to extend the Kubernetes API to provide new resource types that can then better represent declaratively the resource needs of an application.</p>&#13;
&#13;
<p>Kubernetes allows for the dynamic registration of new resources using the <code>Custom​Re⁠sourceDefinition</code> interface and will automatically register a new RESTful resource path for the versions you specify. Unlike many of the resources that are built into Kubernetes natively, CRDs can be maintained independently and updated when needed. CRDs will define a specification of the resource under the <code>spec</code> field and will have a <code>spec.scope</code> defining if the custom resources that are created from the CRD will be namespaced or cluster-wide resources. Before we see a CRD and its custom resource implementation, a small diversion into nomenclature of the Kubernetes API is important.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubernetes API objects, resources, version, group, and kind" data-type="sect3"><div class="sect3" id="id175">&#13;
<h3>Kubernetes API objects, resources, version, group, and kind</h3>&#13;
&#13;
<p>Objects in <a data-primary="objects (Kubernetes)" data-type="indexterm" id="id1167"/>Kubernetes are the actual entities that are persisted in the system to represent the state of the cluster. The object itself is what the typical CRUD operations act on within a cluster. In essence an object will be the entire resource definition in state such as a pod or PersistentVolume.</p>&#13;
&#13;
<p class="pagebreak-before">A Kubernetes resource<a data-primary="resources" data-secondary="purpose of" data-type="indexterm" id="id1168"/> is an endpoint in the API that represents a collection of objects of a specific kind. So a pod resource will contain a collection of Pod objects. One can see this in the cluster easily with:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">kubectl<code class="w"> </code>api-versions<code class="w"/>&#13;
NAME<code class="w">              </code>SHORTNAMES<code class="w">  </code>APIVERSION<code class="w">                </code>NAMESPACED<code class="w">  </code>KIND<code class="w"/>&#13;
bindings<code class="w">                      </code>v1<code class="w">                        </code><code class="nb">true</code><code class="w">        </code>Binding<code class="w"/>&#13;
componentstatu...<code class="w"> </code>cs<code class="w">          </code>v1<code class="w">                        </code><code class="nb">false</code><code class="w">       </code>ComponentS...<code class="w"/>&#13;
configmaps<code class="w">        </code>cm<code class="w">          </code>v1<code class="w">                        </code><code class="nb">true</code><code class="w">        </code>ConfigMap<code class="w"/>&#13;
edited<code class="w"> </code><code class="k">for</code><code class="w"> </code>space<code class="w"/>&#13;
mutatingwebhoo...<code class="w">             </code>admissionregistration...<code class="w">  </code><code class="nb">false</code><code class="w">       </code>MutatingWe...<code class="w"/>&#13;
validatingwebh...<code class="w">             </code>admissionregistration...<code class="w">  </code><code class="nb">false</code><code class="w">       </code>Validating...<code class="w"/>&#13;
customresource...<code class="w"> </code>crd,crds<code class="w">    </code>apiextensions.k8s.io/...<code class="w">  </code><code class="nb">false</code><code class="w">       </code>CustomReso...<code class="w"/>&#13;
apiservices<code class="w">                   </code>apiregistration.k8s.i...<code class="w">  </code><code class="nb">false</code><code class="w">       </code>APIService<code class="w"/>&#13;
controllerrevi...<code class="w">             </code>apps/v1<code class="w">                   </code><code class="nb">true</code><code class="w">        </code>Controller...<code class="w"/>&#13;
daemonsets<code class="w">        </code>ds<code class="w">          </code>apps/v1<code class="w">                   </code><code class="nb">true</code><code class="w">        </code>DaemonSet<code class="w"/>&#13;
deployments<code class="w">       </code>deploy<code class="w">      </code>apps/v1<code class="w">                   </code><code class="nb">true</code><code class="w">        </code>Deployment<code class="w"/>&#13;
replicasets<code class="w">       </code>rs<code class="w">          </code>apps/v1<code class="w">                   </code><code class="nb">true</code><code class="w">        </code>ReplicaSet<code class="w"/>&#13;
statefulsets<code class="w">      </code>sts<code class="w">         </code>apps/v1<code class="w">                   </code><code class="nb">true</code><code class="w">        </code>StatefulSet<code class="w"/></pre>&#13;
&#13;
<p>Groups bring<a data-primary="groups" data-type="indexterm" id="id1169"/> objects of similar concern together. This grouping combined with versioning allows for objects within the same group to be managed individually and updated as needed. The group is represented in the RESTful path in the <code>apiVersion</code> field of the object. In Kubernetes the core group (also described as legacy) will fall under the <em>/api/REST</em> path. Often seen in a Pod spec or Deployment yaml in the <code>apiVersion</code> field with the base path removed as such:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w"/>&#13;
<code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">sample</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"/></pre>&#13;
&#13;
<p>As with <a data-primary="versioning" data-type="indexterm" id="id1170"/>any good API, Kubernetes APIs are versioned and support multiple versions using different API paths. There are guidelines for Kubernetes versioning and the same guidelines should be used when versioning Custom Resources. APIs can also fall into different levels based on support or stability of the API, so often you will see Alpha, Beta, or Stable APIs. In a cluster, for example, you may have <code>v1</code> and <code>v1beta1</code> for the same group:</p>&#13;
&#13;
<pre data-code-language="sh" data-type="programlisting">kubectl<code class="w"> </code>api-versions<code class="w"/>&#13;
----<code class="w"> </code>excerpt<code class="w"/>&#13;
autoscaling/v1<code class="w"/>&#13;
autoscaling/v2<code class="w"/>&#13;
autoscaling/v2beta1<code class="w"/>&#13;
autoscaling/v2beta2<code class="w"/></pre>&#13;
&#13;
<p class="pagebreak-before">Often, Kind and Resource are <a data-primary="resources" data-secondary="Kinds versus" data-type="indexterm" id="id1171"/><a data-primary="Kinds" data-type="indexterm" id="id1172"/>used as the same context; however, a resource is a concrete implementation of a Kind. Often there is a direct Kind to Resource relationship such as when defining a <code>kind: Pod</code> specification that will create a pod resource in the cluster. On occasion there is a one to many relationship such as the <code>Scale</code> kind, which can be returned by different resources such as <code>Deployment</code> or <code>ReplicaSet</code>. This is known as a subresource.</p>&#13;
&#13;
<p>Putting these principles together we can begin to model our API for our customer resource. For the rest of this chapter, kubebuilder-generated snippets will be used, but the actual code is not important and will be only a partial representation. The concept discussed is what the focus will be and how it relates to best practices when implementing <a data-primary="Operators" data-secondary="components of" data-startref="operator-component" data-type="indexterm" id="id1173"/>an Operator.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating Our API" data-type="sect1"><div class="sect1" id="id176">&#13;
<h1>Creating Our API</h1>&#13;
&#13;
<p>A Customer Resource Definition can <a data-primary="Operators" data-secondary="API creation" data-type="indexterm" id="operator-api-create"/><a data-primary="APIs (application programming interfaces), creating" data-type="indexterm" id="api-create"/>be created in yaml by hand; however, kubebuilder and other Operator SDKs will automatically generate the API definition for you based on the code provided. In kubebuilder you can create a scaffold of the API and the required Go code after your project is initialized. To initialize a project, once kubebuilder and its prerequisites are met, you can simply run an <code>init</code> command from a new directory that will contain your project files:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">$<code class="w"> </code>kubebuilder<code class="w"> </code>init<code class="w"> </code>--domain<code class="w"> </code>platform.evillgenius.com<code class="w"/>&#13;
<code class="w">    </code>--repo<code class="w"> </code>platform.evillgenius.com/platformapp<code class="w"> </code>--project-name<code class="o">=</code>pe-app<code class="w"/>&#13;
Writing<code class="w"> </code>kustomize<code class="w"> </code>manifests<code class="w"> </code><code class="k">for</code><code class="w"> </code>you<code class="w"> </code>to<code class="w"> </code>edit...<code class="w"/>&#13;
Writing<code class="w"> </code>scaffold<code class="w"> </code><code class="k">for</code><code class="w"> </code>you<code class="w"> </code>to<code class="w"> </code>edit...<code class="w"/>&#13;
Get<code class="w"> </code>controller<code class="w"> </code>runtime:<code class="w"/>&#13;
$<code class="w"> </code>go<code class="w"> </code>get<code class="w"> </code>sigs.k8s.io/controller-runtime@v0.14.1<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>sigs.k8s.io/controller-runtime<code class="w"> </code>v0.14.1<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>k8s.io/apimachinery<code class="w"> </code>v0.26.0<code class="w"/>&#13;
.......................................................<code class="w"> </code>removed<code class="w"> </code><code class="k">for</code><code class="w"> </code>brevity<code class="w"> </code>...<code class="w"/>&#13;
Update<code class="w"> </code>dependencies:<code class="w"/>&#13;
$<code class="w"> </code>go<code class="w"> </code>mod<code class="w"> </code>tidy<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>github.com/go-logr/zapr<code class="w"> </code>v1.2.3<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>go.uber.org/zap<code class="w"> </code>v1.24.0<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>github.com/onsi/ginkgo/v2<code class="w"> </code>v2.6.0<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>github.com/onsi/gomega<code class="w"> </code>v1.24.1<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>gopkg.in/check.v1<code class="w"> </code>v1.0.0-20200227125254-8fa46927fb4f<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>github.com/niemeyer/pretty<code class="w"> </code>v0.0.0-20200227124842-a10e7caefd8e<code class="w"/>&#13;
Next:<code class="w"> </code>define<code class="w"> </code>a<code class="w"> </code>resource<code class="w"> </code>with:<code class="w"/>&#13;
$<code class="w"> </code>kubebuilder<code class="w"> </code>create<code class="w"> </code>api<code class="w"/></pre>&#13;
&#13;
<p>This will create some basic files and placeholder boilerplate code:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">$<code class="w"> </code>tree<code class="w"/>&#13;
.<code class="w"/>&#13;
├──<code class="w"> </code>config<code class="w"/>&#13;
│<code class="w">   </code>├──<code class="w"> </code>default<code class="w"/>&#13;
│<code class="w">   </code>│<code class="w">   </code>├──<code class="w"> </code>kustomization.yaml<code class="w"/>&#13;
│<code class="w">   </code>│<code class="w">   </code>├──<code class="w"> </code>manager_auth_proxy_patch.yaml<code class="w"/>&#13;
│<code class="w">   </code>│<code class="w">   </code>└──<code class="w"> </code>manager_config_patch.yaml<code class="w"/>&#13;
│<code class="w">   </code>├──<code class="w"> </code>manager<code class="w"/>&#13;
│<code class="w">   </code>│<code class="w">   </code>├──<code class="w"> </code>kustomization.yaml<code class="w"/>&#13;
│<code class="w">   </code>│<code class="w">   </code>└──<code class="w"> </code>manager.yaml<code class="w"/>&#13;
│<code class="w">   </code>├──<code class="w"> </code>prometheus<code class="w"/>&#13;
│<code class="w">   </code>│<code class="w">   </code>├──<code class="w"> </code>kustomization.yaml<code class="w"/>&#13;
│<code class="w">   </code>│<code class="w">   </code>└──<code class="w"> </code>monitor.yaml<code class="w"/>&#13;
│<code class="w">   </code>└──<code class="w"> </code>rbac<code class="w"/>&#13;
│<code class="w">       </code>├──<code class="w"> </code>auth_proxy_client_clusterrole.yaml<code class="w"/>&#13;
│<code class="w">       </code>├──<code class="w"> </code>auth_proxy_role_binding.yaml<code class="w"/>&#13;
│<code class="w">       </code>├──<code class="w"> </code>auth_proxy_role.yaml<code class="w"/>&#13;
│<code class="w">       </code>├──<code class="w"> </code>auth_proxy_service.yaml<code class="w"/>&#13;
│<code class="w">       </code>├──<code class="w"> </code>kustomization.yaml<code class="w"/>&#13;
│<code class="w">       </code>├──<code class="w"> </code>leader_election_role_binding.yaml<code class="w"/>&#13;
│<code class="w">       </code>├──<code class="w"> </code>leader_election_role.yaml<code class="w"/>&#13;
│<code class="w">       </code>├──<code class="w"> </code>role_binding.yaml<code class="w"/>&#13;
│<code class="w">       </code>└──<code class="w"> </code>service_account.yaml<code class="w"/>&#13;
├──<code class="w"> </code>Dockerfile<code class="w"/>&#13;
├──<code class="w"> </code>go.mod<code class="w"/>&#13;
├──<code class="w"> </code>go.sum<code class="w"/>&#13;
├──<code class="w"> </code>hack<code class="w"/>&#13;
│<code class="w">   </code>└──<code class="w"> </code>boilerplate.go.txt<code class="w"/>&#13;
├──<code class="w"> </code>main.go<code class="w"/>&#13;
├──<code class="w"> </code>Makefile<code class="w"/>&#13;
├──<code class="w"> </code>PROJECT<code class="w"/>&#13;
└──<code class="w"> </code>README.md<code class="w"/></pre>&#13;
&#13;
<p>Once that is completed you can create the scaffold for the API definition by running the following:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">$<code class="w"> </code>kubebuilder<code class="w"> </code>create<code class="w"> </code>api<code class="w"> </code>--group<code class="w"> </code>egplatform<code class="w"> </code>--version<code class="w"> </code>v1alpha1<code class="w"> </code>--kind<code class="w"> </code>EGApp<code class="w"/>&#13;
Create<code class="w"> </code>Resource<code class="w"> </code><code class="o">[</code>y/n<code class="o">]</code><code class="w"/>&#13;
y<code class="w"/>&#13;
Create<code class="w"> </code>Controller<code class="w"> </code><code class="o">[</code>y/n<code class="o">]</code><code class="w"/>&#13;
y<code class="w"/>&#13;
Writing<code class="w"> </code>kustomize<code class="w"> </code>manifests<code class="w"> </code><code class="k">for</code><code class="w"> </code>you<code class="w"> </code>to<code class="w"> </code>edit...<code class="w"/>&#13;
Writing<code class="w"> </code>scaffold<code class="w"> </code><code class="k">for</code><code class="w"> </code>you<code class="w"> </code>to<code class="w"> </code>edit...<code class="w"/>&#13;
api/v1alpha1/egapp_types.go<code class="w"/>&#13;
controllers/egapp_controller.go<code class="w"/>&#13;
Update<code class="w"> </code>dependencies:<code class="w"/>&#13;
$<code class="w"> </code>go<code class="w"> </code>mod<code class="w"> </code>tidy<code class="w"/>&#13;
Running<code class="w"> </code>make:<code class="w"/>&#13;
$<code class="w"> </code>make<code class="w"> </code>generate<code class="w"/>&#13;
mkdir<code class="w"> </code>-p<code class="w"> </code>/home/eddiejv/dev/projects/operators/platformapp/bin<code class="w"/>&#13;
<code class="nb">test</code><code class="w"> </code>-s<code class="w"> </code>/home/eddiejv/dev/projects/operators/platformapp/bin/controller-gen<code class="w"/>&#13;
<code class="w">  </code><code class="o">&amp;&amp;</code><code class="w"> </code>/home/eddiejv/dev/projects/operators/platformapp/bin/controller-gen<code class="w"/>&#13;
<code class="w">  </code>--version<code class="w"> </code><code class="p">|</code><code class="w"> </code>grep<code class="w"> </code>-q<code class="w"> </code>v0.11.1<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="nv">GOBIN</code><code class="o">=</code>/home/eddiejv/dev/projects/operators/platformapp/bin<code class="w"/>&#13;
<code class="w">  </code>go<code class="w"> </code>install<code class="w"> </code>sigs.k8s.io/controller-tools/cmd/controller-gen@v0.11.1<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>sigs.k8s.io/controller-tools<code class="w"> </code>v0.11.1<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>github.com/spf13/cobra<code class="w"> </code>v1.6.1<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>github.com/gobuffalo/flect<code class="w"> </code>v0.3.0<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>golang.org/x/tools<code class="w"> </code>v0.4.0<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>k8s.io/utils<code class="w"> </code>v0.0.0-20221107191617-1a15be271d1d<code class="w"/>&#13;
go:<code class="w"> </code>downloading<code class="w"> </code>github.com/mattn/go-colorable<code class="w"> </code>v0.1.9<code class="w"/>&#13;
/home/eddiejv/dev/projects/operators/platformapp/bin/controller-gen<code class="w"/>&#13;
<code class="w">  </code>object:headerFile<code class="o">=</code><code class="s2">"hack/boilerplate.go.txt"</code><code class="w"> </code><code class="nv">paths</code><code class="o">=</code><code class="s2">"./..."</code><code class="w"/>&#13;
Next:<code class="w"> </code>implement<code class="w"> </code>your<code class="w"> </code>new<code class="w"> </code>API<code class="w"> </code>and<code class="w"> </code>generate<code class="w"> </code>the<code class="w"> </code>manifests<code class="w"> </code><code class="o">(</code>e.g.<code class="w"> </code>CRDs,CRs<code class="o">)</code><code class="w"> </code>with:<code class="w"/>&#13;
$<code class="w"> </code>make<code class="w"> </code>manifests<code class="w"/></pre>&#13;
&#13;
<p>This will add an API, bin, and controllers directories and update other directories with more boilerplate code. The two main files to work with are the <em>api/&lt;version&gt;/&lt;kind&gt;_types.go</em> and <em>controllers/&lt;kind&gt;_controller.go</em> files.</p>&#13;
&#13;
<p>To start modifying your API to map to the resources you want expressed in your CRD, you will add new fields to the struct created for your new object in the <em>api/&lt;version&gt;/&lt;kind&gt;_types.go</em> file. So for our example here we add the following:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code><code class="w"> </code><code class="nx">EGAppSpec</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Important: Run "make" to regenerate code after modifying this file</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// Foo is an example field of EGApp. Edit egapp_types.go to remove/update</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">Foo</code><code class="w"> </code><code class="kt">string</code><code class="w"> </code><code class="s">`json:"foo,omitempty"`</code><code class="w"/>&#13;
&#13;
<code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="c1">// EGAppStatus defines the observed state of EGApp</code><code class="w"/>&#13;
<code class="c1">// +kubebuilder:subresource:status</code><code class="w"/>&#13;
<code class="kd">type</code><code class="w"> </code><code class="nx">EGAppStatus</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Important: Run "make" to regenerate code after modifying this file</code><code class="w"/>&#13;
&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
<blockquote><div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>If you are not a Go programmer do not worry as there are other projects such as Java Operator SDK and Kopf that can help you build Operators in either Java or Python as well. The Operator Framework SDK also has support to create Operators from Ansible or Helm.</p>&#13;
</div></blockquote>&#13;
&#13;
<p>To continue with the example, we want to add specific fields to the spec and also have a status. To update specification the information can be added as such:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">type</code><code class="w"> </code><code class="nx">EGAppSpec</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Important: Run "make" to regenerate code after modifying this file</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// AppId is the unique AppId match to internal catalog systems</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">AppId</code><code class="w"> </code><code class="kt">string</code><code class="w"> </code><code class="s">`json:"appId,omitempty"`</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// +kubebuilder:validation:Enum=java;python;go</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">Framework</code><code class="w"> </code><code class="kt">string</code><code class="w"> </code><code class="s">`json:"framework"`</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// +kubebuilder:validation:Optional</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// +kubebuilder:validation:Enum=lowMem;highMem;highCPU;balanced</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// +kubebuilder:default="lowMem"</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">InstanceType</code><code class="w"> </code><code class="kt">string</code><code class="w"> </code><code class="s">`json:"instanceType"`</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// +kubebuilder:validation:Enum=dev;stage;prod</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">Environment</code><code class="w"> </code><code class="kt">string</code><code class="w"> </code><code class="s">`json:"environment"`</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// +kubebuilder:validation:Optional</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// +kubebuilder:default:=1</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">ReplicaCount</code><code class="w"> </code><code class="kt">int32</code><code class="w"> </code><code class="s">`json:"replicaCount"`</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="c1">// EGAppStatus defines the observed state of EGApp</code><code class="w"/>&#13;
<code class="c1">// +kubebuilder:subresource:status</code><code class="w"/>&#13;
<code class="kd">type</code><code class="w"> </code><code class="nx">EGAppStatus</code><code class="w"> </code><code class="kd">struct</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Important: Run "make" to regenerate code after modifying this file</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="nx">Pods</code><code class="w"> </code><code class="p">[]</code><code class="kt">string</code><code class="w"> </code><code class="s">`json:"pods"`</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>What is of importance here is we mapped the information we need in the spec that defines the application into data types and gave them a JSON representation. The &#13;
<span class="keep-together"><code>// +kubebuilder:</code></span> lines that look like they are in comments are marker comments that kubebuilder uses to generate code based on the information provided. As an example, we are declaring to kubebuilder to generate all the needed code to ensure that the <code>Framework</code> field is validated against three possible strings of Java, Python, or Go. That is why it was noted at the end of the <code>kubebuilder create api</code> command that any changes made to the API require a <code>make generate</code> to update all the other generated code required and the <code>make manifests</code> to update all the yaml manifests’ boilerplate. This will then give you a starting CRD that looks something like this:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apiextensions.k8s.io/v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CustomResourceDefinition</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">controller-gen.kubebuilder.io/version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v0.11.1</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">creationTimestamp</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">null</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">egapps.egplatform.platform.evillgenius.com</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">group</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">egplatform.platform.evillgenius.com</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">names</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">EGApp</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">listKind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">EGAppList</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">plural</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">egapps</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">singular</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">egapp</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">scope</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Namespaced</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">versions</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1alpha1</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">schema</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">openAPIV3Schema</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">EGApp is the Schema for the egapps API</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">properties</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="s">'APIVersion</code><code class="nv"> </code><code class="s">defines</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">versioned</code><code class="nv"> </code><code class="s">schema</code><code class="nv"> </code><code class="s">of</code><code class="nv"> </code><code class="s">this</code><code class="w"/>&#13;
<code class="w">              </code><code class="s">representation</code><code class="nv"> </code><code class="s">of</code><code class="nv"> </code><code class="s">an</code><code class="nv"> </code><code class="s">object.</code><code class="nv"> </code><code class="s">Servers</code><code class="nv"> </code><code class="s">should</code><code class="nv"> </code><code class="s">convert</code><code class="nv"> </code><code class="s">recognized</code><code class="w"/>&#13;
<code class="w">              </code><code class="s">schemas</code><code class="nv"> </code><code class="s">to</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">latest</code><code class="nv"> </code><code class="s">internal</code><code class="nv"> </code><code class="s">value,</code><code class="nv"> </code><code class="s">and</code><code class="nv"> </code><code class="s">may</code><code class="nv"> </code><code class="s">reject</code><code class="nv"> </code><code class="s">unrecognized</code><code class="w"/>&#13;
<code class="w">              </code><code class="s">values.</code><code class="nv"> </code><code class="s">More</code><code class="nv"> </code><code class="s">info:</code><code class="nv"> </code><code class="s">https://git.k8s.io/community/contributors/</code><code class="w"/>&#13;
<code class="w">              </code><code class="s">devel/sig-architecture/api-conventions.md#resources'</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">kind</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="s">'Kind</code><code class="nv"> </code><code class="s">is</code><code class="nv"> </code><code class="s">a</code><code class="nv"> </code><code class="s">string</code><code class="nv"> </code><code class="s">value</code><code class="nv"> </code><code class="s">representing</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">REST</code><code class="nv"> </code><code class="s">resource</code><code class="w"/>&#13;
<code class="w">              </code><code class="s">this</code><code class="nv"> </code><code class="s">object</code><code class="nv"> </code><code class="s">represents.</code><code class="nv"> </code><code class="s">Servers</code><code class="nv"> </code><code class="s">may</code><code class="nv"> </code><code class="s">infer</code><code class="nv"> </code><code class="s">this</code><code class="nv"> </code><code class="s">from</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">endpoint</code><code class="w"/>&#13;
<code class="w">              </code><code class="s">the</code><code class="nv"> </code><code class="s">client</code><code class="nv"> </code><code class="s">submits</code><code class="nv"> </code><code class="s">requests</code><code class="nv"> </code><code class="s">to.</code><code class="nv"> </code><code class="s">Cannot</code><code class="nv"> </code><code class="s">be</code><code class="nv"> </code><code class="s">updated.</code><code class="nv"> </code><code class="s">In</code><code class="nv"> </code><code class="s">CamelCase.</code><code class="w"/>&#13;
<code class="w">              </code><code class="s">More</code><code class="nv"> </code><code class="s">info:</code><code class="nv"> </code><code class="s">https://git.k8s.io/community/contributors/devel/</code><code class="w"/>&#13;
<code class="w">              </code><code class="s">sig-architecture/api-conventions.md#types-kinds'</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">object</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">EGAppSpec defines the desired state of EGApp</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">properties</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">appId</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Foo is an example field of EGApp. Edit</code><code class="w"/>&#13;
<code class="w">                  </code><code class="l-Scalar-Plain">egapp_types.go to remove/update</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">environment</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">enum</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">                </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">dev</code><code class="w"/>&#13;
<code class="w">                </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">stage</code><code class="w"/>&#13;
<code class="w">                </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">prod</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">framework</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">enum</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">                </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">java</code><code class="w"/>&#13;
<code class="w">                </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">python</code><code class="w"/>&#13;
<code class="w">                </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">go</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">instanceType</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lowMem</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">enum</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">                </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">lowMem</code><code class="w"/>&#13;
<code class="w">                </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">highMem</code><code class="w"/>&#13;
<code class="w">                </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">highCPU</code><code class="w"/>&#13;
<code class="w">                </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">balanced</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">replicaCount</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">format</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">int32</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">integer</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">required</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">environment</code><code class="w"/>&#13;
<code class="w">            </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">framework</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">object</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">status</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">EGAppStatus defines the observed state of EGApp</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">properties</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">pods</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">items</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">                  </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">array</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">required</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">pods</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">object</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">object</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">served</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">storage</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">subresources</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">status</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/></pre>&#13;
&#13;
<p>You will notice that kubebuilder also added the OpenAPI validation information so the CR can be validated against the requirements of the CRD. Kubebuilder also allows for the creation of additional validators using logic via a webhook. To add admission webhooks for your CRD, by implementing the Defaulter and/or the Validator interface, kubebuilder provides code generation to create the webhook server and registers it with the controller manager. Using the kubebuilder CLI this can easily be generated in a scaffold again with:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">$<code class="w"> </code>kubebuilder<code class="w"> </code>create<code class="w"> </code>webhook<code class="w"> </code>--group<code class="w"> </code>egplatform<code class="w"> </code>--version<code class="w"> </code>v1alpha1<code class="w"> </code>--kind<code class="w"> </code>EGApp<code class="w"/>&#13;
<code class="w">    </code>--defaulting<code class="w"> </code>--programmatic-validation<code class="w"/></pre>&#13;
&#13;
<p>We can deploy this custom resource easily with kubebuilder:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">$<code class="w"> </code>make<code class="w"> </code>install<code class="w"/>&#13;
<code class="nb">test</code><code class="w"> </code>-s<code class="w"> </code>/home/eddiejv/dev/projects/operators/platformapp/bin/controller-gen<code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"/>&#13;
/home/eddiejv/dev/projects/operators/platformapp/bin/controller-gen<code class="w"> </code>--version<code class="w"> </code><code class="p">|</code><code class="w"/>&#13;
grep<code class="w"> </code>-q<code class="w"> </code>v0.11.1<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="nv">GOBIN</code><code class="o">=</code>/home/eddiejv/dev/projects/operators/platformapp/bin<code class="w"> </code>go<code class="w"> </code>install<code class="w"/>&#13;
sigs.k8s.io/controller-tools/cmd/controller-gen@v0.11.1/home/eddiejv/dev/<code class="w"/>&#13;
projects/operators/platformapp/bin/controller-gen<code class="w"> </code>rbac:roleName<code class="o">=</code>manager-role<code class="w"/>&#13;
crd<code class="w"> </code>webhook<code class="w"> </code><code class="nv">paths</code><code class="o">=</code><code class="s2">"./..."</code><code class="w"> </code>output:crd:artifacts:config<code class="o">=</code>config/crd/bases<code class="w"/>&#13;
/home/eddiejv/dev/projects/operators/platformapp/bin/kustomize<code class="w"> </code>build<code class="w"> </code>config/crd<code class="w"/>&#13;
<code class="p">|</code><code class="w"> </code>kubectl<code class="w"> </code>apply<code class="w"> </code>-f<code class="w"> </code>-<code class="w"/>&#13;
customresourcedefinition.apiextensions.k8s.io/<code class="w"/>&#13;
egapps.egplatform.platform.evillgenius.com<code class="w"> </code>created<code class="w"/></pre>&#13;
&#13;
<p>We can then see from the <code>kubectl</code> command that the egapp resource is now installed in the cluster, and we can see the structure of the resource itself:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">$<code class="w"> </code>kubectl<code class="w"> </code>explain<code class="w"> </code>egapp<code class="w"> </code>--recursive<code class="w"/>&#13;
KIND:<code class="w">     </code>EGApp<code class="w"/>&#13;
VERSION:<code class="w">  </code>egplatform.platform.evillgenius.com/v1alpha1<code class="w"/>&#13;
&#13;
DESCRIPTION:<code class="w"/>&#13;
<code class="w">     </code>EGApp<code class="w"> </code>is<code class="w"> </code>the<code class="w"> </code>Schema<code class="w"> </code><code class="k">for</code><code class="w"> </code>the<code class="w"> </code>egapps<code class="w"> </code>API<code class="w"/>&#13;
&#13;
FIELDS:<code class="w"/>&#13;
<code class="w">   </code>apiVersion<code class="w">   </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">   </code>kind<code class="w"> </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">   </code>metadata<code class="w">     </code>&lt;Object&gt;<code class="w"/>&#13;
<code class="w">      </code>annotations<code class="w">       </code>&lt;map<code class="o">[</code>string<code class="o">]</code>string&gt;<code class="w"/>&#13;
<code class="w">      </code>creationTimestamp<code class="w"> </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>deletionGracePeriodSeconds<code class="w">        </code>&lt;integer&gt;<code class="w"/>&#13;
<code class="w">      </code>deletionTimestamp<code class="w"> </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>finalizers<code class="w">        </code>&lt;<code class="o">[]</code>string&gt;<code class="w"/>&#13;
<code class="w">      </code>generateName<code class="w">      </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>generation<code class="w">        </code>&lt;integer&gt;<code class="w"/>&#13;
<code class="w">      </code>labels<code class="w">    </code>&lt;map<code class="o">[</code>string<code class="o">]</code>string&gt;<code class="w"/>&#13;
<code class="w">      </code>managedFields<code class="w">     </code>&lt;<code class="o">[]</code>Object&gt;<code class="w"/>&#13;
<code class="w">         </code>apiVersion<code class="w">     </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">         </code>fieldsType<code class="w">     </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">         </code>fieldsV1<code class="w">       </code>&lt;map<code class="o">[</code>string<code class="o">]</code>&gt;<code class="w"/>&#13;
<code class="w">         </code>manager<code class="w">        </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">         </code>operation<code class="w">      </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">         </code>subresource<code class="w">    </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">         </code><code class="nb">time</code><code class="w">   </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>name<code class="w">      </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>namespace<code class="w"> </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>ownerReferences<code class="w">   </code>&lt;<code class="o">[]</code>Object&gt;<code class="w"/>&#13;
<code class="w">         </code>apiVersion<code class="w">     </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">         </code>blockOwnerDeletion<code class="w">     </code>&lt;boolean&gt;<code class="w"/>&#13;
<code class="w">         </code>controller<code class="w">     </code>&lt;boolean&gt;<code class="w"/>&#13;
<code class="w">         </code>kind<code class="w">   </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">         </code>name<code class="w">   </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">         </code>uid<code class="w">    </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>resourceVersion<code class="w">   </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>selfLink<code class="w">  </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>uid<code class="w">       </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">   </code>spec<code class="w"> </code>&lt;Object&gt;<code class="w"/>&#13;
<code class="w">      </code>appId<code class="w">     </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>environment<code class="w">      </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>framework<code class="w"> </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>instanceType<code class="w">      </code>&lt;string&gt;<code class="w"/>&#13;
<code class="w">      </code>replicaCount<code class="w">      </code>&lt;integer&gt;<code class="w"/>&#13;
<code class="w">   </code>status<code class="w">       </code>&lt;Object&gt;<code class="w"/>&#13;
<code class="w">      </code>pods<code class="w">      </code>&lt;<code class="o">[]</code>string&gt;<code class="w"/></pre>&#13;
&#13;
<p>Now that the API has been created and installed in the cluster, it can’t really do anything. At this stage if we create a yaml and deploy it to the cluster in a namespace it will create an entry in etcd with the information stated in the yaml, but until we create the controller, nothing will happen. Now let’s explore how the controller<a data-primary="Operators" data-secondary="API creation" data-startref="operator-api-create" data-type="indexterm" id="id1174"/><a data-primary="APIs (application programming interfaces), creating" data-startref="api-create" data-type="indexterm" id="id1175"/> works.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Controller Reconciliation" data-type="sect1"><div class="sect1" id="id177">&#13;
<h1>Controller Reconciliation</h1>&#13;
&#13;
<p>The controller code<a data-primary="Operators" data-secondary="controller reconciliation" data-type="indexterm" id="operator-controller-reconcile"/><a data-primary="controller reconciliation" data-type="indexterm" id="controller-reconcile"/><a data-primary="reconciliation" data-type="indexterm" id="reconcile"/> was created when the API was created and will have much of the boilerplate needed to start building the reconciliation logic needed. Note that the code is not important here, but the understanding of what is happening behind the scenes is key to understanding what an Operator can do. The controller code is located in the <em>controllers/&lt;kind&gt;_controller.go</em> file. The <code>Reconcile</code> method is where the logic should be added. Before we dive into that, a plan for reconciliation and understanding the phases is required. This is shown in <a data-type="xref" href="#operator_overview">Figure 21-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="operator_overview">&#13;
<img alt="Operator Overview" src="assets/kbp2_2101.png"/>&#13;
<h6><span class="label">Figure 21-1. </span>Operator overview</h6>&#13;
</div></figure>&#13;
&#13;
<p>Operators are services that watch for events related to the resource types the operator cares about. When an event occurs that meets the criteria, called a predicate in the Operator pattern, the Operator begins the process of reconciling the desired state to the running state. During the reconciliation process, any logic to determine how to handle the state change is implemented; regardless of what exactly changed, the reconcile cycle handles it all. This is known as level-based triggering, and while less efficient, it is well-suited for complex distributed system like Kubernetes.</p>&#13;
&#13;
<p>In the Operator, developers will code into the <code>Reconcile</code> method the logic represented in <a data-type="xref" href="#reconciliation_logic">Figure 21-2</a>:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Is there an instance of the Custom Resource?</p>&#13;
</li>&#13;
<li>&#13;
<p>If so, do some validation.</p>&#13;
</li>&#13;
<li>&#13;
<p>If valid, check to see if state needs to be changed and change it.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>If the resource is being deleted, the logic to handle cleanup is also implemented here.</p>&#13;
&#13;
<p>If your CR implements other resources that it does not directly own, you should implement a <code>Finalizer</code> to handle the cleanup of those sources and block the deletion of the CR until the finalizer completes its process. This is often used for CRs that will create resources on a cloud provider, for example, or PersistentVolumes as they may have some reclaim policy defined that needs to be honored before the PV is considered<a data-primary="Operators" data-secondary="controller reconciliation" data-startref="operator-controller-reconcile" data-type="indexterm" id="id1176"/><a data-primary="controller reconciliation" data-startref="controller-reconcile" data-type="indexterm" id="id1177"/><a data-primary="reconciliation" data-startref="reconcile" data-type="indexterm" id="id1178"/> deleted.</p>&#13;
&#13;
<figure><div class="figure" id="reconciliation_logic">&#13;
<img alt="Reconciliation Logic" src="assets/kbp2_2102.png"/>&#13;
<h6><span class="label">Figure 21-2. </span>Reconciliation logic</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Resource Validation" data-type="sect1"><div class="sect1" id="id178">&#13;
<h1>Resource Validation</h1>&#13;
&#13;
<p>An important <a data-primary="Operators" data-secondary="resource validation" data-type="indexterm" id="id1179"/><a data-primary="resources" data-secondary="validating" data-type="indexterm" id="id1180"/><a data-primary="validating resources" data-type="indexterm" id="id1181"/>aspect of designing an efficient Operator is the validation of the resources being requested. As mentioned there are a few ways to validate the resource against the API specification; however, it is important to build redundancies into the process to ensure consistent behavior. The first layer of validation should be the OpenAPI validation defined in the CRD specification. This validation will prevent the CR from ever making it to the etcd server as a resource and causing detrimental aftereffects. The second layer of validation should be a validating admission controller implementation that will check the resource against the API specification through a webhook request. This again prevents the resource from ever making it into the API server. Adding some validation logic in the reconciliation loop code is also a valid strategy, but it is important to understand that it will be validation against an already existing resource in the cluster state, and therefore proper error handling needs to take place. Often this is implemented as an <code>IsValid</code> method that calls the same validation logic that the Validating Webhook implementation has.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Controller Implementation" data-type="sect1"><div class="sect1" id="id179">&#13;
<h1>Controller Implementation</h1>&#13;
&#13;
<p>If we <a data-primary="Operators" data-secondary="controller implementation" data-type="indexterm" id="operator-controller-implement"/><a data-primary="controller implementation" data-type="indexterm" id="controller-implement"/>continue with the example used so far, the logic for our controller will be in the following code:</p>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// +kubebuilder:rbac:groups=egplatform.platform.evillgenius.com,</code><code class="w"/>&#13;
<code class="w">  </code><code class="nx">resources</code><code class="p">=</code><code class="nx">egapps</code><code class="p">,</code><code class="nx">verbs</code><code class="p">=</code><code class="nx">get</code><code class="p">;</code><code class="nx">list</code><code class="p">;</code><code class="nx">watch</code><code class="p">;</code><code class="nx">create</code><code class="p">;</code><code class="nx">update</code><code class="p">;</code><code class="nx">patch</code><code class="p">;</code><code class="nx">delete</code><code class="w"/>&#13;
<code class="c1">// +kubebuilder:rbac:groups=egplatform.platform.evillgenius.com,</code><code class="w"/>&#13;
<code class="w">  </code><code class="nx">resources</code><code class="p">=</code><code class="nx">egapps</code><code class="o">/</code><code class="nx">status</code><code class="p">,</code><code class="nx">verbs</code><code class="p">=</code><code class="nx">get</code><code class="p">;</code><code class="nx">update</code><code class="p">;</code><code class="nx">patch</code><code class="w"/>&#13;
<code class="c1">// +kubebuilder:rbac:groups=egplatform.platform.evillgenius.com,</code><code class="w"/>&#13;
<code class="w">  </code><code class="nx">resources</code><code class="p">=</code><code class="nx">egapps</code><code class="o">/</code><code class="nx">finalizers</code><code class="p">,</code><code class="nx">verbs</code><code class="p">=</code><code class="nx">update</code><code class="w"/>&#13;
&#13;
<code class="c1">// Reconcile is part of the main Kubernetes reconciliation loop which aims to</code><code class="w"/>&#13;
<code class="c1">// move the current state of the cluster closer to the desired state.</code><code class="w"/>&#13;
<code class="c1">// TODO(user): Modify the Reconcile function to compare the state specified by</code><code class="w"/>&#13;
<code class="c1">// the EGApp object against the actual cluster state, and then</code><code class="w"/>&#13;
<code class="c1">// perform operations to make the cluster state reflect the state specified by</code><code class="w"/>&#13;
<code class="c1">// the user.</code><code class="w"/>&#13;
<code class="c1">//</code><code class="w"/>&#13;
<code class="c1">// For more details, check Reconcile and its Result here:</code><code class="w"/>&#13;
<code class="c1">// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.14.1/pkg/reconcile</code><code class="w"/>&#13;
<code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">r</code><code class="w"> </code><code class="o">*</code><code class="nx">EGAppReconciler</code><code class="p">)</code><code class="w"> </code><code class="nx">Reconcile</code><code class="p">(</code><code class="nx">ctx</code><code class="w"> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code class="w"> </code><code class="nx">req</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">(</code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">,</code><code class="w"> </code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">_</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">log</code><code class="p">.</code><code class="nx">FromContext</code><code class="p">(</code><code class="nx">ctx</code><code class="p">)</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// TODO(user): your logic here</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">logger</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">log</code><code class="p">.</code><code class="nx">Log</code><code class="p">.</code><code class="nx">WithValues</code><code class="p">(</code><code class="s">"EGApp"</code><code class="p">,</code><code class="w"> </code><code class="nx">req</code><code class="p">.</code><code class="nx">NamespacedName</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">logger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"EGApp Reconcile started..."</code><code class="p">)</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// fetch the EGApp CR instance</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">egApp</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">egplatformv1alpha1</code><code class="p">.</code><code class="nx">EGApp</code><code class="p">{}</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Get</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">req</code><code class="p">.</code><code class="nx">NamespacedName</code><code class="p">,</code><code class="w"> </code><code class="nx">egApp</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">errors</code><code class="p">.</code><code class="nx">IsNotFound</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nx">logger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"EGApp resource not found. Object must be deleted"</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">logger</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code class="w"> </code><code class="s">"Failed to get EGApp"</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// check if the deployment already exists, if not create a new one</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">found</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">appsv1</code><code class="p">.</code><code class="nx">Deployment</code><code class="p">{}</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Get</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">types</code><code class="p">.</code><code class="nx">NamespacedName</code><code class="p">{</code><code class="nx">Name</code><code class="p">:</code><code class="w"> </code><code class="nx">egApp</code><code class="p">.</code><code class="nx">Name</code><code class="p">,</code><code class="w"> </code><code class="nx">Namespace</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nx">egApp</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">},</code><code class="w"> </code><code class="nx">found</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">dep</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">r</code><code class="p">.</code><code class="nx">deploymentForEGApp</code><code class="p">(</code><code class="nx">egApp</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">logger</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"Creating a  new deployment"</code><code class="p">,</code><code class="w"> </code><code class="s">"Deployment.Namespace"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">          </code><code class="nx">dep</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">,</code><code class="w"> </code><code class="s">"Deployment.Name"</code><code class="p">,</code><code class="w"> </code><code class="nx">dep</code><code class="p">.</code><code class="nx">Name</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Create</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">dep</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nx">logger</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code class="w"> </code><code class="s">"Failed to create new deployment"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">              </code><code class="s">"Deployment.Namespace"</code><code class="p">,</code><code class="w"> </code><code class="nx">dep</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">,</code><code class="w"> </code><code class="s">"Deployment.Name"</code><code class="p">,</code><code class="w"> </code><code class="nx">dep</code><code class="p">.</code><code class="nx">Name</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code><code class="w"> </code><code class="nx">err</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"> </code><code class="k">else</code><code class="w"> </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">logger</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code class="w"> </code><code class="s">"Failed to get deployment"</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// This point, we have the deployment object created</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// Ensure the deployment size is same as the spec</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">replicas</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">egApp</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">ReplicaCount</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="o">*</code><code class="nx">found</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Replicas</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="nx">replicas</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">found</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">Replicas</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">replicas</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Update</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">found</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nx">logger</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code class="w"> </code><code class="s">"Failed to update Deployment"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">              </code><code class="s">"Deployment.Namespace"</code><code class="p">,</code><code class="w"> </code><code class="nx">found</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">,</code><code class="w"> </code><code class="s">"Deployment.Name"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">              </code><code class="nx">found</code><code class="p">.</code><code class="nx">Name</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code><code class="w"> </code><code class="nx">err</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="c1">// Spec updated return and requeue</code><code class="w"/>&#13;
<code class="w">        </code><code class="c1">// Requeue for any reason other than an error</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="nx">Requeue</code><code class="p">:</code><code class="w"> </code><code class="kc">true</code><code class="p">},</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// Update the egApp status with pod names</code><code class="w"/>&#13;
<code class="w">    </code><code class="c1">// List the pods for this egApp's deployment</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">podList</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">PodList</code><code class="p">{}</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">listOpts</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[]</code><code class="nx">client</code><code class="p">.</code><code class="nx">ListOption</code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">client</code><code class="p">.</code><code class="nx">InNamespace</code><code class="p">(</code><code class="nx">egApp</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">),</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">client</code><code class="p">.</code><code class="nx">MatchingLabels</code><code class="p">(</code><code class="nx">egApp</code><code class="p">.</code><code class="nx">GetLabels</code><code class="p">()),</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">r</code><code class="p">.</code><code class="nx">List</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">podList</code><code class="p">,</code><code class="w"> </code><code class="nx">listOpts</code><code class="o">...</code><code class="p">);</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">logger</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code class="w"> </code><code class="s">"Failed to list pods"</code><code class="p">,</code><code class="w"> </code><code class="s">"egApp.Namespace"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">          </code><code class="nx">egApp</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">,</code><code class="w"> </code><code class="s">"egApp.Name"</code><code class="p">,</code><code class="w"> </code><code class="nx">egApp</code><code class="p">.</code><code class="nx">Name</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code><code class="w"> </code><code class="nx">err</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">podNames</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">getPodNames</code><code class="p">(</code><code class="nx">podList</code><code class="p">.</code><code class="nx">Items</code><code class="p">)</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="c1">// Update status.Pods if needed</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="p">!</code><code class="nx">reflect</code><code class="p">.</code><code class="nx">DeepEqual</code><code class="p">(</code><code class="nx">podNames</code><code class="p">,</code><code class="w"> </code><code class="nx">egApp</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Pods</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">egApp</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Pods</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">podNames</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Status</code><code class="p">().</code><code class="nx">Update</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">egApp</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">        </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nx">logger</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code class="w"> </code><code class="s">"Failed to update egApp status"</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">            </code><code class="k">return</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code><code class="w"> </code><code class="nx">err</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code><code class="w"> </code><code class="kc">nil</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">r</code><code class="w"> </code><code class="o">*</code><code class="nx">EGAppReconciler</code><code class="p">)</code><code class="w"> </code><code class="nx">deploymentForEGApp</code><code class="p">(</code><code class="nx">m</code><code class="w"> </code><code class="o">*</code><code class="nx">egplatformv1alpha1</code><code class="p">.</code><code class="nx">EGApp</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">  </code><code class="o">*</code><code class="nx">appsv1</code><code class="p">.</code><code class="nx">Deployment</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">ls</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">m</code><code class="p">.</code><code class="nx">GetLabels</code><code class="p">()</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">replicas</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">m</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">ReplicaCount</code><code class="w"/>&#13;
&#13;
<code class="w">    </code><code class="nx">deploy</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">appsv1</code><code class="p">.</code><code class="nx">Deployment</code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">ObjectMeta</code><code class="p">:</code><code class="w"> </code><code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nx">Name</code><code class="p">:</code><code class="w">      </code><code class="nx">m</code><code class="p">.</code><code class="nx">Name</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nx">Namespace</code><code class="p">:</code><code class="w"> </code><code class="nx">m</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">Spec</code><code class="p">:</code><code class="w"> </code><code class="nx">appsv1</code><code class="p">.</code><code class="nx">DeploymentSpec</code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nx">Replicas</code><code class="p">:</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">replicas</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nx">Selector</code><code class="p">:</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">metav1</code><code class="p">.</code><code class="nx">LabelSelector</code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                </code><code class="nx">MatchLabels</code><code class="p">:</code><code class="w"> </code><code class="nx">ls</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">            </code><code class="nx">Template</code><code class="p">:</code><code class="w"> </code><code class="nx">corev1</code><code class="p">.</code><code class="nx">PodTemplateSpec</code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                </code><code class="nx">ObjectMeta</code><code class="p">:</code><code class="w"> </code><code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nx">Labels</code><code class="p">:</code><code class="w"> </code><code class="nx">ls</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">                </code><code class="nx">Spec</code><code class="p">:</code><code class="w"> </code><code class="nx">corev1</code><code class="p">.</code><code class="nx">PodSpec</code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nx">Containers</code><code class="p">:</code><code class="w"> </code><code class="p">[]</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">Container</code><code class="p">{{</code><code class="w"/>&#13;
<code class="w">                        </code><code class="nx">Image</code><code class="p">:</code><code class="w"> </code><code class="s">"gcr.io/kuar-demo/kuard-amd64:1"</code><code class="p">,</code><code class="w">  </code><code class="c1">// hard-coded</code><code class="w"/>&#13;
<code class="w">                          </code><code class="nx">here</code><code class="p">,</code><code class="w"> </code><code class="nx">make</code><code class="w"> </code><code class="nx">this</code><code class="w"> </code><code class="nx">dynamic</code><code class="w"/>&#13;
<code class="w">                        </code><code class="nx">Name</code><code class="p">:</code><code class="w">  </code><code class="nx">m</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">AppId</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                        </code><code class="nx">Ports</code><code class="p">:</code><code class="w"> </code><code class="p">[]</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">ContainerPort</code><code class="p">{{</code><code class="w"/>&#13;
<code class="w">                            </code><code class="nx">ContainerPort</code><code class="p">:</code><code class="w"> </code><code class="mi">8080</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                            </code><code class="nx">Name</code><code class="p">:</code><code class="w">          </code><code class="s">"http"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                        </code><code class="p">}},</code><code class="w"/>&#13;
<code class="w">                    </code><code class="p">}},</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">SetControllerReference</code><code class="p">(</code><code class="nx">m</code><code class="p">,</code><code class="w"> </code><code class="nx">deploy</code><code class="p">,</code><code class="w"> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Scheme</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">deploy</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="c1">// Utility function to iterate over pods and return the names slice</code><code class="w"/>&#13;
<code class="kd">func</code><code class="w"> </code><code class="nx">getPodNames</code><code class="p">(</code><code class="nx">pods</code><code class="w"> </code><code class="p">[]</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">Pod</code><code class="p">)</code><code class="w"> </code><code class="p">[]</code><code class="kt">string</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="nx">podNames</code><code class="w"> </code><code class="p">[]</code><code class="kt">string</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">pod</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">pods</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">podNames</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nb">append</code><code class="p">(</code><code class="nx">podNames</code><code class="p">,</code><code class="w"> </code><code class="nx">pod</code><code class="p">.</code><code class="nx">Name</code><code class="p">)</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">podNames</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/>&#13;
&#13;
<code class="c1">// SetupWithManager sets up the controller with the Manager.</code><code class="w"/>&#13;
<code class="kd">func</code><code class="w"> </code><code class="p">(</code><code class="nx">r</code><code class="w"> </code><code class="o">*</code><code class="nx">EGAppReconciler</code><code class="p">)</code><code class="w"> </code><code class="nx">SetupWithManager</code><code class="p">(</code><code class="nx">mgr</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Manager</code><code class="p">)</code><code class="w"> </code><code class="kt">error</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">NewControllerManagedBy</code><code class="p">(</code><code class="nx">mgr</code><code class="p">).</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">For</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">egplatformv1alpha1</code><code class="p">.</code><code class="nx">EGApp</code><code class="p">{}).</code><code class="w"/>&#13;
<code class="w">        </code><code class="nx">Complete</code><code class="p">(</code><code class="nx">r</code><code class="p">)</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>The main steps are implemented here through the reconcile process. Two important points to reference are:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The Custom Resource actually creates deployments. If the specific instance is not found, a deployment is created using values from the CR spec to fill in the required data. The line <code>ctrl.SetControllerReference(m, deploy, r.scheme)</code> is where ownership of the deployment is obtained by the CR. This allows for the resource to also clean up any deployments it owns when deleted.</p>&#13;
</li>&#13;
<li>&#13;
<p>The status is updated on the resource with a list of pods associated with the deployment. This update is done to the <code>status.pods</code> property of the CR, which was created as a subresource on the line <code>err := r.Status().Update(ctx, egApp)</code>. This is important because it will not update the status of our resource without increasing the <code>ResourceGeneration</code> metadata field. By implementing a predicate on the watch to not trigger a reconciliation on events that did not increase the <code>ResourceGeneration</code> metadata field, we can ensure the entire loop is not repeated for a noop scenario.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Once the controller logic is implemented, to test it against the CR spec deployed earlier to the cluster, kubebuilder can run the code locally to verify all is working and then also package it as a container and deploy to the cluster when ready to operationalize.</p>&#13;
&#13;
<p>Here is what that looks like:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting">$<code class="w"> </code>make<code class="w"> </code>run<code class="w"/>&#13;
<code class="nb">test</code><code class="w"> </code>-s<code class="w"> </code>/home/eddiejv/dev/projects/operators/platformapp/bin/controller-gen<code class="w"> </code><code class="o">&amp;&amp;</code><code class="w"/>&#13;
/home/eddiejv/dev/projects/operators/platformapp/bin/controller-gen<code class="w"> </code>--version<code class="w"/>&#13;
<code class="p">|</code><code class="w"> </code>grep<code class="w"> </code>-q<code class="w"> </code>v0.11.1<code class="w"> </code><code class="o">||</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="nv">GOBIN</code><code class="o">=</code>/home/eddiejv/dev/projects/operators/platformapp/bin<code class="w"> </code>go<code class="w"> </code>install<code class="w"/>&#13;
sigs.k8s.io/controller-tools/cmd/controller-gen@v0.11.1<code class="w"/>&#13;
/home/eddiejv/dev/projects/operators/platformapp/bin/controller-gen<code class="w"/>&#13;
rbac:roleName<code class="o">=</code>manager-role<code class="w"> </code>crd<code class="w"> </code>webhook<code class="w"> </code><code class="nv">paths</code><code class="o">=</code><code class="s2">"./..."</code><code class="w"/>&#13;
output:crd:artifacts:config<code class="o">=</code>config/crd/bases<code class="w"/>&#13;
/home/eddiejv/dev/projects/operators/platformapp/bin/controller-gen<code class="w"/>&#13;
object:headerFile<code class="o">=</code><code class="s2">"hack/boilerplate.go.txt"</code><code class="w"> </code><code class="nv">paths</code><code class="o">=</code><code class="s2">"./..."</code><code class="w"/>&#13;
go<code class="w"> </code>fmt<code class="w"> </code>./...<code class="w"/>&#13;
go<code class="w"> </code>vet<code class="w"> </code>./...<code class="w"/>&#13;
go<code class="w"> </code>run<code class="w"> </code>./main.go<code class="w"/>&#13;
<code class="m">2023</code>-02-24T11:07:21-06:00<code class="w"> </code>INFO<code class="w"> </code>controller-runtime.metrics<code class="w"> </code>Metrics<code class="w"> </code>server<code class="w"> </code>is<code class="w"/>&#13;
<code class="w">  </code>starting<code class="w"> </code>to<code class="w"> </code>listen<code class="w"> </code><code class="o">{</code><code class="s2">"addr"</code>:<code class="w"> </code><code class="s2">":8080"</code><code class="o">}</code><code class="w"/>&#13;
<code class="m">2023</code>-02-24T11:07:21-06:00<code class="w"> </code>INFO<code class="w"> </code>setup<code class="w"> </code>starting<code class="w"> </code>manager<code class="w"/>&#13;
<code class="m">2023</code>-02-24T11:07:21-06:00<code class="w"> </code>INFO<code class="w"> </code>Starting<code class="w"> </code>server<code class="w"> </code><code class="o">{</code><code class="s2">"path"</code>:<code class="w"> </code><code class="s2">"/metrics"</code>,<code class="w"> </code><code class="s2">"kind"</code>:<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"metrics"</code>,<code class="w"> </code><code class="s2">"addr"</code>:<code class="w"> </code><code class="s2">"[::]:8080"</code><code class="o">}</code><code class="w"/>&#13;
<code class="m">2023</code>-02-24T11:07:21-06:00<code class="w"> </code>INFO<code class="w"> </code>Starting<code class="w"> </code>server<code class="w"> </code><code class="o">{</code><code class="s2">"kind"</code>:<code class="w"> </code><code class="s2">"health probe"</code>,<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"addr"</code>:<code class="w"> </code><code class="s2">"[::]:8081"</code><code class="o">}</code><code class="w"/>&#13;
<code class="m">2023</code>-02-24T11:07:21-06:00<code class="w"> </code>INFO<code class="w"> </code>Starting<code class="w"> </code>EventSource<code class="w"> </code><code class="o">{</code><code class="s2">"controller"</code>:<code class="w"> </code><code class="s2">"egapp"</code>,<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"controllerGroup"</code>:<code class="w"> </code><code class="s2">"egplatform.platform.evillgenius.com"</code>,<code class="w"> </code><code class="s2">"controllerKind"</code>:<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"EGApp"</code>,<code class="w"> </code><code class="s2">"source"</code>:<code class="w"> </code><code class="s2">"kind source: *v1alpha1.EGApp"</code><code class="o">}</code><code class="w"/>&#13;
<code class="m">2023</code>-02-24T11:07:21-06:00<code class="w"> </code>INFO<code class="w"> </code>Starting<code class="w"> </code>Controller<code class="w"> </code><code class="o">{</code><code class="s2">"controller"</code>:<code class="w"> </code><code class="s2">"egapp"</code>,<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"controllerGroup"</code>:<code class="w"> </code><code class="s2">"egplatform.platform.evillgenius.com"</code>,<code class="w"> </code><code class="s2">"controllerKind"</code>:<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"EGApp"</code><code class="o">}</code><code class="w"/>&#13;
<code class="m">2023</code>-02-24T11:07:21-06:00<code class="w"> </code>INFO<code class="w"> </code>Starting<code class="w"> </code>workers<code class="w"> </code><code class="o">{</code><code class="s2">"controller"</code>:<code class="w"> </code><code class="s2">"egapp"</code>,<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"controllerGroup"</code>:<code class="w"> </code><code class="s2">"egplatform.platform.evillgenius.com"</code>,<code class="w"> </code><code class="s2">"controllerKind"</code>:<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"EGApp"</code>,<code class="w"> </code><code class="s2">"worker count"</code>:<code class="w"> </code><code class="m">1</code><code class="o">}</code><code class="w"/></pre>&#13;
&#13;
<p>The logs show that the controller is up and listening for events. Then a CR was deployed to the cluster using:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">egplatform.platform.evillgenius.com/v1alpha1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">EGApp</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app.Kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">egapp</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app.Kubernetes.io/instance</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">egapp-sample</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app.Kubernetes.io/part-of</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pe-app</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app.Kubernetes.io/managed-by</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kustomize</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app.Kubernetes.io/created-by</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pe-app</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">egapp-sample</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">appId</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">egapp-sample</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">framework</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">go</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">instanceType</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lowMem</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">environment</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">dev</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">replicaCount</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">2</code><code class="w"/></pre>&#13;
&#13;
<p>The controller log shows the reconciliation loop starting, and because a deployment did not exist it created the deployment:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="m">2023</code>-02-24T11:12:46-06:00<code class="w"> </code>INFO<code class="w"> </code>EGApp<code class="w"> </code>Reconcile<code class="w"> </code>started...<code class="w"> </code><code class="o">{</code><code class="s2">"EGApp"</code>:<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"default/egapp-sample"</code><code class="o">}</code><code class="w"/>&#13;
<code class="m">2023</code>-02-24T11:12:46-06:00<code class="w"> </code>INFO<code class="w"> </code>Creating<code class="w"> </code>a<code class="w">  </code>new<code class="w"> </code>deployment<code class="w"> </code><code class="o">{</code><code class="s2">"EGApp"</code>:<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"default/egapp-sample"</code>,<code class="w"> </code><code class="s2">"Deployment.Namespace"</code>:<code class="w"> </code><code class="s2">"default"</code>,<code class="w"> </code><code class="s2">"Deployment.Name"</code>:<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"egapp-sample"</code><code class="o">}</code><code class="w"/></pre>&#13;
&#13;
<p>Then a <code>kubectl delete</code> was called on the instance and the controller began another reconciliation loop and deleted the object:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="m">2023</code>-02-24T11:21:39-06:00<code class="w"> </code>INFO<code class="w"> </code>EGApp<code class="w"> </code>Reconcile<code class="w"> </code>started...<code class="w"> </code><code class="o">{</code><code class="s2">"EGApp"</code>:<code class="w"/>&#13;
<code class="w">  </code><code class="s2">"default/egapp-sample"</code><code class="o">}</code><code class="w"/>&#13;
<code class="m">2023</code>-02-24T11:21:39-06:00<code class="w"> </code>INFO<code class="w"> </code>EGApp<code class="w"> </code>resource<code class="w"> </code>not<code class="w"> </code>found.<code class="w"> </code>Object<code class="w"> </code>must<code class="w"/>&#13;
<code class="w">  </code>be<code class="w"> </code>deleted<code class="w"> </code><code class="o">{</code><code class="s2">"EGApp"</code>:<code class="w"> </code><code class="s2">"default/egapp-sample"</code><code class="o">}</code><code class="w"/></pre>&#13;
&#13;
<p>Much more can be done within the context of the controller and API itself, for example, implementing complex logic around cleanup, such as calling backups, rebalancing workloads across nodes, scaling with custom logic, etc. This is where an engineer’s deep knowledge of how a system should behave, how it should be deployed, and how to react in case of a problem is codified. The whole premise of the benefits of the Operator pattern is encapsulated in this <a data-primary="Operators" data-secondary="controller implementation" data-startref="operator-controller-implement" data-type="indexterm" id="id1182"/><a data-primary="controller implementation" data-startref="controller-implement" data-type="indexterm" id="id1183"/>code example.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Operator Life Cycle" data-type="sect1"><div class="sect1" id="id180">&#13;
<h1>Operator Life Cycle</h1>&#13;
&#13;
<p>The development<a data-primary="Operators" data-secondary="life cycle of" data-type="indexterm" id="operator-lifecycle"/><a data-primary="life cycle of Operators" data-type="indexterm" id="lifecycle-operator"/> of an Operator is not an easy undertaking, but it does not have to answer all the operational problems of the application. Development should focus on the big hurdles and then iterate through versions to enhance the Operator’s capabilities over time. The team at CoreOS and RedHat put together a solid spectrum of capabilities they call <a href="https://oreil.ly/X_Lun">Operator Capability Levels</a> that outline some of the main concerns the Operator should tackle when maturing through the levels. These are:</p>&#13;
<dl>&#13;
<dt>Basic install</dt>&#13;
<dd>&#13;
<p>Automated application provisioning and configuration management</p>&#13;
</dd>&#13;
<dt>Seamless  upgrades</dt>&#13;
<dd>&#13;
<p>Patch and minor version upgrades are supported</p>&#13;
</dd>&#13;
<dt>Full life cycle</dt>&#13;
<dd>&#13;
<p>App life cycle, storage life cycle (backup, failure recovery)</p>&#13;
</dd>&#13;
<dt>Deep insights</dt>&#13;
<dd>&#13;
<p>Metrics, alerts, log processing and workload analysis</p>&#13;
</dd>&#13;
<dt>Auto pilot</dt>&#13;
<dd>&#13;
<p>Horizontal/vertical scaling, auto config tuning, abnormal detection, scheduling tuning</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>This is a solid framework for planning the life of an Operator that will progress over time. The focus is that the Operator should be treated like any piece of software with defined life cycle, product management, deprecation policies, and clear and consistent versioning.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Version Upgrades" data-type="sect2"><div class="sect2" id="id181">&#13;
<h2>Version Upgrades</h2>&#13;
&#13;
<p>In our <a data-primary="Operators" data-secondary="version upgrades" data-type="indexterm" id="id1184"/><a data-primary="version upgrades" data-type="indexterm" id="id1185"/>example we started with <code>v1alphav1</code> as our stated version supported in the CRD. Through the life cycle of the Operator there may be a need to support multiple versions depending on the stage and stability of the API.</p>&#13;
&#13;
<p>When a new version is introduced, a process should be followed carefully to ensure that issues will not arise with existing resources. A Custom Resource object will need the ability to be served by all defined versions of the CRD. That means there could be a mismatch between the version being served and the one stored in state. A conversion process should be implemented on the Custom Resource object to be converted between the version stored and the version that is served. When the conversion involves schema changes or custom logic, a conversion webhook can be used to make the required updates. The default None conversion strategy is used when there are no schema or custom logic is needed as only the apiVersion field will be changed.</p>&#13;
&#13;
<p>You will add a conversion strategy field to the CRD and point it to the webhook listening for the specific resource. This would look like:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apiextensions.k8s.io/v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CustomResourceDefinition</code><code class="w"/>&#13;
<code class="p">...</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">...</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">conversion</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">strategy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Webhook</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">webhook</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">clientConfig</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">service</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">egapp-conversion</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">egapp</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/egapp-conversion</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8081</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">caBundle</code><code class="p">:</code><code class="w"> </code><code class="s">"Hf8j0Kw...&lt;base64-encoded</code><code class="nv"> </code><code class="s">PEM</code><code class="nv"> </code><code class="s">bundle&gt;...tLS0K"</code><code class="w"/>&#13;
<code class="p">...</code><code class="w"/></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Operator Best Practices" data-type="sect2"><div class="sect2" id="id272">&#13;
<h2>Operator Best Practices</h2>&#13;
&#13;
<p>The development <a data-primary="Operators" data-secondary="best practices" data-type="indexterm" id="operator-best"/><a data-primary="best practices" data-secondary="Operators" data-type="indexterm" id="best-practice-operator"/>and ongoing upkeep of an Operator is no small endeavor and should be thought about and planned very carefully. Many times it is easier to package an application using simpler paradigms such as Helm charts, Kustomize repositories, or Terraform modules. When it becomes important to include special reconciliation logic to maintain the application or ease the burden for the users of the application, then an Operator pattern may make sense. If you decide to build an Operator then best practice guidelines are:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Do not overload an Operator to manage more than a single application, and own each CRD it controls.</p>&#13;
</li>&#13;
<li>&#13;
<p>If your Operator manages multiple CRDs then the Operator should also have multiple controllers. Keep it simple: one controller for each CRD.</p>&#13;
</li>&#13;
<li>&#13;
<p>Operators should not be specific to the namespace they are watching resources in and also should not be specific to the namespace they will be deployed in.</p>&#13;
</li>&#13;
<li>&#13;
<p>Operators should be versioned using <a href="https://semver.org">semantic versioning</a>, and as extensions of the Kubernetes API, they should also follow the <a href="https://oreil.ly/O-5lH">Kubernetes API versioning guidelines</a> as they relate to version changes.</p>&#13;
</li>&#13;
<li>&#13;
<p>CRDs should follow the OpenAPI spec to allow for a known schema. Most Operator SDK-based tooling will provide a method to create boilerplate CRDs based on the OpenAPI spec to make them easier to develop.</p>&#13;
</li>&#13;
<li>&#13;
<p>As with any Kubernetes service the Operator itself should follow sound security guidelines such as run as non-root, least privilege RBAC, and observability. Metrics and logs should be external to the system. The Operator should be instrumented to allow for visibility into the Operator’s health and any known Service Level Indicators (SLIs). Metric exports such as Prometheus, DataDog, Cloud Operations, and OpenTelemetry can all be leveraged.</p>&#13;
</li>&#13;
<li>&#13;
<p>Operators do not install other Operators and should not register their own CRDs as those resources are global to the cluster and would require escalated privileges for the Operator.</p>&#13;
</li>&#13;
<li>&#13;
<p>Check all CRDs for validity before accepting the request. The CRDs could be validated against a known schema such as an OpenAPI validation schema or through an admission controller that can validate the CRD. These methods will prevent the resource from wasting space on etcd as it will not be submitted to the API. There should also be some validation logic within the reconciliation cycle as a last effort to validate and clean up the resource.</p>&#13;
</li>&#13;
<li>&#13;
<p>The Operator should be self-cleaning when no longer needed. Proper resource clean up after deletion is important, not only for direct resources created by the Operator but also for any external resources that may have been created in support of the application requirements of the Operator (e.g., PVs for storage attached to pods as needed by the application, external resources to the cluster, etc.).</p>&#13;
</li>&#13;
<li>&#13;
<p>Think carefully about the life cycle of the Operator and when breaking changes are introduced to the upgrade path for existing users of the prior versions. Implement conversion webhooks to allow the conversion to and from a specific version to ensure there is no loss of information converting a resource from a vX to a vY and back to vX.</p>&#13;
</li>&#13;
<li>&#13;
<p>Be thoughtful on the status information written to the resources managed by the Operator. The customer resource is the only interface to the user to understand the state of the resource. By having a status that is clear and concise written to the resource by the controller the user can easily use the existing Kubernetes client tooling to query and act on the status as desired. Status should be implemented as a subresource, and a predicate should be used so as not to trigger a reconciliation loop after an update that did not increase the <code>ResourceGeneration</code> metadata field of the <a data-primary="Operators" data-secondary="best practices" data-startref="operator-best" data-type="indexterm" id="id1186"/><a data-primary="best practices" data-secondary="Operators" data-startref="best-practice-operator" data-type="indexterm" id="id1187"/>main resource.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id394">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>The promise of fully automated deployment and “day 2” operations for an application has driven the Operator market beyond just experimental to become a key feature in the Kubernetes ecosystem. Operators should be used when complex applications are needed to support an organization’s business, but be careful in creating them when easier mechanisms exist. Leverage existing Operators created by software vendors that help support and maintain them, many of which can be found on <a href="https://oreil.ly/wMLSA">operatorhub.io</a>. While the Operator pattern can be a very powerful tool, it requires commitment to ensure that it doesn’t create more problems than it can solve. All warnings aside, if you are building a large application platform based on Kubernetes the Operator pattern should be front and center in reducing operator toil.</p>&#13;
</div></section>&#13;
</div></section></body></html>