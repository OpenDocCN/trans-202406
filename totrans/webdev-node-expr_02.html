<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 2. Getting Started with Node"><div class="chapter" id="ch_getting_started_with_node">
<h1><span class="label">Chapter 2. </span>Getting Started with Node</h1>


<p><a data-type="indexterm" data-primary="Node" data-secondary="getting started with" id="ix_ch-02-getting_started_with_node-asciidoc0"/>If you don’t have any experience with Node, this chapter is for you.
Understanding Express and its usefulness requires a basic understanding of
Node. If you already have experience building web apps
with Node, feel free to skip this chapter. In this chapter, we will be
building a very minimal web server with Node; in the next chapter, we will
see how to do the same thing with Express.</p>






<section data-type="sect1" data-pdf-bookmark="Getting Node"><div class="sect1" id="idm45053609034904">
<h1>Getting Node</h1>

<p><a data-type="indexterm" data-primary="installation" data-secondary="Node" id="idm45053609033496"/><a data-type="indexterm" data-primary="Node" data-secondary="installation" id="idm45053609032520"/>Getting Node installed on your system couldn’t be easier. The Node
team has gone to great lengths to make sure
the installation process is simple and straightforward on all major
platforms.</p>

<p>Go to the <a href="http://nodejs.org">Node home page</a>. Click the big green
button that has a version number followed by “LTS (Recommended for Most
Users).” LTS stands for <em>Long-Term Support</em>, and is somewhat more stable
than the version labeled Current, which contains more recent features and
performance improvements.</p>

<p><a data-type="indexterm" data-primary="macOS" data-secondary="Node installation on" id="idm45053609029144"/><a data-type="indexterm" data-primary="Windows" data-secondary="Node installation on" id="idm45053609028168"/>For Windows and macOS, an installer will be downloaded that walks you
through the process. <a data-type="indexterm" data-primary="Linux" data-secondary="Node installation on" id="idm45053609026984"/>For Linux, you will probably be up and running more
quickly if you <a href="http://bit.ly/36UYMxI">use a
package manager</a>.</p>
<div data-type="caution"><h6>Caution</h6>
<p>If you’re a Linux user and you do want to use a package
manager, make sure you follow the instructions in the aforementioned web
page. Many Linux
distributions will install an extremely old version of Node if you don’t
add the appropriate package repository.</p>
</div>

<p>You can also download <a href="https://nodejs.org/en/download">a standalone
installer</a>, which can be helpful if you are distributing Node to your
organization.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Using the Terminal"><div class="sect1" id="idm45053609022488">
<h1>Using the Terminal</h1>

<p><a data-type="indexterm" data-primary="Node" data-secondary="terminal for" id="idm45053609021208"/><a data-type="indexterm" data-primary="terminal" id="idm45053609020232"/>I’m an unrepentant fan of the power and productivity of using a terminal
(also called a <em>console</em> or <em>command prompt</em>). Throughout this book, all examples will assume you’re using a terminal. If
you’re not friends with your terminal, I highly recommend you spend some
time familiarizing yourself with your terminal of choice. Many of the
utilities in this book have corresponding GUI interfaces, so if you’re dead
set against using a terminal, you have options, but you will have to find
your own way.</p>

<p><a data-type="indexterm" data-primary="Linux" data-secondary="shell options" id="idm45053605814888"/><a data-type="indexterm" data-primary="macOS" data-secondary="shell options" id="idm45053605813912"/>If you’re on macOS or Linux, you have a wealth of venerable shells (the
terminal command interpreter) to choose from. <a data-type="indexterm" data-primary="bash" id="idm45053605812696"/>The most popular by
far is bash, though zsh has its adherents. The main reason I gravitate toward bash (other than long
familiarity) is ubiquity. Sit down in front of any Unix-based computer,
and 99% of the time, the default shell will be bash.</p>

<p><a data-type="indexterm" data-primary="Windows" data-secondary="shell options" id="idm45053605811384"/>If you’re a Windows user, things aren’t quite so rosy. Microsoft has never been particularly
interested in providing a pleasant terminal experience, so you’ll have to
do a little more work. <a data-type="indexterm" data-primary="Git bash shell" id="idm45053605809880"/>Git helpfully includes a “Git bash” shell, which
provides a Unix-like terminal experience (it has only a small subset of the
normally available Unix command-line utilities, but it’s a useful subset).
While Git bash provides you with a minimal bash shell, it’s still using the
built-in Windows console application, which leads to an exercise in
frustration (even simple functionality like resizing a console window,
selecting text, cutting, and pasting is unintuitive and awkward). For this
reason, I recommend installing a more sophisticated terminal such as
<a href="https://github.com/cbucher/console">ConsoleZ</a> or
<a href="https://conemu.github.io">ConEmu</a>. <a data-type="indexterm" data-primary="Microsoft" data-secondary="PowerShell" id="idm45053605807192"/><a data-type="indexterm" data-primary="PowerShell" id="idm45053605806184"/>For Windows power
users—especially for .NET developers or for hardcore Windows systems or
network administrators—there is another option: Microsoft’s own
PowerShell. PowerShell
lives up to its name: people do remarkable things with it, and a skilled
PowerShell user could give a Unix command-line guru a run for their money.
However, if you move between macOS/Linux and Windows, I still recommend
sticking with Git bash for the consistency it provides.</p>

<p><a data-type="indexterm" data-primary="Ubuntu Linux" id="idm45053605804776"/><a data-type="indexterm" data-primary="Windows" data-secondary="Ubuntu Linux and" id="idm45053605804072"/>If you’re using Windows 10 or later, you can now install Ubuntu Linux
directly on Windows! This is not dual-boot or virtualization but some
great work on behalf of Microsoft’s open source team to bring the Linux
experience to Windows. You can install Ubuntu on Windows through the
<a href="http://bit.ly/2KcSfEI">Microsoft App
Store</a>.</p>

<p><a data-type="indexterm" data-primary="virtual machines (VMs)" id="idm45053605801720"/><a data-type="indexterm" data-primary="Windows" data-secondary="virtualization" id="idm45053605801016"/>A final option for Windows users is virtualization.
With the power and architecture of modern computers, the performance of
virtual machines (VMs) is practically indistinguishable from actual
machines. <a data-type="indexterm" data-primary="Oracle VirtualBox" id="idm45053605799720"/><a data-type="indexterm" data-primary="VirtualBox" id="idm45053605799048"/>I’ve had great
luck with Oracle’s free <a href="https://www.virtualbox.org/">VirtualBox</a>.</p>

<p><a data-type="indexterm" data-primary="cloud development environments" id="idm45053605797304"/><a data-type="indexterm" data-primary="Cloud9" id="idm45053605796584"/><a data-type="indexterm" data-primary="development environments, cloud-based" id="idm45053605795912"/>Finally, no matter what system you’re on, there are excellent cloud-based
development environments, such as <a href="https://aws.amazon.com/cloud9/">Cloud9</a>
(now an AWS product). Cloud9 will spin up a new Node development
environment that makes it extremely easy to get started quickly with
Node.</p>

<p>Once you’ve settled on a shell that makes you happy, I recommend you spend
some time getting to know the basics.
There are many wonderful tutorials on the internet
(<a href="https://guide.bash.academy">The Bash Guide</a> is a great place to start), and
you’ll save yourself a lot of headaches later by learning a little now.
At minimum, you should know how to navigate directories; copy, move, and
delete files; and break out of a command-line program (usually Ctrl-C). If
you want to become a terminal ninja, I encourage you to learn how to search
for text in files, search for files and directories, chain commands
together (the old “Unix philosophy”), and redirect output.</p>
<div data-type="caution"><h6>Caution</h6>
<p><a data-type="indexterm" data-primary="Ctrl-S" id="idm45053605791480"/>On many Unix-like systems, Ctrl-S has a special meaning: it
will “freeze” the terminal (this was once used to pause output quickly
scrolling past). Since this
is such a common shortcut for Save, it’s easy to unthinkingly press,
which leads to a confusing situation for most people (this happens to
me more often than I care to admit). <a data-type="indexterm" data-primary="Ctrl-Q" id="idm45053605790296"/>To unfreeze the terminal, simply hit
Ctrl-Q. So if you’re ever confounded by a terminal that seems to have
suddenly frozen, try pressing Ctrl-Q and see if that releases it.</p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Editors"><div class="sect1" id="idm45053605789048">
<h1>Editors</h1>

<p><a data-type="indexterm" data-primary="editors" id="idm45053605787640"/><a data-type="indexterm" data-primary="Node" data-secondary="editors with" id="idm45053605786936"/>Few topics inspire such heated debate among programmers as the choice of
editors, and for good reason: the editor is your primary
tool. My
editor of choice is vi (or an editor
that has a vi mode).<sup><a data-type="noteref" id="idm45053605785656-marker" href="ch02.xhtml#idm45053605785656">1</a></sup> vi isn’t for everyone (my
coworkers constantly roll their eyes at me when I tell them how easy it
would be to do what they’re doing in vi), but finding a powerful editor and
learning to use it will significantly increase your productivity and, dare
I say it, enjoyment. One of the reasons I particularly like vi (though
hardly the most important reason) is that, like bash, it is ubiquitous. If
you have access to a Unix system, vi is there for you. Most popular
editors have a “vi mode” that allows you to use vi keyboard commands.
Once you get used to it, it’s hard to imagine using anything else. vi is a
hard road at first, but the payoff is worth it.</p>

<p><a data-type="indexterm" data-primary="Emacs" id="idm45053605782824"/>If, like me, you see the value in being familiar with an editor that’s
available anywhere, your other option is Emacs. Emacs and I
have never quite gotten on (and usually you’re either an Emacs person or a
vi person), but I absolutely respect the power and flexibility that Emacs
provides.  If vi’s modal editing approach isn’t for you, I would encourage
you to look into Emacs.</p>

<p>While knowing a console editor (like vi or Emacs) can come in incredibly
handy, you may still want a more modern editor. <a data-type="indexterm" data-primary="Visual Studio Code" id="idm45053605781064"/>A popular choice is
<a href="https://code.visualstudio.com/">Visual Studio Code</a> (not to be confused with
Visual Studio without the “Code”). I can heartily endorse Visual Studio
Code; it is a well-designed, fast, efficient editor that is perfectly
suited for Node and JavaScript development. <a data-type="indexterm" data-primary="Atom" id="idm45053605779288"/>Another popular choice is
<a href="https://atom.io">Atom</a>, which is also popular in the JavaScript community.
Both of these editors are available for free on Windows, macOS, and Linux
(and both have vi modes!).</p>

<p>Now that we have a good tool to edit code, let’s turn our attention to npm,
which will help us get packages that other people have written so we can
take advantage of the large and active JavaScript community.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="npm"><div class="sect1" id="idm45053605776856">
<h1>npm</h1>

<p><a data-type="indexterm" data-primary="Node" data-secondary="npm and" id="idm45053605775576"/><a data-type="indexterm" data-primary="npm (package manager)" id="idm45053605774600"/>npm is the ubiquitous package manager for Node packages (and is how we’ll get and install
Express). In the wry tradition of PHP, GNU, WINE, and others, <em>npm</em> is not
an acronym (which is why it isn’t capitalized); rather, it is a recursive
abbreviation for “npm is not an acronym.”</p>

<p>Broadly speaking, a package manager’s two primary responsibilities are
installing packages and managing dependencies. npm is a fast, capable, and
painless package manager, which I feel is in large part responsible for the
rapid growth and diversity of the Node ecosystem.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>There is a popular competing package manager called Yarn that uses the same
package database that npm does; we’ll be using Yarn in
<a data-type="xref" href="ch16.xhtml#ch_single_page_applications">Chapter 16</a>.</p>
</div>

<p>npm is installed when you install Node, so if you followed the steps listed
earlier, you’ve already got it. So let’s get to work!</p>

<p><a data-type="indexterm" data-primary="install command" id="idm45053605769368"/>The primary command you’ll be using with npm (unsurprisingly) is
<code>install</code>.
 For example, to install nodemon (a
popular utility to automatically restart a Node program when you make
changes to the source code), you would issue the following command (on the
console):</p>

<pre data-type="programlisting">npm install -g nodemon</pre>

<p><a data-type="indexterm" data-primary="-g flag (npm)" id="idm45053605766856"/>The <code>-g</code> flag tells npm to install the package <em>globally</em>, meaning it’s
available globally on the system. This distinction will become clearer
when we cover the <em>package.json</em> files. For now, the rule of thumb is that
JavaScript utilities (like nodemon) will generally be installed globally,
whereas packages that are specific to your web app or project will not.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Unlike languages like Python—which underwent a major language change from
2.0 to 3.0, necessitating a way to easily switch between different
environments—the Node platform is new enough that it is likely that you
should always be running the latest version of Node. However, if you
do find yourself needing to support multiple versions of Node, check out
<a href="https://github.com/creationix/nvm">nvm</a> or <a href="https://github.com/tj/n">n</a>, which
allow you to switch environments. You can find out what version of Node is
installed on your computer by typing <code>node --version</code>.</p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="A Simple Web Server with Node"><div class="sect1" id="idm45053605760776">
<h1>A Simple Web Server with Node</h1>

<p><a data-type="indexterm" data-primary="Node" data-secondary="simple web server project" id="ix_ch-02-getting_started_with_node-asciidoc1"/><a data-type="indexterm" data-primary="web server project" data-secondary="creating with Node" id="ix_ch-02-getting_started_with_node-asciidoc2"/>If you’ve ever built a static HTML website before or are coming from a PHP
or ASP background, you’re probably used to the idea of the web server
(Apache or IIS, for example) serving your static files so that a browser
can view them over the network. For example, if you create the file <em>about.html</em> and put
it in the proper directory, you can then navigate to
<em>http://localhost/about.html</em>. Depending on your web server
configuration, you might even be able to omit the <em>.html</em>, but the
relationship between URL and filename is clear: the web server simply knows
where the file is on the computer and serves it to the browser.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="localhost" id="idm45053605753896"/><em>localhost</em>, as the name implies, refers to the computer
you’re on. This is a common alias for the IPv4 loopback address 127.0.0.1 or the IPv6
loopback address ::1. You will often see 127.0.0.1 used instead, but I
will be using <em>localhost</em> in this book. If you’re using a remote
<span class="keep-together">computer</span> (using SSH, for
example), keep in mind that browsing to <em>localhost</em> will not connect to
that computer.</p>
</div>

<p>Node offers a different paradigm than that of a traditional web server: the
app that you write <em>is</em> the web server. Node simply provides the framework
for you to build a web server.</p>

<p>“But I don’t want to write a web server,” you might be saying! It’s a
natural response: you want to be writing an app, not a web server.
However, Node makes the business of writing this web server a simple affair
(just a few lines, even), and the control you gain over your application in
return is more than worth it.</p>

<p>So let’s get to it. You’ve installed Node, you’ve made friends with the
terminal, and now you’re ready to go.</p>








<section data-type="sect2" data-pdf-bookmark="Hello World"><div class="sect2" id="idm45053605748424">
<h2>Hello World</h2>

<p><a data-type="indexterm" data-primary="web server project" data-secondary="Hello world" id="idm45053605746984"/>I’ve always found it unfortunate that the canonical introductory
programming example is the uninspired message “Hello world.”
However, it seems almost sacrilegious at this point to fly in the face of
such ponderous tradition, so we’ll start there and then move on to
something more interesting.</p>

<p>In your favorite editor, create a file called <em>helloworld.js</em>
(<em>ch02/00-helloworld.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code>

<code class="kr">const</code> <code class="nx">server</code> <code class="o">=</code> <code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="p">{</code> <code class="s1">'Content-Type'</code><code class="o">:</code> <code class="s1">'text/plain'</code> <code class="p">})</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s1">'Hello world!'</code><code class="p">)</code>
<code class="p">})</code>

<code class="nx">server</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`server started on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">; `</code> <code class="o">+</code>
  <code class="s1">'press Ctrl-C to terminate....'</code><code class="p">))</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="semicolons" id="idm45053608449768"/>Depending on when and where you learned JavaScript, you may be disconcerted
by the lack of semicolons in this example. I used to be a die-hard
semicolon promoter, and I grudgingly stopped using them as I did more React
development, where it is conventional to omit them. After a while, the fog
lifted from my eyes, and I wondered why I was ever so excited about
semicolons! I’m now firmly on team “no-semicolon,” and the examples in this
book will reflect that. It’s a personal choice, and you are welcome to use
semicolons if you wish.</p>
</div>

<p>Make sure you are in the same directory as <em>helloworld.js</em>, and type
<code>node helloworld.js</code>. Then open a browser and navigate to
<em>http://localhost:3000</em>, and <em>voilà</em>! Your first web server. This
particular one doesn’t serve HTML; rather, it just displays the message
“Hello world!” in plain text to your browser. If you want, you can
experiment with sending HTML instead: just change <code>text/plain</code> to
<code>text/html</code> and change <code>'Hello world!'</code> to a string containing valid HTML.
I didn’t demonstrate that, because I try to avoid writing HTML inside
JavaScript for reasons that will be discussed in more detail in
<a data-type="xref" href="ch07.xhtml#ch_templating">Chapter 7</a>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Event-Driven Programming"><div class="sect2" id="idm45053608497064">
<h2>Event-Driven Programming</h2>

<p><a data-type="indexterm" data-primary="event-driven programming" id="idm45053608495896"/><a data-type="indexterm" data-primary="Node" data-secondary="event-driven programming as core philosophy" id="idm45053608495224"/><a data-type="indexterm" data-primary="web server project" data-secondary="event-driven programming" id="idm45053608494248"/>The core philosophy behind Node is that of <em>event-driven
programming</em>. What that means for you,
the programmer, is that you have to understand what events are available to
you and how to respond to them. Many people are introduced to event-driven
programming by implementing a user interface: the user clicks something,
and you handle the <em>click event</em>. It’s a good metaphor, because it’s
understood that the programmer has no control over when, or if, the user is
going to click something, so event-driven programming is really quite
intuitive. It can be a little harder to make the conceptual leap to
responding to events on the server, but the principle is the same.</p>

<p>In the previous code example, the event is implicit: the event that’s being
handled is an HTTP request. <a data-type="indexterm" data-primary="http.createServer method" id="idm45053608491224"/>The <code>http.createServer</code> method takes a
function as an argument; that function will be invoked every time an HTTP
request is made. Our simple program just sets the content type to
plain text and sends the string “Hello world!”</p>

<p>Once you start thinking in terms of event-driven programming, you start
seeing events everywhere. One such event is when a user navigates from one
page or area of your application to another. How your application responds
to that navigation event is referred to as <em>routing</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Routing"><div class="sect2" id="idm45053608488312">
<h2>Routing</h2>

<p><a data-type="indexterm" data-primary="client/server applications" id="idm45053608486840"/><a data-type="indexterm" data-primary="routing" id="idm45053608486120"/><a data-type="indexterm" data-primary="web server project" data-secondary="routing" id="idm45053608485448"/>Routing refers to the mechanism for serving the client the content it has
asked for.
For web-based client/server applications, the client specifies the desired
content in the URL; specifically, the path and querystring (the parts of a
URL will be discussed in more detail in
<a data-type="xref" href="ch06.xhtml#ch_the_request_and_response_objects">Chapter 6</a>).</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Server routing traditionally hinges on the path and the querystring, but
there is other information available: headers, the domain, the IP address,
and more. This allows servers to take into consideration, for example, the
approximate physical location of the user or the preferred language of the
user.</p>
</div>

<p>Let’s expand our “Hello world!” example to do something more interesting.
Let’s serve a really minimal website consisting of a home page, an About
page, and a Not Found page. For now, we’ll stick with our previous example
and just serve plaintext instead of HTML (<em>ch02/01-helloworld.js</em> in the
companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code>

<code class="kr">const</code> <code class="nx">server</code> <code class="o">=</code> <code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code><code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// normalize url by removing querystring, optional</code>
  <code class="c1">// trailing slash, and making it lowercase</code>
  <code class="kr">const</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">url</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\/?(?:\?.*)?$/</code><code class="p">,</code> <code class="s1">''</code><code class="p">).</code><code class="nx">toLowerCase</code><code class="p">()</code>
  <code class="k">switch</code><code class="p">(</code><code class="nx">path</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">case</code> <code class="s1">''</code><code class="o">:</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="p">{</code> <code class="s1">'Content-Type'</code><code class="o">:</code> <code class="s1">'text/plain'</code> <code class="p">})</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s1">'Homepage'</code><code class="p">)</code>
      <code class="k">break</code>
    <code class="k">case</code> <code class="s1">'/about'</code><code class="o">:</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="p">{</code> <code class="s1">'Content-Type'</code><code class="o">:</code> <code class="s1">'text/plain'</code> <code class="p">})</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s1">'About'</code><code class="p">)</code>
      <code class="k">break</code>
    <code class="k">default</code><code class="o">:</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">404</code><code class="p">,</code> <code class="p">{</code> <code class="s1">'Content-Type'</code><code class="o">:</code> <code class="s1">'text/plain'</code> <code class="p">})</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s1">'Not Found'</code><code class="p">)</code>
      <code class="k">break</code>
  <code class="p">}</code> <code class="p">})</code>

<code class="nx">server</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`server started on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">; `</code> <code class="o">+</code>
  <code class="s1">'press Ctrl-C to terminate....'</code><code class="p">))</code></pre>

<p>If you run this, you’ll find you can now browse to the home page
(<em>http://localhost:3000</em>) and the About page
(<em>http://localhost:3000/about</em>). Any querystrings will be ignored (so
<em>http://localhost:3000/?foo=bar</em> will serve the home page), and any other
URL (<em>http://localhost:3000/foo</em>) will serve the Not Found page.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Serving Static Resources"><div class="sect2" id="idm45053608476488">
<h2>Serving Static Resources</h2>

<p><a data-type="indexterm" data-primary="static resources" id="ix_ch-02-getting_started_with_node-asciidoc3"/><a data-type="indexterm" data-primary="web server project" data-secondary="static resources" id="ix_ch-02-getting_started_with_node-asciidoc4"/>Now that we’ve got some simple routing working, let’s serve some real HTML
and a logo image. These are called <em>static</em> resources because they
generally don’t change (as opposed to, for example, a stock ticker: every
time you reload the page, the stock prices may change).</p>
<div data-type="tip"><h6>Tip</h6>
<p>Serving static resources with Node is suitable for development
and small projects, but for larger projects, you will probably want to use
a proxy server such as NGINX or a CDN to serve static resources. See
<a data-type="xref" href="ch17.xhtml#ch_static_content">Chapter 17</a> for more information.</p>
</div>

<p>If you’ve worked with Apache or IIS, you’re probably used to just creating
an HTML file, navigating to it, and having it delivered to the browser
automatically. Node doesn’t work like that: we’re going to have to do the
work of opening the file, reading it, and then sending its contents along
to the browser. So let’s create a directory in our project called
<em>public</em> (why we don’t call it <em>static</em> will become evident in the next
chapter). In that directory, we’ll create <em>home.html</em>, <em>about.html</em>,
<em>404.html</em>, a subdirectory called <em>img</em>, and an image called
<em>img/logo.png</em>. I’ll leave that up to you; if you’re reading this book,
you probably know how to write an HTML file and find an image. In your HTML files, reference the logo
thusly: <code>&lt;img src="/img/logo.png" alt="logo"&gt;</code>.</p>

<p>Now modify <em>helloworld.js</em> (<em>ch02/02-helloworld.js</em> in the companion
repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code>

<code class="kd">function</code> <code class="nx">serveStaticFile</code><code class="p">(</code><code class="nx">res</code><code class="p">,</code> <code class="nx">path</code><code class="p">,</code> <code class="nx">contentType</code><code class="p">,</code> <code class="nx">responseCode</code> <code class="o">=</code> <code class="mi">200</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="nx">__dirname</code> <code class="o">+</code> <code class="nx">path</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">500</code><code class="p">,</code> <code class="p">{</code> <code class="s1">'Content-Type'</code><code class="o">:</code> <code class="s1">'text/plain'</code> <code class="p">})</code>
      <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s1">'500 - Internal Error'</code><code class="p">)</code>
    <code class="p">}</code>
    <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="nx">responseCode</code><code class="p">,</code> <code class="p">{</code> <code class="s1">'Content-Type'</code><code class="o">:</code> <code class="nx">contentType</code> <code class="p">})</code>
    <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
  <code class="p">})</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">server</code> <code class="o">=</code> <code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code><code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// normalize url by removing querystring, optional trailing slash, and</code>
  <code class="c1">// making lowercase</code>
  <code class="kr">const</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">url</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/\/?(?:\?.*)?$/</code><code class="p">,</code> <code class="s1">''</code><code class="p">).</code><code class="nx">toLowerCase</code><code class="p">()</code>
  <code class="k">switch</code><code class="p">(</code><code class="nx">path</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">case</code> <code class="s1">''</code><code class="o">:</code>
      <code class="nx">serveStaticFile</code><code class="p">(</code><code class="nx">res</code><code class="p">,</code> <code class="s1">'/public/home.html'</code><code class="p">,</code> <code class="s1">'text/html'</code><code class="p">)</code>
      <code class="k">break</code>
    <code class="k">case</code> <code class="s1">'/about'</code><code class="o">:</code>
      <code class="nx">serveStaticFile</code><code class="p">(</code><code class="nx">res</code><code class="p">,</code> <code class="s1">'/public/about.html'</code><code class="p">,</code> <code class="s1">'text/html'</code><code class="p">)</code>
      <code class="k">break</code>
    <code class="k">case</code> <code class="s1">'/img/logo.png'</code><code class="o">:</code>
      <code class="nx">serveStaticFile</code><code class="p">(</code><code class="nx">res</code><code class="p">,</code> <code class="s1">'/public/img/logo.png'</code><code class="p">,</code> <code class="s1">'image/png'</code><code class="p">)</code>
      <code class="k">break</code>
    <code class="k">default</code><code class="o">:</code>
      <code class="nx">serveStaticFile</code><code class="p">(</code><code class="nx">res</code><code class="p">,</code> <code class="s1">'/public/404.html'</code><code class="p">,</code> <code class="s1">'text/html'</code><code class="p">,</code> <code class="mi">404</code><code class="p">)</code>
      <code class="k">break</code>
  <code class="p">}</code>
<code class="p">})</code>

<code class="nx">server</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`server started on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">; `</code> <code class="o">+</code>
  <code class="s1">'press Ctrl-C to terminate....'</code><code class="p">))</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>In this example, we’re being pretty unimaginative with our
routing. If you navigate to
<em>http://localhost:3000/about</em>, the <em>public/about.html</em> file is served.
You could change the route to be anything you want, and change the file to
be anything you want. For example, if you had a different About page for
each day of the week, you could have files <em>public/about_mon.html</em>,
<em>public/about_tue.html</em>, and so on, and provide logic in your routing to
serve the appropriate page when the user navigates to
<em>http://localhost:3000/about</em>.</p>
</div>

<p>Note we’ve created a helper function, <code>serveStaticFile</code>, that’s
doing the bulk of the work.
<a data-type="indexterm" data-primary="fs.readFile" id="idm45053605047704"/><code>fs.readFile</code> is an asynchronous method for reading files. There is a synchronous version of that function,
<code>fs.readFileSync</code>, but the sooner you start thinking asynchronously, the
better. <a data-type="indexterm" data-primary="callbacks" id="idm45053605046088"/>The <code>fs.readFile</code> function uses a pattern called <em>callbacks</em>.
You provide a function called a <em>callback function</em>, and when the work has
been done, that callback function is invoked (“called back,” so to speak).
In this case, <code>fs.readFile</code> reads the contents of the specified file and
executes the callback function when the file has been read; if the file
didn’t exist or there were permissions issues reading the file, the <code>err</code>
variable is set, and the function returns an HTTP status code of 500
indicating a server error. If the file is read
successfully, the file is sent to the client with the specified response
code and content type. Response codes will be discussed in more detail in
<a data-type="xref" href="ch06.xhtml#ch_the_request_and_response_objects">Chapter 6</a>.</p>
<div data-type="tip"><h6>Tip</h6>
<p><code>__dirname</code> will resolve to the directory the executing
script resides in. So if your script resides in <em>/home/sites/app.js</em>,
<code>__dirname</code> will resolve to <em>/home/sites</em>. It’s a good idea to
use this handy global whenever possible. Failing to do so can cause
hard-to-diagnose errors if you run your app from a different directory<a data-type="indexterm" data-startref="ix_ch-02-getting_started_with_node-asciidoc4" id="idm45053605038728"/><a data-type="indexterm" data-startref="ix_ch-02-getting_started_with_node-asciidoc3" id="idm45053605037928"/>.<a data-type="indexterm" data-startref="ix_ch-02-getting_started_with_node-asciidoc2" id="idm45053605037096"/><a data-type="indexterm" data-startref="ix_ch-02-getting_started_with_node-asciidoc1" id="idm45053605036360"/></p>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Onward to Express"><div class="sect1" id="idm45053605760120">
<h1>Onward to Express</h1>

<p>So far, Node probably doesn’t seem that impressive to you. We’ve basically
replicated what Apache or IIS do for you automatically, but now you have
some insight into how Node does things and how much control you have. We
haven’t done anything particularly impressive, but you can see how we could
use this as a jumping-off point to do more sophisticated things.<a data-type="indexterm" data-startref="ix_ch-02-getting_started_with_node-asciidoc0" id="idm45053605033976"/> If we
continued down this road, writing more and more sophisticated Node
applications, you might very well end up with something that resembles
Express….</p>

<p>Fortunately, we don’t have to: Express already exists, and it saves you
from implementing a lot of time-consuming infrastructure. So now that
we’ve gotten a little Node experience under our belt, we’re ready to jump
into learning Express.</p>
</div></section>







<div data-type="footnotes"><p data-type="footnote" id="idm45053605785656"><sup><a href="ch02.xhtml#idm45053605785656-marker">1</a></sup> <a data-type="indexterm" data-primary="vim" id="idm45053605785256"/>These days, vi is essentially synonymous with vim (vi improved). On most systems, vi is aliased to vim, but I usually type <code>vim</code> to make sure I’m using vim.</p></div></div></section></div>



  </body></html>