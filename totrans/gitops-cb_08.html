<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 7. Argo CD" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_Argo_CD">
<h1><span class="label">Chapter 7. </span>Argo CD</h1>
<p>In the previous chapter, you learned about Tekton and other engines such as GitHub Actions to implement the <a data-primary="CI (continuous integration)" data-type="indexterm" id="idm45120826331552"/>continuous integration (CI) part of a project.</p>
<p>Although CI is important because it’s where you build the application and check that nothing has been broken (running unit tests, component tests, etc.), there is still a missing part: how to deploy this application to an environment (a Kubernetes cluster) using the GitOps methodology and not creating a script running <code>kubectl</code>/<code>helm</code> commands.</p>
<p>As Daniel Bryant puts it, “If you weren’t using SSH in the past to deploy your application in production, don’t use <code>kubectl</code> to do it in Kubernetes.”</p>
<p>In this chapter, we’ll introduce you to <a data-primary="Argo CD" data-type="indexterm" id="idm45120826328512"/><a data-primary="CD (continuous deployment)" data-secondary="Argo CD" data-type="indexterm" id="idm45120826327904"/><a data-primary="continuous deployment (CD)" data-see="CD (continuous deployment)" data-type="indexterm" id="idm45120826327056"/>Argo CD, a declarative, GitOps continuous delivery (CD) tool for Kubernetes.
In the first part of the section, we’ll see the deployment of an application using Argo CD (Recipes <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_7_1">7.1</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_7_2">7.2</a>).</p>
<p>Argo CD not only supports the deployment of plain Kubernetes manifests, but also the deployment of Kustomize projects (<a data-type="xref" href="#recipe_7_3">Recipe 7.3</a>) and Helm projects (<a data-type="xref" href="#recipe_7_4">Recipe 7.4</a>).</p>
<p>A typical operation done in Kubernetes is a rolling update to a new version of the container, and Argo CD integrates with another tool to make this process smooth (<a data-type="xref" href="#recipe_7_5">Recipe 7.5</a>).</p>
<p>Delivering complex applications might require some orchestration on when and how the application must be deployed and released (Recipes <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_7_7">7.7</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_7_8">7.8</a>).</p>
<p>We’ll see how to:</p>
<ul>
<li>
<p>Install and deploy the first application.</p>
</li>
<li>
<p>Use automatic deployment and self-healing applications.</p>
</li>
<li>
<p>Execute a rolling update when a new container is released.</p>
</li>
<li>
<p>Give an order on the execution.</p>
</li>
</ul>
<p>In this chapter, we are using the <code>https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code> GitHub repository as source directory.
To run it successfully in this chapter, you should fork it and use it in the YAML files provided in the examples.</p>
<section data-pdf-bookmark="7.1 Deploy an Application Using Argo CD" data-type="sect1"><div class="sect1" id="recipe_7_1">
<h1>7.1 Deploy an Application Using Argo CD</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120826311632">
<h2>Problem</h2>
<p>You want Argo CD to deploy <a data-primary="Argo CD" data-secondary="applications" data-tertiary="deploying" data-type="indexterm" id="Argo_app_deploy"/><a data-primary="applications" data-secondary="deployment" data-tertiary="Argo CD" data-type="indexterm" id="app_deploy_Argo"/><a data-primary="deployment" data-secondary="applications" data-tertiary="Argo CD" data-type="indexterm" id="deploy_app_Argo"/>an application defined in a Git repository.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120826305360">
<h2>Solution</h2>
<p>Create an <code>Application</code> resource to set up Argo CD to deploy the application.</p>
<p>To install <a data-primary="Argo CD" data-secondary="installing" data-type="indexterm" id="Argo_install"/>Argo CD, create the <code>argocd</code> namespace and apply the Argo CD installation manifest:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -n argocd <code class="se">\</code>
-f https://raw.githubusercontent.com/argoproj/argo-cd/v2.3.4/manifests/install.yaml</pre>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45120826291744">
<h5>Optional Steps</h5>
<p>It’s not mandatory to install the Argo CD CLI tool, or expose the Argo CD server service to access the Argo CD Dashboard. Still, in this book, we’ll use them in the recipes to show you the final result after applying the manifests.
So, although not mandatory, we encourage you to follow the next steps to be aligned with the book.</p>
<p>To install<a data-primary="argocd CLI tool, installing" data-type="indexterm" id="idm45120826296976"/> the <code>argocd</code> CLI tool, go to the <a href="https://oreil.ly/kU9LS">Argo CD CLI GitHub release page</a> and in the Assets section, download the tool for your platform.</p>
<p>After installing the <code>argocd</code> tool, the <code>argocd-server</code> Kubernetes Service needs to be exposed.
You can use any technique such as Ingress or set the service as <code>LoadBalancer</code> but we’ll use the <code>kubectl port-forwarding</code> to connect to the API server without exposing the service:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl port-forward svc/argocd-server -n argocd <code class="m">9090</code>:443</pre>
<p>At this point, you can access the Argo CD server using <em>http://localhost:9090</em>.</p>
<p>The initial <a data-primary="Argo CD" data-secondary="admin account, password" data-type="indexterm" id="idm45120826264112"/><a data-primary="passwords, Argo CD admin account" data-type="indexterm" id="idm45120826286960"/>password for the <code>admin</code> account is generated automatically in a secret named <code>argocd-initial-admin-secret</code> in the <code>argocd</code> namespace:</p>
<pre data-code-language="bash" data-type="programlisting"><code class="nv">argoPass</code><code class="o">=</code><code class="k">$(</code>kubectl -n argocd get secret argocd-initial-admin-secret -o <code class="nv">jsonpath</code><code class="o">=</code><code class="s2">"{.data.password}"</code> <code class="p">|</code> base64 -d<code class="k">)</code>

<code class="nv">argoURL</code><code class="o">=</code>localhost:9090

argocd login --insecure --grpc-web <code class="nv">$argoURL</code>  --username admin --password <code class="nv">$argoPass</code>

<code class="s1">'admin:login'</code> logged <code class="k">in</code> successfully</pre>
<p>You should use the same credentials to access the <a data-primary="Argo CD" data-secondary="installing" data-startref="Argo_install" data-type="indexterm" id="idm45120826257264"/>Argo CD UI.</p>
</div></aside>
<p>Let’s make Argo CD deploy a simple web application showing a box with a configured color.
The application is composed of three Kubernetes manifest files, including a <code>Namespace</code>, a <code>Deployment</code>, and a <code>Service</code> definition.</p>
<p>The files are located in the <a href="https://oreil.ly/DAH50">ch07/bgd</a> folder of the book’s repository.</p>
<p>All these files are known as an <code>Application</code> in Argo CD.
Therefore, you must define it as such to apply these manifests in your cluster.</p>
<p>Let’s check the<a data-primary="Application resource file (Argo CD)" data-type="indexterm" id="idm45120826217408"/> Argo CD <code>Application</code> resource file used for deploying the 
<span class="keep-together">application</span>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Application</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd-app</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO1-1" id="co_argo_cd_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">destination</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO1-2" id="co_argo_cd_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w">
</code><code class="w">    </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w"> </code><code class="w">
</code><code class="w">  </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO1-3" id="co_argo_cd_CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">source</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO1-4" id="co_argo_cd_CO1-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch07/bgd</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO1-5" id="co_argo_cd_CO1-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO1-6" id="co_argo_cd_CO1-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO1-1" id="callout_argo_cd_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Namespace where Argo CD is installed</p></dd>
<dt><a class="co" href="#co_argo_cd_CO1-2" id="callout_argo_cd_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Target cluster and namespace</p></dd>
<dt><a class="co" href="#co_argo_cd_CO1-3" id="callout_argo_cd_CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Installing the application in Argo CD’s default project</p></dd>
<dt><a class="co" href="#co_argo_cd_CO1-4" id="callout_argo_cd_CO1-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>The manifest repo where the YAML resides</p></dd>
<dt><a class="co" href="#co_argo_cd_CO1-5" id="callout_argo_cd_CO1-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>The path to look for manifests</p></dd>
<dt><a class="co" href="#co_argo_cd_CO1-6" id="callout_argo_cd_CO1-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></dt>
<dd><p>Branch to checkout</p></dd>
</dl>
<p>In the terminal window, run the following<a data-primary="Argo CD" data-secondary="applications" data-tertiary="registering" data-type="indexterm" id="idm45120826065584"/><a data-primary="applications" data-secondary="registering, Argo CD" data-type="indexterm" id="idm45120826064336"/> command to register the Argo CD 
<span class="keep-together">application</span>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f manual-bgd-app.yaml</pre>
<p>At this point, the application is registered as an Argo CD application.</p>
<p>You can check the status using either <code>argocd</code> or the UI; run the following command to list applications<a data-primary="applications" data-secondary="listing with Argo CD" data-type="indexterm" id="idm45120826054672"/><a data-primary="Argo CD" data-secondary="applications" data-tertiary="listing" data-type="indexterm" id="idm45120826054160"/> using the CLI too:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app list</pre>
<p>And the output is something like:</p>
<pre data-code-language="bash" data-type="programlisting">NAME     CLUSTER                         NAMESPACE  PROJECT  STATUS
bgd-app  https://kubernetes.default.svc  bgd        default  OutOfSync</pre>
<p>The important field here<a data-primary="STATUS field (Argo CD)" data-type="indexterm" id="idm45120826057632"/><a data-primary="Argo CD" data-secondary="STATUS field" data-type="indexterm" id="idm45120826026880"/> is <code>STATUS</code>.
It’s <code>OutOfSync</code>, which means the application is registered, and there is a drift between the current status (in this case, no application deployed) and the content in the Git repository (the application deployment files).</p>
<p>You’ll notice that no pods are running if you get all the pods from the <code>bgd</code> namespace:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods -n bgd

No resources found <code class="k">in</code> bgd namespace.</pre>
<p>Argo CD doesn’t synchronize<a data-primary="applications" data-secondary="synchronization (Argo CD)" data-type="indexterm" id="app_sync_Argo"/><a data-primary="Argo CD" data-secondary="applications" data-tertiary="synchronizing" data-type="indexterm" id="Argo_app_sync"/> the application automatically by default.
It just shows a divergence, and the user is free to fix it by triggering a synchronized operation.</p>
<p>With the CLI, you synchronize the application by running the following command in a terminal:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app sync bgd-app</pre>
<p>And the ouput of the command shows all the important information regarding the deployment:</p>
<pre data-code-language="bash" data-type="programlisting">Name:               bgd-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          bgd
URL:                https://openshift-gitops-server-openshift-gitops.apps.openshift.sotogcp.com/applications/bgd-app
Repo:               https://github.com/lordofthejars/gitops-cookbook-sc.git
Target:             main
Path:               ch07/bgd
SyncWindow:         Sync Allowed
Sync Policy:        &lt;none&gt;
Sync Status:        Synced to main <code class="o">(</code>384cd3d<code class="o">)</code>
Health Status:      Progressing

Operation:          Sync
Sync Revision:      384cd3d21c534e75cb6b1a6921a6768925b81244
Phase:              Succeeded
Start:              <code class="m">2022</code>-06-16 <code class="m">14</code>:45:12 +0200 CEST
Finished:           <code class="m">2022</code>-06-16 <code class="m">14</code>:45:13 +0200 CEST
Duration:           1s
Message:            successfully synced <code class="o">(</code>all tasks run<code class="o">)</code>

GROUP  KIND        NAMESPACE  NAME  STATUS   HEALTH       HOOK  MESSAGE
       Namespace   bgd        bgd   Running  Synced             namespace/bgd created
       Service     bgd        bgd   Synced   Healthy            service/bgd created
apps   Deployment  bgd        bgd   Synced   Progressing        deployment.apps/bgd created
       Namespace              bgd   Synced</pre>
<p>You can synchronize the application from the UI as well, by clicking the <code>SYNC</code> button as <a data-primary="applications" data-secondary="synchronization (Argo CD)" data-startref="app_sync_Argo" data-type="indexterm" id="idm45120825977744"/><a data-primary="Argo CD" data-secondary="applications" data-startref="Argo_app_sync" data-tertiary="synchronizing" data-type="indexterm" id="idm45120825961760"/>shown in <a data-type="xref" href="#fig-711">Figure 7-1</a>.</p>
<figure><div class="figure" id="fig-711">
<img alt="Sync button to synchronize the application" height="992" src="assets/gocb_0701.png" width="1237"/>
<h6><span class="label">Figure 7-1. </span>Argo CD web console</h6>
</div></figure>
<p class="less_space pagebreak-before">If you get all the pods from the <code>bgd</code> namespace, you’ll notice one pod running:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods -n bgd

NAME                   READY   STATUS    RESTARTS   AGE
bgd-788cb756f7-jll9n   <code class="m">1</code>/1     Running   <code class="m">0</code>          60s</pre>
<p>And the same for the Service:</p>
<pre data-code-language="bash" data-type="programlisting"><code>kubectl</code><code> </code><code>get</code><code> </code><code>services</code><code> </code><code>-n</code><code> </code><code>bgd</code><code>

</code><code>NAME</code><code>   </code><code>TYPE</code><code>        </code><code>CLUSTER-IP</code><code>      </code><code>EXTERNAL-IP</code><code>   </code><code>PORT</code><code class="o">(</code><code>S</code><code class="o">)</code><code>
</code><code>bgd</code><code>    </code><code>ClusterIP</code><code>   </code><code class="m">172</code><code>.30.35.199</code><code>   </code><code>&lt;</code><code>none&gt;</code><code>        </code><code class="m">8080</code><code>:32761/TCP</code><code> </code><a class="co" href="#callout_argo_cd_CO2-1" id="co_argo_cd_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO2-1" id="callout_argo_cd_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Exposed port is 32761</p></dd>
</dl>
<p>In the following sections, you’ll need to access the deployed service to validate that it’s deployed.
There are several ways to access services deployed to Minikube; for the following chapters, we use the Minikube IP and the exposed port of the service.</p>
<p>Run the following command in a terminal window to get <a data-primary="Minikube" data-secondary="IP, accessing" data-type="indexterm" id="idm45120825865840"/>the Minikube IP:</p>
<pre data-code-language="bash" data-type="programlisting">minikube ip -p gitops
<code class="m">192</code>.168.59.100</pre>
<p>Open a browser window, set the previous IP followed by the exposed port (in this example <code>192.168.59.100:32761</code>), and access the service to validate that the color of the circles in the box is blue, as shown in <a data-type="xref" href="#fig-712">Figure 7-2</a>.</p>
<figure><div class="figure" id="fig-712">
<img alt="Blue box application" height="568" src="assets/gocb_0704.png" width="704"/>
<h6><span class="label">Figure 7-2. </span>Deployed application</h6>
</div></figure>
</div></section>
<section class="less_space pagebreak-before" data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120826304448">
<h2>Discussion</h2>
<p>Now it’s time to update the<a data-primary="Argo CD" data-secondary="application deployment" data-tertiary="updating files" data-type="indexterm" id="idm45120825836048"/><a data-primary="deployment" data-secondary="updating" data-tertiary="deployment files" data-type="indexterm" id="idm45120825834800"/><a data-primary="applications" data-secondary="Argo CD" data-tertiary="updating deployment files" data-type="indexterm" id="idm45120825830608"/> application deployment files.
This time we will change the value of an environment variable defined in the <em>bgd-deployment.yaml</em> file.</p>
<p>Open <em>ch07/bgd/bgd-deployment.yaml</em> in your file editor and change the <code>COLOR</code> environment variable value from <code>blue</code> to <code>green</code>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/redhatworkshops/bgd:latest</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w"/>
<code class="w">    </code><code class="nt">env</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">COLOR</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"green"</code><code class="w"/></pre>
<p>In a terminal run the following commands to commit and push the file so the change is available for Argo CD:</p>
<pre data-code-language="bash" data-type="programlisting">git add .
git commit -m <code class="s2">"Updates color"</code>

git push origin main</pre>
<p>With the change <a data-primary="STATUS field (Argo CD)" data-type="indexterm" id="idm45120825777120"/><a data-primary="Argo CD" data-secondary="STATUS field" data-type="indexterm" id="idm45120825778624"/>pushed, check the status of the application again:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app list

NAME     CLUSTER                         NAMESPACE  PROJECT  STATUS
bgd-app  https://kubernetes.default.svc  bgd        default  Sync</pre>
<p>We see the application status is <code>Sync</code>.
This happens because Argo CD uses a polling approach to detect divergences between what’s deployed and what’s defined in Git.
After some time (by default, it’s 3 minutes), the application status will be <code>OutOfSync</code>:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app list
NAME     CLUSTER                         NAMESPACE  PROJECT  STATUS     HEALTH
bgd-app  https://kubernetes.default.svc  bgd        default  OutOfSync  Healthy</pre>
<p>To synchronize the changes, run the <code>sync</code> subcommand:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app sync bgd-app</pre>
<p>After some seconds, access the service and validate that the circles are green, as shown in <a data-type="xref" href="#fig-713">Figure 7-3</a>.</p>
<figure><div class="figure" id="fig-713">
<img alt="Green box application" height="462" src="assets/gocb_0705.png" width="968"/>
<h6><span class="label">Figure 7-3. </span>Deployed application</h6>
</div></figure>
<p>To remove the application, use the CLI tool or the UI:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app delete bgd-app</pre>
<p>Also, revert the changes done in the Git repository to get the initial version of the application and push<a data-primary="Argo CD" data-secondary="applications" data-startref="Argo_app_deploy" data-tertiary="deploying" data-type="indexterm" id="idm45120825664544"/><a data-primary="applications" data-secondary="deployment" data-startref="app_deploy_Argo" data-tertiary="Argo CD" data-type="indexterm" id="idm45120825663920"/><a data-primary="deployment" data-secondary="applications" data-startref="deploy_app_Argo" data-tertiary="Argo CD" data-type="indexterm" id="idm45120825729744"/> them:</p>
<pre data-code-language="bash" data-type="programlisting">git revert HEAD

git push origin main</pre>
</div></section>
</div></section>
<section data-pdf-bookmark="7.2 Automatic Synchronization" data-type="sect1"><div class="sect1" id="recipe_7_2">
<h1>7.2 Automatic Synchronization</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120825732672">
<h2>Problem</h2>
<p>You want Argo CD to <a data-primary="Argo CD" data-secondary="applications" data-tertiary="synchronizing" data-type="indexterm" id="Argo_app_synch"/>automatically update resources when there are changes.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120825639232">
<h2>Solution</h2>
<p>Use the <code>syncPolicy</code> <a data-primary="syncPolicy, Argo CD" data-type="indexterm" id="idm45120825644480"/><a data-primary="automated policy, Argo CD" data-type="indexterm" id="idm45120825643856"/><a data-primary="Argo CD" data-secondary="syncPolicy" data-type="indexterm" id="idm45120825643216"/><a data-primary="Argo CD" data-secondary="automated policy" data-type="indexterm" id="idm45120825642272"/>section with an <code>automated</code> policy.</p>
<p>Argo CD can automatically synchronize an application when it detects differences between the manifests in Git and the Kubernetes cluster.</p>
<p>A benefit of automatic sync is that there is no need to log in to the Argo CD API, with the security implications that involves (managing secrets, network, etc.), and the use of the <code>argocd</code> tool.
Instead, when a manifest is changed and pushed to the Git repository with the changes to the tracking Git repo, the manifests are automatically applied.</p>
<p>Let’s modify the previous Argo CD manifest file (<code>Application</code>), adding the <code>sync​Po⁠licy</code> section, so changes are deployed automatically:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Application</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd-app</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">destination</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w">
</code><code class="w">    </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w"> </code><code class="w">
</code><code class="w">  </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"> </code><code class="w">
</code><code class="w">  </code><code class="nt">source</code><code class="p">:</code><code class="w"> </code><code class="w">
</code><code class="w">    </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch07/bgd</code><code class="w">
</code><code class="w">    </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code><code class="w">
</code><code class="w">    </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w">
</code><code class="w">  </code><code class="nt">syncPolicy</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO3-1" id="co_argo_cd_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">automated</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO3-2" id="co_argo_cd_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO3-1" id="callout_argo_cd_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Starts the synchronization policy configuration section</p></dd>
<dt><a class="co" href="#co_argo_cd_CO3-2" id="callout_argo_cd_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Argo CD automatically syncs the repo</p></dd>
</dl>
<p>At this point, we can apply the <code>Application</code> file into a running cluster by running the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f bgd/bgd-app.yaml</pre>
<p>Now, Argo CD deploys the application without executing any other command.</p>
<p>Run the <code>kubectl</code> command or check in the Argo CD UI to validate that the deployment is happening:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods -n bgd

NAME                   READY   STATUS    RESTARTS   AGE
bgd-788cb756f7-jll9n   <code class="m">1</code>/1     Running   <code class="m">0</code>          60s</pre>
<p>Access the service and validate that the circles are blue, as shown in <a data-type="xref" href="#fig-721">Figure 7-4</a>.</p>
<figure><div class="figure" id="fig-721">
<img alt="Blue box application" height="568" src="assets/gocb_0704.png" width="704"/>
<h6><span class="label">Figure 7-4. </span>Deployed application</h6>
</div></figure>
<p class="pagebreak-before less_space">To remove the <a data-primary="Argo CD" data-secondary="applications" data-tertiary="removing" data-type="indexterm" id="idm45120825469264"/><a data-primary="applications" data-secondary="Argo CD" data-tertiary="removing" data-type="indexterm" id="idm45120825467984"/>application, use the CLI tool or the UI:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app delete bgd-app</pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120825638768">
<h2>Discussion</h2>
<p>Although Argo CD deploys applications automatically, it uses some default conservative strategies for safety reasons.</p>
<p>Two of these are the pruning of deleted resources and the self-healing of the application in case a change was made in the Kubernetes cluster directly instead of through Git.</p>
<p>By default, Argo CD will not delete (prune) <a data-primary="Argo CD" data-secondary="resources, pruning" data-type="indexterm" id="idm45120825422432"/><a data-primary="resources" data-secondary="pruning by Argo CD" data-type="indexterm" id="idm45120825421920"/>any resource when it detects that it is no longer available in Git, and it will be in an <code>OutOfSync</code> status.
If you want Argo CD to delete these resources, you can do it in two ways.</p>
<p>The first way is by manually invoking a sync with the <code>-prune</code> option:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app sync --prune</pre>
<p>The second way is letting Argo CD delete pruned resources automatically by setting the <code>prune</code> attribute to <code>true</code> in the <code>automated</code> section:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">syncPolicy</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">automated</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">prune</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO4-1" id="co_argo_cd_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO4-1" id="callout_argo_cd_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Enables automatic pruning</p></dd>
</dl>
<p>Another important concept affecting how the application is automatically updated is<a data-primary="Argo CD" data-secondary="applications" data-tertiary="self-healing" data-type="indexterm" id="Argo_app_selfheal"/><a data-primary="applications" data-secondary="Argo CD" data-tertiary="self-healing" data-type="indexterm" id="app_Argo_selfheal"/> self-healing.</p>
<p>Argo CD is configured not to correct any drift made manually in the cluster.
For example, Argo CD will let the execution of a <code>kubectl patch</code> directly in the cluster change any configuration parameter of the application.</p>
<p>Let’s see it in action.</p>
<p>The color of the circle is set as an environment variable (<code>COLOR</code>).</p>
<p>Now, let’s change the <code>COLOR</code> environment variable to <code>green</code> using the <code>kubectl patch</code> command.</p>
<p>Run the following command in the terminal:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl -n bgd patch deploy/bgd <code class="se">\</code>
--type<code class="o">=</code><code class="s1">'json'</code> -p<code class="o">=</code><code class="s1">'[{"op": "replace", "path": "/</code>
<code class="s1">spec/template/spec/containers/0/env/0/value", "value":"green"}]'</code></pre>
<p>Wait for the rollout to happen:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl rollout status deploy/bgd -n bgd</pre>
<p>If you refresh the browser, you should see green circles now, as shown in <a data-type="xref" href="#fig-722">Figure 7-5</a>.</p>
<figure><div class="figure" id="fig-722">
<img alt="Green box application" height="462" src="assets/gocb_0705.png" width="968"/>
<h6><span class="label">Figure 7-5. </span>Deployed application</h6>
</div></figure>
<p>Looking over the Argo CD sync status, you’ll see that it’s <code>OutOfSync</code> as the application and the definition in the Git repository (<code>COLOR: blue</code>) diverges.</p>
<p>Argo CD will not roll back to correct this drift as <a data-primary="selfHeal property (Argo CD)" data-type="indexterm" id="idm45120825324528"/>the <code>selfHeal</code> property default is set to <code>false</code>.</p>
<p>Let’s remove the application and deploy a new one, but set <code>selfHeal</code> to <code>true</code> in this case:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app delete bgd-app</pre>
<p>Let’s enable the <code>selfHealing</code> property, and repeat the experiment:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Application</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd-app</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">destination</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w">
</code><code class="w">    </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w"> </code><code class="w">
</code><code class="w">  </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"> </code><code class="w">
</code><code class="w">  </code><code class="nt">source</code><code class="p">:</code><code class="w"> </code><code class="w">
</code><code class="w">    </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch07/bgd</code><code class="w">
</code><code class="w">    </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code><code class="w">
</code><code class="w">    </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w">
</code><code class="w">  </code><code class="nt">syncPolicy</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">automated</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">prune</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w">
</code><code class="w">      </code><code class="nt">selfHeal</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO5-1" id="co_argo_cd_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO5-1" id="callout_argo_cd_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p><code>selfHeal</code> set to <code>true</code> to correct any drift</p></dd>
</dl>
<p>And in the terminal apply the resource:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f bgd/heal-bgd-app.yaml</pre>
<p class="less_space pagebreak-before">Repeat the previous steps:</p>
<ol>
<li>
<p>Open the browser to check that the circles are blue.</p>
</li>
<li>
<p>Reexecute the <code>kubectl -n bgd patch deploy/bgd ...</code> command.</p>
</li>
<li>
<p>Refresh the browser and check that the circles are still blue.</p>
</li>
</ol>
<p>Argo CD corrects the drift introduced by the <code>patch</code> command, synchronizing the application to the correct state defined in the Git repository.</p>
<p>To <a data-primary="Argo CD" data-secondary="applications" data-startref="Argo_app_selfheal" data-tertiary="self-healing" data-type="indexterm" id="idm45120825130096"/><a data-primary="applications" data-secondary="Argo CD" data-startref="app_Argo_selfheal" data-tertiary="self-healing" data-type="indexterm" id="idm45120825128768"/><a data-primary="Argo CD" data-secondary="applications" data-startref="Argo_app_synch" data-tertiary="synchronizing" data-type="indexterm" id="idm45120825127280"/>remove the application, use the CLI tool or the UI:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app delete bgd-app</pre>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120825181984">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/mw4b2">Argo CD Automated Sync Policy</a></p>
</li>
<li>
<p><a href="https://oreil.ly/wIleG">Argo CD Sync Options</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="7.3 Kustomize Integration" data-type="sect1"><div class="sect1" id="recipe_7_3">
<h1>7.3 Kustomize Integration</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120825121888">
<h2>Problem</h2>
<p>You want to use Argo CD to deploy<a data-primary="Argo CD" data-secondary="Kustomize manifests, deploying" data-type="indexterm" id="Argo_Kustmani_deploy"/><a data-primary="Kustomize" data-secondary="manifests, deploying with Argo CD" data-type="indexterm" id="Kust_mani_deployArgo"/><a data-primary="manifests" data-secondary="Kustomize, deploying with Argo CD" data-type="indexterm" id="mani-Kust_deployArgo"/> Kustomize manifests.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120825099392">
<h2>Solution</h2>
<p>Argo CD supports several different ways in which Kubernetes manifests can be defined:</p>
<ul>
<li>
<p>Kustomize</p>
</li>
<li>
<p>Helm</p>
</li>
<li>
<p>Ksonnet</p>
</li>
<li>
<p>Jsonnet</p>
</li>
</ul>
<p>You can also extend the supported ways to custom ones, but this is out of the scope of this book.</p>
<p>Argo CD detects a Kustomize project if there are any of the following files:  <em>kustomization.yaml</em>, <em>kustomization.yml</em>, or <em>Kustomization</em>.</p>
<p>Let’s deploy the same BGD application, but in this case, deployed as Kustomize manifests.</p>
<p>Moreover, we’ll set <code>kustomize</code> to override the <code>COLOR</code> environment variable to yellow.</p>
<p>The Kustomize file defined in the repository looks like this:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kustomize.config.k8s.io/v1beta1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Kustomization</code><code class="w">
</code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdk</code><code class="w">
</code><code class="nt">resources</code><code class="p">:</code><code class="w">
</code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">../base</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO6-1" id="co_argo_cd_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">bgdk-ns.yaml</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO6-2" id="co_argo_cd_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="nt">patchesJson6902</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO6-3" id="co_argo_cd_CO6-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">target</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO6-4" id="co_argo_cd_CO6-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="w">      </code><code class="nt">group</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps</code><code class="w">
</code><code class="w">      </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w">
</code><code class="w">      </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdk</code><code class="w">
</code><code class="w">    </code><code class="nt">patch</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="p-Indicator">-</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO6-5" id="co_argo_cd_CO6-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="no">- op: replace</code><code class="w">
</code><code class="w">        </code><code class="no">path: /spec/template/spec/containers/0/env/0/value</code><code class="w">
</code><code class="w">        </code><code class="no">value: yellow</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO6-1" id="callout_argo_cd_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Directory with standard deployment files (blue circles)</p></dd>
<dt><a class="co" href="#co_argo_cd_CO6-2" id="callout_argo_cd_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Specific file for creating a namespace</p></dd>
<dt><a class="co" href="#co_argo_cd_CO6-3" id="callout_argo_cd_CO6-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Patches standard deployment files</p></dd>
<dt><a class="co" href="#co_argo_cd_CO6-4" id="callout_argo_cd_CO6-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Patches the deployment file</p></dd>
<dt><a class="co" href="#co_argo_cd_CO6-5" id="callout_argo_cd_CO6-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Overrides the environment variable value to <code>yellow</code></p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You don’t need to create this file as it’s already stored in the Git repository.</p>
</div>
<p>Create the following <code>Application</code> file to deploy the application:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Application</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdk-app</code><code class="w"/>
<code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">destination</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdk</code><code class="w"/>
<code class="w">    </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w"> </code>
<code class="w">  </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"> </code>
<code class="w">  </code><code class="nt">source</code><code class="p">:</code><code class="w"> </code>
<code class="w">    </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch07/bgdk/bgdk</code><code class="w"/>
<code class="w">    </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code><code class="w"/>
<code class="w">    </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w"/>
<code class="w">  </code><code class="nt">syncPolicy</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">automated</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/></pre>
<p>At this point, we can apply the <code>Application</code> file to a running cluster by running the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f bgdk/bgdk-app.yaml</pre>
<p>Access the service and you’ll notice the circles are yellow instead of blue.</p>
<p>To remove the application, use the CLI tool or the UI:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app delete bgdk-app</pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120825098896">
<h2>Discussion</h2>
<p>We can explicitly specify which tool to use, overriding the default algorithm used by Argo CD in the <code>Application</code> file.
For example, we can use a plain directory strategy regarding the presence of the <em>kustomization.yaml</em> file:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">source</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">directory</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO7-1" id="co_argo_cd_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">recurse</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO7-1" id="callout_argo_cd_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Overrides always use a plain directory strategy</p></dd>
</dl>
<p>Possible strategies are: <code>directory</code>, <code>chart</code>, <code>helm</code>, <code>kustomize</code>, <code>path</code>, and <code>plugin</code>.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Everything we’ve seen about Kustomize is valid when using<a data-primary="Argo CD" data-secondary="Kustomize manifests, deploying" data-startref="Argo_Kustmani_deploy" data-type="indexterm" id="idm45120824754208"/><a data-primary="Kustomize" data-secondary="manifests, deploying with Argo CD" data-startref="Kust_mani_deployArgo" data-type="indexterm" id="idm45120824731280"/><a data-primary="manifests" data-secondary="Kustomize, deploying with Argo CD" data-startref="mani-Kust_deployArgo" data-type="indexterm" id="idm45120824730192"/> Argo CD.</p>
</div>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120824728720">
<h2>See Also</h2>
<ul>
<li>
<p><a data-type="xref" href="ch04.xhtml#ch_Kustomize">Chapter 4</a></p>
</li>
<li>
<p><a href="https://oreil.ly/EIxY1">argo-cd/application-crd.yaml on GitHub</a></p>
</li>
<li>
<p><a href="https://oreil.ly/DJbiU">Argo CD Tool Detection</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="7.4 Helm Integration" data-type="sect1"><div class="sect1" id="recipe_7_4">
<h1>7.4 Helm Integration</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120824722192">
<h2>Problem</h2>
<p>You want to use<a data-primary="Argo CD" data-secondary="Helm manifests, deploying" data-type="indexterm" id="Argo_Helmmani_deploy"/><a data-primary="Helm" data-secondary="manifests, deploying with Argo CD" data-type="indexterm" id="Helm_mani_deployArgo"/><a data-primary="manifests" data-secondary="Helm, deploying with Argo CD" data-type="indexterm" id="mani-Helm_deployArgo"/> Argo CD to deploy Helm manifests.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120824716832">
<h2>Solution</h2>
<p>Argo CD supports installing Helm Charts to the cluster when it detects a Helm project in the deployment directory (when the <em>Chart.yaml</em> file is present).</p>
<p>Let’s deploy the same BGD application, but in this case, deployed as a Helm manifest.</p>
<p>The layout of the project is a simple Helm layout already created in the GitHub repository you’ve cloned previously:</p>
<pre data-code-language="bash" data-type="programlisting">├── Chart.yaml
├── charts
├── templates
│   ├── NOTES.txt
│   ├── _helpers.tpl
│   ├── deployment.yaml
│   ├── ns.yaml
│   ├── service.yaml
│   ├── serviceaccount.yaml
│   └── tests
│       └── test-connection.yaml
└── values.yaml</pre>
<p>Create a <em>bgdh/bgdh-app.yaml</em> file to define the Argo CD application:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Application</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdh-app</code><code class="w"/>
<code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">destination</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdh</code><code class="w"/>
<code class="w">    </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w"> </code>
<code class="w">  </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"> </code>
<code class="w">  </code><code class="nt">source</code><code class="p">:</code><code class="w"> </code>
<code class="w">    </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch07/bgdh</code><code class="w"/>
<code class="w">    </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code><code class="w"/>
<code class="w">    </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w"/>
<code class="w">  </code><code class="nt">syncPolicy</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">automated</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/></pre>
<p>At this point, we can apply the <code>Application</code> file into a running cluster by running the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f bgdh/bgdh-app.yaml</pre>
<p>Validate the pod is running in the <code>bgdh</code> namespace:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods -n bgdh

NAME                        READY   STATUS    RESTARTS   AGE
bgdh-app-556c46fcd6-ctfkf   <code class="m">1</code>/1     Running   <code class="m">0</code>          5m43s</pre>
<p class="less_space pagebreak-before">To remove the application, use the CLI tool or the UI:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app delete bgdh-app</pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120824609488">
<h2>Discussion</h2>
<p>Argo CD populates build environment variables to Helm manifests (actually also Kustomize, Jsonnet, and custom tools support too).</p>
<p>The following variables are set:</p>
<ul>
<li>
<p><code>ARGOCD_APP_NAME</code></p>
</li>
<li>
<p><code>ARGOCD_APP_NAMESPACE</code></p>
</li>
<li>
<p><code>ARGOCD_APP_REVISION</code></p>
</li>
<li>
<p><code>ARGOCD_APP_SOURCE_PATH</code></p>
</li>
<li>
<p><code>ARGOCD_APP_SOURCE_REPO_URL</code></p>
</li>
<li>
<p><code>ARGOCD_APP_SOURCE_TARGET_REVISION</code></p>
</li>
<li>
<p><code>KUBE_VERSION</code></p>
</li>
<li>
<p><code>KUBE_API_VERSIONS</code></p>
</li>
</ul>
<p>In the following snippet, you can see the usage of the application name:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Application</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdh-app</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">openshift-gitops</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">destination</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p">...</code><code class="w">
</code><code class="w">  </code><code class="nt">source</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch07/bgd</code><code class="w">
</code><code class="w">    </code><code class="p">...</code><code class="w">
</code><code class="w">    </code><code class="nt">helm</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO8-1" id="co_argo_cd_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">parameters</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO8-2" id="co_argo_cd_CO8-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO8-3" id="co_argo_cd_CO8-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">        </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$ARGOCD_APP_NAME</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO8-4" id="co_argo_cd_CO8-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO8-1" id="callout_argo_cd_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Specific Helm section</p></dd>
<dt><a class="co" href="#co_argo_cd_CO8-2" id="callout_argo_cd_CO8-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Extra parameters to set, same as setting them in <em>values.yaml</em>, but high preference</p></dd>
<dt><a class="co" href="#co_argo_cd_CO8-3" id="callout_argo_cd_CO8-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>The name of the parameter</p></dd>
<dt><a class="co" href="#co_argo_cd_CO8-4" id="callout_argo_cd_CO8-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>The value of the parameter, in this case from a Build Env var</p></dd>
</dl>
<p>Argo CD can use a different <em>values.yaml</em> file or set parameter values to override the ones defined in <em>values.yaml</em>:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app <code class="nb">set</code> bgdh-app --values new-values.yaml

argocd app <code class="nb">set</code> bgdh-app -p service.type<code class="o">=</code>LoadBalancer</pre>
<p>Note that values files must be in the same Git repository as the Helm Chart.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Argo CD <a data-primary="Argo CD" data-secondary="Helm hooks" data-type="indexterm" id="idm45120824367408"/><a data-primary="Helm" data-secondary="hooks, Argo CD support" data-type="indexterm" id="idm45120824366432"/>supports Helm hooks <a data-primary="Argo CD" data-secondary="Helm manifests, deploying" data-startref="Argo_Helmmani_deploy" data-type="indexterm" id="idm45120824381712"/><a data-primary="Helm" data-secondary="manifests, deploying with Argo CD" data-startref="Helm_mani_deployArgo" data-type="indexterm" id="idm45120824380608"/><a data-primary="manifests" data-secondary="Helm, deploying with Argo CD" data-startref="mani-Helm_deployArgo" data-type="indexterm" id="idm45120824379424"/>too.</p>
</div>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120824610640">
<h2>See Also</h2>
<ul>
<li>
<p><a data-type="xref" href="ch05.xhtml#ch_Helm">Chapter 5</a></p>
</li>
<li>
<p><a href="https://oreil.ly/EIxY1"><em>argo-cd/application-crd.yaml</em> on GitHub</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="7.5 Image Updater" data-type="sect1"><div class="sect1" id="recipe_7_5">
<h1>7.5 Image Updater</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120824359616">
<h2>Problem</h2>
<p>You want Argo CD to automatically deploy a container image when it’s published.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120824358000">
<h2>Solution</h2>
<p>Use <a href="https://oreil.ly/kztMq">Argo CD Image Updater</a> to detect <a data-primary="Argo CD" data-secondary="container images, updating automatically" data-type="indexterm" id="Argo_contimg_updatauto"/><a data-primary="container images" data-secondary="updating" data-tertiary="automatically with Argo CD" data-type="indexterm" id="contimg_update_Argo"/>a change on the container registry and update the deployment files.</p>
<p>One of the most repetitive tasks during development is deploying a new version of a container image.</p>
<p>With a pure Argo CD solution, after the container image is published to a container registry, we need to update the Kubernetes/Kustomize/Helm manifest files pointing to the new container image and push the result to the Git repository.</p>
<p>This process implies:</p>
<ol>
<li>
<p>Clone the repo</p>
</li>
<li>
<p>Parse the YAML files and update them accordingly</p>
</li>
<li>
<p>Commit and Push the changes</p>
</li>
</ol>
<p>These boilerplate tasks should be defined for each repository during the continuous integration phase.
Although this approach works, it could be automated so the cluster could detect a new image pushed to the container registry and update the current deployment file pointing to the newer version.</p>
<p>This is exactly what <a data-primary="Argo CD Image Updater" data-type="indexterm" id="idm45120824334144"/>Argo CD Image Updater (<em>ArgoCD IU</em>) does.
It’s a Kubernetes controller monitoring for a new container version and updating the manifests defined in the Argo CD <code>Application</code> file.</p>
<p>The Argo CD IU lifecycle and its relationship with Argo CD are shown in <a data-type="xref" href="#fig-751">Figure 7-6</a>.</p>
<figure><div class="figure" id="fig-751">
<img alt="Lifecycle of Argo CD and Argo CD Image Updater" height="799" src="assets/gocb_0706.png" width="1366"/>
<h6><span class="label">Figure 7-6. </span>Argo CD Image Updater lifecycle</h6>
</div></figure>
<p>At this time, Argo CD IU only updates manifests of Kustomize or Helm.
In the case of Helm, it needs to support specifying the image’s tag using a parameter (<code>image.tag</code>).</p>
<p>Let’s install the <a data-primary="Argo CD Image Updater" data-secondary="installing" data-type="indexterm" id="idm45120824327888"/>controller in the same namespace as Argo CD:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f <code class="se">\</code>
https://raw.githubusercontent.com/argoproj-labs/argocd-imageupdater/v0.12.0/manifests/install.yaml -n argocd</pre>
<p>Validate the installation process, checking that the pod status of the controller is <code>Running</code>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods -n argocd

NAME                                                         READY   STATUS    RESTARTS   AGE
argocd-image-updater-59c45cbc5c-kjjtp                        <code class="m">1</code>/1     Running   <code class="m">0</code>          40h</pre>
<p>Before using Argo CD IU, we create a Kubernetes Secret representing the Git credentials, so the updated manifests can be pushed to the repository.
The secret must be at the Argo CD namespace and, in this case, we name it <code>git-creds</code>.</p>
<pre data-code-language="bash" data-type="programlisting">kubectl -n argocd create secret generic git-creds <code class="se">\ </code>--from-literal<code class="o">=</code><code class="nv">username</code><code class="o">=</code>&lt;git_user&gt; <code class="se">\</code>
--from-literal<code class="o">=</code><code class="nv">password</code><code class="o">=</code>&lt;git_password_or_token&gt;</pre>
<p>Finally, let’s annotate the <code>Application</code> manifest with some special annotations so the controller can start monitoring the registry:</p>
<dl>
<dt>image-list</dt>
<dd>
<p>Specify one or more images (comma-separated-value) considered for updates.</p>
</dd>
<dt>write-back-method</dt>
<dd>
<p>Methods to propagate new versions. There are <code>git</code> and <code>argocd</code> methods implemented to update to a newer image. The Git method commits the change to the Git repository. Argo CD uses the Kubernetes/ArgoCD API to update the resource.</p>
</dd>
</dl>
<p>There are more <a data-primary="Argo CD Image Updater" data-secondary="configuration options" data-type="indexterm" id="idm45120824263920"/>configuration options, but the previous ones are the most important to get started.</p>
<p>Let’s create an Argo CD <code>Application</code> manifest annotated <a data-primary="Argo CD" data-secondary="manifests" data-tertiary="annotations" data-type="indexterm" id="idm45120824261984"/><a data-primary="manifests" data-secondary="Argo CD IU annotations" data-type="indexterm" id="idm45120824260704"/>with Argo CD IU 
<span class="keep-together">annotations</span>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Application</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdk-app</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w">
</code><code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO9-1" id="co_argo_cd_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">argocd-image-updater.argoproj.io/image-list</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">myalias=quay.io/rhdevelopers/bgd</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO9-2" id="co_argo_cd_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">argocd-image-updater.argoproj.io/write-back-method</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git:secret:openshift-gitops/git-creds</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO9-3" id="co_argo_cd_CO9-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">argocd-image-updater.argoproj.io/git-branch</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO9-4" id="co_argo_cd_CO9-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">destination</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">bgdk</code><code class="w">
</code><code class="w">    </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w"> </code><code class="w">
</code><code class="w">  </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"> </code><code class="w">
</code><code class="w">  </code><code class="nt">source</code><code class="p">:</code><code class="w"> </code><code class="w">
</code><code class="w">    </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch07/bgdui/bgdk</code><code class="w">
</code><code class="w">    </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code><code class="w">
</code><code class="w">    </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w">
</code><code class="w">  </code><code class="nt">syncPolicy</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">automated</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO9-1" id="callout_argo_cd_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Adds annotations section</p></dd>
<dt><a class="co" href="#co_argo_cd_CO9-2" id="callout_argo_cd_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Sets the monitored image name</p></dd>
<dt><a class="co" href="#co_argo_cd_CO9-3" id="callout_argo_cd_CO9-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Configures to use Git as <code>write-back-method</code>, setting the location of the credentials (<code>&lt;namespace&gt;/&lt;secretname&gt;</code>)</p></dd>
<dt><a class="co" href="#co_argo_cd_CO9-4" id="callout_argo_cd_CO9-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Sets the branch to push changes</p></dd>
</dl>
<p>Now apply the manifest to deploy the application’s first version and enable Argo CD IU to update the repository when a new image is pushed to the container registry:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply -f bgdui/bgdui-app.yaml</pre>
<p>At this point, version 1.0.0 is up and running in the <code>bgdk</code> namespace, and you may access it as we’ve done before.
Let’s generate a new container version to validate that the new image is in the repository.</p>
<p>To simplify the process, we’ll tag the container with version <code>1.1.0</code> as it was a new one.</p>
<p>Go to the Quay repository created at the beginning of this chapter, go to the tags section, push the gear icon, and select <code>Add New Tag</code> to create a new container, as shown in <a data-type="xref" href="#fig-752">Figure 7-7</a>.</p>
<figure class="width-75"><div class="figure" id="fig-752">
<img alt="Creating a new Tag in Quay" height="494" src="assets/gocb_0707.png" width="1434"/>
<h6><span class="label">Figure 7-7. </span>Tag container</h6>
</div></figure>
<p>Set the tag to <code>1.1.0</code> value as shown in the figure <a data-type="xref" href="#fig-753">Figure 7-8</a>.</p>
<figure><div class="figure" id="fig-753">
<img alt="Sets the new tag" height="428" src="assets/gocb_0708.png" width="1260"/>
<h6><span class="label">Figure 7-8. </span>Tag container</h6>
</div></figure>
<p>After this step, you should have a new container created as shown in <a data-type="xref" href="#fig-754">Figure 7-9</a>.</p>
<p>Wait for around two minutes until the change is detected and the controller triggers the repo update.</p>
<figure><div class="figure" id="fig-754">
<img alt="A new container is placed in Quay repo" height="806" src="assets/gocb_0709.png" width="2393"/>
<h6><span class="label">Figure 7-9. </span>Final result</h6>
</div></figure>
<p>To validate the triggering process check the logs of the controller:</p>
<pre data-code-language="bash" data-type="programlisting"><code>kubectl</code><code> </code><code>logs</code><code> </code><code>argocd-image-updater-59c45cbc5c-kjjtp</code><code> </code><code>-f</code><code> </code><code>-n</code><code> </code><code>argocd</code><code>

</code><code>...</code><code>
</code><code class="nv">time</code><code class="o">=</code><code class="s2">"2022-06-20T21:19:05Z"</code><code> </code><code class="nv">level</code><code class="o">=</code><code>info</code><code> </code><code class="nv">msg</code><code class="o">=</code><code class="s2">"Setting new image to quay.io/rhdevelopers/bgd:1.1.0"</code><code> </code><code class="nv">alias</code><code class="o">=</code><code>myalias</code><code> </code><code class="nv">application</code><code class="o">=</code><code>bgdk-app</code><code> </code><code class="nv">image_name</code><code class="o">=</code><code>rhdevelopers/bgd</code><code> </code><code class="nv">image_tag</code><code class="o">=</code><code class="m">1</code><code>.0.0</code><code> </code><code class="nv">registry</code><code class="o">=</code><code>quay.io</code><code>
</code><code class="nv">time</code><code class="o">=</code><code class="s2">"2022-06-20T21:19:05Z"</code><code> </code><code class="nv">level</code><code class="o">=</code><code>info</code><code> </code><code class="nv">msg</code><code class="o">=</code><code class="s2">"Successfully updated image 'quay.io/rhdevelopers/bgd:1.0.0' to 'quay.io/rhdevelopers/bgd:1.1.0', but pending spec update (dry run=false)"</code><code> </code><code class="nv">alias</code><code class="o">=</code><code>myalias</code><code> </code><code class="nv">application</code><code class="o">=</code><code>bgdk-app</code><code> </code><code class="nv">image_name</code><code class="o">=</code><code>rhdevelopers/bgd</code><code> </code><code class="nv">image_tag</code><code class="o">=</code><code class="m">1</code><code>.0.0</code><code> </code><code class="nv">registry</code><code class="o">=</code><code>quay.io</code><code> </code><a class="co" href="#callout_argo_cd_CO10-1" id="co_argo_cd_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code class="nv">time</code><code class="o">=</code><code class="s2">"2022-06-20T21:19:05Z"</code><code> </code><code class="nv">level</code><code class="o">=</code><code>info</code><code> </code><code class="nv">msg</code><code class="o">=</code><code class="s2">"Committing 1 parameter update(s) for application bgdk-app"</code><code> </code><code class="nv">application</code><code class="o">=</code><code>bgdk-app</code><code>
</code><code>...</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO10-1" id="callout_argo_cd_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Detects the change and updates the image</p></dd>
</dl>
<p>After that, if you inspect the repository, you’ll see a new Kustomize file named <code>.argocd-source-bgdk-app.yaml</code>, updating the image value to the new container, as shown in <a data-type="xref" href="#fig-755">Figure 7-10</a>.</p>
<figure><div class="figure" id="fig-755">
<img alt="New Kustomize file updating to the new container" height="614" src="assets/gocb_0710.png" width="1871"/>
<h6><span class="label">Figure 7-10. </span>New Kustomize file updating to the new container</h6>
</div></figure>
<p>Now Argo CD can detect the change and update the cluster properly with the new image.</p>
<p>To remove the application, use the CLI tool or the UI:</p>
<pre data-code-language="bash" data-type="programlisting">argocd app delete bgdk-app</pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120823969632">
<h2>Discussion</h2>
<p>An update strategy defines how Argo CD IU will find new versions.
With no change, Argo CD IU uses a semantic version to detect the latest version.</p>
<p>An optional version constraint field may<a data-primary="Argo CD Image Updater" data-secondary="version constraint field" data-type="indexterm" id="idm45120824342288"/> be added to restrict which versions are allowed to be automatically updated.
To only update patch versions, we can change the <code>image-list</code> annotation as shown in the following snippet:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">argocd-image-updater.argoproj.io/image-list</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">myalias=quay.io/rhdevelopers/bgd:1.2.x</code><code class="w"/></pre>
<p>Argo CD Image Updater can update to the image that has the most recent build date:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">argocd-image-updater.argoproj.io/myalias.update-strategy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">latest</code><code class="w">
</code><code class="nt">argocd-image-updater.argoproj.io/myimage.allow-tags</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">regexp:^[0-9a-f]{7}$</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO11-1" id="co_argo_cd_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO11-1" id="callout_argo_cd_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Restricts the tags considered for the update</p></dd>
</dl>
<p>The digest update strategy will use image digests to update your applications’ image tags:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">argocd-image-updater.argoproj.io/myalias.update-strategy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">digest</code><code class="w"/></pre>
<p>So far, the container was stored in a public registry. If the repository is private, Argo CD Image Updater <a data-primary="Argo CD Image Updater" data-secondary="repository read access" data-type="indexterm" id="idm45120823849216"/>needs read access to the repo to detect any change.</p>
<p>First of all, create a new secret representing the container registry credentials:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -n argocd secret docker-registry quayio --docker-server<code class="o">=</code>quay.io --docker-username<code class="o">=</code><code class="nv">$QUAY_USERNAME</code> --docker-password<code class="o">=</code><code class="nv">$QUAY_PASSWORD</code></pre>
<p>Argo CD Image Updater <a data-primary="Argo CD Image Updater" data-secondary="ConfigMap" data-type="indexterm" id="idm45120823843024"/><a data-primary="ConfigMap" data-secondary="Argo CD Image Updater" data-type="indexterm" id="idm45120823842176"/>uses a <code>ConfigMap</code> as a configuration source, which is the place to register the private container registry.
Create a new <code>ConfigMap</code> manifest setting the supported registries:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ConfigMap</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd-image-updater-config</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO12-1" id="co_argo_cd_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="nt">data</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">registries.conf</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w">
</code><code class="w">    </code><code class="no">registries: </code><a class="co" href="#callout_argo_cd_CO12-2" id="co_argo_cd_CO12-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="no">- name: RedHat Quay </code><a class="co" href="#callout_argo_cd_CO12-3" id="co_argo_cd_CO12-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="no">api_url: https://quay.io </code><a class="co" href="#callout_argo_cd_CO12-4" id="co_argo_cd_CO12-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="no">prefix: quay.io </code><a class="co" href="#callout_argo_cd_CO12-5" id="co_argo_cd_CO12-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="no">insecure: yes</code><code class="w">
</code><code class="w">      </code><code class="no">credentials: pullsecret:argocd/quayio </code><a class="co" href="#callout_argo_cd_CO12-6" id="co_argo_cd_CO12-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO12-1" id="callout_argo_cd_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Name of the Argo CD IU <code>ConfigMap</code></p></dd>
<dt><a class="co" href="#co_argo_cd_CO12-2" id="callout_argo_cd_CO12-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Place to register all registries</p></dd>
<dt><a class="co" href="#co_argo_cd_CO12-3" id="callout_argo_cd_CO12-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>A name to identify it</p></dd>
<dt><a class="co" href="#co_argo_cd_CO12-4" id="callout_argo_cd_CO12-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>URL of the service</p></dd>
<dt><a class="co" href="#co_argo_cd_CO12-5" id="callout_argo_cd_CO12-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>The prefix used in the container images</p></dd>
<dt><a class="co" href="#co_argo_cd_CO12-6" id="callout_argo_cd_CO12-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></dt>
<dd><p>Gets the credentials from the <code>quayio</code> secret stored at <code>argocd</code> namespace</p></dd>
</dl>
<p>Argo CD Image Updater commits the update with a default message:</p>
<pre data-code-language="bash" data-type="programlisting">commit 3caf0af8b7a26de70a641c696446bbe1cd04cea8 <code class="o">(</code>HEAD -&gt; main, origin/main<code class="o">)</code>
Author: argocd-image-updater &lt;noreply@argoproj.io&gt;
Date:   Thu Jun <code class="m">23</code> <code class="m">09</code>:41:00 <code class="m">2022</code> +0000

    build: automatic update of bgdk-app

    updates image rhdevelopers/bgd tag <code class="s1">'1.0.0'</code> to <code class="s1">'1.1.0'</code></pre>
<p>We can update the <a data-primary="Argo CD Image Updater" data-secondary="default commit message" data-type="indexterm" id="idm45120823678624"/>default commit message to one that fits your requirements.
Configure the <code>git.commit-message-template</code> key in ArgoCD IU <code>argocd-image-updater-config</code> <code>ConfigMap</code> with the message:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ConfigMap</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd-image-updater-config</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO13-1" id="co_argo_cd_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="nt">data</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">git.user</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">alex</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO13-2" id="co_argo_cd_CO13-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">git.email</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">alex@example.com</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO13-3" id="co_argo_cd_CO13-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">git.commit-message-template</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO13-4" id="co_argo_cd_CO13-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="no">build: automatic update of {{ .AppName }} </code><a class="co" href="#callout_argo_cd_CO13-5" id="co_argo_cd_CO13-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="no">{{ range .AppChanges -}} </code><a class="co" href="#callout_argo_cd_CO13-6" id="co_argo_cd_CO13-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="no">updates image {{ .Image }} tag '{{ .OldTag }}' to '{{ .NewTag }}' </code><a class="co" href="#callout_argo_cd_CO13-7" id="co_argo_cd_CO13-7"><img alt="7" height="12" src="assets/7.png" width="12"/></a><code class="no"> </code><a class="co" href="#callout_argo_cd_CO13-8" id="co_argo_cd_CO13-8"><img alt="8" height="12" src="assets/8.png" width="12"/></a><code class="no"> </code><a class="co" href="#callout_argo_cd_CO13-9" id="co_argo_cd_CO13-9"><img alt="9" height="12" src="assets/9.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="no">{{ end -}}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO13-1" id="callout_argo_cd_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Argo CD IU <code>ConfigMap</code></p></dd>
<dt><a class="co" href="#co_argo_cd_CO13-2" id="callout_argo_cd_CO13-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Commit user</p></dd>
<dt><a class="co" href="#co_argo_cd_CO13-3" id="callout_argo_cd_CO13-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Commmit email</p></dd>
<dt><a class="co" href="#co_argo_cd_CO13-4" id="callout_argo_cd_CO13-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Golang <code>text/template</code> content</p></dd>
<dt><a class="co" href="#co_argo_cd_CO13-5" id="callout_argo_cd_CO13-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>The name of the application</p></dd>
<dt><a class="co" href="#co_argo_cd_CO13-6" id="callout_argo_cd_CO13-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></dt>
<dd><p>List of changes performed by the update</p></dd>
<dt><a class="co" href="#co_argo_cd_CO13-7" id="callout_argo_cd_CO13-7"><img alt="7" height="12" src="assets/7.png" width="12"/></a></dt>
<dd><p>Image name</p></dd>
<dt><a class="co" href="#co_argo_cd_CO13-8" id="callout_argo_cd_CO13-8"><img alt="8" height="12" src="assets/8.png" width="12"/></a></dt>
<dd><p>Previous container tag</p></dd>
<dt><a class="co" href="#co_argo_cd_CO13-9" id="callout_argo_cd_CO13-9"><img alt="9" height="12" src="assets/9.png" width="12"/></a></dt>
<dd><p>New container tag</p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Remember to restart the Argo CD UI controller when the <code>ConfigMap</code> is <a data-primary="Argo CD" data-secondary="container images, updating automatically" data-startref="Argo_contimg_updatauto" data-type="indexterm" id="idm45120823530864"/><a data-primary="container images" data-secondary="updating" data-startref="contimg_update_Argo" data-tertiary="automatically with Argo CD" data-type="indexterm" id="idm45120823529616"/>changed:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl rollout restart deployment argocd-image-updater -n argocd</pre>
</div>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120823520352">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/kztMq">Argo CD Image Updater</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="7.6 Deploy from a Private Git Repository" data-type="sect1"><div class="sect1" id="recipe_7_6">
<h1>7.6 Deploy from a Private Git Repository</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120823524880">
<h2>Problem</h2>
<p>You want <a data-primary="Argo CD" data-secondary="manifests" data-tertiary="deploying" data-type="indexterm" id="Argo_mani_deploy"/><a data-primary="manifests" data-secondary="deploying, Argo CD" data-type="indexterm" id="mani_deploy_Argo"/>Argo CD to deploy manifests.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120823516416">
<h2>Solution</h2>
<p>Use Argo CD CLI/UI or YAML files to register the repositories’ credential information (username/password/token/key).</p>
<p>In Argo CD, you have two ways to register a <a data-primary="Git" data-secondary="repositories registration" data-type="indexterm" id="Gitrepo_regis_Argo"/><a data-primary="repositories" data-secondary="Git" data-tertiary="registering with Argo CD" data-type="indexterm" id="repo_Git_regisArgo"/><a data-primary="Argo CD" data-secondary="Git repositories, registering" data-type="indexterm" id="Argo_Git_regis"/>Git repository with its credentials. One way is using the Argo CD CLI/Argo CD UI tooling. To register a private repository in Argo CD, set the username and password by running the following command:</p>
<pre data-code-language="bash" data-type="programlisting">argocd repo add https://github.com/argoproj/argocd-example-apps <code class="se">\</code>
--username &lt;username&gt; --password &lt;password&gt;</pre>
<p>Alternatively, we can use the Argo CD UI to register it too. Open Argo CD UI in a browser, and click the Settings/Repositories button (the one with gears) as shown in <a data-type="xref" href="#fig-761">Figure 7-11</a>.</p>
<figure><div class="figure" id="fig-761">
<img alt="Selection of Repositories section" height="416" src="assets/gocb_0711.png" width="1432"/>
<h6><span class="label">Figure 7-11. </span>Settings menu</h6>
</div></figure>
<p>Then click the “Connect Repo using HTTPS” button and fill the form with the required data as shown in <a data-type="xref" href="#fig-762">Figure 7-12</a>.</p>
<figure><div class="figure" id="fig-762">
<img alt="Configuration of the repository with HTTPS credentials" height="807" src="assets/gocb_0712.png" width="1070"/>
<h6><span class="label">Figure 7-12. </span>Configuration of repository</h6>
</div></figure>
<p>Finally, click the Connect button to test that it’s possible to establish a connection and add the repository into Argo CD.</p>
<p>The other way is to create a Kubernetes Secret manifest file with that repository and credentials information:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Secret</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">private-repo</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO14-1" id="co_argo_cd_CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">argocd.argoproj.io/secret-type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">repository</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO14-2" id="co_argo_cd_CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="nt">stringData</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git</code><code class="w">
</code><code class="w">  </code><code class="nt">url</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/argoproj/private-repo</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO14-3" id="co_argo_cd_CO14-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">password</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">my-password</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO14-4" id="co_argo_cd_CO14-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">username</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">my-username</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO14-5" id="co_argo_cd_CO14-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO14-1" id="callout_argo_cd_CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Create a secret in the Argo CD namespace</p></dd>
<dt><a class="co" href="#co_argo_cd_CO14-2" id="callout_argo_cd_CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Sets secret type as <code>repository</code></p></dd>
<dt><a class="co" href="#co_argo_cd_CO14-3" id="callout_argo_cd_CO14-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>URL of the repository to register</p></dd>
<dt><a class="co" href="#co_argo_cd_CO14-4" id="callout_argo_cd_CO14-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Password to access</p></dd>
<dt><a class="co" href="#co_argo_cd_CO14-5" id="callout_argo_cd_CO14-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Username to access</p></dd>
</dl>
<p>If you apply this file, it will have the same effect as the manual approach.</p>
<p>At this point, every time we define a <code>repoURL</code> value in the <code>Application</code> resource with a repository URL registered for authentication, Argo CD will use the registered credentials to log in.</p>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120823515824">
<h2>Discussion</h2>
<p>In addition to setting credentials such as username and password for accessing a private Git repo, Argo CD also supports other methods such as tokens, TLS client certificates, SSH private keys, or GitHub App credentials.</p>
<p>Let’s see some examples using Argo CD CLI or Kubernetes Secrets.</p>
<p>To configure a <a data-primary="TLS client certificate, configuring" data-type="indexterm" id="idm45120823344096"/>TLS client certificate:</p>
<pre data-code-language="bash" data-type="programlisting">argocd repo add https://repo.example.com/repo.git <code class="se">\</code>
--tls-client-cert-path ~/mycert.crt <code class="se">\</code>
--tls-client-cert-key-path ~/mycert.key</pre>
<p class="pagebreak-before less_space">For SSH, you<a data-primary="SSH, registering Git repositories" data-type="indexterm" id="idm45120823339264"/> just need to set the location of the SSH private key:</p>
<pre data-code-language="bash" data-type="programlisting">argocd repo add git@github.com:argoproj/argocd-example-apps.git <code class="se">\</code>
--ssh-privatekey-path ~/.ssh/id_rsa</pre>
<p>Or using a Kubernetes<a data-primary="Kubernetes Secrets" data-secondary="Git repositories, registering" data-type="indexterm" id="idm45120823330928"/> Secret:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Secret</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">private-repo</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">argocd.argoproj.io/secret-type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">repository</code><code class="w">
</code><code class="nt">stringData</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git</code><code class="w">
</code><code class="w">  </code><code class="nt">url</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git@github.com:argoproj/my-private-repository</code><code class="w">
</code><code class="w">  </code><code class="nt">sshPrivateKey</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO15-1" id="co_argo_cd_CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="no">-----BEGIN OPENSSH PRIVATE KEY-----</code><code class="w">
</code><code class="w">    </code><code class="no">...</code><code class="w">
</code><code class="w">    </code><code class="no">-----END OPENSSH PRIVATE KEY-----</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO15-1" id="callout_argo_cd_CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Sets the content of the SSH private key</p></dd>
</dl>
<p>If you are using the GitHub App method, you need to set the App ID, the App Installation ID, and the private key:</p>
<pre data-code-language="bash" data-type="programlisting">argocd repo add https://github.com/argoproj/argocd-example-apps.git --github-app-id <code class="m">1</code> --github-app-installation-id <code class="m">2</code> --github-app-private-key-path test.private-key.pem</pre>
<p>Or using the declarative approach:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Secret</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">github-repo</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">argocd.argoproj.io/secret-type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">repository</code><code class="w">
</code><code class="nt">stringData</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git</code><code class="w">
</code><code class="w">  </code><code class="nt">repo</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://ghe.example.com/argoproj/my-private-repository</code><code class="w">
</code><code class="w">  </code><code class="nt">githubAppID</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO16-1" id="co_argo_cd_CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">githubAppInstallationID</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">2</code><code class="w">
</code><code class="w">  </code><code class="nt">githubAppEnterpriseBaseUrl</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://ghe.example.com/api/v3</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO16-2" id="co_argo_cd_CO16-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">githubAppPrivateKeySecret</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w">
</code><code class="w">    </code><code class="no">-----BEGIN OPENSSH PRIVATE KEY-----</code><code class="w">
</code><code class="w">    </code><code class="no">...</code><code class="w">
</code><code class="w">    </code><code class="no">-----END OPENSSH PRIVATE KEY-----</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO16-1" id="callout_argo_cd_CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Sets GitHub App parameters</p></dd>
<dt><a class="co" href="#co_argo_cd_CO16-2" id="callout_argo_cd_CO16-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Only valid if GitHub App Enterprise is used</p></dd>
</dl>
<p>For the access token, use the account name as the username and the token in the password field.</p>
<p>Choosing which strategy to use will depend on your experience managing Kubernetes Secrets.
Remember that a Secret in Kubernetes is not encrypted but encoded in Base64, so it is not secured by default.</p>
<p>We recommend using only the declarative approach when you’ve got a good strategy for securing the secrets.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>We’ve not discussed the Sealed Secrets project yet (we’ll do so in the following chapter), but when using Sealed Secrets, the labels will be removed to avoid the <code>SealedSecret</code> object having a <code>template</code> section that encodes all the fields you want the controller to put in the unsealed <a data-primary="Argo CD" data-secondary="manifests" data-startref="Argo_mani_deploy" data-tertiary="deploying" data-type="indexterm" id="idm45120823100448"/><a data-primary="manifests" data-secondary="deploying, Argo CD" data-startref="mani_deploy_Argo" data-type="indexterm" id="idm45120823098928"/><a data-primary="Git" data-secondary="repositories" data-startref="Gitrepo_regis_Argo" data-tertiary="registration" data-type="indexterm" id="idm45120823052896"/><a data-primary="repositories" data-secondary="Git" data-startref="repo_Git_regisArgo" data-tertiary="registering with Argo CD" data-type="indexterm" id="idm45120823051568"/><a data-primary="Argo CD" data-secondary="Git repositories, registering" data-startref="Argo_Git_regis" data-type="indexterm" id="idm45120823050240"/>Secret:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p">...</code><code class="w"/>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="s">"argocd.argoproj.io/secret-type"</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">repository</code><code class="w"/></pre>
</div>
</div></section>
</div></section>
<section data-pdf-bookmark="7.7 Order Kubernetes Manifests" data-type="sect1"><div class="sect1" id="recipe_7_7">
<h1>7.7 Order Kubernetes Manifests</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120823045584">
<h2>Problem</h2>
<p>You want to use Argo CD to deploy.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120823044032">
<h2>Solution</h2>
<p>Use <em>sync waves</em> and <em>resource hooks</em> to <a data-primary="sync waves, modifying manifest order" data-type="indexterm" id="sync_wav_mani"/><a data-primary="resource hooks" data-secondary="modifying manifest order" data-type="indexterm" id="resource_hok_mani"/>modify the default <a data-primary="Argo CD" data-secondary="Kubernetes manifests, setting deployment order" data-type="indexterm" id="Argo_Kmani_deployord"/><a data-primary="Kubernetes" data-secondary="manifests" data-tertiary="setting deployment order in Argo CD" data-type="indexterm" id="K_mani_deployordArgo"/>order of applying manifests.</p>
<p>Argo CD applies the Kubernetes manifests (plain, Helm, Kustomize) in a particular order using the following logic:</p>
<ol>
<li>
<p>By kind</p>
<ol>
<li>
<p>Namespaces</p>
</li>
<li>
<p>NetworkPolicy</p>
</li>
<li>
<p>Limit Range</p>
</li>
<li>
<p>ServiceAccount</p>
</li>
<li>
<p>Secret</p>
</li>
<li>
<p>ConfigMap</p>
</li>
<li>
<p>StorageClass</p>
</li>
<li>
<p>PersistentVolumes</p>
</li>
<li>
<p>ClusterRole</p>
</li>
<li>
<p>Role</p>
</li>
<li>
<p>Service</p>
</li>
<li>
<p>DaemonSet</p>
</li>
<li>
<p>Pod</p>
</li>
<li>
<p>ReplicaSet</p>
</li>
<li>
<p>Deployment</p>
</li>
<li>
<p>StatefulSet</p>
</li>
<li>
<p>Job</p>
</li>
<li>
<p>Ingress</p>
</li>
</ol>
</li>
<li>
<p>In the same kind, then by name (alphabetical order)</p>
</li>
</ol>
<p>Argo CD has three phases when applying resources: the first phase is executed before applying the manifests (<code>PreSync</code>), the second phase is when the manifests are applied (<code>Sync</code>), and the third phase is executed after all manifests are applied and synchronized (<code>PostSync</code>).</p>
<p><a data-type="xref" href="#fig-771">Figure 7-13</a> summarizes these phases.</p>
<figure><div class="figure" id="fig-771">
<img alt="Relationship between phases and sync waves" height="583" src="assets/gocb_0713.png" width="1415"/>
<h6><span class="label">Figure 7-13. </span>Hooks and sync waves</h6>
</div></figure>
<p>Resource hooks <a data-primary="resource hooks" data-secondary="manifest deployment" data-type="indexterm" id="resourcehks_manideploy"/>are scripts executed at a given phase, or if the Sync phase failed, you could run some rollback operations.</p>
<p class="pagebreak-before less_space"><a data-type="xref" href="#table0701">Table 7-1</a> lists the available resource hooks.</p>
<table id="table0701">
<caption><span class="label">Table 7-1. </span>Resource hooks</caption>
<thead>
<tr>
<th>Hook</th>
<th>Description</th>
<th>Use case</th>
</tr>
</thead>
<tbody>
<tr>
<td><div>
<p><code>PreSync</code></p></div></td>
<td><p>Executes prior to the application of the manifests</p></td>
<td><p>Database migrations</p></td>
</tr>
<tr>
<td><div>
<p><code>Sync</code></p></div></td>
<td><p>Executes at the same time as manifests</p></td>
<td><p>Complex rolling update strategies like canary releases or dark launches</p></td>
</tr>
<tr>
<td><div>
<p><code>PostSync</code></p></div></td>
<td><p>Executes after all <code>Sync</code> hooks have completed and were successful (healthy)</p></td>
<td><p>Run tests to validate deployment was correctly done</p></td>
</tr>
<tr>
<td><div>
<p><code>SyncFail</code></p></div></td>
<td><p>Executes when the sync operation fails</p></td>
<td><p>Rollback operations in case of failure</p></td>
</tr>
<tr>
<td><div>
<p><code>Skip</code></p></div></td>
<td><p>Skip the application of the manifest</p></td>
<td><p>When manual steps are required to deploy the application (i.e., releasing public traffic to new version)</p></td>
</tr>
</tbody>
</table>
<p>Hooks are defined as an annotation named <code>argocd.argoproj.io/hook</code> to a Kubernetes resource.
In the following snippet, a <code>PostSync</code> manifest is defined:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">batch/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Job</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">todo-insert</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO17-1" id="co_argo_cd_CO17-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">argocd.argoproj.io/hook</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">PostSync</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO17-2" id="co_argo_cd_CO17-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO17-1" id="callout_argo_cd_CO17-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Job’s name</p></dd>
<dt><a class="co" href="#co_argo_cd_CO17-2" id="callout_argo_cd_CO17-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Sets when the manifest is applied</p></dd>
</dl>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45120822913408">
<h5>Deletion Policies</h5>
<p>A hook is not deleted when <a data-primary="resource hooks" data-secondary="manifest deployment" data-startref="resourcehks_manideploy" data-type="indexterm" id="idm45120822911872"/><a data-primary="resource hooks" data-secondary="manifest deployment" data-tertiary="deletion policies" data-type="indexterm" id="idm45120822910624"/>finished; for example, if you run a Kubernetes Job, it’ll remain <code>Completed</code>.</p>
<p>This might be the desired state, but we can specify to automatically delete these resources if annotated with <code>argocd.argoproj.io/hook-delete-policy</code> and the policy value is set.</p>
<p>Supported policies are:</p>
<table>
<thead>
<tr>
<th>Policy</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><div>
<p><code>HookSucceeded</code></p></div></td>
<td><p>Deleted after the hook succeeded</p></td>
</tr>
<tr>
<td><div>
<p><code>HookFailed</code></p></div></td>
<td><p>Deleted after the hook failed</p></td>
</tr>
<tr>
<td><div>
<p><code>BeforeHookCreation</code></p></div></td>
<td><p>Deleted before the new one is created</p></td>
</tr>
</tbody>
</table>
</div></aside>
<p class="less_space pagebreak-before">A <em>sync wave</em> is a way <a data-primary="resource hooks" data-secondary="manifest deployment" data-tertiary="sync waves" data-type="indexterm" id="idm45120822866912"/>to order how Argo CD applies the manifests stored in Git.</p>
<p>All manifests have zero waves by default, and the lower values go first.
Use the <code>argocd.argoproj.io/sync-wave</code> annotation to set the wave number to a resource.</p>
<p>For example, you might want to deploy a database first and then create the database schema; for this case, you should set a <code>sync-wave</code> lower in the database deployment file than in the job for creating the database schema, as shown in the following snippet:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">postgresql</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO18-1" id="co_argo_cd_CO18-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">todo</code><code class="w">
</code><code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">argocd.argoproj.io/sync-wave</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">0</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO18-2" id="co_argo_cd_CO18-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="p">...</code><code class="w">
</code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">batch/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Job</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">todo-table</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO18-3" id="co_argo_cd_CO18-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">todo</code><code class="w">
</code><code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">argocd.argoproj.io/sync-wave</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">1</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO18-4" id="co_argo_cd_CO18-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO18-1" id="callout_argo_cd_CO18-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>PostgreSQL deployment</p></dd>
<dt><a class="co" href="#co_argo_cd_CO18-2" id="callout_argo_cd_CO18-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Sync wave for PostgreSQL deployment is 0</p></dd>
<dt><a class="co" href="#co_argo_cd_CO18-3" id="callout_argo_cd_CO18-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Name of the Job</p></dd>
<dt><a class="co" href="#co_argo_cd_CO18-4" id="callout_argo_cd_CO18-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Job executed when PostgreSQL is healthy</p></dd>
</dl>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120823043408">
<h2>Discussion</h2>
<p>When Argo CD starts applying the manifests, it orders the resources in the following way:</p>
<ol>
<li>
<p>Phase</p>
</li>
<li>
<p>Wave (lower precedence first)</p>
</li>
<li>
<p>Kind</p>
</li>
<li>
<p>Name</p>
</li>
</ol>
<p>Let’s deploy a more significant application with deployment files, sync waves, and hooks.</p>
<p>The sample application deployed is a TODO application connected with a database (PostgreSQL) to store TODOs.
To deploy the application, some particular order needs to be applied; for example, the database server must be running before creating the database schema.
Also, when the whole application is deployed, we insert some default TODOs into the database to run a post-sync manifest.</p>
<p>The overall process is shown in <a data-type="xref" href="#fig-772">Figure 7-14</a>.</p>
<figure><div class="figure" id="fig-772">
<img alt="Todo Application with the order manifests are executed" height="1489" src="assets/gocb_0714.png" width="1378"/>
<h6><span class="label">Figure 7-14. </span>Todo app</h6>
</div></figure>
<p class="pagebreak-before less_space">Create an <code>Application</code> resource pointing out to the application:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Application</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">todo-app</code><code class="w"/>
<code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">destination</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">todo</code><code class="w"/>
<code class="w">    </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://kubernetes.default.svc</code><code class="w"/>
<code class="w">  </code><code class="nt">project</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w"/>
<code class="w">  </code><code class="nt">source</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ch07/todo</code><code class="w"/>
<code class="w">    </code><code class="nt">repoURL</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/gitops-cookbook-sc.git</code><code class="w"/>
<code class="w">    </code><code class="nt">targetRevision</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w"/>
<code class="w">  </code><code class="nt">syncPolicy</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">automated</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">prune</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>
<code class="w">      </code><code class="nt">selfHeal</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">false</code><code class="w"/>
<code class="w">    </code><code class="nt">syncOptions</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">CreateNamespace=true</code><code class="w"/></pre>
<p>In the terminal, apply the resource, and Argo CD will deploy all applications in the specified<a data-primary="sync waves, modifying manifest order" data-startref="sync_wav_mani" data-type="indexterm" id="idm45120822723088"/><a data-primary="resource hooks" data-secondary="modifying manifest order" data-startref="resource_hok_mani" data-type="indexterm" id="idm45120822674960"/><a data-primary="Argo CD" data-secondary="Kubernetes manifests, setting deployment order" data-startref="Argo_Kmani_deployord" data-type="indexterm" id="idm45120822673840"/><a data-primary="Kubernetes" data-secondary="manifests" data-startref="K_mani_deployordArgo" data-tertiary="setting deployment order in Argo CD" data-type="indexterm" id="idm45120822672656"/> order.</p>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120822736736">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/NDWru"><em>gitops-engine/sync_tasks.go</em> on GitHub</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="7.8 Define Synchronization Windows" data-type="sect1"><div class="sect1" id="recipe_7_8">
<h1>7.8 Define Synchronization Windows</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120822666384">
<h2>Problem</h2>
<p>You want Argo CD to block or allow<a data-primary="Argo CD" data-secondary="application synchronization, defining time windows" data-type="indexterm" id="Argo_appsync_timewind"/><a data-primary="applications" data-secondary="synchronization (Argo CD)" data-tertiary="defining time windows" data-type="indexterm" id="app_sync_timwinArgo"/> application synchronization depending on time.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120822662000">
<h2>Solution</h2>
<p>Argo CD has the <em>sync windows</em> concept to configure time windows where application synchronizations (applying new resources that have been pushed to the repository) will either be blocked or allowed.</p>
<p>To define a sync window, create an <code>AppProject</code> manifest setting the <code>kind</code> (either <code>allow</code> or <code>deny</code>), a <code>schedule</code> in cron format to define the initial time, a <code>duration</code> of the window, and which resources the sync window is applied to (<code>Application</code>, namespaces, or clusters).</p>
<aside class="less_space pagebreak-before" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45120822569696">
<h5>About Cron Expressions</h5>
<p>A cron expression<a data-primary="cron expressions" data-type="indexterm" id="idm45120822568128"/><a data-primary="Argo CD" data-secondary="cron expressions" data-type="indexterm" id="idm45120822567392"/> represents a time.
It’s composed of the following fields:</p>
<pre data-type="programlisting">┌────────── minute (0 - 59)
│ ┌────────── hour (0 - 23)
│ │ ┌────────── day of the month (1 - 31)
│ │ │ ┌────────── month (1 - 12)
│ │ │ │ ┌────────── day of the week (0 - 6)
* * * * *</pre>
</div></aside>
<p>The <code>AppProject</code> resource is responsible for defining these windows where synchronizations are permitted/blocked.</p>
<p>Create a new file to permit synchronizations only from 22:00 to 23:00 (just one hour) and for Argo CD <code>Applications</code> whose names end in <code>-prod</code>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">AppProject</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">syncWindows</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO19-1" id="co_argo_cd_CO19-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">allow</code><code class="w">  </code><a class="co" href="#callout_argo_cd_CO19-2" id="co_argo_cd_CO19-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">schedule</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">0</code><code class="nv"> </code><code class="s">22</code><code class="nv"> </code><code class="s">*</code><code class="nv"> </code><code class="s">*</code><code class="nv"> </code><code class="s">*</code><code class="s">'</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO19-3" id="co_argo_cd_CO19-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">duration</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1h</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO19-4" id="co_argo_cd_CO19-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">applications</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO19-5" id="co_argo_cd_CO19-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">'</code><code class="s">*-prod</code><code class="s">'</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO19-6" id="co_argo_cd_CO19-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO19-1" id="callout_argo_cd_CO19-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>List of windows</p></dd>
<dt><a class="co" href="#co_argo_cd_CO19-2" id="callout_argo_cd_CO19-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Allow syncs</p></dd>
<dt><a class="co" href="#co_argo_cd_CO19-3" id="callout_argo_cd_CO19-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Only at 22:00</p></dd>
<dt><a class="co" href="#co_argo_cd_CO19-4" id="callout_argo_cd_CO19-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>For 1 hour (23:00)</p></dd>
<dt><a class="co" href="#co_argo_cd_CO19-5" id="callout_argo_cd_CO19-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Sets the applications that affect this window</p></dd>
<dt><a class="co" href="#co_argo_cd_CO19-6" id="callout_argo_cd_CO19-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></dt>
<dd><p>Regular expression matching any application whose name ends with <code>-prod</code></p></dd>
</dl>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120822475776">
<h2>Discussion</h2>
<p>We cannot perform a sync of the application (neither automatic nor manual) when it’s not the time configured in the time window defined in the <code>AppProject</code> manifest.
However, we can configure a window to allow manual syncs.</p>
<p class="less_space pagebreak-before">Using the CLI tool:</p>
<pre data-code-language="bash" data-type="programlisting">argocd proj windows enable-manual-sync &lt;PROJECT ID&gt;</pre>
<p>Also, manual sync can be set in the YAML file.
In the following example, we’re setting manual synchronization for the <code>namespace</code> default, denying synchronizations at 22:00 for one hour and allowing synchronizations in <code>prod-cluster</code> at 23:00 for <a data-primary="Argo CD" data-secondary="application synchronization, defining time windows" data-startref="Argo_appsync_timewind" data-type="indexterm" id="idm45120822423984"/><a data-primary="applications" data-secondary="synchronization (Argo CD)" data-startref="app_sync_timwinArgo" data-tertiary="defining time windows" data-type="indexterm" id="idm45120822423232"/>one hour:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argoproj.io/v1alpha1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">AppProject</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">argocd</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">syncWindows</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">deny</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO20-1" id="co_argo_cd_CO20-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">schedule</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">0</code><code class="nv"> </code><code class="s">22</code><code class="nv"> </code><code class="s">*</code><code class="nv"> </code><code class="s">*</code><code class="nv"> </code><code class="s">*</code><code class="s">'</code><code class="w">
</code><code class="w">    </code><code class="nt">duration</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1h</code><code class="w">
</code><code class="w">    </code><code class="nt">manualSync</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO20-2" id="co_argo_cd_CO20-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">namespaces</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO20-3" id="co_argo_cd_CO20-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">bgd</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">allow</code><code class="w">
</code><code class="w">    </code><code class="nt">schedule</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">0</code><code class="nv"> </code><code class="s">23</code><code class="nv"> </code><code class="s">*</code><code class="nv"> </code><code class="s">*</code><code class="nv"> </code><code class="s">*</code><code class="s">'</code><code class="w">
</code><code class="w">    </code><code class="nt">duration</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1h</code><code class="w">
</code><code class="w">    </code><code class="nt">clusters</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_argo_cd_CO20-4" id="co_argo_cd_CO20-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">prod-cluster</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_argo_cd_CO20-1" id="callout_argo_cd_CO20-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Block synchronizations</p></dd>
<dt><a class="co" href="#co_argo_cd_CO20-2" id="callout_argo_cd_CO20-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Enable manual sync to <code>default</code> namespace</p></dd>
<dt><a class="co" href="#co_argo_cd_CO20-3" id="callout_argo_cd_CO20-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Configure namespaces to block</p></dd>
<dt><a class="co" href="#co_argo_cd_CO20-4" id="callout_argo_cd_CO20-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Configure clusters to allow syncs at 23:00</p></dd>
</dl>
<p>We can inspect the current windows from the UI by going to the Settings → Projects → default → windows tab or by using the <code>argocd</code> CLI tool:</p>
<pre data-code-language="bash" data-type="programlisting">argocd proj windows list default

ID  STATUS    KIND   SCHEDULE    DURATION  APPLICATIONS  NAMESPACES  CLUSTERS      MANUALSYNC
<code class="m">0</code>   Inactive  deny   <code class="m">0</code> <code class="m">22</code> * * *  1h        -             bgd         -             Enabled
<code class="m">1</code>   Inactive  allow  <code class="m">0</code> <code class="m">23</code> * * *  1h        -             -           prod-cluster  Disabled</pre>
</div></section>
</div></section>
</div></section></div></body></html>