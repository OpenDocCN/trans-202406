<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 21. Setting Up MongoDB in Production"><div class="chapter" id="chapter-start-stop"><h1><span class="label">Chapter 21. </span>Setting Up MongoDB in Production</h1><p>In <a data-type="xref" href="ch02.xhtml#chapter-2">Chapter 2</a>, we covered<a data-type="indexterm" data-primary="administration, of servers" data-secondary="production set up" id="ASprod21"/><a data-type="indexterm" data-primary="server administration" data-secondary="production set up" id="SAprod21"/> the basics of starting MongoDB. This chapter will go into
  more detail about which options are important for setting up MongoDB in
  production, <span class="keep-together">including</span>:</p><ul><li><p>Commonly used options</p></li><li><p>Starting up and shutting down MongoDB</p></li><li><p>Security-related options</p></li><li><p>Logging considerations</p></li></ul><section data-type="sect1" data-pdf-bookmark="Starting from the Command Line"><div class="sect1" id="sect2_d1e8466"><h1>Starting from the Command Line</h1><p>The<a data-type="indexterm" data-primary="command line, starting MongoDB from" id="CLstart21"/><a data-type="indexterm" data-primary="mongod" data-secondary="startup options" id="Mstartup21"/><a data-type="indexterm" data-primary="production set up" data-secondary="starting from command line" id="PSUcommand21"/> MongoDB server is started with the <code>mongod</code> executable. <code>mongod</code> has many configurable startup options; to
    view all of them, run <code>mongod --help</code>
    from the command line. A couple of the options are widely used and
    important to be aware of:</p><dl><dt><code class="option">--dbpath</code></dt><dd><p>Specify<a data-type="indexterm" data-primary="data directories, specifying alternate" id="idm45882335032856"/><a data-type="indexterm" data-primary="directories" data-secondary="specifying alternate" id="idm45882335032024"/><a data-type="indexterm" data-primary="--dbpath" data-primary-sortas="dbpath" id="idm45882335030920"/> an alternate directory to use as the data directory;
          the default is <em class="filename">/data/db/</em> (or,
          on Windows, <em class="filename">\data\db\</em> on the
          MongoDB binary’s volume). Each <code>mongod</code> process on a machine needs its own
          data directory, so if you are running three instances of <code>mongod</code> on one machine, you’ll need three
          separate data directories. When <code>mongod</code> starts up, it creates a <em class="filename">mongod.lock</em> file in its data directory,
          which prevents any other <code>mongod</code>
          process from using that directory. If you attempt to start another
          MongoDB server using the same data directory, it will give an
          error:</p><pre data-type="programlisting">exception in initAndListen: DBPathInUse: Unable to lock the
      lock file: \ data/db/mongod.lock (Resource temporarily unavailable).
      Another mongod instance is already running on the 
      data/db directory,
      \ terminating</pre></dd><dt><code class="option">--port</code></dt><dd><p>Specify<a data-type="indexterm" data-primary="--port" data-primary-sortas="port" id="idm45882335023720"/> the port number for the server to listen on. By
          default, <code>mongod</code> uses port 27017,
          which is unlikely to be used by another process (besides other
          <code>mongod</code> processes). If you would
          like to run more than one <code>mongod</code>
          process on a single machine, you’ll need to specify different ports
          for each one. If you try to start <code>mongod</code> on a port that is already being
          used, it will give an error:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">Failed</code> <code class="nx">to</code> <code class="nx">set</code> <code class="nx">up</code> <code class="nx">listener</code><code class="o">:</code> <code class="nx">SocketException</code><code class="o">:</code> <code class="nx">Address</code> <code class="nx">already</code> <code class="k">in</code> <code class="nx">use</code><code class="p">.</code></pre></dd><dt><code class="option">--fork</code></dt><dd><p>On<a data-type="indexterm" data-primary="servers" data-secondary="forking server processes" id="idm45882335013048"/><a data-type="indexterm" data-primary="--fork" data-primary-sortas="fork" id="idm45882335012072"/> Unix-based systems, fork the server process, running
          MongoDB as a <span class="keep-together">daemon</span>.</p><p>If you are starting up <em class="filename">mongod</em> for the first time (with an empty
          data directory), it can take the filesystem a few minutes to
          allocate database files. The parent process will not return from
          forking until the preallocation is done and
          <em>mongod</em> is ready to start accepting connections.
          Thus, <em class="filename">fork</em> may appear to hang.
          You can tail the log to see what it is doing. You must use
          <code class="option">--logpath</code> if you specify
          <code class="option">--fork</code>.</p></dd><dt><code class="option">--logpath</code></dt><dd><p>Send<a data-type="indexterm" data-primary="files and filesystems" data-secondary="sending output to" id="idm45882334998248"/><a data-type="indexterm" data-primary="--logpath" data-primary-sortas="logpath" id="idm45882334997112"/> all output to the specified file rather than
          outputting on the command line. This will create the file if it does
          not exist, assuming you have write permissions to the directory. It
          will also overwrite the log file if it already exists, erasing any
          older log entries. If you’d like to keep old logs around, use the
          <code class="option">--logappend</code> option in addition to
          <code class="option">--logpath</code> (highly recommended).</p></dd><dt><code class="option">--directoryperdb</code></dt><dd><p>Put<a data-type="indexterm" data-primary="directories" data-secondary="placing databases in" id="idm45882334993016"/><a data-type="indexterm" data-primary="databases" data-secondary="placing in own directory" id="idm45882334991880"/><a data-type="indexterm" data-primary="--directoryperdb" data-primary-sortas="directoryperdb" id="idm45882334990760"/> each database in its own directory. This allows you
          to mount different databases on different disks, if necessary or
          desired. Common uses for this are putting a local database on its
          own disk (replication) or moving a database to a different disk if
          the original one fills up. You could also put databases that handle
          more load on faster disks and databases with a lower load on slower
          disks. This basically gives you more flexibility to move things
          around later.</p></dd><dt><code class="option">--config</code></dt><dd><p>Use<a data-type="indexterm" data-primary="--config" data-primary-sortas="config" id="idm45882334987912"/> a configuration file for additional options not
          specified on the command line. This is typically used to make sure
          options are the same between restarts. See <a data-type="xref" href="#sect2_d1e8618">“File-Based Configuration”</a> for details.</p></dd></dl><p>For example, to start the server as a daemon listening on port 5586
    and sending all output to <em class="filename">mongodb.log</em>, we could run this:</p><pre data-type="programlisting">$ ./mongod --dbpath data/db --port 5586 --fork --logpath
    mongodb.log --logappend 2019-09-06T22:52:25.376-0500 I CONTROL [main]
    Automatically disabling TLS 1.0, \ to force-enable TLS 1.0 specify
    --sslDisabledProtocols 'none' about to fork child process, waiting until
    server is ready for connections. forked process: 27610 child process
    started successfully, parent exiting</pre><p>When<a data-type="indexterm" data-primary="logs and logging" data-secondary="checking log at startup" id="idm45882334983368"/><a data-type="indexterm" data-primary="production set up" data-secondary="checking log" id="idm45882334982232"/> you first install and start MongoDB, it is a good idea to
    look at the log. This might be an easy thing to miss, especially if
    MongoDB is being started from an init script, but the log often contains
    important warnings that prevent later errors from occurring. If you don’t
    see any warnings in the MongoDB log on startup, then you are all set.
    (Startup warnings will also appear on shell startup.)</p><p>If<a data-type="indexterm" data-primary="warnings, in startup banner" id="idm45882334980312"/> there are any warnings in the startup banner, take note of
    them. MongoDB will warn you about a variety of issues: that you’re running
    on a<a data-type="indexterm" data-primary="32-bit systems" id="idm45882334979192"/> 32-bit machine (which MongoDB is not designed for), that
    you have NUMA enabled (which can slow your application to a crawl), or
    that your system does not allow enough open file descriptors (MongoDB uses
    a lot of file descriptors).</p><p>The log preamble won’t change when you restart the database, so feel
    free to run <span class="keep-together">MongoDB</span> from an init
    script and ignore the logs, once you know what they say. However, it’s a
    good idea to check again each time you do an install, upgrade, or recover
    from a crash, just to make sure MongoDB and your system are on the same
    page.</p><p>When you start the database, MongoDB will write a document to the
    <em class="filename">local.startup_log</em>
    collection<a data-type="indexterm" data-primary="local.startup_log collection" id="idm45882334887672"/> that describes the version of MongoDB, underlying system,
    and flags used. We<a data-type="indexterm" data-primary="mongo shell" data-secondary="viewing startup log" id="idm45882334886808"/> can look at this document using the
    <em>mongo</em> shell:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">use</code> <code class="nx">local</code>
<code class="nx">switched</code> <code class="nx">to</code> <code class="nx">db</code> <code class="nx">local</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">startup_log</code><code class="p">.</code><code class="nx">find</code><code class="p">().</code><code class="nx">sort</code><code class="p">({</code><code class="nx">startTime</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">}).</code><code class="nx">limit</code><code class="p">(</code><code class="mi">1</code><code class="p">).</code><code class="nx">pretty</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"server1-1544192927184"</code><code class="p">,</code>
    <code class="s2">"hostname"</code> <code class="o">:</code> <code class="s2">"server1.example.net"</code><code class="p">,</code>
    <code class="s2">"startTime"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2019-09-06T22:50:47Z"</code><code class="p">),</code>
    <code class="s2">"startTimeLocal"</code> <code class="o">:</code> <code class="s2">"Fri Sep  6 22:57:47.184"</code><code class="p">,</code>
    <code class="s2">"cmdLine"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"net"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"port"</code> <code class="o">:</code> <code class="mi">5586</code>
        <code class="p">},</code>
        <code class="s2">"processManagement"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"fork"</code> <code class="o">:</code> <code class="kc">true</code>
        <code class="p">},</code>
        <code class="s2">"storage"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"dbPath"</code> <code class="o">:</code> <code class="s2">"data/db"</code>
        <code class="p">},</code>
        <code class="s2">"systemLog"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"destination"</code> <code class="o">:</code> <code class="s2">"file"</code><code class="p">,</code>
            <code class="s2">"logAppend"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
            <code class="s2">"path"</code> <code class="o">:</code> <code class="s2">"mongodb.log"</code>
        <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"pid"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">27278</code><code class="p">),</code>
    <code class="s2">"buildinfo"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"version"</code> <code class="o">:</code> <code class="s2">"4.2.0"</code><code class="p">,</code>
        <code class="s2">"gitVersion"</code> <code class="o">:</code> <code class="s2">"a4b751dcf51dd249c5865812b390cfd1c0129c30"</code><code class="p">,</code>
        <code class="s2">"modules"</code> <code class="o">:</code> <code class="p">[</code>
            <code class="s2">"enterprise"</code>
        <code class="p">],</code>
        <code class="s2">"allocator"</code> <code class="o">:</code> <code class="s2">"system"</code><code class="p">,</code>
        <code class="s2">"javascriptEngine"</code> <code class="o">:</code> <code class="s2">"mozjs"</code><code class="p">,</code>
        <code class="s2">"sysInfo"</code> <code class="o">:</code> <code class="s2">"deprecated"</code><code class="p">,</code>
        <code class="s2">"versionArray"</code> <code class="o">:</code> <code class="p">[</code>
            <code class="mi">4</code><code class="p">,</code>
            <code class="mi">2</code><code class="p">,</code>
            <code class="mi">0</code><code class="p">,</code>
            <code class="mi">0</code>
        <code class="p">],</code>
        <code class="s2">"openssl"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"running"</code> <code class="o">:</code> <code class="s2">"Apple Secure Transport"</code>
        <code class="p">},</code>
        <code class="s2">"buildEnvironment"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"distmod"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">,</code>
            <code class="s2">"distarch"</code> <code class="o">:</code> <code class="s2">"x86_64"</code><code class="p">,</code>
            <code class="s2">"cc"</code> <code class="o">:</code> <code class="s2">"gcc: Apple LLVM version 8.1.0 (clang-802.0.42)"</code><code class="p">,</code>
            <code class="s2">"ccflags"</code> <code class="o">:</code> <code class="s2">"-mmacosx-version-min=10.10 -fno-omit\</code>
<code class="s2">                       -frame-pointer -fno-strict-aliasing \</code>
<code class="s2">                       -ggdb -pthread -Wall </code>
<code class="s2">                       -Wsign-compare -Wno-unknown-pragmas \</code>
<code class="s2">                       -Winvalid-pch -Werror -O2 -Wno-unused\</code>
<code class="s2">                       -local-typedefs -Wno-unused-function </code>
<code class="s2">                       -Wno-unused-private-field \</code>
<code class="s2">                       -Wno-deprecated-declarations \</code>
<code class="s2">                       -Wno-tautological-constant-out-of\</code>
<code class="s2">                       -range-compare </code>
<code class="s2">                       -Wno-unused-const-variable -Wno\</code>
<code class="s2">                       -missing-braces -Wno-inconsistent\</code>
<code class="s2">                       -missing-override </code>
<code class="s2">                       -Wno-potentially-evaluated-expression \</code>
<code class="s2">                       -Wno-exceptions -fstack-protector\</code>
<code class="s2">                       -strong -fno-builtin-memcmp"</code><code class="p">,</code>
            <code class="s2">"cxx"</code> <code class="o">:</code> <code class="s2">"g++: Apple LLVM version 8.1.0 (clang-802.0.42)"</code><code class="p">,</code>
            <code class="s2">"cxxflags"</code> <code class="o">:</code> <code class="s2">"-Woverloaded-virtual -Werror=unused-result \</code>
<code class="s2">                       -Wpessimizing-move -Wredundant-move \</code>
<code class="s2">                       -Wno-undefined-var-template -stdlib=libc++ \</code>
<code class="s2">                       -std=c++14"</code><code class="p">,</code>
            <code class="s2">"linkflags"</code> <code class="o">:</code> <code class="s2">"-mmacosx-version-min=10.10 -Wl, \</code>
<code class="s2">                       -bind_at_load -Wl,-fatal_warnings \</code>
<code class="s2">                       -fstack-protector-strong \</code>
<code class="s2">                       -stdlib=libc++"</code><code class="p">,</code>
            <code class="s2">"target_arch"</code> <code class="o">:</code> <code class="s2">"x86_64"</code><code class="p">,</code>
            <code class="s2">"target_os"</code> <code class="o">:</code> <code class="s2">"macOS"</code>
        <code class="p">},</code>
        <code class="s2">"bits"</code> <code class="o">:</code> <code class="mi">64</code><code class="p">,</code>
        <code class="s2">"debug"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"maxBsonObjectSize"</code> <code class="o">:</code> <code class="mi">16777216</code><code class="p">,</code>
        <code class="s2">"storageEngines"</code> <code class="o">:</code> <code class="p">[</code>
            <code class="s2">"biggie"</code><code class="p">,</code>
            <code class="s2">"devnull"</code><code class="p">,</code>
            <code class="s2">"ephemeralForTest"</code><code class="p">,</code>
            <code class="s2">"inMemory"</code><code class="p">,</code>
            <code class="s2">"queryable_wt"</code><code class="p">,</code>
            <code class="s2">"wiredTiger"</code>
        <code class="p">]</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>This collection can be useful for tracking upgrades and changes in
    behavior.</p><section data-type="sect2" data-pdf-bookmark="File-Based Configuration"><div class="sect2" id="sect2_d1e8618"><h2>File-Based Configuration</h2><p>MongoDB<a data-type="indexterm" data-primary="files and filesystems" data-secondary="file-based configuration" id="idm45882334874648"/><a data-type="indexterm" data-primary="production set up" data-secondary="file-based configuration" id="idm45882334873560"/> supports reading configuration information from a file.
      This can be useful if you have a large set of options you want to use or
      are automating the task of <span class="keep-together">starting
      up</span> MongoDB. To tell the server to get options from a
      configuration file, use the <code class="option">-f</code> or
      <code class="option">--config</code> flags. For example, run <code>mongod --config ~/.mongodb.conf</code> to use
      <em class="filename">~/.mongodb.conf</em> as a configuration
      file.</p><p>The options supported in a configuration file are the same as
      those accepted at the command line. However, the format is different. As
      of MongoDB 2.6, MongoDB configuration files use the YAML format. Here’s
      an example configuration file:</p><pre id="I_programlisting8_d1e8994" data-type="programlisting">systemLog:
   destination: file
   path: "mongod.log"
   logAppend: true
storage:
   dbPath: data/db
processManagement:
   fork: true
net:
   port: 5586
...</pre><p>This configuration file specifies the same options we used earlier
      when starting with regular command-line arguments. Note that these same
      options are reflected in the <em>startup_log</em> collection
      document we looked at in the previous section. The only real difference
      is that the options are specified using JSON rather than YAML.</p><p>In MongoDB 4.2, expansion directives were added to allow the
      loading of specific configuration file options or loading of the entire
      configuration file. The advantage of expansion directives is that
      confidential information, such as passwords and security certificates,
      does not have to be stored in the config file directly. The<a data-type="indexterm" data-primary="--configExpand" data-primary-sortas="configExpand" id="idm45882334638888"/> <code>--configExpand</code>
      command-line option enables this feature and must include the expansion
      directives you wish to enable. <code>__rest</code>
      and <code>__exec</code> are the current
      implementation of the expansion directives in MongoDB. The <code>__rest</code> expansion directive loads specific
      configuration file values or loads the entire configuration file from a
      REST endpoint. The <code>__exec</code> expansion
      directive loads specific configuration file values or loads the entire
      configuration file from a shell or<a data-type="indexterm" data-startref="CLstart21" id="idm45882334635080"/><a data-type="indexterm" data-startref="Mstartup21" id="idm45882334634248"/><a data-type="indexterm" data-startref="PSUcommand21" id="idm45882334633416"/> terminal command.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Stopping MongoDB"><div class="sect1" id="sect2_d1e8686"><h1>Stopping MongoDB</h1><p>Being<a data-type="indexterm" data-primary="servers" data-secondary="shutting down" id="idm45882334631368"/><a data-type="indexterm" data-primary="MongoDB" data-secondary="stopping" id="idm45882334630232"/><a data-type="indexterm" data-primary="production set up" data-secondary="stopping MongoDB" id="idm45882334629128"/> able to safely stop a running MongoDB server is at least as
    important as being able to start one. There are a couple of different
    options for doing this effectively.</p><p>The cleanest way to shut down a running server is to use
    the<a data-type="indexterm" data-primary="shutdown command" id="idm45882334627224"/> <code>shutdown</code> command,
    <code>{"shutdown" : 1}</code>. This<a data-type="indexterm" data-primary="admin database" data-secondary="shutdown command" id="idm45882334625368"/> is an admin command and must be run on the
    <em>admin</em> database. The shell features a helper function
    to make this easier:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">use</code> <code class="nx">admin</code>
<code class="nx">switched</code> <code class="nx">to</code> <code class="nx">db</code> <code class="nx">admin</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">shutdownServer</code><code class="p">()</code>
<code class="nx">server</code> <code class="nx">should</code> <code class="nx">be</code> <code class="nx">down</code><code class="p">...</code></pre><p>When<a data-type="indexterm" data-primary="force option" id="idm45882334622248"/> run on a primary, the <code>shutdown</code> command steps down the primary and
    waits for a secondary to catch up before shutting down the server. This
    minimizes the chance of rollback, but the shutdown isn’t guaranteed to
    succeed. If there is no secondary available that can catch up within a few
    seconds, the <code>shutdown</code> command will fail
    and the (former) primary will not shut down:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">shutdownServer</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"closest"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1349465327</code><code class="p">),</code>
    <code class="s2">"difference"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">20</code><code class="p">),</code>
    <code class="s2">"errmsg"</code> <code class="o">:</code> <code class="s2">"no secondaries within 10 seconds of my optime"</code><code class="p">,</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">0</code>
<code class="p">}</code></pre><p>You can force the <code>shutdown</code>
    command to shut down a primary by using the <code>force</code> option:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"shutdown"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"force"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">})</code></pre><p>This<a data-type="indexterm" data-primary="SIGTERM signal" id="idm45882334533240"/><a data-type="indexterm" data-primary="SIGINT signal" id="idm45882334532504"/> is equivalent to sending a SIGINT or <span class="keep-together">SIGTERM</span> signal (all three of these options
    result in a clean shutdown, but there may be unreplicated data). If the
    server is running as the foreground process in a terminal, a SIGINT can be
    sent by pressing Ctrl-C. Otherwise, a command like <code>kill</code> can be used to send the signal. If
    <em>mongod</em> had 10014 as its PID, the<a data-type="indexterm" data-primary="kill command" id="idm45882334548920"/> command would be <code>kill -2
    10014</code> (<span class="keep-together">SIGINT</span>) or <code>kill 10014</code> (SIGTERM).</p><p>When <em>mongod</em> receives a SIGINT or SIGTERM, it
    will do a clean shutdown. This means it will wait for any running
    operations or file preallocations to finish (this could take a moment),
    close all open connections, flush all data to disk, and halt.</p></div></section><section data-type="sect1" data-pdf-bookmark="Security"><div class="sect1" id="idm45882334639480"><h1>Security</h1><p>Do<a data-type="indexterm" data-primary="firewalls" id="idm45882334544664"/><a data-type="indexterm" data-primary="security considerations" data-secondary="firewalls" id="idm45882334543800"/><a data-type="indexterm" data-primary="production set up" data-secondary="security" data-seealso="security considerations" id="idm45882334495832"/> not set up publicly addressable MongoDB servers. You should
    restrict access as tightly as possible between the outside world and
    MongoDB. The best way to do this is to set up firewalls and only allow
    MongoDB to be reachable on internal network addresses. <a data-type="xref" href="ch24.xhtml#chapter-ops">Chapter 24</a> covers what connections it’s necessary to allow
    between <span class="keep-together">MongoDB</span> servers and clients.</p><p>Beyond<a data-type="indexterm" data-primary="config database" data-secondary="options increasing security of" id="idm45882334492104"/><a data-type="indexterm" data-primary="security considerations" data-secondary="config file options" id="idm45882334491000"/> firewalls, there are a few options you can add to your
    config file to make it more secure:</p><dl><dt><code class="option">--bind_ip</code></dt><dd><p>Specify<a data-type="indexterm" data-primary="--bind_ip&#10;              parameter" data-primary-sortas="bind_ip parameter" id="idm45882334488392"/> the interfaces that you want MongoDB to listen on.
          Generally you want this to be an internal IP: something application
          servers and other members of your cluster can access but that is
          inaccessible to the outside world. <em class="filename">localhost</em> is fine for <span class="command"><em>mongos</em></span> processes if you’re running the
          application server on the same machine. For config servers and
          shards, they’ll need to be addressable from other machines, so stick
          with non-<em class="filename">localhost</em>
          addresses.</p><p>Starting in MongoDB 3.6, <span class="command"><em>mongod</em></span> and <span class="command"><em>mongos</em></span> processes bind to <em class="filename">localhost</em> by default. When bound only to
          <em class="filename">localhost</em>, <span class="command"><em>mongod</em></span> and <span class="command"><em>mongos</em></span> will only accept connections from
          clients running on the same machine. This helps limit the exposure
          of unsecured MongoDB instances. To bind to other addresses, use the
          <code class="option">net.bindIp</code> configuration file setting or the
          <code class="option">--bind_ip</code> command-line option to specify a list of
          hostnames or IP addresses.</p></dd><dt><code class="option">--nounixsocket</code></dt><dd><p>Disable<a data-type="indexterm" data-primary="--nounixsocket" data-primary-sortas="nounixsocket" id="idm45882334462040"/> listening on the UNIX domain socket. If you’re not
          planning to connect via filesystem socket, you might as well
          disallow it. You would only connect via filesystem socket on a
          machine that is also running an application server: you must be
          local to use a filesystem socket.</p></dd><dt><code class="option">--noscripting</code></dt><dd><p>Disable<a data-type="indexterm" data-primary="--noscripting" data-primary-sortas="noscripting" id="idm45882334459368"/> server-side JavaScript execution. Some security
          issues that have been reported with MongoDB have been
          JavaScript-related, so it’s generally safer to disallow it, if your
          application allows.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>Several shell helpers assume that JavaScript is available on
            the server, notably <code class="function">sh.status()</code>. You will see errors if you
            attempt to run any of these helpers with JavaScript
            disabled.</p></div></dd></dl><section data-type="sect2" data-pdf-bookmark="Data Encryption"><div class="sect2" id="idm45882334456248"><h2>Data Encryption</h2><p>Data<a data-type="indexterm" data-primary="production set up" data-secondary="data encryption" id="idm45882334455368"/><a data-type="indexterm" data-primary="data" data-secondary="encrypting" id="idm45882334454232"/> encryption is available in MongoDB Enterprise. These
      options are not supported in the Community version of MongoDB.</p><p>The data encryption process includes the following steps:</p><ul><li><p>Generate a master key.</p></li><li><p>Generate keys for each database.</p></li><li><p>Encrypt data with the database keys.</p></li><li><p>Encrypt the database keys with the master key.</p></li></ul><p>When using data encryption, all<a data-type="indexterm" data-primary="files and filesystems" data-secondary="data encryption" id="idm45882334450472"/> data files are encrypted in the filesystem. Data is only
      unencrypted in memory and during transmission. To encrypt all of
      MongoDB’s network traffic, you can use TLS/SSL. The data encryption
      options that MongoDB Enterprise users can add to their config files are:</p><dl><dt><code class="option">--enableEncryption</code></dt><dd><p>Enables<a data-type="indexterm" data-primary="--enableEncryption" data-primary-sortas="enableEncryption" id="idm45882334447736"/> encryption in the WiredTiger storage engine. With
              this option, data stored in memory and on disk will be
              encrypted. This is sometimes referred to as “encryption at
              rest.” You must set this to <code>true</code> in order to pass in encryption
              keys and to configure encryption. This option is <code>false</code> by default.</p></dd><dt><code class="option">--encryptionCipherMode</code></dt><dd><p>Set<a data-type="indexterm" data-primary="--encryptionCipherMode" data-primary-sortas="encryptionCipherMode" id="idm45882334444168"/> the cipher mode for encryption at rest in
              WiredTiger. There are two modes available: AES256-CBC and
              AES256-GCM. AES256-CBC is an acronym for 256-bit Advanced
              Encryption Standard in Cipher Block Chaining Mode. AES256-GCM
              uses Galois/Counter Mode. Both are standard encryption ciphers.
              As of MongoDB 4.0, MongoDB Enterprise on Windows no longer
              supports AES256-GCM.</p></dd><dt><code class="option">--encryptionKeyFile</code></dt><dd><p>Specify<a data-type="indexterm" data-primary="--encryptionKeyFile" data-primary-sortas="encryptionKeyFile" id="idm45882334441368"/> the path to the local keyfile if you are managing
              keys using a process other than the Key Management
              Interoperability Protocol (KMIP).</p></dd></dl><p>MongoDB<a data-type="indexterm" data-primary="Key Management Interoperability Protocol (KMIP)" id="idm45882334439672"/> Enterprise also supports key management using KMIP. A
      discussion of KMIP is beyond the scope of this book. Please see the
      <a href="https://oreil.ly/TeA4t">MongoDB
      documentation for details on using KMIP with MongoDB</a>.</p></div></section><section data-type="sect2" data-pdf-bookmark="SSL Connections"><div class="sect2" id="idm45882334437816"><h2>SSL Connections</h2><p>As<a data-type="indexterm" data-primary="production set up" data-secondary="SSL connections" id="idm45882334436648"/><a data-type="indexterm" data-primary="SSL connections" id="idm45882334435512"/> we saw in <a data-type="xref" href="ch18.xhtml#chapter-seeing">Chapter 18</a>, MongoDB
      supports transport encryption<a data-type="indexterm" data-primary="transport encryption" id="idm45882334433560"/> using TLS/SSL<a data-type="indexterm" data-primary="TLS/SSL encryption" id="idm45882334432600"/>. This feature is available in all editions of MongoDB. By
      default, connections to MongoDB transfer data unencrypted. However,
      TLS/SSL ensures transport encryption. MongoDB uses native TSL/SSL
      libraries available on your operating system. Use the option<a data-type="indexterm" data-primary="--tlsMode" data-primary-sortas="tlsMode" id="idm45882334431320"/> <code class="option">--tlsMode</code> and related options to
      configure TLS/SSL. Refer to <a data-type="xref" href="ch18.xhtml#chapter-seeing">Chapter 18</a> for more
      detail, and consult your driver’s documentation on how to create TLS/SSL
      connections using your language.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Logging"><div class="sect1" id="idm45882334436872"><h1>Logging</h1><p>By<a data-type="indexterm" data-primary="production set up" data-secondary="logging" id="idm45882334427016"/><a data-type="indexterm" data-primary="logs and logging" data-secondary="default options" id="idm45882334425880"/><a data-type="indexterm" data-primary="stdout" id="idm45882334424776"/> default, <em class="filename">mongod</em> sends
    its logs to stdout. Most init scripts<a data-type="indexterm" data-primary="--logpath" data-primary-sortas="logpath" id="idm45882334423096"/> use the <code class="option">--logpath</code> option to send logs to a
    file. If<a data-type="indexterm" data-primary="logs and logging" data-secondary="best practices" id="idm45882334421144"/> you have multiple MongoDB instances on a single machine
    (say, a <em class="filename">mongod</em> and a <em class="filename">mongos</em>), make sure that their logs are stored
    in separate files. Be sure that you know where the logs are and have read
    access to the files.</p><p>MongoDB spits out a lot of log messages, but please do not run with
    the <code class="option">--quiet</code> option (which suppresses some of them).
    Leaving the log level at the default is usually perfect: there is enough
    information for basic debugging (why is this slow, why isn’t this starting
    up, etc.), but the logs do not take up too much space.</p><p>If<a data-type="indexterm" data-primary="debugging" id="idm45882334417000"/><a data-type="indexterm" data-primary="logs and logging" data-secondary="debugging" id="idm45882334416136"/> you are debugging a specific issue with your application,
    there are a couple of options for getting more information from the logs.
    You can change the log level by running the<a data-type="indexterm" data-primary="setParameter command" id="idm45882334414696"/> <code>setParameter</code> command, or
    by setting the log level at startup time by passing it as a string using
    the <code>--setParameter</code> option.</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"setParameter"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"logLevel"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">})</code></pre><p>You<a data-type="indexterm" data-primary="logs and logging" data-secondary="changing log level" id="idm45882334387992"/> can also change the log level for a particular component.
    This is helpful if you are debugging a specific aspect of your application
    and require more information, but only from that component. In this
    example, we set the default log verbosity to 1 and the query component
    verbosity to 2:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"setParameter"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">logComponentVerbosity</code><code class="o">:</code>
        <code class="p">{</code> <code class="nx">verbosity</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">query</code><code class="o">:</code> <code class="p">{</code> <code class="nx">verbosity</code><code class="o">:</code> <code class="mi">2</code> <code class="p">}}})</code></pre><p>Remember to turn the log level back down to 0 when you’re done
    debugging, or your logs may be needlessly noisy. You can turn the level
    all the way up to 5, at which point <code>mongod</code> will print out almost every action it
    takes, including the contents of every request handled. This can cause a
    lot of I/O as <em class="filename">mongod</em> writes
    everything to the log file, which can slow down a busy system. Turning on
    profiling is a better option if you need to see every operation as it’s
    happening.</p><p>By default, MongoDB logs information about queries that take longer
    than 100 ms to run. If 100 ms is too short or too long for your
    application, you can change the threshold with<a data-type="indexterm" data-primary="setProfilingLevel" id="idm45882334264792"/> <code>setProfilingLevel</code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="c1">// Only log queries that take longer than 500 ms</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">setProfilingLevel</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">500</code><code class="p">)</code>
<code class="p">{</code> <code class="s2">"was"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"slowms"</code> <code class="o">:</code> <code class="mi">100</code><code class="p">,</code> <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">setProfilingLevel</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
<code class="p">{</code> <code class="s2">"was"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"slowms"</code> <code class="o">:</code> <code class="mi">500</code><code class="p">,</code> <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code></pre><p>The second line will turn off profiling, but the value in
    milliseconds given in the first line will continue to be used as a
    threshold for the log (across all databases). You can also set this
    parameter by restarting MongoDB with<a data-type="indexterm" data-primary="--slowms" data-primary-sortas="slowms" id="idm45882334247368"/> the <code class="option">--slowms</code> option.</p><p>Finally, set<a data-type="indexterm" data-primary="logs and logging" data-secondary="rotating logs" id="idm45882334173352"/> up a cron job that rotates your log every day or week. If
    MongoDB was started with <code class="option">--logpath</code>, sending the process a
    SIGUSR1 signal will make it rotate the log. There is also a <code>logRotate</code> command<a data-type="indexterm" data-primary="logRotate command" id="idm45882334170760"/> that does the same thing:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"logRotate"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><p>You<a data-type="indexterm" data-startref="SAprod21" id="idm45882334162728"/><a data-type="indexterm" data-startref="ASprod21" id="idm45882334161992"/> cannot rotate logs if MongoDB was not
    started with <code class="option">--logpath</code>.</p></div></section></div></section></div>



  </body></html>