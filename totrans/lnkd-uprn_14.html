<html><head></head><body><section data-pdf-bookmark="Chapter 14. Production-Ready Linkerd" data-type="chapter" epub:type="chapter" class="preface"><div class="preface" id="LUAR_production_ready">
<h1 class="calibre7"><span class="calibre">Chapter 14. </span>Production-Ready Linkerd</h1>


<p class="author1">Once you’ve deployed Linkerd,<a data-primary="production" data-secondary="production-ready Linkerd" data-tertiary="about" data-type="indexterm" id="id1736" class="calibre4"/> your next task is to appropriately
harden your environment for production usage. As you prepare,
it’s valuable to familiarize yourself with the resources available to you.
Linkerd users have access to two basic sets of resources:</p>

<ul class="printings">
<li class="calibre6">
<p class="author1">Community-provided resources, which are free to use and a great source of information for everyone</p>
</li>
<li class="calibre6">
<p class="author1">Commercial resources from Buoyant, the creators of Linkerd</p>
</li>
</ul>

<p class="author1">For the purposes of this book we’re going to avoid going into the paid
resources. If you’d like more information on Buoyant’s commercial offerings, visit <a href="https://buoyant.io" class="calibre4">the Buoyant website</a>.</p>






<section data-pdf-bookmark="Linkerd Community Resources" data-type="sect1" class="preface"><div class="preface" id="id185">
<h1 class="calibre8">Linkerd Community Resources</h1>

<p class="author1">The Linkerd community is active<a data-primary="production" data-secondary="production-ready Linkerd" data-tertiary="Linkerd community resources" data-type="indexterm" id="id1737" class="calibre4"/><a data-primary="resources online" data-secondary="Linkerd community resources" data-type="indexterm" id="id1738" class="calibre4"/><a data-primary="Linkerd" data-secondary="community resources" data-type="indexterm" id="id1739" class="calibre4"/> on <a href="https://oreil.ly/n6j1e" class="calibre4">GitHub</a>, <a href="https://slack.linkerd.io" class="calibre4">Slack</a>, and the <a href="https://oreil.ly/w5dIi" class="calibre4">CNCF mailing list</a>. Beyond that, there are a number of useful guides and resources online.</p>

<p class="author1">If you’re looking to learn more<a data-primary="production" data-secondary="Buoyant production runbook URL" data-type="indexterm" id="id1740" class="calibre4"/><a data-primary="resources online" data-secondary="Buoyant production runbook" data-type="indexterm" id="id1741" class="calibre4"/><a data-primary="documentation for Linkerd online" data-secondary="Buoyant production runbook" data-type="indexterm" id="id1742" class="calibre4"/><a data-primary="Linkerd" data-secondary="documentation URL" data-tertiary="Buoyant production runbook" data-type="indexterm" id="id1743" class="calibre4"/><a data-primary="Buoyant, Inc." data-secondary="Linkerd production runbook" data-type="indexterm" id="id1744" class="calibre4"/> about running Linkerd in production, the <a href="https://oreil.ly/kCfO5" class="calibre4">Buoyant production runbook</a> is actively updated as Linkerd versions change and contains lots of important information.</p>








<section data-pdf-bookmark="Getting Help" data-type="sect2" class="preface"><div class="preface" id="id104">
<h2 class="calibre27">Getting Help</h2>

<p class="author1">Community support for Linkerd<a data-primary="help from Linkerd community" data-type="indexterm" id="id1745" class="calibre4"/> is mostly provided by volunteer community members in the Linkerd Slack or directly by the maintainer and contributor community on GitHub. It’s important that users trying to get help from the open source 
<span class="calibre">community</span> understand that you have a responsibility to carefully test all changes you make to Linkerd. When seeking help for Linkerd, you should be sure to clearly articulate the problem you’re facing and, if possible, provide clear steps to reproduce the issue. The hardest task for maintainers or volunteer community members will always be understanding and testing any particular problems that come up.</p>
</div></section>








<section data-pdf-bookmark="Responsible Disclosure" data-type="sect2" class="preface"><div class="preface" id="id105">
<h2 class="calibre27">Responsible Disclosure</h2>

<p class="author1">If you run into a security issue<a data-primary="resources online" data-secondary="Linkerd community resources" data-tertiary="contact for Linkerd security issue" data-type="indexterm" id="id1746" class="calibre4"/><a data-primary="security" data-secondary="contact for Linkerd security issue" data-type="indexterm" id="id1747" class="calibre4"/><a data-primary="Linkerd" data-secondary="contact for Linkerd security issue" data-type="indexterm" id="id1748" class="calibre4"/> with Linkerd, the project maintainers kindly ask that you send a private email to <a href="mailto:cncf-linkerd-maintainers@lists.cncf.io" class="calibre4">cncf-linkerd-maintainers@lists.cncf.io</a>. The maintainers will acknowledge your report and provide you additional information as they investigate the disclosure. <a data-primary="Linkerd" data-secondary="vulnerability notification subscription" data-type="indexterm" id="id1749" class="calibre4"/><a data-primary="vulnerability notification subscription" data-type="indexterm" id="id1750" class="calibre4"/><a data-primary="security" data-secondary="vulnerability notification subscription" data-type="indexterm" id="id1751" class="calibre4"/>You can subscribe to Linkerd vulnerability notifications at the <a href="https://oreil.ly/HIc0c" class="calibre4">cncf-linkerd-announce mailing list</a>.</p>
</div></section>








<section data-pdf-bookmark="Kubernetes Compatibility" data-type="sect2" class="preface"><div class="preface" id="id330">
<h2 class="calibre27">Kubernetes Compatibility</h2>

<p class="author1">Linkerd is tested with all currently active Kubernetes versions. Each version’s release notes contain the minimum supported Kubernetes version.</p>
</div></section>
</div></section>






<section data-pdf-bookmark="Going to Production with Linkerd" data-type="sect1" class="preface"><div class="preface" id="id331">
<h1 class="calibre8">Going to Production with Linkerd</h1>

<p class="author1">With that out of the way, we can dive into going to production with Linkerd.</p>








<section data-pdf-bookmark="Stable or Edge?" data-type="sect2" class="preface"><div class="preface" id="id332">
<h2 class="calibre27">Stable or Edge?</h2>

<p class="author1">For production use, your simplest path is going to be running a release from the stable channel, such as Buoyant Enterprise for Linkerd. Running an edge-channel release in production is definitely possible, though.</p>

<p class="author1">If you decide to run edge releases in production, it is <em class="hyperlink">critical</em> that you carefully read the release notes for any release you’re considering and that you give feedback about your experience to the Linkerd maintainers. The simplest way to do this is via the <a href="https://slack.linkerd.io" class="calibre4">community Slack</a>. Discussions or issues on <a href="https://oreil.ly/y0Zut" class="calibre4">GitHub</a> are also a great way to reach the Linkerd team.</p>
</div></section>








<section data-pdf-bookmark="Preparing Your Environment" data-type="sect2" class="preface"><div class="preface" id="id186">
<h2 class="calibre27">Preparing Your Environment</h2>

<p class="author1">The first step in making sure that<a data-primary="production" data-secondary="production-ready Linkerd" data-tertiary="preparing the environment" data-type="indexterm" id="id1752" class="calibre4"/><a data-primary="linkerd" data-secondary="check command" data-tertiary="--pre preinstall check" data-type="indexterm" id="id1753" class="calibre4"/><a data-primary="deploying Linkerd" data-secondary="linkerd check command" data-tertiary="--pre for preinstall check" data-type="indexterm" id="id1754" class="calibre4"/> your environment is ready for Linkerd is
always to run the CLI’s preflight check:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>check<code class="w"> </code>--pre<code class="w"/></pre>

<p class="author1">This will verify that your environment is ready to run Linkerd, paying
particular attention to Kubernetes permissions.</p>

<p class="author1">Beyond the preflight check, you also need to make sure that you understand
your environment’s particular security requirements. For example:<a data-primary="permissions" data-secondary="Pods NET_ADMIN" data-type="indexterm" id="id1755" class="calibre4"/></p>

<ul class="printings">
<li class="calibre6">
<p class="author1">If you can’t allow your Pods <code class="calibre9">NET_ADMIN</code> permissions, you’ll need to use the
Linkerd CNI plugin.</p>
</li>
<li class="calibre6">
<p class="author1">If you’re using the Kubernetes tainting mechanism and you have applied custom taints to the Nodes where you’ll be running the Linkerd control plane, you’ll need to add tolerations to the Linkerd deployments.</p>
</li>
<li class="calibre6">
<p class="author1">If you use network policies to segregate traffic, you’ll need to make sure
that your policies allow communication between the Linkerd control plane and
its proxies. You may also want to consider using the Linkerd policy mechanisms for
application-aware policy enforcement.</p>
</li>
</ul>

<p class="author1">In addition to communications, <a data-primary="workloads" data-secondary="adding to the mesh" data-tertiary="going to production with Linkerd" data-type="indexterm" id="id1756" class="calibre4"/><a data-primary="service meshes" data-secondary="adding workloads to" data-tertiary="going to production with Linkerd" data-type="indexterm" id="id1757" class="calibre4"/>you’ll also need to consider how you’ll handle adding
your application to the mesh, as discussed in <a data-type="xref" href="ch04.html#LUAR_meshing_workloads" class="calibre4">Chapter 4</a>.
For example, will you use namespace injection or workload injection? These
aren’t likely to be terribly complex decisions, but it’s still a good idea to
think about them ahead of time.</p>

<p class="author1">To recap, you add a workload to the mesh by instructing the Linkerd proxy injector, a mutating webhook, to add a proxy to a Pod at Pod creation time. That instruction can be passed by adding an annotation at either the namespace, workload, or Pod level:</p>

<pre data-code-language="yaml" data-type="programlisting" class="calibre36"><code class="nt">linkerd.io/inject</code><code class="p">:</code><code class="w"> </code><code class="calibre9">enabled</code><code class="w"/></pre>

<p class="author1">For production use, we recommend that you add the annotation at the namespace
or workload level. This will generally be the simplest way to manage meshing
application workloads, since it doesn’t require altering individual Pod
manifests. (There are some situations in which you may need to add the proxy directly to a Pod, as discussed in <a data-type="xref" href="ch06.html#LUAR_cli" class="calibre4">Chapter 6</a>, but they’re few and far between.)</p>

<p class="author1">In either case, you’ll want to configure your deployment tooling to add the
appropriate annotations during the deployment process, to ensure that your
workloads are all appropriately meshed. This is also the time to add any
exceptions to the cluster-wide configuration for skip and opaque ports, as
discussed in <a data-type="xref" href="ch04.html#LUAR_meshing_workloads" class="calibre4">Chapter 4</a>.</p>
<div data-type="note" epub:type="note" class="calibre16"><h1 class="calibre26">Explicitly Enabling Injection</h1>
<p class="author1">Remember that if you are adding the Linkerd proxy-injection annotations at the
namespace level, you can still override the injection behavior on individual
workloads by adding the following annotation to a Deployment:</p>

<pre data-code-language="yaml" data-type="programlisting" class="calibre56"><code class="nt">linkerd.io/inject</code><code class="p">:</code><code class="w"> </code><code class="calibre9">disabled</code><code class="w"/></pre>
</div>
</div></section>








<section data-pdf-bookmark="Configuring Linkerd for High Availability" data-type="sect2" class="preface"><div class="preface" id="id106">
<h2 class="calibre27">Configuring Linkerd for High Availability</h2>

<p class="author1">If you’re deploying Linkerd in production,<a data-primary="production" data-secondary="production-ready Linkerd" data-tertiary="high availability configuration" data-type="indexterm" id="ch14-ha" class="calibre4"/><a data-primary="high availability configuration" data-type="indexterm" id="ch14-ha2" class="calibre4"/> it means you’ve decided to add
critical security, observability, and reliability features to your production
application. Good for you! Unfortunately, all that new functionality comes
with some very real costs. Linkerd is now in the critical operating path for your
most critical workloads. If Linkerd suffers a catastrophic failure, you’re
likely to suffer a very real application outage, or at the very least a
degradation in service.</p>

<p class="author1">In order to mitigate these risks, the Linkerd project defines and supports
<em class="hyperlink">high availability</em> (HA) mode. HA mode modifies the way Linkerd is deployed, as
shown in <a data-type="xref" href="#linkerd-ha-mode" class="calibre4">Figure 14-1</a>.</p>

<figure class="calibre23"><div class="figure" id="linkerd-ha-mode">
<img alt="luar 1401" src="assets/luar_1401.png" class="calibre24"/>
<h6 class="calibre25"><span class="calibre">Figure 14-1. </span>Linkerd HA mode</h6>
</div></figure>
<div data-type="warning" epub:type="warning" class="calibre18"><h1 class="calibre35">Always Run HA in Production</h1>
<p class="author1">We <em class="hyperlink">strongly</em> recommend HA mode for any production use of Linkerd. If you
don’t explicitly install in HA mode, your Linkerd installation will have
several single points of failure that could cause downtime for your
application.</p>
</div>










<section data-pdf-bookmark="What does HA mode do?" data-type="sect3" class="preface"><div class="preface" id="id107">
<h3 class="calibre33">What does HA mode do?</h3>

<p class="author1">High availability mode makes<a data-primary="high availability configuration" data-secondary="about high availability" data-type="indexterm" id="ch14-hado" class="calibre4"/> a few significant changes to your Linkerd control
plane install. You can find all the details about exactly what HA mode
changes in the <a href="https://oreil.ly/eDjOq" class="calibre4">latest documentation</a>, and we
strongly encourage you to review this documentation when upgrading to make
sure that you’re working with the latest information.</p>

<p class="author1">The basic configuration, though, has been fairly consistent over time. In
broad strokes, HA mode:</p>
<dl class="calibre10">
<dt class="calibre11">Runs three replicas</dt>
<dd class="calibre12">
<p class="calibre13">In HA mode, each control plane component runs three replicas rather than just one,
to prevent failure of a single replica from taking down the whole mesh.</p>
</dd>
<dt class="calibre11">Sets anti-affinity</dt>
<dd class="calibre12">
<p class="calibre13">Additionally, HA mode creates anti-affinity rules that prevent any single Node
from running more than one replica of any control plane component. This
prevents a single Node failure from taking down the entire mesh.</p>
</dd>
<dt class="calibre11">Tightens resource limits</dt>
<dd class="calibre12">
<p class="calibre13">HA mode establishes much more aggressive CPU and memory resource requests and limits
than non-HA mode, to prevent any runaway processes from causing more
widespread problems for the cluster as a whole.</p>
</dd>
</dl>
<div data-type="note" epub:type="note" class="calibre16"><h1 class="calibre26">Verifying Requests and Limits</h1>
<p class="author1">These more aggressive limits set by HA mode function well for many
organizations, but you should view them as just a starting point: they may not
be what your organization needs. It’s important to actively monitor the
Linkerd control plane’s actual resource usage for your installation and tune
the requests and limits as needed.</p>

<p class="author1">In particular, a control plane component that hits its memory limit will be
OOMKilled and then restarted.
This can be easy to miss if it happens infrequently, but if it happens
consistently, you will likely suffer a production incident.</p>
</div>
<dl class="calibre10">
<dt class="calibre11">Makes the <code class="calibre14">proxy-injector</code> mandatory</dt>
<dd class="calibre12">
<p class="calibre13">In HA mode, the <code class="calibre9">proxy-injector</code> component of the Linkerd control plane is
<em class="hyperlink">required</em> to be healthy before <em class="hyperlink">any</em> Pod is allowed to be scheduled. This
reflects the fact that Linkerd is commonly responsible for ensuring secure
communications within your application. It is likely to be better to fail to
start an application Pod than to allow it to run without having Linkerd’s
proxy present to make it part of the mesh.</p>

<p class="calibre13">It’s important to realize, though, that this requirement is enforced using a
cluster-wide admission webhook, and as such it affects <em class="hyperlink">every</em> Pod in the
cluster, not just application workloads. This means that you <em class="hyperlink">must</em> exempt
critical cluster infrastructure namespaces, such as <code class="calibre9">kube-system</code>, from having
the policy enforced.</p>

<p class="calibre13">To exempt a namespace, apply the following label to the namespace:</p>

<pre data-code-language="yaml" data-type="programlisting" class="calibre36"><code class="nt">config.linkerd.io/admission-webhooks</code><code class="p">:</code><code class="w"> </code><code class="calibre9">disabled</code><code class="w"/></pre>
</dd>
</dl>
<div data-type="warning" epub:type="warning" class="calibre18"><h1 class="calibre35">No Admission Webhook for Infrastructure!</h1>
<p class="author1">You <em class="hyperlink">must</em> exempt infrastructure namespaces from the HA admission webhook.
If you don’t, you can easily end up deadlocked, with Linkerd waiting for system
infrastructure while system infrastructure is waiting for Linkerd.<a data-startref="ch14-hado" data-type="indexterm" id="id1758" class="calibre4"/></p>
</div>
</div></section>










<section data-pdf-bookmark="High availability installation with Helm" data-type="sect3" class="preface"><div class="preface" id="id187">
<h3 class="calibre33">High availability installation with Helm</h3>

<p class="author1">We recommend using Helm for production<a data-primary="high availability configuration" data-secondary="installation via Helm" data-type="indexterm" id="id1759" class="calibre4"/><a data-primary="Helm for Linkerd deployment" data-secondary="high availability installation" data-type="indexterm" id="id1760" class="calibre4"/><a data-primary="Helm for Linkerd deployment" data-secondary="Helm for Linkerd in production" data-type="indexterm" id="id1761" class="calibre4"/><a data-primary="Buoyant, Inc." data-secondary="Helm for Linkerd in production" data-type="indexterm" id="id1762" class="calibre4"/> Linkerd installs, including high availability
installs. A complicating factor is that high availability installations are
much more likely than other installations to need customized values for Helm.
To make this a bit easier, the Linkerd Helm chart includes a values file that
you can use as a basis for your high availability installation.</p>

<p class="author1">We recommend that you always refer to the
<a href="https://oreil.ly/GLiFw" class="calibre4">latest
high availability installation instructions</a> when deploying Linkerd HA with
Helm. A brief overview of the process at the time of writing is shown in
<a data-type="xref" href="#EX-prod-helm" class="calibre4">Example 14-1</a>.</p>
<div data-type="example" id="EX-prod-helm" class="calibre40">
<h5 class="calibre41"><span class="calibre">Example 14-1. </span>Installing Linkerd in HA mode with Helm</h5>

<pre data-code-language="bash" data-type="programlisting" class="calibre42"><code class="c"># Add the Linkerd stable repo</code>
$<code class="w"> </code>helm<code class="w"> </code>repo<code class="w"> </code>add<code class="w"> </code>linkerd<code class="w"> </code>https://helm.linkerd.io/stable<code class="w"/>

<code class="c"># Update your Helm repositories</code>
$<code class="w"> </code>helm<code class="w"> </code>repo<code class="w"> </code>update<code class="w"/>

<code class="c"># Pull down the latest version of the chart</code>
$<code class="w"> </code>helm<code class="w"> </code>fetch<code class="w"> </code>--untar<code class="w"> </code>linkerd/linkerd-control-plane<code class="w"/>

<code class="c"># Examine linkerd-control-plane/values-ha.yaml and edit if needed. The</code>
<code class="c"># edited file should be placed in version control and, as new charts are</code>
<code class="c"># released, periodically compared with the new values-ha.yaml files.</code>

<code class="c"># Install the Linkerd CRDs</code>
$<code class="w"> </code>helm<code class="w"> </code>install<code class="w"> </code>linkerd-crds<code class="w"> </code>linkerd/linkerd-crds<code class="w"> </code><code class="se">\</code>
<code class="w">  </code>-n<code class="w"> </code>linkerd<code class="w"> </code>--create-namespace<code class="w"/>

<code class="c"># Install the Linkerd control plane</code>
<code class="c"># Note the added reference to the values-ha.yaml file</code>
$<code class="w"> </code>helm<code class="w"> </code>install<code class="w"> </code>linkerd-control-plane<code class="w"> </code><code class="se">\</code>
<code class="w">  </code>-n<code class="w"> </code>linkerd<code class="w"> </code><code class="se">\</code>
<code class="w">  </code>--set-file<code class="w"> </code><code class="nv">identityTrustAnchorsPEM</code><code class="o">=</code>ca.crt<code class="w"> </code><code class="se">\</code>
<code class="w">  </code>--set-file<code class="w"> </code>identity.issuer.tls.crtPEM<code class="o">=</code>issuer.crt<code class="w"> </code><code class="se">\</code>
<code class="w">  </code>--set-file<code class="w"> </code>identity.issuer.tls.keyPEM<code class="o">=</code>issuer.key<code class="w"> </code><code class="se">\</code>
<code class="w">  </code>-f<code class="w"> </code>linkerd-control-plane/values-ha.yaml<code class="w"> </code><code class="se">\</code>
<code class="w">  </code>linkerd/linkerd-control-plane<code class="w"/>

<code class="c"># Ensure your install was successful</code>
$<code class="w"> </code>linkerd<code class="w"> </code>check<code class="w"/></pre></div>

<p class="author1">As noted in the comments, you should keep your version of <em class="hyperlink">values-ha.yaml</em> in version control. It’s an important resource for reinstallations and disaster recovery.</p>
</div></section>










<section data-pdf-bookmark="High availability installation with the CLI" data-type="sect3" class="preface"><div class="preface" id="id108">
<h3 class="calibre33">High availability installation with the CLI</h3>

<p class="author1">While we don’t generally recommend<a data-primary="high availability configuration" data-secondary="installation via CLI" data-type="indexterm" id="id1763" class="calibre4"/><a data-primary="Linkerd CLI" data-secondary="high availability installation" data-type="indexterm" id="id1764" class="calibre4"/> CLI-based installs for production
environments, you can use the Linkerd CLI to output deployment YAML configured
with all the HA options and then use this YAML as the basis for your actual
install process.</p>

<p class="author1">To do this, use the <code class="calibre9">linkerd install</code> command with the <code class="calibre9">--ha</code> flag, and
save the resulting YAML to a file:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>install<code class="w"> </code>--ha<code class="w"> </code>&gt;<code class="w"> </code>linkerd-ha.yaml<code class="w"/></pre>

<p class="author1">You can then put <em class="hyperlink">linkerd-ha.yaml</em> in version control and edit it as needed.<a data-startref="ch14-ha" data-type="indexterm" id="id1765" class="calibre4"/><a data-startref="ch14-ha2" data-type="indexterm" id="id1766" class="calibre4"/></p>
</div></section>
</div></section>
</div></section>






<section data-pdf-bookmark="Monitoring Linkerd" data-type="sect1" class="preface"><div class="preface" id="id188">
<h1 class="calibre8">Monitoring Linkerd</h1>

<p class="author1">There are commercial providers<a data-primary="monitoring Linkerd" data-secondary="about" data-type="indexterm" id="id1767" class="calibre4"/><a data-primary="production" data-secondary="production-ready Linkerd" data-see="monitoring Linkerd" data-tertiary="monitoring Linkerd" data-type="indexterm" id="id1768" class="calibre4"/> that will automatically configure Linkerd monitoring and alerting. For those of you looking to monitor Linkerd yourselves, we recommend you establish monitors to ensure Linkerd remains highly available in your 
<span class="calibre">environment.</span></p>








<section data-pdf-bookmark="Certificate Health and Expiration" data-type="sect2" class="preface"><div class="preface" id="id109">
<h2 class="calibre27">Certificate Health and Expiration</h2>

<p class="author1">The most common cause of Linkerd<a data-primary="monitoring Linkerd" data-secondary="certificates expiring" data-type="indexterm" id="id1769" class="calibre4"/><a data-primary="production" data-secondary="downtime from certificate expiration" data-type="indexterm" id="id1770" class="calibre4"/><a data-primary="debugging" data-secondary="certificates expiring" data-type="indexterm" id="id1771" class="calibre4"/> outages is expired certificates. Both the
trust anchor and identity issuer certificates must be valid at all times to
avoid downtime. As such, carefully monitoring your certificates to be certain
that you always renew them before they expire is crucial.</p>

<p class="author1">The <code class="calibre9">linkerd check</code> command<a data-primary="linkerd" data-secondary="check command" data-tertiary="certificate expiration warning" data-type="indexterm" id="id1772" class="calibre4"/> will begin warning you when your root or
issuer certs will expire in less than 60 days.</p>
<div data-type="warning" epub:type="warning" class="calibre18"><h1 class="calibre35">Never Let Your Certificates Expire</h1>
<p class="author1">Because Linkerd requires <a data-primary="certificates" data-secondary="Linkerd and" data-tertiary="never let certificates expire" data-type="indexterm" id="id1773" class="calibre4"/><a data-primary="expired certificates" data-type="indexterm" id="id1774" class="calibre4"/><a data-primary="mTLS (mutual TLS)" data-secondary="certificates should not expire" data-type="indexterm" id="id1775" class="calibre4"/><a data-primary="X.509 certificates" data-secondary="Linkerd and" data-tertiary="never let certificates expire" data-type="indexterm" id="id1776" class="calibre4"/>mTLS connections between Pods by default, the health
and security of the certificates it uses are absolutely critical to the
healthy operation of the mesh—and thus your platform. If certificates
expire, or can’t be generated for new Pods, <em class="hyperlink">you will incur downtime</em>.</p>

<p class="author1">This is the most common cause of downtime in production Linkerd clusters.
Understanding and monitoring your Linkerd certificates is vital.</p>
</div>
</div></section>








<section data-pdf-bookmark="Control Plane" data-type="sect2" class="preface"><div class="preface" id="id189">
<h2 class="calibre27">Control Plane</h2>

<p class="author1">Linkerd’s control plane is vital<a data-primary="monitoring Linkerd" data-secondary="control plane" data-type="indexterm" id="id1777" class="calibre4"/><a data-primary="control plane of Linkerd" data-secondary="monitoring" data-type="indexterm" id="id1778" class="calibre4"/> to the normal operation of your platform. You
should collect and measure Linkerd proxy metrics for the control plane,
like success rates, latency, and requests per second. Alert on aberrant
behavior and investigate situations where the success rates drop below 100%.</p>

<p class="author1">You should also closely monitor the resource consumption of the control plane
and ensure it never gets close to its CPU or memory limits.</p>
</div></section>








<section data-pdf-bookmark="Data Plane" data-type="sect2" class="preface"><div class="preface" id="id190">
<h2 class="calibre27">Data Plane</h2>

<p class="author1">The Linkerd proxy tends to be<a data-primary="monitoring Linkerd" data-secondary="data plane" data-type="indexterm" id="id1779" class="calibre4"/><a data-primary="data plane of Linkerd" data-secondary="monitoring" data-type="indexterm" id="id1780" class="calibre4"/> fairly uncomplicated and straightforward to
operate. That being said, it’s important to ensure the proxies aren’t
consuming more resources than they should be: if they are, it can indicate
excessive traffic or other issues. Monitor the resource usage on your proxies,
and ensure that their resource requests and limits match what they need in
order to handle application traffic.</p>

<p class="author1">It’s also wise to ensure you are monitoring<a data-primary="proxy injector of control plane" data-secondary="monitoring versions" data-type="indexterm" id="id1781" class="calibre4"/><a data-primary="Pods" data-secondary="startup process" data-tertiary="proxy version monitoring" data-type="indexterm" id="id1782" class="calibre4"/> the versions of the Linkerd proxies in your environment. The proxy will be deployed with the version defined by the proxy injector at the time a Pod is created. <a data-primary="Pods" data-secondary="restarting regularly" data-type="indexterm" id="id1783" class="calibre4"/>If your Pods aren’t restarted on a regular basis, the proxy version can get out of sync with the control plane. You will want to ensure your proxies are always within at least one major version of the control plane.</p>
</div></section>








<section data-pdf-bookmark="Metrics Collection" data-type="sect2" class="preface"><div class="preface" id="id110">
<h2 class="calibre27">Metrics Collection</h2>

<p class="author1">Any production installation of Linkerd<a data-primary="monitoring Linkerd" data-secondary="metrics collection" data-type="indexterm" id="id1784" class="calibre4"/><a data-primary="metrics" data-secondary="collecting for monitoring" data-type="indexterm" id="id1785" class="calibre4"/> also needs to account for what you will
do with the metrics data generated by Linkerd. Linkerd proxies are constantly
collecting useful information about the traffic going into and out of their
Pods, and<a data-primary="OpenTelemetry for metrics access" data-type="indexterm" id="id1786" class="calibre4"/><a data-primary="metrics" data-secondary="collecting for monitoring" data-tertiary="OpenTelemetry for metrics access" data-type="indexterm" id="id1787" class="calibre4"/> all this information is made available in such a way that any tool
compatible with OpenTe⁠lemetry should be able to access it. (Linkerd has also
long provided open source configuration details for configuring Prometheus to
scrape metrics from Linkerd.)</p>

<p class="author1">Linkerd is not itself a monitoring tool (though Linkerd Viz can consume
metrics and display many useful things about them); instead, it is designed to
provide metrics to whatever monitoring solution is already in use in your
environment. Whatever that is, one of the most important long-term tasks
facing a platform engineer responsible for a production Linkerd installation
is creating a plan for collecting, storing, and using all the metrics
generated by Linkerd, since effective long-term monitoring is extremely
valuable for understanding the behavior and health of your apps.</p>
</div></section>








<section data-pdf-bookmark="Linkerd Viz for Production Use" data-type="sect2" class="preface"><div class="preface" id="id191">
<h2 class="calibre27">Linkerd Viz for Production Use</h2>

<p class="author1">The Linkerd Viz extension consumes<a data-primary="monitoring Linkerd" data-secondary="metrics collection" data-tertiary="Linkerd Viz for display and diagnostics" data-type="indexterm" id="id1788" class="calibre4"/><a data-primary="Linkerd Viz extension" data-secondary="monitoring Linkerd with" data-type="indexterm" id="id1789" class="calibre4"/> metrics provided by Linkerd, using them to
enable some powerful diagnostics for Linkerd and providing a basic
open source dashboard (shown in <a data-type="xref" href="#linkerd-viz-dashboard" class="calibre4">Figure 14-2</a>) to make some of
these metrics more easily visible. As of Linkerd 2.12, the core visibility
data available from the CLI—from metrics to the state of a multicluster
gateway—requires the Linkerd Viz extension to be installed.</p>

<figure class="calibre23"><div class="figure" id="linkerd-viz-dashboard">
<img alt="luar 1402" src="assets/luar_1402.png" class="calibre24"/>
<h6 class="calibre25"><span class="calibre">Figure 14-2. </span>The Linkerd Viz dashboard</h6>
</div></figure>

<p class="author1">Though Linkerd Viz is not <em class="hyperlink">required</em> for<a data-primary="production" data-secondary="Linkerd Viz production-ready install" data-tertiary="recommended for production use" data-type="indexterm" id="id1790" class="calibre4"/><a data-primary="production" data-secondary="Linkerd Viz production-ready install" data-type="indexterm" id="id1791" class="calibre4"/><a data-primary="Linkerd Viz extension" data-secondary="production-ready install" data-type="indexterm" id="id1792" class="calibre4"/><a data-primary="Linkerd Viz extension" data-secondary="production-ready install" data-tertiary="recommended for production use" data-type="indexterm" id="id1793" class="calibre4"/> production use, we generally
recommend installing it. Running Viz in production requires careful attention
to three areas:</p>
<dl class="calibre10">
<dt class="calibre11">Prometheus and Linkerd Viz</dt>
<dd class="calibre12">
<p class="calibre13">When you install Linkerd Viz, it can<a data-primary="Linkerd Viz extension" data-secondary="Prometheus instance" data-tertiary="not for production" data-type="indexterm" id="id1794" class="calibre4"/><a data-primary="Prometheus" data-secondary="instance with Linkerd Viz extension" data-tertiary="not for production" data-type="indexterm" id="id1795" class="calibre4"/> install a Prometheus instance for you.
<em class="hyperlink">This Prometheus instance is not recommended for production use</em>, since it
uses an in-memory data store for metrics. As it saves more metrics data, it
will fill up its available memory and crash, losing all the metrics data it
had saved up to that point. In a busy production system, this can happen
multiple times a day.</p>

<p class="calibre13">To use Linkerd Viz in production,<a data-primary="Linkerd Viz extension" data-secondary="Prometheus instance" data-tertiary="persistent storage needed for production" data-type="indexterm" id="id1796" class="calibre4"/><a data-primary="Prometheus" data-secondary="persistent storage needed for production" data-type="indexterm" id="id1797" class="calibre4"/> therefore, you’ll need to use a different
Prometheus instance with persistent storage. <a data-primary="Linkerd Viz extension" data-secondary="Prometheus instance" data-tertiary="externalization documentation URL" data-type="indexterm" id="id1798" class="calibre4"/><a data-primary="resources online" data-secondary="Linkerd Viz extension documentation" data-tertiary="Prometheus externalization" data-type="indexterm" id="id1799" class="calibre4"/><a data-primary="Prometheus" data-secondary="externalization documentation URL" data-type="indexterm" id="id1800" class="calibre4"/>The full procedure for
externalizing Prometheus is shown in <a data-type="xref" href="ch10.html#EX12-production-prometheus" class="calibre4">Example 10-9</a>. You can
also review the official docs on
<a href="https://oreil.ly/i5knP" class="calibre4">externalizing Prometheus</a>.</p>
<div data-type="warning" epub:type="warning" class="calibre18"><h1 class="calibre35">Always Use Your Own Prometheus</h1>
<p class="calibre13">We’ll say it one more time: <em class="hyperlink">do not use the Prometheus installed by Linkerd Viz in production</em>. It stores your metrics only in RAM, and you <em class="hyperlink">will</em> lose
any historical data when it restarts.</p>

<p class="calibre13"><a data-type="xref" href="ch10.html#LUAR_observability" class="calibre4">Chapter 10</a> has more details on the right way to deal with
metrics.</p>
</div>
</dd>
<dt class="calibre11">Securing the Linkerd Viz dashboard</dt>
<dd class="calibre12">
<p class="calibre13">The open source Linkerd Viz dashboard<a data-primary="dashboards" data-secondary="Linkerd Viz extension" data-tertiary="securing the dashboard" data-type="indexterm" id="id1801" class="calibre4"/><a data-primary="Linkerd Viz extension" data-secondary="dashboard unauthenticated" data-tertiary="securing the dashboard" data-type="indexterm" id="id1802" class="calibre4"/> provides access to important information
about your cluster, including metrics, Linkerd Tap, and more. For ease of
experimentation, it does not include any authentication mechanism; as such, we
<em class="hyperlink">do not recommend</em> this configuration for production.</p>

<p class="calibre13">If you intend to make the Linkerd Viz dashboard available in production, we
<em class="hyperlink">strongly recommend</em> limiting access to it using your ingress controller as
well as Linkerd authorization policy. You can learn more about ingress
controllers in <a data-type="xref" href="ch05.html#LUAR_ingress_and_linkerd" class="calibre4">Chapter 5</a>, and <a data-primary="dashboards" data-secondary="Linkerd Viz extension" data-tertiary="securing the dashboard documentation URL" data-type="indexterm" id="id1803" class="calibre4"/><a data-primary="resources online" data-secondary="Linkerd Viz extension documentation" data-tertiary="securing the dashboard" data-type="indexterm" id="id1804" class="calibre4"/><a data-primary="Linkerd Viz extension" data-secondary="dashboard unauthenticated" data-tertiary="securing the dashboard documentation URL" data-type="indexterm" id="id1805" class="calibre4"/><a data-primary="documentation for Linkerd online" data-secondary="securing the Linkerd Viz dashboard" data-type="indexterm" id="id1806" class="calibre4"/>more about exactly how to
secure the Linkerd Viz dashboard in
<a href="https://oreil.ly/Ivenb" class="calibre4">the Linkerd docs</a>.</p>
</dd>
<dt class="calibre11">Securing Linkerd Tap</dt>
<dd class="calibre12">
<p class="calibre13">Linkerd Tap allows operators to<a data-primary="Tap component of Linkerd Viz extension" data-secondary="securing" data-type="indexterm" id="id1807" class="calibre4"/><a data-primary="Linkerd Viz extension" data-secondary="Tap component" data-tertiary="securing" data-type="indexterm" id="id1808" class="calibre4"/><a data-primary="metadata via Tap of Linkerd Viz" data-secondary="securing Tap" data-type="indexterm" id="id1809" class="calibre4"/> view the metadata about requests between
applications in your environment. Though it cannot ever access unencrypted
message bodies, it is still important to secure access to Linkerd Tap since
many organizations include potentially sensitive information in their URLs or
headers that should not be exposed to everyone with access to the cluster.
Access to Linkerd Tap is provided via the <code class="calibre9">linkerd-linkerd-tap-admin</code> ClusterRole.</p>

<p class="calibre13">You can read more about<a data-primary="Linkerd Viz extension" data-secondary="Tap component" data-tertiary="securing documentation URL" data-type="indexterm" id="id1810" class="calibre4"/><a data-primary="Tap component of Linkerd Viz extension" data-secondary="securing" data-tertiary="documentation URL" data-type="indexterm" id="id1811" class="calibre4"/><a data-primary="resources online" data-secondary="Linkerd Viz extension documentation" data-tertiary="securing Tap" data-type="indexterm" id="id1812" class="calibre4"/><a data-primary="documentation for Linkerd online" data-secondary="securing the Linkerd Viz Tap" data-type="indexterm" id="id1813" class="calibre4"/> securing Tap traffic in the
<a href="https://oreil.ly/wjWnb" class="calibre4">Linkerd docs</a>, but the most
basic operation here is to give a Kubernetes account permission to access
Linkerd Tap. That can be done with the role binding shown in <a data-type="xref" href="#EX-prod-tap" class="calibre4">Example 14-2</a>.</p>
<div data-type="example" id="EX-prod-tap" class="calibre40">
<h5 class="calibre41"><span class="calibre">Example 14-2. </span>Accessing Linkerd Tap</h5>

<pre data-code-language="bash" data-type="programlisting" class="calibre42">$<code class="w"> </code><code class="nb">export</code><code class="w"> </code><code class="nv">USER</code><code class="o">=</code>&lt;target_username&gt;<code class="w"/>
$<code class="w"> </code>kubectl<code class="w"> </code>create<code class="w"> </code>clusterrolebinding<code class="w"> </code><code class="se">\</code>
<code class="w">  </code><code class="s">"</code><code class="si">${</code><code class="nv">USER</code><code class="si">}</code><code class="s">"</code>-tap-admin<code class="w"> </code><code class="se">\</code>
<code class="w">  </code>--clusterrole<code class="o">=</code>linkerd-linkerd-viz-tap-admin<code class="w"> </code><code class="se">\</code>
<code class="w">  </code>--user<code class="o">=</code><code class="s">"</code><code class="si">${</code><code class="nv">USER</code><code class="si">}</code><code class="s">"</code><code class="w"/></pre></div>
</dd>
</dl>
</div></section>








<section data-pdf-bookmark="Accessing Linkerd Logs" data-type="sect2" class="preface"><div class="preface" id="accessing_linkerd_logs_ch14">
<h2 class="calibre27">Accessing Linkerd Logs</h2>

<p class="author1">The Linkerd control plane and<a data-primary="Linkerd" data-secondary="logs" data-type="indexterm" id="id1814" class="calibre4"/><a data-primary="monitoring Linkerd" data-secondary="logs" data-type="indexterm" id="id1815" class="calibre4"/><a data-primary="kubectl" data-secondary="Linkerd logs" data-type="indexterm" id="id1816" class="calibre4"/><a data-primary="logging by Linkerd" data-type="indexterm" id="id1817" class="calibre4"/> the Linkerd proxies all emit log information,
accessible using <code class="calibre9">kubectl logs</code>, that can be valuable for troubleshooting any
active incidents or investigating anomalous behavior. <a data-primary="logging by Linkerd" data-secondary="log level" data-type="indexterm" id="id1818" class="calibre4"/><a data-primary="Linkerd" data-secondary="logs" data-tertiary="log level" data-type="indexterm" id="id1819" class="calibre4"/><a data-primary="monitoring Linkerd" data-secondary="logs" data-tertiary="log level" data-type="indexterm" id="id1820" class="calibre4"/>Each log message emitted
has an associated <em class="hyperlink">log level</em>:</p>
<dl class="calibre10">
<dt class="calibre11"><code class="calibre14">ERROR</code></dt>
<dd class="calibre12">
<p class="calibre13">Messages that indicate serious problems with Linkerd that must be
resolved in order to continue operating the mesh</p>
</dd>
<dt class="calibre11"><code class="calibre14">WARNING</code></dt>
<dd class="calibre12">
<p class="calibre13">Messages that indicate problems that should be resolved but won’t
prevent the mesh from functioning</p>
</dd>
<dt class="calibre11"><code class="calibre14">INFO</code></dt>
<dd class="calibre12">
<p class="calibre13">Informational messages</p>
</dd>
<dt class="calibre11"><code class="calibre14">DEBUG</code></dt>
<dd class="calibre12">
<p class="calibre13">Messages that are only for <a data-primary="debugging" data-secondary="DEBUG-level log messages" data-type="indexterm" id="id1821" class="calibre4"/>debugging and usually require knowledge of
Linkerd to interpret</p>
</dd>
</dl>

<p class="author1">By default, Linkerd components are configured to emit messages at the <code class="calibre9">INFO</code>
level and higher. If necessary, you can override this configuration so that
Linkerd will emit <code class="calibre9">DEBUG</code> messages too. (It is not recommended to turn off
<code class="calibre9">INFO</code>-level messages.) Switching the log level requires a restart for the
control plane, though Linkerd proxies can change their log level at runtime.</p>

<p class="author1">You should only switch Linkerd to emit <code class="calibre9">DEBUG</code>-level log messages while
actively troubleshooting an issue; emitting <code class="calibre9">DEBUG</code>-level logs has real
performance implications for Linkerd itself, and the extra log volume can
quickly overwhelm log aggregators.</p>

<p class="author1">On that note, when monitoring your Linkerd environment it’s worthwhile to
monitor the log level of your Linkerd components to ensure they haven’t been
mistakenly left emitting <code class="calibre9">DEBUG</code> logs.</p>
</div></section>
</div></section>






<section data-pdf-bookmark="Upgrading Linkerd" data-type="sect1" class="preface"><div class="preface" id="id112">
<h1 class="calibre8">Upgrading Linkerd</h1>

<p class="author1">Linkerd is designed to be safe<a data-primary="Linkerd" data-secondary="upgrading" data-type="indexterm" id="id1822" class="calibre4"/><a data-primary="upgrading Linkerd" data-type="indexterm" id="id1823" class="calibre4"/><a data-primary="production" data-secondary="upgrading Linkerd" data-type="indexterm" id="id1824" class="calibre4"/> to operate and upgrade. Upgrades within the
same major version are generally safe and, if high availability mode is
configured, can be confidently performed without any loss of functionality.
That being said, in all cases it’s wise to test your upgrades, and upgrade
processes, in your nonproduction environments before moving to production.</p>

<p class="author1">When using releases from the stable channel, remember that major version upgrades, <a data-primary="Linkerd" data-secondary="upgrading" data-tertiary="major version upgrades" data-type="indexterm" id="id1825" class="calibre4"/><a data-primary="upgrading Linkerd" data-secondary="major version upgrades" data-type="indexterm" id="id1826" class="calibre4"/><a data-primary="production" data-secondary="upgrading Linkerd" data-tertiary="major version upgrades" data-type="indexterm" id="id1827" class="calibre4"/>unlike minor version upgrades, can contain breaking changes. Linkerd 2.10, 2.11, and 2.12 all contained significant changes to the operation of Linkerd that required many users to change their deployment strategies or carefully test the behavior of their applications. It is incumbent on you as the platform operator to carefully read the release notes for a new major version before deploying and test your upgrade process before moving to production.</p>
<div data-type="warning" epub:type="warning" class="calibre18"><h1 class="calibre35">Never Skip Major Versions</h1>
<p class="author1">When upgrading, <em class="hyperlink">never</em> skip major versions; <a data-primary="upgrading Linkerd" data-secondary="major version upgrades" data-tertiary="never skip" data-type="indexterm" id="id1828" class="calibre4"/>for example, an upgrade from
2.12.5 to 2.14.3 is <em class="hyperlink">not supported</em>. Upgrades are tested only across a
single major version; attempting to skip will land you in uncharted territory
and could easily cause downtime.</p>
</div>

<p class="author1">Note that you should <em class="hyperlink">always</em> read the upgrade instructions for a given
release before upgrading; for example, Linkerd 2.12 added a new step to the
process. <a data-primary="Linkerd" data-secondary="upgrading" data-tertiary="documentation URL" data-type="indexterm" id="id1829" class="calibre4"/><a data-primary="production" data-secondary="upgrading Linkerd" data-tertiary="documentation URL" data-type="indexterm" id="id1830" class="calibre4"/><a data-primary="upgrading Linkerd" data-secondary="documentation URL" data-type="indexterm" id="id1831" class="calibre4"/><a data-primary="Linkerd" data-secondary="documentation URL" data-tertiary="upgrading Linkerd" data-type="indexterm" id="id1832" class="calibre4"/><a data-primary="documentation for Linkerd online" data-secondary="upgrading Linkerd" data-type="indexterm" id="id1833" class="calibre4"/><a data-primary="resources online" data-secondary="Linkerd documentation" data-tertiary="upgrading Linkerd" data-type="indexterm" id="id1834" class="calibre4"/>This is especially important when using releases from the edge channel! You can find the latest instructions in the
<a href="https://oreil.ly/Mmou7" class="calibre4">Linkerd upgrade documentation</a>.</p>

<p class="author1">As with Linkerd installs, the project supports two main pathways for upgrading.</p>








<section data-pdf-bookmark="Upgrading via Helm" data-type="sect2" class="preface"><div class="preface" id="upgrading_via_helm_ch14">
<h2 class="calibre27">Upgrading via Helm</h2>

<p class="author1">Using Helm is the recommended<a data-primary="upgrading Linkerd" data-secondary="Helm for upgrading" data-type="indexterm" id="id1835" class="calibre4"/><a data-primary="production" data-secondary="upgrading Linkerd" data-tertiary="Helm for upgrading" data-type="indexterm" id="id1836" class="calibre4"/><a data-primary="Linkerd" data-secondary="upgrading" data-tertiary="Helm for upgrading" data-type="indexterm" id="id1837" class="calibre4"/><a data-primary="Helm for Linkerd deployment" data-secondary="upgrading Linkerd" data-type="indexterm" id="id1838" class="calibre4"/><a data-primary="Buoyant, Inc." data-secondary="Helm for Linkerd in production" data-tertiary="upgrading Linkerd" data-type="indexterm" id="id1839" class="calibre4"/><a data-primary="Helm for Linkerd deployment" data-secondary="Helm for Linkerd in production" data-tertiary="upgrading Linkerd" data-type="indexterm" id="id1840" class="calibre4"/> method for production installations and upgrades.</p>
<div data-type="note" epub:type="note" class="calibre16"><h1 class="calibre26">Read the Instructions</h1>
<p class="author1">Remember to read the <a href="https://oreil.ly/7IhPt" class="calibre4">Linkerd upgrade
instructions</a> before starting the upgrade!<a data-primary="linkerd" data-secondary="check command" data-tertiary="upgrading Linkerd" data-type="indexterm" id="id1841" class="calibre4"/></p>
</div>

<p class="author1">Here’s the process:</p>
<ol class="calibre54">
<li class="calibre55">
<p class="author1">Ensure that the control plane itself is healthy and that Linkerd is running cleanly:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>check<code class="w"/></pre>
</li>
<li class="calibre55">
<p class="author1">If <code class="calibre9">linkerd check</code> reveals any issues, address them <em class="hyperlink">before</em> moving
forward. Trying to upgrade when the control plane is not functioning correctly
can cause major problems.</p>
</li>
<li class="calibre55">
<p class="author1">Once you know that the control plane is running smoothly, pull down updates to
your Helm repositories:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>helm<code class="w"> </code>repo<code class="w"> </code>update<code class="w"/></pre>
</li>
<li class="calibre55">
<p class="author1">Next, update the Linkerd Helm charts. Note that as of Linkerd 2.12, there are two distinct Helm charts, and you need to run upgrades for both.</p>

<p class="author1">First, upgrade the Linkerd CRDs:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>helm<code class="w"> </code>upgrade<code class="w"> </code>linkerd-crds<code class="w"> </code>-n<code class="w"> </code>linkerd<code class="w"> </code>linkerd/linkerd-crds<code class="w"/></pre>

<p class="author1">Once that’s done, upgrade the control plane itself:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>helm<code class="w"> </code>upgrade<code class="w"> </code>linkerd-control-plane<code class="w"> </code><code class="se">\</code>
<code class="w">  </code>-n<code class="w"> </code>linkerd<code class="w"> </code>linkerd/linkerd-control-plane<code class="w"/></pre>
</li>
<li class="calibre55">
<p class="author1">Once again, ensure that the control plane is healthy:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>check<code class="w"/></pre>
</li>

</ol>
</div></section>








<section data-pdf-bookmark="Upgrading via the CLI" data-type="sect2" class="preface"><div class="preface" id="id193">
<h2 class="calibre27">Upgrading via the CLI</h2>

<p class="author1">Linkerd’s CLI has an <code class="calibre9">upgrade</code> command<a data-primary="upgrading Linkerd" data-secondary="CLI for upgrading" data-type="indexterm" id="id1842" class="calibre4"/><a data-primary="linkerd" data-secondary="upgrade command" data-type="indexterm" id="id1843" class="calibre4"/><a data-primary="production" data-secondary="upgrading Linkerd" data-tertiary="CLI for upgrading" data-type="indexterm" id="id1844" class="calibre4"/><a data-primary="Linkerd" data-secondary="upgrading" data-tertiary="CLI for upgrading" data-type="indexterm" id="id1845" class="calibre4"/> that will output YAML that can be
directly applied to your Kubernetes cluster to upgrade the Linkerd control
plane. While we generally recommend using Helm to upgrade Linkerd, the Linkerd
CLI may better fit some workflows.</p>
<div data-type="note" epub:type="note" class="calibre16"><h1 class="calibre26">Read the Instructions</h1>
<p class="author1">Remember to read the <a href="https://oreil.ly/7IhPt" class="calibre4">Linkerd upgrade
instructions</a> before starting the upgrade!</p>
</div>

<p class="author1">The basic process for upgrading the via the CLI is:<a data-primary="linkerd" data-secondary="check command" data-tertiary="upgrading Linkerd" data-type="indexterm" id="id1846" class="calibre4"/></p>
<ol class="calibre54">
<li class="calibre55">
<p class="author1">Ensure that the control plane itself is healthy and that Linkerd is running cleanly:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>check<code class="w"/></pre>
</li>
<li class="calibre55">
<p class="author1">If <code class="calibre9">linkerd check</code> reveals any issues, address them <em class="hyperlink">before</em> moving
forward. Trying to upgrade when the control plane is not functioning correctly
can cause major problems.</p>
</li>
<li class="calibre55">
<p class="author1">Start the upgrade process itself by installing the latest version of the
Linkerd CLI. This allows the CLI to fetch the latest versions of the various
Linkerd installation resources:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>curl<code class="w"> </code>--proto<code class="w"> </code><code class="s">'=https'</code><code class="w"> </code>--tlsv1.2<code class="w"> </code>-sSfL<code class="w"> </code>https://run.linkerd.io/install<code class="w"> </code><code class="p">|</code><code class="w"> </code>sh<code class="w"/></pre>

<p class="author1">Confirm you’re running the latest version with:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>version<code class="w"> </code>--client<code class="w"/></pre>
</li>
<li class="calibre55">
<p class="author1">Upgrade the control plane running in the cluster:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>upgrade<code class="w"> </code><code class="se">\</code>
<code class="w">    </code><code class="p">|</code><code class="w"> </code>kubectl<code class="w"> </code>apply<code class="w"> </code>--prune<code class="w"> </code>-l<code class="w"> </code>linkerd.io/control-plane-ns<code class="o">=</code>linkerd<code class="w"> </code>-f<code class="w"> </code>-<code class="w"/></pre>

<p class="author1">Using the <code class="calibre9">--prune</code> flag ensures that resources that are no longer required
are removed from your cluster.</p>
<div data-type="note" epub:type="note" class="calibre16"><h1 class="calibre26">Seriously, Read the Instructions!</h1>
<p class="author1">As an illustration of why reading the instructions is important, upgrading to
Linkerd 2.12 required passing a much more complex set of pruning instructions to <code class="calibre9">kubectl apply</code>!</p>

<p class="author1">The upgrade instructions can change with each major version, which is why you
should <em class="hyperlink">always</em> read the <a href="https://oreil.ly/o_Aef" class="calibre4">latest documentation</a> before upgrading.</p>
</div>
</li>
<li class="calibre55">
<p class="author1">Once again, ensure that the control plane is healthy:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>check<code class="w"/></pre>
</li>

</ol>
</div></section>
</div></section>






<section data-pdf-bookmark="Readiness Checklist" data-type="sect1" class="preface"><div class="preface" id="id194">
<h1 class="calibre8">Readiness Checklist</h1>

<p class="author1">There’s a lot separating a small <a data-primary="production" data-secondary="production-ready Linkerd" data-tertiary="checklist for readiness" data-type="indexterm" id="id1847" class="calibre4"/><a data-primary="production" data-secondary="checklist for production readiness" data-type="indexterm" id="id1848" class="calibre4"/>demo environment from a major production
environment, as we’ve just covered! The following checklist covers
some of the most important things to consider when taking Linkerd into
production:</p>

<ul class="printings">
<li class="calibre6">
<p class="author1">I’ve run Linkerd’s preflight checks with my installation credentials.</p>
</li>
<li class="calibre6">
<p class="author1">I’m mirroring the Linkerd images into my own internal registry.</p>
</li>
<li class="calibre6">
<p class="author1">I’m confident I have the capacity on my cluster to run Linkerd’s control plane in high availability mode.</p>
</li>
<li class="calibre6">
<p class="author1">I have a plan to run Linkerd in HA mode.</p>
</li>
<li class="calibre6">
<p class="author1">I have created my own certificates for Linkerd.</p>

<ul class="printings">
<li class="calibre6">
<p class="author1">I have a plan to securely store and rotate those certificates.</p>
</li>
<li class="calibre6">
<p class="author1">I have created monitors to ensure I will be notified before my certificates expire.</p>
</li>
</ul>
</li>
<li class="calibre6">
<p class="author1">I have identified the various non-HTTP workloads in use in my environment.</p>

<ul class="printings">
<li class="calibre6">
<p class="author1">I am aware of which ones are in the mesh and which are not.</p>
</li>
</ul>
</li>
<li class="calibre6">
<p class="author1">I have annotated the <code class="calibre9">kube-system</code> namespace to ensure it will operate normally without the proxy injector being available.</p>
</li>
<li class="calibre6">
<p class="author1">I have ensured the <code class="calibre9">linkerd</code> namespace will not be configured for auto-injection.</p>
</li>
<li class="calibre6">
<p class="author1">I have ensured the <code class="calibre9">kube-system</code> namespace will not be configured for auto-injection.</p>
</li>
<li class="calibre6">
<p class="author1">I am aware of any other namespaces that I need to ensure do not get injected by the proxy.</p>

<ul class="printings">
<li class="calibre6">
<p class="author1">I have exempted them from the injector failure policy.</p>
</li>
</ul>
</li>
<li class="calibre6">
<p class="author1">I have a plan for adding the appropriate annotations to my workloads.</p>
</li>
<li class="calibre6">
<p class="author1">I have a plan for gathering and storing Linkerd metrics.</p>
</li>
<li class="calibre6">
<p class="author1">I have tooling in place to ensure Linkerd is healthy and that I will be notified if there is an issue.</p>
</li>
</ul>

<p class="author1">If you are able to check off most or all of these items, you are well on your way to being able to confidently run Linkerd in production.</p>
</div></section>






<section data-pdf-bookmark="Summary" data-type="sect1" class="preface"><div class="preface" id="id333">
<h1 class="calibre8">Summary</h1>

<p class="author1">In this chapter, we covered many of the core tasks and concerns involved with
running Linkerd in production. No two organizations have identical operational
constraints and requirements, so, as with everything else in technology, you
should be prepared to adapt this advice to your real-world circumstances. If
you have particular operational concerns, or want help running Linkerd, we
recommend connecting with the Linkerd community or establishing a commercial
relationship with a vendor that provides support or management for Linkerd.</p>
</div></section>
</div></section></body></html>