<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 16. Miscellaneous Topics"><div class="chapter" id="CH16_EXTRA_TOPICS">
<h1><span class="label">Chapter 16. </span>Miscellaneous Topics</h1>


<p>The idea of this chapter is to go beyond troubleshooting a query,  or an overloaded system, or setting up different MySQL topologies. We want to show you the arsenal of tools available for you to make daily tasks easier or investigate complex issues. Let’s start with MySQL Shell.</p>






<section data-type="sect1" data-pdf-bookmark="MySQL Shell"><div class="sect1" id="MYSQL-SHELL">
<h1>MySQL Shell</h1>

<p>MySQL Shell is an advanced client and code editor for MySQL.<a data-type="indexterm" data-primary="MySQL Shell" data-secondary="about" id="idm46177445662888"/> It expands the functionality of the traditional MySQL client that most DBAs worked with in MySQL 5.6 and 5.7. MySQL Shell supports programming languages such as Python, JavaScript, and SQL. It also extends functionalities using an API command syntax. For example, it is possible to customize scripts to administer an InnoDB Cluster. From MySQL Shell, you can also start and configure MySQL sandbox instances.</p>








<section data-type="sect2" data-pdf-bookmark="Installing MySQL Shell"><div class="sect2" id="idm46177445661224">
<h2>Installing MySQL Shell</h2>

<p>For supported Linux distributions, the easiest way to install<a data-type="indexterm" data-primary="MySQL Shell" data-secondary="installing" id="ch16-inst"/><a data-type="indexterm" data-primary="Linux" data-secondary="MySQL Shell installation" id="ch16-inst2"/> MySQL Shell is to use the MySQL <em>yum</em> or <em>apt</em> repository. Let’s see how to install it on Ubuntu and CentOS.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Installing MySQL Shell on Ubuntu 20.04 Focal Fossa"><div class="sect2" id="idm46177445656232">
<h2>Installing MySQL Shell on Ubuntu 20.04 Focal Fossa</h2>

<p>Installing MySQL Shell in Ubuntu is relatively easy since it is part of the regular repositories.<a data-type="indexterm" data-primary="Linux" data-secondary="Ubuntu" data-tertiary="MySQL Shell installation" id="idm46177445654344"/><a data-type="indexterm" data-primary="Ubuntu Linux" data-secondary="MySQL Shell installation" id="idm46177445653032"/></p>

<p>First, we need to configure the MySQL repository. We can use these commands to <a href="https://oreil.ly/K7eq8">download</a> the <em>apt</em> repository to our server and install it:</p>

<pre data-type="programlisting"># <strong>wget  https://dev.mysql.com/get/mysql-apt-config_0.8.16-1_all.deb</strong>
# <strong>dpkg -i mysql-apt-config_0.8.16-1_all.deb</strong></pre>

<p>Once installed, update our package information:</p>

<pre data-type="programlisting"># <strong>apt-get update</strong></pre>

<p>Then execute the <code>install</code> command to install MySQL Shell:</p>

<pre data-type="programlisting"># <strong>apt-get install mysql-shell</strong></pre>

<p>We can now start MySQL Shell using the command line:</p>

<pre data-type="programlisting"># <strong>mysqlsh</strong></pre>

<pre data-type="programlisting">MySQL Shell 8.0.23

Copyright (c) 2016, 2021, Oracle and/or its affiliates.
Oracle is a registered trademark of Oracle Corporation and/or its affiliates.
Other names may be trademarks of their respective owners.

Type '\help' or '\?' for help; '\quit' to exit.
 MySQL  JS &gt;</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Installing MySQL Shell on CentOS 8"><div class="sect2" id="idm46177445655528">
<h2>Installing MySQL Shell on CentOS 8</h2>

<p>To install MySQL Shell in CentOS 8, we follow the same steps<a data-type="indexterm" data-primary="Linux" data-secondary="CentOS 8 Linux" data-tertiary="MySQL Shell installation" id="idm46177445641464"/><a data-type="indexterm" data-primary="CentOS 8 Linux" data-secondary="MySQL Shell installation" id="idm46177445640120"/> as described for Ubuntu—but first we need to make sure the default MySQL package present in 
<span class="keep-together">CentOS</span> 8 is disabled:</p>

<pre data-type="programlisting"># <strong>yum remove mysql-community-release -y</strong></pre>

<pre data-type="programlisting">No match for argument: mysql-community-release
No packages marked for removal.
Dependencies resolved.
Nothing to do.
Complete!</pre>

<pre data-type="programlisting"># <strong>dnf erase mysql-community-release</strong></pre>

<pre data-type="programlisting">No match for argument: mysql-community-release
No packages marked for removal.
Dependencies resolved.
Nothing to do.
Complete!</pre>

<p>Next, we are going to configure our <em>yum</em> repository. We need to get the correct OS version from the <a href="https://oreil.ly/YvW74">download page</a>:</p>

<pre data-type="programlisting"># <strong>yum install</strong> \
    <strong>https://dev.mysql.com/get/mysql80-community-release-el8-1.noarch.rpm -y</strong></pre>

<p>With the repository installed, we will install the MySQL Shell binary:</p>

<pre data-type="programlisting"># <strong>yum install mysql-shell -y</strong></pre>

<p>And we can validate that the installation worked by running it:<a data-type="indexterm" data-startref="ch16-inst" id="idm46177445629448"/><a data-type="indexterm" data-startref="ch16-inst2" id="idm46177445628664"/></p>

<pre data-type="programlisting"># <strong>mysqlsh</strong></pre>

<pre data-type="programlisting">MySQL Shell 8.0.23

Copyright (c) 2016, 2021, Oracle and/or its affiliates.
Oracle is a registered trademark of Oracle Corporation and/or its affiliates.
Other names may be trademarks of their respective owners.

Type '\help' or '\?' for help; '\quit' to exit.
 MySQL  JS &gt;</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Deploying a Sandbox InnoDB Cluster with MySQL Shell"><div class="sect2" id="idm46177445642520">
<h2>Deploying a Sandbox InnoDB Cluster with MySQL Shell</h2>

<p>MySQL Shell automates the deployment of sandbox instances<a data-type="indexterm" data-primary="MySQL Shell" data-secondary="sandbox deployment" id="ch16-san5"/><a data-type="indexterm" data-primary="installation of MySQL" data-secondary="sandboxes" data-tertiary="MySQL Shell deploying" id="ch16-san4"/><a data-type="indexterm" data-primary="sandboxes" data-secondary="MySQL Shell deploying" id="ch16-san"/><a data-type="indexterm" data-primary="InnoDB Cluster and MySQL Router" data-secondary="MySQL Shell deploying sandbox" id="ch16-san2"/><a data-type="indexterm" data-primary="replication" data-secondary="MySQL Shell deploying sandboxes" id="ch16-san3"/> with AdminAPI, which provides the <code>dba.deploySandboxInstance(</code><em><code>port_number</code></em><code>)</code> command.</p>

<p>By default, the sandbox instances are placed in a directory named <em>$HOME/mysql-sandboxes/port</em>. Let’s see how to change the directory:</p>

<pre data-type="programlisting"># <strong>mkdir /var/lib/sandboxes</strong>
# <strong>mysqlsh</strong></pre>

<pre data-type="programlisting" data-code-language="mysql"><code> </code><code class="n">MySQL</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">shell</code><code class="p">.</code><code class="n">options</code><code class="p">.</code><code class="n">sandboxDir</code><code class="o">=</code><code class="s1">'/var/lib/sandboxes'</code></strong></pre>

<pre data-type="programlisting">/var/lib/sandboxes</pre>

<p>A prerequiste to deploy a sandbox instance is to install the MySQL binaries. If necessary, review <a data-type="xref" href="ch01.xhtml#CH1_INSTALL">Chapter 1</a> for details. You’ll need to enter a password for the <code>root</code> user in order to complete the deployment:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">MySQL</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">dba</code><code class="p">.</code><code class="nf">deploySandboxInstance</code><code class="p">(</code><code class="mi">3310</code><code class="p">)</code></strong></pre>

<pre data-type="programlisting">A new MySQL sandbox instance will be created on this host in
/var/lib/sandboxes/3310

Warning: Sandbox instances are only suitable for deploying and
running on your local machine for testing purposes and are not
accessible from external networks.

Please enter a MySQL root password for the new instance: ******

Deploying new MySQL instance...

Instance localhost:3310 successfully deployed and started.
Use shell.connect('root@localhost:3310') to connect to the instance.</pre>

<p>We are going to deploy two more instances:</p>

<pre data-type="programlisting" data-code-language="mysql"><code> </code><code class="n">MySQL</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">dba</code><code class="p">.</code><code class="nf">deploySandboxInstance</code><code class="p">(</code><code class="mi">3320</code><code class="p">)</code></strong><code>
 </code><code class="n">MySQL</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">dba</code><code class="p">.</code><code class="nf">deploySandboxInstance</code><code class="p">(</code><code class="mi">3330</code><code class="p">)</code></strong></pre>

<p>The next step is to create the InnoDB Cluster while connected to the seed MySQL Server instance.<a data-type="indexterm" data-primary="MySQL Shell" data-secondary="sandbox deployment" data-tertiary="seed instance" id="idm46177445517224"/><a data-type="indexterm" data-primary="seed instance" id="idm46177445516072"/><a data-type="indexterm" data-primary="replication" data-secondary="seed instance" id="idm46177445515400"/><a data-type="indexterm" data-primary="sandboxes" data-secondary="MySQL Shell deploying" data-tertiary="seed instance" id="idm46177445514456"/><a data-type="indexterm" data-primary="replication" data-secondary="MySQL Shell deploying sandboxes" data-tertiary="seed instance" id="idm46177445513240"/> The <em>seed</em> instance is the instance we are connected to via MySQL Shell and that we want to replicate to the other instances. In this example the sandbox instances are all blank instances, so we can choose any instance. In a production setup the seed instance would be the one that contains the existing dataset to be replicated to the other instances in the cluster.</p>

<p>We use this command to connect MySQL Shell to the seed instance, in this case the one at port 3310:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">MySQL</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="err">\</code><code class="n">connect</code><code> </code><code class="n">root</code><code class="o">@</code><code class="n">localhost</code><code class="p">:</code><code class="mi">3310</code></strong></pre>

<pre data-type="programlisting">Creating a session to <em>root@localhost:3310</em>
Please provide the password for <em>root@localhost:3310</em>: <strong><strong/></strong>
Save password for <em>root@localhost:3310</em>? [Y]es/[N]o/Ne[v]er (default No): Y
Fetching schema names for autocompletion... Press ^C to stop.
Your MySQL connection id is 12
Server version: 8.0.21 Source distribution
No default schema selected; type \use &lt;schema&gt; to set one.</pre>

<p>Subsequently, we will use the <code>createCluster()</code> method to create the InnoDB Cluster with the currently connected instance as the seed:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">MySQL</code><code> </code><code class="n">localhost</code><code class="p">:</code><code class="mi">3310</code><code> </code><code class="k">ssl</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">var</code><code> </code><code class="n">cluster</code><code> </code><code class="o">=</code><code> </code><code class="n">dba</code><code class="p">.</code><code class="nf">createCluster</code><code class="p">(</code><code class="s1">'learning_mysql'</code><code class="p">)</code></strong></pre>

<pre data-type="programlisting">A new InnoDB cluster will be created on instance 'localhost:3310'.

Validating instance configuration at localhost:3310...
NOTE: Instance detected as a sandbox.
Please note that sandbox instances are only suitable for deploying test clusters
for use within the same host.

This instance reports its own address as 127.0.0.1:3310

Instance configuration is suitable.
NOTE: Group Replication will communicate with other members using
'127.0.0.1:33101'. Use the localAddress option to override.

Creating InnoDB cluster 'learning_mysql' on '127.0.0.1:3310'...

Adding Seed Instance...
Cluster successfully created. Use Cluster.addInstance() to add MySQL instances.
At least 3 instances are needed for the cluster to be able to withstand up to
one server failure.</pre>

<p>As we can see in the output, three instances are capable of keeping the database online with one server failure, which is why we deployed three sandbox instances.</p>

<p>The next step is to add secondary instances to our <code>learning_mysql</code> InnoDB Cluster. Any transactions that were executed by the seed instance are reexecuted by each secondary instance as it is added.</p>

<p>The seed instance in this example was recently created, so it is nearly empty. Therefore, there is little data that needs to be replicated from the seed instance to the secondary instances. If it’s necessary to replicate data, MySQL will use the <a href="https://oreil.ly/VUASS">clone plugin</a> (discussed in <a data-type="xref" href="ch13.xhtml#clone_plugin">“Creating a Replica Using the Clone Plugin”</a>) to configure the instances automatically.</p>

<p>Let’s add one secondary to see the process in action. To add the second instance to the InnoDB Cluster:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">MySQL</code><code>  </code><code class="n">localhost</code><code class="p">:</code><code class="mi">3310</code><code> </code><code class="k">ssl</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code>  </code><strong><code class="n">cluster</code><code class="p">.</code><code class="nf">addInstance</code><code class="p">(</code><code class="s1">'root@localhost:3320'</code><code class="p">)</code></strong></pre>

<pre data-type="programlisting">...

* Waiting for clone to finish...
NOTE: 127.0.0.1:3320 is being cloned from 127.0.0.1:3310
** Stage DROP DATA: Completed
** Clone Transfer
    FILE COPY  ############################################################
    100%  Completed
    PAGE COPY  ############################################################
    100%  Completed
    REDO COPY  ############################################################
    100%  Completed

NOTE: 127.0.0.1:3320 is shutting down...

* Waiting for server restart... ready
* 127.0.0.1:3320 has restarted, waiting for clone to finish...
** Stage RESTART: Completed
* Clone process has finished: 59.62 MB transferred in about 1 second
(~59.62 MB/s)

State recovery already finished for '127.0.0.1:3320'

The instance '127.0.0.1:3320' was successfully added to the cluster</pre>

<p>Then add the third instance:</p>

<pre data-type="programlisting" data-code-language="mysql"><code> </code><code class="n">MySQL</code><code>  </code><code class="n">localhost</code><code class="p">:</code><code class="mi">3310</code><code> </code><code class="k">ssl</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code>  </code><strong><code class="n">cluster</code><code class="p">.</code><code class="nf">addInstance</code><code class="p">(</code><code class="s1">'root@localhost:3320'</code><code class="p">)</code></strong></pre>

<p>At this point we have created a cluster with three instances: a primary and two secondaries. We can see the status by running the following command:</p>

<pre data-type="programlisting" data-code-language="mysql"><code> </code><code class="n">MySQL</code><code>  </code><code class="n">localhost</code><code class="p">:</code><code class="mi">3310</code><code> </code><code class="k">ssl</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">cluster</code><code class="p">.</code><code class="nf">status</code><code class="p">(</code><code class="p">)</code></strong></pre>

<pre data-type="programlisting">{
    "clusterName": "learning_mysql",
    "defaultReplicaSet": {
        "name": "default",
        "primary": "127.0.0.1:3310",
        "ssl": "REQUIRED",
        "status": "OK",
        "statusText": "Cluster is ONLINE and can tolerate up to ONE failure.",
        "topology": {
            "127.0.0.1:3310": {
                "address": "127.0.0.1:3310",
                "mode": "R/W",
                "readReplicas": {},
                "replicationLag": null,
                "role": "HA",
                "status": "ONLINE",
                "version": "8.0.21"
            },
            "127.0.0.1:3320": {
                "address": "127.0.0.1:3320",
                "mode": "R/O",
                "readReplicas": {},
                "replicationLag": null,
                "role": "HA",
                "status": "ONLINE",
                "version": "8.0.21"
            },
            "127.0.0.1:3330": {
                "address": "127.0.0.1:3330",
                "mode": "R/O",
                "readReplicas": {},
                "replicationLag": null,
                "role": "HA",
                "status": "ONLINE",
                "version": "8.0.21"
            }
        },
        "topologyMode": "Single-Primary"
    },
    "groupInformationSourceMember": "127.0.0.1:3310"</pre>

<p>Assuming MySQL Router is already installed (see <a data-type="xref" href="ch15.xhtml#MYSQL_ROUTER">“MySQL Router”</a>), <a data-type="indexterm" data-primary="MySQL Router" data-secondary="MySQL Shell deploying sandboxes" id="idm46177445317464"/>the only required step is to bootstrap it with the location of the InnoDB Cluster metadata server.</p>

<p>We observe the router being bootstrapped:<a data-type="indexterm" data-startref="ch16-san" id="idm46177445315896"/><a data-type="indexterm" data-startref="ch16-san2" id="idm46177445315192"/><a data-type="indexterm" data-startref="ch16-san3" id="idm46177445314520"/><a data-type="indexterm" data-startref="ch16-san4" id="idm46177445313848"/><a data-type="indexterm" data-startref="ch16-san5" id="idm46177445313176"/></p>

<pre data-type="programlisting"># <strong>mysqlrouter --bootstrap root@localhost:3310 --user=mysqlrouter</strong></pre>

<pre data-type="programlisting">Please enter MySQL password for root:
# Bootstrapping system MySQL Router instance...

- Creating account(s) (only those that are needed, if any)
...

## MySQL Classic protocol

- Read/Write Connections: localhost:6446
- Read/Only Connections:  localhost:6447

...</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="MySQL Shell Utilities"><div class="sect2" id="idm46177445625128">
<h2>MySQL Shell Utilities</h2>

<p>As we’ve said, MySQL Shell is a powerful, advanced client and<a data-type="indexterm" data-primary="MySQL Shell" data-secondary="utilities" id="ch16-uti"/><a data-type="indexterm" data-primary="backups and recovery" data-secondary="MySQL Shell utilities" id="ch16-uti2"/><a data-type="indexterm" data-primary="backups and recovery" data-secondary="logical backups" data-tertiary="MySQL Shell utilities" id="ch16-uti3"/><a data-type="indexterm" data-primary="logical backups" data-secondary="MySQL Shell utilities" id="ch16-uti4"/> code editor for MySQL. Among its many functionalities are utilities to create a logical dump and do a logical restore for the entire database instance, including users. <a data-type="indexterm" data-primary="parallel backup queues" data-secondary="MySQL Shell utilities" id="idm46177445291528"/><a data-type="indexterm" data-primary="parallel restore of dumps" data-secondary="MySQL Shell utilities" id="idm46177445290680"/>The advantage, compared to <code>mysqldump</code>, for example, is that the utility has parallelization capacity, greatly improving the dump and restore speed.</p>

<p>Here are the utilities to execute the dump and restore process:</p>
<dl>
<dt><code>util.dumpInstance()</code></dt>
<dd>
<p>Dump an entire database instance, including users</p>
</dd>
<dt><code>util.dumpSchemas()</code></dt>
<dd>
<p>Dump a set of schemas</p>
</dd>
<dt><code>util.loadDump()</code></dt>
<dd>
<p>Load a dump into a target database</p>
</dd>
<dt><code>util.dumpTables()</code></dt>
<dd>
<p>Load specific tables and views</p>
</dd>
</dl>

<p>Let’s take a closer look at each of these in turn.</p>










<section data-type="sect3" data-pdf-bookmark="util.dumpInstance()"><div class="sect3" id="idm46177445281880">
<h3>util.dumpInstance()</h3>

<p>The <code>dumpInstance()</code> utility will dump all the databases that are present in the <a data-type="indexterm" data-primary="backups and recovery" data-secondary="MySQL Shell utilities" data-tertiary="util.dumpInstance()" id="idm46177445279544"/><a data-type="indexterm" data-primary="MySQL Shell" data-secondary="utilities" data-tertiary="util.dumpInstance()" id="idm46177445278184"/><a data-type="indexterm" data-primary="util.dumpInstance()" id="idm46177445276968"/>MySQL data directory (see <a data-type="xref" href="ch01.xhtml#MYSQL_DIRECTORY_CONTENT">“The Contents of the MySQL Directory”</a>). It will exclude the  <code>information_schema</code>, <code>mysql_</code>, <code>ndbinfo</code>, <code>performance_schema</code>, and <code>sys</code> schemas while taking the dump.</p>

<p>There’s also a dry-run option that allows you to inspect the schemas and view the compatibility issues and then run the dump with the appropriate compatibility options applied to remove the issues. Let’s try this now—we’ll examine the possible errors and see the options for the dump utility.</p>

<p>To start the dump, run the following command:</p>

<pre data-type="programlisting" data-code-language="mysql"><code> </code><code class="n">MySQL</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">shell</code><code class="p">.</code><code class="nf">connect</code><code class="p">(</code><code class="s1">'root@localhost:48008'</code><code class="p">)</code><code class="p">;</code></strong><code>
 </code><code class="n">MySQL</code><code>  </code><code class="n">localhost</code><code class="p">:</code><code class="mi">48008</code><code> </code><code class="k">ssl</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">util</code><code class="p">.</code><code class="nf">dumpInstance</code><code class="p">(</code><code class="s2">"/backup"</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="err">{</code><code class="n">ocimds</code><code class="p">:</code><code> </code><code class="no">true</code><code class="p">,</code><code> </code><code class="n">compatibility</code><code class="p">:</code><code>                                       </code><code class="o">&gt;</code><code> </code><code class="p">[</code><code class="s2">"strip_restricted_grants"</code><code class="p">]</code><code class="p">,</code><code>
                                    </code><code class="n">dryRun</code><code class="p">:</code><code> </code><code class="no">true</code><code class="err">}</code><code class="p">)</code></strong></pre>

<pre data-type="programlisting">Acquiring global read lock
Global read lock acquired
Gathering information - done
All transactions have been started
Locking instance for backup
...
NOTE: Database test had unsupported ENCRYPTION option commented out
ERROR: Table 'test'.'sbtest1' uses unsupported storage engine MyISAM
(fix this with 'force_innodb' compatibility option)
Compatibility issues with MySQL Database Service 8.0.23 were found.
Please use the 'compatibility' option to apply compatibility adaptations
to the dumped DDL.
Util.dumpInstance: Compatibility issues were found (RuntimeError)</pre>

<p>With the <code>ocimds</code> option set to <code>true</code>, the dump utility will check the data dictionary and index dictionary. Encryption options in <code>CREATE TABLE</code> statements are commented out in the DDL files, to ensure that all tables are located in the MySQL data directory and use the default schema encryption. <code>strip_restricted_grants</code> removes specific privileges that are restricted by MySQL Database Service that would cause an error during the user creation process. <code>dryRun</code> is self-explanatory: it will perform validation only, and no data will be actually dumped.</p>

<p>So, we have a MyISAM table in the <code>test</code> database. The dry-run option clearly throws the error.</p>

<p>To fix this error, we are going to use the <code>force_innodb</code> option, which will convert all unsupported engines to InnoDB in the <code>CREATE TABLE</code> statement:</p>

<pre data-type="programlisting" data-code-language="mysql"><code> </code><code class="n">MySQL</code><code>  </code><code class="n">localhost</code><code class="p">:</code><code class="mi">48008</code><code> </code><code class="k">ssl</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">util</code><code class="p">.</code><code class="nf">dumpInstance</code><code class="p">(</code><code class="s2">"backup"</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="err">{</code><code class="n">ocimds</code><code class="p">:</code><code> </code><code class="no">true</code><code class="p">,</code><code> </code><code class="n">compatibility</code><code class="p">:</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="p">[</code><code class="s2">"strip_restricted_grants"</code><code class="p">,</code><code class="s2">"force_innodb"</code><code class="p">]</code><code class="p">,</code></strong><code>
                                </code><strong><code class="n">dryRun</code><code class="p">:</code><code> </code><code class="no">true</code><code class="err">}</code><code class="p">)</code></strong></pre>

<p>Now the dry run does not throw any errors, and there are no exceptions. Let’s run the <code>dumpInstance()</code> command to take an instance backup. The target directory must be empty before the export takes place. If the directory does not yet exist in its parent directory, the utility creates it.</p>

<p>We are going to process the dump in parallel. For this, we will use the option <code>threads</code> and set a value of 10 threads:</p>

<pre data-type="programlisting" data-code-language="mysql"><code> </code><code class="n">MySQL</code><code>  </code><code class="n">localhost</code><code class="p">:</code><code class="mi">48008</code><code> </code><code class="k">ssl</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">util</code><code class="p">.</code><code class="nf">dumpInstance</code><code class="p">(</code><code class="s2">"/backup"</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="err">{</code><code class="n">ocimds</code><code class="p">:</code><code> </code><code class="no">true</code><code class="p">,</code><code> </code><code class="n">compatibility</code><code class="p">:</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="p">[</code><code class="s2">"strip_restricted_grants"</code><code class="p">,</code><code class="s2">"force_innodb"</code><code class="p">]</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="n">threads</code><code> </code><code class="p">:</code><code> </code><code class="mi">10</code><code> </code><code class="err">}</code><code class="p">)</code></strong></pre>

<p>If we observe the last part of the output, we’ll see:</p>

<pre data-type="programlisting">1 thds dumping - 100% (10.00K rows / ~10.00K rows), 0.00 rows/s, 0.00 B/s
uncompressed, 0.00 B/s

uncompressed
Duration: 00:00:00s
Schemas dumped: 1
Tables dumped: 10
Uncompressed data size: 1.88 MB
Compressed data size: 598.99 KB
Compression ratio: 3.1
Rows written: 10000
Bytes written: 598.99 KB
Average uncompressed throughput: 1.88 MB/s
Average compressed throughput: 598.99 KB/s</pre>

<p>If we were using <code>mysqldump</code>, we would have a single file. As we can see here, there are multiple files in the backup directory:</p>

<pre data-type="programlisting">@.done.json
@.json
@.post.sql
@.sql
test.json
test@sbtest10@@0.tsv.zst
test@sbtest10@@0.tsv.zst.idx
test@sbtest10.json
test@sbtest10.sql
...
test@sbtest1@@0.tsv.zst
test@sbtest1@@0.tsv.zst.idx
test@sbtest1.json
test@sbtest1.sql
test@sbtest9@@0.tsv.zst
test@sbtest9@@0.tsv.zst.idx
test@sbtest9.json
test@sbtest9.sql
test.sql</pre>

<p>Let’s take a look at these:</p>

<ul>
<li>
<p>The <em>@.json</em> file contains server details and lists of users, database names, and their character sets.</p>
</li>
<li>
<p>The <em>@.post.sql</em> and <em>@.sql</em> files contain MySQL Server version details.</p>
</li>
<li>
<p>The <em>test.json</em> file contains view, stored procedure, and function names along with a list of tables.</p>
</li>
<li>
<p>The <em>@.users.sql</em> file (not shown) contains a list of database users.</p>
</li>
<li>
<p>The <em>test@sbtest10.json</em> file contains column names and character sets. There will be a similiarly named file for each dumped table.</p>
</li>
<li>
<p>The <em>test@sbtest1.sql</em> file contains a table structure. There will be one for each dumped table.</p>
</li>
<li>
<p>The  <em>test@sbtest10@@0.tsv.zst</em> file is a binary file. It stores data. There will be a similarly named file for each dumped table.</p>
</li>
<li>
<p>The <em>test@sbtest10@@0.tsv.zst.idx</em> file is a binary file. It stores table index stats. There will be a similarly named file for each dumped table.</p>
</li>
<li>
<p>The <em>@.done.json</em> file contains the backup end time and data file sizes in KB.</p>
</li>
<li>
<p>The  <em>test.sql</em> file contains a database statement.</p>
</li>
</ul>
</div></section>













<section data-type="sect3" data-pdf-bookmark="util.dumpSchemas()"><div class="sect3" id="idm46177445281352">
<h3>util.dumpSchemas()</h3>

<p>This utility is similar to <code>dumpInstance()</code>, but it allows us to<a data-type="indexterm" data-primary="backups and recovery" data-secondary="MySQL Shell utilities" data-tertiary="util.dumpSchemas()" id="idm46177445040120"/><a data-type="indexterm" data-primary="MySQL Shell" data-secondary="utilities" data-tertiary="util.dumpSchemas()" id="idm46177445039032"/><a data-type="indexterm" data-primary="util.dumpSchemas()" id="idm46177445037944"/> specify schemas to dump. It supports the same options:</p>

<pre data-type="programlisting" data-code-language="mysql"><code> </code><code class="n">MySQL</code><code>  </code><code class="n">localhost</code><code class="p">:</code><code class="mi">48008</code><code> </code><code class="k">ssl</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">util</code><code class="p">.</code><code class="nf">dumpSchemas</code><code class="p">(</code><code class="p">[</code><code class="s2">"test"</code><code class="p">]</code><code class="p">,</code><code class="s2">"/backup"</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="err">{</code><code class="n">ocimds</code><code class="p">:</code><code> </code><code class="no">true</code><code class="p">,</code><code> </code><code class="n">compatibility</code><code class="p">:</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="p">[</code><code class="s2">"strip_restricted_grants"</code><code class="p">,</code><code class="s2">"force_innodb"</code><code class="p">]</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="n">threads</code><code> </code><code class="p">:</code><code> </code><code class="mi">10</code><code> </code><code class="p">,</code><code> </code><code class="n">dryRun</code><code class="p">:</code><code> </code><code class="no">true</code><code class="err">}</code><code class="p">)</code></strong></pre>

<p>If we want to specify multiple schemas, we can do that by running:</p>

<pre data-type="programlisting" data-code-language="mysql"><code> </code><code class="n">MySQL</code><code>  </code><code class="n">localhost</code><code class="p">:</code><code class="mi">48008</code><code> </code><code class="k">ssl</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">util</code><code class="p">.</code><code class="nf">dumpSchemas</code><code class="p">(</code><code class="p">[</code><code class="s2">"test"</code><code class="p">,</code><code class="s2">"percona"</code><code class="p">,</code></strong><code>
                                  </code><strong><code class="s2">"learning_mysql"</code><code class="p">]</code><code class="p">,</code><code class="s2">"/backup"</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="err">{</code><code class="n">ocimds</code><code class="p">:</code><code> </code><code class="no">true</code><code class="p">,</code><code> </code><code class="n">compatibility</code><code class="p">:</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="p">[</code><code class="s2">"strip_restricted_grants"</code><code class="p">,</code><code class="s2">"force_innodb"</code><code class="p">]</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="n">threads</code><code> </code><code class="p">:</code><code> </code><code class="mi">10</code><code> </code><code class="p">,</code><code> </code><code class="n">dryRun</code><code class="p">:</code><code> </code><code class="no">true</code><code class="err">}</code><code class="p">)</code></strong></pre>
</div></section>













<section data-type="sect3" data-pdf-bookmark="util.dumpTables()"><div class="sect3" id="idm46177444977848">
<h3>util.dumpTables()</h3>

<p>If we want to extract more granular data, like specific tables, we<a data-type="indexterm" data-primary="backups and recovery" data-secondary="MySQL Shell utilities" data-tertiary="util.dumpTables()" id="idm46177444896984"/><a data-type="indexterm" data-primary="MySQL Shell" data-secondary="utilities" data-tertiary="util.dumpTables()" id="idm46177444909432"/><a data-type="indexterm" data-primary="util.dumpTables()" id="idm46177444908216"/> can use the <code>dumpTables()</code> utility. Again, the big advantage compared to <code>mysqldump</code> is the potential to extract data from MySQL in parallel:</p>

<pre data-type="programlisting" data-code-language="mysql"><code> </code><code class="n">MySQL</code><code>  </code><code class="n">localhost</code><code class="p">:</code><code class="mi">48008</code><code> </code><code class="k">ssl</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">util</code><code class="p">.</code><code class="nf">dumpTables</code><code class="p">(</code><code class="s2">"test"</code><code class="p">,</code><code> </code><code class="p">[</code><code> </code><code class="s2">"sbtest1"</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="s2">"sbtest2"</code><code> </code><code class="p">]</code><code class="p">,</code><code class="s2">"/backup"</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="err">{</code><code class="n">ocimds</code><code class="p">:</code><code> </code><code class="no">true</code><code class="p">,</code><code> </code><code class="n">compatibility</code><code class="p">:</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="p">[</code><code class="s2">"strip_restricted_grants"</code><code class="p">,</code><code class="s2">"force_innodb"</code><code class="p">]</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="n">threads</code><code> </code><code class="p">:</code><code> </code><code class="mi">2</code><code> </code><code class="p">,</code><code> </code><code class="n">dryRun</code><code class="p">:</code><code> </code><code class="no">true</code><code class="err">}</code><code class="p">)</code></strong></pre>
</div></section>













<section data-type="sect3" data-pdf-bookmark="util.loadDump(url[, options])"><div class="sect3" id="idm46177444809320">
<h3>util.loadDump(url[, options])</h3>

<p>We’ve seen all the utilities to extract data, but there is one<a data-type="indexterm" data-primary="backups and recovery" data-secondary="MySQL Shell utilities" data-tertiary="util.loadDump()" id="idm46177444808040"/><a data-type="indexterm" data-primary="MySQL Shell" data-secondary="utilities" data-tertiary="util.loadDump()" id="idm46177444820696"/><a data-type="indexterm" data-primary="util.loadDump()" id="idm46177444819480"/> remaining: the one to load data into MySQL.</p>

<p>The <code>loadDump()</code> enables provides data streaming to remote storage, parallel loading of tables or table chunks, and progress state tracking. It also provides resume and reset capabilities and the option of concurrent loading while the dump is still taking place.</p>

<p>Note that this utility uses the <code>LOAD DATA LOCAL INFILE</code> statement, so we need to enable the <a href="https://oreil.ly/vm445"><code>local_infile</code></a> parameter globally while importing.</p>

<p>The <code>loadDump()</code> utility checks whether the <a href="https://oreil.ly/2Si8y"><code>sql_require_primary_key</code> system variable</a> is set to <code>ON</code>, and if it is, returns an error if there is a table in the dump files with no primary key:</p>

<pre data-type="programlisting" data-code-language="mysql"><code> </code><code class="n">MySQL</code><code>  </code><code class="n">localhost</code><code class="p">:</code><code class="mi">48008</code><code> </code><code class="k">ssl</code><code>  </code><code class="n">JS</code><code> </code><code class="o">&gt;</code><code> </code><strong><code class="n">util</code><code class="p">.</code><code class="nf">loadDump</code><code class="p">(</code><code class="s2">"/backup"</code><code class="p">,</code></strong><code>
                                </code><code class="o">&gt;</code><code> </code><strong><code class="err">{</code><code class="n">progressFile</code><code> </code><code class="p">:</code><code class="s2">"/backup</code></strong><code class="s2">
                                &gt; </code><strong><code class="s2">restore.json"</code><code class="p">,</code><code class="n">threads</code><code> </code><code class="p">:</code><code class="mi">12</code><code class="err">}</code><code class="p">)</code></strong></pre>

<p class="pagebreak-before">The last part of the output will be similar to this:</p>

<pre data-type="programlisting">[Worker006] percona@sbtest7@@0.tsv.zst: Records: 400000 Deleted: 0  Skipped: 0
Warnings: 0
[Worker007] percona@sbtest4@@0.tsv.zst: Records: 400000 Deleted: 0  Skipped: 0
Warnings: 0
[Worker002] percona@sbtest13@@0.tsv.zst: Records: 220742 Deleted: 0  Skipped: 0
Warnings: 0
Executing common postamble SQL

23 chunks (5.03M rows, 973.06 MB) for 23 tables in 3 schemas were loaded in
1 min 24 sec (avg throughput 11.58 MB/s)
0 warnings were reported during the load.</pre>

<p>Be sure to check the warnings reported at the end in case any show up.<a data-type="indexterm" data-startref="ch16-uti" id="idm46177444753144"/><a data-type="indexterm" data-startref="ch16-uti2" id="idm46177444752536"/><a data-type="indexterm" data-startref="ch16-uti3" id="idm46177444751928"/><a data-type="indexterm" data-startref="ch16-uti4" id="idm46177444751256"/></p>
</div></section>



</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Flame Graphs"><div class="sect1" id="idm46177444809064">
<h1>Flame Graphs</h1>

<p>Quoting <a href="https://oreil.ly/STGxb">Brendan Gregg</a>, determining why<a data-type="indexterm" data-primary="flame graphs" id="ch16-fg"/><a data-type="indexterm" data-primary="visualizing output" data-secondary="flame graphs" id="ch16-fg2"/><a data-type="indexterm" data-primary="output" data-secondary="visualizing" data-tertiary="flame graphs" id="ch16-fg3"/><a data-type="indexterm" data-primary="CPU performance monitoring" data-secondary="flame graphs" id="ch16-fg4"/><a data-type="indexterm" data-primary="stack traces" data-secondary="flame graphs from" id="ch16-fg5"/><a data-type="indexterm" data-primary="monitoring MySQL servers" data-secondary="operating system metrics" data-tertiary="CPU flame graphs" id="ch16-fg6"/><a data-type="indexterm" data-primary="operating systems" data-secondary="metrics to monitor" data-tertiary="CPU flame graphs" id="ch16-fg7"/><a data-type="indexterm" data-primary="hot code paths in flame graphs" id="ch16-fg9"/><a data-type="indexterm" data-primary="CPU performance monitoring" data-secondary="perf CPU profiler" data-tertiary="flame graphs" id="ch16-fgxx"/><a data-type="indexterm" data-primary="perf CPU profiler for flame graphs" id="ch16-fg8"/> CPUs are busy is a routine task for performance analysis, which often involves profiling <em>stack traces</em>. Profiling by sampling at a fixed rate is a coarse but effective way to see which code paths are <em>hot</em> (busy on the CPU). It usually works by creating a timed interrupt that collects the current program counter, function address, or entire stack trace, and translates these to something human-readable when printing a summary report. <em>Flame graphs</em> are a type of visualization for sampled stack traces that allow hot code paths to be identified quickly.</p>

<p>A <em>stack trace</em> (also called <em>stack backtrace</em> or <em>stack traceback</em>) is a report of the active stack frames at a certain point in time during the execution of a program. There are many tools available to collect stack traces. <a data-type="indexterm" data-primary="CPU performance monitoring" data-secondary="CPU profilers" id="idm46177444704936"/><a data-type="indexterm" data-primary="CPU performance monitoring" data-secondary="perf CPU profiler" id="idm46177444704088"/>These tools are also known as <em>CPU profilers</em>. The CPU profiler we are going to use is <a href="https://oreil.ly/T7qZl"><code>perf</code></a>.</p>

<p><code>perf</code> is a profiler tool for Linux 2.6+–based systems that abstracts away CPU hardware differences in Linux performance measurements and presents a simple command-line interface.<a data-type="indexterm" data-primary="perf_events in Linux" id="idm46177444701272"/> <code>perf</code> is based on the <code>perf_events</code> interface exported by recent versions of the Linux kernel.</p>

<p><code>perf_events</code> is an event-oriented observability tool that can help solve advanced performance and troubleshooting tasks. Questions that can be answered include:</p>

<ul>
<li>
<p>Why is the kernel on-CPU so much? What code paths are hot?</p>
</li>
<li>
<p>Which code paths are causing CPU level 2 cache misses?</p>
</li>
<li>
<p>Are the CPUs stalled on memory I/O?</p>
</li>
<li>
<p>Which code paths are allocating memory, and how much?</p>
</li>
<li>
<p>What is triggering TCP retransmits?</p>
</li>
</ul>

<ul class="less_space pagebreak-before">
<li>
<p>Is a certain kernel function being called, and how often?</p>
</li>
<li>
<p>Why are threads leaving the CPU?</p>
</li>
</ul>

<p>Note that in this book, we are only scratching the surface of <code>perf</code>’s capabilities. <a data-type="indexterm" data-primary="CPU performance monitoring" data-secondary="CPU profilers" data-tertiary="information online" id="idm46177444691496"/><a data-type="indexterm" data-primary="perf CPU profiler for flame graphs" data-secondary="perf information online" id="idm46177444690408"/><a data-type="indexterm" data-primary="web links in book" data-secondary="CPU profilers" id="idm46177444689560"/><a data-type="indexterm" data-primary="Gregg, Brendan" id="idm46177444688712"/>We highly recommend checking out <a href="https://oreil.ly/STGxb">Brendan Gregg’s website</a>, which contains much more detailed information about <code>perf</code> and other CPU profilers.</p>

<p>To produce flame graphs, we need to start collecting the stack trace report with <code>perf</code> in the MySQL server. This operation needs to be done on the MySQL host. We will collect data for 60 seconds:</p>

<pre data-type="programlisting"># <strong>perf record -a -g -F99 -p $(pgrep -x mysqld) -- sleep 60;</strong>
# <strong>perf report &gt; /tmp/perf.report;</strong>
# <strong>perf script &gt; /tmp/perf.script;</strong></pre>

<p>And if we check the <em>/tmp</em> directory, we will see <code>perf</code> files:</p>

<pre data-type="programlisting"># <strong>ls -l /tmp/perf</strong>*
-rw-r--r-- 1 root root  502100 Feb 13 22:01 /tmp/perf.report
-rw-r--r-- 1 root root 7303290 Feb 13 22:01 /tmp/perf.script</pre>

<p>The next step doesn’t need to be executed on the MySQL host; we can copy the files to another Linux host or even macOS.</p>

<p>To produce the flame graphs we can use <a href="https://oreil.ly/llqVS">Brendan’s GitHub repository</a>. For this example, we will clone the Flame Graph repository in the  directory where our <code>perf</code> report is located:</p>

<pre data-type="programlisting"># <strong>git clone https://github.com/brendangregg/FlameGraph</strong>
# <strong>./FlameGraph/stackcollapse-perf.pl ./perf.script &gt; perf.report.out.folded</strong>
# <strong>./FlameGraph/flamegraph.pl ./perf.report.out.folded &gt; perf.report.out.svg</strong></pre>

<p>We’ve produced a file named <em>perf.report.out.svg</em>. This file can be opened in any browser to be visualized. <a data-type="xref" href="#FIG-MYSQL-FLAME">Figure 16-1</a> is an example of a flame graph.</p>

<p>Flame graphs show the sample population across the x-axis, and stack depth on the y-axis. Each function (stack frame) is drawn as a rectangle, with the width relative to the number of samples; so the bigger the bar, the more CPU time was spent on that function. The x-axis spans the stack trace collection but does not show the passage of time, so the left-to-right ordering has no special meaning. The ordering is done alphabetically based on the function names, from the root to the leaf of each stack.</p>

<p>The file that’s created is interactive, so we can explore where kernel CPU time is spent. In the previous example an <code>INSERT</code> operation is consuming 44% of the CPU time, as you can see in <a data-type="xref" href="#FIG-MYSQL-INSERT-FLAME">Figure 16-2</a>.<a data-type="indexterm" data-startref="ch16-fg" id="idm46177444674072"/><a data-type="indexterm" data-startref="ch16-fg2" id="idm46177444673368"/><a data-type="indexterm" data-startref="ch16-fg3" id="idm46177444672696"/><a data-type="indexterm" data-startref="ch16-fg4" id="idm46177444672024"/><a data-type="indexterm" data-startref="ch16-fg5" id="idm46177444671352"/><a data-type="indexterm" data-startref="ch16-fg6" id="idm46177444670680"/><a data-type="indexterm" data-startref="ch16-fg7" id="idm46177444670008"/><a data-type="indexterm" data-startref="ch16-fg8" id="idm46177444669336"/><a data-type="indexterm" data-startref="ch16-fg9" id="idm46177444668664"/><a data-type="indexterm" data-startref="ch16-fgxx" id="idm46177444667992"/></p>

<figure><div id="FIG-MYSQL-FLAME" class="figure">
<img src="Images/lm2e_1601.png" alt="lm2e 1601" width="2396" height="1632"/>
<h6><span class="label">Figure 16-1. </span>An example of a flame graph</h6>
</div></figure>

<figure><div id="FIG-MYSQL-INSERT-FLAME" class="figure">
<img src="Images/lm2e_1602.png" alt="lm2e 1602" width="2384" height="502"/>
<h6><span class="label">Figure 16-2. </span>44% of CPU time is used for an <code>INSERT</code> operation</h6>
</div></figure>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Building MySQL from Source"><div class="sect1" id="idm46177444749672">
<h1>Building MySQL from Source</h1>

<p>As <a data-type="xref" href="ch01.xhtml#CH1_INSTALL">Chapter 1</a> explained, MySQL has a distribution available for most common operating systems.<a data-type="indexterm" data-primary="MySQL" data-secondary="building from source" id="ch16-bui"/><a data-type="indexterm" data-primary="building MySQL from source" id="ch16-bui2"/><a data-type="indexterm" data-primary="Linux" data-secondary="Ubuntu" data-tertiary="building MySQL from source" id="ch16-bui3"/><a data-type="indexterm" data-primary="Ubuntu Linux" data-secondary="building MySQL from source" id="ch16-bui4"/> Some companies have also compiled their own MySQL versions, such as <a data-type="indexterm" data-primary="RocksDB engine" id="idm46177444655976"/><a data-type="indexterm" data-primary="storage engines" data-secondary="RocksDB" id="idm46177444655224"/>Facebook, which worked on the RocksDB engine and integrated it into MySQL. RocksDB is an embeddable, persistent key/value store for fast storage that has several advantages compared with InnoDB with regard to space efficiency.</p>

<p class="pagebreak-before">Despite its advantages, RocksDB does not support replication<a data-type="indexterm" data-primary="Facebook’s MyRocks" id="idm46177444653416"/><a data-type="indexterm" data-primary="MyRocks" data-secondary="RocksDB storage engine" id="idm46177444652632"/> or a SQL layer. This led the Facebook team to build MyRocks, an open source project that integrates RocksDB as a MySQL storage engine. With MyRocks, it is possible to use RocksDB as backend storage and still benefit from all the features of MySQL. Facebook’s project is open source and available on <a href="https://oreil.ly/ssWon">GitHub</a>.</p>

<p>Another motivation to compile MySQL is the ability to customize its build. <a data-type="indexterm" data-primary="MySQL" data-secondary="building from source" data-tertiary="debug option" id="idm46177444650136"/><a data-type="indexterm" data-primary="building MySQL from source" data-secondary="debug option" id="idm46177444648888"/><a data-type="indexterm" data-primary="debug option in MySQL build" id="idm46177444647928"/>For example, for a very specific problem, we can always try to debug MySQL to gather extra information. To do this, we need to configure MySQL with the <code>-DWITH_DEBUG=1</code> option.</p>








<section data-type="sect2" data-pdf-bookmark="Building MySQL for Ubuntu Focal Fossa and ARM Processors"><div class="sect2" id="idm46177444646328">
<h2>Building MySQL for Ubuntu Focal Fossa and ARM Processors</h2>

<p>Because ARM processors are currently gaining traction<a data-type="indexterm" data-primary="ARM build of MySQL" id="idm46177444644168"/> (particularly thanks to Apple’s M1 chip), we will show you how to compile MySQL for Ubuntu Focal Fossa running on ARM.</p>

<p>First, we are going to create our directories. We will create one directory that will be for the source code, another one for the compiled binaries, and a third for the <code>boost</code> library:</p>

<pre data-type="programlisting"># <strong>cd /</strong>
# <strong>mkdir compile</strong>
# <strong>cd compile/</strong>
# <strong>mkdir build</strong>
# <strong>mkdir source</strong>
# <strong>mkdir boost</strong>
# <strong>mkdir basedir</strong>
# <strong>mkdir /var/lib/mysql</strong></pre>

<p>Next, we need to install the additional Linux packages required to compile MySQL:</p>

<pre data-type="programlisting"># <strong>apt-get -y install dirmngr</strong>
# <strong>apt-get update -y</strong>
# <strong>apt-get -y install cmake</strong>
# <strong>apt-get -y install lsb-release wget</strong>
# <strong>apt-get -y purge eatmydata || true</strong>
# <strong>apt-get -y install psmisc pkg-config</strong>
# <strong>apt-get -y install libsasl2-dev libsasl2-modules libsasl2-modules-ldap ||</strong> \
    <strong>apt-get -y install libsasl2-modules libsasl2-modules-ldap libsasl2-dev</strong>
# <strong>apt-get -y install dh-systemd || true</strong>
# <strong>apt-get -y install curl bison cmake perl libssl-dev gcc g++ libaio-dev</strong> \
    <strong>libldap2-dev libwrap0-dev gdb unzip gawk</strong>
# <strong>apt-get -y install lsb-release libmecab-dev libncurses5-dev libreadline-dev</strong> \
    <strong>libpam-dev zlib1g-dev</strong>
# <strong>apt-get -y install libldap2-dev libnuma-dev libjemalloc-dev libeatmydata</strong> \
    <strong>libc6-dbg valgrind libjson-perl  libsasl2-dev</strong>
# <strong>apt-get -y install libmecab2 mecab mecab-ipadic</strong>
# <strong>apt-get -y install build-essential devscripts libnuma-dev</strong>
# <strong>apt-get -y install cmake autotools-dev autoconf automake build-essential</strong> \
    <strong>devscripts debconf debhelper fakeroot</strong>
# <strong>apt-get -y install libcurl4-openssl-dev patchelf</strong>
# <strong>apt-get -y install libeatmydata1</strong>
# <strong>apt-get install libmysqlclient-dev -y</strong>
# <strong>apt-get install valgrind -y</strong></pre>

<p>These packages are related to the <a href="https://oreil.ly/GOnBJ">CMake flags</a> that we will run.<a data-type="indexterm" data-primary="CMAKE for MySQL build" id="idm46177444624856"/> If we remove or add certain flags, some packages are not necessary to install (for example, if we don’t want to compile with Valgrind, we don’t need this package).</p>

<p>Next, we will download the source code. For this, we will use <a href="https://oreil.ly/6Jb4c">MySQL repository</a> on GitHub:</p>

<pre data-type="programlisting"># <strong>cd source</strong>
# <strong>git clone https://github.com/mysql/mysql-server.git</strong></pre>

<p>The output will be similar to this:</p>

<pre data-type="programlisting">Cloning into 'mysql-server'...
remote: Enumerating objects: 1639611, done.
remote: Total 1639611 (delta 0), reused 0 (delta 0), pack-reused 1639611
Receiving objects: 100% (1639611/1639611), 3.19 GiB | 42.88 MiB/s, done.
Resolving deltas: 100% (1346714/1346714), done.
Updating files: 100% (32681/32681), done.</pre>

<p>To check which version we will compile, we can run the following:</p>

<pre data-type="programlisting"># <strong>cd mysql-server/</strong>
# <strong>git branch</strong></pre>

<p>Next, we will go to our <em>build</em> directory and run <code>CMake</code> with our chosen flags:</p>

<pre data-type="programlisting"># <strong>cd /compile/build</strong>
# <strong>cmake ../source/mysql-server/  -DBUILD_CONFIG=mysql_release \</strong>
    <strong>-DCMake_BUILD_TYPE=${CMake_BUILD_TYPE:-RelWithDebInfo} \</strong>
    <strong>-DWITH_DEBUG=1 \</strong>
    <strong>-DFEATURE_SET=community \</strong>
    <strong>-DENABLE_DTRACE=OFF \</strong>
    <strong>-DWITH_SSL=system \</strong>
    <strong>-DWITH_ZLIB=system \</strong>
    <strong>-DCMake_INSTALL_PREFIX="/compile/basedir/" \</strong>
    <strong>-DINSTALL_LIBDIR="lib/" \</strong>
    <strong>-DINSTALL_SBINDIR="bin/" \</strong>
    <strong>-DWITH_INNODB_MEMCACHED=ON \</strong>
    <strong>-DDOWNLOAD_BOOST=1 \</strong>
    <strong>-DWITH_VALGRIND=1 \</strong>
    <strong>-DINSTALL_PLUGINDIR="plugin/" \</strong>
    <strong>-DMYSQL_DATADIR="/var/lib/mysql/" \</strong>
    <strong>-DWITH_BOOST="/compile/boost/"</strong></pre>

<p class="pagebreak-before">Here’s what each of these does:</p>

<ul>
<li>
<p><code>DBUILD_CONFIG</code> configures a source distribution with the same build options as for MySQL releases (we are going to override some of them).</p>
</li>
<li>
<p><code>DCMake_BUILD_TYPE</code> with <code>RelWithDebInfo</code> enables optimizations and generates debugging information.</p>
</li>
<li>
<p><code>DWITH_DEBUG</code> enables the use of the <code>--debug="d,parser_debug"</code> option when MySQL is started. This causes the Bison parser used to process SQL statements to dump a parser trace to the server’s standard error output. Typically, this output is written to the error log.</p>
</li>
<li>
<p><code>DFEATURE_SET</code> indicates we are going to install community features.</p>
</li>
<li>
<p><code>DENABLE_DTRACE</code> includes support for DTrace probes. The DTrace probes in the MySQL server are designed to provide information about the execution of queries within MySQL and the different areas of the system being utilized during that process.</p>
</li>
<li>
<p>The <code>DWITH_SSL</code> option adds support for encrypted connections, entropy for random number generation, and other encryption-related operations.</p>
</li>
<li>
<p><code>DWITH_ZLIB</code> enables compression library support for the <code>COMPRESS()</code> and 
<span class="keep-together"><code>UNCOMPRESS()</code></span> functions, and compression of the client/server protocol.</p>
</li>
<li>
<p><code>DCMake_INSTALL_PREFIX</code> sets the location of our installation base directory.</p>
</li>
<li>
<p><code>DINSTALL_LIBDIR</code> indicates where to install the library files.</p>
</li>
<li>
<p><code>DINSTALL_SBINDIR</code> specifies where to install <code>mysqld</code>.</p>
</li>
<li>
<p><code>DWITH_INNODB_MEMCACHED</code> generates memcached shared libraries (<em>libmemcached.so</em> and <em>innodb_engine.so</em>).</p>
</li>
<li>
<p><code>DDOWNLOAD_BOOST</code> makes CMake download the <code>boost</code> library and place it in the location specified with <code>DWITH_BOOST</code>.</p>
</li>
<li>
<p><code>DWITH_VALGRIND</code> enables Valgrind, exposing the Valgrind API to MySQL code. This is useful for analyzing memory leaks.</p>
</li>
<li>
<p><code>DINSTALL_PLUGINDIR</code> defines where the compiler will place the plugin libraries.</p>
</li>
<li>
<p><code>DMYSQL_DATADIR</code> defines the location of the MySQL data directory.</p>
</li>
<li>
<p><code>DWITH_BOOST</code> defines the directory where CMake will download the <code>boost</code> library.</p>
</li>
</ul>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If by mistake you miss a step and the CMake process fails, to prevent old object files or configuration information from being used in the next attempt you’ll need to clean up the build directory and the previous configuration. That is, you’ll need to run the following commands in the build directory on Unix before rerunning CMake:</p>

<pre data-type="programlisting"># <strong>cd /compile/build</strong>
# <strong>make clean</strong>
# <strong>rm CMakeCache.txt</strong></pre>
</div>

<p>After we run CMake, we are going to compile MySQL using the <code>make</code> command. <a data-type="indexterm" data-primary="thread" data-secondary="compiling MySQL" id="idm46177444577096"/>To optimize the compiling process we will use the <code>-j</code> option, which specifies how many threads we are going to use to compile MySQL. Since in our instance we have 16 ARM cores, we are going to use 15 threads (leaving one for OS activities):</p>

<pre data-type="programlisting"># <strong>make  -j 15</strong>
# <strong>make install</strong></pre>

<p>This process may take a while, and it is very verbose. After it’s finished, we can see the binaries in the <em>basedir</em> directory:</p>

<pre data-type="programlisting"># <strong>ls -l /compile/basedir/bin</strong></pre>

<p>Note that we are not going to find a <em>mysqld</em> binary in the <em>/compile/build/bin/</em> directory, but instead we will see <em>mysqld-debug</em>. This is because of the <code>DWITH_DEBUG</code> option we set previously:</p>

<pre data-type="programlisting"># <strong>/compile/build/bin/mysqld-debug --version</strong></pre>

<pre data-type="programlisting">/compile/build/bin/mysqld-debug  Ver 8.0.23-debug-valgrind for Linux on aarch64
(Source distribution)</pre>

<p>Now, we can test our binary. For this we are going to manually create the directories and configure the permissions:</p>

<pre data-type="programlisting"># <strong>mkdir /var/log/mysql/</strong>
# <strong>mkdir /var/run/mysqld/</strong>
# <strong>chown ubuntu: /var/log/mysql/</strong>
# <strong>chown ubuntu: /var/run/mysqld/</strong></pre>

<p>Then add these settings to <em>/etc/my.cnf</em>:</p>

<pre data-type="programlisting">[mysqld]
pid-file        = /var/run/mysqld/mysqld.pid
socket          = /var/run/mysqld/mysqld.sock
datadir         = /var/lib/mysql
log-error       = /var/log/mysql/error.log</pre>

<p class="pagebreak-before">Next, we are going to initialize the MySQL data dictionary:</p>

<pre data-type="programlisting"># <strong>/compile/basedir/bin/mysqld-debug --defaults-file=/etc/my.cnf --initialize</strong> \
<strong>--user ubuntu</strong></pre>

<p>Now, MySQL is ready to be started:</p>

<pre data-type="programlisting"># <strong>/compile/basedir/bin/mysqld-debug --defaults-file=/etc/my.cnf --user ubuntu &amp;</strong></pre>

<p>A temporary password will be created, and we can extract it from the error log:</p>

<pre data-type="programlisting"># <strong>grep "A temporary password" /var/log/mysql/error.log</strong></pre>

<pre data-type="programlisting">2021-02-14T16:55:25.754028Z 6 [Note] [MY-010454] [Server] A temporary
password is generated for root@localhost: yGldRKoRf0%T</pre>

<p>Now we can connect using the MySQL client of our preference:<a data-type="indexterm" data-startref="ch16-bui" id="idm46177444556584"/><a data-type="indexterm" data-startref="ch16-bui2" id="idm46177444555800"/><a data-type="indexterm" data-startref="ch16-bui3" id="idm46177444555128"/><a data-type="indexterm" data-startref="ch16-bui4" id="idm46177444554456"/></p>

<pre data-type="programlisting"># <strong>mysql -uroot -p'yGldRKoRf0%T'</strong></pre>

<pre data-type="programlisting">mysql: [Warning] Using a password on the command line interface can be
insecure. Welcome to the MySQL monitor. Commands end with ; or \g.
Your MySQL connection id is 8
Server version: 8.0.23-debug-valgrind

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt;</pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Analyzing a MySQL Crash"><div class="sect1" id="idm46177444645352">
<h1>Analyzing a MySQL Crash</h1>

<p>We say that MySQL <em>crashes</em> when the <code>mysqld</code> process dies<a data-type="indexterm" data-primary="MySQL" data-secondary="crash analysis" id="idm46177444549112"/><a data-type="indexterm" data-primary="crash analysis" id="idm46177444548104"/> without the proper shutdown command. MySQL can crash for a variety of reasons, including these:</p>

<ul>
<li>
<p>Hardware failure (memory, disk, processor)</p>
</li>
<li>
<p>Segmentation faults (invalid memory access)</p>
</li>
<li>
<p>Bugs</p>
</li>
<li>
<p>Being killed by the <code>OOM</code> process</p>
</li>
<li>
<p>Various other causes, such as <a href="https://oreil.ly/Lq09r">cosmic rays</a>.</p>
</li>
</ul>

<p>The MySQL process can receive a number of signals from Linux. The following are among the most common:</p>
<dl>
<dt>Signal 15 (<code>SIGTERM</code>)</dt>
<dd>
<div class="openblock">
<p>Causes the server to shut down. This is like executing a<a data-type="indexterm" data-primary="Linux" data-secondary="signal 15 SIGTERM" data-secondary-sortas="signal 5" id="idm46177444537416"/> <code>SHUTDOWN</code> statement without having to connect to the server (which for shutdown requires an account that has the <code>SHUTDOWN</code> privilege). For example, the following two commands result in a regular shutdown:</p>

<pre data-type="programlisting"># <strong>systemctl stop mysql</strong>
# <strong>kill -15 -p $(pgrep -x mysqld)</strong></pre>
</div>

</dd>
<dt>Signal 1 (<code>SIGHUP</code>)</dt>
<dd>
<div class="openblock">
<p>Causes the server to reload the grant tables and to flush tables,<a data-type="indexterm" data-primary="Linux" data-secondary="signal 1 SIGHUP" data-secondary-sortas="signal 1" id="idm46177444530904"/> logs, the thread cache, and the host cache. These actions are like various forms of the <code>FLUSH</code> 
<span class="keep-together">statement:</span></p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="n">FLUSH</code><code> </code><code class="n">LOGS</code><code class="p">;</code></strong></pre>

<p>or:</p>

<pre data-type="programlisting"># <strong>kill -1 -p $(pgrep -x mysqld)</strong></pre>
</div>

</dd>
<dt>Signal 6 (<code>SIGABRT</code>)</dt>
<dd>
<div class="openblock">
<p>Happens because something went wrong. It is commonly used<a data-type="indexterm" data-primary="Linux" data-secondary="signal 6 SIGABRT" data-secondary-sortas="signal 2" id="idm46177444517208"/> by <code>libc</code> and other libraries to abort the program in case of critical errors. For example, <code>glibc</code> sends a <code>SIGABRT</code> if it detects a double free or other heap corruption. <code>SIGABRT</code> will write the crash details in the MySQL error log, like this:</p>

<pre data-type="programlisting">18:03:28 UTC - mysqld got signal 6 ;
Most likely, you have hit a bug, but this error can also be caused by...
Thread pointer: 0x7fe6b4000910
Attempting backtrace. You can use the following information to find out
where mysqld died. If you see no messages after this, something went
terribly wrong...
stack_bottom = 7fe71845fbc8 thread_stack 0x46000
/opt/mysql/8.0.23/bin/mysqld(my_print_stacktrace(unsigned char const*...
/opt/mysql/8.0.23/bin/mysqld(handle_fatal_signal+0x323) [0x1032cc3]
/lib64/libpthread.so.0(+0xf630) [0x7fe7244e5630]
/lib64/libc.so.6(gsignal+0x37) [0x7fe7224fa387]
/lib64/libc.so.6(abort+0x148) [0x7fe7224fba78]
/opt/mysql/8.0.23/bin/mysqld() [0xd52c3d]
/opt/mysql/8.0.23/bin/mysqld(MYSQL_BIN_LOG::new_file_impl(bool...
/opt/mysql/8.0.23/bin/mysqld(MYSQL_BIN_LOG::rotate(bool, bool*)+0x35)...
/opt/mysql/8.0.23/bin/mysqld(MYSQL_BIN_LOG::rotate_and_purge(THD*...
/opt/mysql/8.0.23/bin/mysqld(handle_reload_request(THD*, unsigned...
/opt/mysql/8.0.23/bin/mysqld(signal_hand+0x2ea) [0xe101da]
/opt/mysql/8.0.23/bin/mysqld() [0x25973dc]
/lib64/libpthread.so.0(+0x7ea5) [0x7fe7244ddea5]
/lib64/libc.so.6(clone+0x6d) [0x7fe7225c298d]

Trying to get some variables.
Some pointers may be invalid and cause the dump to abort.
Query (0): Connection ID (thread ID): 0
Status: NOT_KILLED

The manual page at http://dev.mysql.com/doc/mysql/en/crashing.html
contains information that should help you find out what is causing
the crash.
2021-02-14T18:03:29.120726Z mysqld_safe mysqld from pid file...</pre>
</div>

</dd>
<dt>Signal 11 (<code>SIGSEGV</code>)</dt>
<dd>
<p>Indicates a segmentation fault, bus error, or access violation<a data-type="indexterm" data-primary="Linux" data-secondary="signal 11 SIGSEGV" data-secondary-sortas="signal 4" id="idm46177444491688"/> issue. This is generally an attempt to access memory that the CPU cannot physically address, or an access violation. When MySQL receives a <code>SIGSEGV</code>, a core dump will be created if the <code>core-file</code> parameter is configured.</p>
</dd>
<dt>Signal 9 (<code>SIGKILL</code>)</dt>
<dd>
<div class="openblock">
<p>Causes a process to terminate immediately (kills it). This is<a data-type="indexterm" data-primary="Linux" data-secondary="signal 9 SIGKILL" data-secondary-sortas="signal 3" id="idm46177444486968"/> probably the most famous signal. In contrast to <code>SIGTERM</code> and <code>SIGINT</code>, this signal cannot be caught or ignored, and the receiving process cannot perform any cleanup upon receiving this signal. Besides the chance of corrupting MySQL data, <code>SIGKILL</code> will also force MySQL to perform a recovery process when restarted to bring it to an operational state. The following example shows how to send a <code>SIGKILL</code> manually to the MySQL process:</p>

<pre data-type="programlisting"># <strong>kill -9 -p $(pgrep -x mysqld)</strong></pre>

<p>Also, the Linux <code>OOM</code> process executes a <code>SIGKILL</code> to terminate with the MySQL process.</p>
</div>

</dd>
</dl>

<p>Let’s try to analyze a crash where MySQL got a signal 11:<a data-type="indexterm" data-primary="stack traces" data-secondary="crash analysis" id="idm46177444480664"/></p>

<pre data-type="programlisting">11:47:47 UTC - mysqld got signal 11 ;
Most likely, you have hit a bug, but this error can also be caused by...
Build ID: Not Available
Server Version: 8.0.22-13 Percona Server (GPL), Release 13, Revision 6f7822f
Thread pointer: 0x7f0e46c73000
Attempting backtrace. You can use the following information to find out
where mysqld died. If you see no messages after this, something went
terribly wrong...
stack_bottom = 7f0e664ecd10 thread_stack 0x46000
/usr/sbin/mysqld(my_print_stacktrace(unsigned char const*, unsigned...
/usr/sbin/mysqld(handle_fatal_signal+0x3c3) [0x1260d33]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x128a0) [0x7f0e7acd58a0]
/usr/sbin/mysqld(Item_splocal::this_item()+0x14) [0xe36ad4]
/usr/sbin/mysqld(Item_sp_variable::val_str(String*)+0x20) [0xe38e60]
/usr/sbin/mysqld(Arg_comparator::compare_string()+0x27) [0xe5c127]
/usr/sbin/mysqld(Item_func_ne::val_int()+0x30) [0xe580e0]
/usr/sbin/mysqld(Item::val_bool()+0xcc) [0xe3ddbc]
/usr/sbin/mysqld(sp_instr_jump_if_not::exec_core(THD*, unsigned int*)+0x2d)...
/usr/sbin/mysqld(sp_lex_instr::reset_lex_and_exec_core(THD*, unsigned int*...
/usr/sbin/mysqld(sp_lex_instr::validate_lex_and_execute_core(THD*, unsigned...
/usr/sbin/mysqld(sp_head::execute(THD*, bool)+0x5c7) [0x1068e37]
/usr/sbin/mysqld(sp_head::execute_trigger(THD*, MYSQL_LEX_CSTRING const&amp;...
/usr/sbin/mysqld(Trigger::execute(THD*)+0x10b) [0x12288cb]
/usr/sbin/mysqld(Trigger_chain::execute_triggers(THD*)+0x18) [0x1229c98]
/usr/sbin/mysqld(Table_trigger_dispatcher::process_triggers(THD*...
/usr/sbin/mysqld(fill_record_n_invoke_before_triggers(THD*, COPY_INFO*...
/usr/sbin/mysqld(Sql_cmd_update::update_single_table(THD*)+0x1e98) [0x11ec138]
/usr/sbin/mysqld(Sql_cmd_update::execute_inner(THD*)+0xd5) [0x11ec5f5]
/usr/sbin/mysqld(Sql_cmd_dml::execute(THD*)+0x6c0) [0x116f590]
/usr/sbin/mysqld(mysql_execute_command(THD*, bool)+0xaf8) [0x110e588]
/usr/sbin/mysqld(mysql_parse(THD*, Parser_state*, bool)+0x4ec) [0x111327c]
/usr/sbin/mysqld(dispatch_command(THD*, COM_DATA const*...
/usr/sbin/mysqld(do_command(THD*)+0x204) [0x1116554]
/usr/sbin/mysqld() [0x1251c20]
/usr/sbin/mysqld() [0x2620e84]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x76db) [0x7f0e7acca6db]
/lib/x86_64-linux-gnu/libc.so.6(clone+0x3f) [0x7f0e78c95a3f]
Trying to get some variables.
Some pointers may be invalid and cause the dump to abort.
Query (7f0e46cb4dc8): update table1 set c2_id='R', c3_description='testing...
Connection ID (thread ID): 111
Status: NOT_KILLED
Please help us make Percona Server better by reporting any
bugs at https://bugs.percona.com/</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Sometimes stack may not contain fully resolved symbols or may only have addresses. That depends on whether the mysqld binary is stripped and whether the debug symbols are available. As a rule of thumb, we recommend installing debug symbols, as that has no disadvantage other than using up some disk space. Having debug symbols installed doesn’t make your MySQL server run in some slow debug mode. Official MySQL 8.0 builds are always symbolized, however, so you don’t need to worry.</p>
</div>

<p>The stack trace is analyzed from top to bottom. We can see from the crash that this is a Percona Server v8.0.22. Next, we see the thread being created at the OS level at this point:</p>

<pre data-type="programlisting">/lib/x86_64-linux-gnu/libpthread.so.0(+0x76db) [0x7f0e7acca6db]</pre>

<p>Continuing up through the stack, the code path enters MySQL and starts executing a command:</p>

<pre data-type="programlisting">/usr/sbin/mysqld(do_command(THD*)+0x204)...</pre>

<p>And the code path that crashes is the <code>Item_splocal</code> function:</p>

<pre data-type="programlisting">/usr/sbin/mysqld(Item_splocal::this_item()+0x...</pre>

<p>With a bit of investigation in the <a href="https://oreil.ly/OjTUs">MySQL code</a>, we discover that <code>Item_splocal</code> is part of the stored procedure code. If we look at the end of the stack trace, we will see a query:</p>

<pre data-type="programlisting">Query (7f0e46cb4dc8): update table1 set c2_id='R', c3_description='testing...</pre>

<p><em>Triggers</em> can also use the stored procedure path when they<a data-type="indexterm" data-primary="triggers in crash analysis" id="idm46177444467400"/> contain variables. If we check whether this table has triggers, we see this:</p>

<pre data-type="programlisting" data-code-language="mysql"><strong>CREATE DEFINER=`root`@`localhost` TRIGGER `table1_update_trigger`
BEFORE UPDATE ON `table1` FOR EACH ROW BEGIN
DECLARE vc1_id VARCHAR(2);
SELECT c2_id FROM table1 WHERE c1_id = new.c1_id INTO vc1_id;
IF vc1_id &lt;&gt; <em>P</em> THEN
INSERT INTO table1_hist(
c1_id,
c2_id,
c3_description)
VALUES(
old.c1_id,
old.c2_id,
new.c3_description);
END IF;
END
;;</strong></pre>

<p>With all this information, we can create a test case and report the bug:</p>

<pre data-type="programlisting" data-code-language="mysql"><strong>USE test;

CREATE TABLE `table1` (
  `c1_id` int primary key auto_increment,
  `c2_id` char(1) NOT NULL,
   `c3_description` varchar(255));

CREATE TABLE `table1_hist` (
  `c1_id` int,
  `c2_id` char(1) NOT NULL,
  `c3_description` varchar(255));
  insert into table1 values (1, <em>T</em>,  <em>test crash</em>);

delimiter ;;

CREATE DEFINER=`root`@`localhost` TRIGGER `table1_update_trigger`
BEFORE UPDATE ON `table1` FOR EACH ROW BEGIN
DECLARE vc1_id VARCHAR(2);
SELECT c2_id FROM table1 WHERE c1_id = new.c1_id INTO vc1_id;
IF vc1_id &lt;&gt; <em>P</em> THEN
INSERT INTO table1_hist(
c1_id,
c2_id,
c3_description)
VALUES(
old.c1_id,
old.c2_id,
new.c3_description);
END IF;
END
;;</strong></pre>

<p>To reproduce it, we run multiple commands simultaneously in the same table until the error happens:</p>

<pre data-type="programlisting">$ <strong>mysqlslap --user=msandbox --password=msandbox</strong> \
    <strong>--socket=/tmp/mysql_sandbox37515.sock</strong> \
    <strong>--create-schema=test --port=37515</strong> \
    <strong>--query="update table1 set c2_id='R',
    *c3_description='testing crash' where c1_id=1"</strong> \
    <strong>--concurrency=50 --iterations=200</strong></pre>

<p>This bug is relatively easy to reproduce, and we recommend you test it. You can find more details about this bug in Percona’s <a href="https://oreil.ly/cAWbG">Jira system</a>.</p>

<p>Also, we can see that Oracle fixed the bug at version 8.0.23 thanks to the <a href="https://oreil.ly/izg4K">release notes</a>:</p>
<blockquote>
<p>Prepared statements involving stored programs could cause heap-use-after-free memory problems (Bug #32131022, Bug #32045681, Bug #32051928).</p></blockquote>

<p>Sometimes bugs are not easy to reproduce and can be really frustrating to investigate. Even experienced engineers have problems with this, especially when investigating memory leaks. We hope we have sparked your curiosity to investigate crashes.</p>
</div></section>







</div></section></div></body></html>