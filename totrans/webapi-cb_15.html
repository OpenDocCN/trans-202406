<html><head></head><body><section data-pdf-bookmark="Chapter 15. Measuring Performance" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_performance">&#13;
<h1><span class="label">Chapter 15. </span>Measuring Performance</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Introduction" data-type="sect1"><div class="sect1" id="id214">&#13;
<h1>Introduction</h1>&#13;
&#13;
<p><a data-primary="performance measurement" data-type="indexterm" id="ix_15-measuring-performance-asciidoc0"/>There <a data-primary="performance measurement" data-secondary="basics" data-type="indexterm" id="id1178"/>are many third-party tools for measuring performance in a JavaScript app, but the browser also has some handy tools built in for capturing performance metrics.</p>&#13;
&#13;
<p><a data-primary="Navigation Timing API" data-type="indexterm" id="id1179"/>The Navigation Timing API is used to capture performance data about the initial page load. You can inspect how long the page took to load, how long it took for the DOM to become interactive, and more. It returns a set of timestamps that indicate when each event happened during the page load.</p>&#13;
&#13;
<p><a data-primary="Resource Timing API" data-type="indexterm" id="id1180"/>The Resource Timing API lets you inspect how long it took to download resources and make network requests. This covers page resources such as HTML files, CSS files, JavaScript files, and images. It also covers asynchronous requests such as those made with the Fetch API.</p>&#13;
&#13;
<p><a data-primary="User Timing API" data-type="indexterm" id="id1181"/>The User Timing API is a way to calculate the elapsed time of arbitrary operations. You can create performance <em>marks</em>, which are points in time, and <em>measures</em>, which are calculated durations between marks.</p>&#13;
&#13;
<p>All of these APIs create performance entries in a buffer on the page. This is a single collection of all types of performance entries. You can inspect this buffer at any time, and you can also use <code>PerformanceObserver</code> to listen asynchronously for new performance entries to be added.</p>&#13;
&#13;
<p>Performance entries use high-precision timestamps. Time is measured in milliseconds, but can also contain fractional portions that, in some browsers, can have microsecond accuracy. In the browser, these timestamps are stored as <code>DOMHighResTimeStamp</code> objects. These are numbers that start at zero when the page loads and represent the time since the page load that a given entry happened.</p>&#13;
&#13;
<p>This chapter’s recipes explore solutions for gathering performance metrics. What you do with those metrics is up to you. You can use the Fetch or Beacon API to send the performance metrics to an API for collection and later analysis.</p>&#13;
&#13;
<p>You can use these performance metrics during development for debugging purposes, or leave them in to collect real performance metrics from your users. These can be sent to an analytics service for aggregation and analysis.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Measuring Page Load Performance" data-type="sect1"><div class="sect1" id="id604">&#13;
<h1>Measuring Page Load Performance</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id215">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="page load performance measurement" data-type="indexterm" id="id1182"/><a data-primary="performance measurement" data-secondary="page load" data-type="indexterm" id="id1183"/>You want to gather information about the timing of page load events.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id605">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Look up the single performance entry with a type of <code>navigation</code>, and retrieve the navigation timestamps from the performance entry object (see <a data-type="xref" href="#example15-1">Example 15-1</a>). You can then calculate the interval between these timestamps to figure out the time taken for various page load events.</p>&#13;
<div data-type="example" id="example15-1">&#13;
<h5><span class="label">Example 15-1. </span>Looking up the navigation timing performance entry</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// There is only one navigation performance entry.</code>&#13;
<code class="kr">const</code> <code class="p">[</code><code class="nx">navigation</code><code class="p">]</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">getEntriesByType</code><code class="p">(</code><code class="s1">'navigation'</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>This object has a lot of properties. <a data-type="xref" href="#table15-1">Table 15-1</a> lists a few examples of useful calculations you can perform.</p>&#13;
<table id="table15-1">&#13;
<caption><span class="label">Table 15-1. </span>Navigation timing calculations</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Metric</th>&#13;
<th>Start time</th>&#13;
<th>End time</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>Time to first byte</p></td>&#13;
<td><p><code>startTime</code></p></td>&#13;
<td><p><code>responseStart</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Time to DOM interactive</p></td>&#13;
<td><p><code>startTime</code></p></td>&#13;
<td><p><code>domInteractive</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>Total load time</p></td>&#13;
<td><p><code>startTime</code></p></td>&#13;
<td><p><code>loadEventEnd</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id606">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The <code>startTime</code> property of the navigation timing performance entry is always 0.</p>&#13;
&#13;
<p>This entry doesn’t only contain timing information. It also contains information such as the amount of data transferred, the HTTP response code, and the page URL. This information is useful to determine how quickly your application becomes responsive when it first loads.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Measuring Resource Performance" data-type="sect1"><div class="sect1" id="id607">&#13;
<h1>Measuring Resource Performance</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id311">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="performance measurement" data-secondary="resource" data-type="indexterm" id="id1184"/><a data-primary="resources" data-secondary="performance measurement" data-type="indexterm" id="id1185"/>You want to get information about requests for the resources loaded on the page.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id608">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Find the resource performance entries in the performance buffer (see <a data-type="xref" href="#example15-2">Example 15-2</a>).</p>&#13;
<div data-type="example" id="example15-2">&#13;
<h5><span class="label">Example 15-2. </span>Getting the resource performance entries</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">entries</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">getEntriesByType</code><code class="p">(</code><code class="s1">'resource'</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>You’ll get one entry for each resource on the page. Resources include CSS files, JavaScript files, images, and any other requests by the page.</p>&#13;
&#13;
<p>For each resource, you can calculate how long it took to load by taking the difference between the <code>startTime</code> and <code>responseEnd</code> properties. The URL of the resource is available in the <code>name</code> property.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id609">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Any network requests you make with the Fetch API also show up as a resource. This makes this API useful for profiling the real-world performance of your REST API &#13;
<span class="keep-together">endpoints.</span></p>&#13;
&#13;
<p>When the page first loads, the performance buffer includes an entry for all resources requested during the initial page load. Subsequent requests are added to the performance buffer as they are made.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Finding the Slowest Resources" data-type="sect1"><div class="sect1" id="id610">&#13;
<h1>Finding the Slowest Resources</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id312">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="performance measurement" data-secondary="finding slowest resources" data-type="indexterm" id="id1186"/><a data-primary="resources" data-secondary="finding slowest" data-type="indexterm" id="id1187"/>You want to get a list of the resources that took the longest to load.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id611">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Sort and filter the list of resource performance entries. Since this list is just an array, you can call methods such as <code>sort</code> and <code>slice</code> on it. To find how long the resource took to load, take the difference between its &#13;
<span class="keep-together"><code>responseEnd</code></span> and <code>startTime</code> timestamps.</p>&#13;
&#13;
<p class="pagebreak-before"><a data-type="xref" href="#code_findSlowest">Example 15-3</a> shows how to find the five slowest-loading resources.</p>&#13;
<div data-type="example" id="code_findSlowest">&#13;
<h5><span class="label">Example 15-3. </span>Finding the five slowest-loading resources</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">slowestResources</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">getEntriesByType</code><code class="p">(</code><code class="s1">'resource'</code><code class="p">)</code>&#13;
  <code class="p">.</code><code class="nx">sort</code><code class="p">((</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="o">=&gt;</code>&#13;
    <code class="p">(</code><code class="nx">b</code><code class="p">.</code><code class="nx">responseEnd</code> <code class="o">-</code> <code class="nx">b</code><code class="p">.</code><code class="nx">startTime</code><code class="p">)</code> <code class="o">-</code> <code class="p">(</code><code class="nx">a</code><code class="p">.</code><code class="nx">responseEnd</code> <code class="o">-</code> <code class="nx">a</code><code class="p">.</code><code class="nx">startTime</code><code class="p">))</code>&#13;
  <code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id612">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The key is the <code>sort</code> call. This compares each pair of load times and sorts the whole list in descending order of load times. Then, the <code>slice</code> call is just taking the first five elements of the sorted array.</p>&#13;
&#13;
<p>If you want to instead get a list of the five fastest-loading resources, you can just reverse the order in which the load times are compared (see <a data-type="xref" href="#example15-4">Example 15-4</a>).</p>&#13;
<div data-type="example" id="example15-4">&#13;
<h5><span class="label">Example 15-4. </span>Finding the 5 fastest resources</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">fastestResources</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">getEntriesByType</code><code class="p">(</code><code class="s1">'resource'</code><code class="p">)</code>&#13;
  <code class="p">.</code><code class="nx">sort</code><code class="p">((</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="o">=&gt;</code>&#13;
    <code class="p">(</code><code class="nx">a</code><code class="p">.</code><code class="nx">responseEnd</code> <code class="o">-</code> <code class="nx">a</code><code class="p">.</code><code class="nx">startTime</code><code class="p">)</code> <code class="o">-</code> <code class="p">(</code><code class="nx">b</code><code class="p">.</code><code class="nx">responseEnd</code> <code class="o">-</code> <code class="nx">b</code><code class="p">.</code><code class="nx">startTime</code><code class="p">))</code>&#13;
  <code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>The reversed comparison means the array is sorted in ascending order rather than descending order. The <code>slice</code> call now returns the five fastest-loading resources.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Finding Timings for a Specific Resource" data-type="sect1"><div class="sect1" id="id613">&#13;
<h1>Finding Timings for a Specific Resource</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id313">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="performance measurement" data-secondary="finding timings for a specific resource" data-type="indexterm" id="id1188"/><a data-primary="requests" data-secondary="finding timings for specific resource requests" data-type="indexterm" id="id1189"/><a data-primary="resources" data-secondary="finding timings for" data-type="indexterm" id="id1190"/>You want to look up the timings for requests for a specific resource.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id614">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the method <code>window.performance.getEntriesByName</code> to look up resources by a specific URL (see <a data-type="xref" href="#example15-5">Example 15-5</a>).</p>&#13;
<div data-type="example" id="example15-5">&#13;
<h5><span class="label">Example 15-5. </span>Finding all resource timings for a specific URL</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// Look up all requests to the /api/users API</code>&#13;
<code class="kr">const</code> <code class="nx">entries</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">getEntriesByName</code><code class="p">(</code><code class="s1">'https://localhost/api/users'</code><code class="p">,</code>&#13;
<code class="s1">'resource'</code><code class="p">);</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id615">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The name of a resource entry is its URL. The first argument to <code>getEntriesByName</code> is the URL. The second argument indicates that you’re interested in resource timings.</p>&#13;
&#13;
<p>If there were multiple requests for the given URL, you’ll get multiple resource entries in the returned array.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Profiling Rendering Performance" data-type="sect1"><div class="sect1" id="id616">&#13;
<h1>Profiling Rendering Performance</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id216">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="performance measurement" data-secondary="profiling rendering performance" data-type="indexterm" id="ix_15-measuring-performance-asciidoc1"/><a data-primary="rendering performance, profiling" data-type="indexterm" id="ix_15-measuring-performance-asciidoc2"/>You want to record the time it takes to render some data on the page.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id617">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Create a performance mark just before the rendering begins. Once rendering is complete, create another mark. Then you can create a <em>measure</em> between the two marks to record how long the rendering took.</p>&#13;
&#13;
<p>Imagine you have a <code>DataView</code> component that can be used to render some data in the page (see <a data-type="xref" href="#code_renderData">Example 15-6</a>).</p>&#13;
<div data-type="example" id="code_renderData">&#13;
<h5><span class="label">Example 15-6. </span>Measuring rendering performance</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// Create the initial performance mark just before rendering.</code>&#13;
<code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">mark</code><code class="p">(</code><code class="s1">'render-start'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Create the component and render the data.</code>&#13;
<code class="kr">const</code> <code class="nx">dataView</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">DataView</code><code class="p">();</code>&#13;
<code class="nx">dataView</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// When rendering is done, create the ending performance mark.</code>&#13;
<code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">mark</code><code class="p">(</code><code class="s1">'render-end'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Create a measure between the two marks.</code>&#13;
<code class="kr">const</code> <code class="nx">measure</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">measure</code><code class="p">(</code><code class="s1">'render'</code><code class="p">,</code> <code class="s1">'render-start'</code><code class="p">,</code> <code class="s1">'render-end'</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>The <code>measure</code> object contains the start time and the calculated duration of the &#13;
<span class="keep-together">measure.</span></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id217">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Whenever you create performance marks and measures, they are added to the page’s performance buffer to look up later. For example, if you wanted to look up the <code>render</code> measure at a later time, you could use <code>window.performance.getEntriesByName</code> (see <a data-type="xref" href="#example15-7">Example 15-7</a>).</p>&#13;
<div data-type="example" id="example15-7">&#13;
<h5><span class="label">Example 15-7. </span>Looking up a measure by name</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// There is only one 'render' measure, so you can use</code>&#13;
<code class="c1">// array destructuring to get the first (and only) entry.</code>&#13;
<code class="kr">const</code> <code class="p">[</code><code class="nx">renderMeasure</code><code class="p">]</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">getEntriesByName</code><code class="p">(</code><code class="s1">'render'</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>Marks and measures can also contain data associated with them by passing the <code>detail</code> option. For example, when rendering the data in <a data-type="xref" href="#code_renderData">Example 15-6</a>, you can pass the data itself as metadata when creating the measure.</p>&#13;
&#13;
<p>When creating a measure in this way, you need to include the start and end marks inside the options object (see <a data-type="xref" href="#example15-8">Example 15-8</a>).</p>&#13;
<div data-type="example" id="example15-8">&#13;
<h5><span class="label">Example 15-8. </span>Measuring rendering performance with data</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// Create the initial performance mark just before rendering.</code>&#13;
<code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">mark</code><code class="p">(</code><code class="s1">'render-start'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Create the component and render the data.</code>&#13;
<code class="kr">const</code> <code class="nx">dataView</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">DataView</code><code class="p">();</code>&#13;
<code class="nx">dataView</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// When rendering is done, create the ending performance mark.</code>&#13;
<code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">mark</code><code class="p">(</code><code class="s1">'render-end'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Create a measure between the two marks, passing the</code>&#13;
<code class="c1">// data being rendered as the measure detail.</code>&#13;
<code class="kr">const</code> <code class="nx">measure</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">measure</code><code class="p">(</code><code class="s1">'render'</code><code class="p">,</code> <code class="p">{</code>&#13;
  <code class="nx">start</code><code class="o">:</code> <code class="s1">'render-start'</code><code class="p">,</code>&#13;
  <code class="nx">end</code><code class="o">:</code> <code class="s1">'render-end'</code><code class="p">,</code>&#13;
  <code class="nx">detail</code><code class="o">:</code> <code class="nx">data</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Later, when you look up this performance entry, the detail metadata is available in the measure’s <code>detail</code> property.<a data-startref="ix_15-measuring-performance-asciidoc2" data-type="indexterm" id="id1191"/><a data-startref="ix_15-measuring-performance-asciidoc1" data-type="indexterm" id="id1192"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Profiling Multistep Tasks" data-type="sect1"><div class="sect1" id="id618">&#13;
<h1>Profiling Multistep Tasks</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id218">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="multistep tasks, profiling" data-type="indexterm" id="ix_15-measuring-performance-asciidoc3"/><a data-primary="performance measurement" data-secondary="profiling multistep tasks" data-type="indexterm" id="ix_15-measuring-performance-asciidoc4"/><a data-primary="tasks, profiling multistep" data-type="indexterm" id="ix_15-measuring-performance-asciidoc5"/>You want to gather performance data for a multistep process. You want to get the time for the whole sequence, but also the time for individual steps. For example, you might want to load some data from an API and then do some processing with that data. In this case, you want to know the time for the API request, the time for the processing, and also the total time taken.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id619">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Create multiple marks and measures. You can use a given mark in more than one measure calculation.</p>&#13;
&#13;
<p>In <a data-type="xref" href="#example15-9">Example 15-9</a>, there’s an API that returns some user transactions. Once the transactions are received, you want to run some analytics on the transaction data. Finally, the analytics data is sent to another API.</p>&#13;
<div data-type="example" id="example15-9">&#13;
<h5><span class="label">Example 15-9. </span>Profiling a multistep process</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">mark</code><code class="p">(</code><code class="s1">'transactions-start'</code><code class="p">);</code>&#13;
<code class="kr">const</code> <code class="nx">transactions</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="s1">'/api/users/123/transactions'</code><code class="p">);</code>&#13;
<code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">mark</code><code class="p">(</code><code class="s1">'transactions-end'</code><code class="p">);</code>&#13;
<code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">mark</code><code class="p">(</code><code class="s1">'process-start'</code><code class="p">);</code>&#13;
<code class="kr">const</code> <code class="nx">analytics</code> <code class="o">=</code> <code class="nx">processAnalytics</code><code class="p">(</code><code class="nx">transactions</code><code class="p">);</code>&#13;
<code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">mark</code><code class="p">(</code><code class="s1">'process-end'</code><code class="p">);</code>&#13;
<code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">mark</code><code class="p">(</code><code class="s1">'upload-start'</code><code class="p">);</code>&#13;
<code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="s1">'/api/analytics'</code><code class="p">,</code> <code class="p">{</code>&#13;
  <code class="nx">method</code><code class="o">:</code> <code class="s1">'POST'</code><code class="p">,</code>&#13;
  <code class="nx">body</code><code class="o">:</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">analytics</code><code class="p">),</code>&#13;
  <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>&#13;
    <code class="s1">'Content-Type'</code><code class="o">:</code> <code class="s1">'application/json'</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code>&#13;
<code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">mark</code><code class="p">(</code><code class="s1">'upload-end'</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>Once the process has finished and marks have been taken, you can use those marks to generate several measures, as shown in <a data-type="xref" href="#code_measures">Example 15-10</a>.</p>&#13;
<div data-type="example" id="code_measures">&#13;
<h5><span class="label">Example 15-10. </span>Generating measures</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Download transactions:'</code><code class="p">,</code>&#13;
  <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">measure</code><code class="p">(</code>&#13;
    <code class="s1">'transactions'</code><code class="p">,</code> <code class="s1">'transactions-start'</code><code class="p">,</code> <code class="s1">'transactions-end'</code>&#13;
  <code class="p">).</code><code class="nx">duration</code>&#13;
<code class="p">);</code>&#13;
&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Process analytics:'</code><code class="p">,</code>&#13;
  <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">measure</code><code class="p">(</code>&#13;
    <code class="s1">'analytics'</code><code class="p">,</code> <code class="s1">'process-start'</code><code class="p">,</code> <code class="s1">'process-end'</code>&#13;
  <code class="p">).</code><code class="nx">duration</code>&#13;
<code class="p">);</code>&#13;
&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Upload analytics:'</code><code class="p">,</code>&#13;
  <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">measure</code><code class="p">(</code>&#13;
    <code class="s1">'upload'</code><code class="p">,</code> <code class="s1">'upload-start'</code><code class="p">,</code> <code class="s1">'upload-end'</code>&#13;
  <code class="p">).</code><code class="nx">duration</code>&#13;
<code class="p">);</code>&#13;
&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Total time:'</code><code class="p">,</code>&#13;
  <code class="nb">window</code><code class="p">.</code><code class="nx">performance</code><code class="p">.</code><code class="nx">measure</code><code class="p">(</code>&#13;
    <code class="s1">'total'</code><code class="p">,</code> <code class="s1">'transactions-start'</code><code class="p">,</code> <code class="s1">'upload-end'</code>&#13;
  <code class="p">).</code><code class="nx">duration</code>&#13;
<code class="p">);</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id219">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>This example shows how you can create multiple marks and measures to gather performance data on a set of tasks. A given mark can be used more than once, in multiple measures. <a data-type="xref" href="#code_measures">Example 15-10</a> creates a measure for each step of the process, then generates a final measure for the entire task’s duration. This is done by taking the first mark of the download task and the last mark of the upload task, and calculating a measure between them<a data-startref="ix_15-measuring-performance-asciidoc5" data-type="indexterm" id="id1193"/><a data-startref="ix_15-measuring-performance-asciidoc4" data-type="indexterm" id="id1194"/><a data-startref="ix_15-measuring-performance-asciidoc3" data-type="indexterm" id="id1195"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Listening for Performance Entries" data-type="sect1"><div class="sect1" id="id620">&#13;
<h1>Listening for Performance Entries</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id220">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="performance entries, listening for" data-type="indexterm" id="ix_15-measuring-performance-asciidoc6"/><a data-primary="performance measurement" data-secondary="listening for performance entries" data-type="indexterm" id="ix_15-measuring-performance-asciidoc7"/><a data-primary="PerformanceObserver" data-type="indexterm" id="ix_15-measuring-performance-asciidoc8"/>You want to be notified of new performance entries so that you can report them to an analytics service. For example, consider the scenario where you want to be notified of performance statistics every time an API request is made.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id621">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use a <code>PerformanceObserver</code> to listen for new performance entries of the desired type. For API requests, the type would be <code>resource</code> (see <a data-type="xref" href="#code_performanceObserver">Example 15-11</a>).</p>&#13;
<div data-type="example" id="code_performanceObserver">&#13;
<h5><span class="label">Example 15-11. </span>Using a <code>PerformanceObserver</code></h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">analyticsEndpoint</code> <code class="o">=</code> <code class="s1">'https://example.com/api/analytics'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">observer</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">PerformanceObserver</code><code class="p">(</code><code class="nx">entries</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">entry</code> <code class="k">of</code> <code class="nx">entries</code><code class="p">.</code><code class="nx">getEntries</code><code class="p">())</code> <code class="p">{</code>&#13;
    <code class="c1">// Only interested in 'fetch' entries.</code>&#13;
    <code class="c1">// Use the Beacon API to send a quick request containing the performance</code>&#13;
    <code class="c1">// entry data.</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">entry</code><code class="p">.</code><code class="nx">initiatorType</code> <code class="o">===</code> <code class="s1">'fetch'</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="nx">navigator</code><code class="p">.</code><code class="nx">sendBeacon</code><code class="p">(</code><code class="nx">analyticsEndpoint</code><code class="p">,</code> <code class="nx">entry</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">observer</code><code class="p">.</code><code class="nx">observe</code><code class="p">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s1">'resource'</code> <code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id221">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The <code>PerformanceObserver</code> fires for every network request, including the one you make to your analytics service. For this reason, <a data-type="xref" href="#code_performanceObserver">Example 15-11</a> checks to make sure a given entry is not the analytics endpoint before sending the request. Without this check, you end up in an infinite loop of POST requests. When a network request is made, the observer fires and you send the POST request. This creates a new performance entry, which calls the observer again. Each POST to the analytics service triggers a new observer callback.</p>&#13;
&#13;
<p>To prevent a high volume of requests in a short period to your analytics service, for a real application you may want to collect performance entries in a buffer. Once the buffer reaches a certain size, you can send all the entries from the buffer in a single request (see <a data-type="xref" href="#example15-12">Example 15-12</a>)<a data-startref="ix_15-measuring-performance-asciidoc8" data-type="indexterm" id="id1196"/>.<a data-startref="ix_15-measuring-performance-asciidoc7" data-type="indexterm" id="id1197"/><a data-startref="ix_15-measuring-performance-asciidoc6" data-type="indexterm" id="id1198"/><a data-startref="ix_15-measuring-performance-asciidoc0" data-type="indexterm" id="id1199"/></p>&#13;
<div data-type="example" id="example15-12">&#13;
<h5><span class="label">Example 15-12. </span>Sending performance entries in batches</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">analyticsEndpoint</code> <code class="o">=</code> <code class="s1">'https://example.com/api/analytics'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// An array to hold buffered entries. Once the buffer reaches the desired size,</code>&#13;
<code class="c1">// all entries are sent in a single request.</code>&#13;
<code class="kr">const</code> <code class="nx">BUFFER_SIZE</code> <code class="o">=</code> <code class="mi">10</code><code class="p">;</code>&#13;
<code class="kd">let</code> <code class="nx">buffer</code> <code class="o">=</code> <code class="p">[];</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">observer</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">PerformanceObserver</code><code class="p">(</code><code class="nx">entries</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">entry</code> <code class="k">of</code> <code class="nx">entries</code><code class="p">.</code><code class="nx">getEntries</code><code class="p">())</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">entry</code><code class="p">.</code><code class="nx">initiatorType</code> <code class="o">===</code> <code class="s1">'fetch'</code> <code class="o">&amp;&amp;</code> <code class="nx">entry</code><code class="p">.</code><code class="nx">name</code> <code class="o">!==</code> <code class="nx">analyticsEndpoint</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="nx">buffer</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">entry</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// If the buffer has reached its target size, send the analytics request.</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">buffer</code><code class="p">.</code><code class="nx">length</code> <code class="o">===</code> <code class="nx">BUFFER_SIZE</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="nx">fetch</code><code class="p">(</code><code class="nx">analyticsEndpoint</code><code class="p">,</code> <code class="p">{</code>&#13;
        <code class="nx">method</code><code class="o">:</code> <code class="s1">'POST'</code><code class="p">,</code>&#13;
        <code class="nx">body</code><code class="o">:</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">buffer</code><code class="p">),</code>&#13;
        <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>&#13;
          <code class="s1">'Content-Type'</code><code class="o">:</code> <code class="s1">'application/json'</code>&#13;
        <code class="p">}</code>&#13;
      <code class="p">});</code>&#13;
&#13;
      <code class="c1">// Reset the buffer now that the batched entries have been sent.</code>&#13;
      <code class="nx">buffer</code> <code class="o">=</code> <code class="p">[];</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">observer</code><code class="p">.</code><code class="nx">observe</code><code class="p">({</code> <code class="nx">type</code><code class="o">:</code> <code class="s1">'resource'</code> <code class="p">});</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section></body></html>