<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 5. Helm" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_Helm">
<h1><span class="label">Chapter 5. </span>Helm</h1>
<p>In <a data-type="xref" href="ch04.xhtml#ch_Kustomize">Chapter 4</a>, you learned about Kustomize, a simple yet powerful tool to manage Kubernetes resources. But another popular tool aims to simplify the Kubernetes resources management too: <a data-primary="Helm" data-type="indexterm" id="idm45120841731232"/>Helm.</p>
<p>Helm works similarly to Kustomize, but it’s a template solution and acts more like a package manager, producing artifacts that are versionable, sharable, or deployable.</p>
<p>In this chapter, we’ll introduce Helm, a package manager for Kubernetes that helps install and manage Kubernetes applications using the Go template language in YAML files.</p>
<p>The first step is to create a Helm project and deploy it to a Kubernetes cluster (see Recipes <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_5_1">5.1</a> and
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_5_2">5.2</a>). After the first deployment, the application is updated with a new container image, a new configuration value, or any other field, such as the replica number (see <a data-type="xref" href="#recipe_5_3">Recipe 5.3</a>).</p>
<p>One of the differences between Kustomize and Helm is the concept of a <a data-primary="Charts" data-type="indexterm" id="idm45120841671440"/><a data-primary="Helm" data-secondary="Charts" data-type="indexterm" id="idm45120841670832"/>Chart.
A Chart is a packaged artifact that can be shared and contains multiple elements like dependencies on other Charts (see Recipes <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_5_4">5.4</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_5_5">5.5</a>, and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_5_6">5.6</a>).</p>
<p>Application configuration<a data-primary="configuration properties" data-secondary="rolling updates" data-type="indexterm" id="idm45120841665744"/> values are properties usually mapped as a Kubernetes <code>ConfigMap</code>.
Any change (and its consequent update on the cluster) on<a data-primary="ConfigMap" data-secondary="rolling updates, Helm" data-type="indexterm" id="idm45120841664288"/> a <code>ConfigMap</code> doesn’t trigger a rolling update of the application, which means that the application will run with the previous version until you manually restart it.</p>
<p>Helm provides some functions to automatically execute a rolling update when the <code>ConfigMap</code> of an application changes (see <a data-type="xref" href="#recipe_5_7">Recipe 5.7</a>).</p>
<section data-pdf-bookmark="5.1 Creating a Helm Project" data-type="sect1"><div class="sect1" id="recipe_5_1">
<h1>5.1 Creating a Helm Project</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120841659344">
<h2>Problem</h2>
<p>You want to create a simple<a data-primary="Helm" data-secondary="projects, creating" data-type="indexterm" id="Helm_proj_creat"/><a data-primary="projects" data-secondary="Helm" data-tertiary="creating" data-type="indexterm" id="proj_Helm_creat"/> Helm project.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120841654864">
<h2>Solution</h2>
<p>Use the <a href="https://helm.sh">Helm</a> CLI tool to create a new project.</p>
<p>In contrast to Kustomize, which can be used either within the <code>kubectl</code> command or as a standalone CLI tool, Helm needs to be downloaded and installed in your local machine.</p>
<p>Helm is a packager for Kubernetes that bundles related manifest files and packages them into a single logical deployment unit: a <a data-primary="Helm" data-secondary="Charts" data-type="indexterm" id="idm45120841650800"/>Chart.
Thus simplified, for many engineers, Helm makes it easy to start using Kubernetes with real applications.</p>
<p>Helm Charts are useful for addressing the installation complexities and simple upgrades of applications.</p>
<p>For this book, we use Helm 3.7.2, which you can download from <a href="https://oreil.ly/AWfiO">GitHub</a> and install in your PATH directory.</p>
<p>Open a terminal and run the following commands to create a <a data-primary="Helm" data-secondary="Charts" data-tertiary="creating directories" data-type="indexterm" id="idm45120841647536"/>Helm Chart directory layout:</p>
<pre data-code-language="bash" data-type="programlisting">mkdir pacman
mkdir pacman/templates

<code class="nb">cd</code> pacman</pre>
<p>Then create three files: one that defines the Chart, another representing the deployment template using the Go template language and template functions from the Sprig library, and finally a file containing the default values for the Chart.</p>
<p>A <em>Chart.yaml</em> file <a data-primary="Chart.yaml file" data-secondary="creating" data-type="indexterm" id="idm45120841642720"/>declares the Chart with information such as version or name.
Create the file in the root directory:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v2</code><code class="w">
</code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman</code><code class="w">
</code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">A</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Helm</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">chart</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">for</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Pacman</code><code class="w">

</code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">application</code><code class="w">

</code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.1.0</code><code class="w"> </code><a class="co" href="#callout_helm_CO1-1" id="co_helm_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">

</code><code class="nt">appVersion</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">1.0.0</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_helm_CO1-2" id="co_helm_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO1-1" id="callout_helm_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Version of the Chart. This is updated when something in the Chart definition is changed.</p></dd>
<dt><a class="co" href="#co_helm_CO1-2" id="callout_helm_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Version of the application.</p></dd>
</dl>
<p>Let’s create a <em>deployment.yaml</em> and a <em>service.yaml</em> template file to deploy the 
<span class="keep-together">application</span>.</p>
<p>The <em>deployment.yaml</em> file <a data-primary="deployment.yaml, Helm Charts" data-type="indexterm" id="idm45120841577632"/>templatizes the deployment’s name, the application version, the replica count, the container image and tag, the pull policy, the security context, and the port:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO2-1" id="co_helm_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="nv">-</code><code class="nv"> </code><code class="nv">if</code><code class="nv"> </code><code class="nv">.Chart.AppVersion</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO2-2" id="co_helm_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.AppVersion</code><code class="nv"> </code><code class="nv">|</code><code class="nv"> </code><code class="nv">quote</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO2-3" id="co_helm_CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="nv">-</code><code class="nv"> </code><code class="nv">end</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Values.replicaCount</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO2-4" id="co_helm_CO2-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">          </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">{{</code><code class="nv"> </code><code class="s">.Values.image.repository</code><code class="nv"> </code><code class="s">}}:</code><code class="w">
</code><code class="w">          </code><code class="s">{{</code><code class="nv"> </code><code class="s">.Values.image.tag</code><code class="nv"> </code><code class="s">|</code><code class="nv"> </code><code class="s">default</code><code class="nv"> </code><code class="s">.Chart.AppVersion}}</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_helm_CO2-5" id="co_helm_CO2-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w"> </code><a class="co" href="#callout_helm_CO2-6" id="co_helm_CO2-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Values.image.pullPolicy</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO2-7" id="co_helm_CO2-7"><img alt="7" height="12" src="assets/7.png" width="12"/></a><code class="w">
</code><code class="w">            </code><code class="nt">securityContext</code><code class="p">:</code><code class="w">
</code><code class="w">              </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="nv">-</code><code class="nv"> </code><code class="nv">toYaml</code><code class="nv"> </code><code class="nv">.Values.securityContext</code><code class="nv"> </code><code class="nv">|</code><code class="nv"> </code><code class="nv">nindent</code><code class="nv"> </code><code class="nv">14</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">            </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">            </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">              </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Values.image.containerPort</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">                </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w">
</code><code class="w">                </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO2-1" id="callout_helm_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Sets the name from the <em>Chart.yaml</em> file</p></dd>
<dt><a class="co" href="#co_helm_CO2-2" id="callout_helm_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Conditionally sets the version based on the presence of the <code>appVersion</code> in the <em>Chart.yaml</em> file</p></dd>
<dt><a class="co" href="#co_helm_CO2-3" id="callout_helm_CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Sets the <code>appVersion</code> value but quoting the property</p></dd>
<dt><a class="co" href="#co_helm_CO2-4" id="callout_helm_CO2-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Placeholder for the <code>replicaCount</code> property</p></dd>
<dt><a class="co" href="#co_helm_CO2-5" id="callout_helm_CO2-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Placeholder for the container image</p></dd>
<dt><a class="co" href="#co_helm_CO2-6" id="callout_helm_CO2-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></dt>
<dd><p>Placeholder for the image tag if present and if not, defaults to the <em>Chart.yaml</em> property</p></dd>
<dt><a class="co" href="#co_helm_CO2-7" id="callout_helm_CO2-7"><img alt="7" height="12" src="assets/7.png" width="12"/></a></dt>
<dd><p>Sets the <code>securityContext</code> value as a YAML object and not as a string, indenting it 14 spaces</p></dd>
</dl>
<p>The <em>service.yaml</em> file <a data-primary="service.yaml (Helm Charts)" data-type="indexterm" id="idm45120841213408"/>templatizes the service name and the container port:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Service</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w"/>
<code class="w">      </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.image.containerPort</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">      </code><code class="nt">targetPort</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.image.containerPort</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/></pre>
<p>The <em>values.yaml</em> file <a data-primary="values.yaml (Helm Charts)" data-type="indexterm" id="idm45120841178784"/>contains the default values for the Chart.
These values can be overridden at runtime, but they provide good initial values.</p>
<p>Create the file in the root directory with some default values:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">image</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_helm_CO3-1" id="co_helm_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">repository</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/gitops-cookbook/pacman-kikd</code><code class="w"> </code><a class="co" href="#callout_helm_CO3-2" id="co_helm_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">tag</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">1.0.0</code><code class="s">"</code><code class="w">
</code><code class="w">  </code><code class="nt">pullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Always</code><code class="w">
</code><code class="w">  </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w">

</code><code class="nt">replicaCount</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w">
</code><code class="nt">securityContext</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO3-3" id="co_helm_CO3-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO3-1" id="callout_helm_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Defines the <code>image</code> section</p></dd>
<dt><a class="co" href="#co_helm_CO3-2" id="callout_helm_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Sets the <code>repository</code> property</p></dd>
<dt><a class="co" href="#co_helm_CO3-3" id="callout_helm_CO3-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Empty <code>securityContext</code></p></dd>
</dl>
<p>Built-in properties are capitalized; for this reason, properties defined in the <em>Chart.yaml</em> file start with an uppercase letter.</p>
<p>Since the <code>toYaml</code> function is used for the <code>securityContext</code> value, the expected value for the <code>securityContext</code> property in <em>values.yaml</em> should be a YAML object.
For example:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">securityContext</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">capabilities</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">drop</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">ALL</code><code class="w"/>
<code class="w">  </code><code class="nt">readOnlyRootFilesystem</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>
<code class="w">  </code><code class="nt">runAsNonRoot</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>
<code class="w">  </code><code class="nt">runAsUser</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1000</code><code class="w"/></pre>
<p>The relationship between all elements <a data-primary="Helm" data-secondary="elements, relationships of" data-type="indexterm" id="idm45120840955168"/>is shown in <a data-type="xref" href="#fig-511">Figure 5-1</a>.</p>
<figure><div class="figure" id="fig-511">
<img alt="Relationship between Helm elements" height="1189" src="assets/gocb_0501.png" width="1431"/>
<h6><span class="label">Figure 5-1. </span>Relationship between Helm elements</h6>
</div></figure>
<p class="pagebreak-before less_space">At this point the Helm directory layout is created and should be similar to this:</p>
<pre data-code-language="bash" data-type="programlisting"><code>pacman</code><code>
    </code><code>├──</code><code> </code><code>Chart.yaml</code><code> </code><a class="co" href="#callout_helm_CO4-1" id="co_helm_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
    </code><code>├──</code><code> </code><code>templates</code><code> </code><a class="co" href="#callout_helm_CO4-2" id="co_helm_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
    </code><code>│</code><code>   </code><code>├──</code><code> </code><code>deployment.yaml</code><code> </code><a class="co" href="#callout_helm_CO4-3" id="co_helm_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
    </code><code>│</code><code>   </code><code>├──</code><code> </code><code>service.yaml</code><code>
    </code><code>└──</code><code> </code><code>values.yaml</code><code> </code><a class="co" href="#callout_helm_CO4-4" id="co_helm_CO4-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO4-1" id="callout_helm_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>The <em>Chart.yaml</em> file is the Chart descriptor and contains metadata related to the Chart.</p></dd>
<dt><a class="co" href="#co_helm_CO4-2" id="callout_helm_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>The <em>templates</em> directory contains all template files used for installing a Chart.</p></dd>
<dt><a class="co" href="#co_helm_CO4-3" id="callout_helm_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>These files are Helm template files used to deploy the application.</p></dd>
<dt><a class="co" href="#co_helm_CO4-4" id="callout_helm_CO4-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>The <em>values.yaml</em> file contains the default values for a Chart.</p></dd>
</dl>
<p>To render the Helm Chart locally<a data-primary="helm template command" data-type="indexterm" id="idm45120840887360"/><a data-primary="Helm" data-secondary="Charts" data-tertiary="rendering" data-type="indexterm" id="idm45120840886752"/> to YAML, run the following command in a terminal window:</p>
<pre data-code-language="bash" data-type="programlisting">helm template .</pre>
<p>The output is:</p>
<pre data-code-language="bash" data-type="programlisting"><code>---</code><code>
</code><code>apiVersion:</code><code> </code><code>v1</code><code>
</code><code>kind:</code><code> </code><code>Service</code><code>
</code><code>metadata:</code><code>
  </code><code>labels:</code><code>
    </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code>
  </code><code>name:</code><code> </code><code>pacman</code><code> </code><a class="co" href="#callout_helm_CO5-1" id="co_helm_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>spec:</code><code>
  </code><code>ports:</code><code>
    </code><code>-</code><code> </code><code>name:</code><code> </code><code>http</code><code>
      </code><code>port:</code><code> </code><code class="m">8080</code><code> </code><a class="co" href="#callout_helm_CO5-2" id="co_helm_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
      </code><code>targetPort:</code><code> </code><code class="m">8080</code><code>
  </code><code>selector:</code><code>
    </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code>
</code><code>---</code><code>
</code><code>apiVersion:</code><code> </code><code>apps/v1</code><code>
</code><code>kind:</code><code> </code><code>Deployment</code><code>
</code><code>metadata:</code><code>
  </code><code>name:</code><code> </code><code>pacman</code><code>
  </code><code>labels:</code><code>
    </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code>
    </code><code>app.kubernetes.io/version:</code><code> </code><code class="s2">"1.0.0"</code><code> </code><a class="co" href="#callout_helm_CO5-3" id="co_helm_CO5-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
</code><code>spec:</code><code>
  </code><code>replicas:</code><code> </code><code class="m">1</code><code>
  </code><code>selector:</code><code>
    </code><code>matchLabels:</code><code>
      </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code>
  </code><code>template:</code><code>
    </code><code>metadata:</code><code>
      </code><code>labels:</code><code>
        </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code>
    </code><code>spec:</code><code>
      </code><code>containers:</code><code>
          </code><code>-</code><code> </code><code>image:</code><code> </code><code class="s2">"quay.io/gitops-cookbook/pacman-kikd:1.0.0"</code><code> </code><a class="co" href="#callout_helm_CO5-4" id="co_helm_CO5-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code>
            </code><code>imagePullPolicy:</code><code> </code><code>Always</code><code>
            </code><code>securityContext:</code><code> </code><a class="co" href="#callout_helm_CO5-5" id="co_helm_CO5-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code>
              </code><code class="o">{</code><code class="o">}</code><code>
            </code><code>name:</code><code> </code><code>pacman</code><code>
            </code><code>ports:</code><code>
              </code><code>-</code><code> </code><code>containerPort:</code><code> </code><code class="m">8080</code><code>
                </code><code>name:</code><code> </code><code>http</code><code>
                </code><code>protocol:</code><code> </code><code>TCP</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO5-1" id="callout_helm_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Name is injected from <em>Chart.yaml</em></p></dd>
<dt><a class="co" href="#co_helm_CO5-2" id="callout_helm_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Port is set in <em>values.yaml</em></p></dd>
<dt><a class="co" href="#co_helm_CO5-3" id="callout_helm_CO5-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Version is taken from Chart version</p></dd>
<dt><a class="co" href="#co_helm_CO5-4" id="callout_helm_CO5-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Concatenates content from two attributes</p></dd>
<dt><a class="co" href="#co_helm_CO5-5" id="callout_helm_CO5-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Empty security context</p></dd>
</dl>
<p>You can override<a data-primary="Helm" data-secondary="default values, overriding" data-type="indexterm" id="idm45120840720864"/> any default value by using the <code>--set</code> parameter in Helm.
Let’s override the <code>replicaCount</code> value from one (defined in <em>values.yaml</em>) to three:</p>
<pre data-code-language="bash" data-type="programlisting">helm template  --set <code class="nv">replicaCount</code><code class="o">=</code><code class="m">3</code> .</pre>
<p>And the <code>replicas</code> value is updated:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="s">"1.0.0"</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">3</code><code class="w"/>
<code class="p">...</code><code class="w"/></pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120840617840">
<h2>Discussion</h2>
<p>Helm is a package manager for Kubernetes, and as such, it helps you with the task of versioning, sharing, and upgrading Kubernetes applications.</p>
<p>Let’s see how to install the<a data-primary="Kubernetes" data-secondary="Helm Charts" data-tertiary="installing" data-type="indexterm" id="idm45120840652352"/><a data-primary="Helm" data-secondary="Charts" data-tertiary="installing to Kubernetes clusters" data-type="indexterm" id="idm45120840651104"/> Helm Chart to a Kubernetes cluster and upgrade the application.</p>
<p>With Minikube up and running, execute the following command in a terminal window, and run the <code>install</code> command to deploy the application to the cluster:</p>
<pre data-code-language="bash" data-type="programlisting">helm install pacman .</pre>
<p>The Chart is installed in the running Kubernetes instance:</p>
<pre data-code-language="bash" data-type="programlisting">LAST DEPLOYED: Sat Jan <code class="m">22</code> <code class="m">15</code>:13:50 <code class="m">2022</code>
NAMESPACE: default
STATUS: deployed
REVISION: <code class="m">1</code>
TEST SUITE: None</pre>
<p>Get the list of <a data-primary="Helm" data-secondary="installed elements, listing" data-type="indexterm" id="idm45120840605200"/><a data-primary="Kubernetes" data-secondary="Helm Charts" data-tertiary="listing installed elements" data-type="indexterm" id="idm45120840604352"/>current deployed pods, Deployments, and Services to validate that the Helm Chart is deployed in the Kubernetes cluster:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods

NAME                    READY   STATUS    RESTARTS   AGE
pacman-7947b988-kzjbc   <code class="m">1</code>/1     Running   <code class="m">0</code>          60s</pre>
<pre data-code-language="bash" data-type="programlisting">kubectl get deployment

NAME     READY   UP-TO-DATE   AVAILABLE   AGE
pacman   <code class="m">1</code>/1     <code class="m">1</code>            <code class="m">1</code>           4m50s</pre>
<pre data-code-language="bash" data-type="programlisting">kubectl get services

NAME     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<code class="o">(</code>S<code class="o">)</code>    AGE
pacman   ClusterIP   <code class="m">172</code>.30.129.123   &lt;none&gt;        <code class="m">8080</code>/TCP   9m55s</pre>
<p>Also, it’s possible to get history <a data-primary="Helm" data-secondary="Charts" data-tertiary="history command" data-type="indexterm" id="idm45120840525616"/><a data-primary="Charts" data-secondary="history command" data-type="indexterm" id="idm45120840524640"/>information about the deployed Helm Chart using the <code>history</code> command:</p>
<pre data-code-language="bash" data-type="programlisting">helm <code class="nb">history</code> pacman

REVISION	UPDATED                 	STATUS  	CHART       ↳
   APP VERSION   DESCRIPTION
<code class="m">1</code>       	Sat Jan <code class="m">22</code> <code class="m">15</code>:23:22 <code class="m">2022</code>	deployed	pacman-0.1.0↳
   <code class="m">1</code>.0.0         Install <code class="nb">complete</code></pre>
<p>To uninstall a <a data-primary="Charts" data-secondary="uninstalling" data-type="indexterm" id="idm45120840506688"/><a data-primary="Helm" data-secondary="Charts" data-tertiary="uninstalling" data-type="indexterm" id="idm45120840505840"/>Chart from the cluster, run <code>uninstall</code> command:</p>
<pre data-code-language="bash" data-type="programlisting">helm uninstall pacman

release <code class="s2">"pacman"</code> uninstalled</pre>
<p>Helm is a package manager that lets you <a data-primary="Charts" data-secondary="sharing to other Charts" data-type="indexterm" id="idm45120840456432"/><a data-primary="Helm" data-secondary="Charts" data-tertiary="sharing to other Charts" data-type="indexterm" id="idm45120840455920"/>share the Chart (package) to other Charts as a dependency.
For example, you can have a Chart defining the deployment of the application and another Chart as a dependency setting a database deployment.
In this way, the installation process installs the application and the database Chart automatically.</p>
<p>We’ll learn <a data-primary="Helm" data-secondary="projects, creating" data-startref="Helm_proj_creat" data-type="indexterm" id="idm45120840482240"/><a data-primary="projects" data-secondary="Helm" data-startref="proj_Helm_creat" data-tertiary="creating" data-type="indexterm" id="idm45120840481072"/>about the packaging process and adding dependencies in a later section.</p>
<div data-type="tip"><h6>Tip</h6>
<p>You can use the <code>helm create &lt;name&gt;</code> <a data-primary="helm create &lt;name&gt; command" data-type="indexterm" id="idm45120840453696"/>command to let <a data-primary="projects" data-secondary="Helm" data-tertiary="scaffolding" data-type="indexterm" id="idm45120840452976"/><a data-primary="Helm" data-secondary="scaffolding projects" data-type="indexterm" id="idm45120840451728"/>the Helm tool skaffold the project.</p>
</div>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120841653920">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://helm.sh">Helm</a></p>
</li>
<li>
<p><a href="https://oreil.ly/vYI40">Go template package</a></p>
</li>
<li>
<p><a href="https://oreil.ly/ngC2v">Sprig Function Documentation</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="5.2 Reusing Statements Between Templates" data-type="sect1"><div class="sect1" id="recipe_5_2">
<h1>5.2 Reusing Statements Between Templates</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120840427376">
<h2>Problem</h2>
<p>You want to reuse template <a data-primary="Helm" data-secondary="template statements, reusable" data-type="indexterm" id="Helm_tempstate_reuse"/><a data-primary="template statements, reusable" data-type="indexterm" id="tempstate_reuse"/><a data-primary="statements, reusable" data-type="indexterm" id="statement_reuse"/>statements across several files.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120840422976">
<h2>Solution</h2>
<p>Use <em>_helpers.tpl</em> to define<a data-primary="_helpers.tpl" data-primary-sortas="helpers.tpl" data-type="indexterm" id="helper_temp"/> reusable statements.</p>
<p>We deployed a simple application to Kubernetes using Helm in the previous recipe.
This simple application was composed of a Kubernetes Deployment file and a Kubernetes Service file where the <code>selector</code> field was defined with the same value.</p>
<p>As a reminder:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="p">...</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.replicaCount</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}}</code><code class="w"/>
<code class="p">...</code><code class="w"/></pre>
<pre data-code-language="yaml" data-type="programlisting"><code class="l-Scalar-Plain">service.yaml</code><code class="w"/>
<code class="l-Scalar-Plain">----</code><code class="w"/>
<code class="p">...</code><code class="w"/>
<code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="l-Scalar-Plain">----</code><code class="w"/></pre>
<p>If you need to update this field—for example, adding a new label as a selector—you would need to update in three places, as shown in the previous snippets.</p>
<p>Helm lets you create a <em>_helpers.tpl</em> file in the <em>templates</em> directory defining statements that can be called in templates to avoid this problem.</p>
<p>Let’s refactor the previous example to use the <em>_helpers.tpl</em> file to define the <code>selectorLabels</code>.</p>
<p>Create the <em>_helpers.tpl</em> file in the <em>templates</em> directory with the following content:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="nv">-</code><code class="nv"> </code><code class="nv">define</code><code class="nv"> </code><code class="nv">"pacman.selectorLabels"</code><code class="nv"> </code><code class="nv">-</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO6-1" id="co_helm_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO6-2" id="co_helm_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="nv">-</code><code class="nv"> </code><code class="nv">end</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO6-1" id="callout_helm_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Defines the statement name</p></dd>
<dt><a class="co" href="#co_helm_CO6-2" id="callout_helm_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Defines the logic of the statement</p></dd>
</dl>
<p>Then replace the template placeholders shown in previous snippets with a call to the <code>podman.selectorLabels</code> helper statement using the <code>include</code> keyword:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Values.replicaCount</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="nv">-</code><code class="nv"> </code><code class="nv">include</code><code class="nv"> </code><code class="nv">"pacman.selectorLabels"</code><code class="nv"> </code><code class="nv">.</code><code class="nv"> </code><code class="nv">|</code><code class="nv"> </code><code class="nv">nindent</code><code class="nv"> </code><code class="nv">6</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO7-1" id="co_helm_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="nv">-</code><code class="nv"> </code><code class="nv">include</code><code class="nv"> </code><code class="nv">"pacman.selectorLabels"</code><code class="nv"> </code><code class="nv">.</code><code class="nv"> </code><code class="nv">|</code><code class="nv"> </code><code class="nv">nindent</code><code class="nv"> </code><code class="nv">8</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO7-2" id="co_helm_CO7-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO7-1" id="callout_helm_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Calls <code>pacman.selectorLabels</code> with indentation</p></dd>
<dt><a class="co" href="#co_helm_CO7-2" id="callout_helm_CO7-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Calls <code>pacman.selectorLabels</code> with indentation</p></dd>
</dl>
<p>To render the Helm Chart locally to YAML, run the following command in a terminal window:</p>
<pre data-code-language="bash" data-type="programlisting">helm template .</pre>
<p>The output is:</p>
<pre data-code-language="bash" data-type="programlisting"><code>apiVersion:</code><code> </code><code>v1</code><code>
</code><code>kind:</code><code> </code><code>Service</code><code>
</code><code>metadata:</code><code>
  </code><code>labels:</code><code>
    </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code>
  </code><code>name:</code><code> </code><code>pacman</code><code>
</code><code>spec:</code><code>
  </code><code>ports:</code><code>
    </code><code>-</code><code> </code><code>name:</code><code> </code><code>http</code><code>
      </code><code>port:</code><code> </code><code class="m">8080</code><code>
      </code><code>targetPort:</code><code> </code><code class="m">8080</code><code>
  </code><code>selector:</code><code>
    </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code> </code><a class="co" href="#callout_helm_CO8-1" id="co_helm_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>---</code><code>
</code><code>apiVersion:</code><code> </code><code>apps/v1</code><code>
</code><code>kind:</code><code> </code><code>Deployment</code><code>
</code><code>metadata:</code><code>
  </code><code>name:</code><code> </code><code>pacman</code><code>
  </code><code>labels:</code><code>
    </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code>
    </code><code>app.kubernetes.io/version:</code><code> </code><code class="s2">"1.0.0"</code><code>
</code><code>spec:</code><code>
  </code><code>replicas:</code><code> </code><code class="m">1</code><code>
  </code><code>selector:</code><code>
    </code><code>matchLabels:</code><code>
      </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code> </code><a class="co" href="#callout_helm_CO8-2" id="co_helm_CO8-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
  </code><code>template:</code><code>
    </code><code>metadata:</code><code>
      </code><code>labels:</code><code>
        </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code> </code><a class="co" href="#callout_helm_CO8-3" id="co_helm_CO8-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
    </code><code>spec:</code><code>
      </code><code>containers:</code><code>
          </code><code>-</code><code> </code><code>image:</code><code> </code><code class="s2">"quay.io/gitops-cookbook/pacman-kikd:1.0.0"</code><code>
            </code><code>imagePullPolicy:</code><code> </code><code>Always</code><code>
            </code><code>securityContext:</code><code>
              </code><code class="o">{</code><code class="o">}</code><code>
            </code><code>name:</code><code> </code><code>pacman</code><code>
            </code><code>ports:</code><code>
              </code><code>-</code><code> </code><code>containerPort:</code><code> </code><code class="m">8080</code><code>
                </code><code>name:</code><code> </code><code>http</code><code>
                </code><code>protocol:</code><code> </code><code>TCP</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO8-1" id="callout_helm_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Selector is updated with value set in <em>_helpers.tpl</em></p></dd>
<dt><a class="co" href="#co_helm_CO8-2" id="callout_helm_CO8-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Selector is updated with value set in <em>_helpers.tpl</em></p></dd>
<dt><a class="co" href="#co_helm_CO8-3" id="callout_helm_CO8-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Selector is updated with value set in <em>_helpers.tpl</em></p></dd>
</dl>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120840422032">
<h2>Discussion</h2>
<p>If you want to update the selector labels, the only change you need to do is an update to the <em>_helpers.tpl</em> file:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="nv">-</code><code class="nv"> </code><code class="nv">define</code><code class="nv"> </code><code class="nv">"pacman.selectorLabels"</code><code class="nv"> </code><code class="nv">-</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.AppVersion</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO9-1" id="co_helm_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="nv">-</code><code class="nv"> </code><code class="nv">end</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO9-1" id="callout_helm_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Adds a new attribute</p></dd>
</dl>
<p class="less_space pagebreak-before">To render the Helm Chart locally to YAML, run the following command in a terminal window:</p>
<pre data-code-language="bash" data-type="programlisting">helm template .</pre>
<p>The output is:</p>
<pre data-code-language="bash" data-type="programlisting"><code>---</code><code>
</code><code class="c1"># Source: pacman/templates/service.yaml
</code><code>apiVersion:</code><code> </code><code>v1</code><code>
</code><code>kind:</code><code> </code><code>Service</code><code>
</code><code>metadata:</code><code>
</code><code>...</code><code>
  </code><code>selector:</code><code>
    </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code>
    </code><code>app.kubernetes.io/version:</code><code> </code><code class="m">1</code><code>.0.0</code><code> </code><a class="co" href="#callout_helm_CO10-1" id="co_helm_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>---</code><code>
</code><code>apiVersion:</code><code> </code><code>apps/v1</code><code>
</code><code>kind:</code><code> </code><code>Deployment</code><code>
</code><code>metadata:</code><code>
  </code><code>name:</code><code> </code><code>pacman</code><code>
  </code><code>labels:</code><code>
    </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code>
    </code><code>app.kubernetes.io/version:</code><code> </code><code class="s2">"1.0.0"</code><code>
</code><code>spec:</code><code>
  </code><code>replicas:</code><code> </code><code class="m">1</code><code>
  </code><code>selector:</code><code>
    </code><code>matchLabels:</code><code>
      </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code>
      </code><code>app.kubernetes.io/version:</code><code> </code><code class="m">1</code><code>.0.0</code><code> </code><a class="co" href="#callout_helm_CO10-2" id="co_helm_CO10-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
  </code><code>template:</code><code>
    </code><code>metadata:</code><code>
      </code><code>labels:</code><code>
        </code><code>app.kubernetes.io/name:</code><code> </code><code>pacman</code><code>
        </code><code>app.kubernetes.io/version:</code><code> </code><code class="m">1</code><code>.0.0</code><code> </code><a class="co" href="#callout_helm_CO10-3" id="co_helm_CO10-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code>
    </code><code>spec:</code><code>
</code><code>...</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO10-1" id="callout_helm_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Label is added</p></dd>
<dt><a class="co" href="#co_helm_CO10-2" id="callout_helm_CO10-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Label is added</p></dd>
<dt><a class="co" href="#co_helm_CO10-3" id="callout_helm_CO10-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Label is added</p></dd>
</dl>
<div data-type="tip"><h6>Tip</h6>
<p>Although <a data-primary="_helpers.tpl" data-primary-sortas="helpers.tpl" data-startref="helper_temp" data-type="indexterm" id="idm45120839817376"/><a data-primary="Helm" data-secondary="template statements, reusable" data-startref="Helm_tempstate_reuse" data-type="indexterm" id="idm45120839816096"/><a data-primary="template statements, reusable" data-startref="tempstate_reuse" data-type="indexterm" id="idm45120839788336"/><a data-primary="statements, reusable" data-startref="statement_reuse" data-type="indexterm" id="idm45120839787488"/>it’s common to use <em>__helpers.tpl</em> as the filename to define functions, you can name any file starting with <code>__</code>, and Helm will read the functions too.</p>
</div>
</div></section>
</div></section>
<section data-pdf-bookmark="5.3 Updating a Container Image in Helm" data-type="sect1"><div class="sect1" id="recipe_5_3">
<h1>5.3 Updating a Container Image in Helm</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120839784320">
<h2>Problem</h2>
<p>You want to update <a data-primary="container images" data-secondary="updating" data-tertiary="Helm" data-type="indexterm" id="contimg_updat_Helm"/><a data-primary="Helm" data-secondary="container images, updating" data-type="indexterm" id="Helm_contimg_updat"/>the container image from a deployment file using Helm and upgrade the running instance.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120839780384">
<h2>Solution</h2>
<p>Use the <code>upgrade</code> <a data-primary="upgrade command" data-type="indexterm" id="upgradcom"/>command.</p>
<p>With Minikube up and running, deploy version 1.0.0 of the <code>pacman</code> application:</p>
<pre data-code-language="bash" data-type="programlisting">helm install pacman .</pre>
<p>With the first revision deployed, let’s update the container image to a new version and deploy it.</p>
<p>You can check revision <a data-primary="container images" data-secondary="revision number, checking" data-type="indexterm" id="idm45120839773136"/>number by running the following command:</p>
<pre data-code-language="bash" data-type="programlisting">helm <code class="nb">history</code> pacman

REVISION   UPDATED                   STATUS    CHART          APP VERSION↳
  DESCRIPTION
<code class="m">1</code>          Sun Jan <code class="m">23</code> <code class="m">16</code>:00:09 <code class="m">2022</code>  deployed  pacman-0.1.0   <code class="m">1</code>.0.0↳
  Install <code class="nb">complete</code></pre>
<p>To update the version, open <em>values.yaml</em> and update the <code>image.tag</code> field to the newer container image tag:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">image</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">repository</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/gitops-cookbook/pacman-kikd</code><code class="w">
</code><code class="w">  </code><code class="nt">tag</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">1.1.0</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_helm_CO11-1" id="co_helm_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">pullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Always</code><code class="w">
</code><code class="w">  </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w">

</code><code class="nt">replicaCount</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w">
</code><code class="nt">securityContext</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO11-1" id="callout_helm_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Updates to container tag to 1.1.0</p></dd>
</dl>
<p>Then update the <code>appVersion</code> field of the <em>Chart.yaml</em> file:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v2</code><code class="w">
</code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman</code><code class="w">
</code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">A</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Helm</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">chart</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">for</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Pacman</code><code class="w">

</code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">application</code><code class="w">
</code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.1.0</code><code class="w">
</code><code class="nt">appVersion</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">1.1.0</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_helm_CO12-1" id="co_helm_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO12-1" id="callout_helm_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Version is updated accordingly</p></dd>
</dl>
<div data-type="tip"><h6>Tip</h6>
<p>You can use <code>appVersion</code> as <a data-primary="appVersion tag" data-type="indexterm" id="idm45120839619776"/>the tag instead of having two separate fields. Using two fields or one might depend on your use case, versioning strategy, and lifecycle of your software.</p>
</div>
<p>After these changes, upgrade the deployment by running the <a data-primary="upgrade command" data-startref="upgradcom" data-type="indexterm" id="idm45120839618400"/>following command:</p>
<pre data-code-language="bash" data-type="programlisting">helm upgrade pacman .</pre>
<p>The output reflects that a new revision has been deployed:</p>
<pre data-code-language="bash" data-type="programlisting"><code>Release</code><code> </code><code class="s2">"pacman"</code><code> </code><code>has</code><code> </code><code>been</code><code> </code><code>upgraded.</code><code> </code><code>Happy</code><code> </code><code>Helming!</code><code>
</code><code>NAME:</code><code> </code><code>pacman</code><code>
</code><code>LAST</code><code> </code><code>DEPLOYED:</code><code> </code><code>Mon</code><code> </code><code>Jan</code><code> </code><code class="m">24</code><code> </code><code class="m">11</code><code>:39:28</code><code> </code><code class="m">2022</code><code>
</code><code>NAMESPACE:</code><code> </code><code>asotobue-dev</code><code>
</code><code>STATUS:</code><code> </code><code>deployed</code><code>
</code><code>REVISION:</code><code> </code><code class="m">2</code><code> </code><a class="co" href="#callout_helm_CO13-1" id="co_helm_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>TEST</code><code> </code><code>SUITE:</code><code> </code><code>None</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO13-1" id="callout_helm_CO13-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>New revision</p></dd>
</dl>
<p>The <code>history</code> command <a data-primary="history command" data-type="indexterm" id="idm45120839531792"/>shows all changes between all versions:</p>
<pre data-code-language="bash" data-type="programlisting">helm <code class="nb">history</code> pacman

REVISION UPDATED                  STATUS    	CHART       	APP VERSION↳
DESCRIPTION
<code class="m">1</code>        Mon Jan <code class="m">24</code> <code class="m">10</code>:22:06 <code class="m">2022</code> superseded	pacman-0.1.0	<code class="m">1</code>.0.0↳
Install <code class="nb">complete</code>
<code class="m">2</code>        Mon Jan <code class="m">24</code> <code class="m">11</code>:39:28 <code class="m">2022</code> deployed  	pacman-0.1.0	<code class="m">1</code>.1.0↳
Upgrade <code class="nb">complete</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><code>appVersion</code> is the application version, so every time you change the application version, you should update that field too. On the other side, <code>version</code> is the Chart version and should be updated when the definition of the Chart (i.e., templates) changes, so both fields are independent.</p>
</div>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120839779472">
<h2>Discussion</h2>
<p>Not only you can install or upgrade a version with Helm, but you can also roll back to a previous revision.</p>
<p>In the terminal window, <a data-primary="helm rollback command" data-type="indexterm" id="idm45120839478928"/><a data-primary="rollback command" data-type="indexterm" id="idm45120839478336"/>run the following command:</p>
<pre data-code-language="bash" data-type="programlisting">helm rollback pacman <code class="m">1</code>

Rollback was a success! Happy Helming!</pre>
<p class="less_space pagebreak-before">Running the <code>history</code> command reflects this change too:</p>
<pre data-code-language="bash" data-type="programlisting">helm <code class="nb">history</code> pacman

REVISION  UPDATED                   STATUS    	CHART       	APP VERSION↳
DESCRIPTION
<code class="m">1</code>         Mon Jan <code class="m">24</code> <code class="m">10</code>:22:06 <code class="m">2022</code>  superseded	pacman-0.1.0	<code class="m">1</code>.0.0↳
Install <code class="nb">complete</code>
<code class="m">2</code>         Mon Jan <code class="m">24</code> <code class="m">11</code>:39:28 <code class="m">2022</code>  superseded	pacman-0.1.0	<code class="m">1</code>.1.0↳
Upgrade <code class="nb">complete</code>
<code class="m">3</code>         Mon Jan <code class="m">24</code> <code class="m">12</code>:31:58 <code class="m">2022</code>  deployed  	pacman-0.1.0	<code class="m">1</code>.0.0↳
Rollback to</pre>
<p>Finally, Helm offers a way to <a data-primary="Helm" data-secondary="values, overriding" data-type="indexterm" id="idm45120839474240"/>override values, not only using the <code>--set</code> argument as shown in <a data-type="xref" href="#recipe_5_1">Recipe 5.1</a>, but by providing a YAML file.</p>
<p>Create a new YAML file named <em>newvalues.yaml</em> in the root directory with the following content:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">image</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">tag</code><code class="p">:</code><code class="w"> </code><code class="s">"1.2.0"</code><code class="w"/></pre>
<p>Then run the <code>template</code> command, <a data-primary="template command" data-type="indexterm" id="idm45120839408192"/>setting the new file as an override of <em>values.yaml</em>:</p>
<pre data-code-language="bash" data-type="programlisting">helm template pacman -f newvalues.yaml .</pre>
<p>The <a data-primary="container images" data-secondary="updating" data-startref="contimg_updat_Helm" data-tertiary="Helm" data-type="indexterm" id="idm45120839376848"/><a data-primary="Helm" data-secondary="container images, updating" data-startref="Helm_contimg_updat" data-type="indexterm" id="idm45120839383504"/>resulting YAML document is using the values set in <em>values.yaml</em> but overriding the <code>images.tag</code> set in <em>newvalues.yaml</em>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman</code><code class="w"/>
<code class="p">...</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman</code><code class="w"/>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman</code><code class="w"/>
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="s">"quay.io/gitops-cookbook/pacman-kikd:1.2.0"</code><code class="w"/>
<code class="w">            </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Always</code><code class="w"/>
<code class="p">...</code><code class="w"/></pre>
</div></section>
</div></section>
<section data-pdf-bookmark="5.4 Packaging and Distributing a Helm Chart" data-type="sect1"><div class="sect1" id="recipe_5_4">
<h1>5.4 Packaging and Distributing a Helm Chart</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120839241696">
<h2>Problem</h2>
<p>You want to<a data-primary="Helm" data-secondary="Charts" data-tertiary="packaging/distributing" data-type="indexterm" id="Helm_Chart_packdist"/><a data-primary="Charts" data-secondary="packaging/distributing" data-type="indexterm" id="Charts_pack_dist"/> package and distribute a Helm Chart so it can be reused by others.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120839237248">
<h2>Solution</h2>
<p>Use the <code>package</code> <a data-primary="package command" data-type="indexterm" id="idm45120839235104"/>command.</p>
<p>Helm is a package manager for Kubernetes.
As we’ve seen in this chapter, the basic unit in Helm is a Chart containing the Kubernetes files required to deploy the application, the default values for the templates, etc.</p>
<p>But we’ve not yet seen how to package Helm Charts and distribute them to be available to other Charts as dependencies or deployed by other users.</p>
<p>Let’s package the <code>pacman</code> Chart into a <em>.tgz</em> file.
In the <em>pacman</em> directory, run the following command:</p>
<pre data-code-language="bash" data-type="programlisting">helm package .</pre>
<p>And you’ll get a message informing you where the archive is stored:</p>
<pre data-code-language="bash" data-type="programlisting">Successfully packaged chart and saved it to:↳
gitops-cookbook/code/05_helm/04_package/pacman/pacman-0.1.0.tgz</pre>
<p>A Chart then needs to be published <a data-primary="Charts" data-secondary="publishing" data-type="indexterm" id="idm45120839192000"/><a data-primary="Helm" data-secondary="Charts" data-tertiary="publishing" data-type="indexterm" id="idm45120839191488"/>into a Chart repository.
A Chart <a data-primary="Charts" data-secondary="repositories" data-type="indexterm" id="idm45120839198544"/><a data-primary="repositories" data-secondary="Helm Charts" data-type="indexterm" id="idm45120839197696"/>repository is an HTTP server with an <em>index.yaml</em> file containing metadata information regarding Charts and <em>.tgz</em> Charts.</p>
<p>To publish them, update<a data-primary="index.yaml, updating" data-type="indexterm" id="idm45120839205616"/> the <em>index.yaml</em> file with the new metadata information, and upload the artifact.</p>
<p>The directory layout of a <a data-primary="repositories" data-secondary="directory layout" data-type="indexterm" id="idm45120839201072"/>repository might look like this:</p>
<pre data-code-language="bash" data-type="programlisting">repo
├── index.yaml
├── pacman-0.1.0.tgz</pre>
<p>The <em>index.yaml</em> file with information about each Chart present in the repository looks like:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="nt">entries</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">pacman</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v2</code><code class="w"/>
<code class="w">    </code><code class="nt">appVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.0.0</code><code class="w"/>
<code class="w">    </code><code class="nt">created</code><code class="p">:</code><code class="w"> </code><code class="s">"2022-01-24T16:42:54.080959+01:00"</code><code class="w"/>
<code class="w">    </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">A Helm chart for Pacman</code><code class="w"/>
<code class="w">    </code><code class="nt">digest</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">aa3cce809ffcca86172fc793d7804d1c61f157b9b247680a67d5b16b18a0798d</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman</code><code class="w"/>
<code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">application</code><code class="w"/>
<code class="w">    </code><code class="nt">urls</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">pacman-0.1.0.tgz</code><code class="w"/>
<code class="w">    </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.1.0</code><code class="w"/>
<code class="nt">generated</code><code class="p">:</code><code class="w"> </code><code class="s">"2022-01-24T16:42:54.080485+01:00"</code><code class="w"/></pre>
<div data-type="tip"><h6>Tip</h6>
<p>You can <a data-primary="repo index command" data-type="indexterm" id="idm45120839150416"/>run <code>helm repo index</code> in the root directory, where packaged Charts are stored, to generate the index file <a data-primary="Helm" data-secondary="Charts" data-startref="Helm_Chart_packdist" data-tertiary="packaging/distributing" data-type="indexterm" id="idm45120839089152"/><a data-primary="Charts" data-secondary="packaging/distributing" data-startref="Charts_pack_dist" data-type="indexterm" id="idm45120839087632"/>automatically.</p>
</div>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120839236656">
<h2>Discussion</h2>
<p>In addition to packaging a Helm Chart, Helm can generate a signature file for the packaged Chart to verify its correctness later.</p>
<p>In this way, you can be sure it has not been modified, and it’s the correct Chart.</p>
<p>To sign/verify the package, you need a pair of GPG keys in the machine; we’re assuming you already have one pair created.</p>
<p>Now you need to call the <code>package</code> command but set the <code>-sign</code> argument with the required parameters to generate a signature file:</p>
<pre data-code-language="bash" data-type="programlisting">helm package --sign --key <code class="s1">'me@example.com'</code> <code class="se">\</code>
  --keyring /home/me/.gnupg/secring.gpg  .</pre>
<p>Now, two files are created—the packaged Helm Chart (<em>.tgz</em>) and the signature file (<em>.tgz.prov</em>):</p>
<pre data-code-language="bash" data-type="programlisting"><code>.</code><code>
</code><code>├──</code><code> </code><code>Chart.yaml</code><code>
</code><code>├──</code><code> </code><code>pacman-0.1.0.tgz</code><code> </code><a class="co" href="#callout_helm_CO14-1" id="co_helm_CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>├──</code><code> </code><code>pacman-0.1.0.tgz.prov</code><code> </code><a class="co" href="#callout_helm_CO14-2" id="co_helm_CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>├──</code><code> </code><code>templates</code><code>
</code><code>│</code><code>  </code><code>├──</code><code> </code><code>deployment.yaml</code><code>
</code><code>│</code><code>  </code><code>└──</code><code> </code><code>service.yaml</code><code>
</code><code>└──</code><code> </code><code>values.yaml</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO14-1" id="callout_helm_CO14-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Chart package</p></dd>
<dt><a class="co" href="#co_helm_CO14-2" id="callout_helm_CO14-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Signature file</p></dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Remember to upload both files in the Chart repository.</p>
</div>
<p>To verify that a Chart <a data-primary="Charts" data-secondary="validating" data-type="indexterm" id="idm45120838974384"/><a data-primary="Helm" data-secondary="Charts" data-tertiary="validating" data-type="indexterm" id="idm45120838973376"/>is valid and has not been manipulated, use the <code>verify</code>
<span class="keep-together">command</span>:</p>
<pre data-code-language="bash" data-type="programlisting"><code>helm</code><code> </code><code>verify</code><code> </code><code>pacman-0.1.0.tgz</code><code>

</code><code>Signed</code><code> </code><code>by:</code><code> </code><code>alexs</code><code> </code><code class="o">(</code><code>book</code><code class="o">)</code><code> </code><code>&lt;</code><code>asotobu@example.com&gt;</code><code>
</code><code>Using</code><code> </code><code>Key</code><code> </code><code>With</code><code> </code><code>Fingerprint:</code><code> </code><code>57C4511D738BC0B288FAF9D69B40EB787040F3CF</code><code>
</code><code>Chart</code><code> </code><code>Hash</code><code> </code><code>Verified:↳</code><code>
</code><code>sha256:d8b2e0c5e12a8425df2ea3a903807b93aabe4a6ff8277511a7865c847de3c0bf</code><code> </code><a class="co" href="#callout_helm_CO15-1" id="co_helm_CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO15-1" id="callout_helm_CO15-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>It’s valid</p></dd>
</dl>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120839085568">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/pQ2Ab">The Chart Repository Guide</a></p>
</li>
<li>
<p><a href="https://oreil.ly/1Hql0">Helm Provenance and Integrity</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="5.5 Deploying a Chart from a Repository" data-type="sect1"><div class="sect1" id="recipe_5_5">
<h1>5.5 Deploying a Chart from a Repository</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120838897152">
<h2>Problem</h2>
<p>You want to deploy<a data-primary="Helm" data-secondary="Charts" data-tertiary="deploying" data-type="indexterm" id="Helm_Chart_deploy"/><a data-primary="Charts" data-secondary="deploying" data-type="indexterm" id="Chart_deploy"/><a data-primary="repositories" data-secondary="Helm Charts" data-tertiary="deploying" data-type="indexterm" id="repo_Chart_deploy"/> a Helm Chart stored in Chart repository.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120838891760">
<h2>Solution</h2>
<p>Use the <code>repo add</code> command<a data-primary="repo add command" data-type="indexterm" id="idm45120838889328"/> to add the remote repository and the <code>install</code> <a data-primary="install command" data-type="indexterm" id="idm45120838888080"/>command to deploy it.</p>
<p>Public Helm Chart repositories <a data-primary="Public Helm Chart repositories" data-type="indexterm" id="idm45120838886800"/><a data-primary="Helm Chart repositories" data-type="indexterm" id="idm45120838886128"/><a data-primary="Helm" data-secondary="Charts" data-tertiary="public repositories" data-type="indexterm" id="idm45120838885456"/><a data-primary="Charts" data-secondary="public repositories" data-type="indexterm" id="idm45120838884240"/><a data-primary="repositories" data-secondary="Helm Charts" data-tertiary="public" data-type="indexterm" id="idm45120838883296"/>like <a href="https://oreil.ly/QJzWZ">Bitnami</a> are available for this purpose.</p>
<p>To install Charts from a repository (either public or private), you need to register <a data-primary="Charts" data-secondary="registering" data-type="indexterm" id="idm45120838880848"/><a data-primary="Helm" data-secondary="Charts" data-tertiary="registering" data-type="indexterm" id="idm45120838879872"/>it using its URL:</p>
<pre data-code-language="bash" data-type="programlisting"><code>helm</code><code> </code><code>repo</code><code> </code><code>add</code><code> </code><code>bitnami</code><code> </code><code>https://charts.bitnami.com/bitnami</code><code> </code><a class="co" href="#callout_helm_CO16-1" id="co_helm_CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO16-1" id="callout_helm_CO16-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>URL of Helm Chart repository where <em>index.yaml</em> is placed</p></dd>
</dl>
<p>List the <a data-primary="repo list command" data-type="indexterm" id="idm45120838866208"/>registered repositories:</p>
<pre data-code-language="bash" data-type="programlisting"><code>helm</code><code> </code><code>repo</code><code> </code><code>list</code><code>

</code><code>NAME</code><code>     	</code><code>URL</code><code>
</code><code>stable</code><code>   	</code><code>https://charts.helm.sh/stable</code><code>
</code><code>bitnami</code><code>  	</code><code>https://charts.bitnami.com/bitnami</code><code> </code><a class="co" href="#callout_helm_CO17-1" id="co_helm_CO17-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO17-1" id="callout_helm_CO17-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Bitnami repo is registered</p></dd>
</dl>
<div data-type="tip"><h6>Tip</h6>
<p>Run <code>helm repo update</code> to get the <a data-primary="repo update command" data-type="indexterm" id="idm45120838830112"/>latest list of Charts for each repo.</p>
</div>
<p>After registering a repository, you might want to find which <a data-primary="Charts" data-secondary="available" data-type="indexterm" id="idm45120838828736"/><a data-primary="Helm" data-secondary="Charts" data-tertiary="finding available" data-type="indexterm" id="idm45120838827760"/>Charts are available.</p>
<p>If you want to <a data-primary="PostgreSQL servers, deploying" data-type="indexterm" id="PostgreSQL_deploy"/>deploy a PostgreSQL instance in the cluster, use the <code>search</code> command to <a data-primary="search command" data-type="indexterm" id="idm45120838804768"/>search all repositories for a Chart that matches the name:</p>
<pre data-code-language="bash" data-type="programlisting">helm search repo postgresql</pre>
<p>The outputs are the list of Charts that matches the name, the version of the Chart and PostgreSQL, and a description.
Notice the name of the Chart is composed of the repository name and the Chart name, i.e., <code>bitnami/postgresql</code>:</p>
<pre data-type="programlisting">NAME                               	CHART VERSION	APP VERSION↳
	DESCRIPTION
bitnami/postgresql                 	10.16.2      	11.14.0↳
    	Chart for PostgreSQL, an object-relational data...
bitnami/postgresql-ha              	8.2.6        	11.14.0↳
    	Chart for PostgreSQL with HA architecture (usin...
stable/postgresql                  	8.6.4        	11.7.0↳
     	DEPRECATED Chart for PostgreSQL, an object-rela...
stable/pgadmin                     	1.2.2        	4.18.0↳
     	pgAdmin is a web based administration tool for ...
stable/stolon                      	1.6.5        	0.16.0↳
     	DEPRECATED - Stolon - PostgreSQL cloud native H...
stable/gcloud-sqlproxy             	0.6.1        	1.11↳
       	DEPRECATED Google Cloud SQL Proxy
stable/prometheus-postgres-exporter	1.3.1        	0.8.0↳
      	DEPRECATED A Helm chart for prometheus postgres...</pre>
<p>To deploy the PostgreSQL Chart, run the <code>install</code> command <a data-primary="install command" data-type="indexterm" id="idm45120838794080"/>but change the location of the Helm Chart from a local directory to the full name of the Chart (<code>&lt;repo&gt;/&lt;chart&gt;</code>):</p>
<pre data-code-language="bash" data-type="programlisting"><code>helm</code><code> </code><code>install</code><code> </code><code>my-db</code><code> </code><code class="se">\ </code><a class="co" href="#callout_helm_CO18-1" id="co_helm_CO18-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>--set</code><code> </code><code>postgresql.postgresqlUsername</code><code class="o">=</code><code>my-default,postgresql.↳</code><code>
</code><code class="nv">postgresqlPassword</code><code class="o">=</code><code>postgres,postgresql.postgresqlDatabase</code><code class="o">=</code><code>mydb,↳</code><code>
</code><code>postgresql.persistence.enabled</code><code class="o">=</code><code class="nb">false</code><code> </code><code class="se">\ </code><a class="co" href="#callout_helm_CO18-2" id="co_helm_CO18-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
</code><code>bitnami/postgresql</code><code> </code><a class="co" href="#callout_helm_CO18-3" id="co_helm_CO18-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO18-1" id="callout_helm_CO18-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Sets the name of the deployment</p></dd>
<dt><a class="co" href="#co_helm_CO18-2" id="callout_helm_CO18-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Overrides default values to the ones set in the command line</p></dd>
<dt><a class="co" href="#co_helm_CO18-3" id="callout_helm_CO18-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Sets the PostgreSQL Chart stored in the Bitnami repo</p></dd>
</dl>
<p class="less_space pagebreak-before">And a detailed output is shown in the console:</p>
<pre data-type="programlisting">NAME: my-db
LAST DEPLOYED: Mon Jan 24 22:33:56 2022
NAMESPACE: asotobue-dev
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
CHART NAME: postgresql
CHART VERSION: 10.16.2
APP VERSION: 11.14.0

** Please be patient while the chart is being deployed **

PostgreSQL can be accessed via port 5432 on the following DNS names↳
from within your cluster:

    my-db-postgresql.asotobue-dev.svc.cluster.local - Read/Write connection

To get the((("passwords", "Helm Charts")))((("Helm", "Charts", "passwords")))((("Charts", "passwords"))) password for "postgres" run:

    export POSTGRES_ADMIN_PASSWORD=$(kubectl get secret↳
     --namespace asotobue-dev my-db-postgresql -o↳
     jsonpath="{.data.postgresql-postgres-password}" | base64 --decode)

To get the password for "my-default" run:

    export POSTGRES_PASSWORD=$(kubectl get secret↳
     --namespace asotobue-dev my-db-postgresql -o↳
     jsonpath="{.data.postgresql-password}" | base64 --decode)

To connect to your database run the following command:

    kubectl run my-db-postgresql-client --rm --tty -i --restart='Never'↳
     --namespace asotobue-dev↳
     --image docker.io/bitnami/postgresql:11.14.0-debian-10-r28↳
     --env="PGPASSWORD=$POSTGRES_PASSWORD"↳
     --command -- psql --host my-db-postgresql -U my-default -d mydb↳
     -p 5432



To connect to your ((("Helm", "Charts", "connecting to databases")))((("Charts", "databases", "connecting to")))((("databases", "connecting to", "Helm Charts")))database from outside the cluster execute the following commands:

    kubectl port-forward --namespace asotobue-dev svc/my-db-postgresql 5432:5432 &amp;
    PGPASSWORD="$POSTGRES_PASSWORD" psql --host 127.0.0.1 -U my-default -d mydb -p 5432</pre>
<p>Inspect the installation by listing pods, Services, StatefulSets, or Secrets:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods

NAME                 READY   STATUS    RESTARTS   AGE
my-db-postgresql-0   <code class="m">1</code>/1     Running   <code class="m">0</code>          23s</pre>
<pre data-code-language="bash" data-type="programlisting">kubectl get services

NAME                        TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<code class="o">(</code>S<code class="o">)</code>    AGE
my-db-postgresql            ClusterIP   <code class="m">172</code>.30.35.1   &lt;none&gt;        <code class="m">5432</code>/TCP   3m33s
my-db-postgresql-headless   ClusterIP   None          &lt;none&gt;        <code class="m">5432</code>/TCP   3m33s</pre>
<pre data-code-language="bash" data-type="programlisting">kubectl get statefulset

NAME               READY   AGE
my-db-postgresql   <code class="m">1</code>/1     4m24s</pre>
<pre data-code-language="bash" data-type="programlisting">kubectl get secrets

NAME                          TYPE                                  DATA   AGE
my-db-postgresql              Opaque                                <code class="m">2</code>      5m23s
sh.helm.release.v1.my-db.v1   helm.sh/release.v1                    <code class="m">1</code>      5m24s</pre>
</div></section>
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45120838890816">
<h2>Discussion</h2>
<p>When a third party creates a Chart, there is no direct access to default values or the list of parameters to override.
Helm provides <a data-primary="Helm" data-secondary="Charts" data-tertiary="checking default values" data-type="indexterm" id="idm45120838654352"/><a data-primary="Charts" data-secondary="default values, checking" data-type="indexterm" id="idm45120838684672"/><a data-primary="show command" data-type="indexterm" id="idm45120838683792"/>a <code>show</code> command to check these values:</p>
<pre data-code-language="bash" data-type="programlisting">helm show values bitnami/postgresql</pre>
<p>And shows all the possible <a data-primary="Helm" data-secondary="Charts" data-startref="Helm_Chart_deploy" data-tertiary="deploying" data-type="indexterm" id="idm45120838660080"/><a data-primary="Charts" data-secondary="deploying" data-startref="Chart_deploy" data-type="indexterm" id="idm45120838629472"/><a data-primary="repositories" data-secondary="Helm Charts" data-startref="repo_Chart_deploy" data-tertiary="deploying" data-type="indexterm" id="idm45120838628384"/> <a data-primary="PostgreSQL servers, deploying" data-startref="PostgreSQL_deploy" data-type="indexterm" id="idm45120838657264"/>values:</p>
<pre data-code-language="bash" data-type="programlisting"><code class="c1">## @section Global parameters</code>
<code class="c1">## Global Docker image parameters</code>
<code class="c1">## Please, note that this will override the image parameters, including dependencies</code>
<code class="c1">## configured to use the global value</code>
<code class="c1">## Current available global Docker image parameters: imageRegistry, imagePullSecrets</code>
<code class="c1">## and storageClass</code>
<code class="c1">##</code>

<code class="c1">## @param global.imageRegistry Global Docker image registry</code>
<code class="c1">## @param global.imagePullSecrets Global Docker registry secret names as an array</code>
<code class="c1">## @param global.storageClass Global StorageClass for Persistent Volume(s)</code>
<code class="c1">##</code>
global:
  imageRegistry: <code class="s2">""</code>
  <code class="c1">## E.g.</code>
  <code class="c1">## imagePullSecrets:</code>
  <code class="c1">##   - myRegistryKeySecretName</code>
  <code class="c1">##</code>
  imagePullSecrets: <code class="o">[]</code>
...</pre>
</div></section>
</div></section>
<section data-pdf-bookmark="5.6 Deploying a Chart with a Dependency" data-type="sect1"><div class="sect1" id="recipe_5_6">
<h1>5.6 Deploying a Chart with a Dependency</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120838550048">
<h2>Problem</h2>
<p>You want to deploy<a data-primary="Helm" data-secondary="Charts" data-tertiary="deploying with dependencies" data-type="indexterm" id="Helm_Chart_deploydepend"/><a data-primary="Charts" data-secondary="deploying" data-tertiary="with dependencies" data-type="indexterm" id="Charts_deploy_depend"/><a data-primary="deployment" data-secondary="Charts with dependencies" data-type="indexterm" id="deploy_Chart_depend"/> a Helm Chart that is a dependency of another Chart.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120838568016">
<h2>Solution</h2>
<p>Use the <code>dependencies</code> section <a data-primary="dependencies section (Chart.yaml), registering Charts" data-type="indexterm" id="depsect_Chart_regist"/><a data-primary="Chart.yaml file" data-secondary="dependencies section, registering Charts" data-type="indexterm" id="Chart_depsect_regist"/>in the <em>Chart.yaml</em> file to register other Charts. So far, we’ve seen how to deploy simple services to the cluster, but usually a service might have other dependencies like a database, mail server, distributed cache, etc.</p>
<p>In the previous section, we saw how to deploy a PostgreSQL server in a Kubernetes cluster.
In this section, we’ll see how to deploy a service composed of a Java service returning a list of songs stored in a <a data-primary="Java services, deploying" data-type="indexterm" id="Java_deploy"/>PostgreSQL database. The application is summarized in <a data-type="xref" href="#fig-561">Figure 5-2</a>.</p>
<figure><div class="figure" id="fig-561">
<img alt="Music application overview" height="894" src="assets/gocb_0502.png" width="1432"/>
<h6><span class="label">Figure 5-2. </span>Music application overview</h6>
</div></figure>
<p>Let’s start creating the Chart layout shown in <a data-type="xref" href="#recipe_5_1">Recipe 5.1</a>:</p>
<pre data-code-language="bash" data-type="programlisting">mkdir music
mkdir music/templates

<code class="nb">cd</code> music</pre>
<p>Then create two template files to deploy the music service.</p>
<p>The <em>templates/deployment.yaml</em> file contains the Kubernetes Deployment definition:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">{{</code><code class="nv">- if .Chart.AppVersion</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.AppVersion | quote</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">{{</code><code class="nv">- end</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.replicaCount</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="s">"{{</code><code class="nv"> </code><code class="s">.Values.image.repository</code><code class="nv"> </code><code class="s">}}:↳</code><code class="w"/>
<code class="w">          </code><code class="s">{{</code><code class="nv"> </code><code class="s">.Values.image.tag</code><code class="nv"> </code><code class="s">|</code><code class="nv"> </code><code class="s">default</code><code class="nv"> </code><code class="s">.Chart.AppVersion}}"</code><code class="w"/>
<code class="w">            </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.image.pullPolicy</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">            </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">            </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>
<code class="w">              </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.image.containerPort</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">                </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w"/>
<code class="w">                </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code><code class="w"/>
<code class="w">            </code><code class="nt">env</code><code class="p">:</code><code class="w"/>
<code class="w">              </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">QUARKUS_DATASOURCE_JDBC_URL</code><code class="w"/>
<code class="w">                </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.postgresql.server | ↳</code><code class="w"/>
<code class="w">                </code><code class="nv">default (printf "%s-postgresql" ( .Release.Name )) | quote</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">              </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">QUARKUS_DATASOURCE_USERNAME</code><code class="w"/>
<code class="w">                </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.postgresql.postgresqlUsername | ↳</code><code class="w"/>
<code class="w">                </code><code class="nv">default (printf "postgres" ) | quote</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">              </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">QUARKUS_DATASOURCE_PASSWORD</code><code class="w"/>
<code class="w">                </code><code class="nt">valueFrom</code><code class="p">:</code><code class="w"/>
<code class="w">                  </code><code class="nt">secretKeyRef</code><code class="p">:</code><code class="w"/>
<code class="w">                    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.postgresql.secretName | ↳</code><code class="w"/>
<code class="w">                    </code><code class="nv">default (printf "%s-postgresql" ( .Release.Name )) | quote</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">                    </code><code class="nt">key</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.postgresql.secretKey</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/></pre>
<p>The <em>templates/service.yaml</em> file contains the Kubernetes Service definition:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Service</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w"/>
<code class="w">      </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.image.containerPort</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">      </code><code class="nt">targetPort</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.image.containerPort</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/></pre>
<p>After the creation of the templates, it’s time for the Chart metadata <em>Chart.yaml</em> file.
In this case, we need to define the dependencies of this Chart too.
Since the music service uses a PostgreSQL database, we can add the Chart used in <a data-type="xref" href="#recipe_5_5">Recipe 5.5</a> as a dependency:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v2</code><code class="w">
</code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">music</code><code class="w">
</code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">A</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Helm</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">chart</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">for</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Music</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">service</code><code class="w">

</code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">application</code><code class="w">
</code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.1.0</code><code class="w">
</code><code class="nt">appVersion</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">1.0.0</code><code class="s">"</code><code class="w">

</code><code class="nt">dependencies</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_helm_CO19-1" id="co_helm_CO19-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">postgresql</code><code class="w"> </code><a class="co" href="#callout_helm_CO19-2" id="co_helm_CO19-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">10.16.2</code><code class="w"> </code><a class="co" href="#callout_helm_CO19-3" id="co_helm_CO19-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">repository</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">https://charts.bitnami.com/bitnami</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_helm_CO19-4" id="co_helm_CO19-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO19-1" id="callout_helm_CO19-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Dependencies section</p></dd>
<dt><a class="co" href="#co_helm_CO19-2" id="callout_helm_CO19-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Name of the Chart to add as dependency</p></dd>
<dt><a class="co" href="#co_helm_CO19-3" id="callout_helm_CO19-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Chart version</p></dd>
<dt><a class="co" href="#co_helm_CO19-4" id="callout_helm_CO19-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Repository</p></dd>
</dl>
<p>The final file is <em>Values.yaml</em> with default configuration values.
In this case, a new section is added to configure music deployment with PostgreSQL instance parameters:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">image</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">repository</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/gitops-cookbook/music</code><code class="w">
</code><code class="w">  </code><code class="nt">tag</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">1.0.0</code><code class="s">"</code><code class="w">
</code><code class="w">  </code><code class="nt">pullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Always</code><code class="w">
</code><code class="w">  </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w">

</code><code class="nt">replicaCount</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w">

</code><code class="nt">postgresql</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_helm_CO20-1" id="co_helm_CO20-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">jdbc:postgresql://music-db-postgresql:5432/mydb</code><code class="w">
</code><code class="w">  </code><code class="nt">postgresqlUsername</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">my-default</code><code class="w">
</code><code class="w">  </code><code class="nt">secretName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">music-db-postgresql</code><code class="w">
</code><code class="w">  </code><code class="nt">secretKey</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">postgresql-password</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO20-1" id="callout_helm_CO20-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>PostgreSQL section</p></dd>
</dl>
<p>With the Chart in place, the next thing to do is download the dependency Chart and store it in the <em>charts</em> directory.
This process is automatically done by running the <code>dependency update</code> command:</p>
<pre data-code-language="bash" data-type="programlisting">helm dependency update</pre>
<p>The command output shows that one Chart has been downloaded and saved:</p>
<pre data-type="programlisting">Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "stable" chart repository
...Successfully got an update from the "bitnami" chart repository
Update Complete. ⎈Happy Helming!⎈
Saving 1 charts
Downloading postgresql from repo https://charts.bitnami.com/bitnami
Deleting outdated charts</pre>
<p>The directory layout looks like this:</p>
<pre data-code-language="bash" data-type="programlisting"><code>music</code><code>
</code><code>├──</code><code> </code><code>Chart.lock</code><code>
</code><code>├──</code><code> </code><code>Chart.yaml</code><code>
</code><code>├──</code><code> </code><code>charts</code><code>
</code><code>│</code><code>    </code><code>└──</code><code> </code><code>postgresql-10.16.2.tgz</code><code> </code><a class="co" href="#callout_helm_CO21-1" id="co_helm_CO21-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>├──</code><code> </code><code>templates</code><code>
</code><code>│</code><code>    </code><code>├──</code><code> </code><code>deployment.yaml</code><code>
</code><code>│</code><code>    </code><code>└──</code><code> </code><code>service.yaml</code><code>
</code><code>└──</code><code> </code><code>values.yaml</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO21-1" id="callout_helm_CO21-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>PostgreSQL Chart is placed in the correct directory</p></dd>
</dl>
<p>Finally, we deploy the Chart, setting configuration PostgreSQL deployment values from the command line:</p>
<pre data-code-language="bash" data-type="programlisting">helm install music-db --set postgresql.postgresqlPassword<code class="o">=</code>postgres postgresql.postgresqlDatabase<code class="o">=</code>mydb,postgresql.persistence.enabled<code class="o">=</code><code class="nb">false</code> .</pre>
<p>The installation process shows information about the deployment:</p>
<pre data-code-language="bash" data-type="programlisting">NAME: music-db
LAST DEPLOYED: Tue Jan <code class="m">25</code> <code class="m">17</code>:53:17 <code class="m">2022</code>
NAMESPACE: default
STATUS: deployed
REVISION: <code class="m">1</code>
TEST SUITE: None</pre>
<p>Inspect the installation by listing pods, Services, StatefulSets, or Secrets:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods

NAME                     READY   STATUS    RESTARTS      AGE
music-67dbf986b7-5xkqm   <code class="m">1</code>/1     Running   <code class="m">1</code> <code class="o">(</code>32s ago<code class="o">)</code>   39s
music-db-postgresql-0    <code class="m">1</code>/1     Running   <code class="m">0</code>             39s</pre>
<pre data-code-language="bash" data-type="programlisting">kubectl get statefulset

NAME                  READY   AGE
music-db-postgresql   <code class="m">1</code>/1     53s</pre>
<pre data-code-language="bash" data-type="programlisting">kubectl get services

NAME                         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<code class="o">(</code>S<code class="o">)</code>    AGE
kubernetes                   ClusterIP   <code class="m">10</code>.96.0.1     &lt;none&gt;        <code class="m">443</code>/TCP    40d
music                        ClusterIP   <code class="m">10</code>.104.110.34 &lt;none&gt;        <code class="m">8080</code>/TCP   82s
music-db-postgresql          ClusterIP   <code class="m">10</code>.110.71.13  &lt;none&gt;        <code class="m">5432</code>/TCP   82s
music-db-postgresql-headless ClusterIP   None          &lt;none&gt;        <code class="m">5432</code>/TCP   82s</pre>
<p>We can validate the access to the music service by using port forwarding to the Kubernetes Service.</p>
<p>Open a new terminal window and run the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl port-forward service/music <code class="m">8080</code>:8080

Forwarding from <code class="m">127</code>.0.0.1:8080 -&gt; <code class="m">8080</code>
Forwarding from <code class="o">[</code>::1<code class="o">]</code>:8080 -&gt; <code class="m">8080</code></pre>
<p>The terminal is blocked and it’s normal until you stop the <code>kubectl port-forward</code> process.
Thanks to port forwarding, we can access the music service using the <code>localhost</code> address and port <code>8080</code>.</p>
<p>In another terminal, <code>curl</code> the service:</p>
<pre data-code-language="bash" data-type="programlisting">curl localhost:8080/song</pre>
<p>The<a data-primary="dependencies section (Chart.yaml), registering Charts" data-startref="depsect_Chart_regist" data-type="indexterm" id="idm45120837631232"/><a data-primary="Chart.yaml file" data-secondary="dependencies section, registering Charts" data-startref="Chart_depsect_regist" data-type="indexterm" id="idm45120837637936"/> request is sent to the music service deployed in <a data-primary="Helm" data-secondary="Charts" data-startref="Helm_Chart_deploydepend" data-tertiary="deploying with dependencies" data-type="indexterm" id="idm45120837635056"/><a data-primary="Charts" data-secondary="deploying" data-startref="Charts_deploy_depend" data-tertiary="with dependencies" data-type="indexterm" id="idm45120837633728"/><a data-primary="deployment" data-secondary="Charts with dependencies" data-startref="deploy_Chart_depend" data-type="indexterm" id="idm45120837632272"/><a data-primary="Java services, deploying" data-startref="Java_deploy" data-type="indexterm" id="idm45120837611216"/>Kubernetes and returns a list of songs:</p>
<pre data-code-language="json" data-type="programlisting"><code class="p">[</code><code class="w"/>
<code class="w">  </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nt">"id"</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"artist"</code><code class="p">:</code><code class="w"> </code><code class="s2">"DT"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Quiero Munchies"</code><code class="w"/>
<code class="w">  </code><code class="p">},</code><code class="w"/>
<code class="w">  </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nt">"id"</code><code class="p">:</code><code class="w"> </code><code class="mi">2</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"artist"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Lin-Manuel Miranda"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"We Don't Talk About Bruno"</code><code class="w"/>
<code class="w">  </code><code class="p">},</code><code class="w"/>
<code class="w">  </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nt">"id"</code><code class="p">:</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"artist"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Imagination"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Just An Illusion"</code><code class="w"/>
<code class="w">  </code><code class="p">},</code><code class="w"/>
<code class="w">  </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nt">"id"</code><code class="p">:</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"artist"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Txarango"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Tanca Els Ulls"</code><code class="w"/>
<code class="w">  </code><code class="p">},</code><code class="w"/>
<code class="w">  </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nt">"id"</code><code class="p">:</code><code class="w"> </code><code class="mi">5</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"artist"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Halsey"</code><code class="p">,</code><code class="w"/>
<code class="w">    </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Could Have Been Me"</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">]</code><code class="w"/></pre>
</div></section>
</div></section>
<section data-pdf-bookmark="5.7 Triggering a Rolling Update Automatically" data-type="sect1"><div class="sect1" id="recipe_5_7">
<h1>5.7 Triggering a Rolling Update Automatically</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120837607456">
<h2>Problem</h2>
<p>You want to trigger a rolling <a data-primary="deployment" data-secondary="rolling updates, triggering automatically" data-type="indexterm" id="deployment_updat_auto"/>update of deployment when a <code>ConfigMap</code> object is changed.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120837525216">
<h2>Solution</h2>
<p>Use the <code>sha256sum</code> template function <a data-primary="sha256sum template function" data-type="indexterm" id="idm45120837522176"/>to generate a change on the deployment file.</p>
<p>In <a data-type="xref" href="ch04.xhtml#recipe_4_5">Recipe 4.5</a>, we saw that Kustomize has a <code>ConfigMapGenerator</code> that automatically appends a hash to the <code>ConfigMap</code> metadata name and modifies the deployment file with the new hash when used.
Any change on the <code>ConfigMap</code> triggers a rolling update of the deployment.</p>
<p>Helm doesn’t provide a direct way like Kustomize does to update a deployment file when the <code>ConfigMap</code> changes, but there is a template function to calculate a SHA-256 hash of any file and embed the result in the template.</p>
<p>Suppose we’ve got a Node.js application that returns a greeting message.
An environment variable configures this greeting message, and in the Kubernetes Deployment, this variable is injected from a Kubernetes <code>ConfigMap</code>.</p>
<p><a data-type="xref" href="#fig-571">Figure 5-3</a> shows an overview of the application.</p>
<figure><div class="figure" id="fig-571">
<img alt="Greetings application overview" height="354" src="assets/gocb_0503.png" width="1432"/>
<h6><span class="label">Figure 5-3. </span>Greetings application overview</h6>
</div></figure>
<p>Let’s create the Helm Chart for the Greetings application; note that we’re not covering the entire process of creating a Chart, but just the essential parts.
You can refer to <a data-type="xref" href="#recipe_5_1">Recipe 5.1</a> to get started.</p>
<p>Create a deployment template that injects a <code>ConfigMap</code> as an environment variable. The following listing shows the file:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="nv">-</code><code class="nv"> </code><code class="nv">if</code><code class="nv"> </code><code class="nv">.Chart.AppVersion</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.AppVersion</code><code class="nv"> </code><code class="nv">|</code><code class="nv"> </code><code class="nv">quote</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="nv">-</code><code class="nv"> </code><code class="nv">end</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Values.replicaCount</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">          </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">{{</code><code class="nv"> </code><code class="s">.Values.image.repository</code><code class="nv"> </code><code class="s">}}:↳</code><code class="w">
</code><code class="w">          </code><code class="s">{{</code><code class="nv"> </code><code class="s">.Values.image.tag</code><code class="nv"> </code><code class="s">|</code><code class="nv"> </code><code class="s">default</code><code class="nv"> </code><code class="s">.Chart.AppVersion}}</code><code class="s">"</code><code class="w">
</code><code class="w">            </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Values.image.pullPolicy</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">            </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">            </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">              </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Values.image.containerPort</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">                </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w">
</code><code class="w">                </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code><code class="w">
</code><code class="w">            </code><code class="nt">env</code><code class="p">:</code><code class="w">
</code><code class="w">              </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GREETING</code><code class="w">
</code><code class="w">                </code><code class="nt">valueFrom</code><code class="p">:</code><code class="w">
</code><code class="w">                  </code><code class="nt">configMapKeyRef</code><code class="p">:</code><code class="w">
</code><code class="w">                    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Values.configmap.name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO22-1" id="co_helm_CO22-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">                    </code><code class="nt">key</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">greeting</code><code class="w"> </code><a class="co" href="#callout_helm_CO22-2" id="co_helm_CO22-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO22-1" id="callout_helm_CO22-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p><code>ConfigMap</code> name</p></dd>
<dt><a class="co" href="#co_helm_CO22-2" id="callout_helm_CO22-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Property key of the <code>ConfigMap</code></p></dd>
</dl>
<p>The initial <code>ConfigMap</code> file is shown in the following listing:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ConfigMap</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">greeting-config</code><code class="w"> </code><a class="co" href="#callout_helm_CO23-1" id="co_helm_CO23-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="nt">data</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">greeting</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Aloha</code><code class="w"> </code><a class="co" href="#callout_helm_CO23-2" id="co_helm_CO23-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO23-1" id="callout_helm_CO23-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Sets <code>ConfigMap</code> name</p></dd>
<dt><a class="co" href="#co_helm_CO23-2" id="callout_helm_CO23-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Key/value</p></dd>
</dl>
<p>Create a Kubernetes Service template to access the service:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Service</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">http</code><code class="w"/>
<code class="w">      </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.image.containerPort</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">      </code><code class="nt">targetPort</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Values.image.containerPort</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="w"> </code><code class="p-Indicator">}}</code><code class="w"/></pre>
<p>Update the <em>values.yaml</em> file with the template <code>configmap</code> parameters:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">image</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">repository</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/gitops-cookbook/greetings</code><code class="w">
</code><code class="w">  </code><code class="nt">tag</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">1.0.0</code><code class="s">"</code><code class="w">
</code><code class="w">  </code><code class="nt">pullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Always</code><code class="w">
</code><code class="w">  </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w">

</code><code class="nt">replicaCount</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w">

</code><code class="nt">configmap</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">greeting-config</code><code class="w"> </code><a class="co" href="#callout_helm_CO24-1" id="co_helm_CO24-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO24-1" id="callout_helm_CO24-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Refers to <code>ConfigMap</code> name</p></dd>
</dl>
<p>Finally, install the Chart using the <code>install</code> command:</p>
<pre data-code-language="bash" data-type="programlisting">helm install greetings .</pre>
<p>When the Chart is deployed, use the <code>kubectl port-forward</code> command in one terminal to get access to the service:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl port-forward service/greetings <code class="m">8080</code>:8080</pre>
<p>And <code>curl</code> the service in another terminal window:</p>
<pre data-code-language="bash" data-type="programlisting"><code>curl</code><code> </code><code>localhost:8080</code><code>
</code><code>Aloha</code><code> </code><code>Ada</code><code> </code><a class="co" href="#callout_helm_CO25-1" id="co_helm_CO25-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO25-1" id="callout_helm_CO25-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Configured greeting is used</p></dd>
</dl>
<p>Now, let’s update the <code>ConfigMap</code> file to a new greeting message:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ConfigMap</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">greeting-config</code><code class="w">
</code><code class="nt">data</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">greeting</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Hola</code><code class="w"> </code><a class="co" href="#callout_helm_CO26-1" id="co_helm_CO26-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO26-1" id="callout_helm_CO26-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>New greeting message</p></dd>
</dl>
<p>Update the <code>appVersion</code> field from the <em>Chart.yaml</em> file to <code>1.0.1</code> and upgrade the Chart by running the following command:</p>
<pre data-code-language="bash" data-type="programlisting">helm upgrade greetings .</pre>
<p>Restart the <code>kubectl port-forward</code> process and <code>curl</code> the service again:</p>
<pre data-code-language="bash" data-type="programlisting"><code>curl</code><code> </code><code>localhost:8080</code><code>
</code><code>Aloha</code><code> </code><code>Alexandra</code><code> </code><a class="co" href="#callout_helm_CO27-1" id="co_helm_CO27-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO27-1" id="callout_helm_CO27-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Greeting message isn’t updated</p></dd>
</dl>
<p>The <code>ConfigMap</code> object is updated during the upgrade, but since there are no changes in the <code>Deployment</code> object, there is no restart of the pod; hence the environment variable is not set to the new value.
Listing the pods shows no execution of the rolling update:</p>
<pre data-code-language="bash" data-type="programlisting"><code>kubectl</code><code> </code><code>get</code><code> </code><code>pods</code><code>

</code><code>NAME</code><code>                         </code><code>READY</code><code>   </code><code>STATUS</code><code>    </code><code>RESTARTS</code><code>   </code><code>AGE</code><code>
</code><code>greetings-64ddfcb649-m5pml</code><code>   </code><code class="m">1</code><code>/1</code><code>     </code><code>Running</code><code>   </code><code class="m">0</code><code>          </code><code>2m21s</code><code> </code><a class="co" href="#callout_helm_CO28-1" id="co_helm_CO28-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO28-1" id="callout_helm_CO28-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Age value shows no rolling update</p></dd>
</dl>
<p><a data-type="xref" href="#fig-572">Figure 5-4</a> summarizes the change.</p>
<figure><div class="figure" id="fig-572">
<img alt="Greetings application with new configuration value" height="354" src="assets/gocb_0504.png" width="1432"/>
<h6><span class="label">Figure 5-4. </span>Greetings application with new configuration value</h6>
</div></figure>
<p>Let’s use the <code>sha256sum</code> function to <a data-primary="sha256sum template function" data-type="indexterm" id="sha256sum"/>calculate an SHA-256 value of the <em>configmap.yaml</em> file content and set it as a pod annotation, which effectively triggers a rolling update as the pod definition has changed:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Values.replicaCount</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app.kubernetes.io/name</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">.Chart.Name</code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">      </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">checksum/config</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">{</code><code class="w"> </code><code class="nv">include</code><code class="nv"> </code><code class="nv">(print</code><code class="nv"> </code><code class="nv">$.Template.BasePath</code><code class="nv"> </code><code class="nv">"/configmap.yaml")↳</code><code class="w">
</code><code class="w">         </code><code class="nv">.</code><code class="nv"> </code><code class="nv">|</code><code class="nv"> </code><code class="nv">sha256sum</code><code class="w"> </code><code class="p-Indicator">}</code><code class="p-Indicator">}</code><code class="w"> </code><a class="co" href="#callout_helm_CO29-1" id="co_helm_CO29-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO29-1" id="callout_helm_CO29-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Includes the <em>configmap.yaml</em> file, calculates the SHA-256 value, and sets it as an annotation</p></dd>
</dl>
<p>Update the <code>ConfigMap</code> again with a new value:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ConfigMap</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">greeting-config</code><code class="w">
</code><code class="nt">data</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">greeting</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Namaste</code><code class="w"> </code><a class="co" href="#callout_helm_CO30-1" id="co_helm_CO30-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO30-1" id="callout_helm_CO30-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>New greeting message</p></dd>
</dl>
<p>Update the <code>appVersion</code> field from <em>Chart.yaml</em> to <code>1.0.1</code> and upgrade the Chart by running the following command:</p>
<pre data-code-language="bash" data-type="programlisting">helm upgrade greetings .</pre>
<p>Restart the <code>kubectl port-forward</code> process and <code>curl</code> the service again:</p>
<pre data-code-language="bash" data-type="programlisting"><code>curl</code><code> </code><code>localhost:8080</code><code>
</code><code>Namaste</code><code> </code><code>Alexandra</code><code> </code><a class="co" href="#callout_helm_CO31-1" id="co_helm_CO31-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO31-1" id="callout_helm_CO31-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Greeting message is the new one</p></dd>
</dl>
<p>List the pods deployed in the cluster again, and you’ll notice that a rolling update is happening:</p>
<pre data-code-language="bash" data-type="programlisting"><code>kubectl</code><code> </code><code>get</code><code> </code><code>pods</code><code>

</code><code>NAME</code><code>                         </code><code>READY</code><code>   </code><code>STATUS</code><code>              </code><code>RESTARTS</code><code>   </code><code>AGE</code><code>
</code><code>greetings-5c6b86dbbd-2p9bd</code><code>   </code><code class="m">0</code><code>/1</code><code>     </code><code>ContainerCreating</code><code>   </code><code class="m">0</code><code>          </code><code>3s</code><code> </code><a class="co" href="#callout_helm_CO32-1" id="co_helm_CO32-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
</code><code>greetings-64ddfcb649-m5pml</code><code>   </code><code class="m">1</code><code>/1</code><code>     </code><code>Running</code><code>             </code><code class="m">0</code><code>          </code><code>2m21s</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO32-1" id="callout_helm_CO32-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>A rolling update is happening</p></dd>
</dl>
<p>Describe the pod to validate that the annotation with the SHA-256 value is present:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl describe pod greetings-5c6b86dbbd-s4n7b</pre>
<p>The <a data-primary="deployment" data-secondary="rolling updates, triggering automatically" data-startref="deployment_updat_auto" data-type="indexterm" id="idm45120836364800"/>output shows all pod parameters.
The important one is the <code>annotations</code> placed at the top of the output showing the <code>checksum/config</code> annotation containing the calculated SHA-256 value:</p>
<pre data-code-language="bash" data-type="programlisting"><code>Name:</code><code>                 </code><code>greetings-5c6b86dbbd-s4n7b</code><code>
</code><code>Namespace:</code><code>            </code><code>asotobue-dev</code><code>
</code><code>Priority:</code><code>             </code><code>-3</code><code>
</code><code>Priority</code><code> </code><code>Class</code><code> </code><code>Name:</code><code>  </code><code>sandbox-users-pods</code><code>
</code><code>Node:</code><code>                 </code><code>ip-10-0-186-34.ec2.internal/10.0.186.34</code><code>
</code><code>Start</code><code> </code><code>Time:</code><code>           </code><code>Thu,</code><code> </code><code class="m">27</code><code> </code><code>Jan</code><code> </code><code class="m">2022</code><code> </code><code class="m">11</code><code>:55:02</code><code> </code><code>+0100</code><code>
</code><code>Labels:</code><code>               </code><code>app.kubernetes.io/name</code><code class="o">=</code><code>greetings</code><code>
                      </code><code>pod-template-hash</code><code class="o">=</code><code>5c6b86dbbd</code><code>
</code><code>Annotations:</code><code>          </code><code>checksum/config:↳</code><code>
</code><code>59e9100616a11d65b691a914cd429dc6011a34e02465173f5f53584b4aa7cba8</code><code> </code><a class="co" href="#callout_helm_CO33-1" id="co_helm_CO33-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_helm_CO33-1" id="callout_helm_CO33-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Calculated value</p></dd>
</dl>
<p><a data-type="xref" href="#fig-573">Figure 5-5</a> summarizes <a data-primary="sha256sum template function" data-startref="sha256sum" data-type="indexterm" id="idm45120836287728"/>the elements that changed when the application was updated.</p>
<figure><div class="figure" id="fig-573">
<img alt="Final overview of the Greetings application" height="354" src="assets/gocb_0505.png" width="1432"/>
<h6><span class="label">Figure 5-5. </span>Final overview of the Greetings application</h6>
</div></figure>
</div></section>
</div></section>
<section data-pdf-bookmark="5.8 Final Thoughts" data-type="sect1"><div class="sect1" id="idm45120837523472">
<h1>5.8 Final Thoughts</h1>
<p>In the previous chapter, we saw Kustomize; in this chapter, we’ve seen another tool to help deploy Kubernetes applications.</p>
<p>When you need to choose between Kustomize or Helm, you might have questions on which one to use.</p>
<p>In our experience, the best way to proceed is with Kustomize for simple projects, where only simple changes might be required between new deployments.</p>
<p>If the project is complex with external dependencies, and several deployment parameters, then Helm is a better option.</p>
</div></section>
</div></section></div></body></html>