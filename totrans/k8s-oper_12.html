<html><head></head><body><section data-pdf-bookmark="Appendix B. Custom Resource Validation" data-type="appendix" epub:type="appendix"><div class="appendix" id="appendix_crd_validation">&#13;
<h1><span class="label">Appendix B. </span>Custom Resource Validation</h1>&#13;
&#13;
&#13;
<p>When adding a new API, the Operator SDK generates a skeleton custom resource definition.<a data-primary="validation of custom resources" data-type="indexterm" id="ix_valCR"/><a data-primary="custom resources (CRs)" data-secondary="validation of" data-type="indexterm" id="ix_CRval"/> This skeleton is usable as is; no further changes or additions need to be made to create custom resources.</p>&#13;
&#13;
<p>The skeleton CRD achieves this flexibility by simply defining the <code>spec</code> and <span class="keep-together"><code>status</code></span> sections, representing the user input and custom resource state, respectively, as open-ended objects:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">spec</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
<code class="nt">status</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code></pre>&#13;
&#13;
<p>The drawback to this approach is that Kubernetes isn’t able to validate any of the data in either of these fields. Since Kubernetes doesn’t know what values should or should not be allowed, as long as the manifest parses, the values are allowed.</p>&#13;
&#13;
<p>To solve this problem, CRDs include support for the <a href="https://oreil.ly/bzRIu">OpenAPI Specification</a> to describe the validation constraints of each of its fields. You’ll need to manually add this validation to the CRD to describe the allowed values for both the <code>spec</code> and <span class="keep-together"><code>status</code></span> sections.</p>&#13;
&#13;
<p>You’ll make two primary changes to the <code>spec</code> section of the CRD:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Add a <code>properties</code> map. For each of the attributes that may be specified for custom resources of this type, add an entry to this map along with information on the parameter’s type and allowed values.</p>&#13;
</li>&#13;
<li>&#13;
<p>Optionally, you can add a <code>required</code> field listing the properties whose presence Kubernetes should enforce. Add the name of each required property as an entry in this list. If you omit any of these properties during resource creation, Kubernetes will reject the resource.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>You can also flesh out the <code>status</code> section with property information following the same conventions as for <code>spec</code>; however, there is no need to add a <code>required</code> field.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>In both cases, the existing line <code>type: object</code> remains; you insert the new additions at the same level as this “type” declaration.</p>&#13;
</div>&#13;
&#13;
<p>You can find both the <code>spec</code> and <code>status</code> fields in the following section of the CRD:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="l-Scalar-Plain">spec -&gt; validation -&gt; openAPIV3Schema -&gt; properties</code></pre>&#13;
&#13;
<p>As an example, the additions to the VisitorsApp CRD are as follows:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">spec</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
    <code class="nt">properties</code><code class="p">:</code>&#13;
        <code class="nt">size</code><code class="p">:</code>&#13;
            <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">integer</code>&#13;
        <code class="nt">title</code><code class="p">:</code>&#13;
            <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
    <code class="nt">required</code><code class="p">:</code>&#13;
    <code class="p-Indicator">-</code> <code class="l-Scalar-Plain">size</code>&#13;
<code class="nt">status</code><code class="p">:</code>&#13;
    <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">object</code>&#13;
    <code class="nt">properties</code><code class="p">:</code>&#13;
        <code class="nt">backendImage</code><code class="p">:</code>&#13;
            <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code>&#13;
        <code class="nt">frontendImage</code><code class="p">:</code>&#13;
            <code class="nt">type</code><code class="p">:</code> <code class="l-Scalar-Plain">string</code></pre>&#13;
&#13;
<p>This snippet is only an example of what you can accomplish using OpenAPI validation.<a data-primary="validation of custom resources" data-startref="ix_valCR" data-type="indexterm" id="idm45261327670488"/><a data-primary="custom resources (CRs)" data-secondary="validation of" data-startref="ix_CRval" data-type="indexterm" id="idm45261327653176"/> You can find detailed information on creating custom resource definitions in <a href="https://oreil.ly/FfkJe">the Kubernetes documentation</a>.</p>&#13;
</div></section></body></html>