<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 4. First Steps in the Cloud"><div class="chapter" id="first_steps_in_the_cloud">
<h1><span class="label">Chapter 4. </span>First Steps in the Cloud</h1>

<p>In the previous two chapters, we took you through the essentials of genomics and computing technology. <a contenteditable="false" data-primary="cloud computing" data-secondary="getting started" data-type="indexterm" id="ix_cldstrt"/>Our goal was to make sure you have enough of a grounding in both domains regardless of whether you’re coming to this more from one side or the other—or perhaps even from another domain altogether; if so, welcome! And hang in there.</p>

<p>We realize that those first two chapters might have felt very passive since there were no hands-on exercises involved. So here’s the good news: you’re finally going to get to do some hands-on work. This chapter is all about getting you oriented and comfortable with the GCP services that we use throughout this book. First, we walk you through creating a GCP account and running simple commands in Google Cloud Shell. After that, we show you how to set up your own VM in the cloud, get Docker running on it, and set up the environment that you’ll use in <a data-type="xref" href="ch05.xhtml#first_steps_with_gatk">Chapter 5</a> to run GATK analyses. Finally, we show you how to configure the IGV to access data in Google Cloud Storage. After you have all that set up, you’ll be ready to do some actual genomics.</p>

<section data-type="sect1" data-pdf-bookmark="Setting Up Your Google Cloud Account and First Project"><div class="sect1" id="setting_up_your_google_cloud_account_an">
<h1>Setting Up Your Google Cloud Account and First Project</h1>

<p>You can sign up for an account on GCP by navigating to <a href="https://cloud.google.com"><em>https://cloud.google.com</em></a> and following the prompts. We are purposely light on the details here because the interface for account setup has been known to change. At a high level, though, your goals are to establish a new Google Cloud account, set up a billing account, accept the free trial credits (if you’re eligible), and create a new project that links to your billing account.</p>

<p><a contenteditable="false" data-primary="Google Cloud Platform (GCP)" data-secondary="setting up account and creating a project" data-type="indexterm" id="ix_GCPstrt"/><a contenteditable="false" data-primary="cloud computing" data-secondary="getting started" data-tertiary="setting up Google Cloud account and first project" data-type="indexterm" id="ix_cldstrtGCpr"/>If you don’t already have a Google identity of some kind, you can create one with your regular email account; you don’t need to use a Gmail account. Keep in mind also that if your institution uses G Suite, your work email might already be associated with a Google identity even if the domain name is not <em>gmail.com</em>.</p>

<p>After you’ve signed up, make your way to the <a href="https://oreil.ly/T4nVl">GCP console</a>, which provides a web-based graphical interface for managing cloud resources.<a contenteditable="false" data-primary="GCP console" data-seealso="Google Cloud Platform" data-type="indexterm" id="idm45625634473272"/> You can access most of the functionality offered in the console through a pure command-line interface. In the course of the book, we show you how to do some things through the web interface and some through the command line, depending on what we believe is most convenient and/or typical.</p>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="understanding_the_gcp_free_tier_program">
<h5>Understanding the GCP Free Tier Program</h5>

<p>GCP currently offers a <a href="https://oreil.ly/REJoI">free trial with $300 credit</a> spendable over the first 12 months of your account, plus additional services that are <a contenteditable="false" data-primary="Google Cloud Platform (GCP)" data-secondary="Free Tier program" data-type="indexterm" id="idm45625634468984"/>advertised as “Always Free.” We take advantage of some of these free services, such as the Google Cloud Shell, in the course of this chapter, but we also use some services that cost money, so we recommend that you take advantage of the free trial program if you can. Based on our testing, the free trial should be sufficient to work through all of the book examples without having to pay anything.</p>

<p>You’ll notice that even the free trial account requires that you provide billing information, which can be either a credit card or a bank account (which can take a few days to clear). <a href="https://oreil.ly/A9jCr">The GCP website</a> states that this is necessary to limit abuse by robots and make sure only real people are creating free trial accounts. It also states that Google will not charge anything to your account automatically when the free trial ends. According to the program documentation, you will have the opportunity to upgrade your account by expressly allowing GCP to charge your account, but if you do not do so, your account will automatically be downgraded to access only the free services.</p>
</div></aside>

<section data-type="sect2" data-pdf-bookmark="Creating a Project"><div class="sect2" id="creating_a_project">
<h2>Creating a Project</h2>

<p>Let’s begin by creating your first project, which is necessary to organize your work, set up billing, and gain access to GCP services. In the console, go to the <a href="https://oreil.ly/2oA64">“Manage resources”</a> page and then, at the top of the page, select Create Project. As shown in <a data-type="xref" href="#creating_a_new_projectdot">Figure 4-1</a>, you need to give your project a name, which must be unique within the entire GCP. You can also select an organization if your Google identity is associated with one (which is usually the case if you have an institutional/work G Suite account), but if you just created your account, this might not be applicable to you at the moment. Having an organization selected means new projects will be associated with that organization by default, which allows for central management of projects. For the purposes of these instructions, we assume that you’re setting up your account for the first time and there isn’t a preexisting organization linked to it.</p>

<figure class="no-frame"><div id="creating_a_new_projectdot" class="figure"><img alt="Creating a new project." src="Images/gitc_0401.png" width="569" height="458"/>
<h6><span class="label">Figure 4-1. </span>Creating a new project.</h6>
</div></figure>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Checking Your Billing Account and Activating Free Credits"><div class="sect2" id="checking_your_billing_account_and_activ">
<h2>Checking Your Billing Account and Activating Free Credits</h2>

<p>If you followed the sign-up process outlined in the previous section and activated your free trial, the system will have set up billing information for you as part of the overall account creation process.<a contenteditable="false" data-primary="Google Cloud Platform (GCP)" data-secondary="setting up account and creating a project" data-tertiary="checking billing account and activating free credits" data-type="indexterm" id="idm45625634456328"/> You can check<a contenteditable="false" data-primary="GCP console" data-secondary="Billing section" data-type="indexterm" id="idm45625634454472"/> your billing information in the <a href="https://oreil.ly/X8G6K">Billing section of the console</a>, which you can also access at any time from the sidebar menu.</p>

<p>If you’re eligible for the free credits program, one of the panels on the billing overview page will summarize the number of credits and days you have left to spend them. Note that if yours is displaying a blue Upgrade button, as shown in <a data-type="xref" href="#the_panel_in_the_billing_console_summar">Figure 4-2</a>, your trial has not yet started and you need to activate it in order to take advantage of the program. You might also see a “Free trial status” banner at the top of your browser window with a blue Activate button. Someone at GCP is working really hard to not let you walk away from free money, so click either of those buttons to start the process and receive your free credits.</p>

<figure class="width-40 no-frame"><div id="the_panel_in_the_billing_console_summar" class="figure"><img alt="The panel in the Billing console summarizing free trial credits availability." src="Images/gitc_0402.png" width="600" height="982"/>
<h6><span class="label">Figure 4-2. </span>The panel in the Billing console summarizing free trial credits availability.</h6>
</div></figure>

<p>More generally, the billing overview page provides summaries of how much money (or credits) you have spent so far as well as some basic forecasting. That being said, it’s important to understand that the system does not show you costs in real time: there is some lag time between the moments when you use chargeable resources and when the costs are updated on your billing page.</p>

<p>Many people who make the move to the cloud report that keeping track of their spending is one of the most difficult parts of the process. <a contenteditable="false" data-primary="costs" data-secondary="tracking spending in GCP" data-type="indexterm" id="idm45625634446616"/>It’s also the one that causes them the most anxiety because it can be very easy to spend large sums of money pretty quickly in the cloud if you’re not careful. <a contenteditable="false" data-primary="Budgets and alerts settings in GCP" data-type="indexterm" id="idm45625634444824"/>One feature offered by GCP that we find particularly useful in this respect is the “Budgets &amp; alerts” settings, as depicted in <a data-type="xref" href="#budget_and_alert_threshold_administrati">Figure 4-3</a>. This allows you to set email alerts that will notify you (or whoever is the billing administrator on your account) when you exceed certain spending thresholds. To be clear, this won’t stop anything from running or prevent you from starting any new work that would push you over the threshold, but at least it will let you know where you stand.</p>

<figure class="no-frame"><div id="budget_and_alert_threshold_administrati" class="figure"><img alt="Budget and alert threshold administration" src="Images/gitc_0403.png" width="1442" height="1567"/>
<h6><span class="label">Figure 4-3. </span>Budget and alert threshold administration.</h6>
</div></figure>

<p>To access the billing notifications feature,<a contenteditable="false" data-primary="GCP console" data-secondary="billing notifications feature" data-type="indexterm" id="idm45625634439368"/> on the main menu on the GCP console, choose Billing, select the billing account you just created, and then look for the Budgets and alerts option. After you select it, you will be able to set up a new budget using the Create budget form shown in <a data-type="xref" href="#budget_and_alert_threshold_administrati">Figure 4-3</a>. You can create multiple budgets and set multiple triggers for different percentages of the budget if you want warnings as you approach your budget amount. But as we just mentioned, keep in mind that it is still only a notification service and will not prevent you from incurring additional charges.<a contenteditable="false" data-primary="Google Cloud Platform (GCP)" data-secondary="setting up account and creating a project" data-startref="ix_GCPstrt" data-type="indexterm" id="idm45625634436216"/><a contenteditable="false" data-primary="cloud computing" data-secondary="gettng started" data-startref="ix_cldstrtGCpr" data-tertiary="setting up Google Cloud account and first project" data-type="indexterm" id="idm45625634434488"/></p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Running Basic Commands in Google Cloud Shell"><div class="sect1" id="running_basic_commands_in_google_cloud">
<h1>Running Basic Commands in Google Cloud Shell</h1>

<p>Now that you’ve established your account, set up billing, and created your project, the next step is to log in to your first VM.<a contenteditable="false" data-primary="cloud computing" data-secondary="getting started" data-tertiary="running basic commands in Google Cloud Shell" data-type="indexterm" id="ix_cldstrtcmd"/><a contenteditable="false" data-primary="Google Cloud Shell" data-type="indexterm" id="ix_GCS"/> For our exercises here, we use Google Cloud Shell, which does not require any configuration to get started and is completely free, although it comes with a few important limitations that we discuss in a moment.</p>

<section data-type="sect2" data-pdf-bookmark="Logging in to the Cloud Shell VM"><div class="sect2" id="logging_in_to_the_cloud_shell_vm">
<h2>Logging in to the Cloud Shell VM</h2>

<p>To create a secure connection<a contenteditable="false" data-primary="Google Cloud Shell" data-secondary="logging in to Cloud Shell VM" data-type="indexterm" id="idm45625634424696"/> to a Cloud Shell VM<a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="logging into Google Cloud Shell VM" data-type="indexterm" id="idm45625634423128"/> using the SSH protocol, in the upper-right corner of the console, click the terminal icon:</p>

<figure class="width-10 no-frame"><div id="the_terminal_icon_to_open_cloud_shelldo" class="figure"><img alt="The terminal icon to open Cloud Shell." src="Images/gitc_04in01.png" width="102" height="102"/></div></figure>

<p>This launches a new panel in the bottom on the console; if you want, you can also pop the terminal out to its own window. This gives you shell access to your own Debian-based Linux VM provisioned with modest resources, including 5 GB of free storage (mounted at <em>$HOME</em>) on a persistent disk. Some basic packages are preinstalled and ready to go, including the Google Cloud SDK (aka <code>gcloud</code>), which provides a rich set of command-line-based tools for interacting with GCP services.<a contenteditable="false" data-primary="gcloud (Google Cloud SDK)" data-type="indexterm" id="idm45625634418168"/> We’ll use it in a few minutes to try out some basic data management commands. In the meantime, feel free to explore this Debian VM, look around, and see what tools are installed.</p>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Be aware that weekly usage quotas limit how much time you can spend running the Cloud Shell; as of this writing, it’s 50 hours per week. In addition, if you don’t use it regularly (within 120 days, as of this writing), the contents of the disk that provides you with free storage might end up being deleted.</p>
</div>

<p>When you log in to Cloud Shell for the first time, it prompts you to specify <a contenteditable="false" data-primary="Project ID (on GCP)" data-type="indexterm" id="idm45625634414856"/>a Project ID using the<a contenteditable="false" data-primary="gcloud (Google Cloud SDK)" data-secondary="specifying Project ID" data-type="indexterm" id="idm45625634413528"/> aforementioned <code>gcloud</code> utility:</p>

<pre data-type="programlisting">
Welcome to Cloud Shell! Type "help" to get started.
To set your Cloud Platform project in this session use “gcloud config set project
[PROJECT_ID]”</pre>

<p>You can find your Project ID on the Home page of the console, as shown in <a data-type="xref" href="#location_of_the_project_id_in_the_gcp_c">Figure 4-4</a>.</p>

<figure class="width-75 no-frame"><div id="location_of_the_project_id_in_the_gcp_c" class="figure"><img alt="Location of the Project ID in the GCP console." src="Images/gitc_0404.png" width="1224" height="866"/>
<h6><span class="label">Figure 4-4. </span>Location of the Project ID in the GCP console.</h6>
</div></figure>

<p>When you have your Project ID, run the following command in the Cloud Shell, substituting your own Project ID for the one shown here:</p>

<pre data-type="programlisting">
genomics_book@cloudshell:~$ gcloud config set project ferrous-layout-260200
Updated property [core/project].
genomics_book@cloudshell:~ (ferrous-layout-260200)$</pre>

<p>Notice that your command prompt now includes your Project ID. It is quite long, so going forward, we’ll <a contenteditable="false" data-primary="$ (dollar sign)" data-secondary="VM prompt ending in" data-type="indexterm" id="idm45625634405032"/>show only the last character in the prompt—in this case, the dollar sign ($)—when we demonstrate running commands. <a contenteditable="false" data-primary="ls command (gcloud)" data-type="indexterm" id="idm45625634403400"/>For example, if we list the contents of the working directory using the <code>ls</code> command, it will look like this:</p>

<pre data-type="programlisting">
$ ls
README-cloudshell.txt</pre>

<p>And, hey, there’s already something here: a <em>README</em> file, which, as the name indicates, really wants you to read it. <a contenteditable="false" data-primary="cat command (gcloud)" data-type="indexterm" id="idm45625634400024"/>You can do so by running the <code>cat</code> command:</p>

<pre data-type="programlisting">
$ cat README-cloudshell.txt</pre>

<p>This displays a welcome message that summarizes some usage instructions and recommendations for getting help. And with that, you’re ready to use Cloud Shell to begin interacting with basic GCP services. Let’s get cracking!</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Using gsutil to Access and Manage Files"><div class="sect2" id="using_gsutil_to_access_and_manage_files">
<h2>Using gsutil to Access and Manage Files</h2>

<p>Now that we have access to this extremely simple-to-launch and free (if fairly limited) VM, let’s use it <a contenteditable="false" data-primary="Google Cloud Shell" data-secondary="using gsutil to access and manage files" data-type="indexterm" id="ix_GCSgsutil"/>to see whether we can access the bundle of example data provided with this book. <a contenteditable="false" data-primary="gsutil" data-secondary="using to access and manage files" data-type="indexterm" id="ix_gsutil"/>The data bundle resides in Google Cloud Storage (GCS), which is a form of <em>object store</em> (i.e., it’s used for storing files) with units of storage called <em>buckets</em>. You can view the contents of GCS buckets and perform basic management tasks on them via the web through the <a href="https://oreil.ly/sqrkr">storage browser section</a> of the GCP console, but the interface is fairly limited. <a contenteditable="false" data-primary="Google Storage Utilities" data-see="gsutil" data-type="indexterm" id="idm45625634388856"/>The more powerful approach is to use the <code>gcloud</code> tool, <span class="keep-together"><code>gsutil</code></span> (Google Storage Utilities), from the command line. You can access buckets through their GCS path, which is just their name prefixed with <em>gs://</em>.</p>

<p>As an example, the path for the public storage bucket for this book is <em>gs://genomics-in-the-cloud</em>. You can list the contents of the bucket by typing the following command in your cloud shell:</p>

<pre data-type="programlisting">
$ gsutil ls gs://genomics-in-the-cloud
gs://genomics-in-the-cloud/hello.txt
gs://genomics-in-the-cloud/v1/</pre>

<p>There should be a file called <em>hello.txt</em>. Let’s <a contenteditable="false" data-primary="gsutil" data-secondary="using to access and manage files" data-tertiary="cat command" data-type="indexterm" id="idm45625634382488"/>use the <code>gsutil</code> version of the Unix command <code>cat</code>, which allows us to read the content of text files to see what this <em>hello.txt</em> file contains:</p>

<pre data-type="programlisting">
$ gsutil cat gs://genomics-in-the-cloud/hello.txt
HELLO, DEAR READER!</pre>

<p>You can also try<a contenteditable="false" data-primary="gsutil" data-secondary="using to access and manage files" data-tertiary="cp command" data-type="indexterm" id="idm45625634378216"/> copying the file to your storage disk:</p>

<pre data-type="programlisting">
$ gsutil cp gs://genomics-in-the-cloud/hello.txt .
Copying gs://genomics-in-the-cloud/hello.txt...
/ [1 files][   20.0 B/   20.0 B]
Operation completed over 1 objects/20.0 B.</pre>

<p>If you <a contenteditable="false" data-primary="gsutil" data-secondary="using to access and manage files" data-tertiary="ls command" data-type="indexterm" id="idm45625634375096"/>list the contents of your working directory by using <code>ls</code> again, you should now have a local copy of the <em>hello.txt</em> file:</p>

<pre data-type="programlisting">
$ ls
hello.txt README-cloudshell.txt</pre>

<p>While we’re <a contenteditable="false" data-primary="storage buckets" data-secondary="creating with gsutil" data-type="indexterm" id="idm45625634370904"/>playing with <code>gsutil</code>, how about <a contenteditable="false" data-primary="gsutil" data-secondary="using to access and manage files" data-tertiary="creating storage bucket" data-type="indexterm" id="idm45625634368920"/>we do something that will be useful later: create a storage bucket of your own, so that you can store outputs in GCS. <a contenteditable="false" data-primary="names" data-secondary="bucket names in GCS" data-type="indexterm" id="idm45625634366968"/><a contenteditable="false" data-primary="buckets" data-see="storage buckets" data-type="indexterm" id="idm45625634365592"/>You’ll need to substitute <code>my-bucket</code> in the command shown here because bucket names must be unique across all of GCS:</p>

<pre data-type="programlisting">
$ gsutil mb gs://my-bucket</pre>

<p>If you didn’t change the bucket name or you tried a name that was already taken by someone else, you might get the following error message:</p>

<pre data-type="programlisting">
Creating gs://my-bucket/...
ServiceException: 409 Bucket my-bucket already exists.</pre>

<p>If this is the case, just try something else that’s more likely to be unique. You’ll know it worked when you see the <code>Creating <em>name</em>...</code> in the output and then get back to the prompt without any further complaint from <code>gsutil</code>. When that’s done, you’re going to create an environment variable that will serve as an alias for your bucket name. <a contenteditable="false" data-primary="gsutil" data-secondary="using to access and manage files" data-tertiary="creating alias for bucket name" data-type="indexterm" id="idm45625634359576"/><a contenteditable="false" data-primary="gsutil" data-secondary="using to access and manage files" data-tertiary="cp command" data-type="indexterm" id="idm45625634357848"/>That way, you’ll save yourself some typing and you’ll be able to copy and paste subsequent commands without having to substitute the bucket name every time:</p>

<pre data-type="programlisting">
$ export BUCKET="gs://my-bucket"</pre>

<p>You can run the <code>echo</code> command on your new variable to verify that your bucket name has been stored properly:</p>

<pre data-type="programlisting">
$ echo $BUCKET
gs://my-bucket</pre>

<p>Now, let’s get you comfortable with using <code>gsutil</code>. First, copy the <em>hello.txt</em> file to your new bucket. You can do either directly from the original bucket:</p>

<pre data-type="programlisting">
$ gsutil cp gs://genomics-in-the-cloud/hello.txt $BUCKET/</pre>

<p>Or, you can do it from your local copy; for example, if you made modifications that you want to save:</p>

<pre data-type="programlisting">
$ gsutil cp hello.txt $BUCKET/</pre>

<p>Finally, as one more example of basic file management, you can decide that the file should reside in its own directory in your bucket:</p>

<pre data-type="programlisting">
$ gsutil cp $BUCKET/hello.txt $BUCKET/my-directory/</pre>

<p>As you can see, the <code>gsutil</code> commands are set up to be as similar as possible to their original Unix counterparts. So, for example, you’ll also be able to use <code>-r</code> to make the <code>cp</code> and <code>mv</code> commands recursive to apply to directories. For large file transfers, you can use a few cloud-specification optimizations to speed up the process, like the <code>gsutil -m</code> option, which parallelizes file transfers.<a contenteditable="false" data-primary="gsutil" data-secondary="using to access and manage files" data-tertiary="parallelizing file transfers with -m option" data-type="indexterm" id="idm45625634345608"/> Conveniently, the system will usually inform you in the terminal output when you could take advantage of such optimizations, so you don’t need to go and memorize the documentation before getting underway.</p>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="managing_buckets_through_the_gcp_consol">
<h5>Managing Buckets Through the GCP Console</h5>

<p>If you’d rather manage<a contenteditable="false" data-primary="storage buckets" data-secondary="managing through GCP console" data-type="indexterm" id="idm45625634341864"/> your storage buckets through<a contenteditable="false" data-primary="GCP console" data-secondary="managing buckets through" data-type="indexterm" id="idm45625634340200"/> a web interface, go to <a href="https://oreil.ly/NGmdr"><em>Storage</em></a>, which should list all buckets that belong to your default project, as shown in <a data-type="xref" href="#gcp_console_storage_browserdot">Figure 4-5</a>. To create a new bucket, at the top center of the page, click Create Bucket.</p>
</div></aside>

<figure class="no-frame"><div id="gcp_console_storage_browserdot" class="figure"><img alt="GCP console storage browser." src="Images/gitc_0405.png" width="1440" height="282"/>
<h6><span class="label">Figure 4-5. </span>GCP console storage browser.</h6>
</div></figure>

<p>This opens a reasonably simple configuration form. The most important thing to do here is to choose a good name because the name you choose must be unique across all of Google Cloud—so be creative! If you choose a name that is already in use, the system will let you know when you click Continue in the configuration form, as demonstrated in <a data-type="xref" href="#naming_your_bucketdot">Figure 4-6</a>.</p>

<figure class="width-60 no-frame"><div id="naming_your_bucketdot" class="figure"><img alt="Naming your bucket." src="Images/gitc_0406.png" width="1146" height="572"/>
<h6><span class="label">Figure 4-6. </span>Naming your bucket.</h6>
</div></figure>

<p>When you have a unique name, the system will let you proceed to the next step by expanding the menu options. These allow you to customize the storage location and access controls for your bucket, but for the time being, feel free to just accept the defaults and click Create. Doing so will take you back to the list of buckets, which should at this point include your newly created one. You can click its name to view its contents—but of course it’s still empty, so the view won’t be particularly exciting, as illustrated in <a data-type="xref" href="#viewing_the_contents_of_your_bucketdot">Figure 4-7</a>.</p>

<p>The interface offers a few basic management options like deleting buckets and files as well as uploading files and folders. Note that you can even drag and drop files and folders from your local machine into the bucket contents window, which is stunningly easy (go ahead, try it), but it’s not something you can expect to do very often in the course of your genomics work. In the real world, you’re more likely to use the <code>gsutil</code> command-line utility. One of the advantages of using the command-line path is that you can save those commands as a script, for provenance and so that your steps can be reproduced if needed.<a contenteditable="false" data-primary="gsutil" data-secondary="using to access and manage files" data-startref="ix_gsutil" data-type="indexterm" id="idm45625634327080"/><a contenteditable="false" data-primary="Google Cloud Shell" data-secondary="using gsutil to access and manage files" data-startref="x_GCSgsutil" data-type="indexterm" id="idm45625634325368"/></p>

<figure class="no-frame"><div id="viewing_the_contents_of_your_bucketdot" class="figure"><img alt="Viewing the contents of your bucket." src="Images/gitc_0407.png" width="1370" height="530"/>
<h6><span class="label">Figure 4-7. </span>Viewing the contents of your bucket.</h6>
</div></figure>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Pulling a Docker Image and Spinning Up the Container"><div class="sect2" id="pulling_a_docker_image_and_spinning_up">
<h2>Pulling a Docker Image and Spinning Up the Container</h2>

<p>Cloud Shell is the gift that keeps<a contenteditable="false" data-primary="Google Cloud Shell" data-secondary="pulling Docker image and starting up a container" data-type="indexterm" id="ix_GCSDock"/> on giving: the Docker application (which we introduced in <a data-type="xref" href="ch03.xhtml#computing_technology_basics_for_life_sc">Chapter 3</a>) comes preinstalled, so you can go ahead and get started with that, too! We’re going to use a simple Ubuntu container to illustrate basic Docker functionality. Although a Docker image is available for GATK—and that’s what we’re going to use for a good chunk of the next few chapters—we’re not going to use it here because it’s rather large, so it takes a little while to get going. We wouldn’t actually be able to run any realistic analyses with it in the free Cloud Shell because of the small amount of CPU and memory resources allocated for this free VM.</p>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The first thing to do to learn how to use Docker containers in this context is to...well, avoid the online Docker documentation! Seriously. Not because it’s bad, but because the majority of those documents are written mainly for people who want to run web applications in the cloud. If that’s what <em>you</em> want to do, more power to you, but you’re reading the wrong book. What we’re providing here are tailored instructions that will teach you how to use Docker to run research software in containers.</p>
</div>

<p>As just noted, we’re going to use a very generic example: an image containing the Ubuntu Linux OS.<a contenteditable="false" data-primary="Ubuntu Linux operating system, Docker image containing (OS)" data-type="indexterm" id="idm45625634313736"/> It’s an official image that is provided as part of the core library in a public container image repository, Docker Hub, so we just need to state its name. <a contenteditable="false" data-primary="Docker Hub" data-type="indexterm" id="idm45625634312280"/>You’ll see later that images contributed by the community are prefixed by the contributor’s username or organization name. While still in your Cloud Shell terminal (it doesn’t matter where your working directory is), run the following command to retrieve the Ubuntu image from the Docker Hub library of official (certified) images:</p>

<pre data-type="programlisting">
$ docker pull ubuntu
Using default tag: latest
latest: Pulling from library/ubuntu
7413c47ba209: Pull complete
0fe7e7cbb2e8: Pull complete
1d425c982345: Pull complete
344da5c95cec: Pull complete
Digest: sha256:d91842ef309155b85a9e5c59566719308fab816b40d376809c39cf1cf4de3c6a
Status: Downloaded newer image for ubuntu:latest
docker.io/library/ubuntu:latest</pre>

<p>The <code>pull</code> command fetches the image and saves it to your VM.<a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="pulling Ubuntu OS image and saving in Google Cloud Shell" data-type="indexterm" id="idm45625634308488"/> The version of the container image is indicated by its <code>tag</code> (which can be anything the image creator wants to assign) and by its <code>sha256</code> hash (which is based on the image contents). By default, the system gives us the latest version that is available because we did not specify a particular tag; in a later exercise, you’ll see how to request a specific version by its tag. Note that container images are typically composed of several modular <em>slices</em>, which are pulled separately. They’re organized so that the next time you pull a version of the image, the system will skip downloading any slices that are unchanged compared to the version you already have.</p>

<p>Now let’s start up the container. <a contenteditable="false" data-primary="containers" data-secondary="starting up and running Docker container in Google Cloud Shell" data-type="indexterm" id="idm45625634304648"/>There are three main options for running it, but the tricky thing is that there is usually only one correct way to do it <em>as its author intended</em>, and it’s difficult to know what that is if the documentation doesn’t specify it (which is soooo often the case). Confused? Let’s walk through the cases to make this a bit more concrete, and you’ll see why we’re putting you through this momentary frustration and mystery—it’s to save you potential misery down the road.</p>

<dl>
	<dt>First option</dt>
	<dd>
	<p>Just <a contenteditable="false" data-primary="docker run command" data-type="indexterm" id="idm45625634300296"/>run it!</p>

	<pre data-type="programlisting">
$ docker run ubuntu</pre>
	</dd>
	<dt>Result</dt>
	<dd>
	<p>A short pause, then your command prompt comes back. No output. What happened? Docker did in fact spin up the container, but the container wasn’t configured to <em>do</em> anything under those conditions, so it basically shrugged and shut down again.</p>
	</dd>
	<dt>Second option</dt>
	<dd>
	<p>Run it with a command appended:</p>

	<pre data-type="programlisting">
$ docker run ubuntu echo "Hello World!"
Hello World!</pre>
	</dd>
	<dt>Result</dt>
	<dd>
	<p>It echoed <code>Hello World!</code>, as requested, and then shut down again. OK, so now we know that we can pass commands to the container, and if it’s a command that is recognized by something in there, it will be executed. Then, when any and all commands have been completed, the container will shut down. A bit lazy, but reasonable.</p>
	</dd>
	<dt>Third option</dt>
	<dd>
	<p>Run it interactively by using the <code>-it</code> option:</p>

	<pre data-type="programlisting">
$ docker run -it ubuntu /bin/bash
root@d84c079d0623:/#</pre>
	</dd>
	<dt>Result</dt>
	<dd>
	<p>Aha! A new command prompt (Bash in this case)! <a contenteditable="false" data-primary="Bash shell" data-secondary="running Docker container within Google Cloud Shell" data-type="indexterm" id="idm45625634288072"/>But with a different shell symbol: <code>#</code> instead of <code>$</code>. This means that the container is running and you are in it. You can now run any command that you would normally use on an Ubuntu system, including installing new packages if you like. Try running a few Unix commands such as <code>ls</code> or <code>ls -la</code> to poke around and see what the container can do. Later in the book, particularly in <a data-type="xref" href="ch12.xhtml#interactive_analysis_in_jupyter_noteboo">Chapter 12</a>, we go into some of the implications of this, including practical instructions for how to package and redistribute an image you’ve customized in order to share your own analysis in a reproducible way.</p>
	</dd>
</dl>

<p>When you’re done poking around, type <code><strong>exit</strong></code> at the command prompt (or press Ctrl+D) to terminate the shell. <a contenteditable="false" data-primary="containers" data-secondary="shutting down Docker container in Google Cloud Shell" data-type="indexterm" id="idm45625634282360"/>Because this is the main process the container was running, terminating it will cause the container to shut down and return to the Cloud Shell itself. To be clear, this will shut down the container <em>and any commands that are currently running</em>.</p>

<p>If you’re curious: yes, it is possible to step outside of the container without shutting it down; this is called <em>detaching</em>. <a contenteditable="false" data-primary="containers" data-secondary="detaching Docker container in Google Cloud Shell" data-type="indexterm" id="idm45625634278984"/>To do so, press Ctrl+P+Q instead of using the <code>exit</code> command. You’ll then be able to jump back into the container at any time—provided that you can identify it. <a contenteditable="false" data-primary="universally unique identifier (UUID) assigned by Docker to containers" data-type="indexterm" id="idm45625634276808"/>By default, Docker assigns your container a universally unique identifier (UUID) as well as a random human-readable name (which tend to sound a bit silly).<a contenteditable="false" data-primary="docker ps command" data-type="indexterm" id="idm45625634275352"/> You can run <code>docker ps</code> to list currently running containers or <code>docker ps -a</code> to list containers that have been created. This displays a list of containers indexed by their container IDs that should look something like this:</p>

<pre class="small" data-type="programlisting">
$ docker ps -a
CONTAINER ID	IMAGE	COMMAND                 CREATED     STATUS			
PORTS		NAMES
c2b4f8a0c7a6	ubuntu	"/bin/bash"             5 minutes ago	 Up 5 minutes	
vigorous_rosalind
9336068da866	ubuntu	"echo ’Hello World!’"	8 minutes ago	Exited (0) 8 minutes ago
objective_curie</pre>

<p>We’re showing that two entries correspond to the last two invocations of Docker, each with a unique identifier, the <code>CONTAINER ID</code>. We see the container with ID <code>c2b4f8a0c7a6</code> that is currently running was named <code>vigorous_rosalind</code> and has a status of <code>Up 5 minutes</code>. You can tell that the other container, <code>objective_curie</code>, is not running because its status is <code>Exited (0) 8 minutes ago</code>. The names we see here were randomly assigned (We swear! What are the odds?), so they’re admittedly not terribly meaningful.<a contenteditable="false" data-primary="names" data-secondary="Docker containers" data-type="indexterm" id="idm45625634268008"/> If you have multiple containers running at the same time, this can become a bit confusing, so you’ll want a better way to identify them. The good news is that you can give them a meaningful name by adding <code>--name=<em>meaningful_name</em></code> immediately after <code>docker run</code> in your initial command, substituting <code><em>meaningful_name</em></code> with the name that you want to give the container.<a contenteditable="false" data-primary="docker run command" data-secondary="--name=meaningful_name option" data-type="indexterm" id="idm45625634264472"/></p>

<p>To enter the container, simply run <code>docker attach <em>c2b4f8a0c7a6</em></code> (substituting your container ID), press Enter, and you will<a contenteditable="false" data-primary="docker attach command" data-type="indexterm" id="idm45625634262328"/> find yourself back at the helm (your keyboard might be labeled Return instead of Enter). You can open a second command tab in Cloud Shell if you’d like to be able to run commands outside the container alongside the work you’re doing inside the container. Note that you can have multiple containers running at the same time on a single VM—that’s one of the great advantages of the container system—but they will be competing for the CPU and memory resources of the VM, which in Cloud Shell are rather minimal. Later in this chapter, we show you how to spin up VMs<a contenteditable="false" data-primary="Google Cloud Shell" data-secondary="pulling Docker image and starting up a container" data-startref="ix_GCSDock" data-type="indexterm" id="idm45625634260456"/> with beefier capabilities. </p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Mounting a Volume to Access the Filesystem from Within the Container"><div class="sect2" id="mounting_a_volume_to_access_the_filesys">
<h2>Mounting a Volume to Access the Filesystem from Within <span class="keep-together">the Container</span></h2>

<p>Having completed the previous exercise, you are now able to retrieve and run an instance of any container image shared in a public repository.<a contenteditable="false" data-primary="containers" data-secondary="mounting a volume from Google Cloud Shell into" data-type="indexterm" id="ix_ctnrmtvol"/><a contenteditable="false" data-primary="Google Cloud Shell" data-secondary="mounting a volume to access filesystem from within container" data-type="indexterm" id="ix_GCSmtvol"/> Many commonly used bioinformatics tools, including GATK, are available preinstalled in Docker containers. <a contenteditable="false" data-primary="volume or directory, mounting from Google Cloud Shell into Docker container" data-type="indexterm" id="ix_volmt"/>The idea is that knowing how to use them out of a Docker container means you won’t need to worry about having the correct OS or software environment. However, there’s still one trick that we need to show you in order to make that really work for you: how to access your machine’s filesystem from within the container by <em>mounting a volume</em>.</p>

<p>What does that last bit mean? By default, when you’re inside the container, you can’t access any data that resides on the filesystem outside of the container. The container is a closed box. There are ways to copy things back and forth between the container and your filesystem, but that becomes tedious really fast. So we’re going to follow the easier path, which is to establish a link between a directory outside the container in a way that makes it appear as if it were within the container. In other words, we’re going to poke a hole in the container wall, as shown in <a data-type="xref" href="#mounting_a_volume_or_directory_from_you">Figure 4-8</a>.</p>

<figure><div id="mounting_a_volume_or_directory_from_you" class="figure"><img alt="Mounting a volume or directory from your Google Cloud Shell into a Docker container." src="Images/gitc_0408.png" width="1440" height="601"/>
<h6><span class="label">Figure 4-8. </span>Mounting a directory from your Google Cloud Shell VM into a Docker <span class="keep-together">container:</span> Ubuntu container used in this chapter (left); GATK container introduced in <a data-type="xref" href="ch05.xhtml#first_steps_with_gatk">Chapter 5</a> (right).</h6>
</div></figure>

<p>As an example, let’s create a new directory called <em>book</em> in our Cloud Shell VM’s home directory, and put the <em>hello.txt</em> file from earlier inside it:</p>

<pre data-type="programlisting">
$ mkdir book
$ mv hello.txt book/
$ ls book
hello.txt</pre>

<p>So this time, let’s run the command to spin up our <a contenteditable="false" data-primary="docker run command" data-secondary="-v argument" data-type="indexterm" id="idm45625634241560"/>Ubuntu container by using the <code>-v</code> argument (where <code>v</code> is for volume), which allows us to specify a filesystem location and a mount point within the container:</p>

<pre data-type="programlisting">
$ docker run -v ~/book:/home/book -it ubuntu /bin/bash</pre>

<p>The <code>-v ~/book_data:/home/book</code> part of the command links the location you specified to the path <em>/home/book</em> directory within the Docker container. The <code>/home</code> part of the path is a directory that already exists in the container, whereas the <code>book</code> part can be any name you choose to give it. Now, everything in the <code>book</code> directory on your filesystem can be accessed from within the Docker container’s <em>/home/book</em> directory:</p>

<pre data-type="programlisting">
# ls home/book
hello.txt</pre>

<p>Here, we’re using the same name for the mount point as for the actual location we’re mounting because it’s more intuitive that way, but you could use a different name if you wanted. Note that if you give your mount point the name of a directory or file that already exists with that path in the container, it will “squash” the existing path, meaning that path will not be accessible for as long as the volume is mounted.</p>

<p>A few other Docker tricks are good to know, but for now, this is enough of a demonstration of the core Docker functionality that you’re going to use in <a data-type="xref" href="ch05.xhtml#first_steps_with_gatk">Chapter 5</a>. We go into the details of more sophisticated options as we encounter them.<a contenteditable="false" data-primary="volume or directory, mounting from Google Cloud Shell into Docker container" data-startref="ix_volmt" data-type="indexterm" id="idm45625634231800"/><a contenteditable="false" data-primary="containers" data-secondary="mounting a volume from Google Cloud Shell into" data-startref="ix_ctnrmtvol" data-type="indexterm" id="idm45625634230360"/><a contenteditable="false" data-primary="Google Cloud Shell" data-secondary="mounting a volume to access filesystem from within container" data-startref="ix_GCSmtvol" data-type="indexterm" id="idm45625634228520"/><a contenteditable="false" data-primary="Google Cloud Shell" data-startref="ix_GCS" data-type="indexterm" id="idm45625634226824"/><a contenteditable="false" data-primary="cloud computing" data-secondary="getting started" data-startref="ix_cldstrtcmd" data-tertiary="running basic commands in Google Cloud Shell" data-type="indexterm" id="idm45625634225448"/></p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Setting Up Your Own Custom VM"><div class="sect1" id="setting_up_your_own_custom_vm">
<h1>Setting Up Your Own Custom VM</h1>

<p>Now that you’ve successfully run some basic file-management commands and got the hang of interacting with Docker containers, it’s time to move on to bigger and better things. <a contenteditable="false" data-primary="Google Cloud Platform (GCP)" data-secondary="setting up your own custom VM" data-type="indexterm" id="ix_GCPcusVM"/><a contenteditable="false" data-primary="cloud computing" data-secondary="getting started" data-tertiary="setting up your own custom VM" data-type="indexterm" id="ix_cldstrtCVM"/><a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-type="indexterm" id="ix_VMscust"/>The Google Cloud Shell environment is excellent for quickly getting started with some light coding and execution tasks, but the VM allocated for Cloud Shell is really underpowered and will definitely not cut the mustard when it comes to running real GATK analyses in <a data-type="xref" href="ch05.xhtml#first_steps_with_gatk">Chapter 5</a>.</p>

<p>In this section, we show you how to set up your own VM in the cloud (sometimes called an <em>instance</em>) using Google’s Compute Engine service, which allows you to select, configure, and run VMs of whatever size you need.</p>

<section data-type="sect2" data-pdf-bookmark="Creating and Configuring Your VM Instance"><div class="sect2" id="creating_and_configuring_your_vm_instan">
<h2>Creating and Configuring Your VM Instance</h2>

<p>First, go to the <a href="https://oreil.ly/sGeug"><em>Compute Engine</em></a> or access the page<a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-tertiary="creating and configuring VM instance" data-type="indexterm" id="ix_VMscustinst"/> through the sidebar menu on the left, as shown in <a data-type="xref" href="#compute_engine_menu_showing_the_vm_inst">Figure 4-9</a>.</p> 

<figure class="width-50 no-frame"><div id="compute_engine_menu_showing_the_vm_inst" class="figure"><img alt="Compute Engine menu showing the VM instances menu item." src="Images/gitc_0409.png" width="1440" height="1813"/>
<h6><span class="label">Figure 4-9. </span>Compute Engine menu showing the VM instances menu item.</h6>
</div></figure>

<p>Click the VM Instances link in this menu to go to an overview of running images. If this is a new account, you won’t have any running. Notice at the top that there’s an option for Create Instance. Click that, and let’s walk through the process of creating a new VM with just the resources you need.</p>

<p>Next, in the top menu bar, click Create Instance, as shown in <a data-type="xref" href="#create_an_instance">Figure 4-10</a>. This brings up a configuration form, as shown in <a data-type="xref" href="#the_vm_instance_configuration_paneldot">Figure 4-11</a>.</p>

<figure class="no-frame"><div id="create_an_instance" class="figure"><img alt="Create an instance" src="Images/gitc_0410.png" width="1440" height="153"/>
<h6><span class="label">Figure 4-10. </span>Create a VM instance.</h6>
</div></figure>

<figure class="no-frame"><div id="the_vm_instance_configuration_paneldot" class="figure"><img alt="The VM instance configuration panel." src="Images/gitc_0411.png" width="1442" height="1322"/>
<h6><span class="label">Figure 4-11. </span>The VM instance configuration panel.</h6>
</div></figure>

<p>Follow the step-by-step instructions in the subsections that follow to configure the VM. There are tons of options and the process can be quite confusing if you don’t have experience with the terminology, so we mapped out the simplest path through the configuration form that will allow you to run all of the command exercises in the first few chapters of this book. Please make sure that you use exactly the same settings as shown here unless you really know what you’re doing.</p>

<section data-type="sect3" data-pdf-bookmark="Name your VM"><div class="sect3" id="name_your_vm">
<h3>Name your VM</h3>

<p>Give your VM a name; for example, <code>genomics-book</code>, as shown in <a data-type="xref" href="#name_your_vm_instancedot">Figure 4-12</a>. This must <a contenteditable="false" data-primary="names" data-secondary="naming VM instance in GCP" data-type="indexterm" id="idm45625634193528"/>be unique within your project, but unlike bucket names, it does not need to be unique across GCP. Some people like to use their username so that others with access to the project can instantly identify who created the resource.</p>

<figure class="width-75 no-frame"><div id="name_your_vm_instancedot" class="figure"><img alt="Name your VM instance." src="Images/gitc_0412.png" width="930" height="130"/>
<h6><span class="label">Figure 4-12. </span>Name your VM instance.</h6>
</div></figure>
</div></section>

<section data-type="sect3" data-pdf-bookmark="Choose a region (important!) and zone (not so important)"><div class="sect3" id="choose_a_region_left_parenthesisimporta">
<h3>Choose a region (important!) and zone (not so important)</h3>

<p>There are different physical locations for the cloud. <a contenteditable="false" data-primary="region, choosing for custom VM in GCP" data-type="indexterm" id="idm45625634187208"/>Like most commercial cloud providers, GCP maintains datacenters in many parts of the world and provides you with the option to choose which one you want to use. Regions are the top-level geographical distinction, with names that are reasonably descriptive (like <code>us-west2</code>, which refers to a facility in Los Angeles).<a contenteditable="false" data-primary="zones in GCP" data-type="indexterm" id="idm45625634185256"/> Each region is further divided into two or more zones designated by single letters (<code>a</code>, <code>b</code>, <code>c</code>, etc.), which correspond to separate datacenters with their own physical infrastructure (power, network, etc.), though in some cases they might share the same building.</p>

<p>This system of regions and zones plays an important role in limiting the impact of localized problems like power outages, and all major cloud providers use some version of this strategy. For more on this topic, see <a href="https://oreil.ly/pZUl6">this entertaining blog post</a> by Kyle Galbraith about how cloud regions and zones (in his case, on AWS) could play an important role in the event of a zombie apocalypse.</p>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The ability to choose specific regions and zones for your projects is increasingly helpful for dealing with regulatory restrictions on where human-subjects data can be stored because it allows you to specify a compliant location for all storage and compute resources. However, some parts of the world are not yet well covered by cloud services or are covered differently by the various cloud providers, so you might need to factor in available datacenter locations when choosing a provider.</p>
</div>

<p>To choose a region for your project, you can consult the full list of <a href="https://oreil.ly/D4Iqa">available Google Cloud regions and zones</a> and make a decision based on geographic proximity. Alternatively, you can use an online utility that measures how close you <em>effectively</em> are to each datacenter in terms of network response time, like <a href="http://www.gcping.com"><em>http://www.gcping.com</em></a>. For example, if we run this test from the small town of Sunderland in western Massachusetts (results in <a data-type="xref" href="#geographical_distance_and_response_time">Table 4-1</a>), we find that it takes 38 milliseconds to get a response from the <code>us-east4</code> region located in Northern Virginia (698 km away), versus 41 milliseconds from the <code>northamerica-northeast1</code> region located in Montreal (441 km away). This shows us that geographical proximity does not correlate directly with network region proximity. As an even more striking example, we find that we are quite a bit “closer” to the <code>europe-west2</code> region in London (5,353 km away), with a response time of 102 milliseconds, than to the <code>us-west2</code> region in Los Angeles (4,697 km away) which gives us a response time of 180 milliseconds.</p>

<table class="border" id="geographical_distance_and_response_time">
	<caption><span class="label">Table 4-1. </span>Geographical distance and response time from Sunderland, MA</caption>
	<thead>
		<tr>
			<th>Region</th>
			<th>Location</th>
			<th>Distance (km)</th>
			<th>Response (ms)</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>us-east4</td>
			<td>Northern Virginia, US</td>
			<td>698</td>
			<td>38</td>
		</tr>
		<tr>
			<td>northamerica-northeast1</td>
			<td>Montreal</td>
			<td>441</td>
			<td>41</td>
		</tr>
		<tr>
			<td>europe-west2</td>
			<td>London</td>
			<td>5,353</td>
			<td>102</td>
		</tr>
		<tr>
			<td>us-west2</td>
			<td>Los Angeles</td>
			<td>4,697</td>
			<td>180</td>
		</tr>
	</tbody>
</table>

<p>This brings us back to our VM configuration. For the Region, we’re going to be using <code>us-east4</code> (Northern Virginia) because it’s closest to the one of us who travels least (Geraldine), and for the Zone we just randomly choose <code>us-east4-a</code>. You need to make sure that you choose <em>your</em> region based on the preceding discussion, both for your own benefit (it will be faster) and to avoid clobbering that one datacenter in Virginia in the unlikely event that all 60,000 registered users of the GATK software begin working through these exercises at the same time—though that’s one way to test the vaunted “elasticity” of the cloud.</p>
</div></section>

<section data-type="sect3" data-pdf-bookmark="Select a machine type"><div class="sect3" id="select_a_machine_type">
<h3>Select a machine type</h3>

<p>This is where you can configure the resources of the VM you’re about to launch. You can control RAM as well as CPUs.<a contenteditable="false" data-primary="machine type, selecting for custom VM in GCP" data-type="indexterm" id="idm45625634155352"/> For some instance types (available under Customize) you can even select VMs with GPUs, which are used to accelerate certain programs. The hitch is that what you select here will determine how much you’ll be billed per second of the VM’s uptime; the bigger and beefier the machine, the more it will cost you. The right side of the page should show how the hourly and monthly cost changes when you change the machine type. Note also that you’re billed for how long the VM is online, not for how much time you spend actually using it. We cover strategies for limiting costs later, but keep that in mind!</p>

<p>Here, select <code>n1-standard-2</code>; this is a fairly basic machine that’s<a contenteditable="false" data-primary="n1-standard-2 machine type (in GCP)" data-type="indexterm" id="idm45625634152536"/> not going to cost much at all, as shown in <a data-type="xref" href="#selecting_a_machine_typedot">Figure 4-13</a>.</p>

<figure class="width-75 no-frame"><div id="selecting_a_machine_typedot" class="figure"><img alt="Selecting a machine type." src="Images/gitc_0413.png" width="856" height="264"/>
<h6><span class="label">Figure 4-13. </span>Selecting a machine type.</h6>
</div></figure>
</div></section>

<section data-type="sect3" data-pdf-bookmark="Specify a container? (nope)"><div class="sect3" id="specify_a_containerquestion_mark_left_p">
<h3>Specify a container? (nope)</h3>

<p>We’re not going to fill this out. This is useful if you want to use a very specific setup using a custom container image that you’ve preselected or generated yourself.<a contenteditable="false" data-primary="containers" data-secondary="specifying for custom VM in GCP" data-type="indexterm" id="idm45625634146232"/> In fact, we could have preconfigured a container for you and skipped a bunch of setup that’s coming next. But then you wouldn’t have the opportunity to learn how to do those things for yourself, would you? So, for now, let’s just skip this option.</p>
</div></section>

<section data-type="sect3" data-pdf-bookmark="Customize the boot disk"><div class="sect3" id="customize_the_boot_disk">
<h3>Customize the boot disk</h3>

<p>Like Machine Type, this is another really useful setting.<a contenteditable="false" data-primary="boot disk, customizing for VM in GCP" data-type="indexterm" id="idm45625634142136"/> You can define two things here: the OS that you want to use and the amount of disk space you want. The former is especially important if you need to use a particular type and version of OS. And, of course, the latter is important if you don’t want to run out of disk space halfway through your analysis.</p>

<p>By default, the <a contenteditable="false" data-primary="Linux OS on cloud VMs" data-secondary="customizing boot disk for VM in GCP" data-type="indexterm" id="idm45625634140072"/>system proposes a particular flavor of Linux OS, accompanied by a paltry 10 GB of disk space, as shown in <a data-type="xref" href="#choosing_a_different_boot_diskdot">Figure 4-14</a>. We’re going to need a bigger boat.</p>

<figure class="width-75 no-frame"><div id="choosing_a_different_boot_diskdot" class="figure"><img alt="Choosing a different boot disk. " src="Images/gitc_0414.png" width="924" height="248"/>
<h6><span class="label">Figure 4-14. </span>Choosing a boot disk size and image.</h6>
</div></figure>

<p>To access the settings menu for this, click Change. This opens a new screen with a menu of predefined options. You can also make your own custom images, or even find more images in <a href="https://oreil.ly/sjiIf">Google Cloud Marketplace</a>.</p>

<p>For our immediate purposes, we prefer Ubuntu 18.04 LTS, which is the most recent version of Ubuntu’s long-term release, as of this writing. It might not be as bleeding edge as Ubuntu 19.04, but the LTS, which stands for <em>long-term support</em>, guarantees that it’s being maintained for security vulnerabilities and package updates for five years from release. This Ubuntu image has a ton of what we already need, ready to go and installed, including various standard Linux tools and the GCP SDK command-line tools, which we will rely on quite heavily.</p>

<p>Select Ubuntu in the Operating System menu, then select Ubuntu 18.04 LTS in the version menu,<a contenteditable="false" data-primary="Ubuntu 18.04 LTS image, selecting for VM boot disk in GCP" data-type="indexterm" id="idm45625634131976"/> as shown in <a data-type="xref" href="#selecting_a_base_imagedot">Figure 4-15</a>.</p>

<figure class="no-frame"><div id="selecting_a_base_imagedot" class="figure"><img alt="Selecting a base image." src="Images/gitc_0415.png" width="1440" height="638"/>
<h6><span class="label">Figure 4-15. </span>Selecting a base image.</h6>
</div></figure>

<p>At the bottom of the form, you can change the Boot disk Size to give yourself more space. As shown in <a data-type="xref" href="#setting_the_boot_disk_sizedot">Figure 4-16</a>, go ahead and select 100 GB instead of the default 10 GB (the data we’re going to be working with can easily take up a lot of space). You can bump this up quite a bit more, depending on your dataset size and needs. Although you can’t easily adjust it after the VM launches, you do have the option of adding block storage volumes to the running instance after launch—think of it as the cloud equivalent of plugging in a USB drive. So if you run out of disk space, you won’t be totally stuck.</p>

<figure class="width-75 no-frame"><div id="setting_the_boot_disk_sizedot" class="figure"><img alt="Setting the boot disk size." src="Images/gitc_0416.png" width="958" height="280"/>
<h6><span class="label">Figure 4-16. </span>Setting the boot disk size.</h6>
</div></figure>

<p>After you’ve done all this, click Select; this closes the screen and returns you to the instance creation form where the “Boot disk” section should match the screenshot in <a data-type="xref" href="#the_updated_boot_disk_selectiondot">Figure 4-17</a>.</p>

<figure class="width-75 no-frame"><div id="the_updated_boot_disk_selectiondot" class="figure"><img alt="The updated boot disk selection." src="Images/gitc_0417.png" width="918" height="250"/>
<h6><span class="label">Figure 4-17. </span>The updated boot disk selection.</h6>
</div></figure>

<p>At the bottom of the form, click Create. This returns you to the page that lists Compute Engine VM instances, including your newly created VM instance. You might see a spinning icon in front of its name while the instance is being created and booted up, and then a green circle with a checkmark will appear when it is running and ready for use, as shown in <a data-type="xref" href="#viewing_the_vm_statusdot">Figure 4-18</a>.</p>

<figure class="no-frame"><div id="viewing_the_vm_statusdot" class="figure"><img alt="Viewing the VM status." src="Images/gitc_0418.png" width="1428" height="252"/>
<h6><span class="label">Figure 4-18. </span>Viewing the VM status.</h6>
</div></figure>

<p>And voilà, your VM is ready <a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-startref="ix_VMscustinst" data-tertiary="creating and configuring VM instance" data-type="indexterm" id="idm45625634115128"/>for action.</p>
</div></section>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Logging into Your VM by Using SSH"><div class="sect2" id="logging_into_your_vm_by_using_ssh">
<h2>Logging into Your VM by Using SSH</h2>

<p>There are several ways that you can access the VM after it’s running, which you can learn about in the GCP documentation. <a contenteditable="false" data-primary="SSH (Secure Shell)" data-secondary="using to log into custom VM in GCP" data-type="indexterm" id="idm45625634111256"/><a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-tertiary="logging into VM using SSH" data-type="indexterm" id="idm45625634109816"/>We’re going to show you the simplest way to do it, using the Google Cloud console and the built-in SSH terminal. It’s hard to beat: as soon as you see a green checkmark in the Google Cloud console, you can simply click the SSH option to open a drop-down menu, as illustrated in <a data-type="xref" href="#options_for_sshing_into_your_vm">Figure 4-19</a>. Select the option “Open in a browser window,” and a few seconds later you should see an SSH terminal open to this VM.</p>

<figure class="no-frame"><div id="options_for_sshing_into_your_vm" class="figure"><img alt="Options for SSHing into your VM" src="Images/gitc_0419.png" width="1441" height="428"/>
<h6><span class="label">Figure 4-19. </span>Options for SSHing into your VM.</h6>
</div></figure>

<p>This opens a new window with a terminal that allows you to run commands from within the VM instance, as shown in <a data-type="xref" href="#vm_instance_terminaldot">Figure 4-20</a>. It might take a minute to establish the connection.</p>

<figure class="no-frame"><div id="vm_instance_terminaldot" class="figure"><img alt="VM instance terminal." src="Images/gitc_0420.png" width="1441" height="907"/>
<h6><span class="label">Figure 4-20. </span>VM instance terminal.</h6>
</div></figure>

<p>Feel free to look around and get to know your brand-new VM; you’re going to spend a lot of time with it in the course of the next few chapters (but, like, in a good way).</p>

<aside class="pagebreak-before less_space" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45625634100056">
<h5>Connecting to the VM by Command Line</h5>

<p>Alright, we’ll show you one other one, if you insist.<a contenteditable="false" data-primary="command line" data-secondary="gcloud, connecting to VM by" data-seealso="gcloud" data-type="indexterm" id="idm45625634098184"/> Here it is: you can also use the <code>gcloud</code> command<a contenteditable="false" data-primary="gcloud (Google Cloud SDK)" data-secondary="compute SSH command" data-type="indexterm" id="idm45625634095928"/> line to SSH to your VMs. Here’s the syntax:</p>

<pre data-type="programlisting">
gcloud compute ssh --project [PROJECT_ID] --zone [ZONE] [INSTANCE_NAME]</pre>

<p>You would need to replace the <code><em>PROJECT_ID</em></code>, <code><em>ZONE</em></code>, and <code><em>INSTANCE_NAME</em></code> with actual values (but no brackets). You can do this from the Cloud Shell VM or from any other location where you have installed the Google Cloud SDK command-line package (<code>gcloud</code>). When you run it for the first time, the system might prompt you to generate an authentication key. Just follow the fairly straightforward prompts: press Y for yes and then type your desired passphrase if you want to use one.</p>
</div></aside>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Checking Your Authentication"><div class="sect2" id="checking_your_authentication">
<h2>Checking Your Authentication</h2>

<p>You’re probably itching to run <a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-tertiary="checking your authentication" data-type="indexterm" id="ix_VMscustauth"/>something<a contenteditable="false" data-primary="authentication" data-secondary="checking for custom VM in GCP" data-type="indexterm" id="ix_authVM"/> interesting, but let’s begin by making sure your account credentials are set up properly so you can use the GCP command-line tools, which come preinstalled on the image we chose. In the SSH terminal, run the following command:</p>

<pre data-type="programlisting">
$ gcloud init
Welcome! This command will take you through the configuration of gcloud.
Your current configuration has been set to: [default]
You can skip diagnostics next time by using the following flag:
 gcloud init --skip-diagnostics
Network diagnostic detects and fixes local network connection issues.
Checking network connection...done.                                                                                                                                   
Reachability Check passed.
Network diagnostic passed (1/1 checks passed).
Choose the account you would like to use to perform operations for
this configuration:
[1] XXXXXXXXXXX-compute@developer.gserviceaccount.com
[2] Log in with a new account
Please enter your numeric choice:</pre>

<p>The line that starts with <code>[1]</code> shows you that by default, GCP has you logged in under a service account: the domain is <em>@developer.gserviceaccount.com</em>. This is fine for running tools within your VM, but if you want to be able to manage resources, including copying files out to GCS buckets, you need to do so under an account with the relevant permissions. It is possible to grant this service account all the various permissions that you’ll need for these exercises, but that would lead us a bit further into the guts of GCP account administration than we’d like to go at this juncture—we want to get you doing genomics work ASAP! So instead, let’s just use the original account that you used to create the project at the beginning of this chapter, given that it already has those permissions as a project owner.</p>

<p>To log in with that account, press 2 at the prompt. This triggers some interaction with the program; GCP will warn you that using your personal credentials on a VM is a security risk because if you give someone else access to the VM, they will be able to use your credentials:</p>

<pre data-type="programlisting">
You are running on a Google Compute Engine virtual machine.
It is recommended that you use service accounts for authentication.
You can run:
 $ gcloud config set account `ACCOUNT`
to switch accounts if necessary.
Your credentials may be visible to others with access to this
virtual machine. Are you sure you want to authenticate with
your personal account?
Do you want to continue (Y/n)?</pre>

<p>The solution: don’t share access to your personal VM.<sup><a data-type="noteref" id="ch04fn1-marker" href="ch04.xhtml#ch04fn1">1</a></sup></p>

<p>If you type Y for yes, the program will give you a link:</p>

<pre data-type="programlisting">
Go to the following link in your browser:
   https://accounts.google.com/o/oauth2/auth?redirect_uri=&lt;...&gt;
Enter verification code:</pre>

<p>When you click the link or copy and paste it into your browser, you are presented with a Google login page. Log in with the same account you used for the GCP to get your authentication code and then copy and paste that back into your terminal window. The <code>gcloud</code> utility will confirm your login identity and ask you to select the project ID you want to use from the list of projects you have access to. It will also offer the option to set your preferred compute and storage zone, which should match what you set earlier when you created the VM. If you’re not seeing what you expect in the project ID list, you can<a contenteditable="false" data-primary="authentication" data-secondary="checking for custom VM in GCP" data-startref="ix_authVM" data-type="indexterm" id="idm45625634074664"/> always <a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-startref="ix_VMscustauth" data-tertiary="checking your authentication" data-type="indexterm" id="idm45625634072824"/>double-check the <a href="https://oreil.ly/T50ev">resource management page in the GCP console</a>.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Copying the Book Materials to Your VM"><div class="sect2" id="copying_the_book_materials_to_your_vm">
<h2>Copying the Book Materials to Your VM</h2>

<p>Throughout the next few chapters, you’re going<a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-tertiary="copying book materials to VM" data-type="indexterm" id="idm45625634068008"/> to run real GATK commands and workflows on your VM, so you need to retrieve the example data, source code, and a couple of software packages. We’ve bundled most of that in a single place: a Cloud Storage bucket called <code>genomics-in-the-cloud</code>. The only piece that is separate is the source code, which we provide in GitHub.</p>

<p>First, you’re going to copy the data <a contenteditable="false" data-primary="gsutil" data-secondary="copying data bundle from bucket to VM" data-type="indexterm" id="idm45625634065000"/>bundle from the bucket to your VM using <code>gsutil</code>, the GCP storage utility that we already used earlier in the Cloud Shell portion of this chapter. In your VM’s terminal window, make a new directory called <code><strong>book</strong></code>, and then run the <code>gsutil</code> command to copy the book data bundle to the storage space associated with your VM:</p>

<pre data-type="programlisting">
$ mkdir ~/book
$ gsutil -m cp -r gs://genomics-in-the-cloud/v1/* ~/book/</pre>

<p>This will copy about 10 GB of data to your VM’s storage, so it might take a few minutes even with the <code>-m</code> flag enabling parallel downloads. As you’ll see later, it is possible to run some analysis commands directly on files in Cloud Storage without copying them first, but we want to keep things as simple as possible in the beginning.</p>

<p>Now, go<a contenteditable="false" data-primary="Git" data-type="indexterm" id="idm45625634059112"/> ahead and retrieve the source code from the <a href="https://oreil.ly/genomics-repo">public repository on GitHub</a>. We’re making the code available there because it’s a highly popular platform for sharing code under <em>version control</em>, and we’re committed to providing long-term maintenance for the code we use in the book.<a contenteditable="false" data-primary="git clone command" data-type="indexterm" id="idm45625634056504"/> To get a copy on your VM, first use <code>cd</code> to move into the newly created <em>book</em> directory and then use the <code>git clone</code> command to copy the contents of the repository:</p>

<pre data-type="programlisting">
$ cd ~/book
$ git clone https://github.com/broadinstitute/genomics-in-the-cloud.git code</pre>

<p>This creates a directory (<em>~book/code</em>) that includes all the sample code we use throughout the book.<a contenteditable="false" data-primary="git pull command" data-type="indexterm" id="idm45625634052312"/> Not only that, but it will be set up as an active Git repository, so you can get the latest changes by running the <code>git pull</code> command in the code directory, as follows:</p>

<pre data-type="programlisting">
$ cd ~/book/code
$ git pull</pre>

<p>With that, you should now have the latest and greatest version of the book code. To find out what has changed since the original publication, check out the <em>README</em> text file in the code directory.</p>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45625634048472">
<h5>Using Git and GitHub for Version Control</h5>

<p>You don’t need to be familiar with Git in order to work through the examples in this book, but we do encourage you to consider taking some time at your convenience to learn how to use it at a basic level. It’s becoming increasingly common to use Git as a version control system for scientific code, so you will run into it again when exploring other people’s work, and you might benefit from using it to make your own work computationally reproducible. An excellent place to start is with Software Carpentry’s lesson on <a href="https://oreil.ly/yMLtP">using Git for version control</a>.</p>
</div></aside>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Installing Docker on Your VM"><div class="sect2" id="installing_docker_on_your_vm">
<h2>Installing Docker on Your VM</h2>

<p>You’re going to be working with Docker on your VM, so let’s make sure that you can run it. <a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-tertiary="installing Docker on your VM" data-type="indexterm" id="idm45625634043544"/><a contenteditable="false" data-primary="Docker" data-secondary="installing on VM in Google Cloud Platform" data-type="indexterm" id="idm45625634041800"/>If you simply run the command <code>docker</code> in the terminal, you’ll get an error message because Docker does not come preinstalled on the VM:</p>

<pre data-type="programlisting">
$ docker
Command 'docker' not found, but can be installed with:
snap install docker     # version 18.09.9, or
apt  install docker.io
See 'snap info docker' for additional versions.</pre>

<p>The error message helpfully points out how to remedy the situation using a preinstalled package called <code>snap</code>, but we’re actually going to use a slightly different way of installing Docker: we’re going to download and run a script from the Docker website that will largely automate the installation process. This way, you’ll know what to do if you find yourself needing to install Docker somewhere that doesn’t have a built-in package manager option.</p>

<p>Run the following command to install Docker on the VM:</p>

<pre data-type="programlisting">
$ curl -sSL https://get.docker.com/ | sh 
# Executing docker install script, commit: f45d7c11389849ff46a6b4d94e0dd1ffebca
32c1 + sudo -E sh -c apt-get update -qq &gt;/dev/null
...
Client: Docker Engine - Community
Version:           19.03.5
...
If you would like to use Docker as a non-root user, you should now consider
adding your user to the "docker" group with something like:
 sudo usermod -aG docker genomics_book
Remember that you will have to log out and back in for this to take effect!
WARNING: Adding a user to the "docker" group will grant the ability to run
        containers which can be used to obtain root privileges on the
        docker host.
        Refer to https://docs.docker.com/engine/security/security/#docker-daemon-
        attack-surface for more information.</pre>

<p>This might take a little while to complete, so let’s take that time to examine the command in a bit more detail. <a contenteditable="false" data-primary="curl utility" data-secondary="using to install Docker on VM in GCP" data-type="indexterm" id="idm45625634034872"/>First, we’re using a convenient little utility called <code>curl</code> (short for <em>Client URL</em>) to download the installation script from the Docker website URL we provided, with a few command parameters (<code>-sSL</code>) that instruct the program to follow any redirection links and save the output as a file. Then, we use the pipe character (<code>|</code>) to hand that output file over to a second command, <code>sh</code>, which means “run that script that we just gave you.” The first line of output lets you know what it’s doing: <code>Executing docker install script</code> (we omitted parts of the preceding output for brevity).</p>

<p>When it finishes, the <a contenteditable="false" data-primary="usermod command" data-type="indexterm" id="idm45625634029720"/>script prompts you to run the <code>usermod</code> command in the example that follows in order to grant yourself the ability to run Docker commands without using <code>sudo</code> each time. <a contenteditable="false" data-primary="sudo usermod -aG docker command" data-type="indexterm" id="idm45625634027496"/>Invoking <code>sudo docker</code> can result in output files being owned by root, making it difficult to manage or access them later, so it’s really important to do this step:</p>

<pre data-type="programlisting">
$ sudo usermod -aG docker $USER</pre>

<p>This does not produce any output; we’ll test in a minute whether it worked properly. First, however, you need to log out of your VM and then back in again. Doing so will make the system reevaluate your Unix group membership, which is necessary for the change you just made to take effect. Simply type <code><strong>exit</strong></code> (or press Ctrl+D) at the command prompt:</p>

<pre data-type="programlisting">
$ exit</pre>

<p>This closes the terminal window to your VM. Go back to the GCP console, find your VM in the list of Compute Engine instances, and then click SSH to log back in again. This probably feels like a lot of hoops to jump through, but hang in there; we’re getting to the good part.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Setting Up the GATK Container Image"><div class="sect2" id="setting_up_the_gatk_container_image">
<h2>Setting Up the GATK Container Image</h2>

<p>When you’re back<a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-tertiary="setting up GATK container image" data-type="indexterm" id="ix_VMscustGATK"/> in your VM, test your <a contenteditable="false" data-primary="containers" data-secondary="setting up GATK container image in GCP" data-type="indexterm" id="ix_cntrGATK"/>Docker installation<a contenteditable="false" data-primary="Genome Analysis Toolkit (GATK)" data-secondary="setting up GATK container image in GCP" data-type="indexterm" id="ix_GATKctrimg"/> by pulling the GATK container, which we use in the very next chapter:</p>

<pre data-type="programlisting">
$ docker pull us.gcr.io/broad-gatk/gatk:4.1.3.0
4.1.3.0: Pulling from us.gcr.io/broad-gatk/gatk
ae79f2514705: Pull complete
5ad56d5fc149: Pull complete
170e558760e8: Pull complete
395460e233f5: Pull complete
6f01dc62e444: Pull complete
b48fdadebab0: Pull complete
16fb14f5f7c9: Pull complete
Digest: sha256:e37193b61536cf21a2e1bcbdb71eac3d50dcb4917f4d7362b09f8d07e7c2ae50
Status: Downloaded newer image for us.gcr.io/broad-gatk/gatk:4.1.3.0
us.gcr.io/broad-gatk/gatk:4.1.3.0</pre>

<p>As a <a contenteditable="false" data-primary="docker pull command" data-type="indexterm" id="idm45625634012856"/>reminder, the last bit after the container name is the version tag, which you can change to get a different version than what we’ve specified here. Note that if you change the version, some commands might no longer work. We can’t guarantee that all code examples are going to be future-compatible, especially for the newer tools, some of which are still under active development. As noted earlier, for updated materials, see <a href="https://oreil.ly/genomics-repo">this book’s GitHub repository</a>.</p>

<p>The GATK container image is quite large, so the download might take a little while. The good news is that next time you need to pull a GATK image (e.g., to get another release), Docker will pull only the components that have been updated, so it will go faster.</p>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Here we’re pulling the GATK image from the Google Container Repository (GCR) because GCR is on the<a contenteditable="false" data-primary="Google Container Repository (GCR), pulling GATK image from" data-type="indexterm" id="idm45625634008632"/> same network as the VM we’re running on, so it will be faster than pulling it from Docker Hub. However, if you’re working on a different platform, you might find it faster to pull the image from the GATK repository on Docker Hub. To do so, change the <code>us.gcr.io/broad-gatk</code> part of the image path to just <code><strong>broadinstitute</strong></code>.</p>
</div>

<p>Now, remember the instructions you followed earlier in this chapter to spin up a container with a mounted folder? You’re going to use that again to make the <code>book</code> directory accessible to the GATK container:</p>

<pre class="small" data-type="programlisting">
$ docker run -v ~/book:/home/book -it us.gcr.io/broad-gatk/gatk:4.1.3.0 /bin/bash</pre>

<p>You should now be able to browse the <code>book</code> directory that you set up in your VM from within the container. It will be located under <em>/home/book</em>. Finally, to double-check that GATK itself is working as expected, try running the command <code>gatk</code> at the command line from within your running container. If everything is working properly, you should see some text output that outlines basic GATK command-line syntax and a few configuration options:</p>

<pre class="small" data-type="programlisting">
# gatk
Usage template for all tools (uses --spark-runner LOCAL when used with a Spark tool)
   gatk AnyTool toolArgs
Usage template for Spark tools (will NOT work on non-Spark tools)
   gatk SparkTool toolArgs  [ -- --spark-runner &lt;LOCAL | SPARK | GCS&gt; sparkArgs ]
Getting help
   gatk --list       Print the list of available tools
   gatk Tool --help  Print help on a particular tool
Configuration File Specification
    --gatk-config-file                PATH/TO/GATK/PROPERTIES/FILE
gatk forwards commands to GATK and adds some sugar for submitting spark jobs
  --spark-runner &lt;target&gt;    controls how spark tools are run
    valid targets are:
    LOCAL:      run using the in-memory spark runner
    SPARK:      run using spark-submit on an existing cluster
                --spark-master must be specified
                --spark-submit-command may be specified to control the Spark submit command
                arguments to spark-submit may optionally be specified after --
    GCS:        run using Google cloud dataproc
                commands after the -- will be passed to dataproc
                --cluster &lt;your-cluster&gt; must be specified after the --
                spark properties and some common spark-submit parameters will be translated
                to dataproc equivalents
  --dry-run     may be specified to output the generated command line without running it
  --java-options 'OPTION1[ OPTION2=Y ... ]''   optional - pass the given string of options to 
                 the java JVM at runtime. 
                Java options MUST be passed inside a single string with space-separated values
</pre>

<p>We discuss what that all means in loving detail in <a data-type="xref" href="ch05.xhtml#first_steps_with_gatk">Chapter 5</a>; for now, you’re done setting up the environment that you’ll be using to run GATK tools over the course of the next three chapters.<a contenteditable="false" data-primary="containers" data-secondary="setting up GATK container image in GCP" data-startref="ix_cntrGATK" data-type="indexterm" id="idm45625633997496"/><a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-startref="ix_VMscustGATK" data-tertiary="setting up GATK container image" data-type="indexterm" id="idm45625633995784"/><a contenteditable="false" data-primary="Genome Analysis Toolkit (GATK)" data-secondary="setting up GATK container image in GCP" data-startref="ix_GATKctrimg" data-type="indexterm" id="idm45625633993752"/></p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Stopping Your VM…to Stop It from Costing You Money"><div class="sect2" id="stopping_your_vmsemicolonto_stop_it_fro">
<h2>Stopping Your VM…to Stop It from Costing You Money</h2>

<p>The VM you just finished setting up is going to come in handy throughout the book; you’ll come<a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-tertiary="stopping your VM" data-type="indexterm" id="idm45625633990216"/> back to this VM for many of the exercises in the next few chapters. However, as long as it’s up and running, it’s costing you either credits or actual money. The simplest way to deal with that is to stop it: put it on pause whenever you’re not actively using it.</p>

<p>You can restart it on demand; it just takes a minute or two to get it back up and running, and it will retain all environment settings, the history of what you ran previously, and whatever data you have in local storage. Note that you will be charged a small fee for that storage even while the VM is not running and you’re not getting charged for the VM itself. In our opinion, this is well worth it for the convenience of being able to come back to your VM after an arbitrary amount of time and just pick up your work where you left off.</p>

<p>To stop your VM, in the GCP console, go to the VM instances <a contenteditable="false" data-primary="GCP console" data-secondary="stopping, starting, or deleting your VM instance" data-type="indexterm" id="idm45625633986728"/>management page, as shown previously. Find your instance and click the vertical three-dot symbol on the right to open the menu of controls, and then select Stop, as shown in <a data-type="xref" href="#stoppingcomma_startingcomma_or_deleting">Figure 4-21</a>. The process might take a couple of minutes to complete, but you can safely navigate away from that page. To restart your instance later on, just follow the same steps but click Start in the control menu.</p>

<figure class="no-frame"><div id="stoppingcomma_startingcomma_or_deleting" class="figure"><img alt="Stopping, starting, or deleting your VM instance." src="Images/gitc_0421.png" width="1440" height="521"/>
<h6><span class="label">Figure 4-21. </span>Stopping, starting, or deleting your VM instance.</h6>
</div></figure>

<p>Alternatively, you can delete your VM entirely, but keep in mind that deleting the VM will delete all locally stored data too, so make sure you save anything you care about to a storage bucket first.<a contenteditable="false" data-primary="Google Cloud Platform (GCP)" data-secondary="setting up your own custom VM" data-startref="ix_GCPcusVM" data-type="indexterm" id="idm45625633980920"/><a contenteditable="false" data-primary="virtual machines (VMs)" data-secondary="setting up custom VM in Google Cloud Platform" data-startref="ix_VMscust" data-type="indexterm" id="idm45625633979240"/><a contenteditable="false" data-primary="cloud computing" data-secondary="getting started" data-startref="ix_cldstrtCVM" data-tertiary="setting up your own custom VM" data-type="indexterm" id="idm45625633977496"/></p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Configuring IGV to Read Data from GCS Buckets"><div class="sect1" id="configuring_the_integrated_genome_viewe">
<h1>Configuring IGV to Read Data from GCS Buckets</h1>

<p>Just one more small step remains before you move <a contenteditable="false" data-primary="cloud computing" data-secondary="getting started" data-tertiary="configuring integrated genome viewer to read data from GCS buckets" data-type="indexterm" id="ix_cldstrtcfgIGV"/>on to the next chapter: we’re going<a contenteditable="false" data-primary="storage buckets" data-secondary="configuring IGV to read data from GCS buckets" data-type="indexterm" id="ix_stbcktcfgIGV"/> to install and <a contenteditable="false" data-primary="IGV (Integrated Genome Viewer)" data-secondary="configuring to read data from GCS buckets" data-type="indexterm" id="ix_IGVcfg"/>configure a genome browser called Integrated Genome Viewer (IGV) that can work directly with files in GCP. <a contenteditable="false" data-primary="Google Cloud Storage (GCS)" data-secondary="configuring IGV to read data from buckets" data-type="indexterm" id="ix_GCScfg"/>That will allow you to examine sequence data and variant calls without needing to copy the files to your local machine.</p>

<p>First, if you don’t have it installed yet on your local machine, get the <a href="https://oreil.ly/bEPS_">IGV program from the website</a> and follow the installation instructions. If you already have a copy, consider updating it to the latest version; we are using 2.7.2 (macOS version). Once you have the application open, choose View &gt; Preferences from the top menu bar, as shown in <a data-type="xref" href="#selecting_the_preferences_menu_itemdot">Figure 4-22</a>.</p>

<figure class="no-frame"><div id="selecting_the_preferences_menu_itemdot" class="figure"><img alt="Selecting the Preferences menu item." src="Images/gitc_0422.png" width="1350" height="512"/>
<h6><span class="label">Figure 4-22. </span>Selecting the Preferences menu item.</h6>
</div></figure>

<p>This opens the Preferences pane, shown in <a data-type="xref" href="#the_igv_preferences_panedot">Figure 4-23</a>.</p>

<p>In the Preferences pane, Select the “Enable Google access” checkbox, click Save, and then quit IGV and reopen it to force a refresh of the top menu bar. You should now see a Google menu item that was not there previously; click it and select Login, as shown in <a data-type="xref" href="#selecting_the_google_login_menu_itemdot">Figure 4-24</a>, to set up IGV with your Google account credentials.</p>

<figure class="no-frame"><div id="the_igv_preferences_panedot" class="figure"><img alt="The IGV Preferences pane." src="Images/gitc_0423.png" width="1289" height="974"/>
<h6><span class="label">Figure 4-23. </span>The IGV Preferences pane.</h6>
</div></figure>

<figure class="no-frame"><div id="selecting_the_google_login_menu_itemdot" class="figure"><img alt="Selecting the Google Login menu item." src="Images/gitc_0424.png" width="1482" height="224"/>
<h6><span class="label">Figure 4-24. </span>Selecting the Google Login menu item.</h6>
</div></figure>

<p>This will take you to a Google login page in your web browser; follow the prompts to allow IGV to access relevant permissions on your Google account. When this is complete, you should see a web page that simply says OK. Let’s switch back to IGV and test that it works. From the top-level menu, click Files &gt; Load from URL, as shown in <a data-type="xref" href="#the_quotload_from_urlquot_menu_itemdot">Figure 4-25</a>, making sure not to select one of the other options by mistake (they look similar, so it’s easy to get tripped up). Make sure also that the reference drop-down menu in the upper-left corner of the IGV window is set to “Human hg19.”</p>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you’re confused about what is different between the human references, see the notes in <a data-type="xref" href="ch02.xhtml#the_reference_genome_as_common_framewor">“The Reference Genome as Common Framework”</a> about hg19 and GRCh38.</p>
</div>

<figure class="no-frame"><div id="the_quotload_from_urlquot_menu_itemdot" class="figure"><img alt="The &quot;Load from URL&quot; menu item." src="Images/gitc_0425.png" width="1414" height="560"/>
<h6><span class="label">Figure 4-25. </span>The Load from URL menu item.</h6>
</div></figure>

<p>Finally, enter the GCS file path for one<a contenteditable="false" data-primary="BAMs (Binary Alignment Maps)" data-secondary="entering GCS file path to view in IGV" data-type="indexterm" id="idm45625633946056"/> of the sample BAM files we provide in the book data bundle in the dialog window that pops up (e.g., <em>mother.bam</em>, as shown in <a data-type="xref" href="#the_quotload_from_urlquot_dialog_boxdot">Figure 4-26</a>), and then click OK. Remember, you can get a list of files in the bucket by using <code>gsutil</code> from your VM or from Cloud Shell, or you can browse the contents of the bucket by using the <a href="https://oreil.ly/1iQmv">Google Cloud console storage browser</a>. If you use the browser interface to get the path to the file, you’ll need to compose the GCS file path by stripping off the first part of the URL before the bucket name; for instance, remove <em>https://console.cloud.google.com/storage/browser</em> and replace that with <code><strong>gs://</strong></code>. Do the same for the BAM’s accompanying index file, which should have the same filename and path but ends in <em>.bai</em>.<sup><a data-type="noteref" id="idm45625633939976-marker" href="ch04.xhtml#idm45625633939976">2</a></sup></p>

<figure class="no-frame"><div id="the_quotload_from_urlquot_dialog_boxdot" class="figure"><img alt="The &quot;Load from URL&quot; dialog box." src="Images/gitc_0426.png" width="1416" height="334"/>
<h6><span class="label">Figure 4-26. </span>The Load from URL dialog box.</h6>
</div></figure>

<p>This will make the data available to you in IGV as a new data track, but by default nothing will be loaded in the main viewer. To check that you can view data, in the search window, enter the genomic coordinates <code><strong>20:9,999,830-10,000,170</strong></code> and then click Go. These coordinates will take you to the 10 millionth DNA base ±170 on the 20th human chromosome, as shown in <a data-type="xref" href="#igv_view_of_a_bam_file_located_in_a_gcs">Figure 4-27</a>, where you’ll see the left-side edge of the slice of sequence data that we provide in this sample file. We explain in detail how to interpret the visual output of IGV in <a data-type="xref" href="ch05.xhtml#first_steps_with_gatk">Chapter 5</a>, when we use it to investigate the result of a real (small) analysis.</p>

<figure class="no-frame"><div id="igv_view_of_a_bam_file_located_in_a_gcs" class="figure"><img alt="IGV view of a BAM file located in a GCS bucket." src="Images/gitc_0427.png" width="1442" height="816"/>
<h6><span class="label">Figure 4-27. </span>IGV view of a BAM file located in a GCS bucket.</h6>
</div></figure>

<p>IGV retrieves only small slices of data at a time, so the transfer should be very fast unless you have a particularly slow internet connection. Do keep in mind, however, that GCP, like all commercial cloud providers, will charge an <a href="https://oreil.ly/rktm2">egress fee</a> for transferring data out of the cloud. On the bright side, it’s a small fee, proportional to the amount of data you transfer. So the cost of viewing slices of data in IGV is trivial—on the order of fractions of pennies—and it is definitely preferable to what it would cost to transfer the entire file for offline browsing!</p>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="who_pays_the_egress_feequestion_mark">
<h5>Who Pays the Egress Fee?</h5>

<p>By default, Google buckets are set<a contenteditable="false" data-primary="egress fees for GCS buckets" data-type="indexterm" id="idm45625633926984"/> up so that their owner pays any egress fees. However, it is possible to modify the bucket configuration to a setting called <code>requester-pays</code>, which means that the person requesting the data will be charged instead. To access data that resides in a bucket set to <code>requester-pays</code>, you would need to give IGV a Project ID (using the Google menu shown in <a data-type="xref" href="#selecting_the_google_login_menu_itemdot">Figure 4-24</a>) for billing purposes. You don’t need to do that in the context of this book, because the bucket we are using is hosted by the Broad Institute Data Sciences Platform, which is generously footing the bill for hosting the example data and covering any egress charges.</p>
</div></aside>

<p>You can view the contents of other <a contenteditable="false" data-primary="Variant Content Format (VCF) files" data-secondary="viewing in Integrated Genome Viewer" data-type="indexterm" id="idm45625633922616"/>data files, like VCF files, using the same set of operations, as long as the files are stored in a GCP bucket. Unfortunately, it means that this won’t work for files that are on the local storage of your VM, so anytime you want to examine one of those, you’ll need to copy it to a bucket first. You’re going to get really friendly with <code>gsutil</code> in no time.</p>

<p>Oh, one last thing while you have IGV open: click the little yellow callout bubble in the IGV window toolbar, which controls the behavior of the detail viewer, as shown in <a data-type="xref" href="#changing_the_behavior_of_the_detail_vie">Figure 4-28</a>. Do yourself a favor and switch the setting from Show Details on Hover to Show Details on Click. Whichever action you choose will trigger the appearance of little dialog that gives you detailed information about any part of the data that you either click or hover over; for example, for a sequence read, it will give you all the mapping information as well as the full sequence and base qualities. You can try it out now with the data you just loaded. As you’ll see, the detail display functionality in and of itself is very convenient, but the “on Hover” version of this behavior can be a bit overwhelming when you’re new to the interface; hence, our recommendation to switch to “on Click.”</p>

<figure class="no-frame"><div id="changing_the_behavior_of_the_detail_vie" class="figure"><img alt="Changing the behavior of the detail viewer from &quot;on Hover&quot; to &quot;on Click.&quot;" src="Images/gitc_0428.png" width="1054" height="176"/>
<h6><span class="label">Figure 4-28. </span>Changing the behavior of the detail viewer from “on Hover” to “on Click.”</h6>
</div></figure>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Wrap-Up and Next Steps"><div class="sect1" id="wrap_up_and_next_ste">
<h1>Wrap-Up and Next Steps</h1>

<p>In this chapter, we <a contenteditable="false" data-primary="Google Cloud Storage (GCS)" data-secondary="configuring IGV ro read data from buckets" data-startref="ix_GCScfg" data-type="indexterm" id="idm45625633914296"/>showed<a contenteditable="false" data-primary="IGV (Integrated Genome Viewer)" data-secondary="configuring to read data from GCS buckets" data-startref="ix_IGVcfg" data-type="indexterm" id="idm45625633912424"/> you how to get <a contenteditable="false" data-primary="cloud computing" data-secondary="getting started" data-startref="ix_cldstrtcfgIGV" data-tertiary="configuring integrated genome viewer to read data from GCS buckets" data-type="indexterm" id="idm45625633910568"/>started with GCP <a contenteditable="false" data-primary="storage buckets" data-secondary="configuring IGV to read data from GCS buckets" data-startref="ix_stbcktcfgIGV" data-type="indexterm" id="idm45625633908440"/>resources, from creating an account, using the super-basic Cloud Shell, and then graduating to your own custom VM. You learned how to manage files in GCS, run Docker containers, and administer your VM. Finally, you retrieved the book data and source code, finished setting up your custom VM to work with the GATK container, and set up IGV to view data stored in buckets. In <a data-type="xref" href="ch05.xhtml#first_steps_with_gatk">Chapter 5</a>, we get you started with GATK itself, and before you know it, you’ll be running real genomics tools on example data in the cloud.<a contenteditable="false" data-primary="cloud computing" data-secondary="getting started" data-startref="ix_cldstrt" data-type="indexterm" id="idm45625633905112"/></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="ch04fn1"><sup><a href="ch04.xhtml#ch04fn1-marker">1</a></sup> Keep in mind that if you create accounts for other users in your GCP project, they will be able to SSH to your VMs as well. It is possible to further restrict access to your VMs in a shared project, but that is beyond the simple introduction we’re presenting here.</p><p data-type="footnote" id="idm45625633939976"><sup><a href="ch04.xhtml#idm45625633939976-marker">2</a></sup> For example, <em>https://console.cloud.google.com/storage/browser/genomics-in-the-cloud/v1/data/germline/bams/mother.bam</em> becomes <em>gs://genomics-in-the-cloud/v1/data/germline/bams/mother.bam</em>.</p></div></div></section></div>



  </body></html>