<html><head></head><body><section data-pdf-bookmark="Chapter 10. Working with Files" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_files">&#13;
<h1><span class="label">Chapter 10. </span>Working with Files</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Introduction" data-type="sect1"><div class="sect1" id="id130">&#13;
<h1>Introduction</h1>&#13;
&#13;
<p><a data-primary="files, working with" data-type="indexterm" id="ix_10-working-with-files-asciidoc0"/>Reading <a data-primary="files, working with" data-secondary="basics" data-type="indexterm" id="id1006"/>and writing files are part of many applications. In the past, you couldn’t really work with local files within the browser. To read data, you’d upload a file to a backend server, which would process it and return data to the browser.</p>&#13;
&#13;
<p>To write data, the server would send a downloadable file. Without browser plug-ins, there wasn’t a way to work directly with files.</p>&#13;
&#13;
<p>Today, browsers have first-class support for reading and writing files. The <code>file</code> input type opens a file chooser and provides data about the selected file. You can also limit the supported files to specific extensions or MIME types. From there, the File API can read the contents of the file into memory.</p>&#13;
&#13;
<p>Taking it a step further, the File System API enables your JavaScript code to interact directly with the local filesystem, without needing a file input to select a file first (though, depending on settings, the user may need to grant permission!).</p>&#13;
&#13;
<p>You can use these APIs to create text editors, image viewers, audio or video players, and more.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Loading Text from a File" data-type="sect1"><div class="sect1" id="id520">&#13;
<h1>Loading Text from a File</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id293">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="files, working with" data-secondary="loading text from" data-type="indexterm" id="ix_10-working-with-files-asciidoc1"/>You want to load some text data from the user’s local filesystem.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id131">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use an <code>&lt;input type="file"&gt;</code> to select the file (see <a data-type="xref" href="#example10-1">Example 10-1</a>).</p>&#13;
<div data-type="example" id="example10-1">&#13;
<h5><span class="label">Example 10-1. </span>A file input</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"file"</code> <code class="na">id</code><code class="o">=</code><code class="s">"select-file"</code><code class="p">&gt;</code></pre></div>&#13;
&#13;
<p>When you click on the file input, the browser will show a dialog where you can browse files and folders on the local system. The exact dialog shown will depend on the browser and operating system version. Navigate to, and select, the desired file. <a data-primary="FileReader object" data-type="indexterm" id="ix_10-working-with-files-asciidoc2"/>One you have a selected file, use a <code>FileReader</code> as shown in <a data-type="xref" href="#code_loadPlainText">Example 10-2</a> to read the file’s text content.</p>&#13;
<div data-type="example" id="code_loadPlainText">&#13;
<h5><span class="label">Example 10-2. </span>Loading plain text from a file</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Reads the text content of a file.</code>&#13;
<code class="cm"> * @param file The File object containing the data to be read</code>&#13;
<code class="cm"> * @param onSuccess A function to call when the data is available</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">readFileContent</code><code class="p">(</code><code class="nx">file</code><code class="p">,</code> <code class="nx">onSuccess</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">reader</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">FileReader</code><code class="p">();</code>&#13;
&#13;
  <code class="c1">// When the content is loaded, the reader will emit a</code>&#13;
  <code class="c1">// 'load' event.</code>&#13;
  <code class="nx">reader</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'load'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">onSuccess</code><code class="p">(</code><code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// Always handle errors!</code>&#13;
  <code class="nx">reader</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error reading file:'</code><code class="p">,</code> <code class="nx">event</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// Start the file read operation.</code>&#13;
  <code class="nx">reader</code><code class="p">.</code><code class="nx">readAsText</code><code class="p">(</code><code class="nx">file</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">fileInput</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#select-file'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// The input fires a 'change' event when a file is selected.</code>&#13;
<code class="nx">fileInput</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'change'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// This is an array, because a file input can be used to select</code>&#13;
  <code class="c1">// multiple files. Here, there's only once file selected.</code>&#13;
  <code class="c1">// This is using array destructuring syntax to get the first file.</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">file</code><code class="p">]</code> <code class="o">=</code> <code class="nx">fileInput</code><code class="p">.</code><code class="nx">files</code><code class="p">;</code>&#13;
&#13;
  <code class="nx">readFileContent</code><code class="p">(</code><code class="nx">file</code><code class="p">,</code> <code class="nx">content</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="c1">// The file's text content is now available.</code>&#13;
    <code class="c1">// Imagine you have a textarea element you want to set the text in.</code>&#13;
    <code class="kr">const</code> <code class="nx">textArea</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'.file-content-textarea'</code><code class="p">);</code>&#13;
    <code class="nx">textArea</code><code class="p">.</code><code class="nx">textContent</code> <code class="o">=</code> <code class="nx">content</code><code class="p">;</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id132">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>A <code>FileReader</code> is an object that reads files asynchronously. It can read a file’s content in several different ways, depending on the type of file. <a data-type="xref" href="#code_loadPlainText">Example 10-2</a> uses the <code>readAsText</code> method, which retrieves the file content as plain text.</p>&#13;
&#13;
<p>If you have a binary file, such as a ZIP archive or image, you can use <code>readAsBinaryString</code>. An image can be read as a data URL with Base64-encoded image data using <code>readAsDataURL</code>, which you’ll see in <a data-type="xref" href="#recipe_loadImage">“Loading an Image as a Data URL”</a>.</p>&#13;
&#13;
<p>This API is event based, so the <code>readFileContent</code> function takes a callback function that is called with the content when it’s ready.</p>&#13;
&#13;
<p>You could also wrap this with a <code>Promise</code> to make a <code>Promise</code>-based API, as shown in <a data-type="xref" href="#example10-3">Example 10-3</a>.</p>&#13;
<div data-type="example" id="example10-3">&#13;
<h5><span class="label">Example 10-3. </span>Promisified <code>readFileContent</code> function</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">readFileContent</code><code class="p">(</code><code class="nx">file</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">reader</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">FileReader</code><code class="p">();</code>&#13;
&#13;
  <code class="k">return</code> <code class="k">new</code> <code class="nb">Promise</code><code class="p">((</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">reader</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'load'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="nx">resolve</code><code class="p">(</code><code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="nx">reader</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="nx">reject</code><code class="p">);</code>&#13;
&#13;
    <code class="nx">reader</code><code class="p">.</code><code class="nx">readAsText</code><code class="p">(</code><code class="nx">file</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">try</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">content</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">readFileContent</code><code class="p">(</code><code class="nx">inputFile</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="nx">textArea</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'.file-content-textarea'</code><code class="p">);</code>&#13;
  <code class="nx">textArea</code><code class="p">.</code><code class="nx">textContent</code> <code class="o">=</code> <code class="nx">content</code><code class="p">;</code>&#13;
<code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error reading file content:'</code><code class="p">,</code> <code class="nx">error</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Once you have the text content, you can add it to the page in several ways. You could set it as the <code>textContent</code> of a DOM node, or you could even load it into a <code>textarea</code> to make the content editable<a data-startref="ix_10-working-with-files-asciidoc2" data-type="indexterm" id="id1007"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Loading an Image as a Data URL" data-type="sect1"><div class="sect1" id="recipe_loadImage">&#13;
<h1>Loading an Image as a Data URL</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id294">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="data URL" data-secondary="loading an image as" data-type="indexterm" id="ix_10-working-with-files-asciidoc3"/><a data-primary="files, working with" data-secondary="loading an image as a data URL" data-type="indexterm" id="ix_10-working-with-files-asciidoc4"/><a data-primary="images" data-secondary="loading as data URL" data-type="indexterm" id="ix_10-working-with-files-asciidoc5"/>You want to let the user select a local image file, then display that image on the page.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id522">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the <code>readAsDataURL</code> method of <code>FileReader</code> to get a Base64-encoded data URL, then set that as the <code>src</code> attribute of an <code>img</code> tag (see Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#example10-4">10-4</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#example10-5">10-5</a>).</p>&#13;
<div data-type="example" id="example10-4">&#13;
<h5><span class="label">Example 10-4. </span>File input and image placeholder</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">input</code><code>&#13;
  </code><code class="na">type</code><code class="o">=</code><code class="s">"file"</code><code>&#13;
  </code><code class="na">id</code><code class="o">=</code><code class="s">"select-file"</code><code>&#13;
  </code><code class="na">accept</code><code class="o">=</code><code class="s">"image/*"</code><code> </code><a class="co" href="#callout_working_with_files_CO1-1" id="co_working_with_files_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="p">&gt;</code><code>&#13;
</code><code class="p">&lt;</code><code class="nt">img</code><code> </code><code class="na">id</code><code class="o">=</code><code class="s">"placeholder-image"</code><code class="p">&gt;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_files_CO1-1" id="callout_working_with_files_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Restricts the file chooser to only allow images to be selected. A wildcard pattern is used here, but you can also specify an exact MIME type such as <code>image/png</code>.</p></dd>&#13;
</dl></div>&#13;
<div data-type="example" id="example10-5">&#13;
<h5><span class="label">Example 10-5. </span>Loading an image into the page</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Loads and shows an image from a file.</code>&#13;
<code class="cm"> * @param file The File object containing the image data</code>&#13;
<code class="cm"> * @param imageElement A placeholder Image element that will</code>&#13;
<code class="cm"> *                     show the image data</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">showImageFile</code><code class="p">(</code><code class="nx">file</code><code class="p">,</code> <code class="nx">imageElement</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">reader</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">FileReader</code><code class="p">();</code>&#13;
&#13;
  <code class="nx">reader</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'load'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="c1">// Set the data URL directly as the image's</code>&#13;
    <code class="c1">// src attribute to load the image.</code>&#13;
    <code class="nx">imageElement</code><code class="p">.</code><code class="nx">src</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">reader</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="nx">event</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">reader</code><code class="p">.</code><code class="nx">readAsDataURL</code><code class="p">(</code><code class="nx">file</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">fileInput</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#select-file'</code><code class="p">);</code>&#13;
<code class="nx">fileInput</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'change'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">showImageFile</code><code class="p">(</code>&#13;
    <code class="nx">fileInput</code><code class="p">.</code><code class="nx">files</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code>&#13;
    <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#placeholder-image'</code><code class="p">)</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id133">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>A data URL has the <code>data</code> URL scheme. It specifies the data’s MIME type, then the image data is included in Base64-encoded format:</p>&#13;
&#13;
<pre data-type="programlisting">data:image/png;base64,UHJldGVuZCB0aGlzIGlzIGltYWdlIGRhdGE=</pre>&#13;
&#13;
<p>When the <code>FileReader</code> returns the image encoded as a data URL, the data URL is set as the image element’s <code>src</code> attribute. This renders the image in the page.</p>&#13;
&#13;
<p>It’s important to note that this is all being done locally in the user’s browser. Nothing is being uploaded to a remote server, as the File API works on the local filesystem.</p>&#13;
&#13;
<p><a data-type="xref" href="ch04.html#recipe_uploadFetch">“Uploading a File with the Fetch API”</a> in <a data-type="xref" href="ch04.html#ch_network">Chapter 4</a> shows an example of using an <code>&lt;input type="file"&gt;</code> to upload file data to a remote server, though this uses the FormData API instead of the File API.<a data-startref="ix_10-working-with-files-asciidoc5" data-type="indexterm" id="id1008"/></p>&#13;
&#13;
<p>For more details about data URLs and Base64 encoding, see <a href="https://oreil.ly/kMtDy">this article from MDN</a><a data-startref="ix_10-working-with-files-asciidoc4" data-type="indexterm" id="id1009"/><a data-startref="ix_10-working-with-files-asciidoc3" data-type="indexterm" id="id1010"/><a data-startref="ix_10-working-with-files-asciidoc1" data-type="indexterm" id="id1011"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Loading a Video as an Object URL" data-type="sect1"><div class="sect1" id="id523">&#13;
<h1>Loading a Video as an Object URL</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id295">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="files, working with" data-secondary="loading a video as an object URL" data-type="indexterm" id="ix_10-working-with-files-asciidoc6"/><a data-primary="object URL" data-secondary="loading video as" data-type="indexterm" id="ix_10-working-with-files-asciidoc7"/><a data-primary="videos" data-secondary="loading as object URL" data-type="indexterm" id="ix_10-working-with-files-asciidoc8"/>You want the user to select a video file, then play it in the browser.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id524">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Create an object URL for the <code>File</code> object, and set it as the <code>src</code> attribute of a <code>&lt;video&gt;</code> element.</p>&#13;
&#13;
<p>First, you’ll need a <code>&lt;video&gt;</code> element and an <code>&lt;input type="file"&gt;</code> to select the video file (see <a data-type="xref" href="#example10-6">Example 10-6</a>).</p>&#13;
<div data-type="example" id="example10-6">&#13;
<h5><span class="label">Example 10-6. </span>The video player markup</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">input</code><code>&#13;
  </code><code class="na">id</code><code class="o">=</code><code class="s">"file-upload"</code><code>&#13;
  </code><code class="na">type</code><code class="o">=</code><code class="s">"file"</code><code>&#13;
  </code><code class="na">accept</code><code class="o">=</code><code class="s">"video/*"</code><code> </code><a class="co" href="#callout_working_with_files_CO2-1" id="co_working_with_files_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="p">&gt;</code><code>&#13;
&#13;
</code><code class="p">&lt;</code><code class="nt">video</code><code>&#13;
  </code><code class="na">id</code><code class="o">=</code><code class="s">"video-player"</code><code>&#13;
  </code><code class="na">controls</code><code> </code><a class="co" href="#callout_working_with_files_CO2-2" id="co_working_with_files_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="p">&gt;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_files_CO2-1" id="callout_working_with_files_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Only allows the selection of video files</p></dd>&#13;
<dt><a class="co" href="#co_working_with_files_CO2-2" id="callout_working_with_files_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Tells the browser to include playback controls</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Next, listen for the file input’s <code>change</code> event and create an object URL, as shown in <a data-type="xref" href="#example10-7">Example 10-7</a>.</p>&#13;
<div data-type="example" id="example10-7">&#13;
<h5><span class="label">Example 10-7. </span>Playing the video file</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">fileInput</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#file-upload'</code><code class="p">);</code>&#13;
<code class="kr">const</code> <code class="nx">video</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#video-player'</code><code class="p">);</code>&#13;
&#13;
<code class="nx">fileInput</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'change'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">file</code><code class="p">]</code> <code class="o">=</code> <code class="nx">fileInput</code><code class="p">.</code><code class="nx">files</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// File extends from Blob, which can be passed to</code>&#13;
  <code class="c1">// createObjectURL.</code>&#13;
  <code class="kr">const</code> <code class="nx">objectUrl</code> <code class="o">=</code> <code class="nx">URL</code><code class="p">.</code><code class="nx">createObjectURL</code><code class="p">(</code><code class="nx">file</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// The &lt;video&gt; element can take the object URL to load the video.</code>&#13;
  <code class="nx">video</code><code class="p">.</code><code class="nx">src</code> <code class="o">=</code> <code class="nx">objectUrl</code><code class="p">;</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id134">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>An object URL is a special URL that refers to the file content. You can do this without a <code>FileReader</code>, since the file itself has a <code>createObjectURL</code> method. This URL can be passed to the <code>&lt;video&gt;</code> element.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1012">&#13;
<h1>Data URLs and Object URLs</h1>&#13;
<p><a data-primary="data URL" data-secondary="object URL versus" data-type="indexterm" id="id1013"/><a data-primary="object URL" data-secondary="data URL versus" data-type="indexterm" id="id1014"/>There are some important differences between data and object URLs.</p>&#13;
&#13;
<p>A data URL contains the data <em>within the URL</em>. The data (usually binary) is encoded in Base64 format and is appended to the URL itself.</p>&#13;
&#13;
<p>An object URL represents some data that has been loaded into the browser’s memory, usually Blobs and Files. It doesn’t contain the data itself in the URL, but is a reference to the actual data. When you’re done using it, an object URL can be revoked to prevent memory leaks<a data-startref="ix_10-working-with-files-asciidoc8" data-type="indexterm" id="id1015"/><a data-startref="ix_10-working-with-files-asciidoc7" data-type="indexterm" id="id1016"/><a data-startref="ix_10-working-with-files-asciidoc6" data-type="indexterm" id="id1017"/>.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Loading an Image with Drag and Drop" data-type="sect1"><div class="sect1" id="id525">&#13;
<h1>Loading an Image with Drag and Drop</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id296">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="drag and drop" data-secondary="loading images with" data-type="indexterm" id="ix_10-working-with-files-asciidoc9"/><a data-primary="files, working with" data-secondary="loading an image with drag and drop" data-type="indexterm" id="ix_10-working-with-files-asciidoc10"/><a data-primary="images" data-secondary="loading with drag and drop" data-type="indexterm" id="ix_10-working-with-files-asciidoc11"/>You want to be able to drag an image file into the browser window and display that image on the page when it is dropped.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id526">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Define an element to serve as the drop area, and a placeholder image element (see <a data-type="xref" href="#example10-8">Example 10-8</a>).</p>&#13;
<div data-type="example" id="example10-8">&#13;
<h5><span class="label">Example 10-8. </span>The drop target and image elements</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">label</code> <code class="na">id</code><code class="o">=</code><code class="s">"drop-target"</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;</code><code class="nt">div</code><code class="p">&gt;</code>Drag and drop an image here<code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>&#13;
  <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"file"</code> <code class="na">id</code><code class="o">=</code><code class="s">"file-input"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">img</code> <code class="na">id</code><code class="o">=</code><code class="s">"placeholder"</code><code class="p">&gt;</code></pre></div>&#13;
&#13;
<p>Note that this example still includes a file <code>input</code>. This is so that those using assistive technologies can also upload an image without having to attempt a drag and drop operation. Because the drop target is a label, containing the file input, you can click anywhere inside the drop target to open the file chooser.</p>&#13;
&#13;
<p>First, create a function that receives the image file and reads it as a data URL (see <a data-type="xref" href="#example10-9">Example 10-9</a>).</p>&#13;
<div data-type="example" id="example10-9">&#13;
<h5><span class="label">Example 10-9. </span>Reading the dropped file</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">showDroppedFile</code><code class="p">(</code><code class="nx">file</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="c1">// Read the file data and insert the loaded image</code>&#13;
  <code class="c1">// into the page.</code>&#13;
  <code class="kr">const</code> <code class="nx">reader</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">FileReader</code><code class="p">();</code>&#13;
  <code class="nx">reader</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'load'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">image</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#placeholder'</code><code class="p">);</code>&#13;
    <code class="nx">image</code><code class="p">.</code><code class="nx">src</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">reader</code><code class="p">.</code><code class="nx">readAsDataURL</code><code class="p">(</code><code class="nx">file</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Next, create handler functions for the <code>dragover</code> and <code>drop</code> events. These events are attached to the drop target element (see <a data-type="xref" href="#example10-10">Example 10-10</a>).</p>&#13;
<div data-type="example" id="example10-10">&#13;
<h5><span class="label">Example 10-10. </span>Adding the drag and drop code</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">target</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#drop-target'</code><code class="p">);</code>&#13;
<code class="nx">target</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'drop'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// Cancel the drop event. Otherwise, the browser will leave the page</code>&#13;
  <code class="c1">// and navigate to the file directly.</code>&#13;
  <code class="nx">event</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>&#13;
&#13;
  <code class="c1">// Get the selected file data. dataTransfer.items is a</code>&#13;
  <code class="c1">// DataTransferItemList. Each item in the list, a DataTransferItem, has data</code>&#13;
  <code class="c1">// about an item being dropped. As this example only deals with a single file, it</code>&#13;
  <code class="c1">// gets the first item in the list.</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">item</code><code class="p">]</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">dataTransfer</code><code class="p">.</code><code class="nx">items</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// Get the dropped data as a File object.</code>&#13;
  <code class="kr">const</code> <code class="nx">file</code> <code class="o">=</code> <code class="nx">item</code><code class="p">.</code><code class="nx">getAsFile</code><code class="p">();</code>&#13;
&#13;
  <code class="c1">// Only proceed if an image file was dropped.</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">file</code><code class="p">.</code><code class="nx">type</code><code class="p">.</code><code class="nx">startsWith</code><code class="p">(</code><code class="s1">'image/'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="nx">showDroppedFile</code><code class="p">(</code><code class="nx">file</code><code class="p">);</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// You need to cancel the dragover event as well to prevent the</code>&#13;
<code class="c1">// file from replacing the full page content.</code>&#13;
<code class="nx">target</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'dragover'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">event</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Finally, make sure to wire up the fallback file input. You just need to get the selected file, then pass it to the <code>showDroppedFile</code> method to provide the same result (see <a data-type="xref" href="#example10-11">Example 10-11</a>).</p>&#13;
<div data-type="example" id="example10-11">&#13;
<h5><span class="label">Example 10-11. </span>Handling the file input</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">fileInput</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#file-input'</code><code class="p">);</code>&#13;
<code class="nx">fileInput</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'change'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">file</code><code class="p">]</code> <code class="o">=</code> <code class="nx">fileInput</code><code class="p">.</code><code class="nx">files</code><code class="p">;</code>&#13;
  <code class="nx">showDroppedFile</code><code class="p">(</code><code class="nx">file</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id135">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>By default, when you drag an image into a page, the browser navigates away from the current page. The URL changes to the path of the file, and the image is shown in the browser window. In this example, you instead want to load the image data into an <code>&lt;img&gt;</code> element and stay on the current page.</p>&#13;
&#13;
<p>To prevent the default behavior, the drop handler calls <code>preventDefault</code> on the drop event. To fully prevent the behavior, you also need to call <code>preventDefault</code> on the <code>dragover</code> event, which is why you need the second event listener. This makes it so that the element can actually receive <code>drop</code> events<a data-startref="ix_10-working-with-files-asciidoc11" data-type="indexterm" id="id1018"/><a data-startref="ix_10-working-with-files-asciidoc10" data-type="indexterm" id="id1019"/><a data-startref="ix_10-working-with-files-asciidoc9" data-type="indexterm" id="id1020"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Checking and Requesting Permissions" data-type="sect1"><div class="sect1" id="id527">&#13;
<h1>Checking and Requesting Permissions</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id136">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="files, working with" data-secondary="checking and requesting permissions" data-type="indexterm" id="ix_10-working-with-files-asciidoc12"/><a data-primary="permissions, checking/requesting" data-type="indexterm" id="ix_10-working-with-files-asciidoc13"/>You want to check—and request if necessary—permissions to access a file on the local filesystem.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id137">&#13;
<h2>Solution</h2>&#13;
&#13;
<p><a data-primary="queryPermission function" data-type="indexterm" id="ix_10-working-with-files-asciidoc14"/>Show a file picker, and when a file is selected, call <code>queryPermission</code> to check for existing permission. If the permission check returns <code>prompt</code>, call <code>requestPermission</code> to show a permission request (see <a data-type="xref" href="#example10-12">Example 10-12</a>).</p>&#13;
<div data-type="example" id="example10-12">&#13;
<h5><span class="label">Example 10-12. </span>Selecting and checking permissions for a file</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Selects a file, then checks permissions, showing a request if necessary,</code>&#13;
<code class="cm"> * for a file.</code>&#13;
<code class="cm"> * @return true if the file can be written to, false otherwise</code>&#13;
<code class="cm"> */</code>&#13;
<code class="nx">async</code> <code class="kd">function</code> <code class="nx">canAccessFile</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="s1">'showOpenFilePicker'</code> <code class="k">in</code> <code class="nb">window</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// showOpenFilePicker can select multiple files, just</code>&#13;
    <code class="c1">// get the first one (with array destructuring).</code>&#13;
    <code class="kr">const</code> <code class="p">[</code><code class="nx">file</code><code class="p">]</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">showOpenFilePicker</code><code class="p">();</code>&#13;
&#13;
    <code class="kd">let</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">file</code><code class="p">.</code><code class="nx">queryPermission</code><code class="p">({</code> <code class="nx">mode</code><code class="o">:</code> <code class="s1">'readwrite'</code> <code class="p">});</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">result</code> <code class="o">===</code> <code class="s1">'prompt'</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="nx">result</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">file</code><code class="p">.</code><code class="nx">requestPermission</code><code class="p">({</code> <code class="nx">mode</code><code class="o">:</code> <code class="s1">'readwrite'</code> <code class="p">});</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">result</code> <code class="o">===</code> <code class="s1">'granted'</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="c1">// If you get here, it means the API isn't supported.</code>&#13;
  <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>&#13;
<code class="p">}</code></pre></div>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>This API may not be supported by all browsers yet. See <a href="https://oreil.ly/AfNpL">CanIUse</a> for the latest compatibility data.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id138">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The <code>queryPermission</code> function returns either <code>granted</code> (the permission was previously granted), <code>denied</code> (access is denied), or <code>prompt</code> (need to ask for permission).</p>&#13;
&#13;
<p>The requested mode is <code>readwrite</code>, which means the browser is able to write to your local filesystem if you grant the permission. This is why the permission check is important from a security and privacy perspective.</p>&#13;
&#13;
<p><code>queryPermission</code> checks the permission only and does not show a prompt. If this comes back as <code>prompt</code>, you can then call <code>requestPermission</code>, which shows a permission request in the browser. The file is considered writable if either call returns <a data-startref="ix_10-working-with-files-asciidoc14" data-type="indexterm" id="id1021"/><a data-startref="ix_10-working-with-files-asciidoc13" data-type="indexterm" id="id1022"/><a data-startref="ix_10-working-with-files-asciidoc12" data-type="indexterm" id="id1023"/>&#13;
<span class="keep-together"><code>granted</code>.</span></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Exporting API Data to a File" data-type="sect1"><div class="sect1" id="recipe_fileExport">&#13;
<h1>Exporting API Data to a File</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id297">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="API data" data-secondary="exporting to files" data-type="indexterm" id="ix_10-working-with-files-asciidoc15"/><a data-primary="files, working with" data-secondary="exporting API data to" data-type="indexterm" id="ix_10-working-with-files-asciidoc16"/>You are requesting JSON data from an API, and you want to give the user an option to download the raw JSON data.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id529">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Let the user select an output file, then write the JSON data to the local filesystem.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>This API may not be supported by all browsers yet. See <a href="https://oreil.ly/tsT_j">CanIUse</a> for the latest compatibility data.</p>&#13;
</div>&#13;
&#13;
<p>First, define a helper function that shows the file picker and returns the file that was selected (see <a data-type="xref" href="#example10-13">Example 10-13</a>).</p>&#13;
<div data-type="example" id="example10-13">&#13;
<h5><span class="label">Example 10-13. </span>Selecting an output file</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Shows a save file picker and returns the selected file handle.</code>&#13;
<code class="cm"> * @returns a file handle to the selected file, or null if the user clicked Cancel.</code>&#13;
<code class="cm"> */</code>&#13;
<code class="nx">async</code> <code class="kd">function</code> <code class="nx">selectOutputFile</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="c1">// Check to make sure the API is supported in this browser.</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="p">(</code><code class="s1">'showSaveFilePicker'</code> <code class="k">in</code> <code class="nb">window</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="kc">null</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">try</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nb">window</code><code class="p">.</code><code class="nx">showSaveFilePicker</code><code class="p">({</code>&#13;
      <code class="c1">// The default name for the output file</code>&#13;
      <code class="nx">suggestedName</code><code class="o">:</code> <code class="s1">'users.json'</code><code class="p">,</code>&#13;
&#13;
      <code class="c1">// Limit the available file extensions.</code>&#13;
      <code class="nx">types</code><code class="o">:</code> <code class="p">[</code>&#13;
        <code class="p">{</code> <code class="nx">description</code><code class="o">:</code> <code class="s2">"JSON"</code><code class="p">,</code> <code class="nx">accept</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"application/json"</code><code class="o">:</code> <code class="p">[</code><code class="s2">".json"</code><code class="p">]</code> <code class="p">}</code> <code class="p">}</code>&#13;
      <code class="p">]</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// If the user clicks Cancel, an exception is thrown. In this case,</code>&#13;
    <code class="c1">// return null to indicate no file was selected.</code>&#13;
    <code class="k">return</code> <code class="kc">null</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Next, define a function that uses this helper, and perform the actual export (see <a data-type="xref" href="#example10-14">Example 10-14</a>).</p>&#13;
<div data-type="example" id="example10-14">&#13;
<h5><span class="label">Example 10-14. </span>Exporting data to a local file</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">async</code> <code class="kd">function</code> <code class="nx">exportData</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="c1">// Use the helper function defined previously.</code>&#13;
  <code class="kr">const</code> <code class="nx">outputFile</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">selectOutputFile</code><code class="p">();</code>&#13;
&#13;
  <code class="c1">// Only proceed if an output file was actually selected.</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">outputFile</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">try</code> <code class="p">{</code>&#13;
      <code class="c1">// Prepare a writable stream, which is used to save the file</code>&#13;
      <code class="c1">// to disk.</code>&#13;
      <code class="kr">const</code> <code class="nx">stream</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">outputFile</code><code class="p">.</code><code class="nx">createWritable</code><code class="p">();</code>&#13;
&#13;
      <code class="c1">// Write the JSON t the stream in a human-readable format.</code>&#13;
      <code class="nx">await</code> <code class="nx">stream</code><code class="p">.</code><code class="nx">write</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">userList</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">2</code><code class="p">));</code>&#13;
      <code class="nx">await</code> <code class="nx">stream</code><code class="p">.</code><code class="nx">close</code><code class="p">();</code>&#13;
&#13;
      <code class="c1">// Show a success message.</code>&#13;
      <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#export-success'</code><code class="p">).</code><code class="nx">classList</code><code class="p">.</code><code class="nx">remove</code><code class="p">(</code><code class="s1">'d-none'</code><code class="p">);</code>&#13;
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id139">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>This is a good approach for allowing a user to back up or export their data from your app. Some regulations, like the General Data Protection Regulation (GDPR) in the European Union, require you to make a user’s data available for download.</p>&#13;
&#13;
<p>In this case, text data is being written to the stream, which is of type <code>FileSystem</code> &#13;
<span class="keep-together"><code>WritableFileStream</code>.</span> These streams also support writing <code>ArrayBuffer</code>, <code>TypedArray</code>, <code>DataView</code>, and <code>Blob</code> objects.</p>&#13;
&#13;
<p>In order to create the text to write to the file, <code>exportData</code> is calling <code>JSON.stringify</code> with some extra arguments. The second <code>null</code> argument is the <code>replacer</code> function, which you saw in <a data-type="xref" href="ch02.html#ch_webStorage">Chapter 2</a>. This argument has to be provided in order to provide the third argument, which specifies the amount of indentation whitespace to apply. This creates a more readable output format.</p>&#13;
&#13;
<p>At the time of writing, this API is still considered experimental. You should avoid using it in a production application until it has better browser support<a data-startref="ix_10-working-with-files-asciidoc16" data-type="indexterm" id="id1024"/><a data-startref="ix_10-working-with-files-asciidoc15" data-type="indexterm" id="id1025"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Exporting API Data with a Download Link" data-type="sect1"><div class="sect1" id="id530">&#13;
<h1>Exporting API Data with a Download Link</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id298">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="API data" data-secondary="exporting with download link" data-type="indexterm" id="ix_10-working-with-files-asciidoc17"/><a data-primary="files, working with" data-secondary="exporting API data with a download link" data-type="indexterm" id="ix_10-working-with-files-asciidoc18"/>You want to provide export functionality but don’t want to worry about filesystem permissions, like in <a data-type="xref" href="#recipe_fileExport">“Exporting API Data to a File”</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id140">&#13;
<h2>Solution</h2>&#13;
&#13;
<p><a data-primary="Blob object" data-type="indexterm" id="ix_10-working-with-files-asciidoc19"/>Put the API data into a <code>Blob</code> object, and create an object URL to set as a link’s <code>href</code> attribute. Then you can export the data with a normal browser file download, without needing filesystem permissions.</p>&#13;
&#13;
<p>First, add a placeholder link to the page, which becomes the export link (see <a data-type="xref" href="#example10-15">Example 10-15</a>).</p>&#13;
<div data-type="example" id="example10-15">&#13;
<h5><span class="label">Example 10-15. </span>The placeholder export link</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">a</code><code> </code><code class="na">id</code><code class="o">=</code><code class="s">"export-link"</code><code> </code><code class="na">download</code><code class="o">=</code><code class="s">"users.json"</code><code class="p">&gt;</code><code>Export User Data</code><code class="p">&lt;</code><code class="p">/</code><code class="nt">a</code><code class="p">&gt;</code><code> </code><a class="co" href="#callout_working_with_files_CO3-1" id="co_working_with_files_CO3-1"><img alt="1" src="assets/1.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_working_with_files_CO3-1" id="callout_working_with_files_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The <code>download</code> attribute provides a default filename to use when downloading.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>After you fetch the data from the API and render it in the UI, create the <code>Blob</code> and object URL (see <a data-type="xref" href="#example10-16">Example 10-16</a>).</p>&#13;
<div data-type="example" id="example10-16">&#13;
<h5><span class="label">Example 10-16. </span>Preparing the export link</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">exportLink</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#export-link'</code><code class="p">);</code>&#13;
&#13;
<code class="nx">async</code> <code class="kd">function</code> <code class="nx">getUserData</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="s1">'/api/users'</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="nx">users</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">response</code><code class="p">.</code><code class="nx">json</code><code class="p">();</code>&#13;
&#13;
  <code class="c1">// Render the user data in the UI, assuming that you</code>&#13;
  <code class="c1">// have a renderUsers function somewhere that does this.</code>&#13;
  <code class="nx">renderUsers</code><code class="p">(</code><code class="nx">users</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// Clean up the previous export data, if it exists.</code>&#13;
  <code class="kr">const</code> <code class="nx">currentUrl</code> <code class="o">=</code> <code class="nx">exportLink</code><code class="p">.</code><code class="nx">href</code><code class="p">;</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">currentUrl</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">URL</code><code class="p">.</code><code class="nx">revokeObjectURL</code><code class="p">(</code><code class="nx">currentUrl</code><code class="p">);</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="c1">// Need a Blob for creating an object URL</code>&#13;
  <code class="kr">const</code> <code class="nx">blob</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Blob</code><code class="p">([</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">userList</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">2</code><code class="p">)],</code> <code class="p">{</code>&#13;
    <code class="nx">type</code><code class="o">:</code> <code class="s1">'application/json'</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// The object URL links to the Blob contents—set this in the link.</code>&#13;
  <code class="kr">const</code> <code class="nx">url</code> <code class="o">=</code> <code class="nx">URL</code><code class="p">.</code><code class="nx">createObjectURL</code><code class="p">(</code><code class="nx">blob</code><code class="p">);</code>&#13;
  <code class="nx">exportLink</code><code class="p">.</code><code class="nx">href</code> <code class="o">=</code> <code class="nx">url</code><code class="p">;</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id141">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>This method of exporting requires no special permission. When the link is clicked, and it has the object URL set, it downloads the <code>Blob</code>’s contents as a file, using the suggested filename of <em>users.json</em>.</p>&#13;
&#13;
<p>A <code>Blob</code> is a special object that holds some piece data. Usually this is binary data like a file or image, but you can also create a <code>Blob</code> with string content, which is what this recipe does.</p>&#13;
&#13;
<p>The <code>Blob</code> resides in memory, and the created object URL links to it. Once the object URL is set in the link element, it becomes an export download link. When the link is clicked, the object URL returns the raw string data. Since the link has a <code>download</code> attribute, it is downloaded to a local file.</p>&#13;
&#13;
<p>To prevent memory leaks, clean up the old URL by calling <code>URL.revokeObjectURL</code> and passing the object URL as its argument. You can do this once you no longer need the object URL—for example, after the user downloads the file or before leaving the<a data-startref="ix_10-working-with-files-asciidoc19" data-type="indexterm" id="id1026"/> page<a data-startref="ix_10-working-with-files-asciidoc18" data-type="indexterm" id="id1027"/><a data-startref="ix_10-working-with-files-asciidoc17" data-type="indexterm" id="id1028"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Uploading a File with Drag and Drop" data-type="sect1"><div class="sect1" id="id531">&#13;
<h1>Uploading a File with Drag and Drop</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id299">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="drag and drop" data-secondary="uploading a file with" data-type="indexterm" id="id1029"/><a data-primary="Fetch API" data-secondary="uploading a file with drag and drop" data-type="indexterm" id="id1030"/><a data-primary="files, working with" data-secondary="uploading a file with drag and drop" data-type="indexterm" id="id1031"/>You want to allow the user to drag and drop a file, such as an image, then upload that file to a remote service.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id532">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Pass the received <code>File</code> object to the Fetch API in the handle for the <code>drop</code> event (see <a data-type="xref" href="#example10-17">Example 10-17</a>).</p>&#13;
<div data-type="example" id="example10-17">&#13;
<h5><span class="label">Example 10-17. </span>Uploading a dropped file</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">target</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'.drop-target'</code><code class="p">);</code>&#13;
&#13;
<code class="nx">target</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'drop'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// Cancel the drop event. Otherwise, the browser will leave the page</code>&#13;
  <code class="c1">// and navigate to the file directly.</code>&#13;
  <code class="nx">event</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>&#13;
&#13;
  <code class="c1">// Get the selected file data.</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">item</code><code class="p">]</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">dataTransfer</code><code class="p">.</code><code class="nx">items</code><code class="p">;</code>&#13;
  <code class="kr">const</code> <code class="nx">file</code> <code class="o">=</code> <code class="nx">item</code><code class="p">.</code><code class="nx">getAsFile</code><code class="p">();</code>&#13;
&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">file</code><code class="p">.</code><code class="nx">type</code><code class="p">.</code><code class="nx">startsWith</code><code class="p">(</code><code class="s1">'image/'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="nx">fetch</code><code class="p">(</code><code class="s1">'/api/uploadFile'</code><code class="p">,</code> <code class="p">{</code>&#13;
      <code class="nx">method</code><code class="o">:</code> <code class="s1">'POST'</code><code class="p">,</code>&#13;
      <code class="nx">body</code><code class="o">:</code> <code class="nx">file</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// You need to cancel the dragover event as well, to prevent the</code>&#13;
<code class="c1">// file from replacing the full page content.</code>&#13;
<code class="nx">target</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'dragover'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">event</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id142">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>When you call <code>getAsFile</code> on the data transfer object, you get a <code>File</code> object. <code>File</code> extends from <code>Blob</code>, so you can use the Fetch API to send the file (<code>Blob</code>) contents to a remote server.</p>&#13;
&#13;
<p>This example checks the MIME type of the uploaded file and will only upload it if it is an image file.<a data-startref="ix_10-working-with-files-asciidoc0" data-type="indexterm" id="id1032"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section></body></html>