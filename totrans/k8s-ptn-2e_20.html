<html><head></head><body><section data-pdf-bookmark="Chapter 16. Sidecar" data-type="chapter" epub:type="chapter"><div class="chapter" id="Sidecar">&#13;
<h1><span class="label">Chapter 16. </span>Sidecar</h1>&#13;
&#13;
&#13;
<p>A<a data-primary="Sidecar" data-type="indexterm" id="sdcr16"/> sidecar container extends and enhances the functionality of a preexisting container without changing it. The <em>Sidecar</em> pattern is one of the fundamental container patterns that allows single-purpose containers to cooperate closely together. In this chapter, you’ll learn all about the basic sidecar concept. The<a data-primary="Adapter" data-type="indexterm" id="idm45902091700320"/><a data-primary="Adapter" data-secondary="Sidecar" data-type="indexterm" id="idm45902091699616"/><a data-primary="Ambassador" data-type="indexterm" id="idm45902091698672"/><a data-primary="Ambassador" data-secondary="Sidecar" data-type="indexterm" id="idm45902091698000"/> specialized follow-up patterns, <em>Adapter</em> and <em>Ambassador</em>, are discussed in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch17.html#Adapter">17</a> and&#13;
<a data-type="xref" data-xrefstyle="select:labelnumber" href="ch18.html#Ambassador">18</a>, respectively.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect1"><div class="sect1" id="idm45902091693600">&#13;
<h1>Problem</h1>&#13;
&#13;
<p>Containers<a data-primary="problems" data-secondary="containers, enhancing" data-type="indexterm" id="idm45902091692272"/><a data-primary="containers" data-secondary="enhancing through collaboration" data-type="indexterm" id="idm45902091691296"/> are a popular packaging technology that allow developers and system administrators to build, ship, and run applications in a unified way. A container represents a natural boundary for a unit of functionality with a distinct runtime, release cycle, API, and team owning it. A proper container behaves like a single Linux process—solves one problem and does it well—and is created with the idea of replaceability and reuse. This last part is essential as it allows us to build applications more quickly by leveraging existing specialized containers.</p>&#13;
&#13;
<p>Today, to make an HTTP call, we don’t have to write a client library but can use an existing one. In the same way, to serve a website, we don’t have to create a container for a web server but can use an existing one. This approach allows developers to avoid reinventing the wheel and create an ecosystem with a smaller number of better-quality containers to maintain. However, having single-purpose reusable containers requires ways of extending the&#13;
functionality of a container and a means for collaboration among containers. The sidecar pattern describes this kind of collaboration, where a container enhances the functionality of another preexisting container.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect1"><div class="sect1" id="idm45902091689680">&#13;
<h1>Solution</h1>&#13;
&#13;
<p>In <a data-type="xref" href="ch01.html#kubernetes-core-concepts">Chapter 1</a>, we described how the Pod primitive allows us to combine multiple containers into a single unit. Behind the scenes, at runtime, a Pod is a container as well, but it starts as a paused process (literally with the <code>pause</code> command) before all other containers in the Pod. It is not doing anything other than holding all the Linux namespaces the application containers use to interact throughout the Pod’s lifetime. Apart from this implementation detail, what is more interesting is all the characteristics that the Pod abstraction provides.</p>&#13;
&#13;
<p>The Pod is such a fundamental primitive that it is present in many cloud native platforms under different names but always with similar capabilities. A Pod as the deployment unit puts certain runtime constraints on the containers belonging to it. For example, all containers end up deployed to the same node, and they share the same Pod lifecycle. In addition, a Pod allows its containers to share volumes and communicate over the local network or host IPC. These are the reasons users put a group of containers into a Pod. <em>Sidecar</em> (sometimes also called <em>Sidekick</em>) is used to describe the scenario of a container being put into a Pod to extend and enhance another container’s behavior.</p>&#13;
&#13;
<p>A typical example demonstrating this pattern is of an HTTP server and a Git synchronizer. The HTTP server container is focused only on serving files over HTTP and does not know how or where the files are coming from. Similarly, the Git synchronizer container’s only goal is to sync data from a Git server to the local filesystem. It does not care what happens once synced—its only concern is keeping the local folder in sync with the remote Git server. <a data-type="xref" href="#example-sidecar">Example 16-1</a> shows a Pod definition with these two containers configured to use a volume for file exchange.</p>&#13;
<div data-type="example" id="example-sidecar">&#13;
<h5><span class="label">Example 16-1. </span>Pod with a sidecar</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">&#13;
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w">&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">web-app</code><code class="w">&#13;
</code><code class="nt">spec</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">docker.io/centos/httpd</code><code class="w">  </code><a class="co" href="#callout_sidecar_CO1-1" id="co_sidecar_CO1-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">    </code><code class="nt">ports</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">80</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/var/www/html</code><code class="w">     </code><a class="co" href="#callout_sidecar_CO1-3" id="co_sidecar_CO1-2"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">poll</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">axeclbr/git</code><code class="w">             </code><a class="co" href="#callout_sidecar_CO1-2" id="co_sidecar_CO1-3"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="w">    </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/var/lib/data</code><code class="w">     </code><a class="co" href="#callout_sidecar_CO1-3" id="co_sidecar_CO1-4"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">env</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REPO</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/mdn/beginner-html-site-scripted</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">command</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"</code><code class="s">sh</code><code class="s">"</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"</code><code class="s">-c</code><code class="s">"</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"</code><code class="s">git</code><code class="nv"> </code><code class="s">clone</code><code class="nv"> </code><code class="s">$(GIT_REPO)</code><code class="nv"> </code><code class="s">.</code><code class="nv"> </code><code class="s">&amp;&amp;</code><code class="nv"> </code><code class="s">watch</code><code class="nv"> </code><code class="s">-n</code><code class="nv"> </code><code class="s">600</code><code class="nv"> </code><code class="s">git</code><code class="nv"> </code><code class="s">pull</code><code class="s">"</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">workingDir</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/var/lib/data</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">volumes</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">emptyDir</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_sidecar_CO1-1" id="callout_sidecar_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Main application container serving files over HTTP.</p></dd>&#13;
<dt><a class="co" href="#co_sidecar_CO1-3" id="callout_sidecar_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Sidecar container running in parallel and pulling data from a Git server.</p></dd>&#13;
<dt><a class="co" href="#co_sidecar_CO1-2" id="callout_sidecar_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Shared location for exchanging data between the sidecar and main application container as mounted in the <code>app</code> and <code>poll</code> containers, respectively.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This example shows how the Git synchronizer enhances the HTTP server’s behavior with content to serve and keeps it synchronized. We could also say that both containers collaborate and are equally important, but in a <em>Sidecar</em> pattern, there is a main container and a helper container that enhance the collective behavior.&#13;
Typically, the main container is the first one listed in the containers list, and it represents the<a data-primary="kubectl" data-secondary="Sidecar" data-type="indexterm" id="idm45902091507136"/> default container (e.g., when we run the command <code>kubectl exec</code>).</p>&#13;
&#13;
<p>This simple pattern, illustrated in <a data-type="xref" href="#img-sidecar">Figure 16-1</a>, allows runtime collaboration of containers and at the same time enables separation of concerns for both containers, which might be owned by separate teams, using different programming languages, with different release cycles, etc. It also promotes replaceability and reuse of containers as the HTTP server, and the Git synchronizer can be reused in other applications and different configuration either as a single container in a Pod or again in collaboration with other containers.</p>&#13;
&#13;
<figure><div class="figure" id="img-sidecar">&#13;
<img alt="Sidecar Pattern" src="assets/kup2_1601.png"/>&#13;
<h6><span class="label">Figure 16-1. </span>Sidecar pattern</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect1"><div class="sect1" id="idm45902091425744">&#13;
<h1>Discussion</h1>&#13;
&#13;
<p>Previously we said that container images are like classes, and containers are like the objects in object-oriented programming (OOP). If we continue this analogy, extending a container to enhance its functionality is similar to inheritance in OOP, and having multiple containers collaborating in a Pod is similar to composition in OOP. While both approaches allow code reuse, inheritance involves tighter coupling between containers and represents an “is-a” relationship between containers.</p>&#13;
&#13;
<p>On the other hand, a composition in a Pod represents a “has-a” relationship, and it is more flexible because it doesn’t couple containers together at build time, giving you the ability to later swap containers in the Pod definition. With the composition approach, you have multiple containers (processes) running, health checked, restarted, and consuming resources, as the main application container does. Modern sidecar containers are small and consume minimal resources, but you have to decide whether it is worth running a separate process or whether it is better to merge it into the main container.</p>&#13;
&#13;
<p>We see two dominating approaches for using sidecars: transparent sidecars that are invisible to the application, and explicit sidecars that the main application interacts with over well-defined APIs. Envoy proxy is an example of a transparent sidecar that runs alongside the main container and abstracts the network by providing common features such as&#13;
Transport Layer Security (TLS), load balancing, automatic retries, circuit breaking, global rate limiting, observability of L7 traffic, distributed tracing, and more. All of these features become available to the application by transparently attaching the sidecar container and intercepting all the incoming and outgoing traffic to the main container. This is similar to<a data-primary="aspect-oriented programming" data-type="indexterm" id="idm45902091423600"/> aspect-oriented programming, in that with additional containers, we introduce orthogonal capabilities to the Pod without touching the main container.</p>&#13;
&#13;
<p>An example of an explicit proxy that uses the sidecar architecture is Dapr. A Dapr sidecar container is injected into a Pod and offers features such as reliable service invocation, publish-subscribe, bindings to external systems, state abstraction, observability, distributed tracing, and more. The primary difference between Dapr and Envoy proxy is that Dapr does not intercept all the networking traffic going in and out of the application. Rather, Dapr features are exposed over HTTP and gRPC APIs, which the application invokes or subscribes to.<a data-primary="" data-startref="sdcr16" data-type="indexterm" id="idm45902091422416"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="More Information" data-type="sect1"><div class="sect1" id="idm45902091421312">&#13;
<h1>More Information</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/bMAvz">Sidecar Example</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/7cII-">Pods</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/1XqCg">Design Patterns for Container-Based Distributed Systems</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/1KMw1">Prana: A Sidecar for Your Netflix PaaS-Based Applications and Services</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/8Cq95">Tin-Can Phone: Patterns to Add Authorization and Encryption to Legacy &#13;
<span class="keep-together">Applications</span></a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/0FF-r">Envoy</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://dapr.io">Dapr</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/kkhYD">The Almighty Pause Container</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/KYe39">Sidecar Pattern</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section></body></html>