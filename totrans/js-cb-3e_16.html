<html><head></head><body><section data-pdf-bookmark="Chapter 14. Data Persistence" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch14">&#13;
<h1><span class="label">Chapter 14. </span>Data Persistence</h1>&#13;
&#13;
&#13;
<p><a data-primary="data" data-secondary="persistence of" data-type="indexterm" id="ix_data_persist_ch14"/>We can animate and interact, stream, play, and render, but we always come back to the data. Data is the foundation on which we build the majority of our JavaScript applications. In  the first part of the book we worked with the JavaScript languages standards for data types, in <a data-type="xref" href="ch13.html#ch13">Chapter 13</a> we fetched data from a remote source, and in <a data-type="xref" href="ch20.html#ch20">Chapter 20</a> we’ll work with data on the server, manipulating data using APIs and data sources. Data and JavaScript, friends forever.</p>&#13;
&#13;
<p>In this chapter, we’re going to look at ways we can persist data with JavaScript in the browser using cookies, <code>sessionStorage</code>, <code>localStorage</code>, and IndexedDB.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Persisting Information with Cookies" data-type="sect1"><div class="sect1" id="cookies">&#13;
<h1>Persisting Information with Cookies</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45475140349784">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="data" data-secondary="cookies" data-type="indexterm" id="ix_data_cookie"/><a data-primary="cookies" data-type="indexterm" id="ix_cookies_data_persist"/>You need to read or set the value of a browser cookie.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45475140345944">&#13;
<h2>Solution</h2>&#13;
&#13;
<p><a data-primary="document.cookie object" data-type="indexterm" id="idm45475140344536"/>Use <code>document.cookie</code> to set and retrieve cookie values:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nb">document</code><code class="p">.</code><code class="nx">cookie</code> <code class="o">=</code> <code class="s1">'author=Adam'</code><code class="p">;</code>&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">document</code><code class="p">.</code><code class="nx">cookie</code><code class="p">);</code></pre>&#13;
&#13;
<p><a data-primary="endcodeURIComponent() method" data-type="indexterm" id="idm45475140332776"/>To encode strings, use <code>encodeURIComponent</code>, which will remove any commas, semicolons, or whitespace:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">book</code> <code class="o">=</code> <code class="nb">encodeURIComponent</code><code class="p">(</code><code class="s1">'JavaScript Cookbook'</code><code class="p">);</code>&#13;
<code class="nb">document</code><code class="p">.</code><code class="nx">cookie</code> <code class="o">=</code> <code class="sb">`title=</code><code class="si">${</code><code class="nx">book</code><code class="si">}</code><code class="sb">`</code><code class="p">;</code>&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">document</code><code class="p">.</code><code class="nx">cookie</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// logs title=JavaScript%20Cookbook</code></pre>&#13;
&#13;
<p><a data-primary="; (semicolon), cookie value" data-type="indexterm" id="idm45475140319432"/>Options can be added to the end of the cookie value and should be separated with a semicolon:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nb">document</code><code class="p">.</code><code class="nx">cookie</code> <code class="o">=</code> <code class="s1">'user=Abigail;  max-age=86400; path=/'</code><code class="p">;</code></pre>&#13;
&#13;
<p>To delete a cookie, set an expiration date for the cookie that has already occurred:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">eraseCookie</code><code class="p">(</code><code class="nx">key</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">cookie</code> <code class="o">=</code> <code class="sb">`</code><code class="si">${</code><code class="nx">key</code><code class="si">}</code><code class="sb">=;expires=Thu, 01 Jan 1970 00:00:00 UTC`</code><code class="p">;</code>&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">cookie</code> <code class="o">=</code> <code class="nx">cookie</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45475140239928">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Cookies are small bits of data that are stored in the browser. They are often set from the server application and sent to the server with nearly every request. In a browser they are accessed via the <code>document.cookie</code> object.</p>&#13;
&#13;
<p>Cookies accept the following options, each separated with a semicolon:</p>&#13;
<dl>&#13;
<dt><code>domain</code></dt>&#13;
<dd>&#13;
<p>The domain where the cookie is accessible. If not set, this defaults to the current host location. Specifying a domain allows the cookie to be accessed at subdomains.</p>&#13;
</dd>&#13;
<dt><code>expires</code></dt>&#13;
<dd>&#13;
<p>Sets a time at which the cookie expires. Accepts a date in GMTString format.</p>&#13;
</dd>&#13;
<dt><code>max-age</code></dt>&#13;
<dd>&#13;
<p>Sets the length of time that the cookie is valid. Accepts a value in seconds.</p>&#13;
</dd>&#13;
<dt><code>path</code></dt>&#13;
<dd>&#13;
<p>The path at which the cookie is accessible (such as <code>/</code> or <code>/app</code>). If not specified, the cookie defaults to the current path.</p>&#13;
</dd>&#13;
<dt><code>secure</code></dt>&#13;
<dd>&#13;
<p>If set to <code>true</code>, the cookie will only be transmitted over <code>https</code>.</p>&#13;
</dd>&#13;
<dt><code>samesite</code></dt>&#13;
<dd>&#13;
<p>Defaults to <code>strict</code>. If set to <code>strict</code>, the cookie will not be sent in cross-site browsing. Alternatively, <code>lax</code> will send cookies on top-level GET requests.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>In the following example, the user can enter a value which is stored as a cookie. They can then retrieve the value of a specified key and delete the value.</p>&#13;
&#13;
<p>In an HTML file:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="o">&lt;!</code><code class="nx">DOCTYPE</code> <code class="nx">html</code><code class="o">&gt;</code>&#13;
<code class="o">&lt;</code><code class="nx">html</code> <code class="nx">lang</code><code class="o">=</code><code class="s2">"en"</code><code class="o">&gt;</code>&#13;
  <code class="o">&lt;</code><code class="nx">head</code><code class="o">&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">meta</code> <code class="nx">charset</code><code class="o">=</code><code class="s2">"UTF-8"</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">meta</code> <code class="nx">name</code><code class="o">=</code><code class="s2">"viewport"</code> <code class="nx">content</code><code class="o">=</code><code class="s2">"width=device-width, initial-scale=1.0"</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">meta</code> <code class="nx">http</code><code class="o">-</code><code class="nx">equiv</code><code class="o">=</code><code class="s2">"X-UA-Compatible"</code> <code class="nx">content</code><code class="o">=</code><code class="s2">"ie=edge"</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">style</code><code class="o">&gt;</code>&#13;
      <code class="nx">div</code> <code class="p">{</code>&#13;
        <code class="nx">margin</code><code class="o">:</code> <code class="mi">10</code><code class="nx">px</code><code class="p">;</code>&#13;
      <code class="p">}</code>&#13;
&#13;
      <code class="p">.</code><code class="nx">data</code> <code class="p">{</code>&#13;
        <code class="nx">width</code><code class="o">:</code> <code class="mi">200</code><code class="nx">px</code><code class="p">;</code>&#13;
        <code class="nx">background</code><code class="o">-</code><code class="nx">color</code><code class="o">:</code> <code class="nx">yellow</code><code class="p">;</code>&#13;
        <code class="nx">padding</code><code class="o">:</code> <code class="mi">5</code><code class="nx">px</code><code class="p">;</code>&#13;
      <code class="p">}</code>&#13;
    <code class="o">&lt;</code><code class="err">/style&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">title</code><code class="o">&gt;</code><code class="nx">Store</code><code class="p">,</code> <code class="nx">retrieve</code><code class="p">,</code> <code class="nx">and</code> <code class="k">delete</code> <code class="nx">a</code> <code class="nx">cookie</code><code class="o">&lt;</code><code class="err">/title&gt;</code>&#13;
  <code class="o">&lt;</code><code class="err">/head&gt;</code>&#13;
  <code class="o">&lt;</code><code class="nx">body</code><code class="o">&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="nx">Store</code><code class="p">,</code> <code class="nx">retrieve</code><code class="p">,</code> <code class="nx">and</code> <code class="k">delete</code> <code class="nx">a</code> <code class="nx">cookie</code><code class="o">&lt;</code><code class="err">/h1&gt;</code>&#13;
&#13;
    <code class="o">&lt;</code><code class="nx">form</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">label</code> <code class="k">for</code><code class="o">=</code><code class="s2">"key"</code><code class="o">&gt;</code> <code class="nx">Enter</code> <code class="nx">key</code><code class="o">:&lt;</code><code class="err">/label&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">input</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"text"</code> <code class="nx">id</code><code class="o">=</code><code class="s2">"key"</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">label</code> <code class="k">for</code><code class="o">=</code><code class="s2">"value"</code><code class="o">&gt;</code><code class="nx">Enter</code> <code class="nx">value</code><code class="o">:&lt;</code><code class="err">/label&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">input</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"text"</code> <code class="nx">id</code><code class="o">=</code><code class="s2">"value"</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/form&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">id</code><code class="o">=</code><code class="s2">"set"</code><code class="o">&gt;</code><code class="nx">Set</code> <code class="nx">data</code><code class="o">&lt;</code><code class="err">/button&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">id</code><code class="o">=</code><code class="s2">"get"</code><code class="o">&gt;</code><code class="nx">Get</code> <code class="nx">data</code><code class="o">&lt;</code><code class="err">/button&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">id</code><code class="o">=</code><code class="s2">"erase"</code><code class="o">&gt;</code><code class="nx">Erase</code> <code class="nx">data</code><code class="o">&lt;</code><code class="err">/button&gt;</code>&#13;
&#13;
    <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Cookie</code> <code class="nx">value</code><code class="o">:&lt;</code><code class="err">/p&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">id</code><code class="o">=</code><code class="s2">"cookiestr"</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"data"</code><code class="o">&gt;&lt;</code><code class="err">/div&gt;</code>&#13;
&#13;
    <code class="o">&lt;</code><code class="nx">script</code> <code class="nx">src</code><code class="o">=</code><code class="s2">"cookie.js"</code><code class="o">&gt;&lt;</code><code class="err">/script&gt;</code>&#13;
  <code class="o">&lt;</code><code class="err">/body&gt;</code>&#13;
<code class="o">&lt;</code><code class="err">/html&gt;</code></pre>&#13;
&#13;
<p>And the associated <em>cookie.js</em> file:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// set the cookie</code>&#13;
<code class="kd">function</code> <code class="nx">setData</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">formKey</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'key'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>&#13;
  <code class="kr">const</code> <code class="nx">formValue</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'value'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">cookieVal</code> <code class="o">=</code> <code class="sb">`</code><code class="si">${</code><code class="nx">formKey</code><code class="si">}</code><code class="sb">=</code><code class="si">${</code><code class="nb">encodeURIComponent</code><code class="p">(</code><code class="nx">formValue</code><code class="p">)</code><code class="si">}</code><code class="sb">`</code><code class="p">;</code>&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">cookie</code> <code class="o">=</code> <code class="nx">cookieVal</code><code class="p">;</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// retrieve the cookie value for a specified key</code>&#13;
<code class="kd">function</code> <code class="nx">getData</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">key</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'key'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>&#13;
  <code class="kr">const</code> <code class="nx">cookie</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'cookiestr'</code><code class="p">);</code>&#13;
  <code class="nx">cookie</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">keyValue</code> <code class="o">=</code> <code class="nx">key</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/([.*+?^=!:${}()|[\]/\\])/g</code><code class="p">,</code> <code class="s1">'\\$1'</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="nx">regex</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">RegExp</code><code class="p">(</code><code class="sb">`(?:^|;)\\s?</code><code class="si">${</code><code class="nx">keyValue</code><code class="si">}</code><code class="sb">=(.*?)(?:;|$)`</code><code class="p">,</code> <code class="s1">'i'</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="nx">match</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">cookie</code><code class="p">.</code><code class="nx">match</code><code class="p">(</code><code class="nx">regex</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="nx">value</code> <code class="o">=</code> <code class="p">(</code><code class="nx">match</code> <code class="o">&amp;&amp;</code> <code class="nb">decodeURIComponent</code><code class="p">(</code><code class="nx">match</code><code class="p">[</code><code class="mi">1</code><code class="p">]))</code> <code class="o">||</code> <code class="s1">''</code><code class="p">;</code>&#13;
  <code class="nx">cookie</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="sb">`&lt;p&gt;</code><code class="si">${</code><code class="nx">value</code><code class="si">}</code><code class="sb">&lt;/p&gt;`</code><code class="p">;</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// remove the cookie for a specified key</code>&#13;
<code class="kd">function</code> <code class="nx">removeData</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">key</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'key'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'cookiestr'</code><code class="p">).</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">cookie</code> <code class="o">=</code> <code class="sb">`</code><code class="si">${</code><code class="nx">key</code><code class="si">}</code><code class="sb">=; expires=Thu, 01 Jan 1970 00:00:00 UTC`</code><code class="p">;</code>&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">cookie</code> <code class="o">=</code> <code class="nx">cookie</code><code class="p">;</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'set'</code><code class="p">).</code><code class="nx">onclick</code> <code class="o">=</code> <code class="nx">setData</code><code class="p">;</code>&#13;
<code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'get'</code><code class="p">).</code><code class="nx">onclick</code> <code class="o">=</code> <code class="nx">getData</code><code class="p">;</code>&#13;
<code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'erase'</code><code class="p">).</code><code class="nx">onclick</code> <code class="o">=</code> <code class="nx">removeData</code><code class="p">;</code></pre>&#13;
&#13;
<p><a data-primary="regular expressions" data-secondary="cookie value matching" data-type="indexterm" id="idm45475139918376"/>Notice that I am using regular expressions to match the cookie values, which have been encoded using <code>encodeURIComponent</code>. This is because <code>document.cookie</code> returns a string with all of the cookie values. Using regular expressions in this way allows me to extract the information that I need. Regular expressions are covered in more detail in <a data-type="xref" href="ch02.html#ch02">Chapter 2</a>.<a data-primary="" data-startref="ix_cookies_data_persist" data-type="indexterm" id="idm45475139597960"/><a data-primary="" data-startref="ix_data_cookie" data-type="indexterm" id="idm45475139596984"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using sessionStorage for Client-Side Storage" data-type="sect1"><div class="sect1" id="using_sessionstorage_for_client-side_sto">&#13;
<h1>Using sessionStorage for Client-Side Storage</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45475139594584">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="Storage object" data-type="indexterm" id="ix_storage_object"/><a data-primary="DOM (Document Object Model)" data-secondary="sessionStorage" data-type="indexterm" id="ix_dom_sessionstorage"/><a data-primary="data" data-secondary="sessionStorage for client-side storage" data-type="indexterm" id="ix_data_sessionstorage"/><a data-primary="sessionStorage functionality" data-type="indexterm" id="ix_sessionStorage"/>You want to easily store information for a single session, without running into the size and cross-page contamination problems associated with cookies.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45475139588584">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the DOM Storage <code>sessionStorage</code> functionality:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'Franco'</code><code class="p">);</code>&#13;
<code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">city</code> <code class="o">=</code> <code class="s1">'Pittsburgh'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// returns 2</code>&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// retrieve individual values</code>&#13;
<code class="kr">const</code> <code class="nx">name</code> <code class="o">=</code> <code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="s1">'name'</code><code class="p">);</code>&#13;
<code class="kr">const</code> <code class="nx">city</code> <code class="o">=</code> <code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="s1">'city'</code><code class="p">);</code>&#13;
&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`The stored name is </code><code class="si">${</code><code class="nx">name</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`The stored city is </code><code class="si">${</code><code class="nx">city</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// remove an individual item from storage</code>&#13;
<code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">removeItem</code><code class="p">(</code><code class="s1">'name'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// remove all items from storage</code>&#13;
<code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">clear</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// returns 0</code>&#13;
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">length</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45475139584344">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p><code>sessionStorage</code> allows us to easily store information in the user’s browser for a single session. A session lasts for as long as a single browser tab is open. Once the user closes the browser or tab, the session ends. Opening a new tab of the same page will start a new browser session.</p>&#13;
&#13;
<p><a data-primary="localStorage functionality" data-type="indexterm" id="idm45475139336152"/>By comparison, the default behavior of both cookies and <code>localStorage</code> (discussed in <a data-type="xref" href="#creating_a_localstorage_client-side_data">“Creating a localStorage Client-Side Data Storage Item”</a>) is to persist across sessions. As an example of the differences between these storage methods, <a data-type="xref" href="#comparing_sessionstorage_and_cookies">Example 14-1</a> stores information from a form in a cookie, <code>localStorage</code>, and <code>sessionStorage</code>.</p>&#13;
<div data-type="example" id="comparing_sessionstorage_and_cookies">&#13;
<h5><span class="label">Example 14-1. </span>Comparing <code>sessionStorage</code> and cookies</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="cp">&lt;!DOCTYPE html&gt;</code>&#13;
<code class="nt">&lt;html</code> <code class="na">lang=</code><code class="s">"en"</code><code class="nt">&gt;</code>&#13;
  <code class="nt">&lt;head&gt;</code>&#13;
    <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">"UTF-8"</code> <code class="nt">/&gt;</code>&#13;
    <code class="nt">&lt;meta</code> <code class="na">name=</code><code class="s">"viewport"</code> <code class="na">content=</code><code class="s">"width=device-width, initial-scale=1.0"</code> <code class="nt">/&gt;</code>&#13;
    <code class="nt">&lt;meta</code> <code class="na">http-equiv=</code><code class="s">"X-UA-Compatible"</code> <code class="na">content=</code><code class="s">"ie=edge"</code> <code class="nt">/&gt;</code>&#13;
    <code class="nt">&lt;style&gt;</code>&#13;
      <code class="nt">div</code> <code class="p">{</code>&#13;
        <code class="k">margin</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>&#13;
      <code class="p">}</code>&#13;
&#13;
      <code class="nc">.data</code> <code class="p">{</code>&#13;
        <code class="k">width</code><code class="o">:</code> <code class="m">100px</code><code class="p">;</code>&#13;
        <code class="k">background-color</code><code class="o">:</code> <code class="nb">yellow</code><code class="p">;</code>&#13;
        <code class="k">padding</code><code class="o">:</code> <code class="m">5px</code><code class="p">;</code>&#13;
      <code class="p">}</code>&#13;
    <code class="nt">&lt;/style&gt;</code>&#13;
    <code class="nt">&lt;title&gt;</code>Comparing Cookies, localStorage, and sessionStorage<code class="nt">&lt;/title&gt;</code>&#13;
  <code class="nt">&lt;/head&gt;</code>&#13;
  <code class="nt">&lt;body&gt;</code>&#13;
    <code class="nt">&lt;h1&gt;</code>Comparing Cookies, localStorage, and sessionStorage<code class="nt">&lt;/h1&gt;</code>&#13;
&#13;
    <code class="nt">&lt;form&gt;</code>&#13;
      <code class="nt">&lt;div&gt;</code>&#13;
        <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"key"</code><code class="nt">&gt;</code> Enter key:<code class="nt">&lt;/label&gt;</code>&#13;
        <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">id=</code><code class="s">"key"</code> <code class="nt">/&gt;</code>&#13;
      <code class="nt">&lt;/div&gt;</code>&#13;
      <code class="nt">&lt;div&gt;</code>&#13;
        <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"value"</code><code class="nt">&gt;</code>Enter value:<code class="nt">&lt;/label&gt;</code>&#13;
        <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">id=</code><code class="s">"value"</code> <code class="nt">/&gt;</code>&#13;
      <code class="nt">&lt;/div&gt;</code>&#13;
    <code class="nt">&lt;/form&gt;</code>&#13;
    <code class="nt">&lt;button</code> <code class="na">id=</code><code class="s">"set"</code><code class="nt">&gt;</code>Set data<code class="nt">&lt;/button&gt;</code>&#13;
    <code class="nt">&lt;button</code> <code class="na">id=</code><code class="s">"get"</code><code class="nt">&gt;</code>Get data<code class="nt">&lt;/button&gt;</code>&#13;
    <code class="nt">&lt;button</code> <code class="na">id=</code><code class="s">"erase"</code><code class="nt">&gt;</code>Erase data<code class="nt">&lt;/button&gt;</code>&#13;
&#13;
    <code class="nt">&lt;p&gt;</code>Session:<code class="nt">&lt;/p&gt;</code>&#13;
    <code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"sessionstr"</code> <code class="na">class=</code><code class="s">"data"</code><code class="nt">&gt;&lt;/div&gt;</code>&#13;
    <code class="nt">&lt;p&gt;</code>Local:<code class="nt">&lt;/p&gt;</code>&#13;
    <code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"localstr"</code> <code class="na">class=</code><code class="s">"data"</code><code class="nt">&gt;&lt;/div&gt;</code>&#13;
    <code class="nt">&lt;p&gt;</code>Cookie:<code class="nt">&lt;/p&gt;</code>&#13;
    <code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"cookiestr"</code> <code class="na">class=</code><code class="s">"data"</code><code class="nt">&gt;&lt;/div&gt;</code>&#13;
&#13;
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"cookie.js"</code><code class="nt">&gt;&lt;/script&gt;</code>&#13;
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"app.js"</code><code class="nt">&gt;&lt;/script&gt;</code>&#13;
  <code class="nt">&lt;/body&gt;</code>&#13;
<code class="nt">&lt;/html&gt;</code></pre></div>&#13;
&#13;
<p>The <em>cookies.js</em> file contains the code necessary to set, retrieve, and erase a given cookie:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// set session cookie</code>&#13;
<code class="kd">function</code> <code class="nx">setCookie</code><code class="p">(</code><code class="nx">cookie</code><code class="p">,</code> <code class="nx">value</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">cookieVal</code> <code class="o">=</code> <code class="sb">`</code><code class="si">${</code><code class="nx">cookie</code><code class="si">}</code><code class="sb">=</code><code class="si">${</code><code class="nb">encodeURIComponent</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code><code class="si">}</code><code class="sb">;path=/`</code><code class="p">;</code>&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">cookie</code> <code class="o">=</code> <code class="nx">cookieVal</code><code class="p">;</code>&#13;
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">cookieVal</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// each cookie separated by semicolon;</code>&#13;
<code class="kd">function</code> <code class="nx">getCookie</code><code class="p">(</code><code class="nx">key</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">keyValue</code> <code class="o">=</code> <code class="nx">key</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/([.*+?^=!:${}()|[\]/\\])/g</code><code class="p">,</code> <code class="s1">'\\$1'</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">cookie</code> <code class="p">}</code> <code class="o">=</code> <code class="nb">document</code><code class="p">;</code>&#13;
  <code class="kr">const</code> <code class="nx">regex</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">RegExp</code><code class="p">(</code><code class="sb">`(?:^|;)\\s?</code><code class="si">${</code><code class="nx">keyValue</code><code class="si">}</code><code class="sb">=(.*?)(?:;|$)`</code><code class="p">,</code> <code class="s1">'i'</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="nx">match</code> <code class="o">=</code> <code class="nx">cookie</code><code class="p">.</code><code class="nx">match</code><code class="p">(</code><code class="nx">regex</code><code class="p">);</code>&#13;
&#13;
  <code class="k">return</code> <code class="nx">match</code> <code class="o">&amp;&amp;</code> <code class="nb">decodeURIComponent</code><code class="p">(</code><code class="nx">match</code><code class="p">[</code><code class="mi">1</code><code class="p">]);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// set cookie date to the past to erase</code>&#13;
<code class="kd">function</code> <code class="nx">eraseCookie</code><code class="p">(</code><code class="nx">key</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">cookie</code> <code class="o">=</code> <code class="sb">`</code><code class="si">${</code><code class="nx">key</code><code class="si">}</code><code class="sb">=;path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC`</code><code class="p">;</code>&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">cookie</code> <code class="o">=</code> <code class="nx">cookie</code><code class="p">;</code>&#13;
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">cookie</code><code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>And the <em>app.js</em> file contains the rest of the program functionality:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// set data for both session and cookie</code>&#13;
<code class="kd">function</code> <code class="nx">setData</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">key</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'key'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">value</code> <code class="p">}</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'value'</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// set sessionStorage</code>&#13;
  <code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// set localStorage</code>&#13;
  <code class="nx">localStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// set cookie</code>&#13;
  <code class="nx">setCookie</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">function</code> <code class="nx">getData</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">try</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">key</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'key'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>&#13;
    <code class="kr">const</code> <code class="nx">session</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'sessionstr'</code><code class="p">);</code>&#13;
    <code class="kr">const</code> <code class="nx">local</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'localstr'</code><code class="p">);</code>&#13;
    <code class="kr">const</code> <code class="nx">cookie</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'cookiestr'</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// reset display</code>&#13;
    <code class="nx">session</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>&#13;
    <code class="nx">local</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>&#13;
    <code class="nx">cookie</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>&#13;
&#13;
    <code class="c1">// sessionStorage</code>&#13;
    <code class="kd">let</code> <code class="nx">value</code> <code class="o">=</code> <code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="nx">key</code><code class="p">)</code> <code class="o">||</code> <code class="s1">''</code><code class="p">;</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="nx">session</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="sb">`&lt;p&gt;</code><code class="si">${</code><code class="nx">value</code><code class="si">}</code><code class="sb">&lt;/p&gt;`</code><code class="p">;</code>&#13;
&#13;
    <code class="c1">// localStorage</code>&#13;
    <code class="nx">value</code> <code class="o">=</code> <code class="nx">localStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="nx">key</code><code class="p">)</code> <code class="o">||</code> <code class="s1">''</code><code class="p">;</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="nx">local</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="sb">`&lt;p&gt;</code><code class="si">${</code><code class="nx">value</code><code class="si">}</code><code class="sb">&lt;/p&gt;`</code><code class="p">;</code>&#13;
&#13;
    <code class="c1">// cookie</code>&#13;
    <code class="nx">value</code> <code class="o">=</code> <code class="nx">getCookie</code><code class="p">(</code><code class="nx">key</code><code class="p">)</code> <code class="o">||</code> <code class="s1">''</code><code class="p">;</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="nx">cookie</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="sb">`&lt;p&gt;</code><code class="si">${</code><code class="nx">value</code><code class="si">}</code><code class="sb">&lt;/p&gt;`</code><code class="p">;</code>&#13;
  <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">function</code> <code class="nx">removeData</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">key</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'key'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// sessionStorage</code>&#13;
  <code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">removeItem</code><code class="p">(</code><code class="nx">key</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// localStorage</code>&#13;
  <code class="nx">localStorage</code><code class="p">.</code><code class="nx">removeItem</code><code class="p">(</code><code class="nx">key</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// cookie</code>&#13;
  <code class="nx">eraseCookie</code><code class="p">(</code><code class="nx">key</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// reset display</code>&#13;
  <code class="nx">getData</code><code class="p">();</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'set'</code><code class="p">).</code><code class="nx">onclick</code> <code class="o">=</code> <code class="nx">setData</code><code class="p">;</code>&#13;
<code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'get'</code><code class="p">).</code><code class="nx">onclick</code> <code class="o">=</code> <code class="nx">getData</code><code class="p">;</code>&#13;
<code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'erase'</code><code class="p">).</code><code class="nx">onclick</code> <code class="o">=</code> <code class="nx">removeData</code><code class="p">;</code></pre>&#13;
&#13;
<p><a data-primary="getItem() function" data-type="indexterm" id="idm45475139040664"/><a data-primary="setItem() function" data-type="indexterm" id="idm45475139040056"/>You can get and set the data from <code>sessionStorage</code>, accessing it directly, as demonstrated in the solution, but a better approach is to use the <code>getItem()</code> and <code>setItem()</code> functions.</p>&#13;
&#13;
<p>Load the example page, add one or more values for the same key, and then click the “Get data” button. The result is displayed in <a data-type="xref" href="#getting_session_cookie_data">Figure 14-1</a>. No surprises here. The data has been stored in cookies, <code>localStorage</code>, and <code>sessionStorage</code>. Now, open the same page in a new tab window, enter the value into the <code>key</code> form field, and click the “Get data” button. The activity results in a page like that shown in <a data-type="xref" href="#values_diff_tab">Figure 14-2</a>.</p>&#13;
&#13;
<figure class="no-frame"><div class="figure" id="getting_session_cookie_data">&#13;
<img alt="jsc3 1401" src="assets/jsc3_1401.png"/>&#13;
<h6><span class="label">Figure 14-1. </span>Displaying stored <code>sessionStorage</code> and cookie data in original tab</h6>&#13;
</div></figure>&#13;
&#13;
<figure class="no-frame"><div class="figure" id="values_diff_tab">&#13;
<img alt="jsc3 1402" src="assets/jsc3_1402.png"/>&#13;
<h6><span class="label">Figure 14-2. </span>Displaying stored <code>sessionStorage</code> and cookie data in second tab</h6>&#13;
</div></figure>&#13;
&#13;
<p>In the new tab window, the <code>cookie</code> and <code>localStorage</code> values persist because the <code>cookie</code> is session specific, but the <code>sessionStorage</code>, which is specific to the tab window, does not.</p>&#13;
&#13;
<p>The screenshots illustrate the difference in cross-tab persistence, one of the key differences between <code>sessionStorage</code> and cookies, aside from how they’re set and accessed in JavaScript. Hopefully, the images and the example also demonstrate the potential hazards involved when using <code>sessionStorage</code>, especially in circumstances where cookies have normally been used.</p>&#13;
&#13;
<p>If your website or application users are familiar with the cookie persistence across tabbed windows, <code>sessionStorage</code> can be an unpleasant surprise. Along with the different behavior, there’s also the fact that browser menu options to delete cookies probably won’t have an impact on <code>sessionStorage</code>, which could also be an unwelcome surprise for your users. On the other hand, <code>sessionStorage</code> is incredibly clean to use, and provides a welcome storage option when we want to link storage to a specific tab window only.</p>&#13;
&#13;
<p>One last note on <code>sessionStorage</code> related to its implementation: both <code>sessionStorage</code> and <code>localStorage</code>, covered in the next recipe, are part of the W3C DOM Storage specification. Both are <code>window</code> object properties, which means they can be accessed globally. Both are implementations of the <code>Storage</code> object, and changes to the <code>prototype</code> for <code>Storage</code> result in changes to both the <code>sessionStorage</code> and <code>localStorage</code> objects:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">Storage</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">someMethod</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">param</code><code class="p">)</code> <code class="p">{</code> <code class="p">...};</code>&#13;
<code class="p">...</code>&#13;
<code class="nx">localStorage</code><code class="p">.</code><code class="nx">someMethod</code><code class="p">(</code><code class="nx">param</code><code class="p">);</code>&#13;
<code class="p">...</code>&#13;
<code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">someMethod</code><code class="p">(</code><code class="nx">param</code><code class="p">);</code></pre>&#13;
&#13;
<p>Aside from the differences covered in this recipe and the next, another major difference is that the <code>Storage</code> objects don’t make a round trip to the server—they’re purely client-side storage techniques.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45475138684600">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>For more information on the <code>Storage</code> object, <code>sessionStorage</code>, <code>localStorage</code>, or the Storage DOM, consult the <a href="https://oreil.ly/PgBUt">specification</a>. See <a data-type="xref" href="#creating_a_localstorage_client-side_data">“Creating a localStorage Client-Side Data Storage Item”</a> for a different look at how <code>sessionStorage</code> and <code>localStorage</code> can be set and retrieved.<a data-primary="" data-startref="ix_sessionStorage" data-type="indexterm" id="idm45475138669960"/><a data-primary="" data-startref="ix_data_sessionstorage" data-type="indexterm" id="idm45475138668984"/><a data-primary="" data-startref="ix_dom_sessionstorage" data-type="indexterm" id="idm45475138668040"/><a data-primary="" data-startref="ix_storage_object" data-type="indexterm" id="idm45475138667096"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a localStorage Client-Side Data Storage Item" data-type="sect1"><div class="sect1" id="creating_a_localstorage_client-side_data">&#13;
<h1>Creating a localStorage Client-Side Data Storage Item</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45475138664568">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="data" data-secondary="localStorage client-side storage item" data-type="indexterm" id="ix_data_localstorage"/><a data-primary="localStorage functionality" data-type="indexterm" id="ix_localStorage"/>You want to persist form element entries (or any data) in such a way that users can continue where they left off if the browser crashes, the user accidentally closes the browser, or the internet connection is lost.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45475138660536">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>You could use cookies if the data is small enough, but that strategy doesn’t work in an offline situation. Another, better approach, especially when you’re persisting larger amounts of data or if you have to support functionality when no internet connection is present, is to use <code>localStorage</code>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">formValue</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'formelem'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>&#13;
<code class="k">if</code> <code class="p">(</code><code class="nx">formValue</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="nx">localStorage</code><code class="p">.</code><code class="nx">formelem</code> <code class="o">=</code> <code class="nx">formValue</code><code class="p">;</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// recover</code>&#13;
<code class="kr">const</code> <code class="nx">storedValue</code> <code class="o">=</code> <code class="nx">localStorage</code><code class="p">.</code><code class="nx">formelem</code><code class="p">;</code>&#13;
<code class="k">if</code> <code class="p">(</code><code class="nx">storedValue</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'formelem'</code><code class="p">).</code><code class="nx">value</code> <code class="o">=</code> <code class="nx">storedValue</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45475138616600">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p><a data-type="xref" href="#using_sessionstorage_for_client-side_sto">“Using sessionStorage for Client-Side Storage”</a> covered <code>sessionStorage</code>, one of the DOM Storage techniques. The <code>localStorage</code> object interface is the same, with the same approaches to setting the data:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// use item methods</code>&#13;
<code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'value'</code><code class="p">);</code>&#13;
<code class="nx">localStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'value'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// use property names directly</code>&#13;
<code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">keyName</code> <code class="o">=</code> <code class="s1">'value'</code><code class="p">;</code>&#13;
<code class="nx">localStorage</code><code class="p">.</code><code class="nx">keyName</code> <code class="o">=</code> <code class="s1">'value'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// use the key method</code>&#13;
<code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code> <code class="o">=</code> <code class="s1">'value'</code><code class="p">;</code>&#13;
<code class="nx">localStorage</code><code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code> <code class="o">=</code> <code class="s1">'value'</code><code class="p">;</code></pre>&#13;
&#13;
<p>and for getting the data:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// use item methods</code>&#13;
<code class="nx">value</code> <code class="o">=</code> <code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="s1">'key'</code><code class="p">);</code>&#13;
<code class="nx">value</code> <code class="o">=</code> <code class="nx">localStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="s1">'key'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// use property names directly</code>&#13;
<code class="nx">value</code> <code class="o">=</code> <code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">keyName</code><code class="p">;</code>&#13;
<code class="nx">value</code> <code class="o">=</code> <code class="nx">localStorage</code><code class="p">.</code><code class="nx">keyName</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// use the key method</code>&#13;
<code class="nx">value</code> <code class="o">=</code> <code class="nx">sessionStorage</code><code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>&#13;
<code class="nx">value</code> <code class="o">=</code> <code class="nx">localStorage</code><code class="p">.</code><code class="nx">key</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code></pre>&#13;
&#13;
<p>Again, as with <code>sessionStorage</code>, though you can access and set data on <code>localStorage</code> directly, you should use <code>getItem()</code> and <code>setItem()</code>, instead.</p>&#13;
&#13;
<p><a data-primary="clear method, DOM Storage" data-type="indexterm" id="idm45475138322056"/><a data-primary="length property" data-type="indexterm" id="idm45475138321160"/>Both of the storage objects support the <code>length</code> property, which provides a count of stored item pairs, and the <code>clear</code> method (no parameters), which clears out all storage. In addition, both are scoped to the HTML5 origin, which means that the data storage is shared across all pages in a domain, but not across protocols (e.g., <code>http</code> is not the same as <code>https</code>) or ports.</p>&#13;
&#13;
<p>The difference between the two is how long data is stored. The <code>sessionStorage</code> object only stores data for the session, but the <code>localStorage</code> object stores data on the client forever, or until specifically removed.</p>&#13;
&#13;
<p><a data-primary="storage event" data-type="indexterm" id="idm45475138316904"/><a data-primary="events" data-secondary="storage" data-type="indexterm" id="idm45475138315976"/>The <code>sessionStorage</code> and <code>localStorage</code> objects also support one event: the <code>storage</code> event. This is an interesting event, in that it fires on all pages when changes are made to a <code>localStorage</code> item. It is also an area of low compatibility among browsers: you can capture the event on the <code>body</code> or <code>document</code> elements for Firefox, on the <code>body</code> for IE, or on the <code>document</code> for Safari.</p>&#13;
&#13;
<p><a data-type="xref" href="#using_localstorage_to_back_up_form_entri">Example 14-2</a> demonstrates a more comprehensive implementation than the use case covered in the solution for this recipe. In the example, all elements of a small form have their <code>onchange</code> event handler method assigned to a function that captures the change element name and value, and stores the values in the local storage via <code>localStorage</code>. When the form is submitted, all of the stored form data is cleared.</p>&#13;
&#13;
<p><a data-primary="events" data-secondary="onchange" data-type="indexterm" id="idm45475138308712"/><a data-primary="onchange event" data-type="indexterm" id="idm45475138307736"/>When the page is loaded, the form elements <code>onchange</code> event handler is assigned to the function to store the values, and if the value is already stored, it is restored to the form element. To test the application, enter data into a couple of the form fields—but, before clicking the Submit button, refresh the page. Without <code>localStorage</code>, you’d lose the data. Now, when you reload the page, the form is restored to the state it was in before the page was reloaded.</p>&#13;
<div data-type="example" id="using_localstorage_to_back_up_form_entri">&#13;
<h5><span class="label">Example 14-2. </span>Using <code>localStorage</code> to back up form entries in case of page reload or browser crash</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="cp">&lt;!DOCTYPE html&gt;</code>&#13;
<code class="nt">&lt;html</code> <code class="na">lang=</code><code class="s">"en"</code><code class="nt">&gt;</code>&#13;
  <code class="nt">&lt;head&gt;</code>&#13;
    <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">"UTF-8"</code> <code class="nt">/&gt;</code>&#13;
    <code class="nt">&lt;meta</code> <code class="na">name=</code><code class="s">"viewport"</code> <code class="na">content=</code><code class="s">"width=device-width, initial-scale=1.0"</code> <code class="nt">/&gt;</code>&#13;
    <code class="nt">&lt;meta</code> <code class="na">http-equiv=</code><code class="s">"X-UA-Compatible"</code> <code class="na">content=</code><code class="s">"ie=edge"</code> <code class="nt">/&gt;</code>&#13;
    <code class="nt">&lt;title&gt;</code>Creating a localStorage Client-Side Data Storage Item<code class="nt">&lt;/title&gt;</code>&#13;
  <code class="nt">&lt;/head&gt;</code>&#13;
  <code class="nt">&lt;body&gt;</code>&#13;
    <code class="nt">&lt;h1&gt;</code>Creating a localStorage Client-Side Data Storage Item<code class="nt">&lt;/h1&gt;</code>&#13;
&#13;
    <code class="nt">&lt;form</code> <code class="na">id=</code><code class="s">"inputform"</code><code class="nt">&gt;</code>&#13;
      <code class="nt">&lt;div&gt;</code>&#13;
        <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"field1"</code><code class="nt">&gt;</code>Enter field1:<code class="nt">&lt;/label&gt;</code>&#13;
        <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">id=</code><code class="s">"field1"</code> <code class="nt">/&gt;</code>&#13;
      <code class="nt">&lt;/div&gt;</code>&#13;
      <code class="nt">&lt;div&gt;</code>&#13;
        <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"field2"</code><code class="nt">&gt;</code>Enter field2:<code class="nt">&lt;/label&gt;</code>&#13;
        <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">id=</code><code class="s">"field2"</code> <code class="nt">/&gt;</code>&#13;
      <code class="nt">&lt;/div&gt;</code>&#13;
      <code class="nt">&lt;div&gt;</code>&#13;
        <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"field3"</code><code class="nt">&gt;</code>Enter field1:<code class="nt">&lt;/label&gt;</code>&#13;
        <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">id=</code><code class="s">"field3"</code> <code class="nt">/&gt;</code>&#13;
      <code class="nt">&lt;/div&gt;</code>&#13;
      <code class="nt">&lt;div&gt;</code>&#13;
        <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"field4"</code><code class="nt">&gt;</code>Enter field1:<code class="nt">&lt;/label&gt;</code>&#13;
        <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">id=</code><code class="s">"field4"</code> <code class="nt">/&gt;</code>&#13;
      <code class="nt">&lt;/div&gt;</code>&#13;
      <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"submit"</code> <code class="na">value=</code><code class="s">"Clear Storage"</code> <code class="nt">/&gt;</code>&#13;
    <code class="nt">&lt;/form&gt;</code>&#13;
&#13;
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"localstorage.js"</code><code class="nt">&gt;&lt;/script&gt;</code>&#13;
  <code class="nt">&lt;/body&gt;</code>&#13;
<code class="nt">&lt;/html&gt;</code></pre>&#13;
&#13;
<p>In the JavaScript file:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// store the form input elements as a variable</code>&#13;
<code class="kr">const</code> <code class="nx">elems</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelectorAll</code><code class="p">(</code><code class="s1">'input'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// store field values</code>&#13;
<code class="kd">function</code> <code class="nx">processField</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="nx">localStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="nb">window</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">href</code><code class="p">,</code> <code class="s1">'true'</code><code class="p">);</code>&#13;
  <code class="nx">localStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code> <code class="k">this</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// clear individual fields</code>&#13;
<code class="kd">function</code> <code class="nx">clearStored</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="nx">elems</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="nx">elem</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">elem</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'text'</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="nx">localStorage</code><code class="p">.</code><code class="nx">removeItem</code><code class="p">(</code><code class="nx">elem</code><code class="p">.</code><code class="nx">id</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// capture submit button to clear storage when clicked</code>&#13;
<code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'inputform'</code><code class="p">).</code><code class="nx">onsubmit</code> <code class="o">=</code> <code class="nx">clearStored</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// on form element change, store the value in localStorage</code>&#13;
<code class="nx">elems</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="nx">elem</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">elem</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'text'</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">value</code> <code class="o">=</code> <code class="nx">localStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="nx">elem</code><code class="p">.</code><code class="nx">id</code><code class="p">);</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="nx">elem</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="nx">value</code><code class="p">;</code>&#13;
&#13;
    <code class="c1">// change event</code>&#13;
    <code class="nx">elem</code><code class="p">.</code><code class="nx">onchange</code> <code class="o">=</code> <code class="nx">processField</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>The size allotted for <code>localStorage</code> varies by browser, but most are in the 5 mb to 10 mb range. You can use a <code>try/catch</code> block to test to ensure you have not exceeded the limit in the user’s browser:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="k">try</code> <code class="p">{</code>&#13;
  <code class="nx">localStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'value'</code><code class="p">);</code>&#13;
<code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">domException</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code>&#13;
    <code class="p">[</code><code class="s1">'QuotaExceededError'</code><code class="p">,</code> <code class="s1">'NS_ERROR_DOM_QUOTA_REACHED'</code><code class="p">].</code><code class="nx">includes</code><code class="p">(</code>&#13;
      <code class="nx">domException</code><code class="p">.</code><code class="nx">name</code>&#13;
    <code class="p">)</code>&#13;
  <code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// handle file size exceeded error</code>&#13;
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="c1">// handle any other error</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>localStorage</code> object can be used for offline work. For the form example, you can store the data in the <code>localStorage</code> and provide a button to click when connected to the internet, in order to sync the data from <code>localStorage</code> to server-side storage.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45475138486152">&#13;
<h2>See Also</h2>&#13;
&#13;
<p>See <a data-type="xref" href="#using_sessionstorage_for_client-side_sto">“Using sessionStorage for Client-Side Storage”</a> for more on the <code>Storage</code> object, and on <code>sessionStorage</code> and <code>localStorage</code>.<a data-primary="" data-startref="ix_localStorage" data-type="indexterm" id="idm45475138000088"/><a data-primary="" data-startref="ix_data_localstorage" data-type="indexterm" id="idm45475137999192"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Persisting Larger Chunks of Data on the Client Using IndexedDB" data-type="sect1"><div class="sect1" id="persisting_larger_chunks_data">&#13;
<h1>Persisting Larger Chunks of Data on the Client <span class="keep-together">Using IndexedDB</span></h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45475137996120">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="database management (IndexedDB)" data-type="indexterm" id="ix_database_manage"/><a data-primary="IndexedDB" data-type="indexterm" id="ix_indexdb"/><a data-primary="data" data-secondary="IndexedDB database management" data-type="indexterm" id="ix_data_indexdb"/>You need more sophisticated data storage on the client than what’s provided with other persistent storage methods, such as <code>localStorage</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45475137990840">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>In modern browsers, use IndexedDB.</p>&#13;
&#13;
<p>The JavaScript file in <a data-type="xref" href="#example_using_indexeddb">Example 14-3</a> uses IndexedDB to create a database and a data object. Once created, it adds data and then retrieves the first object. A more detailed description of what’s happening is in the discussion.</p>&#13;
<div data-type="example" id="example_using_indexeddb">&#13;
<h5><span class="label">Example 14-3. </span>Example of using IndexedDB to create a datastore, add data, and then retreive a data object</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[</code>&#13;
  <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s1">'Joe Brown'</code><code class="p">,</code> <code class="nx">age</code><code class="o">:</code> <code class="mi">53</code><code class="p">,</code> <code class="nx">experience</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>&#13;
  <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s1">'Cindy Johnson'</code><code class="p">,</code> <code class="nx">age</code><code class="o">:</code> <code class="mi">44</code><code class="p">,</code> <code class="nx">experience</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>&#13;
  <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s1">'Some Reader'</code><code class="p">,</code> <code class="nx">age</code><code class="o">:</code> <code class="mi">30</code><code class="p">,</code> <code class="nx">experience</code><code class="o">:</code> <code class="mi">3</code> <code class="p">}</code>&#13;
<code class="p">];</code>&#13;
&#13;
<code class="c1">// delete the 'Cookbook' database, so the example can be run more than once</code>&#13;
<code class="kr">const</code> <code class="nx">delReq</code> <code class="o">=</code> <code class="nx">indexedDB</code><code class="p">.</code><code class="nx">deleteDatabase</code><code class="p">(</code><code class="s1">'Cookbook'</code><code class="p">);</code>&#13;
<code class="nx">delReq</code><code class="p">.</code><code class="nx">onerror</code> <code class="o">=</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'delete error'</code><code class="p">,</code> <code class="nx">event</code><code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="c1">// open the 'Cookbook' database with a version of '1'</code>&#13;
<code class="c1">// or create it if it does not exist</code>&#13;
<code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">indexedDB</code><code class="p">.</code><code class="nx">open</code><code class="p">(</code><code class="s1">'Cookbook'</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// upgradeneeded event is fired when a db is opened</code>&#13;
<code class="c1">// with a version number higher than the currently stored version (in this case none)</code>&#13;
<code class="nx">request</code><code class="p">.</code><code class="nx">onupgradeneeded</code> <code class="o">=</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">transaction</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// create a new object store named 'reader' in the database</code>&#13;
  <code class="kr">const</code> <code class="nx">objectStore</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">createObjectStore</code><code class="p">(</code><code class="s1">'reader'</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">keyPath</code><code class="o">:</code> <code class="s1">'id'</code><code class="p">,</code>&#13;
    <code class="nx">autoIncrement</code><code class="o">:</code> <code class="kc">true</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// create new keys in the object store</code>&#13;
  <code class="nx">objectStore</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">(</code><code class="s1">'experience'</code><code class="p">,</code> <code class="s1">'experience'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">unique</code><code class="o">:</code> <code class="kc">false</code> <code class="p">});</code>&#13;
  <code class="nx">objectStore</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'name'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">unique</code><code class="o">:</code> <code class="kc">true</code> <code class="p">});</code>&#13;
&#13;
  <code class="c1">// when all data loaded, log to the console</code>&#13;
  <code class="nx">transaction</code><code class="p">.</code><code class="nx">oncomplete</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'data finished'</code><code class="p">);</code>&#13;
  <code class="p">};</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">readerObjectStore</code> <code class="o">=</code> <code class="nx">transaction</code><code class="p">.</code><code class="nx">objectStore</code><code class="p">(</code><code class="s1">'reader'</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// add each value from the data object to the indexedDB database</code>&#13;
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="nx">value</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">req</code> <code class="o">=</code> <code class="nx">readerObjectStore</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="nx">value</code><code class="p">);</code>&#13;
    <code class="c1">// console log a message when successfully added</code>&#13;
    <code class="nx">req</code><code class="p">.</code><code class="nx">onsuccess</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'data added'</code><code class="p">);</code>&#13;
    <code class="p">};</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// if the request throws an error, log it to the console</code>&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">onerror</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">errorCode</code><code class="p">);</code>&#13;
  <code class="p">};</code>&#13;
&#13;
  <code class="c1">// when the data store is successfully created, log to the console</code>&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">onsuccess</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'datastore created'</code><code class="p">);</code>&#13;
  <code class="p">};</code>&#13;
&#13;
  <code class="c1">// on page click, get a random value from the database and log it to the console</code>&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">onclick</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">randomNum</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">3</code><code class="p">)</code> <code class="o">+</code> <code class="mi">1</code><code class="p">;</code>&#13;
    <code class="kr">const</code> <code class="nx">dataRequest</code> <code class="o">=</code> <code class="nx">db</code>&#13;
      <code class="p">.</code><code class="nx">transaction</code><code class="p">([</code><code class="s1">'reader'</code><code class="p">])</code>&#13;
      <code class="p">.</code><code class="nx">objectStore</code><code class="p">(</code><code class="s1">'reader'</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">randomNum</code><code class="p">);</code>&#13;
    <code class="nx">dataRequest</code><code class="p">.</code><code class="nx">onsuccess</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Name : </code><code class="si">${</code><code class="nx">dataRequest</code><code class="p">.</code><code class="nx">result</code><code class="p">.</code><code class="nx">name</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>&#13;
    <code class="p">};</code>&#13;
  <code class="p">};</code>&#13;
<code class="p">};</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45475137978344">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>IndexedDB is the specification the W3C and others agreed to when exploring solutions to large data management on the client. Though it is transaction based, and supports the concept of a <em>cursor</em>, it isn’t a relational database system. It works with JavaScript objects, each of which is indexed by a given <em>key</em>, whatever you decide the key to be.</p>&#13;
&#13;
<p>IndexedDB can be both asynchronous and synchronous. It can be used for larger chunks of data in a traditional server or cloud application, but is also helpful for offline web application use.</p>&#13;
&#13;
<p>Most implementations of IndexedDB don’t restrict data storage size, but if you store more than 50 MB in Firefox, the user will need to provide permission. Chrome creates a pool of temporary storage, and each application can have up to 20% of it. Other agents have similar limitations. All of the main browsers support IndexedDB, except Opera Mini, though the overall support may not be identical.</p>&#13;
&#13;
<p>As the solution demonstrates, the IndexedDB API methods trigger both success and error callback functions, which you can capture using traditional event handling, or as callback, or assign to a function. Mozilla describes the pattern of use with IndexedDB:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Open a database.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create an object store in upgrading database.</p>&#13;
</li>&#13;
<li>&#13;
<p>Start a transaction and make a request to do some database operation, like adding or retrieving data.</p>&#13;
</li>&#13;
<li>&#13;
<p>Wait for the operation to complete by listening to the right kind of DOM event.</p>&#13;
</li>&#13;
<li>&#13;
<p>Do something with the results (which can be found on the request object).</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Starting from the top in the solution, a data object is created with three values to add to the datastore. The database is deleted if it exists, so that the example can be run multiple times. Following, a call to <code>open()</code> opens the database, if it exists, or creates it, if not. Because the database is deleted before the example is run, it’s recreated. The name and version are both necessary, because the database can be altered only if a new version of the database is opened.</p>&#13;
&#13;
<p><a data-primary="open() method, IndexedDB" data-type="indexterm" id="idm45475137448088"/>A request object (IDBOpenDBRequest) is returned from the <code>open()</code> method, and whether the operation succeeds or not is triggered as events on this object. <a data-primary="event handlers" data-secondary="onsuccess" data-type="indexterm" id="idm45475137446568"/><a data-primary="onsuccess event handler" data-type="indexterm" id="idm45475137445592"/>In the code, the <code>onsuccess</code> event handler for the object is captured to provide a message to the console about the success. You can also assign the database handle to a global variable in this event handler, but the code assigns this in the next event handled, the <code>upgradeneeded</code> event.</p>&#13;
&#13;
<p><a data-primary="event handlers" data-secondary="upgradeneeded" data-type="indexterm" id="idm45475137443512"/><a data-primary="upgradeneeded event handler" data-type="indexterm" id="idm45475137442536"/>The <code>upgradeneeded</code> event handler is only invoked when a database doesn’t exist for a given database name and version. The event object also gives us a way to access the IDBDatabase reference, which is assigned to the global variable, <code>db</code>. The existing transaction can also be accessed via the event object passed as an argument to the event handler, and it’s accessed and assigned to a local variable.</p>&#13;
&#13;
<p>The event handler for this event is the only time you’ll be able to create the object store and its associated indexes. In the solution, a datastore named <code>reader</code> is created, with its key set to an autoincrementing <code>id</code>. Two other indexes are for the datastore’s <code>name</code> and <code>experience</code> fields. The data is also added to the datastore in the event, though it could have been added at a separate time, say when a person submits an HTML form.</p>&#13;
&#13;
<p>Following the <code>upgradeneeded</code> event handler, the <code>success</code> and <code>error</code> handlers are coded, just to provide feedback. Last but not least, the <code>document.onclick</code> event handler is used to trigger a database access. In the solution, a random data instance is accessed via the database handler, its transaction, the object store, and eventually, for a given key. When the query is successful, the <code>name</code> field is accessed and the value is printed to the console. Rather than accessing a single value, we can also use a cursor, but I’ll leave that for your own experimentation.</p>&#13;
&#13;
<p>The resulting printouts to the console are, in order:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">data</code> <code class="nx">added</code>&#13;
<code class="nx">data</code> <code class="nx">finished</code>&#13;
<code class="nx">datastore</code> <code class="nx">created</code>&#13;
<code class="nx">Name</code> <code class="o">:</code> <code class="nx">Cindy</code> <code class="nx">Johnson</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Simplifying IndexedDB with a Library" data-type="sect1"><div class="sect1" id="indexeddb-libraries">&#13;
<h1>Simplifying IndexedDB with a Library</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45475137425208">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="IDB library" data-type="indexterm" id="ix_idb_library"/><a data-primary="libraries" data-secondary="IDB" data-type="indexterm" id="ix_lib_idb"/>You’d like to work with IndexedDB in an asynchronous fashion, using JavaScript promises.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45475137416328">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the <a href="https://github.com/jakearchibald/idb">IDB library</a>, which offers usability improvements to the IndexedDB API as well as a wrapper for using promises.</p>&#13;
&#13;
<p>The following file imports the IDB library, creates an IndexedDB data store, and adds data to it:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="p">{</code> <code class="nx">openDB</code><code class="p">,</code> <code class="nx">deleteDB</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'https://unpkg.com/idb?module'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[</code>&#13;
  <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s1">'Riley Harrison'</code><code class="p">,</code> <code class="nx">age</code><code class="o">:</code> <code class="mi">57</code><code class="p">,</code> <code class="nx">experience</code><code class="o">:</code> <code class="mi">1</code> <code class="p">},</code>&#13;
  <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s1">'Harlow Everly'</code><code class="p">,</code> <code class="nx">age</code><code class="o">:</code> <code class="mi">29</code><code class="p">,</code> <code class="nx">experience</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>&#13;
  <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s1">'Abigail McCullough'</code><code class="p">,</code> <code class="nx">age</code><code class="o">:</code> <code class="mi">38</code><code class="p">,</code> <code class="nx">experience</code><code class="o">:</code> <code class="mi">10</code> <code class="p">}</code>&#13;
<code class="p">];</code>&#13;
&#13;
<code class="p">(</code><code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// for demo purposes, delete existing db on page load</code>&#13;
  <code class="k">try</code> <code class="p">{</code>&#13;
    <code class="nx">await</code> <code class="nx">deleteDB</code><code class="p">(</code><code class="s1">'CookbookIDB'</code><code class="p">);</code>&#13;
  <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'delete error'</code><code class="p">,</code> <code class="nx">err</code><code class="p">);</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="c1">// open the database and create the data store</code>&#13;
  <code class="kr">const</code> <code class="nx">database</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">openDB</code><code class="p">(</code><code class="s1">'CookbookIDB'</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">upgrade</code><code class="p">(</code><code class="nx">db</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="c1">// Create a store of objects</code>&#13;
      <code class="kr">const</code> <code class="nx">store</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">createObjectStore</code><code class="p">(</code><code class="s1">'reader'</code><code class="p">,</code> <code class="p">{</code>&#13;
        <code class="nx">keyPath</code><code class="o">:</code> <code class="s1">'id'</code><code class="p">,</code>&#13;
        <code class="nx">autoIncrement</code><code class="o">:</code> <code class="kc">true</code>&#13;
      <code class="p">});</code>&#13;
&#13;
      <code class="c1">// create new keys in the object store</code>&#13;
      <code class="nx">store</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">(</code><code class="s1">'experience'</code><code class="p">,</code> <code class="s1">'experience'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">unique</code><code class="o">:</code> <code class="kc">false</code> <code class="p">});</code>&#13;
      <code class="nx">store</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'name'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">unique</code><code class="o">:</code> <code class="kc">true</code> <code class="p">});</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// add all of the reader data to the store</code>&#13;
  <code class="nx">data</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="nx">async</code> <code class="nx">value</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">await</code> <code class="nx">database</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="s1">'reader'</code><code class="p">,</code> <code class="nx">value</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">})();</code></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>In the example, I am loading the <code>idb</code> module from <a href="https://unpkg.com">UNPKG</a>, which allows me to directly access the module from a URL, rather than locally installing it. This works well for demo purposes, but in an application you will want to install the module via <code>npm</code> and bundle it with your code.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="idm45475137118968">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>IDB bills itself as “a tiny library that mostly mirrors the IndexedDB API, but with small improvements that make a big difference to usability.” Using <code>idb</code> simplifies some of the syntax of IndexedDB, along with enabling support for asynchronous code execution with promises.</p>&#13;
&#13;
<p>The <code>openDB</code> method opens a database and returns a promise:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">openDB</code><code class="p">(</code><code class="nx">name</code><code class="p">,</code> <code class="nx">version</code><code class="p">,</code> <code class="p">{</code>&#13;
  <code class="c1">// ...</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>In the following example, a user can add data to the database and retrieve all of the data to be displayed on the page. In an HTML file:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="cp">&lt;!DOCTYPE html&gt;</code>&#13;
<code class="nt">&lt;html</code> <code class="na">lang=</code><code class="s">"en"</code><code class="nt">&gt;</code>&#13;
  <code class="nt">&lt;head&gt;</code>&#13;
    <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">"UTF-8"</code> <code class="nt">/&gt;</code>&#13;
    <code class="nt">&lt;meta</code> <code class="na">name=</code><code class="s">"viewport"</code> <code class="na">content=</code><code class="s">"width=device-width, initial-scale=1.0"</code> <code class="nt">/&gt;</code>&#13;
    <code class="nt">&lt;meta</code> <code class="na">http-equiv=</code><code class="s">"X-UA-Compatible"</code> <code class="na">content=</code><code class="s">"ie=edge"</code> <code class="nt">/&gt;</code>&#13;
    <code class="nt">&lt;title&gt;</code>IDB Discussion Example<code class="nt">&lt;/title&gt;</code>&#13;
    <code class="nt">&lt;style&gt;</code>&#13;
      <code class="nt">div</code> <code class="p">{</code>&#13;
        <code class="k">margin</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>&#13;
      <code class="p">}</code>&#13;
&#13;
      <code class="nc">.data</code> <code class="p">{</code>&#13;
        <code class="k">width</code><code class="o">:</code> <code class="m">200px</code><code class="p">;</code>&#13;
        <code class="k">background-color</code><code class="o">:</code> <code class="nb">yellow</code><code class="p">;</code>&#13;
        <code class="k">padding</code><code class="o">:</code> <code class="m">5px</code><code class="p">;</code>&#13;
      <code class="p">}</code>&#13;
    <code class="nt">&lt;/style&gt;</code>&#13;
  <code class="nt">&lt;/head&gt;</code>&#13;
  <code class="nt">&lt;body&gt;</code>&#13;
    <code class="nt">&lt;h1&gt;</code>IDB Discussion Example<code class="nt">&lt;/h1&gt;</code>&#13;
&#13;
    <code class="nt">&lt;form&gt;</code>&#13;
      <code class="nt">&lt;div&gt;</code>&#13;
        <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"name"</code><code class="nt">&gt;</code> Enter name:<code class="nt">&lt;/label&gt;</code>&#13;
        <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">id=</code><code class="s">"name"</code> <code class="nt">/&gt;</code>&#13;
      <code class="nt">&lt;/div&gt;</code>&#13;
      <code class="nt">&lt;div&gt;</code>&#13;
        <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"age"</code><code class="nt">&gt;</code>Enter age:<code class="nt">&lt;/label&gt;</code>&#13;
        <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">id=</code><code class="s">"age"</code> <code class="nt">/&gt;</code>&#13;
      <code class="nt">&lt;/div&gt;</code>&#13;
    <code class="nt">&lt;/form&gt;</code>&#13;
    <code class="nt">&lt;button</code> <code class="na">id=</code><code class="s">"set"</code><code class="nt">&gt;</code>Set data<code class="nt">&lt;/button&gt;</code>&#13;
    <code class="nt">&lt;button</code> <code class="na">id=</code><code class="s">"get"</code><code class="nt">&gt;</code>Get data<code class="nt">&lt;/button&gt;</code>&#13;
&#13;
    <code class="nt">&lt;p&gt;</code>Data:<code class="nt">&lt;/p&gt;</code>&#13;
    <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"data"</code><code class="nt">&gt;</code>&#13;
      <code class="nt">&lt;ul</code> <code class="na">id=</code><code class="s">"data-list"</code><code class="nt">&gt;&lt;/ul&gt;</code>&#13;
    <code class="nt">&lt;/div&gt;</code>&#13;
&#13;
    <code class="nt">&lt;script </code><code class="na">type=</code><code class="s">"module"</code> <code class="na">src=</code><code class="s">"idb-discussion.js"</code><code class="nt">&gt;&lt;/script&gt;</code>&#13;
  <code class="nt">&lt;/body&gt;</code>&#13;
<code class="nt">&lt;/html&gt;</code></pre>&#13;
&#13;
<p>And the <em>idb-discussion.js</em> file:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="p">{</code> <code class="nx">openDB</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'https://unpkg.com/idb?module'</code><code class="p">;</code>&#13;
&#13;
<code class="p">(</code><code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// open the database and create the data store</code>&#13;
  <code class="kr">const</code> <code class="nx">database</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">openDB</code><code class="p">(</code><code class="s1">'ReaderNames'</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">upgrade</code><code class="p">(</code><code class="nx">db</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="c1">// Create a store of objects</code>&#13;
      <code class="kr">const</code> <code class="nx">store</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">createObjectStore</code><code class="p">(</code><code class="s1">'reader'</code><code class="p">,</code> <code class="p">{</code>&#13;
        <code class="nx">keyPath</code><code class="o">:</code> <code class="s1">'id'</code><code class="p">,</code>&#13;
        <code class="nx">autoIncrement</code><code class="o">:</code> <code class="kc">true</code>&#13;
      <code class="p">});</code>&#13;
&#13;
      <code class="c1">// create new keys in the object store</code>&#13;
      <code class="nx">store</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">(</code><code class="s1">'age'</code><code class="p">,</code> <code class="s1">'age'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">unique</code><code class="o">:</code> <code class="kc">false</code> <code class="p">});</code>&#13;
      <code class="nx">store</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'name'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">unique</code><code class="o">:</code> <code class="kc">true</code> <code class="p">});</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">async</code> <code class="kd">function</code> <code class="nx">setData</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">name</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'name'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>&#13;
    <code class="kr">const</code> <code class="nx">age</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'age'</code><code class="p">).</code><code class="nx">value</code><code class="p">;</code>&#13;
&#13;
    <code class="nx">await</code> <code class="nx">database</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="s1">'reader'</code><code class="p">,</code> <code class="p">{</code>&#13;
      <code class="nx">name</code><code class="p">,</code>&#13;
      <code class="nx">age</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="nx">async</code> <code class="kd">function</code> <code class="nx">getData</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// get the reader data from the database</code>&#13;
    <code class="kr">const</code> <code class="nx">readers</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">database</code><code class="p">.</code><code class="nx">getAll</code><code class="p">(</code><code class="s1">'reader'</code><code class="p">);</code>&#13;
&#13;
    <code class="kr">const</code> <code class="nx">dataDisplay</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'data-list'</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// add the name and age of each reader in the db to the page</code>&#13;
    <code class="nx">readers</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="nx">reader</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="kr">const</code> <code class="nx">value</code> <code class="o">=</code> <code class="sb">`</code><code class="si">${</code><code class="nx">reader</code><code class="p">.</code><code class="nx">name</code><code class="si">}</code><code class="sb">: </code><code class="si">${</code><code class="nx">reader</code><code class="p">.</code><code class="nx">age</code><code class="si">}</code><code class="sb">`</code><code class="p">;</code>&#13;
      <code class="kr">const</code> <code class="nx">li</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'li'</code><code class="p">);</code>&#13;
      <code class="nx">li</code><code class="p">.</code><code class="nx">appendChild</code><code class="p">(</code><code class="nb">document</code><code class="p">.</code><code class="nx">createTextNode</code><code class="p">(</code><code class="nx">value</code><code class="p">));</code>&#13;
      <code class="nx">dataDisplay</code><code class="p">.</code><code class="nx">appendChild</code><code class="p">(</code><code class="nx">li</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'set'</code><code class="p">).</code><code class="nx">onclick</code> <code class="o">=</code> <code class="nx">setData</code><code class="p">;</code>&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'get'</code><code class="p">).</code><code class="nx">onclick</code> <code class="o">=</code> <code class="nx">getData</code><code class="p">;</code>&#13;
<code class="p">})();</code></pre>&#13;
&#13;
<p><a data-primary="" data-startref="ix_data_persist_ch14" data-type="indexterm" id="idm45475136893928"/><a data-primary="" data-startref="ix_data_indexdb" data-type="indexterm" id="idm45475136893192"/><a data-primary="" data-startref="ix_indexdb" data-type="indexterm" id="idm45475136892248"/><a data-primary="" data-startref="ix_lib_idb" data-type="indexterm" id="idm45475136733416"/><a data-primary="" data-startref="ix_database_manage" data-type="indexterm" id="idm45475136732472"/><a data-primary="" data-startref="ix_idb_library" data-type="indexterm" id="idm45475136731528"/>I won’t go into the full API, but highly recommend consulting the <a href="https://github.com/jakearchibald/idb/blob/master/README.md">library’s documentation</a> and using IDB whenever working with IndexedDB.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>