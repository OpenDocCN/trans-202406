<html><head></head><body><section data-pdf-bookmark="Chapter 22. Configuration Template" data-type="chapter" epub:type="chapter"><div class="chapter" id="ConfigurationTemplate">&#13;
<h1><span class="label">Chapter 22. </span>Configuration Template</h1>&#13;
&#13;
&#13;
<p>The<a data-primary="Configuration Template" data-type="indexterm" id="cnfgtmplt22"/> <em>Configuration Template</em> pattern enables you to create and process large and complex configurations during application startup. The generated configuration is specific to the target runtime environment as reflected by the parameters used in processing the configuration template.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect1"><div class="sect1" id="idm45902088778048">&#13;
<h1>Problem</h1>&#13;
&#13;
<p>In<a data-primary="problems" data-secondary="configuration files, dealing with large" data-type="indexterm" id="idm45902088776720"/><a data-primary="Configuration Resource" data-type="indexterm" id="idm45902088775744"/><a data-primary="Configuration Resource" data-secondary="Configuration Template" data-type="indexterm" id="idm45902088775072"/> <a data-type="xref" data-xrefstyle="chap-num-title" href="ch20.html#ConfigurationResource">Chapter 20, “Configuration Resource”</a>, you saw how to use the Kubernetes native resource objects ConfigMap and Secret to configure  applications. But sometimes configuration files can get large and complex. Putting the configuration files directly into ConfigMaps can be problematic since they have to be correctly embedded in the resource definition. We need to be careful and avoid using special characters like quotes and breaking the Kubernetes resource syntax. The size of configurations is another consideration, as there is a limit on the sum of all values of ConfigMaps or Secrets, which is 1 MB (a limit imposed by the underlying backend store etcd).</p>&#13;
&#13;
<p>Large configuration files typically differ only slightly for the different execution environments. This<a data-primary="configuration information" data-secondary="reducing duplication in" data-type="indexterm" id="idm45902088772240"/> similarity leads to a lot of duplication and redundancy in the ConfigMaps because each environment has mostly the same data. The <em>Configuration Template</em> pattern we explore in this chapter addresses these specific use-case <span class="keep-together">concerns</span>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect1"><div class="sect1" id="idm45902088769840">&#13;
<h1>Solution</h1>&#13;
&#13;
<p>To reduce duplication, it makes sense to store only the <em>differing</em> configuration values like database connection parameters in a ConfigMap or even directly in environment variables. During startup of the container, these values are processed with configuration templates to create the full configuration file (like a<a data-primary="WildFly" data-type="indexterm" id="idm45902088767184"/> WildFly <em>standalone.xml</em>). There are many tools like<a data-primary="Tiller" data-type="indexterm" id="idm45902088765936"/> <em>Tiller</em> (Ruby) or<a data-primary="Gomplate" data-type="indexterm" id="idm45902088764688"/> <em>Gomplate</em> (Go) for processing templates during application initialization. <a data-type="xref" href="#img-configuration-template">Figure 22-1</a> is a configuration template example filled with data coming from environment variables or a mounted volume, possibly backed by a ConfigMap.</p>&#13;
&#13;
<p>Before the application is started, the fully processed configuration file is put into a location where it can be directly used like any other configuration file.</p>&#13;
&#13;
<p>There are two techniques for how such<a data-primary="configuration information" data-secondary="live processing of" data-type="indexterm" id="idm45902088761808"/> live processing can happen during runtime:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>We can add the template processor as part of the <code>ENTRYPOINT</code> to a Dockerfile so the template processing becomes directly part of the container image. The entry point here is typically a script that first performs the template processing and then starts the application. The parameters for the template come from environment variables.</p>&#13;
</li>&#13;
<li>&#13;
<p>With Kubernetes, a better way to perform initialization is with an<a data-primary="Init Container" data-type="indexterm" id="idm45902088758464"/><a data-primary="Init Container" data-secondary="Configuration Template" data-type="indexterm" id="idm45902088757856"/> init container of a Pod in which the template processor runs and creates the configuration for the application containers in the Pod. The <em>Init Container</em> pattern is described in detail in <a data-type="xref" href="ch15.html#InitContainer">Chapter 15</a>.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>For Kubernetes, the init container approach is the most appealing because we can use ConfigMaps directly for the template parameters. This technique is illustrated in <a data-type="xref" href="#img-configuration-template">Figure 22-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="img-configuration-template">&#13;
<img alt="Configuration template pattern" src="assets/kup2_2201.png"/>&#13;
<h6><span class="label">Figure 22-1. </span>Configuration template</h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">The application’s Pod definition consists of at least two containers: one init container for the template processing and one for the application container.&#13;
The init container contains not only the template processor but also the configuration templates &#13;
<span class="keep-together">themselves.</span> In addition to the containers, this Pod also defines two volumes: one volume for the template parameters, backed by a ConfigMap, and an <code>emptyDir</code> volume used to share the processed templates between the init container and the application container.</p>&#13;
&#13;
<p>With this setup, the following steps are performed during startup of this Pod:</p>&#13;
<ol>&#13;
<li>&#13;
<p>The init container is started, and it runs the template processor. The processor takes the templates from its image, and the template parameters from the mounted ConfigMap volume, and stores the result in the <code>emptyDir</code> volume.</p>&#13;
</li>&#13;
<li>&#13;
<p>After the init container has finished, the application container starts up and loads the configuration files from the <code>emptyDir</code> volume.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>The following example uses an init container for managing a full set<a data-primary="WildFly" data-type="indexterm" id="wildfly22"/> of WildFly configuration files for two environments: a development environment and a production environment. Both are very similar to each other and differ only slightly.&#13;
In fact, in our example, they differ only in the way logging is performed: each log line is prefixed with <code>DEVELOPMENT:</code> or <code>PRODUCTION:</code>, respectively.</p>&#13;
&#13;
<p>You can find the full example along with complete installation instructions in the book’s example <a href="https://oreil.ly/gzSdc">GitHub repo</a>. (We show only the main concept here; for the technical details, refer to the source repo.)</p>&#13;
&#13;
<p>The log pattern in <a data-type="xref" href="#ex-log-config-template">Example 22-1</a> is stored in <em>standalone.xml</em>, which we parameterize by using the<a data-primary="Go Template" data-type="indexterm" id="idm45902088741024"/> Go template syntax.</p>&#13;
<div data-type="example" id="ex-log-config-template">&#13;
<h5><span class="label">Example 22-1. </span>Log configuration template</h5>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting">....<code class="w"/>&#13;
<code class="nt">&lt;formatter</code><code class="w"> </code><code class="na">name=</code><code class="s">"COLOR-PATTERN"</code><code class="nt">&gt;</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">&lt;pattern-formatter</code><code class="w"> </code><code class="na">pattern=</code><code class="s">"{{(datasource "</code><code class="err">config").logFormat}}"</code><code class="nt">/&gt;</code><code class="w"/>&#13;
<code class="nt">&lt;/formatter&gt;</code><code class="w"/>&#13;
....<code class="w"/></pre></div>&#13;
&#13;
<p>Here we use <a href="https://gomplate.ca">Gomplate</a> as a template processor, which uses the notion of a <em>data source</em> for referencing the template parameters to be filled in. In our case, this data source comes from a ConfigMap-backed volume mounted to an init container. Here, the ConfigMap contains a single entry with the key <code>logFormat</code>, from where the actual format is extracted.</p>&#13;
&#13;
<p>With this template in place, we can now create the Docker image for the init container. The Dockerfile for the image <em>k8spatterns/example-configuration-template-init</em> is very simple (<a data-type="xref" href="#ex-log-template-container">Example 22-2</a>).</p>&#13;
<div data-type="example" id="ex-log-template-container">&#13;
<h5><span class="label">Example 22-2. </span>Simple Dockerfile for template image</h5>&#13;
&#13;
<pre data-type="programlisting">FROM k8spatterns/gomplate&#13;
COPY in /in</pre></div>&#13;
&#13;
<p>The base image <em>k8spatterns/gomplate</em> contains the template processor and an entry-point script that uses the following directories by default:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>/in</em> holds the WildFly configuration templates, including the parameterized <em>standalone.xml</em>. These are added directly to the image.</p>&#13;
</li>&#13;
<li>&#13;
<p><em>/params</em> is used to look up the Gomplate data sources, which are YAML files. This directory is mounted from a ConfigMap-backed Pod volume.</p>&#13;
</li>&#13;
<li>&#13;
<p><em>/out</em> is the directory into which the processed files are stored. This directory is mounted in the WildFly application container and used for the configuration.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The second ingredient of our example is the ConfigMap holding the parameters. In <a data-type="xref" href="#ex-log-template-parameter">Example 22-3</a>, we just use a simple file with key-value pairs.</p>&#13;
<div data-type="example" id="ex-log-template-parameter">&#13;
<h5><span class="label">Example 22-3. </span>Create ConfigMap with values to fill into the configuration template</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">kubectl<code class="w"> </code>create<code class="w"> </code>configmap<code class="w"> </code>wildfly-cm<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">       </code>--from-literal<code class="o">=</code><code class="s1">'config.yml=logFormat: "DEVELOPMENT: %-5p %s%e%n'</code><code class="w"/></pre></div>&#13;
&#13;
<p>Finally, we need the Deployment resource for the WildFly server (<a data-type="xref" href="#ex-log-template-deployment">Example 22-4</a>).</p>&#13;
<div data-type="example" id="ex-log-template-deployment">&#13;
<h5><span class="label">Example 22-4. </span>Deployment with template processor as init container</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w">&#13;
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w">&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">example</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cm-template</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">wildfly-cm-template</code><code class="w">&#13;
</code><code class="nt">spec</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">example</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cm-template</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">initContainers</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">k8spatterns/example-config-cm-template-init</code><code class="w"> </code><a class="co" href="#callout_configuration_template_CO1-1" id="co_configuration_template_CO1-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">init</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">/params</code><code class="s">"</code><code class="w">                             </code><a class="co" href="#callout_configuration_template_CO1-2" id="co_configuration_template_CO1-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">wildfly-parameters</code><code class="w">&#13;
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">/out</code><code class="s">"</code><code class="w">                                </code><a class="co" href="#callout_configuration_template_CO1-3" id="co_configuration_template_CO1-3"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">wildfly-config</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">jboss/wildfly:10.1.0.Final</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">server</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">command</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"</code><code class="s">/opt/jboss/wildfly/bin/standalone.sh</code><code class="s">"</code><code class="w">&#13;
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"</code><code class="s">-Djboss.server.config.dir=/config</code><code class="s">"</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">/config</code><code class="s">"</code><code class="w">                             </code><a class="co" href="#callout_configuration_template_CO1-4" id="co_configuration_template_CO1-4"><img alt="4" src="assets/4.png"/></a><code class="w">&#13;
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">wildfly-config</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">volumes</code><code class="p">:</code><code class="w">                                             </code><a class="co" href="#callout_configuration_template_CO1-5" id="co_configuration_template_CO1-5"><img alt="5" src="assets/5.png"/></a><code class="w">&#13;
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">wildfly-parameters</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">configMap</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">wildfly-cm</code><code class="w">&#13;
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">wildfly-config</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">emptyDir</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_configuration_template_CO1-1" id="callout_configuration_template_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Image holding the configuration templates that has been created from <a data-type="xref" href="#ex-log-template-container">Example 22-2</a>.</p></dd>&#13;
<dt><a class="co" href="#co_configuration_template_CO1-2" id="callout_configuration_template_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Parameters are mounted from a volume <code>wildfly-parameters</code> declared in <img src="assets/5.png"/>.</p></dd>&#13;
<dt><a class="co" href="#co_configuration_template_CO1-3" id="callout_configuration_template_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The target directory for writing out processed templates. This is mounted from an empty volume.</p></dd>&#13;
<dt><a class="co" href="#co_configuration_template_CO1-4" id="callout_configuration_template_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The directory holding the generated full configuration files is mounted as <span class="keep-together"><code>/config</code></span>.</p></dd>&#13;
<dt><a class="co" href="#co_configuration_template_CO1-5" id="callout_configuration_template_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Volume declaration for the parameters’ ConfigMap and the empty directory used for sharing the processed configuration.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This declaration is quite a mouthful, so let’s drill down: the Deployment specification contains a Pod with our init container, the application container, and two internal Pod volumes:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The first volume, <code>wildfly-parameters</code>, references the ConfigMap <code>wildfly-cm</code> with the parameter values that we created in <a data-type="xref" href="#ex-log-template-parameter">Example 22-3</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p>The other volume is an empty directory initially and is shared between the init container and the WildFly container.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p class="pagebreak-before">If you start this Deployment, the following will happen:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>An init container is created, and its command is executed. This container takes the <em>config.yml</em> from the ConfigMap volume, fills in the templates from the <em>/in</em> directory in an init container, and stores the processed files in the <em>/out</em> directory. The <em>/out</em> directory is where the volume <code>wildfly-config</code> is mounted.</p>&#13;
</li>&#13;
<li>&#13;
<p>After the init container is done, a WildFly server starts with an option so that it looks up the complete configuration from the <em>/config</em> directory. Again, <em>/config</em> is the shared volume <code>wildfly-config</code> containing the processed template files.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>It is important to note that we do <em>not</em> have to change these Deployment resource descriptors when going from the development to the production environment.&#13;
Only the ConfigMap with the template parameters is different.</p>&#13;
&#13;
<p>With this technique, it<a data-primary="configuration information" data-secondary="DRY configurations" data-type="indexterm" id="idm45902088352688"/><a data-primary="DRY (don't repeat yourself)" data-type="indexterm" id="idm45902088351840"/><a data-primary="don't repeat yourself (DRY)" data-type="indexterm" id="idm45902088351232"/> is easy to create a DRY configuration without copying and maintaining duplicated large configuration files.<sup><a data-type="noteref" href="ch22.html#idm45902088350368" id="idm45902088350368-marker">1</a></sup> For example, when the WildFly configuration changes for all environments, only a single template file in the init container needs to be updated. This approach has, of course, significant advantages on maintenance as there is no danger of configuration drift.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>When working with Pods and volumes, as in this pattern, it is not obvious how to debug if things don’t work as expected. So if you want to examine the processed templates, check out the directory <em>/var/lib/kubelet/pods/{podid}/volumes/kubernetes.io~empty-dir/</em> on the node, as it contains the content of an <code>emptyDir</code> volume. Alternatively, just <code>kubectl exec</code> into the Pod when it is running, and examine the mounted directory (<em>/config</em> in our example) for any created files.<a data-primary="" data-startref="wildfly22" data-type="indexterm" id="idm45902088346832"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect1"><div class="sect1" id="idm45902088768864">&#13;
<h1>Discussion</h1>&#13;
&#13;
<p>The <em>Configuration Template</em> pattern builds on top of the <em>Configuration Resource</em> pattern and is especially suited when we need to operate applications in different environments with similar complex configurations. However, the setup with configuration templates is more complicated and has more moving parts that can go wrong. Use it only if your application requires huge configuration data. Such applications often require a considerable amount of configuration data from which only a small fraction is dependent on the environment. Even when copying over the whole configuration directly into the environment-specific ConfigMap works initially, it puts a burden on the maintenance of that configuration because it is doomed to diverge over time.&#13;
For such a situation, this template approach is perfect.</p>&#13;
&#13;
<p>If you are running on top of Red Hat OpenShift, an enterprise Kubernetes distribution, you have an alternative by using <a href="https://oreil.ly/JuYab">OpenShift templates</a> for parameterizing resource descriptors.&#13;
This approach does not solve the challenge of large configuration sets but is still very helpful for applying the same deployment resources to slightly varying environments.<a data-primary="" data-startref="cnfgtmplt22" data-type="indexterm" id="idm45902088343120"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="More Information" data-type="sect1"><div class="sect1" id="idm45902088341888">&#13;
<h1>More Information</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/gzSdc">Configuration Template Example</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/0gPNC">Tiller Template Engine</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/e-5mR">Gomplate</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/fHi0o">Go Template Syntax</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45902088350368"><sup><a href="ch22.html#idm45902088350368-marker">1</a></sup> <a href="https://oreil.ly/Xitl7">DRY</a> is an acronym for “Don’t Repeat Yourself.”</p></div></div></section></body></html>