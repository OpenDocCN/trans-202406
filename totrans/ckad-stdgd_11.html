<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:epub="http://www.idpf.org/2007/ops" lang="en" xml:lang="en" xsi:schemaLocation="http://www.w3.org/2002/06/xhtml2/ http://www.w3.org/MarkUp/SCHEMA/xhtml2.xsd">
  <head>
    <title>Unknown</title>
    <link rel="stylesheet" type="text/css" href="../stylesheet.css"/>
    <link rel="stylesheet" type="text/css" href="../page_styles.css"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  </head>
  <body class="calibre"><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Deployment Strategies" class="praise"><div class="dedication" id="deployment_strategies">
<h1 class="calibre14"><span class="keep-together">Chapter 11. </span>Deployment Strategies</h1>


<p class="author1">Deploying an application (bundled into a container image) to one or many Pods is only the beginning of its life cycle within a Kubernetes cluster. Periodically, developers will produce and publish new container image tags to ship bug fixes and new features. Manually updating Pods with a new container image tag one by one would be extremely tedious. Kubernetes offers the Deployment primitive to streamline the 
<span class="keep-together">process.</span></p>

<p class="author1"><a data-type="xref" href="ch10.xhtml#deployments" class="calibre10">Chapter 10</a> explained how to automatically roll out a new release using the Deployment primitive. In this chapter, we will discuss the built-in deployment strategies supported by the primitive. We’ll also talk about other deployment strategies that require deliberate human decisions. Each deployment strategy is presented with an example featuring their benefits and potential trade-offs. More deployment strategies exist, but they will not be covered in this book.</p>
<div data-type="note" epub:type="note" class="calibre26"><h6 class="calibre27">Note</h6>
<p class="author1">Some deployment strategies require the use of concepts not yet discussed. Jump to <a data-type="xref" href="ch14.xhtml#container_probes" class="calibre10">Chapter 14</a> for coverage of container probes. Reference <a data-type="xref" href="ch21.xhtml#services" class="calibre10">Chapter 21</a> for more information on the purpose of Services.</p>
</div>
<aside data-type="sidebar" epub:type="sidebar" class="calibre48"><div class="sidebar" id="id480">
<h1 class="calibre49">Coverage of Curriculum Objectives</h1>
<p class="author1">This chapter addresses the following curriculum objective:</p>

<ul class="printings">
<li class="calibre13">
<p class="author1">Use Kubernetes primitives to implement common deployment strategies (e.g., blue/green or canary)</p>
</li>
</ul>
</div></aside>






<section data-type="sect1" data-pdf-bookmark="Rolling Deployment Strategy" class="praise"><div class="dedication" id="id269">
<h1 class="calibre17">Rolling Deployment Strategy</h1>

<p class="author1">The Deployment primitive employs rolling deployment as the default deployment strategy, also referred to as ramped deployment. It’s called “ramped” because the Deployment gradually transitions replicas from the old version to a new version in batches. The Deployment automatically creates a new ReplicaSet for the desired change after the user updates the Pod template.</p>

<p class="author1"><a data-type="xref" href="#deployment_strategy_rolling_update" class="calibre10">Figure 11-1</a> shows a snapshot in time during the rollout process.</p>

<figure class="calibre35"><div id="deployment_strategy_rolling_update" class="figure">
<img src="Images/ckd2_1101.png" alt="ckd2 1101" class="calibre87"/>
<h6 class="calibre32"><span class="keep-together">Figure 11-1. </span>The rolling deployment strategy</h6>
</div></figure>

<p class="author1">In this scenario, the user initiated an update of the application version from 1.0.0 to 2.0.0. As a result, the Deployment creates a new ReplicaSet and starts up Pods running the new application version while at the same time scaling down the old version. The Service routes network traffic to either the old or new version of the application.</p>








<section data-type="sect2" data-pdf-bookmark="Implementation" class="praise"><div class="dedication" id="id270">
<h2 class="calibre33">Implementation</h2>

<p class="author1">A Deployment uses the rolling deployment strategy by default. The runtime value for the attribute <code class="calibre15">spec.strategy.type</code> is <code class="calibre15">RollingUpdate</code>. Users can fine-tune this strategy. You can use the attributes <code class="calibre15">spec.strategy.rollingUpdate.maxUnavailable</code> and <code class="calibre15">spec.strategy.rollingUpdate.maxSurge</code> to change the rollout rate. Both attributes can use a fixed integer (for example, 3) or assign a percentage of the total required number of Pods (for example, 33%). The default value for <code class="calibre15">maxUnavailable</code> and <code class="calibre15">maxSurge</code> is 25%.</p>

<p class="author1">The attribute <code class="calibre15">maxUnavailable</code> specifies the maximum number of Pods that can be unavailable during the update process. For example, if you set the value to 40%, then the old ReplicaSet can scale down to 60% immediately when the rolling update starts.</p>

<p class="author1">The attribute <code class="calibre15">maxSurge</code> specifies the maximum number of Pods that can be created over the desired number of Pods. For example, if you set the value to 10%, the total number of new and old Pods cannot exceed a total of 110% after the new ReplicaSet has been created.</p>

<p class="author1">Independent of the values assigned to the attributes <code class="calibre15">maxUnavailable</code> and <code class="calibre15">maxSurge</code>, all replicas controlled by the old ReplicaSet will be ramped down to 0 over time until all replicas controlled by the new ReplicaSet equals the value of <code class="calibre15">spec.replicas</code>.</p>

<p class="author1">It’s recommended to define a readiness probe for the Pod template to ensure that a replica is ready to handle incoming requests. The attribute <code class="calibre15">spec.minReadySeconds</code> specifies the number of seconds a replica needs to be available for before it is made available to incoming requests.</p>

<p class="author1"><a data-type="xref" href="#yaml_manifest_deployment_rolling_update" class="calibre10">Example 11-1</a> shows the usage of those attributes in the context of a full Deployment YAML manifest stored in the file <em class="calibre3">deployment-rolling-update.yaml</em>.</p>
<div id="yaml_manifest_deployment_rolling_update" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 11-1. </span>A Deployment configured with a rolling update strategy</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Deployment</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">web-server</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="calibre15">4</code><code class="w">
</code><code class="w">  </code><code class="nt">strategy</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="calibre15">RollingUpdate</code><code class="w">
</code><code class="w">    </code><code class="nt">rollingUpdate</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">maxUnavailable</code><code class="p">:</code><code class="w"> </code><code class="calibre15">40%</code><code class="w">   </code><a class="calibre10" id="co_deployment_strategies_CO1-1" href="#callout_deployment_strategies_CO1-1"><img src="Images/1.png" alt="1" class="calibre51"/></a><code class="w">
</code><code class="w">      </code><code class="nt">maxSurge</code><code class="p">:</code><code class="w"> </code><code class="calibre15">10%</code><code class="w">         </code><a class="calibre10" id="co_deployment_strategies_CO1-2" href="#callout_deployment_strategies_CO1-2"><img src="Images/2.png" alt="2" class="calibre51"/></a><code class="w">
</code><code class="w">  </code><code class="nt">minReadySeconds</code><code class="p">:</code><code class="w"> </code><code class="calibre15">60</code><code class="w">       </code><a class="calibre10" id="co_deployment_strategies_CO1-3" href="#callout_deployment_strategies_CO1-3"><img src="Images/3.png" alt="3" class="calibre51"/></a><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd</code><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd</code><code class="w">
</code><code class="w">        </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd:2.4.23-alpine</code><code class="w">
</code><code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="calibre15">80</code><code class="w">
</code><code class="w">          </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="calibre15">TCP</code><code class="w">
</code><code class="w">        </code><code class="nt">readinessProbe</code><code class="p">:</code><code class="w">     </code><a class="calibre10" id="co_deployment_strategies_CO1-4" href="#callout_deployment_strategies_CO1-4"><img src="Images/4.png" alt="4" class="calibre51"/></a><code class="w">
</code><code class="w">          </code><code class="nt">httpGet</code><code class="p">:</code><code class="w">
</code><code class="w">            </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="calibre15">/</code><code class="w">
</code><code class="w">            </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="calibre15">80</code></pre></div>
<dl class="calibre18">
<dt class="calibre52"><a class="calibre10" id="callout_deployment_strategies_CO1-1" href="#co_deployment_strategies_CO1-1"><img src="Images/1.png" alt="1" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">The percentage of Pods that can be unavailable during the update.</p></dd>
<dt class="calibre52"><a class="calibre10" id="callout_deployment_strategies_CO1-2" href="#co_deployment_strategies_CO1-2"><img src="Images/2.png" alt="2" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">The percentage of Pods that can temporarily exceed the total number of replicas.</p></dd>
<dt class="calibre52"><a class="calibre10" id="callout_deployment_strategies_CO1-3" href="#co_deployment_strategies_CO1-3"><img src="Images/3.png" alt="3" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">The number of seconds for which the readiness probe in a Pod needs to be healthy until the rollout process can continue.</p></dd>
<dt class="calibre52"><a class="calibre10" id="callout_deployment_strategies_CO1-4" href="#co_deployment_strategies_CO1-4"><img src="Images/4.png" alt="4" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">The readiness probe for all replicas referred to by <code class="calibre15">spec.minReadySeconds</code>.</p></dd>
</dl>

<p class="author1">The combination of assigned values to <code class="calibre15">maxUnavailable</code> and <code class="calibre15">maxSurge</code> determines the runtime behavior and speed of a rollout. You will adjust those parameters to find the most suitable combination for your application.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Use Cases and Trade-Offs" class="praise"><div class="dedication" id="id271">
<h2 class="calibre33">Use Cases and Trade-Offs</h2>

<p class="author1">The rolling deployment is a fitting deployment strategy for rolling out a new application version with zero downtime. Depending on the number of replicas the Deployment manages, this process can be relatively slow, as old versions of the applications are ramped down and new versions of the application are ramped up in batches.</p>

<p class="author1">It’s important to mention that this deployment strategy comes with a potential risk. Old and new versions of the application run in parallel. Breaking changes introduced with the new version can lead to unexpected and hard-to-debug errors for consumers if they haven’t adapted their client software to the latest changes. It’s a good idea to roll out a new application version in a backward-compatible fashion, for example by using a versioned API, to avoid running into this situation.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Fixed Deployment Strategy" class="praise"><div class="dedication" id="id272">
<h1 class="calibre17">Fixed Deployment Strategy</h1>

<p class="author1">The fixed deployment strategy will terminate replicas with the old application version at once before creating another ReplicaSet that controls replicas running the new application version.</p>

<p class="author1"><a data-type="xref" href="#deployment_strategy_fixed" class="calibre10">Figure 11-2</a> illustrates the rollout process while updating the Pod template from application version 1.0.0 to 2.0.0. All replicas of the old ReplicaSet are shut down simultaneously. Then, the replicas controlled by the new ReplicaSet are started. During this process, the Service may not be able to reach any of the replicas, which can lead to unnecessary downtime for consumers.</p>

<figure class="calibre35"><div id="deployment_strategy_fixed" class="figure">
<img src="Images/ckd2_1102.png" alt="ckd2 1102" class="calibre88"/>
<h6 class="calibre32"><span class="keep-together">Figure 11-2. </span>The fixed deployment strategy</h6>
</div></figure>








<section data-type="sect2" data-pdf-bookmark="Implementation" class="praise"><div class="dedication" id="id273">
<h2 class="calibre33">Implementation</h2>

<p class="author1">To configure the fixed deployment strategy for a Deployment, set the attribute <code class="calibre15">spec.strategy.type</code> to <code class="calibre15">Recreate</code>. Internally, this strategy type will automatically assign the total number of replicas to the attribute <code class="calibre15">maxUnavailable</code>. No other configuration options need to be provided.</p>

<p class="author1"><a data-type="xref" href="#yaml_manifest_deployment_fixed" class="calibre10">Example 11-2</a> shows the <code class="calibre15">Recreate</code> strategy type in the context of a full Deployment YAML manifest stored in the file <em class="calibre3">deployment-fixed.yaml</em>.</p>
<div id="yaml_manifest_deployment_fixed" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 11-2. </span>A Deployment configured with a fixed deployment strategy</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Deployment</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">web-server</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="calibre15">4</code><code class="w">
</code><code class="w">  </code><code class="nt">strategy</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Recreate</code><code class="w">   </code><a class="calibre10" id="co_deployment_strategies_CO2-1" href="#callout_deployment_strategies_CO2-1"><img src="Images/1.png" alt="1" class="calibre51"/></a><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd</code><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd</code><code class="w">
</code><code class="w">        </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd:2.4.23-alpine</code><code class="w">
</code><code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="calibre15">80</code><code class="w">
</code><code class="w">          </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="calibre15">TCP</code></pre></div>
<dl class="calibre18">
<dt class="calibre52"><a class="calibre10" id="callout_deployment_strategies_CO2-1" href="#co_deployment_strategies_CO2-1"><img src="Images/1.png" alt="1" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">The strategy type for configuring fixed deployment.</p></dd>
</dl>

<p class="author1">Assigning a readiness probe to containers defined by the Pod template isn’t strictly necessary because all replicas with the old application version will be shut down at once. Nevertheless, it still makes sense to verify that the application is up and running by defining a readiness probe before incoming traffic can reach the container.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Use Cases and Trade-Offs" class="praise"><div class="dedication" id="id274">
<h2 class="calibre33">Use Cases and Trade-Offs</h2>

<p class="author1">The fixed deployment strategy is suitable for situations where application downtime is acceptable. For example, it’s great if you want to roll out a new application to a developer environment for testing purposes. For production environments, this deployment strategy may work if you announce an outage time window to 
<span class="keep-together">customers.</span></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Blue-Green Deployment Strategy" class="praise"><div class="dedication" id="id275">
<h1 class="calibre17">Blue-Green Deployment Strategy</h1>

<p class="author1">The blue-green deployment strategy (sometimes referred to as red-black deployment strategy) figuratively uses blue as a representation of the old application version and green as a representation of the new application version. Both application versions will be operated at the same time with an equal number of replicas.</p>

<p class="author1">Kubernetes routes traffic to the blue deployment, while the development or test team rolls out and tests the green deployment. Traffic is switched over to the green deployment as soon as it is considered production-ready. At that point, the team managing the application can decommission the blue deployment.</p>

<p class="author1"><a data-type="xref" href="#deployment_strategy_blue_green" class="calibre10">Figure 11-3</a> shows two Deployments managing replicas with different application versions. The Services can switch network traffic from the old application version to the new application version by changing the label selection.</p>

<figure class="calibre35"><div id="deployment_strategy_blue_green" class="figure">
<img src="Images/ckd2_1103.png" alt="ckd2 1103" class="calibre88"/>
<h6 class="calibre32"><span class="keep-together">Figure 11-3. </span>The blue-green deployment strategy</h6>
</div></figure>








<section data-type="sect2" data-pdf-bookmark="Implementation" class="praise"><div class="dedication" id="id276">
<h2 class="calibre33">Implementation</h2>

<p class="author1">Blue-green deployment is not a built-in strategy you can configure within the Deployment resource. You will have to create a Deployment object for both application versions. The Service routes traffic to replicas managed by either the blue or the green Deployment.</p>

<p class="author1"><a data-type="xref" href="#yaml_manifest_deployment_blue" class="calibre10">Example 11-3</a> shows a blue Deployment YAML manifest stored in the file <em class="calibre3">deployment-blue.yaml</em> specifying the container image <code class="calibre15">httpd:2.4.23-alpine</code> in the Pod template.</p>
<div id="yaml_manifest_deployment_blue" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 11-3. </span>A blue Deployment</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Deployment</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">web-server-blue</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="calibre15">4</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="calibre15">blue</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="calibre15">blue</code><code class="w">                   </code><a class="calibre10" id="co_deployment_strategies_CO3-1" href="#callout_deployment_strategies_CO3-1"><img src="Images/1.png" alt="1" class="calibre51"/></a><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd</code><code class="w">
</code><code class="w">        </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd:2.4.23-alpine</code><code class="w">   </code><a class="calibre10" id="co_deployment_strategies_CO3-2" href="#callout_deployment_strategies_CO3-2"><img src="Images/2.png" alt="2" class="calibre51"/></a><code class="w">
</code><code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="calibre15">80</code><code class="w">
</code><code class="w">          </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="calibre15">TCP</code></pre></div>
<dl class="calibre18">
<dt class="calibre52"><a class="calibre10" id="callout_deployment_strategies_CO3-1" href="#co_deployment_strategies_CO3-1"><img src="Images/1.png" alt="1" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">Uses the label assignment <code class="calibre15">type: blue</code> to any replica managed by the corresponding ReplicaSet.</p></dd>
<dt class="calibre52"><a class="calibre10" id="callout_deployment_strategies_CO3-2" href="#co_deployment_strategies_CO3-2"><img src="Images/2.png" alt="2" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">The old application version <code class="calibre15">2.4.23-alpine</code>.</p></dd>
</dl>

<p class="author1">To set up a green deployment that runs the newer container image <code class="calibre15">httpd:2.4.57-alpine</code>, simply create another Deployment object. Note that the label used for the Pod template is different than for the blue deployment. <a data-type="xref" href="#yaml_manifest_deployment_green" class="calibre10">Example 11-4</a> shows the green Deployment definition in the file <em class="calibre3">deployment-green.yaml</em>.</p>
<div id="yaml_manifest_deployment_green" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 11-4. </span>A green Deployment</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">apps/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Deployment</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">web-server-green</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="calibre15">4</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="calibre15">green</code><code class="w">
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="calibre15">green</code><code class="w">                  </code><a class="calibre10" id="co_deployment_strategies_CO4-1" href="#callout_deployment_strategies_CO4-1"><img src="Images/1.png" alt="1" class="calibre51"/></a><code class="w">
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd</code><code class="w">
</code><code class="w">        </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd:2.4.57-alpine</code><code class="w">   </code><a class="calibre10" id="co_deployment_strategies_CO4-2" href="#callout_deployment_strategies_CO4-2"><img src="Images/2.png" alt="2" class="calibre51"/></a><code class="w">
</code><code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="calibre15">80</code><code class="w">
</code><code class="w">          </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="calibre15">TCP</code></pre></div>
<dl class="calibre18">
<dt class="calibre52"><a class="calibre10" id="callout_deployment_strategies_CO4-1" href="#co_deployment_strategies_CO4-1"><img src="Images/1.png" alt="1" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">Uses the label assignment <code class="calibre15">type: green</code> to any replica managed by the corresponding ReplicaSet.</p></dd>
<dt class="calibre52"><a class="calibre10" id="callout_deployment_strategies_CO4-2" href="#co_deployment_strategies_CO4-2"><img src="Images/2.png" alt="2" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">The new application version <code class="calibre15">2.4.57-alpine</code>.</p></dd>
</dl>

<p class="author1">As mentioned earlier, the Service is the Kubernetes object responsible for routing network traffic to the old or new application version. <a data-type="xref" href="#yaml_manifest_deployment_blue_green_service" class="calibre10">Example 11-5</a> shows a Service object.</p>
<div id="yaml_manifest_deployment_blue_green_service" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 11-5. </span>The Service routing network traffic to a blue deployment</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Service</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">web-server</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="calibre15">blue</code><code class="w">   </code><a class="calibre10" id="co_deployment_strategies_CO5-1" href="#callout_deployment_strategies_CO5-1"><img src="Images/1.png" alt="1" class="calibre51"/></a><code class="w">
</code><code class="w">  </code><code class="nt">ports</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="calibre15">TCP</code><code class="w">
</code><code class="w">      </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="calibre15">80</code><code class="w">
</code><code class="w">      </code><code class="nt">targetPort</code><code class="p">:</code><code class="w"> </code><code class="calibre15">80</code></pre></div>
<dl class="calibre18">
<dt class="calibre52"><a class="calibre10" id="callout_deployment_strategies_CO5-1" href="#co_deployment_strategies_CO5-1"><img src="Images/1.png" alt="1" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">The label selector pointing to replicas managed by the blue deployment.</p></dd>
</dl>

<p class="author1">The resource declaration currently points to the blue deployment; to switch to green, simply change the label selection from <code class="calibre15">type: blue</code> to <code class="calibre15">type: green</code>. At that point, you can delete the blue Deployment.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Use Cases and Trade-Offs" class="praise"><div class="dedication" id="id277">
<h2 class="calibre33">Use Cases and Trade-Offs</h2>

<p class="author1">The blue-green deployment strategy is suitable for deployment scenarios where complex upgrades need to be performed without downtime to consumers. This situation may arise if a rollout requires a data migration or if multiple, dependent software components need to be changed at once. Should a rollback to the old application version be required, a simple change of the label selection in the Service will do.</p>

<p class="author1">On the downside, it’s worth mentioning that you will need more hardware resources than for other deployment strategies. If you need five replicas to run the old application version, then you will need the same amount of resources for the new application version, assuming the resource requirements won’t differ.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Canary Deployment Strategy" class="praise"><div class="dedication" id="id278">
<h1 class="calibre17">Canary Deployment Strategy</h1>

<p class="author1">The canary deployment strategy is similar to the blue-green deployment; however, you’d make the new application version available to only a subset of consumers. With this approach, you can implement A/B testing of new features or if you need to gather metrics about consumer behavior. Based on the defined set of success criteria, traffic to the new application version can be increased gradually. The goal is to shut down the old application version completely.</p>

<p class="author1"><a data-type="xref" href="#deployment_strategy_canary" class="calibre10">Figure 11-4</a> shows how the Service sends traffic to both application versions.</p>

<figure class="calibre35"><div id="deployment_strategy_canary" class="figure">
<img src="Images/ckd2_1104.png" alt="ckd2 1104" class="calibre89"/>
<h6 class="calibre32"><span class="keep-together">Figure 11-4. </span>The canary deployment strategy</h6>
</div></figure>

<p class="author1">Deployment 1 controls application version v1.0.0. Deployment 2 controls application version v2.0.0. Deployments 1 and 2 use the same label assignment in their Pod template. The Service selects the label key-value pair(s) defined by both Deployments.</p>








<section data-type="sect2" data-pdf-bookmark="Implementation" class="praise"><div class="dedication" id="id279">
<h2 class="calibre33">Implementation</h2>

<p class="author1">In a Kubernetes cluster, you represent each application version with the help of a Deployment object. You want to roll out the new application version with fewer replicas than the current application version by assigning a smaller value to the attribute <code class="calibre15">spec.replicas</code>.</p>

<p class="author1">The following code snippet shows the truncated definition of the Deployment controlling the old application version:</p>

<pre data-type="programlisting" data-code-language="yaml" class="calibre37"><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Deployment</code><code class="w"></code>
<code class="nt">spec</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="calibre15">4</code><code class="w"></code>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"></code>
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"></code>
<code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd</code><code class="w"></code></pre>

<p class="author1">For the new application version, assign a smaller number of replicas:</p>

<pre data-type="programlisting" data-code-language="yaml" class="calibre37"><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Deployment</code><code class="w"></code>
<code class="nt">spec</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="calibre15">1</code><code class="w"></code>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"></code>
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"></code>
<code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd</code><code class="w"></code></pre>

<p class="author1">To ensure that replicas for old and new application versions receive requests from consumers, the assigned Pod template label(s) in both Deployment objects need to be the same. Ensure that the Service selects those label(s), as shown in this truncated Service definition:</p>

<pre data-type="programlisting" data-code-language="yaml" class="calibre37"><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Service</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="calibre15">httpd</code><code class="w">   </code><a class="calibre10" id="co_deployment_strategies_CO6-1" href="#callout_deployment_strategies_CO6-1"><img src="Images/1.png" alt="1" class="calibre51"/></a></pre>
<dl class="calibre18">
<dt class="calibre52"><a class="calibre10" id="callout_deployment_strategies_CO6-1" href="#co_deployment_strategies_CO6-1"><img src="Images/1.png" alt="1" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">Selects the label assigned to both Deployments.</p></dd>
</dl>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Use Cases and Trade-Offs" class="praise"><div class="dedication" id="id280">
<h2 class="calibre33">Use Cases and Trade-Offs</h2>

<p class="author1">Organization typically use the canary deployment strategy to roll out experimental features or changes with potential impact on system performance. You can evaluate your success criteria while making the new feature available to only a subset of consumers. Implementing a canary deployment usually requires fewer hardware resources than the blue-green deployment as the number of replicas with the new application version is much lower.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Summary" class="praise"><div class="dedication" id="id281">
<h1 class="calibre17">Summary</h1>

<p class="author1">A deployment is the process of making a software change available to end users or programs. You need to consider two aspects: the procedure of how to deploy a change and the routing of network traffic to the application. Select an appropriate deployment strategy based on use case, application type, and trade-offs.</p>

<p class="author1">With the Deployment primitive, Kubernetes natively supports two deployment strategies: the rolling deployment and the fixed deployment. The rolling deployment, specified by the <code class="calibre15">RollingUpdate</code> strategy, rolls out a change gradually in batches. The fixed deployment, configured by the <code class="calibre15">Recreate</code> strategy, first shuts down the old application version and then brings up the new application version.</p>

<p class="author1">The blue-green and canary deployment strategies can be set up by creating a second Deployment object that manages the new application version in parallel with the old one. The Service then routes network traffic to replicas of both application versions (blue-green) or transitions consumers to the new application version over time 
<span class="keep-together">(canary).</span></p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Exam Essentials" class="praise"><div class="dedication" id="id282">
<h1 class="calibre17">Exam Essentials</h1>
<dl class="calibre18">
<dt class="calibre19">Understand how to configure strategies native to the Deployment primitive</dt>
<dd class="calibre20">
<p class="calibre21">The exam may confront you with different deployment strategies. You need to understand how to implement the most common strategies and how to modify an existing deployment scenario. Learn how to configure the built-in strategies in the Deployment primitive and their options for fine-tuning the runtime 
<span class="keep-together">behavior.</span></p>
</dd>
<dt class="calibre19">Practice multi-phased deployment strategies</dt>
<dd class="calibre20">
<p class="calibre21">You can implement even more sophisticated deployment scenarios with the help of the Deployment and Service primitives. Examples are the blue-green and canary deployment strategies, which require a multi-phased rollout process. Expose yourself to implementation techniques and rollout procedures. Operators provided by the Kubernetes community, e.g., <a href="https://argo-rollouts.readthedocs.io/en/stable/" class="calibre10">Argo Rollouts</a>, offer higher-level abstractions for more sophisticated deployment strategies. The exam does not require you to understand external tooling to implement deployment strategies.</p>
</dd>
</dl>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Sample Exercises" class="praise"><div class="dedication" id="id283">
<h1 class="calibre17">Sample Exercises</h1>

<p class="author1">Solutions to these exercises are available in <a href="app01_split_007.xhtml#appendix_a_deployment_strategies" class="calibre10">Appendix A</a>.</p>
<ol class="calibre55">
<li class="calibre56">
<p class="author1">One of your teammates created a Deployment YAML manifest to operate the container image <code class="calibre15">grafana/grafana:9.5.9</code>. Create the Deployment object from the YAML manifest file <code class="calibre15">deployment-grafana.yaml</code>:</p>

<pre data-type="programlisting" data-code-language="yaml" class="calibre37"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">apps/v1</code><code class="w"></code>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Deployment</code><code class="w"></code>
<code class="nt">metadata</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">grafana</code><code class="w"></code>
<code class="nt">spec</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="calibre15">6</code><code class="w"></code>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"></code>
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"></code>
<code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="calibre15">grafana</code><code class="w"></code>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"></code>
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"></code>
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"></code>
<code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="calibre15">grafana</code><code class="w"></code>
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"></code>
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"></code>
<code class="w">      </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="calibre15">grafana/grafana:9.5.9</code><code class="w"></code>
<code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">grafana</code><code class="w"></code>
<code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w"></code>
<code class="w">        </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="calibre15">3000</code><code class="w"></code></pre>

<p class="author1">You need to update all replicas with the container image <code class="calibre15">grafana/grafana:10.1.2</code>. Make sure that the rollout happens in batches of two replicas at a time. Ensure that a readiness probe is defined.</p>
</li>
<li class="calibre56">
<p class="author1">In this exercise, you will set up a blue-green Deployment scenario. You’ll first create the initial (blue) Deployment and expose it with a Service. Later, you will create a second (green) Deployment and switch over traffic.</p>

<p class="author1">Create a Deployment named <code class="calibre15">nginx-blue</code> with 3 replicas. The Pod template of the Deployment should use container image <code class="calibre15">nginx:1.23.0</code> and assign the label 
<span class="keep-together"><code class="calibre15">version=blue</code>.</span></p>

<p class="author1">Expose the Deployment with a Service of type ClusterIP named <code class="calibre15">nginx</code>. Map the incoming and outgoing port to 80. Select the Pod with label <code class="calibre15">version=blue</code>.</p>

<p class="author1">Run a temporary Pod with the container image <code class="calibre15">alpine/curl:3.14</code> to make a call against the Service using <code class="calibre15">curl</code>.</p>

<p class="author1">Create a second Deployment named <code class="calibre15">nginx-green</code> with 3 replicas. The Pod template of the Deployment should use container image <code class="calibre15">nginx:1.23.4</code> and assign the label <code class="calibre15">version=green</code>.</p>

<p class="author1">Change the Service’s label selection so that traffic will be routed to the Pods controlled by the Deployment <code class="calibre15">nginx-green</code>.</p>

<p class="author1">Delete the Deployment named <code class="calibre15">nginx-blue</code>.</p>

<p class="author1">Run a temporary Pod with the container image <code class="calibre15">alpine/curl:3.14</code> to make a call against the Service.</p>
</li>

</ol>
</div></section>
</div></section></div></body>
</html>