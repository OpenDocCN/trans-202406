<html><head></head><body><section data-pdf-bookmark="Chapter 17. Adapter" data-type="chapter" epub:type="chapter"><div class="chapter" id="Adapter">&#13;
<h1><span class="label">Chapter 17. </span>Adapter</h1>&#13;
&#13;
&#13;
<p>The<a data-primary="Adapter" data-type="indexterm" id="adptr17"/> <em>Adapter</em> pattern takes a heterogeneous containerized system and makes it conform to a consistent, unified interface with a standardized and normalized format that can be consumed by the outside world.&#13;
The <em>Adapter</em> pattern inherits all its characteristics from the<a data-primary="Sidecar" data-type="indexterm" id="idm45902091403920"/><a data-primary="Sidecar" data-secondary="Adapter" data-type="indexterm" id="idm45902091403216"/> <em>Sidecar</em> pattern but has the single purpose of providing adapted access to the application.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect1"><div class="sect1" id="idm45902091401728">&#13;
<h1>Problem</h1>&#13;
&#13;
<p>Containers<a data-primary="problems" data-secondary="application access, providing unified" data-type="indexterm" id="idm45902091400400"/><a data-primary="heterogeneous components, managing" data-type="indexterm" id="idm45902091399424"/> allow us to package and run applications written in different libraries and languages in a unified way. Today, it is common to see multiple teams using different technologies and creating distributed systems composed of heterogeneous components. This heterogeneity can cause difficulties when all components have to be treated in a unified way by other systems. The <em>Adapter</em> pattern offers a solution by hiding the complexity of a system and providing unified access to it.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect1"><div class="sect1" id="idm45902091397904">&#13;
<h1>Solution</h1>&#13;
&#13;
<p>The best way to illustrate the <em>Adapter</em> pattern is through an example. A major prerequisite for successfully running and supporting distributed systems is providing detailed monitoring and alerting. Moreover, if we have a distributed system composed of multiple services we want to monitor, we may use an external monitoring tool to poll metrics from every service and record them.</p>&#13;
&#13;
<p>However, services written in different languages may not have the same capabilities and may not expose metrics in the same format expected by the monitoring tool. This diversity creates a challenge for monitoring such a heterogeneous application from a single monitoring solution that expects a unified view of the whole system. With the <em>Adapter</em> pattern, it is possible to provide a unified monitoring interface by exporting metrics from various application containers into one standard format and protocol. In <a data-type="xref" href="#img-adapter">Figure 17-1</a>, an adapter container translates locally stored metrics information into the external format the monitoring server understands.</p>&#13;
&#13;
<figure><div class="figure" id="img-adapter">&#13;
<img alt="Adapter pattern" src="assets/kup2_1701.png"/>&#13;
<h6><span class="label">Figure 17-1. </span>Adapter pattern</h6>&#13;
</div></figure>&#13;
&#13;
<p>With this approach, every service represented by a Pod, in addition to the main application container, would have another container that knows how to read the custom application-specific metrics and expose them in a generic format understandable by the monitoring tool. We could have one adapter container that knows how to export Java-based metrics over HTTP and another adapter container in a different Pod that exposes Python-based metrics over HTTP. For the monitoring tool, all metrics would be available over HTTP and in a common, normalized format.</p>&#13;
&#13;
<p>For a concrete implementation of this pattern, let’s add the adapter shown in <a data-type="xref" href="#img-adapter">Figure 17-1</a> to our sample random generator application. When appropriately configured, it writes out a log file with the random-number generator and includes the time it took to create the random number. We want to monitor this time with Prometheus. Unfortunately, the log format doesn’t match the format Prometheus expects. Also, we need to offer this information over an HTTP endpoint so that a Prometheus server can scrape the value.</p>&#13;
&#13;
<p>For this use case, an adapter is a perfect fit: a sidecar container starts a small HTTP server and on every request, reads the custom log file and transforms it into a Prometheus-understandable format. <a data-type="xref" href="#ex-adapter">Example 17-1</a> shows a Deployment with such an adapter. This configuration allows a decoupled Prometheus monitoring setup without the main application needing to know anything about Prometheus. The full example in the book’s GitHub repository demonstrates this setup together with a Prometheus installation.</p>&#13;
<div class="less_space pagebreak-before" data-type="example" id="ex-adapter">&#13;
<h5><span class="label">Example 17-1. </span>Adapter delivering Prometheus-conformant output</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w">&#13;
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w">&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="nt">spec</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">k8spatterns/random-generator:1.0</code><code class="w">      </code><a class="co" href="#callout_adapter_CO1-1" id="co_adapter_CO1-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">env</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">LOG_FILE</code><code class="w">                             </code><a class="co" href="#callout_adapter_CO1-2" id="co_adapter_CO1-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/logs/random.log</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w">&#13;
</code><code class="w">          </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w">                                </code><a class="co" href="#callout_adapter_CO1-3" id="co_adapter_CO1-3"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/logs</code><code class="w">&#13;
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">log-volume</code><code class="w">&#13;
</code><code class="w">      </code><code class="c1"># --------------------------------------------</code><code class="w">&#13;
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">k8spatterns/random-generator-exporter</code><code class="w"> </code><a class="co" href="#callout_adapter_CO1-4" id="co_adapter_CO1-4"><img alt="4" src="assets/4.png"/></a><code class="w">&#13;
</code><code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">prometheus-adapter</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">env</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">LOG_FILE</code><code class="w">                             </code><a class="co" href="#callout_adapter_CO1-5" id="co_adapter_CO1-5"><img alt="5" src="assets/5.png"/></a><code class="w">&#13;
</code><code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/logs/random.log</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">9889</code><code class="w">&#13;
</code><code class="w">          </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w">                                </code><a class="co" href="#callout_adapter_CO1-6" id="co_adapter_CO1-6"><img alt="6" src="assets/6.png"/></a><code class="w">&#13;
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/logs</code><code class="w">&#13;
</code><code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">log-volume</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">volumes</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">log-volume</code><code class="w">                             </code><a class="co" href="#callout_adapter_CO1-7" id="co_adapter_CO1-7"><img alt="7" src="assets/7.png"/></a><code class="w">&#13;
</code><code class="w">        </code><code class="nt">emptyDir</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_adapter_CO1-1" id="callout_adapter_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Main application container with the random generator service exposed on 8080.</p></dd>&#13;
<dt><a class="co" href="#co_adapter_CO1-2" id="callout_adapter_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Path to the log file containing the timing information about random-number generation.</p></dd>&#13;
<dt><a class="co" href="#co_adapter_CO1-3" id="callout_adapter_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Directory shared with the Prometheus Adapter container.</p></dd>&#13;
<dt><a class="co" href="#co_adapter_CO1-4" id="callout_adapter_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Prometheus exporter image, exporting on port 9889.</p></dd>&#13;
<dt><a class="co" href="#co_adapter_CO1-5" id="callout_adapter_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Path to the same log file to which the main application is logging.</p></dd>&#13;
<dt><a class="co" href="#co_adapter_CO1-6" id="callout_adapter_CO1-6"><img alt="6" src="assets/6.png"/></a></dt>&#13;
<dd><p>Shared volume is also mounted in the adapter container.</p></dd>&#13;
<dt><a class="co" href="#co_adapter_CO1-7" id="callout_adapter_CO1-7"><img alt="7" src="assets/7.png"/></a></dt>&#13;
<dd><p>Files are shared via an <code>emptyDir</code> volume from the node’s filesystem.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Another use of this pattern is<a data-primary="logging" data-type="indexterm" id="idm45902091074288"/> logging. Different containers may log information in different formats and levels of detail. An adapter can normalize that information, clean it up, enrich it with contextual information by using<a data-primary="Self Awareness" data-type="indexterm" id="idm45902091073552"/><a data-primary="Self Awareness" data-secondary="Adapter" data-type="indexterm" id="idm45902091072944"/> the <em>Self Awareness</em> pattern described in <a data-type="xref" href="ch14.html#SelfAwareness">Chapter 14</a>, and then make it available for pickup by the centralized log aggregator.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect1"><div class="sect1" id="idm45902091070592">&#13;
<h1>Discussion</h1>&#13;
&#13;
<p>The <em>Adapter</em> is a specialization of the <em>Sidecar</em> pattern explained in <a data-type="xref" href="ch16.html#Sidecar">Chapter 16</a>. It acts as a reverse proxy to a heterogeneous system by hiding its complexity behind a unified interface. Using a distinct name different from the generic <em>Sidecar</em> pattern allows us to more precisely communicate the purpose of this pattern.</p>&#13;
&#13;
<p>In the next chapter, you’ll get to know another sidecar variation: the <em>Ambassador</em> pattern, which acts as a proxy to the outside world.<a data-primary="" data-startref="adptr17" data-type="indexterm" id="idm45902091066608"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="More Information" data-type="sect1"><div class="sect1" id="idm45902091065376">&#13;
<h1>More Information</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/ABSfi">Adapter Example</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section></body></html>