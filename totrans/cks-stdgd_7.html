<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 7. Monitoring, Logging, and Runtime Security" data-type="chapter" epub:type="chapter"><div class="chapter" id="monitoring_logging_runtimesecurity">
<h1><span class="label">Chapter 7. </span>Monitoring, Logging, and Runtime Security</h1>
<p><a data-primary="Falco" data-secondary="about" data-type="indexterm" id="idm46394749552400"/><a data-primary="behavior analytics" data-secondary="defined" data-type="indexterm" id="idm46394749551520"/><a data-primary="logging" data-seealso="behavior analytics" data-type="indexterm" id="log_ch"/><a data-primary="monitoring" data-seealso="behavior analytics" data-type="indexterm" id="mon_ch"/><a data-primary="runtime security" data-seealso="behavior analytics" data-type="indexterm" id="rs_ch"/>The last domain of the curriculum primarily deals with detecting suspicious activity on the host and container level in a Kubernetes cluster. We’ll first define the term <em>behavior analytics</em> and how it applies to the realm of Kubernetes. With the theory out of the way, we’ll bring in the tool called Falco that can detect intrusion scenarios.</p>
<p>Once a container has been started, its runtime environment can still be modified. For example, as an operator you could decide to shell into the container in order to manually install additional tools or write files to the container’s temporary filesystem. Modifying a container after it has been started can open doors to security risks. You will want to aim for creating <em>immutable containers</em>, containers that cannot be modified after they have been started. We’ll learn how to configure a Pod with the right settings to make its containers immutable.</p>
<p>Last, we’ll talk about capturing logs for events that occur in a Kubernetes cluster. Those logs can be used for troubleshooting purposes on the cluster level, to reconstruct when and how the cluster configuration was changed such that it led to an undesired or broken runtime behavior. Log entries can also be used to trace an attack that may be happening right now as a means to enacting countermeasures.</p>
<p>At a high level, this chapter covers the following concepts:</p>
<ul>
<li>
<p>Performing behavior analytics to detect malicious activities</p>
</li>
<li>
<p>Performing deep analytical investigation and identification</p>
</li>
<li>
<p>Ensuring immutability of containers at runtime</p>
</li>
<li>
<p>Using audit logs to monitor access</p>
</li>
</ul>
<section class="less_space" data-pdf-bookmark="Performing Behavior Analytics" data-type="sect1"><div class="sect1" id="idm46394749540656">
<h1>Performing Behavior Analytics</h1>
<p><a data-primary="behavior analytics" data-secondary="performing" data-type="indexterm" id="ba_per"/>Apart from managing and upgrading a Kubernetes cluster, the administrator is in charge of keeping an eye on potentially malicious activity. While you can perform this task manually by logging into cluster nodes and observing host- and container-level processes, it is a horribly inefficient undertaking.</p>
<p><em>Behavior analytics</em> is the process of observing the cluster nodes for any activity that seems out of the ordinary. An automated process helps with filtering, recording, and alerting events of specific interest.</p>
<section data-pdf-bookmark="Scenario: A Kubernetes Administrator Can Observe Actions Taken by an Attacker" data-type="sect2"><div class="sect2" id="idm46394749536704">
<h2>Scenario: A Kubernetes Administrator Can Observe Actions Taken by an Attacker</h2>
<p><a data-primary="scenarios" data-secondary="Kubernetes administrator can observe actions taken by attackers" data-type="indexterm" id="idm46394749535184"/>An attacker gained access to a container by opening a shell running on a worker node to launch additional attacks throughout the Kubernetes cluster. An administrator can’t easily detect this event by manually checking each and every container. <a data-type="xref" href="#behavioral-analytics-attacker">Figure 7-1</a> illustrates the scenario.</p>
<figure><div class="figure" id="behavioral-analytics-attacker">
<img alt="ckss 0701" height="393" src="assets/ckss_0701.png" width="1430"/>
<h6><span class="label">Figure 7-1. </span>Malicious events recorded by behavior analytics tool</h6>
</div></figure>
<p>The administrator decided to take matters in their own hands by installing a behavior analytics tool. The tool will continuously monitor certain events and record them almost instantaneously. The administrator now has an efficient mechanism for detecting intrusions and can act upon them.</p>
<p><a data-primary="Tetragon" data-type="indexterm" id="idm46394749530624"/><a data-primary="Tracee" data-type="indexterm" id="idm46394749529920"/>Among the behavior analytics tools relevant to the exam are <a href="https://falco.org">Falco</a>, <a href="https://oreil.ly/ibXcO">Tracee</a>, and <a href="https://oreil.ly/q15oU">Tetragon</a>. In this book, we’ll only focus on Falco, as it is listed among the links of documentation pages available during the exam.</p>
</div></section>
<section data-pdf-bookmark="Understanding Falco" data-type="sect2"><div class="sect2" id="idm46394749526688">
<h2>Understanding Falco</h2>
<p><a data-primary="Falco" data-secondary="about" data-type="indexterm" id="idm46394749525312"/>Falco helps with detecting threats by observing host- and container-level activity. Here are a few examples of events Falco could watch for:</p>
<ul class="less_space pagebreak-before">
<li>
<p>Reading or writing files at specific locations in the filesystem</p>
</li>
<li>
<p>Opening a shell binary for a container, such as <code>/bin/bash</code> to open a bash shell</p>
</li>
<li>
<p>An attempt to make a network call to undesired URLs</p>
</li>
</ul>
<p>Falco deploys a set of sensors that listen for the configured events and conditions. Each sensor consists of a set of rules that map an event to a data source. An alert is produced when a rule matches a specific event. Alerts will be sent to an output channel to record the event, such as standard output, a file, or an HTTPS endpoint. Falco allows for enabling more than one output channel simultaneously. <a data-type="xref" href="#falco-high-level-architecture">Figure 7-2</a> shows Falco’s high-level architecture.</p>
<figure><div class="figure" id="falco-high-level-architecture">
<img alt="ckss 0702" height="558" src="assets/ckss_0702.png" width="1259"/>
<h6><span class="label">Figure 7-2. </span>Falco’s high-level architecture</h6>
</div></figure>
<p>Falco is a tool with a lot of features and configuration options. We won’t be able to discuss all features in this book, but I would suggest you spend some time on understanding Falco’s high-level concepts.</p>
<p><a data-primary="Degioanni, Loris, Practical Cloud Native Security with Falco" data-type="indexterm" id="idm46394749515664"/><a data-primary="Grasso, Leonardo, Practical Cloud Native Security with Falco" data-type="indexterm" id="idm46394749514912"/><a data-primary="Practical Cloud Native Security with Falco (Degioanni and Grasso)" data-type="indexterm" id="idm46394749514192"/><a data-primary="Falco 101 video course" data-type="indexterm" id="idm46394749513472"/>Another great learning resource on Falco can be found on the Sysdig training portal webpage. <a href="https://oreil.ly/PwGWx">“Falco 101”</a> is a free video course that explains all the bells and whistles of the product. All you need to do to get started is sign up for an account. Moreover, I’d suggest giving the book <a class="orm:hideurl" href="https://oreil.ly/0WHIR"><em>Practical Cloud Native Security with Falco</em></a> by Loris Degioanni and Leonardo Grasso (O’Reilly) a read. The content takes a beginner-friendly approach to learning Falco.</p>
</div></section>
<section data-pdf-bookmark="Installing Falco" data-type="sect2"><div class="sect2" id="idm46394749510400">
<h2>Installing Falco</h2>
<p><a data-primary="Falco" data-secondary="installing" data-type="indexterm" id="idm46394749508928"/><a data-primary="installing" data-secondary="Falco" data-type="indexterm" id="idm46394749507952"/><a data-primary="documentation" data-secondary="Falco" data-type="indexterm" id="idm46394749507008"/>Falco can be installed as a binary on the host system or as a DaemonSet object in Kubernetes. You can safely assume that Falco has been preinstalled for you in the exam environment. For more information on the installation process, have a look at the <a href="https://oreil.ly/MB6wU">relevant portion</a> of the Falco documentation. The following steps briefly explain the installation of the binary on an Ubuntu machine. Falco needs to be installed on all worker nodes of a Kubernetes cluster. Be aware that those instructions may change with a future version of Falco.</p>
<p>First, you need to trust the Falco GPG key, configure the Falco-specific apt repository, and update the package list:</p>
<pre data-type="programlisting"><strong>$ curl -s https://falco.org/repo/falcosecurity-packages.asc | apt-key add -</strong>
<strong>$ echo "deb https://download.falco.org/packages/deb stable main" | tee -a</strong> \
  <strong>/etc/apt/sources.list.d/falcosecurity.list</strong>
<strong>$ apt-get update -y</strong></pre>
<p>You then install the kernel header with the following command:</p>
<pre data-type="programlisting"><strong>$ apt-get -y install linux-headers-$(uname -r)</strong></pre>
<p>Last, you need to install the Falco apt package with version 0.33.1:</p>
<pre data-type="programlisting"><strong>$ apt-get install -y falco=0.33.1</strong></pre>
<p>Falco has been installed successfully and is running as a systemd service in the background. Run the following command to check on the status of the Falco service:</p>
<pre data-type="programlisting"><strong>$ sudo systemctl status falco</strong>
● falco.service - Falco: Container Native Runtime Security
     Loaded: loaded (/lib/systemd/system/falco.service; enabled; vendor preset: \
             enabled)
     Active: active (running) since Tue 2023-01-24 15:42:31 UTC; 43min ago
       Docs: https://falco.org/docs/
   Main PID: 8718 (falco)
      Tasks: 12 (limit: 1131)
     Memory: 30.2M
     CGroup: /system.slice/falco.service
             └─8718 /usr/bin/falco --pidfile=/var/run/falco.pid</pre>
<p>The Falco service should be in the “active” status. It is already monitoring events in your system.</p>
</div></section>
<section data-pdf-bookmark="Configuring Falco" data-type="sect2"><div class="sect2" id="idm46394749509808">
<h2>Configuring Falco</h2>
<p><a data-primary="configuring" data-secondary="Falco" data-type="indexterm" id="idm46394749496544"/><a data-primary="Falco" data-secondary="configuring" data-type="indexterm" id="idm46394749495568"/>The Falco service provides an operational environment for monitoring the system with a set of default rules. Those rules live in YAML files in the <code>/etc/falco</code> directory. The list of files and subdirectories in <code>/etc/falco</code> is as follows:</p>
<pre data-type="programlisting"><strong>$ tree /etc/falco</strong>
/etc/falco
├── aws_cloudtrail_rules.yaml
├── falco.yaml
├── falco_rules.local.yaml
├── falco_rules.yaml
├── k8s_audit_rules.yaml
├── rules.available
│   └── application_rules.yaml
└── rules.d</pre>
<p>Of those files, I want to describe the high-level purpose of the most important ones.</p>
<section data-pdf-bookmark="Falco configuration file" data-type="sect3"><div class="sect3" id="idm46394749492080">
<h3>Falco configuration file</h3>
<p><a data-primary="configuration file (Falco)" data-type="indexterm" id="idm46394749490768"/><a data-primary="Falco" data-secondary="configuration file" data-type="indexterm" id="idm46394749490000"/><a data-primary="falco.yaml file" data-type="indexterm" id="idm46394749489056"/>The file named <code>falco.yaml</code> is the configuration file for the Falco process. It controls the channel that will be notified in case of an alert. A channel could be standard output or a file. Furthermore, the file defines the minimum log level of alerts to include in logs, and how to configure the embedded web server used to implement a health check for the Falco process. Refer to <a href="https://oreil.ly/sfHW9">“Falco Configuration Options”</a> for a full reference on all available options.</p>
</div></section>
<section data-pdf-bookmark="Default rules" data-type="sect3"><div class="sect3" id="idm46394749486736">
<h3>Default rules</h3>
<p><a data-primary="default rules, for Falco" data-type="indexterm" id="idm46394749485568"/><a data-primary="Falco" data-secondary="default rules for" data-type="indexterm" id="idm46394749484800"/><a data-primary="falco_rules.yaml file" data-type="indexterm" id="idm46394749483856"/>The file named <code>falco_rules.yaml</code> defines a set of preinstalled rules. Falco considers those rules to be applied by default. Among them are checks for creating an alert when a shell to a container is opened or when a write operation is performed to a system directory. You can find other examples and their corresponding rule definitions on the <a href="https://oreil.ly/fxHQm">“Rules Examples” page</a>.</p>
</div></section>
<section data-pdf-bookmark="Custom rules" data-type="sect3"><div class="sect3" id="idm46394749481696">
<h3>Custom rules</h3>
<p><a data-primary="custom rules, for Falco" data-type="indexterm" id="idm46394749480496"/><a data-primary="Falco" data-secondary="custom rules for" data-type="indexterm" id="idm46394749479792"/><a data-primary="falco_rules.local.yaml file" data-type="indexterm" id="idm46394749478848"/>The file named <code>falco_rules.local.yaml</code> lets you define custom rules and override default rules. With a fresh installation of Falco, the file only contains commented-out rules to provide you with a starting point for adding your own rules. You can find <a href="https://oreil.ly/mJnPo">guidance on writing custom rules</a> in the Falco documentation.</p>
</div></section>
<section data-pdf-bookmark="Kubernetes-specific rules" data-type="sect3"><div class="sect3" id="idm46394749476576">
<h3>Kubernetes-specific rules</h3>
<p><a data-primary="k8s_audit_rules.yaml file" data-type="indexterm" id="idm46394749475392"/><a data-primary="Kubernetes-specific rules" data-type="indexterm" id="idm46394749474624"/>The file <code>k8s_audit_rules.yaml</code> defines <a href="https://oreil.ly/d5FGD">Kubernetes-specific rules</a> in addition to logging system call events. Typical examples are “log an event when a namespace is deleted” or “log an event when a Role or ClusterRole object is created.”</p>
</div></section>
<section data-pdf-bookmark="Applying configuration changes" data-type="sect3"><div class="sect3" id="idm46394749472224">
<h3>Applying configuration changes</h3>
<p>Modifying the contents of configuration files will not automatically propagate them to the Falco process. You need to restart the Falco service, as demonstrated by the following command:</p>
<pre data-type="programlisting"><strong>$ sudo systemctl restart falco</strong></pre>
<p>Next up, we’ll trigger some of the events covered by Falco’s default rules. Each of those events will create an alert written to the configured channel. The initial setup of Falco routes messages to standard output.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Generating Events and Inspecting Falco Logs" data-type="sect2"><div class="sect2" id="generating-events-inspect-falco-logs">
<h2>Generating Events and Inspecting Falco Logs</h2>
<p><a data-primary="events, generating in Falco" data-type="indexterm" id="idm46394749467184"/><a data-primary="Falco" data-secondary="generating events in" data-type="indexterm" id="idm46394749466464"/><a data-primary="Falco" data-secondary="inspecting logs" data-type="indexterm" id="idm46394749465520"/><a data-primary="logs, inspecting in Falco" data-type="indexterm" id="idm46394749464576"/>Let’s see Falco alerts in action. One of the default rules added by Falco creates an alert whenever a user tries to open a shell to a container. We’ll need to perform this activity to see a log entry for it. To achieve that, create a new Pod named <code>nginx</code>, open a bash shell to the container, and then exit out of the container:</p>
<pre data-type="programlisting"><strong>$ kubectl run nginx --image=nginx:1.23.3</strong>
pod/nginx created
<strong>$ kubectl exec -it nginx -- bash</strong>
root@nginx:/# exit</pre>
<p>Identify the cluster node the Pod runs on by inspecting its runtime details:</p>
<pre data-type="programlisting"><strong>$ kubectl get pod nginx -o jsonpath='{.spec.nodeName}'</strong>
kube-worker-1</pre>
<p><a data-primary="commands" data-secondary="journalctl" data-type="indexterm" id="idm46394749460080"/><a data-primary="journalctl command" data-type="indexterm" id="idm46394749458880"/>This Pod is running on the cluster node named <code>kube-worker-1</code>. You will need to inspect the Falco logs on that machine to find the relevant log entry. You can inspect logged events by using the <code>journalctl</code> command directly on the <code>kube-worker-1</code> cluster node. The following command searches for entries that contain the keyword <code>falco</code>:</p>
<pre data-type="programlisting"><strong>$ sudo journalctl -fu falco</strong>
...
Jan 24 18:03:37 kube-worker-1 falco[8718]: 18:03:14.632368639: Notice A shell \
was spawned in a container with an attached terminal (user=root user_loginuid=0 \
nginx (id=18b247adb3ca) shell=bash parent=runc cmdline=bash pid=47773 \
terminal=34816 container_id=18b247adb3ca image=docker.io/library/nginx)</pre>
<p>You will find that additional rules will kick in if you try to modify the container state. Say you’d installed the Git package using <code>apt</code> in the <code>nginx</code> container:</p>
<pre data-type="programlisting">root@nginx:/# apt update
root@nginx:/# apt install git</pre>
<p>Falco added log entries for those system-level operations. The following output renders the alerts:</p>
<pre data-type="programlisting"><strong>$ sudo journalctl -fu falco</strong>
Jan 24 18:55:48 ubuntu-focal falco[8718]: 18:55:05.173895727: Error Package \
management process launched in container (user=root user_loginuid=0 \
command=apt update pid=60538 container_id=18b247adb3ca container_name=nginx \
image=docker.io/library/nginx:1.23.3)
Jan 24 18:55:48 ubuntu-focal falco[8718]: 18:55:11.050925982: Error Package \
management process launched in container (user=root user_loginuid=0 \
command=apt install git-all pid=60823 container_id=18b247adb3ca \
container_name=nginx image=docker.io/library/nginx:1.23.3)
...</pre>
<p>In the next section, we’ll inspect the Falco rules that trigger the creation of alerts, and their syntax.</p>
</div></section>
<section data-pdf-bookmark="Understanding Falco Rule File Basics" data-type="sect2"><div class="sect2" id="idm46394749468784">
<h2>Understanding Falco Rule File Basics</h2>
<p><a data-primary="Falco" data-secondary="rule file basics" data-type="indexterm" id="idm46394749449984"/><a data-primary="rules files (Falco)" data-type="indexterm" id="idm46394749449008"/>A Falco rules file usually consists of three elements defined in YAML: rules, macros, and lists. You’ll need to understand those elements on a high level and know how to modify them to achieve a certain goal.</p>
<div data-type="note" epub:type="note"><h1>Crafting your own Falco rules</h1>
<p><a data-primary="documentation" data-secondary="Falco" data-type="indexterm" id="idm46394749447056"/>During the exam, you will likely not have to craft your own Falco rules. You’ll be provided with an existing set of rules. If you want to dive deeper into Falco rules, have a look at the relevant <a href="https://oreil.ly/PD1ro">documentation page</a>.</p>
</div>
<section data-pdf-bookmark="Rule" data-type="sect3"><div class="sect3" id="idm46394749444944">
<h3>Rule</h3>
<p><a data-primary="rules" data-secondary="Falco" data-type="indexterm" id="idm46394749443712"/>A <em>rule</em> is the condition under which an alert should be generated. It also defines the output message of the alert. An output message can consist of a hard-coded message and incorporate built-in variables. The alert is recorded on the <code>WARNING</code> log level. <a data-type="xref" href="#falco-rule-camera">Example 7-1</a> shows the YAML for a rule listening to events that try to access the machine’s camera from processes other than your traditional video-conferencing software, such as Skype or Webex.</p>
<div data-type="example" id="falco-rule-camera">
<h5><span class="label">Example 7-1. </span>A Falco rule that monitors camera access</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">rule</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">access_camera</code><code class="w"/>
<code class="w">  </code><code class="nt">desc</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">a process other than skype/webex tries to access the camera</code><code class="w"/>
<code class="w">  </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">evt.type = open and fd.name = /dev/video0 and not proc.name in \</code><code class="w"/>
<code class="w">             </code><code class="l-Scalar-Plain">(skype, webex)</code><code class="w"/>
<code class="w">  </code><code class="nt">output</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Unexpected process opening camera video device (command=%proc.cmdline)</code><code class="w"/>
<code class="w">  </code><code class="nt">priority</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">WARNING</code><code class="w"/></pre></div>
</div></section>
<section data-pdf-bookmark="Macro" data-type="sect3"><div class="sect3" id="idm46394749414928">
<h3>Macro</h3>
<p><a data-primary="macros (Falco)" data-type="indexterm" id="idm46394749371696"/>A <em>macro</em> is a reusable rule condition that helps with avoiding copy-pasting similar logic across multiple rules. Macros are useful if the rule file becomes lengthy and you want to improve on maintainability.</p>
<p>Say you are in the process of simplifying a rules file. You notice that multiple rules use the same condition that listens for camera access. <a data-type="xref" href="#falco-macro-camera">Example 7-2</a> shows how to break out the logic into a macro.</p>
<div data-type="example" id="falco-macro-camera">
<h5><span class="label">Example 7-2. </span>A Falco macro defining a reusable condition</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">macro</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">camera_process_access</code><code class="w"/>
<code class="w">  </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">evt.type = open and fd.name = /dev/video0 and not proc.name in \</code><code class="w"/>
<code class="w">             </code><code class="l-Scalar-Plain">(skype, webex)</code><code class="w"/></pre></div>
<p>The macro can now be referenced by name in a rule definition, as shown in 
<span class="keep-together"><a data-type="xref" href="#falco-rule-with-macro">Example 7-3</a>.</span></p>
<div data-type="example" id="falco-rule-with-macro">
<h5><span class="label">Example 7-3. </span>A Falco rule incorporating a macro</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">rule</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">access_camera</code><code class="w"/>
<code class="w">  </code><code class="nt">desc</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">a process other than skype/webex tries to access the camera</code><code class="w"/>
<code class="w">  </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">camera_process_access</code><code class="w"/>
<code class="w">  </code><code class="nt">output</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Unexpected process opening camera video device (command=%proc.cmdline)</code><code class="w"/>
<code class="w">  </code><code class="nt">priority</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">WARNING</code><code class="w"/></pre></div>
</div></section>
<section data-pdf-bookmark="List" data-type="sect3"><div class="sect3" id="idm46394749257248">
<h3>List</h3>
<p><a data-primary="lists (Falco)" data-type="indexterm" id="idm46394749264656"/>A <em>list</em> is a collection of items that you can include in rules, macros, and other lists. Think of lists as an array in traditional programming languages. <a data-type="xref" href="#falco-list-video-software">Example 7-4</a> creates a list of process names associated with video-conferencing software.</p>
<div data-type="example" id="falco-list-video-software">
<h5><span class="label">Example 7-4. </span>A Falco list</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">list</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">video_conferencing_software</code><code class="w"/>
<code class="w">  </code><code class="nt">items</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="nv">skype</code><code class="p-Indicator">,</code><code class="w"> </code><code class="nv">webex</code><code class="p-Indicator">]</code><code class="w"/></pre></div>
<p><a data-type="xref" href="#falco-macro-with-list">Example 7-5</a> shows the usage of the list by name in a macro.</p>
<div data-type="example" id="falco-macro-with-list">
<h5><span class="label">Example 7-5. </span>A Falco macro that uses a list</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">macro</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">camera_process_access</code><code class="w"/>
<code class="w">  </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">evt.type = open and fd.name = /dev/video0 and not proc.name in \</code><code class="w"/>
<code class="w">             </code><code class="l-Scalar-Plain">(video_conferencing_software)</code><code class="w"/></pre></div>
</div></section>
<section data-pdf-bookmark="Dissecting an existing rule" data-type="sect3"><div class="sect3" id="idm46394749265600">
<h3>Dissecting an existing rule</h3>
<p>The reason why Falco ships with default rules is to shorten the timespan to hit the ground running for a production cluster. Instead of having to come up with your own rules and the correct syntax, you can simply install Falco and benefit from best practices from the get-go.</p>
<p>Let’s come back to one of the events we triggered in <a data-type="xref" href="#generating-events-inspect-falco-logs">“Generating Events and Inspecting Falco Logs”</a>. At the time of writing, I am using the Falco version 0.33.1. The rules file <code>/etc/falco/falco_rules.yaml</code> shipped with it contains a rule named “Terminal shell in container.” It observes the event of opening a shell to a container. You can easily find the rule by searching for a portion of the log message, e.g., “A shell was spawned in a container.” <a data-type="xref" href="#default-open-shell-falco-rule-file">Example 7-6</a> shows the syntax of the rule definition, as well as the annotated portions of the YAML.</p>
<div data-type="example" id="default-open-shell-falco-rule-file">
<h5><span class="label">Example 7-6. </span>A Falco rule that monitors shell activity to a container</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">macro</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">spawned_process</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO1-1" id="co_monitoring__logging__and_runtime_security_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">(evt.type</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">in</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">(execve,</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">execveat)</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">and</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">evt.dir=&lt;)</code><code class="w">

</code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">macro</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">container</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO1-1" id="co_monitoring__logging__and_runtime_security_CO1-2"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">(container.id</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">!=</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">host)</code><code class="w">

</code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">macro</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">container_entrypoint</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO1-1" id="co_monitoring__logging__and_runtime_security_CO1-3"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">(not</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">proc.pname</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">exists</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">or</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">proc.pname</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">in</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">(runc:[0:PARENT],</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">\</code><code class="w">
</code><code class="w">              </code><code class="l-Scalar-Plain">runc:[1:CHILD],</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">runc,</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">docker-runc,</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">exe,</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">docker-runc-cur))</code><code class="w">

</code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">macro</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">user_expected_terminal_shell_in_container_conditions</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO1-1" id="co_monitoring__logging__and_runtime_security_CO1-4"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">(never_true)</code><code class="w">

</code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">rule</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Terminal</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">shell</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">in</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">container</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO1-2" id="co_monitoring__logging__and_runtime_security_CO1-5"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">desc</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">A</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">shell</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">was</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">used</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">as</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">entrypoint/exec</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">point</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">into</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">a</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">container</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">with</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">an</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">\</code><code class="w">
</code><code class="w">        </code><code class="l-Scalar-Plain">attached</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">terminal.</code><code class="w">
</code><code class="w">  </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">&gt;</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO1-3" id="co_monitoring__logging__and_runtime_security_CO1-6"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="no">spawned_process and container</code><code class="w">
</code><code class="w">    </code><code class="no">and shell_procs and proc.tty != 0</code><code class="w">
</code><code class="w">    </code><code class="no">and container_entrypoint</code><code class="w">
</code><code class="w">    </code><code class="no">and not user_expected_terminal_shell_in_container_conditions</code><code class="w">
</code><code class="w">  </code><code class="nt">output</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">&gt;</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO1-4" id="co_monitoring__logging__and_runtime_security_CO1-7"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="no">A shell was spawned in a container with an attached terminal (user=%user.name \</code><code class="w">
</code><code class="w">    </code><code class="no">user_loginuid=%user.loginuid %container.info</code><code class="w">
</code><code class="w">    </code><code class="no">shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline pid=%proc.pid \</code><code class="w">
</code><code class="w">    </code><code class="no">terminal=%proc.tty container_id=%container.id image=%container.image.repository)</code><code class="w">
</code><code class="w">  </code><code class="nt">priority</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">NOTICE</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO1-5" id="co_monitoring__logging__and_runtime_security_CO1-8"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">tags</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="nv">container</code><code class="p-Indicator">,</code><code class="w"> </code><code class="nv">shell</code><code class="p-Indicator">,</code><code class="w"> </code><code class="nv">mitre_execution</code><code class="p-Indicator">]</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO1-6" id="co_monitoring__logging__and_runtime_security_CO1-9"><img alt="6" height="12" src="assets/6.png" width="12"/></a></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO1-1" id="callout_monitoring__logging__and_runtime_security_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Defines a macro, a condition reusable across multiple rules referenced by name.</p></dd>
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO1-5" id="callout_monitoring__logging__and_runtime_security_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Specifies the name of the rule.</p></dd>
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO1-6" id="callout_monitoring__logging__and_runtime_security_CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>The aggregated condition composed of multiple macros.</p></dd>
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO1-7" id="callout_monitoring__logging__and_runtime_security_CO1-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>The alerting message should the event happen. The message may use built-in fields to reference runtime value.</p></dd>
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO1-8" id="callout_monitoring__logging__and_runtime_security_CO1-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>Indicates how serious a violation of the rule it is.</p></dd>
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO1-9" id="callout_monitoring__logging__and_runtime_security_CO1-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></dt>
<dd><p>Categorizes the rule set into groups of related rules for ease of management.</p></dd>
</dl>
<p>Sometimes you may want to change an existing rule. The next section will explain how to best approach overriding default rules.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Overriding Existing Rules" data-type="sect2"><div class="sect2" id="idm46394748947312">
<h2>Overriding Existing Rules</h2>
<p><a data-primary="Falco" data-secondary="overriding existing rules" data-type="indexterm" id="idm46394748945744"/><a data-primary="rules" data-secondary="overriding existing" data-type="indexterm" id="idm46394748944800"/>Instead of modifying the rule definition directly in <code>/etc/falco/falco_rules.yaml</code>, I’d suggest you redefine the rule in <code>/etc/falco/falco_rules.local.yaml</code>. That’ll help with falling back to the original rule definition in case you want to get rid of the modifications or if you make any mistakes in the process. The rule definition needs to be changed on all worker nodes of the cluster.</p>
<p>The rule definition shown in <a data-type="xref" href="#modified-open-shell-falco-rule-file">Example 7-7</a> overrides the rule named “Terminal shell in container” by changing the priority to <code>ALERT</code> and the output to a new format by incorporating <a href="https://oreil.ly/z5oAk">built-in fields</a>.</p>
<div data-type="example" id="modified-open-shell-falco-rule-file">
<h5><span class="label">Example 7-7. </span>The modified rule that monitors shell activity to a container</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">rule</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Terminal</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">shell</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">in</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">container</code><code class="w">
</code><code class="w">  </code><code class="nt">desc</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">A</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">shell</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">was</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">used</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">as</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">entrypoint/exec</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">point</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">into</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">a</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">container</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">with</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">an</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">\</code><code class="w">
</code><code class="w">        </code><code class="l-Scalar-Plain">attached</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">terminal.</code><code class="w">
</code><code class="w">  </code><code class="nt">condition</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">&gt;</code><code class="w">
</code><code class="w">    </code><code class="no">spawned_process and container</code><code class="w">
</code><code class="w">    </code><code class="no">and shell_procs and proc.tty != 0</code><code class="w">
</code><code class="w">    </code><code class="no">and container_entrypoint</code><code class="w">
</code><code class="w">    </code><code class="no">and not user_expected_terminal_shell_in_container_conditions</code><code class="w">
</code><code class="w">  </code><code class="nt">output</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">&gt;</code><code class="w">
</code><code class="w">    </code><code class="no">Opened shell: %evt.time,%user.name,%container.name </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO2-1" id="co_monitoring__logging__and_runtime_security_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">priority</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ALERT</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO2-2" id="co_monitoring__logging__and_runtime_security_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">tags</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="nv">container</code><code class="p-Indicator">,</code><code class="w"> </code><code class="nv">shell</code><code class="p-Indicator">,</code><code class="w"> </code><code class="nv">mitre_execution</code><code class="p-Indicator">]</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO2-1" id="callout_monitoring__logging__and_runtime_security_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Simplifies the log output rendered for a violation.</p></dd>
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO2-2" id="callout_monitoring__logging__and_runtime_security_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Treats a violation of the rule with <code>ALERT</code> priority.</p></dd>
</dl>
<p>After adding the rule to <code>falco_rules.local.yaml</code>, we need to let Falco pick up the changes. Restart the Falco service with the following command:</p>
<pre data-type="programlisting"><strong>$ sudo systemctl restart falco</strong></pre>
<p>As a result, any attempt that shells into a container will be logged with a different output format and priority, as the following shows:</p>
<pre data-type="programlisting"><strong>$ sudo journalctl -fu falco</strong>
...
Jan 24 21:19:13 kube-worker-1 falco[100017]: 21:19:13.961970887: Alert Opened \
shell: 21:19:13.961970887,&lt;NA&gt;,nginx</pre>
<p><a data-primary="" data-startref="ba_per" data-type="indexterm" id="idm46394748794416"/>In addition to overriding existing Falco rules, you can also define your own custom rules in <code>/etc/falco/falco_rules.local.yaml</code>. Writing custom rules is out of scope for this book, but you should find plenty of information on the topic in the Falco documentation.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Ensuring Container Immutability" data-type="sect1"><div class="sect1" id="idm46394749540160">
<h1>Ensuring Container Immutability</h1>
<p><a data-primary="behavior analytics" data-secondary="ensuring container immutability" data-type="indexterm" id="idm46394748742544"/><a data-primary="containers" data-secondary="ensuring immutability" data-type="indexterm" id="idm46394748741600"/><a data-primary="immutability, ensuring for containers" data-type="indexterm" id="idm46394748740656"/>Containers are mutable by default. After the container has been started, you can open a shell to it, install a patch for existing software, modify files, or make changes to its configuration. Mutable containers allow attackers to gain access to the container by downloading or installing malicious software.</p>
<p>To counteract the situation, make sure that the container is operated in an immutable state. That means preventing write operations to the container’s filesystem or even disallowing shell access to the container. If you need to make any substantial changes to the container, such as updating a dependency or incorporating a new application feature, you should release a new tag of the container image instead of manually modifying the container itself. You’d then assign the new tag of the container image to the Pod without having to modify the internals directly.</p>
<section data-pdf-bookmark="Scenario: An Attacker Installs Malicious Software" data-type="sect2"><div class="sect2" id="idm46394748739344">
<h2>Scenario: An Attacker Installs Malicious Software</h2>
<p><a data-primary="scenarios" data-secondary="attacker installs malicious software" data-type="indexterm" id="idm46394748738176"/><a data-type="xref" href="#installs-malicious-software-attacker">Figure 7-3</a> illustrates a scenario where an attacker gains access to a container using stolen credentials. The attacker downloads and installs malicious software given that the container allows write operations to the root filesystem. The malicious software keeps monitoring activities in the container; for example, it could parse the application logs for sensitive information. It may then send the information to a server outside of the Kubernetes cluster. Consequently, the data is used as a means to log into other parts of the system.</p>
<figure><div class="figure" id="installs-malicious-software-attacker">
<img alt="ckss 0703" height="440" src="assets/ckss_0703.png" width="1429"/>
<h6><span class="label">Figure 7-3. </span>An attacker shells into a container and installs malicious software</h6>
</div></figure>
<p><a data-primary="ConfigMap" data-type="indexterm" id="idm46394748734272"/><a data-primary="Secrets" data-secondary="about" data-type="indexterm" id="idm46394748733568"/>In the next section, you’ll learn how to prevent the situation from happening by using a distroless container image, injecting configuration data with the help of a ConfigMap or Secret, and by configuring a read-only container filesystem. Those settings as a whole will make the container truly immutable.</p>
</div></section>
<section data-pdf-bookmark="Using a Distroless Container Image" data-type="sect2"><div class="sect2" id="idm46394748732240">
<h2>Using a Distroless Container Image</h2>
<p><a data-primary="distroless image" data-type="indexterm" id="idm46394748731104"/><a data-primary="images" data-secondary="distroless" data-type="indexterm" id="idm46394748730400"/>Distroless container images have become increasing popular in the world of containers. They only bundle your application and its runtime dependencies, while at the same time removing as much of the operating system as possible, e.g., shells, package managers, and libraries. Distroless container images are not just smaller in size; they are also more secure. An attacker cannot shell into the container, and therefore the filesystem cannot be misused to install malicious software. Using distroless container images is the first line of defense in creating an immutable container. We already covered distroless container images in <a data-type="xref" href="ch06.xhtml#small-sized-base-image">“Picking a Base Image Small in Size”</a>. Refer to that section for more information.</p>
</div></section>
<section data-pdf-bookmark="Configuring a Container with a ConfigMap or Secret" data-type="sect2"><div class="sect2" id="configuring-container-configmap-secret">
<h2>Configuring a Container with a ConfigMap or Secret</h2>
<p><a data-primary="ConfigMap" data-type="indexterm" id="idm46394748726592"/><a data-primary="Secrets" data-secondary="configuring containers with" data-type="indexterm" id="idm46394748725888"/><a data-primary="configuring" data-secondary="containers with ConfigMap" data-type="indexterm" id="idm46394748724928"/><a data-primary="configuring" data-secondary="containers with Secrets" data-type="indexterm" id="idm46394748723968"/><a data-primary="containers" data-secondary="configuring with ConfigMap or Secrets" data-type="indexterm" id="idm46394748723024"/>It is best practice to use the same container image for different deployment environments, even though their runtime configurations may be different. Any environment-specific configuration, such as credentials, and connection URLs to other parts of the system, should be externalized. In Kubernetes, you can inject configuration data into a container with the help of a ConfigMap or Secret as environment variables or files mounted via Volumes. <a data-type="xref" href="#configmap-runtime-configuration">Figure 7-4</a> shows the reuse of the same container image to configure a Pod in a development and production cluster. Configuration data specific to the environment is provided by a ConfigMap.</p>
<figure><div class="figure" id="configmap-runtime-configuration">
<img alt="ckss 0704" height="397" src="assets/ckss_0704.png" width="1337"/>
<h6><span class="label">Figure 7-4. </span>Using the same container image across multiple environments</h6>
</div></figure>
<p>Avoiding the creation of environment-specific container images simplifies the creation process, reduces the risk of introducing accidental security risks, and makes testing of the functionality easier. Injecting runtime values does not require changing the container after it has been started and therefore is key to making it immutable.</p>
<p>When using Secrets as environment variables in a container, make sure to avoid accidentally logging the values to standard output, e.g., as a plain-text value when writing a log message. Anyone with access to the container logs would be able to parse them for Secrets values. As a spot check, identify the places in your application code where you use a Secret and assess their risk for exposure.</p>
<p><a data-primary="documentation" data-secondary="Kubernetes" data-type="indexterm" id="idm46394748718048"/>To brush up on creating, configuring, and consuming ConfigMaps and Secrets, revisit the <a href="https://oreil.ly/RjxjE">Kubernetes documentation</a>.</p>
</div></section>
<section data-pdf-bookmark="Configuring a Read-Only Container Root Filesystem" data-type="sect2"><div class="sect2" id="idm46394748716048">
<h2>Configuring a Read-Only Container Root Filesystem</h2>
<p><a data-primary="configuring" data-secondary="read-only container root filesystems" data-type="indexterm" id="idm46394748714640"/><a data-primary="read-only container root filesystems, configuring" data-type="indexterm" id="idm46394748713648"/>Another aspect of container immutability is to prevent write access to the container’s filesystem. You can configure this runtime behavior by assigning the value <code>true</code> to the attribute <code>spec.containers[].securityContext.readOnlyRootFilesystem</code>.</p>
<p><a data-primary="nginx" data-type="indexterm" id="idm46394748711280"/>There are some applications that still require write access to fulfill their functional requirements. For example, <a href="https://www.nginx.com">nginx</a> needs to write to the directories 
<span class="keep-together"><code>/var/run</code>,</span> <code>/var/cache/nginx</code>, and <code>/usr/local/nginx</code>. In combination with setting <code>readOnlyRootFilesystem</code> to <code>true</code>, you can declare Volumes that make those directories writable. <a data-type="xref" href="#nginx-immutable-container">Example 7-8</a> shows the YAML manifest of an immutable container running nginx.</p>
<div data-type="example" id="nginx-immutable-container">
<h5><span class="label">Example 7-8. </span>A container disallowing write access to the root filesystem</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx</code><code class="w"/>
<code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx:1.21.6</code><code class="w"/>
<code class="w">    </code><code class="nt">securityContext</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">readOnlyRootFilesystem</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>
<code class="w">    </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx-run</code><code class="w"/>
<code class="w">      </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/var/run</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx-cache</code><code class="w"/>
<code class="w">      </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/var/cache/nginx</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx-data</code><code class="w"/>
<code class="w">      </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/usr/local/nginx</code><code class="w"/>
<code class="w">  </code><code class="nt">volumes</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx-run</code><code class="w"/>
<code class="w">    </code><code class="nt">emptyDir</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx-data</code><code class="w"/>
<code class="w">    </code><code class="nt">emptyDir</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">nginx-cache</code><code class="w"/>
<code class="w">    </code><code class="nt">emptyDir</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/></pre></div>
<p>Identify the filesystem read/write requirements of your application before creating a Pod. Configure write mountpaths with the help of Volumes. Any other filesystem path should become read-only.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Using Audit Logs to Monitor Access" data-type="sect1"><div class="sect1" id="idm46394748700832">
<h1>Using Audit Logs to Monitor Access</h1>
<p><a data-primary="access" data-secondary="monitoring using audit logs" data-type="indexterm" id="ac_mon"/><a data-primary="audit logs" data-type="indexterm" id="al_ab"/><a data-primary="behavior analytics" data-secondary="using audit logs to monitor access" data-type="indexterm" id="ba_al"/><a data-primary="monitoring" data-type="indexterm" id="mon_ab"/>It’s imperative for a Kubernetes administrator to have a record of events that have occurred in the cluster. Those records can help detect an intrusion in real-time, or they can be used to track down configuration changes for troubleshooting purposes. <em>Audit logs</em> provide a chronological view of events received by the API server.</p>
<section data-pdf-bookmark="Scenario: An Administrator Can Monitor Malicious Events in Real Time" data-type="sect2"><div class="sect2" id="idm46394748573984">
<h2>Scenario: An Administrator Can Monitor Malicious Events in Real Time</h2>
<p><a data-primary="scenarios" data-secondary="administrator can monitor malicious events in real time" data-type="indexterm" id="idm46394748572816"/><a data-type="xref" href="#observing-audit-log-attacker">Figure 7-5</a> shows the benefits of monitoring Kubernetes API events. In this scenario, the attacker tries to make calls to the API server. Events of interest have been captured by the audit log mechanism. The administrator can view those events at any time, identify intrusion attempts, and take countermeasure.</p>
<figure><div class="figure" id="observing-audit-log-attacker">
<img alt="ckss 0705" height="299" src="assets/ckss_0705.png" width="1429"/>
<h6><span class="label">Figure 7-5. </span>An attacker monitored by observing audit logs</h6>
</div></figure>
<p>We only reviewed one of the use cases here, the one that applies to security concerns. The ability to trace company-internal API requests should not be underestimated. By reviewing audit logs, the administrator can provide guidance to application developers trying to create Kubernetes objects, or reconstruct configuration changes that may have led to faulty cluster behavior.</p>
</div></section>
<section data-pdf-bookmark="Understanding Audit Logs" data-type="sect2"><div class="sect2" id="idm46394748568528">
<h2>Understanding Audit Logs</h2>
<p><a data-primary="JSON Lines format" data-type="indexterm" id="idm46394748567120"/>Kubernetes can store records for events triggered by end users for any requests made to the API server or for events emitted by the control plane itself. Entries in the audit log exist in <a href="https://jsonlines.org">JSON Lines</a> format and can consist of, but aren’t limited to, the following information:</p>
<ul>
<li>
<p>What event occurred?</p>
</li>
<li>
<p>Who triggered the event?</p>
</li>
<li>
<p>When was it triggered?</p>
</li>
<li>
<p>Which Kubernetes component handled the request?</p>
</li>
</ul>
<p><a data-primary="audit policy" data-type="indexterm" id="idm46394748561376"/>The type of event and the corresponding request data to be recorded are defined by an <em>audit policy</em>. The audit policy is a YAML manifest specifying those rules and has to be provided  to the API server process.</p>
<p><a data-primary="log backend" data-type="indexterm" id="idm46394748559744"/><a data-primary="webhook backend" data-type="indexterm" id="idm46394748559040"/><a data-primary="audit backend" data-type="indexterm" id="idm46394748558368"/>The <em>audit backend</em> is responsible for storing the recorded audit events, as defined by the audit policy. You have two configurable options for a backend:</p>
<ul>
<li>
<p>A log backend, which write the events to a file.</p>
</li>
<li>
<p>A webhook backend, which sends the events to an external service via 
<span class="keep-together">HTTP(S)—for</span> example, for the purpose of integrating a centralized logging and monitoring system. Such a backend can help with debugging runtime issues like a crashed application.</p>
</li>
</ul>
<p><a data-type="xref" href="#audit-log-architecture">Figure 7-6</a> puts together all the pieces necessary to configure audit logging. The following sections will explain the details of configuring them.</p>
<figure><div class="figure" id="audit-log-architecture">
<img alt="ckss 0706" height="449" src="assets/ckss_0706.png" width="1041"/>
<h6><span class="label">Figure 7-6. </span>The high-level audit log architecture</h6>
</div></figure>
<p>Let’s have a deeper look at the audit policy file and its configuration options.</p>
</div></section>
<section data-pdf-bookmark="Creating the Audit Policy File" data-type="sect2"><div class="sect2" id="idm46394748483920">
<h2>Creating the Audit Policy File</h2>
<p><a data-primary="None audit level" data-type="indexterm" id="idm46394748482528"/><a data-primary="Metadata audit level" data-type="indexterm" id="idm46394748481824"/><a data-primary="Request audit level" data-type="indexterm" id="idm46394748481152"/><a data-primary="RequestResponse audit level" data-type="indexterm" id="idm46394748480480"/>The audit policy file is effectively a YAML manifest for a <code>Policy</code> resource. Any event received by the API server is matched against the rules defined in the policy file in the order of definition. The event is logged with the declared audit level if a matching rule can be found. <a data-type="xref" href="#audit-levels">Table 7-1</a> lists all available audit levels.</p>
<table id="audit-levels">
<caption><span class="label">Table 7-1. </span>Audit levels</caption>
<thead>
<tr>
<th>Level</th>
<th>Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>None</code></p></td>
<td><p>Do not log events matching this rule.</p></td>
</tr>
<tr>
<td><p><code>Metadata</code></p></td>
<td><p>Only log request metadata for the event.</p></td>
</tr>
<tr>
<td><p><code>Request</code></p></td>
<td><p>Log metadata and the request body for the event.</p></td>
</tr>
<tr>
<td><p><code>RequestResponse</code></p></td>
<td><p>Log metadata, request, and response body for the event.</p></td>
</tr>
</tbody>
</table>
<p><a data-type="xref" href="#audit-policy">Example 7-9</a> shows an exemplary audit policy. The rules are specified as an array of items with the attribute named <code>rules</code>. Each rule declares a level, the resource type and API group it applies to, and an optional namespace.</p>
<div data-type="example" id="audit-policy">
<h5><span class="label">Example 7-9. </span>Contents of an audit policy file</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">audit.k8s.io/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Policy</code><code class="w">
</code><code class="nt">omitStages</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"</code><code class="s">RequestReceived</code><code class="s">"</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO3-1" id="co_monitoring__logging__and_runtime_security_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="nt">rules</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">level</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">RequestResponse</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO3-2" id="co_monitoring__logging__and_runtime_security_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">resources</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">group</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">"</code><code class="w">
</code><code class="w">      </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="s">"</code><code class="s">pods</code><code class="s">"</code><code class="p-Indicator">]</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">level</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Metadata</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO3-3" id="co_monitoring__logging__and_runtime_security_CO3-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">resources</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">group</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">"</code><code class="w">
</code><code class="w">      </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="s">"</code><code class="s">pods/log</code><code class="s">"</code><code class="p-Indicator">,</code><code class="w"> </code><code class="s">"</code><code class="s">pods/status</code><code class="s">"</code><code class="p-Indicator">]</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO3-1" id="callout_monitoring__logging__and_runtime_security_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Prevents generating logs for all requests in the <code>RequestReceived</code> stage</p></dd>
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO3-2" id="callout_monitoring__logging__and_runtime_security_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Logs Pod changes at <code>RequestResponse</code> level</p></dd>
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO3-3" id="callout_monitoring__logging__and_runtime_security_CO3-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Logs specialized Pod events, e.g., log and status requests, at the <code>Metadata</code> level</p></dd>
</dl>
<p><a data-primary="documentation" data-secondary="Kubernetes" data-type="indexterm" id="idm46394748376992"/>The previous audit policy isn’t very extensive but should give you an impression of its format. Refer to the <a href="https://oreil.ly/Zozkf">Kubernetes documentation</a> for additional examples and more details.</p>
<p>Once the audit policy file has been created, it can be consumed by the API server process. Add the flag <code>--audit-policy-file</code> to the API server process in the file <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>. The value assigned to the parameter is the fully qualified path to the audit policy file.</p>
<p>Next up, we’ll walk through the settings needed to configure audit logging for the API server for a file-based log backend and a webhook backend.</p>
</div></section>
<section data-pdf-bookmark="Configuring a Log Backend" data-type="sect2"><div class="sect2" id="idm46394748324448">
<h2>Configuring a Log Backend</h2>
<p><a data-primary="configuring" data-secondary="log backend" data-type="indexterm" id="idm46394748322976"/><a data-primary="log backend" data-type="indexterm" id="idm46394748322000"/>To set up a file-based log backend, you will need to add three pieces of configuration to the file <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>. The following list summarizes the configuration:</p>
<ol>
<li>
<p>Provide two flags to the API server process: the flag <code>--audit-policy-file</code> points to the audit policy file; the flag <code>--audit-log-path</code> points to the log output file.</p>
</li>
<li>
<p>Add a Volume mountpath for the audit log policy file and the log output 
<span class="keep-together">directory.</span></p>
</li>
<li>
<p>Add a Volume definition to the host path for the audit log policy file and the log output directory.</p>
</li>
</ol>
<p><a data-type="xref" href="#log-backend-api-server">Example 7-10</a> shows the modified content of the API server configuration file.</p>
<div data-type="example" id="log-backend-api-server">
<h5><span class="label">Example 7-10. </span>Configuring the audit policy file and audit log file</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="p">...</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">command</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">kube-apiserver</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--audit-policy-file=/etc/kubernetes/audit-policy.yaml</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO4-1" id="co_monitoring__logging__and_runtime_security_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--audit-log-path=/var/log/kubernetes/audit/audit.log</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO4-1" id="co_monitoring__logging__and_runtime_security_CO4-2"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p">...</code><code class="w">
</code><code class="w">    </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/etc/kubernetes/audit-policy.yaml</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO4-2" id="co_monitoring__logging__and_runtime_security_CO4-3"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">audit</code><code class="w">
</code><code class="w">      </code><code class="nt">readOnly</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/var/log/kubernetes/audit/</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO4-2" id="co_monitoring__logging__and_runtime_security_CO4-4"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">audit-log</code><code class="w">
</code><code class="w">      </code><code class="nt">readOnly</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">false</code><code class="w">
</code><code class="w">  </code><code class="p">...</code><code class="w">
</code><code class="w">  </code><code class="nt">volumes</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">audit</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO4-3" id="co_monitoring__logging__and_runtime_security_CO4-5"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">hostPath</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/etc/kubernetes/audit-policy.yaml</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">File</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">audit-log</code><code class="w"> </code><a class="co" href="#callout_monitoring__logging__and_runtime_security_CO4-3" id="co_monitoring__logging__and_runtime_security_CO4-6"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">hostPath</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/var/log/kubernetes/audit/</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">DirectoryOrCreate</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO4-1" id="callout_monitoring__logging__and_runtime_security_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Provides the location of the policy file and log file to the API server process.</p></dd>
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO4-3" id="callout_monitoring__logging__and_runtime_security_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Mounts the policy file and the audit log directory to the given paths.</p></dd>
<dt><a class="co" href="#co_monitoring__logging__and_runtime_security_CO4-5" id="callout_monitoring__logging__and_runtime_security_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Defines the Volumes for the policy file and the audit log directory.</p></dd>
</dl>
<p><a data-primary="documentation" data-secondary="Kubernetes" data-type="indexterm" id="idm46394748184656"/>The runtime behavior of the log backend can be further customized by passing additional flags to the API server process. For example, you can specify the maximum number of days to retain old audit log files by providing the flag <code>--audit-log-maxage</code>. Refer to the <a href="https://oreil.ly/L-63d">Kubernetes documentation</a> to have a look at the complete list of flags.</p>
<p><a data-primary="commands" data-secondary="kubectl" data-type="indexterm" id="idm46394748182192"/><a data-primary="kubectl command" data-type="indexterm" id="idm46394748181216"/>It’s time to produce some log entries. The following <code>kubectl</code> command sends a request to the API server for creating a Pod named <code>nginx</code>:</p>
<pre data-type="programlisting"><strong>$ kubectl run nginx --image=nginx:1.21.6</strong>
pod/nginx created</pre>
<p>In the previous step, we configured the audit log file at <code>/var/log/kubernetes/audit/audit.log</code>. Depending on the rules in the audit policy, the number of entries may be overwhelming, which makes finding a specific event hard. A simple way to filter configured events is by searching for the value <code>audit.k8s.io/v1</code> assigned to the <code>apiVersion</code> attribute. The following command finds relevant log entries, one for the <code>RequestResponse</code> level, and another for the <code>Metadata</code> level:</p>
<pre data-type="programlisting">
<strong>$ sudo grep 'audit.k8s.io/v1' /var/log/kubernetes/audit/audit.log</strong>
...
{"kind":"Event","apiVersion":"audit.k8s.io/v1","level":"RequestResponse", \
"auditID":"285f4b99-951e-405b-b5de-6b66295074f4","stage":"ResponseComplete", \
"requestURI":"/api/v1/namespaces/default/pods/nginx","verb":"get", \
"user":{"username":"system:node:node01","groups":["system:nodes", \
"system:authenticated"]},"sourceIPs":["172.28.116.6"],"userAgent": \
"kubelet/v1.26.0 (linux/amd64) kubernetes/b46a3f8","objectRef": \
{"resource":"pods","namespace":"default","name":"nginx","apiVersion":"v1"}, \
"responseStatus":{"metadata":{},"code":200},"responseObject":{"kind":"Pod", \
"apiVersion":"v1","metadata":{"name":"nginx","namespace":"default", \
...
{"kind":"Event","apiVersion":"audit.k8s.io/v1","level":"Metadata","auditID": \
"5c8e5ecc-0ce0-49e0-8ab2-368284f2f785","stage":"ResponseComplete", \
"requestURI":"/api/v1/namespaces/default/pods/nginx/status","verb":"patch", \
"user":{"username":"system:node:node01","groups":["system:nodes", \
"system:authenticated"]},"sourceIPs":["172.28.116.6"],"userAgent": \
"kubelet/v1.26.0 (linux/amd64) kubernetes/b46a3f8","objectRef": \
{"resource":"pods","namespace":"default","name":"nginx","apiVersion":"v1", \
"subresource":"status"},"responseStatus":{"metadata":{},"code":200}, \
...
</pre>
</div></section>
<section data-pdf-bookmark="Configuring a Webhook Backend" data-type="sect2"><div class="sect2" id="idm46394748323856">
<h2>Configuring a Webhook Backend</h2>
<p><a data-primary="configuring" data-secondary="webhook backend" data-type="indexterm" id="idm46394748106880"/><a data-primary="webhook backend" data-type="indexterm" id="idm46394748105904"/><a data-primary="kubeconfig file" data-type="indexterm" id="idm46394748105232"/>Configuring a webhook backend looks different from configuring a log backend. We need to tell the API server to send an HTTP(S) request to an external service instead of the file. The configuration to the external service, the webhook, and the credentials needed to authenticate are defined in a <a href="https://oreil.ly/bUnmO">kubeconfig file</a>, similarly to what we’ve done in <a data-type="xref" href="ch06.xhtml#configuring-imagepolicywebhook-admission-controller-plugin">“Configuring the ImagePolicyWebhook Admission Controller Plugin”</a>.</p>
<p><a data-primary="" data-startref="ac_mon" data-type="indexterm" id="idm46394748102512"/><a data-primary="" data-startref="al_ab" data-type="indexterm" id="idm46394748101312"/><a data-primary="" data-startref="ba_al" data-type="indexterm" id="idm46394748100368"/><a data-primary="" data-startref="mon_ab" data-type="indexterm" id="idm46394748099424"/>Add the flag <code>--audit-webhook-config-file</code> to the API server process in the file <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>, and point it to the location of the kubeconfig file. The flag <code>--audit-webhook-initial-backoff</code> defines the time to wait after the initial request to the external service before retrying. You will still have to assign the flag <code>--audit-policy-file</code> to point to the audit policy file.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm46394748096512">
<h1>Summary</h1>
<p>Monitoring and logging events in a Kubernetes cluster is an important duty of every administrator. We used Falco to identify and filter security-related events. You learned about the purpose and syntax of the different configuration files and how to find relevant alerts in the logs.</p>
<p>In addition to employing behavior analytics tools, you will want to set up audit logging for requests reaching the API server. Audit logging records configured events to a backend, either to a file on the control plane node or to an external service via an HTTP(S) call. We worked through the process of enabling audit logging for the API server process.</p>
<p>A sensible step toward more secure containers is to make them immutable. An immutable container only supports a read-only filesystem, so that a potential attacker cannot install malicious software. Mount a Volume if the application running inside of the container needs to write data. Use a distroless container image to lock out attackers from being able to shell into the container.</p>
</div></section>
<section data-pdf-bookmark="Exam Essentials" data-type="sect1"><div class="sect1" id="idm46394748094096">
<h1>Exam Essentials</h1>
<dl>
<dt>Practice how to configure and operate Falco.</dt>
<dd>
<p>Falco is definitely going to come up as a topic during the exam. You will need to understand how to read and modify a rule in a configuration file. I would suggest you browse through the syntax and options in more detail in case you need to write one yourself. The main entry point for running Falco is the command line tool. It’s fair to assume that it will have been preinstalled in the exam environment.</p>
</dd>
<dt>Know how to identify immutable containers.</dt>
<dd>
<p>Immutable containers are a central topic to this exam domain. Understand how to set the <code>spec.containers[].securityContext.readOnlyRootFilesystem</code> attribute for a Pod and how to mount a Volume to a specific path in case a write operation is required by the container process.</p>
</dd>
<dt>Deeply understand audit log configuration options.</dt>
<dd>
<p><a data-primary="behavior analytics" data-secondary="sample exercises" data-type="indexterm" id="idm46394748088192"/><a data-primary="sample exercises" data-secondary="behavior analytics" data-type="indexterm" id="idm46394748087216"/><a data-primary="" data-startref="log_ch" data-type="indexterm" id="idm46394748086272"/><a data-primary="" data-startref="mon_ch" data-type="indexterm" id="idm46394748085328"/><a data-primary="" data-startref="rs_ch" data-type="indexterm" id="idm46394748084384"/>Setting up audit logging consists of two steps. For one, you need to understand the syntax and structure of an audit policy file. The other aspect is how to configure the API server to consume the audit policy file, provide a reference to a backend, and mount the relevant filesystem Volumes. Make sure to practice all of those aspects hands-on.</p>
</dd>
</dl>
</div></section>
<section data-pdf-bookmark="Sample Exercises" data-type="sect1"><div class="sect1" id="idm46394748082928">
<h1>Sample Exercises</h1>
<ol>
<li>
<p>Navigate to the directory <em>app-a/ch07/falco</em> of the checked-out GitHub repository <a href="https://oreil.ly/sImXZ"><em>bmuschko/cks-study-guide</em></a>. Start up the VMs running the cluster using the command <code>vagrant up</code>. The cluster consists of a single control plane node named <code>kube-control-plane</code> and one worker node named <code>kube-worker-1</code>. Once done, shut down the cluster using <code>vagrant destroy -f</code>. Falco is already running as a systemd service.</p>
<p>Inspect the process running in the existing Pod named <code>malicious</code>. Have a look at the Falco logs and see if a rule created a log for the process.</p>
<p>Reconfigure the existing rule that creates a log for the event by changing the output to <code>&lt;timestamp&gt;,&lt;username&gt;,&lt;container-id&gt;</code>. Find the changed log entry in the Falco logs.</p>
<p>Reconfigure Falco to write logs to the file at <code>/var/logs/falco.log</code>. Disable the standard output channel. Ensure that Falco appends new messages to the log file.</p>
<p><em>Prerequisite:</em> This exercise requires the installation of the tools <a href="https://oreil.ly/FiyeH">Vagrant</a> and <a href="https://oreil.ly/WW8IK">
<span class="keep-together">VirtualBox</span></a>.</p>
</li>
<li>
<p>Navigate to the directory <em>app-a/ch07/immutable-container</em> of the checked-out GitHub repository <a href="https://oreil.ly/sImXZ"><em>bmuschko/cks-study-guide</em></a>. Execute the command <code>kubectl apply -f setup.yaml</code>.</p>
<p>Inspect the Pod created by the YAML manifest in the <code>default</code> namespace. Make relevant changes to the Pod so that its container can be considered immutable.</p>
</li>
<li>
<p>Navigate to the directory <em>app-a/ch07/audit-log</em> of the checked-out GitHub repository <a href="https://oreil.ly/sImXZ"><em>bmuschko/cks-study-guide</em></a>. Start up the VMs running the cluster using the command <code>vagrant up</code>. The cluster consists of a single control plane node named <code>kube-control-plane</code> and one worker node named <code>kube-worker-1</code>. Once done, shut down the cluster using <code>vagrant destroy -f</code>.</p>
<p>Edit the existing audit policy file at <code>/etc/kubernetes/audit/rules/audit-policy.yaml</code>. Add a rule that logs events for ConfigMaps and Secrets at the <code>Metadata</code> level. Add another rule that logs events for Services at the <code>Request</code> level.</p>
<p>Configure the API server to consume the audit policy file. Logs should be written to the file <code>/var/log/kubernetes/audit/logs/apiserver.log</code>. Define a maximum number of five days to retain audit log files.</p>
<p>Ensure that the log file has been created and contains at least one entry that matches the events configured.</p>
<p><em>Prerequisite:</em> This exercise requires the installation of the tools <a href="https://oreil.ly/FiyeH">Vagrant</a> and <a href="https://oreil.ly/WW8IK">
<span class="keep-together">VirtualBox</span></a>.</p>
</li>
</ol>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46394748057184">
<h1>Interactive Exam Practice</h1>
<p>Get more hands-on training and test your CKS exam readiness by working through our interactive CKS labs. Each step of the lab must be completed correctly before you can move to the next step. If you get stuck, you can view the solution and learn how to complete the step.</p>
<p>The following labs cover material from this chapter:</p>
<ul>
<li>
<p><a href="https://learning.oreilly.com/scenarios/configuring-and-running/9781098150006/">Configuring and Running Falco for Intrusion Detection</a></p>
</li>
<li>
<p><a href="https://learning.oreilly.com/scenarios/identifying-immutable-containers/9781098150013/">Identifying Immutable Containers</a></p>
</li>
<li>
<p><a href="https://learning.oreilly.com/scenarios/configuring-audit-logging/9781098150020/">Configuring Audit Logging for a Log Backend</a></p>
</li>
</ul>
</div></aside>
</div></section>
</div></section></div></body></html>