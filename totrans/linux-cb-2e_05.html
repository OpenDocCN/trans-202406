<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 5. Managing Users and Groups"><div class="chapter" id="cha-users-groups">
<h1><span class="label">Chapter 5. </span>Managing Users and Groups</h1>


<p>Linux has two <a data-type="indexterm" data-primary="users" data-secondary="types of" id="idm46466161752264"/><a data-type="indexterm" data-primary="human users" data-see="users" id="idm46466161749448"/><a data-type="indexterm" data-primary="unique identity" data-see="UID" id="idm46466161748600"/><a data-type="indexterm" data-primary="group identification" data-see="GID" id="idm46466161747752"/>types of users: human users and system users. Each user has a unique
identity (UID), and at least one group identification (GID). All users
have one primary group and may be members of multiple groups.</p>

<p>Each human user owns a home directory for their personal files.
User home directories belong<a data-type="indexterm" data-primary="/home" data-secondary="purpose of" id="idm46466161745960"/> in <em>/home</em> and are named for the owner, like our
example user Duchess, who owns <em>/home/duchess</em>. Users<a data-type="indexterm" data-primary="groups" data-secondary="supplemental" id="idm46466161745496"/><a data-type="indexterm" data-primary="supplemental groups" id="idm46466161742264"/> may belong to multiple
groups, and the additional group memberships are called <em>supplemental</em> groups.
Users in a group have all the privileges <a data-type="indexterm" data-primary="privileges" data-secondary="purpose of" id="idm46466161740312"/><a data-type="indexterm" data-primary="users" data-secondary="privileges, purpose of" id="idm46466161739464"/><a data-type="indexterm" data-primary="groups" data-secondary="privileges, purpose of" id="idm46466161738616"/>of that group. (To learn
all about privileges, see <a data-type="xref" href="ch06.xhtml#cha-files-directories">Chapter 6</a>.) Privileges control access
to files and commands, and are fundamental to system security.</p>

<p>System users <a data-type="indexterm" data-primary="system users" data-secondary="purpose of" id="idm46466161737672"/><a data-type="indexterm" data-primary="users" data-secondary="system users" data-tertiary="purpose of" id="idm46466161736072"/>represent system services and processes. System users need user
accounts for controlling their privileges and do not have logins or directories
in 
<span class="keep-together"><em>/home</em></span>.</p>

<p>Human users are<a data-type="indexterm" data-primary="users" data-secondary="root" id="idm46466161733736"/><a data-type="indexterm" data-primary="root users" id="idm46466161731784"/><a data-type="indexterm" data-primary="superusers" data-see="root users" id="idm46466161731176"/> divided into two categories: the <em>root</em> user, or the superuser,
is all-powerful and can do anything on the system. All other users are called
normal or unprivileged users. Normal users are given just enough privileges to
manage their own files and run commands that allow normal users to use them.
Normal users can be given limited or complete root powers, which you will learn
about in the recipes about <em>su</em> and <em>sudo</em>.</p>

<p>You can see all the users on your system<a data-type="indexterm" data-primary="/etc/passwd" id="idm46466161727624"/><a data-type="indexterm" data-primary="/etc/group" id="idm46466161727016"/> in <em>/etc/passwd</em>, and all the groups
in <em>/etc/group</em>.</p>
<div data-type="note" epub:type="note"><h1>Centralized User Management</h1>
<p><em>/etc/passwd</em> and <em>/etc/group</em> are inherited from Unix and have not changed much<a data-type="indexterm" data-primary="centralized user management" id="idm46466161722664"/><a data-type="indexterm" data-primary="users" data-secondary="centralized management" id="idm46466161722056"/>
since they were ported to Linux in 1992. Since then, newer tools have evolved to
manage users and groups, such as centralized databases that serve entire
organizations. This chapter does not cover centralized user management tools.</p>
</div>

<p>Linux <a data-type="indexterm" data-primary="users" data-secondary="commands for" id="idm46466161723416"/><a data-type="indexterm" data-primary="groups" data-secondary="commands for" id="idm46466161720392"/><a data-type="indexterm" data-primary="useradd command" id="idm46466161719544"/><a data-type="indexterm" data-primary="groupadd command" id="idm46466161718840"/><a data-type="indexterm" data-primary="userdel command" id="idm46466161718136"/><a data-type="indexterm" data-primary="groupdel command" id="idm46466161716904"/><a data-type="indexterm" data-primary="usermod command" id="idm46466161716200"/><a data-type="indexterm" data-primary="passwd command" id="idm46466161715400"/>comes with a number of commands for managing users and groups:</p>

<ul>
<li>
<p><em>useradd</em> creates new users.</p>
</li>
<li>
<p><em>groupadd</em> creates new groups.</p>
</li>
<li>
<p><em>userdel</em> deletes users.</p>
</li>
<li>
<p><em>groupdel</em> deletes groups.</p>
</li>
<li>
<p><em>usermod</em> is for making changes to existing users.</p>
</li>
<li>
<p><em>passwd</em> creates and changes passwords.</p>
</li>
</ul>

<p>These are part of <a data-type="indexterm" data-primary="Shadow Password Suite" id="idm46466161706232"/><a data-type="indexterm" data-primary="passwords" data-secondary="Shadow Password Suite" id="idm46466161705736"/>the <em>Shadow Password Suite</em>, and <em>/etc/login.defs</em> is its
main configuration file.</p>

<p><em>useradd</em> behaves differently on different systems, according to how it is
configured. Traditionally, it lumped all new users into the same primary group,
<em>users</em> (100). This meant that users had to be careful with permissions on their
files to avoid exposing them to other group users. Red Hat changed this
with its <em>User Private Group</em> scheme, which creates a personal private
group for each new user. Most Linux distributions make this the default, though
there are exceptions, such as openSUSE.</p>

<p>The Shadow Password Suite was created by Julianne Frances Haugh way back in the
1980s, back before Linux was born, to improve Unix password security and to
make user account management easier. It was ported to Linux in 1992, when Linux
was barely a year old.</p>

<p>Before the Shadow Password Suite, all the relevant files had to be edited
individually, there were multiple password management commands, and hashed
passwords were stored in <em>/etc/passwd</em> and <em>/etc/group</em>. These two files must
be world readable, so storing passwords in them, even when they’re hashed, is
asking for trouble. Anyone can copy a world-readable file, and then crack
the passwords at their leisure. Relocating the hashed passwords to the shadow
files, <em>/etc/shadow</em> and <em>/etc/gshadow</em>, which are accessible only by root,
added a strong layer of protection. The longevity of the Shadow Password
Suite is a testament to how well it was designed and coded.</p>

<p>Newer arrivals <a data-type="indexterm" data-primary="adduser command" id="idm46466161694792"/><a data-type="indexterm" data-primary="addgroup command" id="idm46466161700952"/>are <em>adduser</em> and <em>addgroup</em> for Debian. They are Perl script
wrappers for <em>useradd</em> and <em>groupadd</em>. These scripts walk you through a
complete new user and new group configuration.</p>

<p>In this chapter, you will learn how to create and remove human and system users,
manage passwords, find UIDs and GIDs, set your desired defaults for creating new
users, change group memberships, customize the common files your new users
need, clean up after users that you have removed, become root, and
grant limited root 
<span class="keep-together">powers</span> to normal users.</p>






<section data-type="sect1" data-pdf-bookmark="5.1 Finding a User’s UID and GID"><div class="sect1" id="rec-uid-gid">
<h1>5.1 Finding a User’s UID and GID</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161691368">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="users" data-secondary="UID/GID, displaying" id="user-uidgid-display"/><a data-type="indexterm" data-primary="UID (unique identity)" data-secondary="displaying" id="uid-display"/><a data-type="indexterm" data-primary="GID (group identification)" data-secondary="displaying" id="gid-display"/><a data-type="indexterm" data-primary="displaying" data-secondary="UID/GID" id="display-uidgid"/><a data-type="indexterm" data-primary="id command" id="id-command"/> want to list users’ UIDs and GIDs.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161683064">
<h2>Solution</h2>

<p>Use the <em>id</em> command with no options to see your own UID and GIDs. In the
following example, the user is Duchess:</p>
<pre>duchess@pc:~$ <strong>id</strong>
uid=1000(duchess) gid=1000(duchess)
groups=1000(duchess),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),118(lpadmin),
126(sambashare),131(libvirt)</pre>

<p>Display another user’s UID and GIDs by providing their username as an argument:</p>
<pre>duchess@pc:~$ <strong>id madmax</strong>
uid=1001(madmax) gid=1001(madmax) groups=1001(madmax),1010(composers)</pre>

<p>Display your effective ID. This is your ID when you run a command as another
user. You can see this with <em>sudo</em>:</p>
<pre>duchess@client4:~$ <strong>sudo id -un</strong>
root

duchess@client4:~$ <strong>sudo -u madmax id -gn</strong>
madmax
</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161676712">
<h2>Discussion</h2>

<p>There are three types of user IDs in Linux:</p>

<ul>
<li>
<p>Real UID/GID</p>
</li>
<li>
<p>Effective UID/GID</p>
</li>
<li>
<p>Saved UID/GID</p>
</li>
</ul>

<p>The <em>real ID</em> is<a data-type="indexterm" data-primary="real IDs" id="idm46466161670632"/> the UID and primary GID assigned to the user at creation. These
are what you see when you run the <em>id</em> command, as yourself, with no options.</p>

<p>The <em>effective ID</em> is<a data-type="indexterm" data-primary="effective IDs" id="idm46466161668616"/> the UID used to run a process that requires different privileges
than the user who launched the process, for example, the <em>passwd</em> command.
<em>passwd</em> requires<a data-type="indexterm" data-primary="passwd command" data-secondary="privileges" id="idm46466161666744"/><a data-type="indexterm" data-primary="privileges" data-secondary="for passwd command" data-secondary-sortas="passwd command" id="idm46466161665896"/> root privileges but uses the special permission modes to
allow users to change their own passwords.</p>

<p>You can see this for yourself. First, take a look at the <em>passwd</em> command’s
permissions:</p>
<pre>$ <strong>ls -l /usr/bin/passwd</strong>
-rwsr-xr-x 1 root root 68208 May 27  2020 /usr/bin/passwd</pre>

<p>This shows that <em>passwd</em> is owned by root, both UID and GID. Now type the
<em>passwd</em> command and press Enter.</p>

<p>Open a second terminal to find the process for <em>passwd</em>, then print its
process ID, effective ID, and real ID:</p>
<pre>$ <strong>ps -a|grep passwd</strong>
12916 pts/1    00:00:00 passwd

$ <strong>ps -eo pid,euser,ruser,rgroup | grep 12916
  12916 root     root     root</strong>
</pre>

<p>Even though an unprivileged user is running <em>passwd</em>, it runs with root
permissions. (See <a data-type="xref" href="ch06.xhtml#rec-sticky-symbolic">Recipe 6.11</a> for information on the special
permission modes.)</p>

<p>The <em>saved ID</em> is<a data-type="indexterm" data-primary="saved IDs" id="idm46466161656040"/> used by processes that need elevated privileges, usually
root privileges. When a process needs to do work that requires fewer privileges,
it can temporarily switch to a nonprivileged user ID. The effective UID is changed to
the lower privilege value, and the original effective UID is saved to the SUID,
saved user ID. When the process needs elevated privileges again, it changes to
the SUID.</p>

<p>The <em>id</em> command has a few options:</p>

<ul>
<li>
<p><em>-u</em> shows the effective UID number.</p>
</li>
<li>
<p><em>-g</em> shows the effective GID number.</p>
</li>
<li>
<p><em>-G</em> shows all group IDs.</p>
</li>
<li>
<p><em>-n</em> prints the name rather than the number. You can use this in combination
with <em>-u</em>, <em>-g</em>, and <em>-G</em>.</p>
</li>
<li>
<p><em>-un</em> shows the effective UID username.</p>
</li>
<li>
<p><em>-gn</em> shows the effective group name.</p>
</li>
<li>
<p><em>-Gn</em> shows all effective GID names.</p>
</li>
<li>
<p><em>-r</em> shows the real ID instead of the effective ID. You can use this in
combination with <em>-u</em>, <em>-g</em>, <a data-type="indexterm" data-primary="users" data-secondary="UID/GID, displaying" data-startref="user-uidgid-display" id="idm46466161641080"/><a data-type="indexterm" data-primary="UID (unique identity)" data-secondary="displaying" data-startref="uid-display" id="idm46466161639816"/><a data-type="indexterm" data-primary="GID (group identification)" data-secondary="displaying" data-startref="gid-display" id="idm46466161638728"/><a data-type="indexterm" data-primary="displaying" data-secondary="UID/GID" data-startref="display-uidgid" id="idm46466161637640"/><a data-type="indexterm" data-primary="id command" data-startref="id-command" id="idm46466161636328"/>and <em>-G</em>.</p>
</li>
</ul>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161634872">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch06.xhtml#rec-sticky-symbolic">Recipe 6.11</a></p>
</li>
<li>
<p><em>man 1 id</em></p>
</li>
<li>
<p><em>man 1 ps</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.2 Creating a Human User with useradd"><div class="sect1" id="rec-create-user-useradd">
<h1>5.2 Creating a Human User with useradd</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161628072">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="users" data-secondary="creating" data-tertiary="with useradd command" data-tertiary-sortas="useradd command" id="user-create-useradd"/><a data-type="indexterm" data-primary="useradd command" data-secondary="human users, creating" id="useradd-human-create"/>want to create a new user with a user private group and home directory
populated with a set of default files like <em>.bashrc</em>, <em>.profile</em>,
<em>.bash_history</em>, and any other files you want them to have.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161622344">
<h2>Solution</h2>

<p>The <em>useradd</em> command is included in most Linux distributions and is
configurable to suit your requirements. The default configuration varies across
the various Linux distributions, so the quickest way to learn how your system
is set up is to create a new test user:</p>
<pre>$ <strong>sudo useradd test1</strong></pre>

<p>Now run the <em>id</em> command, and then see if <em>useradd</em> created a home directory.
The following examples are from Fedora 34:</p>
<pre>$ <strong>id test1</strong>
uid=1011(test1) gid=1011(test1) groups=1011(test1)

$ <strong>sudo ls -a /home/test1/</strong>
.  ..  .bash_logout  .bash_profile  .bashrc</pre>

<p>In this example, the default configuration meets all the requirements listed in
the Problem. Now you only need to set a password:</p>
<pre>$ <strong>sudo passwd test1</strong>
Changing password for user test1.
New password: <i>password</i>
Retype new password: <i>password</i>
passwd: all authentication tokens updated successfully.</pre>

<p>You may<a data-type="indexterm" data-primary="passwords" data-secondary="for new users" data-secondary-sortas="new users" id="idm46466161612280"/> elect to force the user to reset their password at first login, after
creating the user’s password:</p>
<pre>$ <strong>sudo passwd -e test1</strong>
Expiring password for user test1.
passwd: Success</pre>

<p>Give the login to your user, and they can start using their new account. The
new user account is represented like this in <em>/etc/passwd</em>:</p>
<pre>
test1:x:1011:1011::/home/test1:/bin/bash</pre>

<p>Some Linuxes, for example openSUSE, configure <em>useradd</em> to not create the
user’s home directory by default and to put all users into the <em>users (100)</em>
group. This potentially exposes files to other users, if group permissions on the
files allow it. The following example creates a user private group:</p>
<pre>$ <strong>sudo useradd -mU test2</strong></pre>

<p><em>-m</em> creates the user’s home directory, and <em>-U</em> creates their private group
with the same name as their username.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161621000">
<h2>Discussion</h2>

<p>All new user accounts are inactive until you set a password.</p>

<p>The first group <a data-type="indexterm" data-primary="groups" data-secondary="primary" id="idm46466161602824"/><a data-type="indexterm" data-primary="primary groups" id="idm46466161602088"/>created for a user, whether it is a user private group or a
common group for all users, is their <em>primary</em> group. All other groups the user
is assigned to <a data-type="indexterm" data-primary="groups" data-secondary="supplemental" id="idm46466161600200"/><a data-type="indexterm" data-primary="supplemental groups" id="idm46466161598952"/>are <em>supplementary</em> groups.</p>

<p>There are some additional useful options:</p>

<ul>
<li>
<p><em>-G</em>, <em>--groups</em> is for adding the user to multiple supplemental groups in a
comma-delimited list. The groups must already exist:</p>
</li>
</ul>
<pre>$ <strong>sudo useradd -G group1,group2,group3 test1</strong></pre>

<ul>
<li>
<p><em>-c</em>, <em>--comment</em> accepts any text string. Use this for the user’s full name,
or any comment or description:</p>
</li>
</ul>
<pre>$ <strong>useradd -G group1,group2,group3 -c 'Test 1,,,,' test1</strong></pre>

<p>The four commas define five fields: full name, room number, work phone, home
phone, and other. Way back in olden times this was called the <a data-type="indexterm" data-primary="GECOS data" id="idm46466161592072"/>GECOS data. GECOS
is short for General Electric Comprehensive Operating Supervisor, a mainframe
operating system. You may enter any text string in these fields, or nothing, though
it is useful to include the user’s full name. Study your <em>/etc/passwd</em> file to
see how other entries use the GECOS fields.</p>

<p>The <em>useradd</em> defaults are scattered across multiple configuration files; see
<a data-type="xref" href="#rec-change-useradd-defaults">Recipe 5.4</a> to learn how to change the<a data-type="indexterm" data-primary="users" data-secondary="creating" data-tertiary="with useradd command" data-tertiary-sortas="useradd command" data-startref="user-create-useradd" id="idm46466161590728"/><a data-type="indexterm" data-primary="useradd command" data-secondary="human users, creating" data-startref="useradd-human-create" id="idm46466161586920"/> defaults.</p>
</div></section>













<section data-type="sect2" class="pagebreak-before less_space" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161604056">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 useradd</em></p>
</li>
<li>
<p><em>man 5 login.defs</em></p>
</li>
<li>
<p><em>/etc/default/useradd</em></p>
</li>
<li>
<p><em>/etc/skel</em></p>
</li>
<li>
<p><em>/etc/login/defs</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.3 Creating a System User with useradd"><div class="sect1" id="rec-create-system-user">
<h1>5.3 Creating a System User with useradd</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161576536">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="users" data-secondary="system users" data-tertiary="creating with useradd" id="idm46466161575304"/><a data-type="indexterm" data-primary="system users" data-secondary="creating" data-tertiary="with useradd command" data-tertiary-sortas="useradd command" id="idm46466161574216"/><a data-type="indexterm" data-primary="useradd command" data-secondary="system users, creating" id="idm46466161572856"/>want to create a system user with the <em>useradd</em> command.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161570648">
<h2>Solution</h2>

<p>The following example creates a new system user with no home directory, no
login shell, and uses the correct UID numbering range for system users:</p>
<pre>$ <strong>sudo useradd -rs /bin/false service1</strong></pre>

<p><em>-r</em> means create a system user with a real ID in the correct numerical range for
system users, and <em>-s</em> specifies the login shell. <em>/bin/false</em> is a command
that does nothing and prevents the user from logging into the system.</p>

<p>See the Discussion in <a data-type="xref" href="#rec-uid-gid-numbering">Recipe 5.6</a> for information about UID and GID numbering.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161565144">
<h2>Discussion</h2>

<p>In olden times, most services ran as <a data-type="indexterm" data-primary="nobody users" id="idm46466161563736"/><a data-type="indexterm" data-primary="users" data-secondary="nobody" id="idm46466161563128"/><a data-type="indexterm" data-primary="services" data-secondary="system users" data-see="system users" id="idm46466161562280"/>the <em>nobody</em> user. Now it is a common
practice for services to have their own unique users, as this provides stronger
security than the <em>nobody</em> user owning multiple services. You will
rarely have to create a system user, as services should create their own unique
users when they are installed.</p>

<p>The <em>nobody</em> user is always assigned UID 65534 and GID 65534.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161559576">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 useradd</em></p>
</li>
<li>
<p><em>man 1 false</em></p>
</li>
<li>
<p>The Discussion in <a data-type="xref" href="#rec-uid-gid-numbering">Recipe 5.6</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.4 Changing the useradd Default Settings"><div class="sect1" id="rec-change-useradd-defaults">
<h1>5.4 Changing the useradd Default Settings</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161551768">
<h2>Problem</h2>

<p>The <a data-type="indexterm" data-primary="useradd command" data-secondary="default settings, changing" id="useradd-default-change"/><a data-type="indexterm" data-primary="default useradd settings, changing" id="default-useradd-change"/><a data-type="indexterm" data-primary="changing" data-secondary="default useradd settings" id="change-default-useradd"/>default <em>useradd</em> settings are not right for you, and you want to change them.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161547032">
<h2>Solution</h2>

<p>The <em>useradd</em> configuration is spread across multiple configuration files:
<em>/etc/default/useradd</em>, <em>/etc/login.defs</em>, and files in the <em>/etc/skel</em>
directory.</p>

<p>The following values appear in <em>/etc/default/useradd</em>. This example shows the
openSUSE defaults:</p>
<pre>$ <strong>useradd -D</strong>
GROUP=100
HOME=/home
INACTIVE=-1
EXPIRE=
SHELL=/bin/bash
SKEL=/etc/skel
CREATE_MAIL_SPOOL=yes</pre>

<p><em>GROUP=100</em> sets a single shared group as the default for all new users, traditionally
<em>100</em>. The group must first exist, and <em>USERGROUPS_ENAB no</em> must be
set in <em>/etc/login.defs</em>. Then set <em>GROUP=</em> in <em>/etc/default/useradd</em> to the
GID of the user group. If our Duchess user is in a shared group, her <em>id</em>
output shows <em>uid=1000(duchess) gid=100(users)</em>.</p>

<p>Enable private user groups by setting <em>USERGROUPS_ENAB yes</em> in
<em>/etc/login.defs</em>, then comment out <em>GROUP=</em> in <em>/etc/default/useradd</em>.
This creates a nonshared private group for each user. If our Duchess user has
her own private group, her <em>id</em> output shows <em>uid=1000(duchess) gid=1000(duchess)</em>.</p>
<dl>
<dt>HOME=</dt>
<dd>
<p>sets the default directory for all user home directories. The default  is <em>/home</em>.</p>
</dd>
<dt>INACTIVE=-1</dt>
<dd>
<p>sets the number of days after a password expires until the account is locked.
A value of 0 disables the account as soon as the password expires, and a value of –1 disables locking the account.</p>
</dd>
<dt>EXPIRE=</dt>
<dd>
<p>sets an expiration date on the account, in YYYY-MM-DD format. For
example, if you set it to 2021-12-31, the account will be disabled on that date.
Leaving <em>EXPIRE=</em> empty means the account will not expire.</p>
</dd>
<dt>SHELL=/bin/bash</dt>
<dd>
<p>sets the default command shell. <em>/bin/bash</em> is the most commonly used
Linux shell. Other values are any installed shell on the user’s system, such
as <em>/bin/zsh</em> or <em>/usr/bin/tcsh</em>. <em>cat /etc/shells</em> lists all installed shells.</p>
</dd>
<dt>SKEL=/etc/skel</dt>
<dd>
<p>sets the location for the files that you want automatically distributed
to new users. Most Linuxes put them in <em>/etc/skel</em>. These are files such as
<em>.bash_logout</em>,  <em>.bash_profile</em> or <em>.profile</em>, <em>.bashrc</em>, and any other
files you want new users to have. You may edit these files to suit your own
requirements. <em>SKEL</em> is short for skeleton.</p>
</dd>
<dt>CREATE_MAIL_SPOOL=yes</dt>
<dd>
<p>is a relic of olden times, and should be set to <em>yes</em>, as
there may be some legacy processes that still need it.</p>
</dd>
</dl>

<p>The following values in <em>/etc/login.defs</em> are relevant to user creation
defaults:</p>

<ul>
<li>
<p><em>USERGROUPS_ENAB yes</em> enables private user groups.</p>
</li>
<li>
<p><em>CREATE_HOME yes</em> configures <em>useradd</em> to automatically create private user home
directories. This does not apply to system users (see
<a data-type="xref" href="#rec-create-system-user">Recipe 5.3</a>).</p>
</li>
</ul>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161513144">
<h2>Discussion</h2>

<p>The <a data-type="indexterm" data-primary="UID (unique identity)" data-secondary="numbering range" id="idm46466161511464"/>UID numbering range is defined in <em>/etc/login.defs</em>. Every UID must be
unique, so the user account creation commands assign UIDs from the range defined
in this file. Typically, human UIDs start at 1000, and are automatically assigned
by <em>useradd</em>. You can override this with the <em>-u</em> option, but you must select
an unused number that follows the configured numbering scheme
(see the Discussion in <a data-type="xref" href="#rec-uid-gid-numbering">Recipe 5.6</a>).</p>

<p>A mandatory password change at first login is a simple precaution against the
original password possibly falling into the wrong hands as it passes from the
administrator to the<a data-type="indexterm" data-primary="useradd command" data-secondary="default settings, changing" data-startref="useradd-default-change" id="idm46466161508344"/><a data-type="indexterm" data-primary="default useradd settings, changing" data-startref="default-useradd-change" id="idm46466161507256"/><a data-type="indexterm" data-primary="changing" data-secondary="default useradd settings" data-startref="change-default-useradd" id="idm46466161505528"/> user.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161503432">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 useradd</em></p>
</li>
<li>
<p><em>man 5 login.defs</em></p>
</li>
<li>
<p><em>/etc/default/useradd</em></p>
</li>
<li>
<p><em>/etc/skel</em></p>
</li>
<li>
<p><em>/etc/login/defs</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.5 Customizing the Documents, Music, Video, Pictures, and Downloads Directories"><div class="sect1" id="idm46466161496344">
<h1>5.5 Customizing the Documents, Music, Video, Pictures, and Downloads Directories</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161495336">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="users" data-secondary="well-known user directories, customizing" id="user-directory-custom"/><a data-type="indexterm" data-primary="well-known user directories, customizing" id="wellknown-directory-custom"/><a data-type="indexterm" data-primary="customizing" data-secondary="well-known user directories" id="custom-wellknown-directory"/><a data-type="indexterm" data-primary="directories" data-secondary="well-known user, customizing" id="directory-wellknown-custom"/><a data-type="indexterm" data-primary="Documents directory, customizing" id="document-directory-custom"/><a data-type="indexterm" data-primary="Music directory, customizing" id="music-directory-custom"/><a data-type="indexterm" data-primary="Video directory, customizing" id="video-directory-custom"/><a data-type="indexterm" data-primary="Picture directory, customizing" id="picture-directory-custom"/><a data-type="indexterm" data-primary="Downloads directory, customizing" id="download-directory-custom"/> followed <a data-type="xref" href="#rec-create-user-useradd">Recipe 5.2</a> to create a new user, now you want
to customize the Documents, Music, Video, Pictures, and Downloads directories
for new users.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161483544">
<h2>Solution</h2>

<p>Creating these directories is not a function of <em>useradd</em>, but rather the
X Desktop Group (XDG) user directories tool. The Documents, Music, Video, etc.,
directories are called the <em>well-known user directories</em>. These directories
are set up from the <em>/etc/xdg/user-dirs.defaults</em> configuration file, which
establishes the default configuration for all users:</p>
<pre>$ <strong>less /etc/xdg/user-dirs.defaults</strong>
# Default settings for user directories
#
# The values are relative pathnames from the home directory and
# will be translated on a per-path-element basis into the users locale
DESKTOP=Desktop
DOWNLOAD=Downloads
TEMPLATES=Templates
PUBLICSHARE=Public
DOCUMENTS=Documents
MUSIC=Music
PICTURES=Pictures
VIDEOS=Videos
# Another alternative is:
#MUSIC=Documents/Music
#PICTURES=Documents/Pictures
#VIDEOS=Documents/Videos</pre>

<p>These are name-value pairs. The names cannot be changed. The values are the
directories that the names are mapped to, and they are relative to users’ home
directories. For example, DOCUMENTS is mapped to
<em>/home/username/Documents</em>. The directories are created automatically
for every new user when they start their graphical desktop environments for
the first time. You may comment out any directories you wish to exclude or
change the directories the names are mapped to.</p>

<p>Users may create their own personal configurations in
<em>~/.config/user-dirs.dirs</em>. The directories must exist before applying
the changes. The following example was created by our example user Duchess, who
does not care for the boring default values. Note that the name-value pair
syntax is different in <em>~/.config/user-dirs.dirs</em>:</p>
<pre class="pagebreak-before">XDG_DESKTOP_DIR="$HOME/table"
XDG_DOWNLOAD_DIR="$HOME/landing-zone"
XDG_DOCUMENTS_DIR="$HOME/omg-paperwork"
XDG_MUSIC_DIR="$HOME/singendance"
XDG_PICTURES_DIR="$HOME/piccies"</pre>

<p>When your changes are complete and the new directories have been created, use
the <em>xdg-user-dirs-update</em> command to apply your changes:</p>
<pre>duchess@pc:~$ <strong>xdg-user-dirs-update --set DOWNLOAD $HOME/landing-zone</strong>
duchess@pc:~$ <strong>xdg-user-dirs-update --set DESKTOP  $HOME/table</strong>
duchess@pc:~$ <strong>xdg-user-dirs-update --set DOCUMENTS  $HOME/omg-paperwork</strong>
duchess@pc:~$ <strong>xdg-user-dirs-update --set MUSIC  $HOME/singendance</strong>
duchess@pc:~$ <strong>xdg-user-dirs-update --set PICTURES  $HOME/piccies</strong></pre>

<p>Log out, then log back in, and you will see something like
<a data-type="xref" href="#fig-thunar-xdg">Figure 5-1</a>. XDG applies special icons to the well-known directories.</p>

<figure><div id="fig-thunar-xdg" class="figure">
<img src="Images/lcb2_0501.png" alt="lcb2 0501" width="463" height="381"/>
<h6><span class="label">Figure 5-1. </span>Custom well-known directories</h6>
</div></figure>

<p>The shortcuts in the side pane will not change, and the old directories are
unchanged except they do not have the special icons. You will have to change
the shortcuts and migrate the old directory contents manually.</p>

<p>Restore to the defaults in <em>/etc/xdg/user-dirs.defaults</em> with this command:</p>
<pre>$ <strong>xdg-user-dirs-update --force</strong></pre>

<p>Log out and back in to see the changes. Again, none of your directories are
removed or changed in any way, except for the special icons that mark the
well-known user directories.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161481704">
<h2>Discussion</h2>

<p>When you run the <em>xdg-user-dirs-update --set</em> command, you must use only the
names as listed in <em>man 5 user-dirs.default</em>:</p>

<pre data-type="programlisting">DESKTOP
DOWNLOAD
TEMPLATES
PUBLICSHARE
DOCUMENTS
MUSIC
PICTURES
VIDEOS</pre>

<p>Only the values, which are the target directories, are configurable. Target
directories must be relative to users’ home directories. If you want to use
directories outside of your home, create symlinks. For example, Duchess owns
<em>/users/stuff/duchess</em> and stores music files in it. The following example
links this <a data-type="indexterm" data-primary="users" data-secondary="well-known user directories, customizing" data-startref="user-directory-custom" id="idm46466161460200"/><a data-type="indexterm" data-primary="well-known user directories, customizing" data-startref="wellknown-directory-custom" id="idm46466161459112"/><a data-type="indexterm" data-primary="customizing" data-secondary="well-known user directories" data-startref="custom-wellknown-directory" id="idm46466161458200"/><a data-type="indexterm" data-primary="directories" data-secondary="well-known user, customizing" data-startref="directory-wellknown-custom" id="idm46466161455992"/><a data-type="indexterm" data-primary="Documents directory, customizing" data-startref="document-directory-custom" id="idm46466161454872"/><a data-type="indexterm" data-primary="Music directory, customizing" data-startref="music-directory-custom" id="idm46466161453832"/><a data-type="indexterm" data-primary="Video directory, customizing" data-startref="video-directory-custom" id="idm46466161452840"/><a data-type="indexterm" data-primary="Picture directory, customizing" data-startref="picture-directory-custom" id="idm46466161451752"/><a data-type="indexterm" data-primary="Downloads directory, customizing" data-startref="download-directory-custom" id="idm46466161450648"/>directory to <em>/home/duchess/singendance</em>:</p>
<pre>duchess@pc:~$ <strong>ln -s /users/stuff/duchess /home/duchess/singendance</strong>
</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161447768">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 5 user-dirs.defaults</em></p>
</li>
<li>
<p><em>man 1 xdg-user-dirs-update</em></p>
</li>
<li>
<p><em>man 5 user-dirs.conf</em></p>
</li>
<li>
<p><a href="https://oreil.ly/FFDga">xdg-user-dirs at
freedesktop</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.6 Creating User and System Groups with groupadd"><div class="sect1" id="rec-uid-gid-numbering">
<h1>5.6 Creating User and System Groups with groupadd</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161440808">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="groups" data-secondary="creating" data-tertiary="with groupadd command" data-tertiary-sortas="groupadd command" id="group-create-groupadd"/><a data-type="indexterm" data-primary="groupadd command" id="groupadd-command"/><a data-type="indexterm" data-primary="users" data-secondary="groups" data-see="groups" id="idm46466161437016"/><a data-type="indexterm" data-primary="system groups" data-secondary="creating" data-tertiary="with groupadd command" data-tertiary-sortas="groupdadd command" id="system-group-create"/>want to create groups with <em>groupadd</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161434056">
<h2>Solution</h2>

<p>The following example creates a new user group <em>musicians</em>:</p>
<pre>$ <strong>sudo groupadd musicians</strong></pre>

<p>Use <em>groupadd</em> with the <em>-r</em> option to create a system group:</p>
<pre>$ <strong>sudo groupadd -r service1</strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161428536">
<h2>Discussion</h2>

<p>System groups <a data-type="indexterm" data-primary="groups" data-secondary="numbering range" id="idm46466161426968"/><a data-type="indexterm" data-primary="UID (unique identity)" data-secondary="numbering range" id="idm46466161425768"/><a data-type="indexterm" data-primary="GID (group identification)" data-secondary="numbering range" id="idm46466161424920"/><a data-type="indexterm" data-primary="system groups" data-secondary="numbering range" id="idm46466161424072"/>differ from human user groups in the UID and GID numbering ranges
assigned to them. This is configured in <em>/etc/login.defs</em> for <em>groupadd</em> and
<em>useradd</em>, as this example from Fedora 34 shows:</p>

<pre data-type="programlisting"># Min/max values for automatic uid selection in useradd(8)
#
UID_MIN                  1000
UID_MAX                 60000
# System accounts
SYS_UID_MIN               201
SYS_UID_MAX               999
# Extra per user uids
SUB_UID_MIN                100000
SUB_UID_MAX             600100000
SUB_UID_COUNT               65536

#
# Min/max values for automatic gid selection in groupadd(8)
#
GID_MIN                  1000
GID_MAX                 60000
# System accounts
SYS_GID_MIN               201
SYS_GID_MAX               999
# Extra per user group ids
SUB_GID_MIN                100000
SUB_GID_MAX             600100000
SUB_GID_COUNT               65536</pre>

<p>These define the number ranges available to the system administrator. All
others are reserved for and managed by the system.</p>

<p>GID numbering is managed automatically by <em>groupadd</em>, according to the
number ranges defined in <em>/etc/login.defs</em> You may override this with the
<em>-g</em> option, but your chosen GID must fall within the defined range, and must
not already be <a data-type="indexterm" data-primary="groups" data-secondary="creating" data-tertiary="with groupadd command" data-tertiary-sortas="groupadd command" data-startref="group-create-groupadd" id="idm46466161415448"/><a data-type="indexterm" data-primary="groupadd command" data-startref="groupadd-command" id="idm46466161414552"/><a data-type="indexterm" data-primary="system groups" data-secondary="creating" data-tertiary="with groupadd command" data-tertiary-sortas="groupdadd command" data-startref="system-group-create" id="idm46466161414040"/>used.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161419192">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 groupadd</em></p>
</li>
<li>
<p><em>/etc/login.defs</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" class="pagebreak-before less_space" data-pdf-bookmark="5.7 Adding Users to Groups with usermod"><div class="sect1" id="idm46466161408824">
<h1>5.7 Adding Users to Groups with usermod</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161407400">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="users" data-secondary="assigning to groups" id="idm46466161406136"/><a data-type="indexterm" data-primary="groups" data-secondary="assigning users" id="idm46466161405288"/><a data-type="indexterm" data-primary="usermod command" data-secondary="assigning users to groups" id="idm46466161404440"/>want to assign users to groups.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161403016">
<h2>Solution</h2>

<p>Use the <em>usermod</em> command. The following example adds Duchess to the <em>musicians</em>
group:</p>
<pre>$ <strong>sudo usermod -aG musicians duchess</strong></pre>

<p>This example adds Duchess to multiple groups:</p>
<pre>$ <strong>sudo usermod -aG musicians,composers,stagehands duchess</strong></pre>

<p>Alternatively, you could edit <em>/etc/group</em> and type Duchess’s name after
the appropriate group or groups. When you list multiple group members, the list
must be comma-delimited, with no spaces between the names.</p>
<pre>musicians:x:900:stash,madmax,duchess</pre>
<div data-type="warning" epub:type="warning"><h1>Be Careful to Append, Not Replace</h1>
<p>If you forget the <em>-a</em> option and use <em>-G</em> alone, all of the user’s existing
groups will be removed and replaced with the new groups. This is especially
damaging if this removes users from their <em>sudo</em> group.</p>
</div>

<p>When you change group memberships for logged-in users, users must log out and
then log back in to activate the changes. There are various workarounds to
activate a new group assignment without logging out, but they all have limitations,
such as being limited to the current shell. Groups are enumerated at login, so
the most reliable solution is to log out and log back in.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161393544">
<h2>Discussion</h2>

<p>The <em>-a</em> option means append, and <em>-G</em> is group or groups.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161390680">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 usermod</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" class="pagebreak-before less_space" data-pdf-bookmark="5.8 Creating Users with adduser on Ubuntu"><div class="sect1" id="idm46466161387928">
<h1>5.8 Creating Users with adduser on Ubuntu</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161386056">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="users" data-secondary="creating" data-tertiary="with adduser command" data-tertiary-sortas="adduser command" id="user-create-adduser"/><a data-type="indexterm" data-primary="adduser command" data-secondary="human users, creating" id="adduser-human-create"/>are running Debian or a Debian-based Linux, and need to know how to create
new users with <em>adduser</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161381448">
<h2>Solution</h2>

<p><em>adduser</em> walks you through a complete new user setup, like this example for Stash
Cat:</p>
<pre>$ <strong>sudo adduser stash</strong>
Adding user 'stash' ...
Adding new group 'stash' (1009) ...
Adding new user 'stash' (1009) with group 'stash' ...
Creating home directory '/home/stash' ...
Copying files from '/etc/skel' ...
Enter new UNIX password:
Retype new UNIX password:
passwd: password updated successfully
Changing the user information for stash
Enter the new value, or press ENTER for the default
        Full Name []: Stash Cat
        Room Number []:
        Work Phone []:
        Home Phone []:
        Other []:
Is the information correct? [Y/n]</pre>

<p>Stash looks like this in <em>/etc/passwd</em>:</p>

<pre data-type="programlisting">stash:x:1009:1009:Stash Cat,,,:/home/stash:/bin/bash</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161375960">
<h2>Discussion</h2>

<p>The <em>adduser</em> defaults are managed in <em>/etc/adduser.conf</em>. This provides a
number of useful defaults such as:</p>
<dl>
<dt>DSHELL=</dt>
<dd>
<p>sets the default login shell. <em>/bin/bash</em> is the most commonly used
Linux shell. Other values are any
installed shell on the user’s system, such as <em>/bin/zsh</em> or <em>/usr/bin/tcsh</em>.
<em>cat /etc/shells</em> lists all installed shells.</p>
</dd>
<dt>USERGROUPS=yes</dt>
<dd>
<p>creates user private groups, <em>no</em> puts all users into
the same group.</p>
</dd>
<dt>USERS_GID=100</dt>
<dd>
<p>is required when <em>USERGROUPS=no</em> is set.</p>
</dd>
<dt>EXTRA_GROUPS=</dt>
<dd>
<p>is your list of supplemental groups for new users, for
example, <em>EXTRA_GROUPS="audio video plugdev libvirt"‍</em>.</p>
</dd>
<dt>ADD_EXTRA_GROUPS=1</dt>
<dd>
<p>makes the groups listed in <em>EXTRA_GROUPS=</em> the default
for new users.</p>
</dd>
</dl>

<p><em>/etc/adduser.conf</em> contains the following user and group numbering scheme:</p>

<pre data-type="programlisting">FIRST_SYSTEM_UID=100
LAST_SYSTEM_UID=999

FIRST_SYSTEM_GID=100
LAST_SYSTEM_GID=999

FIRST_UID=1000
LAST_UID=59999

FIRST_GID=1000
LAST_GID=59999--</pre>

<p>Fedora Linux includes <em>adduser</em>, but it is not really <em>adduser</em>, just a
symlink<a data-type="indexterm" data-primary="users" data-secondary="creating" data-tertiary="with adduser command" data-tertiary-sortas="adduser command" data-startref="user-create-adduser" id="idm46466161359112"/><a data-type="indexterm" data-primary="adduser command" data-secondary="human users, creating" data-startref="adduser-human-create" id="idm46466161357544"/> to <em>useradd</em>:</p>
<pre>$ <strong>stat /usr/sbin/adduser</strong>
  File: /usr/sbin/adduser -&gt; useradd
  Size: 7    Blocks: 0    IO Block: 4096   symbolic link
[...]</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161354920">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 5 adduser.conf</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.9 Creating a System User with adduser on Ubuntu"><div class="sect1" id="rec-create-system-user-adduser">
<h1>5.9 Creating a System User with adduser on Ubuntu</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161350632">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="users" data-secondary="system users" data-tertiary="creating with adduser command" id="user-system-create-adduser"/><a data-type="indexterm" data-primary="system users" data-secondary="creating" data-tertiary="with adduser command" data-tertiary-sortas="adduser command" id="system-create-adduser"/><a data-type="indexterm" data-primary="adduser command" data-secondary="system users, creating" id="adduser-system-create"/>want to create a system user with <em>adduser</em> on your Ubuntu (or Debian, Mint,
or other Debian derivative) system.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161343304">
<h2>Solution</h2>

<p>The following example creates a new system user, <em>service1</em>, with <em>adduser</em>,
without a home directory, and with its own unique primary group:</p>
<pre>$ <strong>sudo adduser --system  --no-create-home --group service</strong>
Adding system user 'service1' (UID 124) ...
Adding new group 'service1' (GID 135) ...
Adding new user 'service1' (UID 124) with group 'service1' ...
Not creating home directory '/home/service1'.</pre>

<p>This is how it looks in <em>/etc/passwd</em>:</p>

<pre data-type="programlisting">service1:x:124:135::/home/service1:/usr/sbin/nologin</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161338360">
<h2>Discussion</h2>

<p>System users do not have home directories.</p>

<p>Back in olden times, it was common for services to run as <a data-type="indexterm" data-primary="nobody users" id="idm46466161336936"/><a data-type="indexterm" data-primary="users" data-secondary="nobody" id="idm46466161334392"/>the <em>nobody</em> user
and group, except Debian which uses <em>nobody</em> and <em>nogroup</em>. Recycling the
same user for multiple services is a security weakness. It is unlikely you will
ever have to create a system user, as the common practice now is for the
package installer to create a unique user and group when you install a new
service. But now you know how, just in case you ever 
<span class="keep-together">need to.</span></p>

<p><em>nobody</em> and <em>nogroup</em> always have a real ID <a data-type="indexterm" data-primary="users" data-secondary="system users" data-tertiary="creating with adduser command" data-startref="user-system-create-adduser" id="idm46466161331400"/><a data-type="indexterm" data-primary="system users" data-secondary="creating" data-tertiary="with adduser command" data-tertiary-sortas="adduser command" data-startref="system-create-adduser" id="idm46466161330072"/><a data-type="indexterm" data-primary="adduser command" data-secondary="system users, creating" data-startref="adduser-system-create" id="idm46466161328440"/>of 65534.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161326072">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 adduser</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.10 Creating User and System Groups with addgroup"><div class="sect1" id="idm46466161323368">
<h1>5.10 Creating User and System Groups with addgroup</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161322472">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="groups" data-secondary="creating" data-tertiary="with addgroup command" id="group-create-addgroup"/><a data-type="indexterm" data-primary="addgroup command" id="addgroup-command"/><a data-type="indexterm" data-primary="system groups" data-secondary="creating" data-tertiary="with addgroup command" data-tertiary-sortas="addgroup command" id="system-group-create-addgroup"/> want to know how to create user and system groups with Debian’s <em>addgroup</em>
command.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161316984">
<h2>Solution</h2>

<p>The following example creates a human user group:</p>
<pre>$ <strong>sudo addgroup composers</strong>
Adding group 'composers' (GID 1010) ...
Done.</pre>

<p>It looks like this in <em>/etc/group</em>:</p>

<pre data-type="programlisting">composers:x:1010:</pre>

<p>This example creates a new system group:</p>
<pre>$ <strong>sudo addgroup --system service1</strong>
Adding group 'service1' (GID 136) ...
Done.</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161310040">
<h2>Discussion</h2>

<p>The difference between user and system groups is they each have different numbering
ranges for UIDs and GIDs, which are <a data-type="indexterm" data-primary="groups" data-secondary="creating" data-tertiary="with addgroup command" data-startref="group-create-addgroup" id="idm46466161307128"/><a data-type="indexterm" data-primary="addgroup command" data-startref="addgroup-command" id="idm46466161308120"/><a data-type="indexterm" data-primary="system groups" data-secondary="creating" data-tertiary="with addgroup command" data-tertiary-sortas="addgroup command" data-startref="system-group-create-addgroup" id="idm46466161306424"/>configured in <em>/etc/adduser.conf</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161315192">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 addgroup</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.11 Checking Password File Integrity"><div class="sect1" id="idm46466161300824">
<h1>5.11 Checking Password File Integrity</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161299928">
<h2>Problem</h2>

<p>There<a data-type="indexterm" data-primary="users" data-secondary="password files, checking integrity" id="user-password-integrity"/><a data-type="indexterm" data-primary="groups" data-secondary="password files, checking integrity" id="group-password-integrity"/><a data-type="indexterm" data-primary="passwords" data-secondary="checking file integrity" id="password-integrity"/><a data-type="indexterm" data-primary="integrity of password files, checking" id="integrity-password"/><a data-type="indexterm" data-primary="pwck command" id="pwck-command"/><a data-type="indexterm" data-primary="grpck command" id="grpck-command"/> is a lot going on in all these user files and group files, and you want
to know if there is some kind of checker to verify that these files are written
correctly.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161290936">
<h2>Solution</h2>

<p>The <em>pwck</em> command checks the integrity of <em>/etc/passwd</em> and <em>/etc/shadow</em>,
and <em>grpck</em> checks <em>/etc/group</em> and <em>/etc/gshadow</em>. They look for correct
format, valid data, valid names, and valid GIDs (see the man pages for a
complete list). When you run these with no options, they report both warnings and
errors:</p>
<pre>$ <strong>sudo pwck</strong>
user 'news': directory '/var/spool/news' does not exist
user 'uucp': directory '/var/spool/uucp' does not exist
user 'www-data': directory '/var/www' does not exist
user 'list': directory '/var/list' does not exist

$ <strong>sudo grpck</strong>
group mail has an entry in /etc/gshadow, but its password field in /etc/group is
not set to 'x'
grpck: no changes</pre>

<p>Add the <strong><code>-q</code></strong> option to report only errors:</p>
<pre>$ <strong>sudo pwck -q</strong>

$ <strong>sudo grpck -q</strong>
group mail has an entry in /etc/gshadow, but its password field in /etc/group
is not set to 'x'
</pre>

<p>This shows an error in <em>/etc/gshadow</em>. This is not a very helpful message
because it’s not really an error. It is not a common practice to place passwords
on user groups, so reporting this an as error is needlessly confusing. The other
checks are useful, such as the correct number of fields, and a unique valid group
name.</p>

<p>You will never edit <em>/etc/shadow</em> or <em>/etc/gshadow</em>, but only <em>/etc/passwd</em> and
<em>/etc/group</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161280008">
<h2>Discussion</h2>

<p>The following example shows an error that must be corrected. Type <strong><code>n</code></strong>, when
prompted, to prevent deleting the entries. The first “delete line” example is
from <em>/etc/passwd</em>, and the second is in <em>/etc/shadow</em>:</p>
<pre>$ <strong>sudo pwck -q</strong>
invalid password file entry
delete line 'fakeservice:x:996:996::/home/fakeservice'? <strong>n</strong>
delete line 'fakeservice:!:18469::::::'? <strong>n</strong>
pwck: no changes</pre>

<p>Then correct the line in <em>/etc/passwd</em>, and that will fix both error
messages. In the example, <em>fakeservice:x:996:996::/home/fakeservice</em> is missing
the last field, and should be
<em>fakeservice:x:996:996::/home/fakeservice:/bin/false</em>.</p>

<p>The “directory does not exist” warnings for <em>/etc/passwd</em> usually refer to
default system users that are not in use. For example:</p>

<pre data-type="programlisting">user 'www-data': directory '/var/www' does not exist</pre>

<p>The <em>www-data</em> user is unused when you are not running an HTTP server, and there
is no <em>/var/www</em> directory until you install an HTTP server.</p>

<p>The “no changes” message means that no changes were made to the password file.</p>

<p>See the man pages for a complete list of <a data-type="indexterm" data-primary="users" data-secondary="password files, checking integrity" data-startref="user-password-integrity" id="idm46466161266952"/><a data-type="indexterm" data-primary="groups" data-secondary="password files, checking integrity" data-startref="group-password-integrity" id="idm46466161265864"/><a data-type="indexterm" data-primary="passwords" data-secondary="checking file integrity" data-startref="password-integrity" id="idm46466161264776"/><a data-type="indexterm" data-primary="integrity of password files, checking" data-startref="integrity-password" id="idm46466161263592"/><a data-type="indexterm" data-primary="pwck command" data-startref="pwck-command" id="idm46466161262552"/><a data-type="indexterm" data-primary="grpck command" data-startref="grpck-command" id="idm46466161261480"/>checks.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161267912">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 pwck</em></p>
</li>
<li>
<p><em>man 8 grpck</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.12 Disabling a User Account"><div class="sect1" id="idm46466161257176">
<h1>5.12 Disabling a User Account</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161256168">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="users" data-secondary="disabling accounts" id="user-disable"/><a data-type="indexterm" data-primary="disabling" data-secondary="user accounts" id="disable-user-account"/><a data-type="indexterm" data-primary="passwd command" data-secondary="disabling accounts" id="passwd-disable"/> want to disable a user account without deleting it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161250792">
<h2>Solution</h2>

<p>To temporarily deactivate an account, disable the user’s password with the
<em>passwd</em> command:</p>
<pre>$ <strong>sudo passwd -l stash</strong>
passwd: password expiry information changed.</pre>

<p class="pagebreak-before less_space">Now the user cannot log in. The following example unlocks the user’s account:</p>
<pre>$ <strong>sudo passwd -u stash</strong>
passwd: password expiry information changed.</pre>

<p>This does not prevent a user from logging in via a different authentication
method, such as an SSH key. To completely disable a user account, <a data-type="indexterm" data-primary="usermod command" data-secondary="disabling accounts" id="idm46466161246136"/>use <em>usermod</em>:</p>
<pre>$ <strong>sudo usermod --expiredate 1 stash</strong></pre>

<p>When the user tries to log in, they see a “Your account has expired; please contact
your system administrator” message. Restore their account:</p>
<pre>$ <strong>sudo usermod --expiredate -1 stash</strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161241560">
<h2>Discussion</h2>

<p>Another way to disable a user is to replace the x in the password field in
<em>/etc/passwd</em> with an asterisk (*):</p>

<pre data-type="programlisting">stash:*:1009:1009:Stash Cat,,,:/home/stash:/bin/bash</pre>

<p>Reenable Stash by replacing the asterisk <a data-type="indexterm" data-primary="users" data-secondary="disabling accounts" data-startref="user-disable" id="idm46466161237784"/><a data-type="indexterm" data-primary="disabling" data-secondary="user accounts" data-startref="disable-user-account" id="idm46466161236696"/><a data-type="indexterm" data-primary="passwd command" data-secondary="disabling accounts" data-startref="passwd-disable" id="idm46466161235480"/>with <em>x</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161233784">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 1 passwd</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.13 Deleting a User with userdel"><div class="sect1" id="idm46466161231144">
<h1>5.13 Deleting a User with userdel</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161230312">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="users" data-secondary="deleting" data-tertiary="with userdel command" data-tertiary-sortas="userdel command" id="user-delete-userdel"/><a data-type="indexterm" data-primary="deleting" data-secondary="users" data-tertiary="with userdel command" data-tertiary-sortas="userdel command" id="delete-user-userdel"/><a data-type="indexterm" data-primary="userdel command" id="userdel-command"/>need to delete a user, and possibly their home directory and its contents.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161223864">
<h2>Solution</h2>

<p>The following example uses the <em>userdel</em> command to delete the user Stash from
<em>/etc/passwd</em>, Stash’s primary group and all group memberships, and the shadow
files:</p>
<pre>$ <strong>sudo userdel stash</strong></pre>

<p>If Stash belongs to a shared primary user group (discussed in
<a data-type="xref" href="#rec-change-useradd-defaults">Recipe 5.4</a>), the group will not be deleted.</p>

<p>Use the <em>-r</em> option to delete the user’s home directory and its contents, and
their mail spool:</p>
<pre>$ <strong>sudo userdel -r stash</strong></pre>

<p>If the user owns files outside of their home directory, you will have to find and
take care of them separately (see <a data-type="xref" href="#rec-find-user-files">Recipe 5.16</a>).</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161216216">
<h2>Discussion</h2>

<p>Read your <em>/etc/passwd</em> and <em>/etc/group</em> files before and after deleting a user
to see the user disappear.</p>

<p>It is a good practice to clean up after removing a <a data-type="indexterm" data-primary="users" data-secondary="deleting" data-tertiary="with userdel command" data-tertiary-sortas="userdel command" data-startref="user-delete-userdel" id="idm46466161212424"/><a data-type="indexterm" data-primary="deleting" data-secondary="users" data-tertiary="with userdel command" data-tertiary-sortas="userdel command" data-startref="delete-user-userdel" id="idm46466161210856"/><a data-type="indexterm" data-primary="userdel command" data-startref="userdel-command" id="idm46466161209064"/>user.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161213208">
<h2>See Also</h2>

<ul>
<li>
<p><em>man userdel</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.14 Deleting a User with deluser on Ubuntu"><div class="sect1" id="idm46466161205432">
<h1>5.14 Deleting a User with deluser on Ubuntu</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161204456">
<h2>Problem</h2>

<p>You’re <a data-type="indexterm" data-primary="users" data-secondary="deleting" data-tertiary="with deluser command" data-tertiary-sortas="deluser command" id="idm46466161203128"/><a data-type="indexterm" data-primary="deleting" data-secondary="users" data-tertiary="with deluser command" data-tertiary-sortas="deluser command" id="idm46466161201800"/><a data-type="indexterm" data-primary="deluser command" id="idm46466161200472"/>running Ubuntu (or another Debian derivative) and want to use <em>deluser</em>
to delete a user.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161198712">
<h2>Solution</h2>

<p>The following example deletes the user Stash from <em>/etc/passwd</em>, Stash’s
primary group from <em>/etc/group</em>, and their corresponding shadow files:</p>
<pre>$ <strong>sudo deluser stash</strong>
Removing user 'stash' ...
Warning: group 'stash' has no more members.
Done.</pre>

<p><em>deluser</em> will not remove the primary group of an existing user, so if Stash
belongs to a shared primary group it will not be removed.</p>

<p>This example removes Stash’s home directory and makes a backup of all the
deleted files:</p>
<pre>$ <strong>sudo deluser --remove-all-files --backup stash</strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161199480">
<h2>Discussion</h2>

<p><em>--backup</em> creates a compressed archive of the user’s files in the current
directory. Use the <em>--backup-to</em> option to select a different directory:</p>
<pre>$ <strong>sudo deluser --remove-all-files --backup-to /user-backups stash</strong>
</pre>

<p>If the user owns files outside of their home directory, you will have to hunt
them down and deal with them manually (see <a data-type="xref" href="#rec-find-user-files">Recipe 5.16</a>).</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161188216">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 deluser</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.15 Removing a Group with delgroup on Ubuntu"><div class="sect1" id="idm46466161185032">
<h1>5.15 Removing a Group with delgroup on Ubuntu</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161184200">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="groups" data-secondary="deleting" id="idm46466161182648"/><a data-type="indexterm" data-primary="deleting" data-secondary="groups with delgroup command" id="idm46466161181800"/><a data-type="indexterm" data-primary="delgroup command" id="idm46466161180952"/>have an Ubuntu system and want to use the <em>delgroup</em> command to delete
groups.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161180248">
<h2>Solution</h2>

<p>The following example removes the <em>musicians</em> group:</p>
<pre>$ <strong>sudo delgroup musicians</strong></pre>

<p><em>delgroup</em> will not remove the primary group of an existing user. It will
remove supplemental groups even when they have members. If you do not want to
remove groups that have members, use the <em>--only-if-empty</em> option:</p>
<pre>$ <strong>sudo delgroup --only-if-empty musicians</strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161174296">
<h2>Discussion</h2>

<p>The default behavior of <em>delgroup</em> is configured in <em>/etc/deluser.conf</em> and
<em>/etc/adduser.conf</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161171288">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 delgroup</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.16 Finding and Managing All Files for a User"><div class="sect1" id="rec-find-user-files">
<h1>5.16 Finding and Managing All Files for a User</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161167416">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="users" data-secondary="files, finding/managing" id="user-file-find"/><a data-type="indexterm" data-primary="files" data-secondary="user files, finding/managing" id="files-user-find"/><a data-type="indexterm" data-primary="finding" data-secondary="user files" id="find-user-files"/><a data-type="indexterm" data-primary="find command" id="find-command"/>want to delete a user, but you don’t want a bunch of orphaned files
left over, and you need to find all of them.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161160920">
<h2>Solution</h2>

<p>The <em>find</em> command will locate all files on the local system by UID or GID. The
following example searches the entire root directory for all files owned by the
user’s UID:</p>
<pre>$ <strong>sudo find / -uid 1007</strong></pre>

<p>This can take some time if there are lot of files to search. If you are certain
you do not have to search the entire filesystem, you can narrow your search to
specific subdirectories, such as <em>/etc</em>, <em>/home</em>, or <em>/var</em>:</p>
<pre>$ <strong>sudo find /etc -uid 1007</strong>
$ <strong>sudo find /home -uid 1007</strong>
$ <strong>sudo find /var -uid 1007</strong></pre>

<p>You may also search by GID, username, or group name:</p>
<pre>$ <strong>sudo find / -gid 1007</strong>
$ <strong>sudo find / -name duchess</strong>
$ <strong>sudo find / -group duchess</strong></pre>

<p>Now that you know where all the files are, what to do with them? One option is
to change their ownership to another user and let the new user deal with them:</p>
<pre>$ <strong>sudo find /backups -uid 1007 -exec chown -v 1010 {} \;</strong>
changed ownership of '/backups/duchess/' from 1007 to 1010
changed ownership of '/backups/duchess/bin' from 1007 to 1010
changed ownership of '/backups/duchess/logs' from 1007 to 1010</pre>

<p>You could combine <em>find</em> and <em>cp</em> to find <a data-type="indexterm" data-primary="cp command" id="idm46466161148088"/><a data-type="indexterm" data-primary="copying" data-secondary="user files" id="idm46466161147144"/>and copy all the files to a different
directory:</p>
<pre>$ <strong>sudo find / -uid 1007 -exec cp -v {} /orphans \;</strong></pre>

<p>Using <em>cp -v</em> prints progress messages and copies only the files and not their
parent directories. If you wish to copy the parent directories, use the
<em>-r</em> option:</p>
<pre>$ <strong>sudo find / -uid 1007 -exec cp -rv {} /orphans \;</strong></pre>

<p>Copying leaves the original files in place. After they are safely copied, you
may wish to delete the originals. One way to do this is to run <em>find</em> again
and use <em>rm</em> to delete<a data-type="indexterm" data-primary="rm command" id="idm46466161142056"/><a data-type="indexterm" data-primary="deleting" data-secondary="user files" id="idm46466161141256"/> the original files:</p>
<pre>$ <strong>sudo find / -uid 1007 -exec rm -v {} \;</strong></pre>

<p>This deletes the files but not the directories. Use the <em>-r</em> option to delete
the directories if you are certain there are no other files in those directories
that you want to keep:</p>
<pre>$ <strong>sudo find / -uid 1007 -exec rm -rv {} \;</strong></pre>

<p>One more option is to use <em>find</em> and <em>mv</em> to <a data-type="indexterm" data-primary="mv command" id="idm46466161136424"/><a data-type="indexterm" data-primary="moving" data-secondary="user files" id="idm46466161135464"/>move the files to a different
location:</p>
<pre>$ <strong>sudo find / -uid 1007 -exec mv {} /orphans \;</strong></pre>

<p>If you see a “No such file or directory” message, usually that is because the
file or directory was moved, which you can verify by looking in the directory
they were moved to.</p>

<p>Find files owned by a nonexistent user or group:</p>
<pre>$ <strong>find / -nouser</strong>
$ <strong>find / -nogroup</strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161131560">
<h2>Discussion</h2>

<p>Be careful with <em>mv</em> and <em>rm</em> because there is no undo. If you make a mistake,
your best hope of recovery is from backup.</p>

<p>Cleaning up after departed users can be a chore, because computers make it too
easy to create as many files as your storage will hold. If you find yourself
thinking that <em>find</em> is taking too long, keep in mind it will find everything
while you go do something <a data-type="indexterm" data-primary="users" data-secondary="files, finding/managing" data-startref="user-file-find" id="idm46466161127288"/><a data-type="indexterm" data-primary="files" data-secondary="user files, finding/managing" data-startref="files-user-find" id="idm46466161126200"/><a data-type="indexterm" data-primary="finding" data-secondary="user files" data-startref="find-user-files" id="idm46466161124824"/><a data-type="indexterm" data-primary="find command" data-startref="find-command" id="idm46466161123736"/>else.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161128584">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 1 find</em></p>
</li>
<li>
<p><em>man 1 mv</em></p>
</li>
<li>
<p><em>man 1 cp</em></p>
</li>
<li>
<p><em>man 1 rm</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.17 Using su to Be Root"><div class="sect1" id="rec-su">
<h1>5.17 Using su to Be Root</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161116008">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="users" data-secondary="root" data-tertiary="switching to" id="user-root-switch"/><a data-type="indexterm" data-primary="root users" data-secondary="switching to" id="root-user-switch"/><a data-type="indexterm" data-primary="switching to root user" id="switch-root-user"/><a data-type="indexterm" data-primary="su command" id="su-command"/> need to know how to get root permissions to perform some administration
chores.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161109528">
<h2>Solution</h2>

<p>Use the <em>su</em> command to change to the root user when you need
to do system chores:</p>
<pre>duchess@pc:~$ <strong>su -l</strong>
Password:
root@pc:~#</pre>

<p>If you do not know root’s password, or if there is no root password, see
<a data-type="xref" href="#rec-root-password">Recipe 5.21</a> to learn how to use <em>sudo</em> to set a root password.</p>

<p>When you are finished, exit root and return to your own account:</p>
<pre>root@pc:~# <strong>exit</strong>
logout
duchess@pc:~$</pre>

<p>The <em>-l</em> option invokes the root user’s environment, changing to root’s home
directory and loading root’s environment variables. Omit <em>-l</em> to keep your own
environment:</p>
<pre>duchess@pc:~$ <strong>su</strong>
Password:
root@pc:/home/duchess~#</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161101048">
<h2>Discussion</h2>

<p>You can change to any user, as long as you have their password.</p>

<p>Using <em>su</em> to change to root gives you absolute power over your system, and every
command that you run is run as root. Consider using <em>sudo</em> (see <a data-type="xref" href="#rec-sudo">Recipe 5.18</a>),
which provides some safety features, such as protecting root’s password and
leaving an audit <a data-type="indexterm" data-primary="users" data-secondary="root" data-tertiary="switching to" data-startref="user-root-switch" id="idm46466161095144"/><a data-type="indexterm" data-primary="root users" data-secondary="switching to" data-startref="root-user-switch" id="idm46466161094376"/><a data-type="indexterm" data-primary="switching to root user" data-startref="switch-root-user" id="idm46466161093736"/><a data-type="indexterm" data-primary="su command" data-startref="su-command" id="idm46466161093224"/>trail.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161092360">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 1 su</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.18 Granting Limited Root Powers with sudo"><div class="sect1" id="rec-sudo">
<h1>5.18 Granting Limited Root Powers with sudo</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161088120">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="users" data-secondary="root" data-tertiary="limiting powers with sudo" id="user-root-limit"/><a data-type="indexterm" data-primary="root users" data-secondary="limiting powers with sudo" id="root-user-limit"/><a data-type="indexterm" data-primary="sudo command" data-secondary="limiting powers with" id="sudo-command-limit"/> want to delegate some system administration chores to other users, and you
want to limit their root powers to what is needed for their specific tasks.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161082280">
<h2>Solution</h2>

<p>Use the <em>sudo</em> command. <em>sudo</em> is safer than <em>su</em> because it grants limited
root powers to specific users for specific tasks, logs activity, and caches the
user’s password for a limited amount of time, with a default of 15 minutes. After
15 minutes, the user must provide <em>sudo</em> with their password again. The caching
duration is configurable. <em>sudo</em> protects root’s password because <em>sudo</em> users
use their own passwords.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Some Linux distributions, such as openSUSE, default to <em>sudo</em> asking for the root
user’s password. See <a data-type="xref" href="#rec-target-sudo-user">Recipe 5.22</a> to learn how to change this.</p>
</div>

<p><em>/etc/sudoers</em> is the configuration file, and you should edit it with a special
<a data-type="indexterm" data-primary="visudo command" id="idm46466161073080"/>command, <em>visudo</em>. This opens <em>/etc/sudoers</em> with your default text editor,
and you can review and edit the default configuration. Once again, Duchess
demonstrates for us:</p>
<pre>duchess@pc:~$ <strong>sudo visudo</strong>
[sudo] password for duchess:
[...]
##Allow root to run any commands
root    ALL=(ALL) ALL

# Allow members of group sudo to execute any command
%sudo   ALL=(ALL) ALL
[...]</pre>

<p><em>%sudo ALL=(ALL) ALL</em> means that any user you add to<a data-type="indexterm" data-primary="groups" data-secondary="sudo" id="group-sudo"/> the <em>sudo</em> group gets
full <em>sudo</em> powers just like root. The percent sign indicates <em>%sudo</em> is a group
from <em>/etc/group</em>, and not a group configured in <em>/etc/sudoers</em>.</p>

<p>Suppose you have a junior admin, Stash, whose job is installing and
removing software and keeping the system updated. You could create a system
group for Stash. Or you could configure Stash for this task in
<em>/etc/sudoers</em>. The following example gives Stash <em>sudo</em> powers to run the
listed commands. You need the username, the hostname of the local machine, and
a comma-delimited list of allowed commands:</p>
<pre><strong>stash server1 = /bin/rpm, /usr/bin/yum, /usr/bin/dnf</strong></pre>

<p>Suppose you want to give Stash more admin chores, such as managing services.
The allowed commands list will get long, so you could create some command
aliases instead. The<a data-type="indexterm" data-primary="commands, aliasing" id="idm46466161064920"/><a data-type="indexterm" data-primary="aliasing commands" id="idm46466161061640"/> following example aliases the software management commands
to SOFTWARE, and the service management commands to SYSTEMD:</p>
<pre><strong>Cmnd_Alias SOFTWARE = /bin/rpm, /usr/bin/yum, /usr/bin/dnf
Cmnd_Alias SYSTEMD = /usr/bin/systemctl start, /usr/bin/systemctl stop,
/usr/bin/systemctl reload, /usr/bin/systemctl restart, /usr/bin/systemctl
status, /usr/bin/systemctl enable, /usr/bin/systemctl disable,
/usr/bin/systemctl mask, /usr/bin/systemctl unmask</strong></pre>

<p>Now Stash’s configuration looks like this:</p>
<pre><strong>stash server1 = SOFTWARE, SYSTEMD</strong></pre>

<p>You may create user groups in <em>/etc/sudoers</em> (not related to system groups in
<em>/etc/group</em>), then assign them some command aliases:</p>
<pre><strong>User_Alias  JRADMIN = stash, madmax

JRADMIN server1 = SOFTWARE, SYSTEMD</strong></pre>

<p>You may create a <em>Host_Alias</em> to give a user <em>sudo</em> rights on multiple machines:</p>
<pre><strong>Host_Alias SERVERS = server1, server2, server3</strong></pre>

<p>Then bring in the JRADMINs:</p>
<pre><strong>JRADMIN SERVERS = SOFTWARE, SYSTEMD</strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161081704">
<h2>Discussion</h2>

<p>When your limited <em>sudo</em> users try to run a not-allowed command, they see this
message: “Sorry, user <em>duchess</em> is not allowed to execute <code><em>/some/command</em></code> as root on <em>server2</em>.”</p>

<p>Don’t put too much faith in limiting users to a specific set of commands.
Many everyday applications provide a means for privilege escalation via shell
escape, <a data-type="indexterm" data-primary="root privileges" data-secondary="via shell escape" id="idm46466161050920"/><a data-type="indexterm" data-primary="shell escape" id="idm46466161049912"/><a data-type="indexterm" data-primary="privileges" data-secondary="root" data-see="root privileges" id="idm46466161049304"/>and your users can gain full root powers. This example shows how it
works with <em>awk</em>:</p>
<pre>$ <strong>sudo awk 'BEGIN {system("/bin/bash")}'</strong>
root@client4:/home/duchess# </pre>

<p>And just like that, Duchess has full root powers. The humble <em>less</em> command also
provides a shell escape. Read a file with <em>less</em> that is large enough to require
paging:</p>
<pre>$ <strong>sudo less /etc/systctl.conf</strong>
#
# /etc/sysctl.conf - Configuration file for setting system variables
# See /etc/sysctl.d/ for additional system variables.
# See sysctl.conf (5) for information.
/etc/sysctl.conf
</pre>

<p>Type <strong><code>!<em>sh</em></code></strong>, then when the prompt changes, type <strong><code>whoami</code></strong>:</p>
<pre>duchess@client4:~$ <strong>sudo less /etc/systctl.conf</strong>
#
# /etc/sysctl.conf - Configuration file for setting system variables
# See /etc/sysctl.d/ for additional system variables.
# See sysctl.conf (5) for information.
<strong>!'sh'</strong>
duchess@client4:~$ sudo less /etc/sysctl.conf
# <strong>whoami</strong>
root
</pre>

<p>Type <strong><code>exit</code></strong> to return your normal shell.</p>

<p>In my experience, it is extremely difficult to keep track of the many applications
that can provide a shell escape. <em>journalctl</em> records everything, should you
wish to monitor your <em>sudo</em> users (see <a data-type="xref" href="ch20.xhtml#rec-logfiles">Recipe 20.1</a>).</p>

<p>In some Linuxes, <a data-type="indexterm" data-primary="groups" data-secondary="sudo" data-startref="group-sudo" id="idm46466161035848"/>such as Fedora, the <em>wheel</em> group is the default <em>sudo</em> group.
Check your <em>/etc/sudoers</em> file to see how your distribution configures this.
You can also create your own <em>sudo</em> group, and name it whatever you want.</p>

<p>The <em>/etc/sudoers</em> file controls users only on the local machine. Including
other machines, like the SERVERS alias, allows you to share a single
configuration file on multiple machines. <em>sudo</em> ignores any items, such as
hosts or users, that are not present on the local machine.</p>

<p>Let’s dissect <em>root  ALL=(ALL) ALL</em> to understand what all those ALLs
mean.</p>
<dl>
<dt>root</dt>
<dd>
<p>is in the user field, and this field holds any single user,
user alias, or system group.</p>
</dd>
<dt>ALL=</dt>
<dd>
<p>is in the host field. ALL means any host anywhere, or you could
use a host alias, or name a single host.</p>
</dd>
<dt>(ALL)</dt>
<dd>
<p>is in the optional users field. <em>(ALL)</em> means the user or users can run
commands as any other user, or you can specify certain users.</p>
</dd>
<dt>ALL</dt>
<dd>
<p>in is the command field. <em>ALL</em> is unrestricted, or you can specify a list
of allowed <a data-type="indexterm" data-primary="users" data-secondary="root" data-tertiary="limiting powers with sudo" data-startref="user-root-limit" id="idm46466161022232"/><a data-type="indexterm" data-primary="root users" data-secondary="limiting powers with sudo" data-startref="root-user-limit" id="idm46466161020904"/><a data-type="indexterm" data-primary="sudo command" data-secondary="limiting powers with" data-startref="sudo-command-limit" id="idm46466161019816"/>commands.</p>
</dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466161054376">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 sudo</em></p>
</li>
<li>
<p><em>man 5 sudoers</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.19 Extending the sudo Password Timeout"><div class="sect1" id="idm46466161015096">
<h1>5.19 Extending the sudo Password Timeout</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466161014200">
<h2>Problem</h2>

<p>On<a data-type="indexterm" data-primary="sudo command" data-secondary="extending timeout" id="idm46466161012824"/><a data-type="indexterm" data-primary="passwords" data-secondary="extending sudo timeout" id="idm46466161011976"/><a data-type="indexterm" data-primary="extending sudo password timeout" id="idm46466161011128"/><a data-type="indexterm" data-primary="users" data-secondary="root" data-tertiary="changing sudo password timeout" id="idm46466161010520"/><a data-type="indexterm" data-primary="root users" data-secondary="changing sudo password timeout" id="idm46466161009336"/><a data-type="indexterm" data-primary="changing" data-secondary="sudo password timeout" id="idm46466161008328"/> most Linux distributions, <em>sudo</em> caches passwords for a default interval of
15 minutes. Then after 15 minutes you have to enter your password again. You are
tired of having to enter your password so often when you have a lot of work to do,
and want to make the caching interval longer.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466161006520">
<h2>Solution</h2>

<p>Change the caching interval in <em>/etc/sudoers</em>. Open the file for editing with
<em>visudo</em>:</p>
<pre>$ <strong>sudo visudo</strong></pre>

<p>Then look for a <em>Defaults</em> line and set your new cache interval. The following
example sets it to 60 minutes:</p>
<pre>$ <strong>Defaults timestamp_timeout=60</strong></pre>

<p>If you set it to 0, <em>sudo</em> asks for your password every time you use it.</p>

<p>If you set <em>timestamp_timeout</em> to a negative number, like <em>-1</em>, your password never
expires.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466161005480">
<h2>Discussion</h2>

<p>The <em>sudo</em> password caching is a useful protection against accidents, such as
forgetting you are running as root or wandering away and allowing someone else to have some fun with your computer.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466160996776">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 sudo</em></p>
</li>
<li>
<p><em>man 5 sudoers</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.20 Creating Individual sudoers Configurations"><div class="sect1" id="idm46466160992440">
<h1>5.20 Creating Individual sudoers Configurations</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466160991576">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="sudo command" data-secondary="individual configurations" id="idm46466160990136"/><a data-type="indexterm" data-primary="users" data-secondary="root" data-tertiary="individual sudo configurations" id="idm46466160989400"/><a data-type="indexterm" data-primary="root users" data-secondary="individual sudo configurations" id="idm46466160988312"/>want to set some different <em>sudo</em> configurations for your users; for
example, you want your junior admins to have a different password timeout than
you. Yours is long, and you want theirs to be short.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466160987208">
<h2>Solution</h2>

<p>You may create individual configurations in <em>/etc/sudoers.d</em>. The following
example creates a 30-minute password timeout for Stash:</p>
<pre>$ <strong>cd /etc/sudoers.d/</strong>
$ <strong>sudo visudo -f stash</strong></pre>

<p>Type <strong><code>Defaults timestamp_timeout=30</code></strong>, save the file, and you’re done. You can
see the new file:</p>
<pre>$ <strong>sudo ls /etc/sudoers.d/</strong>
README stash</pre>

<p>You only need to enter configuration items that are different from the entries
in <em>/etc/sudoers</em>, not to replicate the whole file.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466160986952">
<h2>Discussion</h2>

<p>This is a nice feature for managing multiple users. Instead of managing one big
configuration file, break it up into smaller per-user files.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466160978280">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 sudo</em></p>
</li>
<li>
<p><em>man 5 sudoers</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.21 Managing the Root User’s Password"><div class="sect1" id="rec-root-password">
<h1>5.21 Managing the Root User’s Password</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466160972888">
<h2>Problem</h2>

<p>Your<a data-type="indexterm" data-primary="users" data-secondary="root" data-tertiary="password management" id="idm46466160971320"/><a data-type="indexterm" data-primary="root password" data-secondary="managing" id="idm46466160970232"/><a data-type="indexterm" data-primary="passwords" data-secondary="root" data-tertiary="managing" id="idm46466160969384"/><a data-type="indexterm" data-primary="sudo command" data-secondary="root password management" id="idm46466160968200"/> Linux distribution set you up as system administrator during installation,
with unrestricted <em>sudo</em> privileges, and did not create a root password. Or,
your root user had a password but you forgot it. You need to know how to give
root a new password.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466160966776">
<h2>Solution</h2>

<p>When you want to run as “real” root, use <em>sudo</em> to <em>su</em> to root:</p>
<pre>duchess@pc:~$ <strong>sudo su -l</strong>
[sudo] password for duchess:
root@pc:~#</pre>

<p>At this point you can use the <em>passwd</em> command to give root a password so you can
log in as root directly, or reset a lost root password.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466160961464">
<h2>Discussion</h2>

<p>There are times when you need a root password and not <em>sudo</em>; for example, when
you boot to an emergency runlevel.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466160959816">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 sudo</em></p>
</li>
<li>
<p><em>man 5 sudoers</em></p>
</li>
<li>
<p><em>man 1 passwd</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="5.22 Changing sudo to Not Ask for the Root Password"><div class="sect1" id="rec-target-sudo-user">
<h1>5.22 Changing sudo to Not Ask for the Root Password</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466160952920">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="sudo command" data-secondary="authentication on individual passwords" id="sudo-authenticate"/><a data-type="indexterm" data-primary="authentication" data-secondary="of sudo command" data-secondary-sortas="sudo command" id="authenticate-sudo"/><a data-type="indexterm" data-primary="passwords" data-secondary="for sudo command" data-secondary-sortas="sudo command" id="password-sudo"/><a data-type="indexterm" data-primary="users" data-secondary="root" data-tertiary="changing sudo authentication" id="user-root-authenticate"/><a data-type="indexterm" data-primary="root users" data-secondary="changing sudo authentication" id="root-user-authenticate"/>want your <em>sudo</em> users to authenticate with their own passwords, but your
Linux system asks for the root user’s password, like the following example:</p>
<pre>$ <strong>sudo visudo</strong>
[sudo] password for root:</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466160942568">
<h2>Solution</h2>

<p>This is the default behavior on some Linux distributions, such as openSUSE.</p>

<p>When you install Ubuntu Linux and make your user an administrator during
installation, Ubuntu configures your user appropriately with full <em>sudo</em> powers,
equivalent to root but using your own password. openSUSE does not, but instead
configures your user to use the password of the target user, which is root.</p>

<p>To set up <em>sudo</em> users to always be asked for their own passwords, edit
<em>/etc/sudoers</em> by commenting out these two lines:</p>
<pre>duchess@pc:~$ <strong>sudo visudo</strong>

<strong># Defaults targetpw
# ALL   ALL=(ALL) ALL </strong></pre>

<p>In<a data-type="indexterm" data-primary="openSUSE" data-secondary="sudo authentication" id="idm46466160936808"/><a data-type="indexterm" data-primary="Fedora Linux" data-secondary="sudo authentication" id="idm46466160935496"/> openSUSE and Fedora, create <em>sudo</em> users with full root powers by adding them
to the <em>wheel</em> group in <em>/etc/group</em>. (For limited users, refer to <a data-type="xref" href="#rec-sudo">Recipe 5.18</a>.)</p>

<p>The change takes effect immediately after saving your changes and closing the
file.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466160931944">
<h2>Discussion</h2>

<p>Protecting the root user’s password is a primary reason to use <em>sudo</em>, <a data-type="indexterm" data-primary="sudo command" data-secondary="authentication on individual passwords" data-startref="sudo-authenticate" id="idm46466160929928"/><a data-type="indexterm" data-primary="authentication" data-secondary="of sudo command" data-secondary-sortas="sudo command" data-startref="authenticate-sudo" id="idm46466160928680"/><a data-type="indexterm" data-primary="passwords" data-secondary="for sudo command" data-secondary-sortas="sudo command" data-startref="password-sudo" id="idm46466160927352"/><a data-type="indexterm" data-primary="users" data-secondary="root" data-tertiary="changing sudo authentication" data-startref="user-root-authenticate" id="idm46466160926024"/><a data-type="indexterm" data-primary="root users" data-secondary="changing sudo authentication" data-startref="root-user-authenticate" id="idm46466160924440"/>rather
than <em>su</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466160923128">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="#rec-sudo">Recipe 5.18</a></p>
</li>
</ul>
</div></section>





</div></section>







</div></section></div></body></html>