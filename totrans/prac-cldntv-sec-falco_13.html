<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. Configuring and Running Falco"><div class="chapter" id="configuring_and_running">
<h1><span class="label">Chapter 10. </span>Configuring and Running Falco</h1>
<p>In the previous chapter, you learned how to install Falco in production environments. However, you still need to know how its configuration system works. Learning to change its settings is fundamental to managing them over time and accommodating your needs. You can configure Falco during or immediately after installation, when updating to a newer version, or any time your needs change.</p>
<p>This chapter will help you understand and use the available settings. First, we’ll explain the main areas of intervention: command-line options, environment variables, the configuration file, and rules files. Then we will go deeper into each of them. You will also find valuable suggestions for production use cases, along with some tips to fine-tune your Falco configuration. At the end of the chapter you’ll find a dedicated section on configuring plugins, and we’ll show you how to update the configuration of a running Falco instance.</p>
<section data-type="sect1" data-pdf-bookmark="Configuring Falco"><div class="sect1" id="configuring_falco">
<h1>Configuring Falco</h1>
<p><a contenteditable="false" data-primary="configuring Falco" data-secondary="settings for" data-type="indexterm" id="idm45324224472944"/>You can configure Falco through its settings, which we have grouped into three categories:</p>
<dl>
<dt>Command-line options and environment variables</dt>
<dd><p>Command-line options and environment variables are the first settings you need to run Falco. Most of these settings allow Falco to talk with your system, which is particularly important for system instrumentation and data enrichment. Other settings here let you adapt Falco to specific needs or help with troubleshooting.</p></dd>
<dt>Configuration file</dt>
<dd><p>You can configure almost any Falco behavior from within the main configuration file, which you can customize according to your needs. For instance, you can load rules files, activate the output channels you want, and use plugins if you need to. By default Falco looks for this file at <em>/etc/falco/falco.yaml</em>, but you can specify a different path using a command-line option.</p></dd>
<dt>Ruleset</dt>
<dd><p>Falco comes with a rich default ruleset so that you can start to use it immediately. However, the ruleset is perhaps the most critical aspect to customize. It represents the configuration of the Falco engine and sets what Falco will detect. By convention, rules files live in <em>/etc/falco</em>.</p></dd>
</dl>
<p>Before we address each category in detail, we want to show you how Falco changes depending on how you install it.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Differences Among Installation Methods"><div class="sect1" id="differences_among_installation_methods">
<h1>Differences Among Installation Methods</h1>
<p><a contenteditable="false" data-primary="configuring Falco" data-secondary="differences among installation methods" data-type="indexterm" id="idm45324224464016"/>Regardless of the installation method you choose, Falco’s configuration areas will always be the same. However, the ways you can change the settings may be slightly different.</p>
<section data-type="sect2" data-pdf-bookmark="Host Installation"><div class="sect2" id="host_installatio">
<h2>Host Installation</h2>
<p><a contenteditable="false" data-primary="configuring Falco" data-secondary="host installation" data-type="indexterm" id="idm45324224460528"/>If you installed Falco using a package manager, you can specify the command-line options and environment variables directly in the systemd unit file, which you can find at <em>/usr/lib/systemd/user/falco.service</em>. Using <code>systemctl edit falco</code> is a convenient way to do that. When you’re finished, remember to restart the service with <code>systemctl restart falco</code>.</p>
<p>If you are not using a package manager, running Falco is entirely up to you, including passing command-line options and setting the environment variables. In such a case, you can manually create a systemd unit. You can use the <a href="https://oreil.ly/0LcF3"><em>falco-service</em> file’s source code</a> as an example.</p>
<p>Regardless of the package you use, you’ll find Falco’s configuration and rules files under <em>/etc/falco.</em> You can edit those files directly and then restart Falco.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Containers"><div class="sect2" id="containers-id000016">
<h2>Containers</h2>
<p><a contenteditable="false" data-primary="configuring Falco" data-secondary="containers" data-type="indexterm" id="idm45324224452976"/><a contenteditable="false" data-primary="containers" data-secondary="configuring Falco" data-type="indexterm" id="idm45324224451600"/>Falco’s container images allow you to specify the command to run, which by default is <code>/usr/bin/falco</code>. If you need to pass command-line options, do so through the CLI of your container runtime. For example, with Docker, to pass <code>--version</code>, you would use:</p>
<pre data-type="programlisting">$ <strong>docker run --rm -it falcosecurity/falco /usr/bin/falco --version</strong></pre>
<p class="widows_3">Note that the <em>falcosecurity/falco</em> container image’s entry point is a script that tries to install the driver automatically. If you want to skip the installation, you need to set the <code>SKIP_DRIVER_LOADER</code> environment variable to any nonempty value. In Docker, you can use the <code>-e</code> option to set an environment variable.<sup><a data-type="noteref" id="ch01fn11-marker" href="ch10.xhtml#ch01fn11">1</a></sup> So, for example, to get the version and skip the driver installation at the same time, you would run:</p>
<pre data-type="programlisting">$ <strong>docker run --rm -it -e SKIP_DRIVER_LOADER=y \</strong>
<strong>    falcosecurity/falco /usr/bin/falco --version</strong></pre>
<p>Falco container images also bundle both the default configuration file and the default rules files. If you need to modify any of these, the usual approach is to make an external copy of the file (for example, <em>/etc/falco/falco.yaml</em>) and then mount it into the container. You can grab the configuration and rules files from the binary package (make sure it matches the version of Falco running in the container) and modify them according to your needs. Then, in Docker, use the <code>-v</code> option to mount the modified files into the container.<sup><a data-type="noteref" id="ch01fn12-marker" href="ch10.xhtml#ch01fn12">2</a></sup></p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Kubernetes Deployments"><div class="sect2" id="kubernetes_deployments">
<h2>Kubernetes Deployments</h2>
<p><a contenteditable="false" data-primary="configuring Falco" data-secondary="Kubernetes deployments" data-type="indexterm" id="idm45324224437552"/>When you deploy Falco in Kubernetes, you’ll also specify command-line options and environment variables in the DaemonSet or the Deployment manifest. If you use Helm or the example manifests from <a data-type="xref" href="ch09.xhtml#installing_falco">Chapter 9</a>, the deployment will already be configured with all the options to connect to your container runtime and the Kubernetes API server. If you need to modify an option, find the corresponding <a href="https://oreil.ly/9CsSk">Falco chart configuration</a> or modify the <a href="https://oreil.ly/L6rs9">manifest</a> directly.</p>
<p>Another important difference is that configuration and rules files live inside a ConfigMap whose contents shadow those shipped within the container image. For Helm users, the maintainers update Falco’s chart and configuration and rules files in sync with the Falco distribution. On the other hand, if you are using manifest files, it’s completely up to you to ensure the ConfigMap embeds the right files.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Command-Line Options and Environment Variables"><div class="sect1" id="command_line_options_and_environment_va">
<h1>Command-Line Options and Environment Variables</h1>
<p><a contenteditable="false" data-primary="command-line options" data-secondary="configuring Falco with" data-type="indexterm" id="ch10.html0"/><a contenteditable="false" data-primary="configuring Falco" data-secondary="command-line options and environment variables" data-type="indexterm" id="ch10.html1"/><a contenteditable="false" data-primary="environment variables" data-type="indexterm" id="ch10.html2"/>When running Falco, specifying a command-line option or setting an environment variable is sometimes the only way to change some of the settings. Settings you configure via the command line always take precedence over settings loaded from the configuration file.</p>
<p class="pagebreak-before">You can get the full list of Falco’s command-line options by running <code>falco --help</code>. Falco will print each option (along with a brief description) in alphabetical order. The available options may change depending on the Falco version. Always refer to <code>falco --help</code> when in doubt.</p>
<p>In the rest of this section, to help familiarize you with the most important settings, we group them by function. We also provide detailed information about using environment variables, which you will not find in <code>falco --help</code>.</p>
<section data-type="sect2" data-pdf-bookmark="Configuration Settings"><div class="sect2" id="configuration_settings">
<h2>Configuration Settings</h2>
<p><a contenteditable="false" data-primary="command-line options" data-secondary="configuration settings" data-type="indexterm" id="idm45324224421136"/>The two command-line options shown in <a data-type="xref" href="#configuration_command_line_options">Table 10-1</a> pertain to Falco’s configuration file (located by default at <em>/etc/falco/falco.yaml</em>). The first one allows you to load a configuration file from a different location; the second allows you to override some configuration values on the fly. You won’t usually need to use them, but they can be handy when troubleshooting. Also, when running Falco in production, ensure nobody sets them by mistake so that Falco uses the correct configuration file and the intended settings.</p>
<table class="border" id="configuration_command_line_options">
<caption><span class="label">Table 10-1. </span>Configuration command-line options</caption>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-c</code></td>
<td>Sets the path to the configuration file Falco will load. If this is not set, Falco uses the default path: <em>/etc/falco/falco.yaml</em>.</td>
</tr>
<tr>
<td><code>-o</code>, <code>--option <em>&lt;key&gt;</em>=<em>&lt;val&gt;</em></code></td>
<td>Overrides a value in the configuration file by setting the value <code><em>&lt;val&gt;</em></code> to the configuration option specified by <code><em>&lt;key&gt;</em></code>. You can use dot notation (<code>.</code>) to specify nested options or square brackets notation (<code>[]</code>) to access lists: for example, <code>-o key.subkey.list[0]=myValue</code>.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Instrumentation Settings (Syscalls Only)"><div class="sect2" id="instrumentation_settings_left_parenthes">
<h2>Instrumentation Settings (Syscalls Only)</h2>
<p><a contenteditable="false" data-primary="command-line options" data-secondary="syscall instrumentation settings" data-type="indexterm" id="ch10.html3"/><a contenteditable="false" data-primary="configuring Falco" data-secondary="instrumentation settings" data-type="indexterm" id="ch10.html4"/><a contenteditable="false" data-primary="instrumentation settings" data-type="indexterm" id="ch10.html5"/><a contenteditable="false" data-primary="system calls" data-secondary="instrumentation settings" data-type="indexterm" id="ch10.html6"/>As you learned in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch04.xhtml#data_source">4</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.xhtml#installing_falco">9</a>, Falco uses the kernel module driver by default. You can switch to the eBPF probe by setting the <code>FALCO_BPF_PROBE</code> environment variable. You can set it to the path of the probe you want to use: for example, <code>FALCO_BPF_PROBE="/path/to/falco-bpf.o"</code>. Otherwise, you can set it to an empty string (<code>FALCO_BPF_PROBE=""</code>) and Falco will use <em>~/.falco/falco-bpf.o</em> by default.</p>
<p>When you run Falco in a container or Kubernetes, the container image supports <code>FALCO_BPF_PROBE</code> to control the on-the-fly driver installation, along with other environment variables. (The <em>falco-driver-loader</em> script exposes most of them, so you can also use <code>falco-driver-loader --help</code> to get more information.) Let’s look at those environment variables now:</p>
<dl class="pagebreak-before less_space">
<dt><code>DRIVERS_REPO</code></dt>
<dd><p>If you create a repository of prebuilt drivers (either kernel modules or eBPF probes), you can use this option to instruct the script to download a driver from your repository. A driver repository hosts files with the following URL structure:</p>
<p class="indent"><em>&lt;DRIVERS_REPO&gt;/&lt;DRIVER_VERSION&gt;/falco_&lt;OS_ID&gt;​_&lt;KER⁠NEL_RELEASE&gt;_&lt;KERNEL_VERSION&gt;.[ko|o]</em></p>
<p>This variable allows you to set the base URL of your repository (with no trailing slash). You may want to use this setting if you are running Falco in an air-gapped environment or if you don’t want to download prebuilt drivers from the internet. If not set, this variable defaults to The Falco Project’s <a href="https://oreil.ly/vsE8X">public driver repository</a>.</p></dd>
<dt><code>DRIVER_INSECURE_DOWNLOAD</code></dt>
<dd><p>If your driver repository does not support HTTPS, set it to any value (for example, <code>yes</code>) to allow the script to download files from insecure URLs.</p></dd>
<dt><code>SKIP_DRIVER_LOADER</code></dt>
<dd><p>If you installed the driver on the host by other means, you’ll likely want to disable the <em>falco-driver-loader</em> script when the container starts. In that case, set this environment variable to any value (for example, <code>yes</code>). This setting only affects Falco container images that use <em>falco-driver-loader</em> in the entry point, like the <em>falcosecurity/falco</em> container image.</p></dd>
<dt><code>HOST_ROOT</code></dt>
<dd><p>This environment variable differs from the others listed here in that it’s not related to the driver installation and directly affects Falco. <code>HOST_ROOT</code> expects a base path and affects the instrumentation setup and enrichment system. If the value is not empty, Falco uses it as a path prefix when it accesses the host’s filesystem to use the kernel module devices (under <em>/dev</em>) or to fetch information for data enrichment (in particular from <em>/proc</em> and the container runtime Unix socket path). The <em>falco-driver-loader</em> script uses this variable for similar purposes (for example, to access <em>/boot</em>, <em>/lib</em>, <em>/usr</em>, and <em>/etc</em>).</p>
<p>Use <code>HOST_ROOT</code> when running Falco in a container. The usual convention is to set <code>HOST_ROOT=/host</code> and mount all the relevant paths into the container under the <em>/host</em> directory. Kubernetes deployment uses this approach; see Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch05.xhtml#data_enrichment">5</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.xhtml#installing_falco">9</a> for more details.</p></dd>
</dl>
<p class="pagebreak-before">For completeness, other settings related to syscall instrumentation are listed in <a data-type="xref" href="#syscall_instrumentation_command_line_op">Table 10-2</a>. These settings have a significant performance impact, so don’t use them unless you need to.<a contenteditable="false" data-primary="" data-startref="ch10.html6" data-type="indexterm" id="idm45324224370480"/><a contenteditable="false" data-primary="" data-startref="ch10.html5" data-type="indexterm" id="idm45324224369136"/><a contenteditable="false" data-primary="" data-startref="ch10.html4" data-type="indexterm" id="idm45324224367760"/><a contenteditable="false" data-primary="" data-startref="ch10.html3" data-type="indexterm" id="idm45324224366384"/></p>
<table class="border" id="syscall_instrumentation_command_line_op">
<caption><span class="label">Table 10-2. </span>Syscall instrumentation command-line options</caption>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-A</code></td>
<td>Falco does not monitor all syscalls by default, so you usually cannot use all event types in rule conditions (the driver skips most syscalls that are noisy or expensive to process, such as <code>read</code>, <code>write</code>, <code>send</code>, and <code>recv</code>). If you enable this setting, the driver will send all supported syscall events to Falco, which may be helpful in edge use cases. However, enabling this setting has a severe performance penalty. Falco may not be able to catch up with the event stream.<br/>The full list of supported syscalls is available in <a href="https://oreil.ly/WVDRm"><em>syscall_info_table.c</em></a>. By default, the driver skips those marked with <code>E<span class="keep-together">F_DROP_SIMPLE_CONS</span></code>.</td>
</tr>
<tr>
<td><code>-u</code>, <code><span class="keep-together">--userspace</span></code></td>
<td>Use this option only when you can’t use the kernel space instrumentation. This option must be used with a user-space driver like pdig (discussed in <a data-type="xref" href="ch04.xhtml#data_source">Chapter 4</a>).</td>
</tr>
</tbody>
</table>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Data Enrichment Settings (Syscalls Only)"><div class="sect2" id="data_enrichment_settings_left_parenthes">
<h2>Data Enrichment Settings (Syscalls Only)</h2>
<p><a contenteditable="false" data-primary="command-line options" data-secondary="data enrichment settings" data-type="indexterm" id="idm45324224350128"/><a contenteditable="false" data-primary="configuring Falco" data-secondary="data enrichment settings" data-type="indexterm" id="idm45324224348784"/><a contenteditable="false" data-primary="data enrichment" data-secondary="command-line options" data-type="indexterm" id="idm45324224347440"/><a contenteditable="false" data-primary="system calls" data-secondary="data enrichment settings" data-type="indexterm" id="idm45324224346064"/>When using syscalls as a data source, Falco needs to connect to a driver. It also needs to fetch information from the host, the container runtime, and Kubernetes. In <a data-type="xref" href="ch05.xhtml#data_enrichment">Chapter 5</a>, we talked briefly about the settings described in this section; <a data-type="xref" href="#data_enrichment_command_line_options">Table 10-3</a> provides detailed usage descriptions of command-line options and environment variables that affect the data enrichment mechanism.</p>
<table class="border" id="data_enrichment_command_line_options">
<caption><span class="label">Table 10-3. </span>Data enrichment command-line options</caption>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--cri <em>&lt;path&gt;</em></code></td>
<td>Use this option to specify the path to the Unix socket of a CRI-compatible container runtime. If the Unix socket is valid, Falco will connect to the runtime to fetch the container metadata.<br/>In recent versions of Falco, you can specify this option multiple times. Falco will try each given path in order and use the first one that connects. When this option is not set, Falco will only try to use <em>/run/containerd/containerd.sock</em>.</td>
</tr>
<tr>
<td><code>--disable-cri-async</code></td>
<td>This option disables asynchronous CRI metadata fetching. You won’t usually need to set it. However, if Falco shows container metadata intermittently, this option can help you fix the issue.</td>
</tr>
<tr>
<td><code>-k <em>&lt;url&gt;</em></code>, <code>--k8s-api <em>&lt;url&gt;</em></code></td>
<td>This enables Kubernetes metadata enrichment by connecting to the Kubernetes API server specified by <code><em>&lt;url&gt;</em></code>.<br/>Alternatively, you can use the <code>FALCO_K8S_API</code> environment variable, which accepts the same values allowed by this option.</td>
</tr>
<tr>
<td><code>-K <em>&lt;bt_file&gt;</em> | <em>&lt;cert_file&gt;</em>:<em>&lt;key_file[#pwd]&gt;<br/></em> [:<em>&lt;ca_cert_file&gt;</em>]</code>,<br/> <code>--k8s-api-cert <em>&lt;bt_file&gt;</em> | <em>&lt;cert_file&gt;</em></code>:<code><em>&lt;key_file[#pwd]&gt;<br/></em> [:<em>&lt;ca_cert_file&gt;</em>]</code></td>
<td>Use this option to authenticate with the Kubernetes API server. You can provide either a bearer token file<sup><a data-type="noteref" id="ch01fn13-marker" href="ch10.xhtml#ch01fn13">a</a></sup> (<code><em>&lt;bt_file&gt;</em></code>) or a certificate and a private key (<code><em>&lt;cert_file&gt;</em></code>:<code><em>&lt;key_file&gt;</em></code>). If you use the latter, you can optionally use a passphrase (<code><em>#pwd</em></code>) to access the private key, if encrypted, and a CA certificate (<code>:<em>&lt;ca_cert_file&gt;</em></code>) to verify the API server’s identity. Certificates and private keys must be provided in the PEM file format.<br/>As an alternative, you can use the <code>FALCO_K8S_API_CERT</code> environment variable, which accepts the same values allowed by this option.</td>
</tr>
<tr>
<td><code>--k8s-node <em>&lt;node_name&gt;</em></code></td>
<td>This option enables an important performance optimization for Kubernetes metadata enrichment: Falco will use the node name as a filter when requesting metadata of Pods from the API server, discarding unnecessary metadata coming from other nodes. You should always set this option. If you don’t, Falco will work, but may have performance issues on large clusters.</td>
</tr>
</tbody>
<tbody><tr class="footnotes"><td colspan="2"><p data-type="footnote" id="ch01fn13"><sup><a href="ch10.xhtml#ch01fn13-marker">a</a></sup> A bearer token file contains a string that authenticates the API request, one of the available <a href="https://oreil.ly/nh9Qk">authentication strategies</a> for Kubernetes.</p></td></tr></tbody></table>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Ruleset Settings"><div class="sect2" id="ruleset_settings">
<h2>Ruleset Settings</h2>
<p><a contenteditable="false" data-primary="command-line options" data-secondary="ruleset settings" data-type="indexterm" id="idm45324224314256"/><a contenteditable="false" data-primary="configuring Falco" data-secondary="ruleset settings" data-type="indexterm" id="idm45324224312880"/><a contenteditable="false" data-primary="rulesets" data-secondary="command-line-options" data-type="indexterm" id="idm45324224311504"/><a data-type="xref" href="#ruleset_command_line_options">Table 10-4</a> shows the command-line options that can affect the ruleset. Falco will only use the configuration file to load rules if you don’t use any of these options.</p>
<table class="border" id="ruleset_command_line_options">
<caption><span class="label">Table 10-4. </span>Ruleset command-line options</caption>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-D <em>&lt;substring&gt;</em></code></td>
<td>This option allows you to disable one or more rules that match <code><em>&lt;substring&gt;</em></code> in their names. You can specify it multiple times, but it is incompatible with the <code>-t</code> option (see below).</td>
</tr>
<tr>
<td><span class="keep-together"><code>-r <em>&lt;rules_file&gt;</em></code></span></td>
<td>This option allows you to specify a file or a directory that Falco will use to load rules. In the case of a directory, Falco loads all the files it contains. You can specify <code>-r</code> multiple times to load multiple files or directories.<br/>If you use this option, Falco will ignore any rules files and directories specified in the configuration file (<em>/etc/falco/falco.yaml</em>). Thus, we do not recommend using it in production, except for debugging or in special cases.</td>
</tr>
<tr>
<td><code>-T <em>&lt;tag&gt;</em></code></td>
<td>This option disables any rules with the given <code><em>&lt;tag&gt;</em></code>.You can specify it multiple times, but it is incompatible with the <code>-t</code> option (see below).</td>
</tr>
<tr>
<td><code>-t <em>&lt;tag&gt;</em></code></td>
<td>This option enables only rules with the given <code><em>&lt;tag&gt;</em></code> and disables all others. You can specify it multiple times, but it is incompatible with the <code>-T</code> and <code>-D</code> options.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Output Settings"><div class="sect2" id="output_settings">
<h2>Output Settings</h2>
<p><a contenteditable="false" data-primary="command-line options" data-secondary="output settings" data-type="indexterm" id="idm45324224290752"/><a contenteditable="false" data-primary="configuring Falco" data-secondary="output settings" data-type="indexterm" id="idm45324224289376"/><a contenteditable="false" data-primary="outputs" data-secondary="command-line options" data-type="indexterm" id="idm45324224288000"/>We described most of the output formatting options (along with Falco output channel configuration) in <a data-type="xref" href="ch08.xhtml#the_output_framework">Chapter 8</a>. However, two other command-line options (listed in <a data-type="xref" href="#output_command_line_options">Table 10-5</a>) allow you to further customize Falco’s output behavior.</p>
<table class="border" id="output_command_line_options">
<caption><span class="label">Table 10-5. </span>Output command-line options</caption>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code><span class="keep-together">-p<em>&lt;output_format&gt;</em></span></code>, <br/><code><span class="keep-together">--print<em>&lt;output_format&gt;</em></span></code></td>
<td>
<p>When enabled, this option appends additional information to the Falco notification’s output. A few flavors are available; for instance:</p>
<ul>
<li><p><code>-pc</code> or <code>-pcontainer</code> will add container information, such as the name and ID.</p></li>
<li><p><code>-pk</code> or <code>-pkubernetes</code> will add Kubernetes information, such as the namespace and Pod name.</p></li>
</ul>
<p>We recommend using <code>-pk</code> when using Falco in a Kubernetes context.</p>
</td>
</tr>
<tr>
<td><code>-U</code>, <code><span class="keep-together">--unbuffered</span></code></td>
<td>This option disables full output buffering in the output channels (see <a data-type="xref" href="ch08.xhtml#the_output_framework">Chapter 8</a>). Use it only if you encounter issues when piping the Falco output into another process or script. Turning off output buffering may increase CPU usage.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Other Settings for Debugging and Troubleshooting"><div class="sect2" id="other_settings_for_debugging_and_troubl">
<h2>Other Settings for Debugging and Troubleshooting</h2>
<p><a contenteditable="false" data-primary="command-line options" data-secondary="debugging/troubleshooting settings" data-type="indexterm" id="idm45324224267280"/><a contenteditable="false" data-primary="configuring Falco" data-secondary="debugging/troubleshooting settings" data-type="indexterm" id="idm45324224265888"/><a contenteditable="false" data-primary="debugging, command-line options for" data-type="indexterm" id="idm45324224264496"/><a contenteditable="false" data-primary="troubleshooting, command-line options for" data-type="indexterm" id="idm45324224263376"/>The command-line options we have described so far are the ones you’re likely to use routinely while operating Falco. However, there’s another group of options (listed in <a data-type="xref" href="#command_line_options_for_debugging_and">Table 10-6</a>) for more occasional use, such as when you need information about your Falco installation or are trying to solve a problem.<a contenteditable="false" data-primary="" data-startref="ch10.html2" data-type="indexterm" id="idm45324224260736"/><a contenteditable="false" data-primary="" data-startref="ch10.html1" data-type="indexterm" id="idm45324224259392"/><a contenteditable="false" data-primary="" data-startref="ch10.html0" data-type="indexterm" id="idm45324224258016"/></p>
<table class="border" id="command_line_options_for_debugging_and">
<caption><span class="label">Table 10-6. </span>Command-line options for debugging and troubleshooting</caption>
<thead>
<tr>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-e <em>&lt;events_file&gt;</em></code></td>
<td>Tells Falco to use the trace file (see <a data-type="xref" href="ch03.xhtml#understanding_falcoapostr">Chapter 3</a>) specified by <code><em>&lt;events_file&gt;</em></code> as a data source instead of using a live event source. Once Falco consumes all the events in the file, it exits. Useful for testing and rule authoring.</td>
</tr>
<tr>
<td><code>-L</code></td>
<td>Prints information about all loaded rules.</td>
</tr>
<tr>
<td><code>-l <em>&lt;rule&gt;</em></code></td>
<td>Prints the name and description of the rule with name <code><em>&lt;rule&gt;</em></code>, if loaded.</td>
</tr>
<tr>
<td><code>--list[=<em>&lt;source&gt;</em>]</code></td>
<td>Lists all available condition fields, grouped by class (see <a data-type="xref" href="ch06.xhtml#fields_and_filters">Chapter 6</a>). If you also provide <code><em>&lt;source&gt;</em></code>, Falco will only list fields for that data source. The value of <code><em>&lt;source&gt;</em></code> can be <code>syscall</code> or any other data source provided by configured plugins.</td>
</tr>
<tr>
<td><code>--list-plugins</code></td>
<td>Prints information about configured plugins.</td>
</tr>
<tr>
<td><code>-s <em>&lt;stats_file&gt;</em></code></td>
<td>Tells Falco to create the file <code><em>&lt;stats_file&gt;</em></code> and populate it with statistics while running.</td>
</tr>
<tr>
<td><code>--stats-interval <em>&lt;msec&gt;</em></code></td>
<td>Sets the refresh interval (in milliseconds) for updating the file created by <code><span class="keep-together">-s <em>&lt;stats_file&gt;</em></span></code>.</td>
</tr>
<tr>
<td><code>--support</code></td>
<td>Prints details about the loaded Falco configuration and ruleset, and other useful information for troubleshooting that you can provide when asking for help (for example, when <a href="https://oreil.ly/vkk2h">opening an issue</a> in the Falco GitHub repository).</td>
</tr>
<tr>
<td><code>-V</code>, <code>--validate <em>&lt;rules_file&gt;</em></code></td>
<td>Validates the content of the given <code><em>&lt;rules_file&gt;</em></code>. Useful for testing and rule authoring.</td>
</tr>
<tr>
<td><code>-v</code></td>
<td>Enables verbose logging while Falco is running. This option does not affect the usual Falco notifications, but log messages may interleave. Useful for debugging.</td>
</tr>
<tr>
<td><code>--version</code></td>
<td>Prints the version of Falco you are using.</td>
</tr>
</tbody>
</table>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Configuration File"><div class="sect1" id="configuration_file">
<h1>Configuration File</h1>
<p><a contenteditable="false" data-primary="configuration file" data-type="indexterm" id="idm45324224224416"/><a contenteditable="false" data-primary="configuring Falco" data-secondary="configuration file" data-type="indexterm" id="idm45324224223312"/>We talk about Falco’s configuration file all throughout this book, and we’ve already covered its most important aspects. This section provides an overview and pointers to everything you may need.</p>
<p>The configuration file is a YAML file, located at <em>/etc/falco/falco.yaml</em> by default. In this file, you can configure:</p>
<dl>
<dt>Rules files</dt>
<dd><p><a contenteditable="false" data-primary="rules files" data-secondary="configuration nodes" data-type="indexterm" id="idm45324224219040"/>The <code>rules_file</code> configuration node is the first one you’ll find in the configuration file. It allows you to choose which rules files Falco will load (more on these in the next section).</p></dd>
<dt>Plugins</dt>
<dd><p><a contenteditable="false" data-primary="plugins" data-secondary="configuration nodes" data-type="indexterm" id="idm45324224216032"/>You can enable plugins and pass settings through the <code>load_plugins</code> and <code>plugins</code> configuration nodes (see <a data-type="xref" href="#using_plugins">“Using Plugins”</a>).</p></dd>
<dt>Output channels</dt>
<dd><p><a contenteditable="false" data-primary="output channels" data-secondary="configuration nodes" data-type="indexterm" id="idm45324224211744"/>Various configuration nodes allow you to configure formatting, logging, and output channel options. Refer to <a data-type="xref" href="ch08.xhtml#the_output_framework">Chapter 8</a> for more information on the output framework.</p></dd>
<dt>Embedded servers</dt>
<dd><p><a contenteditable="false" data-primary="embedded server configuration nodes" data-type="indexterm" id="idm45324224208224"/><a contenteditable="false" data-primary="webserver configuration node" data-type="indexterm" id="idm45324224207152"/>Falco provides an embedded web server that exposes a healthy endpoint.<sup><a data-type="noteref" id="ch01fn14-marker" href="ch10.xhtml#ch01fn14">3</a></sup> Container orchestrators and other applications can use this endpoint to check if Falco is up and running. The <code>webserver</code> configuration node allows you to enable and configure the server.</p>
<p>Falco also provides a gRPC server that you can enable and configure using the <code>grpc</code> configuration node (see Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch08.xhtml#the_output_framework">8</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch12.xhtml#consuming_falco_events">12</a>).</p></dd>
<dt>Advanced fine-tuning settings (syscalls only)</dt>
<dd><p><a contenteditable="false" data-primary="system calls" data-secondary="configuration settings" data-type="indexterm" id="idm45324224199360"/>Syscall instrumentation is likely the most complex feature Falco supports, so the configuration file also provides advanced settings for it. Those settings vary between versions of Falco, so we suggest you always refer to the online documentation and the inline comments included in the configuration file.</p>
<p>Notable options here include <code>syscall_event_drops</code>, which controls the detection of dropped events; <code>syscall_event_timeouts</code>, which helps detect the absence of events (an uncommon situation for syscalls); and <code>metadata_download</code>, which provides several options to fine-tune information downloads from the container orchestrator API server.</p></dd>
</dl>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Ruleset"><div class="sect1" id="ruleset">
<h1>Ruleset</h1>
<p><a contenteditable="false" data-primary="configuring Falco" data-secondary="ruleset" data-type="indexterm" id="ch10.html7"/><a contenteditable="false" data-primary="rulesets" data-secondary="customizing" data-type="indexterm" id="ch10.html8"/>Falco comes with a set of predefined rules that you can use right out of the box. However, there are good reasons to customize your ruleset as much as possible. The default ruleset is designed to cover major attack vectors, but these rules cannot cover all possible cases. Attack mechanisms are always evolving, so your ruleset needs to keep up. If you want the highest level of security, you need a ruleset that’s tailored to your specific environment.</p>
<p>Additional benefits of customizing your rules include avoiding noisy false positives and optimizing Falco’s performance. You need to learn how to configure the ruleset correctly for all of these reasons.</p>
<section data-type="sect2" data-pdf-bookmark="Loading Rules Files"><div class="sect2" id="loading_rules_files">
<h2>Loading Rules Files</h2>
<p><a contenteditable="false" data-primary="rules files" data-secondary="loading" data-type="indexterm" id="idm45324224187312"/><a contenteditable="false" data-primary="rulesets" data-secondary="loading rules files" data-type="indexterm" id="idm45324224185936"/>There are two ways to tell Falco which rules files to load: through the command line or the configuration file. On the command line, you specify rules files using the <code>-r</code> flag. In the configuration file, you put rules files under the <code>rules_file</code> section. Recall that anything you set via the command line will take precedence over the configuration file. In production, we recommend loading rules files through the configuration file <em>only,</em> for this reason.</p>
<p>Whichever method you choose, you can specify more than one rules file or directory. So, you can do:</p>
<pre data-type="programlisting">$ <strong>falco -r path/to/my/rulefile1.yaml -r path/to/my/rulefile2.yaml</strong></pre>
<p>or:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">rules_file</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">path/to/my/rulefile1.yaml</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">path/to/my/rulefile2.yaml</code><code class="w"/></pre>
<p>It’s important to be aware that rules files are loaded and parsed in the order you specify. (When the entry is a directory, Falco will load every file in that directory in alphabetical order.) This makes it possible to customize rules, macros, and lists (see <a data-type="xref" href="ch07.xhtml#falco_rules">Chapter 7</a>) that are defined in one file in a subsequent file. The default Falco configuration is crafted to take advantage of this mechanism.</p>
<p>Let’s take a look at the <code>rules_file</code> section in the default configuration file that is shipped with Falco:</p>
<pre data-type="programlisting" data-code-language="yaml" class="pagebreak-before less_space"><code class="nt">rules_file</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">/etc/falco/falco_rules.yaml</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">/etc/falco/falco_rules.local.yaml</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">/etc/falco/rules.d</code><code class="w"/></pre>
<p>The main rules file, <em>falco_rules.yaml</em>, which contains rules for syscalls, is followed by a file named <em>falco_rules.local.yaml</em>. This file is where you should make changes to <em>falco_rules.yaml</em>. It is empty by default, and you can work in it without having to worry about polluting the main rules file. You can create other local files as you need.</p>
<p>Usually, Falco provides one rules file per data source. You can use this approach or use multiple files, depending on your needs. Just keep in mind that the loading order matters. Also note that Falco will only load rules that match the configured data source; all others will be ignored. This means you don’t have to worry about manually removing or disabling rules files intended for other data sources.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Tuning the Ruleset"><div class="sect2" id="tuning_the_ruleset">
<h2>Tuning the Ruleset</h2>
<p><a contenteditable="false" data-primary="rulesets" data-secondary="tuning" data-type="indexterm" id="idm45324224094736"/>The most important aspect of tuning the ruleset is understanding what your use case needs to detect. That will allow you to decide which rules work for you and which do not. Avoiding unnecessary rules has the double benefit of increasing performance (Falco will use less CPU resources) and reducing false positives.</p>
<p>Once you have done an initial skim, disable the rules you are not interested in (as described in <a data-type="xref" href="ch07.xhtml#falco_rules">Chapter 7</a>). We do not suggest removing them from the rules files unless you have created your own rules files from scratch. We also recommend periodically evaluating your ruleset, because the rules you need will change over time.</p>
<p>Next, look at the rules’ conditions. We’ll get into the details of writing Falco rules in <a data-type="xref" href="ch13.xhtml#writing_falco_rules">Chapter 13</a>, but for now we’ll offer <a contenteditable="false" data-primary="rules" data-secondary="general guidelines for evaluating" data-type="indexterm" id="idm45324224113856"/>two general guidelines for evaluating Falco rules.</p>
<p>First, <em>avoid using too many exceptions in conditions:</em> for example, long chains of <code>and not (...) and not (...)</code>. Falco has no alternative but to sequentially check any exception present in the condition, which is an expensive task. Shorter conditions, whenever possible, can improve rule evaluation performance significantly.</p>
<p>The second guideline applies only to syscalls and holds that <em>a rule condition should always match just one event type or a small set of event types</em>. For example, <code>evt.type=connect</code> and <code>evt.type in (open,openat,openat2)</code> are both fine, but <code>evt.type!=execve</code> is not, because that filter would match all event types except one, which is too many. Falco indexes rules by event type as a way of optimizing its internal evaluation process; a rule matching too many event types would make this indexing inefficient. To help rule authors spot this issue, Falco emits warnings for rules that match all event types.<a contenteditable="false" data-primary="" data-startref="ch10.html8" data-type="indexterm" id="idm45324224108480"/><a contenteditable="false" data-primary="" data-startref="ch10.html7" data-type="indexterm" id="idm45324224107104"/></p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Using Plugins"><div class="sect1" id="using_plugins">
<h1>Using Plugins</h1>
<p><a contenteditable="false" data-primary="configuring Falco" data-secondary="plugins" data-type="indexterm" id="idm45324224103456"/><a contenteditable="false" data-primary="plugins" data-secondary="configuring Falco" data-type="indexterm" id="idm45324224102080"/><a contenteditable="false" data-primary="plugins" data-secondary="as data source" data-secondary-sortas="data source" data-type="indexterm" id="idm45324224100704"/>By default, Falco comes configured to use syscalls. If you want to use a plugin as your data source instead, make sure that:</p>
<ul>
<li><p>The plugin file is already available in <em>/usr/share/falco/plugins</em> (some plugins are shipped with Falco); if not, you’ll need to install it in that folder.</p></li>
<li><p>A rules file for the plugin is available (we recommend placing it under <em>/etc/falco</em>).</p></li>
<li><p>You have read the plugin’s documentation and understand which configuration parameters it needs.</p></li>
</ul>
<p>Then, preparing Falco’s configuration file to use a plugin is a three-step process: select the correct rules file, configure the plugin, and enable it.</p>
<p><a contenteditable="false" data-primary="CloudTrail" data-secondary="plugin" data-type="indexterm" id="idm45324224071200"/>To illustrate this process, we will use the <a href="https://oreil.ly/kgImn">CloudTrail plugin</a>, which fetches log files containing <a href="https://oreil.ly/DUEDJ">CloudTrail</a> events (details on using this plugin are provided in the next chapter). The CloudTrail plugin has a ruleset that requires another plugin with field extraction capability: the <a href="https://oreil.ly/Viiaj">JSON plugin</a>. Both plugins and the ruleset come bundled with Falco out of the box, so you should already have them if you’ve installed Falco. You’ll find the plugin files <em>libcloudtrail.so</em> and <em>libjson.so</em> under <em>/usr/share/falco/plugins</em> and the rules file at <em>/etc/falco/aws_cloudtrail_rules.yaml</em>.</p>
<p>Rules files for plugins are not usually configured by default in the Falco configuration, so you’ll have to add an entry to <code>rules_file</code> to load the correct rules file (you can also remove unnecessary ones if you want to):</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">rules_file</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">/etc/falco/aws_cloudtrail_rules.yaml</code><code class="w"/></pre>
<p>Next, under <code>plugins</code>, add the relevant entries:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">plugins</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cloudtrail</code><code class="w"/>
<code class="w">    </code><code class="nt">library_path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">libcloudtrail.so</code><code class="w"/>
<code class="w">    </code><code class="nt">init_config</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">sqsDelete</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>
<code class="w">    </code><code class="nt">open_params</code><code class="p">:</code><code class="w"> </code><code class="s">"sqs://my-sqs-queue"</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">json</code><code class="w"/>
<code class="w">    </code><code class="nt">library_path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">libjson.so</code><code class="w"/>
<code class="w">    </code><code class="nt">init_config</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="w"/></pre>
<p>The <code>name</code> field must match the plugin name, and <code>library_path</code> must match the plugin file under <em>/usr/share/falco/plugins</em>.</p>
<p>In <code>init_config</code>, add the initialization parameters that Falco will pass to the plugin (refer to your plugin’s documentation for details). Most plugins accept either a plain-text or a JSON-formatted string. If the plugin supports a JSON string, you can still use the YAML syntax for <code>init_config</code> (as in the preceding example); Falco will automatically convert it for you.</p>
<p>The <code>open_params</code> setting is needed only for plugins with event sourcing capability (such as the CloudTrail plugin) and accepts only a plain-text string. It provides the parameters to open the stream of events (again, refer to your plugin’s documentation). Some plugins might not need this setting; in that case, you can just set it to an empty string (<code>""</code>).</p>
<p>The last step is to enable your plugins:</p>
<pre data-type="programlisting" data-code-language="yaml"><code class="nt">load_plugins</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="nv">cloudtrail</code><code class="p-Indicator">,</code><code class="w"> </code><code class="nv">json</code><code class="p-Indicator">]</code><code class="w"/></pre>
<p>The <code>load_plugins</code> setting accepts an array of plugin names. You can enable multiple plugins at the same time.<sup><a data-type="noteref" id="ch01fn15-marker" href="ch10.xhtml#ch01fn15">4</a></sup></p>
<p>That’s it! Your plugins are now configured and ready to run in Falco.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Changing the Configuration"><div class="sect1" id="changing_the_configuration">
<h1>Changing the Configuration</h1>
<p><a contenteditable="false" data-primary="configuring Falco" data-secondary="changing the configuration" data-type="indexterm" id="idm45324223937104"/>Once you’ve installed and configured Falco, you may need to change its configuration from time to time. There are two ways to tell Falco to load an updated configuration (that is, any modification to the configuration file or rules files).</p>
<p>The simplest method is just to modify the configuration and then restart Falco. If you installed Falco on the host using a package manager, you can do this with <code>systemctl restart falco</code>. If you are running Falco in a container, restart the container. If you’re running it in a Kubernetes cluster, you’ll need to redeploy Falco. Restarting Falco is the only way to upgrade to a newer version or change its command-line settings.</p>
<p>The second way to load an updated configuration is to <em>hot-reload</em>, or tell Falco to reload the configuration and rules files without stopping its running process. You can tell Falco to reload itself by sending a <a href="https://oreil.ly/6unav">SIGHUP signal</a>:</p>
<pre data-type="programlisting">$ <strong>kill -HUP</strong> <strong><em>&lt;falco process ID here&gt;</em></strong></pre>
<p>Once Falco receives the signal, it will reload the configuration file and the configured rules files.</p>
<p>Since version 0.32.0, Falco can automatically hot-reload when the configuration file or a rules file is modified. In the configuration file, the <code>watch_config_files</code> setting controls this feature (enabled by default). So, in recent versions of Falco, you can just change the configuration file or rules files without the need to send a SIGHUP signal manually.</p>
<p>Note that when Falco is restarting or hot reloading, it does not detect events. However, the amount of time required to hot-reload Falco is significantly shorter than the time it takes to restart the process, and is usually negligible.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="conclusion-id000009">
<h1>Conclusion</h1>
<p>This chapter and the previous one provided in-depth coverage of installing, configuring, and running Falco in a production environment, for both the syscall instrumentation scenario and the scenario where you’re using a plugin as a data source. Now, it’s time to dig deeper into a concrete plugin case: using Falco for cloud security. In the next chapter, you will discover how to secure your cloud by taking advantage of the CloudTrail plugin.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="ch01fn11"><sup><a href="ch10.xhtml#ch01fn11-marker">1</a></sup> There are several other ways to set environment variables when running a container in Docker; for more information, refer to Docker’s <a href="https://oreil.ly/91H3j">online documentation</a>.</p><p data-type="footnote" id="ch01fn12"><sup><a href="ch10.xhtml#ch01fn12-marker">2</a></sup> There are several alternatives for mounting files into a container. For details, see Docker’s <a href="https://oreil.ly/4cdap">documentation</a>.</p><p data-type="footnote" id="ch01fn14"><sup><a href="ch10.xhtml#ch01fn14-marker">3</a></sup> Falco’s developers initially introduced the web server to support the Kubernetes audit log as a data source. Recently, they factored out this functionality into a plugin. Thus, the actual settings you can find under the <code>webserver</code> configuration node may vary significantly from one Falco version to another.</p><p data-type="footnote" id="ch01fn15"><sup><a href="ch10.xhtml#ch01fn15-marker">4</a></sup> The first versions of Falco with the plugin system do not allow you to enable multiple plugins with the event sourcing capability at the same time. However, you can enable multiple plugins with only the field extraction capability (see <a data-type="xref" href="ch04.xhtml#data_source">Chapter 4</a>).</p></div></div></section></div></body></html>