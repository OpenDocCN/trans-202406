<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 13. Secure Remote Access with OpenVPN"><div class="chapter" id="cha-openvpn">
<h1><span class="label">Chapter 13. </span>Secure Remote Access with OpenVPN</h1>


<p>Open Virtual Private Network (OpenVPN) creates<a data-type="indexterm" data-primary="Open Virtual Private Network" data-see="OpenVPN" id="idm46466157030760"/> a TLS/SSL encrypted connection between two
different networks at separate physical locations, like a branch office linked to a main
office, or a remote worker logging in to the company network from home. This connection
is called an <a data-type="indexterm" data-primary="tunneling" data-secondary="with OpenVPN" data-secondary-sortas="OpenVPN" id="idm46466157031672"/>encrypted  <em>tunnel</em>, a secure transport protecting your connection from the
big bad internet. OpenVPN is dependent on OpenSSL, so having OpenSSL knowledge is
helpful.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you are already familiar with OpenVPN, you can probably skip ahead to Recipes <a data-xrefstyle="select:labelnumber" data-type="xref" href="#rec-create-pki">13.5</a>,
<a data-xrefstyle="select:labelnumber" data-type="xref" href="#rec-customize-rsa">13.6</a>, and <a data-xrefstyle="select:labelnumber" data-type="xref" href="#rec-vpn-configs">13.7</a> to review creating your encryption
certificates and client and server configuration. If you are new to VPNs, try each recipe in
sequence. Take your time; VPNs are complicated and finicky. Do a lot of testing before
deploying to production systems.</p>
</div>






<section data-type="sect1" class="orm:non-recipe" data-pdf-bookmark="OpenVPN Overview"><div class="sect1" id="idm46466157023448">
<h1>OpenVPN Overview</h1>

<p>A VPN is<a data-type="indexterm" data-primary="VPNs (virtual private networks)" data-seealso="OpenVPN" id="vpn"/><a data-type="indexterm" data-primary="OpenVPN" data-secondary="overview" id="openvpn-overview"/> a secure extension of your network that makes all the same services available to
remote workers that local users have, so the remote users’ experience is the same as for users physically present at your location. They can access your local web servers, email, file shares, chat servers, video conferencing apps, internal wikis, everything that you have walled off from the outside world and is available only to users inside your network. A VPN is not like SSH, which connects individual computers. A VPN links  etworks and individual hosts to networks.</p>

<p>In this chapter you will learn how to set up an OpenVPN server, configure clients, and create and manage a proper public key infrastructure (PKI) for authentication and encryption. Your server will authenticate and protect all manner of clients: Linux, macOS, Windows PCs, Android, and iOS devices.</p>

<p>OpenVPN is an open source project, with both free downloads and commercial options. The
free-of-cost server and client is the <em>openvpn</em> package, which is available on all Linux distros and downloads at
<a href="https://oreil.ly/vwEAs">OpenVPN Community Downloads</a>.
Commercial options include OpenVPN Access Server, which is a premises server with
additional management tools and cloud options. Hosted personal plans require installing
only the client and provide access to a global network of OpenVPN servers.</p>

<p>A true VPN is strong because it trusts no one and requires authenticated endpoints, where
server and client authenticate to each other. Most commercial TLS/SSL VPNs do not do
this, but instead trust all clients, like shopping sites do. This is more flexible and allows users
to log in from anywhere, using any device. It is convenient not to have to install and
configure client software and copy encryption keys. But for your internal network that is
shortsighted—the last thing you need is users logging in from random PCs or smartphones
infected with keyloggers and spyware, and then given a warm welcome into<a data-type="indexterm" data-primary="VPNs (virtual private networks)" data-seealso="OpenVPN" data-startref="vpn" id="idm46466157018344"/> your LAN.</p>








<section data-type="sect2" class="orm:non-recipe" data-pdf-bookmark="Certificate Authority"><div class="sect2" id="idm46466157014712">
<h2>Certificate Authority</h2>

<p>A certificate authority (CA)<a data-type="indexterm" data-primary="certificate authority (CA)" id="idm46466157012088"/><a data-type="indexterm" data-primary="CA (certificate authority)" id="idm46466157017768"/> is the most important part of running an OpenVPN server. A CA issues digital certificates and certifies ownership of public keys. Click the little padlock in a web browser to see the public certificate for a website, and which CA signed it. A CA is a trusted authority, and that is why so many sites use commercial CAs. Self-signed certificates, like the ones we are creating in this chapter, are fine to use inside your organization. Customer-facing sites should use commercial CAs. Using a CA saves you from the hassle of keeping copies of client certificates on your OpenVPN server; all the server needs to know is that the client certificate is authenticated by your CA.</p>
</div></section>













<section data-type="sect2" class="orm:non-recipe" data-pdf-bookmark="SSL Versus TLS"><div class="sect2" id="idm46466157016744">
<h2>SSL Versus TLS</h2>

<p>Secure Sockets Layer (SSL)<a data-type="indexterm" data-primary="Secure Sockets Layer (SSL)" id="idm46466157001800"/><a data-type="indexterm" data-primary="SSL (Secure Sockets Layer)" id="idm46466157001192"/> and Transport Layer Security (TLS)<a data-type="indexterm" data-primary="Transport Layer Security (TLS)" id="idm46466157000008"/><a data-type="indexterm" data-primary="TLS (Transport Layer Security)" id="idm46466156999400"/> are cryptographic protocols. TLS evolved from SSL. All versions of SSL are deprecated, as are TLS 1.0 and TLS 1.1. Use TLS 1.2 or 1.3, and disable all the others (<a data-type="xref" href="#rec-harden-vpn">Recipe 13.10</a>). Older versions are deprecated because of security flaws, so don’t let anyone talk you into supporting deprecated versions.</p>
</div></section>













<section data-type="sect2" class="orm:non-recipe" data-pdf-bookmark="TUN/TAP"><div class="sect2" id="idm46466157007240">
<h2>TUN/TAP</h2>

<p>The <em>TUN</em> and <em>TAP</em> devices <a data-type="indexterm" data-primary="TUN devices" id="idm46466157006072"/><a data-type="indexterm" data-primary="TAP devices" id="idm46466157005464"/>are virtual network interfaces. These are built into the Linux
kernel, and you should not have to do anything to make them available. The <em>TUN</em> device
is for routed networks, and the <em>TAP</em> device is for bridged networks. Your server and client
configuration files specify which one to <a data-type="indexterm" data-primary="OpenVPN" data-secondary="overview" data-startref="openvpn-overview" id="idm46466157003000"/>use.</p>
<div data-type="warning" epub:type="warning"><h1>Good Security Takes Work</h1>
<p>Good security requires ongoing study and maintenance. This chapter aims to show you
how to set up a strong VPN that is reasonably user-friendly. There are many additional
methods for making your VPN even stronger, such as client certificates with short
lifetimes, additional authentications, hardware devices, SELinux, chroot jails, short
password timeouts, and many more. If you require super-high security, please consult
expert professionals.</p>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="13.1 Installing OpenVPN, Server and Client"><div class="sect1" id="rec-install-openvpn">
<h1>13.1 Installing OpenVPN, Server and Client</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156992936">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="OpenVPN" data-secondary="installing" id="openvpn-install"/><a data-type="indexterm" data-primary="installing" data-secondary="OpenVPN" id="install-openvpn"/><a data-type="indexterm" data-primary="servers" data-secondary="OpenVPN" data-tertiary="installing" id="server-openvpn-install"/><a data-type="indexterm" data-primary="clients" data-secondary="OpenVPN" data-tertiary="installing" id="client-openvpn-install"/>need to know how to install openVPN.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156985512">
<h2>Solution</h2>

<p>The <a href="https://openvpn.net">OpenVPN website</a> supplies both the community open source OpenVPN and the commercial OpenVPN Access Server. The community OpenVPN is free of cost and open source. This chapter covers the community OpenVPN.</p>

<p>On Linux, install the <em>openvpn</em> package. (As always, verify the package
name on your particular Linux.) Get the most current version you can, from 2.4.5 and up.
This provides both server and client. Source tarballs and Windows installers are available
from <a href="https://oreil.ly/vwEAs">OpenVPN Community Downloads</a>.</p>

<p>For your clients, you could try the free
<a href="https://oreil.ly/vQugl">OpenVPN Access Clients</a>,
which are available for Linux, macOS, Android, iOS, and Windows. These are
designed for the commercial OpenVPN Access Server and also work with the community OpenVPN server.</p>

<p>You can also find the community OpenVPN client for Android in the Google Play Store.</p>

<p>See <a data-type="xref" href="#rec.ovpn">Recipe 13.9</a> to learn how to use the <em>.ovpn</em> inline file format for easier client

<span class="keep-together">configuration</span>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156984472">
<h2>Discussion</h2>

<p>On Linux, OpenVPN must be installed on your OpenVPN server and on all clients. The OpenVPN package provides both client and server functionality.</p>

<p>Ubuntu, Fedora, and openSUSE include additional packages that provide integration with NetworkManager, which makes managing, connecting, and disconnecting to VPNs nice and easy.</p>

<p><em>NetworkManager-openvpn</em> (Fedora, openSUSE) and <em>network-manager-openvpn</em> (Ubuntu) integrate OpenVPN with<a data-type="indexterm" data-primary="NetworkManager" data-secondary="OpenVPN installation" id="idm46466156973896"/> Network Manager. If you are using the GNOME environment
(such as GNOME, Xfce, Cinnamon, or Mate), you also need <em>NetworkManager-openvpn-gnome</em> (openSUSE, Fedora), or <em>network-manager-openvpn</em> (Ubuntu).</p>

<p>OpenVPN Access Server is a free download, and you may connect up to two clients at the same time without purchasing a license. It comes with additional features, such as a web administration interface and automatic configurations with the free OpenVPN Access Client. If you start with the community OpenVPN and then decide to migrate to OpenVPN Access Server, everything you learned for the community OpenVPN server applies to Access Server as<a data-type="indexterm" data-primary="OpenVPN" data-secondary="installing" data-startref="openvpn-install" id="idm46466156970296"/><a data-type="indexterm" data-primary="installing" data-secondary="OpenVPN" data-startref="install-openvpn" id="idm46466156968648"/><a data-type="indexterm" data-primary="servers" data-secondary="OpenVPN" data-tertiary="installing" data-startref="server-openvpn-install" id="idm46466156967432"/><a data-type="indexterm" data-primary="clients" data-secondary="OpenVPN" data-tertiary="installing" data-startref="client-openvpn-install" id="idm46466156965912"/> well.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156964040">
<h2>See Also</h2>

<ul class="no-space-list">
<li>
<p><a href="https://oreil.ly/eKbsg">EasyRSA</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ah124">OpenVPN documentation</a></p>
</li>
<li>
<p><em>man 8 openvpn</em></p>
</li>
<li>
<p><a href="https://oreil.ly/Ctm0X">OpenSSL Cookbook</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="13.2 Setting Up a Simple Connection Test"><div class="sect1" id="idm46466156956888">
<h1>13.2 Setting Up a Simple Connection Test</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156971656">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="OpenVPN" data-secondary="connectivity testing" id="openvpn-connectivity"/><a data-type="indexterm" data-primary="connectivity testing" data-secondary="in OpenVPN" data-secondary-sortas="OpenVPN" id="connectivity-openvpn"/><a data-type="indexterm" data-primary="testing" data-secondary="connectivity testing in OpenVPN" id="testing-connectivity-openvpn"/><a data-type="indexterm" data-primary="networking" data-secondary="OpenVPN" data-see="OpenVPN" id="idm46466156951048"/>want to run the simplest OpenVPN connection test to get an idea of how it works and to verify connectivity.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156949368">
<h2>Solution</h2>

<p>The following simple test creates an unencrypted tunnel between two Linux computers that
are on the same network. OpenVPN must be installed on both of them. First verify that
the OpenVPN daemon is not running on either host, and if it is, stop it:</p>
<pre>$ <strong>systemctl status <i>openvpn@.openvpn1.service</i></strong>
● openvpn.service - OpenVPN service
     Loaded: loaded (/lib/systemd/system/openvpn.service; enabled; vendor prese&gt;
     Active: active (exited) since Sun 2021-01-10 13:43:18 PST; 33min ago
[...]
$ <strong>sudo systemctl stop <i>openvpn@.openvpn1.service</i></strong></pre>
<div data-type="tip"><h1>Use a Different Subnet for Your VPN</h1>
<p>Use a different subnet for your OpenVPN tunnel; for example, <em>host1</em> and <em>host2</em> are on 192.168.43.0/24, so the example uses the 10.0.0.0/24 private address space for the VPN tunnel.</p>
</div>

<p>In the following example, the two computers are named <em>host1</em> and <em>host2</em>. The first
example creates a VPN tunnel from <em>host1</em> to <em>host2</em>:</p>
<pre>[madmax@host1 ~]$ <strong>sudo openvpn  --remote <i>host2</i> --dev tun0 --ifconfig <i>10.0.0.1 \
10.0.0.2</i></strong>
Sat Jan  9 14:40:34 2021 disabling NCP mode (--ncp-disable) because not in P2MP
  client or server mode
Sat Jan  9 14:40:34 2021 OpenVPN 2.4.8 x86_64-redhat-linux-gnu [SSL (OpenSSL)]
  [LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Jan 29 2020
Sat Jan  9 14:40:34 2021 library versions: OpenSSL 1.1.1d FIPS  10 Sep 2019,
  LZO 2.10
Sat Jan  9 14:40:34 2021 ******* WARNING *******: All encryption and
  authentication features disabled -- All data will be tunnelled as clear text
  and will not be protected against man-in-the-middle changes. PLEASE DO
  RECONSIDER THIS CONFIGURATION!
Sat Jan  9 14:40:34 2021 TUN/TAP device tun0 opened
Sat Jan  9 14:40:34 2021 /sbin/ip link set dev tun0 up mtu 1500
Sat Jan  9 14:40:34 2021 /sbin/ip addr add dev tun0 local 10.0.0.1 peer 10.0.0.2
Sat Jan  9 14:40:34 2021 TCP/UDP: Preserving recently used remote address:
  [AF_INET]192.168.122.239:1194
Sat Jan  9 14:40:34 2021 UDP link local (bound): [AF_INET][undef]:1194
Sat Jan  9 14:40:34 2021 UDP link remote: [AF_INET]192.168.122.239:1194</pre>

<p>This example creates a link from <em>host2</em> to <em>host1</em>:</p>
<pre>[stash@host2 ~]$ <strong>sudo openvpn --remote <i>host1</i> --dev tun0 --ifconfig <i>10.0.0.2 \
10.0.0.1</i></strong>
Sat Jan  9 14:50:53 2021 disabling NCP mode (--ncp-disable) because not in P2MP
  client or server mode
Sat Jan  9 14:50:53 2021 OpenVPN 2.4.7 x86_64-pc-linux-gnu [SSL (OpenSSL)] [LZO]
  [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Sep  5 2019
Sat Jan  9 14:50:53 2021 library versions: OpenSSL 1.1.1f  31 Mar 2020, LZO 2.10
Sat Jan  9 14:50:53 2021 ******* WARNING *******: All encryption and
  authentication features disabled -- All data will be tunnelled as clear text
  and will not be protected against man-in-the-middle changes. PLEASE DO
  RECONSIDER THIS CONFIGURATION!
Sat Jan  9 14:50:53 2021 TUN/TAP device tun0 opened
Sat Jan  9 14:50:53 2021 /sbin/ip link set dev tun0 up mtu 1500
Sat Jan  9 14:50:53 2021 /sbin/ip addr add dev tun0 local 10.0.0.2 peer 10.0.0.1
Sat Jan  9 14:50:53 2021 TCP/UDP: Preserving recently used remote address:
  [AF_INET]192.168.122.52:1194
Sat Jan  9 14:50:53 2021 UDP link local (bound): [AF_INET][undef]:1194
Sat Jan  9 14:50:53 2021 UDP link remote: [AF_INET]192.168.122.52:1194
Sat Jan  9 14:51:03 2021 Peer Connection Initiated with
  [AF_INET]192.168.122.52:1194
Sat Jan  9 14:51:04 2021 WARNING: this configuration may cache passwords in
  memory -- use the auth-nocache option to prevent this
Sat Jan  9 14:51:04 2021 Initialization Sequence Completed</pre>

<p>You have a successful connection when both hosts show the
“Initialization Sequence Completed” message. Test your connections by pinging through
the <em>tun0</em> interface on both hosts:</p>
<pre>[madmax@host1 ~]$ <strong>ping -I tun0 <i>10.0.0.2</i></strong>
PING 10.0.0.2 (10.0.0.2) from 10.0.0.1 tun0: 56(84) bytes of data.
64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=0.515 ms
64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=0.436 ms

[stash@host2 ~]$ <strong>ping -I tun0 <i>10.0.0.1</i></strong>
PING 10.0.0.1 (10.0.0.1) from 10.0.0.2 tun0: 56(84) bytes of data.
64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=0.592 ms
64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=0.534 ms
</pre>

<p>Press Ctrl-C on each host to stop ping, and again to close the tunnels.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156929480">
<h2>Discussion</h2>

<p>This simple test illustrates how OpenVPN works. It creates a virtual network interface,
<em>tun0</em> on both hosts, then routes network traffic through this interface. This simple test
does not create an encrypted connection, as you can see from the
“******* WARNING *******: All encryption and authentication features disabled”
message in your command<a data-type="indexterm" data-primary="OpenVPN" data-secondary="connectivity testing" data-startref="openvpn-connectivity" id="idm46466156930536"/><a data-type="indexterm" data-primary="connectivity testing" data-secondary="in OpenVPN" data-secondary-sortas="OpenVPN" data-startref="connectivity-openvpn" id="idm46466156927400"/><a data-type="indexterm" data-primary="testing" data-secondary="connectivity testing in OpenVPN" data-startref="testing-connectivity-openvpn" id="idm46466156924568"/> output.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156922920">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/eKbsg">EasyRSA</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ah124">OpenVPN documentation</a></p>
</li>
<li>
<p><a href="https://oreil.ly/2AAEe">systemd.unit</a></p>
</li>
<li>
<p><em>man 8 openvpn</em></p>
</li>
<li>
<p><a href="https://oreil.ly/Ctm0X">OpenSSL Cookbook</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="13.3 Setting Up Easy Encryption with Static Keys"><div class="sect1" id="idm46466156914936">
<h1>13.3 Setting Up Easy Encryption with Static Keys</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156913928">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="OpenVPN" data-secondary="encryption" data-tertiary="with static keys" data-tertiary-sortas="static keys" id="openvpn-encrypt-static"/><a data-type="indexterm" data-primary="encryption" data-secondary="in OpenVPN" data-tertiary="with static keys" data-secondary-sortas="OpenVPN" data-tertiary-sortas="static keys" id="encryption-openvpn-static"/><a data-type="indexterm" data-primary="static keys" id="static-keys"/> want an easy way to create and manage encryption for OpenVPN.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156907496">
<h2>Solution</h2>

<p>The easiest method is to use shared static keys. Shared static keys are useful for testing,
but they are not adequate for production systems. (See the Discussion to learn about
their shortcomings.) In this recipe you will learn how to create and share static keys,
and how to create simple server and client configuration files.</p>

<p class="pagebreak-before less_space">Follow these steps:</p>
<ol>
<li>
<p>Create and distribute a shared static key between two hosts.</p>
</li>
<li>
<p>Create server and client configuration files.</p>
</li>
<li>
<p>Start OpenVPN on both hosts, referencing their configuration files.</p>
</li>

</ol>

<p>In the following examples, the OpenVPN server is on <em>server1</em>, the client is
<em>client1</em>, and the new key is <em>myvpn.key</em>. You may name your keys whatever you
want.</p>

<p>Create a new directory on the OpenVPN server to store keys, then create a new static key:</p>
<pre>$ <strong>sudo mkdir <i>/etc/openvpn/keys</i></strong>
$ <strong>sudo openvpn --genkey --secret <i>myvpn.key</i></strong></pre>

<p>Copy the key to the client machine:</p>
<pre>$ <strong>scp <i>myvpn.key</i> <i>client1:/etc/openvpn/keys/</i></strong>
Password:
myvpn.key                         100%  636   142.7KB/s   00:00
</pre>

<p>Create the server configuration file. The example is <em>/etc/openvpn/server1.conf</em>, and you
can call yours anything you like. Use a different subnet for your OpenVPN tunnel; for example, <em>server1</em> and <em>client1</em> are on 192.168.43.0/24, so the example uses the 10.0.0.0/24 private address space for the VPN tunnel. The server’s <em>tun</em> address is 10.0.0.1:</p>
<pre># server1.conf
dev tun
ifconfig <i>10.0.0.1 10.0.0.2</i>
secret <i>/etc/openvpn/keys/myvpn.key</i>
local <i>192.168.43.184</i></pre>

<p><em>local</em> is the LAN IP address of the server.</p>

<p>Create the client configuration file on the client machine. The client’s <em>tun</em> address is
10.0.0.2:</p>
<pre># client1.conf
dev tun
ifconfig <i>10.0.0.2 10.0.0.1</i>
secret <i>/etc/openvpn/keys/myvpn.key</i>
remote 192.168.43.184</pre>

<p>Make sure the OpenVPN daemon is not running on the server or client:</p>
<pre>$ <strong>sudo systemctl stop openvpn</strong></pre>

<p>Start OpenVPN on the server and client:</p>
<pre>[server1 ~] $ <strong>sudo openvpn <i>/etc/openvpn/server1.conf</i></strong>
</pre>
<pre>[client1 ~] $ <strong>sudo openvpn <i>/etc/openvpn/client1.conf</i></strong>
</pre>

<p>When you see “Initialization Sequence Completed” on both hosts, you have established a
connection. Ping each host over the <em>tun</em> virtual network interface:</p>
<pre>[server1 ~] $ <strong>ping -I tun0 <i>10.0.0.1</i></strong>
[client1 ~] $ <strong>ping -I tun0 <i>10.0.0.2</i></strong></pre>

<p>Press Ctrl-C on both hosts to close the connection.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156906216">
<h2>Discussion</h2>

<p>If you see “WARNING: INSECURE cipher with block size less than 128 bit (64 bit). This allows attacks like SWEET32. Mitigate by using a cipher with a larger block size (e.g. AES-256-CBC)” in your command output, correct it with the following entry in both the server and client configuration files:</p>
<pre>cipher AES-256-CBC</pre>

<p>The biggest problem with using static keys is that you lose perfect forward secrecy because your static key never changes. If an attacker found a way to sniff and capture your network traffic, and then captured and cracked your encryption key, the attacker could then decrypt everything they capture, past and future. OpenVPN’s PKI uses a complex process that generates session keys,  which are not persistent but change regularly. So, at best, a successful attacker can decrypt one session’s worth of traffic at a time, and then has to start over.</p>

<p>Another drawback is you need a different key for each client, and a copy of each client key
on the server. Managing multiple clients is less work and more secure with a proper <a data-type="indexterm" data-primary="OpenVPN" data-secondary="encryption" data-tertiary="with static keys" data-tertiary-sortas="static keys" data-startref="openvpn-encrypt-static" id="idm46466156867112"/><a data-type="indexterm" data-primary="encryption" data-secondary="in OpenVPN" data-tertiary="with static keys" data-secondary-sortas="OpenVPN" data-tertiary-sortas="static keys" data-startref="encryption-openvpn-static" id="idm46466156869048"/><a data-type="indexterm" data-primary="static keys" data-startref="static-keys" id="idm46466156871048"/>PKI.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156877336">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/eKbsg">EasyRSA</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ah124">OpenVPN documentation</a></p>
</li>
<li>
<p><a href="https://oreil.ly/2AAEe">systemd.unit</a></p>
</li>
<li>
<p><em>man 8 openvpn</em></p>
</li>
<li>
<p><a href="https://oreil.ly/Ctm0X">OpenSSL Cookbook</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="13.4 Installing EasyRSA to Manage Your PKI"><div class="sect1" id="rec-install-easyrsa">
<h1>13.4 Installing EasyRSA to Manage Your PKI</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156861848">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="OpenVPN" data-secondary="encryption" data-tertiary="EasyRSA installation" id="openvpn-encrypt-easyrsa-install"/><a data-type="indexterm" data-primary="encryption" data-secondary="in OpenVPN" data-tertiary="EasyRSA installation" data-secondary-sortas="OpenVPN" id="encryption-openvpn-easyrsa-install"/><a data-type="indexterm" data-primary="PKI (public key infrastructure)" data-secondary="EasyRSA" data-tertiary="installing" id="pki-easyrsa-install"/><a data-type="indexterm" data-primary="EasyRSA" data-secondary="installing" id="easyrsa-install"/><a data-type="indexterm" data-primary="installing" data-secondary="EasyRSA" id="install-easyrsa"/><a data-type="indexterm" data-primary="public key infrastructure" data-see="PKI" id="idm46466156853736"/>are going to use EasyRSA to create and manage your public key infrastructure
(PKI), and you want to install and set it up correctly.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156851720">
<h2>Solution</h2>

<p>Your PKI can be anywhere, it does not have to be on the OpenVPN server. You will create
server and client certificates on the PKI, then copy them to their respective hosts.</p>

<p>You can install the <em>easy-rsa</em> package or fetch the freshest release from
<a href="https://oreil.ly/LtAKu">EasyRSA Releases</a> on GitHub.</p>

<p>Fedora and Ubuntu stuff all the EasyRSA files into <em>/usr/share/</em>. This is not a good
working directory, and it is overwritten by system updates. Create a new directory that you
control and does not need root permissions, like our fine example user Duchess who
creates <em>/home/duchess/mypki</em>:</p>
<pre>~$ <strong>mkdir <i>mypki</i></strong></pre>

<p>On Fedora and Ubuntu Linux, copy the <em>/usr/share/easy-rsa</em> directory to your new directory:</p>
<pre>~$ <strong>sudo cp -r /usr/share/easy-rsa <i>mypki</i></strong></pre>

<p>This creates <em>mypki/easyrsa</em>. Check your permissions; you should be the owner
and group owner of everything in your directory.</p>

<p>openSUSE does a proper installation with configuration files in <em>/etc/easy-rsa</em>,
the <em>easyrsa</em> command in <em>/usr/bin</em>, and the documentation and license files in
<em>/usr/share/</em>. You don’t have to move anything or worry about permissions.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156851464">
<h2>Discussion</h2>

<p>You should not need root permissions to create and manage your PKI. You may put it wherever you want, and it should be separate from your OpenVPN configuration, either in a separate directory or on a separate machine. The good OpenVPN people recommend putting it on a well-protected machine that is not exposed to the <a data-type="indexterm" data-primary="OpenVPN" data-secondary="encryption" data-tertiary="EasyRSA installation" data-startref="openvpn-encrypt-easyrsa-install" id="idm46466156839272"/><a data-type="indexterm" data-primary="encryption" data-secondary="in OpenVPN" data-tertiary="EasyRSA installation" data-secondary-sortas="OpenVPN" data-startref="encryption-openvpn-easyrsa-install" id="idm46466156837944"/><a data-type="indexterm" data-primary="PKI (public key infrastructure)" data-secondary="EasyRSA" data-tertiary="installing" data-startref="pki-easyrsa-install" id="idm46466156836344"/><a data-type="indexterm" data-primary="EasyRSA" data-secondary="installing" data-startref="easyrsa-install" id="idm46466156834856"/><a data-type="indexterm" data-primary="installing" data-secondary="EasyRSA" data-startref="install-easyrsa" id="idm46466156833192"/>
<span class="keep-together">internet</span>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156832104">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/eKbsg">EasyRSA</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ah124">OpenVPN documentation</a></p>
</li>
<li>
<p><a href="https://oreil.ly/2AAEe">systemd.unit</a></p>
</li>
<li>
<p><em>man 8 openvpn</em></p>
</li>
<li>
<p><a href="https://oreil.ly/Ctm0X">OpenSSL Cookbook</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="13.5 Creating a PKI"><div class="sect1" id="rec-create-pki">
<h1>13.5 Creating a PKI</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156821240">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="OpenVPN" data-secondary="encryption" data-tertiary="PKI creation" id="openvpn-encrypt-pki-create"/><a data-type="indexterm" data-primary="encryption" data-secondary="in OpenVPN" data-tertiary="PKI creation" data-secondary-sortas="OpenVPN" id="encryption-openvpn-pki-create"/><a data-type="indexterm" data-primary="EasyRSA" data-secondary="PKI, creating" id="easyrsa-pki-create"/><a data-type="indexterm" data-primary="PKI (public key infrastructure)" data-secondary="creating" id="pki-create"/> installed EasyRSA (<a data-type="xref" href="#rec-install-easyrsa">Recipe 13.4</a>), and now you want to know how to set up a
proper public key infrastructure (PKI).</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156814008">
<h2>Solution</h2>

<p>A proper PKI is essential to running an OpenVPN server safely. In this recipe we will use
EasyRSA to create a PKI, which simplifies the process considerably over using
the <em>openssl</em> command. Creating a PKI involves these steps:</p>
<ol>
<li>
<p>Create your own Certificate Authority (CA) certificate to sign server and client certificates. This should be in a separate directory from your OpenVPN server configuration, or on a separate machine.</p>
</li>
<li>
<p>Create and sign an OpenVPN server certificate.</p>
</li>
<li>
<p>Create and sign client certificates.</p>
</li>
<li>
<p>Copy the server certificates and the client certificates to <em>/etc/openvpn/keys</em> on their respective machines. (You may create a different directory than <em>keys</em>.)</p>
</li>

</ol>

<p>In the following examples, all the commands are run from the <em>/home/duchess/mypki/</em>
directory.</p>

<p>Change to your PKI directory and run the command to initiate a new PKI:</p>
<pre>~$ <strong>cd <i>mypki</i></strong>
~/mypki $ <strong>easyrsa init-pki</strong>

init-pki complete; you may now create a CA or requests.
Your newly created PKI dir is: /home/duchess/mypki/pki
</pre>

<p>This creates an empty structure for your new PKI. Next, build<a data-type="indexterm" data-primary="certificate authority (CA)" id="idm46466156799752"/><a data-type="indexterm" data-primary="CA (certificate authority)" id="idm46466156799144"/> your new CA. The CA creates and signs server and client certificates. Protect it with a
strong passphrase, and create the Common Name you want for your new CA:</p>
<pre>~/mypki $ <strong>easyrsa build-ca</strong>
[...]
Enter New CA Key Passphrase:<strong><i>passphrase</i></strong>
Re-Enter New CA Key Passphrase:<strong><i>passphrase</i></strong>
[...]
Common Name (eg: your user, host, or server name) [Easy-RSA CA]: <strong><i>vpnserver1</i></strong>
[...]
CA creation complete and you may now import and sign cert requests.
Your new CA certificate file for publishing is at:
/home/duchess/mypki/pki/ca.crt</pre>
<div data-type="tip"><h6>Tip</h6>
<p>If you see a “RAND_load_file:Cannot open file:crypto/rand/randfile.c:98:Filename=/mypki/pki/.rnd”
message, ignore it, as it is meaningless. You can make it go away by finding
<em>openssl-easyrsa.cnf</em> and commenting out the <em>RANDFILE</em> line at the beginning.</p>
</div>

<p>Generate a keypair and certificate signing request for your OpenVPN server. It is customary to not put a passphrase on the server’s private key. You may protect yours with a passphrase if you wish by omitting the <em>nopass</em> option. A passphrase provides strong protection, but it means entering the passphrase every time you restart your server:</p>
<pre class="codeblock-small">~/mypki $ <strong>easyrsa gen-req <i>vpnserver1</i> nopass</strong>

Using SSL: openssl OpenSSL 1.1.1d  10 Sep 2019
Generating a RSA private key
.............................+++++
................................................................++++++
writing new private key to '/home/duchess/mypki/pki/private/vpnserver1.key.NYjr5y
c9kj'
[...]
Common Name (eg: your user, host, or server name) [<i>vpnserver1</i>]:

Keypair and certificate request completed. Your files are:
req: /home/duchess/mypki/pki/reqs/vpnserver1.req
key: /home/duchess/mypki/pki/private/vpnserver1.key</pre>

<p>Generate a keypair and certificate signing request for a client. Client private keys should
have passwords, especially on mobile clients:</p>
<pre class="codeblock-small">~/mypki $ <strong>easyrsa gen-req <i>vpnclient1</i></strong>

Using SSL: openssl OpenSSL 1.1.1d  10 Sep 2019
Generating a RSA private key
................+++++
....................................................................+++++
writing new private key to '/home/duchess/mypki/pki/private/vpnclient1.key.bicpOc
EC5S'
Enter PEM pass phrase:<i>passphrase</i>
Verifying - Enter PEM pass phrase:<i>passphrase</i>
[...]
Common Name (eg: your user, host, or server name) [<i>vpnclient1</i>]:

Keypair and certificate request completed. Your files are:
req: /home/duchess/mypki/pki/reqs/vpnclient1.req
key: /home/duchess/mypki/pki/private/vpnclient1.key
</pre>

<p>Sign the requests, using their Common Names. Use only their names; if you enter their
paths it will cause an error:</p>
<pre>~/mypki $ <strong>easyrsa sign-req server <i>vpnserver1</i></strong>
Using SSL: openssl OpenSSL 1.1.1d  10 Sep 2019

You are about to sign the following certificate.
Please check over the details shown below for accuracy. Note that this request
has not been cryptographically verified. Please be sure it came from a trusted
source or that you have verified the request checksum with the sender.

Request subject, to be signed as a server certificate for 1080 days:

subject=
    commonName                = vpnserver1

Type the word 'yes' to continue, or any other input to abort.
  Confirm request details: <strong><i>yes</i></strong>
Using configuration from /home/duchess/mypki/pki/safessl-easyrsa.cnf
Enter pass phrase for /home/duchess/mypki/pki/private/ca.key:
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
commonName            :ASN.1 12:'vpnserver1'
Certificate is to be certified until Jan 27 20:09:12 2024 GMT (1080 days)

Write out database with 1 new entries
Data Base Updated

Certificate created at: /home/duchess/mypki/pki/issued/vpnserver1.crt

mypki $ <strong>easyrsa sign-req client <i>vpnclient1</i></strong>
[...]
Certificate created at: /home/duchess/mypki/pki/issued/vpnclient1.crt</pre>

<p>Generate the Diffie-Hellman parameters for the server; this takes a minute or two. This
command must be run on your OpenVPN server:</p>
<pre>$ <strong>easyrsa gen-dh</strong>
Using SSL: openssl OpenSSL 1.1.1d  10 Sep 2019
Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
...........................................+...........
..........+............................................
[...]
DH parameters of size 2048 created at /home/duchess/mypki/pki/dh.pem
</pre>

<p>Create a Hash-based Message Authentication Code (HMAC) key, also on your server:</p>
<pre>$ <strong>openvpn --genkey --secret ta.key</strong></pre>

<p>Copy <em>vpnclient1.key</em>, <em>vpnclient1.crt</em>, <em>ca.crt</em>, and <em>ta.key</em> to <em>/etc/openvpn/keys</em>
on <em>client1</em>.</p>

<p>Copy <em>vpnserver1.key</em>, <em>vpnserver1.crt</em>, <em>ca.crt</em>, <em>dh.pem</em>, and <em>ta.key</em> to
<em>/etc/openvpn/keys</em> on <em>server1</em>.</p>

<p>You may delete all of the <em>*.req</em> files after you have signed the certificate signing requests.</p>

<p><a data-type="xref" href="#table13-xx">Table 13-1</a> should help you remember which files go where.</p>
<table id="table13-xx">
<caption><span class="label">Table 13-1. </span>Server and client key location</caption>
<thead>
<tr>
<th>Name</th>
<th>Location</th>
<th>Public</th>
<th>Private</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>ca.crt</p></td>
<td><p>server &amp; clients</p></td>
<td><p>X</p></td>
<td/>
</tr>
<tr>
<td><p>ca.key</p></td>
<td><p>PKI machine</p></td>
<td/>
<td><p>X</p></td>
</tr>
<tr>
<td><p>ta.key</p></td>
<td><p>server &amp; clients</p></td>
<td/>
<td><p>X</p></td>
</tr>
<tr>
<td><p>dh.pem</p></td>
<td><p>server</p></td>
<td><p>X</p></td>
<td/>
</tr>
<tr>
<td><p>server.crt</p></td>
<td><p>server</p></td>
<td><p>X</p></td>
<td/>
</tr>
<tr>
<td><p>server.key</p></td>
<td><p>server</p></td>
<td/>
<td><p>X</p></td>
</tr>
<tr>
<td><p>client1.crt</p></td>
<td><p>client1</p></td>
<td><p>X</p></td>
<td/>
</tr>
<tr>
<td><p>client1.key</p></td>
<td><p>client1</p></td>
<td/>
<td><p>X</p></td>
</tr>
<tr>
<td><p>client2.crt</p></td>
<td><p>client2</p></td>
<td><p>X</p></td>
<td/>
</tr>
<tr>
<td><p>client2.key</p></td>
<td><p>client2</p></td>
<td/>
<td><p>X</p></td>
</tr>
</tbody>
</table>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156811576">
<h2>Discussion</h2>

<p>What’s this <a data-type="indexterm" data-primary="Diffie-Hellman" id="idm46466156739768"/>Diffie-Hellman stuff? It is the encryption mechanism that allows two hosts to
create and share a secret key. Once the OpenVPN client and server authenticate to each
other, additional send and receive keys are generated to encrypt the 
<span class="keep-together">session</span>.</p>

<p>HMAC <a data-type="indexterm" data-primary="Hash-based Message Authentication Code (HMAC)" id="idm46466156738008"/><a data-type="indexterm" data-primary="HMAC (Hash-based Message Authentication Code)" id="idm46466156737272"/>calculates a message authentication code. HMAC verifies the integrity and authenticity of a message.</p>

<p><em>easyrsa init-pki</em> creates<a data-type="indexterm" data-primary="easyrsa init-pki command" id="idm46466156736008"/> a new PKI, and you may also run it to cleanly remove and rebuild an
existing PKI.</p>

<p>You may set up your PKI anywhere, and the good OpenVPN people recommend putting it on a machine that is not exposed to the internet and is well-protected from anyone who should not be messing with your PKI. If your CA is compromised, it is easy for an attacker to infiltrate your network. Obviously, you must have a secure method of distributing these files: USB stick, the <em>scp</em> command, an encrypted tarball downloaded from a secure server or emailed to your users.</p>

<p>Take a look in your PKI directory to see how all these items are organized.</p>
<pre>~/mypki $ <strong>ls */*</strong>
pki/ca.crt               pki/index.txt            pki/index.txt.old
pki/serial               pki/dh.pem               pki/index.txt.attr
pki/openssl-easyrsa.cnf  pki/serial.old           pki/extensions.temp
pki/index.txt.attr.old   pki/safessl-easyrsa.cnf  pki/ta.key

pki/certs_by_serial:
4954C26DB44106B20F1B9DA17CE515E5.pem  DA68CBE53E30923C9BCC3B9F1C5C9011.pem

pki/issued:
vpnclient1.crt  vpnserver1.crt

pki/private:
ca.key  vpnclient1.key  vpnserver1.key

pki/renewed:
certs_by_serial  private_by_serial  reqs_by_serial

pki/reqs:
vpnclient1.req  vpnserver1.req

pki/revoked:
certs_by_serial  private_by_serial  reqs_by_serial</pre>

<p>Signing requests have a <em>.req</em> file extension, public keys <em>.crt</em>, and private keys <em>.key</em>.
Keys always come in pairs, public and private.</p>
<div data-type="tip"><h1>Public Keys Encrypt, Private Keys Decrypt</h1>
<p>Public keys encrypt, private keys decrypt.
Private keys must<a data-type="indexterm" data-primary="public keys" id="idm46466156726392"/><a data-type="indexterm" data-primary="private keys" id="idm46466156725784"/> be protected and never shared. Public keys are meant to be shared.</p>
</div>

<p>Click on any signed certificate in your file manager to see something like <a data-type="xref" href="#fig-vpn-1">Figure 13-1</a>.
This provides a wealth of information: the CA that signed it, expiration date, serial number,
fingerprint, signature, and lots more.</p>

<figure class="width-55"><div id="fig-vpn-1" class="figure">
<img src="Images/lcb2_1301.png" alt="Viewing a signed certificate" width="532" height="533"/>
<h6><span class="label">Figure 13-1. </span>Viewing a signed certificate</h6>
</div></figure>

<p>Or use the <em>openssl</em> command <a data-type="indexterm" data-primary="openssl command" id="idm46466156721320"/>to read it:</p>
<pre>$ <strong>openssl x509 -noout -text -in <i>vpnserver1.crt</i></strong></pre>

<p>A certificate<a data-type="indexterm" data-primary="certificates" id="idm46466156718616"/> is a request signed by a CA, and it contains the public key and the CA’s
digital signature. A request contains a public key and the digital signature from the
corresponding private key. You can see all of this by comparing them.</p>

<p>EasyRSA was originally part of OpenVPN and then spun off as a separate project. If you
are used to managing PKIs with OpenSSL, you will appreciate how EasyRSA has
streamlined the<a data-type="indexterm" data-primary="OpenVPN" data-secondary="encryption" data-tertiary="PKI creation" data-startref="openvpn-encrypt-pki-create" id="idm46466156714488"/><a data-type="indexterm" data-primary="encryption" data-secondary="in OpenVPN" data-tertiary="PKI creation" data-secondary-sortas="OpenVPN" data-startref="encryption-openvpn-pki-create" id="idm46466156716792"/><a data-type="indexterm" data-primary="EasyRSA" data-secondary="PKI, creating" data-startref="easyrsa-pki-create" id="idm46466156715096"/><a data-type="indexterm" data-primary="PKI (public key infrastructure)" data-secondary="creating" data-startref="pki-create" id="idm46466156712968"/> process.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156711400">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/eKbsg">EasyRSA</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ah124">OpenVPN documentation</a></p>
</li>
<li>
<p><em>man 8 openvpn</em></p>
</li>
<li>
<p><a href="https://oreil.ly/Ctm0X">OpenSSL Cookbook</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="13.6 Customizing EasyRSA Default Options"><div class="sect1" id="rec-customize-rsa">
<h1>13.6 Customizing EasyRSA Default Options</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156703656">
<h2>Problem</h2>

<p>The <a data-type="indexterm" data-primary="OpenVPN" data-secondary="encryption" data-tertiary="EasyRSA customization" id="openvpn-encrypt-easyrsa-custom"/><a data-type="indexterm" data-primary="encryption" data-secondary="in OpenVPN" data-tertiary="EasyRSA customization" data-secondary-sortas="OpenVPN" id="encryption-openvpn-easyrsa-custom"/><a data-type="indexterm" data-primary="PKI (public key infrastructure)" data-secondary="EasyRSA" data-tertiary="customizing" id="pki-easyrsa-custom"/><a data-type="indexterm" data-primary="EasyRSA" data-secondary="customizing" id="easyrsa-custom"/><a data-type="indexterm" data-primary="customizing" data-secondary="EasyRSA" id="custom-easyrsa"/><a data-type="indexterm" data-primary="default EasyRSA options, changing" id="default-easyrsa-change"/><a data-type="indexterm" data-primary="changing" data-secondary="default EasyRSA options" id="changing-easyrsa"/>default settings for EasyRSA are not what you want, and you want to know how to change
them.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156691576">
<h2>Solution</h2>

<p>Look for your <em>vars.example</em> file, which is part of EasyRSA. Save a copy of this file as
<em>vars</em> in your PKI directory, which in the examples in this chapter is
<em>/home/duchess/mypki/pki/</em>. The <em>vars</em> file defines your default settings for creating
and signing certificates.</p>

<p>This file is well commented. Make your edits below the <code># DO YOUR EDITS BELOW THIS POINT</code> line.
Everything prefaced with <em>set_var</em> is editable. Uncomment everything you change.</p>

<p>For example, the default configuration uses just the Common Name, and not a full <em>org</em>
configuration. The following example creates a traditional <em>org</em> configuration:</p>
<pre>set_var EASYRSA_DN      "org"

set_var EASYRSA_REQ_COUNTRY    "<i>US</i>"
set_var EASYRSA_REQ_PROVINCE   "<i>Oregon</i>"
set_var EASYRSA_REQ_CITY       "<i>Walla Walla</i>"
set_var EASYRSA_REQ_ORG        "<i>MyCo</i>"
set_var EASYRSA_REQ_EMAIL      "<i>me@example.com</i>"
set_var EASYRSA_REQ_OU         "<i>MyOU</i>"</pre>

<p>When you use the <em>org</em> configuration, remember to enter your Common Name when you run
<em>easyrsa build-ca</em>, or you will be stuck with the default <em>Easy-RSA CA</em>:</p>
<pre>Common Name (eg: your user, host, or server name) [Easy-RSA CA]:<strong><i>myCN</i></strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156678648">
<h2>Discussion</h2>

<p>Use <em>cn</em> or <em>org</em> according to your own policies and preferences; it makes no difference
to your server operations.</p>

<p>See <a data-type="xref" href="#rec-harden-vpn">Recipe 13.10</a> to learn how to harden your <a data-type="indexterm" data-primary="OpenVPN" data-secondary="encryption" data-tertiary="EasyRSA customization" data-startref="openvpn-encrypt-easyrsa-custom" id="idm46466156675624"/><a data-type="indexterm" data-primary="encryption" data-secondary="in OpenVPN" data-tertiary="EasyRSA customization" data-secondary-sortas="OpenVPN" data-startref="encryption-openvpn-easyrsa-custom" id="idm46466156674056"/><a data-type="indexterm" data-primary="PKI (public key infrastructure)" data-secondary="EasyRSA" data-tertiary="customizing" data-startref="pki-easyrsa-custom" id="idm46466156672328"/><a data-type="indexterm" data-primary="EasyRSA" data-secondary="customizing" id="easyrsa-custom-2"/><a data-type="indexterm" data-primary="customizing" data-secondary="EasyRSA" data-startref="custom-easyrsa" id="idm46466156669592"/><a data-type="indexterm" data-primary="default EasyRSA options, changing" data-startref="default-easyrsa-change" id="idm46466156668424"/><a data-type="indexterm" data-primary="changing" data-secondary="default EasyRSA options" data-startref="changing-easyrsa" id="idm46466156667576"/>server.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156665992">
<h2>See Also</h2>

<ul class="no-space-list">
<li>
<p><a href="https://oreil.ly/eKbsg">EasyRSA</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ah124">OpenVPN documentation</a></p>
</li>
<li>
<p><em>man 8 openvpn</em></p>
</li>
<li>
<p><a href="https://oreil.ly/Ctm0X">OpenSSL Cookbook</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="13.7 Creating and Testing Server and &#10;Client Configurations"><div class="sect1" id="rec-vpn-configs">
<h1>13.7 Creating and Testing Server and 
<span class="keep-together">Client Configurations</span></h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156656968">
<h2>Problem</h2>

<p>Now <a data-type="indexterm" data-primary="OpenVPN" data-secondary="configuring and testing" id="openvpn-config-test"/><a data-type="indexterm" data-primary="configuring" data-secondary="OpenVPN" id="config-openvpn"/><a data-type="indexterm" data-primary="testing" data-secondary="OpenVPN" id="test-openvpn"/><a data-type="indexterm" data-primary="servers" data-secondary="OpenVPN" data-tertiary="configuring and testing" id="server-openvpn-config"/><a data-type="indexterm" data-primary="clients" data-secondary="OpenVPN" data-tertiary="configuring and testing" id="client-openvpn-config"/>that you have a nice stout PKI, you want to know how to configure your OpenVPN
server and clients.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156648440">
<h2>Solution</h2>

<p>In this recipe we will set up a simple test instance between two hosts on the same subnet,
<em>server1</em> and <em>client1</em>. This is a good simple way to test your server configuration
without having to hassle with routing and getting past your internet gateway.</p>

<p>The following example is a simple OpenVPN server configuration. Note that you can store
your server keys anywhere on the server, as long you reference them correctly in your
configuration file:</p>
<pre># <i>vpnserver1.conf</i>
port 1194
proto udp
dev tun
user nobody
group nobody

ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/<i>vpnserver1.crt</i>
key /etc/openvpn/keys/<i>vpnserver1.key</i>
dh /etc/openvpn/keys/dh.pem
tls-auth /etc/openvpn/keys/ta.key 0

server <i>10.10.0.0 255.255.255.0</i>
ifconfig-pool-persist ipp.txt
keepalive 10 120
persist-key
persist-tun
tls-server
remote-cert-tls client

status openvpn-status.log
verb 4
mute 20
explicit-exit-notify 1</pre>

<p>An example client configuration:</p>
<pre># <i>vpnclient1.conf</i>
client
dev tun
proto udp
remote <i>server1</i> 1194

persist-key
persist-tun
resolv-retry infinite
nobind

user nobody
group nobody
tls-client
remote-cert-tls server
verb 4

ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/<i>vpnclient1.crt</i>
key /etc/openvpn/keys/<i>vpnclient1.key</i>
tls-auth /etc/openvpn/keys/ta.key 1
</pre>

<p>Stop your OpenVPN server if it is running:</p>
<pre>$ <strong>sudo systemctl stop <i>openvpn@.openvpn1.service</i></strong></pre>

<p>Start OpenVPN on both hosts with<a data-type="indexterm" data-primary="openvpn command" id="idm46466156635976"/> the <em>openvpn</em> command:</p>
<pre>$ <strong>sudo openvpn <i>/etc/openvpn/vpnserver1.conf</i></strong>
Tue Feb 16 16:50:49 2021 us=265445 Current Parameter Settings:
Tue Feb 16 16:50:49 2021 us=265481   config = '/etc/openvpn/vpnserver1.conf'
[...]
Tue Feb 16 16:50:49 2021 us=270212 Initialization Sequence Completed
</pre>
<pre>$ <strong>sudo openvpn <i>/etc/openvpn/vpnclient1.conf</i></strong>
Tue Feb 16 16:56:22 2021 OpenVPN 2.4.3 x86_64-suse-linux-gnu [SSL (OpenSSL)]
[LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Jun 20 2017
Tue Feb 16 16:56:22 2021 library versions: OpenSSL 1.1.1d  10 Sep 2019, LZO 2.10
Enter Private Key Password: *******
[...]
Tue Feb 16 16:56:26 2021 Initialization Sequence Completed
</pre>

<p>And there you have it, both configurations are correct and you have a successful
connection. Press Ctrl-C on both hosts to stop.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156638984">
<h2>Discussion</h2>

<p>OpenVPN installs with a batch of example configurations in
<em>/usr/share/doc/openvpn/</em>. These are abundantly commented and are excellent
references. There are dozens of options, but in real life you will use just a few of them.
In the examples in this recipe, there are a few items of note.</p>

<p><code>port 1194</code> is the default port, and <code>proto udp</code> is preferred over <code>proto tcp</code>. UDP is more
secure, providing some protection from port scanning and denial-of-service attacks, and
provides higher throughput and lower latency. TCP is useful when a remote user uses
public networks with restrictive firewalls, such as hotels and coffee shops.</p>

<p><em>tls-auth /etc/openvpn/keys/ta.key</em> must always have the 0 value on the server, and 1
on the clients. <em>tls-auth</em> enforces TLS-only connections.</p>

<p><em>verb 4</em> is the logging level. 1 is the lowest, 9 is the most verbose. Keep it at 4–6
until you are confident everything is set up correctly. When you start OpenVPN from the
command line, you will see a lot of messages.</p>

<p>There are a lot of stale how-tos that recommend the <em>comp_lzo</em> option to
enable compression. Don’t bother, as it does not provide much benefit. Most traffic is not
compressible since it is either already compressed or is encrypted and cannot be
compressed. There is at least one vulnerability enabled by <a data-type="indexterm" data-primary="OpenVPN" data-secondary="configuring and testing" data-startref="openvpn-config-test" id="idm46466156625272"/><a data-type="indexterm" data-primary="configuring" data-secondary="OpenVPN" data-startref="config-openvpn" id="idm46466156624408"/><a data-type="indexterm" data-primary="testing" data-secondary="OpenVPN" data-startref="test-openvpn" id="idm46466156622392"/><a data-type="indexterm" data-primary="servers" data-secondary="OpenVPN" data-tertiary="configuring and testing" data-startref="server-openvpn-config" id="idm46466156620952"/><a data-type="indexterm" data-primary="clients" data-secondary="OpenVPN" data-tertiary="configuring and testing" data-startref="client-openvpn-config" id="idm46466156619208"/>compression, VORACLE.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156617480">
<h2>See Also</h2>

<ul class="less-space-list-2">
<li>
<p>The example configuration files in your installation</p>
</li>
<li>
<p><a href="https://oreil.ly/eKbsg">EasyRSA</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ah124">OpenVPN documentation</a></p>
</li>
<li>
<p><em>man 8 openvpn</em></p>
</li>
<li>
<p><a href="https://oreil.ly/Ctm0X">OpenSSL Cookbook</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="13.8 Controlling OpenVPN with systemctl"><div class="sect1" id="idm46466156610408">
<h1>13.8 Controlling OpenVPN with systemctl</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156609400">
<h2>Problem</h2>

<p>You want to<a data-type="indexterm" data-primary="OpenVPN" data-secondary="managing with systemctl" id="idm46466156608056"/><a data-type="indexterm" data-primary="systemctl command" data-secondary="OpenVPN management" id="idm46466156607208"/> manage the OpenVPN daemon like any other daemon, with <em>systemctl</em>, but you
don’t see an OpenVPN unit file. Or, you see an odd-looking unit file like <em>openvpn-server@.service</em>,
and when you try to start it, it throws error messages.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156605944">
<h2>Solution</h2>

<p>The <a data-type="indexterm" data-primary="at sign (@), parameterized unit files" id="idm46466156603560"/><a data-type="indexterm" data-primary="@ (at sign), parameterized unit files" id="idm46466156602600"/><a data-type="indexterm" data-primary="parameterized unit files" id="idm46466156601992"/><a data-type="indexterm" data-primary="unit files, parameterized" id="idm46466156601384"/>ampersand, @, creates a <em>parameterized</em> unit file. This means you can easily create
multiple unit files for the same service by calling different configuration files. For example,
suppose your server configuration file is <em>/etc/openvpn/austin.conf</em>. Your unit file is
<em>openvpn@austin.service</em>, created with <em>systemctl</em>:</p>
<pre class="codeblock-small">$ <strong>sudo systemctl enable openvpn@austin</strong>
Created symlink /etc/systemd/system/multi-user.target.wants/openvpn@austin.service
→ /usr/lib/systemd/system/openvpn@.service.
Created symlink /etc/systemd/system/openvpn.target.wants/openvpn@austin.service
→ /usr/lib/systemd/system/openvpn@.service.</pre>

<p>Note that you do not type the file extension of your OpenVPN <em>.conf</em> file. Now you can
control your OpenVPN daemon with <em>systemctl</em>, just like any other service.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156596168">
<h2>Discussion</h2>

<p>This is a rather ingenious method that gives you the flexibility to create multiple configurations
without having to write multiple unit files. You can “parameterize” any systemd unit file.</p>

<p>You can have multiple tunnels running at the same time on the same machine. Each
configuration requires a different <em>tun</em> device, for example <em>tun0</em>, <em>tun1</em>, <em>tun2</em>,
a different subnet for each tunnel, and a different UDP port. Control all of these tunnels
with different configuration files and their corresponding parameterized unit files.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156593928">
<h2>See Also</h2>

<ul class="less-space-list-2">
<li>
<p><a href="https://oreil.ly/eKbsg">EasyRSA</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ah124">OpenVPN documentation</a></p>
</li>
<li>
<p><a href="https://oreil.ly/2AAEe">systemd.unit</a></p>
</li>
<li>
<p><em>man 8 openvpn</em></p>
</li>
<li>
<p><a href="https://oreil.ly/Ctm0X">OpenSSL Cookbook</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="13.9 Distributing Client Configurations More Easily with .ovpn Files"><div class="sect1" id="rec.ovpn">
<h1>13.9 Distributing Client Configurations More Easily with .ovpn Files</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156581640">
<h2>Problem</h2>

<p>Setting up <a data-type="indexterm" data-primary="OpenVPN" data-secondary="client configurations, distributing" id="openvpn-client-distribute"/><a data-type="indexterm" data-primary="clients" data-secondary="OpenVPN" data-tertiary="distributing configurations" id="client-openvpn-distribute"/><a data-type="indexterm" data-primary=".ovpn files" data-primary-sortas="ovpn files" id="ovpn"/>clients is a fair bit of work, and you want to know if there is a faster way, one
that your users can do themselves without a lot of help.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156575736">
<h2>Solution</h2>

<p>Bundle your client configurations and keys into single files with the <em>.ovpn</em> extension.
All clients, Linux, Windows, macOS, iOS, and Android, can import these.</p>

<p>First create the users’ certificates, then follow this template to create their <em>.ovpn</em> files.
This example builds on the example in <a data-type="xref" href="#rec-vpn-configs">Recipe 13.7</a>. Instead of linking to all their
certificates, copy them into this file. All certificates are in plain text, so all you do is copy the
BEGIN/END portions into the <em>.ovpn</em> file:</p>
<pre>#<i>vpnclient1.ovpn</i>
client
dev tun
proto udp
remote server2 1194

persist-key
persist-tun
resolv-retry infinite
nobind

user nobody
group nobody
tls-client
remote-cert-tls server
verb 4

# ca.crt
&lt;ca&gt;
-----BEGIN CERTIFICATE-----
MIIDSDCCAjCgAwIBAgIUD2UxdEwgvhhr0zq5fAxIDIueB2EwDQYJKoZIhvcNAQEL
BQAwFTETMBEGA1UEAwwKdnBuc2VydmVyMTAeFw0yMTAyMjExODU1MjNaFw0zMTAy
MTkxODU1MjNaMBUxEzARBgNVBAMMCnZwbnNlcnZlcjEwggEiMA0GCSqGSIb3DQEB
AQUAA4IBDwAwggEKAoIBAQDpQJo+Izt8v0zriSWwrChc1tnVj3E3h3XuyEHub7hj
y4bMu2PqKByFNr+iikEF3u0d6HrCRSDKt1BcLzL3TsTJ/hJBHAlTyqEgVce1knjL
2g9NnDbekRtJSJCxS9j+RWtP43Xdg5edb5hTCZqdNFHD8oNuSMGFBbHN4oi9eDXl
rvyVHJe+UkI1Ow6mW0+ln/IoKNFPovz+l+ds3fJ5+UHe2TaQPQc7tGZ33j7wfJQd
es8baFdK+lnmGdUOrW9BQE6ReMSezkz6dKdIZdy7jEs6xoflOzyWlgydmnkAvLnx
MBQDgDUbc5MuooVMAWa4yhtz0B9ZmdJDb8jzHDpTPqdRAgMBAAGjgY8wgYwwHQYD
VR0OBBYEFF8KPhl1xxV0110JiBs5iUEPoJ1IMFAGA1UdIwRJMEeAFF8KPhl1xxV0
110JiBs5iUEPoJ1IoRmkFzAVMRMwEQYDVQQDDAp2cG5zZXJ2ZXIxghQPZTF0TCC+
GGvTOrl8DEgMi54HYTAMBgNVHRMEBTADAQH/MAsGA1UdDwQEAwIBBjANBgkqhkiG
9w0BAQsFAAOCAQEAMnRLz3CBApSrjfUKsWYioNGQGvh77Smh/1hPGIu4eEldQSmZ
Aj7qclEaORdBxmqrVtA3Z9cX1L0xFrg14nLyddmuWHG3ZChc5ZMpYtD2YpOH265B
FFjDp96vK13dpixWKrVpvakLCCA4EvnC8CEjbm0oNFiCgSwKAoJFCcUzwC33swsU
B2w5/iT6CZKuKhSmET1IDpG8krGC/Ib2GNAS0szMI94P0ajZgVznMcXOJ7gUg4rM
sEB8OzM6GBEZTqbAa9uVMZnOZvZA5jGIbBuelUo0bqGdAyx2B68zzuL//qvsHsvw
kZCyKIaXH0NBV7vexMKWcwFLLBzWizFQbbFpFA==
-----END CERTIFICATE-----
&lt;/ca&gt;

# vpnclient1.cert
&lt;cert&gt;
-----BEGIN CERTIFICATE-----
MIIDVjCCAj6gAwIBAgIQLhO4FTrqN5WZiQETULAwnzANBgkqhkiG9w0BAQsFADAV
MRMwEQYDVQQDDAp2cG5zZXJ2ZXIxMB4XDTIxMDIyMTE4NTYzM1oXDTI0MDIwNjE4
NTYzM1owFTETMBEGA1UEAwwKdnBuY2xpZW50MTCCASIwDQYJKoZIhvcNAQEBBQAD
ggEPADCCAQoCggEBALUFYXwk6JW/hRtoMs0Ug5jMcWXsjMUsCz8L8CeXNOs3wQrf
YBWF1TYCLPd2/vwXsvbqCE85IZwjsJ5mEx9YgQ5M1teDkLZqBn8y7VIyDAAU8RsN
NcrnpeMDV0LgZIBeUrHi4ZTooaw4FdJ5BBYRHR1APVaaHDWx59ohJuBDpriWhvWk
lWX0rpSJltXriIOCzky/yEwfw6ah5jWaTgfe41fXq8j3lx2IbgIL7I4//jhC6JYz
N7huTdT2uB2MUbYX0XWBffMG8wcBZtMI2XryZmPvFYWP7N5nZZsBXkLz/UngAu3k
jkYJOnJy/hdOFLN/yXj7VFydmivUSeekdjjxyAECAwEAAaOBoTCBnjAJBgNVHRME
AjAAMB0GA1UdDgQWBBSnLIQoTPLyECbJHfgYBHvQpcmfgzBQBgNVHSMESTBHgBRf
Cj4ZdccVdNddCYgbOYlBD6CdSKEZpBcwFTETMBEGA1UEAwwKdnBuc2VydmVyMYIU
D2UxdEwgvhhr0zq5fAxIDIueB2EwEwYDVR0lBAwwCgYIKwYBBQUHAwIwCwYDVR0P
BAQDAgeAMA0GCSqGSIb3DQEBCwUAA4IBAQBaBpYZXVYUzOcXOVSaijmOZAIVBTeJ
meQz9xBQjqDXaRvypWlQ1gQtO8WnK9ruafc1g/h7LtvqtiALnGiJ0NbshkH8C1KE
yen46UCau5B/Xi0gA7FoPildvYdKSn/jI6KySCsplubjnJK9H/6DjAcEuqFLcsaY
5vpKQGP9Vl7H7hEVs4f1aory1T4Ma/bdXEOqgzHmIARLmxYeJm90sUT/n7e7VXfy
fILZ+8D1fMxCbeQRBkg1e8wJfgEbMRY9aGGt1qAs9gkm9RPelGB18v4iCbyebv3X
4hVHmfjcixdbWiABC7yq/gisooQ0robW/92dgemcwO0awHZX+opNBgwr
-----END CERTIFICATE-----
&lt;/cert&gt;

# vpnclient1.key
&lt;key&gt;
-----BEGIN ENCRYPTED PRIVATE KEY-----
MIIFHDBOBgkqhkiG9w0BBQ0wQTApBgkqhkiG9w0BBQwwHAQInjFvz5a4mY8CAggA
MAwGCCqGSIb3DQIJBQAwFAYIKoZIhvcNAwcECNsxQXxvMpN0BIIEyEZdgFwPnGup
vyhywXR6l6ihvHK2GRczIgH0mFIiwQDgDjZj2YsEnvSA/P3MHplkU/bgv9DJ5j2T
C5wPDmGN4yG1boHx9BQKbXqxGwdz/UcHwmNKur9qnSFrSVEvMDwvum+rmzWuKykf
gkKKBCT1JZ2DWKtjjDNYG9qhBn3S2zYVq311dDuLbBcruvo1UL031sDDYWTpVuuf
zZc0ozng0Nzb35bNkG6Ib+LYLzJi4stxzw0DTFl52lKv++R6xhmqb81IJE3vBs4H
DOutkYfifO1eGqEKksPQRl8n03UVkOtB5pH8VdQeLqEBBaq3qeIfU6FkH9XrPR/E
8VOg9BNpbyuUW7bQu0MzuJ8Ofkjy9K+HHdwFtGPyOatkeaXT/qcKVMvzWcbr8bPc
VncavzXdzo0Sb8FigsKYU1lNjgo00Phd3m0AOfptrweK6ucBds5SmqNrUFXiQ2JA
Ms3LUw4CXBBgvdu5TsA2xLGysip0RPKLyTnUPGnXxbBaaHMv8Jz3XRCrWgZbtAE3
XhE9fKw+ZMEP+2jpC/1mjN/N9VuJfYZEhgA84wzYMu6pt3zPkWZqR6yGTDFEDhvh
OAZYEpqrhe++nxDpuQlpCCl4IndSg9L9oX1ydrvPNHGbRVztd3+r9wr4Ub3fJ1g/
9ckCdanohEymKbjw34HEMmdx+fn5k2T9bLnl8fsYtcESkg04ChON3yOnZFKl6chT
BQ9X2Qmeg7FoawWiUY5o+7OHNKL7QpRt4jXPbXNuXFK9EYvuRzUqubLhL5DdmjuO
Se1vvZg7fT4C8qjYsoCa18idA00EN3ePFFf9AssHCoVW92GiUTTKG+qURCjtNtG6
dnPvxiSf98OBkkjeX3ni0cKdfMGoQTSdEy5GexvfRMF5HJrGO+CWXmqSBsuIlPUe
quqCsPmpaT2Ws/0UU9cKe4qaKjTL7CghtFmUEhH7t6Cd41Ki9gKi33j3541l9w7l
J1bgca4rRUCecp2BPF3IjJc/RnTvHkbUK4mDX9s8xJhYf9WE6JYsk3NBSNNIj/9G
FMJlo71x8H3OAdFzRN5bjV797HByZ+YidZIgGAx2dSko3PQPy7RSxdmzFbxfUvzj
9jcYEu+V9unbtDK2qZ9I+LqXGE+EXjPBui40IWp8XIYNlSLn2qgroH079lXhXKBY
+DzcBzyT7GTX2QeYE+yqqPRIFWHnbnsnD6dMnAa46h+Si+f5sq33rfRsF7UpK4gV
IhzFkncCM47/Taqi0OY04Q40LuSCDjmjFL+VzZOsAtWGRNYNzIgniThEehElJwfI
ErzClcVptjhtCer8BPuO7YaMIHk1hKecHFqw3RrimWzroL1iu9Q29m2oM+bVc6mD
we6r+t8JbaAFxoHBK4i6M0rcdJPICxDTIOjPC3Fg/MeqiCi7F0DFZvXwPGRD+0Of
MBnsDplEUjK06jbE5BjGQ7n7P+dwDxyp/aVO4CfX7ZOco6h9r3b6nqlzPVNE9erw
kS7WwT/TWraw/sfIO9sNSgle7PoRh2s/w/oGVhC6ymlMdXe+mhMzHFnGEbBRh2Rd
kd/EdYNubHg0k9+RLTwbgwZ+176cIJyOpqaoJGv0bsKM8X26Pk/fkyF6xgdQYQOx
8i9Whea8OjUOQAcgc7gUyA==
-----END ENCRYPTED PRIVATE KEY-----
&lt;/key&gt;

# ta.key
&lt;tls-auth&gt;
-----BEGIN OpenVPN Static key V1-----
4eb35b44d1d8a82cfa51af394d4f58f3
69bf8fe8c0a0a032f38b0ee104889628
8a5dc89486736b39d64ad3c6831bf9ba
9f3f96c3307d322a5bf055b9bc3bfa74
929faf361c14de97445f5927794264bb
e3f71c925f2236cfb0109ecfd6406cef
857dfb39783a09ecd56d3cf09ebbc853
0f43b1c787f0db99dbecabcd2090cfbb
54c86d8102a5430fd6a7f37ab5ce8ed9
f6bec8984bde4267f78913ff702dd396
a205b6be9e7ab41cf1ebad3953c27c7c
f3b435345e02aede049ef7c9f1c2704f
2ed91110ccb19d0d3bd46a00f54c73e2
07b31160cdc54c3f5a7989bb999ac5f3
89c6de7e79fc93399924a8d298eab462
231234e690c319d5cbd832788f0dbcfb
-----END OpenVPN Static key V1-----
&lt;/tls-auth&gt;
</pre>

<p>Now you have only one file to distribute to your clients. (See <a data-type="xref" href="#rec-install-openvpn">Recipe 13.1</a> to
learn what to install for Linux, macOS, Windows, iOS, and Android clients.)</p>

<p>The easy way to<a data-type="indexterm" data-primary="NetworkManager" data-secondary="importing .ovpn files" id="networkmanager-ovpn-import"/> import a new <em>.ovpn</em> file in Linux is using NetworkManager. Open
“VPN Connections” → “Add a VPN connection.” This opens
“Choose a VPN Connection Type.” Select “Import a Saved VPN Connection,” click
Create, and find your <em>.ovpn</em> file in the file selector. Review the settings on the General and VPN tabs.</p>

<p>On the General tab, make sure that “All users may connect to this network” is not checked.
This is a simple but important security measure that requires every user to have their own
individual OpenVPN configuration.</p>

<p>On the VPN tab, note that NetworkManager converts the inline certificates to <em>.pem</em>
files (<a data-type="xref" href="#fig-vpn-2">Figure 13-2</a>). This is normal and not a mistake. You can compare these to the originals; click on the little file folder icon to the right to see where the converted files are stored.</p>

<figure><div id="fig-vpn-2" class="figure">
<img src="Images/lcb2_1302.png" alt="Importing .ovpn client configuration file into NetworkManager" width="595" height="658"/>
<h6><span class="label">Figure 13-2. </span>Importing the <em>.ovpn</em> client configuration file into NetworkManager</h6>
</div></figure>

<p>For all other clients, the procedure is similar. Follow their instructions, and if all goes well,
your clients will be up and running in a couple of minutes.</p>

<p>The<a data-type="indexterm" data-primary="NetworkManager" data-secondary="importing .ovpn files" data-startref="networkmanager-ovpn-import" id="idm46466156554520"/> NetworkManager import function also works with client configuration files that are
not inline, like in <a data-type="xref" href="#rec-vpn-configs">Recipe 13.7</a>. In this case the certificates are not converted, and they retain their original filenames.</p>

<p>An inline file may have the <em>.conf</em> extension if you have only Linux <a data-type="indexterm" data-primary="OpenVPN" data-secondary="client configurations, distributing" data-startref="openvpn-client-distribute" id="idm46466156552872"/><a data-type="indexterm" data-primary="clients" data-secondary="OpenVPN" data-tertiary="distributing configurations" data-startref="client-openvpn-distribute" id="idm46466156549416"/><a data-type="indexterm" data-primary=".ovpn files" data-primary-sortas="ovpn files" data-startref="ovpn" id="idm46466156548088"/>clients.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156575192">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/eKbsg">EasyRSA</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ah124">OpenVPN documentation</a></p>
</li>
<li>
<p><em>man 8 openvpn</em></p>
</li>
<li>
<p><a href="https://oreil.ly/Ctm0X">OpenSSL Cookbook</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="13.10 Hardening Your OpenVPN Server"><div class="sect1" id="rec-harden-vpn">
<h1>13.10 Hardening Your OpenVPN Server</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156538968">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="OpenVPN" data-secondary="server hardening" id="openvpn-server-harden"/><a data-type="indexterm" data-primary="servers" data-secondary="OpenVPN" data-tertiary="hardening" id="server-openvpn-harden"/><a data-type="indexterm" data-primary="hardening OpenVPN servers" id="harden-openvpn"/>want to know some options for making your OpenVPN more secure.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156533608">
<h2>Solution</h2>

<p>The OpenVPN default settings are pretty good, but they’re designed for broader
compatibility. There are some changes you can make that will make your server stronger.</p>

<p>The following examples go in both server and client configuration files. These
options maximize the effectiveness of TLS. All SSL and TLS protocols older than TLS 1.2
are deprecated and should not be allowed. Accept only TLS 1.2 or higher:</p>
<pre>tls-version-min 1.2
tls-version-max 1.3 or-highest</pre>

<p>Use a stronger data channel cipher, and enforce its use by disabling cipher negotiation:</p>
<pre>AES-128-GCM
ncp-disable</pre>

<p>There are many changes in TLS 1.3, so you need two different configurations for
TLS 1.2 and 1.3. These are all stronger and more efficient encryption ciphers:</p>
<pre># TLS 1.3
tls-ciphersuites TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
# TLS 1.2
tls-cipher TLS-ECDHE-ECDSA-WITH-CHACHA20-POLY1305-SHA256:TLS-ECDHE-RSA-
WITH-CHACHA20-POLY1305-SHA256:TLS-ECDHE-ECDSA-WITH-AES-128-GCM-SHA256:
TLS-ECDHE-RSA-WITH-AES-128-GCM-SHA256</pre>

<p>Use Elliptic Curve Diffie-Hellman Ephemeral (ECDHE) in place of our old Diffie-Hellman
static keys. You do not have to create a <em>ta.key</em>, as you do in <a data-type="xref" href="#rec-create-pki">Recipe 13.5</a>:</p>
<pre>dh none
ecdh-curve secp384r1
# use tls-server on the server, tls-client on the client
tls-server</pre>

<p>Add the <em>float</em> option, in the server configuration only, to allow clients to roam on different
networks without losing connection, as long they pass all other authentication tests.</p>

<p>The <em>opt-verify</em> option, in the server configuration only, checks for compatibility between
server and client settings, and disconnects clients that do not match.  <em>opt-verify</em> checks
<em>dev-type, link-mtu, tun-mtu, proto, ifconfig, comp-lzo, fragment, keydir, cipher, auth, keysize, secret, no-replay, no-iv, tls-auth, key-method, tls-server</em>, and 
<span class="keep-together"><em>tls-client</em>.</span></p>

<p>See the Discussion for complete example configurations.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156532984">
<h2>Discussion</h2>

<p>Put these enhancements all together in the server configuration:</p>
<pre># <i>vpnserver1.conf</i>
port 1194
proto udp
dev tun
user nobody
group nobody

ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/<i>vpnserver1.crt</i>
key /etc/openvpn/keys/<i>vpnserver1.key</i>

server 10.10.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
keepalive 10 120
persist-key
persist-tun
tls-server

remote-cert-tls client
verify-client-cert require
tls-cert-profile preferred
tls-version-min 1.2
tls-version-max 1.3 or-highest

float
opt-verify
AES-128-GCM
ncp-disable
dh none
ecdh-curve secp384r1

# TLS 1.3
tls-ciphersuites TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
# TLS 1.2
tls-cipher TLS-ECDHE-ECDSA-WITH-CHACHA20-POLY1305-SHA256:TLS-ECDHE-RSA-
WITH-CHACHA20-POLY1305-SHA256:TLS-ECDHE-ECDSA-WITH-AES-128-GCM-SHA256:
TLS-ECDHE-RSA-WITH-AES-128-GCM-SHA256

status openvpn-status.log
verb 4
mute 20
explicit-exit-notify 1</pre>

<p>An example client configuration, using the inline file format (<a data-type="xref" href="#rec.ovpn">Recipe 13.9</a>):</p>
<pre># <i>vpnclient1.conf</i>
client
dev tun
proto udp
remote <i>server1</i> 1194

persist-key
persist-tun
resolv-retry infinite
nobind

user nobody
group nobody
tls-client
remote-cert-tls server
verb 4

# Using inline keys
# ca.crt
&lt;ca&gt;
[...]
&lt;/ca&gt;

# <i>client.crt</i>
&lt;cert&gt;
[...]
&lt;/cert&gt;

# <i>client.key</i>
&lt;key&gt;
[...]
&lt;/key&gt;

tls-version-min 1.2
tls-version-max 1.3 or-highest
AES-128-GCM
ncp-disable
dh none
ecdh-curve secp384r1

# TLS 1.3 encryption settings
tls-ciphersuites TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
# TLS 1.2 encryption settings
tls-cipher TLS-ECDHE-ECDSA-WITH-CHACHA20-POLY1305-SHA256:TLS-ECDHE-RSA-WITH-
CHACHA20-POLY1305-SHA256:TLS-ECDHE-ECDSA-WITH-AES-128-GCM-SHA256:TLS-ECDHE-RSA-
WITH-AES-128-GCM-SHA256

status openvpn-status.log
verb 4
mute 20
explicit-exit-notify 1</pre>

<p>These options strengthen the authentication between client and server, and enforce using
TLS 1.2 and higher. If you’re wondering how to know which ciphers and ciphersuites to use,
I asked some experts. You can lock down your setup even tighter. For example, disallowing
users from saving passwords, adding more restrictions to client-server authentication, using
SELinux, or using a chroot. These are advanced topics not covered <a data-type="indexterm" data-primary="OpenVPN" data-secondary="server hardening" data-startref="openvpn-server-harden" id="idm46466156512088"/><a data-type="indexterm" data-primary="servers" data-secondary="OpenVPN" data-tertiary="hardening" data-startref="server-openvpn-harden" id="idm46466156505272"/><a data-type="indexterm" data-primary="hardening OpenVPN servers" data-startref="harden-openvpn" id="idm46466156511464"/>here.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156510264">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/eKbsg">EasyRSA</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ah124">OpenVPN documentation</a></p>
</li>
<li>
<p><em>man 8 openvpn</em></p>
</li>
<li>
<p><a href="https://oreil.ly/Ctm0X">OpenSSL Cookbook</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="13.11 Configuring Networking"><div class="sect1" id="idm46466156500504">
<h1>13.11 Configuring Networking</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466156499512">
<h2>Problem</h2>

<p>Your<a data-type="indexterm" data-primary="OpenVPN" data-secondary="networking, configuring" id="openvpn-network-config"/><a data-type="indexterm" data-primary="networking" data-secondary="configuring" id="network-config"/><a data-type="indexterm" data-primary="configuring" data-secondary="networking" id="config-network"/><a data-type="indexterm" data-primary="servers" data-secondary="OpenVPN" data-tertiary="networking, configuring" id="server-openvpn-network-config"/> OpenVPN server is running, all of your connection tests work as expected, and now you
need to know how to set up your networking so that remote clients can find your server
and traffic gets routed appropriately.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466156493128">
<h2>Solution</h2>

<p>There is no one-size-fits-all solution. Configuring your networking has to take into account
how your LAN is set up, whether you are connecting individual clients or linking networks,
IPv4, IPv6, how your internet gateway is set up, and lots more. Consult Jan Just Keijser’s excellent
<a href="https://learning.oreilly.com/library/view/openvpn-cookbook-/9781786463128/" class="orm:hideurl"><em>OpenVPN Cookbook</em></a>, 2nd Edition (O’Reilly),
to find the answers you need. This book covers TUN versus TAP,  Windows clients, PAM and LDAP, IPv6, routing, and site-to-site configurations.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466156489224">
<h2>Discussion</h2>

<p>Networking is the most challenging part of running any server, especially an important
security server. It pays to study this and take pains to get it right. The OpenVPN
documentation has a lot of good information on networking as<a data-type="indexterm" data-primary="OpenVPN" data-secondary="networking, configuring" data-startref="openvpn-network-config" id="idm46466156487880"/><a data-type="indexterm" data-primary="networking" data-secondary="configuring" data-startref="network-config" id="idm46466156485272"/><a data-type="indexterm" data-primary="configuring" data-secondary="networking" data-startref="config-network" id="idm46466156491240"/><a data-type="indexterm" data-primary="servers" data-secondary="OpenVPN" data-tertiary="networking, configuring" data-startref="server-openvpn-network-config" id="idm46466156489992"/> well.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466156482856">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/Ah124">OpenVPN documentation</a></p>
</li>
<li>
<p><em>man 8 openvpn</em></p>
</li>
</ul>
</div></section>





</div></section>







</div></section></div></body></html>