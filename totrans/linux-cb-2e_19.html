<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 18. Building an Internet Firewall/Router &#10;on Raspberry Pi"><div class="chapter" id="cha-lan-gateway">
<h1><span class="label">Chapter 18. </span>Building an Internet Firewall/Router 
<span class="keep-together">on Raspberry Pi</span></h1>


<p>The<a data-type="indexterm" data-primary="Pi" data-see="Raspberry Pi" id="idm46466154557832"/><a data-type="indexterm" data-primary="RPi" data-see="Raspberry Pi" id="idm46466154556984"/> Raspberry Pi (RPi) makes a great internet firewall/router for small networks, and
it does not cost a lot of money. You can use any Raspberry Pi, but I recommend the
Raspberry Pi 4B because it is more powerful than the older Pis and is the first Pi with a dedicated gigabit Ethernet port.</p>






<section data-type="sect1" class="orm:non-recipe" data-pdf-bookmark="Overview"><div class="sect1" id="idm46466154555976">
<h1>Overview</h1>

<p>In this chapter you will learn how to install Raspberry Pi OS, connect your Pi
to a computer monitor or TV, use the Raspberry Pi OS recovery mode, run your Pi
headless, add a second Ethernet port, share an internet connection, and use the
Pi for LAN name services.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The examples in this chapter are all on a Raspberry Pi 4 Model B, using the
Raspberry Pi OS. Raspberry Pi OS used to be called Raspbian. Underneath it is
Debian Linux, so if you are accustomed to Debian, Ubuntu, Mint, or any other
Debian variant, it’s the same Linux.</p>
</div>








<section data-type="sect2" class="orm:non-recipe" data-pdf-bookmark="Pros and Cons of a Raspberry Pi Firewall/Router"><div class="sect2" id="idm46466154548824">
<h2>Pros and Cons of a Raspberry Pi Firewall/Router</h2>

<p>The<a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="advantages/disadvantages" id="raspberry-procon"/> Raspberry Pi is a general-purpose computer, not a specialized firewall/router.
It has WiFi, Ethernet, and Bluetooth, and it runs Linux. In comparison, a common choice
for small networks is the small combination firewall/router/wireless access point/
Ethernet switch, like the Linksys AC1900 or the TP-Link Archer AX20. These have
WiFi, gigabit Ethernet, multiple antennas, and support
for “smart” services like Alexa and smartphone administration apps.</p>

<p>The drawback to these devices is their inflexibility, especially limited
storage and operating system support. If you want to replace the vendor software, you must use specialized router distributions like OpenWRT, DD-WRT, pfSense, or OPNsense, which are all excellent, but it is not easy, and you have to find supported devices.</p>

<p>These are some of the advantages Raspberry Pi has over the all-in-one boxes:</p>

<ul>
<li>
<p>Flexibility, just like any general-purpose Linux computer</p>
</li>
<li>
<p>More memory and storage</p>
</li>
<li>
<p>Connects to a computer monitor or TV, keyboard, and mouse</p>
</li>
<li>
<p>Runs a number of Linux distributions, so you can use your existing knowledge
and not have to learn some weird new interface or command set</p>
</li>
<li>
<p>Runs a number of *bsd operating systems, Windows 10, Android, Chromium, and
others</p>
</li>
<li>
<p>Tethers to a mobile hotspot</p>
</li>
<li>
<p>64-bit support</p>
</li>
</ul>

<p>You can run the Raspberry Pi with a graphical desktop, with no graphical desktop,
and headless via SSH, just like any Linux system.</p>

<p>Downsides of Raspberry Pi:</p>

<ul>
<li>
<p>Cannot function as an Ethernet switch, like the all-in-one devices</p>
</li>
<li>
<p>WiFi is not as strong as all-in-one devices</p>
</li>
<li>
<p>Raspberry Pi models 3 and older have poor Ethernet performance because the
Ethernet port shares the USB bus; RPi 4 cures this with a dedicated gigabit
Ethernet port</p>
</li>
</ul>

<p>There are a number <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="operating systems" id="idm46466154534632"/><a data-type="indexterm" data-primary="operating systems for Raspberry Pi" id="idm46466154533784"/>of customized Linux operating systems for Raspberry Pi. The
official operating system is Raspberry Pi OS, which is based on Debian Linux.
SUSE, Ubuntu, Fedora, Arch Linux ARM, and MX Linux have Raspberry Pi variants.
There are also specialized media server and gaming distros. In this chapter we’ll
stick with Raspberry Pi OS because it is optimized for the Pi, and you get a
full graphical desktop with decent performance even on the older RPi models.
Raspberry Pi OS is just like any other Linux, so anything you can do on a big
Linux machine you can do on <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="advantages/disadvantages" data-startref="raspberry-procon" id="idm46466154533176"/>Raspberry Pi.</p>
</div></section>













<section data-type="sect2" class="orm:non-recipe pagebreak-before less_space" data-pdf-bookmark="Hardware Architecture"><div class="sect2" id="idm46466154548360">
<h2>Hardware Architecture</h2>

<p>The<a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="hardware architecture" id="raspberry-architecture"/><a data-type="indexterm" data-primary="hardware architectures" data-secondary="Raspberry Pi" id="hardware-architecture-raspberry"/><a data-type="indexterm" data-primary="Broadcom SoC (system-on-a-chip)" id="broadcom-soc"/> RPi is powered by a Broadcom system-on-a-chip (SoC). The CPU, GPU, and I/O are
all on a single chip. This is especially impressive on the Raspberry Pi 4 Model
B, which supports running two screens at the same time. It handles
high-definition movies without a hiccup.</p>

<p>The Broadcom SoC is an ARM chip, rather than the x86_64 architecture that
dominates the PC market. ARM processors are less complex, using a reduced
instruction set (RISC). x86_64 processors are CISC, complex instruction set
computers. x86_64 processors work a lot harder, are considerably more complex,
and consume more power.</p>
</div></section>













<section data-type="sect2" class="orm:non-recipe" data-pdf-bookmark="Rasberry Pi Banquet of Products"><div class="sect2" id="idm46466154521368">
<h2>Rasberry Pi Banquet of Products</h2>

<p>Every<a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="products available" id="idm46466154519304"/> Raspberry Pi model ever made is still available, including updated releases
of the Raspberry Pi 1, models A and B. The A models are the lower-cost versions
of every release, and the B models cost a little more for more features.</p>

<p>You have many other Pis to choose from, such as:</p>

<ul>
<li>
<p>Raspberry Pi Zero, the smallest Pi for $5</p>
</li>
<li>
<p>Raspberry Pi Zero W includes WiFi, $10</p>
</li>
<li>
<p>Raspberry Pi 400 Personal Computer Kit, a complete system integrated into a
compact keyboard (all you need to add is a display), $100</p>
</li>
</ul>

<p>RPi prices have been stable since the first RPi was released, though of course
this could change.</p>

<p>There is a giant thundering herd of accessories: cases, touchscreens, heat
sinks, fans, breakout boards, hats (expansion boards), all manner of cables and
adapters, motors, cameras, audio boards, little wireless keyboards with
touchpads, gaming emulators, RGB matrices, powered USB hubs, real-time clocks,
tiny displays…it is one of the best playgrounds ever.</p>
</div></section>













<section data-type="sect2" class="orm:non-recipe" data-pdf-bookmark="History and Purpose"><div class="sect2" id="idm46466154517128">
<h2>History and Purpose</h2>

<p>The <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="history and purpose" id="raspberry-history"/><a data-type="indexterm" data-primary="history of Raspberry Pi" id="history-raspberry"/>Raspberry Pi is a real phenomenon. The original intent of its creator, Eben
Upton, was to produce a small and inexpensive computer to encourage young students to study computing, especially students who could not afford to buy a PC. The
first Raspberry Pi, Version 1 Model B, cost about $35. Add a keyboard and mouse,
connect to a TV or monitor, and for less than a tenth the price of a PC you had
a working Linux computer with audio, video, Ethernet, and USB. The open hardware
design, combined with open source software, encourages hacking and learning.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The Broadcom chipsets that power the Pi are not open. This has been a point of
contention since the first Pi was released. The schematics are open, available
on <a href="https://raspberrypi.org" class="orm:hideurl">RaspberryPi.org</a>, and the operating system and BIOS are open source. In my moderately humble opinion, a completely open source platform is preferable and would be great, and having something that works and is available now is better than not having something that works and is available now.</p>
</div>

<p>The first Raspberry Pi was an immediate success, selling over 500,000 units in
the first 6 months after its release in February 2012. Since then around
30 million Raspberry Pis have been sold. The current version, Version 4 Model B,
is a significant upgrade, the most powerful model yet, featuring:</p>

<ul>
<li>
<p>2 USB 2 ports</p>
</li>
<li>
<p>2 USB 3 ports</p>
</li>
<li>
<p>2 micro HDMI ports, supporting 2 4K displays</p>
</li>
<li>
<p>1 dedicated gigabit Ethernet port</p>
</li>
<li>
<p>Supports RAM from 2 GB–8 GB</p>
</li>
<li>
<p>Broadcom BCM2711, 1.5 GHz Quad-core Cortex-A72 (ARM v8) 64-bit SoC</p>
</li>
<li>
<p>2.4 GHz and 5.0 GHz IEEE 802.11ac WiFi</p>
</li>
<li>
<p>Bluetooth</p>
</li>
<li>
<p>40-pin GPIO header</p>
</li>
</ul>

<p>Compared to modern Intel and AMD CPUs, these specs are far from bragworthy, but
it’s enough horsepower to run a Linux graphical desktop, play music, movies,
surf the web, write documents…it is quite capable for its size and price.</p>

<p>The Raspberry Pi is developed and produced by the Raspberry Pi Foundation, a
registered nonprofit charity. The foundation supports numerous education projects
for teachers and students; visit <a href="https://raspberrypi.org"><em class="hyperlink">https://raspberrypi.org</em></a> for
current educational materials and<a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="history and purpose" data-startref="raspberry-history" id="idm46466154496232"/><a data-type="indexterm" data-primary="history of Raspberry Pi" data-startref="history-raspberry" id="idm46466154497832"/> information.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="18.1 Starting and Shutting Down Raspberry Pi"><div class="sect1" id="idm46466154494216">
<h1>18.1 Starting and Shutting Down Raspberry Pi</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154493352">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="startup/shutdown" id="raspberry-startstop"/><a data-type="indexterm" data-primary="starting" data-secondary="Raspberry Pi" id="start-raspberry"/><a data-type="indexterm" data-primary="stopping" data-secondary="Raspberry Pi" id="stop-raspberry"/> don’t see a power switch on your Raspberry Pi (RPi), and you want to turn it on
and off.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154488008">
<h2>Solution</h2>

<p>Power it up by plugging in the power connector. Shut it down from the menu in
your operating system, then unplug it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154486440">
<h2>Discussion</h2>

<p>When you shut down your RPi, you have to disconnect and then reconnect the power
to start it up again.</p>

<p>It wouldn’t surprise me if there is a power switch out there somewhere made for
the RPi, though I have not seen one. One alternative is to plug it into a
switched<a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="startup/shutdown" data-startref="raspberry-startstop" id="idm46466154484824"/><a data-type="indexterm" data-primary="starting" data-secondary="Raspberry Pi" data-startref="start-raspberry" id="idm46466154483784"/><a data-type="indexterm" data-primary="stopping" data-secondary="Raspberry Pi" data-startref="stop-raspberry" id="idm46466154481768"/> power strip.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154479768">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://raspberrypi.org"><em class="hyperlink">https://raspberrypi.org</em></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="18.2 Finding Hardware and How-Tos"><div class="sect1" id="idm46466154476296">
<h1>18.2 Finding Hardware and How-Tos</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154475320">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="hardware requirements" id="raspberry-hardware-req"/><a data-type="indexterm" data-primary="hardware requirements for Raspberry Pi" id="hardware-req-raspberry"/>bought a Raspberry Pi 4 Model B, and you want to know what other hardware
devices you need in order to use it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154471688">
<h2>Solution</h2>

<p>Presumably you already have a computer monitor or TV, mouse, and keyboard. You
also need:</p>

<ul>
<li>
<p>Raspberry Pi power supply</p>
</li>
<li>
<p>HDMI-to-micro-HDMI cable</p>
</li>
<li>
<p>Micro SD card of at least 16 GB</p>
</li>
<li>
<p>Cooling fan, or heat sinks on the CPU, RAM module, and USB controller</p>
</li>
<li>
<p>Case</p>
</li>
<li>
<p>Micro SD card reader</p>
</li>
</ul>

<p>Start by installing Raspberry Pi OS to your micro SD card on another
computer. While that is running, assemble your hardware. When everything is ready,
connect the power and watch your new system boot up. (See Recipes <a data-xrefstyle="select:labelnumber" data-type="xref" href="#rec-install-pi">18.4</a>
and <a data-xrefstyle="select:labelnumber" data-type="xref" href="#rec-install-noobs">18.5</a> to learn how to install Raspberry Pi OS.)</p>

<p>To learn all about RPi, there are numerous sources of schematics, specifications,
how-tos, and clever ideas. The “See Also” section of this recipe lists a nice selection to get you started.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154461000">
<h2>Discussion</h2>

<p>If your display does not have an HDMI port, see <a data-type="xref" href="#rec-no-hdmi">Recipe 18.6</a>.</p>

<p>You may use any micro SD card at least 16 GB in size. High-speed cards make a
noticeable performance improvement. 16 GB is pretty small, and you can use as
large a card as you like.</p>

<p>The RPi 4B has three RAM options, 2 GB, 4 GB, and 8 GB. It is not upgradable,
so whatever you buy is what you will have. 2 GB is more than enough for an
internet gateway, and using your Pi as a lightweight Linux desktop. More
memory is good for multimedia processing, compiling code, games, and other
memory-intensive tasks.</p>

<p>The RPi 4B is quite a bit more powerful than older Pis, and it runs hotter than
older versions. See <a data-type="xref" href="#cooling-rpi">Recipe 18.3</a> to learn how to keep it cool.</p>

<p>With 4 USB ports, the RPi 4B has a lot of flexibility. You can use standard USB
keyboards and mice, a keyboard with a trackpad, and USB-to-PS/2 adapters for older
keyboards and mice. You can attach a USB hard drive for more storage or backups,
and any other USB devices just like on a big computer. The 40-pin GPIO header
supports attaching nearly any expansion board.</p>

<p>There are many nice kits that bundle everything you need to get started. My
favorite store is <a href="https://adafruit.com">Adafruit.com</a>, and you can find many
more listed<a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="hardware requirements" data-startref="raspberry-hardware-req" id="idm46466154449400"/><a data-type="indexterm" data-primary="hardware requirements for Raspberry Pi" data-startref="hardware-req-raspberry" id="idm46466154448136"/> on <a href="https://raspberrypi.org"><em class="hyperlink">https://raspberrypi.org</em></a>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154451960">
<h2>See Also</h2>

<p>These <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="tutorials" id="idm46466154447432"/><a data-type="indexterm" data-primary="tutorials for Raspberry Pi" id="idm46466154446584"/>sites publish excellent Raspberry Pi tutorials:</p>

<ul>
<li>
<p><a href="https://oreil.ly/Ji4j2">The Raspberry Pi Foundation</a></p>
</li>
<li>
<p><a href="https://oreil.ly/5qwn5">Adafruit</a></p>
</li>
<li>
<p><a href="https://oreil.ly/EuMY7">MagPi</a></p>
</li>
<li>
<p><a href="https://oreil.ly/5KY5B">Hackspace</a></p>
</li>
<li>
<p><a href="https://oreil.ly/NQcB0">Maker Pro</a></p>
</li>
<li>
<p><a href="https://oreil.ly/foZqS">Makezine</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="18.3 Cooling the Raspberry Pi"><div class="sect1" id="cooling-rpi">
<h1>18.3 Cooling the Raspberry Pi</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154435816">
<h2>Problem</h2>

<p>Your<a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="cooling" id="idm46466154434408"/><a data-type="indexterm" data-primary="cooling" data-secondary="Raspberry Pi" id="idm46466154433560"/> Raspberry Pi feels hot to the touch, and you want to install some kind of
cooling for it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154432296">
<h2>Solution</h2>

<p>Install a cooling fan in the case, or heat sinks on the CPU, RAM module, and USB
controller. Install a fan and heat sinks on the Raspberry Pi 4, which runs hotter
than older Pis.</p>

<p>Use the built-in <em>vcgencmd</em> command to<a data-type="indexterm" data-primary="vcgencmd command" id="idm46466154429800"/> measure CPU temperatures before and after
installing cooling devices, and before and after running computationally intensive
tasks such as compiling code or playing videos. The following example is a fanless
board at idle with the case lid removed, and then after five minutes of playing
a movie at 1080p:</p>
<pre>$ <strong>vcgencmd measure_temp</strong>
temp=48.3'C

$ <strong>vcgencmd measure_temp</strong>
temp=61.9'C</pre>

<p>This example shows the effect of a cooling fan when playing the same movie:</p>
<pre>$ <strong>vcgencmd measure_temp</strong>
temp=52.1'C</pre>

<p>The temperature should not go over 70°C. 40°C to 60°C is a good operating range.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154425272">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/Ji4j2">The Raspberry Pi Foundation</a></p>
</li>
<li>
<p><a href="https://oreil.ly/5qwn5">Adafruit</a></p>
</li>
<li>
<p><a href="https://oreil.ly/EuMY7">MagPi</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="18.4 Installing Raspberry Pi OS with Imager and dd"><div class="sect1" id="rec-install-pi">
<h1>18.4 Installing Raspberry Pi OS with Imager and dd</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154417880">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="operating systems" data-tertiary="installing" id="raspberry-ops-install"/><a data-type="indexterm" data-primary="operating systems for Raspberry Pi" data-secondary="installing" id="ops-raspberry-install"/><a data-type="indexterm" data-primary="installing" data-secondary="Raspberry Pi OS" id="install-raspberry"/><a data-type="indexterm" data-primary="Imager, installing Raspberry Pi" id="Imager-install-raspberry"/><a data-type="indexterm" data-primary="dd command" id="dd-install-raspberry"/>have your hardware, and you want to install the operating system.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154409928">
<h2>Solution</h2>

<p>You will create a bootable micro SD card on another computer, then load the SD
card into your Raspberry Pi and start it up.</p>

<p>There are four ways to get a bootable SD card:</p>

<ul>
<li>
<p>Use the Raspberry Pi Imager (currently only for <em>.deb</em> systems such as Debian,
Ubuntu, or Mint)</p>
</li>
<li>
<p>Use the NOOBS installer (<a data-type="xref" href="#rec-install-noobs">Recipe 18.5</a>)</p>
</li>
<li>
<p>Copy your installation image to your micro SD card with the <em>dd</em>
command</p>
</li>
<li>
<p>Buy a micro SD card with the installer already loaded</p>
</li>
</ul>

<p>I favor NOOBs because it works on all Linuxes, and it creates a rescue boot mode.</p>

<p>To install the Raspberry Pi Imager from the <em>.deb</em> package, download it from
<a href="https://raspberrypi.org"><em class="hyperlink">https://raspberrypi.org</em></a>. Then install the package:</p>
<pre>$ <strong>sudo dpkg -i <i>imager_1.5_amd64.deb</i></strong></pre>

<p>Alternatively, Ubuntu users can install the Raspberry Pi Imager with <em>apt</em>:</p>
<pre>$ <strong>sudo apt install rpi-imager</strong></pre>

<p>Plug your SD card into your computer. Locate it with <em>lsblk -p</em> (see
<a data-type="xref" href="ch10.xhtml#rec-lsblk-hardware">Recipe 10.9</a>).</p>

<p>Start the Raspberry Pi Imager from your system menu, and enjoy its cheery raspberry
logo. Click Operating System to select the operating system you want
to install, and the Imager will download it and copy it to your SD card. If you
have already downloaded an image, scroll down the selection menu to Use Custom
to select your downloaded image. You will see a screen like <a data-type="xref" href="#fig-rpi-1">Figure 18-1</a>.</p>

<figure class="width-80"><div id="fig-rpi-1" class="figure">
<img src="Images/lcb2_1801.png" alt="Creating a bootable micro SD card with Raspberry Pi Imager" width="682" height="361"/>
<h6><span class="label">Figure 18-1. </span>Creating a bootable micro SD card with Raspberry Pi Imager</h6>
</div></figure>

<p>Click SD Card to select the device, and then click Write to install the operating

<span class="keep-together">system</span>.</p>

<p>If you don’t have an Ubuntu system, download your chosen operating system image
from <a href="https://raspberrypi.org"><em class="hyperlink">https://raspberrypi.org</em></a> and use the <em>dd</em> command to
copy it to your SD card. 
<span class="keep-together">The following</span> example unzips and copies
<em>2021-03-24-raspios-buster-armhf.zip</em> to the 
<span class="keep-together">SD card:</span></p>
<pre>$ <strong>sudo unzip -p 2021-03-24-raspios-buster-armhf.zip | \
  sudo dd of=/dev/<i>foo</i> bs=4M conv=fsync status=progress</strong></pre>

<p>When the SD card is ready, insert it in your Raspberry Pi and power it
on. When it boots up, you will complete a short setup, and then it is ready to use.</p>

<p>The default user is <em>pi</em>. Look in <em>/home/pi/Bookshelf</em> for a PDF copy of <em>The Official Raspberry Pi Beginner’s Guide</em>  by Gareth Halfacree (Raspberry Pi Press).</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154381832">
<h2>Discussion</h2>

<p>You do not have to format your SD card before copying with <em>dd</em>.</p>

<p>The imager <a data-type="indexterm" data-primary="partitions" data-secondary="in Raspberry Pi" data-secondary-sortas="Raspberry Pi" id="idm46466154380088"/>creates two partitions: a 256 MB FAT32 <em>/boot</em> partition, and an Ext4
<em>rootfs</em> partition just big enough to hold the filesystem. On my test system
that is 3.4 GB, and the rest of the card is unallocated space.</p>

<p>When you boot up your new system for the first time, the root filesystem is
expanded to fill all the unallocated space. You may shrink the root filesystem
and create more partitions<a data-type="indexterm" data-primary="Imager, installing Raspberry Pi" data-startref="Imager-install-raspberry" id="idm46466154375016"/><a data-type="indexterm" data-primary="dd command" data-startref="dd-install-raspberry" id="idm46466154374168"/> with GParted (<a data-type="xref" href="ch09.xhtml#cha-partitioning-gparted">Chapter 9</a>) or <em>parted</em>
(<a data-type="xref" href="ch08.xhtml#cha-partitioning-parted">Chapter 8</a>).</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154372328">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/Ji4j2">The Raspberry Pi Foundation</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="18.5 Installing Raspberry Pi with NOOBS"><div class="sect1" id="rec-install-noobs">
<h1>18.5 Installing Raspberry Pi with NOOBS</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154367704">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="NOOBS" data-secondary="installing Raspberry Pi" id="NOOBS"/> want to use NOOBS to install Raspberry Pi.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154364984">
<h2>Solution</h2>

<p>NOOBS (New Out Of the Box Software) is an older installer. It works on all Linux
distributions and creates a recovery boot mode, which Raspberry Pi Imager does

<span class="keep-together">not do.</span></p>

<p>Download NOOBS on another computer, unzip the download archive, copy all of its
files to a micro SD card, then load the SD card into your Raspberry Pi
and start it up.</p>

<p>Download NOOBS from <a href="https://raspberrypi.org"><em class="hyperlink">https://raspberrypi.org</em></a>.
There are two versions: NOOBS and NOOBS Lite. NOOBS includes Raspberry Pi OS, and
a network installer for other operating systems. NOOBS Lite includes only the
network installer.</p>

<p>Unpack NOOBS after downloading:</p>
<pre>$ <strong>unzip <i>NOOBS_lite_v3_5.zip</i></strong></pre>

<p>Plug your SD card into your computer. Locate it with <em>lsblk -p</em> (see
<a data-type="xref" href="ch10.xhtml#rec-lsblk-hardware">Recipe 10.9</a>).</p>

<p>Format your micro SD card as a single FAT32 partition.</p>

<p>Copy all the NOOBS files to your SD card, then use it to boot your Raspberry Pi.
First you will see a cool rainbow colored screen, then NOOBS boots to the
installation menu (<a data-type="xref" href="#fig-rpi-8">Figure 18-2</a>). Set up networking to use the network installer
or to get updates after installation. Select your operating system, then go find
something to do until it is finished.</p>

<figure><div id="fig-rpi-8" class="figure">
<img src="Images/lcb2_1802.png" alt="NOOBS installation screen." width="735" height="618"/>
<h6><span class="label">Figure 18-2. </span>NOOBS installation screen</h6>
</div></figure>

<p>After installation is complete, you will go through a brief setup process, and
then your Raspberry Pi is ready to use.</p>

<p>The default user is <em>pi</em>. Look in <em>/home/pi/Bookshelf</em> for a PDF copy of <em>The Official Raspberry Pi Beginner’s Guide</em>  by Gareth Halfacree (Raspberry Pi Press).</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154364104">
<h2>Discussion</h2>

<p>NOOBS is a simple unzip and copy, so it works on any computer.</p>

<p>Copying the NOOBS files to your SD card can take a long time. Usually it is faster
to copy the ZIP file to the SD card, then unzip it on the card. You can delete the
ZIP file after <a data-type="indexterm" data-primary="NOOBS" data-secondary="installing Raspberry Pi" data-startref="NOOBS" id="idm46466154348664"/><a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="operating systems" data-tertiary="installing" data-startref="raspberry-ops-install" id="idm46466154347000"/><a data-type="indexterm" data-primary="operating systems for Raspberry Pi" data-secondary="installing" data-startref="ops-raspberry-install" id="idm46466154345480"/><a data-type="indexterm" data-primary="installing" data-secondary="Raspberry Pi OS" data-startref="install-raspberry" id="idm46466154344168"/>installation.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154342488">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch09.xhtml#cha-partitioning-gparted">Chapter 9</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ji4j2">The Raspberry Pi Foundation</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="18.6 Connecting to a Video Display Without HDMI"><div class="sect1" id="rec-no-hdmi">
<h1>18.6 Connecting to a Video Display Without HDMI</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154336792">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="video connections" id="raspberry-video"/><a data-type="indexterm" data-primary="video connections for Raspberry Pi" id="video-raspberry"/><a data-type="indexterm" data-primary="HDMI connections, Raspberry Pi video without" id="hdmi-raspberry-video"/><a data-type="indexterm" data-primary="composite video on Raspberry Pi" id="comp-video-raspberry"/>have a TV or computer monitor that does not have HDMI ports, and you want to
connect your Raspberry Pi to it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154331224">
<h2>Solution</h2>

<p>There are four ways to connect a screen to the RPi 4B. You can use:</p>

<ul>
<li>
<p>Small screens made for the Raspberry Pi</p>
</li>
<li>
<p>DVI-to-HDMI adapter</p>
</li>
<li>
<p>VGA-to-HDMI adapter</p>
</li>
<li>
<p>RCA composite video (use cables made for Raspberry Pi)</p>
</li>
</ul>

<p>There is quite a variety of screens made for the RPi: touchscreens, LED, LCD,
OLED, eInk—you name it, there is probably an RPi version. Follow the installation
instructions that come with the screen.</p>

<p>The DVI-to-HDMI and VGA-to-HDMI adapters connect to your screen, and then your
HDMI-to-micro-HDMI cable connects to the adapter. When you connect to a single
HDMI display on the RPi 4B, plug into the HDMI 0 port, which is the one closest
to the power port.</p>

<p>Composite video requires some extra steps on the RPi 4B because it is disabled by
default. The easy way is to find an HDMI screen to use when you boot your Pi for
the first time and complete your installation. After your installation is
complete, open the configuration tool to enable composite video:</p>
<pre>$ <strong>sudo raspi-config</strong></pre>

<p>Arrow-key down to 6 Advanced Options, then select A8 HDMI/Composite. Select V2
Enable Composite. Exit <em>raspi-config</em>, shut down your Pi, connect your Pi to
your composite video screen, then start it up again. It should default to your
composite video screen.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154319688">
<h2>Discussion</h2>

<p>Older flat-panel screens usually have VGA and composite video connectors, so you
could use either composite video or a VGA-to-HDMI adapter. Technically, HDMI
delivers a higher-quality image than composite video, but most people cannot tell
the difference.</p>

<p><a data-type="xref" href="#fig-rpi-4">Figure 18-3</a> shows a Rocketfish DVI-to-HDMI adapter, a composite cable bundle,
a Rasberry Pi 4B in a CanaKit case with the top removed, and a micro SD card.</p>

<figure><div id="fig-rpi-4" class="figure">
<img src="Images/lcb2_1803.png" alt="Raspberry Pi 4B with accessories" width="800" height="592"/>
<h6><span class="label">Figure 18-3. </span>Raspberry Pi 4B with accessories</h6>
</div></figure>

<p>The RCA composite audio/video cable set, the one with the yellow, red, and white
connectors, plugs into the nifty little 3.5 mm TRRS port on the RPi. You need one
made for the RPi because there is no standard for how the TRRS plug is ordered.
You might find some that don’t work as they are supposed to, which is yellow for
video, and red and white for audio. Avoid composite cables made for camcorders
and MP3 players, which have their own weird ordering that puts the ground ring in
the wrong place. The TRRS (tip-ring-ring-sleeve) plug should be configured like
this:</p>
<pre>Tip          Ring 1        Ring 2   Sleeve
Left audio   Right audio   Ground   Video</pre>

<p>There are several options for tweaking your composite video settings in
<em>/boot/config.txt</em>. If you plan to use composite video, use the NOOBS installer.
Then if you need to correct its settings, you can boot to recovery mode
(<a data-type="xref" href="Images/#rec-recovery-mode">Recipe 18.7</a>) and have access to <em>/boot/config.txt</em>.</p>

<p><em>sdtv_mode=</em> sets the TV standard. <em>sdtv_mode=0</em> is the default for
North America. Most of the world uses PAL; see <a data-type="xref" href="#table18-1">Table 18-1</a> for the settings.</p>
<table id="table18-1">
<caption><span class="label">Table 18-1. </span>sdtv_mode settings</caption>
<thead>
<tr>
<th>value</th>
<th>mode</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>0</p></td>
<td><p>Normal NTSC (default)</p></td>
</tr>
<tr>
<td><p>1</p></td>
<td><p>Japanese version of NTSC</p></td>
</tr>
<tr>
<td><p>2</p></td>
<td><p>Normal PAL</p></td>
</tr>
<tr>
<td><p>3</p></td>
<td><p>Brazilian version of PAL</p></td>
</tr>
<tr>
<td><p>16</p></td>
<td><p>Progressive scan NTSC</p></td>
</tr>
<tr>
<td><p>18</p></td>
<td><p>Progressive scan PAL</p></td>
</tr>
</tbody>
</table>

<p><em>sdtv_aspect=</em> command defines the <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="video connections" data-startref="raspberry-video" id="idm46466154295624"/><a data-type="indexterm" data-primary="video connections for Raspberry Pi" data-startref="video-raspberry" id="idm46466154294536"/><a data-type="indexterm" data-primary="HDMI connections, Raspberry Pi video without" data-startref="hdmi-raspberry-video" id="idm46466154293688"/><a data-type="indexterm" data-primary="composite video on Raspberry Pi" data-startref="comp-video-raspberry" id="idm46466154292840"/>aspect ratio (<a data-type="xref" href="#table18-2">Table 18-2</a>).</p>
<table id="table18-2">
<caption><span class="label">Table 18-2. </span>sdtv_aspect screen ratio settings</caption>
<thead>
<tr>
<th>value</th>
<th>ratio</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>1</p></td>
<td><p>4:3 (default)</p></td>
</tr>
<tr>
<td><p>2</p></td>
<td><p>14:9</p></td>
</tr>
<tr>
<td><p>3</p></td>
<td><p>16:9</p></td>
</tr>
</tbody>
</table>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154321032">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/yp7Mu">Video options in config.txt</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="18.7 Booting into Recovery Mode"><div class="sect1" id="rec-recovery-mode">
<h1>18.7 Booting into Recovery Mode</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154277864">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="booting into recovery mode" id="raspberry-boot-recovery"/><a data-type="indexterm" data-primary="booting" data-secondary="Raspberry Pi into recovery mode" id="boot-raspberry-recovery"/><a data-type="indexterm" data-primary="recovery mode, booting Raspberry Pi" id="recovery-boot-raspberry"/><a data-type="indexterm" data-primary="NOOBS" data-secondary="booting into recovery mode" id="NOOBS-boot-recovery"/>want to know how to boot into recovery mode in case you ever have problems.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154271624">
<h2>Solution</h2>

<p>You must have installed your operating system with NOOBS because that is the
only installer that sets up a recovery mode. Power on your Pi and watch
your startup screen. A screen with the Raspberry Pi logo and a “For recovery mode,
hold Shift” message appears briefly. Press and hold the shift key until the
recovery screen appears (<a data-type="xref" href="#fig-rpi-8">Figure 18-2</a>; the recovery screen is the same as the NOOBS installation screen).</p>

<p>The recovery screen is a nice graphical utility for performing some basic
operations. You can connect to the internet, browse the online help, edit the
<em>/boot/cinfig.txt</em>, or blow away your installation and install something
else.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154266968">
<h2>Discussion</h2>

<p>The recovery screen is the same as the NOOBS installation screen. You have this
recovery option only when you install Raspberry Pi with NOOBS, though by the time you read this it could be different.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154263640">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/Ji4j2">The Raspberry Pi Foundation</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="18.8 Adding a Second Ethernet Interface"><div class="sect1" id="idm46466154262632">
<h1>18.8 Adding a Second Ethernet Interface</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154261640">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="multiple Ethernet ports" id="raspberry-ethernet"/><a data-type="indexterm" data-primary="Ethernet ports, adding to Raspberry Pi" id="ethernet-raspberry"/><a data-type="indexterm" data-primary="multiple Ethernet ports, adding to Raspberry Pi" id="multiple-ethernet-raspberry"/>want to use your Raspberry Pi as an internet firewall/router, but it has only
one Ethernet port, and you really want two Ethernet ports.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154256984">
<h2>Solution</h2>

<p>There are two ways to get a second Ethernet port: with a USB-to-Ethernet
adapter or by installing an Ethernet port that connects to the GPIO pins.</p>

<p>USB-to-Ethernet is easy; just plug it in.</p>

<p class="pagebreak-before less_space">A wired Ethernet port is a little more work. You need an Ethernet adapter powered
by an ENC28J60 Ethernet controller module (<a data-type="xref" href="#fig-rpi-6">Figure 18-4</a>).</p>

<figure><div id="fig-rpi-6" class="figure">
<img src="Images/lcb2_1804.png" alt="ENC28J60 Ethernet adapter." width="1200" height="784"/>
<h6><span class="label">Figure 18-4. </span>ENC28J60 Ethernet adapter</h6>
</div></figure>

<p>The HanRun HR911105A adapter in the photo needs seven female-to-female jumper wires
to connect to the GPIO pins. You can buy multicolor bundles that supply an
assortment of wires for cheap.</p>

<p>Before connecting the wires, generate your own handy pinout diagram by running
the <em>pinout</em> command <a data-type="indexterm" data-primary="pinout command" id="idm46466154249560"/>on your Raspberry Pi (<a data-type="xref" href="#fig-rpi-9">Figure 18-5</a>).</p>

<p><a data-type="xref" href="#fig-rpi-10">Figure 18-6</a> shows the diagram from RaspberryPi.org numbers and labels the GPIO pinouts.</p>

<figure class="width-60"><div id="fig-rpi-9" class="figure">
<img src="Images/lcb2_1805.png" alt="Pinout diagram generated by pinout command." width="426" height="905"/>
<h6><span class="label">Figure 18-5. </span>Pinout diagram generated by pinout command</h6>
</div></figure>

<figure><div id="fig-rpi-10" class="figure">
<img src="Images/lcb2_1806.png" alt="Pinout diagram from raspberrypi.org." width="1825" height="984"/>
<h6><span class="label">Figure 18-6. </span>Pinout diagram from RaspberryPi.org</h6>
</div></figure>

<p>Edit <em>/boot/config.txt</em> to enable the new Ethernet port and load the drivers:</p>
<pre>dtparam=spi=on
dtoverlay=enc28j60</pre>

<p>Keep a copy of the pinout diagram available and power off your Raspberry Pi.
Connect the jumper wires in the following locations on your RPi and ENC28J60 module:</p>
<pre>RPi           ENC28J60
----------------------------
+3V3          VCC
GPIO10        SI
GPIO9         SO
GPIO11        SCK
GND           GND

GPIO25        INT
CE0#/GPIO8    CS</pre>

<p>Note the orientation of the GPIO pins: pin #1 is on the same end of the RPi board
as the SD card slot. Start with 3V3 pin 17, then all of your wires are in the
same area, and the other 3V3 pin is free for a case fan.</p>

<p>When all of the wires are in place, power up your RPi. Run <em>ifconfig</em> to <a data-type="indexterm" data-primary="ifconfig command" id="idm46466154236488"/>see
your new Ethernet interface. It should be <em>eth1</em>:</p>
<pre>$ <strong>ip link show dev eth1</strong>
2: eth1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc fq_codel
state DOWN mode DEFAULT group default qlen 1000
    link/ether d0:50:99:82:e7:2b brd ff:ff:ff:ff:ff:ff</pre>

<p>There it is, all ready to be configured.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154256408">
<h2>Discussion</h2>

<p>The ENC28J60 Ethernet controller supports only 10 MBps. If your internet
speeds are no better 10 MBps, then this is fine. On the Raspberry Pi 4 you will
get as much as 900 MBps with a USB 3.0 Ethernet adapter.</p>

<p>Older Raspberry Pis have slower Ethernet because it runs over the USB 2.0
bus. The RPi 4B is the first Pi to have a dedicated Ethernet bus.</p>

<p>Keep an eye on new product releases for dual gigabit Ethernet options, as there
are likely to be some soon.</p>

<p>The <em>pinout</em> command is<a data-type="indexterm" data-primary="pinout command" id="idm46466154232456"/> provided by the <em>python3-gpiozero</em> package. This is
installed by default in the Raspberry Pi OS desktop image, but not on Raspberry
Pi OS Lite. Install it<a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="multiple Ethernet ports" data-startref="raspberry-ethernet" id="idm46466154231512"/><a data-type="indexterm" data-primary="Ethernet ports, adding to Raspberry Pi" data-startref="ethernet-raspberry" id="idm46466154228696"/><a data-type="indexterm" data-primary="multiple Ethernet ports, adding to Raspberry Pi" data-startref="multiple-ethernet-raspberry" id="idm46466154227784"/> with <em>apt install python3-gpiozero</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154226360">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/0pgXZ">GPIO diagram</a></p>
</li>
<li>
<p><a href="https://oreil.ly/HjlAM">Technical information and datasheet for ENC28J60 controller</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="18.9 Setting Up an Internet Connection Sharing Firewall with firewalld"><div class="sect1" id="idm46466154221560">
<h1>18.9 Setting Up an Internet Connection Sharing Firewall with firewalld</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154220344">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="internet-sharing firewall on" id="raspberry-firewall"/><a data-type="indexterm" data-primary="internet-sharing firewall on Raspberry Pi" id="internet-firewall-raspberry"/><a data-type="indexterm" data-primary="firewalld" data-secondary="internet sharing with Raspberry Pi" id="firewalld-internet-raspberry"/><a data-type="indexterm" data-primary="firewalls" data-secondary="on Raspberry Pi" data-secondary-sortas="Raspberry Pi" id="firewall-raspberry"/> want to configure a simple firewall on your Raspberry Pi that
shares your internet connection and keeps the bad bits out.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154213656">
<h2>Solution</h2>

<p>We will use <em>firewalld</em> to filter incoming packets, allowing only responses
to traffic that originated from inside the LAN and disallowing external connection
requests.</p>

<p>Your internet gateway setup looks something like <a data-type="xref" href="#fig-rpi-3">Figure 18-7</a>.</p>

<figure><div id="fig-rpi-3" class="figure">
<img src="Images/lcb2_1807.png" alt="Raspberry Pi firewall/router" width="532" height="75"/>
<h6><span class="label">Figure 18-7. </span>Raspberry Pi firewall/router</h6>
</div></figure>

<p>The big bad internet comes in through whatever device connects you to your ISP,
which connects to your Raspberry Pi, which filters and routes traffic to your LAN
through an Ethernet switch.</p>

<p>You need two network interfaces on your RPi, one that connects from your internet
box to the RPi, and a second interface to connect your RPi to your LAN.
In this recipe we will use two Ethernet interfaces.</p>

<p>Install <em>firewalld</em>, and optionally <em>firewall-config</em> and <em>firewall-applet</em>.
<em>firewall-config</em> provides<a data-type="indexterm" data-primary="firewall-config interface" id="idm46466154204984"/><a data-type="indexterm" data-primary="firewall-applet interface" id="idm46466154204488"/> a graphical configuration tool, and <em>firewall-applet</em>
sits in the panel and provides quick access to some commands, such as the panic
button and lockdown:</p>
<pre>$ <strong>sudo apt install firewalld firewall-config firewall-applet</strong></pre>

<p>Find your default router/gateway:</p>
<pre>$ <strong>ip r show</strong>
default via 192.168.1.1 dev eth0 proto dhcp src 192.168.1.43 metric 303 mtu 1500
192.168.1.0/24 dev eth0 proto dhcp scope link src 192.168.1.43 metric 303 mtu
1500cat</pre>

<p><em>default via 192.168.1.1</em> is your default gateway.</p>

<p>Make <em>eth1</em> the external interface by connecting it to your internet box. <em>eth0</em>
is your internal interface, connected to your LAN switch. The two
interfaces should be on different subnets. <em>eth1</em> should be on the same subnet
as your internet box. Suppose the LAN interface of your internet box is
192.168.1.1, then <em>eth1</em> could be 192.168.1.2.</p>

<p><em>eth0</em> is on your LAN subnet, for example, 192.168.2.1.</p>

<p>Configure the two interfaces in <em>/etc/dhcpcd.conf</em>:</p>
<pre># external interface
interface eth1
static ip_address=192.168.1.2/24
static routers=192.168.1.1

# internal interface
interface eth0
static ip_address=192.168.2.1/24
static routers=192.168.1.1
</pre>

<p>Reboot to apply the changes.</p>

<p>The next step is to set up <em>firewalld</em>. The two interfaces must be in two
different firewall zones. <em>eth1</em> goes in the <em>external</em> zone, and <em>eth0</em> goes in
the <em>internal</em> zone, then verify your changes:</p>
<pre>$ <strong>sudo firewall-cmd --zone=external --change-interface=eth1</strong>
success
pi@raspberrypi:~ $ <strong>sudo firewall-cmd --zone=internal --change-interface=eth0</strong>
success
pi@raspberrypi:~ $ <strong>sudo firewall-cmd --get-active-zones</strong>
external
  interfaces: eth1
internal
  interfaces: eth0</pre>

<p>List the configuration for each zone:</p>
<pre>$ <strong>sudo firewall-cmd --zone=external --list-all</strong>
external (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth1
  sources:
  services: ssh
  ports:
  protocols:
  masquerade: yes
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:

$ <strong>sudo firewall-cmd --zone=internal --list-all</strong>
internal (active)
  target: default
  icmp-block-inversion: no
  interfaces: eth0 wlan0
  sources:
  services: dhcpv6-client mdns samba-client ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:</pre>

<p>Note that <em>ssh</em> access is the default for the external zone. You may add or remove
any services that you wish. You must leave <em>masquerade</em> enabled because this is
what enables internet access.</p>

<p>Make your changes permanent:</p>
<pre>$ <strong>sudo firewall-cmd --runtime-to-permanent</strong>
success
</pre>

<p>IPv4 forwarding is also enabled by default in the <em>external</em> zone, which you can
verify by reading <em>/proc</em>. IPv4 forwarding enables routing; otherwise, all the
packets entering your RPi would not be routed to other hosts on your network.</p>
<pre>$ <strong>cat /proc/sys/net/ipv4/ip_forward</strong>
1</pre>

<p>1 means it is enabled, 0 is not enabled.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154179688">
<h2>Discussion</h2>

<p>IPv4 masquerading<a data-type="indexterm" data-primary="IPv4 masquerading" id="idm46466154212312"/><a data-type="indexterm" data-primary="NAT (network address translation)" id="idm46466154178888"/><a data-type="indexterm" data-primary="network address translation (NAT)" id="idm46466154178280"/> is network address translation, or NAT. NAT was created to
extend the limited pool of IPv4 addresses (which is officially exhausted). NAT
allows us to freely use the private IPv4 address spaces on our internal networks
without having to purchase public IPv4 addresses. Your internet provider gives you
at least one public IPv4 address. Your private addresses are translated to appear
as your one public IPv4 address; otherwise, your internal hosts would have no
internet access.</p>

<p>You can add and remove services from your <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="internet-sharing firewall on" data-startref="raspberry-firewall" id="idm46466154176280"/><a data-type="indexterm" data-primary="internet-sharing firewall on Raspberry Pi" data-startref="internet-firewall-raspberry" id="idm46466154175192"/><a data-type="indexterm" data-primary="firewalld" data-secondary="internet sharing with Raspberry Pi" data-startref="firewalld-internet-raspberry" id="idm46466154174280"/><a data-type="indexterm" data-primary="firewalls" data-secondary="on Raspberry Pi" data-secondary-sortas="Raspberry Pi" data-startref="firewall-raspberry" id="idm46466154173000"/>zones; see <a data-type="xref" href="ch14.xhtml#cha-firewalld">Chapter 14</a>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154170408">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch14.xhtml#cha-firewalld">Chapter 14</a></p>
</li>
<li>
<p><a href="https://oreil.ly/SuHLL">Debian Bug report logs - #914694</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="18.10 Running Your Raspberry Pi Headless"><div class="sect1" id="idm46466154165768">
<h1>18.10 Running Your Raspberry Pi Headless</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154164600">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="running headless" id="raspberry-headless"/><a data-type="indexterm" data-primary="headless Raspberry Pi" id="headless-raspberry"/><a data-type="indexterm" data-primary="raspi-config" id="raspi-config"/>are using your Raspberry Pi as an internet firewall/router, LAN router, or
some kind of lightweight LAN server, and you want to reduce the load by running it
without a graphical desktop.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154160152">
<h2>Solution</h2>

<p>Follow these steps:</p>
<ol>
<li>
<p>Set up SSH access on your RPi (<a data-type="xref" href="ch12.xhtml#cha-ssh">Chapter 12</a>).</p>
</li>
<li>
<p>Run <em>raspi-config</em> to disable the graphical desktop.</p>
</li>
<li>
<p>Reboot.</p>
</li>
<li>
<p>Launch <em>sudo raspi-config</em>, then navigate to 1 System Options →
S5 Boot / Auto Login (see <a data-type="xref" href="#fig-rpi-5">Figure 18-8</a>).</p>
</li>
<li>
<p>Set the next boot to console, not GUI, then reboot.</p>
</li>

</ol>

<p>As long as you can open an SSH session to your RPi, you will be able to access
it without a screen.</p>

<p>You can launch your graphical environment from the text console by typing the
<strong><code>startx</code></strong> command.</p>

<figure><div id="fig-rpi-5" class="figure">
<img src="Images/lcb2_1808.png" alt="Set the next boot to console, no GUI" width="700" height="407"/>
<h6><span class="label">Figure 18-8. </span>Set the next boot to console, not GUI</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154146424">
<h2>Discussion</h2>

<p><em>rpi-config</em> uses<a data-type="indexterm" data-primary="ncurses interface" id="idm46466154144808"/> the <em>ncurses</em> interface. <em>ncurses</em> is a console interface that
looks like a simple GUI.</p>

<p>When you run the Raspberry Pi headless, it needs only power and network
connections, because you control it over an SSH session from another<a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="running headless" data-startref="raspberry-headless" id="idm46466154142984"/><a data-type="indexterm" data-primary="headless Raspberry Pi" data-startref="headless-raspberry" id="idm46466154141624"/><a data-type="indexterm" data-primary="raspi-config" data-startref="raspi-config" id="idm46466154140776"/> computer.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154138856">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch12.xhtml#cha-ssh">Chapter 12</a></p>
</li>
<li>
<p><a href="https://oreil.ly/Ji4j2">The Raspberry Pi Foundation</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="18.11 Building a DNS/DHCP Server with Raspberry Pi"><div class="sect1" id="idm46466154134264">
<h1>18.11 Building a DNS/DHCP Server with Raspberry Pi</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154133416">
<h2>Problem</h2>

<p>Your <a data-type="indexterm" data-primary="name resolution" data-secondary="with Raspberry Pi" data-secondary-sortas="Raspberry Pi" id="nameres-raspberry"/><a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="name resolution with" id="raspberry-nameres"/><a data-type="indexterm" data-primary="DNS (Domain Name System)" data-secondary="with Raspberry Pi" data-secondary-sortas="Raspberry Pi" id="dns-raspberry"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="with Raspberry Pi" data-secondary-sortas="Raspberry Pi" id="dhcp-raspberry"/>internet box does not offer much in the way of administration features, and
you want control of your local name services, DNS and DHCP.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154126184">
<h2>Solution</h2>

<p>Disable the name services on your internet box, and set up a second Raspberry Pi
to provide your LAN name services with Dnsmasq (<a data-type="xref" href="ch16.xhtml#cha-dns-dhcp">Chapter 16</a>).
Use DHCP to supply all services and addresses to your LAN hosts, including static
addresses, except for your internet gateway, which should be independent of any
internal services.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154124968">
<h2>Discussion</h2>

<p>You could install your name server on your internet firewall/gateway, but it is
not a good security practice to put internal services on a host that is directly
connected to the internet. Your Raspberry Pi DNS/DHCP server needs only a single
network interface, like any other LAN <a data-type="indexterm" data-primary="name resolution" data-secondary="with Raspberry Pi" data-secondary-sortas="Raspberry Pi" data-startref="nameres-raspberry" id="idm46466154122024"/><a data-type="indexterm" data-primary="Raspberry Pi" data-secondary="name resolution with" data-startref="raspberry-nameres" id="idm46466154120296"/><a data-type="indexterm" data-primary="DNS (Domain Name System)" data-secondary="with Raspberry Pi" data-secondary-sortas="Raspberry Pi" data-startref="dns-raspberry" id="idm46466154119048"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="with Raspberry Pi" data-secondary-sortas="Raspberry Pi" data-startref="dhcp-raspberry" id="idm46466154117560"/>server.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154115592">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch16.xhtml#cha-dns-dhcp">Chapter 16</a></p>
</li>
</ul>
</div></section>





</div></section>







</div></section></div></body></html>