<html><head></head><body><section data-pdf-bookmark="Chapter 14. Self Awareness" data-type="chapter" epub:type="chapter"><div class="chapter" id="SelfAwareness">&#13;
<h1><span class="label">Chapter 14. </span>Self Awareness</h1>&#13;
&#13;
&#13;
<p>Some<a data-primary="Self Awareness" data-type="indexterm" id="slfawr14"/> applications need to be self-aware and require information about themselves. The <em>Self Awareness</em> pattern describes the Kubernetes <em>downward API</em> that provides a simple mechanism for introspection and metadata injection to applications.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect1"><div class="sect1" id="idm45902092431472">&#13;
<h1>Problem</h1>&#13;
&#13;
<p>For<a data-primary="problems" data-secondary="metadata injection, mechanism for introspection and" data-type="indexterm" id="idm45902092430144"/><a data-primary="application introspection mechanisms" data-type="indexterm" id="idm45902092429104"/><a data-primary="introspection mechanisms" data-type="indexterm" id="idm45902092428368"/><a data-primary="metadata, injecting" data-type="indexterm" id="idm45902092427680"/> the majority of use cases, cloud native applications are stateless and disposable without an identity relevant to other applications. However, sometimes even these kinds of applications need to have information about themselves and the environment they are running in. That may include information known only at runtime, such as the<a data-primary="Pods" data-secondary="metadata and" data-type="indexterm" id="idm45902092426880"/> Pod name, Pod IP address, and the hostname on which the application is placed. Or, other static information defined at Pod level such as the specific resource requests and limits, or some dynamic information such as annotations and labels that could be altered by the user at runtime.</p>&#13;
&#13;
<p>For example, depending on the resources made available to the container, you may want to tune the application thread-pool size, or change the garbage collection algorithm or memory allocation. You may want to use the Pod name and the hostname while logging information, or while sending metrics to a central server. You may want to discover other Pods in the same namespace with a specific label and join them into a clustered application. For these and other use cases, Kubernetes provides the downward API.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Solution" data-type="sect1"><div class="sect1" id="idm45902092425168">&#13;
<h1>Solution</h1>&#13;
&#13;
<p>The requirements that we’ve described and the following solution are not specific only to containers but are present in any dynamic environment where the metadata of resources changes. For example, AWS offers Instance Metadata and User Data services that can be queried from any EC2 instance to retrieve metadata about the EC2 instance itself. Similarly, AWS ECS provides APIs that can be queried by the containers and retrieve information about the container cluster.</p>&#13;
&#13;
<p>The Kubernetes approach is even more elegant and easier to use. The<a data-primary="downward API" data-type="indexterm" id="idm45902092422784"/>  <em>downward API</em> allows you to pass metadata about the Pod to the containers and the cluster through environment variables and files. These are the same mechanisms we used for passing application-related data from ConfigMaps and Secrets. But in this case, the data is not created by us. Instead, we specify the keys that interest us, and Kubernetes populates the values dynamically. <a data-type="xref" href="#img-introspector">Figure 14-1</a> gives an overview of how the downward API injects resource and runtime information into interested Pods.</p>&#13;
&#13;
<figure class="width-70"><div class="figure" id="img-introspector">&#13;
<img alt="Application introspection mechanisms" src="assets/kup2_1401.png"/>&#13;
<h6><span class="label">Figure 14-1. </span>Application introspection mechanisms</h6>&#13;
</div></figure>&#13;
&#13;
<p>The main point here is that with the downward API, the metadata is injected into your Pod and made available locally. The application does not need to use a client and interact with the Kubernetes API and can remain Kubernetes-agnostic. Let’s see how easy it is to request metadata through environment variables in <a data-type="xref" href="#ex-downward-api">Example 14-1</a>.</p>&#13;
<div class="less_space pagebreak-before" data-type="example" id="ex-downward-api">&#13;
<h5><span class="label">Example 14-1. </span>Environment variables from downward API</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">&#13;
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w">&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="nt">spec</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">k8spatterns/random-generator:1.0</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">env</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">POD_IP</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">valueFrom</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">fieldRef</code><code class="p">:</code><code class="w">                         </code><a class="co" href="#callout_self_awareness_CO1-1" id="co_self_awareness_CO1-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">          </code><code class="nt">fieldPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">status.podIP</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">MEMORY_LIMIT</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">valueFrom</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">        </code><code class="nt">resourceFieldRef</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">          </code><code class="nt">containerName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w"> </code><a class="co" href="#callout_self_awareness_CO1-2" id="co_self_awareness_CO1-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="w">          </code><code class="nt">resource</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">limits.memory</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_self_awareness_CO1-1" id="callout_self_awareness_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The environment variable <code>POD_IP</code> is set from the properties of this Pod and comes into existence at Pod startup time.</p></dd>&#13;
<dt><a class="co" href="#co_self_awareness_CO1-2" id="callout_self_awareness_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The environment variable <code>MEMORY_LIMIT</code> is set to the value of the memory resource limit of this container; the actual limit declaration is not shown here.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>In this example, we use <code>fieldRef</code> to access Pod-level metadata. The keys shown in <a data-type="xref" href="#table-downward-api-field-ref">Table 14-1</a> are available for <code>fieldRef.fieldPath</code> both as environment variables and <code>downwardAPI</code> volumes.</p>&#13;
<table id="table-downward-api-field-ref">&#13;
<caption><span class="label">Table 14-1. </span>Downward API information available in <code>fieldRef.fieldPath</code></caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Name</th>&#13;
<th>Description</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>spec.nodeName</code></p></td>&#13;
<td><p>Name of node hosting the Pod</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>status.hostIP</code></p></td>&#13;
<td><p>IP address of node hosting the Pod</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>metadata.name</code></p></td>&#13;
<td><p>Pod name</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>metadata.namespace</code></p></td>&#13;
<td><p>Namespace in which the Pod is running</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>status.podIP</code></p></td>&#13;
<td><p>Pod IP address</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>spec.serviceAccountName</code></p></td>&#13;
<td><p>ServiceAccount that is used for the Pod</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>metadata.uid</code></p></td>&#13;
<td><p>Unique ID of the Pod</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>metadata.labels['<em>key</em>']</code></p></td>&#13;
<td><p>Value of the Pod’s label <em>key</em></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>metadata.annotations['<em>key</em>']</code></p></td>&#13;
<td><p>Value of the Pod’s annotation <em>key</em></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>As with <code>fieldRef</code>, we use <code>resourceFieldRef</code> to access metadata specific to a container’s resource specification belonging to the Pod. This metadata is specific to a container and is specified with <code>resourceFieldRef.container</code>. When used as an environment variable, by default the current container is used. Possible keys for <code>resourceFieldRef.resource</code> are shown in <a data-type="xref" href="#table-downward-api-resourcefield-ref">Table 14-2</a>. Resource declarations are explained in <a data-type="xref" data-xrefstyle="chap-num-title" href="ch02.html#PredictableDemands">Chapter 2, “Predictable Demands”</a>.</p>&#13;
<table id="table-downward-api-resourcefield-ref">&#13;
<caption><span class="label">Table 14-2. </span>Downward API information available in <code>resourceFieldRef.resource</code></caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Name</th>&#13;
<th>Description</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>requests.cpu</code></p></td>&#13;
<td><p>A container’s CPU request</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>limits.cpu</code></p></td>&#13;
<td><p>A container’s CPU limit</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>requests.memory</code></p></td>&#13;
<td><p>A container’s memory request</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>limits.memory</code></p></td>&#13;
<td><p>A container’s memory limit</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>requests.hugepages-&lt;size&gt;</code></p></td>&#13;
<td><p>A container’s hugepages request (e.g., <code>requests.hugepages-1Gi</code>)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>limits.hugepages-&lt;size&gt;</code></p></td>&#13;
<td><p>A container’s hugepages limit (e.g., <code>limits.hugepages-1Gi</code>)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>requests.ephemeral-storage</code></p></td>&#13;
<td><p>A container’s ephemeral-storage request</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>limits.ephemeral-storage</code></p></td>&#13;
<td><p>A container’s ephemeral-storage limit</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>A user can change certain metadata such as labels and annotations while a Pod is running. Unless the Pod is restarted, environment variables will not reflect such a change. But <code>downwardAPI</code> volumes can reflect updates to labels and annotations. In addition to the individual fields described previously, <code>downwardAPI</code> volumes can capture all Pod labels and annotations into files with <code>metadata.labels</code> and <code>metadata.annotations</code> references. <a data-type="xref" href="#ex-downward-api-2">Example 14-2</a> shows how such volumes can be used.</p>&#13;
<div class="less_space" data-type="example" id="ex-downward-api-2">&#13;
<h5><span class="label">Example 14-2. </span>Downward API through volumes</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">&#13;
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w">&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="nt">spec</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">k8spatterns/random-generator:1.0</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">random-generator</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pod-info</code><code class="w">                 </code><a class="co" href="#callout_self_awareness_CO2-1" id="co_self_awareness_CO2-1"><img alt="1" src="assets/1.png"/></a><code class="w">&#13;
</code><code class="w">      </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/pod-info</code><code class="w">&#13;
</code><code class="w">  </code><code class="nt">volumes</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pod-info</code><code class="w">&#13;
</code><code class="w">    </code><code class="nt">downwardAPI</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="nt">items</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">labels</code><code class="w">                 </code><a class="co" href="#callout_self_awareness_CO2-2" id="co_self_awareness_CO2-2"><img alt="2" src="assets/2.png"/></a><code class="w">&#13;
</code><code class="w">        </code><code class="nt">fieldRef</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">          </code><code class="nt">fieldPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">metadata.labels</code><code class="w">&#13;
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">annotations</code><code class="w">            </code><a class="co" href="#callout_self_awareness_CO2-3" id="co_self_awareness_CO2-3"><img alt="3" src="assets/3.png"/></a><code class="w">&#13;
</code><code class="w">        </code><code class="nt">fieldRef</code><code class="p">:</code><code class="w">&#13;
</code><code class="w">          </code><code class="nt">fieldPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">metadata.annotations</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_self_awareness_CO2-1" id="callout_self_awareness_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Values from the downward API can be mounted as files into the Pod.</p></dd>&#13;
<dt><a class="co" href="#co_self_awareness_CO2-2" id="callout_self_awareness_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The file <code>labels</code> contain all labels, line by line, in the format <code>name=value</code>. This file gets updated when labels are changing.</p></dd>&#13;
<dt><a class="co" href="#co_self_awareness_CO2-3" id="callout_self_awareness_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The <code>annotations</code> file holds all annotations in the same format as the labels.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>With volumes, if the metadata changes while the Pod is running, it is reflected in the volume files. But it is still up to the consuming application to detect the file change and read the updated data accordingly. If such a functionality is not implemented in the application, a Pod restart still might be required.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect1"><div class="sect1" id="idm45902092114944">&#13;
<h1>Discussion</h1>&#13;
&#13;
<p>Often, an application needs to be self-aware and have information about itself and the environment in which it is running. Kubernetes provides nonintrusive mechanisms for introspection and metadata injection. One of the downsides of the downward API is that it offers a fixed number of keys that can be referenced. If your application needs more data, especially about other resources or cluster-related metadata, it has to be queried on the API Server. This technique is used by many applications that query the API Server to discover other Pods in the same namespace that have certain labels or annotations. Then the application may form a cluster with the discovered Pods and sync state. It is also used by monitoring applications to discover Pods of interest and then start instrumenting them.</p>&#13;
&#13;
<p>Many client libraries are available for different languages to interact with the Kubernetes API Server to obtain more self-referring information that goes beyond what the downward API provides.<a data-primary="" data-startref="slfawr14" data-type="indexterm" id="idm45902092113232"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="More Information" data-type="sect1"><div class="sect1" id="idm45902092058128">&#13;
<h1>More Information</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/fHu1O">Self Awareness Example</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/iCwPr">AWS EC2: Instance Metadata and User Data</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/qe2Gc">Expose Pod Information to Containers Through Files</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/bZrtR">Expose Pod Information to Containers Through Environment Variables</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/Jh4zf">Downward API: Available Fields</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section></body></html>