<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 5. Indexes"><div class="chapter" id="chapter_d1e5128"><h1><span class="label">Chapter 5. </span>Indexes</h1><p>This chapter introduces MongoDB indexes. Indexes enable you to perform
  queries efficiently. They’re an important part of application development
  and are even required for certain types of queries. In this chapter we will
  cover:</p><ul><li><p>What indexes are and why you’d want to use them</p></li><li><p>How to choose which fields to index</p></li><li><p>How to enforce and evaluate index usage</p></li><li><p>Administrative details on creating and removing indexes</p></li></ul><p>As you’ll see, choosing the right indexes for your collections is
  critical to <span class="keep-together">performance</span>.</p><section data-type="sect1" data-pdf-bookmark="Introduction to Indexes"><div class="sect1" id="sect1_d1e5151"><h1>Introduction to Indexes</h1><p>A<a data-type="indexterm" data-primary="indexes" data-secondary="purpose of" id="idm45882379035000"/> database index is similar to a book’s index. Instead of
    looking through the whole book, the database takes a shortcut and just
    looks at an ordered list with references to the content. This allows
    MongoDB to query orders of magnitude faster.</p><p>A<a data-type="indexterm" data-primary="collection scans, versus indexes" id="idm45882379033208"/><a data-type="indexterm" data-primary="indexes" data-secondary="versus collection&#10;        scans" id="idm45882379032280"/> query that does not use an index is called a
    <em>collection scan</em>, which means that the server has to
    “look through the whole book” to find a query’s results. This process is
    basically what you’d do if you were looking for information in a book
    without an index: you’d start at page 1 and read through the whole thing.
    In general, you want to avoid making the server do collection scans
    because the process is very slow for large collections.</p><p>Let’s<a data-type="indexterm" data-primary="indexes" data-secondary="example of" id="idm45882379029944"/> look at an example. To get started, we’ll create a
    collection with 1 million documents in it (or 10 million or 100 million,
    if you have the patience):</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="k">for</code> <code class="p">(</code><code class="nx">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="nx">i</code><code class="o">&lt;</code><code class="mi">1000000</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="p">...</code>     <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">insertOne</code><code class="p">(</code>
<code class="p">...</code>         <code class="p">{</code>
<code class="p">...</code>              <code class="s2">"i"</code> <code class="o">:</code> <code class="nx">i</code><code class="p">,</code> 
<code class="p">...</code>              <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user"</code><code class="o">+</code><code class="nx">i</code><code class="p">,</code>
<code class="p">...</code>              <code class="s2">"age"</code> <code class="o">:</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code><code class="o">*</code><code class="mi">120</code><code class="p">),</code> 
<code class="p">...</code>              <code class="s2">"created"</code> <code class="o">:</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">()</code>
<code class="p">...</code>         <code class="p">}</code>
<code class="p">...</code>     <code class="p">);</code>
<code class="p">...</code> <code class="p">}</code></pre><p>Then we’ll look at the differences in performance for queries on
    this collection, first without an index and then with an index.</p><p>If we do a query on this collection, we can use the <code class="function">explain</code> command<a data-type="indexterm" data-primary="explain command" id="idm45882378946280"/> to see what MongoDB is doing when it executes the query.
    The preferred way to use the <code class="function">explain</code>
    command is through the cursor helper method that wraps this command.
    The<a data-type="indexterm" data-primary="cursors" data-secondary="explain cursor method" id="idm45882378944616"/><a data-type="indexterm" data-primary="queries" data-secondary="explain cursor method" id="idm45882378943512"/><a data-type="indexterm" data-primary="CRUD (create, read, update, and delete)" data-secondary="explain cursor method" id="idm45882378942408"/> <code class="function">explain</code> cursor method
    provides information on the execution of a variety of CRUD operations.
    This method may be run in several verbosity modes. We’ll look at
    <code class="varname">executionStats</code> mode<a data-type="indexterm" data-primary="executionStats mode" id="idm45882378939624"/> since this helps us understand the effect of using an index
    to satisfy queries. Try querying on a specific username to see an
    example:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"username"</code><code class="o">:</code> <code class="s2">"user101"</code><code class="p">}).</code><code class="nx">explain</code><code class="p">(</code><code class="s2">"executionStats"</code><code class="p">)</code>
<code class="p">{</code>
    <code class="s2">"queryPlanner"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"plannerVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"namespace"</code> <code class="o">:</code> <code class="s2">"test.users"</code><code class="p">,</code>
        <code class="s2">"indexFilterSet"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"parsedQuery"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"$eq"</code> <code class="o">:</code> <code class="s2">"user101"</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"winningPlan"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"COLLSCAN"</code><code class="p">,</code>
            <code class="s2">"filter"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"$eq"</code> <code class="o">:</code> <code class="s2">"user101"</code>
                <code class="p">}</code>
            <code class="p">},</code>
            <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code>
        <code class="p">},</code>
        <code class="s2">"rejectedPlans"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
    <code class="p">},</code>
    <code class="s2">"executionStats"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"executionSuccess"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
        <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"executionTimeMillis"</code> <code class="o">:</code> <code class="mi">419</code><code class="p">,</code>
        <code class="s2">"totalKeysExamined"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"totalDocsExamined"</code> <code class="o">:</code> <code class="mi">1000000</code><code class="p">,</code>
        <code class="s2">"executionStages"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"COLLSCAN"</code><code class="p">,</code>
            <code class="s2">"filter"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"$eq"</code> <code class="o">:</code> <code class="s2">"user101"</code>
                <code class="p">}</code>
            <code class="p">},</code>
            <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"executionTimeMillisEstimate"</code> <code class="o">:</code> <code class="mi">375</code><code class="p">,</code>
            <code class="s2">"works"</code> <code class="o">:</code> <code class="mi">1000002</code><code class="p">,</code>
            <code class="s2">"advanced"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"needTime"</code> <code class="o">:</code> <code class="mi">1000000</code><code class="p">,</code>
            <code class="s2">"needYield"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"saveState"</code> <code class="o">:</code> <code class="mi">7822</code><code class="p">,</code>
            <code class="s2">"restoreState"</code> <code class="o">:</code> <code class="mi">7822</code><code class="p">,</code>
            <code class="s2">"isEOF"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"invalidates"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
            <code class="s2">"docsExamined"</code> <code class="o">:</code> <code class="mi">1000000</code>
        <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"serverInfo"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"eoinbrazil-laptop-osx"</code><code class="p">,</code>
        <code class="s2">"port"</code> <code class="o">:</code> <code class="mi">27017</code><code class="p">,</code>
        <code class="s2">"version"</code> <code class="o">:</code> <code class="s2">"4.0.12"</code><code class="p">,</code>
        <code class="s2">"gitVersion"</code> <code class="o">:</code> <code class="s2">"5776e3cbf9e7afe86e6b29e22520ffb6766e95d4"</code>
    <code class="p">},</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p><a data-type="xref" href="#sect1_d1e5527">“explain Output”</a> will explain the output fields; for
    now you can ignore almost all of them. For this example, we want to look
    at the nested document that is the value of the
    <code class="varname">"executionStats"</code> field. In this document,
    <code class="varname">"totalDocsExamined"</code> is the number of documents MongoDB
    looked at while trying to satisfy the query, which, as you can see, is
    every document in the collection. That is, MongoDB had to look through
    every field in every document. This took nearly half a second to
    accomplish on my laptop (the <code class="varname">"executionTimeMillis"</code>
    field shows the number of milliseconds it took to execute the
    query).</p><p>The <code class="varname">"nReturned"</code> field of the
    <code class="varname">"executionStats"</code> document shows the number of results
    returned: <code>1</code>, which makes sense because
    there is only one user with the username <code class="varname">"user101"</code>.
    Note that MongoDB had to look through every document in the collection for
    matches because it did not know that usernames are unique.</p><p>To<a data-type="indexterm" data-primary="queries" data-secondary="enabling efficient" id="idm45882378651528"/> enable MongoDB to respond to queries efficiently,
    all<a data-type="indexterm" data-primary="query patterns" data-secondary="defined" id="idm45882378650264"/> <span class="firstterm">query patterns</span> in your application
    should be supported by an index. By query patterns, we simply mean the
    different types of questions your application asks of the database. In
    this example, we queried the <em>users</em> collection by
    username. That is an example of a specific query pattern. In many
    applications, a single index will support several query patterns. We will
    discuss tailoring indexes to query patterns in a later section.</p><section data-type="sect2" data-pdf-bookmark="Creating an Index"><div class="sect2" id="idm45882378647432"><h2>Creating an Index</h2><p>Now<a data-type="indexterm" data-primary="indexes" data-secondary="basic operations" data-tertiary="creating" id="Icreate05"/> let’s try creating an index on the <code>"username"</code> field. To create an index, we’ll
      use the <code class="function">createIndex</code> collection
      method:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"createdCollectionAutomatically"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"numIndexesBefore"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"numIndexesAfter"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>Creating<a data-type="indexterm" data-primary="indexes" data-secondary="basic operations" data-tertiary="checking build progress" id="idm45882378641112"/> the index should take no longer than a few seconds,
      unless you made your collection especially large. If the <code class="function">createIndex</code> call does not return after a few
      seconds, run <code class="function">db.currentOp()</code> (in a
      different shell) or check your <em class="filename">mongod</em>’s log to see the index build’s
      progress.</p><p>Once the index build is complete, try repeating the original
      query:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"username"</code><code class="o">:</code> <code class="s2">"user101"</code><code class="p">}).</code><code class="nx">explain</code><code class="p">(</code><code class="s2">"executionStats"</code><code class="p">)</code>
<code class="p">{</code>
    <code class="s2">"queryPlanner"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"plannerVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"namespace"</code> <code class="o">:</code> <code class="s2">"test.users"</code><code class="p">,</code>
        <code class="s2">"indexFilterSet"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"parsedQuery"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"$eq"</code> <code class="o">:</code> <code class="s2">"user101"</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"winningPlan"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
            <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                <code class="p">},</code>
                <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"username_1"</code><code class="p">,</code>
                <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"[\"user101\", \"user101\"]"</code>
                    <code class="p">]</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"rejectedPlans"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
    <code class="p">},</code>
    <code class="s2">"executionStats"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"executionSuccess"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
        <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"executionTimeMillis"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"totalKeysExamined"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"totalDocsExamined"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"executionStages"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
            <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"executionTimeMillisEstimate"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"works"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"advanced"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"needTime"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"needYield"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"saveState"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"restoreState"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"isEOF"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"invalidates"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"docsExamined"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"alreadyHasObj"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"executionTimeMillisEstimate"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"works"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                <code class="s2">"advanced"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"needTime"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"needYield"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"saveState"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"restoreState"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"isEOF"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"invalidates"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                <code class="p">},</code>
                <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"username_1"</code><code class="p">,</code>
                <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"[\"user101\", \"user101\"]"</code>
                    <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"keysExamined"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"seeks"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"dupsTested"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"dupsDropped"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"seenInvalidated"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"serverInfo"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"eoinbrazil-laptop-osx"</code><code class="p">,</code>
        <code class="s2">"port"</code> <code class="o">:</code> <code class="mi">27017</code><code class="p">,</code>
        <code class="s2">"version"</code> <code class="o">:</code> <code class="s2">"4.0.12"</code><code class="p">,</code>
        <code class="s2">"gitVersion"</code> <code class="o">:</code> <code class="s2">"5776e3cbf9e7afe86e6b29e22520ffb6766e95d4"</code>
    <code class="p">},</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>This <code class="function">explain</code> output is more
      complex, but for now you can continue to ignore all the fields other
      than <code class="varname">"nReturned"</code>,
      <code class="varname">"totalDocsExamined"</code>, and
      <code class="varname">"executionTimeMillis"</code> in the
      <code class="varname">"executionStats"</code> nested document. As you can see, the
      query is now almost instantaneous and, even better, has a similar
      runtime when querying, for example, for any username:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code>  <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"username"</code><code class="o">:</code> <code class="s2">"user999999"</code><code class="p">}).</code><code class="nx">explain</code><code class="p">(</code><code class="s2">"executionStats"</code><code class="p">)</code></pre><p>An<a data-type="indexterm" data-primary="indexes" data-secondary="benefits and drawbacks of" id="idm45882378091368"/> index can make a dramatic difference in query times.
      However, indexes have their price: write operations (inserts, updates,
      and deletes) that modify an indexed field will take longer. This is
      because in addition to updating the document, MongoDB has to update
      indexes when your data changes. Typically, the tradeoff is worth it. The
      tricky part becomes figuring out which fields to index.</p><div data-type="tip"><h6>Tip</h6><p>MongoDB’s indexes work almost identically to typical relational
        database indexes, so if you are familiar with those, you can just skim
        this section for syntax specifics.</p></div><p>To<a data-type="indexterm" data-primary="indexes" data-secondary="basic operations" data-tertiary="choosing fields to index" id="idm45882378088744"/> choose which fields to create indexes for, look through
      your frequent queries and queries that need to be fast and try to find a
      common set of keys from those. For instance, in the preceding example,
      we were querying on <code class="varname">"username"</code>. If that were a
      particularly common query or were becoming a bottleneck, indexing
      <code class="varname">"username"</code> would be a good choice. However, if this
      were an unusual query or one that’s only done by administrators who
      don’t care how long it takes, it would not be a good choice for
      indexing.</p></div></section><section data-type="sect2" data-pdf-bookmark="Introduction to Compound Indexes"><div class="sect2" id="sec2-compound"><h2>Introduction to Compound Indexes</h2><p>The<a data-type="indexterm" data-primary="indexes" data-secondary="basic operations" data-tertiary="compound indexes" id="IBOcompound05"/> purpose of an <a data-type="indexterm" data-primary="indexes" data-secondary="purpose of" id="idm45882378074808"/>index is to make your queries as efficient as possible.
      For many<a data-type="indexterm" data-primary="query patterns" data-secondary="indexes based on two or more keys" id="idm45882378073544"/> query patterns it is necessary to build indexes based on
      two or more keys. For example, an index keeps all of its values in a
      sorted order, so it makes sorting documents by the indexed key much
      faster. However, an index can only help with sorting if it is a prefix
      of the sort. For example, the index on <code>"username"</code> wouldn’t help much for this
      sort:</p><pre id="I_programlisting5_d1e5328" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">().</code><code class="nx">sort</code><code class="p">({</code><code class="s2">"age"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><p>This sorts by <code>"age"</code> and then
      <code>"username"</code>, so a strict sorting by
      <code>"username"</code> isn’t terribly helpful. To
      optimize this sort, you could make an index on <code>"age"</code> <em>and</em> <span class="keep-together"><code>"username"</code>:</span></p><pre id="I_programlisting5_d1e5352" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="s2">"age"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><p>This<a data-type="indexterm" data-primary="compound indexes" data-secondary="defined" id="idm45882378021880"/> is called a <em>compound index</em> and is
      useful if your query has multiple sort directions or multiple keys in
      the criteria. A compound index is an index on more than one
      field.</p><p>Suppose we have a <em class="filename">users</em>
      collection that looks something like this, if we run a query with no
      sorting (called <span class="firstterm">natural order</span>):</p><pre id="I_programlisting5_d1e5372" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({},</code> <code class="p">{</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"i"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">})</code>
<code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user0"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">69</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user1"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">50</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user2"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">88</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user3"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">52</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user4"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">74</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user5"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">104</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user6"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">59</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user7"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">102</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user8"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">94</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user9"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">7</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user10"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">80</code> <code class="p">}</code>
<code class="p">...</code></pre><p>If we index this collection by <code>{"age" :
      1, "username" : 1}</code>, the index will have a form we can
      represent as follows:</p><pre id="I_programlisting5_d1e5379" data-type="programlisting" data-code-language="javascript"><code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="s2">"user100020"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623513776</code>
<code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="s2">"user1002"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8599246768</code>
<code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="s2">"user100388"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623560880</code>
<code class="p">...</code>
<code class="p">[</code><code class="mi">0</code><code class="p">,</code> <code class="s2">"user100414"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623564208</code>
<code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="s2">"user100113"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623525680</code>
<code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="s2">"user100280"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623547056</code>
<code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="s2">"user100551"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623581744</code>
<code class="p">...</code>
<code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="s2">"user100626"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623591344</code>
<code class="p">[</code><code class="mi">2</code><code class="p">,</code> <code class="s2">"user100191"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623535664</code>
<code class="p">[</code><code class="mi">2</code><code class="p">,</code> <code class="s2">"user100195"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623536176</code>
<code class="p">[</code><code class="mi">2</code><code class="p">,</code> <code class="s2">"user100197"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623536432</code>
<code class="p">...</code></pre><p>Each index entry contains an age and a username and points to a
      record identifier. A record identifier is used internally by the storage
      engine to locate the data for a document. Note that <code>"age"</code> fields are ordered to be strictly
      ascending and, within each age, usernames are also in ascending order.
      In this example dataset, each age has approximately 8,000 usernames
      associated with it. Here we’ve included only those necessary to convey
      the general idea.</p><p>The<a data-type="indexterm" data-primary="compound indexes" data-secondary="types of queries" id="idm45882377616600"/> way MongoDB uses this index depends on the type of query
      you’re doing. These are the three most common ways:</p><dl><dt><code>db.users.find({"age" : 21}).sort({"username" :
          -1})</code></dt><dd><p>This<a data-type="indexterm" data-primary="queries" data-secondary="equality queries" id="idm45882377614408"/><a data-type="indexterm" data-primary="db.users.find" id="idm45882377613272"/> is an <span class="firstterm">equality query</span>, which
            searches for a single value. There may be multiple documents with
            that value. Due to the second field in the index, the results are
            already in the correct order for the sort: MongoDB can start with
            the last match for <code>{"age" : 21}</code> and traverse the
            index in order:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="s2">"user100154"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623530928</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="s2">"user100266"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623545264</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="s2">"user100270"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623545776</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="s2">"user100285"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623547696</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="s2">"user100349"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623555888</code>
<code class="p">...</code></pre><p>This type of query is very efficient: MongoDB can jump
            directly to the correct age and doesn’t need to sort the results
            because traversing the index returns the data in the correct
            order.</p><p>Note that sort direction doesn’t matter: MongoDB can
            traverse the index in either direction.</p></dd><dt><code>db.users.find({"age" : {"$gte" : 21, "$lte" :
          30}})</code></dt><dd><p>This<a data-type="indexterm" data-primary="queries" data-secondary="range queries" id="idm45882377511272"/> is a <span class="firstterm">range query</span>, which
            looks for documents matching multiple values (in this case, all
            ages between 21 and 30). MongoDB will use the first key in the
            index, <code>"age"</code>, to return the
            matching documents, like so:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="s2">"user100154"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623530928</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="s2">"user100266"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623545264</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="s2">"user100270"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623545776</code>
<code class="p">...</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="s2">"user999390"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8765250224</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="s2">"user999407"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8765252400</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="s2">"user999600"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8765277104</code>
<code class="p">[</code><code class="mi">22</code><code class="p">,</code> <code class="s2">"user100017"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623513392</code>
<code class="p">...</code>
<code class="p">[</code><code class="mi">29</code><code class="p">,</code> <code class="s2">"user999861"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8765310512</code>
<code class="p">[</code><code class="mi">30</code><code class="p">,</code> <code class="s2">"user100098"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623523760</code>
<code class="p">[</code><code class="mi">30</code><code class="p">,</code> <code class="s2">"user100155"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623531056</code>
<code class="p">[</code><code class="mi">30</code><code class="p">,</code> <code class="s2">"user100168"</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623532720</code>
<code class="p">...</code></pre><p>In general, if MongoDB uses an index for a query it will
            return the resulting documents in index order.</p></dd><dt><code>db.users.find({"age" : {"$gte" : 21, "$lte" :
          30}}).sort({"username" : 1})</code></dt><dd><p>This<a data-type="indexterm" data-primary="queries" data-secondary="multivalue queries" id="idm45882377587816"/> is a multivalue query, like the previous one, but
            this time it has a sort. As before, MongoDB will use the index to
            match the criteria. However, the index doesn’t return the
            usernames in sorted order and the query requested that the results
            be sorted by username. This means MongoDB will need to sort the
            results in memory before returning them, rather than simply
            traversing an index in which the documents are already sorted in
            the desired order. This type of query is usually less efficient as
            a consequence.</p><p>Of course, the speed depends on how many results match your
            criteria: if your result set is only a couple of documents MongoDB
            won’t have much work to do to sort them, but if there are more
            results it will be slower or may not work at all. If you have more
            than 32 MB of results MongoDB will just error out, refusing to
            sort that much data:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nb">Error</code><code class="o">:</code> <code class="nx">error</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"errmsg"</code> <code class="o">:</code> <code class="s2">"Executor error during find command: OperationFailed: </code>
<code class="s2">Sort operation used more than the maximum 33554432 bytes of RAM. Add </code>
<code class="s2">an index, or specify a smaller limit."</code><code class="p">,</code>
    <code class="s2">"code"</code> <code class="o">:</code> <code class="mi">96</code><code class="p">,</code>
    <code class="s2">"codeName"</code> <code class="o">:</code> <code class="s2">"OperationFailed"</code>
<code class="p">}</code></pre></dd></dl><div data-type="tip"><h6>Tip</h6><p>If<a data-type="indexterm" data-primary="indexes" data-secondary="supporting sort operation" id="idm45882377419704"/> you need to avoid this error, then you must create an
        index supporting the sort operation (<a href="https://docs.mongodb.com/manual/reference/method/cursor.sort/index.html#sort-index-use"><em class="hyperlink">https://docs.mongodb.com/manual/reference/method/cursor.sort/index.html#sort-index-use</em></a>)
        or use <code>sort</code> in conjunction with
        <code>limit</code> to reduce the results to
        below 32 MB.</p></div><p>One<a data-type="indexterm" data-primary="compound indexes" data-secondary="keys in reverse order" id="idm45882377413032"/> other index you can use in the last example is the same
      keys in reverse order: <code>{"username" : 1, "age" : 1}</code>. MongoDB
      will then traverse all the index entries, but in the order you want them
      back in. It will pick out the matching documents using the <code>"age"</code> part of the index:</p><pre class="pagebreak-before" data-type="programlisting" data-code-language="javascript"><code class="p">[</code><code class="nx">user0</code><code class="p">,</code> <code class="mi">4</code><code class="p">]</code>
<code class="p">[</code><code class="nx">user1</code><code class="p">,</code> <code class="mi">67</code><code class="p">]</code>
<code class="p">[</code><code class="nx">user10</code><code class="p">,</code> <code class="mi">11</code><code class="p">]</code>
<code class="p">[</code><code class="nx">user100</code><code class="p">,</code> <code class="mi">92</code><code class="p">]</code>
<code class="p">[</code><code class="nx">user1000</code><code class="p">,</code> <code class="mi">10</code><code class="p">]</code>
<code class="p">[</code><code class="nx">user10000</code><code class="p">,</code> <code class="mi">31</code><code class="p">]</code>
<code class="p">[</code><code class="nx">user100000</code><code class="p">,</code> <code class="mi">21</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623511216</code>
<code class="p">[</code><code class="nx">user100001</code><code class="p">,</code> <code class="mi">52</code><code class="p">]</code>
<code class="p">[</code><code class="nx">user100002</code><code class="p">,</code> <code class="mi">69</code><code class="p">]</code>
<code class="p">[</code><code class="nx">user100003</code><code class="p">,</code> <code class="mi">27</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623511600</code>
<code class="p">[</code><code class="nx">user100004</code><code class="p">,</code> <code class="mi">22</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623511728</code>
<code class="p">[</code><code class="nx">user100005</code><code class="p">,</code> <code class="mi">95</code><code class="p">]</code>
<code class="p">...</code></pre><p>This is good in that it does not require any giant in-memory
      sorts. However, it does have to scan the entire index to find all the
      matches. Putting<a data-type="indexterm" data-primary="compound indexes" data-secondary="best practices" id="idm45882377408104"/> the sort key first is generally a good strategy when
      designing compound indexes. As we’ll see shortly, this is one of several
      best practices when considering how to construct compound indexes with
      consideration for equality queries, multivalue queries, and
      sorting.</p></div></section><section data-type="sect2" data-pdf-bookmark="How MongoDB Selects an Index"><div class="sect2" id="idm45882378077736"><h2>How MongoDB Selects an Index</h2><p>Now<a data-type="indexterm" data-primary="indexes" data-secondary="basic operations" data-tertiary="how MongoDB selects indexes" id="idm45882377250712"/> let’s take a look at how MongoDB chooses an index to
      satisfy a query. Let’s imagine we have five indexes. When a query comes
      in, MongoDB looks at the query’s <em>shape</em>.
      The<a data-type="indexterm" data-primary="queries" data-secondary="shape of" id="idm45882377248632"/> shape has to do with what fields are being searched on
      and additional information, such as whether or not there is a sort.
      Based on that information, the system identifies a set of candidate
      indexes that it might be able to use in satisfying the query.</p><p>Let’s assume we have a query come in, and three of our five
      indexes are identified as candidates for this query. MongoDB will then
      create three query plans, one for each of these indexes, and run the
      query in three parallel threads, each using a different index. The
      objective here is to see which one is able to return results the
      fastest.</p><p>Visually, we can think of this as a race, as pictured in <a data-type="xref" href="#fig0501">Figure 5-1</a>. The idea here is that the first query plan to
      reach a goal state is the winner. But more importantly, going forward it
      will be selected as the index to use for queries that have that same
      query shape. The plans are raced against each other for a period
      (referred to as the trial period), after which the results of each race
      are used to calculate the overall winning plan.</p><figure style="float: 0"><div id="fig0501" class="figure"><img src="Images/mdb3_0501.png" width="1257" height="946"/><h6><span class="label">Figure 5-1. </span>How the MongoDB Query Planner selects an index, visualized as a
        race</h6></div></figure><p>To win the race, a query thread must be the first to either return
      all the query results or return a trial number of results in sort order.
      The sort order portion of this is important given how expensive it is to
      perform in-memory sorts.</p><p>The real value of racing several query plans against one another
      is that for subsequent queries that have the same query shape, the
      MongoDB server will know which index to select. The server maintains a
      cache of query plans. A winning plan is stored in the cache for future
      use for queries of that shape. Over time, as a collection changes and as
      the indexes change, eventually a query plan might be evicted from the
      cache and MongoDB will, again, experiment with possible query plans to
      find the one that works best for the current collection and set of
      indexes. Other events that will lead to plans being evicted from the
      cache are if we rebuild a given index, add or drop an index, or
      explicitly clear the plan cache. Finally, the query plan cache does not
      survive a restart of a <em>mongod</em> process.</p></div></section><section data-type="sect2" data-pdf-bookmark="Using Compound Indexes"><div class="sect2" id="idm45882377241416"><h2>Using Compound Indexes</h2><p>In<a data-type="indexterm" data-primary="compound indexes" data-secondary="using" id="CIuse05"/> the previous sections, we’ve been using
      <span class="firstterm">compound indexes</span>, which are indexes with more
      than one key in them. Compound indexes are a little more complicated to
      think about than single-key indexes, but they are very powerful. This
      section covers them in more depth.</p><p>Here, we will walk through an example that gives you an idea of
      the type of thinking you need to do when you are designing compound
      indexes. The<a data-type="indexterm" data-primary="compound indexes" data-secondary="using" data-tertiary="design goals" id="idm45882377236792"/> goal is for our read and write operations to be as
      efficient as possible—but as with so many things, this requires some
      upfront thinking and some experimentation.</p><p>To be sure we get the right indexes in place, it is necessary to
      test our indexes under some real-world workloads and make adjustments
      from there. However, there are some best practices we can apply as we
      design our indexes.</p><p>First, we<a data-type="indexterm" data-primary="compound indexes" data-secondary="using" data-tertiary="index selectivity" id="idm45882377234328"/><a data-type="indexterm" data-primary="indexes" data-secondary="selectivity of" id="idm45882377232920"/> need to consider the selectivity of the index. We are
      interested in the degree to which, for a given query pattern, the index
      is going to minimize the number of records scanned. We need to consider
      selectivity in light of all operations necessary to satisfy a query, and
      sometimes make tradeoffs. We will need to consider, for example, how
      sorts are handled.</p><p>Let’s look at an example. For this, we will use a student dataset
      containing approximately one million records. Documents in this dataset
      resemble the following:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"585d817db4743f74e2da067c"</code><code class="p">),</code>
    <code class="s2">"student_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"scores"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="p">{</code>
        <code class="s2">"type"</code> <code class="o">:</code> <code class="s2">"exam"</code><code class="p">,</code>
        <code class="s2">"score"</code> <code class="o">:</code> <code class="mf">38.05000060199827</code>
    <code class="p">},</code>
    <code class="p">{</code>
        <code class="s2">"type"</code> <code class="o">:</code> <code class="s2">"quiz"</code><code class="p">,</code>
        <code class="s2">"score"</code> <code class="o">:</code> <code class="mf">79.45079445008987</code>
    <code class="p">},</code>
    <code class="p">{</code>
        <code class="s2">"type"</code> <code class="o">:</code> <code class="s2">"homework"</code><code class="p">,</code>
        <code class="s2">"score"</code> <code class="o">:</code> <code class="mf">74.50150548699534</code>
    <code class="p">},</code>
    <code class="p">{</code>
        <code class="s2">"type"</code> <code class="o">:</code> <code class="s2">"homework"</code><code class="p">,</code>
        <code class="s2">"score"</code> <code class="o">:</code> <code class="mf">74.68381684615845</code>
    <code class="p">}</code>
    <code class="p">],</code>
    <code class="s2">"class_id"</code> <code class="o">:</code> <code class="mi">127</code>
<code class="p">}</code></pre><p>We will begin with two indexes and look at how MongoDB uses these
      indexes (or doesn’t) in order to satisfy queries. These two indexes are
      created as follows:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">students</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="s2">"class_id"</code><code class="o">:</code> <code class="mi">1</code><code class="p">})</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">students</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="nx">student_id</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">class_id</code><code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><p>In working with this dataset, we will consider the following
      query, because it illustrates several of the issues that we have to
      think about in designing our indexes:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">students</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">student_id</code><code class="o">:</code><code class="p">{</code><code class="nx">$gt</code><code class="o">:</code><code class="mi">500000</code><code class="p">},</code> <code class="nx">class_id</code><code class="o">:</code><code class="mi">54</code><code class="p">})</code>
<code class="p">...</code>          <code class="p">.</code><code class="nx">sort</code><code class="p">({</code><code class="nx">student_id</code><code class="o">:</code><code class="mi">1</code><code class="p">})</code>
<code class="p">...</code>          <code class="p">.</code><code class="nx">explain</code><code class="p">(</code><code class="s2">"executionStats"</code><code class="p">)</code></pre><p>Note that in this query we are requesting all records with an ID
      greater than 500,000, so about half of the records. We are also
      constraining the search to records for the class with ID <code>54</code>. There are about 500 classes represented in
      this dataset. Finally, we are sorting in ascending order based on
      <code>"student_id"</code>. Note that this is the
      same field on which we are doing a multivalue query. Throughout this
      example we will look at the execution stats that the<a data-type="indexterm" data-primary="explain command" id="idm45882377023336"/> <code>explain</code> method
      provides to illustrate how MongoDB will handle this query.</p><p>If we run the query, the output of the <code>explain</code> method tells us how MongoDB used
      indexes to satisfy it:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"queryPlanner"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"plannerVersion"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"namespace"</code><code class="o">:</code> <code class="s2">"school.students"</code><code class="p">,</code>
    <code class="s2">"indexFilterSet"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"parsedQuery"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"$and"</code><code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
          <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"$eq"</code><code class="o">:</code> <code class="mi">54</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"$gt"</code><code class="o">:</code> <code class="mi">500000</code>
          <code class="p">}</code>
        <code class="p">}</code>
      <code class="p">]</code>
    <code class="p">},</code>
    <code class="s2">"winningPlan"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
      <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
        <code class="s2">"keyPattern"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"student_id"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
          <code class="s2">"class_id"</code><code class="o">:</code> <code class="mi">1</code>
        <code class="p">},</code>
        <code class="s2">"indexName"</code><code class="o">:</code> <code class="s2">"student_id_1_class_id_1"</code><code class="p">,</code>
        <code class="s2">"isMultiKey"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"multiKeyPaths"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
          <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
        <code class="p">},</code>
        <code class="s2">"isUnique"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"isSparse"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"isPartial"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"indexVersion"</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
        <code class="s2">"direction"</code><code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
        <code class="s2">"indexBounds"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">[</code>
            <code class="s2">"(500000.0, inf.0]"</code>
          <code class="p">],</code>
          <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code>
            <code class="s2">"[54.0, 54.0]"</code>
          <code class="p">]</code>
        <code class="p">}</code>
      <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"rejectedPlans"</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code>
        <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"SORT"</code><code class="p">,</code>
        <code class="s2">"sortPattern"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"student_id"</code><code class="o">:</code> <code class="mi">1</code>
        <code class="p">},</code>
        <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"SORT_KEY_GENERATOR"</code><code class="p">,</code>
          <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
            <code class="s2">"filter"</code><code class="o">:</code> <code class="p">{</code>
              <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">{</code>
                <code class="s2">"$gt"</code><code class="o">:</code> <code class="mi">500000</code>
              <code class="p">}</code>
            <code class="p">},</code>
            <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
              <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
              <code class="s2">"keyPattern"</code><code class="o">:</code> <code class="p">{</code>
                <code class="s2">"class_id"</code><code class="o">:</code> <code class="mi">1</code>
              <code class="p">},</code>
              <code class="s2">"indexName"</code><code class="o">:</code> <code class="s2">"class_id_1"</code><code class="p">,</code>
              <code class="s2">"isMultiKey"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
              <code class="s2">"multiKeyPaths"</code><code class="o">:</code> <code class="p">{</code>
                <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
              <code class="p">},</code>
              <code class="s2">"isUnique"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
              <code class="s2">"isSparse"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
              <code class="s2">"isPartial"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
              <code class="s2">"indexVersion"</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
              <code class="s2">"direction"</code><code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
              <code class="s2">"indexBounds"</code><code class="o">:</code> <code class="p">{</code>
                <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code>
                  <code class="s2">"[54.0, 54.0]"</code>
                <code class="p">]</code>
              <code class="p">}</code>
            <code class="p">}</code>
          <code class="p">}</code>
        <code class="p">}</code>
      <code class="p">}</code>
    <code class="p">]</code>
  <code class="p">},</code>
  <code class="s2">"executionStats"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"executionSuccess"</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
    <code class="s2">"executionTimeMillis"</code><code class="o">:</code> <code class="mi">4325</code><code class="p">,</code>
    <code class="s2">"totalKeysExamined"</code><code class="o">:</code> <code class="mi">850477</code><code class="p">,</code>
    <code class="s2">"totalDocsExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
    <code class="s2">"executionStages"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
      <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">3485</code><code class="p">,</code>
      <code class="s2">"works"</code><code class="o">:</code> <code class="mi">850478</code><code class="p">,</code>
      <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">840574</code><code class="p">,</code>
      <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">6861</code><code class="p">,</code>
      <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">6861</code><code class="p">,</code>
      <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
      <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"docsExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"alreadyHasObj"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
        <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
        <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">2834</code><code class="p">,</code>
        <code class="s2">"works"</code><code class="o">:</code> <code class="mi">850478</code><code class="p">,</code>
        <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
        <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">840574</code><code class="p">,</code>
        <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">6861</code><code class="p">,</code>
        <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">6861</code><code class="p">,</code>
        <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"keyPattern"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"student_id"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
          <code class="s2">"class_id"</code><code class="o">:</code> <code class="mi">1</code>
        <code class="p">},</code>
        <code class="s2">"indexName"</code><code class="o">:</code> <code class="s2">"student_id_1_class_id_1"</code><code class="p">,</code>
        <code class="s2">"isMultiKey"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"multiKeyPaths"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
          <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
        <code class="p">},</code>
        <code class="s2">"isUnique"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"isSparse"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"isPartial"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"indexVersion"</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
        <code class="s2">"direction"</code><code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
        <code class="s2">"indexBounds"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">[</code>
            <code class="s2">"(500000.0, inf.0]"</code>
          <code class="p">],</code>
          <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code>
            <code class="s2">"[54.0, 54.0]"</code>
          <code class="p">]</code>
        <code class="p">},</code>
        <code class="s2">"keysExamined"</code><code class="o">:</code> <code class="mi">850477</code><code class="p">,</code>
        <code class="s2">"seeks"</code><code class="o">:</code> <code class="mi">840575</code><code class="p">,</code>
        <code class="s2">"dupsTested"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"dupsDropped"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"seenInvalidated"</code><code class="o">:</code> <code class="mi">0</code>
      <code class="p">}</code>
    <code class="p">}</code>
  <code class="p">},</code>
  <code class="s2">"serverInfo"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"host"</code><code class="o">:</code> <code class="s2">"SGB-MBP.local"</code><code class="p">,</code>
    <code class="s2">"port"</code><code class="o">:</code> <code class="mi">27017</code><code class="p">,</code>
    <code class="s2">"version"</code><code class="o">:</code> <code class="s2">"3.4.1"</code><code class="p">,</code>
    <code class="s2">"gitVersion"</code><code class="o">:</code> <code class="s2">"5e103c4f5583e2566a45d740225dc250baacfbd7"</code>
  <code class="p">},</code>
  <code class="s2">"ok"</code><code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>As with most data output from MongoDB, the <code>explain</code> output is JSON. Let’s look first at
      the bottom half of this output, which is almost entirely the execution
      stats. The <code>"executionStats"</code> field
      contains statistics that describe the completed query execution for the
      winning query plan. We will look at query plans and the query plan
      output from <code>explain</code> a little
      later.</p><p>Within <code>"executionStats"</code>, first
      we will look at <code>"totalKeysExamined"</code>.
      This is how many keys within the index MongoDB walked through in order
      to generate the result set. We can compare <code>"totalKeysExamined"</code> to <code>"nReturned"</code> to get a sense for how much of the
      index MongoDB had to traverse in order to find just the documents
      matching the query. In this case, 850,477 index keys were examined in
      order to locate the 9,903 matching documents.</p><p>This means that the index used in order to satisfy this query was
      not very selective. This is further emphasized by the fact that this
      query took more than 4.3 seconds to run, as indicated by the <code>"executionTimeMillis"</code> field.
      Selectivity<a data-type="indexterm" data-primary="indexes" data-secondary="selectivity of" id="idm45882376834712"/> is one of our key objectives when we are designing an
      index, so let’s figure out where we went wrong with the existing indexes
      for this query.</p><p>Near the top of the <code>explain</code>
      output is the winning query plan (see the field <code>"winningPlan"</code>). A query plan describes the
      steps MongoDB used to satisfy a query. This is, in JSON form, the
      specific outcome of racing a couple of different query plans against one
      another. In particular, we are interested in what indexes were used and
      whether MongoDB had to do an in-memory sort. Below the winning plan are
      the rejected plans. We’ll look at both.</p><p>In this case, the winning plan used a compound index based on
      <code>"student_id"</code> and <code>"class_id"</code>. This is evident in the following
      portion of the <code>explain</code> output:</p><pre data-type="programlisting" data-code-language="javascript"><code class="s2">"winningPlan"</code><code class="o">:</code> <code class="p">{</code>
  <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
  <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
    <code class="s2">"keyPattern"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"student_id"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
      <code class="s2">"class_id"</code><code class="o">:</code> <code class="mi">1</code>
    <code class="p">},</code></pre><p>The <code>explain</code> output presents the
      query plan as a tree of stages. A stage can have one or more input
      stages, depending on how many child stages it has. An input stage
      provides the documents or index keys to its parent. In this case, there
      was one input stage, an index scan, and that scan provided the record
      IDs for documents matching the query to its parent, the <code>"FETCH"</code> stage. The <code>"FETCH"</code> stage, then, will retrieve the
      documents themselves and return them in batches as the client requests
      them.</p><p>The losing query plan—there is only one—would have used an index
      based on <code>"class_id"</code> but then it would
      have had to do an in-memory sort. That is what the following portion of
      this particular query plan means. When you see a <code>"SORT"</code> stage in a query plan, it means that
      MongoDB would have been unable to sort the result set in the database
      using an index and instead would have had to do an in-memory
      sort:</p><pre data-type="programlisting" data-code-language="javascript"><code class="s2">"rejectedPlans"</code><code class="o">:</code> <code class="p">[</code>
  <code class="p">{</code>
    <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"SORT"</code><code class="p">,</code>
    <code class="s2">"sortPattern"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"student_id"</code><code class="o">:</code> <code class="mi">1</code>
    <code class="p">},</code></pre><p>For this query, the index that won is one that was able to return
      sorted output. To win it only had to reach a trial number of sorted
      result documents. For the other plan to win, that query thread would
      have had to return the entire result set (nearly 10,000 documents)
      first, since those would then need to be sorted in memory.</p><p>The issue here is one of selectivity. The multivalue query we are
      running specifies a broad range of <code>"student_id"</code> values, because it’s requesting
      records for which the <code>"student_id"</code> is
      greater than 500,000. That’s about half the records in our collection.
      Here again, for convenience, is the query we are running:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">students</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">student_id</code><code class="o">:</code><code class="p">{</code><code class="nx">$gt</code><code class="o">:</code><code class="mi">500000</code><code class="p">},</code> <code class="nx">class_id</code><code class="o">:</code><code class="mi">54</code><code class="p">})</code>
<code class="p">...</code>          <code class="p">.</code><code class="nx">sort</code><code class="p">({</code><code class="nx">student_id</code><code class="o">:</code><code class="mi">1</code><code class="p">})</code>
<code class="p">...</code>          <code class="p">.</code><code class="nx">explain</code><code class="p">(</code><code class="s2">"executionStats"</code><code class="p">)</code></pre><p>Now, I’m sure you can see where we are headed here. This query
      contains both a multivalue portion and an equality portion. The equality
      portion is that we are asking for all records in which <code>"class_id"</code> is equal to <code>54</code>. There are only about 500 classes in this
      dataset, and while there are a large number of students with grades in
      those classes, <code>"class_id"</code> would serve
      as a much more selective basis on which to execute this query. It is
      this value that constrains our result set to just under 10,000 records
      rather than the approximately 850,000 that were identified by the
      multivalue portion of this query.</p><p>In other words, it would be better, given the indexes we have, if
      we were to use the index based on just <code>"class_id"</code>—the one in the losing query plan.
      MongoDB provides two ways of forcing the database to use a particular
      index. However, I cannot stress strongly enough that you should use
      these ways of overriding what would be the outcome of the query planner
      with caution. These are not techniques you should use in a production
      deployment.</p><p>The cursor <code>hint</code>
      method<a data-type="indexterm" data-primary="compound indexes" data-secondary="using" data-tertiary="specifying which index to use" id="idm45882376274344"/><a data-type="indexterm" data-primary="cursors" data-secondary="cursor hint method" id="idm45882376272968"/> enables us to specify a particular index to use, either
      by specifying its shape or its name. An index filter uses a query shape,
      which is a combination of a query, sort, and projection specification.
      The <code>planCacheSetFilter</code> function can
      be used with an index filter to limit the query optimizer to only
      considering indexes specified in the index filter. If an index filter
      exists for a query shape, MongoDB will ignore <code>hint</code>. Index filters only persist for the
      duration of the <em>mongod</em> server process; they do not
      persist after shutdown.</p><p>If we change our query slightly to use <code>hint</code>, as in the following example, the
      <code>explain</code> output will be quite
      different:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">students</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">student_id</code><code class="o">:</code><code class="p">{</code><code class="nx">$gt</code><code class="o">:</code><code class="mi">500000</code><code class="p">},</code> <code class="nx">class_id</code><code class="o">:</code><code class="mi">54</code><code class="p">})</code>
<code class="p">...</code>          <code class="p">.</code><code class="nx">sort</code><code class="p">({</code><code class="nx">student_id</code><code class="o">:</code><code class="mi">1</code><code class="p">})</code>
<code class="p">...</code>          <code class="p">.</code><code class="nx">hint</code><code class="p">({</code><code class="nx">class_id</code><code class="o">:</code><code class="mi">1</code><code class="p">})</code>
<code class="p">...</code>          <code class="p">.</code><code class="nx">explain</code><code class="p">(</code><code class="s2">"executionStats"</code><code class="p">)</code></pre><p>The resulting output shows that we are now down from having
      scanned roughly 850,000 index keys to just about 20,000 in order to get
      to our result set of just under 10,000. In addition, the execution time
      is only 272 milliseconds rather than the 4.3 seconds we saw with the
      query plan using the other index:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"queryPlanner"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"plannerVersion"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"namespace"</code><code class="o">:</code> <code class="s2">"school.students"</code><code class="p">,</code>
    <code class="s2">"indexFilterSet"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"parsedQuery"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"$and"</code><code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
          <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"$eq"</code><code class="o">:</code> <code class="mi">54</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"$gt"</code><code class="o">:</code> <code class="mi">500000</code>
          <code class="p">}</code>
        <code class="p">}</code>
      <code class="p">]</code>
    <code class="p">},</code>
    <code class="s2">"winningPlan"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"SORT"</code><code class="p">,</code>
      <code class="s2">"sortPattern"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"student_id"</code><code class="o">:</code> <code class="mi">1</code>
      <code class="p">},</code>
      <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"SORT_KEY_GENERATOR"</code><code class="p">,</code>
        <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
          <code class="s2">"filter"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">{</code>
              <code class="s2">"$gt"</code><code class="o">:</code> <code class="mi">500000</code>
            <code class="p">}</code>
          <code class="p">},</code>
          <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
            <code class="s2">"keyPattern"</code><code class="o">:</code> <code class="p">{</code>
              <code class="s2">"class_id"</code><code class="o">:</code> <code class="mi">1</code>
            <code class="p">},</code>
            <code class="s2">"indexName"</code><code class="o">:</code> <code class="s2">"class_id_1"</code><code class="p">,</code>
            <code class="s2">"isMultiKey"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"multiKeyPaths"</code><code class="o">:</code> <code class="p">{</code>
              <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
            <code class="p">},</code>
            <code class="s2">"isUnique"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"isSparse"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"isPartial"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"indexVersion"</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"direction"</code><code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
            <code class="s2">"indexBounds"</code><code class="o">:</code> <code class="p">{</code>
              <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code>
                <code class="s2">"[54.0, 54.0]"</code>
              <code class="p">]</code>
            <code class="p">}</code>
          <code class="p">}</code>
        <code class="p">}</code>
      <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"rejectedPlans"</code><code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
  <code class="p">},</code>
  <code class="s2">"executionStats"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"executionSuccess"</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
    <code class="s2">"executionTimeMillis"</code><code class="o">:</code> <code class="mi">272</code><code class="p">,</code>
    <code class="s2">"totalKeysExamined"</code><code class="o">:</code> <code class="mi">20076</code><code class="p">,</code>
    <code class="s2">"totalDocsExamined"</code><code class="o">:</code> <code class="mi">20076</code><code class="p">,</code>
    <code class="s2">"executionStages"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"SORT"</code><code class="p">,</code>
      <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">248</code><code class="p">,</code>
      <code class="s2">"works"</code><code class="o">:</code> <code class="mi">29982</code><code class="p">,</code>
      <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">20078</code><code class="p">,</code>
      <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">242</code><code class="p">,</code>
      <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">242</code><code class="p">,</code>
      <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
      <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"sortPattern"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"student_id"</code><code class="o">:</code> <code class="mi">1</code>
      <code class="p">},</code>
      <code class="s2">"memUsage"</code><code class="o">:</code> <code class="mi">2386623</code><code class="p">,</code>
      <code class="s2">"memLimit"</code><code class="o">:</code> <code class="mi">33554432</code><code class="p">,</code>
      <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"SORT_KEY_GENERATOR"</code><code class="p">,</code>
        <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
        <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">203</code><code class="p">,</code>
        <code class="s2">"works"</code><code class="o">:</code> <code class="mi">20078</code><code class="p">,</code>
        <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
        <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">10174</code><code class="p">,</code>
        <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">242</code><code class="p">,</code>
        <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">242</code><code class="p">,</code>
        <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
          <code class="s2">"filter"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">{</code>
              <code class="s2">"$gt"</code><code class="o">:</code> <code class="mi">500000</code>
            <code class="p">}</code>
          <code class="p">},</code>
          <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
          <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">192</code><code class="p">,</code>
          <code class="s2">"works"</code><code class="o">:</code> <code class="mi">20077</code><code class="p">,</code>
          <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
          <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">10173</code><code class="p">,</code>
          <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
          <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">242</code><code class="p">,</code>
          <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">242</code><code class="p">,</code>
          <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
          <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
          <code class="s2">"docsExamined"</code><code class="o">:</code> <code class="mi">20076</code><code class="p">,</code>
          <code class="s2">"alreadyHasObj"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
          <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
            <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">20076</code><code class="p">,</code>
            <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">45</code><code class="p">,</code>
            <code class="s2">"works"</code><code class="o">:</code> <code class="mi">20077</code><code class="p">,</code>
            <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">20076</code><code class="p">,</code>
            <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">242</code><code class="p">,</code>
            <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">242</code><code class="p">,</code>
            <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"keyPattern"</code><code class="o">:</code> <code class="p">{</code>
              <code class="s2">"class_id"</code><code class="o">:</code> <code class="mi">1</code>
            <code class="p">},</code>
            <code class="s2">"indexName"</code><code class="o">:</code> <code class="s2">"class_id_1"</code><code class="p">,</code>
            <code class="s2">"isMultiKey"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"multiKeyPaths"</code><code class="o">:</code> <code class="p">{</code>
              <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
            <code class="p">},</code>
            <code class="s2">"isUnique"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"isSparse"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"isPartial"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"indexVersion"</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"direction"</code><code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
            <code class="s2">"indexBounds"</code><code class="o">:</code> <code class="p">{</code>
              <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code>
                <code class="s2">"[54.0, 54.0]"</code>
              <code class="p">]</code>
            <code class="p">},</code>
            <code class="s2">"keysExamined"</code><code class="o">:</code> <code class="mi">20076</code><code class="p">,</code>
            <code class="s2">"seeks"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"dupsTested"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"dupsDropped"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"seenInvalidated"</code><code class="o">:</code> <code class="mi">0</code>
          <code class="p">}</code>
        <code class="p">}</code>
      <code class="p">}</code>
    <code class="p">}</code>
  <code class="p">},</code>
  <code class="s2">"serverInfo"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"host"</code><code class="o">:</code> <code class="s2">"SGB-MBP.local"</code><code class="p">,</code>
    <code class="s2">"port"</code><code class="o">:</code> <code class="mi">27017</code><code class="p">,</code>
    <code class="s2">"version"</code><code class="o">:</code> <code class="s2">"3.4.1"</code><code class="p">,</code>
    <code class="s2">"gitVersion"</code><code class="o">:</code> <code class="s2">"5e103c4f5583e2566a45d740225dc250baacfbd7"</code>
  <code class="p">},</code>
  <code class="s2">"ok"</code><code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>However, what we really want to see is <code>"nReturned"</code> very close to <code>"totalKeysExamined"</code>. In addition, we would
      like avoid having to use <code>hint</code> in
      order to more efficiently execute this query. The way to address both of
      these concerns is to design a better index.</p><p>A better index for the query pattern in question is one based on
      <code>"class_id"</code> and <code>"student_id"</code>, in that order. With <code>"class_id"</code> as the prefix, we are using the
      equality filter in our query to restrict the keys considered within the
      index. This is the most selective component of our query, and therefore
      effectively constrains the number of keys MongoDB needs to consider to
      satisfy this query. We can build this index as <span class="keep-together">follows</span>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">students</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="nx">class_id</code><code class="o">:</code><code class="mi">1</code><code class="p">,</code> <code class="nx">student_id</code><code class="o">:</code><code class="mi">1</code><code class="p">})</code></pre><p>While<a data-type="indexterm" data-primary="compound indexes" data-secondary="best practices" id="idm45882375533608"/> not true for absolutely every dataset, in general you
      should design compound indexes such that fields on which you will be
      using equality filters come before those on which your application will
      use multivalue filters.</p><p>With our new index in place, if we rerun our query, this time no
      hinting is required and we can see from the <code>"executionStats"</code> field in the <code>explain</code> output that we have a fast query (37
      milliseconds) for which the number of results returned (<code>"nReturned"</code>) is equal to the number of keys
      scanned in the index (<code>"totalKeysExamined"</code>). We can also see that
      this is due to the fact that the <code>"executionStages"</code>, which reflect the winning
      query plan, contain an index scan that makes use of the new index we
      created:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">...</code>
<code class="s2">"executionStats"</code><code class="o">:</code> <code class="p">{</code>
  <code class="s2">"executionSuccess"</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
  <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
  <code class="s2">"executionTimeMillis"</code><code class="o">:</code> <code class="mi">37</code><code class="p">,</code>
  <code class="s2">"totalKeysExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
  <code class="s2">"totalDocsExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
  <code class="s2">"executionStages"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
    <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
    <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">36</code><code class="p">,</code>
    <code class="s2">"works"</code><code class="o">:</code> <code class="mi">9904</code><code class="p">,</code>
    <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
    <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">81</code><code class="p">,</code>
    <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">81</code><code class="p">,</code>
    <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"docsExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
    <code class="s2">"alreadyHasObj"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
      <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"works"</code><code class="o">:</code> <code class="mi">9904</code><code class="p">,</code>
      <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">81</code><code class="p">,</code>
      <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">81</code><code class="p">,</code>
      <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
      <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"keyPattern"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"class_id"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"student_id"</code><code class="o">:</code> <code class="mi">1</code>
      <code class="p">},</code>
      <code class="s2">"indexName"</code><code class="o">:</code> <code class="s2">"class_id_1_student_id_1"</code><code class="p">,</code>
      <code class="s2">"isMultiKey"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
      <code class="s2">"multiKeyPaths"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
        <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
      <code class="p">},</code>
      <code class="s2">"isUnique"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
      <code class="s2">"isSparse"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
      <code class="s2">"isPartial"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
      <code class="s2">"indexVersion"</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
      <code class="s2">"direction"</code><code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
      <code class="s2">"indexBounds"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code>
          <code class="s2">"[54.0, 54.0]"</code>
        <code class="p">],</code>
        <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">[</code>
          <code class="s2">"(500000.0, inf.0]"</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="s2">"keysExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"seeks"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
      <code class="s2">"dupsTested"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"dupsDropped"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"seenInvalidated"</code><code class="o">:</code> <code class="mi">0</code>
    <code class="p">}</code>
  <code class="p">}</code>
<code class="p">},</code></pre><p>Considering what we know about how indexes are built, you can
      probably see why this works. The <code>[class_id,
      student_id]</code> index is composed of key pairs such as the
      following. Since the student IDs are ordered within these key pairs, in
      order to satisfy our sort MongoDB simply needs to walk all the key pairs
      beginning with the first one for <code>class_id</code> <code>54</code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">...</code>
<code class="p">[</code><code class="mi">53</code><code class="p">,</code> <code class="mi">999617</code><code class="p">]</code>
<code class="p">[</code><code class="mi">53</code><code class="p">,</code> <code class="mi">999780</code><code class="p">]</code>
<code class="p">[</code><code class="mi">53</code><code class="p">,</code> <code class="mi">999916</code><code class="p">]</code>
<code class="p">[</code><code class="mi">54</code><code class="p">,</code> <code class="mi">500001</code><code class="p">]</code>
<code class="p">[</code><code class="mi">54</code><code class="p">,</code> <code class="mi">500009</code><code class="p">]</code>
<code class="p">[</code><code class="mi">54</code><code class="p">,</code> <code class="mi">500048</code><code class="p">]</code>
<code class="p">...</code></pre><p>In<a data-type="indexterm" data-primary="compound indexes" data-secondary="using" data-tertiary="design goals" id="idm45882375220104"/> considering the design of a compound index, we need to
      know how to address equality filters, multivalue filters, and sort
      components of common query patterns that will make use of the index. It
      is necessary to consider these three factors for all compound indexes,
      and if you design your index to balance these concerns correctly, you
      will get the best performance out of MongoDB for your queries. While
      we’ve addressed all three factors for our example query with the
      <code>[class_id, student_id]</code> index, the
      query as written represents a special case of the compound index problem
      because we’re sorting on one of the fields we are also filtering
      on.</p><p>To remove the special-case nature of this example, let’s sort on
      final grade instead, changing our query to the following:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">students</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">student_id</code><code class="o">:</code><code class="p">{</code><code class="nx">$gt</code><code class="o">:</code><code class="mi">500000</code><code class="p">},</code> <code class="nx">class_id</code><code class="o">:</code><code class="mi">54</code><code class="p">})</code>
<code class="p">...</code>          <code class="p">.</code><code class="nx">sort</code><code class="p">({</code><code class="nx">final_grade</code><code class="o">:</code><code class="mi">1</code><code class="p">})</code>
<code class="p">...</code>          <code class="p">.</code><code class="nx">explain</code><code class="p">(</code><code class="s2">"executionStats"</code><code class="p">)</code></pre><p>If we run this query and look at the <code>explain</code> output, we see that we’re now doing an
      in-memory sort. While the query is still fast at only 136 milliseconds,
      it is an order of magnitude slower than when sorting on <code>"student_id"</code>, because we are now doing an
      in-memory sort. We can see that we are doing an in-memory sort because
      the winning query plan now contains a <code>"SORT"</code> stage:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">...</code>
<code class="s2">"executionStats"</code><code class="o">:</code> <code class="p">{</code>
  <code class="s2">"executionSuccess"</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
  <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
  <code class="s2">"executionTimeMillis"</code><code class="o">:</code> <code class="mi">136</code><code class="p">,</code>
  <code class="s2">"totalKeysExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
  <code class="s2">"totalDocsExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
  <code class="s2">"executionStages"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"SORT"</code><code class="p">,</code>
    <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
    <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">36</code><code class="p">,</code>
    <code class="s2">"works"</code><code class="o">:</code> <code class="mi">19809</code><code class="p">,</code>
    <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
    <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">9905</code><code class="p">,</code>
    <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">315</code><code class="p">,</code>
    <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">315</code><code class="p">,</code>
    <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"sortPattern"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"final_grade"</code><code class="o">:</code> <code class="mi">1</code>
    <code class="p">},</code>
    <code class="s2">"memUsage"</code><code class="o">:</code> <code class="mi">2386623</code><code class="p">,</code>
    <code class="s2">"memLimit"</code><code class="o">:</code> <code class="mi">33554432</code><code class="p">,</code>
    <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"SORT_KEY_GENERATOR"</code><code class="p">,</code>
      <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">24</code><code class="p">,</code>
      <code class="s2">"works"</code><code class="o">:</code> <code class="mi">9905</code><code class="p">,</code>
      <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
      <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">315</code><code class="p">,</code>
      <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">315</code><code class="p">,</code>
      <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
      <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
        <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
        <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">24</code><code class="p">,</code>
        <code class="s2">"works"</code><code class="o">:</code> <code class="mi">9904</code><code class="p">,</code>
        <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
        <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">315</code><code class="p">,</code>
        <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">315</code><code class="p">,</code>
        <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"docsExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
        <code class="s2">"alreadyHasObj"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
          <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
          <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">12</code><code class="p">,</code>
          <code class="s2">"works"</code><code class="o">:</code> <code class="mi">9904</code><code class="p">,</code>
          <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
          <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
          <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
          <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">315</code><code class="p">,</code>
          <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">315</code><code class="p">,</code>
          <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
          <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
          <code class="s2">"keyPattern"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"class_id"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"student_id"</code><code class="o">:</code> <code class="mi">1</code>
          <code class="p">},</code>
          <code class="s2">"indexName"</code><code class="o">:</code> <code class="s2">"class_id_1_student_id_1"</code><code class="p">,</code>
          <code class="s2">"isMultiKey"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
          <code class="s2">"multiKeyPaths"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
            <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
          <code class="p">},</code>
          <code class="s2">"isUnique"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
          <code class="s2">"isSparse"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
          <code class="s2">"isPartial"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
          <code class="s2">"indexVersion"</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
          <code class="s2">"direction"</code><code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
          <code class="s2">"indexBounds"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code>
              <code class="s2">"[54.0, 54.0]"</code>
            <code class="p">],</code>
            <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">[</code>
              <code class="s2">"(500000.0, inf.0]"</code>
            <code class="p">]</code>
          <code class="p">},</code>
          <code class="s2">"keysExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
          <code class="s2">"seeks"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
          <code class="s2">"dupsTested"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
          <code class="s2">"dupsDropped"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
          <code class="s2">"seenInvalidated"</code><code class="o">:</code> <code class="mi">0</code>
        <code class="p">}</code>
      <code class="p">}</code>
    <code class="p">}</code>
  <code class="p">}</code>
<code class="p">},</code>
<code class="p">...</code></pre><p>If we can avoid an in-memory sort with a better index design, we
      should. This will allow us to scale more easily with respect to dataset
      size and system load.</p><p>But to do that, we are going to have to make a tradeoff. This is
      commonly the case when designing compound indexes.</p><p>As<a data-type="indexterm" data-primary="compound indexes" data-secondary="using" data-tertiary="avoiding in-memory sort" id="idm45882374839480"/> is so often necessary for compound indexes, in order to
      avoid an in-memory sort we need to examine more keys than the number of
      documents we return. To use the index to sort, MongoDB needs to be able
      to walk the index keys in order. This means that we need to include the
      sort field among the compound index keys.</p><p>The keys in our new compound index should be ordered as follows:
      <code>[class_id, final_grade, student_id]</code>.
      Note that we include the sort component immediately after the equality
      filter, but before the multivalue filter. This index will very
      selectively narrow the set of keys considered for this query. Then, by
      walking the key triplets matching the equality filter in this index,
      MongoDB can identify the records that match the multivalue filter and
      those records will be ordered properly by final grade in ascending
      order.</p><p>This compound index forces MongoDB to examine keys for more
      documents than will end up being in our result set. However, by using
      the index to ensure we have sorted documents, we save execution time. We
      can construct the new index using the following command:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">students</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="nx">class_id</code><code class="o">:</code><code class="mi">1</code><code class="p">,</code> <code class="nx">final_grade</code><code class="o">:</code><code class="mi">1</code><code class="p">,</code> <code class="nx">student_id</code><code class="o">:</code><code class="mi">1</code><code class="p">})</code></pre><p>Now, if we once again issue our query:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">students</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">student_id</code><code class="o">:</code><code class="p">{</code><code class="nx">$gt</code><code class="o">:</code><code class="mi">500000</code><code class="p">},</code> <code class="nx">class_id</code><code class="o">:</code><code class="mi">54</code><code class="p">})</code>
<code class="p">...</code>          <code class="p">.</code><code class="nx">sort</code><code class="p">({</code><code class="nx">final_grade</code><code class="o">:</code><code class="mi">1</code><code class="p">})</code>
<code class="p">...</code>          <code class="p">.</code><code class="nx">explain</code><code class="p">(</code><code class="s2">"executionStats"</code><code class="p">)</code></pre><p>we get the following <code>"executionStats"</code> in the output from <code>explain</code>. This will vary depending on your
      hardware and what else is going on in the system, but you can see that
      the winning plan no longer includes an in-memory sort. It is instead
      using the index we just created to satisfy the query, including the
      sort:</p><pre class="pagebreak-before" data-type="programlisting" data-code-language="javascript"><code class="s2">"executionStats"</code><code class="o">:</code> <code class="p">{</code>
  <code class="s2">"executionSuccess"</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
  <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
  <code class="s2">"executionTimeMillis"</code><code class="o">:</code> <code class="mi">42</code><code class="p">,</code>
  <code class="s2">"totalKeysExamined"</code><code class="o">:</code> <code class="mi">9905</code><code class="p">,</code>
  <code class="s2">"totalDocsExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
  <code class="s2">"executionStages"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
    <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
    <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">34</code><code class="p">,</code>
    <code class="s2">"works"</code><code class="o">:</code> <code class="mi">9905</code><code class="p">,</code>
    <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
    <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">82</code><code class="p">,</code>
    <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">82</code><code class="p">,</code>
    <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"docsExamined"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
    <code class="s2">"alreadyHasObj"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"inputStage"</code><code class="o">:</code> <code class="p">{</code>
      <code class="s2">"stage"</code><code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
      <code class="s2">"nReturned"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"executionTimeMillisEstimate"</code><code class="o">:</code> <code class="mi">24</code><code class="p">,</code>
      <code class="s2">"works"</code><code class="o">:</code> <code class="mi">9905</code><code class="p">,</code>
      <code class="s2">"advanced"</code><code class="o">:</code> <code class="mi">9903</code><code class="p">,</code>
      <code class="s2">"needTime"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
      <code class="s2">"needYield"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"saveState"</code><code class="o">:</code> <code class="mi">82</code><code class="p">,</code>
      <code class="s2">"restoreState"</code><code class="o">:</code> <code class="mi">82</code><code class="p">,</code>
      <code class="s2">"isEOF"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
      <code class="s2">"invalidates"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"keyPattern"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"class_id"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"final_grade"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"student_id"</code><code class="o">:</code> <code class="mi">1</code>
      <code class="p">},</code>
      <code class="s2">"indexName"</code><code class="o">:</code> <code class="s2">"class_id_1_final_grade_1_student_id_1"</code><code class="p">,</code>
      <code class="s2">"isMultiKey"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
      <code class="s2">"multiKeyPaths"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
        <code class="s2">"final_grade"</code><code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
        <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
      <code class="p">},</code>
      <code class="s2">"isUnique"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
      <code class="s2">"isSparse"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
      <code class="s2">"isPartial"</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
      <code class="s2">"indexVersion"</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
      <code class="s2">"direction"</code><code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
      <code class="s2">"indexBounds"</code><code class="o">:</code> <code class="p">{</code>
        <code class="s2">"class_id"</code><code class="o">:</code> <code class="p">[</code>
          <code class="s2">"[54.0, 54.0]"</code>
        <code class="p">],</code>
        <code class="s2">"final_grade"</code><code class="o">:</code> <code class="p">[</code>
          <code class="s2">"[MinKey, MaxKey]"</code>
        <code class="p">],</code>
        <code class="s2">"student_id"</code><code class="o">:</code> <code class="p">[</code>
          <code class="s2">"(500000.0, inf.0]"</code>
        <code class="p">]</code>
      <code class="p">},</code>
      <code class="s2">"keysExamined"</code><code class="o">:</code> <code class="mi">9905</code><code class="p">,</code>
      <code class="s2">"seeks"</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
      <code class="s2">"dupsTested"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"dupsDropped"</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s2">"seenInvalidated"</code><code class="o">:</code> <code class="mi">0</code>
    <code class="p">}</code>
  <code class="p">}</code>
<code class="p">},</code></pre><p>This section has provided a concrete example of some best
      practices for designing compound indexes. While these guidelines do not
      hold for every situation, they do for most and should be the first ideas
      you consider when constructing a compound index.</p><p>To recap, when designing a compound index:</p><ul><li><p>Keys for equality filters should appear first.</p></li><li><p>Keys used for sorting should appear before multivalue
            fields.</p></li><li><p>Keys for multivalue filters should appear last.</p></li></ul><p>Design your compound index using these guidelines and then test it
      under real-world workloads for the range of query patterns your index is
      designed to support.</p><section data-type="sect3" data-pdf-bookmark="Choosing key directions"><div class="sect3" id="idm45882374459096"><h3>Choosing key directions</h3><p>So far, all<a data-type="indexterm" data-primary="keys" data-secondary="choosing key directions in compound indexes" id="idm45882374457992"/><a data-type="indexterm" data-primary="compound indexes" data-secondary="using" data-tertiary="choosing key directions" id="idm45882374456856"/> of our index entries have been sorted in
        <span class="firstterm">ascending</span>, or least-to-greatest, order.
        However, if you need to sort on two (or more) criteria, you may need
        to have index keys go in different directions. For example, going back
        to our earlier example with the <em>users</em> collection,
        suppose we wanted to sort the collection by age from youngest to
        oldest and by name from Z−A. Our previous indexes would not be very
        efficient for this problem: within each age group users were sorted by
        username in ascending order (A−Z, not Z−A). The compound indexes we’ve
        been using so far do not hold the values in any useful order for
        getting <code>"age"</code> ascending and
        <code>"username"</code> descending.</p><p>To optimize compound sorts in different directions, we need to
        use an index with matching directions. In this example, we could use
        <code>{"age" : 1, "username" : -1}</code>, which would organize the
        data as follows:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="nx">user999600</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8765277104</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="nx">user999407</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8765252400</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="nx">user999390</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8765250224</code>
<code class="p">...</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="nx">user100270</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623545776</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="nx">user100266</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623545264</code>
<code class="p">[</code><code class="mi">21</code><code class="p">,</code> <code class="nx">user100154</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623530928</code>
<code class="p">...</code>
<code class="p">[</code><code class="mi">30</code><code class="p">,</code> <code class="nx">user100168</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623532720</code>
<code class="p">[</code><code class="mi">30</code><code class="p">,</code> <code class="nx">user100155</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623531056</code>
<code class="p">[</code><code class="mi">30</code><code class="p">,</code> <code class="nx">user100098</code><code class="p">]</code> <code class="o">-&gt;</code> <code class="mi">8623523760</code></pre><p>The ages are arranged from youngest to oldest, and within each
        age, the usernames are sorted from Z to A (or rather 9 to 0, given our
        usernames).</p><p>If our application also needed to optimize sorting by <code>{"age" : 1, "username" : 1}</code>, we would have
        to create a second index with those directions. To figure out which
        directions to use for an index, simply match the directions your sort
        is using. Note that inverse indexes (multiplying each direction by −1)
        are equivalent: <code>{"age" : 1, "username" : -1}</code> suits the
        same queries that <code>{"age" : -1, "username" : 1}</code>
        does.</p><p>Index direction only really matters when you’re sorting based on
        multiple criteria. If you’re only sorting by a single key, MongoDB can
        just as easily read the index in the opposite order. For example, if
        you had a sort on <code>{"age" : -1}</code> and
        an index on <code>{"age" : 1}</code>, MongoDB
        could optimize it just as well as if you had an index on <code>{"age" : -1}</code> (so don’t create both!). The
        direction only matters for multikey sorts.</p></div></section><section data-type="sect3" data-pdf-bookmark="Using covered queries"><div class="sect3" id="sect3-covered"><h3>Using covered queries</h3><p>In<a data-type="indexterm" data-primary="compound indexes" data-secondary="using" data-tertiary="covered queries" id="idm45882374005544"/><a data-type="indexterm" data-primary="queries" data-secondary="covered queries" id="idm45882374004136"/> the preceding examples, the index was always used to
        find the correct document and then follow a pointer back to fetch the
        actual document. However, if your query is only looking for the fields
        that are included in the index, it does not need to fetch the
        document. When an index contains all the values requested by a query,
        the query is considered to be <em>covered</em>. Whenever
        practical, use covered queries in preference to going back to
        documents. You can make your working set much smaller that way.</p><p>To make sure a query can use the index only, you should use
        projections (which limit the fields returned to only those specified
        in your query; see <a data-type="xref" href="ch04.xhtml#sect2_d1e3675">“Specifying Which Keys to Return”</a>) to avoid
        returning the <code>"_id"</code> field (unless
        it is part of the index). You may also have to index fields that you
        aren’t querying on, so you should balance your need for faster queries
        with the overhead this will add on writes.</p><p>If you run <code>explain</code> on a
        covered query, the result has an <code>"IXSCAN"</code> stage that is
        <em>not</em> a descendant of a <code>"FETCH"</code> stage, and in the <code>"executionStats"</code>, the value of <code>"totalDocsExamined"</code> is <code>0</code>.</p></div></section><section data-type="sect3" data-pdf-bookmark="Implicit indexes"><div class="sect3" id="idm45882373999544"><h3>Implicit indexes</h3><p>Compound<a data-type="indexterm" data-primary="compound indexes" data-secondary="using" data-tertiary="implicit indexes" id="idm45882373995144"/><a data-type="indexterm" data-primary="indexes" data-secondary="implicit" id="idm45882373993736"/> indexes can do “double duty” and act like different
        indexes for different queries. If we have an index on <code>{"age" : 1, "username" : 1}</code>, the <code>"age"</code> field is sorted identically to the way
        it would be if we had an index on just <code>{"age"
        : 1}</code>. Thus, the compound index can be used the way an index
        on <code>{"age" : 1}</code> by itself would
        be.</p><p>This can be generalized to as many keys as necessary: if an
        index has <em>N</em> keys, you get a “free” index on any
        prefix of those keys. For example, if we have an index that looks like
        <code>{"a": 1, "b": 1, "c": 1, ..., "z":
        1}</code>, we effectively have indexes on <code>{"a": 1}</code>, <code>{"a": 1,
        "b" : 1}</code>, <code>{"a": 1, "b": 1, "c":
        1}</code>, and so on.</p><p>Note<a data-type="indexterm" data-startref="IBOcompound05" id="idm45882373987848"/><a data-type="indexterm" data-startref="CIuse05" id="idm45882373986984"/> that this doesn’t hold for
        <em>any</em> subset of keys: queries that would use the
        index <code>{"b": 1}</code> or <code>{"a": 1, "c": 1}</code> (for example) will not be
        optimized. Only queries that can use a prefix of the index can take
        advantage of it.</p></div></section></div></section><section data-type="sect2" data-pdf-bookmark="How $ Operators Use Indexes"><div class="sect2" id="idm45882377240632"><h2>How $ Operators Use Indexes</h2><p>Some<a data-type="indexterm" data-primary="indexes" data-secondary="basic operations" data-tertiary="query operators" id="IBOqo05"/> queries can use indexes more efficiently than others;
      some queries cannot use indexes at all. This section covers how various
      query operators are handled by <span class="keep-together">MongoDB</span>.</p><section data-type="sect3" data-pdf-bookmark="Inefficient operators"><div class="sect3" id="idm45882373981640"><h3>Inefficient operators</h3><p>In<a data-type="indexterm" data-primary="query operators" data-secondary="inefficient" id="idm45882373980408"/> general, negation is inefficient. <code>"$ne"</code> queries<a data-type="indexterm" data-primary="$ne operator" data-primary-sortas="ne operator" id="idm45882373978728"/> can use an index, but not very well. They must look at
        all the index entries other than the one specified by <code>"$ne"</code>, so they basically have to scan the
        entire index. For example, for a collection with an index on the field
        named <code class="varname">"i"</code>, here are the index ranges traversed for
        such a query:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">example</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"i"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"$ne"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">}}).</code><code class="nx">explain</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"queryPlanner"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="p">...,</code>
        <code class="s2">"parsedQuery"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"i"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"$ne"</code> <code class="o">:</code> <code class="s2">"3"</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"winningPlan"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="p">{</code>
            <code class="p">...,</code>
            <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"i"</code> <code class="o">:</code> <code class="p">[</code>
                    <code class="p">[</code>
                        <code class="p">{</code>
                            <code class="s2">"$minElement"</code> <code class="o">:</code> <code class="mi">1</code>
                        <code class="p">},</code>
                        <code class="mi">3</code>
                    <code class="p">],</code>
                    <code class="p">[</code>
                        <code class="mi">3</code><code class="p">,</code>
                        <code class="p">{</code>
                            <code class="s2">"$maxElement"</code> <code class="o">:</code> <code class="mi">1</code>
                        <code class="p">}</code>
                    <code class="p">]</code>
                <code class="p">]</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"rejectedPlans"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
    <code class="p">},</code>
    <code class="s2">"serverInfo"</code> <code class="o">:</code> <code class="p">{</code>        
        <code class="p">...,</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>This query looks at all index entries less than <code>3</code> and all index entries greater than
        <code>3</code>. This can be efficient if a large
        swath of your collection is <code>3</code>, but
        otherwise it must check almost everything.</p><p><code>"$not"</code> can<a data-type="indexterm" data-primary="$not operator" data-primary-sortas="not operator" id="idm45882373835464"/> sometimes use an index but often does not know how. It
        can reverse basic ranges (<code>{"<em><code>key</code></em>" : {"$lt" :
        7}}</code> becomes <code>{"<em><code>key</code></em>" : {"$gte" :
        7}}</code>) and regular expressions. However, most other queries
        with <code>"$not"</code> will fall back to doing
        a table scan. <code>"$nin"</code> always uses a
        table scan.</p><p>If you need to perform one of these types of queries quickly,
        figure out if there’s another clause that you could add to the query
        that could use an index to filter the result set down to a small
        number of documents before MongoDB attempts to do nonindexed
        matching.</p></div></section><section data-type="sect3" data-pdf-bookmark="Ranges"><div class="sect3" id="idm45882373830872"><h3>Ranges</h3><p>Compound<a data-type="indexterm" data-primary="compound indexes" data-secondary="benefits of" id="idm45882373829928"/><a data-type="indexterm" data-primary="query operators" data-secondary="ranges" id="idm45882373828792"/> indexes can help MongoDB efficiently execute queries
        with multiple clauses. When designing an index with multiple fields,
        put fields that will be used in exact matches first (e.g., <code>"x" : 1</code>) and ranges last (e.g., <code>"y": {"$gt" : 3, "$lt" : 5}</code>). This allows
        the query to find an exact value for the first index key and then
        search within that for a second index range. For example, suppose we
        were querying for a specific age and a range of usernames using an
        <code>{"age" : 1, "username" : 1}</code> index.
        We would get fairly exact index bounds:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"age"</code> <code class="o">:</code> <code class="mi">47</code><code class="p">,</code> <code class="s2">"username"</code> <code class="o">:</code> 
<code class="p">...</code> <code class="p">{</code><code class="s2">"$gt"</code> <code class="o">:</code> <code class="s2">"user5"</code><code class="p">,</code> <code class="s2">"$lt"</code> <code class="o">:</code> <code class="s2">"user8"</code><code class="p">}}).</code><code class="nx">explain</code><code class="p">(</code><code class="s1">'executionStats'</code><code class="p">)</code>
<code class="p">{</code>
    <code class="s2">"queryPlanner"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"plannerVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"namespace"</code> <code class="o">:</code> <code class="s2">"test.users"</code><code class="p">,</code>
        <code class="s2">"indexFilterSet"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"parsedQuery"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"$and"</code> <code class="o">:</code> <code class="p">[</code>
                <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$eq"</code> <code class="o">:</code> <code class="mi">47</code>
                    <code class="p">}</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$lt"</code> <code class="o">:</code> <code class="s2">"user8"</code>
                    <code class="p">}</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$gt"</code> <code class="o">:</code> <code class="s2">"user5"</code>
                    <code class="p">}</code>
                <code class="p">}</code>
            <code class="p">]</code>
        <code class="p">},</code>
        <code class="s2">"winningPlan"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
            <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                <code class="p">},</code>
                <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"age_1_username_1"</code><code class="p">,</code>
                <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"[47.0, 47.0]"</code>
                    <code class="p">],</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"(\"user5\", \"user8\")"</code>
                    <code class="p">]</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"rejectedPlans"</code> <code class="o">:</code> <code class="p">[</code>
            <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
                <code class="s2">"filter"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$eq"</code> <code class="o">:</code> <code class="mi">47</code>
                    <code class="p">}</code>
                <code class="p">},</code>
                <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                    <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                    <code class="p">},</code>
                    <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"username_1"</code><code class="p">,</code>
                    <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                    <code class="p">},</code>
                    <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                    <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                    <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                            <code class="s2">"(\"user5\", \"user8\")"</code>
                        <code class="p">]</code>
                    <code class="p">}</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">]</code>
    <code class="p">},</code>
    <code class="s2">"executionStats"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"executionSuccess"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
        <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
        <code class="s2">"executionTimeMillis"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
        <code class="s2">"totalKeysExamined"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
        <code class="s2">"totalDocsExamined"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
        <code class="s2">"executionStages"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
            <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
            <code class="s2">"executionTimeMillisEstimate"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"works"</code> <code class="o">:</code> <code class="mi">2743</code><code class="p">,</code>
            <code class="s2">"advanced"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
            <code class="s2">"needTime"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"needYield"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"saveState"</code> <code class="o">:</code> <code class="mi">23</code><code class="p">,</code>
            <code class="s2">"restoreState"</code> <code class="o">:</code> <code class="mi">23</code><code class="p">,</code>
            <code class="s2">"isEOF"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"invalidates"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"docsExamined"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
            <code class="s2">"alreadyHasObj"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
                <code class="s2">"executionTimeMillisEstimate"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"works"</code> <code class="o">:</code> <code class="mi">2743</code><code class="p">,</code>
                <code class="s2">"advanced"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
                <code class="s2">"needTime"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"needYield"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"saveState"</code> <code class="o">:</code> <code class="mi">23</code><code class="p">,</code>
                <code class="s2">"restoreState"</code> <code class="o">:</code> <code class="mi">23</code><code class="p">,</code>
                <code class="s2">"isEOF"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"invalidates"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                <code class="p">},</code>
                <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"age_1_username_1"</code><code class="p">,</code>
                <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"[47.0, 47.0]"</code>
                    <code class="p">],</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"(\"user5\", \"user8\")"</code>
                    <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"keysExamined"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
                <code class="s2">"seeks"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"dupsTested"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"dupsDropped"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"seenInvalidated"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"serverInfo"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"eoinbrazil-laptop-osx"</code><code class="p">,</code>
        <code class="s2">"port"</code> <code class="o">:</code> <code class="mi">27017</code><code class="p">,</code>
        <code class="s2">"version"</code> <code class="o">:</code> <code class="s2">"4.0.12"</code><code class="p">,</code>
        <code class="s2">"gitVersion"</code> <code class="o">:</code> <code class="s2">"5776e3cbf9e7afe86e6b29e22520ffb6766e95d4"</code>
    <code class="p">},</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>The query goes directly to <code>"age" :
        47</code> and then searches within that for usernames between
        <code>"user5"</code> and <code>"user8"</code>.</p><p>Conversely, suppose we use an index on <code>{"username" : 1, "age" : 1}</code>. This changes
        the query plan, as the query must look at all users between <code>"user5"</code> and <code>"user8"</code> and pick out the ones with <code>"age" : 47</code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"age"</code> <code class="o">:</code> <code class="mi">47</code><code class="p">,</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"$gt"</code> <code class="o">:</code> <code class="s2">"user5"</code><code class="p">,</code> <code class="s2">"$lt"</code> <code class="o">:</code> <code class="s2">"user8"</code><code class="p">}})</code>
                <code class="p">.</code><code class="nx">explain</code><code class="p">(</code><code class="s1">'executionStats'</code><code class="p">)</code>
<code class="p">{</code>
    <code class="s2">"queryPlanner"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"plannerVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"namespace"</code> <code class="o">:</code> <code class="s2">"test.users"</code><code class="p">,</code>
        <code class="s2">"indexFilterSet"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"parsedQuery"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"$and"</code> <code class="o">:</code> <code class="p">[</code>
                <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$eq"</code> <code class="o">:</code> <code class="mi">47</code>
                    <code class="p">}</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$lt"</code> <code class="o">:</code> <code class="s2">"user8"</code>
                    <code class="p">}</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$gt"</code> <code class="o">:</code> <code class="s2">"user5"</code>
                    <code class="p">}</code>
                <code class="p">}</code>
            <code class="p">]</code>
        <code class="p">},</code>
        <code class="s2">"winningPlan"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
            <code class="s2">"filter"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"age"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"$eq"</code> <code class="o">:</code> <code class="mi">47</code>
                <code class="p">}</code>
            <code class="p">},</code>
            <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                <code class="p">},</code>
                <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"username_1"</code><code class="p">,</code>
                <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"(\"user5\", \"user8\")"</code>
                    <code class="p">]</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"rejectedPlans"</code> <code class="o">:</code> <code class="p">[</code>
            <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
                <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                    <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                        <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">1</code>
                    <code class="p">},</code>
                    <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"username_1_age_1"</code><code class="p">,</code>
                    <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
                        <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                    <code class="p">},</code>
                    <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                    <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                    <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                            <code class="s2">"(\"user5\", \"user8\")"</code>
                        <code class="p">],</code>
                        <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code>
                            <code class="s2">"[47.0, 47.0]"</code>
                        <code class="p">]</code>
                    <code class="p">}</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">]</code>
    <code class="p">},</code>
    <code class="s2">"executionStats"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"executionSuccess"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
        <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
        <code class="s2">"executionTimeMillis"</code> <code class="o">:</code> <code class="mi">369</code><code class="p">,</code>
        <code class="s2">"totalKeysExamined"</code> <code class="o">:</code> <code class="mi">333332</code><code class="p">,</code>
        <code class="s2">"totalDocsExamined"</code> <code class="o">:</code> <code class="mi">333332</code><code class="p">,</code>
        <code class="s2">"executionStages"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
            <code class="s2">"filter"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"age"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"$eq"</code> <code class="o">:</code> <code class="mi">47</code>
                <code class="p">}</code>
            <code class="p">},</code>
            <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
            <code class="s2">"executionTimeMillisEstimate"</code> <code class="o">:</code> <code class="mi">312</code><code class="p">,</code>
            <code class="s2">"works"</code> <code class="o">:</code> <code class="mi">333333</code><code class="p">,</code>
            <code class="s2">"advanced"</code> <code class="o">:</code> <code class="mi">2742</code><code class="p">,</code>
            <code class="s2">"needTime"</code> <code class="o">:</code> <code class="mi">330590</code><code class="p">,</code>
            <code class="s2">"needYield"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"saveState"</code> <code class="o">:</code> <code class="mi">2697</code><code class="p">,</code>
            <code class="s2">"restoreState"</code> <code class="o">:</code> <code class="mi">2697</code><code class="p">,</code>
            <code class="s2">"isEOF"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"invalidates"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"docsExamined"</code> <code class="o">:</code> <code class="mi">333332</code><code class="p">,</code>
            <code class="s2">"alreadyHasObj"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">333332</code><code class="p">,</code>
                <code class="s2">"executionTimeMillisEstimate"</code> <code class="o">:</code> <code class="mi">117</code><code class="p">,</code>
                <code class="s2">"works"</code> <code class="o">:</code> <code class="mi">333333</code><code class="p">,</code>
                <code class="s2">"advanced"</code> <code class="o">:</code> <code class="mi">333332</code><code class="p">,</code>
                <code class="s2">"needTime"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"needYield"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"saveState"</code> <code class="o">:</code> <code class="mi">2697</code><code class="p">,</code>
                <code class="s2">"restoreState"</code> <code class="o">:</code> <code class="mi">2697</code><code class="p">,</code>
                <code class="s2">"isEOF"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"invalidates"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                <code class="p">},</code>
                <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"username_1"</code><code class="p">,</code>
                <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"(\"user5\", \"user8\")"</code>
                    <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"keysExamined"</code> <code class="o">:</code> <code class="mi">333332</code><code class="p">,</code>
                <code class="s2">"seeks"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"dupsTested"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"dupsDropped"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"seenInvalidated"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"serverInfo"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"eoinbrazil-laptop-osx"</code><code class="p">,</code>
        <code class="s2">"port"</code> <code class="o">:</code> <code class="mi">27017</code><code class="p">,</code>
        <code class="s2">"version"</code> <code class="o">:</code> <code class="s2">"4.0.12"</code><code class="p">,</code>
        <code class="s2">"gitVersion"</code> <code class="o">:</code> <code class="s2">"5776e3cbf9e7afe86e6b29e22520ffb6766e95d4"</code>
    <code class="p">},</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>This forces MongoDB to scan 100 times the number of index
        entries as using the previous index would. Using two ranges in a query
        basically always forces this less-efficient query plan.</p></div></section><section data-type="sect3" data-pdf-bookmark="OR queries"><div class="sect3" id="idm45882372987576"><h3>OR queries</h3><p>As<a data-type="indexterm" data-primary="query operators" data-secondary="OR" id="idm45882372986472"/><a data-type="indexterm" data-primary="$or operator" data-primary-sortas="or operator" id="idm45882372985464"/> of this writing, MongoDB can only use one index per
        query. That is, if you create one index on <code>{"x" : 1}</code> and
        another index on <code>{"y" : 1}</code> and then do a query on
        <code>{"x" : 123, "y" : 456}</code>, MongoDB will use one of the
        indexes you created, not both. The only exception to this rule is
        <code class="varname">"$or"</code>. <code class="varname">"$or"</code> can use one index
        per <code>"$or"</code> clause, as <code>"$or"</code> performs two queries and then merges
        the results:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">foo</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"$or"</code> <code class="o">:</code> <code class="p">[{</code><code class="s2">"x"</code> <code class="o">:</code> <code class="mi">123</code><code class="p">},</code> <code class="p">{</code><code class="s2">"y"</code> <code class="o">:</code> <code class="mi">456</code><code class="p">}]}).</code><code class="nx">explain</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"queryPlanner"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"plannerVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"namespace"</code> <code class="o">:</code> <code class="s2">"foo.foo"</code><code class="p">,</code>
        <code class="s2">"indexFilterSet"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"parsedQuery"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"$or"</code> <code class="o">:</code> <code class="p">[</code>
                <code class="p">{</code>
                    <code class="s2">"x"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$eq"</code> <code class="o">:</code> <code class="mi">123</code>
                    <code class="p">}</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"y"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$eq"</code> <code class="o">:</code> <code class="mi">456</code>
                    <code class="p">}</code>
                <code class="p">}</code>
            <code class="p">]</code>
        <code class="p">},</code>
        <code class="s2">"winningPlan"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"SUBPLAN"</code><code class="p">,</code>
            <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
                <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"OR"</code><code class="p">,</code>
                    <code class="s2">"inputStages"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="p">{</code>
                            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                            <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                                <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">1</code>
                            <code class="p">},</code>
                            <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"x_1"</code><code class="p">,</code>
                            <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                            <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                                <code class="s2">"x"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                            <code class="p">},</code>
                            <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                            <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                            <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                            <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                            <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                            <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                                <code class="s2">"x"</code> <code class="o">:</code> <code class="p">[</code>
                                    <code class="s2">"[123.0, 123.0]"</code>
                                <code class="p">]</code>
                            <code class="p">}</code>
                        <code class="p">},</code>
                        <code class="p">{</code>
                            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                            <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                                <code class="s2">"y"</code> <code class="o">:</code> <code class="mi">1</code>
                            <code class="p">},</code>
                            <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"y_1"</code><code class="p">,</code>
                            <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                            <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                                <code class="s2">"y"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                            <code class="p">},</code>
                            <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                            <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                            <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                            <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                            <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                            <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                                <code class="s2">"y"</code> <code class="o">:</code> <code class="p">[</code>
                                    <code class="s2">"[456.0, 456.0]"</code>
                                <code class="p">]</code>
                            <code class="p">}</code>
                        <code class="p">}</code>
                    <code class="p">]</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"rejectedPlans"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
    <code class="p">},</code>
    <code class="s2">"serverInfo"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="p">...,</code>
     <code class="p">},</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>As you can see, this <code>explain</code>
        required two separate queries on the two indexes (as indicated by the
        two <code>"IXSCAN"</code> stages). In general,
        doing two queries and merging the results is much less efficient than
        doing a single query; thus, whenever possible, prefer<a data-type="indexterm" data-primary="$in operator" data-primary-sortas="in operator" id="idm45882372409896"/> <code>"$in"</code> to <code>"$or"</code>.</p><p>If you must use an <code>"$or"</code>,
        keep in mind that MongoDB needs to look through the results of both
        queries and remove any duplicates (documents that matched more than
        one <code>"$or"</code> clause).</p><p>When<a data-type="indexterm" data-startref="IBOqo05" id="idm45882372406408"/> running <code>"$in"</code> queries there is no way, other than
        sorting, to control the order of documents returned. For example,
        <code>{"x" : {"$in" : [1, 2, 3]}}</code> will
        return documents in the same order as <code>{"x" :
        {"$in" : [3, 2, 1]}}</code>.</p></div></section></div></section><section data-type="sect2" data-pdf-bookmark="Indexing Objects and Arrays"><div class="sect2" id="sect2_d1e5358"><h2>Indexing Objects and Arrays</h2><p>MongoDB<a data-type="indexterm" data-primary="indexes" data-secondary="basic operations" data-tertiary="objects and arrays" id="idm45882372175304"/><a data-type="indexterm" data-primary="objects, indexing" id="idm45882372173896"/> allows you to reach into your documents and create
      indexes on nested fields and arrays. Embedded object and array fields
      can be combined with top-level fields in compound indexes, and although
      they are special in some ways, they mostly behave the way “normal” index
      fields behave.</p><section data-type="sect3" data-pdf-bookmark="Indexing embedded docs"><div class="sect3" id="idm45882372172616"><h3>Indexing embedded docs</h3><p>Indexes<a data-type="indexterm" data-primary="embedded documents" data-secondary="indexing" id="idm45882372171640"/> can be created on keys in embedded documents in the
        same way that they are created on normal keys. If we had a collection
        where each document represented a user, we might have an embedded
        document that described each user’s location:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
    <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"sid"</code><code class="p">,</code>
    <code class="s2">"loc"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"ip"</code> <code class="o">:</code> <code class="s2">"1.2.3.4"</code><code class="p">,</code>
        <code class="s2">"city"</code> <code class="o">:</code> <code class="s2">"Springfield"</code><code class="p">,</code>
        <code class="s2">"state"</code> <code class="o">:</code> <code class="s2">"NY"</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>We could put an index on one of the subfields of
        <code class="varname">"loc"</code>, say <code class="varname">"loc.city"</code>, to speed
        up queries using that field:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="s2">"loc.city"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><p>You can go as deep as you’d like with these: you could index
        <code class="varname">"x.y.z.w.a.b.c"</code> (and so on) if you wanted.</p><p>Note that indexing the embedded document itself
        (<code class="varname">"loc"</code>) has very different behavior than indexing a
        field of that embedded document (<code class="varname">"loc.city"</code>).
        Indexing the entire subdocument will only help queries that are
        querying for the entire subdocument. The query optimizer could only
        use an index on <code class="varname">"loc"</code> for queries that described
        the whole subdocument with fields in the correct order (e.g.,
        <code>db.users.find({"loc" : {"ip" : "123.456.789.000", "city" :
        "Shelbyville", "state" : "NY"}}})</code>). It could not use the index
        for queries that looked like <code>db.users.find({"loc.city" :
        "Shelbyville"})</code>.</p></div></section><section data-type="sect3" data-pdf-bookmark="Indexing arrays"><div class="sect3" id="idm45882372141832"><h3>Indexing arrays</h3><p>You<a data-type="indexterm" data-primary="arrays" data-secondary="indexing" id="idm45882372135784"/> can also index arrays, which allows you to use the
        index to search for specific array elements efficiently.</p><p>Suppose we have a collection of blog posts where each document
        is a post. Each post has a <code>"comments"</code> field, which is an array of
        <code>"comment"</code> subdocuments. If we
        wanted to be able to find the most recently commented-on blog posts,
        we could create an index on the <code>"date"</code> key in the array of embedded <code>"comments"</code> documents of our blog post
        <span class="keep-together">collection</span>:</p><pre id="I_programlisting5_d1e5533" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="s2">"comments.date"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><p>Indexing an array creates an index entry for each element of the
        array, so if a post had 20 comments, it would have 20 index entries.
        This makes array indexes more expensive than single-value ones: for a
        single insert, update, or remove, every array entry might have to be
        updated (potentially thousands of index entries).</p><p>Unlike the <code>"loc"</code> example in
        the previous section, you cannot index an entire array as a single
        entity: indexing an array field indexes each element of the array, not
        the array itself.</p><p>Indexes on array elements do not keep any notion of position:
        you cannot use an index for a query that is looking for a specific
        array element, such as <code>"comments.4"</code>.</p><p>You can, incidentally, index a specific array entry, as
        in:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">blog</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="s2">"comments.10.votes"</code><code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><p>However, this index would only be useful for queries for exactly
        the 11th array element (arrays start at index 0).</p><p>Only one field in an index entry can be from an array. This is
        to avoid the explosive number of index entries you’d get from multiple
        multikey indexes: every possible pair of elements would have to be
        indexed, causing indexes to be <em>n*m</em> entries per
        document. For example, suppose we had an index on <code>{"x" : 1, "y" : 1}</code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="c1">// x is an array - legal</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">multi</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="s2">"x"</code> <code class="o">:</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">],</code> <code class="s2">"y"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code>
<code class="o">&gt;</code>
<code class="o">&gt;</code> <code class="c1">// y is an array - still legal</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">multi</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="s2">"x"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"y"</code> <code class="o">:</code> <code class="p">[</code><code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">]})</code>
<code class="o">&gt;</code>
<code class="o">&gt;</code> <code class="c1">// x and y are arrays - illegal!</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">multi</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="s2">"x"</code> <code class="o">:</code> <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">],</code> <code class="s2">"y"</code> <code class="o">:</code> <code class="p">[</code><code class="mi">4</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">]})</code>
<code class="nx">cannot</code> <code class="nx">index</code> <code class="nx">parallel</code> <code class="nx">arrays</code> <code class="p">[</code><code class="nx">y</code><code class="p">]</code> <code class="p">[</code><code class="nx">x</code><code class="p">]</code></pre><p>Were MongoDB to index the final example, it would have to create
        index entries for <code>{"x" : 1, "y" :
        4}</code>, <code>{"x" : 1, "y" : 5}</code>,
        <code>{"x" : 1, "y" : 6}</code>, <code>{"x" : 2, "y" : 4}</code>, <code>{"x" : 2, "y" : 5}</code>, <code>{"x" : 2, "y" : 6}</code>, <code>{"x" : 3, "y" : 4}</code>, <code>{"x" : 3, "y" : 5}</code>, and <code>{"x" : 3, "y" : 6}</code> (and these arrays are
        only three elements long).</p></div></section><section data-type="sect3" data-pdf-bookmark="Multikey index implications"><div class="sect3" id="idm45882372136664"><h3>Multikey index implications</h3><p>If<a data-type="indexterm" data-primary="indexes" data-secondary="multikey" id="idm45882371766248"/> any document has an array field for the indexed key,
        the index immediately is flagged as a <span class="firstterm">multikey
        index</span>. You can see whether an index is multikey from
        <code>explain</code>’s output: if a multikey
        index was used, the <code>"isMultikey"</code>
        field will be <code>true</code>. Once an index
        has been flagged as multikey, it can never be un-multikeyed, even if
        all of the documents containing arrays in that field are removed. The
        only way to un-multikey it is to drop and recreate it.</p><p>Multikey indexes may be a bit slower than non-multikey indexes.
        Many index entries can point at a single document, so MongoDB may need
        to do some deduplication before returning results.</p></div></section></div></section><section data-type="sect2" data-pdf-bookmark="Index Cardinality"><div class="sect2" id="idm45882371762408"><h2>Index Cardinality</h2><p><em>Cardinality</em> refers<a data-type="indexterm" data-primary="indexes" data-secondary="basic operations" data-tertiary="index cardinality" id="idm45882371760984"/> to how many distinct values there are for a field in a
      collection. Some fields, such as <code>"gender"</code> or <code>"newsletter opt-out"</code>, might only have two
      possible values, which is considered a very low cardinality. Others,
      such as <code>"username"</code> or <code>"email"</code>, might have a unique value for every
      document in the collection, which is high cardinality. Still others fall
      somewhere in between, such as <code>"age"</code>
      or <code>"zip code"</code>.</p><p>In general, the greater the cardinality of a field, the more
      helpful an index on that field can be. This is because the index can
      quickly narrow the search space to a much smaller result set. For a
      low-cardinality field, an index generally cannot eliminate as many
      possible matches.</p><p>For example, suppose we had an index on <code>"gender"</code> and were looking for women named
      Susan. We could only narrow down the result space by approximately 50%
      before referring to individual documents to look up <code>"name"</code>. Conversely, if we indexed by <code>"name"</code>, we could immediately narrow down our
      result set to the tiny fraction of users named Susan, and then we could
      refer to those documents to check the gender.</p><p>As a rule of thumb, try to create indexes on high-cardinality keys
      or at least put high-cardinality keys first in compound indexes (before
      low-cardinality keys).</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="explain Output"><div class="sect1" id="sect1_d1e5527"><h1>explain Output</h1><p>As<a data-type="indexterm" data-primary="indexes" data-secondary="explain output" data-tertiary="uses for" id="idm45882371752136"/> you’ve seen, <code class="function">explain</code>
    gives you lots of information about your queries. It’s one of the most
    important diagnostic tools there is for slow queries. You can find out
    which indexes are being used and how by looking at a query’s <code>"explain"</code> output. For any query, you can add a
    call to <code class="function">explain</code> at the end (the way
    you would add a <code class="function">sort</code> or <code class="function">limit</code>, but <code class="function">explain</code> must be the last call).</p><p>There<a data-type="indexterm" data-primary="indexes" data-secondary="explain output" data-tertiary="types of" id="idm45882371746280"/> are two types of <code class="function">explain</code> output that you’ll see most commonly:
    for indexed and nonindexed queries. Special index types may create
    slightly different query plans, but most fields should be similar. Also,
    sharding returns a conglomerate of <code class="function">explain</code>s (as covered in <a data-type="xref" href="ch14.xhtml#chapter_d1e10482">Chapter 14</a>), as it runs the query on multiple
    servers.</p><p>The most basic type of <code class="function">explain</code>
    is on a query that doesn’t use an index. You can tell that a query doesn’t
    use an index because it uses a <code>"COLLSCAN"</code>.</p><p>The output of an <code class="function">explain</code> on a
    query that uses an index varies, but in the simplest case it looks
    something like this if we add an index on <code>imdb.rating</code>:</p><pre id="I_programlisting5_d1e5775" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"age"</code> <code class="o">:</code> <code class="mi">42</code><code class="p">}).</code><code class="nx">explain</code><code class="p">(</code><code class="s1">'executionStats'</code><code class="p">)</code>
<code class="p">{</code>
    <code class="s2">"queryPlanner"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"plannerVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"namespace"</code> <code class="o">:</code> <code class="s2">"test.users"</code><code class="p">,</code>
        <code class="s2">"indexFilterSet"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"parsedQuery"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"age"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"$eq"</code> <code class="o">:</code> <code class="mi">42</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"winningPlan"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
            <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                <code class="p">},</code>
                <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"age_1_username_1"</code><code class="p">,</code>
                <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"[42.0, 42.0]"</code>
                    <code class="p">],</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"[MinKey, MaxKey]"</code>
                    <code class="p">]</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"rejectedPlans"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
    <code class="p">},</code>
    <code class="s2">"executionStats"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"executionSuccess"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
        <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">8449</code><code class="p">,</code>
        <code class="s2">"executionTimeMillis"</code> <code class="o">:</code> <code class="mi">15</code><code class="p">,</code>
        <code class="s2">"totalKeysExamined"</code> <code class="o">:</code> <code class="mi">8449</code><code class="p">,</code>
        <code class="s2">"totalDocsExamined"</code> <code class="o">:</code> <code class="mi">8449</code><code class="p">,</code>
        <code class="s2">"executionStages"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
            <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">8449</code><code class="p">,</code>
            <code class="s2">"executionTimeMillisEstimate"</code> <code class="o">:</code> <code class="mi">10</code><code class="p">,</code>
            <code class="s2">"works"</code> <code class="o">:</code> <code class="mi">8450</code><code class="p">,</code>
            <code class="s2">"advanced"</code> <code class="o">:</code> <code class="mi">8449</code><code class="p">,</code>
            <code class="s2">"needTime"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"needYield"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"saveState"</code> <code class="o">:</code> <code class="mi">66</code><code class="p">,</code>
            <code class="s2">"restoreState"</code> <code class="o">:</code> <code class="mi">66</code><code class="p">,</code>
            <code class="s2">"isEOF"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"invalidates"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"docsExamined"</code> <code class="o">:</code> <code class="mi">8449</code><code class="p">,</code>
            <code class="s2">"alreadyHasObj"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                <code class="s2">"nReturned"</code> <code class="o">:</code> <code class="mi">8449</code><code class="p">,</code>
                <code class="s2">"executionTimeMillisEstimate"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"works"</code> <code class="o">:</code> <code class="mi">8450</code><code class="p">,</code>
                <code class="s2">"advanced"</code> <code class="o">:</code> <code class="mi">8449</code><code class="p">,</code>
                <code class="s2">"needTime"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"needYield"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"saveState"</code> <code class="o">:</code> <code class="mi">66</code><code class="p">,</code>
                <code class="s2">"restoreState"</code> <code class="o">:</code> <code class="mi">66</code><code class="p">,</code>
                <code class="s2">"isEOF"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"invalidates"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                <code class="p">},</code>
                <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"age_1_username_1"</code><code class="p">,</code>
                <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"[42.0, 42.0]"</code>
                    <code class="p">],</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"[MinKey, MaxKey]"</code>
                    <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"keysExamined"</code> <code class="o">:</code> <code class="mi">8449</code><code class="p">,</code>
                <code class="s2">"seeks"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"dupsTested"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"dupsDropped"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"seenInvalidated"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"serverInfo"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"eoinbrazil-laptop-osx"</code><code class="p">,</code>
        <code class="s2">"port"</code> <code class="o">:</code> <code class="mi">27017</code><code class="p">,</code>
        <code class="s2">"version"</code> <code class="o">:</code> <code class="s2">"4.0.12"</code><code class="p">,</code>
        <code class="s2">"gitVersion"</code> <code class="o">:</code> <code class="s2">"5776e3cbf9e7afe86e6b29e22520ffb6766e95d4"</code>
    <code class="p">},</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>This output first tells you what index was used: <code>imdb.rating</code>. Next is how many documents were
    actually returned as a result: <code>"nReturned"</code>. Note that this doesn’t necessarily
    reflect how much work MongoDB did to answer the query (i.e., how many
    indexes and documents it had to search). <code>"totalKeysExamined"</code> reports the number of index
    entries scanned while <code>"totalDocsExamined"</code> indicates how many documents
    were scanned. The number of documents scanned is reflected in <code>"nscannedObjects"</code>.</p><p>The output also shows that there were no <code>rejectedPlans</code> and that it used a bounded search
    on the index within the value 42.0.</p><p><code>"executionTimeMillis"</code> reports how
    fast the query was executed, from the server receiving the request to when
    it sent a response. However, it may not always be the number you are
    looking for. If MongoDB tried multiple query plans, <code>"executionTimeMillis"</code> will reflect how long it
    took all of them to run, not the one chosen as the best.</p><p>Now<a data-type="indexterm" data-primary="indexes" data-secondary="explain output" data-tertiary="important fields" id="idm45882371595160"/> that you know the basics, here is a breakdown of some of
    the more important fields in more detail:</p><dl><dt><code>"isMultiKey" : false</code></dt><dd><p>If this query used a multikey index (see <a data-type="xref" href="#sect2_d1e5358">“Indexing Objects and Arrays”</a>).</p></dd><dt><code>"nReturned" : 8449</code></dt><dd><p>The number of documents returned by the query.</p></dd><dt><code>"totalDocsExamined" :
        8449</code></dt><dd><p>The number of times MongoDB had to follow an index pointer to
          the actual document on disk. If the query contains criteria that are
          not part of the index or requests fields that aren’t contained in
          the index, MongoDB must look up the document each index entry points
          to.</p></dd><dt><code>"totalKeysExamined" :
        8449</code></dt><dd><p>The number of index entries looked at, if an index was used.
          If this was a table scan, it is the number of documents
          examined.</p></dd><dt><code>"stage" : "IXSCAN"</code></dt><dd><p>If MongoDB was able to fulfill this query using an index; if
          not <code>"COLSCAN"</code> would indicate it
          had to perform a collection scan to fulfill the query.</p><p>In this example, MongoDB found all matching documents using
          the index, which we know because
          <code class="varname">"totalKeysExamined"</code> is the same as
          <code class="varname">"totalDocsExamined"</code>. However, the query was told
          to return every field in the matching documents and the index only
          contained the <code>"age"</code> and <code>"username"</code> fields.</p></dd><dt><code>"needYield" : 0</code></dt><dd><p>The number of times this query yielded (paused) to allow a
          write request to proceed. If there are writes waiting to go, queries
          will periodically release their lock and allow them to continue. On
          this system, there were no writes waiting so the query never
          yielded.</p></dd><dt><code>"executionTimeMillis" :
        15</code></dt><dd><p>The number of milliseconds it took the database to execute the
          query. The lower this number is, the better.</p></dd><dt><code>"indexBounds" : {...}</code></dt><dd><p>A description of how the index was used, giving ranges of the
          index traversed. In this example, as the first clause in the query
          was an exact match, the index only needed to look at that value:
          <code>42</code>. The second index key was a
          free variable, because the query didn’t specify any restrictions to
          it. Thus, the database looked for values between negative infinity
          (<code><code>"$minElement" :
          1</code></code>) and infinity (<code><code>"$maxElement" :
          1</code></code>) for usernames within <code>"age" : 42</code>.</p></dd></dl><p>Let’s take<a data-type="indexterm" data-primary="indexes" data-secondary="explain output" data-tertiary="example of" id="idm45882371234760"/> a look at a slightly more complicated example. Suppose you
    have an index on <code>{"username" : 1, "age" :
    1}</code> and an index on <code>{"age" : 1,
    "username" : 1}</code>. What happens if you query for <code>"username"</code> and <code>"age"</code>? Well, it depends on the query:</p><pre id="I_programlisting5_d1e5887" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"age"</code> <code class="o">:</code> <code class="p">{</code><code class="nx">$gt</code> <code class="o">:</code> <code class="mi">10</code><code class="p">},</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user2134"</code><code class="p">}).</code><code class="nx">explain</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"queryPlanner"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"plannerVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"namespace"</code> <code class="o">:</code> <code class="s2">"test.users"</code><code class="p">,</code>
        <code class="s2">"indexFilterSet"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"parsedQuery"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"$and"</code> <code class="o">:</code> <code class="p">[</code>
                <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$eq"</code> <code class="o">:</code> <code class="s2">"user2134"</code>
                    <code class="p">}</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$gt"</code> <code class="o">:</code> <code class="mi">10</code>
                    <code class="p">}</code>
                <code class="p">}</code>
            <code class="p">]</code>
        <code class="p">},</code>
        <code class="s2">"winningPlan"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
            <code class="s2">"filter"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"age"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"$gt"</code> <code class="o">:</code> <code class="mi">10</code>
                <code class="p">}</code>
            <code class="p">},</code>
            <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                <code class="p">},</code>
                <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"username_1"</code><code class="p">,</code>
                <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"[\"user2134\", \"user2134\"]"</code>
                    <code class="p">]</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"rejectedPlans"</code> <code class="o">:</code> <code class="p">[</code>
            <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
                <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                    <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                    <code class="p">},</code>
                    <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"age_1_username_1"</code><code class="p">,</code>
                    <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                    <code class="p">},</code>
                    <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                    <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                    <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code>
                            <code class="s2">"(10.0, inf.0]"</code>
                        <code class="p">],</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                            <code class="s2">"[\"user2134\", \"user2134\"]"</code>
                        <code class="p">]</code>
                    <code class="p">}</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">]</code>
    <code class="p">},</code>
    <code class="s2">"serverInfo"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"eoinbrazil-laptop-osx"</code><code class="p">,</code>
        <code class="s2">"port"</code> <code class="o">:</code> <code class="mi">27017</code><code class="p">,</code>
        <code class="s2">"version"</code> <code class="o">:</code> <code class="s2">"4.0.12"</code><code class="p">,</code>
        <code class="s2">"gitVersion"</code> <code class="o">:</code> <code class="s2">"5776e3cbf9e7afe86e6b29e22520ffb6766e95d4"</code>
    <code class="p">},</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>We are querying for an exact match on <code>"username"</code> and a range of values for <code>"age"</code>, so the database chooses to use the
    <code>{"username" : 1, "age" : 1}</code> index,
    reversing the terms of the query. If, on the other hand, we query for an
    exact age and a range of names, MongoDB will use the other index:</p><pre id="I_programlisting5_d1e5900" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"age"</code> <code class="o">:</code> <code class="mi">14</code><code class="p">,</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="sr">/.*/</code><code class="p">}).</code><code class="nx">explain</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"queryPlanner"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"plannerVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"namespace"</code> <code class="o">:</code> <code class="s2">"test.users"</code><code class="p">,</code>
        <code class="s2">"indexFilterSet"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
        <code class="s2">"parsedQuery"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"$and"</code> <code class="o">:</code> <code class="p">[</code>
                <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$eq"</code> <code class="o">:</code> <code class="mi">14</code>
                    <code class="p">}</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$regex"</code> <code class="o">:</code> <code class="s2">".*"</code>
                    <code class="p">}</code>
                <code class="p">}</code>
            <code class="p">]</code>
        <code class="p">},</code>
        <code class="s2">"winningPlan"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
            <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                <code class="s2">"filter"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$regex"</code> <code class="o">:</code> <code class="s2">".*"</code>
                    <code class="p">}</code>
                <code class="p">},</code>
                <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                <code class="p">},</code>
                <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"age_1_username_1"</code><code class="p">,</code>
                <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                <code class="p">},</code>
                <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"[14.0, 14.0]"</code>
                    <code class="p">],</code>
                    <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                        <code class="s2">"[\"\", {})"</code><code class="p">,</code>
                        <code class="s2">"[/.*/, /.*/]"</code>
                    <code class="p">]</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"rejectedPlans"</code> <code class="o">:</code> <code class="p">[</code>
            <code class="p">{</code>
                <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
                <code class="s2">"filter"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"age"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"$eq"</code> <code class="o">:</code> <code class="mi">14</code>
                    <code class="p">}</code>
                <code class="p">},</code>
                <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
                    <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
                    <code class="s2">"filter"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
                            <code class="s2">"$regex"</code> <code class="o">:</code> <code class="s2">".*"</code>
                        <code class="p">}</code>
                    <code class="p">},</code>
                    <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
                    <code class="p">},</code>
                    <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"username_1"</code><code class="p">,</code>
                    <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
                    <code class="p">},</code>
                    <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
                    <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
                    <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
                        <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                            <code class="s2">"[\"\", {})"</code><code class="p">,</code>
                            <code class="s2">"[/.*/, /.*/]"</code>
                        <code class="p">]</code>
                    <code class="p">}</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">]</code>
    <code class="p">},</code>
    <code class="s2">"serverInfo"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"eoinbrazil-laptop-osx"</code><code class="p">,</code>
        <code class="s2">"port"</code> <code class="o">:</code> <code class="mi">27017</code><code class="p">,</code>
        <code class="s2">"version"</code> <code class="o">:</code> <code class="s2">"4.0.12"</code><code class="p">,</code>
        <code class="s2">"gitVersion"</code> <code class="o">:</code> <code class="s2">"5776e3cbf9e7afe86e6b29e22520ffb6766e95d4"</code>
    <code class="p">},</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>If<a data-type="indexterm" data-primary="hint function" id="idm45882370864456"/><a data-type="indexterm" data-primary="indexes" data-secondary="explain output" data-tertiary="forcing index use" id="idm45882370863720"/> you find that Mongo is using different indexes than you
    want it to for a query, you can force it to use a certain index by using
    <code class="function">hint</code>. For instance, if you want to
    make sure MongoDB uses the <code>{"username" : 1, "age"
    : 1}</code> index on the previous query, you could say the
    following:</p><pre id="I_programlisting5_d1e5925" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"age"</code> <code class="o">:</code> <code class="mi">14</code><code class="p">,</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="sr">/.*/</code><code class="p">}).</code><code class="nx">hint</code><code class="p">({</code><code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>If a query is not using the index that you want it to and you use
      a hint to change it, run an <code>explain</code>
      on the hinted query before deploying. If you force MongoDB to use an
      index on a query that it does not know how to use an index for, you
      could end up making the query less efficient than it was without the
      index.</p></div></div></section><section data-type="sect1" data-pdf-bookmark="When Not to Index"><div class="sect1" id="idm45882371753480"><h1>When Not to Index</h1><p>Indexes<a data-type="indexterm" data-primary="indexes" data-secondary="when not to index" id="idm45882370409016"/> are most effective at retrieving small subsets of data, and
    some types of queries are faster without indexes. Indexes become less and
    less efficient as you need to get larger percentages of a collection
    because using an index requires two lookups: one to look at the index
    entry and one following the index’s pointer to the document. A collection
    scan only requires one: looking at the document. In the worst case
    (returning all of the documents in a collection) using an index would take
    twice as many lookups and would generally be significantly slower than a
    collection scan.</p><p>Unfortunately, there<a data-type="indexterm" data-primary="indexes" data-secondary="effectiveness of" id="idm45882370406936"/> isn’t a hard-and-fast rule about when an index helps and
    when it hinders as it really depends on the size of your data, indexes,
    documents, and average result set (<a data-type="xref" href="#table5-1">Table 5-1</a>). As a rule
    of thumb, an index often speeds things up if the query is returning 30% or
    more of the collection. However, this number can vary from 2% to 60%.
    <a data-type="xref" href="#table5-1">Table 5-1</a> summarizes the conditions in which indexes or
    collection scans tend to work better.</p><table id="table5-1"><caption><span class="label">Table 5-1. </span>Properties that affect the effectiveness of indexes</caption><thead><tr><th>Indexes often work well for</th><th>Collection scans often work well for</th></tr></thead><tbody><tr><td>Large collections</td><td>Small collections</td></tr><tr><td>Large documents</td><td>Small documents</td></tr><tr><td>Selective queries</td><td>Nonselective queries</td></tr></tbody></table><p>Let’s say we have an analytics system that collects statistics. Our
    application queries the system for all documents for a given account to
    generate a nice graph of all data from an hour ago to the beginning of
    time:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">entries</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"created_at"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"$lt"</code> <code class="o">:</code> <code class="nx">hourAgo</code><code class="p">}})</code></pre><p>We index "<code class="varname">created_at</code>" to speed up this
    query.</p><p>When we first launch, the result set is tiny and the query returns
    instantly. But after a couple of weeks, it starts being a lot of data, and
    after a month this query is already taking too long to run.</p><p>For most applications, this is probably the “wrong” query: do you
    really want a query that’s returning most of your dataset? Most
    applications, particularly those with large datasets, do not. However,
    there are some legitimate cases where you may want most or all of your
    data. For example, you might be exporting this data to a reporting system
    or using it for a batch job. In these cases, you would like to return this
    large proportion of the dataset as fast as possible.</p></div></section><section data-type="sect1" data-pdf-bookmark="Types of Indexes"><div class="sect1" id="sect1_d1e5438"><h1>Types of Indexes</h1><p>There<a data-type="indexterm" data-primary="indexes" data-secondary="types of" id="Itype05"/> are a few index options you can specify when building an
    index that change the way the index behaves. The most common variations
    are described in the following sections, and more advanced or special-case
    options are described in the next <span class="keep-together">chapter</span>.</p><section data-type="sect2" data-pdf-bookmark="Unique Indexes"><div class="sect2" id="idm45882370358280"><h2>Unique Indexes</h2><p>Unique<a data-type="indexterm" data-primary="indexes" data-secondary="unique" id="idm45882370357032"/> indexes guarantee that each value will appear at most
      once in the index. For example, if you want to make sure no two
      documents can have the same value in the <code>"username"</code> key, you can create a unique index
      with a <code>partialFilterExpression</code><a data-type="indexterm" data-primary="partialFilterExpression" id="idm45882370354872"/> for only documents with a <code>firstname</code> field (more on this option later in
      the chapter):</p><pre id="I_programlisting5_d1e5620" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="s2">"firstname"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">},</code> 
<code class="p">...</code> <code class="p">{</code><code class="s2">"unique"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"partialFilterExpression"</code><code class="o">:</code><code class="p">{</code> 
     <code class="s2">"firstname"</code><code class="o">:</code> <code class="p">{</code><code class="nx">$exists</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}</code> <code class="p">}</code> <code class="p">}</code> <code class="p">)</code>
<code class="p">{</code>
    <code class="s2">"createdCollectionAutomatically"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"numIndexesBefore"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code>
    <code class="s2">"numIndexesAfter"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="p">}</code></pre><p>For example, suppose you tried to insert the following documents
      in the <em>users</em> <span class="keep-together">collection</span>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="nx">firstname</code><code class="o">:</code> <code class="s2">"bob"</code><code class="p">})</code>
<code class="nx">WriteResult</code><code class="p">({</code> <code class="s2">"nInserted"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">})</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="nx">firstname</code><code class="o">:</code> <code class="s2">"bob"</code><code class="p">})</code>
<code class="nx">WriteResult</code><code class="p">({</code>
  <code class="s2">"nInserted"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="s2">"writeError"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"code"</code> <code class="o">:</code> <code class="mi">11000</code><code class="p">,</code>
    <code class="s2">"errmsg"</code> <code class="o">:</code> <code class="s2">"E11000 duplicate key error collection: test.users index: </code>
<code class="s2">               firstname_1 dup key: { : \"bob\" }"</code>
  <code class="p">}</code>
<code class="p">})</code></pre><p>If you check the collection, you’ll see that only the first
      <code>"bob"</code> was stored. Throwing duplicate
      key exceptions is not very efficient, so use the unique constraint for
      the occasional duplicate, not to filter out zillions of duplicates a
      second.</p><p>A unique index that you are probably already familiar with is the
      index on <code>"_id"</code>, which is
      automatically created whenever you create a collection. This is a normal
      unique index (aside from the fact that it cannot be dropped, as other
      unique indexes can be).</p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>If a key does not exist, the index stores its value as <code>null</code> for that document. This means that if
        you create a unique index and try to insert more than one document
        that is missing the indexed field, the inserts will fail because you
        already have a document with a value of <code>null</code>. See <a data-type="xref" href="#sparse-indexes">“Partial Indexes”</a>
        for advice on handling this.</p></div><p>In some cases a value won’t be indexed. Index buckets are of
      limited size and if an index entry exceeds it, it just won’t be included
      in the index. This can cause confusion as it makes a document
      “invisible” to queries that use the index. Prior to MongoDB 4.2, a field
      was required to be smaller than 1,024 bytes to be included in an index.
      In MongoDB 4.2 and later, this constraint was removed. MongoDB does not
      return any sort of error or warning if a document’s fields cannot be
      indexed due to size. This means that keys longer than 8 KB will not be
      subject to the unique index constraints: you can insert identical 8 KB
      strings, for example.</p><section data-type="sect3" data-pdf-bookmark="Compound unique indexes"><div class="sect3" id="sect2_d1e5495"><h3>Compound unique indexes</h3><p>You<a data-type="indexterm" data-primary="indexes" data-secondary="compound unique" id="idm45882370277272"/><a data-type="indexterm" data-primary="compound indexes" data-secondary="compound unique indexes" id="idm45882370276136"/> can also create a compound unique index. If you do
        this, individual keys can have the same values, but the combination of
        values across all keys in an index entry can appear in the index at
        most once.</p><p>For example, if we had a unique index on <code>{"username" : 1, "age" : 1}</code>, the following
        inserts would be legal:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"bob"</code><code class="p">})</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"bob"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">23</code><code class="p">})</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"fred"</code><code class="p">,</code> <code class="s2">"age"</code> <code class="o">:</code> <code class="mi">23</code><code class="p">})</code></pre><p>However, attempting to insert a second copy of any of these
        documents would cause a duplicate key exception.</p><p>GridFS, the standard method for storing large files in MongoDB
        (see <a data-type="xref" href="ch06.xhtml#sect1_d1e7744">“Storing Files with GridFS”</a>), uses a compound unique index.
        The collection that holds the file content has a unique index on
        <code>{"files_id" : 1, "n" : 1}</code>, which
        allows documents that look like (in part) the <span class="keep-together">following</span>:</p><pre id="I_programlisting5_d1e5705" data-type="programlisting" data-code-language="javascript"><code class="p">{</code><code class="s2">"files_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b23c3ca7525f35f94b60a2d"</code><code class="p">),</code> <code class="s2">"n"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"files_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b23c3ca7525f35f94b60a2d"</code><code class="p">),</code> <code class="s2">"n"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"files_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b23c3ca7525f35f94b60a2d"</code><code class="p">),</code> <code class="s2">"n"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"files_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"4b23c3ca7525f35f94b60a2d"</code><code class="p">),</code> <code class="s2">"n"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">}</code></pre><p>Note that all of the values for <code>"files_id"</code> are the same, but <code>"n"</code> is different.</p></div></section><section data-type="sect3" data-pdf-bookmark="Dropping duplicates"><div class="sect3" id="sect2_d1e5477"><h3>Dropping duplicates</h3><p>If<a data-type="indexterm" data-primary="duplicates" data-secondary="dropping in indexes" id="idm45882369987720"/><a data-type="indexterm" data-primary="indexes" data-secondary="dropping duplicates in" id="idm45882369986584"/> you attempt to build a unique index on an existing
        collection, it will fail to build if there are any duplicate
        values:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="s2">"age"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">},</code> <code class="p">{</code><code class="s2">"unique"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">})</code>
<code class="nx">WriteResult</code><code class="p">({</code>
    <code class="s2">"nInserted"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"writeError"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"code"</code> <code class="o">:</code> <code class="mi">11000</code><code class="p">,</code>
        <code class="s2">"errmsg"</code> <code class="o">:</code> <code class="s2">"E11000 duplicate key error collection: </code>
<code class="s2">                   test.users index: age_1 dup key: { : 12 }"</code>
    <code class="p">}</code>
<code class="p">})</code></pre><p>Generally, you’ll need to process your data (the aggregation
        framework can help) and figure out where the duplicates are and what
        to do with them.</p></div></section></div></section><section data-type="sect2" data-pdf-bookmark="Partial Indexes"><div class="sect2" id="sparse-indexes"><h2>Partial Indexes</h2><p>As<a data-type="indexterm" data-primary="indexes" data-secondary="partial" id="idm45882369909832"/> mentioned in the previous section, unique indexes count
      <code>null</code> as a value, so you cannot have a
      unique index with more than one document missing the key. However, there
      are lots of cases where you may want the unique index to be enforced
      only if the key exists. If you have a field that may or may not exist
      but must be unique when it does, you can combine the <code>"unique"</code> option with the <code>"partial"</code> option.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>Partial indexes in MongoDB are only created on a subset of the data. This is unlike sparse indexes on relational databases, which create fewer index entries pointing to a block of data—however, all blocks of data will have an associated sparse index entry in RDBMS.</p></div><p>To create a partial index, include the <code>"partialFilterExpression<a data-type="indexterm" data-primary="partialFilterExpression" id="idm45882369905560"/>"</code> option. Partial indexes represent a superset
      of the functionality offered by sparse indexes, with a document
      representing the filter expression you wish to create it on. For
      example, if providing an email address was optional but, if provided,
      should be unique, we could do:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">ensureIndex</code><code class="p">({</code><code class="s2">"email"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">},</code> <code class="p">{</code><code class="s2">"unique"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="s2">"partialFilterExpression"</code> <code class="o">:</code> 
<code class="p">...</code> <code class="p">{</code> <code class="nx">email</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$exists</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}</code> <code class="p">}})</code></pre><p>Partial indexes do not necessarily have to be unique. To make a
      nonunique partial index, simply do not include the
      <code class="option">"unique"</code> option.</p><p>One thing to be aware of is that the same query can return
      different results depending on whether or not it uses the partial index.
      For example, suppose we have a collection where most of the documents
      have <code>"x"</code> fields, but one does
      not:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">foo</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">2</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">3</code> <code class="p">}</code></pre><p>When we do a query on <code>"x"</code>, it
      will return all matching documents:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">foo</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"x"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"$ne"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">}})</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">3</code> <code class="p">}</code></pre><p>If we create a partial index on <code>"x"</code>, the <code>"_id" : 0</code> document won’t
      be included in the index. So now if we query on <code>"x"</code>, MongoDB will use the index and not return
      the <code>{"_id" : 0}</code> document:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">foo</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"x"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"$ne"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">}})</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">3</code> <code class="p">}</code></pre><p>You can use <code>hint</code> to force it to
      do a table scan if you need documents with<a data-type="indexterm" data-startref="Itype05" id="idm45882369702472"/> missing fields.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Index Administration"><div class="sect1" id="sect1_d1e5749"><h1>Index Administration</h1><p>As<a data-type="indexterm" data-primary="indexes" data-secondary="basic operations" data-tertiary="creating" id="idm45882369637128"/> shown in the previous section, you can create new indexes
    using the <code class="function">createIndex</code> function. An
    index only needs to be created once per collection. If you try to create
    the same index again, nothing will happen.</p><p>All of the information about a database’s indexes is stored in the
    <em>system.indexes</em> collection<a data-type="indexterm" data-primary="system.indexes collection" id="idm45882369633848"/>. This is a reserved collection, so you cannot modify its
    documents or remove documents from it. You can manipulate it only through
    the <code class="function">createIndex</code>, <code class="function">createIndexes</code>, and <code class="function">dropIndexes</code> database<a data-type="indexterm" data-primary="dropIndexes command" id="idm45882369630600"/> commands.</p><p>When<a data-type="indexterm" data-primary="indexes" data-secondary="metainformation on" id="idm45882369629480"/> you create an index, you can see its metainformation in
    <em class="filename">system.indexes</em>. You can also run
    <code>db.<em><code>collectionName</code></em>.getIndexes()</code>
    to see information about all the indexes on a given collection:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">students</code><code class="p">.</code><code class="nx">getIndexes</code><code class="p">()</code>
<code class="p">[</code>
    <code class="p">{</code>
        <code class="s2">"v"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
        <code class="s2">"key"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code>
        <code class="p">},</code>
    <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"_id_"</code><code class="p">,</code>
    <code class="s2">"ns"</code> <code class="o">:</code> <code class="s2">"school.students"</code>
    <code class="p">},</code>
    <code class="p">{</code>
    <code class="s2">"v"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
    <code class="s2">"key"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"class_id"</code> <code class="o">:</code> <code class="mi">1</code>
    <code class="p">},</code>
    <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"class_id_1"</code><code class="p">,</code>
    <code class="s2">"ns"</code> <code class="o">:</code> <code class="s2">"school.students"</code>
    <code class="p">},</code>
    <code class="p">{</code>
    <code class="s2">"v"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
    <code class="s2">"key"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"student_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
        <code class="s2">"class_id"</code> <code class="o">:</code> <code class="mi">1</code>
    <code class="p">},</code>
    <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"student_id_1_class_id_1"</code><code class="p">,</code>
    <code class="s2">"ns"</code> <code class="o">:</code> <code class="s2">"school.students"</code>
    <code class="p">}</code>
<code class="p">]</code></pre><p>The important fields are <code>"key"</code>
    and <code>"name"</code>. The key can be used for
    hinting and other places where an index must be specified. This is a place
    where field order matters: an index on <code>{"class_id" : 1, "student_id" : 1}</code> is not the
    same as an index on <code>{"student_id" : 1, "class_id"
    : 1}</code>. The index name is used as an identifier for a lot of
    administrative index operations, such as <code class="function">dropIndexes</code>. Whether or not the index is
    multikey is not specified in its spec.</p><p>The <code>"v"</code> field is used internally
    for index versioning. If you have any indexes that do not have at least
    a<code> <code>"v"</code> :
    1</code> field, they are being stored in an older, less efficient
    format. You can upgrade them by ensuring that you’re running at least
    MongoDB version 2.0 and dropping and rebuilding the indexes.</p><section data-type="sect2" data-pdf-bookmark="Identifying Indexes"><div class="sect2" id="sect2_d1e5391"><h2>Identifying Indexes</h2><p>Each<a data-type="indexterm" data-primary="indexes" data-secondary="identifying" id="idm45882369503032"/> index in a collection has a name that uniquely identifies
      that index and is used by the server to delete or manipulate it. Index
      names are, by default, <code><em><code>keyname1</code></em>_<em><code>dir1</code></em>_<em><code>keyname2</code></em>_<em><code>dir2</code></em>_..._<em><code>keynameN</code></em>_<em><code>dirN</code></em></code>,
      where <code><em><code>keynameX</code></em></code> is the
      index’s key and <code><em><code>dirX</code></em></code> is the index’s
      direction (<code>1</code> or <code>-1</code>). This can get unwieldy if indexes contain
      more than a couple of keys, so you can specify your own name as one of
      the options to <code class="function">createIndex</code>:</p><pre id="I_programlisting5_d1e5600" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">soup</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="s2">"a"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"b"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"c"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="p">...,</code> <code class="s2">"z"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">},</code> 
<code class="p">...</code> <code class="p">{</code><code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"alphabet"</code><code class="p">})</code></pre><p>There is a limit to the number of characters in an index name, so
      complex indexes may need custom names to be created. A call to <code>getLastError</code> will show if the index creation
      succeeded or why it didn’t.</p></div></section><section data-type="sect2" data-pdf-bookmark="Changing Indexes"><div class="sect2" id="sect2_d1e5806"><h2>Changing Indexes</h2><p>As<a data-type="indexterm" data-primary="indexes" data-secondary="changing" id="idm45882369466376"/> your application grows and changes, you may find that
      your data or queries have changed and that indexes that used to work
      well no longer do. You<a data-type="indexterm" data-primary="indexes" data-secondary="removing unneeded" id="idm45882369465000"/> can remove unneeded indexes using the <code class="function">dropIndex</code> command:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">people</code><code class="p">.</code><code class="nx">dropIndex</code><code class="p">(</code><code class="s2">"x_1_y_1"</code><code class="p">)</code>
<code class="p">{</code> <code class="s2">"nIndexesWas"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code> <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code></pre><p>Use the <code>"name"</code> field from the
      index description to specify which index to drop.</p><p>Building<a data-type="indexterm" data-primary="indexes" data-secondary="background indexing" id="idm45882369453880"/><a data-type="indexterm" data-primary="indexes" data-secondary="basic operations" data-tertiary="creating" id="idm45882369452872"/> new indexes is time-consuming and resource-intensive.
      Prior to version 4.2, MongoDB will build an index as fast as possible,
      blocking all reads and writes on a database until the index build has
      finished. If you would like your database to remain somewhat responsive
      to reads and writes, use the <code class="option">"background"</code> option when
      building an index. This forces the index build to occasionally yield to
      other operations, but may still have a severe impact on your application
      (see <a data-type="xref" href="ch13.xhtml#repl-building-indexes">“Building Indexes”</a> for more information).
      Background indexing is also much slower than foreground indexing.
      MongoDB version 4.2 introduced a new approach, the<a data-type="indexterm" data-primary="indexes" data-secondary="hybrid index build" id="idm45882369378824"/> hybrid index build. It only holds the exclusive lock at
      the beginning and end of the index build. The rest of the build process
      yields to interleaving read and write operations. This replaces both the
      foreground and the background index build type in MongoDB 4.2.</p><p>If you have the choice, creating indexes on existing documents is
      slightly faster than creating the index first and then inserting all
      documents.</p><p>There is more on the operational aspects of building indexes in
      <a data-type="xref" href="ch19.xhtml#chapter-data-admin">Chapter 19</a>.</p></div></section></div></section></div></section></div>



  </body></html>