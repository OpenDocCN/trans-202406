<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 19. Integrating with Third-Party APIs"><div class="chapter" id="ch_integrating_with_third_party_rest_apis">
<h1><span class="label">Chapter 19. </span>Integrating with Third-Party APIs</h1>


<p><a data-type="indexterm" data-primary="third-party APIs" data-secondary="integrating with" id="ix_ch-19-third_party_apis-asciidoc0"/>Increasingly, successful websites are not completely standalone.  To engage existing users and find new users, integration with social networking is a must.  To provide store locators or other location-aware services, using geolocation and mapping services is essential.  It doesn’t stop there: more and more organizations are realizing that providing an API helps expand their service and makes it more useful.</p>

<p>In this chapter, we’ll be discussing the two most common integration needs: social media and geolocation.</p>






<section data-type="sect1" data-pdf-bookmark="Social Media"><div class="sect1" id="idm45053575216232">
<h1>Social Media</h1>

<p><a data-type="indexterm" data-primary="social media" id="ix_ch-19-third_party_apis-asciidoc1"/><a data-type="indexterm" data-primary="third-party APIs" data-secondary="social media" id="ix_ch-19-third_party_apis-asciidoc2"/>Social media is a great way to promote your product or service: if that’s your goal, the ability for your users to easily share your content on social media sites is essential.  As I write this, the dominant social networking services are Facebook, Twitter, Instagram, and YouTube.  Sites like Pinterest and Flickr have their place, but they are usually a little more audience specific (for example, if your website is about DIY crafting, you would absolutely want to support Pinterest).  Laugh if you will, but I predict that MySpace will make a comeback.  Its site redesign is inspired, and it’s worth noting that MySpace is built on <span class="keep-together">Node.</span></p>








<section data-type="sect2" data-pdf-bookmark="Social Media Plugins and Site Performance"><div class="sect2" id="idm45053575211224">
<h2>Social Media Plugins and Site Performance</h2>

<p><a data-type="indexterm" data-primary="social media" data-secondary="plugins and site performance" id="idm45053575210056"/>Most social media integration is a frontend affair.  You reference the appropriate JavaScript files in your page, and it enables both incoming content (the top three stories from your Facebook page, for example) and outgoing content (the ability to tweet about the page you’re on, for example).  While this often represents the easiest path to social media integration, it comes at a cost: I’ve seen page load times double or even triple thanks to the additional HTTP requests.  If page performance is important to you (and it should be, especially for mobile users), you should carefully consider how you integrate social media.</p>

<p>That said, the code that enables a Facebook Like button or a Tweet button leverages in-browser cookies to post on the user’s behalf.  Moving this functionality to the backend would be difficult (and, in some instances, impossible).  So if that is functionality you need, linking in the appropriate third-party library is your best option, even though it can affect your page performance.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Searching for Tweets"><div class="sect2" id="idm45053575207288">
<h2>Searching for Tweets</h2>

<p><a data-type="indexterm" data-primary="social media" data-secondary="searching for tweets" id="ix_ch-19-third_party_apis-asciidoc3"/><a data-type="indexterm" data-primary="Twitter" data-secondary="searching for tweets" id="ix_ch-19-third_party_apis-asciidoc4"/>Let’s say that we want to mention the top 10 most recent tweets that contain the hashtags #Oregon #travel.  We could use a frontend component to do this, but it will involve additional HTTP requests.  Furthermore, if we do it on the backend, we have the option of caching the tweets for performance.  Also, if we do the searching on the backend, we can “blacklist” uncharitable tweets, which would be more difficult on the frontend.</p>

<p>Twitter, like Facebook, allows you to create <em>apps</em>.  It’s something of a misnomer: a Twitter app doesn’t <em>do</em> anything (in the traditional sense).  It’s more like a set of credentials that you can use to create the actual app on your site.  The easiest and most portable way to access the Twitter API is to create an app and use it to get access tokens.</p>

<p>Create a Twitter app by going to <a href="http://dev.twitter.com"><em class="hyperlink">http://dev.twitter.com</em></a>.  Make sure you’re logged on, and click your username in the navigation bar, and then Apps.  Click “Create an app,” and follow the instructions.  <a data-type="indexterm" data-primary="API secret key" id="idm45053575199432"/><a data-type="indexterm" data-primary="consumer API key" id="idm45053575198760"/>Once you have an application, you’ll see that you now have a <em>consumer API key</em> and an <em>API secret key</em>.  The API secret key, as the name indicates, should be kept secret: do not ever include this in responses sent to the client.  If a third party were to get access to this secret, they could make requests on behalf of your application, which could have unfortunate consequences for you if the use is malicious.</p>

<p>Now that we have a consumer API key and secret key, we can communicate with the Twitter REST API.</p>

<p>To keep our code tidy, we’ll put our Twitter code in a module called <em>lib/twitter.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">https</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'https'</code><code class="p">)</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">twitterOptions</code> <code class="o">=&gt;</code> <code class="p">{</code>

 <code class="k">return</code> <code class="p">{</code>

  <code class="nx">search</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">query</code><code class="p">,</code> <code class="nx">count</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// TODO</code>
  <code class="p">}</code>
 <code class="p">}</code>

<code class="p">}</code></pre>

<p>This pattern should be starting to become familiar to you.  Our module exports a function into which the caller passes a configuration object.  What’s returned is an object containing methods.  In this way, we can add functionality to our module.  Currently, we’re only providing a <code>search</code> method.  Here’s how we will be using the library:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">twitter</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./lib/twitter'</code><code class="p">)({</code>
  <code class="nx">consumerApiKey</code><code class="o">:</code> <code class="nx">credentials</code><code class="p">.</code><code class="nx">twitter</code><code class="p">.</code><code class="nx">consumerApiKey</code><code class="p">,</code>
  <code class="nx">apiSecretKey</code><code class="o">:</code> <code class="nx">credentials</code><code class="p">.</code><code class="nx">twitter</code><code class="p">.</code><code class="nx">apiSecretKey</code><code class="p">,</code>
<code class="p">})</code>

<code class="kr">const</code> <code class="nx">tweets</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">twitter</code><code class="p">.</code><code class="nx">search</code><code class="p">(</code><code class="s1">'#Oregon #travel'</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code>
<code class="c1">// tweets will be in result.statuses</code></pre>

<p>(Don’t forget to put a <code>twitter</code> property with <code>consumerApiKey</code> and
<code>apiSecretKey</code> in your <em>.credentials.development.json</em> file.)</p>

<p>Before we implement the <code>search</code> method, we must provide some functionality to authenticate ourselves to Twitter.  The process is simple: we use HTTPS to request an access token based on our consumer key and consumer secret.  We only have to do this once: currently, Twitter does not expire access tokens (though you can invalidate them manually).  Since we don’t want to request an access token every time, we’ll cache the access token so we can reuse it.</p>

<p>The way we’ve constructed our module allows us to create private functionality that’s not available to the caller.  Specifically, the only thing that’s available to the caller is <code>module.exports</code>.  Since we’re returning a function, only that function is available to the caller.  Calling that function results in an object, and only the properties of that object are available to the caller.  So we’re going to create a variable <code>accessToken</code>, which we’ll use to cache our access token, and a <code>getAccessToken</code> function that will get the access token.  The first time it’s called, it will make a Twitter API request to get the access token.  Subsequent calls will simply return the value of <code>accessToken</code>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">https</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'https'</code><code class="p">)</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">twitterOptions</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// this variable will be invisible outside of this module</code>
  <code class="kd">let</code> <code class="nx">accessToken</code> <code class="o">=</code> <code class="kc">null</code>

  <code class="c1">// this function will be invisible outside of this module</code>
  <code class="kr">const</code> <code class="nx">getAccessToken</code> <code class="o">=</code> <code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code><code class="p">(</code><code class="nx">accessToken</code><code class="p">)</code> <code class="k">return</code> <code class="nx">accessToken</code>
    <code class="c1">// TODO: get access token</code>
  <code class="p">}</code>

  <code class="k">return</code> <code class="p">{</code>
    <code class="nx">search</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">query</code><code class="p">,</code> <code class="nx">count</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="c1">// TODO</code>
    <code class="p">}</code>
  <code class="p">}</code>

<code class="p">}</code></pre>

<p>We mark <code>getAccessToken</code> as async because we may have to make an HTTP request to the Twitter API (if there isn’t a cached token).  Now that we’ve established the basic structure, let’s implement <code>getAccessToken</code>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">getAccessToken</code> <code class="o">=</code> <code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">if</code><code class="p">(</code><code class="nx">accessToken</code><code class="p">)</code> <code class="k">return</code> <code class="nx">accessToken</code>

  <code class="kr">const</code> <code class="nx">bearerToken</code> <code class="o">=</code> <code class="nx">Buffer</code><code class="p">(</code>
    <code class="nb">encodeURIComponent</code><code class="p">(</code><code class="nx">twitterOptions</code><code class="p">.</code><code class="nx">consumerApiKey</code><code class="p">)</code> <code class="o">+</code> <code class="s1">':'</code> <code class="o">+</code>
    <code class="nb">encodeURIComponent</code><code class="p">(</code><code class="nx">twitterOptions</code><code class="p">.</code><code class="nx">apiSecretKey</code><code class="p">)</code>
  <code class="p">).</code><code class="nx">toString</code><code class="p">(</code><code class="s1">'base64'</code><code class="p">)</code>

  <code class="kr">const</code> <code class="nx">options</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">hostname</code><code class="o">:</code> <code class="s1">'api.twitter.com'</code><code class="p">,</code>
    <code class="nx">port</code><code class="o">:</code> <code class="mi">443</code><code class="p">,</code>
    <code class="nx">method</code><code class="o">:</code> <code class="s1">'POST'</code><code class="p">,</code>
    <code class="nx">path</code><code class="o">:</code> <code class="s1">'/oauth2/token?grant_type=client_credentials'</code><code class="p">,</code>
    <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>
      <code class="s1">'Authorization'</code><code class="o">:</code> <code class="s1">'Basic '</code> <code class="o">+</code> <code class="nx">bearerToken</code><code class="p">,</code>
    <code class="p">},</code>
  <code class="p">}</code>

  <code class="k">return</code> <code class="k">new</code> <code class="nb">Promise</code><code class="p">((</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="o">=&gt;</code>
    <code class="nx">https</code><code class="p">.</code><code class="nx">request</code><code class="p">(</code><code class="nx">options</code><code class="p">,</code> <code class="nx">res</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="kd">let</code> <code class="nx">data</code> <code class="o">=</code> <code class="s1">''</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">chunk</code> <code class="o">=&gt;</code> <code class="nx">data</code> <code class="o">+=</code> <code class="nx">chunk</code><code class="p">)</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'end'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="kr">const</code> <code class="nx">auth</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
        <code class="k">if</code><code class="p">(</code><code class="nx">auth</code><code class="p">.</code><code class="nx">token_type</code> <code class="o">!==</code> <code class="s1">'bearer'</code><code class="p">)</code>
          <code class="k">return</code> <code class="nx">reject</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'Twitter auth failed.'</code><code class="p">))</code>
        <code class="nx">accessToken</code> <code class="o">=</code> <code class="nx">auth</code><code class="p">.</code><code class="nx">access_token</code>
        <code class="k">return</code> <code class="nx">resolve</code><code class="p">(</code><code class="nx">accessToken</code><code class="p">)</code>
      <code class="p">})</code>
    <code class="p">}).</code><code class="nx">end</code><code class="p">()</code>
  <code class="p">)</code>
<code class="p">}</code></pre>

<p>The details of constructing this call are available on <a href="http://bit.ly/2KcJ4EA">Twitter’s developer documentation page for application-only authentication</a>.  Basically, we have to construct a bearer token that’s a base64-encoded combination of the consumer key and consumer secret.  Once we’ve constructed that token, we can call the <code>/oauth2/token</code> API with the <code>Authorization</code> header containing the bearer token to request an access token.  Note that we must use HTTPS: if you attempt to make this call over HTTP, you are transmitting your secret key unencrypted, and the API will simply hang up on you.</p>

<p>Once we receive the full response from the API (we listen for the <code>end</code> event of the response stream), we can parse the JSON, make sure the token type is <code>bearer</code>, and be on our merry way.  We cache the access token, and then invoke the callback.</p>

<p>Now that we have a mechanism for obtaining an access token, we can make API calls.  So let’s implement our <code>search</code> method:<a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc4" id="idm45053574775336"/><a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc3" id="idm45053574774632"/></p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">search</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">query</code><code class="p">,</code> <code class="nx">count</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">accessToken</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">getAccessToken</code><code class="p">()</code>
  <code class="kr">const</code> <code class="nx">options</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">hostname</code><code class="o">:</code> <code class="s1">'api.twitter.com'</code><code class="p">,</code>
    <code class="nx">port</code><code class="o">:</code> <code class="mi">443</code><code class="p">,</code>
    <code class="nx">method</code><code class="o">:</code> <code class="s1">'GET'</code><code class="p">,</code>
    <code class="nx">path</code><code class="o">:</code> <code class="s1">'/1.1/search/tweets.json?q='</code> <code class="o">+</code>
      <code class="nb">encodeURIComponent</code><code class="p">(</code><code class="nx">query</code><code class="p">)</code> <code class="o">+</code>
      <code class="s1">'&amp;count='</code> <code class="o">+</code> <code class="p">(</code><code class="nx">count</code> <code class="o">||</code> <code class="mi">10</code><code class="p">),</code>
    <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>
      <code class="s1">'Authorization'</code><code class="o">:</code> <code class="s1">'Bearer '</code> <code class="o">+</code> <code class="nx">accessToken</code><code class="p">,</code>
    <code class="p">},</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="k">new</code> <code class="nb">Promise</code><code class="p">((</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="o">=&gt;</code>
    <code class="nx">https</code><code class="p">.</code><code class="nx">request</code><code class="p">(</code><code class="nx">options</code><code class="p">,</code> <code class="nx">res</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="kd">let</code> <code class="nx">data</code> <code class="o">=</code> <code class="s1">''</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">chunk</code> <code class="o">=&gt;</code> <code class="nx">data</code> <code class="o">+=</code> <code class="nx">chunk</code><code class="p">)</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'end'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">resolve</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">data</code><code class="p">)))</code>
    <code class="p">}).</code><code class="nx">end</code><code class="p">()</code>
  <code class="p">)</code>
<code class="p">},</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Rendering Tweets"><div class="sect2" id="idm45053575206664">
<h2>Rendering Tweets</h2>

<p><a data-type="indexterm" data-primary="social media" data-secondary="rendering tweets" id="ix_ch-19-third_party_apis-asciidoc5"/><a data-type="indexterm" data-primary="Twitter" data-secondary="rendering tweets" id="ix_ch-19-third_party_apis-asciidoc6"/>Now we have the ability to search tweets…so how do we display them on our site?  Largely, it’s up to you, but there are some things to consider.  Twitter has an interest in making sure its data is used in a manner consistent with the brand.  To that end, it does have <a href="http://bit.ly/32ET4N2">display requirements</a>, which employ functional elements you must include to display a tweet.</p>

<p>There is some wiggle room in the requirements (for example, if you’re displaying on a device that doesn’t support images, you don’t have to include the avatar image), but for the most part, you’ll end up with something that looks very much like an embedded tweet.  It’s a lot of work, and there is a way around it…but it involves linking to Twitter’s widget library, which is the very HTTP request we’re trying to avoid.</p>

<p><a data-type="indexterm" data-primary="REST APIs" data-secondary="rendering tweets" id="ix_ch-19-third_party_apis-asciidoc7"/>If you need to display tweets, your best bet is to use the Twitter widget library, even though it incurs an extra HTTP request.  For more complicated use of the API, you’ll still have to access the REST API from the backend, so you will probably end up using the REST API in concert with frontend scripts.</p>

<p>Let’s continue with our example: we want to display the top 10 tweets that mention the hashtags #Oregon #travel.  We’ll use the REST API to search for the tweets and the Twitter widget library to display them.  Since we don’t want to run up against usage limits (or slow down our server), we’ll cache the tweets and the HTML to display them for 15 minutes.</p>

<p>We’ll start by modifying our Twitter library to include a method <code>embed</code>, which gets the HTML to display a tweet.  Note we’re using an npm library <code>querystringify</code> to construct a querystring from an object, so don’t forget to <code>npm install querystringify</code> and import it (<code>const qs = require(  ‘querystringify ’)</code>), and then add the following function to the export of <em>lib/twitter.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">embed</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">url</code><code class="p">,</code> <code class="nx">options</code> <code class="o">=</code> <code class="p">{})</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">options</code><code class="p">.</code><code class="nx">url</code> <code class="o">=</code> <code class="nx">url</code>
  <code class="kr">const</code> <code class="nx">accessToken</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">getAccessToken</code><code class="p">()</code>
  <code class="kr">const</code> <code class="nx">requestOptions</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">hostname</code><code class="o">:</code> <code class="s1">'api.twitter.com'</code><code class="p">,</code>
    <code class="nx">port</code><code class="o">:</code> <code class="mi">443</code><code class="p">,</code>
    <code class="nx">method</code><code class="o">:</code> <code class="s1">'GET'</code><code class="p">,</code>
    <code class="nx">path</code><code class="o">:</code> <code class="s1">'/1.1/statuses/oembed.json?'</code> <code class="o">+</code> <code class="nx">qs</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">options</code><code class="p">),</code>
    <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>
      <code class="s1">'Authorization'</code><code class="o">:</code> <code class="s1">'Bearer '</code> <code class="o">+</code> <code class="nx">accessToken</code><code class="p">,</code>
    <code class="p">},</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="k">new</code> <code class="nb">Promise</code><code class="p">((</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="o">=&gt;</code>
    <code class="nx">https</code><code class="p">.</code><code class="nx">request</code><code class="p">(</code><code class="nx">requestOptions</code><code class="p">,</code> <code class="nx">res</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="kd">let</code> <code class="nx">data</code> <code class="o">=</code> <code class="s1">''</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">chunk</code> <code class="o">=&gt;</code> <code class="nx">data</code> <code class="o">+=</code> <code class="nx">chunk</code><code class="p">)</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'end'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">resolve</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">data</code><code class="p">)))</code>
    <code class="p">}).</code><code class="nx">end</code><code class="p">()</code>
  <code class="p">)</code>
<code class="p">},</code></pre>

<p>Now we’re ready to search for, and cache, tweets.  In our main application file, create the following function <code>getTopTweets</code>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">twitterClient</code> <code class="o">=</code> <code class="nx">createTwitterClient</code><code class="p">(</code><code class="nx">credentials</code><code class="p">.</code><code class="nx">twitter</code><code class="p">)</code>

<code class="kr">const</code> <code class="nx">getTopTweets</code> <code class="o">=</code> <code class="p">((</code><code class="nx">twitterClient</code><code class="p">,</code> <code class="nx">search</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">topTweets</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">count</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code>
    <code class="nx">lastRefreshed</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">refreshInterval</code><code class="o">:</code> <code class="mi">15</code> <code class="o">*</code> <code class="mi">60</code> <code class="o">*</code> <code class="mi">1000</code><code class="p">,</code>
    <code class="nx">tweets</code><code class="o">:</code> <code class="p">[],</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code><code class="p">(</code><code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">()</code> <code class="o">&gt;</code> <code class="nx">topTweets</code><code class="p">.</code><code class="nx">lastRefreshed</code> <code class="o">+</code> <code class="nx">topTweets</code><code class="p">.</code><code class="nx">refreshInterval</code><code class="p">)</code> <code class="p">{</code>
      <code class="kr">const</code> <code class="nx">tweets</code> <code class="o">=</code>
       <code class="nx">await</code> <code class="nx">twitterClient</code><code class="p">.</code><code class="nx">search</code><code class="p">(</code><code class="s1">'#Oregon #travel'</code><code class="p">,</code> <code class="nx">topTweets</code><code class="p">.</code><code class="nx">count</code><code class="p">)</code>
      <code class="kr">const</code> <code class="nx">formattedTweets</code> <code class="o">=</code> <code class="nx">await</code> <code class="nb">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code>
        <code class="nx">tweets</code><code class="p">.</code><code class="nx">statuses</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">async</code> <code class="p">({</code> <code class="nx">id_str</code><code class="p">,</code> <code class="nx">user</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="kr">const</code> <code class="nx">url</code> <code class="o">=</code> <code class="sb">`https://twitter.com/</code><code class="si">${</code><code class="nx">user</code><code class="p">.</code><code class="nx">id_str</code><code class="si">}</code><code class="sb">/statuses/</code><code class="si">${</code><code class="nx">id_str</code><code class="si">}</code><code class="sb">`</code>
          <code class="kr">const</code> <code class="nx">embeddedTweet</code> <code class="o">=</code>
           <code class="nx">await</code> <code class="nx">twitterClient</code><code class="p">.</code><code class="nx">embed</code><code class="p">(</code><code class="nx">url</code><code class="p">,</code> <code class="p">{</code> <code class="nx">omit_script</code><code class="o">:</code> <code class="mi">1</code> <code class="p">})</code>
          <code class="k">return</code> <code class="nx">embeddedTweet</code><code class="p">.</code><code class="nx">html</code>
        <code class="p">})</code>
      <code class="p">)</code>
      <code class="nx">topTweets</code><code class="p">.</code><code class="nx">lastRefreshed</code> <code class="o">=</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">()</code>
      <code class="nx">topTweets</code><code class="p">.</code><code class="nx">tweets</code> <code class="o">=</code> <code class="nx">formattedTweets</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">topTweets</code><code class="p">.</code><code class="nx">tweets</code>
  <code class="p">}</code>
<code class="p">})(</code><code class="nx">twitterClient</code><code class="p">,</code> <code class="s1">'#Oregon #travel'</code><code class="p">)</code></pre>

<p>The essence of the <code>getTopTweets</code> function is to not just search for tweets with a specified hashtag, but to cache those tweets for some reasonable period of time.  Note that we created an immediately invoked function expression, or IIFE: that’s because we want the <code>topTweets</code> cache safely inside a closure so it can’t be messed with.  The asynchronous function that’s returned from the IIFE refreshes the cache if necessary, and then returns the contents of the cache.</p>

<p>Lastly, let’s create a view, <code>views/social.handlebars</code> as a home for our social media presence (which right now, includes only our selected tweets):</p>

<pre data-type="programlisting" data-code-language="html"><code class="nt">&lt;h2&gt;</code>Oregon Travel in Social Media<code class="nt">&lt;/h2&gt;</code>

<code class="nt">&lt;script </code><code class="na">id=</code><code class="s">"twitter-wjs"</code> <code class="na">type=</code><code class="s">"text/javascript"</code>
  <code class="na">async</code> <code class="na">defer</code> <code class="na">src=</code><code class="s">"//platform.twitter.com/widgets.js"</code><code class="nt">&gt;&lt;/script&gt;</code>

{{{tweets}}}</pre>

<p>And a route to handle it:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/social'</code><code class="p">,</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'social'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">tweets</code><code class="o">:</code> <code class="nx">await</code> <code class="nx">getTopTweets</code><code class="p">()</code> <code class="p">})</code>
<code class="p">})</code></pre>

<p>Note that we reference an external script, Twitter’s <code>widgets.js</code>.  This is the script that will format and give functionality to the embedded tweets on your page.  By default, the <code>oembed</code> API will include a reference to this script in the HTML, but since we’re displaying 10 tweets, that would reference that script nine more times than necessary!  So recall that, when we called the <code>oembed</code> API, we passed in the option <code>{ omit_script: 1 }</code>.  Since we did that, we have to provide it somewhere, which we did in the view.  Go ahead and try removing the script from the view. You’ll still see the tweets, but they won’t have any formatting or functionality.<a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc7" id="idm45053574152152"/></p>

<p>Now we have a nice social media feed!  Let’s turn our attention to another important application: displaying maps in our application<a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc6" id="idm45053574151096"/><a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc5" id="idm45053574150424"/>.<a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc2" id="idm45053574149608"/><a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc1" id="idm45053574148888"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Geocoding"><div class="sect1" id="idm45053574771112">
<h1>Geocoding</h1>

<p><a data-type="indexterm" data-primary="geocoding" id="ix_ch-19-third_party_apis-asciidoc8"/><a data-type="indexterm" data-primary="third-party APIs" data-secondary="geocoding" id="ix_ch-19-third_party_apis-asciidoc9"/><em>Geocoding</em> refers to the process of taking a street address or place name (Bletchley Park, Sherwood Drive, Bletchley, Milton Keynes MK3 6EB, UK) and converting it to geographic coordinates (latitude 51.9976597, longitude –0.7406863).  If your application is going to be doing any kind of geographic calculation—distances or directions—or displaying a map, then you’ll need geographic coordinates.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You may be used to seeing geographic coordinates specified in degrees, minutes, and seconds (DMS).  Geocoding APIs and mapping services use a single floating-point number for latitude and longitude.  If you need to display DMS coordinates, see <a href="http://bit.ly/2Xc5IlM">this wikipedia article</a>.</p>
</div>








<section data-type="sect2" data-pdf-bookmark="Geocoding with Google"><div class="sect2" id="idm45053574141608">
<h2>Geocoding with Google</h2>

<p><a data-type="indexterm" data-primary="geocoding" data-secondary="Google and" id="ix_ch-19-third_party_apis-asciidoc10"/><a data-type="indexterm" data-primary="Google" data-secondary="geocoding and" id="ix_ch-19-third_party_apis-asciidoc11"/>Both Google and Bing offer excellent REST services for geocoding.  We’ll be using Google for our example, but the Bing service is very similar.</p>

<p>Without attaching a billing account to your Google account, your geocoding requests will be limited to one a day, which will make for a very slow testing cycle indeed!  Whenever possible in this book, I’ve tried to avoid recommending services you couldn’t at least use in a development capacity for free, and I did try some free geocoding services, and found a significant enough gulf in usability that I continue to recommend Google geocoding.  However, as I write this, the cost of development-volume geocoding with Google is free: you receive a $200 monthly credit with your account, and you would have to make 40,000 requests to exhaust that!  If you want to follow along with this chapter, go to <a href="http://bit.ly/2KcY1X0">your Google console</a>, choose Billing from the main menu, and enter your billing information.</p>

<p>Once you’ve set up billing, you’ll need an API key for Google’s geocoding API.  Go to <a href="http://bit.ly/2KcY1X0">the console</a>, select your project from the navigation bar, and then click on APIs.  If the geocoding API isn’t in your list of enabled APIs, locate it in the list of additional APIs and add it.  Most of the Google APIs share the same API credentials, so click on the navigation menu in the upper left, and go back to your dashboard.  Click on Credentials, and create a new API key if you don’t have an appropriate one already.  Note that API keys can be restricted to prevent abuse, so make sure your API key can be used from your application.  If you need one for developing, you can restrict the key by IP address, and choose your IP address (if you don’t know what it is, you can just ask Google, “What’s my IP address?”).</p>

<p>Once you have an API key, add it to <em>.credentials.development.json</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="s2">"google"</code><code class="o">:</code> <code class="p">{</code>
  <code class="s2">"apiKey"</code><code class="o">:</code> <code class="s2">"&lt;YOUR API KEY&gt;"</code>
<code class="p">}</code></pre>

<p>Then create a module <em>lib/geocode.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">https</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'https'</code><code class="p">)</code>
<code class="kr">const</code> <code class="p">{</code> <code class="nx">credentials</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'../config'</code><code class="p">)</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">async</code> <code class="nx">query</code> <code class="o">=&gt;</code> <code class="p">{</code>

  <code class="kr">const</code> <code class="nx">options</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">hostname</code><code class="o">:</code> <code class="s1">'maps.googleapis.com'</code><code class="p">,</code>
    <code class="nx">path</code><code class="o">:</code> <code class="s1">'/maps/api/geocode/json?address='</code> <code class="o">+</code>
      <code class="nb">encodeURIComponent</code><code class="p">(</code><code class="nx">query</code><code class="p">)</code> <code class="o">+</code> <code class="s1">'&amp;key='</code> <code class="o">+</code>
      <code class="nx">credentials</code><code class="p">.</code><code class="nx">google</code><code class="p">.</code><code class="nx">apiKey</code><code class="p">,</code>
  <code class="p">}</code>

  <code class="k">return</code> <code class="k">new</code> <code class="nb">Promise</code><code class="p">((</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="o">=&gt;</code>
    <code class="nx">https</code><code class="p">.</code><code class="nx">request</code><code class="p">(</code><code class="nx">options</code><code class="p">,</code> <code class="nx">res</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="kd">let</code> <code class="nx">data</code> <code class="o">=</code> <code class="s1">''</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">chunk</code> <code class="o">=&gt;</code> <code class="nx">data</code> <code class="o">+=</code> <code class="nx">chunk</code><code class="p">)</code>
      <code class="nx">res</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'end'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="nx">data</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code>
        <code class="k">if</code><code class="p">(</code><code class="o">!</code><code class="nx">data</code><code class="p">.</code><code class="nx">results</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code>
          <code class="k">return</code> <code class="nx">reject</code><code class="p">(</code><code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="sb">`no results for "</code><code class="si">${</code><code class="nx">query</code><code class="si">}</code><code class="sb">"`</code><code class="p">))</code>
        <code class="nx">resolve</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">results</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">geometry</code><code class="p">.</code><code class="nx">location</code><code class="p">)</code>
      <code class="p">})</code>
    <code class="p">}).</code><code class="nx">end</code><code class="p">()</code>
  <code class="p">)</code>

<code class="p">}</code></pre>

<p>Now we have a function that will contact the Google API to geocode an address.  If it can’t find an address (or fails for any other reason), an error will be returned.  The API can return multiple addresses.  For example, if you search for “10 Main Street” without specifying a city, state, or postal code, it will return dozens of results.  Our implementation simply picks the first one.  The API returns a lot of information, but all we’re currently interested in are the coordinates.  You could easily modify this interface to return more information.  See the <a href="http://bit.ly/2O4EE3t">Google geocoding API documentation</a> for more information about the data the API returns.</p>










<section data-type="sect3" data-pdf-bookmark="Usage restrictions"><div class="sect3" id="idm45053574204376">
<h3>Usage restrictions</h3>

<p><a data-type="indexterm" data-primary="Google" data-secondary="geocoding usage restrictions" id="idm45053573843880"/>The Google geocoding API currently has a monthly usage limit, but you pay $0.005 per geocoding request.  So if you made a million requests in any given month, you’d have a $5,000 bill from Google…so there is a probably practical limit for you!</p>
<div data-type="tip"><h6>Tip</h6>
<p>If you’re worried about runaway charges—which could happen if you accidentally leave a service running, or if a bad actor gets access to your credentials—you can add a budget and configure alerts to notify you as you approach them.  Go to your Google developer console, and choose “Budgets &amp; alerts” from the Billing menu.</p>
</div>

<p>At the time of writing, Google limits you to 5,000 requests per 100 seconds to prevent abuse, which would be difficult to exceed.  Google’s API also requires that if you use a map on your website, you use Google Maps.  That is, if you’re using Google’s service to geocode your data, you can’t turn around and display that information on a Bing map without violating the terms of service.  Generally, this is not an onerous restriction, as you probably wouldn’t be doing geocoding unless you intended to display locations on a map.  However, if you like Bing’s maps better than Google’s, or vice versa, you should be mindful of the terms of service and use the appropriate API.<a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc11" id="idm45053573839944"/><a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc10" id="idm45053573839272"/></p>
</div></section>



</div></section>













<section data-type="sect2" data-pdf-bookmark="Geocoding Your Data"><div class="sect2" id="idm45053574140952">
<h2>Geocoding Your Data</h2>

<p><a data-type="indexterm" data-primary="geocoding" data-secondary="of your own data" id="ix_ch-19-third_party_apis-asciidoc12"/>We have a nice database of vacation packages around Oregon, and we might decide we want to display a map with pins showing where the various vacations are, and this is where geocoding comes in.</p>

<p>We already have vacation data in the database, and each vacation has a location search string that will work with geocoding, but we don’t yet have coordinates.</p>

<p>The question now is when and how do we do the geocoding?  Broadly speaking, we have three options:</p>

<ul>
<li>
<p>Geocode when we add new vacations to the database.  This is probably a great option when we add an admin interface to the system that allows vendors to dynamically add vacations to the database.  Since we’re stopping short of this functionality, however, we’ll discard this option.</p>
</li>
<li>
<p>Geocode as necessary when retrieving vacations from the database.  This approach would do a check every time we get vacations from the database: if any of them have missing coordinates, we would geocode them.  This option sounds appealing, and is probably the easiest of the three, but it has some big disadvantages that make it unsuitable.  The first is performance: if you add a thousand new vacations to the database, the first person to look at the vacations list is going to have to wait for all of those geocoding requests to succeed and get written to the database.  Furthermore, one can imagine a situation where a load testing suite adds a thousand vacations to the database and then performs a thousand requests. Since they all run concurrently, each of those thousand requests results in a thousand geocoding requests because the data hasn’t been written to the database yet…resulting in a million geocoding requests and a $5,000 bill from Google!  So let’s cross this one off the list.</p>
</li>
<li>
<p>Have a script to find vacations with missing coordinate date, and geocode those.  This approach offers the best solution for our current situation.  For development purposes, we’re populating the vacation database once, and we don’t yet have an admin interface for adding new vacations.  Furthermore, if we do decide to add an admin interface later, this approach isn’t incompatible with that: as a matter of fact, we could just run this process after adding a new vacation, and it would work.</p>
</li>
</ul>

<p>First, we need to add a way to update an existing vacation in <em>db.js</em> (we’ll also add a method to close the database connection, which will come in handy in scripts):</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
  <code class="c1">//...</code>
  <code class="nx">updateVacationBySku</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">sku</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">Vacation</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">({</code> <code class="nx">sku</code> <code class="p">},</code> <code class="nx">data</code><code class="p">),</code>
  <code class="nx">close</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">mongoose</code><code class="p">.</code><code class="nx">connection</code><code class="p">.</code><code class="nx">close</code><code class="p">(),</code>
<code class="p">}</code></pre>

<p>Then we can write a script <em>db-geocode.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./db'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">geocode</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./lib/geocode'</code><code class="p">)</code>

<code class="kr">const</code> <code class="nx">geocodeVacations</code> <code class="o">=</code> <code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">vacations</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">db</code><code class="p">.</code><code class="nx">getVacations</code><code class="p">()</code>
  <code class="kr">const</code> <code class="nx">vacationsWithoutCoordinates</code> <code class="o">=</code> <code class="nx">vacations</code><code class="p">.</code><code class="nx">filter</code><code class="p">(({</code> <code class="nx">location</code> <code class="p">})</code> <code class="o">=&gt;</code>
    <code class="o">!</code><code class="nx">location</code><code class="p">.</code><code class="nx">coordinates</code> <code class="o">||</code> <code class="k">typeof</code> <code class="nx">location</code><code class="p">.</code><code class="nx">coordinates</code><code class="p">.</code><code class="nx">lat</code> <code class="o">!==</code> <code class="s1">'number'</code><code class="p">)</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`geocoding </code><code class="si">${</code><code class="nx">vacationsWithoutCoordinates</code><code class="p">.</code><code class="nx">length</code><code class="si">}</code><code class="sb"> `</code> <code class="o">+</code>
    <code class="sb">`of </code><code class="si">${</code><code class="nx">vacations</code><code class="p">.</code><code class="nx">length</code><code class="si">}</code><code class="sb"> vacations:`</code><code class="p">)</code>
  <code class="k">return</code> <code class="nb">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="nx">vacationsWithoutCoordinates</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">async</code> <code class="p">({</code> <code class="nx">sku</code><code class="p">,</code> <code class="nx">location</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code> <code class="nx">search</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">location</code>
    <code class="k">if</code><code class="p">(</code><code class="k">typeof</code> <code class="nx">search</code> <code class="o">!==</code> <code class="s1">'string'</code> <code class="o">||</code> <code class="o">!</code><code class="sr">/\w/</code><code class="p">.</code><code class="nx">test</code><code class="p">(</code><code class="nx">search</code><code class="p">))</code>
      <code class="k">return</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`  SKU </code><code class="si">${</code><code class="nx">sku</code><code class="si">}</code><code class="sb"> FAILED: does not have location.search`</code><code class="p">)</code>
    <code class="k">try</code> <code class="p">{</code>
      <code class="kr">const</code> <code class="nx">coordinates</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">geocode</code><code class="p">(</code><code class="nx">search</code><code class="p">)</code>
      <code class="nx">await</code> <code class="nx">db</code><code class="p">.</code><code class="nx">updateVacationBySku</code><code class="p">(</code><code class="nx">sku</code><code class="p">,</code> <code class="p">{</code> <code class="nx">location</code><code class="o">:</code> <code class="p">{</code> <code class="nx">search</code><code class="p">,</code> <code class="nx">coordinates</code> <code class="p">}</code> <code class="p">})</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`  SKU </code><code class="si">${</code><code class="nx">sku</code><code class="si">}</code><code class="sb"> SUCCEEDED: </code><code class="si">${</code><code class="nx">coordinates</code><code class="p">.</code><code class="nx">lat</code><code class="si">}</code><code class="sb">, </code><code class="si">${</code><code class="nx">coordinates</code><code class="p">.</code><code class="nx">lng</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>
    <code class="p">}</code> <code class="k">catch</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`  SKU {sku} FAILED: </code><code class="si">${</code><code class="nx">err</code><code class="p">.</code><code class="nx">message</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>
    <code class="p">}</code>
  <code class="p">}))</code>
<code class="p">}</code>

<code class="nx">geocodeVacations</code><code class="p">()</code>
  <code class="p">.</code><code class="nx">then</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'DONE'</code><code class="p">)</code>
    <code class="nx">db</code><code class="p">.</code><code class="nx">close</code><code class="p">()</code>
  <code class="p">})</code>
  <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">err</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'ERROR: '</code> <code class="o">+</code> <code class="nx">err</code><code class="p">.</code><code class="nx">message</code><code class="p">)</code>
    <code class="nx">db</code><code class="p">.</code><code class="nx">close</code><code class="p">()</code>
  <code class="p">})</code></pre>

<p>When you run the script (<code>node db-geocode.js</code>), you should see that all of your vacations have been successfully geocoded!  Now that we have that information, let’s learn how to display it on a map….<a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc12" id="idm45053573796312"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Displaying a Map"><div class="sect2" id="idm45053573837912">
<h2>Displaying a Map</h2>

<p><a data-type="indexterm" data-primary="geocoding" data-secondary="displaying a map" id="idm45053573794264"/><a data-type="indexterm" data-primary="maps, displaying" id="idm45053573793288"/>While displaying vacations on a map really falls under “frontend” work, it would be very disappointing to get this far and not see the fruits of our labor.  So we’re going to take a slight departure from the backend focus of this book, and see how to display our newly geocoded dealers on a map.</p>

<p>We already created a Google API key to do our geocoding, but we still need to enable the maps API.  Go to <a href="http://bit.ly/2KcY1X0">your Google console</a>, click on APIs, and find Maps JavaScript API and enable it if it isn’t already.</p>

<p>Now we can create a view to display our vacations map, <em>views/vacations-map.handlebars</em>.  We’ll start with just displaying the map, and work on adding vacations next:</p>

<pre data-type="programlisting" data-code-language="html"><code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"map"</code> <code class="na">style=</code><code class="s">"width: 100%; height: 60vh;"</code><code class="nt">&gt;&lt;/div&gt;</code>
<code class="nt">&lt;script&gt;</code>
  <code class="kd">let</code> <code class="nx">map</code> <code class="o">=</code> <code class="kc">undefined</code>
  <code class="nx">async</code> <code class="kd">function</code> <code class="nx">initMap</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">google</code><code class="p">.</code><code class="nx">maps</code><code class="p">.</code><code class="nx">Map</code><code class="p">(</code><code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'map'</code><code class="p">),</code> <code class="p">{</code>
      <code class="c1">// approximate geographic center of oregon</code>
      <code class="nx">center</code><code class="o">:</code> <code class="p">{</code> <code class="nx">lat</code><code class="o">:</code> <code class="mf">44.0978126</code><code class="p">,</code> <code class="nx">lng</code><code class="o">:</code> <code class="o">-</code><code class="mf">120.0963654</code> <code class="p">},</code>
      <code class="c1">// this zoom level covers most of the state</code>
      <code class="nx">zoom</code><code class="o">:</code> <code class="mi">7</code><code class="p">,</code>
    <code class="p">})</code>
  <code class="p">}</code>
<code class="nt">&lt;/script&gt;</code>
<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"https://maps.googleapis.com/maps/api/js?key={{googleApiKey}}&amp;callback=initMap"</code>
    <code class="na">async</code> <code class="na">defer</code><code class="nt">&gt;&lt;/script&gt;</code></pre>

<p>Now it’s time to put some pins on the map corresponding with our vacations.  In <a data-type="xref" href="ch15.xhtml#ch_rest_apis_and_json">Chapter 15</a>, we created an API endpoint <code>/api/vacations</code>, which will now include geocoded data.  We’ll use that endpoint to get our vacations, and put pins on the map.  Modify the <code>initMap</code> function in <em>views/vacations-map.handlebars.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">async</code> <code class="kd">function</code> <code class="nx">initMap</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">map</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">google</code><code class="p">.</code><code class="nx">maps</code><code class="p">.</code><code class="nx">Map</code><code class="p">(</code><code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'map'</code><code class="p">),</code> <code class="p">{</code>
    <code class="c1">// approximate geographic center of oregon</code>
    <code class="nx">center</code><code class="o">:</code> <code class="p">{</code> <code class="nx">lat</code><code class="o">:</code> <code class="mf">44.0978126</code><code class="p">,</code> <code class="nx">lng</code><code class="o">:</code> <code class="o">-</code><code class="mf">120.0963654</code> <code class="p">},</code>
    <code class="c1">// this zoom level covers most of the state</code>
    <code class="nx">zoom</code><code class="o">:</code> <code class="mi">7</code><code class="p">,</code>
  <code class="p">})</code>
  <code class="kr">const</code> <code class="nx">vacations</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="s1">'/api/vacations'</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="nx">res</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>
  <code class="nx">vacations</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(({</code> <code class="nx">name</code><code class="p">,</code> <code class="nx">location</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">marker</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">google</code><code class="p">.</code><code class="nx">maps</code><code class="p">.</code><code class="nx">Marker</code><code class="p">({</code>
      <code class="nx">position</code><code class="o">:</code> <code class="nx">location</code><code class="p">.</code><code class="nx">coordinates</code><code class="p">,</code>
      <code class="nx">map</code><code class="p">,</code>
      <code class="nx">title</code><code class="o">:</code> <code class="nx">name</code><code class="p">,</code>
    <code class="p">})</code>
  <code class="p">})</code>
<code class="p">}</code></pre>

<p>Now we have a map showing where all our vacations are!  There are a lot of ways we could improve this page: probably the best place to start would be to linking the markers with the vacation detail page, so you could click on a marker and it would take you to the vacation info page.  We could also implement custom markers or tooltips: the Google Maps API has a lot of features, and you can learn about them from the <a href="https://developers.google.com/maps/documentation/javascript/tutorial">official Google documentation</a>.<a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc9" id="idm45053573219640"/><a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc8" id="idm45053573219144"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Weather Data"><div class="sect1" id="idm45053573218408">
<h1>Weather Data</h1>

<p><a data-type="indexterm" data-primary="National Weather Service (NWS) API" id="ix_ch-19-third_party_apis-asciidoc13"/><a data-type="indexterm" data-primary="NWS (National Weather Service) API" id="ix_ch-19-third_party_apis-asciidoc14"/><a data-type="indexterm" data-primary="third-party APIs" data-secondary="weather data" id="ix_ch-19-third_party_apis-asciidoc15"/><a data-type="indexterm" data-primary="weather data" id="ix_ch-19-third_party_apis-asciidoc16"/>Remember our “current weather” widget from <a data-type="xref" href="ch07.xhtml#ch_templating">Chapter 7</a>?  Let’s get that hooked up with some live data!  We’ll be using the US National Weather Service (NWS) API to get forecast information.  As with our Twitter integration, and our use of geocoding, we’ll be caching the forecast to prevent passing every hit to our website on to NWS (which might get us blacklisted if our website gets popular).  Create a file called <em>lib/weather.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">https</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'https'</code><code class="p">)</code>
<code class="kr">const</code> <code class="p">{</code> <code class="nx">URL</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'url'</code><code class="p">)</code>

<code class="kr">const</code> <code class="nx">_fetch</code> <code class="o">=</code> <code class="nx">url</code> <code class="o">=&gt;</code> <code class="k">new</code> <code class="nb">Promise</code><code class="p">((</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">hostname</code><code class="p">,</code> <code class="nx">pathname</code><code class="p">,</code> <code class="nx">search</code> <code class="p">}</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">URL</code><code class="p">(</code><code class="nx">url</code><code class="p">)</code>
  <code class="kr">const</code> <code class="nx">options</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">hostname</code><code class="p">,</code>
    <code class="nx">path</code><code class="o">:</code> <code class="nx">pathname</code> <code class="o">+</code> <code class="nx">search</code><code class="p">,</code>
    <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>
      <code class="s1">'User-Agent'</code><code class="o">:</code> <code class="s1">'Meadowlark Travel'</code>
    <code class="p">},</code>
  <code class="p">}</code>
  <code class="nx">https</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">options</code><code class="p">,</code> <code class="nx">res</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">data</code> <code class="o">=</code> <code class="s1">''</code>
    <code class="nx">res</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">chunk</code> <code class="o">=&gt;</code> <code class="nx">data</code> <code class="o">+=</code> <code class="nx">chunk</code><code class="p">)</code>
    <code class="nx">res</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'end'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">resolve</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">data</code><code class="p">)))</code>
  <code class="p">}).</code><code class="nx">end</code><code class="p">()</code>
<code class="p">})</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">locations</code> <code class="o">=&gt;</code> <code class="p">{</code>

  <code class="kr">const</code> <code class="nx">cache</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">refreshFrequency</code><code class="o">:</code> <code class="mi">15</code> <code class="o">*</code> <code class="mi">60</code> <code class="o">*</code> <code class="mi">1000</code><code class="p">,</code>
    <code class="nx">lastRefreshed</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">refreshing</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="nx">forecasts</code><code class="o">:</code> <code class="nx">locations</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">location</code> <code class="o">=&gt;</code> <code class="p">({</code> <code class="nx">location</code> <code class="p">})),</code>
  <code class="p">}</code>

  <code class="kr">const</code> <code class="nx">updateForecast</code> <code class="o">=</code> <code class="nx">async</code> <code class="nx">forecast</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code><code class="p">(</code><code class="o">!</code><code class="nx">forecast</code><code class="p">.</code><code class="nx">url</code><code class="p">)</code> <code class="p">{</code>
      <code class="kr">const</code> <code class="p">{</code> <code class="nx">lat</code><code class="p">,</code> <code class="nx">lng</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">forecast</code><code class="p">.</code><code class="nx">location</code><code class="p">.</code><code class="nx">coordinates</code>
      <code class="kr">const</code> <code class="nx">path</code> <code class="o">=</code> <code class="sb">`/points/</code><code class="si">${</code><code class="nx">lat</code><code class="p">.</code><code class="nx">toFixed</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code class="si">}</code><code class="sb">,</code><code class="si">${</code><code class="nx">lng</code><code class="p">.</code><code class="nx">toFixed</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code><code class="si">}</code><code class="sb">`</code>
      <code class="kr">const</code> <code class="nx">points</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">_fetch</code><code class="p">(</code><code class="s1">'https://api.weather.gov'</code> <code class="o">+</code> <code class="nx">path</code><code class="p">)</code>
      <code class="nx">forecast</code><code class="p">.</code><code class="nx">url</code> <code class="o">=</code> <code class="nx">points</code><code class="p">.</code><code class="nx">properties</code><code class="p">.</code><code class="nx">forecast</code>
    <code class="p">}</code>
    <code class="kr">const</code> <code class="p">{</code> <code class="nx">properties</code><code class="o">:</code> <code class="p">{</code> <code class="nx">periods</code> <code class="p">}</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">_fetch</code><code class="p">(</code><code class="nx">forecast</code><code class="p">.</code><code class="nx">url</code><code class="p">)</code>
    <code class="kr">const</code> <code class="nx">currentPeriod</code> <code class="o">=</code> <code class="nx">periods</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>
    <code class="nb">Object</code><code class="p">.</code><code class="nx">assign</code><code class="p">(</code><code class="nx">forecast</code><code class="p">,</code> <code class="p">{</code>
      <code class="nx">iconUrl</code><code class="o">:</code> <code class="nx">currentPeriod</code><code class="p">.</code><code class="nx">icon</code><code class="p">,</code>
      <code class="nx">weather</code><code class="o">:</code> <code class="nx">currentPeriod</code><code class="p">.</code><code class="nx">shortForecast</code><code class="p">,</code>
      <code class="nx">temp</code><code class="o">:</code> <code class="nx">currentPeriod</code><code class="p">.</code><code class="nx">temperature</code> <code class="o">+</code> <code class="s1">' '</code> <code class="o">+</code> <code class="nx">currentPeriod</code><code class="p">.</code><code class="nx">temperatureUnit</code><code class="p">,</code>
    <code class="p">})</code>
    <code class="k">return</code> <code class="nx">forecast</code>
  <code class="p">}</code>

  <code class="kr">const</code> <code class="nx">getForecasts</code> <code class="o">=</code> <code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code><code class="p">(</code><code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">()</code> <code class="o">&gt;</code> <code class="nx">cache</code><code class="p">.</code><code class="nx">lastRefreshed</code> <code class="o">+</code> <code class="nx">cache</code><code class="p">.</code><code class="nx">refreshFrequency</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'updating cache'</code><code class="p">)</code>
      <code class="nx">cache</code><code class="p">.</code><code class="nx">refreshing</code> <code class="o">=</code> <code class="kc">true</code>
      <code class="nx">cache</code><code class="p">.</code><code class="nx">forecasts</code> <code class="o">=</code> <code class="nx">await</code> <code class="nb">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="nx">cache</code><code class="p">.</code><code class="nx">forecasts</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">updateForecast</code><code class="p">))</code>
      <code class="nx">cache</code><code class="p">.</code><code class="nx">refreshing</code> <code class="o">=</code> <code class="kc">false</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">cache</code><code class="p">.</code><code class="nx">forecasts</code>
  <code class="p">}</code>

  <code class="k">return</code> <code class="nx">getForecasts</code>

<code class="p">}</code></pre>

<p>You’ll notice that we got tired of using Node’s built-in <code>https</code> library
directly, and instead created a utility function <code>_fetch</code> to make our
weather functionality a little more readable.  One thing that might jump
out at you is that we’re setting the <code>User-Agent</code> header to <code>Meadowlark
Travel</code>.  This is a quirk of the NWS weather API: it requires a string for
the <code>User-Agent</code>.  They state that they will eventually replace this with
an API key, but for now we just need to provide a value here.</p>

<p>Getting weather data from the NWS API is a two-part affair here.  There’s an API endpoint called <code>points</code> that takes a latitude and longitude (with exactly four decimal digits) and returns information about that location…including the appropriate URL from which to get a forecast.  Once we have that URL for any given set of coordinates, we don’t need to fetch it again. All we need to do is call that URL to get the updated forecast.</p>

<p>Note that a lot more data is returned from the forecast than we’re using; we could get a lot more sophisticated with this feature.  In particular, the forecast URL returns an array of periods, with the first element being the current period (for example, “afternoon” or “evening”).  It follows up with periods stretching into the next week.  Feel free to look at the data in the <code>periods</code> array to see the kind of data that’s available to you.</p>

<p>One detail worth pointing out is that we have a boolean property in our cache called <code>refreshing</code>.  This is necessary since updating the cache takes a finite amount of time, and is done asynchronously.  If multiple requests come in before the first cache refresh completes, they will all kick off the work of refreshing the cache.  It won’t hurt anything, exactly, but you will be making more API calls than are strictly necessary.  This boolean variable is just a flag to any additional requests to say, “We’re working on it.”</p>

<p>We’ve designed this to be a drop-in replacement for the dummy function we created back in <a data-type="xref" href="ch07.xhtml#ch_templating">Chapter 7</a>.  All we have to do is open <em>lib/middleware/weather.js</em> and replace the <code>getWeatherData</code> function:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">weatherData</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'../weather'</code><code class="p">)</code>

<code class="kr">const</code> <code class="nx">getWeatherData</code> <code class="o">=</code> <code class="nx">weatherData</code><code class="p">([</code>
  <code class="p">{</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s1">'Portland'</code><code class="p">,</code>
    <code class="nx">coordinates</code><code class="o">:</code> <code class="p">{</code> <code class="nx">lat</code><code class="o">:</code> <code class="mf">45.5154586</code><code class="p">,</code> <code class="nx">lng</code><code class="o">:</code> <code class="o">-</code><code class="mf">122.6793461</code> <code class="p">},</code>
  <code class="p">},</code>
  <code class="p">{</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s1">'Bend'</code><code class="p">,</code>
    <code class="nx">coordinates</code><code class="o">:</code> <code class="p">{</code> <code class="nx">lat</code><code class="o">:</code> <code class="mf">44.0581728</code><code class="p">,</code> <code class="nx">lng</code><code class="o">:</code> <code class="o">-</code><code class="mf">121.3153096</code> <code class="p">},</code>
  <code class="p">},</code>
  <code class="p">{</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s1">'Manzanita'</code><code class="p">,</code>
    <code class="nx">coordinates</code><code class="o">:</code> <code class="p">{</code> <code class="nx">lat</code><code class="o">:</code> <code class="mf">45.7184398</code><code class="p">,</code> <code class="nx">lng</code><code class="o">:</code> <code class="o">-</code><code class="mf">123.9351354</code> <code class="p">},</code>
  <code class="p">},</code>
<code class="p">])</code></pre>

<p>Now we have live weather data in our widget!<a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc16" id="idm45053572735864"/><a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc15" id="idm45053572735256"/><a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc14" id="idm45053572523800"/><a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc13" id="idm45053572523192"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="idm45053573217816">
<h1>Conclusion</h1>

<p>We’ve really only scratched the surface of what can be done with third-party API integration.  Everywhere you look, new APIs are popping up, offering every kind of data imaginable (even the City of Portland is now making a lot of public data available through REST APIs).  While it would be impossible to cover even a small percentage of the APIs available to you, this chapter has covered the fundamentals you’ll need to know to use these APIs: <code>http.request</code>, <code>https.request</code>, and parsing JSON.</p>

<p>We now have a lot of knowledge under our belt. We’ve covered a lot of ground!  What happens when things go wrong, though?  In the next chapter, we’ll be discussing debugging techniques to help us when things don’t work out as we expect.<a data-type="indexterm" data-startref="ix_ch-19-third_party_apis-asciidoc0" id="idm45053572519208"/></p>
</div></section>







</div></section></div>



  </body></html>