<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 2. Browsers" class="calibre4"><div class="preface" id="ch_browser">
<h1 class="calibre12"><span class="keep-together">Chapter 2. </span>Browsers</h1>


<p class="author1">JavaScript doesn’t have a single, bespoke implementation like most other programming languages do. For example, with Python, you’re probably going to run the Python binary provided by the language maintainers. JavaScript, on the other hand, has many different implementations. This includes the JavaScript engine that ships with different web browsers, such as V8 in Chrome, SpiderMonkey in Firefox, and JavaScriptCore in Safari. The V8 <a data-type="indexterm" data-primary="V8" data-secondary="Node.js" id="idm45995926712632" class="calibre6"/>engine is also used by Node.js on the server.</p>

<p class="author1">These separate implementations each start off by implementing some facsimile of the ECMAScript specification. As the compatibility charts that we so often need to consult suggest, not every engine implements JavaScript the same way. Certainly, browser vendors attempt to implement JavaScript features in the same manner, but bugs do happen. At the language level, there are some concurrency primitives that have been made available, which are covered in more detail in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch04.xhtml#ch_shared_mem" class="calibre6">4</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch05.xhtml#ch_adv_shared_mem" class="calibre6">5</a>.</p>

<p class="author1">Other APIs are also added in each implementation to make the JavaScript that can be run even more powerful. This chapter focuses entirely on the multithreaded APIs that are provided by modern web browsers, the most approachable of which is the web worker.</p>

<p class="author1">Using these worker threads is beneficial for many reasons, but one that is particularly applicable to browsers is that, by offloading CPU-intensive work to a separate thread, the main thread is then able to dedicate more resources to rendering the UI. This can help contribute to a smoother, more user-friendly experience than what might have been traditionally achievable.</p>






<section data-type="sect1" class="calibre4" data-pdf-bookmark="Dedicated Workers"><div class="preface" id="ch_browser_sec_web">
<h1 class="calibre13">Dedicated Workers</h1>

<p class="author1">Web workers allow you to spawn a <a data-type="indexterm" data-primary="web workers" id="idm45995926684696" class="calibre6"/>new environment for executing JavaScript in. JavaScript that is executed in this way is allowed to run in a separate thread from the JavaScript that spawned it. Communication occurs between these two environments by using a <a data-type="indexterm" data-primary="message passing" id="idm45995926683624" class="calibre6"/>pattern called <em class="calibre7">message passing</em>. Recall that it’s JavaScript’s nature to be single-threaded. Web workers play nicely with this nature and expose message passing by way of triggering functions to be run by the event loop.</p>

<p class="author1">It’s possible for a JavaScript environment to spawn more than one web worker, and a given web worker is free to spawn even more web workers. That said, if you find yourself spawning massive hierarchies of web workers, you might need to reevaluate your application.</p>

<p class="author1">There is more than one type of web worker, the simplest of which is the dedicated worker.</p>








<section data-type="sect2" data-pdf-bookmark="Dedicated Worker Hello World" class="calibre4"><div class="preface" id="idm45995926680840">
<h2 class="calibre37">Dedicated Worker Hello World</h2>

<p class="author1">The best way to learn a new technology is to <a data-type="indexterm" data-primary="web workers" data-secondary="dedicated" data-tertiary="Hello World" id="webdedhell" class="calibre6"/><a data-type="indexterm" data-primary="dedicated workers" data-secondary="Hello World" id="dedHell" class="calibre6"/>actually work with it. The relationship between page and worker that you are building is displayed in <a data-type="xref" href="#fig_dedicated_worker_relationship" class="calibre6">Figure 2-1</a>. In this case you’ll create just a single worker, but a hierarchy of workers is also achievable.</p>

<figure class="calibre29"><div id="fig_dedicated_worker_relationship" class="figure">
<img src="Images/mtjs_0201.png" alt="Dedicated Workers have exactly one parent" class="calibre44"/>
<h6 class="calibre30"><span class="keep-together">Figure 2-1. </span>Dedicated worker relationship</h6>
</div></figure>

<p class="author1">First, create a <a data-type="indexterm" data-primary="code samples" data-secondary="ch2-web-workers" id="idm45995926672504" class="calibre6"/>directory named <em class="calibre7">ch2-web-workers/</em>. You’ll keep the three example files required for this project in there. Next, create an <em class="calibre7">index.html</em> file inside the directory. JavaScript that runs in the browser needs to first be loaded by a web page, and this file represents the basis of that web page. Add the content from <a data-type="xref" href="#ex_ww_index" class="calibre6">Example 2-1</a> to this file to kick things off.</p>
<div id="ex_ww_index" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-1. </span><em class="calibre7">ch2-web-workers/index.html</em></h5>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;html&gt;</code>
  <code class="nt">&lt;head&gt;</code>
    <code class="nt">&lt;title&gt;</code>Web Workers Hello World<code class="nt">&lt;/title&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"main.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
  <code class="nt">&lt;/head&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre></div>

<p class="author1">As you can see, this file is super basic. All it is doing is setting a title and loading a single JavaScript file named <em class="calibre7">main.js</em>. The remaining sections in this chapter follow a similar pattern. The <a data-type="indexterm" data-primary="dedicated workers" data-secondary="instantiation" id="idm45995926658840" class="calibre6"/><a data-type="indexterm" data-primary="web workers" data-secondary="dedicated" data-tertiary="instantiation" id="idm45995926657992" class="calibre6"/>more interesting part is what’s inside the <em class="calibre7">main.js</em> file.</p>

<p class="author1">In fact, create that <em class="calibre7">main.js</em> file now, and add the content from <a data-type="xref" href="#ex_ww_main" class="calibre6">Example 2-2</a> to it.</p>
<div id="ex_ww_main" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-2. </span><em class="calibre7">ch2-web-workers/main.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'hello from main.js'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">

</code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">worker</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="kr">new</code><code class="calibre18"> </code><code class="nx">Worker</code><code class="p">(</code><code class="s">'worker.js'</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO1-1" href="#callout_browsers_CO1-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">

</code><code class="nx">worker</code><code class="p">.</code><code class="nx">onmessage</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">msg</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO1-2" href="#callout_browsers_CO1-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'message received from worker'</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">msg</code><code class="p">.</code><code class="nx">data</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code><code class="p">;</code><code class="calibre18">

</code><code class="nx">worker</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="s">'message sent to worker'</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO1-3" href="#callout_browsers_CO1-3"><img src="Images/3.png" alt="3" class="calibre32"/></a><code class="calibre18">

</code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'hello from end of main.js'</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO1-1" href="#co_browsers_CO1-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Instantiation of a new dedicated worker.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO1-2" href="#co_browsers_CO1-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">A message handler is attached to the worker.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO1-3" href="#co_browsers_CO1-3"><img src="Images/3.png" alt="3" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">A message is passed into the worker.</p></dd>
</dl></div>

<p class="author1">The first thing that happens in this file is that a call to <code class="calibre18">console.log()</code> is made. This is to make it obvious the order in which files get executed. The next thing that happens is that a new dedicated worker gets instantiated. This is done by calling <code class="calibre18">new Worker(<em class="calibre45">filename</em>)</code>. Once called, the JavaScript engine begins the download (or cache lookup) for the appropriate file in the background.</p>

<p class="author1">Next, a handler for the <code class="calibre18">message</code> event is attached to the worker. This is done by assigning a function to the <code class="calibre18">.onmessage</code> property of the dedicated worker. When a message is received, that function gets called. The argument provided to the function is an instance of <code class="calibre18">MessageEvent</code>. It comes with a bunch of properties, but the one that’s most interesting is the <code class="calibre18">.data</code> property. This represents the object that was returned from the dedicated worker.</p>

<p class="author1">Finally, a call to the <a data-type="indexterm" data-primary="postMessage() method" id="idm45995926096120" class="calibre6"/><a data-type="indexterm" data-primary="methods" data-secondary="postMessage()" id="idm45995926095512" class="calibre6"/>dedicated worker’s <code class="calibre18">.postMessage()</code> method is made. This is how the JavaScript environment that instantiates the dedicated worker is able to communicate with the dedicated worker. In this case a basic string has been passed into the dedicated worker. There are restrictions on what kind of data can be passed into this method; see the <a data-type="xref" data-xrefstyle="appendix-title" href="app01.xhtml#app_sca" class="calibre6">Appendix</a> for more details.</p>

<p class="author1">Now that your main JavaScript file is finished, you’re ready to create the file that will be executed within the dedicated worker. Create a new file named <em class="calibre7">worker.js</em> and add the contents of <a data-type="xref" href="#ex_ww_worker" class="calibre6">Example 2-3</a> to it.</p>
<div id="ex_ww_worker" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-3. </span><em class="calibre7">ch2-web-workers/worker.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'hello from worker.js'</code><code class="p">);</code>

<code class="nx">self</code><code class="p">.</code><code class="nx">onmessage</code> <code class="o">=</code> <code class="p">(</code><code class="nx">msg</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'message from main'</code><code class="p">,</code> <code class="nx">msg</code><code class="p">.</code><code class="nx">data</code><code class="p">);</code>

  <code class="nx">postMessage</code><code class="p">(</code><code class="s">'message sent from worker'</code><code class="p">);</code>
<code class="p">};</code></pre></div>

<p class="author1">In this file a single global <a data-type="indexterm" data-primary="global functions" id="idm45995926066968" class="calibre6"/><a data-type="indexterm" data-primary="onmessage function" id="idm45995926065928" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="onmessage" id="idm45995926065288" class="calibre6"/>function named <code class="calibre18">onmessage</code> is defined and a function is assigned to it. This <code class="calibre18">onmessage</code> function, inside the dedicated worker, is called when the <code class="calibre18">worker.postMessage()</code> method is called from outside the dedicated worker. This assignment could also have been written as <code class="calibre18">onmessage =</code> or even <code class="calibre18">var onmessage =</code>, but using <code class="calibre18">const onmessage =</code> or <code class="calibre18">let onmessage =</code> or even declaring <code class="calibre18">function onmessage</code> won’t work. The <code class="calibre18">self</code> identifier is an alias for <code class="calibre18">globalThis</code> inside a web worker where the otherwise familiar <code class="calibre18">window</code> isn’t available.</p>

<p class="author1">Inside the <code class="calibre18">onmessage</code> function, the code first prints the message that was received from outside of the dedicated worker. After that, it calls the <code class="calibre18">postMessage()</code> global function. This method takes an argument, and the argument is then provided to the calling environment by triggering the dedicated worker’s <code class="calibre18">onmessage()</code> method. The same rules about message passing and object cloning also apply here. Again, the example is just using a simple string for now.</p>

<p class="author1">There are some additional rules when it comes to loading a dedicated worker script file. The file that is loaded must be in the same origin that the main JavaScript environment is running in. Also, browsers won’t allow you to run dedicated workers when JavaScript runs using the <code class="calibre18">file://</code> protocol, which is a fancy way of saying you can’t simply double-click the <em class="calibre7">index.html</em> file and view the application running. Instead, you’ll need to run your application from a web server. Luckily, if you have a recent Node.js installed, you <a data-type="indexterm" data-primary="Node.js" data-secondary="web server, starting localling" id="idm45995926055768" class="calibre6"/>can run the following command to start a very basic web server locally:</p>

<pre data-type="programlisting" data-code-language="shell" class="calibre38"><code class="nv">$ </code>npx serve .</pre>

<p class="author1">Once executed, this command spins up a server that hosts files from the local filesystem. It also displays the URL that the server is available as. Typically the command outputs the following URL, assuming the port is free:</p>

<pre data-type="programlisting" class="calibre38">http://localhost:5000</pre>

<p class="author1">Copy whatever URL was provided to you and open it using a web browser. When the page first opens you’ll most likely see a plain, white screen. But that’s not a problem because all of the output is being displayed in the web developer console. Different browsers make the console available in different ways, but usually you can right-click somewhere in the background and click the Inspect menu option, or you can press Ctrl+Shift+I (or Cmd-Shift-I) to open up the inspector. Once in the inspector, click on the Console tab, and then refresh the page just in case any console messages weren’t captured. Once that’s done you should see the messages that are displayed in <a data-type="xref" href="#ex_ww_output" class="calibre6">Table 2-1</a>.</p>
<table id="ex_ww_output" class="calibre46">
<caption class="calibre47"><span class="keep-together">Table 2-1. </span>Example console output</caption>
<thead class="calibre48">
<tr class="calibre49">
<th class="calibre50">Log</th>
<th class="calibre50">Location</th>
</tr>
</thead>
<tbody class="calibre51">
<tr class="calibre49">
<td class="calibre52"><p class="author1">hello from main.js</p></td>
<td class="calibre52"><p class="author1">main.js:1:9</p></td>
</tr>
<tr class="calibre53">
<td class="calibre52"><p class="author1">hello from end of main.js</p></td>
<td class="calibre52"><p class="author1">main.js:11:9</p></td>
</tr>
<tr class="calibre49">
<td class="calibre52"><p class="author1">hello from worker.js</p></td>
<td class="calibre52"><p class="author1">worker.js:1:9</p></td>
</tr>
<tr class="calibre53">
<td class="calibre52"><p class="author1">message from main, message sent to worker</p></td>
<td class="calibre52"><p class="author1">worker.js:4:11</p></td>
</tr>
<tr class="calibre49">
<td class="calibre52"><p class="author1">message received from worker, message sent from worker</p></td>
<td class="calibre52"><p class="author1">main.js:6:11</p></td>
</tr>
</tbody>
</table>

<p class="author1">This output confirms the order in which the messages have been executed, though it’s not entirely deterministic. First, the <em class="calibre7">main.js</em> file is loaded, and its output is printed. The worker is instantiated and configured, its <code class="calibre18">postMessage()</code> method is called, and then the last message gets printed as well. Next, the <em class="calibre7">worker.js</em> file is run, and its message handler is called, printing a message. It then calls <code class="calibre18">postMessage()</code> to send a message back to <em class="calibre7">main.js</em>. Finally, the <code class="calibre18">onmessage</code> handler for the dedicated <a data-type="indexterm" data-primary="web workers" data-secondary="dedicated" data-tertiary="Hello World" data-startref="webdedhell" id="idm45995926044600" class="calibre6"/><a data-type="indexterm" data-primary="dedicated workers" data-secondary="Hello World" data-startref="dedHell" id="idm45995926043080" class="calibre6"/>worker is called in <em class="calibre7">main.js</em>, and the final message is printed.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Advanced Dedicated Worker Usage" class="calibre4"><div class="preface" id="idm45995926679896">
<h2 class="calibre37">Advanced Dedicated Worker Usage</h2>

<p class="author1">Now that you’re familiar with the basics of dedicated workers, you’re ready to work with some of the more complex features.</p>

<p class="author1">When you work with JavaScript that doesn’t <a data-type="indexterm" data-primary="dedicated workers" data-secondary="advanced use" id="dedadv" class="calibre6"/><a data-type="indexterm" data-primary="web workers" data-secondary="dedicated" data-tertiary="advanced use" id="webdedadv" class="calibre6"/><a data-type="indexterm" data-primary="code" data-secondary="loading" id="idm45995925989304" class="calibre6"/><a data-type="indexterm" data-primary="script tag" id="idm45995925988360" class="calibre6"/>involve dedicated workers, all the code you end up loading is available in the same realm. Loading new JavaScript code is done either by loading a script with a <code class="calibre18">&lt;script&gt;</code> tag, or by making an XHR request and using the <code class="calibre18">eval()</code> function<a data-type="indexterm" data-primary="eval() function" id="idm45995925970088" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="eval()" id="idm45995925969592" class="calibre6"/> with a string representing the code. When it comes to dedicated workers, you can’t inject a <code class="calibre18">&lt;script&gt;</code> tag into the DOM because there’s no DOM associated with the worker.</p>

<p class="author1">Instead, you can make use <a data-type="indexterm" data-primary="importScripts() function" id="idm45995925967864" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="importScripts()" id="idm45995925967256" class="calibre6"/>of the <code class="calibre18">importScripts()</code> function, which is a global function only available within web workers. This function accepts one or more arguments that represent the paths to scripts to be loaded. These scripts will be loaded from the same origin as the web page. These scripts are loaded in a synchronous manner, so code that follows the function call will run after the scripts are loaded.</p>

<p class="author1">Instances of <code class="calibre18">Worker</code> inherit <a data-type="indexterm" data-primary="Worker class" id="idm45995925964744" class="calibre6"/><a data-type="indexterm" data-primary="classes" data-secondary="Worker" id="idm45995925964136" class="calibre6"/>from <code class="calibre18">EventTarget</code> and have some generic methods for dealing with events. However, the <code class="calibre18">Worker</code> class provides the most important methods on the instance. The following is a list of these methods, some of which you’ve already worked with, some of which are new:</p>
<dl class="calibre14">
<dt class="calibre15"><code class="calibre18">worker.postMessage(msg)</code></dt>
<dd class="calibre16">
<p class="calibre17">This sends a message to the worker that is <a data-type="indexterm" data-primary="Worker class" data-secondary="worker.postMessage() method" id="idm45995925960376" class="calibre6"/>handled by the event loop before invoking the <code class="calibre18">self.onmessage</code> function, passing in <code class="calibre18">msg</code>.</p>
</dd>
<dt class="calibre15"><code class="calibre18">worker.onmessage</code></dt>
<dd class="calibre16">
<p class="calibre17">If assigned, it is in turn <a data-type="indexterm" data-primary="Worker class" data-secondary="worker.onmessage method" id="idm45995925957288" class="calibre6"/>invoked when the <code class="calibre18">self.postMessage</code> function inside the worker is called.</p>
</dd>
<dt class="calibre15"><code class="calibre18">worker.onerror</code></dt>
<dd class="calibre16">
<p class="calibre17">If assigned, it is invoked when <a data-type="indexterm" data-primary="Worker class" data-secondary="worker.onerror method" id="idm45995925954104" class="calibre6"/>an error is thrown inside the worker. A single <code class="calibre18">ErrorEvent</code> argument is provided, having <code class="calibre18">.colno</code>, <code class="calibre18">.lineno</code>, <code class="calibre18">.filename</code>, and 
<span class="keep-together"><code class="calibre18">.message</code></span> properties. This error will bubble up unless you call 
<span class="keep-together"><code class="calibre18">err.preventDefault()</code></span>.</p>
</dd>
<dt class="calibre15"><code class="calibre18">worker.onmessageerror</code></dt>
<dd class="calibre16">
<p class="calibre17">If assigned, this is invoked when the <a data-type="indexterm" data-primary="Worker class" data-secondary="worker.onmessageerror method" id="idm45995925948232" class="calibre6"/>worker receives a message that it cannot 
<span class="keep-together">deserialize</span>.</p>
</dd>
<dt class="calibre15"><code class="calibre18">worker.terminate()</code></dt>
<dd class="calibre16">
<p class="calibre17">If called, the worker terminates <a data-type="indexterm" data-primary="Worker class" data-secondary="worker.terminate method" id="idm45995925945176" class="calibre6"/>immediately. Future calls to <code class="calibre18">worker.postMessage()</code> will silently fail.</p>
</dd>
</dl>

<p class="author1">Inside the dedicated worker, the global <code class="calibre18">self</code> variable is an instance of <code class="calibre18">WorkerGlobalScope</code>. The most notable <a data-type="indexterm" data-primary="WorkerGlobalScope" id="idm45995925941976" class="calibre6"/><a data-type="indexterm" data-primary="JavaScript" data-secondary="files" data-tertiary="injecting" id="idm45995925941240" class="calibre6"/>addition is the <code class="calibre18">importScripts()</code> function for injecting new JavaScript files. Some of the high-level communication APIs <a data-type="indexterm" data-primary="API (application programming interface)" data-secondary="XMLHttpRequest" id="idm45995925939368" class="calibre6"/><a data-type="indexterm" data-primary="API (application programming interface)" data-secondary="WebSocket" id="idm45995925938328" class="calibre6"/><a data-type="indexterm" data-primary="API (application programming interface)" data-secondary="fetch()" id="idm45995925937368" class="calibre6"/><a data-type="indexterm" data-primary="WebSocket API" id="idm45995925936408" class="calibre6"/><a data-type="indexterm" data-primary="XMLHttpRequest API" id="idm45995925935736" class="calibre6"/><a data-type="indexterm" data-primary="fetch() function" id="idm45995925935064" class="calibre6"/>like <code class="calibre18">XMLHttpRequest</code>, <code class="calibre18">WebSocket</code>, and <code class="calibre18">fetch()</code> are available. Useful functions that aren’t necessarily part of JavaScript but are rebuilt by every major engine, like <code class="calibre18">setTimeout()</code>, <code class="calibre18">setInterval()</code>, <code class="calibre18">atob()</code>, and <code class="calibre18">btoa()</code>, are also available. The <a data-type="indexterm" data-primary="API (application programming interface)" data-secondary="localStorage" id="idm45995925931048" class="calibre6"/><a data-type="indexterm" data-primary="API (application programming interface)" data-secondary="indexedDB" id="idm45995925930008" class="calibre6"/><a data-type="indexterm" data-primary="localStorage API" id="idm45995925929048" class="calibre6"/><a data-type="indexterm" data-primary="indexedDB API" id="idm45995925928376" class="calibre6"/>two data-storage APIs, <code class="calibre18">localStorage</code> and <code class="calibre18">indexedDB</code>, are available.</p>

<p class="author1">When it comes to APIs that are missing, though, you’ll need to experiment and see what you have access to. Generally, APIs that modify the global state of the web page aren’t available. In the main JavaScript realm, the global <code class="calibre18">location</code> is available <a data-type="indexterm" data-primary="API (application programming interface)" data-secondary="location" id="idm45995925925672" class="calibre6"/><a data-type="indexterm" data-primary="location API" id="idm45995925924696" class="calibre6"/>and is an instance of <code class="calibre18">Location</code>. Inside a dedicated worker, <code class="calibre18">location</code> is still available, but it’s an instance of <code class="calibre18">WorkerLocation</code> and is a little different, notably missing a <code class="calibre18">.reload()</code> method that can cause a page refresh. The <code class="calibre18">document</code> global is also missing, which is the API for accessing the page’s DOM.</p>

<p class="author1">When instantiating a dedicated worker, there is an optional second argument for specifying the options for the worker. The instantiation takes on the following 
<span class="keep-together">signature</span>:</p>

<pre data-type="programlisting" data-code-language="javascript" class="calibre38"><code class="kr">const</code> <code class="nx">worker</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Worker</code><code class="p">(</code><code class="nx">filename</code><code class="p">,</code> <code class="nx">options</code><code class="p">);</code></pre>

<p class="author1">The <code class="calibre18">options</code> argument is an object that can contain the properties listed here:</p>
<dl class="calibre14">
<dt class="calibre15"><code class="calibre18">type</code></dt>
<dd class="calibre16">
<p class="calibre17">Either <code class="calibre18">classic</code> (default), for a classic JavaScript file, or <code class="calibre18">module</code>, to specify an ECMAScript Module (ESM).</p>
</dd>
<dt class="calibre15"><code class="calibre18">credentials</code></dt>
<dd class="calibre16">
<p class="calibre17">This value determines if HTTP credentials are sent with the request to get the worker file. The value can be <code class="calibre18">omit</code> to exclude the credentials, <code class="calibre18">same-origin</code> to send credentials (but only if the origin matches), or <code class="calibre18">include</code> to always send the <a data-type="indexterm" data-primary="dedicated workers" data-secondary="advanced use" data-startref="dedadv" id="idm45995925900936" class="calibre6"/><a data-type="indexterm" data-primary="web workers" data-secondary="dedicated" data-tertiary="advanced use" data-startref="webdedadv" id="idm45995925899656" class="calibre6"/>credentials.</p>
</dd>
</dl>
<dl class="calibre14">
<dt class="calibre15"><code class="calibre18">name</code></dt>
<dd class="calibre16">
<p class="calibre17">This names a dedicated worker and is mostly used for debugging. The value is provided in the worker as a global named <code class="calibre18">name</code>.</p>
</dd>
</dl>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Shared Workers" class="calibre4"><div class="preface" id="ch_browser_sec_shared">
<h1 class="calibre13">Shared Workers</h1>

<p class="author1">A <em class="calibre7">shared worker</em> is another type of web <a data-type="indexterm" data-primary="web workers" data-secondary="shared workers" id="webshare" class="calibre6"/><a data-type="indexterm" data-primary="shared workers" id="sharwork" class="calibre6"/>worker, but what makes it special is that a shared worker can be accessed by different browser environments, such as different windows (tabs), across iframes, and even from different web workers. They also have a different <code class="calibre18">self</code> within the worker, being an instance of <code class="calibre18">SharedWorkerGlobalScope</code>. A shared worker can only be accessed by JavaScript running on the same origin. For example, a window running on <em class="calibre7">http://localhost:5000</em> cannot access a shared worker running on <em class="calibre7">http://google.com:80</em>.</p>
<div data-type="warning" epub:type="warning" class="calibre24"><h6 class="calibre25">Warning</h6>
<p class="author1">Shared workers are currently <a href="https://oreil.ly/eHlkL" class="calibre6">disabled in Safari</a>, and this seems to have been true since at least 2013, which will undoubtedly harm adoption of the technology.</p>
</div>

<p class="author1">Before diving into code, it’s important to consider a few gotchas. One thing that makes shared workers a little hard to reason about is that they aren’t necessarily attached to a particular window (environment). Sure, they’re initially spawned by a particular window, but after that they can end up “belonging” to multiple windows. That means that when the first window is closed, the shared worker is kept around.</p>
<div data-type="tip" class="calibre22"><h6 class="calibre23">Tip</h6>
<p class="author1">Since shared workers don’t belong to a <a data-type="indexterm" data-primary="shared workers" data-secondary="windows" id="idm45995925884504" class="calibre6"/><a data-type="indexterm" data-primary="web workers" data-secondary="shared workers" data-tertiary="windows" id="idm45995925864344" class="calibre6"/>particular window, one interesting question is where should <code class="calibre18">console.log</code> output go? As of Firefox v85, the output is associated with the first window that spawns the <a data-type="indexterm" data-primary="Firefox v85, shared worker logs" id="idm45995925862632" class="calibre6"/>shared worker. Open another window and the first still gets the logs. Close the first window and the logs are now invisible. Open another window and the historical logs then appear in the newest window. Chrome v87, on the other hand, doesn’t display shared <a data-type="indexterm" data-primary="Chrome v87, shared worker logs" id="idm45995925861624" class="calibre6"/>worker logs at all. Keep this in mind when debugging.</p>
</div>
<aside data-type="sidebar" epub:type="sidebar" class="calibre54"><div class="sidebar" id="idm45995925860568">
<h5 class="calibre55">Debugging Shared Workers</h5>
<p class="author1">Both Firefox and Chrome offer a dedicated <a data-type="indexterm" data-primary="shared workers" data-secondary="debugging" id="idm45995925859016" class="calibre6"/><a data-type="indexterm" data-primary="debugging" data-secondary="shared workers" id="idm45995925858040" class="calibre6"/>way to debug shared workers. In Firefox, visit <em class="calibre7">about:debugging</em> in the address bar. Next, click This Firefox in the left column. Then, scroll down until you see the Shared Workers section with a list of shared worker scripts. In our case we see an Inspect button next to an entry for the <em class="calibre7">shared-worker.js</em> file. With Chrome, visit <em class="calibre7">chrome://inspect/#workers</em>, find the <em class="calibre7">shared-worker.js</em> entry, and then click the “inspect” link next to it. With both browsers you’ll be taken to a dedicated console attached to the worker.</p>
</div></aside>

<p class="author1">Shared workers can be used to hold a <a data-type="indexterm" data-primary="state, shared workers" id="idm45995925854488" class="calibre6"/><a data-type="indexterm" data-primary="shared workers" data-secondary="state" id="idm45995925853752" class="calibre6"/>semipersistent state that is maintained when other windows connect to it. For example, if Window 1 tells the shared worker to write a value, then Window 2 can ask the shared worker to read that value back. Refresh Window 1 and the value is still maintained. Refresh Window 2 and it’s also retained. Close Window 1 and it’s still retained. However, once you close or refresh the final window that is still using the shared worker, the state will be lost and the shared worker script will be evaluated again.</p>
<div data-type="warning" epub:type="warning" class="calibre24"><h6 class="calibre25">Warning</h6>
<p class="author1">A shared worker JavaScript file is cached while multiple windows are using it; refreshing a page won’t <a data-type="indexterm" data-primary="shared workers" data-secondary="file caching" id="idm45995925851048" class="calibre6"/>necessarily reload your changes. Instead, you’ll need to close other open browser windows, then refresh the remaining window, to get the browser to run your new code.</p>
</div>

<p class="author1">With these caveats in mind, you’re now <a data-type="indexterm" data-primary="web workers" data-secondary="shared workers" data-startref="webshare" id="idm45995925849176" class="calibre6"/><a data-type="indexterm" data-primary="shared workers" data-startref="sharwork" id="idm45995925847928" class="calibre6"/>ready to build a simple application that uses shared workers.</p>








<section data-type="sect2" data-pdf-bookmark="Shared Worker Hello World" class="calibre4"><div class="preface" id="idm45995925846728">
<h2 class="calibre37">Shared Worker Hello World</h2>

<p class="author1">A shared worker is “keyed” based on <a data-type="indexterm" data-primary="web workers" data-secondary="shared workers" data-tertiary="Hello World" id="websharHell" class="calibre6"/><a data-type="indexterm" data-primary="shared workers" data-secondary="Hello World" id="sharHell" class="calibre6"/>its location in the current origin. For example, the shared worker you’ll work with in this example is located somewhere like <em class="calibre7">http://localhost:5000/shared-worker.js</em>. Whether the worker is loaded from an HTML file located at <em class="calibre7">/red.html</em>, <em class="calibre7">/blue.html</em>, or even <em class="calibre7">/foo/index.html</em>, the shared worker instance will always remain the same. There is a way to create different shared worker instances using <a data-type="indexterm" data-primary="shared workers" data-secondary="instances" id="idm45995925839064" class="calibre6"/><a data-type="indexterm" data-primary="web workers" data-secondary="shared workers" data-tertiary="instances" id="idm45995925838088" class="calibre6"/>the same JavaScript file, and that’s covered in <a data-type="xref" href="#ch_browser_sec_shared_ss_adv" class="calibre6">“Advanced Shared Worker Usage”</a>.</p>

<p class="author1">The relationship between the page and the worker that you are building is displayed in <a data-type="xref" href="#fig_shared_worker_relationship" class="calibre6">Figure 2-2</a>.</p>

<figure class="calibre29"><div id="fig_shared_worker_relationship" class="figure">
<img src="Images/mtjs_0202.png" alt="Shared workers can be owned by more than one page." class="calibre56"/>
<h6 class="calibre30"><span class="keep-together">Figure 2-2. </span>Shared worker relationship</h6>
</div></figure>

<p class="author1">Now, it’s time to create some files. For this example, create a directory named <em class="calibre7">ch2-shared-workers/</em>, and all the files necessary will live in this directory. Once that’s done, create an HTML file containing the content in <a data-type="xref" href="#ex_sw_red_html" class="calibre6">Example 2-4</a>.</p>
<div id="ex_sw_red_html" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-4. </span><em class="calibre7">ch2-shared-workers/red.html</em></h5>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;html&gt;</code>
  <code class="nt">&lt;head&gt;</code>
    <code class="nt">&lt;title&gt;</code>Shared Workers Red<code class="nt">&lt;/title&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"red.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
  <code class="nt">&lt;/head&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre></div>

<p class="author1">Much like the HTML file you created in the previous section, this one just sets a title and loads a JavaScript file. Once that’s done, create another HTML file containing the content in <a data-type="xref" href="#ex_sw_blue_html" class="calibre6">Example 2-5</a>.</p>
<div id="ex_sw_blue_html" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-5. </span><em class="calibre7">ch2-shared-workers/blue.html</em></h5>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;html&gt;</code>
  <code class="nt">&lt;head&gt;</code>
    <code class="nt">&lt;title&gt;</code>Shared Workers Blue<code class="nt">&lt;/title&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"blue.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
  <code class="nt">&lt;/head&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre></div>

<p class="author1">For this example you’re going to work with two separate HTML files, each representing a new JavaScript environment that will be available on the same origin. Technically, you could have reused the same HTML file in both windows, but we want to make it very explicit that none of the state is going to be associated with the HTML files or the <em class="calibre7">red</em>/<em class="calibre7">blue</em> JavaScript files.</p>

<p class="author1">Next, you’re ready to create the <a data-type="indexterm" data-primary="JavaScript" data-secondary="files" data-tertiary="loaded by HTML file" id="idm45995925760920" class="calibre6"/><a data-type="indexterm" data-primary="HTML, loading JavaScript files" id="idm45995925759704" class="calibre6"/>first JavaScript file loaded directly by an HTML file. Create a file containing the content in <a data-type="xref" href="#ex_sw_red_js" class="calibre6">Example 2-6</a>.</p>
<div id="ex_sw_red_js" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-6. </span><em class="calibre7">ch2-shared-workers/red.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'red.js'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">

</code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">worker</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="kr">new</code><code class="calibre18"> </code><code class="nx">SharedWorker</code><code class="p">(</code><code class="s">'shared-worker.js'</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO2-1" href="#callout_browsers_CO2-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">

</code><code class="nx">worker</code><code class="p">.</code><code class="nx">port</code><code class="p">.</code><code class="nx">onmessage</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">event</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO2-2" href="#callout_browsers_CO2-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'EVENT'</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">event</code><code class="p">.</code><code class="nx">data</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO2-1" href="#co_browsers_CO2-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Instantiate the shared worker</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO2-2" href="#co_browsers_CO2-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Note the <code class="calibre18">worker.port</code> property for communications</p></dd>
</dl></div>

<p class="author1">This JavaScript file is rather basic. What it does is <a data-type="indexterm" data-primary="shared workers" data-secondary="instantiation" id="idm45995925703480" class="calibre6"/><a data-type="indexterm" data-primary="newSharedWorker() function" id="idm45995925702536" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="newSharedWorker()" id="idm45995925701896" class="calibre6"/>instantiate a shared worker instance by calling <code class="calibre18">new SharedWorker()</code>. After that it adds a handler for message events that are emitted from the shared worker. When a message is received, it is simply printed to the console.</p>

<p class="author1">Unlike with <code class="calibre18">Worker</code> instances, where you called <code class="calibre18">.onmessage</code> directly, with 
<span class="keep-together"><code class="calibre18">SharedWorker</code></span> instances you’ll make use of the <code class="calibre18">.port</code> property.</p>

<p class="author1">Next, copy and paste the <em class="calibre7">red.js</em> file that you created in <a data-type="xref" href="#ex_sw_red_js" class="calibre6">Example 2-6</a> and name it <em class="calibre7">blue.js</em>. Update the <code class="calibre18">console.log()</code> call to print <em class="calibre7">blue.js</em>; otherwise, the content will remain the same.</p>

<p class="author1">Finally, create a <em class="calibre7">shared-worker.js</em> file, containing <a data-type="indexterm" data-primary="shared-worker.js file" id="idm45995925662744" class="calibre6"/>the content in <a data-type="xref" href="#ex_sw_worker_js" class="calibre6">Example 2-7</a>. This is where most of the magic will happen.</p>
<div id="ex_sw_worker_js" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-7. </span><em class="calibre7">ch2-shared-workers/shared-worker.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code><code class="calibre18"> </code><code class="nx">ID</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">(</code><code class="p">)</code><code class="calibre18"> </code><code class="o">*</code><code class="calibre18"> </code><code class="mi">999999</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO3-1" href="#callout_browsers_CO3-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">
</code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'shared-worker.js'</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">ID</code><code class="p">)</code><code class="p">;</code><code class="calibre18">

</code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">ports</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="kr">new</code><code class="calibre18"> </code><code class="nx">Set</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO3-2" href="#callout_browsers_CO3-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">

</code><code class="nx">self</code><code class="p">.</code><code class="nx">onconnect</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">event</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO3-3" href="#callout_browsers_CO3-3"><img src="Images/3.png" alt="3" class="calibre32"/></a><code class="calibre18">
  </code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">port</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">event</code><code class="p">.</code><code class="nx">ports</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">;</code><code class="calibre18">
  </code><code class="nx">ports</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="nx">port</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'CONN'</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">ID</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">ports</code><code class="p">.</code><code class="nx">size</code><code class="p">)</code><code class="p">;</code><code class="calibre18">

  </code><code class="nx">port</code><code class="p">.</code><code class="nx">onmessage</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">event</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO3-4" href="#callout_browsers_CO3-4"><img src="Images/4.png" alt="4" class="calibre32"/></a><code class="calibre18">
    </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'MESSAGE'</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">ID</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">event</code><code class="p">.</code><code class="nx">data</code><code class="p">)</code><code class="p">;</code><code class="calibre18">

    </code><code class="kr">for</code><code class="calibre18"> </code><code class="p">(</code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">p</code><code class="calibre18"> </code><code class="kr">of</code><code class="calibre18"> </code><code class="nx">ports</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO3-5" href="#callout_browsers_CO3-5"><img src="Images/5.png" alt="5" class="calibre32"/></a><code class="calibre18">
      </code><code class="nx">p</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="p">[</code><code class="nx">ID</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">event</code><code class="p">.</code><code class="nx">data</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
    </code><code class="p">}</code><code class="calibre18">
  </code><code class="p">}</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO3-1" href="#co_browsers_CO3-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Random ID for debugging</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO3-2" href="#co_browsers_CO3-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Singleton list of ports</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO3-3" href="#co_browsers_CO3-3"><img src="Images/3.png" alt="3" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Connection event handler</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO3-4" href="#co_browsers_CO3-4"><img src="Images/4.png" alt="4" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Callback when a new message is received</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO3-5" href="#co_browsers_CO3-5"><img src="Images/5.png" alt="5" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Messages are dispatched to each window</p></dd>
</dl></div>

<p class="author1">The first thing that happens in this file is that a random ID value is generated. This value is printed in the console and later passed to the calling JavaScript environments. It’s not particularly useful with a real application, but it does a great job proving that state is retained, and when state is lost, when dealing with this shared worker.</p>

<p class="author1">Next, a singleton <code class="calibre18">Set</code> named <code class="calibre18">ports</code> is created.<sup class="calibre39"><a data-type="noteref" id="idm45995925449224-marker" href="ch02.xhtml#idm45995925449224" class="calibre40">1</a></sup> This will contain a list of all of the ports that are made available to the worker. Both the <code class="calibre18">worker.port</code> available in the window and the <code class="calibre18">port</code> provided <a data-type="indexterm" data-primary="MessagePort class" id="idm45995925446568" class="calibre6"/><a data-type="indexterm" data-primary="classes" data-secondary="MessagePort" id="idm45995925445960" class="calibre6"/>in a service worker are an instance of the <code class="calibre18">MessagePort</code> class.</p>

<p class="author1">The final thing that happens in the outer scope <a data-type="indexterm" data-primary="connect event" data-secondary="listeners" id="idm45995925444344" class="calibre6"/><a data-type="indexterm" data-primary="events" data-secondary="connect event" id="idm45995925443496" class="calibre6"/>of this shared worker file is that a listener for the <code class="calibre18">connect</code> event is established. This function is called every time a JavaScript environment creates a <code class="calibre18">SharedWorker</code> instance that references this shared worker. When this listener is called, an instance of <code class="calibre18">MessageEvent</code> is provided as the argument.</p>

<p class="author1">There are several properties <a data-type="indexterm" data-primary="connect event" data-secondary="properties" id="idm45995925440536" class="calibre6"/>available on the <code class="calibre18">connect</code> event, but the most important one is the <code class="calibre18">ports</code> property. This property is an array that contains a single element which is a reference to the <code class="calibre18">MessagePort</code> instance that allows communication with the calling JavaScript environment. This particular port is then added to the <code class="calibre18">ports</code> set.</p>

<p class="author1">An event listener for the <code class="calibre18">message</code> event is also <a data-type="indexterm" data-primary="message events" data-secondary="listeners" id="idm45995925436920" class="calibre6"/><a data-type="indexterm" data-primary="events" data-secondary="message" id="idm45995925436072" class="calibre6"/>attached to the port. Much like the <code class="calibre18">onmessage</code> method you used previously with the <code class="calibre18">Worker</code> instance, this method 
<span class="keep-together">is called</span> when one of the external JavaScript environments calls the 
<span class="keep-together">applicable</span> 
<span class="keep-together"><code class="calibre18">.postMessage()</code></span> method. When a message is received, the code prints the ID value and the data that was received.</p>

<p class="author1">The event listener also dispatches the message back to the calling environments. It does this by iterating the <code class="calibre18">ports</code> set, calling the <code class="calibre18">.postMessage()</code> method for each of the encountered ports. Since this method only takes a single argument, an array is passed in to sort of emulate multiple arguments. The first element of this array is the ID value again, and the second is the data that was passed in.</p>

<p class="author1">If you’ve worked with WebSockets using Node.js before, <a data-type="indexterm" data-primary="Node.js" data-secondary="WebSockets" id="idm45995925430408" class="calibre6"/>then this code pattern might feel familiar. With most popular WebSockets packages, an event is triggered when a connection is made, and the connection argument can then have a message listener attached to it.</p>

<p class="author1">At this point you’re ready to test your application again. First, run the following command inside your <em class="calibre7">ch2-shared-workers/</em> directory, and then copy and paste the URL that is displayed:</p>

<pre data-type="programlisting" data-code-language="shell" class="calibre38"><code class="nv">$ </code>npx serve .</pre>

<p class="author1">Again, in our case, we’re given the URL <em class="calibre7">http://localhost:5000</em>. This time, though, instead of opening the URL directly, you’ll want to first open the web inspector in your browser and then open a modified version of the URL.</p>

<p class="author1">Switch to your browser and open a new tab. It’s fine if this opens your home page, a blank tab, or whatever your default page is. Then, open the web inspector again and navigate to the console tab. Once that’s done, paste the URL that was given to you, but modify it to open the <em class="calibre7">/red.html</em> page. The URL that you enter might look something like this:</p>

<pre data-type="programlisting" class="calibre38">http://localhost:5000/red.html</pre>

<p class="author1">Press Enter to open the page. The <code class="calibre18">serve</code> package will <a data-type="indexterm" data-primary="serve package" id="idm45995925426536" class="calibre6"/>probably redirect your browser from <em class="calibre7">/red.html</em> to <em class="calibre7">/red</em>, but that’s fine.</p>

<p class="author1">Once the page has loaded, you should see the messages listed in <a data-type="xref" href="#table_sw_output_1" class="calibre6">Table 2-2</a> displayed in your console. If you open the inspector after loading the page, then you probably won’t see any logs, though doing so then refreshing the page should display the logs. Note that at the time of writing, only Firefox will display messages generated in <em class="calibre7">shared-worker.js</em>.</p>
<table id="table_sw_output_1" class="calibre46">
<caption class="calibre47"><span class="keep-together">Table 2-2. </span>First window console output</caption>
<thead class="calibre48">
<tr class="calibre49">
<th class="calibre50">Log</th>
<th class="calibre50">Location</th>
</tr>
</thead>
<tbody class="calibre51">
<tr class="calibre49">
<td class="calibre52"><p class="author1">red.js</p></td>
<td class="calibre52"><p class="author1">red.js:1:9</p></td>
</tr>
<tr class="calibre53">
<td class="calibre52"><p class="author1">shared-worker.js 278794</p></td>
<td class="calibre52"><p class="author1">shared-worker.js:2:9</p></td>
</tr>
<tr class="calibre49">
<td class="calibre52"><p class="author1">CONN 278794 1</p></td>
<td class="calibre52"><p class="author1">shared-worker.js:9:11</p></td>
</tr>
</tbody>
</table>

<p class="author1">In our case we can see that the <em class="calibre7">red.js</em> file was executed, that this particular <em class="calibre7">shared-worker.js</em> instance generated an ID of 278794, and that there is currently a single window connected to this shared worker.</p>

<p class="author1">Next, open another browser window. Again, open the web inspector first, switch to the Console tab, paste the base URL that was provided by the <code class="calibre18">serve</code> command, and then add <em class="calibre7">/blue.html</em> to the end of the URL. In our case the URL looks like this:</p>

<pre data-type="programlisting" class="calibre38">http://localhost:5000/blue.html</pre>

<p class="author1">Press Enter to open the URL. Once the page loads, you should only see a single message printed in the console output stating that the <em class="calibre7">blue.js</em> file was executed. At this point it’s not too interesting. But switch back to the previous window you had opened for the <em class="calibre7">red.html</em> page. You should see that the new log listed in <a data-type="xref" href="#table_sw_output_2" class="calibre6">Table 2-3</a> has been added.</p>
<table id="table_sw_output_2" class="calibre46">
<caption class="calibre47"><span class="keep-together">Table 2-3. </span>First window console output, continued</caption>
<thead class="calibre48">
<tr class="calibre49">
<th class="calibre50">Log</th>
<th class="calibre50">Location</th>
</tr>
</thead>
<tbody class="calibre51">
<tr class="calibre49">
<td class="calibre52"><p class="author1">CONN 278794 2</p></td>
<td class="calibre52"><p class="author1">shared-worker.js:9:11</p></td>
</tr>
</tbody>
</table>

<p class="author1">Now things are getting a little exciting. The shared worker environment now has two references to a <code class="calibre18">MessagePort</code> instance pointing to two separate windows. At the same time, two windows have references to <code class="calibre18">MessagePort</code> instances for the same shared worker.</p>

<p class="author1">Now you’re ready to send a message to the <a data-type="indexterm" data-primary="shared workers" data-secondary="messages" id="idm45995925381384" class="calibre6"/><a data-type="indexterm" data-primary="postMessage() method" id="idm45995925380536" class="calibre6"/>shared worker from one of the windows. Switch focus to the console window and type in the following command:</p>

<pre data-type="programlisting" data-code-language="javascript" class="calibre38"><code class="nx">worker</code><code class="p">.</code><code class="nx">port</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="s">'hello, world'</code><code class="p">);</code></pre>

<p class="author1">Press Enter to execute that line of JavaScript. You should see a message in the first console that is generated in the shared worker, a message in the first console from <em class="calibre7">red.js</em>, and a message in the second window’s console from <em class="calibre7">blue.js</em>. In our case we see the outputs listed in <a data-type="xref" href="#table_sw_output_3" class="calibre6">Table 2-4</a>.</p>
<table id="table_sw_output_3" class="calibre46">
<caption class="calibre47"><span class="keep-together">Table 2-4. </span>First and second window console output</caption>
<thead class="calibre48">
<tr class="calibre49">
<th class="calibre50">Log</th>
<th class="calibre50">Location</th>
<th class="calibre50">Console</th>
</tr>
</thead>
<tbody class="calibre51">
<tr class="calibre49">
<td class="calibre52"><p class="author1">MESSAGE 278794 hello, world</p></td>
<td class="calibre52"><p class="author1">shared-worker.js:12:13</p></td>
<td class="calibre52"><p class="author1">1</p></td>
</tr>
<tr class="calibre53">
<td class="calibre52"><p class="author1">EVENT Array [ 278794, “hello, world” ]</p></td>
<td class="calibre52"><p class="author1">red.js:6:11</p></td>
<td class="calibre52"><p class="author1">1</p></td>
</tr>
<tr class="calibre49">
<td class="calibre52"><p class="author1">EVENT Array [ 278794, “hello, world” ]</p></td>
<td class="calibre52"><p class="author1">blue.js:6:11</p></td>
<td class="calibre52"><p class="author1">2</p></td>
</tr>
</tbody>
</table>

<p class="author1">At this point you’ve successfully sent a message from the JavaScript environment available in one window to the JavaScript environment in a shared worker, and then passed a message from the worker to <a data-type="indexterm" data-primary="web workers" data-secondary="shared workers" data-tertiary="Hello World" data-startref="websharHell" id="idm45995925355624" class="calibre6"/><a data-type="indexterm" data-primary="shared workers" data-secondary="Hello World" data-startref="sharHell" id="idm45995925354104" class="calibre6"/>two separate windows.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Advanced Shared Worker Usage" class="calibre4"><div class="preface" id="ch_browser_sec_shared_ss_adv">
<h2 class="calibre37">Advanced Shared Worker Usage</h2>

<p class="author1">Shared workers are governed by the same <a data-type="indexterm" data-primary="web workers" data-secondary="shared workers" data-tertiary="advanced use" id="websharadv" class="calibre6"/><a data-type="indexterm" data-primary="shared workers" data-secondary="advanced use" id="sharadvuse" class="calibre6"/>object cloning rules described in the <a data-type="xref" data-xrefstyle="appendix" href="app01.xhtml#app_sca" class="calibre6">Appendix</a>. Also, like their dedicated worker equivalent, shared workers also have access to the <code class="calibre18">importScripts()</code> function for loading external JavaScript files. As of Firefox v85/Chrome v87 you may find Firefox more convenient to debug shared workers with due to the output of <code class="calibre18">console.log()</code> from the shared worker being available.</p>

<p class="author1">The shared worker instances <a data-type="indexterm" data-primary="connect event" data-secondary="shared workers" id="idm45995925327800" class="calibre6"/>do have access to a <code class="calibre18">connect</code> event, which can be handled with the <code class="calibre18">self.onconnect()</code> method. Notably missing, especially if you’re familiar with WebSockets, is a <code class="calibre18">disconnect</code> or <code class="calibre18">close</code> event.</p>

<p class="author1">When it comes to creating <a data-type="indexterm" data-primary="port instances" id="idm45995925325032" class="calibre6"/>a singleton collection of <code class="calibre18">port</code> instances, like in the sample code in this section, it’s very easy to create a memory leak. In this case, just keep refreshing one of the windows, and each refresh adds a new entry to the set.</p>

<p class="author1">This is far from ideal. One thing you can do to address this is to add an event listener in your main JavaScript environments (i.e., <em class="calibre7">red.js</em> and <em class="calibre7">blue.js</em>) that fires when the page is being torn down. Have this event listener pass a special message to the shared worker. Within the shared worker, when the message is received, remove the port from the list of ports. Here’s an example of how to do this:</p>

<pre data-type="programlisting" data-code-language="javascript" class="calibre38"><code class="c">// main JavaScript file</code>
<code class="nb">window</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s">'beforeunload'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">worker</code><code class="p">.</code><code class="nx">port</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="s">'close'</code><code class="p">);</code>
<code class="p">});</code>

<code class="c">// shared worker</code>
<code class="nx">port</code><code class="p">.</code><code class="nx">onmessage</code> <code class="o">=</code> <code class="p">(</code><code class="nx">event</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">if</code> <code class="p">(</code><code class="nx">event</code><code class="p">.</code><code class="nx">data</code> <code class="o">===</code> <code class="s">'close'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">ports</code><code class="p">.</code><code class="kr">delete</code><code class="p">(</code><code class="nx">port</code><code class="p">);</code>
    <code class="kr">return</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">};</code></pre>

<p class="author1">Unfortunately, there are still <a data-type="indexterm" data-primary="beforeunload event" id="idm45995925320840" class="calibre6"/><a data-type="indexterm" data-primary="events" data-secondary="beforeunload" id="idm45995925279912" class="calibre6"/>situations where a port can stick around. If the <code class="calibre18">beforeunload</code> event doesn’t fire, or if an error happens when it’s fired, or if the page crashes in an unanticipated way, this can lead to expired port references sticking around in the shared worker.</p>

<p class="author1">A more robust system would also need a <a data-type="indexterm" data-primary="shared workers" data-secondary="pinging environments" id="idm45995925277928" class="calibre6"/>way for the shared worker to occasionally “ping” the calling environments, sending a special message via <code class="calibre18">port.postMessage()</code>, and have the calling environments reply. With such an approach the shared worker can delete port instances if it doesn’t receive a reply within a certain amount of time. But even this approach isn’t perfect, as a slow JavaScript environment can lead to long response times. Luckily, interacting with ports that no longer have a valid JavaScript associated with them doesn’t have much of a side effect.</p>

<p class="author1">The full constructor for the <code class="calibre18">SharedWorker</code> class <a data-type="indexterm" data-primary="SharedWorker class" id="idm45995925275048" class="calibre6"/><a data-type="indexterm" data-primary="classes" data-secondary="SharedWorker" id="idm45995925274312" class="calibre6"/><a data-type="indexterm" data-primary="constructors" data-secondary="SharedWorker class" id="idm45995925273368" class="calibre6"/>looks like this:</p>

<pre data-type="programlisting" data-code-language="javascript" class="calibre38"><code class="kr">const</code> <code class="nx">worker</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">SharedWorker</code><code class="p">(</code><code class="nx">filename</code><code class="p">,</code> <code class="nx">nameOrOptions</code><code class="p">);</code></pre>

<p class="author1">The signature is slightly different than when instantiating a <code class="calibre18">Worker</code> instance, notably that the second argument can either be an options object, or the name of the worker. Much like with a <code class="calibre18">Worker</code> instance, the name of the worker is available inside the worker as <code class="calibre18">self.name</code>.</p>

<p class="author1">At this point you may be wondering how that works. For example, could the shared worker be declared in <em class="calibre7">red.js</em> with a name of “red worker” and in <em class="calibre7">blue.js</em> with a name of “blue worker”? In this case, two <em class="calibre7">separate</em> workers will be created, each with a different global environment, a different ID value, and the appropriate <code class="calibre18">self.name</code>.</p>

<p class="author1">You can think of these shared <a data-type="indexterm" data-primary="shared workers" data-secondary="keys" id="idm45995925260408" class="calibre6"/>worker instances as being “keyed” by not only their URL but also their name. This may be why the signature changes between a <code class="calibre18">Worker</code> and a <code class="calibre18">SharedWorker</code>, as the name is much more important for the latter.</p>

<p class="author1">Other than the ability to replace the options argument with a string name, the options argument for a <code class="calibre18">SharedWorker</code> is exactly the same as it is for a <code class="calibre18">Worker</code>.</p>

<p class="author1">In this example, you’ve only created a single <code class="calibre18">SharedWorker</code> instance per window, assigned to <code class="calibre18">worker</code>, but there is nothing stopping you from creating multiple instances. In fact, you can even create multiple shared workers that point to the same instance, assuming the URLs and names match. When this happens, both of the <code class="calibre18">SharedWorker</code> instances’ <code class="calibre18">.port</code> properties are able to receive messages.</p>

<p class="author1">These <code class="calibre18">SharedWorker</code> instances are definitely capable of maintaining state between page loads. You’ve been doing just that, with the <code class="calibre18">ID</code> variable holding a unique number and <code class="calibre18">ports</code> containing a list of ports. This state even persists through refreshes as long as one window remains open, like if you were to refresh the <em class="calibre7">blue.html</em> page followed by the <em class="calibre7">red.html</em> page. However, that state would be lost if both pages were refreshed simultaneously, one closed and the other refreshed, or if both were closed. In the next section you’ll work with a technology that can continue to <a data-type="indexterm" data-primary="web workers" data-secondary="shared workers" data-tertiary="advanced use" data-startref="websharadv" id="idm45995925244920" class="calibre6"/><a data-type="indexterm" data-primary="shared workers" data-secondary="advanced use" data-startref="sharadvuse" id="idm45995925243400" class="calibre6"/>maintain state—and run code—even when connected windows are closed.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Service Workers" class="calibre4"><div class="preface" id="ch_browser_sec_service">
<h1 class="calibre13">Service Workers</h1>

<p class="author1">A <em class="calibre7">service worker</em> functions as a <a data-type="indexterm" data-primary="web workers" data-secondary="service workers" id="idm45995925239880" class="calibre6"/><a data-type="indexterm" data-primary="service workers" id="idm45995925238872" class="calibre6"/>sort of proxy that sits between one or more web pages running in the browser and the server. Because a service worker isn’t associated with just a single web page but potentially multiple pages, it’s more similar to a shared worker than to a dedicated worker. They’re even “keyed” in the same manner as shared workers. But a service worker can exist and run in the background even when a page isn’t necessarily still open. Because of this you can think of a dedicated worker as being associated with one page, a shared worker as being associated with one or more pages, but a service worker as being associated with zero or more pages. But a shared worker doesn’t magically spawn into existence. Instead, it does require a web page to be opened first to install the shared worker.</p>

<p class="author1">Service workers are primarily intended for <a data-type="indexterm" data-primary="cache management, service workers" id="idm45995925236872" class="calibre6"/><a data-type="indexterm" data-primary="service workers" data-secondary="cache management" id="idm45995925236200" class="calibre6"/><a data-type="indexterm" data-primary="web workers" data-secondary="service workers" data-tertiary="cache management" id="idm45995925178600" class="calibre6"/>performing cache management of a website or a single page application. They are most commonly invoked when network requests are sent to the server, wherein an event handler inside the service worker intercepts the network request. The service worker’s claim to fame is that it can be used to return cached assets when a browser displays a web page but the computer it’s running on no longer has network access. When the service worker receives the request, it may consult a cache to find a cached resource, make a request to the server to retrieve some semblance of the resource, or even perform a heavy computation and return the result. While this last option makes it similar to the other web workers you’ve looked at, you really shouldn’t use service workers just for the purpose of offloading CPU-intensive work to another thread.</p>

<p class="author1">Service workers expose a larger API than <a data-type="indexterm" data-primary="web workers" data-secondary="service workers" data-tertiary="APIs" id="idm45995925176136" class="calibre6"/><a data-type="indexterm" data-primary="service workers" data-secondary="APIs" id="idm45995925174888" class="calibre6"/><a data-type="indexterm" data-primary="API (application programming interface)" data-secondary="service workers" id="idm45995925173944" class="calibre6"/>that of the other web workers, though their primary use case is not for offloading heavy computation from the main thread. Service workers are certainly complex enough to have entire books dedicated to them. That said, because the primary goal of this book is to teach you about the multithreaded capabilities of JavaScript, we won’t cover them in their entirety. For example, there’s an entire Push API available for receiving messages pushed to the browser from the server that won’t be covered at all.</p>

<p class="author1">Much like with the other web workers, a service worker can’t access the DOM. They also can’t make blocking requests. For example, setting the third argument of <code class="calibre18">XMLHttpRequest#open()</code> to <code class="calibre18">false</code>, which would block code execution until the request succeeds or times out, is not allowed. Browsers will only allow service workers to run on a web page that has been served using the HTTPS protocol. Luckily for us, there is one notable exception, where <code class="calibre18">localhost</code> may load service workers using HTTP. This is to make local development easier. Firefox doesn’t allow service workers when using its Private Browsing feature. Chrome, however, does allow service workers when using its Incognito feature. That said, a service worker instance can’t communicate between a normal and Incognito window.</p>

<p class="author1">Both Firefox and Chrome have an Applications panel in the inspector that contains a Service Workers section. You can use this to both view any service workers associated with the current page and to also perform a very important development action: unregister them, which basically allows you to reset the browser state to before the worker was registered. Unfortunately, as of the current browser versions, these browser panels don’t provide a way to hop into the JavaScript inspectors for the service workers.</p>
<aside data-type="sidebar" epub:type="sidebar" class="calibre54"><div class="sidebar" id="idm45995925168792">
<h5 class="calibre55">Debugging Service Workers</h5>
<p class="author1">To get into the inspector panels for your <a data-type="indexterm" data-primary="debugging" data-secondary="service workers" id="idm45995925167432" class="calibre6"/>service worker instances, you’ll need to go somewhere else. In Firefox, open the address bar and visit <em class="calibre7">about:debugging#/runtime/this-firefox</em>. Scroll down to the service workers and any workers you create today should be visible at the bottom. For Chrome, there are two different screens available for getting access to the browser’s service workers. The more robust page is located at <em class="calibre7">chrome://serviceworker-internals/</em>. It contains a listing of service workers, their status, and basic log output. The other one is at <em class="calibre7">chrome://inspect/#service-workers</em>, and it contains a lot less information.</p>
</div></aside>

<p class="author1">Now that you’re aware of some of the gotchas with service workers, you’re ready to build one out.</p>








<section data-type="sect2" data-pdf-bookmark="Service Worker Hello World" class="calibre4"><div class="preface" id="idm45995925163720">
<h2 class="calibre37">Service Worker Hello World</h2>

<p class="author1">In this section you’re going to build a <a data-type="indexterm" data-primary="service workers" data-secondary="Hello World" id="servHello" class="calibre6"/><a data-type="indexterm" data-primary="web workers" data-secondary="service workers" data-tertiary="Hello World" id="webservHell" class="calibre6"/>very basic service worker that intercepts all HTTP requests sent from a basic web page. Most of the requests will pass through to the server unaltered. However, requests made to a specific resource will instead return a value that is calculated by the service worker itself. Most service workers would instead do a lot of cache lookups, but again, the goal is to show off service workers from a multithreaded point of view.</p>

<p class="author1">The first file you’ll need is again an HTML file. Make a new <a data-type="indexterm" data-primary="code samples" data-secondary="ch2-service-workers" id="idm45995925157960" class="calibre6"/>directory named <em class="calibre7">ch2-service-workers/</em>. Then, inside this directory, create a file with the content from <a data-type="xref" href="#ex_service_workers_index" class="calibre6">Example 2-8</a>.</p>
<div id="ex_service_workers_index" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-8. </span><em class="calibre7">ch2-service-workers/index.html</em></h5>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;html&gt;</code>
  <code class="nt">&lt;head&gt;</code>
    <code class="nt">&lt;title&gt;</code>Service Workers Example<code class="nt">&lt;/title&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"main.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
  <code class="nt">&lt;/head&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre></div>

<p class="author1">This is a rather basic file that just loads your application’s JavaScript file, which comes next. Create a file named <em class="calibre7">main.js</em>, and add the content from <a data-type="xref" href="#ex_service_workers_main" class="calibre6">Example 2-9</a> to it.</p>
<div id="ex_service_workers_main" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-9. </span><em class="calibre7">ch2-service-workers/main.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="nx">navigator</code><code class="p">.</code><code class="nx">serviceWorker</code><code class="p">.</code><code class="nx">register</code><code class="p">(</code><code class="s">'/sw.js'</code><code class="p">,</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO4-1" href="#callout_browsers_CO4-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">
  </code><code class="nx">scope</code><code class="o">:</code><code class="calibre18"> </code><code class="s">'/'</code><code class="calibre18">
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code class="calibre18">

</code><code class="nx">navigator</code><code class="p">.</code><code class="nx">serviceWorker</code><code class="p">.</code><code class="nx">oncontrollerchange</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">(</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO4-2" href="#callout_browsers_CO4-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'controller change'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code><code class="p">;</code><code class="calibre18">

</code><code class="nx">async</code><code class="calibre18"> </code><code class="kr">function</code><code class="calibre18"> </code><code class="nx">makeRequest</code><code class="p">(</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO4-3" href="#callout_browsers_CO4-3"><img src="Images/3.png" alt="3" class="calibre32"/></a><code class="calibre18">
  </code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">result</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">await</code><code class="calibre18"> </code><code class="nx">fetch</code><code class="p">(</code><code class="s">'/data.json'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">payload</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">await</code><code class="calibre18"> </code><code class="nx">result</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">payload</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO4-1" href="#co_browsers_CO4-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Registers service worker and defines scope.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO4-2" href="#co_browsers_CO4-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Listens for a <code class="calibre18">controllerchange</code> event.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO4-3" href="#co_browsers_CO4-3"><img src="Images/3.png" alt="3" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Function to initiate request.</p></dd>
</dl></div>

<p class="author1">Now things are starting to get a little interesting. The first thing going on in this file is that the service worker is created. Unlike the other web workers you worked with, you aren’t using the <code class="calibre18">new</code> keyword with a constructor. Instead, this code <a data-type="indexterm" data-primary="navigator.serviceWorker object" id="idm45995925025112" class="calibre6"/><a data-type="indexterm" data-primary="objects" data-secondary="navigator.serviceWorker" id="idm45995925024440" class="calibre6"/>depends on the <code class="calibre18">navigator.serviceWorker</code> object to create the worker. The first argument is the path to the JavaScript file that acts as the service worker. The second argument is an optional configuration object that supports a single <code class="calibre18">scope</code> property.</p>

<p class="author1">The <code class="calibre18">scope</code> represents the directory for the current origin wherein any HTML pages that are loaded in it will have their requests passed through the service worker. By default, the <code class="calibre18">scope</code> value is the same as the directory that the service worker is loaded from. In this case, the <em class="calibre7">/</em> value is relative to the <em class="calibre7">index.html</em> directory, and because <em class="calibre7">sw.js</em> is located in the same directory, we could have omitted the scope and it would behave exactly the same.</p>

<p class="author1">Once the service worker has been installed for the page, all outbound HTTP requests will get sent through the service worker. This includes requests made to different origins. Since the scope for this page is set to the uppermost directory of the origin, any HTML page that is opened in this origin will then have to make requests through the service worker for assets. If the <code class="calibre18">scope</code> had been set to <em class="calibre7">/foo</em>, then a page opened at 
<span class="keep-together"><em class="calibre7">/bar.html</em></span> will be unaffected by the service worker, but a page at <em class="calibre7">/foo/baz.html</em> would be affected.</p>

<p class="author1">The next thing that happens is that a listener for the <code class="calibre18">controllerchange</code> event is added to the <code class="calibre18">navigator.serviceWorker</code> object. When this listener fires, a message is printed to the console. This message is just for debugging when a service worker takes control of a page that has been loaded and which is within the scope of the worker.</p>

<p class="author1">Finally, a function named <code class="calibre18">makeRequest()</code> is defined. This <a data-type="indexterm" data-primary="makeRequest() function" id="idm45995924978360" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="makeRequest()" id="idm45995924977752" class="calibre6"/>function makes a <code class="calibre18">GET</code> request to the <em class="calibre7">/data.json</em> path, decodes the response as JavaScript Object Notation (JSON), and prints the result. As you might have noticed, there aren’t any references to that function. Instead, you’ll manually run it in the console later to test the functionality.</p>

<p class="author1">With that file out of the way, you’re now ready to create the service worker itself. Create a third file named <em class="calibre7">sw.js</em>, and <a data-type="indexterm" data-primary="sw.js file" id="idm45995924974856" class="calibre6"/>add the content from <a data-type="xref" href="#ex_service_workers_sw" class="calibre6">Example 2-10</a> to it.</p>
<div id="ex_service_workers_sw" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-10. </span><em class="calibre7">ch2-service-workers/sw.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">let</code><code class="calibre18"> </code><code class="nx">counter</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="p">;</code><code class="calibre18">

</code><code class="nx">self</code><code class="p">.</code><code class="nx">oninstall</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">event</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'service worker install'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code><code class="p">;</code><code class="calibre18">

</code><code class="nx">self</code><code class="p">.</code><code class="nx">onactivate</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">event</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'service worker activate'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="nx">event</code><code class="p">.</code><code class="nx">waitUntil</code><code class="p">(</code><code class="nx">self</code><code class="p">.</code><code class="nx">clients</code><code class="p">.</code><code class="nx">claim</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO5-1" href="#callout_browsers_CO5-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">
</code><code class="p">}</code><code class="p">;</code><code class="calibre18">

</code><code class="nx">self</code><code class="p">.</code><code class="nx">onfetch</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">event</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'fetch'</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">event</code><code class="p">.</code><code class="nx">request</code><code class="p">.</code><code class="nx">url</code><code class="p">)</code><code class="p">;</code><code class="calibre18">

  </code><code class="kr">if</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">event</code><code class="p">.</code><code class="nx">request</code><code class="p">.</code><code class="nx">url</code><code class="p">.</code><code class="nx">endsWith</code><code class="p">(</code><code class="s">'/data.json'</code><code class="p">)</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
    </code><code class="nx">counter</code><code class="o">++</code><code class="p">;</code><code class="calibre18">
    </code><code class="nx">event</code><code class="p">.</code><code class="nx">respondWith</code><code class="p">(</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO5-2" href="#callout_browsers_CO5-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">
      </code><code class="kr">new</code><code class="calibre18"> </code><code class="nx">Response</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="p">{</code><code class="nx">counter</code><code class="p">}</code><code class="p">)</code><code class="p">,</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
        </code><code class="nx">headers</code><code class="o">:</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
          </code><code class="s">'Content-Type'</code><code class="o">:</code><code class="calibre18"> </code><code class="s">'application/json'</code><code class="calibre18">
        </code><code class="p">}</code><code class="calibre18">
      </code><code class="p">}</code><code class="p">)</code><code class="calibre18">
    </code><code class="p">)</code><code class="p">;</code><code class="calibre18">
    </code><code class="kr">return</code><code class="p">;</code><code class="calibre18">
  </code><code class="p">}</code><code class="calibre18">

  </code><code class="c">// fallback to normal HTTP request
</code><code class="calibre18">  </code><code class="nx">event</code><code class="p">.</code><code class="nx">respondWith</code><code class="p">(</code><code class="nx">fetch</code><code class="p">(</code><code class="nx">event</code><code class="p">.</code><code class="nx">request</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO5-3" href="#callout_browsers_CO5-3"><img src="Images/3.png" alt="3" class="calibre32"/></a><code class="calibre18">
</code><code class="p">}</code><code class="p">;</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO5-1" href="#co_browsers_CO5-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Allows service worker to claim the opened <em class="calibre7">index.html</em> page.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO5-2" href="#co_browsers_CO5-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Override for when <em class="calibre7">/data.json</em> is requested.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO5-3" href="#co_browsers_CO5-3"><img src="Images/3.png" alt="3" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Other URLs will fall back to a normal network request.</p></dd>
</dl></div>

<p class="author1">The first thing that happens in this file is that a <a data-type="indexterm" data-primary="counter variable" id="idm45995924786680" class="calibre6"/><a data-type="indexterm" data-primary="variable counter" id="idm45995924786008" class="calibre6"/>global variable <code class="calibre18">counter</code> is initialized to zero. Later, when certain types of requests are intercepted, that number will increment. This is just an example to prove that the service worker is running; in a real application you should never store state that’s meant to be persistent in this way. In fact, expect any service workers to start and stop fairly frequently, in a manner that’s hard to predict and that differs depending on browser implementation.</p>

<p class="author1">After that, we create a handler for the <code class="calibre18">install</code> event by assigning a function to <code class="calibre18">self.oninstall</code>. This function <a data-type="indexterm" data-primary="self.oninstall() function" id="idm45995924783096" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="self.oninstall()" id="idm45995924749400" class="calibre6"/>runs when this version of the service worker is installed for the very first time in the browser. Most real-world applications will perform instantiation work at this stage. For example, there’s an object available at <code class="calibre18">self.caches</code> which can be used to configure caches that store the result of network requests. However, because this basic application doesn’t have much to do in the way of instantiation, it just prints a message and finishes.</p>

<p class="author1">Next up is a function for <a data-type="indexterm" data-primary="activate event" id="idm45995924747192" class="calibre6"/><a data-type="indexterm" data-primary="events" data-secondary="activate" id="idm45995924746584" class="calibre6"/>handling the <code class="calibre18">activate</code> event. This event is useful for performing cleanup work when new versions of the service worker are introduced. With a real-world application, it’s probably going to do work like tearing down old versions of caches.</p>

<p class="author1">In this case, the <code class="calibre18">activate</code> handler function is <a data-type="indexterm" data-primary="self.clients.claim() method" id="idm45995924743992" class="calibre6"/><a data-type="indexterm" data-primary="methods" data-secondary="self.clients.claim()" id="idm45995924743384" class="calibre6"/><a data-type="indexterm" data-primary="activate event" data-secondary="handler function" id="idm45995924742536" class="calibre6"/>making a call to the <code class="calibre18">self.clients.claim()</code> method. Calling this allows the page instance that first created the service worker, that is, the <em class="calibre7">index.html</em> page you’ll open for the first time, to then get controlled by the service worker. If you didn’t have this line, the page wouldn’t be controlled by the service worker when first loaded. However, refreshing the page or opening <em class="calibre7">index.html</em> in another tab would then allow that page to be controlled.</p>

<p class="author1">The call to <code class="calibre18">self.clients.claim()</code> returns a promise. Sadly, event handler functions used in service workers are not async functions able to <code class="calibre18">await</code> promises. However, the <code class="calibre18">event</code> argument is an object with a <code class="calibre18">.waitUntil()</code> method, which does work with 
<span class="keep-together">a promise.</span> Once the promise provided to that method resolves, it will allow the 
<span class="keep-together"><code class="calibre18">oninstall</code></span> and <code class="calibre18">onactivate</code> (and later <code class="calibre18">onfetch</code>) handlers to finish. By not calling that method, like in the <code class="calibre18">oninstall</code> handler, the step is considered finished once the function exits.</p>

<p class="author1">The last event handler <a data-type="indexterm" data-primary="onfetch function" id="idm45995924734888" class="calibre6"/>is the <code class="calibre18">onfetch</code> function. This one is the most complex and also the one that will be called the most throughout the lifetime of the service worker. This handler is called every time a network request is made by a web page under control of the service worker. It’s called <code class="calibre18">onfetch</code> to signal that it correlates to the <code class="calibre18">fetch()</code> function in the browser, though it’s almost a misnomer because any network request will be passed through it. For example, if an image tag is later added to the page, the request would also trigger <code class="calibre18">onfetch</code>.</p>

<p class="author1">This function first logs a message to confirm that it’s being run and also printing the URL that is being requested. Other information about the requested resource is also available, such as headers and the HTTP method. In a real-world application this information can be used to consult with a cache to see if the resource already exists. For example, a <code class="calibre18">GET</code> request to a resource within the current origin could be served from the cache, but if it doesn’t exist, it could be requested using <a data-type="indexterm" data-primary="fetch() function" id="idm45995924730952" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="fetch()" id="idm45995924730344" class="calibre6"/>the <code class="calibre18">fetch()</code> function, then inserted into the cache, then returned to the browser.</p>

<p class="author1">This basic example just takes the URL and checks to see if it’s for a URL that ends in 
<span class="keep-together"><em class="calibre7">/data.json</em></span>. If it is not, the <code class="calibre18">if</code> statement body is skipped, and the final line of the function is called. This line just takes the request object (which is an instance of <code class="calibre18">Request</code>), passes it to the <code class="calibre18">fetch()</code> method, which returns a promise, and passes that promise to <code class="calibre18">event.respondWith()</code>. The <code class="calibre18">fetch()</code> method will resolve an object that will then be used to represent the response, which is then provided to the browser. This is essentially a very basic HTTP proxy.</p>

<p class="author1">However, circling back to the <em class="calibre7">/data.json</em> URL check, if it does pass, then something more complicated happens. In that case the <code class="calibre18">counter</code> variable is incremented, and a new response is generated from scratch (which is an instance of <code class="calibre18">Response</code>). In this case, a JSON string is constructed that contains the <code class="calibre18">counter</code> value. This is provided as the first argument to <code class="calibre18">Response</code>, which represents the response body. The second argument contains meta information about the response. In this case the <code class="calibre18">Content-Type</code> header is <a data-type="indexterm" data-primary="Content-Type header" id="idm45995924722216" class="calibre6"/>set to <code class="calibre18">application/json</code>, which suggests to the browser that the response is a JSON payload.</p>

<p class="author1">Now that your files have been created, navigate to the directory where you created them using your console and run the following command to start another web server:</p>

<pre data-type="programlisting" data-code-language="shell" class="calibre38"><code class="nv">$ </code>npx serve .</pre>

<p class="author1">Again, copy the URL that was provided, open a new web browser window, open the inspector, then paste the URL to visit the page. You should see this message printed in your console (and possibly others):</p>

<pre data-type="programlisting" class="calibre38">controller change              main.js:6:11</pre>

<p class="author1">Next, browse to the list of service workers installed in your browser using the aforementioned technique. Within the inspector, you should see the previously logged messages; specifically you should see these two:</p>

<pre data-type="programlisting" class="calibre38">service worker install         sw.js:4:11
service worker activate        sw.js:8:11</pre>

<p class="author1">Next, switch back to the browser window. While in the Console tab of the inspector, run the following line of code:</p>

<pre data-type="programlisting" data-code-language="javascript" class="calibre38"><code class="nx">makeRequest</code><code class="p">();</code></pre>

<p class="author1">This runs the <code class="calibre18">makeRequest()</code> function, which <a data-type="indexterm" data-primary="makeRequest() function" id="idm45995924716536" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="makeRequest()" id="idm45995924679016" class="calibre6"/>triggers an HTTP <code class="calibre18">GET</code> request to 
<span class="keep-together"><em class="calibre7">/data.json</em></span> of the current origin. Once it completes, you should see the message <code class="calibre18">Object { counter: 1 }</code> displayed in your console. That message was generated using the service worker, and the request was never sent to the web server. If you switch to the network tab of the inspector, you should see what looks like an 
<span class="keep-together">otherwise</span> normal request to get the resource. If you click the request, you should see that it replied with a 200 status code, and the <code class="calibre18">Content-Type</code> header should be set to <code class="calibre18">application/json</code> as well. As far as the web page is concerned, it did make a normal HTTP request. But you know better.</p>

<p class="author1">Switch back to the service worker inspector console. In here, you should see that a third message has been printed containing the details of the request. On our machine we get the following:</p>

<pre data-type="programlisting" class="calibre38">fetch http://localhost:5000/data.json   sw.js:13:11</pre>

<p class="author1">At this point you’ve successfully intercepted an HTTP request from one JavaScript environment, performed some computation in another environment, and returned the result back to the main environment. Much like with the other web workers, this calculation was done in a separate thread, running code in parallel. Had the service worker done some very heavy and slow calculations, the web page would have been free to perform other actions while it waited for the response.</p>
<div data-type="tip" class="calibre22"><h6 class="calibre23">Tip</h6>
<p class="author1">In your first browser window, you might have noticed an error that an attempt to download the <em class="calibre7">favicon.ico</em> file was made but failed. You might also be wondering why the shared worker console doesn’t mention this file. That’s because, at the point when the window was first opened, it wasn’t yet under control of the service worker, so the request was made directly over the network, bypassing the worker. Debugging service workers can be confusing, and this is one of the caveats to keep in mind.</p>
</div>

<p class="author1">Now that you’ve built a working service worker, you’re ready to learn about some of the more advanced features they <a data-type="indexterm" data-primary="service workers" data-secondary="Hello World" data-startref="servHello" id="idm45995924713160" class="calibre6"/><a data-type="indexterm" data-primary="web workers" data-secondary="service workers" data-tertiary="Hello World" data-startref="webservHell" id="idm45995924711912" class="calibre6"/>have to offer.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Advanced Service Worker Concepts" class="calibre4"><div class="preface" id="idm45995925162776">
<h2 class="calibre37">Advanced Service Worker Concepts</h2>

<p class="author1">Service workers are intended <a data-type="indexterm" data-primary="web workers" data-secondary="service workers" data-tertiary="advanced use" id="webservadv" class="calibre6"/><a data-type="indexterm" data-primary="service workers" data-secondary="advanced use" id="servadvuse" class="calibre6"/>to only be used for performing asynchronous operations. Because of that, the <code class="calibre18">localStorage</code> API, which technically blocks when reading and writing, isn’t available. However, the <a data-type="indexterm" data-primary="indexedDB API" id="idm45995924705384" class="calibre6"/><a data-type="indexterm" data-primary="API (application programming interface)" data-secondary="indexedDB" id="idm45995924704680" class="calibre6"/>asynchronous <code class="calibre18">indexedDB</code> API is available. Top-level <code class="calibre18">await</code> is disabled within service workers as well.</p>

<p class="author1">When it comes to keeping track of state, you’ll mostly be using <code class="calibre18">self.caches</code> and <code class="calibre18">indexedDB</code>. Again, keeping data in a global variable isn’t going to be reliable. In fact, while debugging your service workers, you might find that they occasionally end up stopped, at which point you’re not allowed to hop into the inspector. The browsers have a button that allows you to start the worker again, allowing you to hop back into the inspector. It’s this stopping and starting that flushes out global state.</p>

<p class="author1">Service worker scripts are <a data-type="indexterm" data-primary="service workers" data-secondary="script caching" id="idm45995924654120" class="calibre6"/>cached rather aggressively by the browser. When reloading the page, the browser may make a request for the script, but unless the script has changed, it won’t be considered for being replaced. The Chrome browser does offer the ability to trigger an update to the script when reloading the page; to do this, navigate to the Application tab in the inspector, then click “Service Workers,” then click the “Update on reload” checkbox.</p>

<p class="author1">Every service worker goes through a state change from the time <a data-type="indexterm" data-primary="service workers" data-secondary="state, stages" id="idm45995924652296" class="calibre6"/>of its inception until the time it can be used. This state is available within the service worker by reading the <code class="calibre18">self.serviceWorker.state</code> property. Here’s a list of the stages it goes through:</p>
<dl class="calibre14">
<dt class="calibre15">parsed</dt>
<dd class="calibre16">
<p class="calibre17">This is the very first state of the service worker. At this point the JavaScript content of the file has been parsed. This is more of an internal state that you’ll probably never encounter in your application.</p>
</dd>
<dt class="calibre15">installing</dt>
<dd class="calibre16">
<p class="calibre17">The installation has begun but is not yet complete. This happens once per worker version. This state is active after <code class="calibre18">oninstall</code> is called and before the <code class="calibre18">event.respondWith()</code> promise has resolved.</p>
</dd>
<dt class="calibre15">installed</dt>
<dd class="calibre16">
<p class="calibre17">At this point the installation is complete. The <code class="calibre18">onactivate</code> handler is going to be called next. In my testing I find that the service workers jump from <code class="calibre18">installing</code> to <code class="calibre18">activating</code> so fast that I never see the <code class="calibre18">installed</code> state.</p>
</dd>
<dt class="calibre15">activating</dt>
<dd class="calibre16">
<p class="calibre17">This state happens when <code class="calibre18">onactivate</code> is called but the <code class="calibre18">event.respondWith()</code> promise hasn’t yet resolved.</p>
</dd>
<dt class="calibre15">activated</dt>
<dd class="calibre16">
<p class="calibre17">The activation is complete, and the worker is ready to do its thing. At this point <code class="calibre18">fetch</code> events will get intercepted.</p>
</dd>
<dt class="calibre15">redundant</dt>
<dd class="calibre16">
<p class="calibre17">At this point, a newer version of the script has been loaded, and the previous script is no longer necessary. This can also be triggered if the worker script download fails, if it contains a syntax error, or if an error is thrown.</p>
</dd>
</dl>

<p class="author1">Philosophically, service workers should be <a data-type="indexterm" data-primary="service workers" data-secondary="progressive enhancement and" id="idm45995924638808" class="calibre6"/>treated as a form of progressive enhancement. This means that any web pages using them should still behave as usual if the service worker isn’t used at all. This is important because you might encounter a browser that doesn’t support service workers, or the installation phase might fail, or privacy-conscientious users might disable them entirely. In other words, if you’re only looking to add multithreading capabilities to your application, then choose one of the other web workers instead.</p>

<p class="author1">The global <code class="calibre18">self</code> object used inside service workers is an instance of <code class="calibre18">ServiceWorkerGlobalScope</code>. The <code class="calibre18">importScripts()</code> function <a data-type="indexterm" data-primary="importScripts() function" id="idm45995924635560" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="importScripts()" id="idm45995924634952" class="calibre6"/>available in other web workers is available in this environment as well. Like the other workers, it’s also possible to pass messages into, and receive messages from, a service worker. The same <code class="calibre18">self.onmessage</code> handler can be assigned. This can, perhaps, be used to signal to the service worker that it should perform some sort of cache invalidation. Again, messages passed in this way are subject to the same cloning algorithm that we discuss in the 
<span class="keep-together"><a data-type="xref" data-xrefstyle="appendix" href="app01.xhtml#app_sca" class="calibre6">Appendix</a>.</span></p>

<p class="author1">While debugging your service workers, and the requests that are being made from your browser, you’ll need to keep <a data-type="indexterm" data-primary="service workers" data-secondary="debugging" id="idm45995924631272" class="calibre6"/>caching in mind. Not only can the service worker implement caches that you control programmatically, but the browser itself also still has to deal with regular network caching. This can mean requests sent from your service worker to the server might not always be received by the server. For this reason, keep the <code class="calibre18">Cache-Control</code> and <code class="calibre18">Expires</code> headers in mind, and be sure to set intentional values.</p>

<p class="author1">There are many more features available to service workers than those covered in this section. Mozilla, the company behind Firefox, was nice enough to put together a cookbook website full of common strategies when building out service workers. This website is available at <a href="https://serviceworke.rs" class="calibre6"><em class="calibre7">https://serviceworke.rs</em></a> and we recommend checking it out if you’re considering implementing service workers in your next web app.</p>

<p class="author1">Service workers, and the other web workers you’ve looked at, certainly come with a bit of complexity. Lucky for us, there are some convenient libraries available, and communication patterns that you can implement, to make managing them a little easier.</p>
<aside data-type="sidebar" epub:type="sidebar" class="calibre54"><div class="sidebar" id="idm45995924626616">
<h5 class="calibre55">Cross-Document Communication</h5>
<p class="author1">There are other ways to employ multithreaded JavaScript programming in browsers without needing to instantiate a web worker. These can be done by communicating across different browser contexts, both fully open pages and iframes. Browsers provide APIs to allow for communication across these pages.</p>

<p class="author1">The first approach works by embedding iframes in a web page, or by creating a pop-up window, and has been available before web workers existed. The parent window is able to get a reference to the child window and can then call a <code class="calibre18">.postMessage()</code> method on that reference to send messages to the child. The child window can then listen for <code class="calibre18">message</code> events on its <code class="calibre18">window</code> object. The child can also pass messages back to the parent window. This pattern likely inspired the web worker interfaces.</p>

<p class="author1">The second approach is a bit more universal. It allows for communication across not only pop-ups and iframes but also any window that is opened for the same origin. It goes even further and allows for communication across worker threads as well. This communication is achieved by instantiating a new <code class="calibre18">BroadcastChannel</code> instance, 
<span class="keep-together">passing</span> in the name of a channel as the first argument. This channel then allows for pub/sub (publish and subscribe) communication. The resulting object has a 
<span class="keep-together"><code class="calibre18">.postMessage()</code></span> method and can have an <code class="calibre18">.onmessage</code> handler assigned. All objects that are listening on this channel across different environments will all have their message handler called when a message has been posted. The instance also has a <code class="calibre18">.close()</code> method <a data-type="indexterm" data-primary="web workers" data-secondary="service workers" data-tertiary="advanced use" data-startref="webservadv" id="idm45995924619288" class="calibre6"/><a data-type="indexterm" data-primary="service workers" data-secondary="advanced use" data-startref="servadvuse" id="idm45995924617960" class="calibre6"/>to disconnect the instance from the channel.</p>
</div></aside>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Message Passing Abstractions" class="calibre4"><div class="preface" id="ch_browser_sec_libs">
<h1 class="calibre13">Message Passing Abstractions</h1>

<p class="author1">Each of the web workers covered in this <a data-type="indexterm" data-primary="message passing" id="idm45995924615304" class="calibre6"/>chapter expose an interface for passing messages into, and receiving messages from, a separate JavaScript environment. This allows you to build applications that are capable of running JavaScript simultaneously across multiple cores.</p>

<p class="author1">However, you’ve really only worked with simple, contrived examples so far, passing along simple strings and calling simple functions. When it comes to building larger applications it’ll be important to pass messages along that can scale and run code in workers that can scale, and simplifying the interface when working with workers will also reduce potential errors.</p>








<section data-type="sect2" data-pdf-bookmark="The RPC Pattern" class="calibre4"><div class="preface" id="ch_browser_sec_libs_sub_rpc">
<h2 class="calibre37">The RPC Pattern</h2>

<p class="author1">So far, you’ve only worked with passing <a data-type="indexterm" data-primary="message passing" data-secondary="RPC pattern" id="messRPC" class="calibre6"/><a data-type="indexterm" data-primary="RPC (Remote Procedure Call)" data-secondary="message passing" id="RPCmess" class="calibre6"/>basic strings along to workers. While this is fine for getting a feel for the capabilities of web workers, it’s something that isn’t going to scale well for a full application.</p>

<p class="author1">For example, let’s assume you have a web worker that does a single thing, like sum all the square root values from 1 to 1,000,000. Well, you could just call the <code class="calibre18">postMessage()</code> for the worker, without <a data-type="indexterm" data-primary="postMessage() method" id="idm45995924607720" class="calibre6"/><a data-type="indexterm" data-primary="methods" data-secondary="postMessage()" id="idm45995924607016" class="calibre6"/>passing arguments, then run the slow logic in the <code class="calibre18">onmessage</code> handler, and send the message back using the worker’s <code class="calibre18">postMessage()</code> function. But what if the worker also needs to calculate Fibonacci sequence? In that case you could pass in a string, one for <code class="calibre18">square_sum</code>, and one for <code class="calibre18">fibonacci</code>. But what if you need arguments? Well, you could pass in <code class="calibre18">square_sum|1000000</code>. But what if you need argument types? Maybe you get something like <code class="calibre18">square_sum|num:1000000</code>. You can probably see what we’re getting at.</p>

<p class="author1">The RPC (Remote Procedure Call) pattern is a way to take a representation of a function and its arguments, serialize them, and pass them to a remote destination to have them get executed. The string <code class="calibre18">square_sum|num:1000000</code> is actually a form of RPC that we accidentally recreated. Perhaps it could ultimately translate into a function call like <code class="calibre18">squareNum(1000000)</code>, which is considered in <a data-type="xref" href="#ch_browser_sec_libs_sub_cmd" class="calibre6">“The Command Dispatcher Pattern”</a>.</p>

<p class="author1">There’s another bit of complexity that an application needs to worry about as well. If the main thread only sends a single message to a web worker at a time, then when a message is returned from the web worker, you know it’s the response to the message. But if you send multiple messages to a web worker at the same time, there’s no easy way to correlate the responses. For example, imagine an application that sends two messages to a web worker and receives two responses:</p>

<pre data-type="programlisting" data-code-language="javascript" class="calibre38"><code class="nx">worker</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="s">'square_sum|num:4'</code><code class="p">);</code>
<code class="nx">worker</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="s">'fibonacci|num:33'</code><code class="p">);</code>

<code class="nx">worker</code><code class="p">.</code><code class="nx">onmessage</code> <code class="o">=</code> <code class="p">(</code><code class="nx">result</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c">// Which result belongs to which message?</code>
  <code class="c">// '3524578'</code>
  <code class="c">// 4.1462643</code>
<code class="p">};</code></pre>

<p class="author1">Luckily, there does exist a standard for passing messages around and fulfilling the RPC pattern that inspiration can be drawn from. This standard is called <a href="https://jsonrpc.org" class="calibre6">JSON-RPC</a>, and it’s fairly trivial to implement. This standard defines JSON representations of request and response objects as “notification” objects, a way to define the method being called and arguments in the request, the result in the response, and a mechanism for associating requests and responses. It even supports error values and batching of requests. For this example you’ll only work with a request and response.</p>

<p class="author1">Taking the two function calls from our example, the JSON-RPC version of those requests and responses might look like this:</p>

<pre data-type="programlisting" data-code-language="json" class="calibre38"><code class="si">//</code> <code class="si">worker.postMessage</code>
<code class="p">{</code><code class="nt">"jsonrpc"</code><code class="p">:</code> <code class="s">"2.0"</code><code class="p">,</code> <code class="nt">"method"</code><code class="p">:</code> <code class="s">"square_sum"</code><code class="p">,</code> <code class="nt">"params"</code><code class="p">:</code> <code class="p">[</code><code class="mi">4</code><code class="p">],</code> <code class="nt">"id"</code><code class="p">:</code> <code class="mi">1</code><code class="p">}</code>
<code class="p">{</code><code class="nt">"jsonrpc"</code><code class="p">:</code> <code class="s">"2.0"</code><code class="p">,</code> <code class="nt">"method"</code><code class="p">:</code> <code class="s">"fibonacci"</code><code class="p">,</code> <code class="nt">"params"</code><code class="p">:</code> <code class="p">[</code><code class="mi">33</code><code class="p">],</code> <code class="nt">"id"</code><code class="p">:</code> <code class="mi">2</code><code class="p">}</code>

<code class="si">//</code> <code class="si">worker.onmessage</code>
<code class="p">{</code><code class="nt">"jsonrpc"</code><code class="p">:</code> <code class="s">"2.0"</code><code class="p">,</code> <code class="nt">"result"</code><code class="p">:</code> <code class="s">"3524578"</code><code class="p">,</code> <code class="nt">"id"</code><code class="p">:</code> <code class="mi">2</code><code class="p">}</code>
<code class="p">{</code><code class="nt">"jsonrpc"</code><code class="p">:</code> <code class="s">"2.0"</code><code class="p">,</code> <code class="nt">"result"</code><code class="p">:</code> <code class="mi">4.1462643</code><code class="p">,</code> <code class="nt">"id"</code><code class="p">:</code> <code class="mi">1</code><code class="p">}</code></pre>

<p class="author1">In this case there’s now a clear correlation between the response messages and their request.</p>

<p class="author1">JSON-RPC is intended to use JSON as the <a data-type="indexterm" data-primary="message serialization" id="idm45995924575944" class="calibre6"/><a data-type="indexterm" data-primary="serializing messages" id="idm45995924448104" class="calibre6"/>encoding when serializing messages, particularly when sending messages over the network. In fact, those <code class="calibre18">jsonrpc</code> fields define the version of JSON-RPC that the message is adhering to, which is very important in a network setting. However, because web workers use the structured clone algorithm (covered in the <a data-type="xref" data-xrefstyle="appendix" href="app01.xhtml#app_sca" class="calibre6">Appendix</a>) that allows passing JSON-compatible objects along, an app could just pass objects directly without paying the cost of JSON serialization and deserialization. Also, the <code class="calibre18">jsonrpc</code> fields might not be as important in the browser where you have tighter control of both ends of the communication channel.</p>

<p class="author1">With these <code class="calibre18">id</code> properties correlating request and response objects, it’s possible to then correlate which message relates to which. You’ll build a solution for correlating these two in <a data-type="xref" href="#ch_browser_sec_libs_sub_interface" class="calibre6">“Putting It All Together”</a>. But, for now, you need to first determine which <a data-type="indexterm" data-primary="message passing" data-secondary="RPC pattern" data-startref="messRPC" id="idm45995924442408" class="calibre6"/><a data-type="indexterm" data-primary="RPC (Remote Procedure Call)" data-secondary="message passing" data-startref="RPCmess" id="idm45995924441192" class="calibre6"/>function to call when a message is received.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="The Command Dispatcher Pattern" class="calibre4"><div class="preface" id="ch_browser_sec_libs_sub_cmd">
<h2 class="calibre37">The Command Dispatcher Pattern</h2>

<p class="author1">While the RPC pattern is useful for <a data-type="indexterm" data-primary="message passing" data-secondary="command dispatcher pattern" id="messcommdis" class="calibre6"/><a data-type="indexterm" data-primary="command dispatcher pattern" id="commdismess" class="calibre6"/>defining protocols, it doesn’t necessarily provide a mechanism for determining what code path to execute on the receiving end. The command dispatcher pattern solves this, providing a way to take a serialized 
<span class="keep-together">command</span>, find the appropriate function, and then execute it, optionally passing in 
<span class="keep-together">arguments</span>.</p>

<p class="author1">This pattern is fairly straightforward to implement and doesn’t require a whole lot of magic. First, we can assume that there are two variables that contain relevant information about the method or <em class="calibre7">command</em> that the code needs to run. The first variable is called <code class="calibre18">method</code> and is a string. The second variable is called <code class="calibre18">args</code> and is an array of values to be passed into the method. Assume these have been pulled from the RPC layer of the application.</p>

<p class="author1">The code that ultimately needs to run might live in different parts of the application. For example, maybe the square sum code lives in a third-party library, and the Fibonacci code is something that you’ve declared more locally. Regardless of where that code lives, you’ll want to make a single repository that maps these commands to the code that needs to be run. There are several ways to pull this off, for example by using a <code class="calibre18">Map</code> object, but because the commands are going to be fairly static, a humble JavaScript object will suffice.</p>

<p class="author1">Another important concept is that only defined commands should be executed. If the caller wants to invoke a method that doesn’t exist, an error should be gracefully generated that can be returned to the caller, without crashing the web worker. And, while the arguments could be passed into the method as an array, it would be a much nicer interface if the array of arguments were spread out into normal function arguments.</p>

<p class="author1"><a data-type="xref" href="#ex_command_dispatcher" class="calibre6">Example 2-11</a> shows an example implementation of a command dispatcher that you can use in your applications.</p>
<div id="ex_command_dispatcher" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-11. </span>Example command dispatcher</h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code><code class="calibre18"> </code><code class="nx">commands</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO6-1" href="#callout_browsers_CO6-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">
  </code><code class="nx">square_sum</code><code class="p">(</code><code class="nx">max</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
    </code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">sum</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="p">;</code><code class="calibre18">
    </code><code class="kr">for</code><code class="calibre18"> </code><code class="p">(</code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">i</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">i</code><code class="calibre18"> </code><code class="o">&lt;</code><code class="calibre18"> </code><code class="nx">max</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">i</code><code class="o">++</code><code class="p">)</code><code class="calibre18"> </code><code class="nx">sum</code><code class="calibre18"> </code><code class="o">+=</code><code class="calibre18"> </code><code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nx">i</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
    </code><code class="kr">return</code><code class="calibre18"> </code><code class="nx">sum</code><code class="p">;</code><code class="calibre18">
  </code><code class="p">}</code><code class="p">,</code><code class="calibre18">
  </code><code class="nx">fibonacci</code><code class="p">(</code><code class="nx">limit</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
    </code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">prev</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">1</code><code class="nx">n</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">next</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="nx">n</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">swap</code><code class="p">;</code><code class="calibre18">
    </code><code class="kr">while</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">limit</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
      </code><code class="nx">swap</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">prev</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">prev</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">prev</code><code class="calibre18"> </code><code class="o">+</code><code class="calibre18"> </code><code class="nx">next</code><code class="p">;</code><code class="calibre18">
      </code><code class="nx">next</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">swap</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">limit</code><code class="o">--</code><code class="p">;</code><code class="calibre18">
    </code><code class="p">}</code><code class="calibre18">
    </code><code class="kr">return</code><code class="calibre18"> </code><code class="nb">String</code><code class="p">(</code><code class="nx">next</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="p">}</code><code class="calibre18">
</code><code class="p">}</code><code class="p">;</code><code class="calibre18">
</code><code class="kr">function</code><code class="calibre18"> </code><code class="nx">dispatch</code><code class="p">(</code><code class="nx">method</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">args</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
  </code><code class="kr">if</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">commands</code><code class="p">.</code><code class="nx">hasOwnProperty</code><code class="p">(</code><code class="nx">method</code><code class="p">)</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO6-2" href="#callout_browsers_CO6-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">
    </code><code class="kr">return</code><code class="calibre18"> </code><code class="nx">commands</code><code class="p">[</code><code class="nx">method</code><code class="p">]</code><code class="p">(</code><code class="p">...</code><code class="nx">args</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO6-3" href="#callout_browsers_CO6-3"><img src="Images/3.png" alt="3" class="calibre32"/></a><code class="calibre18">
  </code><code class="p">}</code><code class="calibre18">
  </code><code class="kr">throw</code><code class="calibre18"> </code><code class="kr">new</code><code class="calibre18"> </code><code class="nx">TypeError</code><code class="p">(</code><code class="s">`</code><code class="s">Command </code><code class="si">${</code><code class="nx">method</code><code class="si">}</code><code class="s"> not defined!</code><code class="s">`</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO6-1" href="#co_browsers_CO6-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">The definition of all supported commands.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO6-2" href="#co_browsers_CO6-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Check to see if command exists.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO6-3" href="#co_browsers_CO6-3"><img src="Images/3.png" alt="3" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Arguments are spread and method is invoked.</p></dd>
</dl></div>

<p class="author1">This code defines an object named <code class="calibre18">commands</code> that contains the entire collection of commands that are supported by the command dispatcher. In this case the code is inlined but it’s absolutely fine, and even encouraged, to reach out to code that lives elsewhere.</p>

<p class="author1">The <code class="calibre18">dispatch()</code> function <a data-type="indexterm" data-primary="dispatch() function" id="idm45995923997448" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="dispatch()" id="idm45995923996712" class="calibre6"/>takes two arguments, the first being the name of the method and the second being the array of arguments. This function can be invoked when the web worker receives an RPC message representing the command. Within this function the first step is to check if the method exists. This is done using 
<span class="keep-together"><code class="calibre18">commands.hasOwnProperty()</code></span>. This is much safer than calling <code class="calibre18">method in commands</code> or even <code class="calibre18">commands[method]</code> since you don’t want noncommand properties like <code class="calibre18">__proto__</code> being called.</p>

<p class="author1">If the command is determined to exist, then the command arguments are spread out, with the first array element being the first argument, etc. The function is then called with the arguments, with the result of the call being returned. However, if the command doesn’t exist, then a <code class="calibre18">TypeError</code> is thrown.</p>

<p class="author1">This is about as basic of a command dispatcher as you can create. Other, more advanced dispatchers might do things like type checking, where the arguments are validated to adhere to a certain primitive type or where objects follow the appropriate shape, throwing errors generically so that the command method code doesn’t need to do it.</p>

<p class="author1">These two patterns will definitely help your <a data-type="indexterm" data-primary="message passing" data-secondary="command dispatcher pattern" data-startref="messcommdis" id="idm45995923991048" class="calibre6"/><a data-type="indexterm" data-primary="command dispatcher pattern" data-startref="commdismess" id="idm45995923989832" class="calibre6"/>applications out, but the interface can be streamlined even more.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Putting It All Together" class="calibre4"><div class="preface" id="ch_browser_sec_libs_sub_interface">
<h2 class="calibre37">Putting It All Together</h2>

<p class="author1">With JavaScript applications, we often think about performing work with outside services. For example, maybe we make a call to a database or maybe we make an HTTP request. When this happens we need to wait for a response to happen. Ideally, we can either provide a callback or treat this lookup as a promise. Although the web worker messaging interface doesn’t make this straightforward, we can definitely build it out by hand.</p>

<p class="author1">It would also be nice to have a more symmetrical interface within a web worker, perhaps by making use of an asynchronous function, one where the resolved value is automatically sent back to the calling environment, without the need to manually call <code class="calibre18">postMessage()</code> within the code.</p>

<p class="author1">In this section, you’ll do just that. You’ll combine the RPC pattern and the command dispatcher pattern and end up with an interface that makes working with web workers much like working with other external libraries you may be more familiar with. This example uses a dedicated worker, but the same thing could be built with a shared worker or service worker.</p>

<p class="author1">First, create a new directory named <em class="calibre7">ch2-patterns/</em> to house <a data-type="indexterm" data-primary="code samples" data-secondary="ch2-patterns" id="idm45995923983192" class="calibre6"/>the files you’re going to create. In here first create another basic HTML file named <em class="calibre7">index.html</em> containing the contents of <a data-type="xref" href="#ex_combined_index" class="calibre6">Example 2-12</a>.</p>
<div id="ex_combined_index" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-12. </span><em class="calibre7">ch2-patterns/index.html</em></h5>

<pre data-type="programlisting" data-code-language="html" class="calibre28"><code class="nt">&lt;html&gt;</code>
  <code class="nt">&lt;head&gt;</code>
    <code class="nt">&lt;title&gt;</code>Worker Patterns<code class="nt">&lt;/title&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"rpc-worker.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
    <code class="nt">&lt;script </code><code class="na">src=</code><code class="s">"main.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
  <code class="nt">&lt;/head&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre></div>

<p class="author1">This time the file is loading two JavaScript files. The first is a new library, and the second is the main JavaScript file, which you’ll now create. Make a file named <em class="calibre7">main.js</em>, and add the contents of <a data-type="xref" href="#ex_combined_main" class="calibre6">Example 2-13</a> to it.</p>
<div id="ex_combined_main" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-13. </span><em class="calibre7">ch2-patterns/main.js</em></h5>
<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code> <code class="nx">worker</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">RpcWorker</code><code class="p">(</code><code class="s">'worker.js'</code><code class="p">);</code>

<code class="nb">Promise</code><code class="p">.</code><code class="nx">allSettled</code><code class="p">([</code>
  <code class="nx">worker</code><code class="p">.</code><code class="nx">exec</code><code class="p">(</code><code class="s">'square_sum'</code><code class="p">,</code> <code class="mi">1_000_000</code><code class="p">),</code>
  <code class="nx">worker</code><code class="p">.</code><code class="nx">exec</code><code class="p">(</code><code class="s">'fibonacci'</code><code class="p">,</code> <code class="mi">1_000</code><code class="p">),</code>
  <code class="nx">worker</code><code class="p">.</code><code class="nx">exec</code><code class="p">(</code><code class="s">'fake_method'</code><code class="p">),</code>
  <code class="nx">worker</code><code class="p">.</code><code class="nx">exec</code><code class="p">(</code><code class="s">'bad'</code><code class="p">),</code>
<code class="p">]).</code><code class="nx">then</code><code class="p">(([</code><code class="nx">square_sum</code><code class="p">,</code> <code class="nx">fibonacci</code><code class="p">,</code> <code class="nx">fake</code><code class="p">,</code> <code class="nx">bad</code><code class="p">])</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'square sum'</code><code class="p">,</code> <code class="nx">square_sum</code><code class="p">);</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'fibonacci'</code><code class="p">,</code> <code class="nx">fibonacci</code><code class="p">);</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'fake'</code><code class="p">,</code> <code class="nx">fake</code><code class="p">);</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'bad'</code><code class="p">,</code> <code class="nx">bad</code><code class="p">);</code>
<code class="p">});</code></pre></div>

<p class="author1">This file represents application code using these new design patterns. First, a worker instance is created, but not by calling one of the web worker classes you’ve been working with so far. Instead, the code instantiates a new <code class="calibre18">RpcWorker</code> class. This class is going to be defined soon.</p>

<p class="author1">After that, four calls to different RPC methods <a data-type="indexterm" data-primary="RPC (Remote Procedure Call)" data-secondary="square_sum method" id="idm45995924262808" class="calibre6"/><a data-type="indexterm" data-primary="RPC (Remote Procedure Call)" data-secondary="fibonacci method" id="idm45995924261832" class="calibre6"/><a data-type="indexterm" data-primary="RPC (Remote Procedure Call)" data-secondary="bad method" id="idm45995924260920" class="calibre6"/><a data-type="indexterm" data-primary="RPC (Remote Procedure Call)" data-secondary="fake_method method" id="idm45995924260008" class="calibre6"/>are made by calling <code class="calibre18">worker.exec</code>. The first one is a call to the <code class="calibre18">square_sum</code> method, the second is to the <code class="calibre18">fibonacci</code> method, the third is to a method that doesn’t exist called <code class="calibre18">fake_method</code>, and the fourth is to a failing method named <code class="calibre18">bad</code>. The first argument is the name of the method, and all the following arguments end up being the arguments that are passed to the method.</p>

<p class="author1">The <code class="calibre18">exec</code> method returns a <a data-type="indexterm" data-primary="RPC (Remote Procedure Call)" data-secondary="exec method" id="idm45995924255704" class="calibre6"/>promise, one that will resolve if the operation succeeds and will reject if the operation fails. With this in mind, each of the promises has been wrapped into a <a data-type="indexterm" data-primary="RPC (Remote Procedure Call)" data-secondary="Promise.allSettled() call" id="idm45995924254376" class="calibre6"/>single <code class="calibre18">Promise.allSettled()</code> call. This will run all of them and then continue the execution once each is complete—regardless of success or failure. After that the result of each operation is printed. <code class="calibre18">allSettled()</code> results include an array of objects with a <code class="calibre18">status</code> string property, and either a <code class="calibre18">value</code> or <code class="calibre18">reason</code> property depending on success or failure.</p>

<p class="author1">Next, create a file named <em class="calibre7">rpc-worker.js</em>, and add the contents of <a data-type="xref" href="#ex_combined_rpc_1" class="calibre6">Example 2-14</a> to it.</p>
<div id="ex_combined_rpc_1" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-14. </span><em class="calibre7">ch2-patterns/rpc-worker.js</em> (part 1)</h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">class</code> <code class="nx">RpcWorker</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">(</code><code class="nx">path</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">this</code><code class="p">.</code><code class="nx">next_command_id</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
    <code class="kr">this</code><code class="p">.</code><code class="nx">in_flight_commands</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Map</code><code class="p">();</code>
    <code class="kr">this</code><code class="p">.</code><code class="nx">worker</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Worker</code><code class="p">(</code><code class="nx">path</code><code class="p">);</code>
    <code class="kr">this</code><code class="p">.</code><code class="nx">worker</code><code class="p">.</code><code class="nx">onmessage</code> <code class="o">=</code> <code class="kr">this</code><code class="p">.</code><code class="nx">onMessageHandler</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="kr">this</code><code class="p">);</code>
  <code class="p">}</code></pre></div>

<p class="author1">This first part of the file <a data-type="indexterm" data-primary="RpcWorker class" id="idm45995924219976" class="calibre6"/><a data-type="indexterm" data-primary="classes" data-secondary="RpcWorker" id="idm45995923956776" class="calibre6"/>starts the <code class="calibre18">RpcWorker</code> class and defines the constructor. Within the constructor a few properties are initialized. First, the <code class="calibre18">next_command_id</code> is set to zero. This value is used as the JSON-RPC-style incrementing message identifier. This is used to correlate the request and response objects.</p>

<p class="author1">Next, a property named <code class="calibre18">in_flight_commands</code> is initialized to an empty <code class="calibre18">Map</code>. This contains entries keyed by the command ID, with a value that contains a promise’s resolve and reject functions. The size of this map grows with the number of parallel messages sent to the worker and shrinks as their correlating messages are returned.</p>

<p class="author1">After that, a dedicated worker is <a data-type="indexterm" data-primary="dedicated workers" data-secondary="worker property" id="idm45995923952520" class="calibre6"/>instantiated and assigned to the <code class="calibre18">worker</code> property. This class effectively encapsulates a <code class="calibre18">Worker</code> instance. After that the <code class="calibre18">onmessage</code> handler of the worker is configured to call the <code class="calibre18">onMessageHandler</code> for the class (defined in the next chunk of code). The <code class="calibre18">RpcWorker</code> class doesn’t extend <code class="calibre18">Worker</code> because it doesn’t really want to expose functionality of the underlying web worker, instead creating a completely new interface.</p>

<p class="author1">Continue modifying the file by adding the content from <a data-type="xref" href="#ex_combined_rpc_2" class="calibre6">Example 2-15</a> to it.</p>
<div id="ex_combined_rpc_2" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-15. </span><em class="calibre7">ch2-patterns/rpc-worker.js</em> (part 2)</h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28">  <code class="nx">onMessageHandler</code><code class="p">(</code><code class="nx">msg</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code> <code class="nx">result</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">id</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">msg</code><code class="p">.</code><code class="nx">data</code><code class="p">;</code>
    <code class="kr">const</code> <code class="p">{</code> <code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code> <code class="p">}</code> <code class="o">=</code> <code class="kr">this</code><code class="p">.</code><code class="nx">in_flight_commands</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">id</code><code class="p">);</code>
    <code class="kr">this</code><code class="p">.</code><code class="nx">in_flight_commands</code><code class="p">.</code><code class="kr">delete</code><code class="p">(</code><code class="nx">id</code><code class="p">);</code>
    <code class="kr">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="nx">reject</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
    <code class="kr">else</code> <code class="nx">resolve</code><code class="p">(</code><code class="nx">result</code><code class="p">);</code>
  <code class="p">}</code></pre></div>

<p class="author1">This chunk of the file defines the <code class="calibre18">onMessageHandler</code> method, which runs when the dedicated <a data-type="indexterm" data-primary="onMessageHandler() method" id="idm45995923907784" class="calibre6"/><a data-type="indexterm" data-primary="methods" data-secondary="onMessageHandler()" id="idm45995923907176" class="calibre6"/>worker posts a message. This code assumes that a JSON-RPC-like message is passed from the web worker to the calling environment, and so, it first extracts the <code class="calibre18">result</code>, <code class="calibre18">error</code>, and <code class="calibre18">id</code> values from the response.</p>

<p class="author1">Next, it consults the <code class="calibre18">in_flight_commands</code> map to find the matching <code class="calibre18">id</code> value, retrieving the appropriate rejection and resolving functions, deleting the entry from the list in the process. If the <code class="calibre18">error</code> value was provided, then the operation is <a data-type="indexterm" data-primary="reject() function" id="idm45995923902744" class="calibre6"/><a data-type="indexterm" data-primary="resolve() method" id="idm45995923902040" class="calibre6"/><a data-type="indexterm" data-primary="methods" data-secondary="reject()" id="idm45995923901368" class="calibre6"/><a data-type="indexterm" data-primary="methods" data-secondary="resolve()" id="idm45995923900424" class="calibre6"/>considered a failure and the <code class="calibre18">reject()</code> function is called with the erroneous value. Otherwise, the <code class="calibre18">resolve()</code> function is called with the result of the operation. Note that this doesn’t support throwing falsy values.</p>

<p class="author1">For a production-ready version of this library you would also want to support a timeout value for these operations. Theoretically, it’s possible for an error to be thrown in such a way, or for a promise to never end up resolving in the worker, and the calling environment would want to reject the promise and also clear the data from the map. Otherwise the application might end up with a memory leak.</p>

<p class="author1">Finally, finish up this file by adding the remaining content from <a data-type="xref" href="#ex_combined_rpc_3" class="calibre6">Example 2-16</a> to it.</p>
<div id="ex_combined_rpc_3" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-16. </span><em class="calibre7">ch2-patterns/rpc-worker.js</em> (part 3)</h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28">  <code class="nx">exec</code><code class="p">(</code><code class="nx">method</code><code class="p">,</code> <code class="p">...</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">id</code> <code class="o">=</code> <code class="o">++</code><code class="kr">this</code><code class="p">.</code><code class="nx">next_command_id</code><code class="p">;</code>
    <code class="kr">let</code> <code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">;</code>
    <code class="kr">const</code> <code class="nx">promise</code> <code class="o">=</code> <code class="kr">new</code> <code class="nb">Promise</code><code class="p">((</code><code class="nx">res</code><code class="p">,</code> <code class="nx">rej</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="nx">resolve</code> <code class="o">=</code> <code class="nx">res</code><code class="p">;</code>
      <code class="nx">reject</code> <code class="o">=</code> <code class="nx">rej</code><code class="p">;</code>
    <code class="p">});</code>
    <code class="kr">this</code><code class="p">.</code><code class="nx">in_flight_commands</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="nx">id</code><code class="p">,</code> <code class="p">{</code> <code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code> <code class="p">});</code>
    <code class="kr">this</code><code class="p">.</code><code class="nx">worker</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">({</code> <code class="nx">method</code><code class="p">,</code> <code class="nx">params</code><code class="o">:</code> <code class="nx">args</code><code class="p">,</code> <code class="nx">id</code> <code class="p">});</code>
    <code class="kr">return</code> <code class="nx">promise</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code></pre></div>

<p class="author1">This last chunk of the file defines the <code class="calibre18">exec()</code> method, which is called when the application wants to <a data-type="indexterm" data-primary="exec() method" id="idm45995923891272" class="calibre6"/><a data-type="indexterm" data-primary="methods" data-secondary="exec()" id="idm45995923786056" class="calibre6"/>execute a method in the web worker. The first thing that happens is that a new <code class="calibre18">id</code> value is generated. Next, a promise is created, which will later be returned by the method. The <code class="calibre18">reject</code> and <code class="calibre18">resolve</code> functions for the promise are pulled out and are added to the <code class="calibre18">in_flight_commands</code> map, associated with the <code class="calibre18">id</code> value.</p>

<p class="author1">After that, a message is posted to the worker. The object that is passed into the worker is an object roughly adhering to the JSON-RPC shape. It contains the <code class="calibre18">method</code> property, a <code class="calibre18">params</code> property that is the remaining arguments in an array, and the <code class="calibre18">id</code> value that was generated for this particular command execution.</p>

<p class="author1">This is a fairly common pattern, useful for associating outgoing asynchronous messages with incoming asynchronous messages. You might find yourself implementing a similar pattern if you needed to, say, put a message onto a network queue and later receive a message. But, again, it does have memory implications.</p>

<p class="author1">With the RPC worker file out of <a data-type="indexterm" data-primary="worker.js file" id="idm45995923779928" class="calibre6"/>the way, you’re ready to create the last file. Make a file named <em class="calibre7">worker.js</em>, and add the contents of <a data-type="xref" href="#ex_combined_worker" class="calibre6">Example 2-17</a> to it.</p>
<div id="ex_combined_worker" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 2-17. </span><em class="calibre7">ch2-patterns/worker.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code><code class="calibre18"> </code><code class="nx">sleep</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">ms</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="kr">new</code><code class="calibre18"> </code><code class="nb">Promise</code><code class="p">(</code><code class="p">(</code><code class="nx">res</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="nx">setTimeout</code><code class="p">(</code><code class="nx">res</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">ms</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO7-1" href="#callout_browsers_CO7-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">

</code><code class="kr">function</code><code class="calibre18"> </code><code class="nx">asyncOnMessageWrap</code><code class="p">(</code><code class="nx">fn</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO7-2" href="#callout_browsers_CO7-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">
  </code><code class="kr">return</code><code class="calibre18"> </code><code class="nx">async</code><code class="calibre18"> </code><code class="kr">function</code><code class="p">(</code><code class="nx">msg</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
    </code><code class="nx">postMessage</code><code class="p">(</code><code class="nx">await</code><code class="calibre18"> </code><code class="nx">fn</code><code class="p">(</code><code class="nx">msg</code><code class="p">.</code><code class="nx">data</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="p">}</code><code class="calibre18">
</code><code class="p">}</code><code class="calibre18">

</code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">commands</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
  </code><code class="nx">async</code><code class="calibre18"> </code><code class="nx">square_sum</code><code class="p">(</code><code class="nx">max</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
    </code><code class="nx">await</code><code class="calibre18"> </code><code class="nx">sleep</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">(</code><code class="p">)</code><code class="calibre18"> </code><code class="o">*</code><code class="calibre18"> </code><code class="mi">100</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO7-3" href="#callout_browsers_CO7-3"><img src="Images/3.png" alt="3" class="calibre32"/></a><code class="calibre18">
    </code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">sum</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="p">;</code><code class="calibre18"> </code><code class="kr">for</code><code class="calibre18"> </code><code class="p">(</code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">i</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">i</code><code class="calibre18"> </code><code class="o">&lt;</code><code class="calibre18"> </code><code class="nx">max</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">i</code><code class="o">++</code><code class="p">)</code><code class="calibre18"> </code><code class="nx">sum</code><code class="calibre18"> </code><code class="o">+=</code><code class="calibre18"> </code><code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nx">i</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
    </code><code class="kr">return</code><code class="calibre18"> </code><code class="nx">sum</code><code class="p">;</code><code class="calibre18">
  </code><code class="p">}</code><code class="p">,</code><code class="calibre18">
  </code><code class="nx">async</code><code class="calibre18"> </code><code class="nx">fibonacci</code><code class="p">(</code><code class="nx">limit</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
    </code><code class="nx">await</code><code class="calibre18"> </code><code class="nx">sleep</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">(</code><code class="p">)</code><code class="calibre18"> </code><code class="o">*</code><code class="calibre18"> </code><code class="mi">100</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
    </code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">prev</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">1</code><code class="nx">n</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">next</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="nx">n</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">swap</code><code class="p">;</code><code class="calibre18">
    </code><code class="kr">while</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">limit</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><code class="nx">swap</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">prev</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">prev</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">prev</code><code class="calibre18"> </code><code class="o">+</code><code class="calibre18"> </code><code class="nx">next</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">next</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">swap</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">limit</code><code class="o">--</code><code class="p">;</code><code class="calibre18"> </code><code class="p">}</code><code class="calibre18">
    </code><code class="kr">return</code><code class="calibre18"> </code><code class="nb">String</code><code class="p">(</code><code class="nx">next</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO7-4" href="#callout_browsers_CO7-4"><img src="Images/4.png" alt="4" class="calibre32"/></a><code class="calibre18">
  </code><code class="p">}</code><code class="p">,</code><code class="calibre18">
  </code><code class="nx">async</code><code class="calibre18"> </code><code class="nx">bad</code><code class="p">(</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
    </code><code class="nx">await</code><code class="calibre18"> </code><code class="nx">sleep</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">(</code><code class="p">)</code><code class="calibre18"> </code><code class="o">*</code><code class="calibre18"> </code><code class="mi">10</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
    </code><code class="kr">throw</code><code class="calibre18"> </code><code class="kr">new</code><code class="calibre18"> </code><code class="nb">Error</code><code class="p">(</code><code class="s">'oh no'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="p">}</code><code class="calibre18">
</code><code class="p">}</code><code class="p">;</code><code class="calibre18">

</code><code class="nx">self</code><code class="p">.</code><code class="nx">onmessage</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">asyncOnMessageWrap</code><code class="p">(</code><code class="nx">async</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">rpc</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO7-5" href="#callout_browsers_CO7-5"><img src="Images/5.png" alt="5" class="calibre32"/></a><code class="calibre18">
  </code><code class="kr">const</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><code class="nx">method</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">params</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">id</code><code class="calibre18"> </code><code class="p">}</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">rpc</code><code class="p">;</code><code class="calibre18">

  </code><code class="kr">if</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">commands</code><code class="p">.</code><code class="nx">hasOwnProperty</code><code class="p">(</code><code class="nx">method</code><code class="p">)</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
    </code><code class="kr">try</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
      </code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">result</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">await</code><code class="calibre18"> </code><code class="nx">commands</code><code class="p">[</code><code class="nx">method</code><code class="p">]</code><code class="p">(</code><code class="p">...</code><code class="nx">params</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
      </code><code class="kr">return</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><code class="nx">id</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">result</code><code class="calibre18"> </code><code class="p">}</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO7-6" href="#callout_browsers_CO7-6"><img src="Images/6.png" alt="6" class="calibre32"/></a><code class="calibre18">
    </code><code class="p">}</code><code class="calibre18"> </code><code class="kr">catch</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
      </code><code class="kr">return</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><code class="nx">id</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">error</code><code class="o">:</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><code class="nx">code</code><code class="o">:</code><code class="calibre18"> </code><code class="o">-</code><code class="mi">32000</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">message</code><code class="o">:</code><code class="calibre18"> </code><code class="nx">err</code><code class="p">.</code><code class="nx">message</code><code class="calibre18"> </code><code class="p">}</code><code class="p">}</code><code class="p">;</code><code class="calibre18">
    </code><code class="p">}</code><code class="calibre18">
  </code><code class="p">}</code><code class="calibre18"> </code><code class="kr">else</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
    </code><code class="kr">return</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_browsers_CO7-7" href="#callout_browsers_CO7-7"><img src="Images/7.png" alt="7" class="calibre32"/></a><code class="calibre18">
      </code><code class="nx">id</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">error</code><code class="o">:</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
        </code><code class="nx">code</code><code class="o">:</code><code class="calibre18"> </code><code class="o">-</code><code class="mi">32601</code><code class="p">,</code><code class="calibre18">
        </code><code class="nx">message</code><code class="o">:</code><code class="calibre18"> </code><code class="s">`</code><code class="s">method </code><code class="si">${</code><code class="nx">method</code><code class="si">}</code><code class="s"> not found</code><code class="s">`</code><code class="calibre18">
      </code><code class="p">}</code><code class="calibre18">
    </code><code class="p">}</code><code class="p">;</code><code class="calibre18">
  </code><code class="p">}</code><code class="calibre18">
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO7-1" href="#co_browsers_CO7-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Adds artificial slowdown to methods.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO7-2" href="#co_browsers_CO7-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">A basic wrapper to convert <code class="calibre18">onmessage</code> to an async function.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO7-3" href="#co_browsers_CO7-3"><img src="Images/3.png" alt="3" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Artificial random slowdowns are added to the commands.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO7-4" href="#co_browsers_CO7-4"><img src="Images/4.png" alt="4" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">The <code class="calibre18">BigInt</code> result is coerced into a JSON-friendly string value.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO7-5" href="#co_browsers_CO7-5"><img src="Images/5.png" alt="5" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">The <code class="calibre18">onmessage</code> wrapper is injected.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO7-6" href="#co_browsers_CO7-6"><img src="Images/6.png" alt="6" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">A successful JSON-RPC-like message is resolved on success.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_browsers_CO7-7" href="#co_browsers_CO7-7"><img src="Images/7.png" alt="7" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">An erroneous JSON-RPC-like message is rejected if a method doesn’t exist.</p></dd>
</dl></div>

<p class="author1">This file has a lot going on. First, the <code class="calibre18">sleep</code> function <a data-type="indexterm" data-primary="sleep() function" id="idm45995923460904" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="sleep()" id="idm45995923171576" class="calibre6"/>is just a promise equivalent version of <code class="calibre18">setTimeout()</code>. The <code class="calibre18">asyncOnMessageWrap()</code> is a function that can wrap an <code class="calibre18">async</code> function and be assigned the <code class="calibre18">onmessage</code> handler. This is a convenience to pull out the data property of the incoming message, pass it to the function, await the result, then pass the result to <code class="calibre18">postMessage()</code>.</p>

<p class="author1">After that, the <code class="calibre18">commands</code> object from before has made its return. This time, though, artificial timeouts have been added and the functions have been made into <code class="calibre18">async</code> functions. This lets the methods emulate an otherwise slow asynchronous process.</p>

<p class="author1">Finally, the <code class="calibre18">onmessage</code> handler is assigned using the wrapper function. The code inside it takes the incoming JSON-RPC-like message and pulls out the <code class="calibre18">method</code>, 
<span class="keep-together"><code class="calibre18">params</code></span>, and <code class="calibre18">id</code> properties. Much like before, the commands collection is consulted to see if it has the method. If it doesn’t, a JSON-RPC-like error is returned. The <code class="calibre18">-32601</code> value is a magic number defined by JSON-RPC to represent a method that doesn’t exist. When the command does exist, the command method is executed, then the resolved value is coerced into a JSON-RPC-like successful message and returned. If the command throws, then a different error is returned, using another JSON-RPC magic number of <code class="calibre18">-32000</code>.</p>

<p class="author1">Once you’ve got the file created, switch to your browser and open the inspector. Then, launch the web server again using the following command from within the <em class="calibre7">ch2-patterns/</em> directory:</p>

<pre data-type="programlisting" data-code-language="shell" class="calibre38"><code class="nv">$ </code>npx serve .</pre>

<p class="author1">Next, switch back to browser and paste in the URL from the output. You won’t see anything interesting on the page, but in the console you should see the following messages:</p>

<pre data-type="programlisting" class="calibre38">square sum    { status: "fulfilled", value: 666666166.4588418 }
fibonacci     { status: "fulfilled", value: "4346655768..." }
fake          { status: "rejected", reason: { code: -32601,
                message: "method fake_method not found" } }
bad           { status: "rejected", reason: { code: -32000,
                message: "oh no" } }</pre>

<p class="author1">In this case you can see that both the <code class="calibre18">square_sum</code> and <code class="calibre18">fibonacci</code> calls ended successfully, while the <code class="calibre18">fake_method</code> command resulted in failure. More importantly, under the hood, the calls to the methods are resolving in different orders, but thanks to the incrementing <code class="calibre18">id</code> values the responses are always properly correlated to their requests.</p>
</div></section>





</div></section>







<div data-type="footnotes" class="calibre41"><p data-type="footnote" id="idm45995925449224" class="calibre42"><sup class="calibre43"><a href="ch02.xhtml#idm45995925449224-marker" class="calibre40">1</a></sup> As of Firefox v85, regardless of how many entries are in the <code class="calibre18">ports</code> set, calling <code class="calibre18">console.log(ports)</code> will always display a single entry. For now, to debug the size, call <code class="calibre18">console.log(ports.size)</code> instead.</p></div></div></section></div></body></html>