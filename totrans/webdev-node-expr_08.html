<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 8. Form Handling"><div class="chapter" id="ch_form_handling">
<h1><span class="label">Chapter 8. </span>Form Handling</h1>


<p><a data-type="indexterm" data-primary="form handling" id="ix_ch-08-form_handling-asciidoc0"/>The usual way you collect information from your users is to use HTML
<em>forms</em>. Whether you let
the browser submit the form normally, use Ajax, or employ fancy frontend
controls, the underlying mechanism is generally still an HTML form. In
this chapter, we’ll discuss the different methods for handling forms, form
validation, and file uploads.</p>






<section data-type="sect1" data-pdf-bookmark="Sending Client Data to the Server"><div class="sect1" id="idm45053592334040">
<h1>Sending Client Data to the Server</h1>

<p><a data-type="indexterm" data-primary="form handling" data-secondary="sending client data to server" id="idm45053592332872"/><a data-type="indexterm" data-primary="querystring" data-secondary="sending client data to server with" id="idm45053592331736"/><a data-type="indexterm" data-primary="request body" data-secondary="sending client data to server with" id="idm45053592330776"/>Broadly speaking, your two options for sending client data to the server
are the querystring and the request body. <a data-type="indexterm" data-primary="GET request" id="idm45053592809048"/>Normally, if you’re using the querystring, you’re making
a <code>GET</code> request, and if you’re using
<a data-type="indexterm" data-primary="POST request" data-secondary="request body and" id="idm45053592807928"/>the request body, you’re using a <code>POST</code> request. (The HTTP protocol doesn’t
prevent you from doing it the other way around, but there’s no point to it:
best to stick to standard practice here.)</p>

<p>It is a common misperception that <code>POST</code> is secure and <code>GET</code> is not: in
reality, both are secure if you use HTTPS, and neither is secure if you
don’t. If you’re not using HTTPS, an intruder can look at the body data
for a <code>POST</code> just as easily as the querystring of a <code>GET</code> request.
However, if you’re using <code>GET</code> requests, your users will see all of their
input (including hidden fields) in the querystring, which is ugly and
messy. Also, browsers
often place limits on querystring length (there is no such restriction for
body length). For these reasons, I generally recommend using <code>POST</code> for
form submission.</p>
</div></section>













<section data-type="sect1" class="pagebreak-before" data-pdf-bookmark="HTML Forms"><div class="sect1" id="idm45053592802520">
<h1>HTML Forms</h1>

<p><a data-type="indexterm" data-primary="form handling" data-secondary="HTML forms" id="idm45053592800776"/><a data-type="indexterm" data-primary="HTML forms" id="idm45053592799800"/>This book is focusing on the server side, but it’s important to understand
some basics about constructing HTML forms. Here’s a simple example:</p>

<pre data-type="programlisting" data-code-language="html"><code class="nt">&lt;form</code> <code class="na">action=</code><code class="s">"/process"</code> <code class="na">method=</code><code class="s">"POST"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"hidden"</code> <code class="na">name=</code><code class="s">"hush"</code> <code class="na">val=</code><code class="s">"hidden, but not secret!"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;div&gt;</code>
        <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"fieldColor"</code><code class="nt">&gt;</code>Your favorite color: <code class="nt">&lt;/label&gt;</code>
        <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">id=</code><code class="s">"fieldColor"</code> <code class="na">name=</code><code class="s">"color"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;/div&gt;</code>
    <code class="nt">&lt;div&gt;</code>
        <code class="nt">&lt;button</code> <code class="na">type=</code><code class="s">"submit"</code><code class="nt">&gt;</code>Submit<code class="nt">&lt;/button&gt;</code>
    <code class="nt">&lt;/div&gt;</code>
<code class="nt">&lt;/form&gt;</code></pre>

<p>Notice the method is specified explicitly as <code>POST</code> in the <code>&lt;form&gt;</code> tag; if
you don’t do this, it defaults to <code>GET</code>. The <code>action</code>
attribute specifies the URL that will receive the form when it’s posted.
If you omit this field, the form will be submitted to the same URL the form
was loaded from. I recommend that you always provide a valid <code>action</code>,
even if you’re using Ajax (this is to prevent you from losing data; see
<a data-type="xref" href="ch22.xhtml#ch_maintenance">Chapter 22</a> for more <span class="keep-together">information).</span></p>

<p>From the server’s perspective, the important attributes in the <code>&lt;input&gt;</code>
fields are the <code>name</code> attributes: that’s how the server identifies the field. It’s important to
understand that the <code>name</code> attribute is distinct from the <code>id</code> attribute,
which should be used for styling and frontend functionality only (it is not
passed to the server).</p>

<p>Note the hidden field: this will not render in the user’s browser.
However, you should not use it for secret or sensitive information; all the
user has to do is examine the page source, and the hidden field will be
exposed.</p>

<p>HTML does not restrict you from having multiple forms on the same page
(this was an unfortunate restriction of some early server frameworks; ASP,
I’m looking at you). I recommend keeping your forms logically consistent;
a form should contain all the fields you would like submitted at once
(optional/empty fields are OK) and none that you don’t. If you have two
different actions on a page, use two different forms. An example of this
would be to have a form for a site search and a separate form for signing
up for an email newsletter. It is possible to use one large form and
figure out what action to take based on what button a person clicked, but
it is a headache and often not friendly for people with disabilities
(because of the way accessibility browsers render forms).</p>

<p>When the user submits the form in this example, the <em>/process</em> URL will be
invoked, and the field values will be transmitted to the server in the
request body.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Encoding"><div class="sect1" id="idm45053592751416">
<h1>Encoding</h1>

<p><a data-type="indexterm" data-primary="encoding of forms" id="idm45053592750216"/><a data-type="indexterm" data-primary="form handling" data-secondary="encoding" id="idm45053592749512"/>When the form is submitted (either by the browser or via Ajax), it must be
encoded somehow. If you
don’t explicitly specify an encoding, it defaults to
<code>application/x-www-form-urlencoded</code> (this is just a lengthy media type for
“URL encoded”). This is a basic, easy-to-use encoding
that’s supported by Express out of the box.</p>

<p>If you need to upload files, things get more complicated. There’s no easy
way to send files using URL encoding, so you’re forced to use the <code>multipart/form-data</code> encoding type, which
is not handled directly by Express.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Different Approaches to Form Handling"><div class="sect1" id="idm45053592746504">
<h1>Different Approaches to Form Handling</h1>

<p><a data-type="indexterm" data-primary="form handling" data-secondary="various approaches to" id="ix_ch-08-form_handling-asciidoc1"/>If you’re not using Ajax, your only option is to submit the form through
the browser, which will reload the page. However, <em>how</em> the page is reloaded is up to you. There
are two things to consider when processing forms: what path handles the
form (the action) and what response is sent to the browser.</p>

<p>If your form uses <code>method="POST"</code> (which is recommended), it is quite
common to use the same path for displaying the form and processing the
form: these can be distinguished because the former is a <code>GET</code> request, and
the latter is a <code>POST</code> request. If you take this approach, you can omit
the <code>action</code> attribute on the form.</p>

<p>The other option is to use a separate path to process the form. For
example, if your contact page uses the path <em>/contact</em>, you might use the
path <em>/process-contact</em> to process the form (by specifying
<code>action="/process-contact"</code>). If you use this approach, you have the
option of submitting the form via <code>GET</code> (which I do not recommend; it
needlessly exposes your form fields on the URL). Using a separate endpoint
for form submission might be preferred if you have multiple URLs that use
the same submission mechanism (for example, you might have an email sign-up
box on multiple pages on the site).</p>

<p>Whatever path you use to process the form, you have to decide what response
to send back to the browser. Here are your options:</p>
<dl>
<dt>Direct HTML response</dt>
<dd>
<p> After processing the form, you can send HTML directly back to the
browser (a view, for example). This approach will produce a warning if the
user attempts to reload the page and can interfere with bookmarking and the
Back button, and for these reasons, it is not recommended.</p>
</dd>
<dt>302 redirect</dt>
<dd>
<p> <a data-type="indexterm" data-primary="302 redirect" id="idm45053592734248"/>While this is a common approach, it is a misuse of the original meaning
of the 302 (Found) response code. HTTP 1.1 added the
303 (See Other) response code, which is preferable. Unless you have reason
to target browsers made before 1996, you should use 303 instead.</p>
</dd>
<dt>303 redirect</dt>
<dd>
<p> <a data-type="indexterm" data-primary="303 redirect" id="idm45053592731816"/>The 303 (See Other) response code was added in HTTP
1.1 to address the misuse of the 302 redirect. The HTTP specification
specifically indicates that the browser should use a <code>GET</code> request when
following a 303 redirect, regardless of the original method. This is the
recommended method for responding to a form submission request.</p>
</dd>
</dl>

<p>Since the recommendation is that you respond to a form submission with a
303 redirect, the next question is, “Where does the redirection point to?”
The answer to that is up to you. Here are the most common
approaches:</p>
<dl>
<dt>Redirect to dedicated success/failure pages</dt>
<dd>
<p> This method requires that you dedicate URLs for appropriate success or
failure messages. For example, if the user signs up for promotional
emails but there was a database error, you might want to redirect to
<em>/error/database</em>. If a user’s email address were invalid, you could
redirect to <em>/error/invalid-email</em>, and if everything was successful, you
could redirect to <em>/promo-email/thank-you</em>. One of the advantages of
this method is that it’s analytics friendly: the number of visits to
your <em>/promo-email/thank-you</em> page should roughly correlate to the number
of <span class="keep-together">people</span> signing up for your
promotional email. It is also straightforward to implement. It has
some downsides, however. It does mean you have to allocate URLs to every
possibility, which means pages to design, write copy for, and maintain.
Another disadvantage is that the user experience can be suboptimal: users
like to be thanked, but then they have to navigate back to where they were
or where they want to go next. This is the approach we’ll be using for
now: we’ll switch to using flash messages (not to be confused with Adobe
Flash) in <a data-type="xref" href="ch09.xhtml#ch_cookies_and_sessions">Chapter 9</a>.</p>
</dd>
<dt>Redirect to the original location with a flash message</dt>
<dd>
<p> For small forms that are scattered throughout your site (like an email
sign-up, for example), the best user experience is not to interrupt the
user’s navigation flow. That is, provide a way to submit an email address
without leaving the page. One way to do this, of course, is Ajax, but if
you don’t want to use Ajax (or you want your fallback mechanism to provide
a good user experience), you can redirect back to the page the user was
originally on. The easiest way to do this is to use a hidden field in the
form that’s populated with the current URL. Since you want there to be
some feedback that the user’s submission was received, you can use flash
messages.</p>
</dd>
<dt>Redirect to a new location with a flash message</dt>
<dd>
<p> Large forms generally have their own page, and it doesn’t make sense to
stay on that page once you’ve submitted the form. In this situation, you
have to make an intelligent guess about where the user might want to go
next and redirect accordingly. For example, if you’re building an admin
interface, and you have a form to create a new vacation package, you might
reasonably expect your user to want to go to the admin page that lists all
vacation packages after submitting the form. However, you should still
employ a flash message to give the user feedback about the result of the
submission.</p>
</dd>
</dl>

<p>If you are using Ajax, I recommend a dedicated URL. It’s tempting to start Ajax <span class="keep-together">handlers</span> with a prefix (for example,
<em>/ajax/enter</em>), but I discourage this approach: it’s attaching
implementation details to a URL. Also, as we’ll see shortly, your Ajax
handler should handle regular browser submissions as a fail-safe.<a data-type="indexterm" data-startref="ix_ch-08-form_handling-asciidoc1" id="idm45053592717608"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Form Handling with Express"><div class="sect1" id="idm45053592716808">
<h1>Form Handling with Express</h1>

<p><a data-type="indexterm" data-primary="Express" data-secondary="form handling with" id="ix_ch-08-form_handling-asciidoc2"/><a data-type="indexterm" data-primary="form handling" data-secondary="Express for" id="ix_ch-08-form_handling-asciidoc3"/>If <a data-type="indexterm" data-primary="req.query object" id="idm45053592266184"/>you’re using <code>GET</code> for your form handling, your fields
 will be
available on the <code>req.query</code> object. For example, if you have an HTML
input field with a name attribute of <code>email</code>, its value will be passed to
the handler as <code>req.query.email</code>. There’s really not much more that needs
to be said about this approach; it’s just that simple.</p>

<p>If you’re using <code>POST</code> (which I recommend), you’ll have to link in
middleware to parse the URL-encoded body. <a data-type="indexterm" data-primary="body-parser middleware" id="idm45053592262472"/>First, install
the <code>body-parser</code> middleware (<code>npm install body-parser</code>);
then, link it in (<em>ch08/meadowlark.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">bodyParser</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'body-parser'</code><code class="p">)</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">bodyParser</code><code class="p">.</code><code class="nx">urlencoded</code><code class="p">({</code> <code class="nx">extended</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}))</code></pre>

<p>Once you’ve linked in <code>body-parser</code>, you’ll find that <code>req.body</code> now
becomes available for you, and that’s where all of your form fields will be
made available. Note that <code>req.body</code> doesn’t prevent you from using the
querystring. Let’s go ahead and add a form to Meadowlark Travel that lets
the user sign up for a mailing list. For demonstration’s sake, we’ll use
the querystring, a hidden field, and visible fields in
<em>/views/newsletter-signup.handlebars</em>:</p>

<pre data-type="programlisting" data-code-language="html"><code class="nt">&lt;h2&gt;</code>Sign up for our newsletter to receive news and specials!<code class="nt">&lt;/h2&gt;</code>
<code class="nt">&lt;form</code> <code class="na">class=</code><code class="s">"form-horizontal"</code> <code class="na">role=</code><code class="s">"form"</code>
    <code class="na">action=</code><code class="s">"/newsletter-signup/process?form=newsletter"</code> <code class="na">method=</code><code class="s">"POST"</code><code class="nt">&gt;</code>
  <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"hidden"</code> <code class="na">name=</code><code class="s">"_csrf"</code> <code class="na">value=</code><code class="s">"{{csrf}}"</code><code class="nt">&gt;</code>
  <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"form-group"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"fieldName"</code> <code class="na">class=</code><code class="s">"col-sm-2 control-label"</code><code class="nt">&gt;</code>Name<code class="nt">&lt;/label&gt;</code>
    <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"col-sm-4"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">class=</code><code class="s">"form-control"</code>
      <code class="na">id=</code><code class="s">"fieldName"</code> <code class="na">name=</code><code class="s">"name"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;/div&gt;</code>
  <code class="nt">&lt;/div&gt;</code>
  <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"form-group"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"fieldEmail"</code> <code class="na">class=</code><code class="s">"col-sm-2 control-label"</code><code class="nt">&gt;</code>Email<code class="nt">&lt;/label&gt;</code>
    <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"col-sm-4"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"email"</code> <code class="na">class=</code><code class="s">"form-control"</code> <code class="na">required</code>
          <code class="na">id=</code><code class="s">"fieldEmail"</code> <code class="na">name=</code><code class="s">"email"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;/div&gt;</code>
  <code class="nt">&lt;/div&gt;</code>
  <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"form-group"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"col-sm-offset-2 col-sm-4"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;button</code> <code class="na">type=</code><code class="s">"submit"</code> <code class="na">class=</code><code class="s">"btn btn-primary"</code><code class="nt">&gt;</code>Register<code class="nt">&lt;/button&gt;</code>
    <code class="nt">&lt;/div&gt;</code>
  <code class="nt">&lt;/div&gt;</code>
<code class="nt">&lt;/form&gt;</code></pre>

<p><a data-type="indexterm" data-primary="Bootstrap" id="idm45053592235064"/>Note we are using Bootstrap styles, as we will be throughout the rest of
the book. If you are unfamiliar with Bootstrap, you may
want to refer to the <a href="http://getbootstrap.com">Bootstrap documentation</a>.</p>

<p>We’ve already linked in our body parser, so now we need to add handlers for
our newsletter sign-up page, processing function, and thank-you page
(<em>ch08/lib/handlers.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">exports</code><code class="p">.</code><code class="nx">newsletterSignup</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// we will learn about CSRF later...for now, we just</code>
  <code class="c1">// provide a dummy value</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'newsletter-signup'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">csrf</code><code class="o">:</code> <code class="s1">'CSRF token goes here'</code> <code class="p">})</code>
<code class="p">}</code>
<code class="nx">exports</code><code class="p">.</code><code class="nx">newsletterSignupProcess</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Form (from querystring): '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">form</code><code class="p">)</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'CSRF token (from hidden form field): '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_csrf</code><code class="p">)</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Name (from visible form field): '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">name</code><code class="p">)</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Email (from visible form field): '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">email</code><code class="p">)</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="mi">303</code><code class="p">,</code> <code class="s1">'/newsletter-signup/thank-you'</code><code class="p">)</code>
<code class="p">}</code>
<code class="nx">exports</code><code class="p">.</code><code class="nx">newsletterSignupThankYou</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'newsletter-signup-thank-you'</code><code class="p">)</code></pre>

<p>(If you haven’t already, create a
<em>views/newsletter-signup-thank-you.handlebars</em> file.)</p>

<p>Lastly, we’ll link our handlers into our application (<em>ch08/meadowlark.js</em>
in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/newsletter-signup'</code><code class="p">,</code> <code class="nx">handlers</code><code class="p">.</code><code class="nx">newsletterSignup</code><code class="p">)</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/newsletter-signup/process'</code><code class="p">,</code> <code class="nx">handlers</code><code class="p">.</code><code class="nx">newsletterSignupProcess</code><code class="p">)</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/newsletter-signup/thank-you'</code><code class="p">,</code> <code class="nx">handlers</code><code class="p">.</code><code class="nx">newsletterSignupThankYou</code><code class="p">)</code></pre>

<p>That’s all there is to it. Note that in our handler, we’re redirecting to
a “thank you” view. We could render a view here, but if we did, the URL
field in the visitor’s browser would remain <em>/process</em>, which could be
confusing. Issuing a redirect solves that problem.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="301 redirect" id="idm45053591918136"/>It’s important that you use a 303 (or 302) redirect, not a 301
redirect in this instance. 301 redirects are “permanent,” meaning your
browser may cache the redirection destination. If you use a 301 redirect
and try to submit the form a second time, your browser may bypass the
<code>/process</code> handler altogether and go directly to <em>/thank-you</em> since it
correctly believes the redirect to be permanent. The 303 redirect, on the
other hand, tells your browser, “Yes, your request is valid, and you can
find your response here,” and does not cache the redirect destination.</p>
</div>

<p>With most frontend frameworks, it is more common to see form data sent
in JSON form with the <code>fetch</code> API, which we’ll be looking at next.
However, it’s still good to understand how browsers handle form submission
by default, as you will still find forms implemented this way.</p>

<p>Let’s turn our attention to form submission with <code>fetch</code>.<a data-type="indexterm" data-startref="ix_ch-08-form_handling-asciidoc3" id="idm45053591913816"/><a data-type="indexterm" data-startref="ix_ch-08-form_handling-asciidoc2" id="idm45053591913016"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Using Fetch to Send Form Data"><div class="sect1" id="idm45053592716216">
<h1>Using Fetch to Send Form Data</h1>

<p><a data-type="indexterm" data-primary="Fetch" data-secondary="sending form data with" id="ix_ch-08-form_handling-asciidoc4"/><a data-type="indexterm" data-primary="form handling" data-secondary="Fetch for sending form data" id="ix_ch-08-form_handling-asciidoc5"/>Using the <code>fetch</code> API to send JSON-encoded form data is a much more modern
approach that gives you more control over the client/server communication
and allows you to have fewer page refreshes.</p>

<p>Since we are not making round-trip requests to the server, we no longer
have to worry about redirects and multiple user URLs (we’ll still have a
separate URL for the form processing itself), and for that reason, we’ll
just consolidate our entire “newsletter signup experience” under a single
URL called <em>/newsletter</em>.</p>

<p>Let’s start with the frontend code. The contents of the HTML form itself
don’t need to be changed (the fields and layout are all the same), but we
don’t need to specify an <code>action</code> or <code>method</code>, and we’ll wrap our form in a
container <code>&lt;div&gt;</code> element that will make it easier to display our “thank
you” message:</p>

<pre data-type="programlisting" data-code-language="html"><code class="nt">&lt;div</code> <code class="na">id=</code><code class="s">"newsletterSignupFormContainer"</code><code class="nt">&gt;</code>
  <code class="nt">&lt;form</code> <code class="na">class=</code><code class="s">"form-horizontal role="</code><code class="na">form</code><code class="err">"</code> <code class="na">id=</code><code class="s">"newsletterSignupForm"</code><code class="nt">&gt;</code>
    <code class="c">&lt;!-- the rest of the form contents are the same... --&gt;</code>
  <code class="nt">&lt;/form&gt;</code>
<code class="nt">&lt;/div&gt;</code></pre>

<p>Then we’ll have a script that intercepts the form submit event and cancels
it (using <code>Event#preventDefault</code>) so we can handle the form processing
ourselves (<em>ch08/views/newsletter.handlebars</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="o">&lt;</code><code class="nx">script</code><code class="o">&gt;</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'newsletterSignupForm'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'submit'</code><code class="p">,</code> <code class="nx">evt</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="nx">evt</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">()</code>
      <code class="kr">const</code> <code class="nx">form</code> <code class="o">=</code> <code class="nx">evt</code><code class="p">.</code><code class="nx">target</code>
      <code class="kr">const</code> <code class="nx">body</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">({</code>
        <code class="nx">_csrf</code><code class="o">:</code> <code class="nx">form</code><code class="p">.</code><code class="nx">elements</code><code class="p">.</code><code class="nx">_csrf</code><code class="p">.</code><code class="nx">value</code><code class="p">,</code>
        <code class="nx">name</code><code class="o">:</code> <code class="nx">form</code><code class="p">.</code><code class="nx">elements</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">value</code><code class="p">,</code>
        <code class="nx">email</code><code class="o">:</code> <code class="nx">form</code><code class="p">.</code><code class="nx">elements</code><code class="p">.</code><code class="nx">email</code><code class="p">.</code><code class="nx">value</code><code class="p">,</code>
      <code class="p">})</code>
      <code class="kr">const</code> <code class="nx">headers</code> <code class="o">=</code> <code class="p">{</code> <code class="s1">'Content-Type'</code><code class="o">:</code> <code class="s1">'application/json'</code> <code class="p">}</code>
      <code class="kr">const</code> <code class="nx">container</code> <code class="o">=</code>
        <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'newsletterSignupFormContainer'</code><code class="p">)</code>
      <code class="nx">fetch</code><code class="p">(</code><code class="s1">'/api/newsletter-signup'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'post'</code><code class="p">,</code> <code class="nx">body</code><code class="p">,</code> <code class="nx">headers</code> <code class="p">})</code>
        <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">resp</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">if</code><code class="p">(</code><code class="nx">resp</code><code class="p">.</code><code class="nx">status</code> <code class="o">&lt;</code> <code class="mi">200</code> <code class="o">||</code> <code class="nx">resp</code><code class="p">.</code><code class="nx">status</code> <code class="o">&gt;=</code> <code class="mi">300</code><code class="p">)</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="sb">`Request failed with status </code><code class="si">${</code><code class="nx">resp</code><code class="p">.</code><code class="nx">status</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>
          <code class="k">return</code> <code class="nx">resp</code><code class="p">.</code><code class="nx">json</code><code class="p">()</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">json</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">container</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="s1">'&lt;b&gt;Thank you for signing up!&lt;/b&gt;'</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">err</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">container</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="sb">`&lt;b&gt;We're sorry, we had a problem `</code> <code class="o">+</code>
            <code class="sb">`signing you up. Please &lt;a href="/newsletter"&gt;try again&lt;/a&gt;`</code>
        <code class="p">})</code>
  <code class="p">})</code>
<code class="o">&lt;</code><code class="err">/script&gt;</code></pre>

<p>Now in our server file (<em>meadowlark.js</em>), make sure we’re linking in
middleware that can parse JSON bodies, before we specify our two endpoints:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">bodyParser</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>

<code class="c1">//...</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/newsletter'</code><code class="p">,</code> <code class="nx">handlers</code><code class="p">.</code><code class="nx">newsletter</code><code class="p">)</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/api/newsletter-signup'</code><code class="p">,</code> <code class="nx">handlers</code><code class="p">.</code><code class="nx">api</code><code class="p">.</code><code class="nx">newsletterSignup</code><code class="p">)</code></pre>

<p>Note that we’re putting our form-processing endpoint at a URL starting with
<code>api</code>; this is a common technique to distinguish between user (browser)
endpoints and API endpoints meant to be accessed with <code>fetch</code>.</p>

<p>Now we’ll add those endpoints to our <em>lib/handlers.js</em> file:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">exports</code><code class="p">.</code><code class="nx">newsletter</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// we will learn about CSRF later...for now, we just</code>
  <code class="c1">// provide a dummy value</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'newsletter'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">csrf</code><code class="o">:</code> <code class="s1">'CSRF token goes here'</code> <code class="p">})</code>
<code class="p">}</code>
<code class="nx">exports</code><code class="p">.</code><code class="nx">api</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">newsletterSignup</code><code class="o">:</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'CSRF token (from hidden form field): '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">_csrf</code><code class="p">)</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Name (from visible form field): '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">name</code><code class="p">)</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Email (from visible form field): '</code> <code class="o">+</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">email</code><code class="p">)</code>
    <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">({</code> <code class="nx">result</code><code class="o">:</code> <code class="s1">'success'</code> <code class="p">})</code>
  <code class="p">},</code>
<code class="p">}</code></pre>

<p>We can do whatever processing we need in the form processing handler;
usually we would be saving the data to the database.
 If there
are problems, we send back a JSON object with an <code>err</code> property (instead of
<code>result: <em>success</em></code>).</p>
<div data-type="tip"><h6>Tip</h6>
<p><a data-type="indexterm" data-primary="Ajax" data-secondary="JSON and" id="idm45053591395016"/>In this example, we’re assuming all Ajax requests are looking for JSON, but
there’s no requirement that Ajax must use JSON for communication (as a
matter of fact, Ajax used to be an acronym in which the “X” stood for XML).
This approach is very JavaScript-friendly, as JavaScript is adept in
handling JSON. If you’re making your Ajax endpoints generally available
or if you know your Ajax requests might be using something other than JSON,
you should return an appropriate response <em>exclusively</em> based on the
<code>Accepts</code> header, which we can conveniently access through the
<code>req.accepts</code> helper method. If you’re responding based only on the
<code>Accepts</code> header, you might want to also look at
<a href="http://bit.ly/33Syx92"><code>res.format</code></a>, which is a handy
convenience method that makes it easy to respond appropriately depending on
what the client expects. If you do that, you’ll have to
make sure to set the <code>dataType</code> or <code>accepts</code> property when making Ajax
requests with JavaScript.<a data-type="indexterm" data-startref="ix_ch-08-form_handling-asciidoc5" id="idm45053591389480"/><a data-type="indexterm" data-startref="ix_ch-08-form_handling-asciidoc4" id="idm45053591388808"/></p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="File Uploads"><div class="sect1" id="idm45053591911736">
<h1>File Uploads</h1>

<p><a data-type="indexterm" data-primary="file uploads" id="ix_ch-08-form_handling-asciidoc6"/><a data-type="indexterm" data-primary="form handling" data-secondary="file uploads" id="ix_ch-08-form_handling-asciidoc7"/><a data-type="indexterm" data-primary="multipart form handling" id="ix_ch-08-form_handling-asciidoc8"/><a data-type="indexterm" data-primary="uploading files" id="ix_ch-08-form_handling-asciidoc9"/>We’ve already mentioned that file uploads bring a raft of complications.
Fortunately, there are some great projects that help make file handling a
snap.</p>

<p>There are four popular and robust options for multipart form processing:
busboy, multiparty, formidable, and multer. <a data-type="indexterm" data-primary="multiparty middleware" id="ix_ch-08-form_handling-asciidoc10"/>I have used all four, and
they’re all good, but I feel multiparty is the best maintained, and so
we’ll use it here.</p>

<p>Let’s create a file upload form for a Meadowlark Travel vacation photo
contest (<em>views/contest/vacation-photo.handlebars</em>):</p>

<pre data-type="programlisting" data-code-language="js"><code class="o">&lt;</code><code class="nx">h2</code><code class="o">&gt;</code><code class="nx">Vacation</code> <code class="nx">Photo</code> <code class="nx">Contest</code><code class="o">&lt;</code><code class="err">/h2&gt;</code>

<code class="o">&lt;</code><code class="nx">form</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"form-horizontal"</code> <code class="nx">role</code><code class="o">=</code><code class="s2">"form"</code>
    <code class="nx">enctype</code><code class="o">=</code><code class="s2">"multipart/form-data"</code> <code class="nx">method</code><code class="o">=</code><code class="s2">"POST"</code>
    <code class="nx">action</code><code class="o">=</code><code class="s2">"/contest/vacation-photo/{{year}}/{{month}}"</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">input</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"hidden"</code> <code class="nx">name</code><code class="o">=</code><code class="s2">"_csrf"</code> <code class="nx">value</code><code class="o">=</code><code class="s2">"{{csrf}}"</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">div</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"form-group"</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">label</code> <code class="k">for</code><code class="o">=</code><code class="s2">"fieldName"</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"col-sm-2 control-label"</code><code class="o">&gt;</code><code class="nx">Name</code><code class="o">&lt;</code><code class="err">/label&gt;</code>
    <code class="o">&lt;</code><code class="nx">div</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"col-sm-4"</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">input</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"text"</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"form-control"</code>
      <code class="nx">id</code><code class="o">=</code><code class="s2">"fieldName"</code> <code class="nx">name</code><code class="o">=</code><code class="s2">"name"</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="err">/div&gt;</code>
  <code class="o">&lt;</code><code class="err">/div&gt;</code>
  <code class="o">&lt;</code><code class="nx">div</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"form-group"</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">label</code> <code class="k">for</code><code class="o">=</code><code class="s2">"fieldEmail"</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"col-sm-2 control-label"</code><code class="o">&gt;</code><code class="nx">Email</code><code class="o">&lt;</code><code class="err">/label&gt;</code>
    <code class="o">&lt;</code><code class="nx">div</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"col-sm-4"</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">input</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"email"</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"form-control"</code> <code class="nx">required</code>
          <code class="nx">id</code><code class="o">=</code><code class="s2">"fieldEmail"</code> <code class="nx">name</code><code class="o">=</code><code class="s2">"email"</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="err">/div&gt;</code>
  <code class="o">&lt;</code><code class="err">/div&gt;</code>
  <code class="o">&lt;</code><code class="nx">div</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"form-group"</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">label</code> <code class="k">for</code><code class="o">=</code><code class="s2">"fieldPhoto"</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"col-sm-2 control-label"</code><code class="o">&gt;</code><code class="nx">Vacation</code> <code class="nx">photo</code><code class="o">&lt;</code><code class="err">/label&gt;</code>
    <code class="o">&lt;</code><code class="nx">div</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"col-sm-4"</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">input</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"file"</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"form-control"</code> <code class="nx">required</code>  <code class="nx">accept</code><code class="o">=</code><code class="s2">"image/*"</code>
          <code class="nx">id</code><code class="o">=</code><code class="s2">"fieldPhoto"</code> <code class="nx">name</code><code class="o">=</code><code class="s2">"photo"</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="err">/div&gt;</code>
  <code class="o">&lt;</code><code class="err">/div&gt;</code>
  <code class="o">&lt;</code><code class="nx">div</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"form-group"</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">div</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"col-sm-offset-2 col-sm-4"</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"submit"</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"btn btn-primary"</code><code class="o">&gt;</code><code class="nx">Register</code><code class="o">&lt;</code><code class="err">/button&gt;</code>
    <code class="o">&lt;</code><code class="err">/div&gt;</code>
  <code class="o">&lt;</code><code class="err">/div&gt;</code>
<code class="o">&lt;</code><code class="err">/form&gt;</code></pre>

<p>Note that we must specify <code>enctype="multipart/form-data"</code> to enable file
uploads.
We’re also restricting the type of files that can be uploaded by using the
<code>accept</code> attribute (which is optional).</p>

<p>Now we need to create route handlers, but we have something of a dilemma.
We want to maintain our ability to easily test our route handlers, which
will be complicated by multipart form processing (in the same way we use
middleware to process other types of body encoding before we even get to
our handlers). Since we don’t want to test multipart form decoding
ourselves (we can assume this is done thoroughly by multiparty), we’ll keep
our handlers “pure” by passing them the already-processed information. Since
we don’t know what that looks like yet, we’ll start with the Express
plumbing in <em>meadowlark.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">multiparty</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'multiparty'</code><code class="p">)</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/contest/vacation-photo/:year/:month'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">form</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">multiparty</code><code class="p">.</code><code class="nx">Form</code><code class="p">()</code>
  <code class="nx">form</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">fields</code><code class="p">,</code> <code class="nx">files</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">(</code><code class="mi">500</code><code class="p">).</code><code class="nx">send</code><code class="p">({</code> <code class="nx">error</code><code class="o">:</code> <code class="nx">err</code><code class="p">.</code><code class="nx">message</code> <code class="p">})</code>
    <code class="nx">handlers</code><code class="p">.</code><code class="nx">vacationPhotoContestProcess</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">fields</code><code class="p">,</code> <code class="nx">files</code><code class="p">)</code>
  <code class="p">})</code>
<code class="p">})</code></pre>

<p>We’re using multiparty’s <code>parse</code> method to parse the request data into the
data fields and the files. This method will store the files in a temporary
directory on the server, and that information will be returned in the
<code>files</code> array passed back.</p>

<p>So now we have extra information to pass to our (testable) route handler:
the fields (which won’t be in <code>req.body</code> as in previous examples since
we’re using a different body parser) and information about the file(s)
that were collected. Now that we know what that looks like, we can
write our route handler:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">exports</code><code class="p">.</code><code class="nx">vacationPhotoContestProcess</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">fields</code><code class="p">,</code> <code class="nx">files</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'field data: '</code><code class="p">,</code> <code class="nx">fields</code><code class="p">)</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'files: '</code><code class="p">,</code> <code class="nx">files</code><code class="p">)</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="mi">303</code><code class="p">,</code> <code class="s1">'/contest/vacation-photo-thank-you'</code><code class="p">)</code>
<code class="p">}</code></pre>

<p>(Year and month are being specified as <em>route parameters</em>, which you’ll
learn about in <a data-type="xref" href="ch14.xhtml#ch_routing">Chapter 14</a>.) Go ahead and run this and examine the
console log. You’ll see that your form fields come across as you would
expect: as an object with properties corresponding to your field names.
The <code>files</code> object contains more data, but it’s relatively straightforward.
For each file uploaded, you’ll see there are properties for size, the path
it was uploaded to (usually a random name in a temporary directory), and
the original name of the file that the user uploaded (just the filename,
not the whole path, for security and privacy reasons).<a data-type="indexterm" data-startref="ix_ch-08-form_handling-asciidoc10" id="idm45053590868408"/></p>

<p>What you do with this file is now up to you: you can store it in a
database, copy it to a more permanent location, or upload it to a
cloud-based file storage system. Remember that if you’re relying on local
storage for saving files, your application won’t scale well, making this a
poor choice for cloud-based hosting. We will be revisiting this example in
<a data-type="xref" href="ch13.xhtml#ch_persistence">Chapter 13</a>.</p>








<section data-type="sect2" data-pdf-bookmark="File Uploads with Fetch"><div class="sect2" id="idm45053590865992">
<h2>File Uploads with Fetch</h2>

<p><a data-type="indexterm" data-primary="Fetch" data-secondary="file uploads with" id="idm45053590987832"/><a data-type="indexterm" data-primary="file uploads" data-secondary="with Fetch" id="idm45053590986856"/>Happily, using <code>fetch</code> for file uploads is nearly identical to letting the
browser handle it. The hard work of file uploads is really in the
encoding, which is being handled for us with middleware.</p>

<p>Consider this JavaScript to send our form contents using <code>fetch</code>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="o">&lt;</code><code class="nx">script</code><code class="o">&gt;</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'vacationPhotoContestForm'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'submit'</code><code class="p">,</code> <code class="nx">evt</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="nx">evt</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">()</code>
      <code class="kr">const</code> <code class="nx">body</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">FormData</code><code class="p">(</code><code class="nx">evt</code><code class="p">.</code><code class="nx">target</code><code class="p">)</code>
      <code class="kr">const</code> <code class="nx">container</code> <code class="o">=</code>
        <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'vacationPhotoContestFormContainer'</code><code class="p">)</code>
      <code class="kr">const</code> <code class="nx">url</code> <code class="o">=</code> <code class="s1">'/api/vacation-photo-contest/{{year}}/{{month}}'</code>
      <code class="nx">fetch</code><code class="p">(</code><code class="nx">url</code><code class="p">,</code> <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'post'</code><code class="p">,</code> <code class="nx">body</code> <code class="p">})</code>
        <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">resp</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">if</code><code class="p">(</code><code class="nx">resp</code><code class="p">.</code><code class="nx">status</code> <code class="o">&lt;</code> <code class="mi">200</code> <code class="o">||</code> <code class="nx">resp</code><code class="p">.</code><code class="nx">status</code> <code class="o">&gt;=</code> <code class="mi">300</code><code class="p">)</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="sb">`Request failed with status </code><code class="si">${</code><code class="nx">resp</code><code class="p">.</code><code class="nx">status</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>
          <code class="k">return</code> <code class="nx">resp</code><code class="p">.</code><code class="nx">json</code><code class="p">()</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">json</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">container</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="s1">'&lt;b&gt;Thank you for submitting your photo!&lt;/b&gt;'</code>
        <code class="p">})</code>
        <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">err</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">container</code><code class="p">.</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="sb">`&lt;b&gt;We're sorry, we had a problem processing `</code> <code class="o">+</code>
            <code class="sb">`your submission.  Please &lt;a href="/newsletter"&gt;try again&lt;/a&gt;`</code>
        <code class="p">})</code>
    <code class="p">})</code>
<code class="o">&lt;</code><code class="err">/script&gt;</code></pre>

<p><a data-type="indexterm" data-primary="FormData object" id="idm45053590981992"/>The important detail to note here is that we convert the form element to a
<a href="https://mzl.la/2CErVzb"><code>FormData</code></a>
object, which <code>fetch</code> can accept directly as the request body. That’s all
there is to it! Because the encoding is exactly the same as it was when we
let the browser handle it, our handler is almost exactly the same. We just
want to return a JSON response instead of a redirect:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">exports</code><code class="p">.</code><code class="nx">api</code><code class="p">.</code><code class="nx">vacationPhotoContest</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">fields</code><code class="p">,</code> <code class="nx">files</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'field data: '</code><code class="p">,</code> <code class="nx">fields</code><code class="p">)</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'files: '</code><code class="p">,</code> <code class="nx">files</code><code class="p">)</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">({</code> <code class="nx">result</code><code class="o">:</code> <code class="s1">'success'</code> <code class="p">})</code>
<code class="p">}</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Improving File Upload UI"><div class="sect1" id="idm45053591387528">
<h1>Improving File Upload UI</h1>

<p><a data-type="indexterm" data-primary="file uploads" data-secondary="improving file upload UI" id="idm45053590686280"/><a data-type="indexterm" data-primary="form handling" data-secondary="improving file upload UI" id="idm45053590685368"/><a data-type="indexterm" data-primary="UI (user interface), for file upload" id="idm45053590684456"/><a data-type="indexterm" data-primary="user interface (UI), for file upload" id="idm45053590683816"/>The browser’s built-in <code>&lt;input&gt;</code> control for file uploads is, shall we say,
a bit lacking from a UI perspective. You’ve probably seen drag-and-drop
interfaces and file upload buttons that are styled more attractively.</p>

<p>The good news is that the techniques you’ve learned here will apply to
almost all of the popular “fancy” file upload components. At the end of
the day, most of them are putting a pretty face on the same form upload
mechanism.</p>

<p>Some of the most popular file upload frontends are as follows:</p>

<ul>
<li>
<p><a href="http://bit.ly/2Qbcd6I">jQuery File Upload</a></p>
</li>
<li>
<p><a href="http://bit.ly/2rEFWeb">Uppy</a> (this one has the benefit of
offering support for many popular upload targets)</p>
</li>
<li>
<p><a href="http://bit.ly/2X5fS7F">file-upload-with-preview</a>
(this one gives you full control; you have access to an array of file
objects that you can use to construct a <code>FormData</code> object to use with
<code>fetch</code>)<a data-type="indexterm" data-startref="ix_ch-08-form_handling-asciidoc9" id="idm45053590676040"/><a data-type="indexterm" data-startref="ix_ch-08-form_handling-asciidoc8" id="idm45053590675240"/><a data-type="indexterm" data-startref="ix_ch-08-form_handling-asciidoc7" id="idm45053590674552"/><a data-type="indexterm" data-startref="ix_ch-08-form_handling-asciidoc6" id="idm45053590673864"/></p>
</li>
</ul>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="idm45053590672792">
<h1>Conclusion</h1>

<p>In this chapter, you learned the various techniques to use for
processing forms. We explored the traditional way forms are handled by
browsers (letting the browser issue a <code>POST</code> request to the server with the
form contents and rendering the response from the server, usually a
redirect) as well as the increasingly ubiquitous approach of preventing the
browser from submitting the form and handling it ourselves with <code>fetch</code>.</p>

<p class="pagebreak-before">We learned about the common ways forms are encoded:</p>
<dl>
<dt><code>application/x-www-form-urlencoded</code></dt>
<dd>
<p>Default and easy-to-use encoding typically associated with traditional form processing</p>
</dd>
<dt><code>application/json</code></dt>
<dd>
<p>Common for (nonfile) data sent with <code>fetch</code></p>
</dd>
<dt><code>multipart/form-data</code></dt>
<dd>
<p>The encoding to use when you need to transfer files</p>
</dd>
</dl>

<p>Now that we’ve covered how to get user data into our server, let’s turn our
attention to <em>cookies</em> and <em>sessions</em>, which also help synchronize the
server and the client.<a data-type="indexterm" data-startref="ix_ch-08-form_handling-asciidoc0" id="idm45053590662840"/></p>
</div></section>







</div></section></div>



  </body></html>