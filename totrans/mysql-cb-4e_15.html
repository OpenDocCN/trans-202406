<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 15. Generating and Using Sequences"><div class="chapter" id="nch-sequences"><h1><span class="label">Chapter 15. </span>Generating and Using Sequences</h1><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45820347129808"><h5>A note for Early Release readers</h5><p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p></div></aside><section data-type="sect1" data-pdf-bookmark="15.0 Introduction"><div class="sect1" id="nch-sequences-seq-intro"><h1>15.0 Introduction</h1><p>A sequence is a set of integers (1, 2, 3, …) generated in order on
    demand. Sequences see frequent use in databases because many applications
    require each row in a table to contain a unique value, and sequences
    provide an easy way to generate them. This chapter describes how to use
    sequences in MySQL in the following five ways:</p><dl><dt>Using <code>AUTO_INCREMENT</code>
        columns</dt><dd><p>The <code>AUTO_INCREMENT</code> column
          is MySQL’s mechanism for generating a sequence over a set of
          rows. Each time you create a row in a table that contains an
          <code>AUTO_INCREMENT</code> column, MySQL
          automatically generates the next value in the sequence as the
          column’s value. This value serves as a unique identifier, making
          sequences an easy way to create items such as customer ID numbers,
          shipping package waybill numbers, invoice or purchase order numbers,
          bug report IDs, ticket numbers, or product serial numbers.</p></dd><dt>Retrieving sequence values</dt><dd><p>For many applications, it’s not enough just to create sequence values. It’s
          also necessary to determine the sequence value for a just-inserted
          row. A web application may need to redisplay to a user the contents
          of a row created from the contents of a form just submitted by the
          user. The value may need to be retrieved so it can be stored in rows
          of a related table.</p></dd><dt>Resequencing techniques</dt><dd><p>It’s possible to renumber a sequence that has holes in it due to row
          deletions, reuse deleted values at the top of a sequence, or add a
          sequence column to a table that has none.</p></dd><dt>Managing multiple simultaneous sequences</dt><dd><p>Special care is necessary when you need to keep track of multiple sequence
          values, such as when you create rows in multiple tables that each
          have an <code>AUTO_INCREMENT</code>
          column.</p></dd><dt>Using single-row sequence generators</dt><dd><p>Sequences can be used as counters. For example, to count votes in a
          poll, you might increment a counter each time a candidate receives a
          vote. The counts for a given candidate form a sequence, but because
          the count itself is the only value of interest, there is no need to
          generate a new row to record each vote. MySQL provides a solution
          for this problem using a mechanism that enables a sequence to be
          easily generated within a single table row over time. To store
          multiple counters in the table, use a column that identifies each
          counter uniquely. The same mechanism also enables creation of
          sequences that increase by values other than one or by nonuniform
          values.</p></dd></dl><p>The engines for most database systems provide sequence-generation
    capabilities, although the implementations tend to be engine-dependent.
    That’s true for MySQL as well, so the material in this section is almost
    completely MySQL-specific, even at the SQL level. In other words, the SQL
    for generating sequences is itself nonportable, even if you use an API
    such as DBI or JDBC that provides an abstraction layer. Abstract
    interfaces may help you process SQL statements portably, but they don’t
    make nonportable SQL portable.</p><p>Scripts related to the examples shown in this chapter are located in
    the <em class="filename">sequences</em> directory of the
    <code>recipes</code> distribution. For scripts that
    create tables used here, look in the <em class="filename">tables</em> directory.</p></div></section><section data-type="sect1" data-pdf-bookmark="15.1 Generating a Sequence with AUTO_INCREMENT Columns"><div class="sect1" id="nch-sequences-seq-create-col"><h1>15.1 Generating a Sequence with AUTO_INCREMENT Columns</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820347087760"><h2>Problem</h2><p>Your table includes a column that should contain only unique IDs, and you need to insert values into this column, insuring they are part of the sequence.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820347086784"><h2>Solution</h2><p>Use an <code>AUTO_INCREMENT</code> column to
      generate a sequence.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820347085392"><h2>Discussion</h2><p>This recipe provides the essential background on using <code>AUTO_INCREMENT</code> columns, beginning with an
      example that demonstrates the sequence-generation mechanism. The
      example centers around a bug-collection scenario: your
      eight-year-old son Junior is assigned the task of collecting insects for
      a class project at school. For each insect, Junior is to record its name
      (<q>ant,</q> <q>bee,</q> and so forth), and its date and
      location of collection. You have expounded the benefits of MySQL for
      record-keeping to Junior since his early days, so upon your arrival home
      from work that day, he immediately announces the necessity of completing
      this project and then, looking you straight in the eye, declares that
      it’s clearly a task for which MySQL is well-suited. Who are you to
      argue? So the two of you get to work. Junior already collected some
      specimens after school while waiting for you to come home and has
      recorded the following information in his notebook:</p><table><thead><tr><th>Name</th><th>Date</th><th>Origin</th></tr></thead><tbody><tr><td>millipede</td><td>2014-09-10</td><td>driveway</td></tr><tr><td>housefly</td><td>2014-09-10</td><td>kitchen</td></tr><tr><td>grasshopper</td><td>2014-09-10</td><td>front yard</td></tr><tr><td>stink bug</td><td>2014-09-10</td><td>front yard</td></tr><tr><td>cabbage butterfly</td><td>2014-09-10</td><td>garden</td></tr><tr><td>ant</td><td>2014-09-10</td><td>back yard</td></tr><tr><td>ant</td><td>2014-09-10</td><td>back yard</td></tr><tr><td>termite</td><td>2014-09-10</td><td>kitchen woodwork</td></tr></tbody></table><p>Looking over Junior’s notes, you’re pleased to see that even at
      his tender age, he has learned to write dates in ISO format. However,
      you also notice that he’s collected a millipede and a termite, neither
      of which actually are insects. You decide to let this pass for the
      moment; Junior forgot to bring home the written instructions for the
      project, so at this point it’s unclear whether these specimens are
      acceptable. (You also note with some alarm Junior’s discovery of
      termites in the house and make a mental note to call the
      exterminator.)</p><p>As you consider how to create a table to store this information,
      it’s apparent that you need at least <code>name</code>, <code>date</code>,
      and <code>origin</code> columns corresponding to
      the types of information that Junior is required to record:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">insect</code>
<code class="p">(</code>
  <code class="n">name</code>    <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>   <code class="o">#</code> <code class="k">type</code> <code class="k">of</code> <code class="n">insect</code>
  <code class="nb">date</code>    <code class="nb">DATE</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>          <code class="o">#</code> <code class="nb">date</code> <code class="n">collected</code>
  <code class="n">origin</code>  <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code>    <code class="o">#</code> <code class="k">where</code> <code class="n">collected</code>
<code class="p">);</code></pre><p>However, those columns are insufficient to make the table easy to
      use. Note that the records collected thus far are not unique; both ants
      were collected at the same time and place. If you put the information
      into an <code>insect</code> table that has the
      structure just shown, neither ant row can be referred to individually
      because there’s nothing to distinguish one from another. Unique IDs
      would be helpful to make the rows distinct and to provide values that
      make each row easy to refer to. An <code>AUTO_INCREMENT</code> column is good for this
      purpose, so a better <code>insect</code> table has
      a structure like this:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">insect</code>
<code class="p">(</code>
  <code class="n">id</code>      <code class="nb">INT</code> <code class="n">UNSIGNED</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="n">AUTO_INCREMENT</code><code class="p">,</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="n">id</code><code class="p">),</code>
  <code class="n">name</code>    <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>   <code class="o">#</code> <code class="k">type</code> <code class="k">of</code> <code class="n">insect</code>
  <code class="nb">date</code>    <code class="nb">DATE</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>          <code class="o">#</code> <code class="nb">date</code> <code class="n">collected</code>
  <code class="n">origin</code>  <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code>    <code class="o">#</code> <code class="k">where</code> <code class="n">collected</code>
<code class="p">);</code></pre><p>Go ahead and create the <code>insect</code>
      table using this second <code>CREATE</code> <code>TABLE</code> statement. (<a data-type="xref" href="#nch-sequences-seq-type">Recipe 15.2</a> discusses the particulars of the
      <code>id</code> column definition.)</p><p>Now that you have an <code>AUTO_INCREMENT</code> column, use it to generate new
      sequence values. One of the useful properties of an <code>AUTO_INCREMENT</code> column is that you need not
      assign its values yourself: MySQL does so for you. There are two ways to
      generate new <code>AUTO_INCREMENT</code> values in
      the <code>id</code> column. One is to explicitly
      set the <code>id</code> column to <code>NULL</code>. The following statement inserts the first four of Junior’s specimens
      into the <code>insect</code> table that
      way:</p><pre data-type="programlisting">mysql&gt; <strong><code>INSERT INTO insect (id,name,date,origin) VALUES</code></strong>
    -&gt; <strong><code>(NULL,'housefly','2014-09-10','kitchen'),</code></strong>
    -&gt; <strong><code>(NULL,'millipede','2014-09-10','driveway'),</code></strong>
    -&gt; <strong><code>(NULL,'grasshopper','2014-09-10','front yard'),</code></strong>
    -&gt; <strong><code>(NULL,'stink bug','2014-09-10','front yard');</code></strong></pre><p>Alternatively, omit the <code>id</code>
      column from the <code>INSERT</code> statement
      entirely. MySQL permits creating rows without explicitly
      specifying values for columns that have a default value. MySQL assigns
      each missing column its default value, and the default for an <code>AUTO_INCREMENT</code> column is its next sequence
      number. Thus, this statement adds Junior’s other four specimens to the
      <code>insect</code> table and generates sequence
      values without naming the <code>id</code> column
      at all:</p><pre data-type="programlisting">mysql&gt; <strong><code>INSERT INTO insect (name,date,origin) VALUES</code></strong>
    -&gt; <strong><code>('cabbage butterfly','2014-09-10','garden'),</code></strong>
    -&gt; <strong><code>('ant','2014-09-10','back yard'),</code></strong>
    -&gt; <strong><code>('ant','2014-09-10','back yard'),</code></strong>
    -&gt; <strong><code>('termite','2014-09-10','kitchen woodwork');</code></strong></pre><p>Whichever method you use, MySQL determines the sequence number for
      each row and assigns it to the <code>id</code>
      column, as you can verify:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * FROM insect ORDER BY id;</code></strong>
+----+-------------------+------------+------------------+
| id | name              | date       | origin           |
+----+-------------------+------------+------------------+
|  1 | housefly          | 2014-09-10 | kitchen          |
|  2 | millipede         | 2014-09-10 | driveway         |
|  3 | grasshopper       | 2014-09-10 | front yard       |
|  4 | stink bug         | 2014-09-10 | front yard       |
|  5 | cabbage butterfly | 2014-09-10 | garden           |
|  6 | ant               | 2014-09-10 | back yard        |
|  7 | ant               | 2014-09-10 | back yard        |
|  8 | termite           | 2014-09-10 | kitchen woodwork |
+----+-------------------+------------+------------------+</pre><p>As Junior collects more specimens, add more rows to the table and
      they’ll be assigned the next values in the sequence (9, 10, …).</p><p>The concept underlying <code>AUTO_INCREMENT</code> columns is simple enough in
      principle: each time you create a new row, MySQL generates the next
      number in the sequence and assigns it to the row. But there are certain
      subtleties to know about, as well as differences in how different
      storage engines handle <code>AUTO_INCREMENT</code>
      sequences. Awareness of these issues enables you to use sequences more
      effectively and avoid surprises. For example, if you explicitly set the
      <code>id</code> column to a non-<code>NULL</code> value, one of two things happens:</p><ul><li><p>If the value is already present in the table, an error occurs
          if the column cannot contain duplicates. For the <code>insect</code> table, the <code>id</code> column is a <code>PRIMARY</code> <code>KEY</code>, which prohibits duplicates:</p><pre data-type="programlisting">mysql&gt; <strong><code>INSERT INTO insect (id,name,date,origin) VALUES</code></strong>
    -&gt; <strong><code>(3,'cricket','2014-09-11','basement');</code></strong>
ERROR 1062 (23000): Duplicate entry '3' for key 'PRIMARY'</pre></li><li><p>If the value is not present in the table, MySQL inserts the
          row using that value. In addition, if the value is larger than the
          current sequence counter, the table’s counter is reset to the value
          plus one. The <code>insect</code> table at
          this point has sequence values 1 through 8. If you insert a new row
          with the <code>id</code> column set to 20,
          that becomes the new maximum value. Subsequent inserts that
          automatically generate <code>id</code> values
          will begin at 21. The values 9 through 19 become unused, resulting
          in a gap in the sequence.</p></li></ul><p>The next recipe looks in more detail at how to define <code>AUTO_INCREMENT</code> columns and how they behave.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.2 Choosing the Data Type for a Sequence Column"><div class="sect1" id="nch-sequences-seq-type"><h1>15.2 Choosing the Data Type for a Sequence Column</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820346889264"><h2>Problem</h2><p>You want to choose correct data type to define a sequence column.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820346888288"><h2>Solution</h2><p>Consider how many unique values your sequence should hold and choose the data type accordingly.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820346887232"><h2>Discussion</h2><p>You should follow certain principles when creating <code>AUTO_INCREMENT</code>
      columns. As an illustration, consider how <a data-type="xref" href="#nch-sequences-seq-create-col">Recipe 15.1</a> declared the <code>id</code> column in the <code>insect</code> table:</p><pre data-type="programlisting">id INT UNSIGNED NOT NULL AUTO_INCREMENT,
PRIMARY KEY (id)</pre><p>The <code>AUTO_INCREMENT</code> keyword
      informs MySQL that it should generate successive sequence numbers for
      the column’s values, but the other information is important, too:</p><ul><li><p><code>INT</code> is the column’s base
          data type. You need not necessarily use <code>INT</code>, but the column should be one of the
          integer types: <code>TINYINT</code>,
          <code>SMALLINT</code>, <code>MEDIUMINT</code>, <code>INT</code>, or <code>BIGINT</code>.</p></li><li><p><code>UNSIGNED</code> prohibits
          negative column values. This is not a required
          attribute for <code>AUTO_INCREMENT</code>
          columns, but sequences consist only of positive integers (normally
          beginning at 1), so there is no reason to permit negative values.
          Furthermore, <em>not</em> declaring the column to be
          <code>UNSIGNED</code> cuts the range of your
          sequence in half. For example, <code>TINYINT</code> has a range of –128 to 127.
          Because sequences include only positive values, the effective range
          of a <code>TINYINT</code> sequence is 1 to
          127. <code>TINYINT</code> <code>UNSIGNED</code> has a range of 0 to 255, which
          increases the upper end of the sequence to 255. The specific integer
          type determines the maximum sequence value. The following table
          shows the maximum unsigned value of each type; use this information
          to choose a type big enough to hold the largest value you’ll
          need:</p><table><thead><tr><th>Data type</th><th>Maximum unsigned value</th></tr></thead><tbody><tr><td><code>TINYINT </code></td><td>255</td></tr><tr><td><code>SMALLINT </code></td><td>65,535</td></tr><tr><td><code>MEDIUMINT </code></td><td>16,777,215</td></tr><tr><td><code>INT </code></td><td>4,294,967,295</td></tr><tr><td><code>BIGINT </code></td><td>18,446,744,073,709,551,615</td></tr></tbody></table><p>Sometimes people omit <code>UNSIGNED</code> so that they can create rows that
          contain negative numbers in the sequence column (using –1 to signify
          <q>has no ID,</q> for example.) This is a bad idea. MySQL
          makes no guarantees about how negative numbers will be treated in an
          <code>AUTO_INCREMENT</code> column, so by
          using them you’re playing with fire. For example, if you resequence
          the column, all your negative values get turned into positive
          sequence numbers.</p></li><li><p><code>AUTO_INCREMENT</code> columns
          cannot contain <code>NULL</code>
          values, so <code>id</code> is declared as
          <code>NOT</code> <code>NULL</code>. (It’s true that you can specify
          <code>NULL</code> as the column value when you
          insert a new row, but for an <code>AUTO_INCREMENT</code> column, that really means
          <q>generate the next sequence value.</q>) MySQL
          automatically defines <code>AUTO_INCREMENT</code> columns as <code>NOT</code> <code>NULL</code> if you forget.</p></li><li><p><code>AUTO_INCREMENT</code> columns must
          be indexed. Normally, because a sequence column exists to provide
          unique identifiers, you use a <code>PRIMARY</code>
          <code>KEY</code> or <code>UNIQUE</code> index to enforce uniqueness. Tables
          can have only one <code>PRIMARY</code>
          <code>KEY</code>, so if the table already has
          some other <code>PRIMARY</code> <code>KEY</code> column, you can declare an <code>AUTO_INCREMENT</code> column to have a <code>UNIQUE</code> index instead:</p><pre data-type="programlisting">id INT UNSIGNED NOT NULL AUTO_INCREMENT,
UNIQUE (id)</pre></li></ul><p>When you create a table that contains an <code>AUTO_INCREMENT</code> column, it’s also important to
      consider which storage engine to use (InnoDB, MyISAM, and so forth). The engine affects
      behaviors such as reuse of values deleted from the top of the sequence (see <a data-type="xref" href="#nch-sequences-seq-delete">Recipe 15.3</a>).</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.3 Deleting Rows Without Changing a Sequence"><div class="sect1" id="nch-sequences-seq-delete"><h1>15.3 Deleting Rows Without Changing a Sequence</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820346853968"><h2>Problem</h2><p>You want to delete few rows from the table that contains an <code>AUTO_INCREMENT</code>
      column.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820346852496"><h2>Solution</h2><p>Use regular <code>DELETE</code> statement. MySQL would not change generated sequence numbers for the existing rows.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820346851072"><h2>Discussion</h2><p>We have thus far considered how MySQL generates sequence values in
      an <code>AUTO_INCREMENT</code> column under
      circumstances where rows are only added to a table. But it’s unrealistic
      to assume that rows will never be deleted. What happens to the sequence
      then?</p><p>Refer again to Junior’s bug-collection project, for which you
      currently have an <code>insect</code> table that
      looks like this:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * FROM insect ORDER BY id;</code></strong>
+----+-------------------+------------+------------------+
| id | name              | date       | origin           |
+----+-------------------+------------+------------------+
|  1 | housefly          | 2014-09-10 | kitchen          |
|  2 | millipede         | 2014-09-10 | driveway         |
|  3 | grasshopper       | 2014-09-10 | front yard       |
|  4 | stink bug         | 2014-09-10 | front yard       |
|  5 | cabbage butterfly | 2014-09-10 | garden           |
|  6 | ant               | 2014-09-10 | back yard        |
|  7 | ant               | 2014-09-10 | back yard        |
|  8 | termite           | 2014-09-10 | kitchen woodwork |
+----+-------------------+------------+------------------+</pre><p>That’s about to change because after Junior remembers to bring
      home the written instructions for the project, you read through them and
      discover two things that affect the table contents:</p><ul><li><p>Specimens should include only insects, not insect-like
          creatures such as millipedes and termites.</p></li><li><p>The purpose of the project is to collect as many
          <em>different</em> specimens as possible, not just as
          <em>many</em> specimens as possible. This means that
          only one ant row is permitted.</p></li></ul><p>These instructions dictate that a few rows be removed from
      table—specifically those with <code>id</code>
      values 2 (millipede), 8 (termite), and 7 (duplicate ant). Thus, despite
      Junior’s evident disappointment at the reduction in the size of his
      collection, you instruct him to remove those rows by issuing a <code>DELETE</code>
      statement:</p><pre data-type="programlisting">mysql&gt; <strong><code>DELETE FROM insect WHERE id IN (2,8,7);</code></strong></pre><p>This statement illustrates why it’s useful to have unique ID
      values: they enable you to specify any row unambiguously. The ant rows
      are identical except for the <code>id</code>
      value. Without that column in the table, it would be more difficult to
      delete just one of them (though not impossible; see <a data-type="xref" href="ch18.xhtml#nch-dups-dups-elim-table">Recipe 18.5</a>).</p><p>After removing the unsuitable rows, the table has these
      remaining:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * FROM insect ORDER BY id;</code></strong>
+----+-------------------+------------+------------+
| id | name              | date       | origin     |
+----+-------------------+------------+------------+
|  1 | housefly          | 2014-09-10 | kitchen    |
|  3 | grasshopper       | 2014-09-10 | front yard |
|  4 | stink bug         | 2014-09-10 | front yard |
|  5 | cabbage butterfly | 2014-09-10 | garden     |
|  6 | ant               | 2014-09-10 | back yard  |
+----+-------------------+------------+------------+</pre><p>The <code>id</code> column sequence now has
      a hole (row 2 is missing) and the values 7 and 8 at the top of the
      sequence are no longer present. How do these deletions affect future
      insert operations? What sequence number will the next new row
      get?</p><p>Removing row 2 creates a gap in the middle of the sequence. This
      has no effect on subsequent inserts, because MySQL makes no attempt to
      fill in holes in a sequence. On the other hand, deleting rows 7 and 8
      removes values at the top of the sequence. For InnoDB or MyISAM tables, values are not reused. The next
      sequence number is the smallest positive integer that has not previously
      been used. (For a sequence that stands at 8, the next row gets a value
      of 9 even if you delete rows 7 and 8 first.) If you require strictly
      monotonic sequences, you can use one of these storage engines. For other
      storage engines, values removed at the top of the sequence may or may
      not be reused. Check the properties of the engine before using
      it.</p><p>If a table uses an engine that differs in value-reuse behavior
      from the behavior you require, use <code>ALTER</code> <code>TABLE</code> to change the table to a more
      appropriate engine. For example, to change a table to use InnoDB (to
      prevent sequence values from being reused after rows are deleted), do
      this:</p><pre data-type="programlisting" data-code-language="sql">ALTER TABLE <em><code>tbl_name</code></em> ENGINE = InnoDB;</pre><p>If you don’t know what engine a table uses, consult <code>INFORMATION_SCHEMA</code> or use <code>SHOW</code> <code>TABLE</code> <code>STATUS</code> or <code>SHOW</code> <code>CREATE</code>
      <code>TABLE</code> to find out. For example, the
      following statement indicates that <code>insect</code> is an InnoDB table:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT ENGINE FROM INFORMATION_SCHEMA.TABLES</code></strong>
    -&gt; <strong><code>WHERE TABLE_SCHEMA = 'cookbook' AND TABLE_NAME = 'insect';</code></strong>
+--------+
| ENGINE |
+--------+
| InnoDB |
+--------+</pre><p>To empty a table and reset the sequence counter (even for engines
      that normally do not reuse values), use <code>TRUNCATE</code> <code>TABLE</code>:</p><pre data-type="programlisting" data-code-language="sql">TRUNCATE TABLE <em><code>tbl_name</code></em>;</pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.4 Retrieving Sequence Values"><div class="sect1" id="nch-sequences-seq-retrieve"><h1>15.4 Retrieving Sequence Values</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820346826976"><h2>Problem</h2><p>After creating a row that includes a new sequence number, you want to know what that number
      is.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820346825920"><h2>Solution</h2><p>Invoke the <code>LAST_INSERT_ID()</code>
      function. If you’re writing a program, your MySQL API may provide a
      way to get the value directly without issuing an SQL statement.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820346824528"><h2>Discussion</h2><p>It’s common for applications to need to know the <code>AUTO_INCREMENT</code>
      value of a newly created row. For example, if you write a web-based
      frontend for entering rows into Junior’s <code>insect</code> table, you might have the application
      display each new row nicely formatted in a new page immediately after
      you hit the Submit button. To do this, you must know the new <code>id</code> value so that you can retrieve the proper
      row. Another situation in which the <code>AUTO_INCREMENT</code> value is needed occurs when you
      use multiple tables: after inserting a row in a main table, you need
      its ID to create rows in other related tables that refer to the
      row in the main table. (<a data-type="xref" href="#nch-sequences-seq-relate">Recipe 15.11</a> shows how to do
      this.)</p><p>When you generate a new <code>AUTO_INCREMENT</code> value, one way to get the value
      from the server is to execute a statement that invokes the <code>LAST_INSERT_ID()</code> function. In addition, many
      MySQL APIs provide a client-side mechanism for making the value
      available without issuing another statement. This recipe discusses both
      methods and compares their characteristics.</p><section data-type="sect3" data-pdf-bookmark="Using LAST_INSERT_ID() to obtain AUTO_INCREMENT values"><div class="sect3" id="idm45820346819136"><h3>Using LAST_INSERT_ID() to obtain AUTO_INCREMENT values</h3><p>The obvious (but incorrect) way to determine a new row’s
        <code>AUTO_INCREMENT</code> value uses the fact
        that when MySQL generates the value, it becomes the largest sequence
        number in the column. Thus, you might try using the <code>MAX()</code> function to retrieve it:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="k">MAX</code><code class="p">(</code><code class="n">id</code><code class="p">)</code> <code class="k">FROM</code> <code class="n">insect</code><code class="p">;</code></pre><p>This is unreliable; if another client inserts a row before you
        issue the <code>SELECT</code> statement,
        <code>MAX(id)</code> returns that client’s ID,
        not yours. It’s possible to solve this problem by grouping the <code>INSERT</code>
        and <code>SELECT</code> statements as a
        transaction or locking the table, but MySQL provides a simpler way to
        obtain the proper value: invoke the <code>LAST_INSERT_ID()</code> function. It returns the
        most recent <code>AUTO_INCREMENT</code> value
        generated within your session, regardless of what other clients are
        doing. For example, to insert a row into the <code>insect</code> table and retrieve its <code>id</code> value, do this:</p><pre data-type="programlisting">mysql&gt; <strong><code>INSERT INTO insect (name,date,origin)</code></strong>
    -&gt; <strong><code>VALUES('cricket','2014-09-11','basement');</code></strong>
mysql&gt; <strong><code>SELECT LAST_INSERT_ID();</code></strong>
+------------------+
| LAST_INSERT_ID() |
+------------------+
|                9 |
+------------------+</pre><p>Or you can use the new value to retrieve the entire row, without
        even knowing what <span class="keep-together">it is:</span></p><pre data-type="programlisting">mysql&gt; <strong><code>INSERT INTO insect (name,date,origin)</code></strong>
    -&gt; <strong><code>VALUES('moth','2014-09-14','windowsill');</code></strong>
mysql&gt; <strong><code>SELECT * FROM insect WHERE id = LAST_INSERT_ID();</code></strong>
+----+------+------------+------------+
| id | name | date       | origin     |
+----+------+------------+------------+
| 10 | moth | 2014-09-14 | windowsill |
+----+------+------------+------------+</pre><p>The server maintains the value returned by <code>LAST_INSERT_ID()</code> on a session-specific
        basis. This property is by design, and it’s important because it
        prevents clients from interfering with each other. When you generate
        an <code>AUTO_INCREMENT</code> value, <code>LAST_INSERT_ID()</code> returns that specific
        value, even when other clients generate new rows in the same table in
        the meantime.</p></div></section><section data-type="sect3" data-pdf-bookmark="Using API-specific methods to obtain AUTO_INCREMENT&#10;        values"><div class="sect3" id="idm45820346774704"><h3>Using API-specific methods to obtain AUTO_INCREMENT
        values</h3><p><code>LAST_INSERT_ID()</code> is an SQL
        function, so you can use it from within any client that can execute
        SQL statements. On the other hand, you do have to execute a separate
        statement to get its value. When you write your own programs, you may
        have another choice. Many MySQL interfaces include an API-specific
        extension that returns the <code>AUTO_INCREMENT</code> value without executing an
        additional statement. Most of our APIs have this capability.</p><dl><dt>Perl</dt><dd><p>Use the <code>mysql_insertid</code> attribute to obtain the <code>AUTO_INCREMENT</code> value generated by a
              statement. This attribute is accessed through either a database
              handle or a statement handle, depending on how you issue the
              statement. The following example references it through the
              database handle:</p><pre data-type="programlisting" data-code-language="perl"><code class="nv">$dbh</code><code class="o">-&gt;</code><code class="k">do</code> <code class="p">(</code><code class="s">"INSERT INTO insect (name,date,origin)</code>
<code class="s">           VALUES('moth','2014-09-14','windowsill')"</code><code class="p">);</code>
<code class="k">my</code> <code class="nv">$seq</code> <code class="o">=</code> <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">mysql_insertid</code><code class="p">};</code></pre><p>To access <code>mysql_insertid</code> as a statement-handle
              attribute, use <code>prepare()</code>
              and <code>execute()</code>:</p><pre data-type="programlisting" data-code-language="perl"><code class="k">my</code> <code class="nv">$sth</code> <code class="o">=</code> <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="n">prepare</code> <code class="p">(</code><code class="s">"INSERT INTO insect (name,date,origin)</code>
<code class="s">                          VALUES('moth','2014-09-14','windowsill')"</code><code class="p">);</code>
<code class="nv">$sth</code><code class="o">-&gt;</code><code class="n">execute</code> <code class="p">();</code>
<code class="k">my</code> <code class="nv">$seq</code> <code class="o">=</code> <code class="nv">$sth</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">mysql_insertid</code><code class="p">};</code></pre></dd><dt>Ruby</dt><dd><p>The Ruby Mysql2 gem exposes the client-side <code>AUTO_INCREMENT</code> value using the
              <code>last_id</code>
               method:</p><pre data-type="programlisting" data-code-language="ruby"><code class="n">client</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="s2">"INSERT INTO insect (name,date,origin)</code>
<code class="s2">        VALUES('moth','2014-09-14','windowsill')"</code><code class="p">)</code>
<code class="n">seq</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">last_id</code></pre></dd><dt>PHP</dt><dd><p>The PDO interface for MySQL has a <code>lastInsertId()</code> database-handle method that returns the most recent
              <code>AUTO_INCREMENT</code> value:</p><pre data-type="programlisting" data-code-language="php"><code class="nv">$dbh</code><code class="o">-&gt;</code><code class="na">exec</code> <code class="p">(</code><code class="s2">"INSERT INTO insect (name,date,origin)</code>
<code class="s2">             VALUES('moth','2014-09-14','windowsill')"</code><code class="p">);</code>
<code class="nv">$seq</code> <code class="o">=</code> <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="na">lastInsertId</code> <code class="p">();</code></pre></dd><dt>Python</dt><dd><p>The Connector/Python driver for DB API provides a <code>lastrowid</code> cursor object attribute that returns the most recent
              <code>AUTO_INCREMENT</code> value:</p><pre data-type="programlisting" data-code-language="python"><code class="n">cursor</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">cursor</code><code class="p">()</code>
<code class="n">cursor</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'''</code>
<code class="s1">               INSERT INTO insect (name,date,origin)</code>
<code class="s1">               VALUES('moth','2014-09-14','windowsill')</code>
<code class="s1">               '''</code><code class="p">)</code>
<code class="n">seq</code> <code class="o">=</code> <code class="n">cursor</code><code class="o">.</code><code class="n">lastrowid</code></pre></dd><dt>Java</dt><dd><p>The Connector/J JDBC driver <code>getGeneratedKeys()</code> method returns <code>AUTO_INCREMENT</code> values. It can be used
              with a <code>Statement</code> or <code>PreparedStatement</code> object if you supply
              an additional <code>Statement.RETURN_GENERATED_KEYS</code>
              argument during the statement-execution process to indicate that
              you want to retrieve the sequence value.</p><p>For a <code>Statement</code>:</p><pre data-type="programlisting" data-code-language="java"><code class="n">Statement</code> <code class="n">s</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="na">createStatement</code> <code class="o">();</code>
<code class="n">s</code><code class="o">.</code><code class="na">executeUpdate</code> <code class="o">(</code><code class="s">"INSERT INTO insect (name,date,origin)"</code>
                 <code class="o">+</code> <code class="s">" VALUES('moth','2014-09-14','windowsill')"</code><code class="o">,</code>
                 <code class="n">Statement</code><code class="o">.</code><code class="na">RETURN_GENERATED_KEYS</code><code class="o">);</code></pre><p>For a <code>PreparedStatement</code>:</p><pre data-type="programlisting" data-code-language="java"><code class="n">PreparedStatement</code> <code class="n">s</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="na">prepareStatement</code> <code class="o">(</code>
                    <code class="s">"INSERT INTO insect (name,date,origin)"</code>
                    <code class="o">+</code> <code class="s">" VALUES('moth','2014-09-14','windowsill')"</code><code class="o">,</code>
                    <code class="n">Statement</code><code class="o">.</code><code class="na">RETURN_GENERATED_KEYS</code><code class="o">);</code>
<code class="n">s</code><code class="o">.</code><code class="na">executeUpdate</code> <code class="o">();</code></pre><p>Then generate a new result set from <code>getGeneratedKeys()</code> to access the
              sequence value:</p><pre data-type="programlisting" data-code-language="java"><code class="kt">long</code> <code class="n">seq</code><code class="o">;</code>
<code class="n">ResultSet</code> <code class="n">rs</code> <code class="o">=</code> <code class="n">s</code><code class="o">.</code><code class="na">getGeneratedKeys</code> <code class="o">();</code>
<code class="k">if</code> <code class="o">(</code><code class="n">rs</code><code class="o">.</code><code class="na">next</code> <code class="o">())</code>
<code class="o">{</code>
  <code class="n">seq</code> <code class="o">=</code> <code class="n">rs</code><code class="o">.</code><code class="na">getLong</code> <code class="o">(</code><code class="mi">1</code><code class="o">);</code>
<code class="o">}</code>
<code class="k">else</code>
<code class="o">{</code>
  <code class="k">throw</code> <code class="k">new</code> <code class="nf">SQLException</code> <code class="o">(</code><code class="s">"getGeneratedKeys() produced no value"</code><code class="o">);</code>
<code class="o">}</code>
<code class="n">rs</code><code class="o">.</code><code class="na">close</code> <code class="o">();</code>
<code class="n">s</code><code class="o">.</code><code class="na">close</code> <code class="o">();</code></pre></dd><dt>Go</dt><dd><p>
                The Go MySQL driver provides method <code>LastInsertId</code> of the <code>Result</code> interface that returns the latest <code>AUTO_INCREMENT</code> value.
              </p><pre data-type="programlisting" data-code-language="go"><code class="nx">res</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">db</code><code class="p">.</code><code class="nx">Exec</code><code class="p">(</code><code class="s">`INSERT INTO insect (name,date,origin)</code>
<code class="s">                     VALUES ('moth','2014-09-14','windowsill')`</code><code class="p">)</code><code class="w"/>
<code class="nx">seq</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">res</code><code class="p">.</code><code class="nx">LastInsertId</code><code class="p">()</code><code class="w"/></pre></dd></dl></div></section><section data-type="sect3" data-pdf-bookmark="Server-side and client-side sequence value retrieval&#10;        compared"><div class="sect3" id="idm45820346441232"><h3>Server-side and client-side sequence value retrieval
        compared</h3><p>As mentioned earlier, the server maintains the value of <code>LAST_INSERT_ID()</code> on a session-specific
        basis. By contrast, the API-specific methods for accessing <code>AUTO_INCREMENT</code> values directly are
        implemented on the client side. Server-side and client-side sequence
        value retrieval methods have some similarities, but also some
        differences.</p><p>All methods, both server-side and client-side, require that you
        access an <code>AUTO_INCREMENT</code> value
        within the same MySQL session that generated it. If you generate an
        <code>AUTO_INCREMENT</code> value, then
        disconnect from the server and reconnect before attempting to access
        the value, you’ll get zero. Within a given session, the persistence of
        <code>AUTO_INCREMENT</code> values can be much
        longer on the server side of the session:</p><ul><li><p>After you execute a statement that generates an <code>AUTO_INCREMENT</code> value, the value remains
            available through <code>LAST_INSERT_ID()</code> even if you execute
            other statements, as long as none of those statements generate an
            <code>AUTO_INCREMENT</code> value.</p></li><li><p>The sequence value available using client-side API methods
            typically is set for <em>every</em> statement, not
            only those that generate <code>AUTO_INCREMENT</code> values. If you execute an <code>INSERT</code>
            statement that generates a new value and then execute some other
            statement before accessing the client-side sequence value, it
            probably will have been set to zero. The precise behavior varies
            among APIs, but to be safe, you can do this: when a statement
            generates a sequence value that you won’t use immediately, save
            the value in a variable that you can refer to later. Otherwise,
            you may find the sequence value wiped out by the time you try to
            access it. (For more on this topic, see <a data-type="xref" href="#nch-sequences-seq-simultaneous">Recipe 15.10</a>.)</p></li></ul></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.5 Renumbering an Existing Sequence"><div class="sect1" id="nch-sequences-seq-reseq"><h1>15.5 Renumbering an Existing Sequence</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820346357520"><h2>Problem</h2><p>You have gaps in a sequence column, and you want to resequence it.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820346356608"><h2>Solution</h2><p>First, consider whether resequencing is necessary. In many cases it is not. But if you have to, resequence the AUTO_INCREMENT columns periodically.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820346355664"><h2>Discussion</h2><p>If you insert rows into a table that has an <code>AUTO_INCREMENT</code> column and never delete any of
      them, values in the column form an unbroken sequence. If you delete
      rows, the sequence begins to have holes in it. For example, Junior’s
      <code>insect</code> table currently looks
      something like this, with gaps in the sequence (assuming that you’ve
      inserted the cricket and moth rows shown in <a data-type="xref" href="#nch-sequences-seq-retrieve">Recipe 15.4</a>):</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * FROM insect ORDER BY id;</code></strong>
+----+-------------------+------------+------------+
| id | name              | date       | origin     |
+----+-------------------+------------+------------+
|  1 | housefly          | 2014-09-10 | kitchen    |
|  3 | grasshopper       | 2014-09-10 | front yard |
|  4 | stink bug         | 2014-09-10 | front yard |
|  5 | cabbage butterfly | 2014-09-10 | garden     |
|  6 | ant               | 2014-09-10 | back yard  |
|  9 | cricket           | 2014-09-11 | basement   |
| 10 | moth              | 2014-09-14 | windowsill |
+----+-------------------+------------+------------+</pre><p>MySQL won’t attempt to eliminate these gaps by filling in the
      unused values when you insert new rows. People who dislike this behavior
      tend to resequence <code>AUTO_INCREMENT</code>
      columns periodically to eliminate the holes. The examples in this
      recipe show how to do that. It’s also possible to extend the range of
      an existing sequence (see <a data-type="xref" href="#nch-sequences-seq-range">Recipe 15.6</a>),
      force deleted values at the top of a sequence to be reused (see <a data-type="xref" href="#nch-sequences-seq-reuse-top">Recipe 15.7</a>), number rows in a particular
      order (see <a data-type="xref" href="#nch-sequences-seq-order">Recipe 15.8</a>), or add a
      sequence column to a table that doesn’t currently have one (see <a data-type="xref" href="#nch-sequences-seq-add-seq">Recipe 15.9</a>).</p><p>Before you decide to resequence an <code>AUTO_INCREMENT</code> column, consider whether that’s
      really necessary. It usually isn’t, and in some cases can cause you real
      problems. For example, you should <em>not</em> resequence a
      column containing values that are referenced by another table.
      Renumbering the values destroys their correspondence to values in the
      other table, making it impossible to properly relate rows in the two
      tables to each other.</p><p>Here are reasons we have seen advanced for resequencing a
      column:</p><dl><dt>Aesthetics</dt><dd><p>Some people prefer unbroken sequences to sequences with
            holes in them. If this is why you want to resequence, there’s
            probably not much we can say to convince you otherwise.
            Nevertheless, it’s not a particularly good reason.</p></dd><dt>Performance</dt><dd><p>The impetus for resequencing may stem from the notion that
            doing so <q>compacts</q> a sequence column by removing
            gaps and enables MySQL to run statements more quickly. This is not
            true. MySQL doesn’t care whether there are holes, and there is no
            performance gain to be had by renumbering an <code>AUTO_INCREMENT</code> column. In fact,
            resequencing affects performance negatively in the sense that the
            table remains locked while MySQL performs the operation—which may
            take a nontrivial amount of time for a large table. Other clients
            can read from the table while this is happening, but clients
            trying to insert new rows block until the operation is
            complete.</p></dd><dt>Running out of numbers</dt><dd><p>The sequence column’s data type and signedness determine its
            upper limit (see <a data-type="xref" href="#nch-sequences-seq-type">Recipe 15.2</a>). If an
            <code>AUTO_INCREMENT</code> sequence is
            approaching the upper limit of its data type, renumbering packs
            the sequence and frees up more values at the top. This may be a
            legitimate reason to resequence a column, but it is still
            unnecessary in many cases. You may be able to change the column
            data type to increase its upper limit without changing the values
            stored in the column; see <a data-type="xref" href="#nch-sequences-seq-range">Recipe 15.6</a>.</p></dd></dl><p>If you’re still determined to resequence a column, it’s easy to
      do: drop the column from the table; then put it back. MySQL renumbers
      the values in the column in unbroken sequence. The following example
      shows how to renumber the <code>id</code> values
      in the <code>insect</code> table using this
      technique:</p><pre data-type="programlisting">mysql&gt; <strong><code>ALTER TABLE insect DROP id;</code></strong>
mysql&gt; <strong><code>ALTER TABLE insect</code></strong>
    -&gt; <strong><code>ADD id INT UNSIGNED NOT NULL AUTO_INCREMENT FIRST,</code></strong>
    -&gt; <strong><code>ADD PRIMARY KEY (id);</code></strong></pre><p>The first <code>ALTER</code> <code>TABLE</code> statement gets rid of the <code>id</code>
      column (and as a result also drops the <code>PRIMARY</code> <code>KEY</code>, because the column to which it refers is
      no longer present). The second statement restores the column to the
      table and establishes it as the <code>PRIMARY</code> <code>KEY</code>. (The <code>FIRST</code> keyword places the column first in the table, which is where it
      was originally. Normally, <code>ADD</code> puts
      columns at the end of the table.)</p><p>When you add an <code>AUTO_INCREMENT</code>
      column to a table, MySQL automatically numbers all the rows
      consecutively, so the resulting contents of the <code>insect</code> table look like this:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * FROM insect ORDER BY id;</code></strong>
+----+-------------------+------------+------------+
| id | name              | date       | origin     |
+----+-------------------+------------+------------+
|  1 | housefly          | 2014-09-10 | kitchen    |
|  2 | grasshopper       | 2014-09-10 | front yard |
|  3 | stink bug         | 2014-09-10 | front yard |
|  4 | cabbage butterfly | 2014-09-10 | garden     |
|  5 | ant               | 2014-09-10 | back yard  |
|  6 | cricket           | 2014-09-11 | basement   |
|  7 | moth              | 2014-09-14 | windowsill |
+----+-------------------+------------+------------+</pre><p>One problem with resequencing a column using separate <code>ALTER</code> <code>TABLE</code>
      statements is that the table is without that column for the interval
      between the two operations. This might cause difficulties for other
      clients that try to access the table during that time. To prevent this
      from happening, perform both operations with a single <code>ALTER</code> <code>TABLE</code>
      statement:</p><pre data-type="programlisting">mysql&gt; <strong><code>ALTER TABLE insect</code></strong>
    -&gt; <strong><code>DROP id,</code></strong>
    -&gt; <strong><code>ADD id INT UNSIGNED NOT NULL AUTO_INCREMENT FIRST;</code></strong></pre><p>MySQL permits multiple actions to be done with <code>ALTER</code> <code>TABLE</code>
      (something not true for all database systems). However, notice that this
      multiple-action statement is not simply a concatenation of the two
      single-action <code>ALTER</code> <code>TABLE</code> statements. The difference is that it is
      unnecessary to reestablish the <code>PRIMARY</code> <code>KEY</code>: MySQL doesn’t drop it unless the indexed
      column is missing after all the actions specified in the <code>ALTER</code> <code>TABLE</code>
      statement have been performed.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.6 Extending the Range of a Sequence Column"><div class="sect1" id="nch-sequences-seq-range"><h1>15.6 Extending the Range of a Sequence Column</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820346293376"><h2>Problem</h2><p>You want to avoid resequencing a column, but you’re running out of room for
      new sequence numbers.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820346292240"><h2>Solution</h2><p>Check whether you can make the column <code>UNSIGNED</code> or
      change it to use a larger integer type.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820346290816"><h2>Discussion</h2><p>Resequencing an <code>AUTO_INCREMENT</code>
      column changes the contents of potentially every row in the table. It’s
      often possible to avoid this by extending the range of the column, which
      changes the table’s structure rather than its contents:</p><ul><li><p>If the data type is signed, make it <code>UNSIGNED</code> to double the range of available
          values. Suppose that an <code>id</code> column
          currently is defined like this:</p><pre data-type="programlisting">id MEDIUMINT NOT NULL AUTO_INCREMENT</pre><p>The upper range of a signed <code>MEDIUMINT</code>
          column is 8,388,607. To increase this to 16,777,215, make the column <code>UNSIGNED</code>
          with <code>ALTER</code> <code>TABLE</code>:</p><pre data-type="programlisting" data-code-language="sql">ALTER TABLE <em><code>tbl_name</code></em> MODIFY id MEDIUMINT UNSIGNED NOT NULL AUTO_INCREMENT;</pre></li><li><p>If your column is already <code>UNSIGNED</code> and it is not already the largest
          integer type (<code>BIGINT</code>), converting it to a larger type
          increases its range. Use <code>ALTER</code>
          <code>TABLE</code> for this, too. Convert the
          <code>id</code> column in the previous example
          from <code>MEDIUMINT</code> to <code>BIGINT</code> like so:</p><pre data-type="programlisting" data-code-language="sql">ALTER TABLE <em><code>tbl_name</code></em> MODIFY id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT;</pre></li></ul><p><a data-type="xref" href="#nch-sequences-seq-type">Recipe 15.2</a> shows the ranges for
      each integer data type, which can help you choose an appropriate
      type.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.7 Reusing Values at the Top of a Sequence"><div class="sect1" id="nch-sequences-seq-reuse-top"><h1>15.7 Reusing Values at the Top of a Sequence</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820346276272"><h2>Problem</h2><p>You’ve deleted rows at the top end of your sequence, and you want to avoid resequencing the column, but still reuse the values.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820346275296"><h2>Solution</h2><p>Yes. Use <code>ALTER</code> <code>TABLE</code> to reset the sequence counter. New sequence numbers will begin with the
      value one larger than the current maximum in the table.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820346273456"><h2>Discussion</h2><p>If you have removed rows only from the top of the sequence, those
      that remain are still in order with no gaps. (For example, if you have
      rows numbered 1 to 100 and you remove the rows with numbers 91 to 100,
      the remaining rows are still in unbroken sequence from 1 to 90.) In this
      special case, it’s unnecessary to renumber the column. Instead, tell
      MySQL to resume the sequence beginning with the value one larger than
      the highest existing sequence number by executing this statement, which
      causes MySQL to reset the sequence counter down as far as it can for new
      rows:</p><pre data-type="programlisting" data-code-language="sql">ALTER TABLE <em><code>tbl_name</code></em> AUTO_INCREMENT = 1;</pre><p>You can use <code>ALTER</code> <code>TABLE</code> to reset the sequence counter if a
      sequence column contains gaps in the middle, but doing so still reuses
      only values deleted from the top of the sequence. It does not eliminate
      the gaps. Suppose that a table contains sequence values from 1 to 10,
      from which you delete the rows for values 3, 4, 5, 9, and 10. The
      maximum remaining value is 8, so if you use <code>ALTER</code> <code>TABLE</code>
      to reset the sequence counter, the next row is given a value of 9, not
      3. To resequence a table to eliminate the gaps, see <a data-type="xref" href="#nch-sequences-seq-reseq">Recipe 15.5</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.8 Ensuring That Rows Are Renumbered in a Particular Order"><div class="sect1" id="nch-sequences-seq-order"><h1>15.8 Ensuring That Rows Are Renumbered in a Particular Order</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820346267088"><h2>Problem</h2><p>You resequenced a column, but MySQL didn’t number the rows the way you want.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820346266080"><h2>Solution</h2><p>Select the rows into another table, using an <code>ORDER</code> <code>BY</code> clause to place them in the order you want,
      and let MySQL number them according to the sort order as it performs the
      operation.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820346264208"><h2>Discussion</h2><p>When you resequence an <code>AUTO_INCREMENT</code> column, MySQL is free to pick the rows from the table in any
      order, so it doesn’t necessarily renumber them in the order that you
      expect. This doesn’t matter at all if your only requirement is that each
      row have a unique identifier. But you might have an application for
      which it’s important that the rows be assigned sequence numbers in a
      particular order. For example, you may want the sequence to correspond
      to the order in which rows were created, as indicated by a <code>TIMESTAMP</code> column.
      To assign numbers in a particular order, use this procedure:</p><ol><li><p>Create an empty clone of the table (see <a data-type="xref" href="ch06.xhtml#nch-tblmgmt-tblmgmt-clone">Recipe 6.1</a>).</p></li><li><p>Copy rows from the original into the clone using <code>INSERT</code>
          <code>INTO</code> … <code>SELECT</code>. Copy all columns except the
          <code>AUTO_INCREMENT</code> column, using an
          <code>ORDER</code> <code>BY</code> clause to specify the order in which
          rows are copied (and thus the order in which MySQL assigns numbers
          to the <code>AUTO_INCREMENT</code>
          column).</p></li><li><p>Drop the original table and rename the clone to have the
          original table’s name.</p></li><li><p>If the table is a large MyISAM table and has multiple indexes, it is more
          efficient to create the new table initially with no indexes except
          the one on the <code>AUTO_INCREMENT</code>
          column. Then copy the original table into the new table and
          use <code>ALTER</code> <code>TABLE</code> to add the remaining indexes
          afterward.</p><p>
            This applies to InnoDB as well. But InnoDB <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-change-buffer.html">Change Buffer</a> caches changes to the secondary indexes in memory and flushes then them to the disk in background. This allows to keep insert performance at the good speed.
          </p></li></ol><p>An alternative procedure:</p><ol><li><p>Create a new table that contains all the columns of the
          original table except the <code>AUTO_INCREMENT</code> column.</p></li><li><p>Use <code>INSERT</code> <code>INTO</code> … <code>SELECT</code> to copy the non-<code>AUTO_INCREMENT</code> columns from the original
          table into the new table.</p></li><li><p>Use <code>TRUNCATE</code> <code>TABLE</code> on the original table to empty it; this also resets the
          sequence counter to 1.</p></li><li><p>Copy rows from the new table back to the original table, using
          an <code>ORDER</code> <code>BY</code> clause to sort rows into the order in
          which you want sequence numbers assigned. MySQL assigns sequence
          values to the <code>AUTO_INCREMENT</code>
          column.</p></li></ol></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.9 Sequencing an Unsequenced Table"><div class="sect1" id="nch-sequences-seq-add-seq"><h1>15.9 Sequencing an Unsequenced Table</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820346245568"><h2>Problem</h2><p>You forgot to include a sequence column when you created a table. Is it too late
      to sequence the table rows?</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820346244496"><h2>Solution</h2><p>No. Add an <code>AUTO_INCREMENT</code>
      column using <code>ALTER</code> <code>TABLE</code>; MySQL creates the column and numbers
      its rows.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820346242144"><h2>Discussion</h2><p>Suppose that a table
      contains <code>name</code> and <code>age</code> columns, but no sequence column:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * FROM t;</code></strong>
+----------+------+
| name     | age  |
+----------+------+
| boris    |   47 |
| clarence |   62 |
| abner    |   53 |
+----------+------+</pre><p>Add a sequence column named <code>id</code>
      to the table as follows:</p><pre data-type="programlisting">mysql&gt; <strong><code>ALTER TABLE t</code></strong>
    -&gt; <strong><code>ADD id INT NOT NULL AUTO_INCREMENT,</code></strong>
    -&gt; <strong><code>ADD PRIMARY KEY (id);</code></strong>
mysql&gt; <strong><code>SELECT * FROM t ORDER BY id;</code></strong>
+----------+------+----+
| name     | age  | id |
+----------+------+----+
| boris    |   47 |  1 |
| clarence |   62 |  2 |
| abner    |   53 |  3 |
+----------+------+----+</pre><p>MySQL numbers the rows for you; it’s unnecessary to assign the
      values yourself. Very handy.</p><p>By default, <code>ALTER</code> <code>TABLE</code> adds new columns to the end of the
      table. To place a column at a specific position, use <code>FIRST</code> or <code>AFTER</code> at the end of the <code>ADD</code> clause.
      The following <code>ALTER</code> <code>TABLE</code> statements are similar to the one just
      shown, but place the <code>id</code> column first
      in the table or after the <code>name</code>
      column, respectively:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">ALTER</code> <code class="k">TABLE</code> <code class="n">t</code>
  <code class="k">ADD</code> <code class="n">id</code> <code class="nb">INT</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="n">AUTO_INCREMENT</code> <code class="k">FIRST</code><code class="p">,</code>
  <code class="k">ADD</code> <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="n">id</code><code class="p">);</code></pre><pre data-type="programlisting" data-code-language="sql"><code class="k">ALTER</code> <code class="k">TABLE</code> <code class="n">t</code>
  <code class="k">ADD</code> <code class="n">id</code> <code class="nb">INT</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="n">AUTO_INCREMENT</code> <code class="k">AFTER</code> <code class="n">name</code><code class="p">,</code>
  <code class="k">ADD</code> <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="n">id</code><code class="p">);</code></pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.10 Managing Multiple Auto-Increment Values Simultaneously"><div class="sect1" id="nch-sequences-seq-simultaneous"><h1>15.10 Managing Multiple Auto-Increment Values Simultaneously</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820346204976"><h2>Problem</h2><p>You’re executing multiple statements that generate <code>AUTO_INCREMENT</code> values, and it’s necessary to
      keep track of them independently. For example, you’re inserting rows
      into multiple tables, each of which has its own <code>AUTO_INCREMENT</code> column.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820346203328"><h2>Solution</h2><p>Save the sequence values in variables for later use.
      Alternatively, if you execute sequence-generating statements from within
      a program, you might be able to issue the statements using separate
      connection or statement objects to keep them from getting mixed
      up.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820346160912"><h2>Discussion</h2><p>As described in <a data-type="xref" href="#nch-sequences-seq-retrieve">Recipe 15.4</a>, the
      <code>LAST_INSERT_ID()</code> server-side
      sequence value function is set each time a statement
      generates an <code>AUTO_INCREMENT</code> value,
      whereas client-side sequence indicators may be reset for every
      statement. What if you issue a statement that generates an <code>AUTO_INCREMENT</code> value, but you don’t want to
      refer to that value until after issuing a second statement that also
      generates an <code>AUTO_INCREMENT</code> value? In
      this case, the original value is no longer accessible, either through
      <code>LAST_INSERT_ID()</code> or as a client-side
      value. To retain access to it, save the value first before issuing the
      second statement. There are several ways to do this:</p><ul><li><p>At the SQL level, save the value in a user-defined variable
          after issuing a statement that generates an <code>AUTO_INCREMENT</code> value:</p><pre data-type="programlisting" data-code-language="sql">INSERT INTO <em><code>tbl_name</code></em> (id,...) VALUES(NULL,...);
SET @saved_id = LAST_INSERT_ID();</pre><p>Then you can issue other statements without regard to their
          effect on <code>LAST_INSERT_ID()</code>. To
          use the original <code>AUTO_INCREMENT</code>
          value in a subsequent statement, refer to the <code>@saved_id</code> variable.</p></li><li><p>At the API level, save the <code>AUTO_INCREMENT</code> value in an API language
          variable. This can be done by saving the value returned from either
          <code>LAST_INSERT_ID()</code> or any
          API-specific extension that is available.</p></li><li><p>Some APIs enable you to maintain separate client-side <code>AUTO_INCREMENT</code> values. For example, Perl
          DBI statement handles have a <code>mysql_insertid</code> attribute, and the
          attribute value for one handle is unaffected by activity on another.
          In Java, use separate <code>Statement</code>
          or <code>PreparedStatement</code>
          objects.</p></li></ul><p>See <a data-type="xref" href="#nch-sequences-seq-relate">Recipe 15.11</a> for application of
      these techniques to situations in which you must insert rows into
      multiple tables that each contain an <code>AUTO_INCREMENT</code> column.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.11 Using Auto-Increment Values to Associate Tables"><div class="sect1" id="nch-sequences-seq-relate"><h1>15.11 Using Auto-Increment Values to Associate Tables</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820346145856"><h2>Problem</h2><p>You use sequence values from one table as keys in a second table so that
      you can associate rows in the two tables with each other. But the
      associations aren’t being set up properly.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820346144880"><h2>Solution</h2><p>You’re probably not inserting rows in the proper order, or you’re
      losing track of the sequence values. Change the insertion order, or save
      the sequence values so that you can refer to them when you need
      them.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820346143936"><h2>Discussion</h2><p>Be careful with an <code>AUTO_INCREMENT</code> value used as an ID value in a
      master table if you also store the value in detail table rows for the
      purpose of linking the detail rows to the proper master table row.
      Suppose that an <code>invoice</code> table lists
      invoice information for customer orders, and an <code>inv_item</code> table lists the individual items
      associated with each invoice. Here, <code>invoice</code> is the master table and <code>inv_item</code> is the detail table. To uniquely
      identify each order, include an <code>AUTO_INCREMENT</code> column <code>inv_id</code> in the <code>invoice</code> table. You’d also store the
      appropriate invoice number in each <code>inv_item</code> table row so that you can tell which
      invoice it goes with. The tables might look something like this:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">invoice</code>
<code class="p">(</code>
  <code class="n">inv_id</code>  <code class="nb">INT</code> <code class="n">UNSIGNED</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="n">AUTO_INCREMENT</code><code class="p">,</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="n">inv_id</code><code class="p">),</code>
  <code class="nb">date</code>    <code class="nb">DATE</code> <code class="k">NOT</code> <code class="k">NULL</code>
  <code class="o">#</code> <code class="p">...</code> <code class="n">other</code> <code class="n">columns</code> <code class="n">could</code> <code class="k">go</code> <code class="n">here</code>
  <code class="o">#</code> <code class="p">...</code> <code class="p">(</code><code class="n">customer</code> <code class="n">ID</code><code class="p">,</code> <code class="n">shipping</code> <code class="n">address</code><code class="p">,</code> <code class="n">etc</code><code class="p">.)</code>
<code class="p">);</code>
<code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">inv_item</code>
<code class="p">(</code>
  <code class="n">inv_id</code>    <code class="nb">INT</code> <code class="n">UNSIGNED</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>  <code class="o">#</code> <code class="n">invoice</code> <code class="n">ID</code> <code class="p">(</code><code class="k">from</code> <code class="n">invoice</code> <code class="k">table</code><code class="p">)</code>
  <code class="k">INDEX</code> <code class="p">(</code><code class="n">inv_id</code><code class="p">),</code>
  <code class="n">qty</code>       <code class="nb">INT</code><code class="p">,</code>                    <code class="o">#</code> <code class="n">quantity</code>
  <code class="n">description</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">40</code><code class="p">)</code>           <code class="o">#</code> <code class="n">description</code>
<code class="p">);</code></pre><p>For this kind of table relationship, it’s typical to insert a row
      into the master table first (to generate the <code>AUTO_INCREMENT</code> value that identifies the row),
      and then insert the detail rows using <code>LAST_INSERT_ID()</code>
      to obtain the master row ID. If a customer buys a hammer, three boxes of
      nails, and (in anticipation of finger-bashing with the hammer) a dozen
      bandages, the rows pertaining to the order can be inserted into the two
      tables <span class="keep-together">like so:</span></p><pre data-type="programlisting" data-code-language="sql"><code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">invoice</code> <code class="p">(</code><code class="n">inv_id</code><code class="p">,</code><code class="nb">date</code><code class="p">)</code>
  <code class="k">VALUES</code><code class="p">(</code><code class="k">NULL</code><code class="p">,</code><code class="n">CURDATE</code><code class="p">());</code>
<code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">inv_item</code> <code class="p">(</code><code class="n">inv_id</code><code class="p">,</code><code class="n">qty</code><code class="p">,</code><code class="n">description</code><code class="p">)</code>
  <code class="k">VALUES</code><code class="p">(</code><code class="n">LAST_INSERT_ID</code><code class="p">(),</code><code class="mi">1</code><code class="p">,</code><code class="s1">'hammer'</code><code class="p">);</code>
<code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">inv_item</code> <code class="p">(</code><code class="n">inv_id</code><code class="p">,</code><code class="n">qty</code><code class="p">,</code><code class="n">description</code><code class="p">)</code>
  <code class="k">VALUES</code><code class="p">(</code><code class="n">LAST_INSERT_ID</code><code class="p">(),</code><code class="mi">3</code><code class="p">,</code><code class="s1">'nails, box'</code><code class="p">);</code>
<code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">inv_item</code> <code class="p">(</code><code class="n">inv_id</code><code class="p">,</code><code class="n">qty</code><code class="p">,</code><code class="n">description</code><code class="p">)</code>
  <code class="k">VALUES</code><code class="p">(</code><code class="n">LAST_INSERT_ID</code><code class="p">(),</code><code class="mi">12</code><code class="p">,</code><code class="s1">'bandage'</code><code class="p">);</code></pre><p>The first <code>INSERT</code> adds a
      row to the <code>invoice</code>
      master table and generates a new <code>AUTO_INCREMENT</code> value for its <code>inv_id</code> column. The following <code>INSERT</code> statements each add a row to the
      <code>inv_item</code> detail table, using <code>LAST_INSERT_ID()</code> to get the invoice number.
      This associates the detail rows with the proper master row.</p><p>What if you have multiple invoices to process? There’s a right way
      and a wrong way to enter the information. The right way is to insert all
      the information for the first invoice, then proceed to the next. The
      wrong way is to add all the master rows into the <code>invoice</code> table, then add all the detail rows to
      the <code>inv_item</code> table. If you do that,
      <em>all</em> the new detail rows in the <code>inv_item</code> table have the <code>AUTO_INCREMENT</code> value from the most recently
      entered <code>invoice</code> row. Thus, all items
      appear to be part of that invoice, and rows in the two tables don’t have
      the proper associations.</p><p>If the detail table contains its own <code>AUTO_INCREMENT</code> column, you must be even more
      careful about how you add rows to the tables. Suppose that you want each
      row in the <code>inv_item</code> table to have a
      unique identifier. To do that, create the <code>inv_item</code> table as follows with an <code>AUTO_INCREMENT</code> column named <code>item_id</code>:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">inv_item</code>
<code class="p">(</code>
  <code class="n">inv_id</code>  <code class="nb">INT</code> <code class="n">UNSIGNED</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>  <code class="o">#</code> <code class="n">invoice</code> <code class="n">ID</code> <code class="p">(</code><code class="k">from</code> <code class="n">invoice</code> <code class="k">table</code><code class="p">)</code>
  <code class="n">item_id</code> <code class="nb">INT</code> <code class="n">UNSIGNED</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="n">AUTO_INCREMENT</code><code class="p">,</code> <code class="o">#</code> <code class="n">item</code> <code class="n">ID</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="n">item_id</code><code class="p">),</code>
  <code class="n">qty</code>     <code class="nb">INT</code><code class="p">,</code>                                  <code class="o">#</code> <code class="n">quantity</code>
  <code class="n">description</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">40</code><code class="p">)</code>                       <code class="o">#</code> <code class="n">description</code>
<code class="p">);</code></pre><p>The <code>inv_id</code> column enables each
      <code>inv_item</code> row to be associated with
      the proper <code>invoice</code> table row, just as
      with the original table structure. In addition, <code>item_id</code> uniquely identifies each item row.
      However, now that both tables contain an <code>AUTO_INCREMENT</code> column, you cannot enter
      information for an invoice the same way as before. If you execute the
      <code>INSERT</code> statements shown previously,
      they now produce a different result due to the change in the <code>inv_item</code> table structure. The <code>INSERT</code> into the <code>invoice</code> table works properly. So does the
      first <code>INSERT</code> into the <code>inv_item</code> table; <code>LAST_INSERT_ID()</code> returns the <code>inv_id</code> value from the master row in the
      <code>invoice</code> table. However, this <code>INSERT</code> also generates its own <code>AUTO_INCREMENT</code> value (for the <code>item_id</code> column), which changes the value of
      <code>LAST_INSERT_ID()</code> and causes the
      master row <code>inv_id</code> value to be
      <q>lost.</q> As a result, each of the remaining inserts into the
      <code>inv_item</code> table stores the preceding
      row’s <code>item_id</code> value into the <code>inv_id</code> column. This causes the second and
      following rows to have incorrect <code>inv_id</code> values.</p><p>To avoid this difficulty, save the sequence value generated by the
      insert into the master table and use the saved value for the inserts
      into the detail table. To save the value, use a user-defined SQL
      variable or a variable maintained by your program. <a data-type="xref" href="#nch-sequences-seq-simultaneous">Recipe 15.10</a> describes those techniques,
      which apply here as follows:</p><ul><li><p>Use a user-defined variable: Save the master row <code>AUTO_INCREMENT</code> value in a user-defined
          variable for use when inserting the detail rows:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">invoice</code> <code class="p">(</code><code class="n">inv_id</code><code class="p">,</code><code class="nb">date</code><code class="p">)</code>
  <code class="k">VALUES</code><code class="p">(</code><code class="k">NULL</code><code class="p">,</code><code class="n">CURDATE</code><code class="p">());</code>
<code class="k">SET</code> <code class="o">@</code><code class="n">inv_id</code> <code class="o">=</code> <code class="n">LAST_INSERT_ID</code><code class="p">();</code>
<code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">inv_item</code> <code class="p">(</code><code class="n">inv_id</code><code class="p">,</code><code class="n">qty</code><code class="p">,</code><code class="n">description</code><code class="p">)</code>
  <code class="k">VALUES</code><code class="p">(</code><code class="o">@</code><code class="n">inv_id</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="s1">'hammer'</code><code class="p">);</code>
<code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">inv_item</code> <code class="p">(</code><code class="n">inv_id</code><code class="p">,</code><code class="n">qty</code><code class="p">,</code><code class="n">description</code><code class="p">)</code>
  <code class="k">VALUES</code><code class="p">(</code><code class="o">@</code><code class="n">inv_id</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="s1">'nails, box'</code><code class="p">);</code>
<code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">inv_item</code> <code class="p">(</code><code class="n">inv_id</code><code class="p">,</code><code class="n">qty</code><code class="p">,</code><code class="n">description</code><code class="p">)</code>
  <code class="k">VALUES</code><code class="p">(</code><code class="o">@</code><code class="n">inv_id</code><code class="p">,</code><code class="mi">12</code><code class="p">,</code><code class="s1">'bandage'</code><code class="p">);</code></pre></li><li><p>Use a variable maintained by your program: This method is
          similar to the previous one, but applies only from within an API.
          Insert the master row, and then save the <code>AUTO_INCREMENT</code> value into an API variable
          for use when inserting detail rows. For example, in Ruby, access the
          <code>AUTO_INCREMENT</code> value using the
          <code>last_id</code> method:</p><pre data-type="programlisting" data-code-language="ruby"><code class="n">client</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="s2">"INSERT INTO invoice (inv_id,date) VALUES(NULL,CURDATE())"</code><code class="p">)</code>
<code class="n">inv_id</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">last_id</code>
<code class="n">sth</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">prepare</code><code class="p">(</code><code class="s2">"INSERT INTO inv_item (inv_id,qty,description)</code>
<code class="s2">                   VALUES(?,?,?)"</code><code class="p">)</code>
<code class="n">sth</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">inv_id</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"hammer"</code><code class="p">)</code>
<code class="n">sth</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">inv_id</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="s2">"nails, box"</code><code class="p">)</code>
<code class="n">sth</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="n">inv_id</code><code class="p">,</code> <code class="mi">12</code><code class="p">,</code> <code class="s2">"bandage"</code><code class="p">)</code></pre></li></ul></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.12 Using Sequence Generators as Counters"><div class="sect1" id="nch-sequences-seq-counter"><h1>15.12 Using Sequence Generators as Counters</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820345639232"><h2>Problem</h2><p>You’re interested only in counting events, so you want to avoid having to create a new table row for each sequence value.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820345580448"><h2>Solution</h2><p>Increment a single row per counter.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820345579568"><h2>Discussion</h2><p><code>AUTO_INCREMENT</code> columns are
      useful for generating sequences across a set of individual rows. But
      some applications require only a count of the number of times an event
      occurs, and there’s no benefit from creating a separate row for each
      event. Instances include web page or banner ad hit counters, a count of
      items sold, or the number of votes in a poll. Such applications need
      only a single row to hold the count as it changes over time. MySQL
      provides a mechanism for this that enables counts to be treated like
      <code>AUTO_INCREMENT</code> values so that you can
      not only increment the count, but retrieve the updated value
      easily.</p><p>To count a single type of event, use a trivial table with a single
      row and column. For example, to record copies sold of a book, create a
      table like this:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">booksales</code> <code class="p">(</code><code class="n">copies</code> <code class="nb">INT</code> <code class="n">UNSIGNED</code><code class="p">);</code></pre><p>However, if you’re counting sales for multiple book titles, that
      method doesn’t work well. You certainly don’t want to create a separate
      single-row counting table per book. Instead, count them all within a
      single table by including a column that uniquely identifies each book.
      The following table does this using a <code>title</code> column for the book title in addition to
      a <code>copies</code> column that records the
      number of copies sold:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">booksales</code>
<code class="p">(</code>
  <code class="n">title</code>   <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">60</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>   <code class="o">#</code> <code class="n">book</code> <code class="n">title</code>
  <code class="n">copies</code>  <code class="nb">INT</code> <code class="n">UNSIGNED</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>  <code class="o">#</code> <code class="nb">number</code> <code class="k">of</code> <code class="n">copies</code> <code class="n">sold</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="n">title</code><code class="p">)</code>
<code class="p">);</code></pre><p>To record sales for a given book, different approaches are
      possible:</p><ul><li><p>Initialize a row for the book with a <code>copies</code> value of 0:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">booksales</code> <code class="p">(</code><code class="n">title</code><code class="p">,</code><code class="n">copies</code><code class="p">)</code> <code class="k">VALUES</code><code class="p">(</code><code class="s1">'The Greater Trumps'</code><code class="p">,</code><code class="mi">0</code><code class="p">);</code></pre><p>Then increment the <code>copies</code>
          value for each sale:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">UPDATE</code> <code class="n">booksales</code> <code class="k">SET</code> <code class="n">copies</code> <code class="o">=</code> <code class="n">copies</code><code class="o">+</code><code class="mi">1</code> <code class="k">WHERE</code> <code class="n">title</code> <code class="o">=</code> <code class="s1">'The Greater Trumps'</code><code class="p">;</code></pre><p>This method requires that you remember to initialize a row for
          each book or the <code>UPDATE</code> will
          fail.</p></li><li><p>Use <code>INSERT</code> with <code>ON</code> <code>DUPLICATE</code> <code>KEY</code> <code>UPDATE</code>, which initializes the row with a count of 1 for the first
          sale and increments the count for subsequent sales:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">booksales</code> <code class="p">(</code><code class="n">title</code><code class="p">,</code><code class="n">copies</code><code class="p">)</code>
<code class="k">VALUES</code><code class="p">(</code><code class="s1">'The Greater Trumps'</code><code class="p">,</code><code class="mi">1</code><code class="p">)</code>
<code class="k">ON</code> <code class="n">DUPLICATE</code> <code class="k">KEY</code> <code class="k">UPDATE</code> <code class="n">copies</code> <code class="o">=</code> <code class="n">copies</code><code class="o">+</code><code class="mi">1</code><code class="p">;</code></pre><p>This is simpler because the same statement works to initialize
          and update the sales count.</p></li></ul><p>To retrieve the sales count (for example, to display a message to
      customers such as <q>you just purchased copy
      <em><code>n</code></em> of this book</q>), issue a <code>SELECT</code> query for the same book title:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="n">copies</code> <code class="k">FROM</code> <code class="n">booksales</code> <code class="k">WHERE</code> <code class="n">title</code> <code class="o">=</code> <code class="s1">'The Greater Trumps'</code><code class="p">;</code></pre><p>Unfortunately, this is not quite correct. Suppose that between the
      times when you update and retrieve the count, some other person buys a
      copy of the book (and thus increments the <code>copies</code> value). Then the <code>SELECT</code> statement won’t actually produce the
      value <em>you</em> incremented the sales count to, but
      rather its most recent value. In other words, other clients can affect
      the value before you have time to retrieve it. This is similar to the
      problem discussed in <a data-type="xref" href="#nch-sequences-seq-retrieve">Recipe 15.4</a> that
      can occur if you try to retrieve the most recent <code>AUTO_INCREMENT</code> value from a column by invoking
      <code>MAX(</code><em><code>col_name</code></em><code>)</code> rather than <code>LAST_INSERT_ID()</code>.</p><p>There are ways around this (such as by grouping the two statements
      as a transaction or by locking the table), but MySQL provides a simpler
      solution based on <code>LAST_INSERT_ID()</code>. If
      you call <code>LAST_INSERT_ID()</code> with an
      expression argument, MySQL treats it like an <code>AUTO_INCREMENT</code> value. To use this feature with
      the <code>booksales</code> table, modify the
      count-incrementing statement slightly:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">booksales</code> <code class="p">(</code><code class="n">title</code><code class="p">,</code><code class="n">copies</code><code class="p">)</code>
<code class="k">VALUES</code><code class="p">(</code><code class="s1">'The Greater Trumps'</code><code class="p">,</code><code class="n">LAST_INSERT_ID</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>
<code class="k">ON</code> <code class="n">DUPLICATE</code> <code class="k">KEY</code> <code class="k">UPDATE</code> <code class="n">copies</code> <code class="o">=</code> <code class="n">LAST_INSERT_ID</code><code class="p">(</code><code class="n">copies</code><code class="o">+</code><code class="mi">1</code><code class="p">);</code></pre><p>The statement uses the <code>LAST_INSERT_ID(</code><em><code>expr</code></em><code>)</code> construct both to initialize and to
      increment the count. MySQL treats the expression argument like an
      <code>AUTO_INCREMENT</code> value, so that you can
      invoke <code>LAST_INSERT_ID()</code> later with no
      argument to retrieve the value:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="n">LAST_INSERT_ID</code><code class="p">();</code></pre><p>By setting and retrieving the <code>copies</code> column this way, you always get back
      the value you set it to, even if some other client updated it in the
      meantime. If you issue the <code>INSERT</code>
      statement from within an API that provides a mechanism for fetching the
      most recent <code>AUTO_INCREMENT</code> value
      directly, you need not even issue the <code>SELECT</code> query. For example, using Connector/Python, update a count and get the new value
      using the <code>lastrowid</code>
      attribute:</p><pre data-type="programlisting" data-code-language="python"><code class="n">cursor</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">cursor</code><code class="p">()</code>
<code class="n">cursor</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s1">'''</code>
<code class="s1">               INSERT INTO booksales (title,copies)</code>
<code class="s1">               VALUES('The Greater Trumps',LAST_INSERT_ID(1))</code>
<code class="s1">               ON DUPLICATE KEY UPDATE copies = LAST_INSERT_ID(copies+1)</code>
<code class="s1">               '''</code><code class="p">)</code>
<code class="n">count</code> <code class="o">=</code> <code class="n">cursor</code><code class="o">.</code><code class="n">lastrowid</code>
<code class="n">cursor</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>
<code class="n">conn</code><code class="o">.</code><code class="n">commit</code><code class="p">()</code></pre><p>In Java, the operation looks like this:</p><pre data-type="programlisting" data-code-language="java"><code class="n">Statement</code> <code class="n">s</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="na">createStatement</code> <code class="o">();</code>
<code class="n">s</code><code class="o">.</code><code class="na">executeUpdate</code> <code class="o">(</code>
    <code class="s">"INSERT INTO booksales (title,copies)"</code>
    <code class="o">+</code> <code class="s">"VALUES('The Greater Trumps',LAST_INSERT_ID(1))"</code>
    <code class="o">+</code> <code class="s">"ON DUPLICATE KEY UPDATE copies = LAST_INSERT_ID(copies+1)"</code><code class="o">,</code>
    <code class="n">Statement</code><code class="o">.</code><code class="na">RETURN_GENERATED_KEYS</code><code class="o">);</code>
<code class="kt">long</code> <code class="n">count</code><code class="o">;</code>
<code class="n">ResultSet</code> <code class="n">rs</code> <code class="o">=</code> <code class="n">s</code><code class="o">.</code><code class="na">getGeneratedKeys</code> <code class="o">();</code>
<code class="k">if</code> <code class="o">(</code><code class="n">rs</code><code class="o">.</code><code class="na">next</code> <code class="o">())</code>
<code class="o">{</code>
  <code class="n">count</code> <code class="o">=</code> <code class="n">rs</code><code class="o">.</code><code class="na">getLong</code> <code class="o">(</code><code class="mi">1</code><code class="o">);</code>
<code class="o">}</code>
<code class="k">else</code>
<code class="o">{</code>
  <code class="k">throw</code> <code class="k">new</code> <code class="nf">SQLException</code> <code class="o">(</code><code class="s">"getGeneratedKeys() produced no value"</code><code class="o">);</code>
<code class="o">}</code>
<code class="n">rs</code><code class="o">.</code><code class="na">close</code> <code class="o">();</code>
<code class="n">s</code><code class="o">.</code><code class="na">close</code> <code class="o">();</code></pre><p>Use of <code>LAST_INSERT_ID(</code><em><code>expr</code></em><code>)</code> for sequence generation has certain other
      properties that differ from true <code>AUTO_INCREMENT</code> sequences:</p><ul><li><p><code>AUTO_INCREMENT</code> values
          increment by one each time, whereas values generated by <code>LAST_INSERT_ID(</code><em><code>expr</code></em><code>)</code> can be any nonnegative value you want.
          For example, to produce the sequence 10, 20, 30, …, increment the
          count by 10 each time. You need not even increment the counter by
          the same value each time. If you sell a dozen copies of a book
          rather than a single copy, update its sales count as follows:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">booksales</code> <code class="p">(</code><code class="n">title</code><code class="p">,</code><code class="n">copies</code><code class="p">)</code>
<code class="k">VALUES</code><code class="p">(</code><code class="s1">'The Greater Trumps'</code><code class="p">,</code><code class="n">LAST_INSERT_ID</code><code class="p">(</code><code class="mi">12</code><code class="p">))</code>
<code class="k">ON</code> <code class="n">DUPLICATE</code> <code class="k">KEY</code> <code class="k">UPDATE</code> <code class="n">copies</code> <code class="o">=</code> <code class="n">LAST_INSERT_ID</code><code class="p">(</code><code class="n">copies</code><code class="o">+</code><code class="mi">12</code><code class="p">);</code></pre></li><li><p>To reset a counter, simply set it to the desired value.
          Suppose that you want to report to book buyers the sales for the
          current month, rather than the total sales (for example, to display
          messages like <q>you’re the <em><code>n</code></em>th buyer
          this month</q>). To clear the counters to zero at the beginning
          of each month, use this statement:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">UPDATE</code> <code class="n">booksales</code> <code class="k">SET</code> <code class="n">copies</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code></pre></li><li><p>One property that’s not so desirable is that the value
          generated by <code>LAST_INSERT_ID(</code><em><code>expr</code></em><code>)</code> is not uniformly available via
          client-side retrieval methods under all circumstances. You can get
          it after <code>UPDATE</code> or <code>INSERT</code> statements, but not for <code>SET</code> statements. If you generate a value as
          follows (in Ruby), the client-side value returned by <code>insert_id</code> is 0, not 48:</p><pre data-type="programlisting" data-code-language="ruby"><code class="n">client</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="s2">"SET @x = LAST_INSERT_ID(48)"</code><code class="p">)</code>
<code class="n">seq</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">last_id</code></pre><p>To get the value in this case, ask the server for it:</p><pre data-type="programlisting" data-code-language="ruby"><code class="n">seq</code> <code class="o">=</code> <code class="n">client</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="s2">"SELECT LAST_INSERT_ID()"</code><code class="p">)</code><code class="o">.</code><code class="n">first</code><code class="o">.</code><code class="n">values</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code></pre></li></ul></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.13 Generating Repeating Sequences"><div class="sect1" id="nch-sequences-seq-repeat"><h1>15.13 Generating Repeating Sequences</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820344978800"><h2>Problem</h2><p>You require a sequence that contains cycles.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820344932528"><h2>Solution</h2><p>Make cycles in the sequence with
      division and modulo operations.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820344931648"><h2>Discussion</h2><p>Some sequence-generation problems require values that go through
      cycles. Suppose that you manufacture items such as pharmaceutical
      products or automobile parts, and you must be able to track them by lot
      number if manufacturing problems are discovered later that require items
      sold within a particular lot to be recalled. Suppose also that you pack
      and distribute items 12 units to a box and 6 boxes to a case. In this
      situation, item identifiers are three-part values: the unit number (with
      a value from 1 to 12), the box number (with a value from 1 to 6), and a
      lot number (with a value from 1 to the highest current case
      number).</p><p>This item-tracking problem appears to require that you maintain
      three counters, so you might generate the next identifier value using an
      algorithm like this:</p><pre data-type="programlisting">retrieve most recently used case, box, and unit numbers
unit = unit + 1     # increment unit number
if (unit &gt; 12)      # need to start a new box?
{
  unit = 1          # go to first unit of next box
  box = box + 1
}
if (box &gt; 6)        # need to start a new case?
{
  box = 1           # go to first box of next case
  case = case + 1
}
store new case, box, and unit numbers</pre><p>Alternatively, it’s possible simply to assign each item a sequence
      number identifier and derive the corresponding case, box, and unit
      numbers from it. The identifier can come from an <code>AUTO_INCREMENT</code> column or a single-row sequence
      generator. The formulas for determining the case, box, and unit numbers
      for any item from its sequence number look like this:</p><pre data-type="programlisting">unit_num = ((seq - 1) % 12) + 1
box_num = (int ((seq - 1) / 12) % 6) + 1
case_num = int ((seq - 1)/(6 * 12)) + 1</pre><p>The following table illustrates the relationship between some
      sample sequence numbers and the corresponding case, box, and unit
      numbers:</p><table><thead><tr><th>seq</th><th>case</th><th>box</th><th>unit</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>1</td><td>1</td></tr><tr><td>12</td><td>1</td><td>1</td><td>12</td></tr><tr><td>13</td><td>1</td><td>2</td><td>1</td></tr><tr><td>72</td><td>1</td><td>6</td><td>12</td></tr><tr><td>73</td><td>2</td><td>1</td><td>1</td></tr><tr><td>144</td><td>2</td><td>6</td><td>12</td></tr></tbody></table></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.14 Using Custom Increment Values"><div class="sect1" id="nch-sequences-seq-increment_increment"><h1>15.14 Using Custom Increment Values</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820344914336"><h2>Problem</h2><p>
        You want to increment sequences not by one but by a different number.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820344913424"><h2>Solution</h2><p>
        Use the system variables <code>auto_increment_increment</code> and <code>auto_increment_offset</code>.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820344911648"><h2>Discussion</h2><p>
        By default MySQL increases values in a column, having an <code>AUTO_INCREMENT</code> option, by one. This is not always desirable. Suppose you have a replication chain (<a data-type="xref" href="ch03.xhtml#nch-replication-replication-circle">Recipe 3.9</a>) of three servers: <code>Venus</code>, <code>Mars</code>, <code>Saturn</code> and want to distinguish from which server the inserted value is originated.
      </p><p>
        The simpliest solution for this issue would be to assign sequence of <code>1, 4, 7, 10, ...</code> values to the rows, inserted on <code>Venus</code>; sequence of <code>2, 5, 8, 11, ...</code> to the rows, inserted on <code>Mars</code> and sequence of <code>3, 6, 9, 12, ...</code> for the rows, inserted on <code>Saturn</code>.
      </p><p>
        To do it set the value of the system variable <code>auto_increment_increment</code> to the number of servers: in our case three (3), so MySQL will increment sequence value by three. Then set <code>auto_increment_offset</code> to one (1) on <code>Venus</code>, to two (2) on <code>Mars</code> and to three (3) on <code>Saturn</code>. This will instruct MySQL to start new sequences from the specified values.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">Venus</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SET</code><code> </code><code class="n">auto_increment_offset</code><code class="o">=</code><code class="mi">1</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Venus</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SET</code><code> </code><code class="n">auto_increment_increment</code><code class="o">=</code><code class="mi">3</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Mars</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SET</code><code> </code><code class="n">auto_increment_offset</code><code class="o">=</code><code class="mi">2</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Mars</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SET</code><code> </code><code class="n">auto_increment_increment</code><code class="o">=</code><code class="mi">3</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Saturn</code><code class="o">&gt;</code><code> </code><strong><code class="k">SET</code><code> </code><code class="n">auto_increment_offset</code><code class="o">=</code><code class="mi">3</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Saturn</code><code class="o">&gt;</code><code> </code><strong><code class="k">SET</code><code> </code><code class="n">auto_increment_increment</code><code class="o">=</code><code class="mi">3</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>
          We set session variables for our example, but if you want to affect not only your own session, but all connections on the server you need to use <span class="command"><em>SET GLOBAL</em></span>. To preserve configuration change after restart set these value in the configuration file, or, starting from the version 8.0, use command <span class="command"><em>SET PERSIST</em></span>.
        </p></div><p>
        If you already have tables with an auto-increment column, specify the offset using statement:
        </p><pre data-type="programlisting" data-code-language="sql">ALTER TABLE <em><code>mytable</code></em> AUTO_INCREMENT = <em><code>N</code></em>;</pre><p>
      </p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>
          Not all engines support option <code>AUTO_INCREMENT</code> for the <span class="command"><em>CREATE TABLE</em></span> and <span class="command"><em>ALTER TABLE</em></span>. In this case you can set starting value for the auto-incremented column by inserting a row with the desired value, then removing it.
        </p></div><p>
        After preparations are done MySQL will use <code>auto_increment_increment</code> value to generate the next sequence number.
      </p><p>
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">Venus</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="k">offset</code><code class="p">(</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="n">id</code><code> </code><code class="nb">INT</code><code> </code><code class="k">NOT</code><code> </code><code class="k">NULL</code><code> </code><code class="n">AUTO_INCREMENT</code><code> </code><code class="k">PRIMARY</code><code> </code><code class="k">KEY</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">host</code><code> </code><code class="nb">CHAR</code><code class="p">(</code><code class="mi">32</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">03</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Venus</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="k">offset</code><code class="p">(</code><code class="k">host</code><code class="p">)</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="o">@</code><code class="o">@</code><code class="n">hostname</code><code class="p">)</code><code class="p">;</code></strong><code> </code><a class="co" id="co_nch-sequences-seq-increment_increment-hostname_co" href="#callout_nch-sequences-seq-increment_increment-hostname_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Venus</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="k">offset</code><code class="p">(</code><code class="k">host</code><code class="p">)</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="o">@</code><code class="o">@</code><code class="n">hostname</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Venus</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="k">offset</code><code class="p">(</code><code class="k">host</code><code class="p">)</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="o">@</code><code class="o">@</code><code class="n">hostname</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Venus</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="k">offset</code><code class="p">;</code></strong><code> </code><a class="co" id="co_nch-sequences-seq-increment_increment-venus_co" href="#callout_nch-sequences-seq-increment_increment-venus_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="o">+</code><code class="c1">----+-------+
</code><code class="o">|</code><code> </code><code class="n">id</code><code> </code><code class="o">|</code><code> </code><code class="k">host</code><code>  </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----+-------+
</code><code class="o">|</code><code>  </code><code class="mi">1</code><code> </code><code class="o">|</code><code> </code><code class="n">Venus</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>  </code><code class="mi">4</code><code> </code><code class="o">|</code><code> </code><code class="n">Venus</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>  </code><code class="mi">7</code><code> </code><code class="o">|</code><code> </code><code class="n">Venus</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----+-------+
</code><code class="mi">3</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Mars</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">ALTER</code><code> </code><code class="k">TABLE</code><code> </code><code class="k">offset</code><code> </code><code class="n">AUTO_INCREMENT</code><code class="o">=</code><code class="mi">2</code><code class="p">;</code><code> </code></strong><code> </code><a class="co" id="co_nch-sequences-seq-increment_increment-alter_co" href="#callout_nch-sequences-seq-increment_increment-alter_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">36</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code><code>


</code><code class="n">Mars</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="k">offset</code><code class="p">(</code><code class="k">host</code><code class="p">)</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="s1">'Mars'</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Mars</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="k">offset</code><code class="p">(</code><code class="k">host</code><code class="p">)</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="s1">'Mars'</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">Mars</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="k">offset</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----+-------+
</code><code class="o">|</code><code> </code><code class="n">id</code><code> </code><code class="o">|</code><code> </code><code class="k">host</code><code>  </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----+-------+
</code><code class="o">|</code><code>  </code><code class="mi">1</code><code> </code><code class="o">|</code><code> </code><code class="n">Venus</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>  </code><code class="mi">4</code><code> </code><code class="o">|</code><code> </code><code class="n">Venus</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>  </code><code class="mi">7</code><code> </code><code class="o">|</code><code> </code><code class="n">Venus</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>  </code><code class="mi">8</code><code> </code><code class="o">|</code><code> </code><code class="n">Mars</code><code>  </code><code class="o">|</code><code>  </code><a class="co" id="co_nch-sequences-seq-increment_increment-mars_co" href="#callout_nch-sequences-seq-increment_increment-mars_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="o">|</code><code> </code><code class="mi">11</code><code> </code><code class="o">|</code><code> </code><code class="n">Mars</code><code>  </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----+-------+
</code><code class="mi">5</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>

      </p><dl class="calloutlist"><dt><a class="co" id="callout_nch-sequences-seq-increment_increment-hostname_co" href="#co_nch-sequences-seq-increment_increment-hostname_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>System variable <code>hostname</code> contains value of the MySQL host. We use it to distinguish machines.</p></dd><dt><a class="co" id="callout_nch-sequences-seq-increment_increment-venus_co" href="#co_nch-sequences-seq-increment_increment-venus_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>On <code>Venus</code> sequence starts from one and we have expected values: <code>1, 4, 7</code>.</p></dd><dt><a class="co" id="callout_nch-sequences-seq-increment_increment-alter_co" href="#co_nch-sequences-seq-increment_increment-alter_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>Table on <code>Mars</code> already existed. The <span class="command"><em>ALTER TABLE</em></span> command sets offset for the <code>AUTO_INCREMENT</code> sequence to the desired value.</p></dd><dt><a class="co" id="callout_nch-sequences-seq-increment_increment-mars_co" href="#co_nch-sequences-seq-increment_increment-mars_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt><dd><p>Since table <code>offset</code> already had rows on Mars new <code>AUTO_INCREMENT</code> value started from 8 that belongs to the sequence <code>2, 5, 8, 11, ...</code>.</p></dd></dl><p>
    </p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.15 Using Window Functions to Number Rows In the Result Set"><div class="sect1" id="nch-sequences-seq-window-functions"><h1>15.15 Using Window Functions to Number Rows In the Result Set</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820344317536"><h2>Problem</h2><p>
        You want to enumerate the result of a <code>SELECT</code> query.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820344316144"><h2>Solution</h2><p>
        Use the window function <code>ROW_NUMBER()</code>.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820344314752"><h2>Discussion</h2><p>
        Sequences are useful not only when you store data in tables, but also when you work with results of queries.
      </p><p>
        Suppose you are running a singing competition. Each talent should present in its turn. To provide everyone equal chances the position in the queue should be defined randomly.
      </p><p>
        Talents are stored in the <code>name</code> table. To retrieve them in random order use function <span class="command"><em>RAND()</em></span>:
        </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code> </code><code class="k">FROM</code><code> </code><code class="n">name</code><code> </code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">RAND</code><code class="p">(</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">------------+-----------+
</code><code class="o">|</code><code> </code><code class="n">first_name</code><code> </code><code class="o">|</code><code> </code><code class="n">last_name</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">------------+-----------+
</code><code class="o">|</code><code> </code><code class="n">Pete</code><code>       </code><code class="o">|</code><code> </code><code class="n">Gray</code><code>      </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">Vida</code><code>       </code><code class="o">|</code><code> </code><code class="n">Blue</code><code>      </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">Rondell</code><code>    </code><code class="o">|</code><code> </code><code class="n">White</code><code>     </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">Kevin</code><code>      </code><code class="o">|</code><code> </code><code class="n">Brown</code><code>     </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">Devon</code><code>      </code><code class="o">|</code><code> </code><code class="n">White</code><code>     </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">------------+-----------+
</code><code class="mi">5</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      </p><p>
        This query will return list of names in different orders each time it is called.
      </p><p>
        Window functions can perform calculations per each row in the result set and we can use them to create a new column with order in which the singers will perform.
      </p><p>
        Window functions work over a specific window that in our case is a <code>SELECT</code> query. They may access multiple rows while are executing but produce result for each row in the window.
        </p><pre data-type="programlisting" data-code-language="sql">mysql&gt; <strong> SELECT</strong>
    -&gt; <strong> ROW_NUMBER() OVER <em><code>win</code></em> AS turn,</strong> <a class="co" id="co_nch-sequences-seq-window-functions-over_co" href="#callout_nch-sequences-seq-window-functions-over_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a>
    -&gt; <strong> first_name, last_name FROM name </strong> <a class="co" id="co_nch-sequences-seq-window-functions-table_co" href="#callout_nch-sequences-seq-window-functions-table_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a>
    -&gt; <strong> WINDOW <em><code>win</code></em></strong> <a class="co" id="co_nch-sequences-seq-window-functions-window_co" href="#callout_nch-sequences-seq-window-functions-window_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a>
    -&gt; <strong> AS (ORDER BY RAND());</strong> <a class="co" id="co_nch-sequences-seq-window-functions-order_co" href="#callout_nch-sequences-seq-window-functions-order_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a>
+------+------------+-----------+
| turn | first_name | last_name |
+------+------------+-----------+
|    1 | Devon      | White     |
|    2 | Kevin      | Brown     |
|    3 | Rondell    | White     |
|    4 | Vida       | Blue      |
|    5 | Pete       | Gray      |
+------+------------+-----------+
5 rows in set (0.00 sec)</pre><p>

        </p><dl class="calloutlist"><dt><a class="co" id="callout_nch-sequences-seq-window-functions-over_co" href="#co_nch-sequences-seq-window-functions-over_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>Function <span class="command"><em>ROW_NUMBER()</em></span> defines the position in the singing schedule.</p></dd><dt><a class="co" id="callout_nch-sequences-seq-window-functions-table_co" href="#co_nch-sequences-seq-window-functions-table_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>Other columns in the table <code>name</code> which we want to see in the query result.</p></dd><dt><a class="co" id="callout_nch-sequences-seq-window-functions-window_co" href="#co_nch-sequences-seq-window-functions-window_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>Keyword <code>WINDOW</code> defines named window over which we will use the function <span class="command"><em>ROW_NUMBER</em></span>.</p></dd><dt><a class="co" id="callout_nch-sequences-seq-window-functions-order_co" href="#co_nch-sequences-seq-window-functions-order_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt><dd><p>Sort the window in random order to get fair queue distribution.</p></dd></dl><p>
      </p><p>
        Another common use of the function <span class="command"><em>ROW_NUMBER()</em></span> is to generate a sequence of identifiers that later could be used to join <code>SELECT</code> result with the another table. We discuss this approach in one of examples in <a data-type="xref" href="#nch-sum-sum-recursive-cte">Recipe 15.16</a>.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820344314448"><h2>See Also</h2><p>For additional information about window functions,
      see <a href="https://dev.mysql.com/doc/refman/8.0/en/window-functions-usage.html">Window Function Concepts and Syntax</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.16 Generating Series with Recursive CTEs"><div class="sect1" id="nch-sum-sum-recursive-cte"><h1>15.16 Generating Series with Recursive CTEs</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820344074928"><h2>Problem</h2><p>
        You want to create a custom sequence, such as a geometric progression or Fibonacci number.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820344073920"><h2>Solution</h2><p>
        Use recursive Commont Table Expressions (CTEs) to create the sequence from the custom formula.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820344072912"><h2>Discussion</h2><p>
        Sequences should not always be an arithmetic progression. They could be any kind of progression and even random numbers or strings.
      </p><p>
        One way to create custom sequences is recursive CTE. They are named temporary result sets that allow self-referencing. Basic recursive CTE syntax is:
        </p><pre data-type="programlisting" data-code-language="sql">WITH RECURSIVE <em><code>name</code></em>(<em><code>column</code></em>[, <em><code>column</code></em>])
(SELECT <em><code>expressin</code></em>[, <em><code>expression</code></em>]
UNION ALL 
SELECT <em><code>expressin</code></em>[, <em><code>expression</code></em>]
FROM name WHERE ...)
SELECT * FROM name;</pre><p>
      </p><p>
        Thus, to generate a geometric progression starting from two with a common ratio two use CTE as follow.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">WITH</code><code> </code><code class="k">RECURSIVE</code><code> </code><code class="n">geometric_progression</code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code> </code><code class="k">AS</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="p">(</code><code class="k">SELECT</code><code> </code><code class="mi">2</code></strong><code> </code><a class="co" id="co_nch-sum-sum-recursive-cte-init_co" href="#callout_nch-sum-sum-recursive-cte-init_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">UNION</code><code> </code><code class="k">ALL</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="n">id</code><code> </code><code class="o">*</code><code> </code><code class="mi">2</code></strong><code> </code><a class="co" id="co_nch-sum-sum-recursive-cte-next_co" href="#callout_nch-sum-sum-recursive-cte-next_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">FROM</code><code> </code><code class="n">geometric_progression</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">5</code><code class="p">)</code></strong><code> </code><a class="co" id="co_nch-sum-sum-recursive-cte-limit_co" href="#callout_nch-sum-sum-recursive-cte-limit_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">geometric_progression</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">------+
</code><code class="o">|</code><code> </code><code class="n">id</code><code>   </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">------+
</code><code class="o">|</code><code>    </code><code class="mi">2</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>    </code><code class="mi">4</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>    </code><code class="mi">8</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>   </code><code class="mi">16</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>   </code><code class="mi">32</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">------+
</code><code class="mi">5</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        </p><dl class="calloutlist"><dt><a class="co" id="callout_nch-sum-sum-recursive-cte-init_co" href="#co_nch-sum-sum-recursive-cte-init_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>Starting value for the sequence.</p></dd><dt><a class="co" id="callout_nch-sum-sum-recursive-cte-next_co" href="#co_nch-sum-sum-recursive-cte-next_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>All subsequent values in the geometric progression are previous number multiplied by the common ratio.</p></dd><dt><a class="co" id="callout_nch-sum-sum-recursive-cte-limit_co" href="#co_nch-sum-sum-recursive-cte-limit_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>To limit number of the generated numbers and avoid infinite loops use either <code>LIMIT</code> clause or any valid <code>WHERE</code> condition.</p></dd></dl><p>
      </p><p>
        Recursive CTEs allow to create multiple sequences at the same time. For example, we can use them to create:
        </p><ul class="simplelist"><li>An id that will use regular arithmetic progression, starting from one with a common difference one</li><li>A geometric progression, starting from three with a common ratio four</li><li>A random number between one and five</li></ul><p>
        To create all these in a single query use a recursive CTE as follow.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">WITH</code><code> </code><code class="k">RECURSIVE</code><code> </code><code class="n">sequences</code><code class="p">(</code><code class="n">id</code><code class="p">,</code><code> </code><code class="n">geo</code><code class="p">,</code><code> </code><code class="n">random</code><code class="p">)</code><code> </code><code class="k">AS</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="p">(</code><code class="k">SELECT</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">,</code><code> </code><code class="n">FLOOR</code><code class="p">(</code><code class="mi">1</code><code class="o">+</code><code class="n">RAND</code><code class="p">(</code><code class="p">)</code><code class="o">*</code><code class="mi">5</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">UNION</code><code> </code><code class="k">ALL</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="n">id</code><code> </code><code class="o">+</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">geo</code><code> </code><code class="o">*</code><code> </code><code class="mi">4</code><code class="p">,</code><code> </code><code class="n">FLOOR</code><code class="p">(</code><code class="mi">1</code><code class="o">+</code><code class="n">RAND</code><code class="p">(</code><code class="p">)</code><code class="o">*</code><code class="mi">5</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">FROM</code><code> </code><code class="n">sequences</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">WHERE</code><code> </code><code class="n">id</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">5</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">sequences</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">------+------+--------+
</code><code class="o">|</code><code> </code><code class="n">id</code><code>   </code><code class="o">|</code><code> </code><code class="n">geo</code><code>  </code><code class="o">|</code><code> </code><code class="n">random</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">------+------+--------+
</code><code class="o">|</code><code>    </code><code class="mi">1</code><code> </code><code class="o">|</code><code>    </code><code class="mi">3</code><code> </code><code class="o">|</code><code>      </code><code class="mi">4</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>    </code><code class="mi">2</code><code> </code><code class="o">|</code><code>   </code><code class="mi">12</code><code> </code><code class="o">|</code><code>      </code><code class="mi">4</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>    </code><code class="mi">3</code><code> </code><code class="o">|</code><code>   </code><code class="mi">48</code><code> </code><code class="o">|</code><code>      </code><code class="mi">2</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>    </code><code class="mi">4</code><code> </code><code class="o">|</code><code>  </code><code class="mi">192</code><code> </code><code class="o">|</code><code>      </code><code class="mi">2</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>    </code><code class="mi">5</code><code> </code><code class="o">|</code><code>  </code><code class="mi">768</code><code> </code><code class="o">|</code><code>      </code><code class="mi">3</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">------+------+--------+
</code><code class="mi">5</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      </p><p>
        To illustrate use of the custom sequence suppose that we are working on a new Data Phobia vaccine and want to start phase III trials on it. Phase III includes testing of the real vaccine and a placebo. Doses are distributed randomly between volunteers. To perform this trial we will use table <code>patients</code> and those who do not have diagnosis of Data Phobia already. We generate a sequence of two random values and assign either a real vaccine or a placebo based on that.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">WITH</code><code> </code><code class="k">RECURSIVE</code><code> </code><code class="n">trial</code><code class="p">(</code><code class="n">id</code><code class="p">,</code><code> </code><code class="n">dose</code><code class="p">)</code><code> </code><code class="k">AS</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="p">(</code><code class="k">SELECT</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">IF</code><code class="p">(</code><code class="mi">1</code><code class="o">=</code><code class="n">FLOOR</code><code class="p">(</code><code class="mi">1</code><code class="o">+</code><code class="n">RAND</code><code class="p">(</code><code class="p">)</code><code class="o">*</code><code class="mi">2</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'Vaccine'</code><code class="p">,</code><code> </code><code class="s1">'Placebo'</code><code class="p">)</code></strong><code> </code><a class="co" id="co_nch-sum-sum-recursive-cte-options_co" href="#callout_nch-sum-sum-recursive-cte-options_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code>  </code><code class="k">UNION</code><code> </code><code class="k">ALL</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code>  </code><code class="k">SELECT</code><code> </code><code class="n">id</code><code class="o">+</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">IF</code><code class="p">(</code><code class="mi">1</code><code class="o">=</code><code class="n">FLOOR</code><code class="p">(</code><code class="mi">1</code><code class="o">+</code><code class="n">RAND</code><code class="p">(</code><code class="p">)</code><code class="o">*</code><code class="mi">2</code><code class="p">)</code><code class="p">,</code><code> </code><code class="s1">'Vaccine'</code><code class="p">,</code><code> </code><code class="s1">'Placebo'</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code>    </code><code class="k">FROM</code><code> </code><code class="n">trial</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code>    </code><code class="k">WHERE</code><code> </code><code class="n">id</code><code> </code><code class="o">&lt;</code><code> </code><code class="p">(</code><code class="k">SELECT</code><code> </code><code class="k">COUNT</code><code class="p">(</code><code class="o">*</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">patients</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code>                   </code><code class="k">WHERE</code><code> </code><code class="n">diagnosis</code><code> </code><code class="o">!</code><code class="o">=</code><code> </code><code class="s1">'Data Phobia'</code><code> </code><code class="k">and</code><code> </code><code class="k">result</code><code> </code><code class="o">!</code><code class="o">=</code><code> </code><code class="s1">'D'</code><code class="p">)</code><code class="p">)</code><code class="p">,</code></strong><code> </code><a class="co" id="co_nch-sum-sum-recursive-cte-count_co" href="#callout_nch-sum-sum-recursive-cte-count_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code>  </code><code class="n">volunteers</code><code> </code><code class="k">AS</code></strong><code> </code><a class="co" id="co_nch-sum-sum-recursive-cte-volunteers_co" href="#callout_nch-sum-sum-recursive-cte-volunteers_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="p">(</code><code class="k">SELECT</code><code> </code><code class="n">ROW_NUMBER</code><code class="p">(</code><code class="p">)</code><code> </code><code class="n">OVER</code><code> </code><code class="n">win</code><code> </code><code class="k">AS</code><code> </code><code class="n">id</code><code class="p">,</code></strong><code> </code><a class="co" id="co_nch-sum-sum-recursive-cte-rownumber_co" href="#callout_nch-sum-sum-recursive-cte-rownumber_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code>         </code><code class="n">national_id</code><code class="p">,</code><code> </code><code class="n">name</code><code class="p">,</code><code> </code><code class="n">surname</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code>  </code><code class="k">FROM</code><code> </code><code class="n">patients</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">diagnosis</code><code> </code><code class="o">!</code><code class="o">=</code><code> </code><code class="s1">'Data Phobia'</code><code> </code><code class="k">and</code><code> </code><code class="k">result</code><code> </code><code class="o">!</code><code class="o">=</code><code> </code><code class="s1">'D'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="n">WINDOW</code><code> </code><code class="n">win</code><code> </code><code class="k">AS</code><code> </code><code class="p">(</code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">surname</code><code class="p">)</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="n">national_id</code><code class="p">,</code><code> </code><code class="n">name</code><code class="p">,</code><code> </code><code class="n">surname</code><code class="p">,</code><code> </code><code class="n">dose</code></strong><code> </code><a class="co" id="co_nch-sum-sum-recursive-cte-join_co" href="#callout_nch-sum-sum-recursive-cte-join_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">FROM</code><code> </code><code class="n">trial</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">volunteers</code><code> </code><code class="k">USING</code><code class="p">(</code><code class="n">id</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">-------------+-----------+-----------+---------+
</code><code class="o">|</code><code> </code><code class="n">national_id</code><code> </code><code class="o">|</code><code> </code><code class="n">name</code><code>      </code><code class="o">|</code><code> </code><code class="n">surname</code><code>   </code><code class="o">|</code><code> </code><code class="n">dose</code><code>    </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">-------------+-----------+-----------+---------+
</code><code class="o">|</code><code> </code><code class="mi">84</code><code class="n">DC051879</code><code>  </code><code class="o">|</code><code> </code><code class="n">William</code><code>   </code><code class="o">|</code><code> </code><code class="n">Brown</code><code>     </code><code class="o">|</code><code> </code><code class="n">Vaccine</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">78</code><code class="n">FS043029</code><code>  </code><code class="o">|</code><code> </code><code class="n">David</code><code>     </code><code class="o">|</code><code> </code><code class="n">Davis</code><code>     </code><code class="o">|</code><code> </code><code class="n">Vaccine</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">38</code><code class="n">BP394037</code><code>  </code><code class="o">|</code><code> </code><code class="n">Catherine</code><code> </code><code class="o">|</code><code> </code><code class="n">Hernandez</code><code> </code><code class="o">|</code><code> </code><code class="n">Placebo</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">28</code><code class="n">VU492728</code><code>  </code><code class="o">|</code><code> </code><code class="n">Alice</code><code>     </code><code class="o">|</code><code> </code><code class="n">Jackson</code><code>   </code><code class="o">|</code><code> </code><code class="n">Vaccine</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">71</code><code class="n">GE601633</code><code>  </code><code class="o">|</code><code> </code><code class="n">John</code><code>      </code><code class="o">|</code><code> </code><code class="n">Johnson</code><code>   </code><code class="o">|</code><code> </code><code class="n">Vaccine</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">09</code><code class="n">SK434607</code><code>  </code><code class="o">|</code><code> </code><code class="n">Richard</code><code>   </code><code class="o">|</code><code> </code><code class="n">Martin</code><code>    </code><code class="o">|</code><code> </code><code class="n">Placebo</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">30</code><code class="n">NC108735</code><code>  </code><code class="o">|</code><code> </code><code class="n">Robert</code><code>    </code><code class="o">|</code><code> </code><code class="n">Martinez</code><code>  </code><code class="o">|</code><code> </code><code class="n">Placebo</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">02</code><code class="n">WS884704</code><code>  </code><code class="o">|</code><code> </code><code class="n">Sarah</code><code>     </code><code class="o">|</code><code> </code><code class="n">Miller</code><code>    </code><code class="o">|</code><code> </code><code class="n">Placebo</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">45</code><code class="n">MY529190</code><code>  </code><code class="o">|</code><code> </code><code class="n">Patricia</code><code>  </code><code class="o">|</code><code> </code><code class="n">Rodriguez</code><code> </code><code class="o">|</code><code> </code><code class="n">Vaccine</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">89</code><code class="n">AR642465</code><code>  </code><code class="o">|</code><code> </code><code class="n">Mary</code><code>      </code><code class="o">|</code><code> </code><code class="n">Smith</code><code>     </code><code class="o">|</code><code> </code><code class="n">Placebo</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">99</code><code class="n">XC682639</code><code>  </code><code class="o">|</code><code> </code><code class="n">Emma</code><code>      </code><code class="o">|</code><code> </code><code class="n">Taylor</code><code>    </code><code class="o">|</code><code> </code><code class="n">Vaccine</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">04</code><code class="n">WT954962</code><code>  </code><code class="o">|</code><code> </code><code class="n">Peter</code><code>     </code><code class="o">|</code><code> </code><code class="n">Wilson</code><code>    </code><code class="o">|</code><code> </code><code class="n">Vaccine</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">-------------+-----------+-----------+---------+
</code><code class="mi">12</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        </p><dl class="calloutlist"><dt><a class="co" id="callout_nch-sum-sum-recursive-cte-options_co" href="#co_nch-sum-sum-recursive-cte-options_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>Function <span class="command"><em>FLOOR(1+RAND()*2)</em></span> generates two random numbers: one or two. Function <span class="command"><em>IF</em></span> works as a ternary operator: if the first argument is true it returns the second one, otherwise it returns the third argument.</p></dd><dt><a class="co" id="callout_nch-sum-sum-recursive-cte-count_co" href="#co_nch-sum-sum-recursive-cte-count_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>We do not want patients who already diagnosed with Data Phobia to participate in our tests as well as we cannot test our vaccine on the patients who did not recover.</p></dd><dt><a class="co" id="callout_nch-sum-sum-recursive-cte-volunteers_co" href="#co_nch-sum-sum-recursive-cte-volunteers_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>While the table <code>patients</code> has an <code>AUTO_INCREMENT</code> column <code>id</code> we cannot use it, because we could not excude patients that do not participate in our tests this way. Therefore we use CTE to create named result set <code>volunteers</code> and generate its own sequence for it.</p></dd><dt><a class="co" id="callout_nch-sum-sum-recursive-cte-rownumber_co" href="#co_nch-sum-sum-recursive-cte-rownumber_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt><dd><p>The function <span class="command"><em>ROW_NUMBER()</em></span> generates new sequence for the patients who participate in the tests. </p></dd><dt><a class="co" id="callout_nch-sum-sum-recursive-cte-join_co" href="#co_nch-sum-sum-recursive-cte-join_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt><dd><p>Join generated sequence of random values for the dose and named result set <code>volunteers</code> using generated <code>id</code> without including it into the final result set.</p></dd></dl><p>
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820344072608"><h2>See Also</h2><p>For additional information about Common Table Expressions, see <a data-type="xref" href="ch10.xhtml#nch-sum-sum-with">Recipe 10.18</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="15.17 Creating and Storing Custom Sequences"><div class="sect1" id="nch-sequences-seq-custom"><h1>15.17 Creating and Storing Custom Sequences</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820343061424"><h2>Problem</h2><p>
        You want to use custom sequence as a stored id column in the table.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820343060448"><h2>Solution</h2><p>
        Create a table that will hold sequence values and a function that will update and select these values.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820343059376"><h2>Discussion</h2><p>
        Although MySQL does not support the SQL <code>SEQUENCE</code> object, it is pretty easy to imitate one.
      </p><p>
        First you need to create a table that will hold sequences.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="o">`</code><code class="n">sequences</code><code class="o">`</code> <code class="p">(</code>
  <code class="o">`</code><code class="n">sequence_name</code><code class="o">`</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">64</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="o">`</code><code class="n">maximum_value</code><code class="o">`</code> <code class="nb">bigint</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">DEFAULT</code> <code class="s1">'9223372036854775807'</code><code class="p">,</code>
  <code class="o">`</code><code class="n">minimum_value</code><code class="o">`</code> <code class="nb">bigint</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">DEFAULT</code> <code class="s1">'-9223372036854775808'</code><code class="p">,</code>
  <code class="o">`</code><code class="k">increment</code><code class="o">`</code> <code class="nb">bigint</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">DEFAULT</code> <code class="s1">'1'</code><code class="p">,</code>
  <code class="o">`</code><code class="n">start_value</code><code class="o">`</code> <code class="nb">bigint</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">DEFAULT</code> <code class="s1">'-9223372036854775808'</code><code class="p">,</code>
  <code class="o">`</code><code class="n">current_base_value</code><code class="o">`</code> <code class="nb">bigint</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">DEFAULT</code> <code class="s1">'-9223372036854775808'</code><code class="p">,</code>
  <code class="o">`</code><code class="n">cycle_option</code><code class="o">`</code> <code class="n">enum</code><code class="p">(</code><code class="s1">'yes'</code><code class="p">,</code><code class="s1">'no'</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">DEFAULT</code> <code class="s1">'no'</code><code class="p">,</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="o">`</code><code class="n">sequence_name</code><code class="o">`</code><code class="p">)</code>
<code class="p">)</code> <code class="n">ENGINE</code><code class="o">=</code><code class="n">InnoDB</code> <code class="k">DEFAULT</code> <code class="n">CHARSET</code><code class="o">=</code><code class="n">utf8mb4</code> <code class="k">COLLATE</code><code class="o">=</code><code class="n">utf8mb4_0900_ai_ci</code><code class="p">;</code></pre><p>
       For this recipe we used the same table definition that the MySQL Engineering Team is planning to implement as part of <a href="https://dev.mysql.com/worklog/task/?id=827">WL#827: SEQUENCE object as in Oracle, PostgreSQL, and/or SQL:2003 </a>. This definition is not required for real-life sequence implementation that could be either simpler or have more options.
      </p><p>
        Columns in the table <code>sequences</code> all have special meanings. <a data-type="xref" href="#nch-sequences-seq-custom-sequences">Table 15-1</a> shows their meanings.        
      </p><table id="nch-sequences-seq-custom-sequences"><caption><span class="label">Table 15-1. </span>Columns in the table <code>sequences</code></caption><thead><tr><th>Column</th><th>Description</th><th>Comments</th></tr></thead><tbody><tr><td><code>sequence_name</code></td><td>Name of the sequence.</td><td>Required field, should be unique.</td></tr><tr><td><code>maximum_value</code></td><td>Maximum value that the sequence can generate.</td><td>We allow negative values in our custom sequence, therefore maximum possible value is 9223372036854775807 that is the maximum value for the <code>BIGINT SIGNED</code> datatype. If you make this column <code>BIGINT UNSIGNED</code> the sequence could have two times more values. This option is not critical for the sequence generation and could be skipped.</td></tr><tr><td><code>minimum_value</code></td><td>Minimum value for the sequence.</td><td>In our case default is -9223372036854775808 that is the minimum for the type <code>BIGINT SIGNED</code>. Depending on how you want to create custom sequences this column could be skipped or have different type or different default value.</td></tr><tr><td><code>increment</code></td><td>Increment for the sequence.</td><td>
              <p>SQL standard defines sequence that use arithmetic progression. This column contains a common difference for the progression. This is required field.</p>
              <p>If you create custom sequence, such as geometric progression you may have a common ratio in this field or any other value that allows to generate the next one.</p>
            </td></tr><tr><td><code>start_value</code></td><td>The value from which the sequence will start.</td><td>This is not essential field for implemnting sentences. In our case it is <code>minimum_value</code> by default.</td></tr><tr><td><code>current_base_value</code></td><td>The value that the sequence needs to return when asked for the next value. Once returned it should be replaced with the newly generated one.</td><td>This is required field. Default is the same as <code>start_value</code>.</td></tr><tr><td><code>cycle_option</code></td><td>Does the sequence support cycles?</td><td>If enabled the sequence will reset back to <code>start_value</code> when it reaches either its <code>minimum_value</code> or <code>maximum_value</code>.</td></tr></tbody></table><p>
        Then we need to create a stored procedure that will update the table <code>sequences</code>.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">PROCEDURE</code> <code class="n">create_sequence</code><code class="p">(</code> 
    <code class="n">sequence_name</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">64</code><code class="p">),</code> <code class="n">start_value</code> <code class="nb">BIGINT</code><code class="p">,</code> <code class="k">increment</code> <code class="nb">BIGINT</code><code class="p">,</code> 
    <code class="n">cycle_option</code> <code class="n">ENUM</code><code class="p">(</code><code class="s1">'yes'</code><code class="p">,</code><code class="s1">'no'</code><code class="p">),</code> <code class="n">maximum_value</code> <code class="nb">BIGINT</code><code class="p">,</code> <code class="n">minimum_value</code> <code class="nb">BIGINT</code><code class="p">)</code> 
<code class="k">BEGIN</code> 
    <code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">sequences</code> 
        <code class="p">(</code><code class="n">sequence_name</code><code class="p">,</code> <code class="n">maximum_value</code><code class="p">,</code> <code class="n">minimum_value</code><code class="p">,</code> <code class="k">increment</code><code class="p">,</code> <code class="n">start_value</code><code class="p">,</code> 
         <code class="n">current_base_value</code><code class="p">,</code> <code class="n">cycle_option</code><code class="p">)</code> 
        <code class="k">VALUES</code><code class="p">(</code>
            <code class="n">sequence_name</code><code class="p">,</code> 
            <code class="n">COALESCE</code><code class="p">(</code><code class="n">maximum_value</code><code class="p">,</code> <code class="mi">9223372036854775807</code><code class="p">),</code> 
            <code class="n">COALESCE</code><code class="p">(</code><code class="n">minimum_value</code><code class="p">,</code> <code class="o">-</code><code class="mi">9223372036854775808</code><code class="p">),</code> 
            <code class="n">COALESCE</code><code class="p">(</code><code class="k">increment</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code> 
            <code class="n">COALESCE</code><code class="p">(</code><code class="n">start_value</code><code class="p">,</code> <code class="o">-</code><code class="mi">9223372036854775808</code><code class="p">),</code> 
            <code class="n">COALESCE</code><code class="p">(</code><code class="n">start_value</code><code class="p">,</code> <code class="o">-</code><code class="mi">9223372036854775808</code><code class="p">),</code> 
            <code class="n">COALESCE</code><code class="p">(</code><code class="n">cycle_option</code><code class="p">,</code> <code class="s1">'no'</code><code class="p">));</code>
<code class="k">END</code><code class="p">;</code></pre><p>
      </p><div data-type="note" epub:type="note"><h6>Note</h6><p>
          Using stored routines, rather than updating the table <code>sequences</code> directly, has a number of advantages:
          </p><ul><li><p>You do not need to care on how to update the <code>current_base_value</code> each time you use the sequence.</p></li><li><p>If <code>cycle_option</code> is enabled you do not need to put code, resetting the <code>current_base_value</code> each time when the sequence boundaries are reached.</p></li><li><p>You may restrict direct access to the table <code>sequences</code> for anyone, except the administrator while still allow application users to use sequences. See <a data-type="xref" href="ch24.xhtml#nch-security-security-routines">Recipe 24.13</a> for the details.</p></li></ul><p>
        </p></div><p>
        MySQL does not allow us to call a stored function with a variable number of arguments. The function <span class="command"><em>COALESCE</em></span> allows to put defaults if <code>NULL</code> values are passed in the places of the arguments for which you want to have default values.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">CALL</code><code> </code><code class="n">create_sequence</code><code class="p">(</code><code class="s1">'bar'</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="s1">'no'</code><code class="p">,</code><code> </code><code class="mi">9223372036854775807</code><code class="p">,</code><code> </code><code class="o">-</code><code class="mi">9223372036854775808</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">CALL</code><code> </code><code class="n">create_sequence</code><code class="p">(</code><code class="s1">'baz'</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="s1">'yes'</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">call</code><code> </code><code class="n">create_sequence</code><code class="p">(</code><code class="s1">'foo'</code><code class="p">,</code><code class="k">null</code><code class="p">,</code><code class="k">null</code><code class="p">,</code><code class="k">null</code><code class="p">,</code><code> </code><code class="k">null</code><code class="p">,</code><code> </code><code class="k">null</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">sequences</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
     </code><code class="n">sequence_name</code><code class="p">:</code><code> </code><code class="n">bar</code><code>
     </code><code class="n">maximum_value</code><code class="p">:</code><code> </code><code class="mi">9223372036854775807</code><code>
     </code><code class="n">minimum_value</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
         </code><code class="k">increment</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
       </code><code class="n">start_value</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
</code><code class="n">current_base_value</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
      </code><code class="n">cycle_option</code><code class="p">:</code><code> </code><code class="k">no</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
     </code><code class="n">sequence_name</code><code class="p">:</code><code> </code><code class="n">baz</code><code>
     </code><code class="n">maximum_value</code><code class="p">:</code><code> </code><code class="mi">10</code><code>
     </code><code class="n">minimum_value</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
         </code><code class="k">increment</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
       </code><code class="n">start_value</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
</code><code class="n">current_base_value</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
      </code><code class="n">cycle_option</code><code class="p">:</code><code> </code><code class="n">yes</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">3</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
     </code><code class="n">sequence_name</code><code class="p">:</code><code> </code><code class="n">foo</code><code>
     </code><code class="n">maximum_value</code><code class="p">:</code><code> </code><code class="mi">9223372036854775807</code><code>
     </code><code class="n">minimum_value</code><code class="p">:</code><code> </code><code class="o">-</code><code class="mi">9223372036854775808</code><code>
         </code><code class="k">increment</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
       </code><code class="n">start_value</code><code class="p">:</code><code> </code><code class="o">-</code><code class="mi">9223372036854775808</code><code>
</code><code class="n">current_base_value</code><code class="p">:</code><code> </code><code class="o">-</code><code class="mi">9223372036854775808</code><code>
      </code><code class="n">cycle_option</code><code class="p">:</code><code> </code><code class="k">no</code><code>
</code><code class="mi">3</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        In the example above we first created sequence <code>bar</code> that starts from 1, increments by 1, does not have cycle option and has default <code>maximum_value</code> 9223372036854775807. Then, we created the sequence <code>baz</code>, that also starts from 1, increments by 1, but has <code>cycle_option</code> enabled and <code>maximum_value</code> 10, so it cycles quite fast. Finally, we created sequence <code>foo</code> that has only custom name and all other defaults.
      </p><p>
        To get the next sequnece value and update the sequence table at the same time we will use a stored function.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">FUNCTION</code> <code class="n">sequence_next_value</code><code class="p">(</code><code class="n">name</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">64</code><code class="p">))</code> <code class="k">RETURNS</code> <code class="nb">BIGINT</code> 
<code class="k">BEGIN</code> 
    <code class="k">DECLARE</code> <code class="n">retval</code> <code class="nb">BIGINT</code><code class="p">;</code> 
    <code class="k">SELECT</code> <code class="n">current_base_value</code> <code class="k">INTO</code> <code class="n">retval</code> <code class="k">FROM</code> <code class="n">sequences</code> 
      <code class="k">WHERE</code> <code class="n">sequence_name</code><code class="o">=</code><code class="n">name</code> <code class="k">FOR</code> <code class="k">UPDATE</code><code class="p">;</code> 
    <code class="k">UPDATE</code> <code class="n">sequences</code> <code class="k">SET</code> <code class="n">current_base_value</code><code class="o">=</code>
        <code class="n">IF</code><code class="p">((</code><code class="n">current_base_value</code><code class="o">+</code><code class="k">increment</code> <code class="o">&lt;=</code> <code class="n">maximum_value</code> 
            <code class="k">AND</code> <code class="n">current_base_value</code><code class="o">+</code><code class="k">increment</code> <code class="o">&gt;=</code> <code class="n">minimum_value</code><code class="p">),</code> 
            <code class="n">current_base_value</code><code class="o">+</code><code class="k">increment</code><code class="p">,</code> 
            <code class="n">IF</code><code class="p">(</code><code class="s1">'yes'</code> <code class="o">=</code> <code class="n">cycle_option</code><code class="p">,</code> <code class="n">start_value</code><code class="p">,</code> <code class="k">NULL</code><code class="p">)</code>
        <code class="p">)</code> <code class="k">WHERE</code> <code class="n">sequence_name</code><code class="o">=</code><code class="n">name</code><code class="p">;</code>
    <code class="k">RETURN</code> <code class="n">retval</code><code class="p">;</code> 
<code class="k">END</code><code class="p">;</code></pre><p>
      </p><p>
        The function first retrieves <code>current_base_value</code> of the sequence using statement <code>SELECT ... FOR UPDATE</code>, so other connections would not modify the sequence until we return the value.
      </p><p>
        Our function supports cycles. In cases where <code>cycle_option</code> is enabled, and the next sequence value exceeds the boundaries, it sets <code>current_base_value</code> to the value, defined by the <code>start_value</code>. If <code>cycle_option</code> is disabled and the next sequence value exceeds boundaries we insert <code>NULL</code> value into the column <code>current_base_value</code> that MySQL will reject with an error. You may consider raising a custom exception instead.
      </p><p>
        To demonstrate how <code>cycle_option</code> option works let’s see how sequence <code>baz</code> behaves when its boundaries are reached.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'baz'</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="o">|</code><code> </code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'baz'</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="o">|</code><code>                         </code><code class="mi">10</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'baz'</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="o">|</code><code> </code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'baz'</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="o">|</code><code>                          </code><code class="mi">1</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'baz'</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="o">|</code><code> </code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'baz'</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="o">|</code><code>                          </code><code class="mi">2</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        To demonstrate function behavior when boundaries are reached while <code>cycle_option</code> is not enabled we created a sequence that has small maximum value.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">CALL</code><code> </code><code class="n">create_sequence</code><code class="p">(</code><code class="s1">'boo'</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="s1">'no'</code><code class="p">,</code><code> </code><code class="mi">3</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'boo'</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="o">|</code><code> </code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'boo'</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="o">|</code><code>                          </code><code class="mi">1</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'boo'</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="o">|</code><code> </code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'boo'</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="o">|</code><code>                          </code><code class="mi">2</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------------------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'boo'</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">ERROR</code><code> </code><code class="mi">1048</code><code> </code><code class="p">(</code><code class="mi">23000</code><code class="p">)</code><code class="p">:</code><code> </code><code class="k">Column</code><code> </code><code class="s1">'current_base_value'</code><code> </code><code class="n">cannot</code><code> </code><code class="n">be</code><code> </code><code class="k">null</code></pre><p>
       To use custom sequences with tables simply call <code>sequence_next_value</code> each time when you need the next sequence value.
     </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">sequence_test</code><code class="p">(</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="n">id</code><code> </code><code class="nb">BIGINT</code><code> </code><code class="k">NOT</code><code> </code><code class="k">NULL</code><code> </code><code class="k">PRIMARY</code><code> </code><code class="k">KEY</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="c1">-- other fields</code></strong><code class="c1">
</code><code>    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">04</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">CALL</code><code> </code><code class="n">create_sequence</code><code class="p">(</code><code class="s1">'sequence_test'</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">,</code><code> </code><code class="s1">'no'</code><code class="p">,</code><code> </code><code class="k">null</code><code class="p">,</code><code> </code><code class="k">null</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">sequence_test</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'sequence_test'</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">sequence_test</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'sequence_test'</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">select</code><code> </code><code class="o">*</code><code> </code><code class="k">from</code><code> </code><code class="n">sequence_test</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----+
</code><code class="o">|</code><code> </code><code class="n">id</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----+
</code><code class="o">|</code><code> </code><code class="mi">10</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">15</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----+
</code><code class="mi">2</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        You can automate sequence values generation for your tables if use triggers.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TRIGGER</code> <code class="n">sequence_test_bi</code> <code class="k">BEFORE</code> <code class="k">INSERT</code> <code class="k">ON</code> <code class="n">sequence_test</code> 
<code class="k">FOR</code> <code class="k">EACH</code> <code class="k">ROW</code> <code class="k">SET</code> <code class="k">NEW</code><code class="p">.</code><code class="n">id</code><code class="o">=</code><code class="n">IFNULL</code><code class="p">(</code><code class="k">NEW</code><code class="p">.</code><code class="n">id</code><code class="p">,</code> <code class="n">sequence_next_value</code><code class="p">(</code><code class="s1">'sequence_test'</code><code class="p">));</code></pre><p>
        In this example we generate new sequence value when a user tries to insert <code>NULL</code> into the <code>id</code> column of the table <code>sequence_test</code>. If the user, instead, decides to specify the value explicitly, the trigger would not change it. 
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">sequence_test</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">sequence_test</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="mi">13</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">select</code><code> </code><code class="o">*</code><code> </code><code class="k">from</code><code> </code><code class="n">sequence_test</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----+
</code><code class="o">|</code><code> </code><code class="n">id</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----+
</code><code class="o">|</code><code> </code><code class="mi">10</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">13</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">15</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">20</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----+
</code><code class="mi">4</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
       Finally, we need to define a stored procedure to delete the sequence when we do not need it.
     </p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">PROCEDURE</code> <code class="n">delete_sequence</code><code class="p">(</code><code class="n">name</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">64</code><code class="p">))</code> 
<code class="k">DELETE</code> <code class="k">FROM</code> <code class="n">sequences</code> <code class="k">WHERE</code> <code class="n">sequence_name</code><code class="o">=</code><code class="n">name</code><code class="p">;</code></pre><p>
       You will find code for maintaining custom sequneces in the file <code>sequences/custom_sequences.sql</code> of the <code>recipes</code> distribution.
     </p></div></section></div></section></div></section></div></body></html>