<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Doing More with MySQL"><div class="chapter" id="CH7_DOING_MORE">
<h1><span class="label">Chapter 7. </span>Doing More with MySQL</h1>


<p>MySQL is feature-rich. Over the past three chapters, you’ve seen the wide variety of techniques that can be used to query, modify, and manage data. However, there’s still much more that MySQL can do, and some of those additional features are the subject of this chapter.</p>

<p>In this chapter, you’ll learn how to:</p>

<ul>
<li>
<p>Insert data into a database from other sources, including with queries and from text files.</p>
</li>
<li>
<p>Perform updates and deletes using multiple tables in a single statement.</p>
</li>
<li>
<p>Replace data.</p>
</li>
<li>
<p>Use MySQL functions in queries to meet more complex information needs.</p>
</li>
<li>
<p>Analyze queries using the <code>EXPLAIN</code> statement and then improve their performance with simple optimization techniques.</p>
</li>
<li>
<p>Use alternative storage engines to change table properties.</p>
</li>
</ul>






<section data-type="sect1" data-pdf-bookmark="Inserting Data Using Queries"><div class="sect1" id="ADV2-SEC-INSERTQUERY">
<h1>Inserting Data Using Queries</h1>

<p>Much of the time, you’ll create tables using data from another<a data-type="indexterm" data-primary="SELECT" data-secondary="inserting data via" id="idm46177463946424"/><a data-type="indexterm" data-primary="queries" data-secondary="inserting data using" id="ch07-insq"/><a data-type="indexterm" data-primary="INSERT" data-secondary="queries to insert data" id="ch07-insq2"/><a data-type="indexterm" data-primary="tables" data-secondary="inserting data using queries" data-seealso="queries" id="ch07-insq3"/> source. The examples you saw in <a data-type="xref" href="ch03.xhtml#CH3_BASICS">Chapter 3</a> therefore illustrate only part of the problem: they show you how to insert data that’s already in the form you want (that is, formatted as a SQL <code>INSERT</code> statement). The other ways to insert data include using SQL <code>SELECT</code> statements on other tables or databases and reading in files from other sources. This section shows you how to tackle the former method of inserting data; you’ll learn how to insert data from a file of comma-separated values in the next section, <a data-type="xref" href="#LOADCSV">“Loading Data from Comma-Delimited Files”</a>.</p>

<p>Suppose we’ve decided to create a new table in the <code>sakila</code> database. It’s going to store a random list of movies that we want to advertise more heavily. In the real world, you’d probably want to use some data science to find out what movies to highlight, but we’re going to stick to the basics. This list of films will be a way for customers to check out different parts of the catalog, rediscover some old favorites, and learn about hidden treasures they haven’t yet explored. We’ve decided to structure the table as 
<span class="keep-together">follows:</span></p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">recommend</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>    </code><strong><code class="n">film_id</code><code> </code><code class="kt">SMALLINT</code><code> </code><code class="k">UNSIGNED</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>    </code><strong><code class="n">language_id</code><code> </code><code class="kt">TINYINT</code><code> </code><code class="k">UNSIGNED</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>    </code><strong><code class="n">release_year</code><code> </code><code class="kt">YEAR</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>    </code><strong><code class="n">title</code><code> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">128</code><code class="p">)</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>    </code><strong><code class="n">length</code><code> </code><code class="kt">SMALLINT</code><code> </code><code class="k">UNSIGNED</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>    </code><strong><code class="n">sequence_id</code><code> </code><code class="kt">SMALLINT</code><code> </code><code class="kp">AUTO_INCREMENT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>    </code><strong><code class="k">PRIMARY</code><code> </code><code class="k">KEY</code><code> </code><code class="p">(</code><code class="n">sequence_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.05 sec)</pre>

<p>This table stores a few details about each film, allowing you to find the actor, category, and other information using simple queries on the other tables. It also stores a <code>sequence_id</code>, which is a unique number that enumerates where the film is in our short list. When you start using the recommendation feature, you’ll first see the movie with a <code>sequence_id</code> of 1, then 2, and so on. You can see that we’re using the MySQL <code>AUTO_INCREMENT</code> feature to allocate the <code>sequence_id</code> values.</p>

<p>Now we need to fill up our new <code>recommend</code> table with a random selection of films. Importantly, we’re going to do the <code>SELECT</code> and <code>INSERT</code> together in one statement. Here we go:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="nf">recommend</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">,</code><code> </code><code class="n">language_id</code><code class="p">,</code><code> </code><code class="n">release_year</code><code class="p">,</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="n">length</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">film_id</code><code class="p">,</code><code> </code><code class="n">language_id</code><code class="p">,</code><code> </code><code class="n">release_year</code><code class="p">,</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="n">length</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="nf">RAND</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">10</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 10 rows affected (0.02 sec)
Records: 10  Duplicates: 0  Warnings: 0</pre>

<p>Now, let’s investigate what happened before we explain how this command works:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">recommend</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+---------+-----+--------------------+--------+-------------+
| film_id | ... | title              | length | sequence_id |
+---------+-----+--------------------+--------+-------------+
|     542 | ... | LUST LOCK          |     52 |           1 |
|     661 | ... | PAST SUICIDES      |    157 |           2 |
|     613 | ... | MYSTIC TRUMAN      |     92 |           3 |
|     757 | ... | SAGEBRUSH CLUELESS |    106 |           4 |
|     940 | ... | VICTORY ACADEMY    |     64 |           5 |
|     917 | ... | TUXEDO MILE        |    152 |           6 |
|     709 | ... | RACER EGG          |    147 |           7 |
|     524 | ... | LION UNCUT         |     50 |           8 |
|      30 | ... | ANYTHING SAVANNAH  |     82 |           9 |
|     602 | ... | MOURNING PURPLE    |    146 |          10 |
+---------+-----+--------------------+--------+-------------+
10 rows in set (0.00 sec)</pre>

<p>You can see that we have 10 films in our recommendation list, numbered with <code>sequence_id</code> values from 1 to 10. We’re ready to start recommending the random movie selection. Don’t worry if your results differ; it’s a consequence of how the <code>RAND()</code> function works.</p>

<p>There are two parts to the SQL statement we used to populate the table: an <code>INSERT INTO</code> and a <code>SELECT</code>. The <code>INSERT INTO</code> statement lists the destination table into which the data will be stored, followed by an optional list of column names in parentheses; if you omit the column names, all columns in the destination table are assumed in the order they appear in the output of a <code>DESCRIBE TABLE</code> or <code>SHOW CREATE TABLE</code> statement. The <code>SELECT</code> statement outputs columns that must match the type and order of the list provided for the <code>INSERT INTO</code> statement (or the implicit complete list if one isn’t provided). The overall effect is that the rows output from the <code>SELECT</code> statement is inserted into the destination table by the <code>INSERT INTO</code> statement. In our example, <code>film_id</code>, <code>language_id</code>, <code>release_year</code>, <code>title</code>, and <code>length</code> values from the <code>film</code> table are inserted into the five columns with the same names and types in the <code>recommend</code> table; the <code>sequence_id</code> is automatically created using MySQL’s <code>AUTO_INCREMENT</code> feature, so it isn’t specified in the statements.</p>

<p>Our example includes the clause <code>ORDER BY RAND()</code>; this<a data-type="indexterm" data-primary="RAND() function" id="idm46177464171864"/><a data-type="indexterm" data-primary="ORDER BY" data-secondary="RAND()" id="idm46177464171128"/> orders the results according to the MySQL function <code>RAND()</code>. The <code>RAND()</code> function returns a pseudorandom number in the range 0 to 1:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="nf">RAND</code><code class="p">(</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+--------------------+
| RAND()             |
+--------------------+
| 0.4593397513584604 |
+--------------------+
1 row in set (0.00 sec)</pre>

<p>A pseudorandom number generator doesn’t generate truly random numbers, but rather generates numbers based on some property of the system, such as the time of day. This is sufficiently random for most applications; a notable exception is cryptography applications that depend on the true randomness of numbers for security.</p>

<p>If you ask for the <code>RAND()</code> value in a <code>SELECT</code> operation, you’ll get a random value for each returned row:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="nf">RAND</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">5</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+------------------+---------------------+
| title            | RAND()              |
+------------------+---------------------+
| ACADEMY DINOSAUR |  0.5514843506286706 |
| ACE GOLDFINGER   | 0.37940252980161693 |
| ADAPTATION HOLES |  0.2425596278557178 |
| AFFAIR PREJUDICE | 0.07459058060738312 |
| AFRICAN EGG      |  0.6452740502034072 |
+------------------+---------------------+
5 rows in set (0.00 sec)</pre>

<p>Since the values are effectively random, you’ll almost certainly see different results than we’ve shown here. Moreover, if you repeat the statement, you’ll also see different values returned. <a data-type="indexterm" data-primary="RAND() function" data-secondary="seed" id="idm46177464452296"/><a data-type="indexterm" data-primary="seed for RAND() function" id="idm46177464451352"/>It is possible to pass <code>RAND()</code> an integer argument called <em>seed</em>. That will result in the <code>RAND()</code> function generating the same values for the same inputs each time that seed is used—it’s not really useful for what we’re trying to achieve here, but a possibility nonetheless. You can try running the following statement as many times as you want, and the results won’t change:</p>

<pre data-type="programlisting" data-code-language="mysql"><strong><code class="k">SELECT</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="nf">RAND</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">5</code><code class="p">;</code></strong></pre>

<p>Let’s return to the <code>INSERT</code> operation. When we ask that the results be ordered by <code>RAND()</code>, the results of the <code>SELECT</code> statement are sorted in a pseudorandom order. The <code>LIMIT 10</code> is there to limit the number of rows returned by the <code>SELECT</code>; we’ve limited in this example simply for readability.</p>

<p>The <code>SELECT</code> statement in an <code>INSERT INTO</code> statement can use all of the usual features of <code>SELECT</code> statements. You can use joins, aggregation, functions, and any other features you choose. You can also query data from one database in another, by prefacing the table names with the database name followed by a period (<code>.</code>) character. For example, if you wanted to insert the <code>actor</code> table from the <code>film</code> database into a new <code>art</code> database, you could do the following:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">DATABASE</code><code> </code><code class="n">art</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 1 row affected (0.01 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">USE</code><code> </code><code class="n">art</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Database changed</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">people</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">person_id</code><code> </code><code class="kt">SMALLINT</code><code> </code><code class="k">UNSIGNED</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">first_name</code><code> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">45</code><code class="p">)</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">last_name</code><code> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">45</code><code class="p">)</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="k">PRIMARY</code><code> </code><code class="k">KEY</code><code> </code><code class="p">(</code><code class="n">person_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.03 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">art</code><code class="p">.</code><code class="nf">people</code><code> </code><code class="p">(</code><code class="n">person_id</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">actor_id</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code> </code><code class="k">FROM</code><code> </code><code class="n">sakila</code><code class="p">.</code><code class="n">actor</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 200 rows affected (0.01 sec)
Records: 200  Duplicates: 0  Warnings: 0</pre>

<p>You can see that the new <code>people</code> table is referred to as <code>art.people</code> (though it doesn’t need to be, since <code>art</code> is the database that’s currently in use), and the <code>actor</code> table is referred to as <code>sakila.actor</code> (which it needs to be, since that isn’t the database being used). Note also that the column names don’t need to be the same for the <code>SELECT</code> and the <code>INSERT</code>.</p>

<p>Sometimes, you’ll encounter duplication issues when inserting<a data-type="indexterm" data-primary="SELECT" data-secondary="inserting data via" data-tertiary="duplication issues" id="idm46177464393800"/><a data-type="indexterm" data-primary="INSERT" data-secondary="queries to insert data" data-tertiary="duplication issues" id="idm46177464392552"/><a data-type="indexterm" data-primary="queries" data-secondary="inserting data using" data-tertiary="duplication issues" id="idm46177464391336"/> with a <code>SELECT</code> statement. If you try to insert the same primary key value twice, MySQL will abort. This won’t happen in the <code>recommend</code> table, as long as you automatically allocate a new <code>sequence_id</code> using the <code>AUTO_INCREMENT</code> feature. However, we can force a duplicate into the table to show the behavior:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">USE</code><code> </code><code class="n">sakila</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Database changed</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="nf">recommend</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">,</code><code> </code><code class="n">language_id</code><code class="p">,</code><code> </code><code class="n">release_year</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">title</code><code class="p">,</code><code> </code><code class="n">length</code><code class="p">,</code><code> </code><code class="n">sequence_id</code><code> </code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">film_id</code><code class="p">,</code><code> </code><code class="n">language_id</code><code class="p">,</code><code> </code><code class="n">release_year</code><code class="p">,</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="n">length</code><code class="p">,</code><code> </code><code class="mi">1</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">1</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">ERROR 1062 (23000): Duplicate entry '1' for key 'recommend.PRIMARY'</pre>

<p>If you want MySQL to ignore this and keep going, add the <code>IGNORE</code> keyword after <code>INSERT</code>:<a data-type="indexterm" data-primary="INSERT" data-secondary="IGNORE" id="idm46177464488984"/><a data-type="indexterm" data-primary="IGNORE" id="idm46177464476952"/></p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">IGNORE</code><code> </code><code class="k">INTO</code><code> </code><code class="nf">recommend</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">,</code><code> </code><code class="n">language_id</code><code class="p">,</code><code> </code><code class="n">release_year</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">title</code><code class="p">,</code><code> </code><code class="n">length</code><code class="p">,</code><code> </code><code class="n">sequence_id</code><code> </code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">film_id</code><code class="p">,</code><code> </code><code class="n">language_id</code><code class="p">,</code><code> </code><code class="n">release_year</code><code class="p">,</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="n">length</code><code class="p">,</code><code> </code><code class="mi">1</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">1</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected, 1 warning (0.00 sec)
Records: 1  Duplicates: 1  Warnings: 1</pre>

<p>MySQL doesn’t complain, but it does report that it encountered a duplicate. Note that the data is not changed; all we did was ignore the error. This is useful in bulk load operations where you don’t want to fail halfway through running a script that inserts a million rows. We can inspect the warning to see the <code><em>Duplicate entry</em></code> error as a warning now:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SHOW</code><code> </code><code class="n">WARNINGS</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+---------+------+-------------------------------------------------+
| Level   | Code | Message                                         |
+---------+------+-------------------------------------------------+
| Warning | 1062 | Duplicate entry '1' for key 'recommend.PRIMARY' |
+---------+------+-------------------------------------------------+
1 row in set (0.00 sec)</pre>

<p>Finally, note that it is possible to insert into a table that’s listed in the <code>SELECT</code> statement, but you still need to avoid duplicate primary keys:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">actor</code><code> </code><code class="k">SELECT</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">actor_id</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">,</code><code> </code><code class="nf">NOW</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">actor</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">ERROR 1062 (23000): Duplicate entry '1' for key 'actor.PRIMARY'</pre>

<p>There are two ways to avoid getting the error. First, the <code>actor</code> table has <code>AUTO_INCREMENT</code> enabled for <code>actor_id</code>, so if you omit this column in the <code>INSERT</code> completely, you won’t get an error, as the new values will be generated automatically. (<code>INSERT</code> statement syntax is explained in <a data-type="xref" href="ch03.xhtml#BAS-SEC-INSERT2">“Alternative Syntaxes”</a>.) Here’s an example that would only one record (due to the <code>LIMIT</code> clause):</p>

<pre data-type="programlisting" data-code-language="mysql"><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="nf">actor</code><code class="p">(</code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">,</code><code> </code><code class="n">last_update</code><code class="p">)</code></strong><code>
</code><strong><code class="k">SELECT</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">,</code><code> </code><code class="nf">NOW</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">actor</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">1</code><code class="p">;</code></strong></pre>

<p>The second way is to modify <code>actor_id</code> in the <code>SELECT</code> query in a way that prevents collisions. Let’s try that:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">actor</code><code> </code><code class="k">SELECT</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">actor_id</code><code class="o">+</code><code class="mi">200</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">,</code><code> </code><code class="nf">NOW</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">actor</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 200 rows affected (0.01 sec)
Records: 200  Duplicates: 0  Warnings: 0</pre>

<p>Here, we’re copying the rows but increasing their <code>actor_id</code> values by 200 before we insert them, because we remember that there are 200 rows initially. This is the result:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">actor</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+----------+-------------+--------------+---------------------+
| actor_id | first_name  | last_name    | last_update         |
+----------+-------------+--------------+---------------------+
|        1 | PENELOPE    | GUINESS      | 2006-02-15 04:34:33 |
|        2 | NICK        | WAHLBERG     | 2006-02-15 04:34:33 |
|      ...                                                    |
|      198 | MARY        | KEITEL       | 2006-02-15 04:34:33 |
|      199 | JULIA       | FAWCETT      | 2006-02-15 04:34:33 |
|      200 | THORA       | TEMPLE       | 2006-02-15 04:34:33 |
|      201 | PENELOPE    | GUINESS      | 2021-02-28 10:24:49 |
|      202 | NICK        | WAHLBERG     | 2021-02-28 10:24:49 |
|      ...                                                    |
|      398 | MARY        | KEITEL       | 2021-02-28 10:24:49 |
|      399 | JULIA       | FAWCETT      | 2021-02-28 10:24:49 |
|      400 | THORA       | TEMPLE       | 2021-02-28 10:24:49 |
+----------+-------------+--------------+---------------------+
400 rows in set (0.00 sec)</pre>

<p class="pagebreak-before">You can see how first names, last names, and <code>last_update</code> values start repeating from the <code>actor_id</code> 201.</p>

<p>It’s also possible to use subqueries in the <code>INSERT SELECT</code> statements. For example, the next statement is valid:<a data-type="indexterm" data-startref="ch07-insq" id="idm46177464919544"/><a data-type="indexterm" data-startref="ch07-insq2" id="idm46177464918840"/><a data-type="indexterm" data-startref="ch07-insq3" id="idm46177464918168"/></p>

<pre data-type="programlisting" data-code-language="mysql"><code class="o">*</code><code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">actor</code> <code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code><code class="o">*</code>
<code class="o">*</code><code class="p">(</code><code class="k">SELECT</code> <code class="n">actor_id</code><code class="o">+</code><code class="mi">400</code><code class="p">,</code> <code class="n">first_name</code><code class="p">,</code> <code class="n">last_name</code><code class="p">,</code> <code class="nf">NOW</code><code class="p">()</code> <code class="k">FROM</code> <code class="n">actor</code><code class="p">)</code> <code class="n">foo</code><code class="p">;</code><code class="o">*</code></pre>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Loading Data from Comma-Delimited Files"><div class="sect1" id="LOADCSV">
<h1>Loading Data from Comma-Delimited Files</h1>

<p>These days, databases are usually not an afterthought. They<a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="loading data from" id="ch07-cdf"/><a data-type="indexterm" data-primary="tables" data-secondary="comma-delimited files" data-tertiary="reading data from" id="ch07-cdf2"/><a data-type="indexterm" data-primary="LOAD DATA" data-secondary="comma-delimited source" id="ch07-cdf3"/><a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="about" id="idm46177464946888"/> are ubiquitous and easier than ever to use, and most IT professionals know about them. Nevertheless, end users find them difficult, and unless specialized UIs are created, a lot of data entry and analysis is instead done in various spreadsheet programs. These programs typically have unique file formats, open or closed, but most of them will allow you to export data as rows of comma-separated values (CSVs), also called a <em>comma-delimited format</em>. You can then import the data with a little effort into MySQL.</p>

<p>Another common task that can be accomplished by working with CSVs is transferring data in a heterogeneous environment. If you have various database software running in your setup, and especially if you’re using a DBaaS in the cloud, moving data between these systems can be daunting. However, the basic CSV data can be a lowest common denominator for them. Note that in the case of any data transfer you should always remember that CSV does not have the notions of schemas, data types, or constraints. But as a flat data file format, it works well.</p>

<p>If you’re not using a spreadsheet program, you can still often use command-line tools such as <code>sed</code> and <code>awk</code>—very old and powerful Unix utilities—to convert text data into a CSV format suitable for import by MySQL. Some cloud databases allow export of their data directly into CSV. In some other cases, small programs have to be written that read data and produce a CSV file. This section shows you the basics of how to import CSV data into MySQL.</p>

<p>Let’s work through an example. We have a list of NASA facilities<a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="NASA_Facilities.csv" id="idm46177464967048"/><a data-type="indexterm" data-primary="NASA_Facilities.csv" id="idm46177464966104"/> with their addresses and contact information that we want to store in a database. At present, it’s stored in a CSV file named <em>NASA_Facilities.csv</em> and has the format shown in <a data-type="xref" href="#ADV2-FIG-NASAFACILITIES">Figure 7-1</a>.</p>

<figure><div id="ADV2-FIG-NASAFACILITIES" class="figure">
<img src="Images/lm2e_0701.png" alt="lm2e 0701" width="1413" height="532"/>
<h6><span class="label">Figure 7-1. </span>List of NASA facilities stored in a spreadsheet file</h6>
</div></figure>

<p>You can see that each facility is associated with a center, and may list the date it was occupied and optionally its status. The full column list is as follows:</p>

<ul>
<li>
<p>Center</p>
</li>
<li>
<p>Center Search Status</p>
</li>
<li>
<p>Facility</p>
</li>
<li>
<p>FacilityURL</p>
</li>
<li>
<p>Occupied</p>
</li>
<li>
<p>Status</p>
</li>
<li>
<p>URL Link</p>
</li>
<li>
<p>Record Date</p>
</li>
<li>
<p>Last Update</p>
</li>
<li>
<p>Country</p>
</li>
<li>
<p>Contact</p>
</li>
<li>
<p>Phone</p>
</li>
<li>
<p>Location</p>
</li>
<li>
<p>City</p>
</li>
<li>
<p>State</p>
</li>
<li>
<p>Zipcode</p>
</li>
</ul>

<p>This example comes directly from NASA’s publicly available<a data-type="indexterm" data-primary="NASA_Facilities.csv" data-secondary="NASA data portal link" id="idm46177464711480"/><a data-type="indexterm" data-primary="web links in book" data-secondary="NASA data portal" id="idm46177464710472"/> <a href="https://oreil.ly/xIm3A">Open Data Portal</a>, and the file is available in the book’s <a href="https://oreil.ly/ayDai">GitHub repository</a>. Since this is already a CSV file, we don’t need to convert it from another file format (like XLS). However, if you do need to do that in your own project, it’s usually as easy as using the Save As command in the spreadsheet program; just don’t forget to pick CSV as the output format.</p>

<p>If you open the <em>NASA_facilities.csv</em> file using a text editor, you’ll see that it has one line per spreadsheet row, with the values for each column separated by commas. If you’re on a non-Windows platform, you may find that in some CSV files each line is terminated with a <code>^M</code>, but don’t worry about this; it’s an artifact of the origins of Windows. Data in this format is often referred to as <em>DOS format</em>, and most software applications can handle it without problem. In our case, the data is in <em>Unix format</em>, and thus on Windows you may see that all the lines are concatenated. You can try to use another text editor if that’s the case. Here are a few width-truncated lines selected from <em>NASA_Facilities.csv</em>:</p>

<pre data-type="programlisting">Center,Center Search Status,Facility,FacilityURL,Occupied,Status,...
Kennedy Space Center,Public,Control Room 2/1726/HGR-S ,,...
Langley Research Center,Public,Micometeroid/LDEF Analysis Laboratory,,...
Kennedy Space Center,Public,SRM Rotation and Processing Facility/K6-0494 ,...
Marshall Space Flight Center,..."35812(34.729538, -86.585283)",Huntsville,...</pre>

<p>If there are commas or other special symbols within values, the whole value is enclosed in quotes, as in the last line shown here.</p>

<p>Let’s import this data into MySQL. First, create the new <code>nasa</code> database:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">DATABASE</code><code> </code><code class="n">nasa</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 1 row affected (0.01 sec)</pre>

<p>Choose this as the active database:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">USE</code><code> </code><code class="n">nasa</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Database changed</pre>

<p>Now, create the <code>facilities</code> table to store the data. This needs to handle all of the fields that we see in the CSV file, which conveniently has a header:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="nf">facilities</code><code> </code><code class="p">(</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">center</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">center_search_status</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">facility</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">facility_url</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">occupied</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">status</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">url_link</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">record_date</code><code> </code><code class="kt">DATETIME</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">last_update</code><code> </code><code class="kt">TIMESTAMP</code><code> </code><code class="no">NULL</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">country</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">contact</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">phone</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">location</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">city</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">state</code><code> </code><code class="kt">TEXT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">zipcode</code><code> </code><code class="kt">TEXT</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.03 sec)</pre>

<p>We’re cheating here somewhat with the data types. NASA provides the schema of the dataset, but for most of the fields the type is given as the “Plain Text,” and we can’t really store a “Website URL” as anything but text, either. <a data-type="indexterm" data-primary="TEXT data type" data-secondary="NASA facilities CSV file" id="idm46177464821928"/>We don’t, however, know how much data each column will hold. Thus, we default to using the <code>TEXT</code> type, which is similar to defining a column as <code>VARCHAR(65535)</code>. There are some differences between the two types, as you can probably remember from <a data-type="xref" href="ch04.xhtml#SEC-STRING-COLUMN-TYPES">“String types”</a>, but they are not important in this example. We don’t define any indexes and don’t put any constraints on our table. If you’re loading a completely new dataset that’s quite small, it can be beneficial to load it first and then analyze it. For larger datasets, make sure the table is structured as well as possible, or you’ll spend a considerable amount of time changing it later.</p>

<p>Now that we’ve set up the database table, we can import the data from the file using the <code>LOAD DATA INFILE</code> command:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">LOAD</code><code> </code><code class="n">DATA</code><code> </code><code class="k">INFILE</code><code> </code><code class="s1">'NASA_Facilities.csv'</code><code> </code><code class="k">INTO</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">facilities</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">FIELDS</code><code> </code><code class="k">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">','</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">ERROR 1290 (HY000): The MySQL server is running with
the --secure-file-priv option so it cannot execute this statement</pre>

<p>Oh, no! We got an error. By default, MySQL doesn’t let you load <em>any</em> data using the <code>LOAD DATA INFILE</code> command. <a data-type="indexterm" data-primary="LOAD DATA" data-secondary="secure_file_priv" id="idm46177465082328"/><a data-type="indexterm" data-primary="secure_file_priv" id="idm46177465081320"/><a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="loading data from" data-tertiary="secure_file_priv" id="idm46177464847016"/>The behavior is controlled by the <code>secure_file_priv</code> system variable. If the variable is set to a path, the file to be loaded should reside in that particular path and be readable by the MySQL server. If the variable isn’t set, which is considered insecure, then the file to be loaded should be readable only by the MySQL server. By default, MySQL 8.0 on Linux sets this variable as follows:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">@</code><code class="o">@</code><code class="n">secure_file_priv</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+-----------------------+
| @@secure_file_priv    |
+-----------------------+
| /var/lib/mysql-files/ |
+-----------------------+
1 row in set (0.00 sec)</pre>

<p>And on Windows:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">@</code><code class="o">@</code><code class="n">secure_file_priv</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+------------------------------------------------+
| @@secure_file_priv                             |
+------------------------------------------------+
| C:\ProgramData\MySQL\MySQL Server 8.0\Uploads\ |
+------------------------------------------------+
1 row in set (0.00 sec)</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The value of the <code>secure_file_priv</code> system variable may be different in your installation of MySQL, or it may even be empty.<a data-type="indexterm" data-primary="NULL" data-secondary="secure_file_priv" id="idm46177465105304"/><a data-type="indexterm" data-primary="secure_file_priv" data-secondary="NULL value" id="idm46177465104296"/><a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="loading data from" data-tertiary="secure_file_priv NULL" id="idm46177465103352"/><a data-type="indexterm" data-primary="LOAD DATA" data-secondary="secure_file_priv" data-tertiary="NULL value" id="idm46177465102168"/> A <code>NULL</code> value for <code>secure_file_priv</code> means that MySQL will allow loading a file in any location as long as that file is accessible to the MySQL server. On Linux, that means that the file has to be readable by the <code>mysqld</code> process, which usually runs under the <code>mysql</code> user. You can change <code>secure_file_priv</code> variable’s value by updating your MySQL configuration and restarting the server. You can find information on how to configure MySQL in <a data-type="xref" href="ch09.xhtml#CH9_OPTIONS_FILE">Chapter 9</a>.</p>
</div>

<p>On Linux or other Unix-like systems, you need to copy the file into that directory, possibly using <code>sudo</code> to allow the operation, and then change its permissions so that the <code>mysqld</code> program can access the file. On Windows, you only need to copy the file to the correct destination.</p>

<p>Let’s do this. On Linux or similar systems, you can run commands like this:</p>

<pre data-type="programlisting">$ <strong>ls -lh $HOME/Downloads/NASA_Facilities.csv</strong>
-rw-r--r--. 1 skuzmichev skuzmichev 114K
    Feb 28 14:19 /home/skuzmichev/Downloads/NASA_Facilities.csv
$ <strong>sudo cp -vip ~/Downloads/NASA_Facilities.csv /var/lib/mysql-files</strong>
[sudo] password for skuzmichev:
'/home/skuzmichev/Downloads/NASA_Facilities.csv'
    -&gt; '/var/lib/mysql-files/NASA_Facilities.csv'
$ <strong>sudo chown mysql:mysql /var/lib/mysql-files/NASA_Facilities.csv</strong>
$ <strong>sudo ls -lh /var/lib/mysql-files/NASA_Facilities.csv</strong>
-rw-r--r--. 1 mysql mysql 114K
    Feb 28 14:19 /var/lib/mysql-files/NASA_Facilities.csv</pre>

<p>On Windows, you can use the File Manager to copy or move the file.</p>

<p>Now we’re ready to try the loading again. When our target file is not in the current directory, we need to pass the full path to the command:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">LOAD</code><code> </code><code class="n">DATA</code><code> </code><code class="k">INFILE</code><code> </code><code class="s1">'/var/lib/mysql-files/NASA_Facilities.csv'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">INTO</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">facilities</code><code> </code><code class="n">FIELDS</code><code> </code><code class="k">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">','</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">ERROR 1292 (22007): Incorrect datetime value:
'Record Date' for column 'record_date' at row 1</pre>

<p>Well, that doesn’t look correct: <code>Record Date</code> is indeed not a date, but a column name. We’ve made a silly but common mistake, loading the CSV file with the header. We need to tell MySQL to omit it:<a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="loading data from" data-tertiary="header omitted" id="idm46177464706728"/></p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">LOAD</code><code> </code><code class="n">DATA</code><code> </code><code class="k">INFILE</code><code> </code><code class="s1">'/var/lib/mysql-files/NASA_Facilities.csv'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">INTO</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">facilities</code><code> </code><code class="n">FIELDS</code><code> </code><code class="k">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">','</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">IGNORE</code><code> </code><code class="mi">1</code><code> </code><code class="k">LINES</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">ERROR 1292 (22007): Incorrect datetime value:
'03/01/1996 12:00:00 AM' for column 'record_date' at row 1</pre>

<p>Turns out, that date format we have is not something MySQL<a data-type="indexterm" data-primary="date and time columns" data-secondary="format of imported data" id="idm46177465163464"/><a data-type="indexterm" data-primary="time and date columns" data-secondary="format of imported data" id="idm46177465138840"/> expects. That’s an extremely common issue. There are a couple of ways out. First, we can just change our <code>record_date</code> column to the <code>TEXT</code> type. We’ll lose the niceties of a proper date-time data type, but we’ll be able to get the data into our database. Second, we can convert the data ingested from the file on the fly. To demonstrate the difference in the results, we specified the <code>occupied</code> column (which is a date field) to be <code>TEXT</code>. Before we jump into the conversion complexities, though, let’s try running the same command on Windows:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">LOAD</code><code> </code><code class="n">DATA</code><code> </code><code class="k">INFILE</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="s1">'C:\ProgramData\MySQL\MySQL Server 8.0\Uploads\NASA_Facilities.csv'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">INTO</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">facilities</code><code> </code><code class="n">FIELDS</code><code> </code><code class="k">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">','</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">ERROR 1290 (HY000): The MySQL server is running with
the --secure-file-priv option so it cannot execute this statement</pre>

<p>Even though the file is present in that directory, <code>LOAD DATA INFILE</code> errors out. <a data-type="indexterm" data-primary="Windows 10" data-secondary="paths with MySQL commands" id="idm46177463829656"/><a data-type="indexterm" data-primary="MySQL" data-secondary="paths in Windows" id="idm46177463828712"/><a data-type="indexterm" data-primary="paths in Windows" id="idm46177463827768"/><a data-type="indexterm" data-primary="secure_file_priv" data-secondary="paths in Windows" id="idm46177463827096"/><a data-type="indexterm" data-primary="LOAD DATA" data-secondary="secure_file_priv" data-tertiary="paths on Windows" id="idm46177463826152"/><a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="loading data from" data-tertiary="paths on Windows" id="idm46177463824936"/><a data-type="indexterm" data-primary="\ (backslash)" data-primary-sortas="#backslash" id="idm46177463823752"/><a data-type="indexterm" data-primary="backslash (\)" id="idm46177465219240"/><a data-type="indexterm" data-primary="/ (forward slash)" data-primary-sortas="#forward slash" id="idm46177465218568"/><a data-type="indexterm" data-primary="forward slash (/)" id="idm46177465217624"/>The reason for that is how MySQL works with paths on Windows. We can’t just use regular Windows-style paths with this or other MySQL commands. We need to escape each backslash (<code>\</code>) with another backslash, or change our path to use forward slashes (<code>/</code>). Both will work…or rather, in this case, both will error out due to the expected <code>record_date</code> conversion issue:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">LOAD</code><code> </code><code class="n">DATA</code><code> </code><code class="k">INFILE</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="s1">'C:\\ProgramData\\MySQL\\MySQL Server 8.0\\Uploads\\NASA_Facilities.csv'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">INTO</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">facilities</code><code> </code><code class="n">FIELDS</code><code> </code><code class="k">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">','</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">ERROR 1292 (22007): Incorrect datetime value:
'Record Date' for column 'record_date' at row 1</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">LOAD</code><code> </code><code class="n">DATA</code><code> </code><code class="k">INFILE</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="s1">'C:/ProgramData/MySQL/MySQL Server 8.0/Uploads/NASA_Facilities.csv'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">INTO</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">facilities</code><code> </code><code class="n">FIELDS</code><code> </code><code class="k">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">','</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">ERROR 1292 (22007): Incorrect datetime value:
'Record Date' for column 'record_date' at row 1</pre>

<p>With that covered, let’s get back to our date conversion issue.<a data-type="indexterm" data-primary="date and time columns" data-secondary="format of imported data" data-tertiary="converting on the fly" id="idm46177461683176"/><a data-type="indexterm" data-primary="time and date columns" data-secondary="format of imported data" data-tertiary="converting on the fly" id="idm46177461682088"/> As we mentioned, this is an extremely common issue. You will inevitably face type conversion problems, because CSV is typeless, and different databases have different expectations about various types. In this case, the open dataset that we obtained has dates in the following format: <code>03/01/1996 12:00:00 AM</code>. While this will make our operation more complex, we believe converting the date values from our CSV file is a good exercise. <a data-type="indexterm" data-primary="strings" data-secondary="STR_TO_DATE()" id="idm46177461680040"/><a data-type="indexterm" data-primary="STR_TO_DATE()" id="idm46177461679192"/><a data-type="indexterm" data-primary="date and time columns" data-secondary="STR_TO_DATE()" id="idm46177461678584"/><a data-type="indexterm" data-primary="time and date columns" data-secondary="STR_TO_DATE()" id="idm46177461677736"/>To convert an arbitrary string to a date, or at least to attempt such a conversion, we can use the <code>STR_TO_DATE()</code> function. After reviewing the documentation, we came up with the following cast:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="nf">STR_TO_DATE</code><code class="p">(</code><code class="s1">'03/01/1996 12:00:00 AM'</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="s1">'%m/%d/%Y %h:%i:%s %p'</code><code class="p">)</code><code> </code><code class="n">converted</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+---------------------+
| converted           |
+---------------------+
| 1996-03-01 00:00:00 |
+---------------------+
1 row in set (0.01 sec)</pre>

<p>Since the function returns <code>NULL</code> when the cast is unsuccessful, we know we have managed to find a correct invocation. Now we need to find out how to use the function in the <code>LOAD DATA INFILE</code> command. The much longer version using the function looks like this:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">LOAD</code><code> </code><code class="n">DATA</code><code> </code><code class="k">INFILE</code><code> </code><code class="s1">'/var/lib/mysql-files/NASA_Facilities.csv'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">INTO</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">facilities</code><code> </code><code class="n">FIELDS</code><code> </code><code class="k">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">','</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">OPTIONALLY</code><code> </code><code class="k">ENCLOSED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">'"'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">IGNORE</code><code> </code><code class="mi">1</code><code> </code><code class="k">LINES</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="n">center</code><code class="p">,</code><code> </code><code class="n">center_search_status</code><code class="p">,</code><code> </code><code class="n">facility</code><code class="p">,</code><code> </code><code class="n">facility_url</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">occupied</code><code class="p">,</code><code> </code><code class="n">status</code><code class="p">,</code><code> </code><code class="n">url_link</code><code class="p">,</code><code> </code><code class="o">@</code><code class="n">var_record_date</code><code class="p">,</code><code> </code><code class="o">@</code><code class="n">var_last_update</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">country</code><code class="p">,</code><code> </code><code class="n">contact</code><code class="p">,</code><code> </code><code class="n">phone</code><code class="p">,</code><code> </code><code class="n">location</code><code class="p">,</code><code> </code><code class="n">city</code><code class="p">,</code><code> </code><code class="n">state</code><code class="p">,</code><code> </code><code class="n">zipcode</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="kt">SET</code><code> </code><code class="n">record_date</code><code> </code><code class="o">=</code><code> </code><code class="k">IF</code><code class="p">(</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="nf">CHAR_LENGTH</code><code class="p">(</code><code class="o">@</code><code class="n">var_record_date</code><code class="p">)</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="no">NULL</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>     </code><strong><code class="nf">STR_TO_DATE</code><code class="p">(</code><code class="o">@</code><code class="n">var_record_date</code><code class="p">,</code><code> </code><code class="s1">'%m/%d/%Y %h:%i:%s %p'</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">)</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">last_update</code><code> </code><code class="o">=</code><code> </code><code class="k">IF</code><code class="p">(</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="nf">CHAR_LENGTH</code><code class="p">(</code><code class="o">@</code><code class="n">var_last_update</code><code class="p">)</code><code class="o">=</code><code class="mi">0</code><code class="p">,</code><code> </code><code class="no">NULL</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>     </code><strong><code class="nf">STR_TO_DATE</code><code class="p">(</code><code class="o">@</code><code class="n">var_last_update</code><code class="p">,</code><code> </code><code class="s1">'%m/%d/%Y %h:%i:%s %p'</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 485 rows affected (0.05 sec)
Records: 485  Deleted: 0  Skipped: 0  Warnings: 0</pre>

<p>That’s a lot of command! Let’s break it down. The first line<a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="loading data from" data-tertiary="FIELDS specification" id="idm46177461459912"/><a data-type="indexterm" data-primary="LOAD DATA" data-secondary="comma-delimited source" data-tertiary="FIELDS specification" id="idm46177461458824"/> specifies our <code>LOAD DATA INFILE</code> command and the path to a file. The second line specifies the target table and begins the <code>FIELDS</code> specification, starting with <code>TERMINATED BY ','</code>, which means our fields are delimited by commas, as expected for CSV. The third line adds another parameter to the <code>FIELDS</code> specification and tells MySQL that some fields (but not all) are enclosed by the <code>"</code> symbol. That’s important, because our dataset has some entries with commas within <code>"..."</code> fields. On line four we specify that we skip the first line of the file, where we know the header resides.</p>

<p>Lines 5 through 7 have the column list specification. We need to convert two date-time columns, and for that we need to read their values into variables, which are then set to the <code>nasa.facilities</code> table’s column values. However, we can’t tell that to MySQL without also specifying all the other columns. If we were to omit some columns from the list or specify them in the wrong order, MySQL would not assign the values correctly. CSV is inherently a position-based format. By default, when the <code>FIELDS</code> specification is not given, MySQL will read each CSV line and will expect each field in all lines to map to a column in the target table (in the order of columns that the <code>DESCRIBE</code> or <code>SHOW CREATE TABLE</code> command gives). By changing the order of columns in this specification, we can populate a table from a CSV file that has fields misplaced. By specifying fewer columns, we can populate a table from a file that is missing some of the fields.</p>

<p>Lines 8 through 15 are our function calls to convert the date-time values. In the preceding column spec, we defined that field 8 is read into the <code>@var_record_date</code> variable, and field 9 into <code>@var_last_update</code>. We know that fields 8 and 9 are our problematic date-time fields. With the variables populated, we can define the <code>SET</code> parameter, which allows modification of the target table column values based on fields read from the CSV file. In this very basic example, you could multiply a specific value by two. In our case, we cast two functions: first we check that a variable is not empty (<code>,,</code> in CSV) by assessing the number of characters read from the file, and second we call the actual conversion if the previous check doesn’t return zero. If we found the length to be zero, we set the value to <code>NULL</code>.</p>

<p>Finally, when the command has been executed, it’s possible to check the results:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">facility</code><code class="p">,</code><code> </code><code class="n">occupied</code><code class="p">,</code><code> </code><code class="n">last_update</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">FROM</code><code> </code><code class="n">facilities</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">last_update</code><code> </code><code class="k">DESC</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">5</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+---------------------...+------------------------+---------------------+
| facility            ...| occupied               | last_update         |
+---------------------...+------------------------+---------------------+
| Turn Basin/K7-1005  ...| 01/01/1963 12:00:00 AM | 2015-06-22 00:00:00 |
| RPSF Surge Building ...| 01/01/1984 12:00:00 AM | 2015-06-22 00:00:00 |
| Thermal Protection S...| 01/01/1988 12:00:00 AM | 2015-06-22 00:00:00 |
| Intermediate Bay/M7-...| 01/01/1995 12:00:00 AM | 2015-06-22 00:00:00 |
| Orbiter Processing F...| 01/01/1987 12:00:00 AM | 2015-06-22 00:00:00 |
+---------------------...+------------------------+---------------------+
5 rows in set (0.00 sec)</pre>

<p>Remember we mentioned that <code>occupied</code> will remain <code>TEXT</code>.<a data-type="indexterm" data-primary="DATETIME data type" data-secondary="imported data as TEXT" id="idm46177461375064"/> You can see that here. While it can be used for sorting, no date functions will work on values in this column unless they are explicitly cast to <code>DATETIME</code>.</p>

<p>This was a complex example, but it shows the unexpected complexity of loading data and the power of the <code>LOAD DATA INFILE</code> command.<a data-type="indexterm" data-startref="ch07-cdf" id="idm46177461372392"/><a data-type="indexterm" data-startref="ch07-cdf2" id="idm46177461371656"/><a data-type="indexterm" data-startref="ch07-cdf3" id="idm46177461370984"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Writing Data into Comma-Delimited Files"><div class="sect1" id="WRITECSV">
<h1>Writing Data into Comma-Delimited Files</h1>

<p>You can use the <code>SELECT INTO OUTFILE</code> statement to write<a data-type="indexterm" data-primary="output" data-secondary="comma-delimited file" id="ch07-cdlw4"/><a data-type="indexterm" data-primary="tables" data-secondary="comma-delimited files" data-tertiary="writing data to" id="ch07-cdlw"/><a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="writing data to" id="ch07-cdlw2"/><a data-type="indexterm" data-primary="writing data to comma-delimited files" id="ch07-cdlw3"/><a data-type="indexterm" data-primary="queries" data-secondary="results into comma-delimited files" id="ch07-cdlw5"/> out the result of a query into a CSV file that can be opened by a spreadsheet or other program.</p>

<p>Let’s export the list of current managers from our <code>employees</code> database into a CSV file. The query used to list all the current managers is shown here:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">USE</code><code> </code><code class="n">employees</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Database changed</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">emp_no</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">,</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="n">from_date</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">FROM</code><code> </code><code class="n">employees</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">titles</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">emp_no</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">title</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Manager'</code><code> </code><code class="k">AND</code><code> </code><code class="n">to_date</code><code> </code><code class="o">=</code><code> </code><code class="s1">'9999-01-01'</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+--------+------------+------------+---------+------------+
| emp_no | first_name | last_name  | title   | from_date  |
+--------+------------+------------+---------+------------+
| 110039 | Vishwani   | Minakawa   | Manager | 1991-10-01 |
| 110114 | Isamu      | Legleitner | Manager | 1989-12-17 |
| 110228 | Karsten    | Sigstam    | Manager | 1992-03-21 |
| 110420 | Oscar      | Ghazalie   | Manager | 1996-08-30 |
| 110567 | Leon       | DasSarma   | Manager | 1992-04-25 |
| 110854 | Dung       | Pesch      | Manager | 1994-06-28 |
| 111133 | Hauke      | Zhang      | Manager | 1991-03-07 |
| 111534 | Hilary     | Kambil     | Manager | 1991-04-08 |
| 111939 | Yuchang    | Weedman    | Manager | 1996-01-03 |
+--------+------------+------------+---------+------------+
9 rows in set (0.13 sec)</pre>

<p>We can change this <code>SELECT</code> query slightly to write this data into an output file as comma-separated values. <code>INTO OUTFILE</code> is subject to the same <code>--secure-file-priv</code> option rules as <code>LOAD DATA INFILE</code>. The file path by default is limited, and we listed the default options in <a data-type="xref" href="#LOADCSV">“Loading Data from Comma-Delimited Files”</a>:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">emp_no</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">,</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="n">from_date</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">FROM</code><code> </code><code class="n">employees</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">titles</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">emp_no</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">title</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Manager'</code><code> </code><code class="k">AND</code><code> </code><code class="n">to_date</code><code> </code><code class="o">=</code><code> </code><code class="s1">'9999-01-01'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">INTO</code><code> </code><code class="k">OUTFILE</code><code> </code><code class="s1">'/var/lib/mysql-files/managers.csv'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">FIELDS</code><code> </code><code class="k">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">','</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 9 rows affected (0.14 sec)</pre>

<p>Here, we’ve saved the results into the file <em>managers.csv</em> in the <em>/var/lib/mysql-files</em> directory; the MySQL server must be able to write to the directory that you specify, <a data-type="indexterm" data-primary="secure_file_priv" id="idm46177461198424"/><a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="writing data to" data-tertiary="secure_file_priv" id="idm46177461197816"/><a data-type="indexterm" data-primary="writing data to comma-delimited files" data-secondary="secure_file_priv" id="idm46177461196728"/><a data-type="indexterm" data-primary="Windows 10" data-secondary="paths with MySQL commands" data-tertiary="secure_file_priv" id="idm46177461195880"/><a data-type="indexterm" data-primary="paths in Windows" data-secondary="secure_file_priv" id="idm46177461194792"/><a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="writing data to" data-tertiary="paths in Windows" id="idm46177461193944"/><a data-type="indexterm" data-primary="MySQL" data-secondary="paths in Windows" id="idm46177461192856"/><a data-type="indexterm" data-primary="secure_file_priv" data-secondary="paths in Windows" id="idm46177461192008"/><a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="writing data to" data-tertiary="FIELDS TERMINATED BY" id="idm46177461191160"/><a data-type="indexterm" data-primary="writing data to comma-delimited files" data-secondary="FIELDS TERMINATED BY" id="idm46177461155688"/>and it should be one listed in the <code>secure_file_priv</code> system variable (if set). On a Windows system, specify a path such as <em>C:\ProgramData\MySQL\MySQL Server 8.0\Uploads\managers.csv</em> instead. <a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="writing data to" data-tertiary="default delimiter" id="idm46177461153944"/><a data-type="indexterm" data-primary="defaults" data-secondary="comma-delimited file delimiter" id="idm46177461152856"/>If you omit the <code>FIELDS TERMINATED BY</code> clause, the server will use tabs as the default separator between the data values.</p>

<p>You can view the contents of the file <em>managers.csv</em> in a text editor, or import it into a spreadsheet program:</p>

<pre data-type="programlisting">110039,Vishwani,Minakawa,Manager,1991-10-01
110114,Isamu,Legleitner,Manager,1989-12-17
110228,Karsten,Sigstam,Manager,1992-03-21
110420,Oscar,Ghazalie,Manager,1996-08-30
110567,Leon,DasSarma,Manager,1992-04-25
110854,Dung,Pesch,Manager,1994-06-28
111133,Hauke,Zhang,Manager,1991-03-07
111534,Hilary,Kambil,Manager,1991-04-08
111939,Yuchang,Weedman,Manager,1996-01-03</pre>

<p>When our data fields contain commas or another delimiter of our choice, MySQL by default will escape the delimiters within<a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="writing data to" data-tertiary="escaping delimiters within fields" id="idm46177461149576"/><a data-type="indexterm" data-primary="defaults" data-secondary="comma-delimited file delimiter" data-tertiary="escaping delimiters within fields" id="idm46177461148488"/> fields. Let’s switch to the <code>sakila</code> database and test this:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">USE</code><code> </code><code class="n">sakila</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Database changed</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="n">special_features</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">10</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">INTO</code><code> </code><code class="k">OUTFILE</code><code> </code><code class="s1">'/var/lib/mysql-files/film.csv'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">FIELDS</code><code> </code><code class="k">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">','</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 10 rows affected (0.00 sec)</pre>

<p>If you take a look at the data in the <em>film.csv</em> file now (again, feel free to use a text editor, a spreadsheet program, or a command-line utility like <code>head</code> on Linux), here’s what you’ll see:</p>

<pre data-type="programlisting">ACADEMY DINOSAUR,Deleted Scenes\,Behind the Scenes
ACE GOLDFINGER,Trailers\,Deleted Scenes
ADAPTATION HOLES,Trailers\,Deleted Scenes
AFFAIR PREJUDICE,Commentaries\,Behind the Scenes
AFRICAN EGG,Deleted Scenes
AGENT TRUMAN,Deleted Scenes
AIRPLANE SIERRA,Trailers\,Deleted Scenes
AIRPORT POLLOCK,Trailers
ALABAMA DEVIL,Trailers\,Deleted Scenes
ALADDIN CALENDAR,Trailers\,Deleted Scenes</pre>

<p>Notice how in rows where the second field contains a comma, it has been automatically escaped with a backslash to distinguish it from the separator. Some spreadsheet programs may understand this and remove the backslashes when importing the file, and some may not. MySQL will respect the escaping and not treat such commas as separators. Note that if we specified <code>FIELDS TERMINATED BY '^'</code>, all <code>^</code> symbols within fields would get escaped; this is not specific to commas.</p>

<p>Since not all programs may deal with escapes gracefully, we can ask MySQL to explicitly define fields by using the <code>ENCLOSED</code> option:<a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="writing data to" data-tertiary="ENCLOSED option" id="idm46177461089384"/></p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="n">special_features</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">10</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">INTO</code><code> </code><code class="k">OUTFILE</code><code> </code><code class="s1">'/var/lib/mysql-files/film_quoted.csv'</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">FIELDS</code><code> </code><code class="k">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">','</code><code> </code><code class="k">ENCLOSED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">'"'</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 10 rows affected (0.00 sec)</pre>

<p>We used this option before when loading data. Take a look at the results in the file <em>film_quoted.csv</em>:</p>

<pre data-type="programlisting">"ACADEMY DINOSAUR","Deleted Scenes,Behind the Scenes"
"ACE GOLDFINGER","Trailers,Deleted Scenes"
"ADAPTATION HOLES","Trailers,Deleted Scenes"
"AFFAIR PREJUDICE","Commentaries,Behind the Scenes"
"AFRICAN EGG","Deleted Scenes"
"AGENT TRUMAN","Deleted Scenes"
"AIRPLANE SIERRA","Trailers,Deleted Scenes"
"AIRPORT POLLOCK","Trailers"
"ALABAMA DEVIL","Trailers,Deleted Scenes"
"ALADDIN CALENDAR","Trailers,Deleted Scenes"</pre>

<p>Our delimiters—commas—are now not escaped, which may work better with modern spreadsheet programs. You may wonder what will happen if there are double quotes within exported fields: MySQL will escape those instead of the commas, which again may cause problems. When doing data export, do not forget to make sure that the resulting output will work for your consumers.<a data-type="indexterm" data-startref="ch07-cdlw" id="idm46177461031384"/><a data-type="indexterm" data-startref="ch07-cdlw2" id="idm46177461030680"/><a data-type="indexterm" data-startref="ch07-cdlw3" id="idm46177461030008"/><a data-type="indexterm" data-startref="ch07-cdlw4" id="idm46177461029336"/><a data-type="indexterm" data-startref="ch07-cdlw5" id="idm46177461028664"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Creating Tables with Queries"><div class="sect1" id="ADV2-SEC-CREATE">
<h1>Creating Tables with Queries</h1>

<p>You can create a table or easily create a copy of a table using a query.<a data-type="indexterm" data-primary="queries" data-secondary="creating tables with" id="ch07-qct"/><a data-type="indexterm" data-primary="CREATE TABLE" data-secondary="queries creating" id="ch07-qct2"/><a data-type="indexterm" data-primary="tables" data-secondary="creating tables" data-tertiary="queries creating" id="ch07-qct3"/> This is useful when you want to build a new database using existing data—for example, you might want to copy across a list of countries—or when you want to reorganize data for some reason. Data reorganization is common when producing reports, merging data from two or more tables, and redesigning on the fly. This short section shows you how it’s done.</p>
<div data-type="tip"><h6>Tip</h6>
<p>We base all the examples here on the unmodified <code>sakila</code> database. You should repeat the steps given in <a data-type="xref" href="ch02.xhtml#BAS-SEC-MODELING-EXAMPLES">“Entity Relationship Modeling Examples”</a> to get the database back to its clean state before proceeding.</p>
</div>

<p>In MySQL, you can easily duplicate the structure of a table using a variant of the 
<span class="keep-together"><code>CREATE TABLE</code></span> syntax:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">USE</code><code> </code><code class="n">sakila</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Database changed</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">actor_2</code><code> </code><code class="k">LIKE</code><code> </code><code class="n">actor</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.24 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DESCRIBE</code><code> </code><code class="n">actor_2</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+-------------+-------------------+------+-----+...
| Field       | Type              | Null | Key |...
+-------------+-------------------+------+-----+...
| actor_id    | smallint unsigned | NO   | PRI |...
| first_name  | varchar(45)       | NO   |     |...
| last_name   | varchar(45)       | NO   | MUL |...
| last_update | timestamp         | NO   |     |...
+-------------+-------------------+------+-----+...</pre>

<pre data-type="programlisting" class="less_space pagebreak-before">...+-------------------+-----------------------------------------------+
...| Default           | Extra                                         |
...+-------------------+-----------------------------------------------+
...| NULL              | auto_increment                                |
...| NULL              |                                               |
...| NULL              |                                               |
...| CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
...+-------------------+-----------------------------------------------+
4 rows in set (0.01 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">actor_2</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Empty set (0.00 sec)</pre>

<p>The <code>LIKE</code> syntax allows you to create a new table with exactly<a data-type="indexterm" data-primary="LIKE clause" data-secondary="creating tables with queries" id="idm46177460897352"/> the same structure as another, including keys. You can see that it doesn’t copy the data across. You can also use the <code>IF NOT EXISTS</code> and <code>TEMPORARY</code> features with this syntax.</p>

<p>If you want to create a table and copy some data, you can do that with a combination of the <code>CREATE TABLE</code> and <code>SELECT</code> statements. Let’s remove the <code>actor_2</code> table and re-create it using this new approach:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DROP</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">actor_2</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.08 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">actor_2</code><code> </code><code class="k">AS</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">from</code><code> </code><code class="n">actor</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 200 rows affected (0.03 sec)
Records: 200  Duplicates: 0  Warnings: 0</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">actor_2</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">5</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+----------+------------+--------------+---------------------+
| actor_id | first_name | last_name    | last_update         |
+----------+------------+--------------+---------------------+
|        1 | PENELOPE   | GUINESS      | 2006-02-15 04:34:33 |
|        2 | NICK       | WAHLBERG     | 2006-02-15 04:34:33 |
|        3 | ED         | CHASE        | 2006-02-15 04:34:33 |
|        4 | JENNIFER   | DAVIS        | 2006-02-15 04:34:33 |
|        5 | JOHNNY     | LOLLOBRIGIDA | 2006-02-15 04:34:33 |
+----------+------------+--------------+---------------------+
5 rows in set (0.01 sec)</pre>

<p>An identical table, <code>actor_2</code>, is created, and all the data is<a data-type="indexterm" data-primary="CTAS (CREATE TABLE AS SELECT)" id="idm46177460797528"/><a data-type="indexterm" data-primary="CREATE TABLE" data-secondary="queries creating" data-tertiary="CTAS (CREATE TABLE AS SELECT)" id="idm46177460796856"/><a data-type="indexterm" data-primary="tables" data-secondary="creating tables" data-tertiary="CTAS (CREATE TABLE AS SELECT)" id="idm46177460795672"/><a data-type="indexterm" data-primary="queries" data-secondary="creating tables with" data-tertiary="CTAS (CREATE TABLE AS SELECT)" id="idm46177460794488"/> copied across by the <code>SELECT</code> statement. <code>CREATE TABLE AS SELECT</code>, or <code>CTAS</code>, is a common name for this action, but it’s actually not mandatory to specify the <code>AS</code> part, and we’ll omit that later.</p>

<p>This technique is powerful. You can create new tables with new structures and use powerful queries to populate them with data. For example, here’s a <code>report</code> table that’s created to contain the names of the films in our database and their categories:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="nf">report</code><code> </code><code class="p">(</code><code class="n">title</code><code> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">128</code><code class="p">)</code><code class="p">,</code><code> </code><code class="n">category</code><code> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">25</code><code class="p">)</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="n">name</code><code> </code><code class="k">AS</code><code> </code><code class="n">category</code><code> </code><code class="k">FROM</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">film</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">film_category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">category_id</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 1000 rows affected (0.06 sec)
Records: 1000  Duplicates: 0  Warnings: 0</pre>

<p>You can see that the syntax is a little different from the previous example. In this example, the new table name, <code>report</code>, is followed by a list of column names and types in parentheses; this is necessary because we’re not duplicating the structure of an existing table. Moreover, we actually change <code>name</code> to <code>category</code>. Then, the <code>SELECT</code> statement follows, with its output matching the new columns in the new table. You can check the contents of the new table to see the result:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">report</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">5</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+---------------------+----------+
| title               | category |
+---------------------+----------+
| AMADEUS HOLY        | Action   |
| AMERICAN CIRCUS     | Action   |
| ANTITRUST TOMATOES  | Action   |
| ARK RIDGEMONT       | Action   |
| BAREFOOT MANCHURIAN | Action   |
+---------------------+----------+
5 rows in set (0.00 sec)</pre>

<p>So, in this example, the <code>title</code> and <code>name</code> values from the <code>SELECT</code> statement are used to populate the new <code>title</code> and <code>category</code> columns in the <code>report</code> table.</p>

<p>Creating tables with a query has a major caveat that you need to be careful about: it doesn’t copy the indexes (or foreign keys, if you use them). This is a feature, since it gives you a lot of flexibility, but it can be a catch if you forget. Have a look at our <code>actor_2</code> example:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DESCRIBE</code><code> </code><code class="n">actor_2</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+-------------+-------------------+------+-----+...
| Field       | Type              | Null | Key |...
+-------------+-------------------+------+-----+...
| actor_id    | smallint unsigned | NO   |     |...
| first_name  | varchar(45)       | NO   |     |...
| last_name   | varchar(45)       | NO   |     |...
| last_update | timestamp         | NO   |     |...
+-------------+-------------------+------+-----+...
...+-------------------+-----------------------------------------------+
...| Default           | Extra                                         |
...+-------------------+-----------------------------------------------+
...| 0                 |                                               |
...| NULL              |                                               |
...| NULL              |                                               |
...| CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
...+-------------------+-----------------------------------------------+
4 rows in set (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SHOW</code><code> </code><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">actor_2</code><code class="err">\</code><code class="n">G</code></strong></pre>

<pre data-type="programlisting">*************************** 1. row ***************************
       Table: actor_2
Create Table: CREATE TABLE `actor_2` (
  `actor_id` smallint unsigned NOT NULL DEFAULT '0',
  `first_name` varchar(45) NOT NULL,
  `last_name` varchar(45) NOT NULL,
  `last_update` timestamp NOT NULL
    DEFAULT CURRENT_TIMESTAMP
    ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
    COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.00 sec)</pre>

<p>You can see that there’s no primary key; the <code>idx_actor_last_name</code> key is missing as well, as is the <code>AUTO_INCREMENT</code> property of the <code>actor_id</code> column.</p>

<p>To copy indexes across to the new table, there are at least<a data-type="indexterm" data-primary="indexes" data-secondary="copying to new tables" id="idm46177460609976"/><a data-type="indexterm" data-primary="tables" data-secondary="creating tables" data-tertiary="indexes copied to new" id="idm46177460609000"/><a data-type="indexterm" data-primary="CREATE TABLE" data-secondary="indexes copied to new" id="idm46177460607784"/><a data-type="indexterm" data-primary="queries" data-secondary="creating tables with" data-tertiary="indexes copied to new" id="idm46177460606840"/> three things you can do. The first is to use the <code>LIKE</code> statement to create the empty table with the indexes, as described earlier, and then copy the data across using an <code>INSERT</code> with a <code>SELECT</code> statement, as described in <a data-type="xref" href="#ADV2-SEC-INSERTQUERY">“Inserting Data Using Queries”</a>.</p>

<p>The second thing you can do is to use <code>CREATE TABLE</code> with a <code>SELECT</code> statement and then add indexes using <code>ALTER</code> <code>TABLE</code> as described in <a data-type="xref" href="ch04.xhtml#CH4_MODIFY">Chapter 4</a>.</p>

<p>The third option is to use the <code>UNIQUE</code> (or <code>PRIMARY KEY</code> or <code>KEY</code>) keyword in combination with <code>CREATE TABLE</code> and <code>SELECT</code> to add a primary key index. Here’s an example of this approach:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DROP</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">actor_2</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.04 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="nf">actor_2</code><code> </code><code class="p">(</code><code class="k">UNIQUE</code><code class="p">(</code><code class="n">actor_id</code><code class="p">)</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">AS</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">from</code><code> </code><code class="n">actor</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 200 rows affected (0.05 sec)
Records: 200  Duplicates: 0  Warnings: 0</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DESCRIBE</code><code> </code><code class="n">actor_2</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+-------------+-------------------+------+-----+...
| Field       | Type              | Null | Key |...
+-------------+-------------------+------+-----+...
| actor_id    | smallint unsigned | NO   | PRI |...
| first_name  | varchar(45)       | NO   |     |...
| last_name   | varchar(45)       | NO   |     |...
| last_update | timestamp         | NO   |     |...
+-------------+-------------------+------+-----+...</pre>

<pre data-type="programlisting" class="less_space pagebreak-before">...+-------------------+-----------------------------------------------+
...| Default           | Extra                                         |
...+-------------------+-----------------------------------------------+
...| 0                 |                                               |
...| NULL              |                                               |
...| NULL              |                                               |
...| CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
...+-------------------+-----------------------------------------------+
4 rows in set (0.01 sec)</pre>

<p>The <code>UNIQUE</code> keyword is applied to the <code>actor_id</code> column,<a data-type="indexterm" data-primary="primary key" data-secondary="UNIQUE and PRIMARY KEY same" id="idm46177460493576"/><a data-type="indexterm" data-primary="primary key" data-secondary="PRIMARY KEY clause" data-tertiary="UNIQUE the same" id="idm46177460492600"/><a data-type="indexterm" data-primary="UNIQUE same as PRIMARY KEY" id="idm46177460491384"/> making it the primary key in the newly created table. The keywords <code>UNIQUE</code> and <code>PRIMARY KEY</code> can be interchanged.</p>

<p>You can use different modifiers when you’re creating tables using these techniques. For example, here’s a table created with defaults and other settings:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="nf">actor_3</code><code> </code><code class="p">(</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">actor_id</code><code> </code><code class="kt">SMALLINT</code><code> </code><code class="k">UNSIGNED</code><code> </code><code class="k">NOT</code><code> </code><code class="no">NULL</code><code> </code><code class="kp">AUTO_INCREMENT</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">first_name</code><code> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">45</code><code class="p">)</code><code> </code><code class="k">NOT</code><code> </code><code class="no">NULL</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">last_name</code><code> </code><code class="kt">VARCHAR</code><code class="p">(</code><code class="mi">45</code><code class="p">)</code><code> </code><code class="k">NOT</code><code> </code><code class="no">NULL</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="n">last_update</code><code> </code><code class="kt">TIMESTAMP</code><code> </code><code class="k">NOT</code><code> </code><code class="no">NULL</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>     </code><strong><code class="k">DEFAULT</code><code> </code><code class="k">CURRENT_TIMESTAMP</code><code> </code><code class="k">ON</code><code> </code><code class="k">UPDATE</code><code> </code><code class="k">CURRENT_TIMESTAMP</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="k">PRIMARY</code><code> </code><code class="k">KEY</code><code> </code><code class="p">(</code><code class="n">actor_id</code><code class="p">)</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code>   </code><strong><code class="k">KEY</code><code> </code><code class="nf">idx_actor_last_name</code><code> </code><code class="p">(</code><code class="n">last_name</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">)</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">actor</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 200 rows affected (0.05 sec)
Records: 200  Duplicates: 0  Warnings: 0</pre>

<p>Here, we’ve set <code>NOT NULL</code> for the new columns, used the <code>AUTO_INCREMENT</code> feature on <code>actor_id</code>, and created two keys. Anything you can do in a regular <code>CREATE TABLE</code> statement can be done in this variant; just remember to add those indexes explicitly!<a data-type="indexterm" data-startref="ch07-qct" id="idm46177460370760"/><a data-type="indexterm" data-startref="ch07-qct2" id="idm46177460389112"/><a data-type="indexterm" data-startref="ch07-qct3" id="idm46177460388504"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Performing Updates and Deletes with Multiple Tables"><div class="sect1" id="ADV2-SEC-UPDEL">
<h1>Performing Updates and Deletes with Multiple Tables</h1>

<p>In <a data-type="xref" href="ch03.xhtml#CH3_BASICS">Chapter 3</a>, we showed you how to update and delete data. In the examples there, each update and delete affected one table and used properties of that table to decide what to modify. This section shows you more complex updates and deletes. As you’ll see, you can delete or update rows from more than one table in one statement, and you can use those or other tables to decide what rows to change.</p>








<section data-type="sect2" data-pdf-bookmark="Deletion"><div class="sect2" id="ADV2-SEC-DELETE">
<h2>Deletion</h2>

<p>Imagine you’re cleaning up a database, perhaps because you’re<a data-type="indexterm" data-primary="database cleanup" id="ch07-dcu"/><a data-type="indexterm" data-primary="relationships" data-secondary="database cleanup of dangling data" id="ch07-dcu3"/><a data-type="indexterm" data-primary="queries" data-secondary="multiple table actions" data-tertiary="DELETE" id="ch07-mtd"/><a data-type="indexterm" data-primary="DELETE" data-secondary="multiple tables" id="ch07-mtd2"/><a data-type="indexterm" data-primary="tables" data-secondary="DELETE" data-tertiary="multiple tables" id="ch07-mtd3"/><a data-type="indexterm" data-primary="tables" data-secondary="multiple table actions" data-tertiary="DELETE" id="idm46177460332984"/><a data-type="indexterm" data-primary="rows" data-secondary="DELETE" data-tertiary="multiple tables" id="ch07-mtd5"/><a data-type="indexterm" data-primary="rows" data-secondary="multiple table actions" data-tertiary="DELETE" id="ch07-mtd6"/> running out of space. One way to solve this problem is to remove some data. For example, in the <code>sakila</code> database, it might make sense to remove films that are present in our inventory, but have never been rented. Unfortunately, this means you need to remove data from the <code>inventory</code> table using information from the <code>rental</code> table.</p>

<p>With the techniques we’ve described so far in the book, there’s no way of doing this without creating a table that combines the two tables (perhaps using <code>INSERT</code> with <code>SELECT</code>), removing unwanted rows, and copying the data back to its source. This section shows you how you can perform this procedure and other more advanced types of deletion more elegantly.</p>

<p>Consider the query you need to write to find films in the <code>inventory</code> table that have never been rented. <a data-type="indexterm" data-primary="nested queries" data-secondary="deleting across multiple tables" id="idm46177460325496"/>One way to do it is to use a nested query, employing the techniques we showed you in <a data-type="xref" href="ch05.xhtml#CH5_ADV1">Chapter 5</a>, with the <code>NOT EXISTS</code> clause. Here’s the query:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">inventory</code><code> </code><code class="k">WHERE</code><code> </code><code class="k">NOT</code><code> </code><code class="k">EXISTS</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="k">SELECT</code><code> </code><code class="mi">1</code><code> </code><code class="k">FROM</code><code> </code><code class="n">rental</code><code> </code><code class="k">WHERE</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">rental</code><code class="p">.</code><code class="n">inventory_id</code><code> </code><code class="o">=</code><code> </code><code class="n">inventory</code><code class="p">.</code><code class="n">inventory_id</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+--------------+---------+----------+---------------------+
| inventory_id | film_id | store_id | last_update         |
+--------------+---------+----------+---------------------+
|            5 |       1 |        2 | 2006-02-15 05:09:17 |
+--------------+---------+----------+---------------------+
1 row in set (0.01 sec)</pre>

<p>You can probably see how it works, but let’s briefly discuss it anyway before we move on. You can see that this query uses a correlated subquery, where the current row being processed in the outer query is referenced by the subquery; you can tell this because the <code>inventory_id</code> column from <code>inventory</code> is referenced, but the <code>inventory</code> table isn’t listed in the <code>FROM</code> clause of the subquery. The subquery produces output when there’s a row in the <code>rental</code> table that matches the current row in the outer query (and so an inventory entry was rented). However, since the query uses <code>NOT EXISTS</code>, the outer query doesn’t produce output when this is the case, and so the overall result is that rows are output for inventory records of movies that haven’t been rented.</p>

<p>Now let’s take our query and turn it into a <code>DELETE</code> statement. Here it is:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DELETE</code><code> </code><code class="k">FROM</code><code> </code><code class="n">inventory</code><code> </code><code class="k">WHERE</code><code> </code><code class="k">NOT</code><code> </code><code class="k">EXISTS</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="k">SELECT</code><code> </code><code class="mi">1</code><code> </code><code class="k">FROM</code><code> </code><code class="n">rental</code><code> </code><code class="k">WHERE</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">rental</code><code class="p">.</code><code class="n">inventory_id</code><code> </code><code class="o">=</code><code> </code><code class="n">inventory</code><code class="p">.</code><code class="n">inventory_id</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 1 row affected (0.04 sec)</pre>

<p>You can see that the subquery remains the same, but the outer <code>SELECT</code> query is replaced by a <code>DELETE</code> statement. Here, we’re following the standard <code>DELETE</code> syntax: the keyword <code>DELETE</code> is followed by <code>FROM</code> and a specification of the table or tables from which rows should be removed, then a <code>WHERE</code> clause (and any other query clauses, such as <code>GROUP BY</code> or <code>HAVING</code>). In this query, rows are deleted from the <code>inventory</code> table, but in the <code>WHERE</code> clause a subquery is specified within a <code>NOT EXISTS</code> statement.</p>

<p class="pagebreak-before">While this statement does indeed delete rows from one table based on data from another table, it’s basically a variation of a regular <code>DELETE</code>. <a data-type="indexterm" data-primary="left joins" data-secondary="deleting with multiple tables" id="idm46177460224856"/>To convert this particular statement into a multitable <code>DELETE</code>, we should switch from a nested subquery to a <code>LEFT JOIN</code>, like so:</p>

<pre data-type="programlisting" data-code-language="mysql"><strong><code class="k">DELETE</code><code> </code><code class="n">inventory</code><code> </code><code class="k">FROM</code><code> </code><code class="n">inventory</code><code> </code><code class="k">LEFT</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">rental</code><code>
</code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">inventory_id</code><code class="p">)</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">rental</code><code class="p">.</code><code class="n">inventory_id</code><code> </code><code class="k">IS</code><code> </code><code class="no">NULL</code><code class="p">;</code></strong></pre>

<p>Note how the syntax changes to include the specific table (or tables) where we want to delete the rows we find. These tables are specified after <code>DELETE</code> but before the <code>FROM</code> and query specification. There’s another way to write this query, however, and it’s the one we prefer:</p>

<pre data-type="programlisting" data-code-language="mysql"><strong><code class="k">DELETE</code><code> </code><code class="k">FROM</code><code> </code><code class="n">inventory</code><code> </code><code class="k">USING</code><code> </code><code class="n">inventory</code><code>
</code><code class="k">LEFT</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">rental</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">inventory_id</code><code class="p">)</code><code>
</code><code class="k">WHERE</code><code> </code><code class="n">rental</code><code class="p">.</code><code class="n">inventory_id</code><code> </code><code class="k">IS</code><code> </code><code class="no">NULL</code><code class="p">;</code></strong></pre>

<p>This query is a mix of the previous two. We do not specify the deletion targets between <code>DELETE</code> and <code>FROM</code>, and write them down as if this were a regular deletion. <a data-type="indexterm" data-primary="USING clause of filter queries" id="idm46177460114376"/>Instead, we use a special <code>USING</code> clause, which indicates that a filter query (a join or otherwise) is going to follow. This is slightly clearer in our opinion than the previous example of <code>DELETE</code> <em><code>table</code></em> <code>FROM</code> <em><code>table</code></em>. One downside of using the <code>USING</code> keyword is that it can be mixed up with the <code>USING</code> keyword of a <code>JOIN</code> statement. With some practice, you’ll never make that mistake, though.</p>

<p>Now that we know both multitable syntax variants, we can construct a query that actually requires a multitable delete. <a data-type="indexterm" data-primary="DELETE" data-secondary="relationships causing failure" id="idm46177460109368"/><a data-type="indexterm" data-primary="relationships" data-secondary="DELETE failure" id="idm46177460108424"/><a data-type="indexterm" data-primary="foreign key constraints" data-secondary="delete with multiple tables" id="idm46177460107480"/>One example of a situation that could require such a statement is deleting records from tables that are involved in foreign key relationships. In the <code>sakila</code> database, there are records for films in the <code>film</code> table that have no associated records in the <code>inventory</code> table. That is, there are films that there’s information on, but that cannot be rented. Suppose that as part of the database cleanup operation, we’re tasked with removing such dangling data. Initially this seems easy enough:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DELETE</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">WHERE</code><code> </code><code class="k">NOT</code><code> </code><code class="k">EXISTS</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="k">SELECT</code><code> </code><code class="mi">1</code><code> </code><code class="k">FROM</code><code> </code><code class="n">inventory</code><code> </code><code class="k">WHERE</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">film</code><code class="p">.</code><code class="n">film_id</code><code> </code><code class="o">=</code><code> </code><code class="n">inventory</code><code class="p">.</code><code class="n">film_id</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">ERROR 1451 (23000): Cannot delete or update a parent row:
a foreign key constraint fails (
`sakila`.`film_actor`, CONSTRAINT `fk_film_actor_film`
FOREIGN KEY (`film_id`) REFERENCES `film` (`film_id`)
ON DELETE RESTRICT ON UPDATE CASCADE)</pre>

<p>Alas, the integrity constraint prevents this deletion. We will have to remove not only the films, but also relationships between those films and actors. That may generate orphan actors, which can be deleted next. We could try to delete films and references to actors in one go, like this:</p>

<pre data-type="programlisting" data-code-language="mysql"><strong><code class="k">DELETE</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film_actor</code><code class="p">,</code><code> </code><code class="n">film</code><code> </code><code class="k">USING</code><code>
</code><code class="n">film</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">film_actor</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code><code>
</code><code class="k">LEFT</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">inventory</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code><code>
</code><code class="k">WHERE</code><code> </code><code class="n">inventory</code><code class="p">.</code><code class="n">film_id</code><code> </code><code class="k">IS</code><code> </code><code class="no">NULL</code><code class="p">;</code></strong></pre>

<p>Unfortunately, even though the <code>film_actor</code> table is listed before the <code>film</code> table, the deletion from <code>film</code> still fails. It’s not possible to tell the optimizer to process tables in a particular order. Even if this example were to have executed successfully, it’s not a good practice to rely on such behavior as the optimizer may later change the table order unpredictably, causing failures. <a data-type="indexterm" data-primary="MySQL" data-secondary="differences from standard SQL" id="idm46177459994168"/><a data-type="indexterm" data-primary="foreign key constraints" data-secondary="MySQL vs SQL check" id="idm46177459993224"/><a data-type="indexterm" data-primary="committing transactions" data-secondary="foreign key check" id="idm46177459992280"/><a data-type="indexterm" data-primary="transactions" data-secondary="foreign key check" data-seealso="committing transactions" id="idm46177459991336"/>This example highlights a difference between MySQL and the SQL standard: the standard specifies that the foreign keys are checked at transaction commit, whereas MySQL checks them immediately, preventing this statement from succeeding. Even if we were able to resolve this problem, films are also related to categories, so that will have to be taken care of too.</p>

<p>MySQL allows a few ways out of this situation. The first one is to execute a series of <code>DELETE</code> statements within one transaction (we talked more about transactions in Chapter 6):</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="n">BEGIN</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DELETE</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film_actor</code><code> </code><code class="k">USING</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">film</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">film_actor</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">LEFT</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">inventory</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">inventory</code><code class="p">.</code><code class="n">film_id</code><code> </code><code class="k">IS</code><code> </code><code class="no">NULL</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 216 rows affected (0.01 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DELETE</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film_category</code><code> </code><code class="k">USING</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">film</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">film_category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">LEFT</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">inventory</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">inventory</code><code class="p">.</code><code class="n">film_id</code><code> </code><code class="k">IS</code><code> </code><code class="no">NULL</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 42 rows affected (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DELETE</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">USING</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">film</code><code> </code><code class="k">LEFT</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">inventory</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">inventory</code><code class="p">.</code><code class="n">film_id</code><code> </code><code class="k">IS</code><code> </code><code class="no">NULL</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 42 rows affected (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="n">ROLLBACK</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.02 sec)</pre>

<p>You can see that we executed <code>ROLLBACK</code> instead of<a data-type="indexterm" data-primary="ROLLBACK" id="idm46177459776264"/> <code>COMMIT</code> to preserve the rows. In reality, you would of course use <code>COMMIT</code> to “save” the results of your operation.</p>

<p>The second option is dangerous. It is possible to suspend<a data-type="indexterm" data-primary="foreign key constraints" data-secondary="foreign_key_checks variable" id="idm46177459746808"/> foreign key constraints by temporarily setting the <code>foreign_key_checks</code> system variable to <code>0</code> on the session level. We recommend against this practice, but it’s the only way to delete from all three tables at the same time:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="kt">SET</code><code> </code><code class="n">foreign_key_checks</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="n">BEGIN</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DELETE</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film</code><code class="p">,</code><code> </code><code class="n">film_actor</code><code class="p">,</code><code> </code><code class="n">film_category</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">USING</code><code> </code><code class="n">film</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">film_actor</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">film_category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">LEFT</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">inventory</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">inventory</code><code class="p">.</code><code class="n">film_id</code><code> </code><code class="k">IS</code><code> </code><code class="no">NULL</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 300 rows affected (0.03 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="n">ROLLBACK</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="kt">SET</code><code> </code><code class="n">foreign_key_checks</code><code class="o">=</code><code class="mi">1</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.00 sec)</pre>

<p>While we don’t recommend disabling foreign key checks, doing so allows us to show the power of multitable deletes. Here, with one query it was possible to achieve what took three queries in the previous example.</p>

<p>Let’s break down this query. The tables from which rows will be deleted (if matched) are <code>film</code>, <code>film_actor</code>, and <code>film_category</code>. We specified them between the <code>DELETE FROM</code> and <code>USING</code> terms for clarity. <code>USING</code> starts our query, the filtering part of the <code>DELETE</code> statement. In this example, we have constructed a four-table join. We have joined <code>film</code>, <code>film_actor</code>, and <code>film_category</code> using <code>INNER JOIN</code>, as we need only matching rows. To the result of those joins, we <code>LEFT JOIN</code> the <code>inventory</code> table. In this context, using a left join is extremely important, because we are actually interested only in rows where <code>inventory</code> will have no records. We express that with <code>WHERE inventory.film_id IS NULL</code>. The result of this query is that we get all films not in <code>inventory</code>, then all film-actor relationships for those films, along with all category relationships for the films.</p>

<p>Is it possible to make this query safe to use with foreign keys? Not without breaking it down, unfortunately, but we can do better than having to run three queries:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="n">BEGIN</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DELETE</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film_actor</code><code class="p">,</code><code> </code><code class="n">film_category</code><code> </code><code class="k">USING</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">film</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">film_actor</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">film_category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">LEFT</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">inventory</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">inventory</code><code class="p">.</code><code class="n">film_id</code><code> </code><code class="k">IS</code><code> </code><code class="no">NULL</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 258 rows affected (0.02 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DELETE</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">USING</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">film</code><code> </code><code class="k">LEFT</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">inventory</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">inventory</code><code class="p">.</code><code class="n">film_id</code><code> </code><code class="k">IS</code><code> </code><code class="no">NULL</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 42 rows affected (0.01 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="n">ROLLBACK</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.01 sec)</pre>

<p>What we’ve done here is combined deletion from the <code>film_actor</code> and <code>film_category</code> tables into a single <code>DELETE</code> statement, thus allowing deletion from <code>film</code> without any error. The difference from the previous example is that we <code>DELETE FROM</code> two tables instead of three.</p>

<p>Let’s talk about the number of rows affected. In the first example, we deleted 42 rows from <code>film</code>, 42 rows from <code>film_category</code>, and 216 rows from the <code>film_actor</code> table. In the second example, our single <code>DELETE</code> query removed 300 rows. In the final example, we removed 258 rows combined from the <code>film_category</code> and <code>film_actor</code> tables, and 42 rows from the <code>film</code> table. You can probably guess by now that for a multitable delete MySQL will output the total number of rows deleted, without a breakdown into individual tables. This makes it harder to keep track of exactly how many rows were touched in each table.<a data-type="indexterm" data-startref="ch07-dcu" id="idm46177459355736"/><a data-type="indexterm" data-startref="ch07-dcu2" id="idm46177459355032"/><a data-type="indexterm" data-startref="ch07-dcu3" id="idm46177459339896"/></p>

<p>Also, in multitable deletes you can’t use the <code>ORDER BY</code> or <code>LIMIT</code> clauses.<a data-type="indexterm" data-startref="ch07-mtd" id="idm46177459338264"/><a data-type="indexterm" data-startref="ch07-mtd2" id="idm46177459337656"/><a data-type="indexterm" data-startref="ch07-mtd3" id="idm46177459337048"/><a data-type="indexterm" data-startref="ch07-mtd5" id="idm46177459336440"/><a data-type="indexterm" data-startref="ch07-mtd6" id="idm46177459335832"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Updates"><div class="sect2" id="ADV2-SEC-UPDATES">
<h2>Updates</h2>

<p>Now we’ll contrive an example using the <code>sakila</code> database to<a data-type="indexterm" data-primary="rows" data-secondary="UPDATE" data-tertiary="multiple tables" id="idm46177459333944"/><a data-type="indexterm" data-primary="rows" data-secondary="multiple table actions" data-tertiary="UPDATE" id="idm46177459332856"/><a data-type="indexterm" data-primary="tables" data-secondary="updates across multiple tables" id="idm46177459331768"/><a data-type="indexterm" data-primary="tables" data-secondary="multiple table actions" data-tertiary="UPDATE" id="idm46177459330920"/><a data-type="indexterm" data-primary="UPDATE" data-secondary="multiple tables" id="idm46177459329832"/><a data-type="indexterm" data-primary="queries" data-secondary="multiple table actions" data-tertiary="UPDATE" id="idm46177459328984"/> illustrate multiple-table updates. We’ve decided to change the ratings of all horror films to R, regardless of the original rating. To begin, let’s display the horror films and their ratings:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">name</code><code> </code><code class="n">category</code><code class="p">,</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="n">rating</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">film_category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">category_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Horror'</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+----------+-----------------------------+--------+
| category | title                       | rating |
+----------+-----------------------------+--------+
| Horror   | ACE GOLDFINGER              | G      |
| Horror   | AFFAIR PREJUDICE            | G      |
| Horror   | AIRPORT POLLOCK             | R      |
| Horror   | ALABAMA DEVIL               | PG-13  |
| ...                                             |
| Horror   | ZHIVAGO CORE                | NC-17  |
+----------+-----------------------------+--------+
56 rows in set (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql" class="less_space pagebreak-before"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="nf">COUNT</code><code class="p">(</code><code class="n">title</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">FROM</code><code> </code><code class="n">film</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">film_category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">category_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Horror'</code><code> </code><code class="k">AND</code><code> </code><code class="n">rating</code><code> </code><code class="o">&lt;</code><code class="o">&gt;</code><code> </code><code class="s1">'R'</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+--------------+
| COUNT(title) |
+--------------+
|           42 |
+--------------+
1 row in set (0.00 sec)</pre>

<p>We don’t know about you, but we’d love to see a G-rated horror film! Now, let’s put that query into an <code>UPDATE</code> statement:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">UPDATE</code><code> </code><code class="n">film</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">film_category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">category_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="kt">SET</code><code> </code><code class="n">rating</code><code> </code><code class="o">=</code><code> </code><code class="s1">'R'</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">category</code><code class="p">.</code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Horror'</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 42 rows affected (0.01 sec)
Rows matched: 56  Changed: 42  Warnings: 0</pre>

<p>Let’s look at the syntax. A multiple-table update looks similar to a <code>SELECT</code> query. The <code>UPDATE</code> statement is followed by a list of tables that incorporates whatever join clauses you need or prefer; in this example, we’ve used <code>JOIN</code> (remember, that’s <code>INNER JOIN</code>) to bring together the <code>film</code> and <code>film_category</code> tables. This is followed by the keyword <code>SET</code>, with assignments to individual columns. Here you can see that only one column is modified (to change the ratings to R), so columns in all other tables besides <code>film</code> aren’t modified. The following <code>WHERE</code> is optional, but is necessary in this example to only touch rows with the category name <code>Horror</code>.</p>

<p>Note how MySQL reports that 56 rows were matched, but only 42 updated. If you look at the results of the previous <code>SELECT</code> queries, you’ll see that they show the counts of films in the Horror category (56), and films in that category with a rating other than R (42). Only 42 rows were updated because the other films already had that rating.</p>

<p>As with multitable deletes, there are some limitations on multitable updates:</p>

<ul>
<li>
<p>You can’t use <code>ORDER BY</code>.</p>
</li>
<li>
<p>You can’t use <code>LIMIT</code>.</p>
</li>
<li>
<p>You can’t update a table that’s read from in a nested subquery.</p>
</li>
</ul>

<p>Other than that, multitable updates are much the same as single-table ones.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Replacing Data"><div class="sect1" id="ADV2-SEC-REPLACE">
<h1>Replacing Data</h1>

<p>You’ll sometimes want to overwrite data. You can do this in two ways using the techniques we’ve shown previously:<a data-type="indexterm" data-primary="rows" data-secondary="multiple table actions" data-tertiary="REPLACE" id="ch07-rep8"/><a data-type="indexterm" data-primary="rows" data-secondary="REPLACE with multiple tables" id="ch07rep5"/><a data-type="indexterm" data-primary="tables" data-secondary="replacing data over multiple tables" id="ch07rep"/><a data-type="indexterm" data-primary="tables" data-secondary="multiple table actions" data-tertiary="REPLACE" id="ch07rep2"/><a data-type="indexterm" data-primary="REPLACE" data-secondary="multiple tables" id="ch07rep3"/><a data-type="indexterm" data-primary="queries" data-secondary="multiple table actions" data-tertiary="REPLACE" id="ch07-rep6"/><a data-type="indexterm" data-primary="queries" data-secondary="REPLACE" data-tertiary="multiple tables" id="ch07rep7"/></p>

<ul>
<li>
<p>Delete an existing row using its primary key and then insert a replacement with the same primary key.</p>
</li>
<li>
<p>Update a row using its primary key, replacing some or all of the values (except the primary key).</p>
</li>
</ul>

<p>The <code>REPLACE</code> statement gives you a third, convenient way to change data. This section explains how it works.</p>

<p>The <code>REPLACE</code> statement is just like <code>INSERT</code>, but with one difference.<a data-type="indexterm" data-primary="primary key" data-secondary="REPLACE" id="idm46177459092472"/> You can’t <code>INSERT</code> a new row if there is an existing row in the table with the same primary key. You can get around this problem with a <code>REPLACE</code> query, which first removes any existing row with the same primary key and then inserts the new one.</p>

<p>Let’s try an example, where we’ll replace the row for the actress <code>PENELOPE GUINESS</code> in the <code>sakila</code> database:<a data-type="indexterm" data-primary="relationships" data-secondary="DELETE failure" id="idm46177459089464"/><a data-type="indexterm" data-primary="DELETE" data-secondary="relationships causing failure" id="idm46177459088616"/></p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">REPLACE</code><code> </code><code class="k">INTO</code><code> </code><code class="n">actor</code><code> </code><code class="k">VALUES</code><code> </code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="s1">'Penelope'</code><code class="p">,</code><code> </code><code class="s1">'Guiness'</code><code class="p">,</code><code> </code><code class="nf">NOW</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">ERROR 1451 (23000): Cannot delete or update a parent row:
a foreign key constraint fails (`sakila`.`film_actor`,
CONSTRAINT `fk_film_actor_actor` FOREIGN KEY (`actor_id`)
REFERENCES `actor` (`actor_id`) ON DELETE RESTRICT ON UPDATE CASCADE)</pre>

<p>Unfortunately, as you’ll have guessed after reading the previous paragraph, <code>REPLACE</code> actually has to perform a <code>DELETE</code>. If your database is highly constrained referentially, like the <code>sakila</code> database is, the <code>REPLACE</code> will often not work. Let’s not fight against the database here and instead use the <code>actor_2</code> table we created in <a data-type="xref" href="#ADV2-SEC-CREATE">“Creating Tables with Queries”</a>:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">REPLACE</code><code> </code><code class="n">actor_2</code><code> </code><code class="k">VALUES</code><code> </code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="s1">'Penelope'</code><code class="p">,</code><code> </code><code class="s1">'Guiness'</code><code class="p">,</code><code> </code><code class="nf">NOW</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 2 rows affected (0.00 sec)</pre>

<p>You can see that MySQL reports that two rows were affected: first the old row was deleted, and then the new row was inserted. You can see that the change we made was minor—we just changed the case of the name—and therefore it could easily have been accomplished with an <code>UPDATE</code>. Because the tables in the <code>sakila</code> database are relatively small, it’s difficult to construct an example in which <code>REPLACE</code> looks simpler than <code>UPDATE</code>.</p>

<p class="pagebreak-before">You can use the different <code>INSERT</code> syntaxes with <code>REPLACE</code>, including using <code>SELECT</code> queries. Here are some examples:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">REPLACE</code><code> </code><code class="k">INTO</code><code> </code><code class="n">actor_2</code><code> </code><code class="k">VALUES</code><code> </code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="s1">'Penelope'</code><code class="p">,</code><code> </code><code class="s1">'Guiness'</code><code class="p">,</code><code> </code><code class="nf">NOW</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 2 rows affected (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">REPLACE</code><code> </code><code class="k">INTO</code><code> </code><code class="nf">actor_2</code><code> </code><code class="p">(</code><code class="n">actor_id</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">VALUES</code><code> </code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="s1">'Penelope'</code><code class="p">,</code><code> </code><code class="s1">'Guiness'</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 2 rows affected (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">REPLACE</code><code> </code><code class="nf">actor_2</code><code> </code><code class="p">(</code><code class="n">actor_id</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">VALUES</code><code> </code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="s1">'Penelope'</code><code class="p">,</code><code> </code><code class="s1">'Guiness'</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 2 rows affected (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">REPLACE</code><code> </code><code class="n">actor_2</code><code> </code><code class="kt">SET</code><code> </code><code class="n">actor_id</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">first_name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Penelope'</code><code class="p">,</code><code> </code><code class="n">last_name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Guiness'</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 2 rows affected (0.00 sec)</pre>

<p>The first variant is almost identical to our previous example, except it includes the optional <code>INTO</code> keyword (which, arguably, improves the readability of the statement). The second variant explicitly lists the column names that the matching values should be inserted into. The third variant is the same as the second, without the optional <code>INTO</code> keyword. The final variant uses the <code>SET</code> syntax; you can add the optional keyword <code>INTO</code> to this variant if you want. Note that if you don’t specify a value for a column, it’s set to its default value, just like for <code>INSERT</code>.</p>

<p>You can also bulk-replace into a table, removing and inserting more than one row. Here’s an example:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">REPLACE</code><code> </code><code class="nf">actor_2</code><code> </code><code class="p">(</code><code class="n">actor_id</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">VALUES</code><code> </code><code class="p">(</code><code class="mi">2</code><code class="p">,</code><code> </code><code class="s1">'Nick'</code><code class="p">,</code><code> </code><code class="s1">'Wahlberg'</code><code class="p">)</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="mi">3</code><code class="p">,</code><code> </code><code class="s1">'Ed'</code><code class="p">,</code><code> </code><code class="s1">'Chase'</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 4 rows affected (0.00 sec)
Records: 2  Duplicates: 2  Warnings: 0</pre>

<p>Note that four rows are affected: two deletions and two insertions. You can also see that two duplicates were found, meaning the replacement of existing rows succeeded. In contrast, if there isn’t a matching row in a <code>REPLACE</code> statement, it acts just like an <code>INSERT</code>:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">REPLACE</code><code> </code><code class="nf">actor_2</code><code> </code><code class="p">(</code><code class="n">actor_id</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">VALUES</code><code> </code><code class="p">(</code><code class="mi">1000</code><code class="p">,</code><code> </code><code class="s1">'William'</code><code class="p">,</code><code> </code><code class="s1">'Dyer'</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 1 row affected (0.00 sec)</pre>

<p>You can tell that only the insert occurred, since only one row was affected.</p>

<p class="pagebreak-before">Replacing also works with a <code>SELECT</code> statement. Recall the<a data-type="indexterm" data-primary="queries" data-secondary="REPLACE" id="idm46177458707352"/> <code>recommend</code> table from <a data-type="xref" href="#ADV2-SEC-INSERTQUERY">“Inserting Data Using Queries”</a>, at the beginning of this chapter. Suppose you’ve added 10 films to it, but you don’t like the choice of the seventh film in the list. Here’s how you can replace it with a random choice of another film:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">REPLACE</code><code> </code><code class="k">INTO</code><code> </code><code class="n">recommend</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">film_id</code><code class="p">,</code><code> </code><code class="n">language_id</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">release_year</code><code class="p">,</code><code> </code><code class="n">title</code><code class="p">,</code><code> </code><code class="n">length</code><code class="p">,</code><code> </code><code class="mi">7</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="nf">RAND</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">1</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 2 rows affected (0.00 sec)
Records: 1  Duplicates: 1  Warnings: 0</pre>

<p>Again, the syntax is the same as with <code>INSERT</code>, but a deletion is attempted (and succeeds!) before the insertion. Note that we keep the value of the <code>sequence_id</code> as 7.</p>

<p>If a table doesn’t have a primary key or another unique key, replacing doesn’t make sense.<a data-type="indexterm" data-primary="primary key" data-secondary="REPLACE" id="idm46177458652280"/> This is because there’s no way of uniquely identifying a matching row in order to delete it. When you use <code>REPLACE</code> on such a table, its behavior is identical to <code>INSERT</code>. Also, as with <code>INSERT</code>, you can’t replace rows in a table that’s used in a subquery. <a data-type="indexterm" data-primary="INSERT" data-secondary="IGNORE" data-tertiary="REPLACE versus" id="idm46177458649800"/><a data-type="indexterm" data-primary="IGNORE" data-secondary="REPLACE versus" id="idm46177458648552"/>Finally, note the difference between <code>INSERT IGNORE</code> and <code>REPLACE</code>: the first keeps the existing data with the duplicate key and does not insert the new row, while the second deletes the existing row and replaces it with the new one.</p>

<p>When specifying a list of columns for <code>REPLACE</code>, you have to list every column that does not have a default value. In our examples, we had to specify <code>actor_id</code>, <code>first_name</code>, and <code>last_name</code>, but we omitted the <code>last_update</code> column, which has a default value of <code>CURRENT_TIMESTAMP</code>.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p><code>REPLACE</code> is a powerful statement, but be careful when using<a data-type="indexterm" data-primary="REPLACE" data-secondary="caution" id="idm46177458613928"/> it, as the results can be unexpected. Pay special attention when you have auto-increment columns and multiple unique keys defined.</p>
</div>

<p>MySQL provides another nonstandard extension of SQL:<a data-type="indexterm" data-primary="MySQL" data-secondary="differences from standard SQL" id="idm46177458612296"/><a data-type="indexterm" data-primary="INSERT" data-secondary="ON DUPLICATE KEY UPDATE" id="idm46177458611032"/><a data-type="indexterm" data-primary="REPLACE" data-secondary="INSERT…ON DUPLICATE KEY UPDATE" id="idm46177458610184"/><a data-type="indexterm" data-primary="keys" data-secondary="INSERT…ON DUPLICATE KEY UPDATE" id="idm46177458609336"/> <code>INSERT ... ON DUPLICATE KEY UPDATE</code>. It is similar to <code>REPLACE</code>, but instead of <code>DELETE</code> followed by <code>INSERT</code>, it executes an <code>UPDATE</code> whenever a duplicate key is found. At the beginning of this section, we had an issue replacing a row in the <code>actor</code> table. MySQL refused to run a <code>REPLACE</code>, because deleting a row from the <code>actor</code> table would violate a foreign key constraint. It is, however, easily possible to achieve the desired result with the following statement:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="nf">actor_3</code><code> </code><code class="p">(</code><code class="n">actor_id</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">VALUES</code><code> </code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="s1">'Penelope'</code><code class="p">,</code><code> </code><code class="s1">'Guiness'</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">ON</code><code> </code><code class="n">DUPLICATE</code><code> </code><code class="k">KEY</code><code> </code><code class="k">UPDATE</code><code> </code><code class="n">first_name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Penelope'</code><code class="p">,</code><code> </code><code class="n">last_name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Guiness'</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 2 rows affected (0.00 sec)</pre>

<p>Note that we’re using the <code>actor_3</code> table created in <a data-type="xref" href="#ADV2-SEC-CREATE">“Creating Tables with Queries”</a>, as it has all the same constraints as the original <code>actor</code> table. The statement that we’ve just shown is very similar to <code>REPLACE</code> semantically, but has a few key differences. When you do not specify a value for a field in a <code>REPLACE</code> command, that field must have a <code>DEFAULT</code> value, and that default value will be set. That naturally follows from the fact that a completely new row is inserted. In the case of <code>INSERT ... ON</code> 
<span class="keep-together"><code>DUPLICATE</code></span> <code>KEY UPDATE</code>, we are updating an existing row, so it’s not necessary to list every column. We can do that if we want, though:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">actor_3</code><code> </code><code class="k">VALUES</code><code> </code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="s1">'Penelope'</code><code class="p">,</code><code> </code><code class="s1">'Guiness'</code><code class="p">,</code><code> </code><code class="nf">NOW</code><code class="p">(</code><code class="p">)</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">ON</code><code> </code><code class="n">DUPLICATE</code><code> </code><code class="k">KEY</code><code> </code><code class="k">UPDATE</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">actor_id</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">first_name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Penelope'</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">last_name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Guiness'</code><code class="p">,</code><code> </code><code class="n">last_update</code><code> </code><code class="o">=</code><code> </code><code class="nf">NOW</code><code class="p">(</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 2 rows affected (0.01 sec)</pre>

<p>To minimize the amount of typing necessary for this command and to allow inserting multiple rows, we can refer to the new field values in the <code>UPDATE</code> clause. Here’s an example with multiple rows, one of which is new:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="nf">actor_3</code><code> </code><code class="p">(</code><code class="n">actor_id</code><code class="p">,</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code class="p">)</code><code> </code><code class="k">VALUES</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="s1">'Penelope'</code><code class="p">,</code><code> </code><code class="s1">'Guiness'</code><code class="p">)</code><code class="p">,</code><code> </code><code class="p">(</code><code class="mi">2</code><code class="p">,</code><code> </code><code class="s1">'Nick'</code><code class="p">,</code><code> </code><code class="s1">'Wahlberg'</code><code class="p">)</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="mi">3</code><code class="p">,</code><code> </code><code class="s1">'Ed'</code><code class="p">,</code><code> </code><code class="s1">'Chase'</code><code class="p">)</code><code class="p">,</code><code> </code><code class="p">(</code><code class="mi">1001</code><code class="p">,</code><code> </code><code class="s1">'William'</code><code class="p">,</code><code> </code><code class="s1">'Dyer'</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">ON</code><code> </code><code class="n">DUPLICATE</code><code> </code><code class="k">KEY</code><code> </code><code class="k">UPDATE</code><code> </code><code class="n">first_name</code><code> </code><code class="o">=</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="n">first_name</code><code class="p">)</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">last_name</code><code> </code><code class="o">=</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="n">last_name</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">Query OK, 5 rows affected (0.01 sec)
Records: 4  Duplicates: 2</pre>

<p>Let’s review this query in more detail. We’re inserting four rows into the <code>actor_3</code> table, and by using <code>ON DUPLICATE KEY UPDATE</code> we’re telling MySQL to run an update on any duplicate rows it finds. Unlike in our previous example, however, this time we don’t set updated column values explicitly. Instead, we use the special <code>VALUES()</code> function to obtain the value of each column in the rows we passed to the <code>INSERT</code>. For example, for the second row, <code>2, Nick, Walhberg</code>, <code>VALUES(first_name)</code> will return <code>Nick</code>. Notice that MySQL reports we’ve updated an odd number of rows: five. Whenever a new row is inserted, the number of affected rows is incremented by one. Whenever an old row is updated, the number of affected rows is incremented by two. Since we’ve already updated the record for <code>Penelope</code> by running the previous query, our new insert doesn’t add anything new, and MySQL will skip the update as well. We are left with two updates for duplicate rows, and insertion of a completely new row, or five rows affected in total.<a data-type="indexterm" data-startref="ch07rep" id="idm46177458369832"/><a data-type="indexterm" data-startref="ch07rep2" id="idm46177458369448"/><a data-type="indexterm" data-startref="ch07rep3" id="idm46177458368840"/><a data-type="indexterm" data-startref="ch07rep5" id="idm46177458368232"/><a data-type="indexterm" data-startref="ch07-rep6" id="idm46177458367624"/><a data-type="indexterm" data-startref="ch07rep7" id="idm46177458367016"/><a data-type="indexterm" data-startref="ch07-rep8" id="idm46177458366408"/></p>
<div data-type="tip"><h6>Tip</h6>
<p>In most situations, we recommend that you default to using <code>INSERT ... ON DUPLICATE KEY UPDATE</code> instead of <code>REPLACE</code>.</p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="The EXPLAIN Statement"><div class="sect1" id="ADV1-SEC-EXPLAIN">
<h1>The EXPLAIN Statement</h1>

<p>You’ll sometimes find that MySQL doesn’t run queries as quickly<a data-type="indexterm" data-primary="EXPLAIN" id="ch07-exp"/><a data-type="indexterm" data-primary="performance" data-secondary="EXPLAIN" id="idm46177458319320"/><a data-type="indexterm" data-primary="debugging with EXPLAIN" id="idm46177458318472"/><a data-type="indexterm" data-primary="queries" data-secondary="EXPLAIN" id="idm46177458317864"/> as you expect. For example, you’ll often notice that a nested query runs slowly. You might also find—or, at least, suspect—that MySQL isn’t doing what you hoped, because you know an index exists but the query still seems slow. You can diagnose and solve query optimization problems using the <code>EXPLAIN</code> statement.</p>

<p>Analyzing query plans, understanding optimizer decisions, and tuning query performance are advanced topics, and more art than science: there’s no one way to do it. We are adding this section so that you know this capability exists, but we won’t get too deep into this topic.</p>

<p>The <code>EXPLAIN</code> statement helps you learn about a <code>SELECT</code> or<a data-type="indexterm" data-primary="EXPLAIN" data-secondary="EXPLAIN SELECT" id="idm46177458314360"/> any other query. Specifically, it tells you how MySQL is going to do the job in terms of the indexes, keys, and steps it’ll take if you ask it to resolve a query. <code>EXPLAIN</code> does not actually execute a query (unless you ask it to) and in general doesn’t take a lot of time to run.</p>

<p>Let’s try a simple example that illustrates the idea:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">actor</code><code class="err">\</code><code class="n">G</code></strong></pre>

<pre data-type="programlisting">*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: actor
   partitions: NULL
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 200
     filtered: 100.00
        Extra: NULL
1 row in set, 1 warning (0.00 sec)</pre>

<p>The statement gives you lots of information. It tells you that:</p>

<ul>
<li>
<p>The <code>id</code> is 1, meaning this row in the output refers to the first (and only!) <code>SELECT</code> statement in this query. If we utilize a subquery, each <code>SELECT</code> statement will have a different <code>id</code> in the <code>EXPLAIN</code> output (although some subqueries will not result in multiple <code>id</code>s being reported, as MySQL might rewrite the query). We’ll show an example with a subquery and different <code>id</code> values later.</p>
</li>
<li>
<p>The <code>select_type</code> is <code>SIMPLE</code>, meaning it doesn’t use a <code>UNION</code> or subqueries.</p>
</li>
<li>
<p>The <code>table</code> that this row is referring to is <code>actor</code>.</p>
</li>
<li>
<p>The <code>partitions</code> column is empty, because no tables are partitioned.</p>
</li>
<li>
<p>The <code>type</code> of join is <code>ALL</code>, meaning all rows in the table are processed by this <code>SELECT</code> statement. This is often bad, but not in this case; we’ll explain why later.</p>
</li>
<li>
<p>The <code>possible_keys</code> that could be used are listed. In this case, no index will help find all rows in a table, so <code>NULL</code> is reported.</p>
</li>
<li>
<p>The <code>key</code> that is actually used is listed, taken from the list of <code>possible_keys</code>. In this case, since no key is available, none is used.</p>
</li>
<li>
<p>The <code>key_len</code> (key length) of the key MySQL plans to use is listed. Again, no key means a <code>NULL</code> <code>key_len</code> is reported.</p>
</li>
<li>
<p>The <code>ref</code> (reference) columns or constants that are used with the key are listed. Again, there are none in this example.</p>
</li>
<li>
<p>The <code>rows</code> that MySQL thinks it needs to process to get an answer are listed.</p>
</li>
<li>
<p>The <code>filtered</code> column tells us the percentage of rows from the table that this stage will return: 100 means all rows will be returned. This is expected as we’re asking for all rows.</p>
</li>
<li>
<p>Any <code>Extra</code> information about the query resolution is listed. Here, there’s none.</p>
</li>
</ul>

<p>In summary, the output of <code>EXPLAIN SELECT * FROM actor</code> tells you that all rows from the <code>actor</code> table will be processed (there are 200 of them), and no indexes will be used to resolve the query. This makes sense and is probably exactly what you expected would happen.</p>

<p>Note that every <code>EXPLAIN</code> statement reports a warning. <a data-type="indexterm" data-primary="EXPLAIN" data-secondary="warnings" id="idm46177458256824"/>Each query we send to MySQL gets rewritten before execution, and the warning message will contain the rewritten query. For example, <code>*</code> may be expanded to an explicit list of columns, or a subquery may be optimized implicitly into a <code>JOIN</code>. Here’s an example:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">actor</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">actor_id</code><code> </code><code class="k">IN</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="k">SELECT</code><code> </code><code class="n">actor_id</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film_actor</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">film_id</code><code> </code><code class="o">=</code><code> </code><code class="mi">11</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+----+-------------+------------+------------+--------+...
| id | select_type | table      | partitions | type   |...
+----+-------------+------------+------------+--------+...
|  1 | SIMPLE      | film_actor | NULL       | ref    |...
|  1 | SIMPLE      | actor      | NULL       | eq_ref |...
+----+-------------+------------+------------+--------+...
...+------------------------+----------------+---------+...
...| possible_keys          | key            | key_len |...
...+------------------------+----------------+---------+...
...| PRIMARY,idx_fk_film_id | idx_fk_film_id | 2       |...
...| PRIMARY                | PRIMARY        | 2       |...
...+------------------------+----------------+---------+...</pre>

<pre data-type="programlisting" class="less_space pagebreak-before">...+----------------------------+------+----------+-------------+
...| ref                        | rows | filtered | Extra       |
...+----------------------------+------+----------+-------------+
...| const                      |    4 |   100.00 | Using index |
...| sakila.film_actor.actor_id |    1 |   100.00 | NULL        |
...+----------------------------+------+----------+-------------+
2 rows in set, 1 warning (0.00 sec)</pre>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SHOW</code><code> </code><code class="n">WARNINGS</code><code class="err">\</code><code class="n">G</code></strong></pre>

<pre data-type="programlisting">*************************** 1. row ***************************

  Level: Note
   Code: 1003
Message: /* select#1 */ select
`sakila`.`actor`.`actor_id` AS `actor_id`,
`sakila`.`actor`.`first_name` AS `first_name`,
`sakila`.`actor`.`last_name` AS `last_name`,
`sakila`.`actor`.`last_update` AS `last_update`
from `sakila`.`film_actor` join `sakila`.`actor` where
((`sakila`.`actor`.`actor_id` = `sakila`.`film_actor`.`actor_id`)
and (`sakila`.`film_actor`.`film_id` = 11))
1 row in set (0.00 sec)</pre>

<p>We mentioned that we would show an example with different <code>id</code> values and a subquery. Here’s the query:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">actor</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">actor_id</code><code> </code><code class="k">IN</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="k">SELECT</code><code> </code><code class="n">actor_id</code><code> </code><code class="k">FROM</code><code> </code><code class="n">film_actor</code><code> </code><code class="k">JOIN</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">film</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">title</code><code> </code><code class="o">=</code><code> </code><code class="s1">'ZHIVAGO CORE'</code><code class="p">)</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+----+--------------+-------------+------------+------+...
| id | select_type  | table       | partitions | type |...
+----+--------------+-------------+------------+------+...
|  1 | SIMPLE       | &lt;subquery2&gt; | NULL       | ALL  |...
|  1 | SIMPLE       | actor       | NULL       | ALL  |...
|  2 | MATERIALIZED | film        | NULL       | ref  |...
|  2 | MATERIALIZED | film_actor  | NULL       | ref  |...
+----+--------------+-------------+------------+------+...
...+------------------------+----------------+---------+---------------------+...
...| possible_keys          | key            | key_len | ref                 |...
...+------------------------+----------------+---------+---------------------+...
...| NULL                   | NULL           | NULL    | NULL                |...
...| PRIMARY                | NULL           | NULL    | NULL                |...
...| PRIMARY,idx_title      | idx_title      | 514     | const               |...
...| PRIMARY,idx_fk_film_id | idx_fk_film_id | 2       | sakila.film.film_id |...
...+------------------------+----------------+---------+---------------------+...</pre>

<pre data-type="programlisting" class="less_space pagebreak-before">...+------+----------+--------------------------------------------+
...| rows | filtered | Extra                                      |
...+------+----------+--------------------------------------------+
...| NULL |   100.00 | NULL                                       |
...|  200 |     0.50 | Using where; Using join buffer (hash join) |
...|    1 |   100.00 | Using index                                |
...|    5 |   100.00 | Using index                                |
...+------+----------+--------------------------------------------+
4 rows in set, 1 warning (0.01 sec)</pre>

<p>In this example, you can see that <code>id</code> 1 is used for the <code>actor</code> and <code>&lt;subquery2&gt;</code> tables, and <code>id</code> 2 is used for <code>film</code> and <code>film_actor</code>. But what is <code>&lt;subquery2&gt;</code>? That’s a virtual table name used here because the optimizer materialized the results of the subquery, or in other words stored them in a temporary table in memory. You can see that the query with an <code>id</code> of 2 has a <code>select_type</code> of <code>MATERIALIZED</code>. The outside query (<code>id</code> 1) will look up the results of the inner query (<code>id</code> 2) from this temporary table. This is just one of many optimizations that MySQL can perform while executing complex queries.</p>

<p>Next, we’ll give the <code>EXPLAIN</code> statement some real work to do.<a data-type="indexterm" data-primary="INNER JOIN" data-secondary="EXPLAIN SELECT" id="idm46177458090744"/><a data-type="indexterm" data-primary="EXPLAIN" data-secondary="EXPLAIN SELECT" data-tertiary="INNER JOIN" id="idm46177458089896"/> Let’s ask it to explain an <code>INNER JOIN</code> between <code>actor</code>, <code>film_actor</code>, <code>film</code>, <code>film_category</code>, and <code>category</code>:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code><code> </code><code class="k">FROM</code><code> </code><code class="n">actor</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">film_actor</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">actor_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">film</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">film_category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">category</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">category_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">category</code><code class="p">.</code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Horror'</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+----+-------------+---------------+------------+--------+...
| id | select_type | table         | partitions | type   |...
+----+-------------+---------------+------------+--------+...
|  1 | SIMPLE      | category      | NULL       | ALL    |...
|  1 | SIMPLE      | film_category | NULL       | ref    |...
|  1 | SIMPLE      | film          | NULL       | eq_ref |...
|  1 | SIMPLE      | film_actor    | NULL       | ref    |...
|  1 | SIMPLE      | actor         | NULL       | eq_ref |...
+----+-------------+---------------+------------+--------+...
...+-----------------------------------+---------------------------+---------+...
...| possible_keys                     | key                       | key_len |...
...+-----------------------------------+---------------------------+---------+...
...| PRIMARY                           | NULL                      | NULL    |...
...| PRIMARY,fk_film_category_category | fk_film_category_category | 1       |...
...| PRIMARY                           | PRIMARY                   | 2       |...
...| PRIMARY,idx_fk_film_id            | idx_fk_film_id            | 2       |...
...| PRIMARY                           | PRIMARY                   | 2       |...
...+-----------------------------------+---------------------------+---------+...</pre>

<pre data-type="programlisting" class="less_space pagebreak-before">...+------------------------------+------+----------+-------------+
...| ref                          | rows | filtered | Extra       |
...+------------------------------+------+----------+-------------+
...| NULL                         |   16 |    10.00 | Using where |
...| sakila.category.category_id  |   62 |   100.00 | Using index |
...| sakila.film_category.film_id |    1 |   100.00 | Using index |
...| sakila.film_category.film_id |    5 |   100.00 | Using index |
...| sakila.film_actor.actor_id   |    1 |   100.00 | NULL        |
...+------------------------------+------+----------+-------------+
5 rows in set, 1 warning (0.00 sec)</pre>

<p>Before we discuss the output, think about how the query could be evaluated. MySQL could go through each row in the <code>actor</code> table, then match that with <code>film_actor</code>, then with <code>film</code>, <code>film_category</code>, and finally <code>category</code>. We have a filter on the <code>category</code> table, so in this imaginary case MySQL would only be able to match fewer rows once it gets to that table. That is a poor execution strategy. Can you think of a better one?</p>

<p>Let’s now look at what MySQL actually decided to do. This time, there are five rows because there are five tables in the join. Let’s run through this, focusing on those things that are different from the previous examples:</p>

<ul>
<li>
<p>The first row is similar to what we saw before. MySQL will read all 16 rows from the <code>category</code> table. This time, the value in the <code>Extra</code> column is <code>Using where</code>. That means a filter based on a <code>WHERE</code> clause is going to be applied. In this example, the <code>filtered</code> column shows 10, meaning that roughly 10% of the table rows will be produced by this stage for further operations. The MySQL optimizer expects 16 rows in the table and expects that one to two rows will be returned here.</p>
</li>
<li>
<p>Now let’s look at row 2. The join <code>type</code> for the <code>film_category</code> table is <code>ref</code>, meaning that all rows in the <code>film_category</code> table that match rows in the <code>category</code> table will be read. In practice, this means one or more rows from the <code>film_category</code> table will be read for each <code>category_id</code> from the <code>category</code> table. The <code>possible_keys</code> column shows both <code>PRIMARY</code> and <code>fk_film_category_category</code>, and the latter is chosen as the index. The primary key of the <code>film_category</code> table has two columns, and the first one of them is <code>film_id</code>, making that index less optimal for filtering on <code>category_id</code>. The key used to search <code>film_category</code> has a <code>key_len</code> of 1 and is searched using the <code>sakila.category.category_id</code> value from the <code>category</code> table.</p>
</li>
<li>
<p>Moving to the next row, we can see that the join <code>type</code> for the <code>film</code> table is <code>eq_ref</code>. This means that for each row we got from the previous stage (scanning <code>film_category</code>), we’ll read exactly one row in this stage. MySQL can guarantee that because the index used to access the <code>film</code> table is <code>PRIMARY</code>. In general, if a <code>UNIQUE NOT NULL</code> index is used, <code>eq_ref</code> is possible. This is one of the best join strategies.</p>
</li>
</ul>

<p>The two nested rows in the output do not show us anything new. In the end, we see that MySQL selected an optimal execution plan. Usually, the fewer rows that are read during the first step of the execution, the faster the query will be.</p>

<p>MySQL 8.0 introduced a new format of <code>EXPLAIN PLAN</code> output, <a data-type="indexterm" data-primary="EXPLAIN" data-secondary="EXPLAIN ANALYZE SELECT" id="idm46177457971736"/>which is available through the <code>EXPLAIN ANALYZE</code> statement. While it may be somewhat easier to read, the caveat here is that the statement actually has to be executed, unlike with the regular <code>EXPLAIN</code>. We won’t go into the details of this new format, but we’ll show an example here:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">ANALYZE</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">first_name</code><code class="p">,</code><code> </code><code class="n">last_name</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">FROM</code><code> </code><code class="n">actor</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">film_actor</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">actor_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">film</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">film_id</code><code class="p">)</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">title</code><code> </code><code class="o">=</code><code> </code><code class="s1">'ZHIVAGO CORE'</code><code class="err">\</code><code class="n">G</code></strong></pre>

<pre data-type="programlisting">*************************** 1. row ***************************
EXPLAIN:
-&gt; Nested loop inner join
   (cost=3.07 rows=5)
   (actual time=0.036..0.055 rows=6 loops=1)
  -&gt; Nested loop inner join
     (cost=1.15 rows=5)
     (actual time=0.028..0.034 rows=6 loops=1)
    -&gt; Index lookup on film
       using idx_title (title='ZHIVAGO CORE')
       (cost=0.35 rows=1)
       (actual time=0.017..0.018 rows=1 loops=1)
    -&gt; Index lookup on film_actor
       using idx_fk_film_id (film_id=film.film_id)
       (cost=0.80 rows=5)
       (actual time=0.010..0.015 rows=6 loops=1)
  -&gt; Single-row index lookup on actor
     using PRIMARY (actor_id=film_actor.actor_id)
     (cost=0.27 rows=1)
     (actual time=0.003..0.003 rows=1 loops=6)

1 row in set (0.00 sec)</pre>

<p>This output is even more advanced than the regular <code>EXPLAIN</code> output, as it gives more data. We’ll leave analyzing it as an exercise for the reader. You should be able to figure it out based on our explanation for the regular <code>EXPLAIN</code> output.<a data-type="indexterm" data-startref="ch07-exp" id="idm46177457929432"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Alternative Storage Engines"><div class="sect1" id="ADV2-SEC-STORAGEENGINES">
<h1>Alternative Storage Engines</h1>

<p>One of the features of MySQL that distinguishes it from many<a data-type="indexterm" data-primary="storage engines" data-secondary="about" id="ch07-sea"/> other RDBMSs is its support for different storage engines. The mechanism of MySQL’s support of multiple engines is complicated, and to explain it properly we’d need to go into more depth on its architecture and implementation than we have space for here. We can, however, try to give you a bird’s-eye overview of what engines are available, why you might want to use a nondefault engine, and why having this choice is important.</p>

<p>Instead of saying <em>storage engine</em>, which sounds<a data-type="indexterm" data-primary="table types" data-see="storage engines" id="idm46177457924920"/><a data-type="indexterm" data-primary="tables" data-secondary="table types" data-see="storage engines" id="idm46177457923944"/> complicated, we could say <em>table type</em>. In very simplified terms, MySQL allows you to create tables of different types, with each type giving those tables distinct properties. There’s no universally good table type, as each storage engine has pros and cons.</p>

<p>In the book so far, we’ve used only the default InnoDB table<a data-type="indexterm" data-primary="defaults" data-secondary="InnoDB as storage engine" id="idm46177457890808"/><a data-type="indexterm" data-primary="InnoDB" data-secondary="default storage engine" id="idm46177457889960"/><a data-type="indexterm" data-primary="storage engines" data-secondary="InnoDB" id="idm46177457889112"/> type. The reason is simple: almost everything you’re likely to want from a modern database can be achieved using InnoDB. It’s generally fast, reliable, and a proven and well-supported engine, and is widely considered (including by us) to provide the best balance of pros and cons. We’ve seen this engine used successfully by applications requiring very high throughput of short queries, and also by data warehouse applications that run few but “large” queries.</p>

<p>At the time of writing, the official MySQL documentation documents 8 additional storage engines, and 18 additional engines are documented for MariaDB. In reality, there are even more storage engines available, but not all of them make it into a major MySQL flavor’s documentation. Here we’ll only describe those engines we find useful and that are at least somewhat commonly used. It may well be that the storage engine that best fits your use case is not one we describe. Take no offense; there are just too many of them to cover them all fairly.</p>

<p>Before we dive into our overview of different engines, let’s briefly look at why this matters. The pluggable nature of storage engines in MySQL and the ability to create tables with different types is important because it allows you to unify your database access layer. Instead of using multiple database products, each with its own driver, query language, configuration, management, backups, and so on, you can just use MySQL and achieve different behaviors by changing table types. Your apps may not even need to know what types tables have. That said, it’s not all that simple and rosy. You may not be able to use all of the backup solutions we’ll explain in <a data-type="xref" href="ch10.xhtml#CH10_BACKUP">Chapter 10</a>. You will also need to understand the trade-offs each engine provides. However, we still think that it’s better to have this ability to change table types than not.</p>

<p>We’ll start our review by defining broad categories based on important properties of the different storage engines. One of the most important divisions is the ability of the engine to support transactions (you can read more about transactions, locking, and why all of this is important in <a data-type="xref" href="ch06.xhtml#CH6_TRANSACTION_LOCKING">Chapter 6</a>).</p>

<p>Currently available transactional engines include the default<a data-type="indexterm" data-primary="storage engines" data-secondary="transaction support" id="idm46177457882920"/><a data-type="indexterm" data-primary="transactions" data-secondary="storage engines that support" id="idm46177457882072"/><a data-type="indexterm" data-primary="InnoDB" data-secondary="transactions" data-tertiary="support for" id="idm46177457881224"/><a data-type="indexterm" data-primary="MyRocks" data-secondary="transaction support" id="idm46177457880136"/><a data-type="indexterm" data-primary="TokuDB" data-secondary="transaction support" id="idm46177457879288"/> InnoDB, the actively developed MyRocks, and the deprecated TokuDB. All of the different engines available across major MySQL flavors; only these three support transactions. Every other engine is nontransactional.</p>

<p>The next broad division we can perform is based on crash<a data-type="indexterm" data-primary="ACID transactions" data-secondary="storage engines" id="idm46177457877704"/><a data-type="indexterm" data-primary="storage engines" data-secondary="crash-safe" id="idm46177457876856"/><a data-type="indexterm" data-primary="crash-safe storage engines" id="idm46177457876008"/><a data-type="indexterm" data-primary="InnoDB" data-secondary="crash-safe" id="idm46177457875400"/><a data-type="indexterm" data-primary="MyRocks" data-secondary="crash-safe" id="idm46177457874552"/><a data-type="indexterm" data-primary="TokuDB" data-secondary="crash-safe" id="idm46177457873704"/> safety, or the ability of the engine to guarantee the durability property of the ACID set of properties. If a table uses a crash-safe engine, then we can expect every bit of data a committed transaction has written to be available after an unclean instance restart. Crash-safe engines include the already mentioned InnoDB, MyRocks, and TokuDB, as well as the Aria engine. None of the other available engines guarantees crash safety.</p>

<p>We could come up with more examples of how to group the table types, but let’s get to actually describing some of the engines and their properties. <a data-type="indexterm" data-primary="storage engines" data-secondary="SHOW ENGINES output" id="idm46177457871736"/><a data-type="indexterm" data-primary="SHOW" data-secondary="ENGINES" id="idm46177457870888"/>First things first, let’s see how to actually view the list of engines available. To achieve that, we use the special <code>SHOW ENGINES</code> command. Here’s its output on a default MySQL 8.0.23 Linux installation:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SHOW</code><code> </code><code class="n">ENGINES</code><code class="p">;</code></strong></pre>

<pre data-type="programlisting">+--------------------+---------+...
| Engine             | Support |...
+--------------------+---------+...
| ARCHIVE            | YES     |...
| BLACKHOLE          | YES     |...
| MRG_MYISAM         | YES     |...
| FEDERATED          | NO      |...
| MyISAM             | YES     |...
| PERFORMANCE_SCHEMA | YES     |...
| InnoDB             | DEFAULT |...
| MEMORY             | YES     |...
| CSV                | YES     |...
+--------------------+---------+...
...+----------------------------------------------------------------+...
...| Comment                                                        |...
...+----------------------------------------------------------------+...
...| Archive storage engine                                         |...
...| /dev/null storage engine (anything you write to it disappears) |...
...| Collection of identical MyISAM tables                          |...
...| Federated MySQL storage engine                                 |...
...| MyISAM storage engine                                          |...
...| Performance Schema                                             |...
...| Supports transactions, row-level locking, and foreign keys     |...
...| Hash based, stored in memory, useful for temporary tables      |...
...| CSV storage engine                                             |...
...+----------------------------------------------------------------+...
...+--------------+------+------------+
...| Transactions | XA   | Savepoints |
...+--------------+------+------------+
...| NO           | NO   | NO         |
...| NO           | NO   | NO         |
...| NO           | NO   | NO         |
...| NULL         | NULL | NULL       |
...| NO           | NO   | NO         |
...| NO           | NO   | NO         |
...| YES          | YES  | YES        |
...| NO           | NO   | NO         |
...| NO           | NO   | NO         |
...+--------------+------+------------+
9 rows in set (0.00 sec)</pre>

<p>You can see that MySQL conveniently tells us whether an engine supports transactions. The <code>XA</code> column is for distributed transactions—we won’t be covering these in this book. Savepoints are basically the ability to create mini-transactions within transactions, another advanced topic. As an exercise, consider executing <code>SHOW ENGINES;</code> in MariaDB and Percona Server installations.<a data-type="indexterm" data-startref="ch07-sea" id="idm46177457860072"/></p>








<section data-type="sect2" data-pdf-bookmark="InnoDB"><div class="sect2" id="ADV1-SEC-INNODB">
<h2>InnoDB</h2>

<p>Before we move on to “alternative” storage engines, let’s discuss<a data-type="indexterm" data-primary="InnoDB" data-secondary="about" id="idm46177457857432"/><a data-type="indexterm" data-primary="storage engines" data-secondary="InnoDB" data-seealso="InnoDB" id="idm46177457856456"/> the default one: InnoDB. InnoDB is reliable, performant, and full-featured. Pretty much everything you’d expect from a modern RDBMS is achievable in some way with InnoDB. In this book, we never change the engine of a table, so every example uses InnoDB. While you are learning MySQL, we recommend that you stick with this engine. It’s important to understand its downsides, but unless they become problematic for you, there’s almost no reason not to use it all the time.</p>

<p>The InnoDB table type includes the following features:</p>
<dl>
<dt>Support for transactions</dt>
<dd>
<p>This is discussed in detail in<a data-type="indexterm" data-primary="InnoDB" data-secondary="transactions" data-tertiary="support for" id="idm46177457833288"/> <a data-type="xref" href="ch06.xhtml#CH6_TRANSACTION_LOCKING">Chapter 6</a>.</p>
</dd>
<dt>Advanced crash recovery features</dt>
<dd>
<p>The InnoDB table type uses logs, which are files that contain<a data-type="indexterm" data-primary="InnoDB" data-secondary="crash-safe" id="idm46177457830184"/> a record of the actions that MySQL has taken to change the database. Logs enable MySQL to recover effectively from power losses, crashes, and other basic database failures. Of course, nothing can help you recover from the loss of a machine, failure of a disk drive, or other catastrophic failures. For these, you need offsite backups and new hardware. Every backup tool we explore in <a data-type="xref" href="ch10.xhtml#CH10_BACKUP">Chapter 10</a> works with InnoDB.</p>
</dd>
<dt>Row-level locking</dt>
<dd>
<p>Unlike the previous default engine, MyISAM (which we’ll explore in the following section), InnoDB<a data-type="indexterm" data-primary="row locks" data-secondary="InnoDB support for" id="idm46177457826808"/> provides fine-grained locking infrastructure. The lowest level of locking is row-level, meaning that an individual row can be locked by a running query or transaction. This is important for most write-heavy online transaction processing (OLTP) applications; if you’re locking at a higher level, like the table level, you can end up with too many concurrency issues.</p>
</dd>
<dt>Foreign key support</dt>
<dd>
<p>InnoDB is currently the only MySQL table type that supports<a data-type="indexterm" data-primary="foreign key constraints" data-secondary="InnoDB support for foreign keys" id="idm46177457824296"/> foreign keys. If you are building a system that requires a high level of data safety enforced by referential constraints, InnoDB is your only choice.</p>
</dd>
<dt>Encryption support</dt>
<dd>
<p>InnoDB tables can be encrypted transparently by MySQL.<a data-type="indexterm" data-primary="encryption" data-secondary="InnoDB support for" id="idm46177457822008"/></p>
</dd>
<dt>Partitioning support</dt>
<dd>
<p>InnoDB supports <em>partitioning</em>; that is, spreading of data<a data-type="indexterm" data-primary="partitioning support from InnoDB" id="idm46177457819624"/> physically between multiple data files based on some rules. This allows InnoDB to work with tables of tremendous size efficiently.</p>
</dd>
</dl>

<p>That’s a lot of pros, but there are also a few cons:</p>
<dl>
<dt>Complexity</dt>
<dd>
<p>InnoDB is relatively complex. This means that there’s a lot to configure and understand. Out of almost a thousand server options in MySQL, more than two hundred are specific to InnoDB. This downside is, however, far outweighed by the benefits this engine provides.</p>
</dd>
<dt>Data footprint</dt>
<dd>
<p>InnoDB is a relatively disk-hungry storage engine, making it less appealing for storing extremely large datasets.<a data-type="indexterm" data-primary="performance" data-secondary="InnoDB disk-hungry" id="idm46177457815288"/><a data-type="indexterm" data-primary="InnoDB" data-secondary="disk-hungry" id="idm46177457814440"/></p>
</dd>
<dt>Scaling with database size</dt>
<dd>
<p>InnoDB shines when the so-called “hot” dataset, or frequently accessed data, is present in its buffer pool. This limits its scalability.<a data-type="indexterm" data-primary="scalability" data-secondary="InnoDB limitation" id="idm46177457812280"/></p>
</dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="MyISAM and Aria"><div class="sect2" id="ADV1-SEC-MYISAM">
<h2>MyISAM and Aria</h2>

<p>MyISAM was the default storage engine in MySQL for a long<a data-type="indexterm" data-primary="MyISAM" id="idm46177457809400"/><a data-type="indexterm" data-primary="Aria" id="idm46177457808792"/><a data-type="indexterm" data-primary="storage engines" data-secondary="MyISAM" id="idm46177457808184"/><a data-type="indexterm" data-primary="storage engines" data-secondary="Aria" id="idm46177457807336"/> time, and a staple of this database. It is simple in use and design, is quite performant, and has low overhead. So why did it stop being the default? There are actually several good reasons for this, as you’ll see when we discuss its limitations.</p>

<p>Nowadays, we do not recommend using MyISAM unless it’s required for legacy reasons. You may read on the internet that its performance is better than InnoDB’s. Unfortunately, most of that information is very old and hasn’t aged well—today, that’s simply not the case in the vast majority of cases. One reason for this is the changes to the Linux kernel necessitated by the Spectre and Meltdown security vulnerabilities in January 2018, which <a data-type="indexterm" data-primary="performance" data-secondary="MyISAM" id="idm46177457805240"/>resulted in a performance decrease of up to 90% for MyISAM.</p>

<p>Until MySQL 8.0, MyISAM was used in MySQL for all data dictionary objects. Starting with that version, the data dictionary is now fully InnoDB, to support advanced features like atomic DDL.</p>

<p>Aria is a reworked MyISAM provided in MariaDB. Apart from<a data-type="indexterm" data-primary="MariaDB" data-secondary="Aria" id="idm46177457803288"/> promising better performance and being improved and worked on continuously, the most important feature of Aria is its crash safety. MyISAM, unlike InnoDB, does not guarantee data safety when your write succeeds, which is a major drawback of this storage engine. Aria, on the other hand, allows the creation of durable tables, supported by a global transaction log. In the future Aria may also support full-fledged transactions, but this is not the case at the time of writing.</p>

<p>The MyISAM table type includes the following features:</p>
<dl>
<dt>Table-level locking</dt>
<dd>
<p>Unlike InnoDB, MyISAM only supports locks at the high level of whole tables. This is much simpler and less nuanced than row-level locking and has lower overhead and memory requirements. However, a major drawback becomes apparent with highly concurrent, write-heavy workloads: even if each session would update or insert a separate row, they will each execute in turn. Reads in MyISAM can coexist simultaneously, but they will block concurrent writes. Writes also block reads.</p>
</dd>
<dt>Partitioning support</dt>
<dd>
<p>Until MySQL 8.0, MyISAM supported partitioning. In MySQL 8.0 this is no longer the case, and to achieve this one must resort to using different storage engines (Merge or MRG_MyISAM).</p>
</dd>
<dt>Compression</dt>
<dd>
<p>It’s possible to create read-only compressed tables with the <code>myisampack</code> utility, which are quite a bit smaller than the equivalent InnoDB tables without compression. Since InnoDB supports compression, however, we recommend you first check whether this option will give you better results.</p>
</dd>
</dl>

<p>The MyISAM type has the following limitations:</p>
<dl>
<dt>Crash safety and recovery</dt>
<dd>
<p>MyISAM tables are not crash-safe. MySQL does not guarantee that when a write succeeds, the data actually reaches files on the disk. If MySQL doesn’t exit cleanly, MyISAM tables may get corrupted, require repairs, and lose data.</p>
</dd>
<dt>Transactions</dt>
<dd>
<p>MyISAM does not support transactions. Thus, MyISAM only provides atomicity for each individual statement, which may not be enough in your case.</p>
</dd>
<dt>Encryption</dt>
<dd>
<p>MyISAM tables do not support encryption.</p>
</dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="MyRocks and TokuDB"><div class="sect2" id="ADV1-SEC-MYROCKS">
<h2>MyRocks and TokuDB</h2>

<p>One of the most significant problems with InnoDB is its relative<a data-type="indexterm" data-primary="MyRocks" id="idm46177457789848"/><a data-type="indexterm" data-primary="TokuDB" id="idm46177457789240"/><a data-type="indexterm" data-primary="performance" data-secondary="InnoDB disk-hungry" id="idm46177457788632"/><a data-type="indexterm" data-primary="InnoDB" data-secondary="disk-hungry" id="idm46177457787784"/><a data-type="indexterm" data-primary="storage engines" data-secondary="MyRocks" id="idm46177457786936"/><a data-type="indexterm" data-primary="storage engines" data-secondary="TokuDB" id="idm46177457786088"/> difficulty in dealing with large datasets. We’ve mentioned that it is desirable to have your frequently accessed data in memory, but that is not always possible to achieve. Moreover, when data sizes go into multiterabyte territory, InnoDB’s on-disk performance suffers, too. The objects in InnoDB also have quite a large overhead in terms of size. In recent years, a few different projects have appeared that attempt to fix issues inherent to InnoDB’s basic data structure the B-tree by basing the storage engine on a different data structure. These include MyRocks, based on the LSM-tree, and TokuDB, based on a proprietary fractal tree data structure.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>We wanted to mention TokuDB in this section for completeness, but its developer, <a data-type="indexterm" data-primary="TokuDB" data-secondary="deprecated" id="idm46177457783560"/>Percona, has deprecated this storage engine, and its future is unclear. TokuDB has similar properties to MyRocks, and in fact MyRocks is the preferable migration path off of TokuDB.</p>
</div>

<p>How data structures affect the properties of storage engines is a complex topic, arguably falling outside the scope of database administration and operation. We try to keep things reasonably simple in this book, so we won’t go into that particular topic. You should also remember what we wrote earlier about InnoDB: that default is not unreasonable, and more often than not, just using InnoDB is going to give you the best set of trade-offs. It continues to be our recommendation that you use InnoDB while learning MySQL, and beyond that, but we also feel that we should cover the alternatives.</p>

<p>The MyRocks table type includes the following features:</p>
<dl>
<dt>Support for transactions</dt>
<dd>
<p>MyRocks is a transactional storage engine, supporting regular transactions and distributed transactions. Savepoints are not fully supported.</p>
</dd>
<dt>Advanced crash recovery features</dt>
<dd>
<p>MyRocks relies on internal log files called WAL files (for “write-ahead log”) to provide crash recovery guarantees. You can expect everything that was committed to be present once the database is restarted after a crash.</p>
</dd>
<dt>Encryption support</dt>
<dd>
<p>MyRocks tables can be encrypted.</p>
</dd>
<dt>Partitioning support</dt>
<dd>
<p>MyRocks tables can be partitioned.</p>
</dd>
<dt>Data compression and compactness</dt>
<dd>
<p>The storage footprint of MyRocks tables is usually lower than that of InnoDB tables. There are two properties leading to that: it uses a more compact storage structure and data within that storage structure can be compressed. While compression is not unique to MyRocks, and InnoDB in fact provides compression options, MyRocks consistently shows better results.</p>
</dd>
<dt>Consistent write performance at scale</dt>
<dd>
<p>This one is difficult to properly explain without going deep into the weeds. However, the minimal version is that the write performance of MyRocks is almost unaffected by the volume of the data. In the real world, this means that MyRocks tables show worse performance than InnoDB tables until the size of the data becomes much larger than memory. What happens then is that InnoDB’s performance decreases faster than MyRocks’, eventually falling behind.</p>
</dd>
</dl>

<p>The MyRocks table type has the following limitations:</p>
<dl>
<dt>Transactions and locking</dt>
<dd>
<p>MyRocks doesn’t support the <code>SERIALIZABLE</code> isolation level or gap locking, described in <a data-type="xref" href="ch06.xhtml#CH6_TRANSACTION_LOCKING">Chapter 6</a>.</p>
</dd>
<dt>Foreign keys</dt>
<dd>
<p>Only InnoDB supports foreign key constraints.</p>
</dd>
<dt>Performance tradeoffs</dt>
<dd>
<p>MyRocks does not cope well with read-heavy and analytical workloads. InnoDB provides better generalized performance.</p>
</dd>
<dt>Complexity</dt>
<dd>
<p>We mentioned that InnoDB is more complex than MyISAM. However, in some respects MyRocks is more complex than InnoDB. It is not well documented, is being actively developed (so is less stable), and can be difficult to operate.</p>
</dd>
<dt>General availability</dt>
<dd>
<p>MyRocks is not available in Community or Enterprise MySQL; to use it, you need to use another version of MySQL, like MariaDB or Percona Server. That may result in operational difficulties. Packaged versions lag behind development, and to use all of the current features, a dedicated MySQL server has to be built with MyRocks sources.</p>
</dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Other Table Types"><div class="sect2" id="ADV1-SEC-OTHERENG">
<h2>Other Table Types</h2>

<p>We’ve covered all the major table types, but there are a few more that we will summarize briefly. Some of these storage engines are rarely used, and they may have documentation issues and bugs.<a data-type="indexterm" data-primary="storage engines" data-secondary="about other types" id="idm46177457761752"/></p>
<dl>
<dt>Memory</dt>
<dd>
<p>Tables of this type are stored entirely in memory and are<a data-type="indexterm" data-primary="memory storage engines" id="idm46177457759208"/> never persisted on disk. The obvious advantage is performance: memory is many times faster than disk and will probably always be. The disadvantage is that the data is lost as soon as MySQL is restarted or crashes. Memory tables are usually used as temporary tables. Apart from that, memory tables can be used to hold small-sized, frequently accessed hot data, such as a dictionary of sorts.</p>
</dd>
<dt>Archive</dt>
<dd>
<p>This type provides a way to store data in a highly compressed<a data-type="indexterm" data-primary="archive storage engines" id="idm46177457756920"/> and append-only manner. You cannot modify or delete data in tables using the Archive storage engine. As its name suggests, it’s mostly useful for long-term storage of data. In reality, it’s rarely used, and it has a few issues with primary key and auto-increment handling. InnoDB with compressed tables and MyRocks may provide better alternatives.</p>
</dd>
<dt>CSV</dt>
<dd>
<p>This storage engine stores tables on disk in CSV format.<a data-type="indexterm" data-primary="comma-separated values (CSVs)" data-secondary="storage engine types" id="idm46177457754664"/> That allows you to view and manipulate such tables with spreadsheet applications or just text editors. It’s not often used, but can be an alternative approach to what we explained in <a data-type="xref" href="#LOADCSV">“Loading Data from Comma-Delimited Files”</a>, and also can be used for data export.</p>
</dd>
<dt>Federated</dt>
<dd>
<p>This type provides a way to query data in remote MySQL<a data-type="indexterm" data-primary="federated storage engines" id="idm46177457751592"/> systems. Federated tables do not contain any data, only some metadata related to connection details. This is an interesting way of getting or modifying remote data without setting up replication. Compared to just connecting to remote MySQL, it has the benefit of simultaneously providing access to local and remote tables.</p>
</dd>
<dt>Blackhole</dt>
<dd>
<p>This storage engine discards every bit of data that would be<a data-type="indexterm" data-primary="Blackhole storage engines" id="idm46177457749368"/> stored within its tables. In other words, whatever is written into a Blackhole table is immediately lost. That doesn’t sound terribly useful, but there are use cases for this engine. Usually it’s used to filter replication through an intermediate server, where unneeded tables are blackholed. Another potential use case is to get rid of a table in a closed-source application: you can’t just drop the table, as that’ll break the app, but by making it Blackhole you remove any processing and storage overhead.</p>
</dd>
</dl>

<p>These storage engines are pretty exotic and are rarely seen in the wild. However, you should know they exist, as you may never know when something might become 
<span class="keep-together">useful.</span></p>
</div></section>





</div></section>







</div></section></div></body></html>