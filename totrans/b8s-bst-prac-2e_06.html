<html><head></head><body><section data-pdf-bookmark="Chapter 6. Versioning, Releases, and Rollouts" data-type="chapter" epub:type="chapter"><div class="chapter" id="versioning_releases_and_rollouts">&#13;
<h1><span class="label">Chapter 6. </span>Versioning, Releases, and Rollouts</h1>&#13;
&#13;
&#13;
<p>One of the main complaints of traditional monolithic applications is that over time they begin to grow too large and unwieldy to properly upgrade, version, or modify at the speed the business requires. Many can argue that this is one of the critical factors that led to more Agile&#13;
development practices and the advent of microservice architectures.&#13;
Being able to quickly iterate on new code, solve new problems, or fix&#13;
hidden problems before they become major issues, as well as the promise of&#13;
zero-downtime upgrades, are all goals that development teams strive for.&#13;
Practically, these issues can be solved with proper processes and procedures in place,&#13;
no matter the type of system, but this usually comes at a much higher cost of both&#13;
technology and human capital to maintain.</p>&#13;
&#13;
<p>When designing systems, isolation and composability are important variables.&#13;
The adoption of containers as the runtime for application code allows for this&#13;
but still requires a high level of human automation or system management to&#13;
maintain at a dependable level for large systems.&#13;
Over time, the system grew, more brittleness was introduced, and systems engineers began to build&#13;
complex automation processes to deliver on complex release, upgrade, and&#13;
failure detection mechanisms. Service orchestrators such as Apache&#13;
Mesos, HashiCorp Nomad, and even specialized container-based&#13;
orchestrators such as Kubernetes and Docker Swarm have evolved these processes into more&#13;
primitive components directly into their runtimes. &#13;
<span class="keep-together">Now, systems</span> engineers can solve&#13;
more complex system problems as the table stakes have been elevated to&#13;
include the versioning, release, and deployment of applications into the&#13;
system.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Versioning" data-type="sect1"><div class="sect1" id="id46">&#13;
<h1>Versioning</h1>&#13;
&#13;
<p>This<a data-primary="versioning" data-secondary="semantic" data-type="indexterm" id="version-semantic"/><a data-primary="semantic versioning" data-type="indexterm" id="semantic-version"/> section is not meant to be a primer on software versioning and the&#13;
history behind it; there are countless articles and computer science course books&#13;
on the subject. The main thing is to pick a pattern and stick with it. The&#13;
majority of software companies and developers have agreed that some form&#13;
of <em>semantic versioning</em> is the most useful, especially in a microservice&#13;
architecture in which a team that writes a certain microservice will depend&#13;
on the API compatibility of other microservices that make up the system.</p>&#13;
&#13;
<p>For those new to semantic versioning, the basics are that it follows a three-part&#13;
version number in a pattern of <em>major version</em>, <em>minor version</em>, and <em>patch</em>,&#13;
usually expressed in a <em>dot notation</em> such as 1(major).2(minor).3(patch).&#13;
The patch signifies an incremental release that includes a bug fix or&#13;
very minor change that has no API changes. The minor version signifies&#13;
updates that might have new API changes but it is backward compatible with the&#13;
previous version. This is a key attribute for developers working with&#13;
other microservices they might not be involved in developing. Knowing that&#13;
I have my service written to communicate with version 1.4.7 of another&#13;
microservice that has been recently upgraded to 1.5.7 should signify&#13;
that I might not need to change my code unless I want to take advantage of&#13;
any new API features. The major version is a breaking change increment&#13;
to the code. In most cases, the API is no longer compatible between major&#13;
versions of the same code. There are many slight modifications to this&#13;
process, including a “4” version to indicate the stage of the software in&#13;
its development life cycle, such as 1.4.7.0 for alpha code and 1.4.7.3 for&#13;
release. The most important thing is that there is consistency across&#13;
the system.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Releases" data-type="sect1"><div class="sect1" id="id47">&#13;
<h1>Releases</h1>&#13;
&#13;
<p>In truth, <a data-primary="releases" data-type="indexterm" id="release"/>Kubernetes does not really have a release controller, so there&#13;
is no native concept of a release. This is usually added to a Deployment&#13;
<code>metadata.labels</code> specification and/or in the&#13;
<code>pod.spec.template.metadata.label</code> specification. When to include either&#13;
is very important, and based on how CD is used to update changes to&#13;
deployments, it can have varied effects. When Helm for Kubernetes was&#13;
introduced, one of its main concepts was the notion of a release to&#13;
differentiate the running instance of the same Helm chart in a cluster.&#13;
This concept is easily reproducible without Helm; however, Helm natively&#13;
keeps track of releases and their history, so many CD tools integrate&#13;
Helm into their pipelines to be the actual release service. Again, the key&#13;
here is consistency in how versioning is used and where it is surfaced&#13;
in the system state of the cluster.</p>&#13;
&#13;
<p>Release names can be quite useful if there is institutional agreement as to&#13;
the definition of certain names. Often, labels such as <code>stable</code> or&#13;
<code>canary</code> are used, which helps to give some operational&#13;
control when tools such as service meshes are added to make fine-grained&#13;
routing decisions. Large organizations that drive numerous changes for&#13;
different audiences will also adopt a ring architecture that can be&#13;
denoted as <code>ring-0</code>, <code>ring-1</code>, and so on.</p>&#13;
&#13;
<p>This topic requires a little side trip into the specifics of labels in&#13;
the Kubernetes declarative model. Labels<a data-primary="labels" data-type="indexterm" id="id654"/> themselves are very much&#13;
free form and can be any <span class="keep-together">key/value</span> pair that follows the syntactical&#13;
rules of the API. The key is not really the content but how each&#13;
controller handles labels, changes to labels, and selector matching of&#13;
labels. Jobs, Deployments, ReplicaSets, and DaemonSets support selector-based matching of pods via labels through direct mapping or set-based&#13;
expressions. It is important to understand that label selectors are&#13;
immutable after they are created, which means if you add a new selector&#13;
and the pod’s labels have a corresponding match, a new ReplicaSet is&#13;
made, not an upgrade to an existing ReplicaSet. This becomes very&#13;
important to understand when dealing with rollouts, discussed<a data-primary="releases" data-startref="release" data-type="indexterm" id="id655"/> next.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Rollouts" data-type="sect1"><div class="sect1" id="id353">&#13;
<h1>Rollouts</h1>&#13;
&#13;
<p>Prior to the Deployment controller being introduced in Kubernetes, the&#13;
only mechanism that existed to control how applications were rolled out&#13;
by the Kubernetes controller process was using the command-line interface (CLI) command&#13;
<code>kubectl rolling-update</code> on the specific <code>replicaController</code> that was to&#13;
be updated. This was very difficult for declarative CD models because this&#13;
was not part of the state of the original manifest. One had to carefully&#13;
ensure that manifests were updated correctly, versioned properly so as to&#13;
not accidentally roll the system back, and archived when no longer&#13;
needed. The Deployment controller added the ability to automate this&#13;
update process using a specific strategy and then allowing the system to&#13;
read the declarative new state based on changes to the&#13;
<code>spec.template</code> of the Deployment. This last fact is often misunderstood&#13;
by new users of Kubernetes and causes frustration when they change a&#13;
label in the Deployment metadata fields, reapply a manifest, and no&#13;
update has been triggered. The Deployment controller is able to&#13;
determine changes to the specification and will take action to update&#13;
the Deployment based on a strategy that is defined by the specification.&#13;
Kubernetes Deployments support two strategies, <code>rollingUpdate</code> and&#13;
<code>recreate</code>, the former being the default.</p>&#13;
&#13;
<p>If a rolling update is specified, the Deployment will create a new&#13;
ReplicaSet to scale to the number of required replicas, and the old&#13;
ReplicaSet will scale down to zero based on specific values for&#13;
<code>maxUnavailble</code> and <code>maxSurge</code>. In essence, those two values will prevent&#13;
Kubernetes from removing older pods until a sufficient number of newer&#13;
pods have come online, and Kubernetes will not create new pods until a certain&#13;
number of old pods have been removed. The nice thing is that the&#13;
Deployment controller will keep a history of the updates, and through the&#13;
CLI, you can roll back Deployments to previous versions.</p>&#13;
&#13;
<p>The <code>recreate</code> strategy is a valid strategy for certain workloads that&#13;
can handle a complete outage of the pods in a ReplicaSet with little&#13;
to no degradation of service. In this strategy the Deployment controller&#13;
will create a new ReplicaSet with the new configuration and will&#13;
delete the prior ReplicaSet before bringing the new pods online.&#13;
Services that sit behind queue-based systems are an example of a service&#13;
that could handle this type of disruption, because messages will queue while&#13;
waiting for the new pods to come online, and message processing will&#13;
resume as soon as the new pods come online.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Putting It All Together" data-type="sect1"><div class="sect1" id="id204">&#13;
<h1>Putting It All Together</h1>&#13;
&#13;
<p>Within<a data-primary="Deployment resource" data-secondary="versioning/releases/rollouts example" data-type="indexterm" id="deploy-resource-version"/><a data-primary="versioning" data-secondary="example" data-type="indexterm" id="version-example"/><a data-primary="releases" data-secondary="example" data-type="indexterm" id="release-example"/><a data-primary="rollouts" data-secondary="example" data-type="indexterm" id="rollout-example"/> a single service Deployment, a few key areas are affected by&#13;
versioning, release, and rollout management. Let’s&#13;
examine an example Deployment and then break down the specific areas of&#13;
interest as they relate to best practices:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="c1"># Web Deployment</code><code class="w"/>&#13;
<code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gb-web-deploy</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">guest-book</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">appver</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.6.9</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">environment</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">production</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">release</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">guest-book-stable</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">release number</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">34e57f01</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">strategy</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">rollingUpdate</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">rollingUpdate</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">maxUnavailbale</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">3</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">maxSurge</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">2</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gb-web</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">ver</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.5.8</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">matchExpressions</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="p-Indicator">{</code><code class="nt">key</code><code class="p">:</code><code class="w"> </code><code class="nv">environment</code><code class="p-Indicator">,</code><code class="nt"> operator</code><code class="p">:</code><code class="w"> </code><code class="nv">In</code><code class="p-Indicator">,</code><code class="nt"> values</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="nv">production</code><code class="p-Indicator">]}</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gb-web</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">ver</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.5.8</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">environment</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">production</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gb-web-cont</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">evillgenius/gb-web:v1.5.5</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">env</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GB_DB_HOST</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gb-mysql</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GB_DB_PASSWORD</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">valueFrom</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">secretKeyRef</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysql-pass</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">key</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">password</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">resources</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">limits</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">memory</code><code class="p">:</code><code class="w"> </code><code class="s">"128Mi"</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">cpu</code><code class="p">:</code><code class="w"> </code><code class="s">"500m"</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">80</code><code class="w"/>&#13;
<code class="nn">---</code><code class="w"/>&#13;
<code class="c1"># DB Deployment</code><code class="w"/>&#13;
<code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gb-mysql</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">guest-book</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">appver</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.6.9</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">environment</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">production</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">release</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">guest-book-stable</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">release number</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">34e57f01</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gb-db</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">tier</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">backend</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">strategy</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Recreate</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gb-db</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">tier</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">backend</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">ver</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.5.9</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">environment</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">production</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysql:5.6</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysql</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">env</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">MYSQL_PASSWORD</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">valueFrom</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">secretKeyRef</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysql-pass</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">key</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">password</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">3306</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysql</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysql-persistent-storage</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/var/lib/mysql</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">volumes</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysql-persistent-storage</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">persistentVolumeClaim</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">claimName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysql-pv-claim</code><code class="w"/>&#13;
<code class="nn">---</code><code class="w"/>&#13;
<code class="c1"># DB Backup Job</code><code class="w"/>&#13;
<code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">batch/v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Job</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">db-backup</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">guest-book</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">appver</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.6.9</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">environment</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">production</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">release</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">guest-book-stable</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">release number</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">34e57f01</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="s">"helm.sh/hook"</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">pre-upgrade</code><code class="w"/>&#13;
<code class="w">    </code><code class="s">"helm.sh/hook"</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">pre-delete</code><code class="w"/>&#13;
<code class="w">    </code><code class="s">"helm.sh/hook"</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">pre-rollback</code><code class="w"/>&#13;
<code class="w">    </code><code class="s">"helm.sh/hook-delete-policy"</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">hook-succeeded</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gb-db-backup</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">tier</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">backend</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">ver</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.6.1</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">environment</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">production</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysqldump</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">evillgenius/mysqldump:v1</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">env</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">DB_NAME</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gbdb1</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GB_DB_HOST</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gb-mysql</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GB_DB_PASSWORD</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">valueFrom</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">secretKeyRef</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysql-pass</code><code class="w"/>&#13;
<code class="w">              </code><code class="nt">key</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">password</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">          </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/mysqldump</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysqldump</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">volumes</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mysqldump</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">hostPath</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/home/bck/mysqldump</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">restartPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Never</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">backoffLimit</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">3</code><code class="w"/></pre>&#13;
&#13;
<p>Upon first inspection, things might look a little off. How can a Deployment have a version tag and the container image the Deployment uses have a different version tag? What will happen if one changes and the other does not? What&#13;
does release mean in this example, and what will be the effect on the&#13;
system if it changes? If a certain label is changed, when&#13;
will it trigger an update to my Deployment? We can find the answers to these questions by looking at some of the best practices for versioning, <a data-primary="Deployment resource" data-secondary="versioning/releases/rollouts example" data-startref="deploy-resource-version" data-type="indexterm" id="id656"/><a data-primary="versioning" data-secondary="example" data-startref="version-example" data-type="indexterm" id="id657"/><a data-primary="releases" data-secondary="example" data-startref="release-example" data-type="indexterm" id="id658"/><a data-primary="rollouts" data-secondary="example" data-startref="rollout-example" data-type="indexterm" id="id659"/>releases, and rollouts.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Best Practices for Versioning, Releases, and Rollouts" data-type="sect1"><div class="sect1" id="id205">&#13;
<h1>Best Practices for Versioning, Releases, and Rollouts</h1>&#13;
&#13;
<p>Effective CI/CD <a data-primary="versioning" data-secondary="best practices" data-type="indexterm" id="version-best-practice"/><a data-primary="releases" data-secondary="best practices" data-type="indexterm" id="release-best-practice"/><a data-primary="rollouts" data-secondary="best practices" data-type="indexterm" id="rollout-best-practice"/><a data-primary="best practices" data-secondary="versioning/releases/rollouts" data-type="indexterm" id="best-practice-version"/>and the ability to offer reduced- or zero-downtime deployments depend on using consistent practices for versioning and release management. The following best practices can help to define consistent parameters that can assist DevOps teams in delivering smooth software deployments:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Use semantic versioning for the application that&#13;
differs from the version of the containers and the version of the pods&#13;
Deployment that make up the entire application. This allows for&#13;
independent life cycles of the containers that make up the application&#13;
and the application as a whole. This can be quite confusing at first,&#13;
but if a principled hierarchical approach is taken for when one changes the other, you can easily track it. In the previous example, the container itself is currently on <code>v1.5.5</code>; however, the pod specification is <code>1.5.8</code>, which could mean that changes were made to the pod&#13;
specification, such as new ConfigMaps, additional secrets, or updated&#13;
replica values, but the specific container used has not changed its&#13;
version. The application itself, the entire guestbook application, and&#13;
all its services, is at <code>1.6.9</code>, which could mean that operations made changes along the way that were beyond just this specific service,&#13;
such as other services that make up the entire application.</p>&#13;
</li>&#13;
<li>&#13;
<p>Use a release and release version/number label in your deployment&#13;
metadata to track releases from CI/CD pipelines. The release name and&#13;
release number should coordinate with the actual release in the CI/CD&#13;
tool records. This allows for both traceability through the CI/CD process&#13;
into the cluster and easier rollback identification. In the&#13;
previous example, the release number comes directly from the release ID of&#13;
the CD pipeline that created the manifest.</p>&#13;
</li>&#13;
<li>&#13;
<p>If Helm is being used to package services for deployment into Kubernetes, take special care to bundle together those services that need to be rolled back or upgraded together into the same Helm chart. Helm allows for easy&#13;
rollback of all components of the application to bring the state back to&#13;
what it was before the upgrade. Because Helm actually processes the templates and all the Helm directives before passing a flattened YAML configuration, the use of life-cycle hooks allows for proper ordering of the application of specific templates. Operators can use proper Helm life-cycle hooks to&#13;
ensure that upgrades and rollback will happen correctly. The previous example for the <code>Job</code> specification uses Helm life-cycle hooks to ensure&#13;
that the template runs a backup of the database before a&#13;
rollback, upgrade, or delete of the Helm release. It also ensures&#13;
that the <code>Job</code> is deleted after the job is run successfully, which, until&#13;
the TTL Controller comes out of alpha in Kubernetes, would require manual&#13;
cleanup.</p>&#13;
</li>&#13;
<li>&#13;
<p>Agree on a release nomenclature that makes sense for the operational&#13;
tempo of the organization. Simple <code>stable</code>, <code>canary</code>, and <code>alpha</code> states&#13;
are quite adequate for most <a data-primary="versioning" data-secondary="best practices" data-startref="version-best-practice" data-type="indexterm" id="id660"/><a data-primary="releases" data-secondary="best practices" data-startref="release-best-practice" data-type="indexterm" id="id661"/><a data-primary="rollouts" data-secondary="best practices" data-startref="rollout-best-practice" data-type="indexterm" id="id662"/><a data-primary="best practices" data-secondary="versioning/releases/rollouts" data-startref="best-practice-version" data-type="indexterm" id="id663"/>situations.</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="id354">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>Kubernetes has allowed for more complex Agile development processes to&#13;
be adopted within companies large and small. The ability to automate&#13;
many of the complex processes that would usually require large amounts&#13;
of human and technical capital has now been democratized so that&#13;
even startups can take advantage of this cloud pattern with relative ease. The&#13;
true declarative nature of Kubernetes really shines when planning the&#13;
proper use of labels and using native Kubernetes controller&#13;
capabilities. By properly identifying operational and development states&#13;
within the declarative properties of the applications deployed into&#13;
Kubernetes, organizations can tie in tooling and automation to more&#13;
easily manage the complex processes of upgrades, rollouts, and rollbacks&#13;
of capabilities.</p>&#13;
</div></section>&#13;
</div></section></body></html>