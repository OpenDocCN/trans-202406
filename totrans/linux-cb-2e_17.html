<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 19. System Rescue and Recovery &#10;with SystemRescue"><div class="chapter" id="cha-rescue-recovery">
<h1><span class="label">Chapter 19. </span>System Rescue and Recovery 
<span class="keep-together">with SystemRescue</span></h1>


<p>A <a data-type="indexterm" data-primary="SystemRescue" data-secondary="purpose of" id="idm46466154109624"/><a data-type="indexterm" data-primary="recovering" data-secondary="with SystemRescue" data-see="SystemRescue" data-secondary-sortas="SystemRescue" id="idm46466154108776"/>SystemRescue DVD or USB drive is an essential tool, and you may use it to
rescue nonbooting Linux and Windows systems. In this chapter you will learn how
to create SystemRescue boot media, how to find your way around SystemRescue,
customize boot options, repair GRUB, retrieve files from a failing disk, reset
Linux and Windows passwords, and convert SystemRescue from a read-only
filesystem to a read-write filesystem with a data partition.</p>

<p>Any live Linux can serve as a rescue Linux. The advantage of SystemRescue is its
small size, and it is tailored for rescue operations.</p>

<p>The root SystemRescue filesystem is read-only, so any changes you make are lost
when you shut it down. You will learn how to set it up to preserve your changes,
such as configurations, appearance, and adding software.</p>

<p>SystemRescue was originally based on Gentoo Linux, and since version 6.0 it is
built from<a data-type="indexterm" data-primary="Arch Linux" id="idm46466154106312"/> Arch Linux. Arch Linux is known for being a reliable and efficient
Linux distribution, and has first-rate documentation. Visit
<a href="https://archlinux.org"><em class="hyperlink">https://archlinux.org</em></a> for documentation and forums.</p>

<p>I prefer USB devices for SystemRescue, both thumb drives and USB hard disks.
They’re fast and have as much capacity as you need for copying files.</p>






<section data-type="sect1" class="pagebreak-before less_space" data-pdf-bookmark="19.1 Creating Your SystemRescue Bootable Device"><div class="sect1" id="idm46466154101608">
<h1>19.1 Creating Your SystemRescue Bootable Device</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154104824">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="installation media" data-secondary="creating" data-tertiary="for SystemRescue" data-tertiary-sortas="SystemRescue" id="install-media-systemrescue"/><a data-type="indexterm" data-primary="USB stick installation media, creating" data-secondary="for SystemRescue" data-tertiary-sortas="SystemRescue" id="USBstick-systemrescue"/><a data-type="indexterm" data-primary="DVD installation media, creating" data-secondary="for SystemRescue" data-secondary-sortas="SystemRescue" id="DVD-install-systemrescue"/><a data-type="indexterm" data-primary="SystemRescue" data-secondary="bootable device, creating" id="systemrescue-boot-device-create"/>want to make a SystemRescue DVD or USB drive.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154092584">
<h2>Solution</h2>

<p>Download the latest SystemRescue <em>.iso</em> from
<a href="https://system-rescue.org"><em class="hyperlink">https://system-rescue.org</em></a>.</p>

<p>The most reliable way to create a bootable SystemRescue USB stick is with the <em>dd</em> command (see <a data-type="xref" href="ch01.xhtml#recipe0106">Recipe 1.6</a>). See Recipes <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch01.xhtml#rec-bootable-dvd">1.4</a> and
<a data-type="xref" data-xrefstyle="select:labelnumber" href="ch01.xhtml#recipe0105">1.5</a> for instructions on creating a bootable DVD. <a data-type="xref" href="ch01.xhtml#cha-install-linux">Chapter 1</a> also describes how to boot to your new medium and
how to disable Secure Boot. SystemRescue does not include signing keys, so you
must disable<a data-type="indexterm" data-primary="Secure Boot, disabling" id="idm46466154085400"/><a data-type="indexterm" data-primary="disabling" data-secondary="Secure Boot" id="idm46466154083880"/> Secure Boot.</p>

<p>When you boot from a USB stick, plug it in to a USB port on your computer, not
a USB hub, because it will not be recognized on a hub.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154082120">
<h2>Discussion</h2>

<p>Remember to reenable Secure Boot when you are finished using SystemRescue.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154080824">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://system-rescue.org"><em class="hyperlink">https://system-rescue.org</em></a></p>
</li>
<li>
<p><a data-type="xref" href="ch01.xhtml#cha-install-linux">Chapter 1</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.2 Getting Started with SystemRescue"><div class="sect1" id="idm46466154078152">
<h1>19.2 Getting Started with SystemRescue</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154074344">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="SystemRescue" data-secondary="starting" id="systemrescue-start"/><a data-type="indexterm" data-primary="starting" data-secondary="SystemRescue" id="start-systemrescue"/>have booted up SystemRescue, and it stops at a plain console prompt, and you
need to know what to do.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154070248">
<h2>Solution</h2>

<p>SystemRescue gives you instructions on the initial login screen (<a data-type="xref" href="#fig-sysrec-6">Figure 19-1</a>).
You are automatically logged in as root, and there is no root password.</p>

<p>You can either work from the console or type <strong><code>startx</code></strong> to <a data-type="indexterm" data-primary="startx command" id="idm46466154067640"/><a data-type="indexterm" data-primary="graphical environments" data-secondary="SystemRescue" id="idm46466154065416"/>launch the Xfce4
desktop environment (<a data-type="xref" href="#fig-sysrec-7">Figure 19-2</a>).</p>

<figure><div id="fig-sysrec-6" class="figure">
<img src="Images/lcb2_1901.png" alt="The SystemRescue login screen.." width="719" height="346"/>
<h6><span class="label">Figure 19-1. </span>The SystemRescue login screen</h6>
</div></figure>

<figure><div id="fig-sysrec-7" class="figure">
<img src="Images/lcb2_1902.png" alt="The SystemRescue Xfce4 desktop environment." width="750" height="558"/>
<h6><span class="label">Figure 19-2. </span>The SystemRescue Xfce4 desktop environment</h6>
</div></figure>

<p>Explore the applications menu, adjust the appearance of Xfce, connect to
networks with NetworkManager, and shut it down or reboot just like any Linux
system.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154059192">
<h2>Discussion</h2>

<p>The one thing you cannot do with the stock SystemRescue image is make persistent
changes in its own configuration. Any changes you make will not survive a
restart because SystemRescue runs from a compressed read-only SquashFS
filesystem. However, you can set it up to preserve your changes; see
<a data-type="xref" href="#rec-preserve-changes">Recipe 19.14</a>.</p>

<p>SquashFS<a data-type="indexterm" data-primary="SquashFS" id="idm46466154056520"/> is the basis of many live Linux distributions, such as Ubuntu, Debian,
Mint, Fedora, and Arch. It is also used by the open source router firmware projects
DD-WRT and OpenWRT. SquashFS is lightweight and fast.</p>

<p>I like working from Xfce4 because it provides a lightweight graphical
environment and applications, and an X terminal for command-line <a data-type="indexterm" data-primary="SystemRescue" data-secondary="starting" data-startref="systemrescue-start" id="idm46466154051880"/><a data-type="indexterm" data-primary="starting" data-secondary="SystemRescue" data-startref="start-systemrescue" id="idm46466154052840"/>operations.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154051144">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://system-rescue.org"><em class="hyperlink">https://system-rescue.org</em></a></p>
</li>
<li>
<p><a href="https://xfce.org"><em class="hyperlink">https://xfce.org</em></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.3 Understanding SystemRescue’s Two Boot Screens"><div class="sect1" id="rec-boot-screens">
<h1>19.3 Understanding SystemRescue’s Two Boot Screens</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154045000">
<h2>Problem</h2>

<p>While <a data-type="indexterm" data-primary="SystemRescue" data-secondary="boot screens" id="systemrescue-bootscreen"/><a data-type="indexterm" data-primary="boot screen" data-secondary="SystemRescue" id="bootscreen-systemrescue"/><a data-type="indexterm" data-primary="BIOS/UEFI setup" data-secondary="SystemRescue boot screens" id="BIOS-UEFI-systemrescue"/>testing SystemRescue, you noticed there are two different boot screens,
and you want to know what they are for.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154039848">
<h2>Solution</h2>

<p>There are two different boot screens according to how you boot SystemRescue.
You’ll see one boot screen with legacy BIOS boot (<a data-type="xref" href="#fig-sysrec-2">Figure 19-3</a>) and
a different screen with UEFI boot (<a data-type="xref" href="#fig-sysrec-4">Figure 19-4</a>).</p>

<p>When the UEFI setup on my Dell system is configured to allow booting legacy
devices, the one-time boot menu (press F12 at startup) shows
all possible boot options (<a data-type="xref" href="#fig-sysrec-5">Figure 19-5</a>). SystemRescue supports UEFI, so it
is not necessary to enable legacy boot. (Remember that Secure Boot must be
disabled for SystemRescue to boot.)</p>

<p>Your system’s BIOS/UEFI may not look like mine, as they all vary.</p>

<figure><div id="fig-sysrec-2" class="figure">
<img src="Images/lcb2_1903.png" alt="The SystemRescue legacy boot screen." width="1154" height="762"/>
<h6><span class="label">Figure 19-3. </span>The SystemRescue legacy BIOS boot screen</h6>
</div></figure>

<figure><div id="fig-sysrec-4" class="figure">
<img src="Images/lcb2_1904.png" alt="The SystemRescue UEFI boot screen." width="920" height="484"/>
<h6><span class="label">Figure 19-4. </span>The SystemRescue UEFI boot screen</h6>
</div></figure>

<figure><div id="fig-sysrec-5" class="figure">
<img src="Images/lcb2_1905.png" alt="Dell one-time boot menu shows all possible boot options." width="1572" height="711"/>
<h6><span class="label">Figure 19-5. </span>Dell one-time boot menu shows all possible boot options</h6>
</div></figure>

<p>The main difference between the two boot screens is the SystemRescue UEFI boot
screen has the “Start EFI Shell” and “EFI Firmware Setup” options, which are not
applicable to a legacy BIOS boot.</p>

<p>The legacy BIOS boot screen does not have the two EFI options, but it includes
Memtest86+ for testing system memory.</p>

<p>See <a data-type="xref" href="#rec-boot-options">Recipe 19.4</a> to learn what the different SystemRescue boot options
are for.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154039048">
<h2>Discussion</h2>

<p>You can configure removable media as the default boot device. Then you don’t have
to hassle with entering your BIOS/UEFI to enable a different boot device or
waiting for the right moment to call up your one-time boot menu; just insert your removable boot media when you need it.</p>

<p>If you are running an older system with no UEFI, you won’t have to choose or
hassle with Secure Boot.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154022824">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://system-rescue.org"><em class="hyperlink">https://system-rescue.org</em></a></p>
</li>
<li>
<p><a data-type="xref" href="ch01.xhtml#cha-install-linux">Chapter 1</a></p>
</li>
<li>
<p><a data-type="xref" href="#rec-boot-options">Recipe 19.4</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.4 Understanding SystemRescue’s Boot Options"><div class="sect1" id="rec-boot-options">
<h1>19.4 Understanding SystemRescue’s Boot Options</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466154014936">
<h2>Problem</h2>

<p>You want to know what all those SystemRescue boot options are
for (<a data-type="xref" href="#rec-boot-screens">Recipe 19.3</a>).</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154013000">
<h2>Solution</h2>

<p>The boot menu options are shortcuts for the most commonly used boot options,
saving you the trouble of opening the editing form and typing them. In most cases
you will use the first boot option, “Boot SystemRescue Using Default Options.”</p>

<p>The second option, “Boot SystemRescue and copy to RAM (copytoram),” speeds up
performance by loading SystemRescue completely into memory. This is
especially useful when you run SystemRescue from a DVD. It uses about 2 GB
of RAM.</p>

<p>The third option, “Boot SystemRescue and verify integrity of the medium (checksum),”
tests itself for corruption. Use this to verify that your SystemRescue is healthy.</p>

<p>The fourth option, “Boot SystemRescue using basic display drivers (nomodeset),” uses
lower-resolution basic video drivers. Use this if your video does not look right
because SystemRescue does not have the right graphics drivers.</p>

<p>The fifth option, “Boot a Linux operating system installed on the disk (findroot),”
is a good way to test if the bootloader is the problem on a nonbooting Linux
installation. It will find a bootable partition, and if there is more than one
it lists all of them, and you select which one you want to use.</p>

<p>The sixth option, “Stop during the root process before mounting the root filesystem,”
is a repair mode in case SystemRescue will not boot. I think it’s easier to keep
some extra SystemRescue drives on hand than to try to repair a broken
SystemRescue.</p>

<p>The UEFI boot screen has two additional options: “Start EFI Shell,” and “EFI
Firmware Setup.” “Start EFI Shell” gives you access to the numerous EFI utilities,
and “EFI Firmware Setup” takes you to your system’s UEFI setup.</p>

<p>Then Reboot and Power off.</p>

<p>The BIOS boot screen has two additional options: “Boot existing OS” and “Run
Memtest86+.” “Boot existing OS” helps diagnose bootloader problems by bypassing
the system’s bootloader, and “Memtest86+” tests system memory.</p>

<p>Both screens include “Reboot” and “Power off,” for rebooting or shutting down
SystemRescue instead of starting it up.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154011608">
<h2>Discussion</h2>

<p>I don’t see much value in using the EFI shell because it supports advanced
operations far beyond what you need for rescuing a nonbooting system. See Intel’s
<a href="https://oreil.ly/dktzy">Basic Instructions for Using the Extensible Firmware Interface</a>
to learn all about it.</p>

<p>All of these menu options are shortcuts for some of SystemRescue’s boot options,
which are documented on <a href="https://system-rescue.org"><em class="hyperlink">https://system-rescue.org</em></a>. You
may append boot options to any of the SystemRescue boot menu items, which you
will see in several of the recipes in this chapter.</p>

<p>You can do these tasks after you start SystemRescue, or pass in boot options. In
the legacy BIOS screen, select your boot entry, then press the Tab key, which
opens an edit field. Enter <strong><code>rootpass=<em>yourpassword</em> nofirewall</code></strong>, then press
Enter to resume startup.</p>

<p>In the UEFI boot screen, press the E key to pass in your own <a data-type="indexterm" data-primary="SystemRescue" data-secondary="boot screens" data-startref="systemrescue-bootscreen" id="idm46466153997096"/><a data-type="indexterm" data-primary="boot screen" data-secondary="SystemRescue" data-startref="bootscreen-systemrescue" id="idm46466153995624"/><a data-type="indexterm" data-primary="BIOS/UEFI setup" data-secondary="SystemRescue boot screens" data-startref="BIOS-UEFI-systemrescue" id="idm46466153994536"/>boot options.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154002568">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://system-rescue.org"><em class="hyperlink">https://system-rescue.org</em></a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.5 Identifying Filesystems"><div class="sect1" id="idm46466153990856">
<h1>19.5 Identifying Filesystems</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153989672">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="filesystems" data-secondary="listing" data-tertiary="existing" id="filesystem-list-exist"/><a data-type="indexterm" data-primary="listing" data-secondary="filesystems" data-tertiary="existing" id="list-filesystem-exist"/><a data-type="indexterm" data-primary="existing filesystems, listing" id="existing-filesystem-listing"/><a data-type="indexterm" data-primary="lsblk command" data-secondary="listing existing filesystems" id="lsblk-command"/>need to know how to identify the filesystems on your hard disks, so you are
certain which ones to use in your rescue operations.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153982632">
<h2>Solution</h2>

<p>Use the good old <em>lsblk</em> command:</p>
<pre># <strong>lsblk -f</strong>
NAME   FSTYPE   FSVER LABEL     UUID                SAVAIL FSUSE% MOUNTPOINT
loop0  squashfs 4.0                                      0   100% /run/archiso/sf
s/airootfs
sda
├─sda1
└─sda2 ntfs                     5E363
sdb
├─sdb1 vfat     FAT16 BOOT      5E2F-1E75
├─sdb2 btrfs          root      02bfdc9a-b8bb-45ac-95a8
├─sdb3 xfs            home      cc8acf0b-529e-473c-b484
└─sdb4 swap     1               7a5519ae-efe6-45e6-b147
sdc    iso9660        RESCUE800 2021-03-06-08-53-50-00
└─sdc1 iso9660        RESCUE800 2021-03-06-08-53-50-00    0   100% /run/archiso/
bootmnt
</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153979080">
<h2>Discussion</h2>

<p>Using filesystem labels makes finding the correct filesystems a lot easier. You
may also use labels in place of UUIDs, for example, in <em>/etc/fstab</em>. See
<a data-type="xref" href="ch09.xhtml#rec-new-partition-gparted">Recipe 9.4</a> and <a data-type="xref" href="ch11.xhtml#cha-create-filesystems">Chapter 11</a> for information on
managing filesystem labels.</p>

<p><em>lsblk</em> does not need root privileges and displays information about your block
devices in almost any way you want to <a data-type="indexterm" data-primary="filesystems" data-secondary="listing" data-tertiary="existing" data-startref="filesystem-list-exist" id="idm46466153975256"/><a data-type="indexterm" data-primary="listing" data-secondary="filesystems" data-tertiary="existing" data-startref="list-filesystem-exist" id="idm46466153974168"/><a data-type="indexterm" data-primary="existing filesystems, listing" data-startref="existing-filesystem-listing" id="idm46466153973400"/><a data-type="indexterm" data-primary="lsblk command" data-secondary="listing existing filesystems" data-startref="lsblk-command" id="idm46466153971128"/>see it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153968600">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch09.xhtml#rec-new-partition-gparted">Recipe 9.4</a></p>
</li>
<li>
<p><a data-type="xref" href="ch11.xhtml#rec-lsblk">Recipe 11.2</a></p>
</li>
<li>
<p><a data-type="xref" href="ch11.xhtml#cha-create-filesystems">Chapter 11</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.6 Resetting a Linux Root Password"><div class="sect1" id="idm46466153969672">
<h1>19.6 Resetting a Linux Root Password</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153962232">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="SystemRescue" data-secondary="root password, resetting" id="systemrescue-root-password"/><a data-type="indexterm" data-primary="root password" data-secondary="resetting" id="root-password-resetting"/><a data-type="indexterm" data-primary="passwords" data-secondary="root" data-tertiary="resetting" id="password-root-reset"/><a data-type="indexterm" data-primary="resetting" data-secondary="root password" id="reset-root-password"/>forgot your Linux root password and need to reset it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153954904">
<h2>Solution</h2>

<p>Boot SystemRescue, then mount the correct root filesystem. In the following
examples, the root filesystem is on <em>/dev/sdb2</em>.  Create a mountpoint in
<em>/mnt</em>, then mount your filesystem:</p>
<pre># <strong>mkdir /mnt/<i>sdb2</i></strong>
# <strong>mount /dev/<i>sdb2</i> /mnt/<i>sdb2</i></strong></pre>

<p>Change from the SystemRescue root filesystem to your mounted filesystem:</p>
<pre># <strong>chroot /mnt/sdb2/ /bin/bash</strong>
:/ #</pre>

<p>Reset the root password:</p>
<pre>:/ # <strong>passwd root</strong>
New password:
Retype new password:
passwd: password updated successfully
:/ #</pre>

<p class="pagebreak-before less_space">Type <strong><code>exit</code></strong> to return to the SystemRescue root filesystem.</p>

<p>Reboot, log in, and try your new password.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153954648">
<h2>Discussion</h2>

<p>You cannot recover a forgotten password, but only create a new one.</p>

<p>This works for any user’s password.</p>

<p>By changing to the host system’s root filesystem you can run some commands, but
not all of them because it is not a complete filesystem. It is missing all the
pseudo-filesystems that exist only in memory, such as <em>sysfs</em> and <em>proc</em>.
See <a data-type="xref" href="#rec-repair-grub">Recipe 19.9</a> to learn how to set up a more complete <em>chroot</em> environment.</p>

<p>Once upon a time you could reset a root password by deleting the password hash
in <em>/etc/shadow</em>. That was then, and now the <em>pam</em> subsystem is more complex
and controls authorization. If you’re curious, study the SystemRescue <em>pam</em>
configuration to see how it is set up to allow an empty root <a data-type="indexterm" data-primary="SystemRescue" data-secondary="root password, resetting" data-startref="systemrescue-root-password" id="idm46466153937384"/><a data-type="indexterm" data-primary="root password" data-secondary="resetting" data-startref="root-password-resetting" id="idm46466153935848"/><a data-type="indexterm" data-primary="passwords" data-secondary="root" data-tertiary="resetting" data-startref="password-root-reset" id="idm46466153934760"/><a data-type="indexterm" data-primary="resetting" data-secondary="root password" data-startref="reset-root-password" id="idm46466153933432"/>password.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153944776">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://system-rescue.org"><em class="hyperlink">https://system-rescue.org</em></a></p>
</li>
<li>
<p><a data-type="xref" href="ch05.xhtml#cha-users-groups">Chapter 5</a></p>
</li>
<li>
<p><em>man 7 pam</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.7 Enabling SSH in SystemRescue"><div class="sect1" id="rec-enable-ssh">
<h1>19.7 Enabling SSH in SystemRescue</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153925208">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="SystemRescue" data-secondary="SSH, enabling" id="systemrescue-ssh-enable"/><a data-type="indexterm" data-primary="OpenSSH" data-secondary="enabling in SystemRescue" id="openssh-enable-systemrescue"/><a data-type="indexterm" data-primary="enabling" data-secondary="SSH in SystemRescue" id="enable-ssh-systemrescue"/><a data-type="indexterm" data-primary="firewalls" data-secondary="disabling" id="firewall-disable"/><a data-type="indexterm" data-primary="disabling" data-secondary="firewalls" id="disable-firewall"/>want SSH access to SystemRescue.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153917992">
<h2>Solution</h2>

<p>SSH is enabled by default, and so is the firewall. Disable the firewall to allow
incoming SSH sessions.</p>

<p>After launching SystemRescue, disable the firewall <a data-type="indexterm" data-primary="systemctl command" data-secondary="disabling firewall" id="idm46466153915128"/>with <em>systemctl</em>:</p>
<pre>[root@systemrescue ~]# <strong>systemctl stop iptables.service</strong></pre>

<p class="pagebreak-before less_space">By default, root has no password on SystemRescue. You must create one to enable
an SSH session:</p>
<pre>[root@systemrescue ~]# <strong>passwd root</strong>
New password:
Retype new password:
passwd: password updated successfully</pre>

<p>Now you can log in to SystemRescue from another computer:</p>
<pre>$ <strong>ssh root@<i>192.168.10.101</i></strong>
ssh root@192.168.1.91
The authenticity of host '192.168.1.91 (192.168.1.91)' can't be established.
ECDSA key fingerprint is SHA256:LlUCEngz5NHg98xv.
Are you sure you want to continue connecting (yes/no/[fingerprint])? <strong>yes</strong>
Warning: Permanently added '192.168.1.91' (ECDSA) to the list of known hosts.
root@192.168.1.91's password:
[root@sysrescue ~]# </pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153908504">
<h2>Discussion</h2>

<p>Every time you boot SystemRescue, it is like a brand-new system with a different
SSH host key. If you reboot SystemRescue, then open a second SSH system from the same computer to SystemRescue, you will see this warning:</p>
<pre>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!</pre>

<p>This goes on for a few more lines, and it tells you the remedy:</p>
<pre>Offending ECDSA key in /home/duchess/.ssh/known_hosts:12
  remove with:
  ssh-keygen -f "/home/duchess/.ssh/known_hosts" -R "192.168.10.101"</pre>

<p>Do what is says, then you can SSH in to SystemRescue.</p>

<p>You may disable the firewall from the boot menu. Press the Tab key (legacy boot)
or the E key (UEFI boot) to add the <em>nofirewall</em> boot option (see the boot
parameters line at the bottom of the <a data-type="indexterm" data-primary="SystemRescue" data-secondary="SSH, enabling" data-startref="systemrescue-ssh-enable" id="idm46466153902952"/><a data-type="indexterm" data-primary="OpenSSH" data-secondary="enabling in SystemRescue" data-startref="openssh-enable-systemrescue" id="idm46466153901544"/><a data-type="indexterm" data-primary="enabling" data-secondary="SSH in SystemRescue" data-startref="enable-ssh-systemrescue" id="idm46466153900456"/><a data-type="indexterm" data-primary="firewalls" data-secondary="disabling" data-startref="firewall-disable" id="idm46466153899368"/><a data-type="indexterm" data-primary="disabling" data-secondary="firewalls" data-startref="disable-firewall" id="idm46466153898248"/>screen, <a data-type="xref" href="#fig-sysrec-8">Figure 19-6</a>).</p>

<figure><div id="fig-sysrec-8" class="figure">
<img src="Images/lcb2_1906.png" alt="Disabling the firewall at boot." width="973" height="599"/>
<h6><span class="label">Figure 19-6. </span>Disabling the firewall at boot</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153904664">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://system-rescue.org"><em class="hyperlink">https://system-rescue.org</em></a></p>
</li>
<li>
<p><a data-type="xref" href="#rec-boot-options">Recipe 19.4</a></p>
</li>
<li>
<p><a data-type="xref" href="ch12.xhtml#cha-ssh">Chapter 12</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.8 Copying Files over the Network with scp and sshfs"><div class="sect1" id="idm46466153887976">
<h1>19.8 Copying Files over the Network with scp and sshfs</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153887080">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="SystemRescue" data-secondary="files, copying over network" id="systemrescue-file-copy"/><a data-type="indexterm" data-primary="files" data-secondary="copying" data-tertiary="over network" id="file-copy-network"/><a data-type="indexterm" data-primary="copying" data-secondary="files" data-tertiary="over network" id="copy-file-network"/><a data-type="indexterm" data-primary="networking" data-secondary="copying files over" id="network-files-copy"/><a data-type="indexterm" data-primary="scp command" id="scp"/><a data-type="indexterm" data-primary="sshfs command" id="sshfs-copy-file"/>have SystemRescue up and running on the system you are rescuing and want to
rescue files by copying them over the network.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153877400">
<h2>Solution</h2>

<p>No problem, do this just like on any Linux. First, enable SSH (<a data-type="xref" href="#rec-enable-ssh">Recipe 19.7</a>).
Then use <em>scp</em> or <em>sshfs</em> to move the files you want to save. All of the commands
in this recipe are run from SystemRescue.</p>

<p>Find the filesystem you want to copy files from with <em>lsblk</em>. If you don’t
remember which partition you want, mount each one to see the files until you
find the right one:</p>
<pre># <strong>lsblk -f</strong>
NAME   FSTYPE   FSVER LABEL     UUID                SAVAIL FSUSE% MOUNTPOINT
loop0  squashfs 4.0                                      0   100% /run/archiso/sf
s/airootfs
sda
├─sda1
└─sda2 ntfs                     5E363E30363E0993
sdb
├─sdb1 vfat     FAT16 BOOT      5E2F-1E75
├─sdb2 btrfs          root      02bfdc9a-b8bb-45ac-95a8
├─sdb3 xfs            home      cc8acf0b-529e-473c-b484
└─sdb4 swap     1               7a5519ae-efe6-45e6-b147
sdc    iso9660        RESCUE800 2021-03-06-08-53-50-00
└─sdc1 iso9660        RESCUE800 2021-03-06-08-53-50-00    0   100% /run/archiso/b
ootmnt
sr0 </pre>

<p>The following example mounts the partition containing <em>/home</em> on the system being
rescued in <em>/mnt</em> on SystemRescue, lists the files in the mountpoint, then
copies the whole <em>/home</em> directory to Duchess’s PC with <em>scp</em>:</p>
<pre># <strong>mkdir /mnt/<i>sdb3</i></strong>
# <strong>mount /dev/<i>sdb3</i> /mnt/<i>sda3</i></strong>
# <strong>ls /mnt/<i>sdb3</i></strong>
bin   dev  home  lib64       media  opt   root  sbin  sys  usr
boot  etc  lib   lost+found  mnt    proc  run   srv   tmp  var
# <strong>scp -r /mnt/sdb3/home/ duchess@pc:</strong>
</pre>

<p>The result is <em>/home/duchess/home</em>.</p>
<div data-type="warning" epub:type="warning"><h1>Always Create a Subdirectory in /mnt</h1>
<p>Never <a data-type="indexterm" data-primary="/mnt" data-secondary="subdirectories in" id="idm46466153861944"/><a data-type="indexterm" data-primary="filesystems" data-secondary="mounting" id="idm46466153861096"/><a data-type="indexterm" data-primary="mounting" data-secondary="filesystems" id="idm46466153860184"/>mount any filesystems in <em>/mnt</em>; it will freeze 
<span class="keep-together">SystemRescue</span>.
Always create subdirectories for your mountpoints.</p>
</div>

<p>You may copy a space-delimited list of files and mix files and directories.
This example copies them to the <em>rescue</em> directory on <em>duchess@pc</em>. The remote
directory must already exist:</p>
<pre># <strong>cd /mnt/sdb3/home/</strong>
# <strong>scp -r <i>file1.txt directory1 file2.txt</i> duchess@pc:rescue/</strong></pre>

<p><em>sshfs</em> is convenient because it mounts a remote filesystem so that it appears as a local filesystem, and you can copy files just as though they were local. Create a
mountpoint on SystemRescue, then mount a remote directory on it, which must
already exist. You will copy files from SystemRescue to the remote system:</p>
<pre># <strong>mkdir /mnt/<i>remote</i></strong>
# <strong>sshfs duchess@pc:rescue/ /mnt/<i>remote</i>/</strong>
# <strong>ls /mnt/<i>remote</i></strong>
rescue</pre>

<p>Now you can use the <em>cp</em> command on SystemRescue, or use a graphical file
manager to copy files (<a data-type="xref" href="#fig-sysrec-10">Figure 19-7</a>).</p>

<figure><div id="fig-sysrec-10" class="figure">
<img src="Images/lcb2_1907.png" alt="Copy files on SystemRescue with a graphical file manager." width="718" height="616"/>
<h6><span class="label">Figure 19-7. </span>Copy files on SystemRescue with a graphical file manager</h6>
</div></figure>

<p>When you are finished, run <strong><code>fusermount -u <em>remote</em></code></strong> to cleanly unmount the
<em>sshfs</em> filesystem.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153876776">
<h2>Discussion</h2>

<p>If you have disabled SSH password authentication on the system you are copying
the files to, reenable it temporarily by commenting out <em>PermitRootLogin no</em>
in <em>/etc/ssh/sshd_config</em>.</p>

<p>The syntax for connecting to the remote directory is relative to the user account
you are logging into. <em>duchess@pc:</em> is the same as <em>duchess@pc:/home/duchess</em>.
<em>duchess@pc:/</em> accesses the root filesystem. When you need to edit system
configuration files, use <em>duchess@pc:/etc</em>; for bootfiles, use <em>duchess@pc:/boot</em>,
and so on.</p>

<p>You can create the remote directory from SystemRescue<a data-type="indexterm" data-primary="SystemRescue" data-secondary="files, copying over network" data-startref="systemrescue-file-copy" id="idm46466153838952"/><a data-type="indexterm" data-primary="files" data-secondary="copying" data-tertiary="over network" data-startref="file-copy-network" id="idm46466153837864"/><a data-type="indexterm" data-primary="copying" data-secondary="files" data-tertiary="over network" data-startref="copy-file-network" id="idm46466153836536"/><a data-type="indexterm" data-primary="networking" data-secondary="copying files over" data-startref="network-files-copy" id="idm46466153835208"/><a data-type="indexterm" data-primary="scp command" data-startref="scp" id="idm46466153834024"/><a data-type="indexterm" data-primary="sshfs command" data-startref="sshfs-copy-file" id="idm46466153832920"/> with <em>ssh</em>:</p>
<pre># <strong>ssh <i>duchess@pc</i></strong>
duchess@pc's password:
duchess@pc:~$ <strong>mkdir remote</strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153829768">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch06.xhtml#rec-cp-mv">Recipe 6.5</a></p>
</li>
<li>
<p><a data-type="xref" href="ch12.xhtml#cha-ssh">Chapter 12</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.9 Repairing GRUB from SystemRescue"><div class="sect1" id="rec-repair-grub">
<h1>19.9 Repairing GRUB from SystemRescue</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153824408">
<h2>Problem</h2>

<p>Your<a data-type="indexterm" data-primary="SystemRescue" data-secondary="GRUB, repairing" id="systemrescue-grup-repair"/><a data-type="indexterm" data-primary="GRUB (GRand Unified Bootloader)" data-secondary="repairing from SystemRescue" id="GRUB-repair"/><a data-type="indexterm" data-primary="troubleshooting" data-secondary="GRUB, repairing from SystemRescue" id="troubleshoot-grub-repair"/><a data-type="indexterm" data-primary="chroot environments, creating" id="chroot-create"/> GRUB bootloader is broken, and your system does not boot.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153818280">
<h2>Solution</h2>

<p>Boot up SystemRescue, create a <em>chroot</em> environment, and reinstall GRUB.</p>

<p>After starting up SystemRescue, create a <em>chroot</em> environment for the root
filesystem on the host:</p>
<pre># <strong>mkdir /mnt/linux</strong>
# <strong>mount /dev/<i>sda2</i> /mnt/linux</strong>
# <strong>mount -o bind /proc /mnt/linux/proc</strong>
# <strong>mount -o bind /dev /mnt/linux/dev</strong>
# <strong>mount -o bind /sys /mnt/linux/dev</strong></pre>

<p>Enter the <em>chroot</em> environment:</p>
<pre># <strong>chroot /mnt/linux /bin/bash</strong>
:/ #</pre>

<p>If <em>/boot</em> is on its own partition, mount it:</p>
<pre>:/ # <strong>mount /dev/sda1 /boot/</strong></pre>

<p>Now reinstall GRUB:</p>
<pre>:/ # <strong>grub-install /dev/sda</strong></pre>

<p>When this is completed, type <strong><code>exit</code></strong> to leave the <em>chroot</em> environment, then
unmount all the filesystems. Reboot your system, and GRUB should work.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153817816">
<h2>Discussion</h2>

<p>Be very careful when creating a <em>chroot</em> environment, and make sure you are
using the correct partitions and filesystems. <em>chroot</em>, change root, is a
great utility for changing to a different root filesystem without rebooting.</p>

<p>You must unmount all <em>chroot</em> filesystems so that they unmount cleanly. It should
be all right to simply reboot, but it is cheap insurance to manually<a data-type="indexterm" data-primary="SystemRescue" data-secondary="GRUB, repairing" data-startref="systemrescue-grup-repair" id="idm46466153802584"/><a data-type="indexterm" data-primary="GRUB (GRand Unified Bootloader)" data-secondary="repairing from SystemRescue" data-startref="GRUB-repair" id="idm46466153801320"/><a data-type="indexterm" data-primary="troubleshooting" data-secondary="GRUB, repairing from SystemRescue" data-startref="troubleshoot-grub-repair" id="idm46466153800136"/><a data-type="indexterm" data-primary="chroot environments, creating" data-startref="chroot-create" id="idm46466153798872"/> unmount them
first.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153797032">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 1 chroot</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.10 Resetting a Windows Password"><div class="sect1" id="idm46466153794648">
<h1>19.10 Resetting a Windows Password</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153793640">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="SystemRescue" data-secondary="Windows password, resetting" id="systemrescue-windows-reset"/><a data-type="indexterm" data-primary="Windows" data-secondary="resetting password" id="windows-reset-password"/><a data-type="indexterm" data-primary="passwords" data-secondary="Windows, resetting" id="password-windows-reset"/><a data-type="indexterm" data-primary="resetting" data-secondary="Windows password" id="reset-windows-password"/> lost your Windows password, and you don’t want to jump through the usual
Windows hoops to reset it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153786744">
<h2>Solution</h2>

<p>No worries, for SystemRescue will have you back in action in a jiffy. Boot up
SystemRescue on your Windows machine, then mount your Windows system directory:</p>
<pre># <strong>mkdir /mnt/windows</strong>
# <strong>mount /dev/<i>sda2</i></strong></pre>

<p>Navigate to the <em>/mnt/windows/Windows/System32/config</em> directory, then<a data-type="indexterm" data-primary="chntpw command" id="chntpw"/> use
the <em>chntpw</em> (change NT password) command to list users:</p>
<pre># <strong>cd /mnt/windows/Windows/System32/config</strong>
# <strong>chntpw -l SAM</strong>
chntpw version 1.00 140201, (c) Petter N Hagen
Hive &lt;SAM&gt; name (from header): &lt;\SystemRoot\System32\Config\SAM&gt;
ROOT KEY at offset: 0x001020 * Subkey indexing type is: 686c &lt;lh&gt;
File size 65536 [10000] bytes, containing 7 pages (+ 1 headerpage)
Used for data: 318/31864 blocks/bytes, unused: 29/12968 blocks/bytes.

| RID -|---------- Username ------------| Admin? |- Lock? --|
| 01f4 | Administrator                  | ADMIN  |          |
| 03e9 | duchess                        | ADMIN  |          |
| 01f7 | DefaultAccount                 |        | dis/lock |
| 01f5 | Guest                          |        | dis/lock |
| 01f8 | WDAGUtilityAccount             |        | dis/lock |
</pre>

<p class="pagebreak-before less_space">Examine the information on the user you want to change:</p>
<pre># <strong>chntpw -u Administrator SAM</strong>
chntpw version 1.00 140201, (c) Petter N Hagen
Hive &lt;SAM&gt; name (from header): &lt;\SystemRoot\System32\Config\SAM&gt;
ROOT KEY at offset: 0x001020 * Subkey indexing type is: 686c &lt;lh&gt;
File size 65536 [10000] bytes, containing 9 pages (+ 1 headerpage)
Used for data: 321/33816 blocks/bytes, unused: 34/27336 blocks/bytes.

================= USER EDIT ====================

RID     : 0500 [01f4]
Username: Administrator
fullname:
comment : Built-in account for administering the computer/domain
homedir :

00000220 = Administrators (which has 2 members)

Account bits: 0x0210 =
[ ] Disabled        | [ ] Homedir req.    | [ ] Passwd not req. |
[ ] Temp. duplicate | [X] Normal account  | [ ] NMS account     |
[ ] Domain trust ac | [ ] Wks trust act.  | [ ] Srv trust act   |
[X] Pwd don't expir | [ ] Auto lockout    | [ ] (unknown 0x08)  |
[ ] (unknown 0x10)  | [ ] (unknown 0x20)  | [ ] (unknown 0x40)  |

Failed login count: 0, while max tries is: 0
Total  login count: 5

- - - - User Edit Menu:
 1 - Clear (blank) user password
 2 - Unlock and enable user account [probably locked now]
 3 - Promote user (make user an administrator)
 4 - Add user to a group
 5 - Remove user from a group
 q - Quit editing user, back to user select
Select: [q] ^</pre>

<p>Enter <strong><code>1</code></strong> to remove the existing password:</p>
<pre>Select: [q] ^ <strong>1</strong>
Password cleared!
[...]</pre>

<p>Press <strong><code>q</code></strong> to quit, and <strong><code>y</code></strong> to “write hive files,” which saves your changes.</p>

<p>Now the Administrator, or whatever user you selected, must log in and set a new
password.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153786280">
<h2>Discussion</h2>

<p>You cannot create a new password or recover the old one with <em>chntpw</em>, but
only delete it. Then you log in without a password and create a new password, or,
if your user is present, let them <a data-type="indexterm" data-primary="chntpw command" data-startref="chntpw" id="idm46466153770152"/><a data-type="indexterm" data-primary="SystemRescue" data-secondary="Windows password, resetting" data-startref="systemrescue-windows-reset" id="idm46466153768760"/><a data-type="indexterm" data-primary="Windows" data-secondary="resetting password" data-startref="windows-reset-password" id="idm46466153767576"/><a data-type="indexterm" data-primary="passwords" data-secondary="Windows, resetting" data-startref="password-windows-reset" id="idm46466153766152"/><a data-type="indexterm" data-primary="resetting" data-secondary="Windows password" data-startref="reset-windows-password" id="idm46466153765064"/>do it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153762904">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://system-rescue.org"><em class="hyperlink">https://system-rescue.org</em></a></p>
</li>
<li>
<p><em>man 8 chntpw</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.11 Rescuing a Failing Hard Disk with GNU ddrescue"><div class="sect1" id="rec-rescue-hard-drive">
<h1>19.11 Rescuing a Failing Hard Disk with GNU ddrescue</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153757416">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="hard disks" data-secondary="rescuing" id="hard-disk-rescue"/><a data-type="indexterm" data-primary="rescuing hard disks" id="rescue-hard-disk"/><a data-type="indexterm" data-primary="ddrescue command" id="ddrescue"/><a data-type="indexterm" data-primary="files" data-secondary="copying" data-tertiary="from failing hard disk" id="file-copy-hard-disk"/><a data-type="indexterm" data-primary="copying" data-secondary="files" data-tertiary="from failing hard disk" id="copy-file-hard-disk"/>suspect that your hard disk is dying, and you want to copy your data from it
before it expires.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153749416">
<h2>Solution</h2>

<p>You want the excellent GNU <em>ddrescue</em> utility. <em>ddrescue</em> tries to copy all the
good blocks first, saving as much data as possible, and skips over the bad
blocks, tracking their locations in a log file. You may make multiple passes to
try to capture more data.</p>

<p>The disk you are trying to rescue must be unmounted. You need another disk, also
unmounted, such as a USB storage device or an internal hard disk, to copy the
rescued data to. Your target partition must already exist and be at least 50%
larger than the partition you are trying to rescue.</p>

<p>The following example copies <em>/dev/sdb1</em> to <em>/dev/sdc1</em>:</p>
<pre># <strong>ddrescue -f -n /dev/sdb1 /dev/sdc1 ddlogfile</strong>
GNU ddrescue 1.25
Press Ctrl-C to interrupt
     ipos:   100177 MB, non-trimmed: 0 B    current rate:   207 MB/s
     opos:   100177 MB, non-scraped: 0 B    average rate: 83686 kB/s
non-tried:    47868 MB,  bad-sector: 0 B,     error rate:      0 B/s
  rescued:   100177 MB,   bad areas: 0,         run time:    23m 56s
pct rescued:    66.77%, read errors: 0,   remaining time:      6m 4s
                         time since last successful read:         0s
Copying non-tried blocks... Pass 1 (forwards)
</pre>

<p>This will take some time. When it is finished the last line will say “Finished.”</p>

<p>This example does one pass, copying the most easily read blocks as quickly as
possible. This is a good tactic on a drive with a lot of errors because
<em>ddrescue</em> won’t spend a lot of time trying to recover the most damaged blocks.
After making this first pass, run it three more times to try to recover more
data:</p>
<pre># <strong>ddrescue -d -f -r3 /dev/sdb1 /dev/sdc1 ddlogfile</strong></pre>

<p>When it is finished, run a filesystem check on the recovery disk, which should
remain unmounted. This example checks and automatically repairs Ext4
filesystems:</p>
<pre># <strong>e2fsck -vfp /dev/sdc1</strong></pre>

<p><em>-f</em> forces a check, in case <em>e2fsck</em> thinks the filesystem is clean. <em>-p</em> is
short for preen, or repair, and <em>-v</em> is verbose. If it finds a problem
that requires your intervention, it prints a description of the problem and exits.</p>

<p><em>e2fsck -vf [device]</em> launches an interactive check and repair.</p>

<p><em>fsck.vfat -vfp [device]</em> is for FAT16/32.</p>

<p><em>xfs_repair [device]</em> is for XFS filesystems.</p>

<p>If your recovered filesystem passes the filesystem checks, go ahead and copy
your files to their final location. If there are still problems, mount it read-only:</p>
<pre># <strong>mkdir /mnt/sdc1-copy</strong>
# <strong>mount -o ro /dev/sdc1 /mnt/sdc1-copy</strong></pre>

<p>Then copy as many files as you can to another disk.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153748872">
<h2>Discussion</h2>

<p>Make sure you have GNU <em>ddrescue</em>, by Antonio Diaz Diaz, and not <em>dd-rescue</em> by Kurt
Garloff. <em>dd-rescue</em> is<a data-type="indexterm" data-primary="dd-rescue command" id="idm46466153729688"/> a great tool, but it is more complicated to use.</p>

<p><em>ddrescue</em> copies at the block level, so it doesn’t matter what the filesystem
is that you are trying to rescue. <em>ddrescue</em> will make an exact copy regardless
of what filesystems your Linux supports.</p>

<p>If <em>ddrescue</em> runs out of space, it will fail at the very end, so be sure your
recovery drive has a generous amount of room.</p>

<p>You can use <em>ddrescue</em> on USB sticks, CompactFlash, and<a data-type="indexterm" data-primary="hard disks" data-secondary="rescuing" data-startref="hard-disk-rescue" id="idm46466153726888"/><a data-type="indexterm" data-primary="rescuing hard disks" data-startref="rescue-hard-disk" id="idm46466153724728"/><a data-type="indexterm" data-primary="ddrescue command" data-startref="ddrescue" id="idm46466153723592"/><a data-type="indexterm" data-primary="files" data-secondary="copying" data-tertiary="from failing hard disk" data-startref="file-copy-hard-disk" id="idm46466153722744"/><a data-type="indexterm" data-primary="copying" data-secondary="files" data-tertiary="from failing hard disk" data-startref="copy-file-hard-disk" id="idm46466153721160"/> SD cards.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153719224">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/mMxQf">GNU ddrescue</a></p>
</li>
<li>
<p><em>man 8 fsck (e2fsprogs)</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.12 Managing Partitions and Filesystems from SystemRescue"><div class="sect1" id="rec-partition-sysrescue">
<h1>19.12 Managing Partitions and Filesystems from SystemRescue</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153714024">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="SystemRescue" data-secondary="filesystems/partitions" data-tertiary="managing" id="systemrescue-filesystem-manage"/><a data-type="indexterm" data-primary="filesystems" data-secondary="managing in SystemRescue" id="filesystem-manage"/><a data-type="indexterm" data-primary="partitions" data-secondary="managing in SystemRescue" id="partition-manage"/> want to partition your hard disk or make changes to filesystem, and you need
to do it from an external Linux system.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153708216">
<h2>Solution</h2>

<p>Use SystemRescue. SystemRescue includes both GParted and <em>parted</em>. You don’t
have to mount any filesystems, and SystemRescue will operate directly on the block devices
on your host system. Use <em>lsblk</em> to see your host block devices:</p>
<pre>[root@systemrescue ~]# <strong>lsblk -p -o NAME,FSTYPE,LABEL</strong>
NAME          FSTYPE     LABEL
/dev/loop/0   squashfs
/dev/sr0
/dev/sr1      iso9660    RESCUE800
/dev/sda
├─/dev/sda1   vfat
├─/dev/sda2   xfs        osuse15-2
├─/dev/sda3   xfs        home
├─/dev/sda4   xfs
└─/dev/sda5   swap
/dev/sdb
└─/dev/sdb1   xfs        backups
/dev/sr0</pre>

<p>Follow the recipes in Chapters
<a data-xrefstyle="select:labelnumber" data-type="xref" href="ch08.xhtml#cha-partitioning-parted">8</a>,
<a data-xrefstyle="select:labelnumber" data-type="xref" href="ch09.xhtml#cha-partitioning-gparted">9</a>,
and
<a data-xrefstyle="select:labelnumber" data-type="xref" href="ch11.xhtml#cha-create-filesystems">11</a>
for managing partitions and filesystems.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153700072">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch08.xhtml#cha-partitioning-parted">Chapter 8</a></p>
</li>
<li>
<p><a data-type="xref" href="ch09.xhtml#cha-partitioning-gparted">Chapter 9</a></p>
</li>
<li>
<p><a data-type="xref" href="ch11.xhtml#cha-create-filesystems">Chapter 11</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" class="pagebreak-before less_space" data-pdf-bookmark="19.13 Creating a Data Partition on Your SystemRescue USB Drive"><div class="sect1" id="rec-writable-partition">
<h1>19.13 Creating a Data Partition on Your SystemRescue USB Drive</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153692312">
<h2>Problem</h2>

<p>SystemRescue on<a data-type="indexterm" data-primary="SystemRescue" data-secondary="filesystems/partitions" data-tertiary="creating data partition" id="systemrescue-partition-create"/><a data-type="indexterm" data-primary="partitions" data-secondary="creating" data-tertiary="in SystemRescue" data-tertiary-sortas="SystemRescue" id="partition-create-systemrescue"/><a data-type="indexterm" data-primary="USB stick installation media, creating" data-secondary="data partition for SystemRescue" id="USBstick-systemrescue-partition"/> USB drives is working well for you, but you want to know how to
partition your device with the SystemRescue root filesystem on the first partition
and a writable filesystem on the second partition. Then you will need only a single
device for copying files.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153686200">
<h2>Solution</h2>

<p>You can do this in just a few steps.</p>

<p>The stock SystemRescue image cannot boot from a partition. It uses less than a
gigabyte of space, so any USB stick will have a lot of wasted space. The trick
to making SystemRescue bootable from a partition is to make your SystemRescue ISO
capable of booting from a partition, add a Master Boot Record (MBR), then install the boot code, <em>mbr.bin</em>.</p>

<p>You need <em>isohybrid</em> and <em>mbr.bin</em>, which are provided by <em>syslinux</em>.
This is provided by the <em>syslinux</em> package on Fedora and openSUSE, and by
<em>syslinux-utils</em> and <em>install-mbr</em> on Ubuntu.</p>

<p>In the following examples, replace <em>/dev/sdc</em> with your own device.</p>

<p>First, make the SystemRescue image bootable from a partition:</p>
<pre>$ <strong>isohybrid --partok <i>systemrescuecd-8.01-amd64.iso</i></strong></pre>

<p>Create an <em>msdos</em> partition table on your USB drive. Use GParted
(<a data-type="xref" href="ch09.xhtml#rec-gparted-create-partition-table">Recipe 9.2</a>) or 
<span class="keep-together"><em>parted</em>:</span></p>
<pre>$ <strong>sudo parted /dev/<i>sdc</i></strong>
(parted) <strong>mklabel msdos</strong>
</pre>

<p>Create two partitions on your USB drive. Set the filesystem type on Partition 1
as FAT32, and set the <em>boot</em> flag. The following example creates an approximately
2 GB boot partition:</p>
<pre>(parted) <strong>mkpart "sysrec" fat32 1MB 2000MB</strong>
(parted) <strong>set 1 boot</strong>
</pre>

<p>Add a second partition for data storage, using any filesystem type you want.
The following example creates a 2 GB partition, then quits <em>parted</em>:</p>
<pre>(parted) <strong>mkpart "data" xfs 2001MB 4000MB</strong>
(parted) <strong>q</strong>
</pre>

<p>Create your filesystems. Partition 1 is FAT32, with the label <em>SYSRESCUE</em>;
Partition 2 is XFS, labeled <em>data</em>:</p>
<pre>$ <strong>sudo mkfs.fat -F 32 -n <i>SYSRESCUE /dev/sdc1</i></strong>
$ <strong>sudo mkfs.xfs -L <i>data /dev/sdc2</i></strong></pre>

<p>Install SystemRescue to the first partition:</p>
<pre>$ <strong>sudo dd status=progress if=<i>systemrescuecd-8.01-amd64.iso</i> of=/dev/<i>sdc1</i></strong>
</pre>

<p>On Ubuntu, install the MBR to the USB drive:</p>
<pre>$ <strong>sudo install-mbr /dev/<i>sdc</i></strong></pre>

<p>On other Linuxes, use <em>dd</em>:</p>
<pre>$ <strong>sudo if=<i>/usr/share/syslinux/mbr.bin</i> of=/dev/<i>sdc</i></strong></pre>

<p><em>mbr.bin</em> may be in a different directory, depending which Linux you are using.</p>

<p>Boot up your SystemRescue drive, and it should start up normally.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153656376">
<h2>Discussion</h2>

<p>Your filesystems do not need labels; they are a convenience to help you remember
what they are for.</p>

<p>You may use any filesystem on the first partition. FAT32 is universal, so you can
boot SystemRescue on Linux, macOS, and Windows. For copying files from macOS and Windows, format your data partition as FAT32 or exFAT.</p>

<p>You will have to mount your second partition manually, then you can use it
however you want. It is convenient for copying files from the host system, and the
coolest thing about having this writable partition is you can use it as a backing
store for storing changes you make to SystemRescue, such as configuration changes
and installing software. See <a data-type="xref" href="#rec-preserve-changes">Recipe 19.14</a> to learn all about<a data-type="indexterm" data-primary="SystemRescue" data-secondary="filesystems/partitions" data-tertiary="creating data partition" data-startref="systemrescue-partition-create" id="idm46466153654200"/><a data-type="indexterm" data-primary="partitions" data-secondary="creating" data-tertiary="in SystemRescue" data-tertiary-sortas="SystemRescue" data-startref="partition-create-systemrescue" id="idm46466153649272"/><a data-type="indexterm" data-primary="USB stick installation media, creating" data-secondary="data partition for SystemRescue" data-startref="USBstick-systemrescue-partition" id="idm46466153653128"/> it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153651448">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch08.xhtml#cha-partitioning-parted">Chapter 8</a></p>
</li>
<li>
<p><a data-type="xref" href="ch11.xhtml#cha-create-filesystems">Chapter 11</a></p>
</li>
<li>
<p><a href="https://system-rescue.org"><em class="hyperlink">https://system-rescue.org</em></a></p>
</li>
<li>
<p><em>man 1 isohybrid</em></p>
</li>
<li>
<p><em>man 1 dd</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="19.14 Preserving Changes in SystemRescue"><div class="sect1" id="rec-preserve-changes">
<h1>19.14 Preserving Changes in SystemRescue</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466153638536">
<h2>Problem</h2>

<p>SystemRescue<a data-type="indexterm" data-primary="SystemRescue" data-secondary="preserving changes" id="systemrescue-preserve"/><a data-type="indexterm" data-primary="preserving" data-secondary="SystemRescue changes" id="preserve-systemrescue"/><a data-type="indexterm" data-primary="changing" data-secondary="SystemRescue, preserving changes" id="change-systemrescue-preserve"/> is working well for you, but you wish you could preserve some changes and not have to start over every time you start SystemRescue.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466153633560">
<h2>Solution</h2>

<p>See <a data-type="xref" href="#rec-writable-partition">Recipe 19.13</a> to learn how to create a writable partition on your SystemRescue USB drive. Give this partition a filesystem label, such as <em>data</em>. Once this is set up, boot up SystemRescue, select your boot menu choice, press the Tab key, and append <strong><code>cow_label=<em>data</em></code></strong> to your boot selection
(<a data-type="xref" href="#fig-sysrec-9">Figure 19-8</a>).</p>

<figure><div id="fig-sysrec-9" class="figure">
<img src="Images/lcb2_1908.png" alt="Appending boot options." width="800" height="486"/>
<h6><span class="label">Figure 19-8. </span>Appending boot options</h6>
</div></figure>

<p>SystemRescue mounts both of your partitions in <em>/run/archiso/</em>:</p>
<pre># <strong>lsblk -p</strong>
lsblk
NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
[...]
sdc      8:32   1   3.7G  0 disk
├─sdc1   8:33   1     2G  0 part /run/archiso/bootmnt
└─sdc2   8:34   1   152G  0 part /run/archiso/cowspace
</pre>

<p>All changes you make to SystemRescue are stored in
<em>/run/archiso/cowspace/persistent_RESCUE800</em>, and the root filesystem
remains the same. <em>RESCUE800</em> is different for each SystemRescue release,
according to the release number.</p>

<p>You can configure SystemRescue just like any Linux: enable and
disable services, set a root password, change appearance, install new software, change network configurations, or write new documents.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466153623960">
<h2>Discussion</h2>

<p>Large USB drives are inexpensive, and needing only a single rescue device is
convenient. You can use either USB thumb drives or <a data-type="indexterm" data-primary="SystemRescue" data-secondary="preserving changes" data-startref="systemrescue-preserve" id="idm46466153619416"/><a data-type="indexterm" data-primary="preserving" data-secondary="SystemRescue changes" data-startref="preserve-systemrescue" id="idm46466153620584"/><a data-type="indexterm" data-primary="changing" data-secondary="SystemRescue, preserving changes" data-startref="change-systemrescue-preserve" id="idm46466153618216"/>USB hard drives.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466153616552">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://system-rescue.org"><em class="hyperlink">https://system-rescue.org</em></a></p>
</li>
</ul>
</div></section>





</div></section>







</div></section></div></body></html>