<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:epub="http://www.idpf.org/2007/ops" lang="en" xml:lang="en" xsi:schemaLocation="http://www.w3.org/2002/06/xhtml2/ http://www.w3.org/MarkUp/SCHEMA/xhtml2.xsd">
  <head>
    <title>Unknown</title>
    <link rel="stylesheet" type="text/css" href="../stylesheet.css"/>
    <link rel="stylesheet" type="text/css" href="../page_styles.css"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  </head>
  <body class="calibre"><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 17. Authentication, Authorization,  and Admission Control" class="praise"><div class="dedication" id="authentication_authorization_admission_control">
<h1 class="calibre14"><span class="keep-together">Chapter 17. </span>Authentication, Authorization, 
<span class="keep-together">and Admission Control</span></h1>


<p class="author1">The API server is the gateway to the Kubernetes cluster. Any human user, client (e.g., <code class="calibre15">kubectl</code>), cluster component, or service account will access the API server by making a RESTful API call via HTTPS. It is <em class="calibre3">the</em> central point for performing operations like creating a Pod or deleting a Service.</p>

<p class="author1">In this chapter, we’ll focus on the security-specific aspects relevant to the API server. For a detailed discussion on the inner workings of the API server and use of the Kubernetes API, refer to <a class="calibre10" href="https://learning.oreilly.com/library/view/managing-kubernetes/9781492033905"><em class="calibre3">Managing Kubernetes</em></a> by Brendan Burns and Craig Tracey (O’Reilly).</p>
<aside data-type="sidebar" epub:type="sidebar" class="calibre48"><div class="sidebar" id="id486">
<h1 class="calibre49">Coverage of Curriculum Objectives</h1>
<p class="author1">This chapter addresses the following curriculum objectives:</p>

<ul class="printings">
<li class="calibre13">
<p class="author1">Understand authentication, authorization, and admission control</p>
</li>
<li class="calibre13">
<p class="author1">Understand SecurityContext</p>
</li>
</ul>
</div></aside>






<section data-type="sect1" data-pdf-bookmark="Processing a Request" class="praise"><div class="dedication" id="processing-api-request">
<h1 class="calibre17">Processing a Request</h1>

<p class="author1"><a data-type="xref" href="#api_server_request_processing" class="calibre10">Figure 17-1</a> illustrates the stages a request goes through when a call is made to the API server. For reference, you can find more information in the <a href="https://kubernetes.io/docs/concepts/security/controlling-access/" class="calibre10">Kubernetes <span class="keep-together">documentation</span></a>.</p>

<figure class="calibre35"><div id="api_server_request_processing" class="figure">
<img src="Images/ckd2_1701.png" alt="ckd2 1701" class="calibre99"/>
<h6 class="calibre32"><span class="keep-together">Figure 17-1. </span>API server request processing</h6>
</div></figure>

<p class="author1">The first stage of request processing is <em class="calibre3">authentication</em>. Authentication validates the identity of the caller by inspecting the client certificates or bearer tokens. If the bearer token is associated with a service account, then it will be verified here.</p>

<p class="author1">The second stage determines if the identity provided in the first stage can access the verb and HTTP path request. Therefore, stage two deals with <em class="calibre3">authorization</em> of the request, which is implemented with the standard Kubernetes RBAC model. Here, we ensure that the service account is allowed to list Pods or create a new Service object if that has been requested.</p>

<p class="author1">The third stage of request processing deals with <em class="calibre3">admission control</em>. Admission control verifies if the request is well formed or potentially needs to be modified before the request is processed. An admission control policy could, for example, ensure that the request for creating a Pod includes the definition of a specific label. If the request doesn’t define the label, then it is rejected.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Authentication with kubectl" class="praise"><div class="dedication" id="authentication_with_kubectl">
<h1 class="calibre17">Authentication with kubectl</h1>

<p class="author1">Developers interact with the Kubernetes API by running the <code class="calibre15">kubectl</code> command line tool. Whenever you execute a command with <code class="calibre15">kubectl</code>, the underlying HTTPS call to the API server needs to authenticate.</p>








<section data-type="sect2" data-pdf-bookmark="The Kubeconfig" class="praise"><div class="dedication" id="id335">
<h2 class="calibre33">The Kubeconfig</h2>

<p class="author1">Credentials for the use of <code class="calibre15">kubectl</code> are stored in the file <em class="calibre3">$HOME/.kube/config</em>, also known as the <em class="calibre3">kubeconfig file</em>. The kubeconfig file defines the API server endpoints of the clusters we want to interact with, as well as a list of users registered with the cluster, including their credentials in the form of client certificates. The mapping between a cluster and user for a given namespace is called a <em class="calibre3">context</em>. <code class="calibre15">kubectl</code> uses the currently selected context to know which cluster to talk to and which credentials to use.</p>
<div data-type="note" epub:type="note" class="calibre26"><h6 class="calibre27">Note</h6>
<p class="author1">You can point the environment variable <code class="calibre15">KUBECONFIG</code> to a set of kubeconfig files. At runtime, <code class="calibre15">kubectl</code> will merge the contents of the set of defined kubeconfig files and use them. By default, <code class="calibre15">KUBECONFIG</code> is not set and falls back to <em class="calibre3">$HOME/.kube/config</em>.</p>
</div>

<p class="author1"><a data-type="xref" href="#kubeconfig" class="calibre10">Example 17-1</a> shows a kubeconfig file. Be aware that file paths assigned in the example are user-specific and may differ in your own environment. You can find a detailed description of all configurable attributes in the <a href="https://kubernetes.io/docs/reference/config-api/kubeconfig.v1/" class="calibre10">Config resource type</a> API documentation.</p>
<div id="kubeconfig" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 17-1. </span>A kubeconfig file</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Config</code><code class="w">
</code><code class="nt">clusters</code><code class="p">:</code><code class="w">                   </code><a class="calibre10" id="co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-1" href="#callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-1"><img src="Images/1.png" alt="1" class="calibre51"/></a><code class="w">
</code><code class="calibre15">-</code><code class="w"> </code><code class="nt">cluster</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">certificate-authority</code><code class="p">:</code><code class="w"> </code><code class="calibre15">/Users/bmuschko/.minikube/ca.crt</code><code class="w">
</code><code class="w">    </code><code class="nt">extensions</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">extension</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">last-update</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Mon,</code><code class="calibre15"> </code><code class="calibre15">09</code><code class="calibre15"> </code><code class="calibre15">Oct</code><code class="calibre15"> </code><code class="calibre15">2023</code><code class="calibre15"> </code><code class="calibre15">07:33:01</code><code class="calibre15"> </code><code class="calibre15">MDT</code><code class="w">
</code><code class="w">        </code><code class="nt">provider</code><code class="p">:</code><code class="w"> </code><code class="calibre15">minikube.sigs.k8s.io</code><code class="w">
</code><code class="w">        </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="calibre15">v1.30.1</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">cluster_info</code><code class="w">
</code><code class="w">    </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="calibre15">https://127.0.0.1:63709</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">minikube</code><code class="w">
</code><code class="nt">contexts</code><code class="p">:</code><code class="w">                   </code><a class="calibre10" id="co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-2" href="#callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-2"><img src="Images/2.png" alt="2" class="calibre51"/></a><code class="w">
</code><code class="calibre15">-</code><code class="w"> </code><code class="nt">context</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">cluster</code><code class="p">:</code><code class="w"> </code><code class="calibre15">minikube</code><code class="w">
</code><code class="w">    </code><code class="nt">user</code><code class="p">:</code><code class="w"> </code><code class="calibre15">bmuschko</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">bmuschko</code><code class="w">
</code><code class="calibre15">-</code><code class="w"> </code><code class="nt">context</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">cluster</code><code class="p">:</code><code class="w"> </code><code class="calibre15">minikube</code><code class="w">
</code><code class="w">    </code><code class="nt">extensions</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">extension</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">last-update</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Mon,</code><code class="calibre15"> </code><code class="calibre15">09</code><code class="calibre15"> </code><code class="calibre15">Oct</code><code class="calibre15"> </code><code class="calibre15">2023</code><code class="calibre15"> </code><code class="calibre15">07:33:01</code><code class="calibre15"> </code><code class="calibre15">MDT</code><code class="w">
</code><code class="w">        </code><code class="nt">provider</code><code class="p">:</code><code class="w"> </code><code class="calibre15">minikube.sigs.k8s.io</code><code class="w">
</code><code class="w">        </code><code class="nt">version</code><code class="p">:</code><code class="w"> </code><code class="calibre15">v1.30.1</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">context_info</code><code class="w">
</code><code class="w">    </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="calibre15">default</code><code class="w">
</code><code class="w">    </code><code class="nt">user</code><code class="p">:</code><code class="w"> </code><code class="calibre15">minikube</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">minikube</code><code class="w">
</code><code class="nt">current-context</code><code class="p">:</code><code class="w"> </code><code class="calibre15">minikube</code><code class="w">   </code><a class="calibre10" id="co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-3" href="#callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-3"><img src="Images/3.png" alt="3" class="calibre51"/></a><code class="w">
</code><code class="nt">preferences</code><code class="p">:</code><code class="w"> </code><code class="calibre15">{</code><code class="calibre15">}</code><code class="w">
</code><code class="nt">users</code><code class="p">:</code><code class="w">                      </code><a class="calibre10" id="co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-4" href="#callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-4"><img src="Images/4.png" alt="4" class="calibre51"/></a><code class="w">
</code><code class="calibre15">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">bmuschko</code><code class="w">
</code><code class="w">  </code><code class="nt">user</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">client-key-data</code><code class="p">:</code><code class="w"> </code><code class="calibre15">&lt;REDACTED&gt;</code><code class="w">
</code><code class="calibre15">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">minikube</code><code class="w">
</code><code class="w">  </code><code class="nt">user</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">client-certificate</code><code class="p">:</code><code class="w"> </code><code class="calibre15">/Users/bmuschko/.minikube/profiles/minikube/client.crt</code><code class="w">
</code><code class="w">    </code><code class="nt">client-key</code><code class="p">:</code><code class="w"> </code><code class="calibre15">/Users/bmuschko/.minikube/profiles/minikube/client.key</code></pre></div>
<dl class="calibre18">
<dt class="calibre52"><a class="calibre10" id="callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-1" href="#co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-1"><img src="Images/1.png" alt="1" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">A list of referential names to clusters and their API server endpoints.</p></dd>
<dt class="calibre52"><a class="calibre10" id="callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-2" href="#co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-2"><img src="Images/2.png" alt="2" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">A list of referential names to contexts (a combination of cluster and user).</p></dd>
<dt class="calibre52"><a class="calibre10" id="callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-3" href="#co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-3"><img src="Images/3.png" alt="3" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">The currently selected context.</p></dd>
<dt class="calibre52"><a class="calibre10" id="callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-4" href="#co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO1-4"><img src="Images/4.png" alt="4" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">A list of referential names to users and their credentials.</p></dd>
</dl>

<p class="author1">User management is handled by the cluster administrator. The administrator creates a user representing the developer and hands the relevant information (username and credentials) to the human wanting to interact with the cluster via <code class="calibre15">kubectl</code>. Alternatively, it is also possible to integrate with external identity providers for authentication purposes, e.g., via <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens" class="calibre10">OpenID Connect</a>.</p>

<p class="author1">Creating a new user manually consists of multiple steps, as described in the <a href="https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#normal-user" class="calibre10">Kubernetes documentation</a>. The developer would then add the user to the kubeconfig file on the machine intended to interact with the cluster.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Managing Kubeconfig Using kubectl" class="praise"><div class="dedication" id="id336">
<h2 class="calibre33">Managing Kubeconfig Using kubectl</h2>

<p class="author1">You do not have to manually edit the kubeconfig file(s) to change or add configuration. <code class="calibre15">Kubectl</code> provides commands for reading and modifying its contents. The following commands provide an overview. You can find additional examples for commands in the <a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/#kubectl-context-and-configuration" class="calibre10">kubectl cheatsheet</a>.</p>

<p class="author1">To view the merged contents of the kubeconfig file(s), run the following command:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl config view</strong>
apiVersion: v1
kind: Config
clusters:
...
</pre>

<p class="author1">To render the currently selected context, use the <code class="calibre15">current-context</code> subcommand. The context named <code class="calibre15">minikube</code> is the active one:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl config current-context</strong>
minikube
</pre>

<p class="author1">To change the context, provide the name with the <code class="calibre15">use-context</code> subcommand. Here, we are switching to the context <code class="calibre15">bmuschko</code>:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl config use-context bmuschko</strong>
Switched to context "bmuschko".
</pre>

<p class="author1">To register a user with the kubeconfig file(s), use the <code class="calibre15">set-credentials</code> subcommand. We are choosing to assign the username <code class="calibre15">myuser</code> and point to the client certificate by providing the corresponding CLI flags:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl config set-credentials myuser \
  --client-key=myuser.key --client-certificate=myuser.crt \
  --embed-certs=true</strong>
</pre>

<p class="author1">For the exam, familiarize yourself with the <code class="calibre15">kubectl config</code> command. Every task in the exam will require you to work with a specific context and/or namespace.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Authorization with Role-Based Access Control" class="praise"><div class="dedication" id="id337">
<h1 class="calibre17">Authorization with Role-Based Access Control</h1>

<p class="author1">We’ve learned that the API server will try to authenticate any request sent using <code class="calibre15">kubectl</code> by verifying the provided credentials. An authenticated request will then need be checked against the permissions assigned to the requestor. The authorization phase of the API processing workflow checks if the operation is permitted against the requested API resource.</p>

<p class="author1">In Kubernetes, those permissions can be controlled using Role-Based Access Control (RBAC). In a nutshell, RBAC defines policies for users, groups, and service accounts by allowing or disallowing access to manage API resources. Enabling and configuring RBAC is mandatory for any organization with a strong emphasis on security.</p>

<p class="author1">Setting permissions is the responsibility of a cluster administrator. In the following sections, we’ll briefly talk about the effects of RBAC on requests from users and service accounts.</p>








<section data-type="sect2" data-pdf-bookmark="RBAC Overview" class="praise"><div class="dedication" id="id338">
<h2 class="calibre33">RBAC Overview</h2>

<p class="author1">RBAC helps with implementing a variety of use cases:</p>

<ul class="printings">
<li class="calibre13">
<p class="author1">Establishing a system for users with different roles to access a set of Kubernetes resources</p>
</li>
<li class="calibre13">
<p class="author1">Controlling processes (associated with a service account) running in a Pod and performing operations against the Kubernetes API</p>
</li>
<li class="calibre13">
<p class="author1">Limiting the visibility of certain resources per namespace</p>
</li>
</ul>

<p class="author1">RBAC consists of three key building blocks, as shown in <a data-type="xref" href="#rbac_key_building_blocks" class="calibre10">Figure 17-2</a>. Together, they connect API primitives and their allowed operations to the so-called subject, which is a user, a group, or a service account.</p>

<figure class="calibre35"><div id="rbac_key_building_blocks" class="figure">
<img src="Images/ckd2_1702.png" alt="ckd2 1702" class="calibre100"/>
<h6 class="calibre32"><span class="keep-together">Figure 17-2. </span>RBAC key building blocks</h6>
</div></figure>

<p class="author1">Each block’s responsibilities are as follows:</p>
<dl class="calibre18">
<dt class="calibre19">Subject</dt>
<dd class="calibre20">
<p class="calibre21">The user or service account that wants to access a resource</p>
</dd>
<dt class="calibre19">Resource</dt>
<dd class="calibre20">
<p class="calibre21">The Kubernetes API resource type (e.g., a Deployment or node)</p>
</dd>
<dt class="calibre19">Verb</dt>
<dd class="calibre20">
<p class="calibre21">The operation that can be executed on the resource (e.g., creating a Pod or deleting a Service)</p>
</dd>
</dl>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Understanding RBAC API Primitives" class="praise"><div class="dedication" id="id339">
<h2 class="calibre33">Understanding RBAC API Primitives</h2>

<p class="author1">With these key concepts in mind, let’s look at the Kubernetes API primitives that implement the RBAC functionality:</p>
<dl class="calibre18">
<dt class="calibre19">Role</dt>
<dd class="calibre20">
<p class="calibre21">The Role API primitive declares the API resources and their operations this rule should operate on in a specific namespace. For example, you may want to say “allow listing and deleting of Pods,” or you may express “allow watching the logs of Pods,” or even both with the same Role. Any operation that is not spelled out explicitly is disallowed as soon as it is bound to the subject.</p>
</dd>
<dt class="calibre19">RoleBinding</dt>
<dd class="calibre20">
<p class="calibre21">The RoleBinding API primitive <em class="calibre3">binds</em> the Role object to the subject(s) in a specific namespace. It is the glue for making the rules active. For example, you may want to say “bind the Role that permits updating Services to the user John Doe.”</p>
</dd>
</dl>

<p class="author1"><a data-type="xref" href="#rbac_primitives" class="calibre10">Figure 17-3</a> shows the relationship between the involved API primitives. Keep in mind that the image renders only a selected list of API resource types and operations.</p>

<figure class="calibre35"><div id="rbac_primitives" class="figure">
<img src="Images/ckd2_1703.png" alt="ckd2 1703" class="calibre101"/>
<h6 class="calibre32"><span class="keep-together">Figure 17-3. </span>RBAC primitives</h6>
</div></figure>

<p class="author1">The following sections demonstrate the namespace-wide usage of Roles and RoleBindings, but the same operations and attributes apply to cluster-wide Roles and RoleBindings, discussed in <a data-type="xref" href="#cluster-wide-rbac" class="calibre10">“Namespace-Wide and Cluster-Wide RBAC”</a>.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Default User-Facing Roles" class="praise"><div class="dedication" id="id340">
<h2 class="calibre33">Default User-Facing Roles</h2>

<p class="author1">Kubernetes defines a set of default Roles. You can assign them to a subject via a RoleBinding or define your own, custom Roles depending on your needs. <a data-type="xref" href="#default_user_facing_roles" class="calibre10">Table 17-1</a> describes the default user-facing Roles.</p>
<table id="default_user_facing_roles" class="calibre58">
<caption class="calibre59"><span class="keep-together">Table 17-1. </span>Default user-facing Roles</caption>
<thead class="calibre61">
<tr class="calibre62">
<th class="calibre63">Default ClusterRole</th>
<th class="calibre63">Description</th>
</tr>
</thead>
<tbody class="calibre64">
<tr class="calibre62">
<td class="calibre65"><p class="author1">cluster-admin</p></td>
<td class="calibre65"><p class="author1">Allows read and write access to resources across all namespaces.</p></td>
</tr>
<tr class="calibre66">
<td class="calibre65"><p class="author1">admin</p></td>
<td class="calibre65"><p class="author1">Allows read and write access to resources in namespace including Roles and RoleBindings.</p></td>
</tr>
<tr class="calibre62">
<td class="calibre65"><p class="author1">edit</p></td>
<td class="calibre65"><p class="author1">Allows read and write access to resources in namespace except Roles and RoleBindings. Provides access to Secrets.</p></td>
</tr>
<tr class="calibre66">
<td class="calibre65"><p class="author1">view</p></td>
<td class="calibre65"><p class="author1">Allows read-only access to resources in namespace except Roles, RoleBindings, and Secrets.</p></td>
</tr>
</tbody>
</table>

<p class="author1">To define new Roles and RoleBindings, you will have to use a context that allows for creating or modifying them, that is, cluster-admin or admin.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Creating Roles" class="praise"><div class="dedication" id="id341">
<h2 class="calibre33">Creating Roles</h2>

<p class="author1">Roles can be created imperatively with the <code class="calibre15">create role</code> command. The most important options for the command are <code class="calibre15">--verb</code> for defining the verbs, aka operations, and <code class="calibre15">--resource</code> for declaring a list of API resources (core primitives as well as CRDs). The following command creates a new Role for the resources Pod, Deployment, and Service with the verbs <code class="calibre15">list</code>, <code class="calibre15">get</code>, and <code class="calibre15">watch</code>:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl create role read-only --verb=list,get,watch \
  --resource=pods,deployments,services</strong>
role.rbac.authorization.k8s.io/read-only created
</pre>

<p class="author1">Declaring multiple verbs and resources for a single imperative <code class="calibre15">create role</code> command can be declared as a comma-separated list for the corresponding command-line option or as multiple arguments. For example, <code class="calibre15">--verb=list,get,watch</code> and 
<span class="keep-together"><code class="calibre15">--verb=list --verb=get --verb=watch</code></span> carry the same instructions. You also can use the wildcard “*” to refer to all verbs or resources.</p>

<p class="author1">The command-line option <code class="calibre15">--resource-name</code> spells out one or many object names that the policy rules should apply to. A name of a Pod could be <code class="calibre15">nginx</code> and listed here with its name. Providing a list of resource names is optional. If no names have been provided, then the provided rules apply to all objects of a resource type.</p>

<p class="author1">The declarative approach can become a little lengthy. As you can see in <a data-type="xref" href="#a_yaml_manifest_defining_a_role" class="calibre10">Example 17-2</a>, the section <code class="calibre15">rules</code> lists the resources and verbs. Resources with an API group, like Deployments that use the API version <code class="calibre15">apps/v1</code>, need to explicitly declare it under the attribute <code class="calibre15">apiGroups</code>. All other resources (e.g., Pods and Services), simply use an empty string, as their API version doesn’t contain a group. Be aware that the imperative command for creating a Role automatically determines the API group.</p>
<div id="a_yaml_manifest_defining_a_role" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 17-2. </span>A YAML manifest defining a Role</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">rbac.authorization.k8s.io/v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Role</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">read-only</code><code class="w">
</code><code class="nt">rules</code><code class="p">:</code><code class="w">
</code><code class="calibre15">-</code><code class="w"> </code><code class="nt">apiGroups</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="s">"</code><code class="s">"</code><code class="w">
</code><code class="w">  </code><code class="nt">resources</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="calibre15">pods</code><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="calibre15">services</code><code class="w">
</code><code class="w">  </code><code class="nt">verbs</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="calibre15">list</code><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="calibre15">get</code><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="calibre15">watch</code><code class="w">
</code><code class="calibre15">-</code><code class="w"> </code><code class="nt">apiGroups</code><code class="p">:</code><code class="w">      </code><a class="calibre10" id="co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO2-1" href="#callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO2-1"><img src="Images/1.png" alt="1" class="calibre51"/></a><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="calibre15">apps</code><code class="w">
</code><code class="w">  </code><code class="nt">resources</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="calibre15">deployments</code><code class="w">
</code><code class="w">  </code><code class="nt">verbs</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="calibre15">list</code><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="calibre15">get</code><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="calibre15">watch</code></pre></div>
<dl class="calibre18">
<dt class="calibre52"><a class="calibre10" id="callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO2-1" href="#co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO2-1"><img src="Images/1.png" alt="1" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">Any resource that belongs to an API group need to be listed as an explicit rule in addition to the API resources that do not belong to an API group.</p></dd>
</dl>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Listing Roles" class="praise"><div class="dedication" id="id342">
<h2 class="calibre33">Listing Roles</h2>

<p class="author1">Once the Role has been created, its object can be listed. The list of Roles renders only the name and the creation timestamp. Each of the listed roles does not give away any of its details:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl get roles</strong>
NAME        CREATED AT
read-only   2021-06-23T19:46:48Z
</pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Rendering Role Details" class="praise"><div class="dedication" id="id343">
<h2 class="calibre33">Rendering Role Details</h2>

<p class="author1">You can inspect the details of a Role using the <code class="calibre15">describe</code> command. The output renders a table that maps a resource to its permitted verbs:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl describe role read-only</strong>
Name:         read-only
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
PolicyRule:
  Resources         Non-Resource URLs  Resource Names  Verbs
  ---------         -----------------  --------------  -----
  pods              []                 []              [list get watch]
  services          []                 []              [list get watch]
  deployments.apps  []                 []              [list get watch]
</pre>

<p class="author1">This cluster has no resources created, so the list of resource names in the following console output is currently empty.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Creating RoleBindings" class="praise"><div class="dedication" id="id344">
<h2 class="calibre33">Creating RoleBindings</h2>

<p class="author1">The imperative command creating a RoleBinding object is <code class="calibre15">create rolebinding</code>. To bind a Role to the RoleBinding, use the <code class="calibre15">--role</code> command-line option. The subject type can be assigned by declaring the options <code class="calibre15">--user</code>, <code class="calibre15">--group</code>, or <code class="calibre15">--serviceaccount</code>. The following command creates the RoleBinding with the name <code class="calibre15">read-only-binding</code> to the user called <code class="calibre15">bmuschko</code>:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl create rolebinding read-only-binding --role=read-only --user=bmuschko</strong>
rolebinding.rbac.authorization.k8s.io/read-only-binding created
</pre>

<p class="author1"><a data-type="xref" href="#a_yaml_manifest_defining_a_rolebinding" class="calibre10">Example 17-3</a> shows a YAML manifest representing the RoleBinding. You can see from the structure that a role can be mapped to one or many subjects. The data type is an array indicated by the dash character under the attribute <code class="calibre15">subjects</code>. At this time, only the user <code class="calibre15">bmuschko</code> has been assigned.</p>
<div id="a_yaml_manifest_defining_a_rolebinding" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 17-3. </span>A YAML manifest defining a RoleBinding</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">rbac.authorization.k8s.io/v1</code><code class="w"></code>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">RoleBinding</code><code class="w"></code>
<code class="nt">metadata</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">read-only-binding</code><code class="w"></code>
<code class="nt">roleRef</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">apiGroup</code><code class="p">:</code><code class="w"> </code><code class="calibre15">rbac.authorization.k8s.io</code><code class="w"></code>
<code class="w">  </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Role</code><code class="w"></code>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">read-only</code><code class="w"></code>
<code class="nt">subjects</code><code class="p">:</code><code class="w"></code>
<code class="calibre15">-</code><code class="w"> </code><code class="nt">apiGroup</code><code class="p">:</code><code class="w"> </code><code class="calibre15">rbac.authorization.k8s.io</code><code class="w"></code>
<code class="w">  </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">User</code><code class="w"></code>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">bmuschko</code><code class="w"></code></pre></div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Listing RoleBindings" class="praise"><div class="dedication" id="id345">
<h2 class="calibre33">Listing RoleBindings</h2>

<p class="author1">The most important information the list of RoleBindings displays is the associated Role. The following command shows that the RoleBinding <code class="calibre15">read-only-binding</code> has been mapped to the Role <code class="calibre15">read-only</code>:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl get rolebindings</strong>
NAME                ROLE             AGE
read-only-binding   Role/read-only   24h
</pre>

<p class="author1">The output does not provide an indication of the subjects. You will need to render the details of the object for more information, as described in the next section.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Rendering RoleBinding Details" class="praise"><div class="dedication" id="id346">
<h2 class="calibre33">Rendering RoleBinding Details</h2>

<p class="author1">RoleBindings can be inspected using the <code class="calibre15">describe</code> command. The output renders a table of subjects and the assigned role. The following example renders the descriptive representation of the RoleBinding named <code class="calibre15">read-only-binding</code>:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl describe rolebinding read-only-binding</strong>
Name:         read-only-binding
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Role:
  Kind:  Role
  Name:  read-only
Subjects:
  Kind  Name      Namespace
  ----  ----      ---------
  User  bmuschko
</pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Seeing the RBAC Rules in Effect" class="praise"><div class="dedication" id="id347">
<h2 class="calibre33">Seeing the RBAC Rules in Effect</h2>

<p class="author1">Let’s see how Kubernetes enforces the RBAC rules for the scenario we set up so far. First, we’ll create a new Deployment with the <code class="calibre15">cluster-admin</code> permissions. In Minikube, those permissions are available to the context <code class="calibre15">minikube</code> by default:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl config current-context</strong>
minikube
<strong class="calibre38">$ kubectl create deployment myapp --image=:1.25.2 --port=80 --replicas=2</strong>
deployment.apps/myapp created
</pre>

<p class="author1">Now, we’ll switch the context for the user <code class="calibre15">bmuschko</code>:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl config use-context bmuschko-context</strong>
Switched to context "bmuschko-context".
</pre>

<p class="author1">Remember that the user <code class="calibre15">bmuschko</code> is permitted to list Deployments. We’ll verify that by using the <code class="calibre15">get deployments</code> command:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl get deployments</strong>
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
myapp   2/2     2            2           8s
</pre>

<p class="author1">The RBAC rules allow listing Deployments, Pods, and Services only. The following command tries to list the ReplicaSets, which results in an error:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl get replicasets</strong>
Error from server (Forbidden): replicasets.apps is forbidden: User "bmuschko" \
cannot list resource "replicasets" in API group "apps" in the namespace "default"
</pre>

<p class="author1">A similar behavior can be observed when trying to use verbs other than <code class="calibre15">list</code>, <code class="calibre15">get</code>, or <code class="calibre15">watch</code>. The following command tries to delete a Deployment:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl delete deployment myapp</strong>
Error from server (Forbidden): deployments.apps "myapp" is forbidden: User \
"bmuschko" cannot delete resource "deployments" in API group "apps" in the \
namespace "default"
</pre>

<p class="author1">At any given time, you can check a user’s permissions with the <code class="calibre15">auth can-i</code> command. The command gives you the option to list all permissions or check a specific permission:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl auth can-i --list --as bmuschko</strong>
Resources          Non-Resource URLs   Resource Names   Verbs
...
pods               []                  []               [list get watch]
services           []                  []               [list get watch]
deployments.apps   []                  []               [list get watch]
<strong class="calibre38">$ kubectl auth can-i list pods --as bmuschko</strong>
yes
</pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Namespace-Wide and Cluster-Wide RBAC" class="praise"><div class="dedication" id="cluster-wide-rbac">
<h2 class="calibre33">Namespace-Wide and Cluster-Wide RBAC</h2>

<p class="author1">Roles and RoleBindings apply to a particular namespace. You will have to specify the namespace when creating both objects. Sometimes, a set of Roles and RoleBindings needs to apply to multiple namespaces or even to the whole cluster. For a cluster-wide definition, Kubernetes offers the API resource types ClusterRole and ClusterRoleBinding. The configuration elements are effectively the same. The only difference is the value of the <code class="calibre15">kind</code> attribute:</p>

<ul class="printings">
<li class="calibre13">
<p class="author1">To define a cluster-wide Role, use the imperative subcommand <code class="calibre15">clusterrole</code> or the kind <code class="calibre15">ClusterRole</code> in the YAML manifest.</p>
</li>
<li class="calibre13">
<p class="author1">To define a cluster-wide RoleBinding, use the imperative subcommand <code class="calibre15">clusterrolebinding</code> or the kind <code class="calibre15">ClusterRoleBinding</code> in the YAML manifest.</p>
</li>
</ul>

<p class="author1">ClusterRoles and ClusterRoleBindings not only set up cluster-wide permissions to a namespaced resource, but they can also be used to set up permissions for non-namespaced resources like CRDs and nodes.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Working with Service Accounts" class="praise"><div class="dedication" id="id349">
<h1 class="calibre17">Working with Service Accounts</h1>

<p class="author1">We’ve been using the <code class="calibre15">kubectl</code> executable to run operations against a Kubernetes cluster. Under the hood, its implementation calls the API server by making an HTTP call to the exposed endpoints. Some applications running inside of a Pod may have to communicate with the API server as well. For example, the application may ask for specific cluster node information or available namespaces.</p>

<p class="author1">Pods can use a service account to authenticate with the API server through an authentication token. A Kubernetes administrator assigns rules to a service account via RBAC to authorize access to specific resources and actions as illustrated in <a data-type="xref" href="#service_account" class="calibre10">Figure 17-4</a>.</p>

<figure class="calibre35"><div id="service_account" class="figure">
<img src="Images/ckd2_1704.png" alt="ckd2 1704" class="calibre102"/>
<h6 class="calibre32"><span class="keep-together">Figure 17-4. </span>Using a service account to communicate with an API server</h6>
</div></figure>

<p class="author1">A Pod doesn’t necessarily need to be involved in the process. Other use cases call for leveraging a service account outside of a Kubernetes cluster. For example, you may want to communicate with the API server as part of CI/CD pipeline automation step. The service account can provide the credentials to authenticate with the API server.</p>








<section data-type="sect2" data-pdf-bookmark="The Default Service Account" class="praise"><div class="dedication" id="id350">
<h2 class="calibre33">The Default Service Account</h2>

<p class="author1">So far, we haven’t defined a service account for a Pod. If not assigned explicitly, a Pod uses the <a href="https://kubernetes.io/docs/concepts/security/service-accounts/#default-service-accounts" class="calibre10"><code class="calibre15">default</code> service account</a>, which has the same permissions as an unauthenticated user. This means that the Pod cannot view or modify the cluster state or list or modify any of its resources. The <code class="calibre15">default</code> service account can however request basic cluster information via the assigned <code class="calibre15">system:discovery</code> Role.</p>

<p class="author1">You can query for the available service accounts with the subcommand <code class="calibre15">serviceaccounts</code>. You should see only the <code class="calibre15">default</code> service account listed in the output:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl get serviceaccounts</strong>
NAME      SECRETS   AGE
default   0         4d
</pre>

<p class="author1">While you can execute the <code class="calibre15">kubectl</code> operation to delete the <code class="calibre15">default</code> service account, Kubernetes will reinstantiate the service account immediately.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Creating a Service Account" class="praise"><div class="dedication" id="id351">
<h2 class="calibre33">Creating a Service Account</h2>

<p class="author1">You can create a custom service account object using the imperative and declarative approach. This command creates a service account object with the name <code class="calibre15">cicd-bot</code>. The assumption here is to use the service account for calls to the API server made by a CI/CD pipeline:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl create serviceaccount cicd-bot</strong>
serviceaccount/cicd-bot created
</pre>

<p class="author1">You can also represent the service account in the form of a manifest. In its simplest form, the definition assigns the kind <code class="calibre15">ServiceAccount</code> and a name, as shown in <a data-type="xref" href="#service-account-pod-setup" class="calibre10">Example 17-4</a>.</p>
<div id="service-account-pod-setup" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 17-4. </span>YAML manifest for a service account</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">v1</code><code class="w"></code>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">ServiceAccount</code><code class="w"></code>
<code class="nt">metadata</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">cicd-bot</code><code class="w"></code></pre></div>

<p class="author1">You can set a couple of <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/" class="calibre10">configuration options</a> for a service account. For example, you may want to disable automounting of the authentication token when assigning the service account to a Pod. Although you will not need to understand those configuration options for the exam, it makes sense to dive deeper into security best practices by reading up on them in the Kubernetes documentation.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Setting Permissions for a Service Account" class="praise"><div class="dedication" id="id352">
<h2 class="calibre33">Setting Permissions for a Service Account</h2>

<p class="author1">It’s important to limit the permissions to only the service accounts that are necessary for the application to function. The next sections will explain how to achieve this to minimize the potential attack surface.</p>

<p class="author1">For this scenario to work, you’ll need to create a ServiceAccount object and assign it to the Pod. Service accounts can be tied in with RBAC and assigned a Role and RoleBinding to define which operations they should be allowed to perform.</p>










<section data-type="sect3" data-pdf-bookmark="Binding the service account to a Pod" class="praise"><div class="dedication" id="id353">
<h3 class="calibre44">Binding the service account to a Pod</h3>

<p class="author1">As a starting point, we will set up a Pod that lists all Pods and Deployments in the namespace <code class="calibre15">k97</code> by calling the Kubernetes API. The call is made as part of an infinite loop every ten seconds. The response from the API call will be written to standard output accessible via the Pod’s logs.</p>
<div data-type="tip" class="calibre26"><h1 class="calibre34">Accessing the API server endpoint</h1>
<p class="author1">Accessing the Kubernetes API from a Pod is straightforward. Instead of using the IP address and port for the API server Pod, you can simply refer to a Service named <code class="calibre15">kubernetes.default.svc</code> instead. This special Service lives in the <code class="calibre15">default</code> namespace and is stood up by the cluster automatically.</p>
</div>

<p class="author1">To authenticate against the API server, we’ll send a bearer token associated with the service account used by the Pod. The default behavior of a service account is to auto-mount API credentials on the path <em class="calibre3">/var/run/secrets/kubernetes.io/serviceaccount/token</em>. We’ll simply get the contents of the file using the <code class="calibre15">cat</code> command-line tool and send them along as a header for the HTTP request. <a data-type="xref" href="#service-account-pod-setup2" class="calibre10">Example 17-5</a> defines the namespace, the service account, and the Pod in a single YAML manifest file: <em class="calibre3">setup.yaml</em>.</p>
<div id="service-account-pod-setup2" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 17-5. </span>YAML manifest for assigning a service account to a Pod</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Namespace</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">k97</code><code class="w">
</code><code class="nn">---</code><code class="w">
</code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">ServiceAccount</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">sa-api</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="calibre15">k97</code><code class="w">
</code><code class="nn">---</code><code class="w">
</code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Pod</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">list-objects</code><code class="w">
</code><code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="calibre15">k97</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">serviceAccountName</code><code class="p">:</code><code class="w"> </code><code class="calibre15">sa-api</code><code class="w">   </code><a class="calibre10" id="co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-1" href="#callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-1"><img src="Images/1.png" alt="1" class="calibre51"/></a><code class="w">
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">pods</code><code class="w">
</code><code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="calibre15">alpine/curl:3.14</code><code class="w">
</code><code class="w">    </code><code class="nt">command</code><code class="p">:</code><code class="w"> </code><code class="calibre15">[</code><code class="s">'</code><code class="s">sh</code><code class="s">'</code><code class="calibre15">,</code><code class="w"> </code><code class="s">'</code><code class="s">-c</code><code class="s">'</code><code class="calibre15">,</code><code class="w"> </code><code class="s">'</code><code class="s">while</code><code class="nv"> </code><code class="s">true;</code><code class="nv"> </code><code class="s">do</code><code class="nv"> </code><code class="s">curl</code><code class="nv"> </code><code class="s">-s</code><code class="nv"> </code><code class="s">-k</code><code class="nv"> </code><code class="s">-m</code><code class="nv"> </code><code class="s">5</code><code class="nv"> </code><code class="s">-H</code><code class="nv"> </code><code class="s">\</code><code class="w">
</code><code class="w">              </code><code class="s">"Authorization:</code><code class="nv"> </code><code class="s">Bearer</code><code class="nv"> </code><code class="s">$(cat</code><code class="nv"> </code><code class="s">/var/run/secrets/kubernetes.io/</code><code class="nv"> </code><code class="s">\</code><code class="w">
</code><code class="w">              </code><code class="s">serviceaccount/token)"</code><code class="nv"> </code><code class="s">https://kubernetes.default.svc.cluster.</code><code class="nv"> </code><code class="s">\</code><code class="w">
</code><code class="w">              </code><code class="s">local/api/v1/namespaces/k97/pods;</code><code class="nv"> </code><code class="s">sleep</code><code class="nv"> </code><code class="s">10;</code><code class="nv"> </code><code class="s">done</code><code class="s">'</code><code class="calibre15">]</code><code class="w">   </code><a class="calibre10" id="co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-2" href="#callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-2"><img src="Images/2.png" alt="2" class="calibre51"/></a><code class="w">
</code><code class="w">  </code><code class="calibre15">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">deployments</code><code class="w">
</code><code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="calibre15">alpine/curl:3.14</code><code class="w">
</code><code class="w">    </code><code class="nt">command</code><code class="p">:</code><code class="w"> </code><code class="calibre15">[</code><code class="s">'</code><code class="s">sh</code><code class="s">'</code><code class="calibre15">,</code><code class="w"> </code><code class="s">'</code><code class="s">-c</code><code class="s">'</code><code class="calibre15">,</code><code class="w"> </code><code class="s">'</code><code class="s">while</code><code class="nv"> </code><code class="s">true;</code><code class="nv"> </code><code class="s">do</code><code class="nv"> </code><code class="s">curl</code><code class="nv"> </code><code class="s">-s</code><code class="nv"> </code><code class="s">-k</code><code class="nv"> </code><code class="s">-m</code><code class="nv"> </code><code class="s">5</code><code class="nv"> </code><code class="s">-H</code><code class="nv"> </code><code class="s">\</code><code class="w">
</code><code class="w">              </code><code class="s">"Authorization:</code><code class="nv"> </code><code class="s">Bearer</code><code class="nv"> </code><code class="s">$(cat</code><code class="nv"> </code><code class="s">/var/run/secrets/kubernetes.io/</code><code class="nv"> </code><code class="s">\</code><code class="w">
</code><code class="w">              </code><code class="s">serviceaccount/token)"</code><code class="nv"> </code><code class="s">https://kubernetes.default.svc.cluster.</code><code class="nv"> </code><code class="s">\</code><code class="w">
</code><code class="w">              </code><code class="s">local/apis/apps/v1/namespaces/k97/deployments;</code><code class="w">
</code><code class="w">              </code><code class="s">sleep</code><code class="nv"> </code><code class="s">10;</code><code class="nv"> </code><code class="s">done</code><code class="s">'</code><code class="calibre15">]</code><code class="w">                                     </code><a class="calibre10" id="co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-3" href="#callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-3"><img src="Images/3.png" alt="3" class="calibre51"/></a></pre></div>
<dl class="calibre18">
<dt class="calibre52"><a class="calibre10" id="callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-1" href="#co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-1"><img src="Images/1.png" alt="1" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">The service account referenced by name used for communicating with the Kubernetes API.</p></dd>
<dt class="calibre52"><a class="calibre10" id="callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-2" href="#co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-2"><img src="Images/2.png" alt="2" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">Performs an API call to retrieve the list of Pods in the namespace <code class="calibre15">k97</code>.</p></dd>
<dt class="calibre52"><a class="calibre10" id="callout_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-3" href="#co_authentication__authorization____span_class__keep_together__and_admission_control__span__CO3-3"><img src="Images/3.png" alt="3" class="calibre51"/></a></dt>
<dd class="calibre20"><p class="calibre53">Performs an API call to retrieve the list of Deployments in the namespace <code class="calibre15">k97</code>.</p></dd>
</dl>

<p class="author1">Create the objects from the YAML manifest with the following command:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl apply -f setup.yaml</strong>
namespace/k97 created
serviceaccount/sa-api created
pod/list-objects created
</pre>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Verifying the default permissions" class="praise"><div class="dedication" id="id354">
<h3 class="calibre44">Verifying the default permissions</h3>

<p class="author1">The Pod named <code class="calibre15">list-objects</code> makes a call to the API server to retrieve the list of Pods and Deployments in dedicated containers. The container <code class="calibre15">pods</code> performs the call to list Pods. The container <code class="calibre15">deployments</code> sends a request to the API server to list Deployments.</p>

<p class="author1">As explained in the <a href="https://oreil.ly/gBp30" class="calibre10">Kubernetes documentation</a>, the default RBAC policies do not grant any permissions to service accounts outside of the <code class="calibre15">kube-system</code> namespace. The logs of the containers <code class="calibre15">pods</code> and <code class="calibre15">deployments</code> return an error message indicating that the service account <code class="calibre15">sa-api</code> is not authorized to list the resources:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl logs list-objects -c pods -n k97</strong>
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "pods is forbidden: User \"system:serviceaccount:k97:sa-api\" \
              cannot list resource \"pods\" in API group \"\" in the \
              namespace \"k97\"",
  "reason": "Forbidden",
  "details": {
    "kind": "pods"
  },
  "code": 403
}
<strong class="calibre38">$ kubectl logs list-objects -c deployments -n k97</strong>
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "deployments.apps is forbidden: User \
              \"system:serviceaccount:k97:sa-api\" cannot list resource \
              \"deployments\" in API group \"apps\" in the namespace \
              \"k97\"",
  "reason": "Forbidden",
  "details": {
    "group": "apps",
    "kind": "deployments"
  },
  "code": 403
}
</pre>

<p class="author1">Next up, we’ll stand up a Role and RoleBinding object with the required API permissions to perform the necessary calls.</p>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Creating the Role" class="praise"><div class="dedication" id="id355">
<h3 class="calibre44">Creating the Role</h3>

<p class="author1">Start by defining the Role named <code class="calibre15">list-pods-role</code> shown in <a data-type="xref" href="#list-pods-role" class="calibre10">Example 17-6</a> in the file <code class="calibre15">role.yaml</code>. The set of the rules adds only the Pod resource and the verb <code class="calibre15">list</code>.</p>
<div id="list-pods-role" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 17-6. </span>YAML manifest for a Role that allows listing Pods</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">rbac.authorization.k8s.io/v1</code><code class="w"></code>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Role</code><code class="w"></code>
<code class="nt">metadata</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">list-pods-role</code><code class="w"></code>
<code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="calibre15">k97</code><code class="w"></code>
<code class="nt">rules</code><code class="p">:</code><code class="w"></code>
<code class="calibre15">-</code><code class="w"> </code><code class="nt">apiGroups</code><code class="p">:</code><code class="w"> </code><code class="calibre15">[</code><code class="s">""</code><code class="calibre15">]</code><code class="w"></code>
<code class="w">  </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="calibre15">[</code><code class="s">"pods"</code><code class="calibre15">]</code><code class="w"></code>
<code class="w">  </code><code class="nt">verbs</code><code class="p">:</code><code class="w"> </code><code class="calibre15">[</code><code class="s">"list"</code><code class="calibre15">]</code><code class="w"></code></pre></div>

<p class="author1">Create the object by pointing to its corresponding YAML manifest file:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl apply -f role.yaml</strong>
role.rbac.authorization.k8s.io/list-pods-role created
</pre>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Creating the RoleBinding" class="praise"><div class="dedication" id="id356">
<h3 class="calibre44">Creating the RoleBinding</h3>

<p class="author1"><a data-type="xref" href="#rolebinding-service-account" class="calibre10">Example 17-7</a> defines the YAML manifest for the RoleBinding in the file <code class="calibre15">rolebinding.yaml</code>. The RoleBinding maps the Role <code class="calibre15">list-pods-role</code> to the service account named <code class="calibre15">sa-pod-api</code> and applies it only to the namespace <code class="calibre15">k97</code>.</p>
<div id="rolebinding-service-account" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 17-7. </span>YAML manifest for a RoleBinding attached to a service account</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">rbac.authorization.k8s.io/v1</code><code class="w"></code>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">RoleBinding</code><code class="w"></code>
<code class="nt">metadata</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">serviceaccount-pod-rolebinding</code><code class="w"></code>
<code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="calibre15">k97</code><code class="w"></code>
<code class="nt">subjects</code><code class="p">:</code><code class="w"></code>
<code class="calibre15">-</code><code class="w"> </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">ServiceAccount</code><code class="w"></code>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">sa-api</code><code class="w"></code>
<code class="nt">roleRef</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Role</code><code class="w"></code>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">list-pods-role</code><code class="w"></code>
<code class="w">  </code><code class="nt">apiGroup</code><code class="p">:</code><code class="w"> </code><code class="calibre15">rbac.authorization.k8s.io</code><code class="w"></code></pre></div>

<p class="author1">Create both RoleBinding objects using the <code class="calibre15">apply</code> command:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl apply -f rolebinding.yaml</strong>
rolebinding.rbac.authorization.k8s.io/serviceaccount-pod-rolebinding created
</pre>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Verifying the granted permissions" class="praise"><div class="dedication" id="id357">
<h3 class="calibre44">Verifying the granted permissions</h3>

<p class="author1">With the granted <code class="calibre15">list</code> permissions, the service account can now properly retrieve all the Pods in the <code class="calibre15">k97</code> namespace. The <code class="calibre15">curl</code> command in the <code class="calibre15">pods</code> container succeeds, as shown in the following output:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl logs list-objects -c pods -n k97</strong>
{
  "kind": "PodList",
  "apiVersion": "v1",
  "metadata": {
    "resourceVersion": "628"
  },
  "items": [
      {
        "metadata": {
          "name": "list-objects",
          "namespace": "k97",
          ...
      }
  ]
}
</pre>

<p class="author1">We did not grant any permissions to the service account for other resources. Listing the Deployments in the <code class="calibre15">k97</code> namespace still fails. The following output shows the response from the <code class="calibre15">curl</code> command in the <code class="calibre15">deployments</code> namespace:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl logs list-objects -c deployments -n k97</strong>
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "deployments.apps is forbidden: User \
              \"system:serviceaccount:k97:sa-api\" cannot list resource \
              \"deployments\" in API group \"apps\" in the namespace \
              \"k97\"",
  "reason": "Forbidden",
  "details": {
    "group": "apps",
    "kind": "deployments"
  },
  "code": 403
}
</pre>

<p class="author1">Feel free to modify the Role object to allow listing Deployment objects as well.</p>
</div></section>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Admission Control" class="praise"><div class="dedication" id="admission_control_phase">
<h1 class="calibre17">Admission Control</h1>

<p class="author1">The last phase of processing a request to the API server is admission control. Admission control is implemented by admission controllers. An admission controller provides a way to approve, deny, or mutate a request before it takes effect.</p>

<p class="author1">Admission controllers can be registered with the configuration of the API server. By default, the configuration file can be found at <em class="calibre3">/etc/kubernetes/manifests/kube-apiserver.yaml</em>. It is the cluster administrator’s job to manage the API server configuration. The following command-line invocation of the API server enables the <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do" class="calibre10">admission control plugins</a> named <code class="calibre15">NamespaceLifecycle</code>, <code class="calibre15">PodSecurity</code> and <code class="calibre15">LimitRanger</code>:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kube-apiserver --enable-admission-plugins=NamespaceLifecycle,PodSecurity,\
  LimitRanger</strong>
</pre>

<p class="author1">As a developer, you are inadvertently using admission control plugins that have been configured for you. One example is the <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#limitranger" class="calibre10">LimitRanger</a> and the <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#resourcequota" class="calibre10">ResourceQuota</a>, we’ll discuss in <a data-type="xref" href="ch18.xhtml#limit_ranges" class="calibre10">“Working with Limit Ranges”</a> and <a data-type="xref" href="ch18.xhtml#resource_quotas" class="calibre10">“Working with Resource Quotas”</a>.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Summary" class="praise"><div class="dedication" id="id359">
<h1 class="calibre17">Summary</h1>

<p class="author1">The API server processes requests to the Kubernetes API. Every request has to go through three phases: authentication, authorization, and admission control. Every phase can short-circuit the processing. For example, if the credentials sent with the request cannot be authenticated, then the request will be dropped immediately.</p>

<p class="author1">We looked at examples of all phases. The authentication phase covered <code class="calibre15">kubectl</code> as the client making a call to the Kubernetes API. The kubeconfig file serves as configuration source for named cluster, users, and their credentials. In Kubernetes, authorization is handled by RBAC. We learned the Kubernetes primitives that let you configure permissions for API resources tied to one or many subjects. Finally, we briefly covered the purpose of admission control and listed some plugins that act as controllers for validating or mutating a request to the Kubernetes API.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Exam Essentials" class="praise"><div class="dedication" id="id360">
<h1 class="calibre17">Exam Essentials</h1>
<dl class="calibre18">
<dt class="calibre19">Practice interacting with the Kubernetes API</dt>
<dd class="calibre20">
<p class="calibre21">This chapter demonstrated some ways to communicate with the Kubernetes API. We performed API requests by switching to a user context and with the help of a RESTful API call using <code class="calibre15">curl</code>. Explore the <a href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/" class="calibre10">Kubernetes API</a> and its endpoints on your own for broader exposure.</p>
</dd>
<dt class="calibre19">Understand the implications of defining RBAC rules for users and service accounts</dt>
<dd class="calibre20">
<p class="calibre21">Anonymous user requests to the Kubernetes API will not allow any substantial operations. For requests coming from a user or a service account, you will need to carefully analyze permissions granted to the subject. Learn the ins and outs of defining RBAC rules by creating the relevant objects to control permissions. Service accounts automount a token when used in a Pod. Expose the token as a volume only if you are intending to make API calls from the Pod.</p>
</dd>
<dt class="calibre19">Learn about the basic need for admission control</dt>
<dd class="calibre20">
<p class="calibre21">For the exam you will not need to understand how to configure admission control plugins in the API server. Developers interact with them, but configuration tasks are up to the cluster administrator. Read up on different plugins to gain a better understanding of the admission control landscape.</p>
</dd>
</dl>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Sample Exercises" class="praise"><div class="dedication" id="id361">
<h1 class="calibre17">Sample Exercises</h1>

<p class="author1">Solutions to these exercises are available in <a href="app01_split_013.xhtml#appendix_a_authentication_authorization_admission_control" class="calibre10">Appendix A</a>.</p>
<ol class="calibre55">
<li class="calibre56">
<p class="author1">The premise of this exercise is to create a new user and add her to the kubeconfig file. You will then define a context that uses the user, switch to the context, and execute a <code class="calibre15">kubectl</code> command.</p>

<p class="author1">Create a certificate for a user named <code class="calibre15">mary</code>. Do not provide any permissions to the user.</p>

<p class="author1">Add the user to the kubeconfig file. Define the context named <code class="calibre15">mary-context</code> that assigns the user to a cluster already available in the kubeconfig file.</p>

<p class="author1">Set the currently selected context to <code class="calibre15">mary-context</code>. Create a Pod using <code class="calibre15">kubectl</code>. What result do you expect to see?</p>
</li>
<li class="calibre56">
<p class="author1">You will use RBAC to grant permissions to a service account. The permissions should apply only to certain API resources and operations.</p>

<p class="author1">Create a new namespace named <code class="calibre15">t23</code>. Create a Pod named service-list in the namespace <code class="calibre15">t23</code>. The container uses the image <code class="calibre15">alpine/curl:3.14</code> and makes a <code class="calibre15">curl</code> call to the Kubernetes API that lists Service objects in the default namespace in an infinite loop.</p>

<p class="author1">Create and attach the service account <code class="calibre15">api-call</code> to the Pod.</p>

<p class="author1">Inspect the container logs after the Pod has been started. What response do you expect to see from the <code class="calibre15">curl</code> command?</p>

<p class="author1">Assign a ClusterRole and RoleBinding to the service account that allows only the operation needed by the Pod. Note the response from the <code class="calibre15">curl</code> command.</p>
</li>
<li class="calibre56">
<p class="author1">Identify the admission controller plugins that have been configured for the API server.</p>

<p class="author1">Locate the configuration file of the API server.</p>

<p class="author1">Inspect the command-line flag that defines the admission controller plugins. Capture the value.</p>
</li>

</ol>
</div></section>
</div></section></div></body>
</html>