- en: Chapter 2\. Infrastructure Security
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第二章。基础设施安全
- en: Many Kubernetes configurations are insecure by default. In this chapter we will
    explore how to secure Kubernetes at the infrastructure level. It can be made more
    secure through the combination of host hardening to make the servers or VMs Kubernetes
    is hosted on more secure, cluster hardening to secure the Kubernetes control plane
    components, and network security to integrate the cluster with the surrounding
    infrastructure. Please note that the concepts discussed in this chapter apply
    to self-hosted Kubernetes clusters as well as managed Kubernetes clusters.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 许多 Kubernetes 配置在默认情况下是不安全的。在本章中，我们将探讨如何在基础设施级别保护 Kubernetes。通过加固主机使托管 Kubernetes
    的服务器或虚拟机更加安全，加固集群以保护 Kubernetes 控制平面组件，并进行网络安全设置以将集群与周围基础设施集成，可以使其更加安全。请注意，本章讨论的概念适用于自托管
    Kubernetes 集群以及托管 Kubernetes 集群。
- en: Host hardening
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 主机加固
- en: This covers the choice of operating system, avoiding running nonessential processes
    on the hosts, and host-based firewalling.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 这涵盖了操作系统的选择，避免在主机上运行非必要进程以及基于主机的防火墙设置。
- en: Cluster hardening
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 集群加固
- en: This covers a range of configuration and policy settings needed to harden the
    control plane, including configuring TLS certificates, locking down the Kubernetes
    datastore, encrypting secrets at rest, credential rotation, and user authentication
    and access control.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 这涵盖了一系列配置和策略设置，用于加固控制平面，包括配置 TLS 证书，锁定 Kubernetes 数据存储，加密静态密钥，凭证轮换，以及用户认证和访问控制。
- en: Network security
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 网络安全
- en: This covers securely integrating the cluster with the surrounding infrastructure,
    and in particular which network interactions between the cluster and the surrounding
    infrastructure are allowed, for control plane, host, and workload traffic.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 这涵盖了安全地将集群与周围基础设施集成，特别是允许集群与周围基础设施之间的网络交互，用于控制平面、主机和工作负载流量。
- en: Let’s look at the details for each of these aspects and explore what is needed
    to build a secure infrastructure for your Kubernetes cluster.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们详细看看每个方面的细节，并探讨构建安全基础设施以保护您的 Kubernetes 集群所需的内容。
- en: Host Hardening
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 主机加固
- en: A secure host is an important building block for a secure Kubernetes cluster.
    When you think of a host, it is in the context of workloads that make up your
    Kubernetes cluster. We will now explore techniques to ensure a strong security
    posture for the host.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 安全的主机是安全 Kubernetes 集群的重要基石。当您考虑主机时，它是在构成 Kubernetes 集群的工作负载背景下。现在我们将探讨确保主机具有强大安全姿态的技术。
- en: Choice of Operating System
  id: totrans-11
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 操作系统的选择
- en: 'Many enterprises standardize on a single operating system across all of their
    infrastructure, which means the choice may have already been made for you. However,
    if there is flexibility to choose an operating system, then it is worth considering
    a modern immutable Linux distribution specifically designed for containers. These
    distributions are advantageous for the following reasons:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 许多企业在其所有基础设施上标准化使用单一操作系统，这意味着可能已经为您做出了选择。但是，如果有选择操作系统的灵活性，那么考虑专为容器设计的现代不可变 Linux
    发行版是值得的。这些发行版有以下优势：
- en: They often have newer kernels, which include the latest vulnerability fixes
    as well as up-to-date implementations of newer technologies such as eBPF, which
    can be leveraged by Kubernetes networking and security monitoring tools.
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它们通常具有更新的内核，包括最新的漏洞修复以及最新技术（如 eBPF）的实现，这些技术可以被 Kubernetes 网络和安全监控工具利用。
- en: They are designed to be immutable, which brings additional benefits for security.
    Immutability in this context means that the root filesystem is locked and cannot
    be changed by applications. Applications can only be installed using containers.
    This isolates applications from the root filesystem and significantly reduces
    the ability for malicious applications to compromise the host.
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它们设计为不可变，这在安全方面带来了额外的好处。在此上下文中，不可变性意味着根文件系统被锁定，应用程序无法更改。只能使用容器安装应用程序。这将应用程序与根文件系统隔离，并显著减少了恶意应用程序破坏主机的能力。
- en: They often include the ability to self-update to newer versions, with the upstream
    versions being geared up for rapid releases to address security vulnerabilities.
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它们通常包括自动更新到较新版本的能力，上游版本已准备好快速发布以解决安全漏洞。
- en: Two popular examples of modern immutable Linux distributions designed for containers
    are Flatcar Container Linux (which was originally based on CoreOS Container Linux)
    and Bottlerocket (originally created and maintained by Amazon).
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 设计用于容器的现代不可变 Linux 发行版的两个流行示例是 Flatcar Container Linux（最初基于 CoreOS Container
    Linux）和 Bottlerocket（最初由亚马逊创建和维护）。
- en: Whichever operating system you choose, it is good practice to monitor upstream
    security announcements so you know when new security vulnerabilities are identified
    and disclosed and to make sure you have processes in place to update your cluster
    to a newer version to address critical security vulnerabilities. Based on your
    assessment of these vulnerabilities, you will want to make a decision on whether
    to upgrade your cluster to a new version of the operating system. When you consider
    the choice of the operating system, you must also take into account shared libraries
    from the host operating system and understand their impact on containers that
    will be deployed on the host.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 无论您选择哪种操作系统，监视上游安全公告以便了解新发现的安全漏洞，并确保您有适当的流程来更新您的集群到更新版本以解决关键的安全漏洞，是一个良好的实践。根据您对这些漏洞的评估，您将需要决定是否将集群升级到操作系统的新版本。在考虑操作系统选择时，您还必须考虑来自主机操作系统的共享库，并了解它们对将部署在主机上的容器的影响。
- en: Another security best practice is to ensure that application developers do not
    depend on a specific version of the operating system or kernel, as this will not
    allow you to update the host operating system as needed.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个安全最佳实践是确保应用开发人员不依赖特定版本的操作系统或内核，因为这样将无法根据需要更新主机操作系统。
- en: Nonessential Processes
  id: totrans-19
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 非必要进程
- en: Each running host process is a potential attack vector for hackers. From a security
    perspective, it is best to remove any nonessential processes that may be running
    by default. If a process isn’t needed for the successful running of Kubernetes,
    management of your host, or security of your host, then it is best not to run
    the process. How you disable the process will depend on your particular setup
    (e.g., systemd configuration change or removing the initialization script from
    /etc/init.d/).
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 每个运行的主机进程都是黑客的潜在攻击向量。从安全的角度来看，最好是删除默认情况下可能正在运行的任何非必要进程。如果一个进程对于成功运行 Kubernetes、管理您的主机或保护您的主机没有必要，则最好不要运行该进程。如何禁用进程将取决于您的特定设置（例如，通过
    systemd 配置更改或从 /etc/init.d/ 中删除初始化脚本）。
- en: If you are using an immutable Linux distribution optimized for containers, then
    nonessential processes will have already been eliminated and you can only run
    additional processes/applications as containers.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您正在使用针对容器优化的不可变 Linux 发行版，则已经消除了非必要进程，您只能作为容器运行额外的进程/应用程序。
- en: Host-Based Firewalling
  id: totrans-22
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 防火墙主机化
- en: To further lock down the servers or VMs Kubernetes is hosted on, the host itself
    can be configured with local firewall rules to restrict which IP address ranges
    and ports are allowed to interact with the host.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 为了进一步锁定托管 Kubernetes 的服务器或虚拟机，可以为主机本身配置本地防火墙规则，以限制允许与主机交互的 IP 地址范围和端口。
- en: Depending on your operating system, this can be done with traditional Linux
    admin tools such as iptables rules or firewalld configuration. It is important
    to make sure any such rules are compatible with both the Kubernetes control plane
    and whichever Kubernetes network plug-in you plan to use so they do not block
    the Kubernetes control plane, pod networking, or the pod network control plane.
    Getting these rules right, and keeping them up to date over time, can be a time-consuming
    process. In addition, if using an immutable Linux distribution, you may not easily
    be able to directly use these tools.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 根据您的操作系统，可以使用传统的 Linux 管理工具，例如 iptables 规则或 firewalld 配置来实现这一点。重要的是确保这些规则与 Kubernetes
    控制平面和您计划使用的 Kubernetes 网络插件兼容，以免阻塞 Kubernetes 控制平面、Pod 网络或 Pod 网络控制平面。正确配置这些规则并随时间保持其更新可能是一个耗时的过程。此外，如果使用不可变的
    Linux 发行版，您可能无法直接使用这些工具。
- en: Fortunately, some Kubernetes network plug-ins can help solve this problem for
    you. For example, several Kubernetes network plug-ins, like Weave Net, Kube-router,
    and Calico, include the ability to apply network policies. You should review these
    plug-ins and pick one that also supports applying network policies to the hosts
    themselves (rather than just to Kubernetes pods). This makes securing the hosts
    in the cluster significantly simpler and is largely operating system independent,
    including working with immutable Linux distributions.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 幸运的是，一些 Kubernetes 网络插件可以帮助解决这个问题。例如，几个 Kubernetes 网络插件，如 Weave Net、Kube-router
    和 Calico，包括应用网络策略的能力。你应该审查这些插件，并选择一个也支持将网络策略应用于主机本身（而不仅仅是 Kubernetes Pod）。这样可以大大简化集群中主机的安全性，并且基本上与操作系统无关，包括与不可变
    Linux 发行版一起使用。
- en: Always Research the Latest Best Practices
  id: totrans-26
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 始终研究最新的最佳实践
- en: As new vulnerabilities or attack vectors are identified by the security research
    community, security best practices evolve over time. Many of these are well-documented
    online and are available for free.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 随着安全研究社区确定新的漏洞或攻击向量，安全最佳实践随时间而演变。许多这些都有详细的在线文档，并且可以免费获取。
- en: For example, the Center for Internet Security maintains free PDF guides with
    comprehensive configuration guidance to secure many of the most common operating
    systems. Known as CIS Benchmarks, they are an excellent resource for making sure
    you are covering the many important actions required to secure your host operating
    system. You can find an [up-to-date list of CIS Benchmarks on their website](https://oreil.ly/dpUnC).
    Please note there are Kubernetes-specific benchmarks, and we will discuss them
    later in this chapter.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，互联网中心安全性维护了免费的 PDF 指南，详细说明了安全地配置许多常见操作系统所需的行动。称为 CIS 基准，它们是确保你覆盖了保护主机操作系统所需的许多重要行动的极好资源。你可以在他们的网站上找到
    [最新的 CIS 基准列表](https://oreil.ly/dpUnC)。请注意，还有针对 Kubernetes 的特定基准，我们将在本章后面讨论。
- en: Cluster Hardening
  id: totrans-29
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 集群加固
- en: Kubernetes is insecure by default. So in addition to hardening the hosts that
    make up a cluster, it is important to harden the cluster itself. This can be done
    through a combination of Kubernetes component and configuration management, authentication
    and role-based access control (RBAC), and keeping the cluster updated with the
    latest versions of Kubernetes to ensure the cluster has the latest vulnerability
    fixes.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes 默认情况下是不安全的。因此除了加固组成集群的主机外，加固集群本身也非常重要。这可以通过 Kubernetes 组件和配置管理、身份验证和基于角色的访问控制（RBAC），以及保持集群更新到最新的
    Kubernetes 版本来实现，以确保集群具有最新的漏洞修复。
- en: Secure the Kubernetes Datastore
  id: totrans-31
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 保护 Kubernetes 数据存储
- en: Kubernetes uses etcd as its main datastore. This is where all cluster configuration
    and desired state is stored. Having access to the etcd datastore is essentially
    equivalent to having root login on all your nodes. Almost any other security measures
    you have put in place within the cluster become moot if a malicious actor gains
    access to the etcd datastore. They will have complete control over your cluster
    at that point, including the ability to run arbitrary containers with elevated
    privileges on any node.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes 使用 etcd 作为其主要数据存储。这是存储所有集群配置和期望状态的地方。访问 etcd 数据存储与在所有节点上拥有 root 登录权限基本上是等效的。如果恶意用户获取了对
    etcd 数据存储的访问权限，几乎所有你在集群内实施的其他安全措施都将失效。他们将完全控制你的集群，包括在任何节点上以提升的权限运行任意容器的能力。
- en: The main way to secure etcd is to use the security features provided by etcd
    itself. These are based around x509 Public Key Infrastructure (PKI), using a combination
    of keys and certificates. They ensure that all data in transit is encrypted with
    TLS and all access is restricted with strong credentials. It is best to configure
    etcd with one set of credentials (key pairs and certificates) for peer communications
    between the different etcd instances, and another set of credentials for client
    communications from the Kubernetes API. As part of this configuration, etcd must
    also be configured with the details of certificate authority (CA) used to generate
    the client credentials.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 保护 etcd 的主要方法是使用 etcd 本身提供的安全功能。这些功能基于 x509 公钥基础设施（PKI），使用密钥和证书的组合。它们确保所有传输中的数据都使用
    TLS 加密，并且所有访问都受到强密码的限制。最好为不同 etcd 实例之间的对等通信配置一组凭据（密钥对和证书），并为来自 Kubernetes API
    的客户端通信配置另一组凭据。作为此配置的一部分，etcd 还必须配置证书颁发机构（CA）的详细信息，用于生成客户端凭据。
- en: Once etcd is configured correctly, only clients with valid certificates can
    access it. You must then configure the Kubernetes API server with the client certificate,
    key, and certificate authority so it can access etcd.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦正确配置了 etcd，只有拥有有效证书的客户端才能访问它。然后，您必须配置 Kubernetes API 服务器，使其能够使用客户端证书、密钥和证书颁发机构来访问
    etcd。
- en: You can also use network-level firewall rules to restrict etcd access so it
    can only be accessed from Kubernetes control nodes (hosting the Kubernetes API
    server). Depending on your environment you can use a traditional firewall, virtual
    cloud firewall, or rules on the etcd hosts themselves (for example, a networking
    policy implementation that supports host endpoint protection) to block traffic.
    This is best done in addition to using etcd’s own security features as part of
    an in-depth defense strategy, since limiting access with firewall rules does not
    address the security need for Kubernetes’ sensitive data to be encrypted in transit.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 您还可以使用网络级防火墙规则限制对 etcd 的访问，以便只能从 Kubernetes 控制节点（托管 Kubernetes API 服务器的节点）访问它。根据您的环境，可以使用传统防火墙、虚拟云防火墙或在
    etcd 主机上设置规则（例如支持主机端点保护的网络策略实施）来阻止流量。这最好是作为深度防御策略的一部分，与使用 etcd 的安全功能一起使用，因为仅通过防火墙规则限制访问并不能解决加密
    Kubernetes 敏感数据在传输中的安全需求。
- en: In addition to securing etcd access for Kubernetes, it is recommended to not
    use the Kubernetes etcd datastore for anything other than Kubernetes. In other
    words, do not store non-Kubernetes data within the datastore and do not give other
    components access to the etcd cluster. If you are running applications or infrastructure
    (within the cluster or external to the cluster) that uses etcd as a datastore,
    the best practice is to set up a separate etcd cluster for that. The arguable
    exception would be if the application or infrastructure was sufficiently privileged
    that a compromise to its datastore would also result in a complete compromise
    of Kubernetes. It is also very important to maintain backups of etcd and secure
    the backups so that it is possible to recover from failures like a failed upgrade
    or a security incident.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 除了为 Kubernetes 安全地访问 etcd，建议不要将 Kubernetes etcd 数据存储用于除 Kubernetes 之外的任何其他用途。换句话说，不要在数据存储中存储非
    Kubernetes 数据，也不要让其他组件访问 etcd 集群。如果正在运行使用 etcd 作为数据存储的应用程序或基础架构（在集群内部或集群外部），最佳实践是为其设置单独的
    etcd 集群。可以辩称的例外情况是，如果应用程序或基础架构具有足够的特权，以至于其数据存储的妥协也会导致 Kubernetes 的完全妥协。还非常重要的是要保持
    etcd 的备份，并确保备份的安全性，以便能够从失败（例如升级失败或安全事件）中恢复。
- en: Secure the Kubernetes API Server
  id: totrans-37
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 保护 Kubernetes API 服务器的安全性
- en: One layer up from the etcd datastore, the next set of crown jewels to be secured
    is the Kubernetes API server. As with etcd, this can be done using x509 PKI and
    TLS. The details of how to bootstrap a cluster in this way vary depending on the
    Kubernetes installation method you are using, but most methods include steps that
    create the required keys and certificates and distribute them to the other Kubernetes
    cluster components. It’s worth noting that some installation methods may enable
    insecure local ports for some components, so it is important to familiarize yourself
    with the settings of each component to identify potential unsecured traffic so
    you can take appropriate action to secure them.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 在 etcd 数据存储之上的另一层，需要保护的下一个关键是 Kubernetes API 服务器。与 etcd 一样，可以使用 x509 PKI 和 TLS
    来实现安全性。如何以这种方式引导集群的详细步骤因您使用的 Kubernetes 安装方法而异，但大多数方法包括创建所需的密钥和证书并将其分发到其他 Kubernetes
    集群组件的步骤。值得注意的是，某些安装方法可能为某些组件启用不安全的本地端口，因此重要的是熟悉每个组件的设置，以识别潜在的未安全流量，以便采取适当的安全措施。
- en: Encrypt Kubernetes Secrets at Rest
  id: totrans-39
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在静止状态下加密 Kubernetes Secrets
- en: Kubernetes can be configured to encrypt sensitive data it stores in etcd, such
    as Kubernetes secrets. This keeps the secrets safe from any attacker that may
    gain access to etcd or to an offline copy of etcd such as offline backup.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes 可以配置为加密存储在 etcd 中的敏感数据，例如 Kubernetes secrets。这样可以防止任何攻击者访问 etcd 或其离线副本（例如离线备份）时泄露这些机密。
- en: By default, Kubernetes does not encrypt secrets at rest, and when encryption
    is enabled, it only encrypts when a secret is written to etcd. Therefore, when
    enabling encryption at rest, it is important to rewrite all secrets (through standard
    kubectl apply or update commands) to trigger their encryption within etcd.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，Kubernetes不会对存储的秘密进行加密，当启用加密时，它仅在将秘密写入etcd时进行加密。因此，在启用静态加密时，重写所有秘密（通过标准kubectl
    apply或update命令）以触发其在etcd中的加密至关重要。
- en: 'Kubernetes supports a variety of encryption providers. It is important to pick
    the recommended encryption based on encryption best practices. The mainline recommended
    choice is AES-CBC with PKCS #7–based encryption. This provides very strong encryption
    using 32-byte keys and is relatively fast. There are two different providers that
    support this encryption:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 'Kubernetes支持各种加密提供程序。根据加密最佳实践选择推荐的加密方法非常重要。主推的选择是基于AES-CBC和PKCS #7的加密。这使用32字节密钥提供非常强大的加密，并且相对较快。有两种不同的提供程序支持此加密：'
- en: The local provider that runs entirely with Kubernetes and uses locally configured
    keys
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 完全在Kubernetes中运行并使用本地配置密钥的本地提供程序。
- en: The KMS provider that uses an external key management service (KMS) to manage
    the keys
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用外部密钥管理服务（KMS）的KMS提供程序来管理密钥。
- en: The local provider stores its keys on the API server’s local disk. This therefore
    has the limitation that if the API server host is compromised, then all of your
    secrets become compromised. Depending on your security posture, this may be acceptable.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 本地提供程序将其密钥存储在API服务器的本地磁盘上。因此，如果API服务器主机受到攻击，则所有您的秘密都会受到威胁。根据您的安全立场，这可能是可以接受的。
- en: The KMS provider uses a technique called *envelope encryption*. With envelope
    encryption, each secret is encrypted with a dynamically generated data encryption
    key (DEK). The DEK is then encrypted using a key encryption key (KEK) provided
    by the KMS, and the encrypted DEK is stored alongside the encrypted secret in
    etcd. The KEK is always hosted by the KMS as the central root of trust and is
    never stored within the cluster. Most large public cloud providers offer a cloud-based
    KMS service that can be used as the KMS provider in Kubernetes. For on-prem clusters
    there are third-party solutions, such as HashiCorp’s Vault, which can act as the
    KMS provider for the cluster. Because the detailed implementations vary, it is
    important to evaluate the mechanism through which the KMS authenticates the API
    server and whether a compromise to the API server host could in turn compromise
    your secrets and therefore offer only limited benefits compared with a local encryption
    provider.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: KMS提供程序使用一种称为*信封加密*的技术。使用信封加密时，每个秘密都使用动态生成的数据加密密钥（DEK）进行加密。然后，DEK使用由KMS提供的密钥加密密钥（KEK）进行加密，并将加密的DEK与etcd中加密的秘密一起存储。KEK始终由KMS托管为中心的信任根，永远不会存储在集群中。大多数大型公共云提供商提供基于云的KMS服务，可用作Kubernetes中的KMS提供程序。对于本地集群，可以使用第三方解决方案，如HashiCorp的Vault，作为集群的KMS提供程序。由于详细的实施方式有所不同，评估KMS如何验证API服务器以及API服务器主机的妥协是否可能威胁到您的秘密，因此仅能提供有限的优势，相比本地加密提供程序。
- en: If exceptionally high volumes of encrypted storage read/writes are anticipated,
    then using the secretbox encryption provider could potentially be faster. However,
    secretbox is a newer standard and at the time of writing has had less review than
    other encryption algorithms. It therefore may not be considered acceptable in
    environments that require high levels of review. In addition, secretbox is not
    yet supported by the KMS provider and must use a local provider, which stores
    the keys on the API server.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 如果预计有异常高量的加密存储读/写操作，则使用secretbox加密提供程序可能会更快。但是，secretbox是一种较新的标准，在撰写时的审查较少。因此，在需要高水平审查的环境中，可能不被认为是可接受的。此外，KMS提供程序尚不支持secretbox，必须使用本地提供程序，将密钥存储在API服务器上。
- en: Encrypting Kubernetes secrets is the most common must-have encryption at-rest
    requirement, but note that you can also configure Kubernetes to encrypt storage
    of other Kubernetes resources if desired.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 加密Kubernetes秘密是最常见的必须在静态时加密要求，但请注意，如果需要，还可以配置Kubernetes以加密其他Kubernetes资源的存储。
- en: It’s also worth noting there are third-party secret management solutions that
    can be used if you have requirements beyond the capabilities of Kubernetes secrets.
    One such solution, already mentioned as a potential KMS provider for envelope
    encryption in Kubernetes, is HashiCorp’s Vault. In addition to providing secure
    secrets management for Kubernetes, Vault can be used beyond the scope of Kubernetes
    to manage secrets more broadly across the enterprise if desired. Vault was also
    a very popular choice for plugging the major gap in earlier Kubernetes versions,
    which did not support the encryption of secrets at rest.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 值得注意的是，如果您有超出 Kubernetes secrets 能力范围的需求，可以使用第三方的秘密管理解决方案。其中一个这样的解决方案，已被提及作为
    Kubernetes 中信封加密的潜在 KMS 提供者，是 HashiCorp 的 Vault。除了为 Kubernetes 提供安全的秘密管理外，Vault
    还可以在企业范围内更广泛地管理秘密，如果需要的话。Vault 还是早期 Kubernetes 版本中填补重要差距的非常受欢迎的选择，这些版本不支持加密处于静态状态的秘密。
- en: Rotate Credentials Frequently
  id: totrans-50
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 频繁轮换凭据
- en: Rotating credentials frequently makes it harder for attackers to make use of
    any compromised credential they may obtain. It is therefore a best practice to
    set short lifetimes on any TLS certificates or other credentials and automate
    their rotation. Most authentication providers can control how long issued certificates
    or service tokens are valid for, and it is best to use short lifetimes whenever
    possible, for example rotating keys every day or more frequently if they are particularly
    sensitive. This needs to include any service tokens used in external integrations
    or as part of the cluster bootstrap process.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 频繁地轮换凭据使攻击者更难利用可能获得的任何被泄露的凭据。因此，设置任何 TLS 证书或其他凭据的短寿命并自动化其轮换是最佳实践。大多数身份验证提供程序可以控制签发证书或服务令牌的有效期多长时间，尽可能使用短的生命周期是最佳的，例如每天轮换密钥或如果特别敏感则更频繁。这需要包括用于外部集成或作为集群引导过程的任何服务令牌。
- en: Fully automating the rotation of credentials may require custom DevOps development
    work, but normally represents a good investment compared with attempting to manually
    rotate credentials on an ongoing basis.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 完全自动化凭据的轮换可能需要定制的 DevOps 开发工作，但通常与尝试定期手动轮换凭据相比，代表了一个很好的投资。
- en: When rotating keys for Kubernetes secrets stored at rest (as discussed in the
    previous section), local providers support multiple keys. The first key is always
    used to encrypt any new secret writes. For decryption, the keys are tried in order
    until the secret is successfully decrypted. As keys are encrypted only on writes,
    it is important to rewrite all secrets (through standard kubectl apply or update
    commands) to trigger their encryption with the latest keys. If the rotation of
    secrets is fully automated, then the write will happen as part of this process
    without requiring a separate step.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 在对存储在静态状态下的 Kubernetes secrets 进行密钥轮换时（如前一节讨论的），本地提供程序支持多个密钥。第一个密钥始终用于加密任何新的秘密写入。对于解密，密钥按顺序尝试，直到成功解密秘密。由于密钥仅在写入时进行加密，因此重写所有秘密（通过标准的
    kubectl apply 或更新命令）以触发使用最新密钥进行加密是很重要的。如果秘密的轮换是完全自动化的，则写入将作为此过程的一部分而发生，无需单独步骤。
- en: When using a KMS provider (rather than a local provider), the KEK can be rotated
    without requiring reencryption of all the secrets, which can reduce the performance
    impact of reencrypting all secrets if you have a large number of sizable secrets.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 当使用 KMS 提供者（而不是本地提供者）时，可以轻松地轮换 KEK 而无需重新加密所有秘密，这可以减少重新加密大量大小适当的秘密时的性能影响。
- en: Authentication and RBAC
  id: totrans-55
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 认证和RBAC
- en: In the previous sections we primarily focused on securing programmatic/code
    access within the cluster. Equally important is to follow best practices for securing
    user interactions with the cluster. This includes creating separate user accounts
    for each user and using Kubernetes RBAC to grant users the minimal access they
    need to perform their role, following the principle of least privilege access.
    Usually it is better to do this using groups and roles, rather than assigning
    RBAC permissions to individual users. This makes it easier to manage privileges
    over time, both in terms of adjusting privileges for different groups of users
    when requirements change and for reducing the effort required to periodically
    review/audit the user privileges across the cluster to verify they are correct
    and up to date.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 在前面的部分中，我们主要关注在集群内部保障程序化/代码访问的安全性。同样重要的是要遵循最佳实践，以保障用户与集群的交互。这包括为每个用户创建单独的用户账户，并使用
    Kubernetes RBAC 为用户授予他们执行角色所需的最小访问权限，遵循最小特权访问原则。通常最好使用组和角色来实现这一点，而不是为个别用户分配 RBAC
    权限。这样做可以更轻松地随着时间调整不同用户组的权限，同时减少定期审查/审核集群中用户权限是否正确和最新的工作量。
- en: Kubernetes has limited built-in authentication capabilities for users, but can
    be integrated with most external enterprise authentication providers, such as
    public cloud provider IAM systems or on-prem authentication services, either directly
    or through third-party projects such as Dex (originally created by CoreOS). It
    is generally recommended to integrate with one of these external authentication
    providers rather than using Kubernetes basic auth or service account tokens, since
    external authentication providers typically have more user-friendly support for
    rotation of credentials, including the ability to specify password strength and
    rotation frequency timeframes.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes 对于用户有限的内置认证能力，但可以与大多数外部企业认证提供者集成，如公共云提供商的 IAM 系统或本地认证服务，可以直接或通过第三方项目（如最初由
    CoreOS 创建的 Dex）。通常建议与其中一个外部认证提供者集成，而不是使用 Kubernetes 基本认证或服务账户令牌，因为外部认证提供者通常具有更友好的凭据轮换支持，包括指定密码强度和轮换频率时间段的能力。
- en: Restricting Cloud Metadata API Access
  id: totrans-58
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 限制云元数据 API 访问
- en: Most public clouds provide a metadata API that is accessible locally from each
    host/VM instance. The APIs provide access to the instance’s cloud credentials,
    IAM permissions, and other potentially sensitive information about the instance.
    By default, these APIs are accessible by the Kubernetes pods running on an instance.
    Any compromised pod can use these credentials to elevate its intended privilege
    level within the cluster or to other cloud provider–hosted services the instance
    may have privileges to access.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数公共云提供了一个可从每个主机/VM实例本地访问的元数据 API。这些 API 提供对实例的云凭据、IAM 权限和实例可能具有的其他潜在敏感信息的访问。默认情况下，这些
    API 可由运行在实例上的 Kubernetes Pod 访问。任何被攻击的 Pod 都可以使用这些凭据提升其在集群内的预期特权级别，或者访问实例可能具有权限访问的其他云提供商托管服务。
- en: 'To address this security issue, the best practice is to:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 解决这个安全问题的最佳实践是：
- en: Provide any required pod IAM credentials following the cloud provider’s recommended
    mechanisms. For example, Amazon EKS allows you to assign a unique IAM role to
    a service account, Microsoft Azure’s AKS allows you to assign a managed identity
    to a pod, and Google Cloud’s GKE allows you to assign IAM permissions via Workload
    Identity.
  id: totrans-61
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 根据云提供商的推荐机制提供任何必需的 Pod IAM 凭据。例如，Amazon EKS 允许您为服务账户分配唯一的 IAM 角色，Microsoft Azure
    的 AKS 允许您为 Pod 分配托管标识，Google Cloud 的 GKE 允许您通过工作负载标识分配 IAM 权限。
- en: Limit the cloud privileges of each instance to the minimum required to reduce
    the impact of any compromised access to the metadata API from the instance.
  id: totrans-62
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 限制每个实例的云权限至最低限度，以减少从实例访问元数据 API 的任何被攻击影响。
- en: Use network policies to block pod access to the metadata API. This can be done
    with per-namespace Kubernetes network policies, or preferably with extensions
    to Kubernetes network policies such as those offered by Calico, which enable a
    single network policy to apply across the whole of the cluster (without the need
    to create a new Kubernetes network policy each time a new namespace is added to
    the cluster). This topic is covered in more depth in the Default Deny and Default
    App Policy section of [Chapter 7](ch07.xhtml#network_policy).
  id: totrans-63
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Use network policies to block pod access to the metadata API. This can be done
    with per-namespace Kubernetes network policies, or preferably with extensions
    to Kubernetes network policies such as those offered by Calico, which enable a
    single network policy to apply across the whole of the cluster (without the need
    to create a new Kubernetes network policy each time a new namespace is added to
    the cluster). This topic is covered in more depth in the Default Deny and Default
    App Policy section of [Chapter 7](ch07.xhtml#network_policy).
- en: Enable Auditing
  id: totrans-64
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: Enable Auditing
- en: Kubernetes auditing provides a log of all actions within the cluster with configurable
    scope and levels of detail. Enabling Kubernetes audit logging and archiving audit
    logs on a secure service is recommended as an important source of forensic details
    in the event of needing to analyze a security breach.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes auditing provides a log of all actions within the cluster with configurable
    scope and levels of detail. Enabling Kubernetes audit logging and archiving audit
    logs on a secure service is recommended as an important source of forensic details
    in the event of needing to analyze a security breach.
- en: 'The forensic review of the audit log can help answer questions such as:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 'The forensic review of the audit log can help answer questions such as:'
- en: What happened, when, and where in the cluster?
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: What happened, when, and where in the cluster?
- en: Who or what initiated it and from where?
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Who or what initiated it and from where?
- en: In addition, Kubernetes audit logs can be actively monitored to alert on suspicious
    activity using your own custom tooling or third-party solutions. There are many
    enterprise products that you can use to monitor Kubernetes audit logs and generate
    alerts based on configurable match criteria.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: In addition, Kubernetes audit logs can be actively monitored to alert on suspicious
    activity using your own custom tooling or third-party solutions. There are many
    enterprise products that you can use to monitor Kubernetes audit logs and generate
    alerts based on configurable match criteria.
- en: The details of what events are captured in Kubernetes audit logs are controlled
    using policy. The policy determines which events are recorded, for which resources,
    and with what level of detail.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: The details of what events are captured in Kubernetes audit logs are controlled
    using policy. The policy determines which events are recorded, for which resources,
    and with what level of detail.
- en: 'Each action being performed can generate a series of events, defined as stages:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 'Each action being performed can generate a series of events, defined as stages:'
- en: RequestReceived
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: RequestReceived
- en: Generated as soon as the audit handler receives the request
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: Generated as soon as the audit handler receives the request
- en: ResponseStarted
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: ResponseStarted
- en: Generated when the response headers are sent, but before the response body is
    sent (generated only for long-running requests such as watches)
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: Generated when the response headers are sent, but before the response body is
    sent (generated only for long-running requests such as watches)
- en: ResponseComplete
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: ResponseComplete
- en: Generated when the response body has been completed
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: Generated when the response body has been completed
- en: Panic
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: Panic
- en: Generated when a panic occurs
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: Generated when a panic occurs
- en: 'The level of detail recorded for each event can be one of the following:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 'The level of detail recorded for each event can be one of the following:'
- en: None
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: None
- en: Does not log the event at all
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: Does not log the event at all
- en: Metadata
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: Metadata
- en: Logs the request metadata (user, timestamp, resource, verb, etc.) but not the
    request details or response body
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: Logs the request metadata (user, timestamp, resource, verb, etc.) but not the
    request details or response body
- en: Request
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: Request
- en: Logs event metadata and the request body but not the response body
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: Logs event metadata and the request body but not the response body
- en: RequestResponse
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: RequestResponse
- en: Logs the full details of the event, including the metadata and request and response
    bodies
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: Logs the full details of the event, including the metadata and request and response
    bodies
- en: Kubernetes’ audit policy is very flexible and well documented in the main Kubernetes
    documentation. Included here are just a couple of simple examples to illustrate.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes’ audit policy is very flexible and well documented in the main Kubernetes
    documentation. Included here are just a couple of simple examples to illustrate.
- en: 'To log all requests at the metadata level:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 'To log all requests at the metadata level:'
- en: '[PRE0]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'To omit the `RequestReceived` stage and to log pod changes at the `RequestResponse`
    level and configmap and secrets changes at the metadata level:'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 'To omit the `RequestReceived` stage and to log pod changes at the `RequestResponse`
    level and configmap and secrets changes at the metadata level:'
- en: '[PRE1]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: This second example illustrates the important consideration of sensitive data
    in audit logs. Depending on the level of security around access to the audit logs,
    it may be essential to ensure the audit policy does not log details of secrets
    or other sensitive data. Just like the practice of encrypting secrets at rest,
    it is generally a good practice to always exclude sensitive details from your
    audit log.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 第二个示例说明了审计日志中敏感数据的重要考虑因素。根据对审计日志访问安全性的要求，确保审计策略不记录机密或其他敏感数据可能是至关重要的。就像对静止状态的加密密码的做法一样，通常建议始终从审计日志中排除敏感细节。
- en: Restrict Access to Alpha or Beta Features
  id: totrans-95
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 限制对 alpha 或 beta 功能的访问
- en: Each Kubernetes release includes alpha and beta features. Whether these are
    enabled can be controlled by specifying feature gate flags for the individual
    Kubernetes components. As these features are in development, they can have limitations
    or bugs that result in security vulnerabilities. So it is a good practice to make
    sure that all alpha and beta features you do not intend to use are disabled.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 每个 Kubernetes 发布版本都包含 alpha 和 beta 功能。可以通过为各个 Kubernetes 组件指定功能门标志来控制它们的启用。由于这些功能正在开发中，它们可能存在限制或错误，从而导致安全漏洞。因此，良好的做法是确保所有不打算使用的
    alpha 和 beta 功能都被禁用。
- en: Alpha features are normally (but not always) disabled by default. They might
    be buggy, and the support for the feature could radically change without backward
    compatibility, or be dropped in future releases. They are generally recommended
    for testing clusters only, not production clusters.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: Alpha 功能通常（但并非总是）默认禁用。它们可能存在错误，并且该功能的支持可能会在不向后兼容的情况下发生根本性变化，或在未来的版本中被删除。一般建议仅将其用于测试集群，而不是生产集群。
- en: Beta features are normally enabled by default. They can still change in non-backward-compatible
    ways between releases, but they are usually considered reasonably well tested
    and safe to enable. But as with any new feature, they are inherently more likely
    to have vulnerabilities because they have been used less and had less review.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: Beta 功能通常默认启用。它们在版本发布之间可能会以不向后兼容的方式更改，但通常被认为经过合理测试且安全可用。但与任何新功能一样，它们天生更有可能存在漏洞，因为它们的使用较少且审核较少。
- en: Always assess the value an alpha or beta feature may provide against the security
    risk it represents, as well as the potential ops risk of non-backward-compatible
    changes of the features between releases.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 评估 alpha 或 beta 功能可能提供的价值，对比其带来的安全风险，以及在发布版本之间功能非向后兼容变更可能带来的操作风险是非常重要的。
- en: Upgrade Kubernetes Frequently
  id: totrans-100
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 频繁升级 Kubernetes
- en: It is inevitable that new vulnerabilities will be discovered over time in any
    large software project. The Kubernetes developer community has a good track record
    of responding to newly discovered vulnerabilities in a timely manner. Severe vulnerabilities
    are normally fixed under embargo, meaning that the knowledge of the vulnerability
    is not made public until the developers have had time to produce a fix. Over time,
    the number of publicly known vulnerabilities for older Kubernetes versions grows,
    which can put older clusters at greater security risk.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 在任何大型软件项目中，随着时间的推移，新的漏洞是不可避免的。Kubernetes 开发者社区在及时响应新发现的漏洞方面表现良好。严重漏洞通常在封禁期间修复，这意味着漏洞的知识不会在开发者有时间制定修复方案之前公开。随着时间的推移，较旧的
    Kubernetes 版本中已公开已知漏洞的数量增加，这可能会增加较旧集群的安全风险。
- en: To reduce the risk of your clusters being compromised, it is important to regularly
    upgrade your clusters, and to have in place the ability to urgently upgrade if
    a severe vulnerability is discovered.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 为减少集群被妥协的风险，定期升级集群非常重要，并确保能够紧急升级以应对发现的严重漏洞。
- en: All Kubernetes security updates and vulnerabilities are reported (once any embargo
    ends) via the public and free-to-join *kubernetes-announce* email group. Joining
    this group is highly recommended for anyone wanting to keep track of known vulnerabilities
    so they can minimize their security exposure.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 所有 Kubernetes 安全更新和漏洞报告（一旦有任何封禁结束）通过公开且免费加入的 *kubernetes-announce* 邮件组。强烈建议任何希望跟踪已知漏洞以最小化安全风险的人加入此组。
- en: Use a Managed Kubernetes Service
  id: totrans-104
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用托管的 Kubernetes 服务
- en: One way to reduce the effort required to act on all of the advice in this chapter
    is to use one of the major public cloud managed Kubernetes services, such as EKS,
    AKS, GKE, or IKS. Using one of these services moves security from being 100% your
    own responsibility to being a shared responsibility model. Shared responsibility
    means there are many elements of security that the service includes by default,
    or can be easily configured to support, but that there are elements you still
    have to take responsibility for yourself in order to make the whole truly secure.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 减少执行本章建议所需工作的一种方式是使用主要的公共云托管Kubernetes服务之一，例如EKS、AKS、GKE或IKS。使用这些服务将安全性从完全由您自己负责减少到共享责任模型。共享责任意味着服务默认包含了许多安全元素，或者可以轻松配置以支持这些安全元素，但您仍然需要自己负责某些元素，以确保整体安全。
- en: The details vary depending on which public cloud service you are using, but
    there’s no doubt that all of them do significant heavy lifting, which reduces
    the effort required to secure the cluster compared to if you are installing and
    managing the cluster yourself. In addition, there are plenty of resources available
    from the public cloud providers and from third parties that detail what you need
    to do as part of the shared responsibility model to fully secure your cluster.
    For example, one of these resources is CIS Benchmarks, as discussed next.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 具体细节因您使用的公共云服务而异，但毫无疑问，所有这些服务都会做大量的重活，这降低了与自行安装和管理集群相比所需的安全工作量。此外，公共云提供商和第三方提供了大量资源，详细说明了作为共享责任模型的一部分，您需要采取哪些措施来全面确保您的集群安全。例如，其中一个资源就是CIS基准，接下来将讨论它。
- en: CIS Benchmarks
  id: totrans-107
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: CIS基准
- en: As discussed earlier in this chapter, CIS maintains free PDF guides with comprehensive
    configuration guidance to secure many of the most common operating systems. These
    guides, known as CIS Benchmarks, can be an invaluable resource to help you with
    host hardening.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 正如本章前面讨论的那样，CIS维护了免费的PDF指南，提供了对许多常见操作系统进行安全配置指导。这些指南称为CIS基准，可帮助您进行主机硬化，是一种无价的资源。
- en: In addition to helping with host hardening, there are also CIS Benchmarks for
    Kubernetes itself, including configuration guidance for many of the popular managed
    Kubernetes services, which can help you implement much of the guidance in this
    chapter. For example, the GKE CIS Benchmark includes guidance on ensuring the
    cluster is configured with autoupgrade of nodes, and for using managing Kubernetes
    authentication and RBAC with Google Groups. These guides are highly recommended
    resources to keep up to date with the latest practical advice on the steps required
    to secure Kubernetes clusters.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 除了帮助进行主机硬化外，还有针对Kubernetes本身的CIS基准，包括对许多流行的托管Kubernetes服务的配置指导，这可以帮助您实施本章指南中的大部分内容。例如，GKE
    CIS基准包括指导如何确保集群配置了节点的自动升级，并且使用Google Groups管理Kubernetes身份验证和RBAC。这些指南是高度推荐的资源，以获取关于如何确保Kubernetes集群安全所需步骤的最新实用建议。
- en: In addition to the guides themselves, there are third-party tools available
    that can assess the status of a running cluster against many of these benchmarks.
    One popular tool is kube-bench, an open source project originally created by the
    team at Aqua Security. Or if you prefer a more packaged solution, then many enterprise
    products have CIS Benchmark and other security compliance tooling and alerting
    built into their cluster management dashboards. Having these kinds of tools in
    place, ideally running automatically at regular intervals, can be valuable for
    verifying the security posture of a cluster and ensuring that careful security
    measures that might have been put in place at cluster creation time are not accidentally
    lost or compromised as the cluster is managed and updated over time.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 除了指南本身外，还有第三方工具可用来评估运行中的集群与许多这些基准的状态。一个流行的工具是kube-bench，这是一个开源项目，最初由Aqua Security团队创建。或者，如果您更喜欢一个更成熟的解决方案，那么许多企业产品在其集群管理仪表板中内置了CIS基准和其他安全合规工具和警报功能。在理想情况下，这些工具会定期自动运行，有助于验证集群的安全姿态，并确保在集群创建时可能采取的谨慎安全措施在管理和更新集群的过程中不会意外丢失或被破坏。
- en: Network Security
  id: totrans-111
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 网络安全
- en: 'When securely integrating the cluster with the surrounding infrastructure outside
    the scope of the cluster, network security is the primary consideration. There
    are two aspects to consider: how to protect the cluster from attack from outside
    the cluster and how to protect the infrastructure outside of the cluster from
    any compromised element inside the cluster. This applies at both the cluster workload
    level (i.e., Kubernetes pods) and the cluster infrastructure level (i.e., the
    Kubernetes control plane and the hosts on which the Kubernetes cluster is running).'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 当在集群与集群范围之外的周围基础设施安全地集成时，网络安全是首要考虑因素。有两个方面需要考虑：如何保护集群免受集群外部的攻击，以及如何保护集群内部任何受损元素对集群外部基础设施的影响。这适用于集群工作负载级别（即
    Kubernetes pod）和集群基础设施级别（即 Kubernetes 控制平面以及运行 Kubernetes 集群的主机）。
- en: The first thing to consider is whether or not the cluster needs to be accessible
    from the public internet, either directly (e.g., one or more nodes have public
    IP addresses) or indirectly (e.g., via a load balancer or similar that is reachable
    from the internet). If the cluster is accessible from the internet, then the number
    of attacks or probes from hackers is massively increased. So if there is not a
    strong requirement for the cluster to be accessible from the internet, then it
    is highly recommended to not allow any access at a routability level (i.e., ensuring
    there is no way of packets getting from the internet to the cluster). In an enterprise
    on-prem environment, this may equate to the choice of IP address ranges to use
    for the cluster and their routability within the enterprise network. If using
    a public cloud managed Kubernetes service, you may find these settings can be
    set only at cluster creation. For example, in GKE, whether the Kubernetes control
    plane is accessible from the internet can be set at cluster creation.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 首先要考虑的是集群是否需要从公共互联网访问，直接（例如，一个或多个节点具有公共 IP 地址）或间接（例如，通过可从互联网访问的负载均衡器或类似设备）。如果集群可以从互联网访问，那么黑客的攻击或探测活动数量将大幅增加。因此，如果集群不需要强制要求从互联网访问，强烈建议在可路由级别上不允许任何访问（即确保互联网上的数据包无法到达集群）。在企业内部环境中，这可能涉及选择用于集群的
    IP 地址范围及其在企业网络中的可路由性。如果使用公共云托管的 Kubernetes 服务，您可能会发现这些设置仅在集群创建时可以设置。例如，在 GKE 中，是否可以从互联网访问
    Kubernetes 控制平面可以在集群创建时设置。
- en: Network policy within the cluster is the next line of defense. Network policy
    can be used to restrict both workload and host communications to/from the cluster
    and the infrastructure outside of the cluster. It has the strong advantage of
    being workload aware (i.e., the ability to limit communication of groups of pods
    that make up an individual microservices) and being platform agnostic (i.e., the
    same techniques and policy language can be used in any environment, whether on-prem
    within the enterprise or in public cloud). Network policy is discussed in depth
    later in a dedicated chapter.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 集群内的网络策略是下一道防线。网络策略可用于限制集群与集群外部基础设施之间的工作负载和主机通信。它具有两大优势：既能意识到工作负载（即限制构成单个微服务的一组
    pod 的通信能力），又能在平台上不可知（即可以在任何环境中使用相同的技术和策略语言，无论是企业内部环境还是公共云中）。网络策略将在专门章节中深入讨论。
- en: Finally, it is highly recommended to use perimeter firewalls, or their cloud
    equivalents such as security groups, to restrict traffic to/from the cluster.
    In most cases these are not Kubernetes workload aware, so they don’t understand
    individual pods and are therefore usually limited in granularity to treating the
    whole of the cluster as a single entity. Even with this limitation they add value
    as part of a defense strategy, though on their own they are unlikely to be sufficient
    for any security-conscious enterprise.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，强烈建议使用周边防火墙，或其云等效物，如安全组，以限制流向/流出集群的流量。在大多数情况下，这些防火墙不了解 Kubernetes 工作负载，因此无法理解单个
    pod，并且通常仅能以集群整体的方式进行粒度控制。尽管存在这些限制，它们作为防御策略的一部分仍然具有价值，但仅靠它们本身可能不足以满足任何注重安全的企业需求。
- en: 'If stronger perimeter defense is desired, there are strategies and third-party
    tools that can make perimeter firewalls or their cloud equivalents more effective:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 如果需要更强的周边防御，有策略和第三方工具可以使周边防火墙或其云等效物更加有效：
- en: One approach is to designate a small number of specific nodes in the cluster
    as having a particular level of access to the rest of the network, which is not
    granted to the rest of the nodes in the cluster. Kubernetes taints can then be
    used to ensure that only workloads that need that special level of access are
    scheduled to those nodes. This way perimeter firewall rules can be set based on
    the IP addresses of the specific nodes to allow desired access, and all other
    nodes in the cluster are denied access outside the cluster.
  id: totrans-117
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 一种方法是将集群中的少数特定节点指定为具有特定访问级别的节点，而这种访问级别不授予集群中的其他节点。然后可以使用 Kubernetes 的污点（taints），确保只有需要该特殊访问级别的工作负载被调度到这些节点上。这样一来，可以基于特定节点的
    IP 地址设置外围防火墙规则，允许所需的访问，而集群中的所有其他节点则被拒绝在集群外访问。
- en: In an on-prem environment, some Kubernetes network plug-ins allow you to use
    routable pod IP addresses (nonoverlay networks) and control the IP address ranges
    that the group of pods backing a particular microservice use. This allows perimeter
    firewalls to act on IP address ranges in a similar way as they do with traditional
    non-Kubernetes workloads. For example, you need to pick a network plug-in that
    supports nonoverlay networks on-prem that are routable across the broader enterprise
    networks and that has flexible IP address management capabilities to facilitate
    such an approach.
  id: totrans-118
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在本地环境中，一些 Kubernetes 网络插件允许您使用可路由的 Pod IP 地址（非覆盖网络），并控制支持特定微服务的一组 Pod 使用的 IP
    地址范围。这使得外围防火墙可以根据 IP 地址范围执行类似于传统非 Kubernetes 工作负载的操作。例如，您需要选择一个在本地环境中支持可路由的非覆盖网络，并具有灵活
    IP 地址管理能力以促进此类方法的网络插件。
- en: 'A variation of the previous is useful in any environment where it is not practical
    to make pod IP addresses routable outside of the cluster (e.g., when using an
    overlay network). In this scenario, the network traffic from pods appears to come
    from the IP address of the node as it uses source network address translation
    (SNAT). In order to address this, you can use a Kubernetes network plug-in that
    supports fine-grained control of egress NAT gateways. The egress NAT gateway feature
    supported by some Kubernetes network plug-ins allows this behavior to be changed
    so that the egress traffic for a set of pods is routed via specific gateways within
    the cluster that perform the SNAT, so the traffic appears to be coming from the
    gateway, rather than from the node hosting the pod. Depending on the network plug-in
    being used, the gateways can be allocated to specific IP address ranges or to
    specific nodes, which in turn allows perimeter firewall rules to act more selectively
    than treating the whole of the cluster as a single entity. There are a few options
    that support this functionality: Red Hat’s OpenShift SDN, Nirmata, and Calico
    all support egress gateways.'
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在不实际将 Pod IP 地址路由到集群外部不可行的任何环境中（例如使用覆盖网络时），前述方法的变体非常有用。在这种情况下，从 Pod 发出的网络流量似乎来自于节点的
    IP 地址，因为它使用源网络地址转换（SNAT）。为了解决这个问题，可以使用支持出口 NAT 网关的 Kubernetes 网络插件。一些 Kubernetes
    网络插件支持出口 NAT 网关功能，允许更改此行为，使一组 Pod 的出口流量通过集群内执行 SNAT 的特定网关路由，因此流量似乎来自于网关，而不是托管
    Pod 的节点。根据使用的网络插件，网关可以分配给特定的 IP 地址范围或特定节点，从而允许外围防火墙规则比将整个集群视为单个实体更为选择性地执行。支持此功能的几个选项包括：Red
    Hat 的 OpenShift SDN、Nirmata 和 Calico 都支持出口网关功能。
- en: Finally, some firewalls support some plug-ins or third-party tools that allow
    the firewall to be more aware of Kubernetes workloads, for example, by automatically
    populating IP address lists within the firewall with pod IP addresses (or node
    IP addresses of the nodes hosting particular pods). Or in a cloud environment,
    there are automatic programming rules that allow security groups to selectively
    act on traffic to/from Kubernetes pods, rather than operating only at the node
    level. This integration is very important for your cluster to help complement
    the security provided by firewalls. There are several tools in the market that
    allow this type of integration. It is important to choose a tool that supports
    these integrations with major firewall vendors and is native to Kubernetes.
  id: totrans-120
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最终，一些防火墙支持一些插件或第三方工具，使防火墙能够更加了解 Kubernetes 工作负载，例如通过自动填充防火墙中的 IP 地址列表，其中包括 pod
    的 IP 地址（或者承载特定 pod 的节点的节点 IP 地址）。或者在云环境中，有自动编程规则允许安全组选择性地对进出 Kubernetes pod 的流量进行操作，而不仅仅是在节点级别操作。这种集成对于你的集群非常重要，可以帮助补充防火墙提供的安全保障。市场上有几种工具可以实现这种类型的集成。选择一个支持与主要防火墙供应商的集成并且对
    Kubernetes 本地化的工具非常重要。
- en: In the previous section we discussed the importance of network security and
    how you can use network security to secure access to your Kubernetes cluster from
    traffic originating outside the cluster and also how to control access for traffic
    originating from within the cluster destined to hosts outside the cluster.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 在前面的部分，我们讨论了网络安全的重要性，以及如何利用网络安全保护来自集群外部来源的流量访问你的 Kubernetes 集群，以及如何控制从集群内部源发往集群外部主机的访问。
- en: Conclusion
  id: totrans-122
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 结论
- en: In this chapter we discussed the following key concepts, which you should use
    to ensure you have a secure infrastructure for your Kubernetes cluster.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们讨论了以下关键概念，你应该使用这些概念来确保你的 Kubernetes 集群有一个安全的基础设施。
- en: You need to ensure that the host is running an operating system that is secure
    and free from critical vulnerabilities.
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你需要确保主机运行的操作系统是安全的，没有关键性漏洞。
- en: You need to deploy access controls on the host to control access to the host
    operating system and deploy controls for network traffic to and from the host.
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你需要在主机上部署访问控制以控制对主机操作系统的访问，并部署用于进出主机的网络流量的控制。
- en: You need to ensure a secure configuration for your Kubernetes cluster; securing
    the datastore and API server are key to ensuring you have a secure cluster configuration.
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你需要确保你的 Kubernetes 集群有一个安全的配置；保护数据存储和 API 服务器对于确保你拥有安全的集群配置至关重要。
- en: Finally, you need to deploy network security to control network traffic that
    originates from pods in the cluster and is destined to pods in the cluster.
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最后，你需要部署网络安全来控制源自集群内部 pod 并且要传输到集群内部 pod 的网络流量。
