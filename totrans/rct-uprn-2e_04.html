<!DOCTYPE html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.w3.org/2002/06/xhtml2/ http://www.w3.org/MarkUp/SCHEMA/xhtml2.xsd" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<link href="Styles/Style00.css" rel="stylesheet" type="text/css" />
<link href="Styles/Style01.css" rel="stylesheet" type="text/css" />

<style type="text/css">body{margin:1em;background-color:transparent!important;}#sbo-rt-content *{text-indent:0pt!important;}#sbo-rt-content .bq{margin-right:1em!important;}</style></head>
<body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 4. Functional Excel"><div class="chapter" id="ch4">
<h1><span class="label">Chapter 4. </span>Functional Excel</h1>


<p>Remember function components? At some point in <a data-type="xref" href="ch02.xhtml#ch2">Chapter 2</a>, as soon as <em>state</em> came into the picture, <a data-type="indexterm" data-primary="Excel component, function" id="ch4_term1"/>function components dropped out of the discussion. It’s time to bring them back.</p>






<section data-type="sect1" data-pdf-bookmark="A Quick Refresher: Function versus Class Components"><div class="sect1" id="idm45779445051728">
<h1>A Quick Refresher: Function versus Class Components</h1>

<p>In its <a data-type="indexterm" data-primary="class components" data-secondary="versus function components" data-secondary-sortas="function components" id="idm45779445050128"/><a data-type="indexterm" data-primary="components, custom" data-secondary="class" data-seealso="Excel component, class" id="idm45779445049040"/><a data-type="indexterm" data-primary="components, custom" data-secondary="class versus function for" id="idm45779445047888"/><a data-type="indexterm" data-primary="this.props object" id="idm45779445046976"/><a data-type="indexterm" data-primary="this.state object" id="idm45779445046304"/><a data-type="indexterm" data-primary="render() method/function" id="idm45779445045632"/>simplest form a class component only needs one <code>render()</code> method. This is where you build the UI, optionally using <code>this.props</code> and <code>this.state</code>:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">class</code> <code class="nx">Widget</code> <code class="kd">extends</code> <code class="nx">React</code><code class="p">.</code><code class="nx">Component</code> <code class="p">{</code>
  <code class="nx">render</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">let</code> <code class="nx">ui</code><code class="o">;</code>
    <code class="c1">// fun with this.props and this.state</code>
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">ui</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;;</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>In a <a data-type="indexterm" data-primary="components, custom" data-secondary="function" data-seealso="Excel component, function" id="idm45779445021504"/><a data-type="indexterm" data-primary="components, custom" data-secondary="properties (props) for" id="idm45779445020336"/><a data-type="indexterm" data-primary="function components" data-secondary="versus class components" data-secondary-sortas="class components" id="idm45779445019392"/><a data-type="indexterm" data-primary="function components" data-secondary="properties in" id="idm45779445018176"/><a data-type="indexterm" data-primary="properties (props)" data-secondary="custom components and" id="idm45779445017232"/>function component the whole component <em>is</em> the function and the UI is whatever the function returns. The props are passed to the function when the component is constructed:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">Widget</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">let</code> <code class="nx">ui</code><code class="o">;</code>
    <code class="c1">// fun with props but where's the state?</code>
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">ui</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;;</code>
<code class="p">}</code></pre>

<p>The usefulness of <a data-type="indexterm" data-primary="function components" data-secondary="hooks as necessary for" id="idm45779444965696"/><a data-type="indexterm" data-primary="hooks" data-secondary="as necessary for function components" data-secondary-sortas="necessary for function components" id="idm45779444964848"/><a data-type="indexterm" data-primary="stateless components" id="idm45779444963552"/>function components ended with React v16.8: you can use them only for components that don’t maintain state (<em>stateless</em> components). But with the addition of <em>hooks</em> in v16.8, it’s now possible to use function components everywhere. Through the rest of this chapter you’ll see how the <code>Excel</code> component from <a data-type="xref" href="ch03.xhtml#ch3">Chapter 3</a> can be implemented as a function component.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Rendering the Data"><div class="sect1" id="idm45779444960336">
<h1>Rendering the Data</h1>

<p>The first step is to <a data-type="indexterm" data-primary="Excel component, function" data-secondary="headers" id="ch4_term2"/><a data-type="indexterm" data-primary="headers, table" id="ch4_term3"/><a data-type="indexterm" data-primary="Excel component, function" data-secondary="rendering data for" id="ch4_term4"/><a data-type="indexterm" data-primary="rendering" data-secondary="of Excel function component" data-secondary-sortas="Excel function component" id="ch4_term5"/><a data-type="indexterm" data-primary="tables" data-secondary="headers of" id="ch4_term6"/>render the data passed to the component (<a data-type="xref" href="#FIG0401">Figure 4-1</a>). How the component is used doesn’t change. In other words, a <a data-type="indexterm" data-primary="properties (props)" data-secondary="initializing components with" id="idm45779444923584"/><a data-type="indexterm" data-primary="PropTypes" id="idm45779444922624"/><a data-type="indexterm" data-primary="data" data-secondary="initial" id="ch4_term7"/><a data-type="indexterm" data-primary="initialData prop" id="ch4_term8"/>developer using your component doesn’t need to know if it’s a class or a function component. The <code>initialData</code> and <code>headers</code> props look the same. Even the <code>propTypes</code> definitions are the same.</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">Excel</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// implement me...</code>
<code class="p">}</code>

<code class="nx">Excel</code><code class="p">.</code><code class="nx">propTypes</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">headers</code><code class="o">:</code> <code class="nx">PropTypes</code><code class="p">.</code><code class="nx">arrayOf</code><code class="p">(</code><code class="nx">PropTypes</code><code class="p">.</code><code class="nx">string</code><code class="p">)</code><code class="o">,</code>
  <code class="nx">initialData</code><code class="o">:</code> <code class="nx">PropTypes</code><code class="p">.</code><code class="nx">arrayOf</code><code class="p">(</code><code class="nx">PropTypes</code><code class="p">.</code><code class="nx">arrayOf</code><code class="p">(</code><code class="nx">PropTypes</code><code class="p">.</code><code class="nx">string</code><code class="p">))</code><code class="o">,</code>
<code class="p">};</code>

<code class="kd">const</code> <code class="nx">headers</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'Book'</code><code class="o">,</code> <code class="s1">'Author'</code><code class="o">,</code> <code class="s1">'Language'</code><code class="o">,</code> <code class="s1">'Published'</code><code class="o">,</code> <code class="s1">'Sales'</code><code class="p">];</code>

<code class="kd">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[</code>
  <code class="p">[</code>
    <code class="s1">'A Tale of Two Cities'</code><code class="o">,</code> <code class="s1">'Charles Dickens'</code><code class="o">,</code> <code class="c1">// ...</code>
  <code class="p">]</code><code class="o">,</code>
  <code class="c1">// ...</code>
<code class="p">];</code>

<code class="nx">ReactDOM</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">Excel</code> <code class="nx">headers</code><code class="o">=</code><code class="p">{</code><code class="nx">headers</code><code class="p">}</code> <code class="nx">initialData</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code> <code class="o">/&gt;,</code>
  <code class="nx">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'app'</code><code class="p">)</code><code class="o">,</code>
<code class="p">);</code></pre>

<p>Implementing the body of the function component is largely copy-pasting the body of the <code>render()</code> method of the class component:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">Excel</code><code class="p">({</code><code class="nx">headers</code><code class="o">,</code> <code class="nx">initialData</code><code class="p">})</code> <code class="p">{</code>
  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">table</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">thead</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code>
          <code class="p">{</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">title</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
            <code class="o">&lt;</code><code class="nx">th</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;</code>
          <code class="p">))}</code>
        <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
      <code class="o">&lt;/</code><code class="nx">thead</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">tbody</code><code class="o">&gt;</code>
        <code class="p">{</code><code class="nx">initialData</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
          <code class="o">&lt;</code><code class="nx">tr</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code>
            <code class="p">{</code><code class="nx">row</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">cell</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
              <code class="o">&lt;</code><code class="nx">td</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">cell</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">td</code><code class="o">&gt;</code>
            <code class="p">))}</code>
          <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
        <code class="p">))}</code>
      <code class="o">&lt;/</code><code class="nx">tbody</code><code class="o">&gt;</code>
    <code class="o">&lt;/</code><code class="nx">table</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code></pre>

<p>In the code above you can <a data-type="indexterm" data-primary="destructuring syntax" id="idm45779444774800"/><a data-type="indexterm" data-primary="props.headers" id="idm45779444774192"/><a data-type="indexterm" data-primary="props.initialData" id="idm45779444618352"/>see that instead of <code>function Excel(props){}</code> you can use destructuring syntax <code>function Excel({headers, initialData}){}</code> to save typing of <code>props.headers</code> and <code>props.initialData</code> later on.</p>

<figure><div id="FIG0401" class="figure">
<img src="Images/rur2_0401.png" alt="rur2 0401" width="600" height="201"/>
<h6><span class="label">Figure 4-1. </span>Rendering the table in a function component (see <em>04.01.fn.table.html</em>)</h6>
</div></figure>
</div></section>













<section data-type="sect1" data-pdf-bookmark="The State Hook"><div class="sect1" id="idm45779444613328">
<h1>The State Hook</h1>

<p>To be able <a data-type="indexterm" data-startref="ch4_term2" id="idm45779444611440"/><a data-type="indexterm" data-startref="ch4_term3" id="idm45779444610736"/><a data-type="indexterm" data-startref="ch4_term4" id="idm45779444610032"/><a data-type="indexterm" data-startref="ch4_term5" id="idm45779444609360"/><a data-type="indexterm" data-startref="ch4_term6" id="idm45779444608688"/><a data-type="indexterm" data-primary="components, custom" data-secondary="state and" id="idm45779444608016"/><a data-type="indexterm" data-primary="hooks" data-secondary="as necessary for function components" data-secondary-sortas="necessary for function components" id="idm45779444607072"/><a data-type="indexterm" data-primary="function components" data-secondary="hooks as necessary for" id="idm45779444605872"/><a data-type="indexterm" data-primary="hooks" data-secondary="defined" id="idm45779444604928"/>to maintain <em>state</em> in your function components, you need <em>hooks</em>. What’s a hook? It’s a function prefixed with the word <code>use*</code> that lets you use various React features, such as tools for managing state and component lifecycles. You can also create your own hooks. By the end of this chapter you’ll learn how to use several built-in hooks as well as write your own.</p>

<p>Let’s start with the <a data-type="indexterm" data-primary="React object" id="idm45779444601872"/><a data-type="indexterm" data-primary="Excel component, function" data-secondary="state hook for" id="ch4_term9"/><a data-type="indexterm" data-primary="hooks" data-secondary="useState()" id="ch4_term10"/><a data-type="indexterm" data-primary="state hooks" id="ch4_term11"/><a data-type="indexterm" data-primary="useState() hook" id="ch4_term12"/>state hook. It’s a function called <code>useState()</code> that’s available as a property of the <code>React</code> object (<code>React.useState()</code>). It takes one value, the initial value of a state variable (a piece of data you want to manage), and returns an array of two elements (a tuple). The first element is the state variable and the second is a function to change this variable. Let’s see an example.</p>

<p>In a <a data-type="indexterm" data-primary="class components" data-secondary="versus function components" data-secondary-sortas="function components" id="idm45779444594784"/><a data-type="indexterm" data-primary="components, custom" data-secondary="class" id="idm45779444593488"/><a data-type="indexterm" data-primary="components, custom" data-secondary="class versus function for" id="idm45779444592544"/><a data-type="indexterm" data-primary="function components" data-secondary="versus class components" data-secondary-sortas="class components" id="idm45779444591584"/><a data-type="indexterm" data-primary="constructor()" id="idm45779444590368"/><a data-type="indexterm" data-primary="state" data-secondary="in class components" data-secondary-sortas="class components" id="idm45779444589696"/>class component, in the <code>constructor()</code> you define the initial value like so:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="k">this</code><code class="p">.</code><code class="nx">state</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">data</code><code class="o">:</code> <code class="nx">initialData</code><code class="p">;</code>
<code class="p">};</code></pre>

<p>Later on, when you want to change the <code>data</code> state, you can instead do the following:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code>
  <code class="nx">data</code><code class="o">:</code> <code class="nx">newData</code><code class="p">,</code>
<code class="p">});</code></pre>

<p>In a function <a data-type="indexterm" data-primary="state" data-secondary="in  function components" data-secondary-sortas=" function components" id="idm45779444578800"/>component, you both define the initial state and get an updater <span class="keep-together">function</span>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">React</code><code class="p">.</code><code class="nx">useState</code><code class="p">(</code><code class="nx">initialData</code><code class="p">);</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Note the array <a data-type="indexterm" data-primary="destructuring syntax" id="idm45779444509904"/><a data-type="indexterm" data-primary="setData() variable" id="idm45779444509232"/>destructuring syntax where you assign the two elements of the array returned by <code>useState()</code> to two variables: <code>data</code> and <code>setData</code>. It’s a shorter and cleaner way to get the two return values, as opposed to, say:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">stateArray</code> <code class="o">=</code> <code class="nx">React</code><code class="p">.</code><code class="nx">useState</code><code class="p">(</code><code class="nx">initialData</code><code class="p">);</code>
<code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">stateArray</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
<code class="kr">const</code> <code class="nx">setData</code> <code class="o">=</code> <code class="nx">stateArray</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code></pre>
</div>

<p>For rendering, you can now use the variable <code>data</code>. When you want to update this variable, use:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">setData</code><code class="p">(</code><code class="nx">newData</code><code class="p">);</code></pre>

<p>Rewriting the component to use the state hook can now look like this:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">Excel</code><code class="p">({</code><code class="nx">headers</code><code class="o">,</code> <code class="nx">initialData</code><code class="p">})</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">data</code><code class="o">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">React</code><code class="p">.</code><code class="nx">useState</code><code class="p">(</code><code class="nx">initialData</code><code class="p">);</code>

  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">table</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">thead</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code>
          <code class="p">{</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">title</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
            <code class="o">&lt;</code><code class="nx">th</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;</code>
          <code class="p">))}</code>
        <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
      <code class="o">&lt;/</code><code class="nx">thead</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">tbody</code><code class="o">&gt;</code>
        <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
          <code class="o">&lt;</code><code class="nx">tr</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code>
            <code class="p">{</code><code class="nx">row</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">cell</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
              <code class="o">&lt;</code><code class="nx">td</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">cell</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">td</code><code class="o">&gt;</code>
            <code class="p">))}</code>
          <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
        <code class="p">))}</code>
      <code class="o">&lt;/</code><code class="nx">tbody</code><code class="o">&gt;</code>
    <code class="o">&lt;/</code><code class="nx">table</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code></pre>

<p>Even though this example (see <em>04.02.fn.table-state.html</em>) doesn’t use <code>setData()</code>, you can see how it’s using the <code>data</code> state. Let’s move on to sorting the table, where you’ll need the means to change the state.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Sorting the Table"><div class="sect1" id="idm45779444612704">
<h1>Sorting the Table</h1>

<p>In a class <a data-type="indexterm" data-primary="this.state object" id="idm45779444233072"/><a data-type="indexterm" data-primary="Excel component, function" data-secondary="sorting content of" id="ch4_term14"/><a data-type="indexterm" data-primary="sorting table data" id="ch4_term15"/>component, all the various bits of state go into the <code>this.state</code> object, a grab bag of often unrelated pieces of information. Using the state hook you can still do the same, but you can also decide to keep pieces of state in different variables. When it comes to sorting a table, the <code>data</code> contained in the table is one piece of information while the auxiliary sorting-specific information is another piece. In other words, you can use the state hook as many times as you want.</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">Excel</code><code class="p">({</code><code class="nx">headers</code><code class="p">,</code> <code class="nx">initialData</code><code class="p">})</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">React</code><code class="p">.</code><code class="nx">useState</code><code class="p">(</code><code class="nx">initialData</code><code class="p">);</code>
  <code class="kr">const</code> <code class="p">[</code><code class="nx">sorting</code><code class="p">,</code> <code class="nx">setSorting</code><code class="p">]</code> <code class="o">=</code> <code class="nx">React</code><code class="p">.</code><code class="nx">useState</code><code class="p">({</code>
    <code class="nx">column</code><code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
    <code class="nx">descending</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
  <code class="p">});</code>

  <code class="c1">// ....</code>
<code class="p">}</code></pre>

<p>The <code>data</code> is what you <a data-type="indexterm" data-startref="ch4_term7" id="idm45779444153280"/><a data-type="indexterm" data-startref="ch4_term8" id="idm45779444152576"/><a data-type="indexterm" data-startref="ch4_term9" id="idm45779444151872"/><a data-type="indexterm" data-startref="ch4_term10" id="idm45779444151200"/><a data-type="indexterm" data-startref="ch4_term11" id="idm45779444150528"/><a data-type="indexterm" data-startref="ch4_term12" id="idm45779444149856"/><a data-type="indexterm" data-primary="sorting object" id="idm45779444149184"/><a data-type="indexterm" data-primary="ascending/descending sorting" id="ch4_term16"/><a data-type="indexterm" data-primary="descending/ascending sorting" id="ch4_term17"/>display in the table; the <code>sorting</code> object is a separate concern. It’s about how you sort (ascending or descending) and by which column (title, author, etc.).</p>

<p>The function that does the <a data-type="indexterm" data-primary="inline functions" id="idm45779444145776"/><a data-type="indexterm" data-primary="sort() method/function" id="ch4_term13"/>sorting is now inline inside the <code>Excel</code> function:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">Excel</code><code class="p">({</code><code class="nx">headers</code><code class="o">,</code> <code class="nx">initialData</code><code class="p">})</code> <code class="p">{</code>

  <code class="c1">// ..</code>

  <code class="kd">function</code> <code class="nx">sort</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// implement me</code>
  <code class="p">}</code>

  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">table</code><code class="o">&gt;</code>
      <code class="p">{</code><code class="cm">/* ... */</code><code class="p">}</code>
    <code class="o">&lt;/</code><code class="nx">table</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code></pre>

<p>The <code>sort()</code> function figures out which column to sort by (using its index) and whether the sorting is descending:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">column</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">cellIndex</code><code class="p">;</code>
<code class="kr">const</code> <code class="nx">descending</code> <code class="o">=</code> <code class="nx">sorting</code><code class="p">.</code><code class="nx">column</code> <code class="o">===</code> <code class="nx">column</code> <code class="o">&amp;&amp;</code> <code class="o">!</code><code class="nx">sorting</code><code class="p">.</code><code class="nx">descending</code><code class="p">;</code></pre>

<p>Then, it <a data-type="indexterm" data-primary="cloning" data-secondary="for protection of this.state" data-secondary-sortas="protection of this.state" id="idm45779444064144"/><a data-type="indexterm" data-primary="copying data" id="idm45779444062912"/><a data-type="indexterm" data-primary="state" data-secondary="protection of" id="idm45779444062272"/>clones the <code>data</code> array because it’s still a bad idea to modify the state directly:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">dataCopy</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>A reminder <a data-type="indexterm" data-primary="clone() function" id="idm45779444058000"/><a data-type="indexterm" data-primary="JSON" id="idm45779444027440"/>that the <code>clone()</code> function is still the quick and dirty JSON encode/decode way of deep copying:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">o</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">return</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">o</code><code class="p">));</code>
<code class="p">}</code></pre>
</div>

<p>The actual sorting is the same as before:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">dataCopy</code><code class="p">.</code><code class="nx">sort</code><code class="p">((</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">===</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">])</code> <code class="p">{</code>
    <code class="k">return</code> <code class="mi">0</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="nx">descending</code>
    <code class="o">?</code> <code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">&lt;</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code>
      <code class="o">?</code> <code class="mi">1</code>
      <code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
    <code class="o">:</code> <code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">&gt;</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code>
      <code class="o">?</code> <code class="mi">1</code>
      <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
<code class="p">});</code></pre>

<p>And finally, the <code>sort()</code> function needs to update the two pieces of state with the new values:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">setData</code><code class="p">(</code><code class="nx">dataCopy</code><code class="p">);</code>
<code class="nx">setSorting</code><code class="p">({</code><code class="nx">column</code><code class="p">,</code> <code class="nx">descending</code><code class="p">});</code></pre>

<p>And that’s about it for the business of <a data-type="indexterm" data-startref="ch4_term13" id="idm45779443857968"/><a data-type="indexterm" data-primary="clicks, event handling with" id="idm45779443857472"/><a data-type="indexterm" data-primary="Excel component, function" data-secondary="headers" id="idm45779443856112"/><a data-type="indexterm" data-primary="headers, table" id="idm45779443855152"/><a data-type="indexterm" data-primary="tables" data-secondary="headers of" id="idm45779443854480"/>sorting. What’s left is just to update the UI (the return value of the <code>Excel()</code> function) to reflect which column is used for sorting and to handle clicks on any of the headers:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">thead</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="nx">sort</code><code class="p">}</code><code class="o">&gt;</code>
  <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code>
    <code class="p">{</code><code class="nx">headers</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">title</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">sorting</code><code class="p">.</code><code class="nx">column</code> <code class="o">===</code> <code class="nx">idx</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">title</code> <code class="o">+=</code> <code class="nx">sorting</code><code class="p">.</code><code class="nx">descending</code> <code class="o">?</code> <code class="s1">' \u2191'</code> <code class="o">:</code> <code class="s1">' \u2193'</code><code class="o">;</code>
      <code class="p">}</code>
      <code class="k">return</code> <code class="o">&lt;</code><code class="nx">th</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;;</code>
    <code class="p">})}</code>
  <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
<code class="o">&lt;/</code><code class="nx">thead</code><code class="o">&gt;</code></pre>

<p>You can see the result with the sorting arrow in <a data-type="xref" href="#FIG0402">Figure 4-2</a>.</p>

<p>You may have noticed another <a data-type="indexterm" data-primary="state hooks" id="idm45779443725344"/><a data-type="indexterm" data-primary="binding of method" id="idm45779443724448"/><a data-type="indexterm" data-primary="callbacks" data-secondary="with hooks" data-secondary-sortas="hooks" id="idm45779443723776"/><a data-type="indexterm" data-primary="Excel component, function" data-secondary="state hook for" id="idm45779443722560"/><a data-type="indexterm" data-primary="method, binding of" id="idm45779443721552"/><a data-type="indexterm" data-primary="constructor()" id="idm45779443720880"/><a data-type="indexterm" data-primary="this.sort object" id="idm45779443720208"/>nice thing about using state hooks: there’s no <span class="keep-together">need to bind</span> any callback functions like you do in the constructor of a class component. None of this <code>this.sort = this.sort.bind(this)</code> business. No <code>this</code>, no <span class="keep-together"><code>constructor()</code></span>. A function is all you need to define a <a data-type="indexterm" data-startref="ch4_term14" id="idm45779443716800"/><a data-type="indexterm" data-startref="ch4_term15" id="idm45779443716128"/><a data-type="indexterm" data-startref="ch4_term16" id="idm45779443715456"/><a data-type="indexterm" data-startref="ch4_term17" id="idm45779443714784"/>component.</p>

<figure><div id="FIG0402" class="figure">
<img src="Images/rur2_0402.png" alt="rur2 0402" width="600" height="201"/>
<h6><span class="label">Figure 4-2. </span>Sorting the data (see <em>04.03.fn.table-sort.html</em>)</h6>
</div></figure>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Editing Data"><div class="sect1" id="idm45779444233856">
<h1>Editing Data</h1>

<p>As you remember from <a data-type="xref" href="ch03.xhtml#ch3">Chapter 3</a>, the <a data-type="indexterm" data-primary="editing/tweaking table data" id="ch4_term18"/><a data-type="indexterm" data-primary="Excel component, function" data-secondary="editing content of" id="ch4_term19"/>editing functionality consists of the following steps:</p>
<ol>
<li>
<p>You double-click a table cell and it turns into a text input form.</p>
</li>
<li>
<p>You type in the text input form.</p>
</li>
<li>
<p>When done, you press Enter to submit the form.</p>
</li>

</ol>

<p>To keep track of this <a data-type="indexterm" data-primary="edit state object" id="idm45779443703760"/>process, let’s add an <code>edit</code> state object. It’s <code>null</code> when there’s no editing; otherwise, it stores the row and column indices of the cell being edited.</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="p">[</code><code class="nx">edit</code><code class="p">,</code> <code class="nx">setEdit</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code></pre>

<p>In the UI you <a data-type="indexterm" data-primary="event, form submit" id="ch4_term20"/><a data-type="indexterm" data-primary="form submit event" id="ch4_term21"/><a data-type="indexterm" data-primary="inputs" data-secondary="text fields for" id="ch4_term22"/><a data-type="indexterm" data-primary="submit event" id="ch4_term23"/><a data-type="indexterm" data-primary="text fields" id="ch4_term24"/><a data-type="indexterm" data-primary="clicks, event handling with" id="idm45779443696880"/><a data-type="indexterm" data-primary="double-clicks, event handling with" id="idm45779443696240"/><a data-type="indexterm" data-primary="onDoubleClick" id="idm45779443695552"/><a data-type="indexterm" data-primary="onSubmit event handler" id="idm45779443694880"/>need to handle double-clicks (<code>onDoubleClick={showEditor}</code>) and, if the user is editing, show a form. Otherwise, show only the data. When the user hits Enter, you trap the submit event (<code>onSubmit={save}</code>).</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="o">&lt;</code><code class="nx">tbody</code> <code class="nx">onDoubleClick</code><code class="o">=</code><code class="p">{</code><code class="nx">showEditor</code><code class="p">}</code><code class="o">&gt;</code>
  <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="o">,</code> <code class="nx">rowidx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">tr</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">rowidx</code><code class="p">}</code> <code class="nx">data</code><code class="o">-</code><code class="nx">row</code><code class="o">=</code><code class="p">{</code><code class="nx">rowidx</code><code class="p">}</code><code class="o">&gt;</code>
      <code class="p">{</code><code class="nx">row</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">cell</code><code class="o">,</code> <code class="nx">columnidx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code>
          <code class="nx">edit</code> <code class="o">&amp;&amp;</code>
          <code class="nx">edit</code><code class="p">.</code><code class="nx">row</code> <code class="o">===</code> <code class="nx">rowidx</code> <code class="o">&amp;&amp;</code>
          <code class="nx">edit</code><code class="p">.</code><code class="nx">column</code> <code class="o">===</code> <code class="nx">columnidx</code>
        <code class="p">)</code> <code class="p">{</code>
          <code class="nx">cell</code> <code class="o">=</code> <code class="p">(</code>
            <code class="o">&lt;</code><code class="nx">form</code> <code class="nx">onSubmit</code><code class="o">=</code><code class="p">{</code><code class="nx">save</code><code class="p">}</code><code class="o">&gt;</code>
              <code class="o">&lt;</code><code class="nx">input</code> <code class="nx">type</code><code class="o">=</code><code class="s2">"text"</code> <code class="nx">defaultValue</code><code class="o">=</code><code class="p">{</code><code class="nx">cell</code><code class="p">}</code> <code class="o">/&gt;</code>
            <code class="o">&lt;/</code><code class="nx">form</code><code class="o">&gt;</code>
          <code class="p">);</code>
        <code class="p">}</code>
        <code class="k">return</code> <code class="o">&lt;</code><code class="nx">td</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">columnidx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">cell</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">td</code><code class="o">&gt;;</code>
      <code class="p">})}</code>
    <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
  <code class="p">))}</code>
<code class="o">&lt;/</code><code class="nx">tbody</code><code class="o">&gt;</code></pre>

<p>There are two <a data-type="indexterm" data-primary="save() method/function" id="idm45779443692672"/><a data-type="indexterm" data-primary="showEditor() method/function" id="idm45779443692176"/><a data-type="indexterm" data-primary="setEdit() function" id="idm45779443496480"/>short functions left to be implemented: <code>showEditor()</code> and <code>save()</code>.</p>

<p>The <code>showEditor()</code> is invoked on double-clicking a cell in the table body. There you update the <code>edit</code> state (via <code>setEdit()</code>) with row and column indexes, so the rendering knows which cells to replace with a form.</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">showEditor</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">setEdit</code><code class="p">({</code>
    <code class="nx">row</code><code class="o">:</code> <code class="nf">parseInt</code><code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">parentNode</code><code class="p">.</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">row</code><code class="o">,</code> <code class="mi">10</code><code class="p">)</code><code class="o">,</code>
    <code class="nx">column</code><code class="o">:</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">cellIndex</code><code class="o">,</code>
  <code class="p">});</code>
<code class="p">}</code></pre>

<p>The <code>save()</code> function traps the form submit event, prevents the submission, and updates the <code>data</code> state with the new value in the cell being edited. It also calls 
<span class="keep-together"><code>setEdit()</code></span> passing <code>null</code> as the new edit state, which means the editing is complete.</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">save</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">e</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>
  <code class="kd">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">firstChild</code><code class="o">;</code>
  <code class="kd">const</code> <code class="nx">dataCopy</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
  <code class="nx">dataCopy</code><code class="p">[</code><code class="nx">edit</code><code class="p">.</code><code class="nx">row</code><code class="p">][</code><code class="nx">edit</code><code class="p">.</code><code class="nx">column</code><code class="p">]</code> <code class="o">=</code> <code class="nx">input</code><code class="p">.</code><code class="nx">value</code><code class="o">;</code>
  <code class="nx">setEdit</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
  <code class="nx">setData</code><code class="p">(</code><code class="nx">dataCopy</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>And with this, the editing functionality is finished. Consult <em>04.04.fn.table-edit.html</em> in the book’s repo for the complete <a data-type="indexterm" data-startref="ch4_term18" id="idm45779443345040"/><a data-type="indexterm" data-startref="ch4_term19" id="idm45779443344432"/><a data-type="indexterm" data-startref="ch4_term20" id="idm45779443343824"/><a data-type="indexterm" data-startref="ch4_term21" id="idm45779443343152"/><a data-type="indexterm" data-startref="ch4_term22" id="idm45779443342480"/><a data-type="indexterm" data-startref="ch4_term23" id="idm45779443341808"/><a data-type="indexterm" data-startref="ch4_term24" id="idm45779443341136"/>code.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Searching"><div class="sect1" id="idm45779443711584">
<h1>Searching</h1>

<p>Searching/filtering the <a data-type="indexterm" data-primary="searching table data" id="idm45779443339024"/><a data-type="indexterm" data-primary="filtering" data-secondary="of table data" data-secondary-sortas="table data" id="idm45779443338320"/><a data-type="indexterm" data-primary="Excel component, function" data-secondary="searching/filtering content of" id="idm45779443337104"/>data doesn’t pose any new challenges when it comes to React and hooks. You can try to implement it yourself and reference the implementation in <em>04.05.fn.table-search.html</em> in the book’s repo.</p>

<p>You’ll need two <a data-type="indexterm" data-primary="boolean search signifier" id="idm45779443334992"/>new pieces of state:</p>

<ul>
<li>
<p>The boolean <code>search</code> to signify whether the user is filtering or just looking at the data</p>
</li>
<li>
<p>The copy <a data-type="indexterm" data-primary="preSearchData" id="idm45779443331696"/><a data-type="indexterm" data-primary="copying data" id="idm45779443330960"/>of <code>data</code> as <code>preSearchData</code>, because now <code>data</code> becomes a filtered subset of all data</p>
</li>
</ul>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">const</code> <code class="p">[</code><code class="nx">search</code><code class="o">,</code> <code class="nx">setSearch</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>
<code class="kd">const</code> <code class="p">[</code><code class="nx">preSearchData</code><code class="o">,</code> <code class="nx">setPreSearchData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code></pre>

<p>You need to take care of keeping <code>preSearchData</code> updated, since <code>data</code> (the filtered subset) can be updated when the user is editing while also filtering. Consult <a data-type="xref" href="ch03.xhtml#ch3">Chapter 3</a> as a refresher.</p>

<p>Let’s move on to <a data-type="indexterm" data-primary="replay feature" id="idm45779443307328"/><a data-type="indexterm" data-primary="Excel component, function" data-secondary="replay feature with" id="idm45779443306592"/>implementing the replay feature, which provides a chance to become familiar with two new concepts:</p>

<ul>
<li>
<p>Using lifecycle hooks</p>
</li>
<li>
<p>Writing your own hooks</p>
</li>
</ul>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Lifecycles in a World of Hooks"><div class="sect1" id="idm45779443303088">
<h1>Lifecycles in a World of Hooks</h1>

<p>The replay feature in <a data-type="xref" href="ch03.xhtml#ch3">Chapter 3</a> uses <a data-type="indexterm" data-primary="Excel component, function" data-secondary="lifecycle hooks for" id="ch4_term25"/><a data-type="indexterm" data-primary="componentDidMount() method" id="idm45779443271280"/><a data-type="indexterm" data-primary="componentWillUnmount() method" id="idm45779443270592"/><a data-type="indexterm" data-primary="components, custom" data-secondary="lifecycle methods with" id="idm45779443269904"/><a data-type="indexterm" data-primary="lifecycle methods" id="idm45779443268960"/>two lifecycle methods of the <code>Excel</code> class: 
<span class="keep-together"><code>componentDidMount()</code></span> and <code>componentWillUnmount()</code>.</p>








<section data-type="sect2" data-pdf-bookmark="Troubles with Lifecycle Methods"><div class="sect2" id="idm45779443266480">
<h2>Troubles with Lifecycle Methods</h2>

<p>If you <a data-type="indexterm" data-primary="fetching table data" id="idm45779443264960"/>revisit the <em>03.14.table-fetch.html</em> example, you may notice each of those has two tasks, unrelated to each other:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">componentDidMount</code><code class="p">()</code> <code class="p">{</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'keydown'</code><code class="p">,</code> <code class="k">this</code><code class="p">.</code><code class="nx">keydownHandler</code><code class="p">);</code>
  <code class="nx">fetch</code><code class="p">(</code><code class="s1">'https://www...'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="cm">/*...*/</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">then</code><code class="p">((</code><code class="nx">initialData</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="cm">/*...*/</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">setState</code><code class="p">({</code><code class="nx">data</code><code class="p">});</code>
    <code class="p">});</code>
<code class="p">}</code>

<code class="nx">componentWillUnmount</code><code class="p">()</code> <code class="p">{</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">removeEventListener</code><code class="p">(</code><code class="s1">'keydown'</code><code class="p">,</code> <code class="k">this</code><code class="p">.</code><code class="nx">keydownHandler</code><code class="p">);</code>
  <code class="nx">clearInterval</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">replayID</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>In <code>componentDidMount()</code> you set <a data-type="indexterm" data-primary="setInterval() function" id="idm45779443170912"/><a data-type="indexterm" data-primary="keydown event listener" id="idm45779443170304"/>up a <code>keydown</code> listener to initiate the replay and also fetch data from a server. In <code>componentWillUnmount()</code> you remove the <code>keydown</code> listener and also clean up a <code>setInterval()</code> ID. This illustrates two problems related to the use of lifecycle methods in class components (which are resolved when using hooks):</p>
<dl>
<dt>Unrelated tasks are implemented together</dt>
<dd>
<p>For example, performing data fetching and setting up <a data-type="indexterm" data-primary="event listeners" id="idm45779443166192"/>event listeners in one place. This makes the lifecycle methods grow in length while performing the unrelated tasks. In simple components this is fine, but in larger ones you need to resort to code comments or moving pieces of code to various other functions, so you can split up the unrelated tasks and make the code more readable.</p>
</dd>
<dt>Related tasks are spread out</dt>
<dd>
<p>For example, consider adding and removing the same event listener. As the lifecycle methods grow in size, it’s harder to consider the separate pieces of the same concern at a glance because they simply don’t fit in the same screen of code when you read it later.</p>
</dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="useEffect()"><div class="sect2" id="idm45779443163088">
<h2>useEffect()</h2>

<p>The built-in <a data-type="indexterm" data-primary="hooks" data-secondary="useEffect()" id="ch4_term29"/><a data-type="indexterm" data-primary="useEffect() hook" id="ch4_term30"/>hook that replaces both of the lifecycle methods above is <code>React.use​Ef⁠fect()</code>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The word “effect” stands <a data-type="indexterm" data-primary="components" data-secondary="side effect tasks in" id="idm45779443157808"/><a data-type="indexterm" data-primary="side effects of tasks" id="ch4_term27"/><a data-type="indexterm" data-primary="tasks, side effects of" id="ch4_term28"/>for “side effect,” meaning a type of work that is unrelated to the main task but happens around the same time. The main task of any React component is to render something based on state and props. But rendering at the same time (in the same function) alongside a few side jobs (such as fetching data from a server or setting up event listeners) may be necessary.</p>

<p>In the <code>Excel</code> component, for example, setting up a <code>keydown</code> handler is a side effect of the main task of rendering data in a table.</p>
</div>

<p>The hook <code>useEffect()</code> takes two <a data-type="indexterm" data-primary="dependencies" data-secondary="variables in" id="idm45779443152144"/><a data-type="indexterm" data-primary="callbacks" data-secondary="with hooks" data-secondary-sortas="hooks" id="ch4_term26"/>arguments:</p>

<ul>
<li>
<p>A callback function that is called by React at the opportune time</p>
</li>
<li>
<p>An optional array of <em>dependencies</em></p>
</li>
</ul>

<p>The list of dependencies contains variables that will be checked before the callback is invoked and dictate whether the callback should even be invoked.</p>

<ul>
<li>
<p>If the values of the dependent variables have not changed, there’s no need to invoke the callback.</p>
</li>
<li>
<p>If the list of dependencies is an empty array, the callback is called only once, similarly to <code>componentDidMount()</code>.</p>
</li>
<li>
<p>If the dependencies are omitted, the callback is invoked on every rerender</p>
</li>
</ul>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// logs only if `data` or `headers` have changed</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">());</code>
<code class="p">},</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">headers</code><code class="p">]);</code>

<code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// logs once, after initial render, like `componentDidMount()`</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">());</code>
<code class="p">},</code> <code class="p">[]);</code>

<code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// called on every re-render</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">());</code>
<code class="p">},</code> <code class="cm">/* no dependencies here */</code><code class="p">);</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Cleaning Up Side Effects"><div class="sect2" id="idm45779443141136">
<h2>Cleaning Up Side Effects</h2>

<p>Now you know how to use hooks to <a data-type="indexterm" data-primary="componentDidMount() method" id="idm45779443057200"/><a data-type="indexterm" data-primary="componentWillUnmount() method" id="idm45779443056592"/><a data-type="indexterm" data-primary="cleanup work" id="ch4_term31"/>accomplish what <code>componentDidMount()</code> has to offer in class components. But what about an equivalent to <code>componentWill​Un⁠mount()</code>? For this task, you use the return value from the callback function you pass to <code>useEffect()</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// logs once, after initial render, like `componentDidMount()`</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">());</code>
  <code class="k">return</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// log when the component will be removed form the DOM</code>
    <code class="c1">// like `componentDidMount()`</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">());</code>
  <code class="p">};</code>
<code class="p">},</code> <code class="p">[]);</code></pre>

<p>Let’s see a more complete example (<em>04.06.useEffect.html</em> in the repo):</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">Example</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Rendering &lt;Example/&gt;'</code><code class="o">,</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">());</code>
    <code class="k">return</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="c1">// log when the component will be removed form the DOM</code>
      <code class="c1">// like `componentDidMount()`</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Removing &lt;Example/&gt;'</code><code class="o">,</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">());</code>
    <code class="p">};</code>
  <code class="p">}</code><code class="o">,</code> <code class="p">[]);</code>
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">I</code> <code class="nx">am</code> <code class="nx">an</code> <code class="nx">example</code> <code class="nx">child</code> <code class="nx">component</code><code class="p">.</code><code class="o">&lt;/</code><code class="nx">p</code><code class="o">&gt;;</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">ExampleParent</code><code class="p">()</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">visible</code><code class="o">,</code> <code class="nx">setVisible</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>
  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="nx">setVisible</code><code class="p">(</code><code class="o">!</code><code class="nx">visible</code><code class="p">)}</code><code class="o">&gt;</code>
        <code class="nx">Hello</code> <code class="nx">there</code><code class="o">,</code> <code class="nx">press</code> <code class="nx">me</code> <code class="p">{</code><code class="nx">visible</code> <code class="o">?</code> <code class="s1">'again'</code> <code class="o">:</code> <code class="s1">''</code><code class="p">}</code>
      <code class="o">&lt;/</code><code class="nx">button</code><code class="o">&gt;</code>
      <code class="p">{</code><code class="nx">visible</code> <code class="o">?</code> <code class="o">&lt;</code><code class="nx">Example</code> <code class="o">/&gt;</code> <code class="o">:</code> <code class="kc">null</code><code class="p">}</code>
    <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code></pre>

<p>Clicking the button once renders a child component and clicking it again removes it. As you can see in <a data-type="xref" href="#FIG0403">Figure 4-3</a>, the return <a data-type="indexterm" data-primary="DOM (Document Object Model)" data-secondary="useEffect() and" id="idm45779443027344"/>value of <code>useEffect()</code> (which is a function) is invoked when the component is removed from the DOM.</p>

<figure><div id="FIG0403" class="figure">
<img src="Images/rur2_0403.png" alt="rur2 0403" width="600" height="201"/>
<h6><span class="label">Figure 4-3. </span>Using <code>useEffect</code></h6>
</div></figure>

<p>Note that the <a data-type="indexterm" data-primary="dependency array" id="idm45779442820336"/>cleanup (a.k.a. <em>teardown</em>) function was called when the component is removed from the DOM because the dependency array is empty. If there were a value in the dependency array, the teardown function would be called whenever the dependency value <a data-type="indexterm" data-startref="ch4_term26" id="idm45779442818816"/><a data-type="indexterm" data-startref="ch4_term27" id="idm45779442818112"/><a data-type="indexterm" data-startref="ch4_term28" id="idm45779442817440"/><a data-type="indexterm" data-startref="ch4_term31" id="idm45779442816768"/>changes.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Trouble-Free Lifecycles"><div class="sect2" id="idm45779442815840">
<h2>Trouble-Free Lifecycles</h2>

<p>If you consider again the <a data-type="indexterm" data-primary="event listeners" id="idm45779442814336"/>use case of setting up and clearing event listeners, it can be implemented like so:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kd">function</code> <code class="nx">keydownHandler</code><code class="p">()</code> <code class="p">{</code>
    <code class="c1">// do things</code>
  <code class="p">}</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'keydown'</code><code class="p">,</code> <code class="nx">keydownHandler</code><code class="p">);</code>
  <code class="k">return</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nb">document</code><code class="p">.</code><code class="nx">removeEventListener</code><code class="p">(</code><code class="s1">'keydown'</code><code class="p">,</code> <code class="nx">keydownHandler</code><code class="p">);</code>
  <code class="p">};</code>
<code class="p">},</code> <code class="p">[]);</code></pre>

<p>The pattern above solves the <a data-type="indexterm" data-primary="components, custom" data-secondary="lifecycle methods with" id="idm45779442811872"/><a data-type="indexterm" data-primary="lifecycle methods" id="idm45779442786128"/>second problem with class-based lifecycle methods mentioned previously—the problem of spreading related tasks all around the component. Here you can see how using hooks allows you to have the handler function, its setup, and its removal, all in the same place.</p>

<p>As for the the first problem (having unrelated tasks in the same place), this is solved by having multiple <code>useEffect</code> calls, each dedicated to a specific task. Similarly to how you can have separate pieces of state instead of one grab-bag object, you can also have separate <code>useEffect</code> calls, each addressing a separate concern, as opposed to a single class method that needs to take care of everything:</p>

<pre data-type="programlisting" data-code-language="javascript" class="pagebreak-before"><code class="kd">function</code> <code class="nx">Example</code><code class="p">()</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>

  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// fetch() and then call setData()</code>
  <code class="p">});</code>

  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// event handlers</code>
  <code class="p">});</code>

  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/div&gt;;</code>
<code class="p">}</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="useLayoutEffect()"><div class="sect2" id="idm45779442745472">
<h2>useLayoutEffect()</h2>

<p>To wrap up the <a data-type="indexterm" data-primary="hooks" data-secondary="useLayoutEffect()" id="ch4_term32"/><a data-type="indexterm" data-primary="useLayoutEffect() hook" id="ch4_term33"/>discussion of <code>useEffect()</code> let’s consider another built-in hook called <code>useLayoutEffect()</code>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>There are just a few built-in hooks, so don’t worry about having to memorize a long list of new APIs.</p>
</div>

<p><code>useLayoutEffect()</code> works like <code>useEffect()</code>, the only <a data-type="indexterm" data-primary="DOM (Document Object Model)" data-secondary="useEffect() and" id="idm45779442672160"/>difference being that it’s invoked before React is done painting all the DOM nodes of a render. In general, you should use <code>useEffect()</code> unless you need to measure something on the page (maybe dimensions of a rendered component or scrolling position after an update) and then rerender based on this information. When none of this is required, <code>useEffect()</code> is better as it’s asynchronous and also indicates to the reader of your code that DOM mutations are not relevant to your component.</p>

<p>Because <code>useLayoutEffect()</code> is <a data-type="indexterm" data-primary="flicker, rerender with" id="ch4_term34"/><a data-type="indexterm" data-primary="rendering" data-secondary="flicker with" id="ch4_term35"/><a data-type="indexterm" data-primary="tables" data-secondary="resizing" id="ch4_term36"/>called sooner, you can recalculate and rerender and the user sees only the last render. Otherwise, they see the initial render first, then the second render. Depending on how complicated the layout use, users may perceive a flicker between the two renders.</p>

<p>The next example (<em>04.07.useLayoutEffect.html</em> in the repo) renders a long table with random cell widths (just to make it harder for the browser). Then the width of the table is set in an effect hook.</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">Example</code><code class="p">({</code><code class="nx">layout</code><code class="p">})</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">layout</code> <code class="o">===</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="kc">null</code><code class="o">;</code>
  <code class="p">}</code>

  <code class="k">if</code> <code class="p">(</code><code class="nx">layout</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">useLayoutEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="kd">const</code> <code class="nx">table</code> <code class="o">=</code> <code class="nx">document</code><code class="p">.</code><code class="nx">getElementsByTagName</code><code class="p">(</code><code class="s1">'table'</code><code class="p">)[</code><code class="mi">0</code><code class="p">];</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">table</code><code class="p">.</code><code class="nx">offsetWidth</code><code class="p">);</code>
      <code class="nx">table</code><code class="p">.</code><code class="nx">width</code> <code class="o">=</code> <code class="s1">'250px'</code><code class="o">;</code>
    <code class="p">}</code><code class="o">,</code> <code class="p">[]);</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="kd">const</code> <code class="nx">table</code> <code class="o">=</code> <code class="nx">document</code><code class="p">.</code><code class="nx">getElementsByTagName</code><code class="p">(</code><code class="s1">'table'</code><code class="p">)[</code><code class="mi">0</code><code class="p">];</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">table</code><code class="p">.</code><code class="nx">offsetWidth</code><code class="p">);</code>
      <code class="nx">table</code><code class="p">.</code><code class="nx">width</code> <code class="o">=</code> <code class="s1">'250px'</code><code class="o">;</code>
    <code class="p">}</code><code class="o">,</code> <code class="p">[]);</code>
  <code class="p">}</code>

  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">table</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">thead</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">tr</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">th</code><code class="o">&gt;</code><code class="nx">Random</code><code class="o">&lt;/</code><code class="nx">th</code><code class="o">&gt;</code>
        <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
      <code class="o">&lt;/</code><code class="nx">thead</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">tbody</code><code class="o">&gt;</code>
        <code class="p">{</code><code class="nb">Array</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nb">Array</code><code class="p">(</code><code class="mi">10000</code><code class="p">)).</code><code class="nx">map</code><code class="p">((</code><code class="nx">_</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
          <code class="o">&lt;</code><code class="nx">tr</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code>
            <code class="o">&lt;</code><code class="nx">td</code> <code class="nx">width</code><code class="o">=</code><code class="p">{</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">800</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()}</code><code class="o">&lt;/</code><code class="nx">td</code><code class="o">&gt;</code>
          <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
        <code class="p">))}</code>
      <code class="o">&lt;/</code><code class="nx">tbody</code><code class="o">&gt;</code>
    <code class="o">&lt;/</code><code class="nx">table</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">ExampleParent</code><code class="p">()</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">layout</code><code class="o">,</code> <code class="nx">setLayout</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="nx">setLayout</code><code class="p">(</code><code class="kc">false</code><code class="p">)}</code><code class="o">&gt;</code><code class="nx">useEffect</code><code class="o">&lt;/</code><code class="nx">button</code><code class="o">&gt;</code><code class="p">{</code><code class="s1">' '</code><code class="p">}</code>
      <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="nx">setLayout</code><code class="p">(</code><code class="kc">true</code><code class="p">)}</code><code class="o">&gt;</code><code class="nx">useLayoutEffect</code><code class="o">&lt;/</code><code class="nx">button</code><code class="o">&gt;</code><code class="p">{</code><code class="s1">' '</code><code class="p">}</code>
      <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="nx">setLayout</code><code class="p">(</code><code class="kc">null</code><code class="p">)}</code><code class="o">&gt;</code><code class="nx">clear</code><code class="o">&lt;/</code><code class="nx">button</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">Example</code> <code class="nx">layout</code><code class="o">=</code><code class="p">{</code><code class="nx">layout</code><code class="p">}</code> <code class="o">/&gt;</code>
    <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
  <code class="p">);</code>
<code class="p">}</code></pre>

<p>Depending on whether you trigger the <code>useEffect()</code> or <code>useLayoutEffect()</code> path, you may see a flicker as the table is being resized from its random value (around 600 px) to the hardcoded 250 px (see <a data-type="xref" href="#FIG0404">Figure 4-4</a>).</p>

<figure><div id="FIG0404" class="figure">
<img src="Images/rur2_0404.png" alt="rur2 0404" width="600" height="202"/>
<h6><span class="label">Figure 4-4. </span>Flickering rerender</h6>
</div></figure>

<p>Note that in both cases, you’re able to get the geometry of the table (e.g., <code>table​.off⁠setWidth</code>), so if you need this only for information purposes and you’re not going to rerender, you’re better off with the asynchronous <code>useEffect()</code>. <code>useLayout​Ef⁠fect()</code> should be reserved for avoiding flicker in cases where you need to act (rerender) based on something you measure, for example, positioning a fancy tooltip component based on the size of the element it’s <a data-type="indexterm" data-startref="ch4_term25" id="idm45779442307968"/><a data-type="indexterm" data-startref="ch4_term29" id="idm45779442307264"/><a data-type="indexterm" data-startref="ch4_term30" id="idm45779442306592"/><a data-type="indexterm" data-startref="ch4_term32" id="idm45779442305920"/><a data-type="indexterm" data-startref="ch4_term33" id="idm45779442305248"/><a data-type="indexterm" data-startref="ch4_term34" id="idm45779442304576"/><a data-type="indexterm" data-startref="ch4_term35" id="idm45779442303904"/><a data-type="indexterm" data-startref="ch4_term36" id="idm45779442303232"/>pointing to.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="A Custom Hook"><div class="sect1" id="idm45779442678256">
<h1>A Custom Hook</h1>

<p>Let’s go back to <code>Excel</code> and see how to go about implementing the replay feature. In the <a data-type="indexterm" data-primary="class components" data-secondary="versus function components" data-secondary-sortas="function components" id="idm45779442300128"/><a data-type="indexterm" data-primary="components, custom" data-secondary="class" id="idm45779442298912"/><a data-type="indexterm" data-primary="components, custom" data-secondary="class versus function for" id="idm45779442297968"/><a data-type="indexterm" data-primary="components, custom" data-secondary="function" id="idm45779442297056"/><a data-type="indexterm" data-primary="function components" data-secondary="versus class components" data-secondary-sortas="class components" id="idm45779442296112"/><a data-type="indexterm" data-primary="logSetState() method" id="idm45779442294896"/><a data-type="indexterm" data-primary="this.setState() method/function" id="idm45779442294224"/><a data-type="indexterm" data-primary="hooks" data-secondary="useState()" id="ch4_term37"/><a data-type="indexterm" data-primary="state hooks" id="ch4_term38"/><a data-type="indexterm" data-primary="useState() hook" id="ch4_term39"/><a data-type="indexterm" data-primary="custom hooks" id="ch4_term40"/><a data-type="indexterm" data-primary="Excel component, function" data-secondary="custom hooks for" id="ch4_term41"/><a data-type="indexterm" data-primary="hooks" data-secondary="customization of" id="ch4_term42"/><a data-type="indexterm" data-primary="hooks" data-secondary="useLoggedState()" id="ch4_term43"/><a data-type="indexterm" data-primary="logging state of components" id="ch4_term44"/><a data-type="indexterm" data-primary="useLoggedState() hook" id="ch4_term45"/><a data-type="indexterm" data-primary="Excel component, function" data-secondary="replay feature with" id="ch4_term46"/><a data-type="indexterm" data-primary="replay feature" id="ch4_term47"/>case of class components, it was necessary to create a <code>logSetState()</code> and then replace all <code>this.setState()</code> calls with <code>this.logSetState()</code>. With function components you can replace all calls to the <code>useState()</code> hook with <code>useLoggedState()</code>. This is a bit more convenient since there are just a few calls (for every independent bit of state) and they are all at the top of the function.</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="c1">// before</code>
<code class="kd">function</code> <code class="nx">Excel</code><code class="p">({</code><code class="nx">headers</code><code class="o">,</code> <code class="nx">initialData</code><code class="p">})</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">data</code><code class="o">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">initialData</code><code class="p">);</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">edit</code><code class="o">,</code> <code class="nx">setEdit</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
  <code class="c1">// ... etc</code>
<code class="p">}</code>

<code class="c1">// after</code>
<code class="kd">function</code> <code class="nx">Excel</code><code class="p">({</code><code class="nx">headers</code><code class="o">,</code> <code class="nx">initialData</code><code class="p">})</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">data</code><code class="o">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useLoggedState</code><code class="p">(</code><code class="nx">initialData</code><code class="o">,</code> <code class="kc">true</code><code class="p">);</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">edit</code><code class="o">,</code> <code class="nx">setEdit</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useLoggedState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
  <code class="c1">// ... etc</code>
<code class="p">}</code></pre>

<p>There is no built-in <code>useLoggedState()</code> hook, but that’s OK. You can create your own <em>custom hooks</em>.
Like the built-in hooks, a custom hook is just a function that starts with <code>use*()</code>. Here’s an example:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">useLoggedState</code><code class="p">(</code><code class="nx">initialValue</code><code class="o">,</code> <code class="nx">isData</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>The signature of the hook can be anything you want. In this case, <a data-type="indexterm" data-primary="isData argument" id="idm45779442162112"/>there’s an additional <code>isData</code> argument. Its purpose is to help differentiate data state versus non-data state. In the class component example from <a data-type="xref" href="ch03.xhtml#ch3">Chapter 3</a> all the state is a single object, but here several pieces of the state are present. In the replay feature, the main goal is to show the data changes and then show that all the supporting info (sorting, descending, etc.) is secondary. Since the replay is updated every second, it won’t be as fun to watch the supporting data change individually; the replay would be too slow. So let’s have a main log (<code>dataLog</code> array) and an auxiliary one (<code>auxLog</code> array). In addition, it is useful to include a flag indicating whether the state changes because of user interaction or (automatically) during replay:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="nx">let</code> <code class="nx">dataLog</code> <code class="o">=</code> <code class="p">[];</code>
<code class="nx">let</code> <code class="nx">auxLog</code> <code class="o">=</code> <code class="p">[];</code>
<code class="nx">let</code> <code class="nx">isReplaying</code> <code class="o">=</code> <code class="kc">false</code><code class="o">;</code></pre>

<p>The custom hook’s goal is not to interfere with the regular state updates, so it delegates this responsibility to the original <code>useState</code>. The goal is to log the state together with a reference to the function that knows how to update this state during replay. The function looks something like this:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">useLoggedState</code><code class="p">(</code><code class="nx">initialValue</code><code class="o">,</code> <code class="nx">isData</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">state</code><code class="o">,</code> <code class="nx">setState</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">initialValue</code><code class="p">);</code>

  <code class="c1">// fun here...</code>

  <code class="k">return</code> <code class="p">[</code><code class="nx">state</code><code class="o">,</code> <code class="nx">setState</code><code class="p">];</code>
<code class="p">}</code></pre>

<p>The code above is using the default <code>useState</code>. But now you have the references to a piece of state and the means to update it. You need to log that. Let’s benefit <a data-type="indexterm" data-primary="hooks" data-secondary="useEffect()" id="ch4_term48"/><a data-type="indexterm" data-primary="useEffect() hook" id="ch4_term49"/>from the <code>useEffect()</code> hook here:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="kd">function</code> <code class="nx">useLoggedState</code><code class="p">(</code><code class="nx">initialValue</code><code class="o">,</code> <code class="nx">isData</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">const</code> <code class="p">[</code><code class="nx">state</code><code class="o">,</code> <code class="nx">setState</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">initialValue</code><code class="p">);</code>

  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// todo</code>
  <code class="p">}</code><code class="o">,</code> <code class="p">[</code><code class="nx">state</code><code class="p">]);</code>

  <code class="k">return</code> <code class="p">[</code><code class="nx">state</code><code class="o">,</code> <code class="nx">setState</code><code class="p">];</code>
<code class="p">}</code></pre>

<p>This method ensures that the logging happens only when the value of <code>state</code> changes. The <code>useLoggedState()</code> function may be called a number of times during various rerenders, but you can ignore these calls unless they involve a change in an interesting piece of <a data-type="indexterm" data-startref="ch4_term37" id="idm45779442009136"/><a data-type="indexterm" data-startref="ch4_term38" id="idm45779441972016"/><a data-type="indexterm" data-startref="ch4_term39" id="idm45779441971408"/>state.</p>

<p>In the <a data-type="indexterm" data-primary="callbacks" data-secondary="with hooks" data-secondary-sortas="hooks" id="idm45779441970288"/>callback of <code>useEffect()</code> you:</p>

<ul>
<li>
<p>Don’t do anything if the user is replaying.</p>
</li>
<li>
<p>Log every change to the data state to <code>dataLog</code>.</p>
</li>
<li>
<p>Log every change to supporting data to <code>auxLog</code>, indexed by the associated change in data.</p>
</li>
</ul>

<pre data-type="programlisting" data-code-language="actionscript"><code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">isReplaying</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code><code class="o">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">isData</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">dataLog</code><code class="p">.</code><code class="nx">push</code><code class="p">([</code><code class="nx">clone</code><code class="p">(</code><code class="nx">state</code><code class="p">)</code><code class="o">,</code> <code class="nx">setState</code><code class="p">]);</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="kd">const</code> <code class="nx">idx</code> <code class="o">=</code> <code class="nx">dataLog</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="o">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">auxLog</code><code class="p">[</code><code class="nx">idx</code><code class="p">])</code> <code class="p">{</code>
      <code class="nx">auxLog</code><code class="p">[</code><code class="nx">idx</code><code class="p">]</code> <code class="o">=</code> <code class="p">[];</code>
    <code class="p">}</code>
    <code class="nx">auxLog</code><code class="p">[</code><code class="nx">idx</code><code class="p">].</code><code class="nx">push</code><code class="p">([</code><code class="nx">state</code><code class="o">,</code> <code class="nx">setState</code><code class="p">]);</code>
  <code class="p">}</code>
<code class="p">}</code><code class="o">,</code> <code class="p">[</code><code class="nx">state</code><code class="p">]);</code></pre>

<p>Why do custom hooks exist? They help you isolate and neatly package a piece of logic that is used in a component and often shared between components. The custom <code>useLoggedState()</code> above can be dropped into any component that can benefit from logging its state. Additionally, custom hooks can call other hooks, which regular (non-hook and non-component) functions cannot.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Wrapping up the Replay"><div class="sect1" id="idm45779442302096">
<h1>Wrapping up the Replay</h1>

<p>Now that you have a custom hook that logs the changes to various bits of state, it’s time to <a data-type="indexterm" data-primary="replay() function" id="idm45779441850784"/>plug in the replay feature.</p>

<p>The <code>replay()</code> function is not an exciting aspect of the React discussion, but it <a data-type="indexterm" data-primary="interval IDs" id="idm45779441849104"/><a data-type="indexterm" data-primary="IDs" data-secondary="interval" id="idm45779441848400"/>sets up an interval ID. You need that ID to clean up the interval in the event that <code>Excel</code> gets removed from the DOM while replaying. In the replay, the data changes are replayed every second, while the auxiliary ones are flushed together:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">replay</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">isReplaying</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
  <code class="kd">let</code> <code class="nx">idx</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="nx">replayID</code> <code class="o">=</code> <code class="nx">setInterval</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">fn</code><code class="p">]</code> <code class="o">=</code> <code class="nx">dataLog</code><code class="p">[</code><code class="nx">idx</code><code class="p">];</code>
    <code class="nx">fn</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
    <code class="nx">auxLog</code><code class="p">[</code><code class="nx">idx</code><code class="p">]</code> <code class="o">&amp;&amp;</code>
      <code class="nx">auxLog</code><code class="p">[</code><code class="nx">idx</code><code class="p">].</code><code class="nx">forEach</code><code class="p">((</code><code class="nx">log</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">fn</code><code class="p">]</code> <code class="o">=</code> <code class="nx">log</code><code class="p">;</code>
        <code class="nx">fn</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
      <code class="p">});</code>
    <code class="nx">idx</code><code class="o">++</code><code class="p">;</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">idx</code> <code class="o">&gt;</code> <code class="nx">dataLog</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">isReplaying</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
      <code class="nx">clearInterval</code><code class="p">(</code><code class="nx">replayID</code><code class="p">);</code>
      <code class="k">return</code><code class="p">;</code>
    <code class="p">}</code>
  <code class="p">},</code> <code class="mi">1000</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>The final bit of plumbing is to set up an effects hook. After <code>Excel</code> renders, the hook is responsible for setting up listeners that monitor the particular. combination of keys to start the replay show. This is <a data-type="indexterm" data-primary="cleanup work" id="idm45779441845728"/>also the place to clean up after the component is destroyed.</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kd">function</code> <code class="nx">keydownHandler</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">altKey</code> <code class="o">&amp;&amp;</code> <code class="nx">e</code><code class="p">.</code><code class="nx">shiftKey</code> <code class="o">&amp;&amp;</code> <code class="nx">e</code><code class="p">.</code><code class="nx">keyCode</code> <code class="o">===</code> <code class="mi">82</code><code class="p">)</code> <code class="p">{</code>
      <code class="c1">// ALT+SHIFT+R(eplay)</code>
      <code class="nx">replay</code><code class="p">();</code>
    <code class="p">}</code>
  <code class="p">}</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'keydown'</code><code class="p">,</code> <code class="nx">keydownHandler</code><code class="p">);</code>
  <code class="k">return</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nb">document</code><code class="p">.</code><code class="nx">removeEventListener</code><code class="p">(</code><code class="s1">'keydown'</code><code class="p">,</code> <code class="nx">keydownHandler</code><code class="p">);</code>
    <code class="nx">clearInterval</code><code class="p">(</code><code class="nx">replayID</code><code class="p">);</code>
    <code class="nx">dataLog</code> <code class="o">=</code> <code class="p">[];</code>
    <code class="nx">auxLog</code> <code class="o">=</code> <code class="p">[];</code>
  <code class="p">};</code>
<code class="p">},</code> <code class="p">[]);</code></pre>

<p>To see the code in its entirety, check out <em>04.08.fn.table-replay.html</em> in the book’s <a data-type="indexterm" data-startref="ch4_term46" id="idm45779441700240"/><a data-type="indexterm" data-startref="ch4_term47" id="idm45779441598240"/><a data-type="indexterm" data-startref="ch4_term48" id="idm45779441597712"/><a data-type="indexterm" data-startref="ch4_term49" id="idm45779441597040"/>repo.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="useReducer"><div class="sect1" id="idm45779441596112">
<h1>useReducer</h1>

<p>Let’s wrap up the chapter with <a data-type="indexterm" data-primary="hooks" data-secondary="useState()" id="idm45779441594384"/><a data-type="indexterm" data-primary="state hooks" id="idm45779441593408"/><a data-type="indexterm" data-primary="useState() hook" id="idm45779441592736"/><a data-type="indexterm" data-primary="hooks" data-secondary="useReducer()" id="ch4_term50"/><a data-type="indexterm" data-primary="useReducer() hook" id="ch4_term51"/><a data-type="indexterm" data-primary="Excel component, function" data-secondary="reducer hook and" id="ch4_term52"/><a data-type="indexterm" data-primary="reducers" data-secondary="Excel function" id="ch4_term53"/>one more built-in hook called <code>useReducer()</code>. Using a reducer is an alternative to <code>useState()</code>. Instead of various parts of the component calling changing state, all changes can be handled in a single location.</p>

<p>A reducer is <a data-type="indexterm" data-primary="JavaScript" data-secondary="reducers in" id="idm45779441586064"/>just a JavaScript function that takes two inputs—the old state and an action—and returns the new state. Think of the action as something that has happened in the app, maybe a click, data fetch, or timeout. Something has happened and it requires a change.
All three of the variables (new state, old state, action) can be of any type, though most commonly they are objects.</p>








<section data-type="sect2" class="pagebreak-before less_space" data-pdf-bookmark="Reducer Functions"><div class="sect2" id="idm45779441584416">
<h2>Reducer Functions</h2>

<p>A reducer function in its simplest form looks like this:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">myReducer</code><code class="p">(</code><code class="nx">oldState</code><code class="p">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">newState</code> <code class="o">=</code> <code class="p">{};</code>
  <code class="c1">// do something with `oldState` and `action`</code>
  <code class="k">return</code> <code class="nx">newState</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Imagine that the reducer function is responsible for making sense of the reality when something happens in the world. The world is a <code>mess</code>, then an <code>event</code> happens. The function that should <code>makeSense()</code> of the world reconciles the mess with the new event and reduces all the complexity to a nice state or <code>order</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">makeSense</code><code class="p">(</code><code class="nx">mess</code><code class="p">,</code> <code class="nx">event</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">order</code> <code class="o">=</code> <code class="p">{};</code>
  <code class="c1">// do something with mess and event</code>
  <code class="k">return</code> <code class="nx">order</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Another analogy comes from the world of cooking. Some sauces and soups are called <em>reductions</em> too, produced by the process of <em>reduction</em> (thickening, intensifying the flavor). The initial state is a pot of water, then various actions (boiling, adding ingredients, stirring) alter the state of the contents of the pot with every action.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Actions"><div class="sect2" id="idm45779441523184">
<h2>Actions</h2>

<p>The reducer function can <a data-type="indexterm" data-primary="component-dispatch-action-reducer flow" id="ch4_term54"/><a data-type="indexterm" data-primary="dispatched events, reducer for" id="ch4_term55"/><a data-type="indexterm" data-primary="event object" id="idm45779441519520"/><a data-type="indexterm" data-primary="action handlers" id="idm45779441518848"/>take anything (a string, an object), but a common implementation is an <code>event</code> object with:</p>

<ul>
<li>
<p>A <code>type</code> (e.g., <code>click</code> in the DOM world)</p>
</li>
<li>
<p>Optionally, some <code>payload</code> of other information about the event</p>
</li>
</ul>

<p>Actions are then “dispatched.” When the <a data-type="indexterm" data-primary="hooks" data-secondary="useState()" id="idm45779441486272"/><a data-type="indexterm" data-primary="state hooks" id="idm45779441485424"/><a data-type="indexterm" data-primary="useState() hook" id="idm45779441484784"/>action is dispatched, the appropriate reducer function is called by React with the current state and your new event (action).</p>

<p>With <code>useState</code> you have:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">initialData</code><code class="p">);</code></pre>

<p>Which can be replaced with the reducer:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">dispatch</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useReducer</code><code class="p">(</code><code class="nx">myReducer</code><code class="p">,</code> <code class="nx">initialData</code><code class="p">);</code></pre>

<p>The <code>data</code> is still used the same way to render the component. But when something happens, <a data-type="indexterm" data-primary="dispatch() function" id="idm45779441435120"/>instead of doing a bit of work followed by a call to <code>setData()</code>, you call the <code>dispatch()</code> function returned by <code>useReducer()</code>. From there the reducer takes over and returns the new version of <code>data</code>. There’s no other function to call to set the new state; the new <code>data</code> is used by React to rerender the component.</p>

<p><a data-type="xref" href="#FIG0405">Figure 4-5</a> shows a diagram of this process.</p>

<figure><div id="FIG0405" class="figure">
<img src="Images/rur2_0405.png" alt="rur2 0405" width="600" height="342"/>
<h6><span class="label">Figure 4-5. </span>Component-dispatch-action-reducer flow</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="An Example Reducer"><div class="sect2" id="idm45779441522592">
<h2>An Example Reducer</h2>

<p>Let’s see a quick, isolated <a data-type="indexterm" data-primary="Excel component, function" data-secondary="reducer hook examples of" id="ch4_term57"/><a data-type="indexterm" data-primary="reducers" data-secondary="examples of" id="ch4_term58"/>example of using a reducer. Say you <a data-type="indexterm" data-primary="random data example" id="ch4_term56"/>have a table of random data together with buttons that can either refresh the data or change the table’s background and foreground colors to random ones (as depicted in <a data-type="xref" href="#FIG0406">Figure 4-6</a>).</p>

<p>Initially, there’s no data and black and white colors are used as defaults:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">initialState</code> <code class="o">=</code> <code class="p">{</code><code class="nx">data</code><code class="o">:</code> <code class="p">[],</code> <code class="nx">color</code><code class="o">:</code> <code class="s1">'black'</code><code class="p">,</code> <code class="nx">background</code><code class="o">:</code> <code class="s1">'white'</code><code class="p">};</code></pre>

<p>The reducer is initialized at the top of the component <code>&lt;RandomData&gt;</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">RandomData</code><code class="p">()</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">[</code><code class="nx">state</code><code class="p">,</code> <code class="nx">dispatch</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useReducer</code><code class="p">(</code><code class="nx">myReducer</code><code class="p">,</code> <code class="nx">initialState</code><code class="p">);</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>Here, we’re back to <code>state</code> being a grab-bag object of various state pieces (but that doesn’t need to be the case). The rest of the component is business-as-usual, rendering based on <code>state</code>, with one difference. Where before you’d <a data-type="indexterm" data-primary="onClick handler" id="idm45779441342592"/><a data-type="indexterm" data-primary="dispatch() function" id="idm45779441342064"/>have a button’s <code>onClick</code> handler be a function that updates the state, now all handlers just call 
<span class="keep-together"><code>dispatch()</code></span>, sending information about the event:</p>

<pre data-type="programlisting" data-code-language="actionscript"><code class="k">return</code> <code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"toolbar"</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="p">({</code><code class="nx">type</code><code class="o">:</code> <code class="s1">'newdata'</code><code class="p">})}</code><code class="o">&gt;</code>
        <code class="nx">Get</code> <code class="nx">data</code>
      <code class="o">&lt;/</code><code class="nx">button</code><code class="o">&gt;</code><code class="p">{</code><code class="s1">' '</code><code class="p">}</code>
      <code class="o">&lt;</code><code class="nx">button</code>
        <code class="nx">onClick</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="p">({</code><code class="nx">type</code><code class="o">:</code> <code class="s1">'recolor'</code><code class="o">,</code> <code class="nx">payload</code><code class="o">:</code> <code class="p">{</code><code class="nx">what</code><code class="o">:</code> <code class="s1">'color'</code><code class="p">}})}</code><code class="o">&gt;</code>
        <code class="nx">Recolor</code> <code class="nx">text</code>
      <code class="o">&lt;/</code><code class="nx">button</code><code class="o">&gt;</code><code class="p">{</code><code class="s1">' '</code><code class="p">}</code>
      <code class="o">&lt;</code><code class="nx">button</code>
        <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code>
          <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">dispatch</code><code class="p">({</code><code class="nx">type</code><code class="o">:</code> <code class="s1">'recolor'</code><code class="o">,</code> <code class="nx">payload</code><code class="o">:</code> <code class="p">{</code><code class="nx">what</code><code class="o">:</code> <code class="s1">'background'</code><code class="p">}})</code>
      <code class="p">}</code><code class="o">&gt;</code>
        <code class="nx">Recolor</code> <code class="nx">background</code>
      <code class="o">&lt;/</code><code class="nx">button</code><code class="o">&gt;</code>
    <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
    <code class="o">&lt;</code><code class="nx">table</code> <code class="nx">style</code><code class="o">=</code><code class="p">{{</code><code class="nx">color</code><code class="o">,</code> <code class="nx">background</code><code class="p">}}</code><code class="o">&gt;</code>
      <code class="o">&lt;</code><code class="nx">tbody</code><code class="o">&gt;</code>
        <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">row</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
          <code class="o">&lt;</code><code class="nx">tr</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code>
            <code class="p">{</code><code class="nx">row</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">cell</code><code class="o">,</code> <code class="nx">idx</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>
              <code class="o">&lt;</code><code class="nx">td</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">idx</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">cell</code><code class="p">}</code><code class="o">&lt;/</code><code class="nx">td</code><code class="o">&gt;</code>
            <code class="p">))}</code>
          <code class="o">&lt;/</code><code class="nx">tr</code><code class="o">&gt;</code>
        <code class="p">))}</code>
      <code class="o">&lt;/</code><code class="nx">tbody</code><code class="o">&gt;</code>
    <code class="o">&lt;/</code><code class="nx">table</code><code class="o">&gt;</code>
  <code class="o">&lt;/</code><code class="nx">div</code><code class="o">&gt;</code>
<code class="p">);</code></pre>

<figure><div id="FIG0406" class="figure">
<img src="Images/rur2_0406.png" alt="rur2 0406" width="600" height="506"/>
<h6><span class="label">Figure 4-6. </span><code>&lt;RandomData/&gt;</code> component (<em>04.09.random-table-reducer.html</em>)</h6>
</div></figure>

<p>Every dispatched <a data-type="indexterm" data-primary="properties (props)" data-secondary="with reducer" data-secondary-sortas="reducer" id="idm45779441086128"/><a data-type="indexterm" data-primary="event object" id="idm45779441084848"/><a data-type="indexterm" data-primary="action handlers" id="idm45779441084176"/>event/action object has a <code>type</code> property, so the reducer function can identify what needs to be done. There may or may not be a <code>payload</code> specifying further details of the event.</p>

<p>Finally, the reducer. It has a <a data-type="indexterm" data-primary="if/else statements" id="idm45779441081936"/>number of <code>if</code>/<code>else</code> statements (or a <code>switch</code>, if that’s your preference) that check what type of event it was sent. Then the data is manipulated according to the action and a new version of the state is returned:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">myReducer</code><code class="p">(</code><code class="nx">oldState</code><code class="p">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">newState</code> <code class="o">=</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">oldState</code><code class="p">);</code>

  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'recolor'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">newState</code><code class="p">[</code><code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">.</code><code class="nx">what</code><code class="p">]</code> <code class="o">=</code>
      <code class="sb">`rgb(</code><code class="si">${</code><code class="nx">rand</code><code class="p">(</code><code class="mi">256</code><code class="p">)</code><code class="si">}</code><code class="sb">,</code><code class="si">${</code><code class="nx">rand</code><code class="p">(</code><code class="mi">256</code><code class="p">)</code><code class="si">}</code><code class="sb">,</code><code class="si">${</code><code class="nx">rand</code><code class="p">(</code><code class="mi">256</code><code class="p">)</code><code class="si">}</code><code class="sb">)`</code><code class="p">;</code>
  <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'newdata'</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[];</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">10</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code> <code class="o">=</code> <code class="p">[];</code>
      <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">j</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">j</code> <code class="o">&lt;</code> <code class="mi">10</code><code class="p">;</code> <code class="nx">j</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">data</code><code class="p">[</code><code class="nx">i</code><code class="p">][</code><code class="nx">j</code><code class="p">]</code> <code class="o">=</code> <code class="nx">rand</code><code class="p">(</code><code class="mi">10000</code><code class="p">);</code>
      <code class="p">}</code>
    <code class="p">}</code>
    <code class="nx">newState</code><code class="p">.</code><code class="nx">data</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="nx">newState</code><code class="p">;</code>
<code class="p">}</code>

<code class="c1">// couple of helpers</code>
<code class="kd">function</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">o</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">return</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">o</code><code class="p">));</code>
<code class="p">}</code>
<code class="kd">function</code> <code class="nx">rand</code><code class="p">(</code><code class="nx">max</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="nx">max</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>Note how <a data-type="indexterm" data-startref="ch4_term54" id="idm45779441078816"/><a data-type="indexterm" data-primary="clone() function" id="idm45779441078208"/><a data-type="indexterm" data-primary="cloning" data-secondary="reducer and" id="idm45779441077536"/><a data-type="indexterm" data-primary="reducers" data-secondary="cloning and" id="idm45779440838688"/><a data-type="indexterm" data-primary="hooks" data-secondary="useState()" id="idm45779440837776"/><a data-type="indexterm" data-primary="useState() hook" id="idm45779440836832"/><a data-type="indexterm" data-primary="state hooks" id="idm45779440836160"/>the old state is being cloned using the quick-and-dirty <code>clone()</code> you already know. With <code>useState()/setState()</code> this wasn’t strictly necessary in a lot of cases. You could often get by with modifying an existing variable and passing it to <code>setState()</code>. But here if you don’t clone and merely modify the same object in memory, React will see old and new state as pointing to the same object and will skip the render, thinking nothing has changed. You can try for yourself: remove the call to <code>clone()</code> and observe that the rerendering is not <a data-type="indexterm" data-startref="ch4_term56" id="idm45779440833264"/>happening.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Unit Testing Reducers"><div class="sect2" id="idm45779441428656">
<h2>Unit Testing Reducers</h2>

<p>Switching to <code>useReducer()</code> for state <a data-type="indexterm" data-primary="testing, reducers for" id="idm45779440830672"/><a data-type="indexterm" data-primary="unit testing, reducers for" id="idm45779440829936"/><a data-type="indexterm" data-primary="reducers" data-secondary="unit testing with" id="idm45779440829248"/>management makes it much easier to write unit tests. You don’t need to set up the component and its properties and state. You don’t need to get a browser involved or find another way to simulate click events. You don’t even need to get React involved at all. To test the state logic, all you need to do is pass both the old state and an action to the reducer function and check if the desired new state is returned. This is <a data-type="indexterm" data-primary="JavaScript" data-secondary="reducers in" id="idm45779440827728"/>pure JavaScript: two objects in, one object out. The unit tests should not be much more complicated than testing the canonical example:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">add</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">return</code> <code class="nx">a</code> <code class="o">+</code> <code class="nx">b</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>There’s a discussion on testing later in the book, but just to give you a taste, a sample test could look like so:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">initialState</code> <code class="o">=</code> <code class="p">{</code><code class="nx">data</code><code class="o">:</code> <code class="p">[],</code> <code class="nx">color</code><code class="o">:</code> <code class="s1">'black'</code><code class="p">,</code> <code class="nx">background</code><code class="o">:</code> <code class="s1">'white'</code><code class="p">};</code>

<code class="nx">it</code><code class="p">(</code><code class="s1">'produces a 10x10 array'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">{</code><code class="nx">data</code><code class="p">}</code> <code class="o">=</code> <code class="nx">myReducer</code><code class="p">(</code><code class="nx">initialState</code><code class="p">,</code> <code class="p">{</code><code class="nx">type</code><code class="o">:</code> <code class="s1">'newdata'</code><code class="p">});</code>
  <code class="nx">expect</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">).</code><code class="nx">toEqual</code><code class="p">(</code><code class="mi">10</code><code class="p">);</code>
  <code class="nx">expect</code><code class="p">(</code><code class="nx">data</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">length</code><code class="p">).</code><code class="nx">toEqual</code><code class="p">(</code><code class="mi">10</code><code class="p">);</code>
<code class="p">});</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Excel Component with a Reducer"><div class="sect1" id="idm45779440816512">
<h1>Excel Component with a Reducer</h1>

<p>For one last example of using reducers, let’s see how you can switch from 
<span class="keep-together"><code>useState()</code></span> to <code>useReducer()</code> in the <code>Excel</code> component.</p>

<p>In the example from the previous section, the state managed by the reducer was again an object of unrelated data. It doesn’t have to be this way. You can have multiple reducers to separate your concerns. You can even mix and match <code>useState()</code> with <code>useReducer()</code>. Let’s try this with <code>Excel</code>.</p>

<p>Previously the <code>data</code> in the table was managed by <code>useState()</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">initialData</code><code class="p">);</code>
<code class="c1">// ...</code>
<code class="kr">const</code> <code class="p">[</code><code class="nx">edit</code><code class="p">,</code> <code class="nx">setEdit</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
<code class="kr">const</code> <code class="p">[</code><code class="nx">search</code><code class="p">,</code> <code class="nx">setSearch</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code></pre>

<p>Switching to <code>useReducer()</code> for managing <code>data</code> while leaving the rest untouched looks like the following:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">dispatch</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useReducer</code><code class="p">(</code><code class="nx">reducer</code><code class="p">,</code> <code class="nx">initialData</code><code class="p">);</code>
<code class="c1">// ...</code>
<code class="kr">const</code> <code class="p">[</code><code class="nx">edit</code><code class="p">,</code> <code class="nx">setEdit</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
<code class="kr">const</code> <code class="p">[</code><code class="nx">search</code><code class="p">,</code> <code class="nx">setSearch</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code></pre>

<p>Since <code>data</code> is the <a data-type="indexterm" data-startref="ch4_term50" id="idm45779440594096"/><a data-type="indexterm" data-startref="ch4_term51" id="idm45779440593456"/>same, there’s no need to change anything in the rendering section. Changes are required only in the <a data-type="indexterm" data-primary="filter() method/function" id="idm45779440557584"/><a data-type="indexterm" data-primary="action handlers" id="idm45779440556928"/>action handlers. For example, <code>filter()</code> is used to do the filtering and call <code>setData()</code>:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">filter</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">needle</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">value</code><code class="p">.</code><code class="nx">toLowerCase</code><code class="p">();</code>
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">needle</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">setData</code><code class="p">(</code><code class="nx">preSearchData</code><code class="p">);</code>
    <code class="k">return</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="kr">const</code> <code class="nx">idx</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">idx</code><code class="p">;</code>
  <code class="kr">const</code> <code class="nx">searchdata</code> <code class="o">=</code> <code class="nx">preSearchData</code><code class="p">.</code><code class="nx">filter</code><code class="p">((</code><code class="nx">row</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">row</code><code class="p">[</code><code class="nx">idx</code><code class="p">].</code><code class="nx">toString</code><code class="p">().</code><code class="nx">toLowerCase</code><code class="p">().</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">needle</code><code class="p">)</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
  <code class="p">});</code>
  <code class="nx">setData</code><code class="p">(</code><code class="nx">searchdata</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>The rewritten version dispatches an action instead. The event has a <code>type</code> of “search” and some additional payload (what is the user searching for, and where?):</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">filter</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">needle</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
  <code class="kr">const</code> <code class="nx">column</code> <code class="o">=</code> <code class="nx">e</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">dataset</code><code class="p">.</code><code class="nx">idx</code><code class="p">;</code>
  <code class="nx">dispatch</code><code class="p">({</code>
    <code class="nx">type</code><code class="o">:</code> <code class="s1">'search'</code><code class="p">,</code>
    <code class="nx">payload</code><code class="o">:</code> <code class="p">{</code><code class="nx">needle</code><code class="p">,</code> <code class="nx">column</code><code class="p">},</code>
  <code class="p">});</code>
  <code class="nx">setEdit</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>Another <a data-type="indexterm" data-primary="toggleSearch() function" id="idm45779440438208"/>example would be toggling the search fields:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// before</code>
<code class="kd">function</code> <code class="nx">toggleSearch</code><code class="p">()</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">search</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">setData</code><code class="p">(</code><code class="nx">preSearchData</code><code class="p">);</code>
    <code class="nx">setSearch</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>
    <code class="nx">setPreSearchData</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="nx">setPreSearchData</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
    <code class="nx">setSearch</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code>


<code class="c1">// after</code>
<code class="kd">function</code> <code class="nx">toggleSearch</code><code class="p">()</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">search</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">dispatch</code><code class="p">({</code><code class="nx">type</code><code class="o">:</code> <code class="s1">'startSearching'</code><code class="p">});</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="nx">dispatch</code><code class="p">({</code><code class="nx">type</code><code class="o">:</code> <code class="s1">'doneSearching'</code><code class="p">});</code>
  <code class="p">}</code>
  <code class="nx">setSearch</code><code class="p">(</code><code class="o">!</code><code class="nx">search</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>Here you can <a data-type="indexterm" data-primary="setSearch() function" id="idm45779440358528"/>see the mix of <code>setSearch()</code> and <code>dispatch()</code> to manage the state. The 
<span class="keep-together"><code>!search</code></span> toggle is a flag for the UI to show or hide input boxes, while the <span class="keep-together"><code>dispatch()</code></span> is for managing the data.</p>

<p>Finally, let’s take a <a data-type="indexterm" data-primary="reducer() function" id="idm45779440250816"/><a data-type="indexterm" data-primary="if/else statements" id="idm45779440250112"/>look at the the <code>reducer()</code> function. This is where all the data filtering and manipulation happens now. It’s again a series of <code>if</code>/<code>else</code> blocks, each handling a different <a data-type="indexterm" data-startref="ch4_term1" id="idm45779440247920"/><a data-type="indexterm" data-startref="ch4_term52" id="idm45779440247216"/><a data-type="indexterm" data-startref="ch4_term53" id="idm45779440246544"/><a data-type="indexterm" data-startref="ch4_term55" id="idm45779440245872"/><a data-type="indexterm" data-startref="ch4_term57" id="idm45779440245200"/><a data-type="indexterm" data-startref="ch4_term58" id="idm45779440244528"/>action type:</p>

<pre data-type="programlisting" data-code-language="javascript" class="pagebreak-before"><code class="kd">let</code> <code class="nx">originalData</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>

<code class="kd">function</code> <code class="nx">reducer</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">action</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'sort'</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code><code class="nx">column</code><code class="p">,</code> <code class="nx">descending</code><code class="p">}</code> <code class="o">=</code> <code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">;</code>
    <code class="k">return</code> <code class="nx">clone</code><code class="p">(</code><code class="nx">data</code><code class="p">).</code><code class="nx">sort</code><code class="p">((</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">===</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">])</code> <code class="p">{</code>
        <code class="k">return</code> <code class="mi">0</code><code class="p">;</code>
      <code class="p">}</code>
      <code class="k">return</code> <code class="nx">descending</code>
        <code class="o">?</code> <code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">&lt;</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code>
          <code class="o">?</code> <code class="mi">1</code>
          <code class="o">:</code> <code class="o">-</code><code class="mi">1</code>
        <code class="o">:</code> <code class="nx">a</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code> <code class="o">&gt;</code> <code class="nx">b</code><code class="p">[</code><code class="nx">column</code><code class="p">]</code>
          <code class="o">?</code> <code class="mi">1</code>
          <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
    <code class="p">});</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'save'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">data</code><code class="p">[</code><code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">.</code><code class="nx">edit</code><code class="p">.</code><code class="nx">row</code><code class="p">][</code><code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">.</code><code class="nx">edit</code><code class="p">.</code><code class="nx">column</code><code class="p">]</code> <code class="o">=</code>
      <code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">.</code><code class="nx">value</code><code class="p">;</code>
    <code class="k">return</code> <code class="nx">data</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'startSearching'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">originalData</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>
    <code class="k">return</code> <code class="nx">originalData</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'doneSearching'</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">originalData</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s1">'search'</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">originalData</code><code class="p">.</code><code class="nx">filter</code><code class="p">((</code><code class="nx">row</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="k">return</code> <code class="p">(</code>
        <code class="nx">row</code><code class="p">[</code><code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">.</code><code class="nx">column</code><code class="p">]</code>
          <code class="p">.</code><code class="nx">toString</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">toLowerCase</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">action</code><code class="p">.</code><code class="nx">payload</code><code class="p">.</code><code class="nx">needle</code><code class="p">.</code><code class="nx">toLowerCase</code><code class="p">())</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code>
      <code class="p">);</code>
    <code class="p">});</code>
  <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>







</div></section></div></body>
</html>