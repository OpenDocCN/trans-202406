- en: Chapter 5\. Helm
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In [Chapter 4](ch04.xhtml#ch_Kustomize), you learned about Kustomize, a simple
    yet powerful tool to manage Kubernetes resources. But another popular tool aims
    to simplify the Kubernetes resources management too: Helm.'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: Helm works similarly to Kustomize, but it’s a template solution and acts more
    like a package manager, producing artifacts that are versionable, sharable, or
    deployable.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
- en: In this chapter, we’ll introduce Helm, a package manager for Kubernetes that
    helps install and manage Kubernetes applications using the Go template language
    in YAML files.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
- en: The first step is to create a Helm project and deploy it to a Kubernetes cluster
    (see Recipes [5.1](#recipe_5_1) and [5.2](#recipe_5_2)). After the first deployment,
    the application is updated with a new container image, a new configuration value,
    or any other field, such as the replica number (see [Recipe 5.3](#recipe_5_3)).
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
- en: One of the differences between Kustomize and Helm is the concept of a Chart.
    A Chart is a packaged artifact that can be shared and contains multiple elements
    like dependencies on other Charts (see Recipes [5.4](#recipe_5_4), [5.5](#recipe_5_5),
    and [5.6](#recipe_5_6)).
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
- en: Application configuration values are properties usually mapped as a Kubernetes
    `ConfigMap`. Any change (and its consequent update on the cluster) on a `ConfigMap`
    doesn’t trigger a rolling update of the application, which means that the application
    will run with the previous version until you manually restart it.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
- en: Helm provides some functions to automatically execute a rolling update when
    the `ConfigMap` of an application changes (see [Recipe 5.7](#recipe_5_7)).
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
- en: 5.1 Creating a Helm Project
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Problem
  id: totrans-9
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: You want to create a simple Helm project.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: Solution
  id: totrans-11
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Use the [Helm](https://helm.sh) CLI tool to create a new project.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
- en: In contrast to Kustomize, which can be used either within the `kubectl` command
    or as a standalone CLI tool, Helm needs to be downloaded and installed in your
    local machine.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: 'Helm is a packager for Kubernetes that bundles related manifest files and packages
    them into a single logical deployment unit: a Chart. Thus simplified, for many
    engineers, Helm makes it easy to start using Kubernetes with real applications.'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
- en: Helm Charts are useful for addressing the installation complexities and simple
    upgrades of applications.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
- en: For this book, we use Helm 3.7.2, which you can download from [GitHub](https://oreil.ly/AWfiO)
    and install in your PATH directory.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
- en: 'Open a terminal and run the following commands to create a Helm Chart directory
    layout:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-18
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Then create three files: one that defines the Chart, another representing the
    deployment template using the Go template language and template functions from
    the Sprig library, and finally a file containing the default values for the Chart.'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
- en: 'A *Chart.yaml* file declares the Chart with information such as version or
    name. Create the file in the root directory:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: '[![1](assets/1.png)](#co_helm_CO1-1)'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
- en: Version of the Chart. This is updated when something in the Chart definition
    is changed.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO1-2)'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: Version of the application.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
- en: Let’s create a *deployment.yaml* and a *service.yaml* template file to deploy
    the application.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: 'The *deployment.yaml* file templatizes the deployment’s name, the application
    version, the replica count, the container image and tag, the pull policy, the
    security context, and the port:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '[![1](assets/1.png)](#co_helm_CO2-1)'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
- en: Sets the name from the *Chart.yaml* file
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO2-2)'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
- en: Conditionally sets the version based on the presence of the `appVersion` in
    the *Chart.yaml* file
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
- en: '[![3](assets/3.png)](#co_helm_CO2-3)'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
- en: Sets the `appVersion` value but quoting the property
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
- en: '[![4](assets/4.png)](#co_helm_CO2-4)'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
- en: Placeholder for the `replicaCount` property
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: '[![5](assets/5.png)](#co_helm_CO2-5)'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: Placeholder for the container image
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
- en: '[![6](assets/6.png)](#co_helm_CO2-6)'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: Placeholder for the image tag if present and if not, defaults to the *Chart.yaml*
    property
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
- en: '[![7](assets/7.png)](#co_helm_CO2-7)'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: Sets the `securityContext` value as a YAML object and not as a string, indenting
    it 14 spaces
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
- en: 'The *service.yaml* file templatizes the service name and the container port:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: The *values.yaml* file contains the default values for the Chart. These values
    can be overridden at runtime, but they provide good initial values.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
- en: 'Create the file in the root directory with some default values:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-47
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: '[![1](assets/1.png)](#co_helm_CO3-1)'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: Defines the `image` section
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO3-2)'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
- en: Sets the `repository` property
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
- en: '[![3](assets/3.png)](#co_helm_CO3-3)'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
- en: Empty `securityContext`
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: Built-in properties are capitalized; for this reason, properties defined in
    the *Chart.yaml* file start with an uppercase letter.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
- en: 'Since the `toYaml` function is used for the `securityContext` value, the expected
    value for the `securityContext` property in *values.yaml* should be a YAML object.
    For example:'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-56
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The relationship between all elements is shown in [Figure 5-1](#fig-511).
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
- en: '![Relationship between Helm elements](assets/gocb_0501.png)'
  id: totrans-58
  prefs: []
  type: TYPE_IMG
- en: Figure 5-1\. Relationship between Helm elements
  id: totrans-59
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'At this point the Helm directory layout is created and should be similar to
    this:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: '[![1](assets/1.png)](#co_helm_CO4-1)'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
- en: The *Chart.yaml* file is the Chart descriptor and contains metadata related
    to the Chart.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO4-2)'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
- en: The *templates* directory contains all template files used for installing a
    Chart.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
- en: '[![3](assets/3.png)](#co_helm_CO4-3)'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: These files are Helm template files used to deploy the application.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
- en: '[![4](assets/4.png)](#co_helm_CO4-4)'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
- en: The *values.yaml* file contains the default values for a Chart.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
- en: 'To render the Helm Chart locally to YAML, run the following command in a terminal
    window:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'The output is:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: '[![1](assets/1.png)](#co_helm_CO5-1)'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
- en: Name is injected from *Chart.yaml*
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO5-2)'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
- en: Port is set in *values.yaml*
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: '[![3](assets/3.png)](#co_helm_CO5-3)'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
- en: Version is taken from Chart version
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
- en: '[![4](assets/4.png)](#co_helm_CO5-4)'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: Concatenates content from two attributes
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
- en: '[![5](assets/5.png)](#co_helm_CO5-5)'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
- en: Empty security context
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
- en: 'You can override any default value by using the `--set` parameter in Helm.
    Let’s override the `replicaCount` value from one (defined in *values.yaml*) to
    three:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-85
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'And the `replicas` value is updated:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-87
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Discussion
  id: totrans-88
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Helm is a package manager for Kubernetes, and as such, it helps you with the
    task of versioning, sharing, and upgrading Kubernetes applications.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
- en: Let’s see how to install the Helm Chart to a Kubernetes cluster and upgrade
    the application.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
- en: 'With Minikube up and running, execute the following command in a terminal window,
    and run the `install` command to deploy the application to the cluster:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'The Chart is installed in the running Kubernetes instance:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Get the list of current deployed pods, Deployments, and Services to validate
    that the Helm Chart is deployed in the Kubernetes cluster:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: '[PRE14]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: '[PRE15]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Also, it’s possible to get history information about the deployed Helm Chart
    using the `history` command:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-100
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'To uninstall a Chart from the cluster, run `uninstall` command:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-102
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: Helm is a package manager that lets you share the Chart (package) to other Charts
    as a dependency. For example, you can have a Chart defining the deployment of
    the application and another Chart as a dependency setting a database deployment.
    In this way, the installation process installs the application and the database
    Chart automatically.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
- en: We’ll learn about the packaging process and adding dependencies in a later section.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  id: totrans-105
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: You can use the `helm create <name>` command to let the Helm tool skaffold the
    project.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
- en: See Also
  id: totrans-107
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[Helm](https://helm.sh)'
  id: totrans-108
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[Go template package](https://oreil.ly/vYI40)'
  id: totrans-109
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[Sprig Function Documentation](https://oreil.ly/ngC2v)'
  id: totrans-110
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 5.2 Reusing Statements Between Templates
  id: totrans-111
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Problem
  id: totrans-112
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: You want to reuse template statements across several files.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
- en: Solution
  id: totrans-114
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Use *_helpers.tpl* to define reusable statements.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
- en: We deployed a simple application to Kubernetes using Helm in the previous recipe.
    This simple application was composed of a Kubernetes Deployment file and a Kubernetes
    Service file where the `selector` field was defined with the same value.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: 'As a reminder:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-118
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: '[PRE19]'
  id: totrans-119
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: If you need to update this field—for example, adding a new label as a selector—you
    would need to update in three places, as shown in the previous snippets.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: Helm lets you create a *_helpers.tpl* file in the *templates* directory defining
    statements that can be called in templates to avoid this problem.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
- en: Let’s refactor the previous example to use the *_helpers.tpl* file to define
    the `selectorLabels`.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: 'Create the *_helpers.tpl* file in the *templates* directory with the following
    content:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: '[![1](assets/1.png)](#co_helm_CO6-1)'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
- en: Defines the statement name
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO6-2)'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
- en: Defines the logic of the statement
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
- en: 'Then replace the template placeholders shown in previous snippets with a call
    to the `podman.selectorLabels` helper statement using the `include` keyword:'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-130
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: '[![1](assets/1.png)](#co_helm_CO7-1)'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
- en: Calls `pacman.selectorLabels` with indentation
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO7-2)'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
- en: Calls `pacman.selectorLabels` with indentation
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
- en: 'To render the Helm Chart locally to YAML, run the following command in a terminal
    window:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'The output is:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: '[![1](assets/1.png)](#co_helm_CO8-1)'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
- en: Selector is updated with value set in *_helpers.tpl*
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO8-2)'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
- en: Selector is updated with value set in *_helpers.tpl*
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
- en: '[![3](assets/3.png)](#co_helm_CO8-3)'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
- en: Selector is updated with value set in *_helpers.tpl*
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
- en: Discussion
  id: totrans-145
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'If you want to update the selector labels, the only change you need to do is
    an update to the *_helpers.tpl* file:'
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-147
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: '[![1](assets/1.png)](#co_helm_CO9-1)'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
- en: Adds a new attribute
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
- en: 'To render the Helm Chart locally to YAML, run the following command in a terminal
    window:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-151
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'The output is:'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  id: totrans-153
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: '[![1](assets/1.png)](#co_helm_CO10-1)'
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
- en: Label is added
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO10-2)'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
- en: Label is added
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
- en: '[![3](assets/3.png)](#co_helm_CO10-3)'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
- en: Label is added
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  id: totrans-160
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: Although it’s common to use *__helpers.tpl* as the filename to define functions,
    you can name any file starting with `__`, and Helm will read the functions too.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
- en: 5.3 Updating a Container Image in Helm
  id: totrans-162
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Problem
  id: totrans-163
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: You want to update the container image from a deployment file using Helm and
    upgrade the running instance.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
- en: Solution
  id: totrans-165
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Use the `upgrade` command.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
- en: 'With Minikube up and running, deploy version 1.0.0 of the `pacman` application:'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  id: totrans-168
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: With the first revision deployed, let’s update the container image to a new
    version and deploy it.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
- en: 'You can check revision number by running the following command:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  id: totrans-171
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'To update the version, open *values.yaml* and update the `image.tag` field
    to the newer container image tag:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: '[![1](assets/1.png)](#co_helm_CO11-1)'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
- en: Updates to container tag to 1.1.0
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
- en: 'Then update the `appVersion` field of the *Chart.yaml* file:'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  id: totrans-177
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: '[![1](assets/1.png)](#co_helm_CO12-1)'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
- en: Version is updated accordingly
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  id: totrans-180
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: You can use `appVersion` as the tag instead of having two separate fields. Using
    two fields or one might depend on your use case, versioning strategy, and lifecycle
    of your software.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
- en: 'After these changes, upgrade the deployment by running the following command:'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  id: totrans-183
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'The output reflects that a new revision has been deployed:'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE32]'
  id: totrans-185
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: '[![1](assets/1.png)](#co_helm_CO13-1)'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
- en: New revision
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
- en: 'The `history` command shows all changes between all versions:'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE33]'
  id: totrans-189
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: Note
  id: totrans-190
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: '`appVersion` is the application version, so every time you change the application
    version, you should update that field too. On the other side, `version` is the
    Chart version and should be updated when the definition of the Chart (i.e., templates)
    changes, so both fields are independent.'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
- en: Discussion
  id: totrans-192
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Not only you can install or upgrade a version with Helm, but you can also roll
    back to a previous revision.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
- en: 'In the terminal window, run the following command:'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE34]'
  id: totrans-195
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'Running the `history` command reflects this change too:'
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE35]'
  id: totrans-197
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: Finally, Helm offers a way to override values, not only using the `--set` argument
    as shown in [Recipe 5.1](#recipe_5_1), but by providing a YAML file.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a new YAML file named *newvalues.yaml* in the root directory with the
    following content:'
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE36]'
  id: totrans-200
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'Then run the `template` command, setting the new file as an override of *values.yaml*:'
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  id: totrans-202
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'The resulting YAML document is using the values set in *values.yaml* but overriding
    the `images.tag` set in *newvalues.yaml*:'
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  id: totrans-204
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 5.4 Packaging and Distributing a Helm Chart
  id: totrans-205
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Problem
  id: totrans-206
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: You want to package and distribute a Helm Chart so it can be reused by others.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
- en: Solution
  id: totrans-208
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Use the `package` command.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
- en: Helm is a package manager for Kubernetes. As we’ve seen in this chapter, the
    basic unit in Helm is a Chart containing the Kubernetes files required to deploy
    the application, the default values for the templates, etc.
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
- en: But we’ve not yet seen how to package Helm Charts and distribute them to be
    available to other Charts as dependencies or deployed by other users.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
- en: 'Let’s package the `pacman` Chart into a *.tgz* file. In the *pacman* directory,
    run the following command:'
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE39]'
  id: totrans-213
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: 'And you’ll get a message informing you where the archive is stored:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE40]'
  id: totrans-215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: A Chart then needs to be published into a Chart repository. A Chart repository
    is an HTTP server with an *index.yaml* file containing metadata information regarding
    Charts and *.tgz* Charts.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
- en: To publish them, update the *index.yaml* file with the new metadata information,
    and upload the artifact.
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
- en: 'The directory layout of a repository might look like this:'
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  id: totrans-219
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: 'The *index.yaml* file with information about each Chart present in the repository
    looks like:'
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  id: totrans-221
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: Tip
  id: totrans-222
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: You can run `helm repo index` in the root directory, where packaged Charts are
    stored, to generate the index file automatically.
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
- en: Discussion
  id: totrans-224
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In addition to packaging a Helm Chart, Helm can generate a signature file for
    the packaged Chart to verify its correctness later.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
- en: In this way, you can be sure it has not been modified, and it’s the correct
    Chart.
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
- en: To sign/verify the package, you need a pair of GPG keys in the machine; we’re
    assuming you already have one pair created.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
- en: 'Now you need to call the `package` command but set the `-sign` argument with
    the required parameters to generate a signature file:'
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  id: totrans-229
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: 'Now, two files are created—the packaged Helm Chart (*.tgz*) and the signature
    file (*.tgz.prov*):'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  id: totrans-231
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: '[![1](assets/1.png)](#co_helm_CO14-1)'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
- en: Chart package
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO14-2)'
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
- en: Signature file
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-236
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: Remember to upload both files in the Chart repository.
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
- en: 'To verify that a Chart is valid and has not been manipulated, use the `verify`
    command:'
  id: totrans-238
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE45]'
  id: totrans-239
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: '[![1](assets/1.png)](#co_helm_CO15-1)'
  id: totrans-240
  prefs: []
  type: TYPE_NORMAL
- en: It’s valid
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
- en: See Also
  id: totrans-242
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[The Chart Repository Guide](https://oreil.ly/pQ2Ab)'
  id: totrans-243
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[Helm Provenance and Integrity](https://oreil.ly/1Hql0)'
  id: totrans-244
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 5.5 Deploying a Chart from a Repository
  id: totrans-245
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Problem
  id: totrans-246
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: You want to deploy a Helm Chart stored in Chart repository.
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
- en: Solution
  id: totrans-248
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Use the `repo add` command to add the remote repository and the `install` command
    to deploy it.
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
- en: Public Helm Chart repositories like [Bitnami](https://oreil.ly/QJzWZ) are available
    for this purpose.
  id: totrans-250
  prefs: []
  type: TYPE_NORMAL
- en: 'To install Charts from a repository (either public or private), you need to
    register it using its URL:'
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE46]'
  id: totrans-252
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: '[![1](assets/1.png)](#co_helm_CO16-1)'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
- en: URL of Helm Chart repository where *index.yaml* is placed
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
- en: 'List the registered repositories:'
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE47]'
  id: totrans-256
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: '[![1](assets/1.png)](#co_helm_CO17-1)'
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
- en: Bitnami repo is registered
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  id: totrans-259
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: Run `helm repo update` to get the latest list of Charts for each repo.
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
- en: After registering a repository, you might want to find which Charts are available.
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
- en: 'If you want to deploy a PostgreSQL instance in the cluster, use the `search`
    command to search all repositories for a Chart that matches the name:'
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  id: totrans-263
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'The outputs are the list of Charts that matches the name, the version of the
    Chart and PostgreSQL, and a description. Notice the name of the Chart is composed
    of the repository name and the Chart name, i.e., `bitnami/postgresql`:'
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  id: totrans-265
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'To deploy the PostgreSQL Chart, run the `install` command but change the location
    of the Helm Chart from a local directory to the full name of the Chart (`<repo>/<chart>`):'
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE50]'
  id: totrans-267
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: '[![1](assets/1.png)](#co_helm_CO18-1)'
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
- en: Sets the name of the deployment
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO18-2)'
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
- en: Overrides default values to the ones set in the command line
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
- en: '[![3](assets/3.png)](#co_helm_CO18-3)'
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
- en: Sets the PostgreSQL Chart stored in the Bitnami repo
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
- en: 'And a detailed output is shown in the console:'
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE51]'
  id: totrans-275
  prefs: []
  type: TYPE_PRE
  zh: '[PRE51]'
- en: 'Inspect the installation by listing pods, Services, StatefulSets, or Secrets:'
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE52]'
  id: totrans-277
  prefs: []
  type: TYPE_PRE
  zh: '[PRE52]'
- en: '[PRE53]'
  id: totrans-278
  prefs: []
  type: TYPE_PRE
  zh: '[PRE53]'
- en: '[PRE54]'
  id: totrans-279
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: '[PRE55]'
  id: totrans-280
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: Discussion
  id: totrans-281
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'When a third party creates a Chart, there is no direct access to default values
    or the list of parameters to override. Helm provides a `show` command to check
    these values:'
  id: totrans-282
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE56]'
  id: totrans-283
  prefs: []
  type: TYPE_PRE
  zh: '[PRE56]'
- en: 'And shows all the possible values:'
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE57]'
  id: totrans-285
  prefs: []
  type: TYPE_PRE
  zh: '[PRE57]'
- en: 5.6 Deploying a Chart with a Dependency
  id: totrans-286
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Problem
  id: totrans-287
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: You want to deploy a Helm Chart that is a dependency of another Chart.
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
- en: Solution
  id: totrans-289
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Use the `dependencies` section in the *Chart.yaml* file to register other Charts.
    So far, we’ve seen how to deploy simple services to the cluster, but usually a
    service might have other dependencies like a database, mail server, distributed
    cache, etc.
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
- en: In the previous section, we saw how to deploy a PostgreSQL server in a Kubernetes
    cluster. In this section, we’ll see how to deploy a service composed of a Java
    service returning a list of songs stored in a PostgreSQL database. The application
    is summarized in [Figure 5-2](#fig-561).
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
- en: '![Music application overview](assets/gocb_0502.png)'
  id: totrans-292
  prefs: []
  type: TYPE_IMG
- en: Figure 5-2\. Music application overview
  id: totrans-293
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'Let’s start creating the Chart layout shown in [Recipe 5.1](#recipe_5_1):'
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE58]'
  id: totrans-295
  prefs: []
  type: TYPE_PRE
  zh: '[PRE58]'
- en: Then create two template files to deploy the music service.
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
- en: 'The *templates/deployment.yaml* file contains the Kubernetes Deployment definition:'
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE59]'
  id: totrans-298
  prefs: []
  type: TYPE_PRE
  zh: '[PRE59]'
- en: 'The *templates/service.yaml* file contains the Kubernetes Service definition:'
  id: totrans-299
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE60]'
  id: totrans-300
  prefs: []
  type: TYPE_PRE
  zh: '[PRE60]'
- en: 'After the creation of the templates, it’s time for the Chart metadata *Chart.yaml*
    file. In this case, we need to define the dependencies of this Chart too. Since
    the music service uses a PostgreSQL database, we can add the Chart used in [Recipe
    5.5](#recipe_5_5) as a dependency:'
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE61]'
  id: totrans-302
  prefs: []
  type: TYPE_PRE
  zh: '[PRE61]'
- en: '[![1](assets/1.png)](#co_helm_CO19-1)'
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
- en: Dependencies section
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO19-2)'
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
- en: Name of the Chart to add as dependency
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
- en: '[![3](assets/3.png)](#co_helm_CO19-3)'
  id: totrans-307
  prefs: []
  type: TYPE_NORMAL
- en: Chart version
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
- en: '[![4](assets/4.png)](#co_helm_CO19-4)'
  id: totrans-309
  prefs: []
  type: TYPE_NORMAL
- en: Repository
  id: totrans-310
  prefs: []
  type: TYPE_NORMAL
- en: 'The final file is *Values.yaml* with default configuration values. In this
    case, a new section is added to configure music deployment with PostgreSQL instance
    parameters:'
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE62]'
  id: totrans-312
  prefs: []
  type: TYPE_PRE
  zh: '[PRE62]'
- en: '[![1](assets/1.png)](#co_helm_CO20-1)'
  id: totrans-313
  prefs: []
  type: TYPE_NORMAL
- en: PostgreSQL section
  id: totrans-314
  prefs: []
  type: TYPE_NORMAL
- en: 'With the Chart in place, the next thing to do is download the dependency Chart
    and store it in the *charts* directory. This process is automatically done by
    running the `dependency update` command:'
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE63]'
  id: totrans-316
  prefs: []
  type: TYPE_PRE
  zh: '[PRE63]'
- en: 'The command output shows that one Chart has been downloaded and saved:'
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE64]'
  id: totrans-318
  prefs: []
  type: TYPE_PRE
  zh: '[PRE64]'
- en: 'The directory layout looks like this:'
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE65]'
  id: totrans-320
  prefs: []
  type: TYPE_PRE
  zh: '[PRE65]'
- en: '[![1](assets/1.png)](#co_helm_CO21-1)'
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
- en: PostgreSQL Chart is placed in the correct directory
  id: totrans-322
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, we deploy the Chart, setting configuration PostgreSQL deployment values
    from the command line:'
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE66]'
  id: totrans-324
  prefs: []
  type: TYPE_PRE
  zh: '[PRE66]'
- en: 'The installation process shows information about the deployment:'
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE67]'
  id: totrans-326
  prefs: []
  type: TYPE_PRE
  zh: '[PRE67]'
- en: 'Inspect the installation by listing pods, Services, StatefulSets, or Secrets:'
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE68]'
  id: totrans-328
  prefs: []
  type: TYPE_PRE
  zh: '[PRE68]'
- en: '[PRE69]'
  id: totrans-329
  prefs: []
  type: TYPE_PRE
  zh: '[PRE69]'
- en: '[PRE70]'
  id: totrans-330
  prefs: []
  type: TYPE_PRE
  zh: '[PRE70]'
- en: We can validate the access to the music service by using port forwarding to
    the Kubernetes Service.
  id: totrans-331
  prefs: []
  type: TYPE_NORMAL
- en: 'Open a new terminal window and run the following command:'
  id: totrans-332
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE71]'
  id: totrans-333
  prefs: []
  type: TYPE_PRE
  zh: '[PRE71]'
- en: The terminal is blocked and it’s normal until you stop the `kubectl port-forward`
    process. Thanks to port forwarding, we can access the music service using the
    `localhost` address and port `8080`.
  id: totrans-334
  prefs: []
  type: TYPE_NORMAL
- en: 'In another terminal, `curl` the service:'
  id: totrans-335
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE72]'
  id: totrans-336
  prefs: []
  type: TYPE_PRE
  zh: '[PRE72]'
- en: 'The request is sent to the music service deployed in Kubernetes and returns
    a list of songs:'
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE73]'
  id: totrans-338
  prefs: []
  type: TYPE_PRE
  zh: '[PRE73]'
- en: 5.7 Triggering a Rolling Update Automatically
  id: totrans-339
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Problem
  id: totrans-340
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: You want to trigger a rolling update of deployment when a `ConfigMap` object
    is changed.
  id: totrans-341
  prefs: []
  type: TYPE_NORMAL
- en: Solution
  id: totrans-342
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Use the `sha256sum` template function to generate a change on the deployment
    file.
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
- en: In [Recipe 4.5](ch04.xhtml#recipe_4_5), we saw that Kustomize has a `ConfigMapGenerator`
    that automatically appends a hash to the `ConfigMap` metadata name and modifies
    the deployment file with the new hash when used. Any change on the `ConfigMap`
    triggers a rolling update of the deployment.
  id: totrans-344
  prefs: []
  type: TYPE_NORMAL
- en: Helm doesn’t provide a direct way like Kustomize does to update a deployment
    file when the `ConfigMap` changes, but there is a template function to calculate
    a SHA-256 hash of any file and embed the result in the template.
  id: totrans-345
  prefs: []
  type: TYPE_NORMAL
- en: Suppose we’ve got a Node.js application that returns a greeting message. An
    environment variable configures this greeting message, and in the Kubernetes Deployment,
    this variable is injected from a Kubernetes `ConfigMap`.
  id: totrans-346
  prefs: []
  type: TYPE_NORMAL
- en: '[Figure 5-3](#fig-571) shows an overview of the application.'
  id: totrans-347
  prefs: []
  type: TYPE_NORMAL
- en: '![Greetings application overview](assets/gocb_0503.png)'
  id: totrans-348
  prefs: []
  type: TYPE_IMG
- en: Figure 5-3\. Greetings application overview
  id: totrans-349
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: Let’s create the Helm Chart for the Greetings application; note that we’re not
    covering the entire process of creating a Chart, but just the essential parts.
    You can refer to [Recipe 5.1](#recipe_5_1) to get started.
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a deployment template that injects a `ConfigMap` as an environment variable.
    The following listing shows the file:'
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE74]'
  id: totrans-352
  prefs: []
  type: TYPE_PRE
  zh: '[PRE74]'
- en: '[![1](assets/1.png)](#co_helm_CO22-1)'
  id: totrans-353
  prefs: []
  type: TYPE_NORMAL
- en: '`ConfigMap` name'
  id: totrans-354
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO22-2)'
  id: totrans-355
  prefs: []
  type: TYPE_NORMAL
- en: Property key of the `ConfigMap`
  id: totrans-356
  prefs: []
  type: TYPE_NORMAL
- en: 'The initial `ConfigMap` file is shown in the following listing:'
  id: totrans-357
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE75]'
  id: totrans-358
  prefs: []
  type: TYPE_PRE
  zh: '[PRE75]'
- en: '[![1](assets/1.png)](#co_helm_CO23-1)'
  id: totrans-359
  prefs: []
  type: TYPE_NORMAL
- en: Sets `ConfigMap` name
  id: totrans-360
  prefs: []
  type: TYPE_NORMAL
- en: '[![2](assets/2.png)](#co_helm_CO23-2)'
  id: totrans-361
  prefs: []
  type: TYPE_NORMAL
- en: Key/value
  id: totrans-362
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a Kubernetes Service template to access the service:'
  id: totrans-363
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE76]'
  id: totrans-364
  prefs: []
  type: TYPE_PRE
  zh: '[PRE76]'
- en: 'Update the *values.yaml* file with the template `configmap` parameters:'
  id: totrans-365
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE77]'
  id: totrans-366
  prefs: []
  type: TYPE_PRE
  zh: '[PRE77]'
- en: '[![1](assets/1.png)](#co_helm_CO24-1)'
  id: totrans-367
  prefs: []
  type: TYPE_NORMAL
- en: Refers to `ConfigMap` name
  id: totrans-368
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, install the Chart using the `install` command:'
  id: totrans-369
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE78]'
  id: totrans-370
  prefs: []
  type: TYPE_PRE
  zh: '[PRE78]'
- en: 'When the Chart is deployed, use the `kubectl port-forward` command in one terminal
    to get access to the service:'
  id: totrans-371
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE79]'
  id: totrans-372
  prefs: []
  type: TYPE_PRE
  zh: '[PRE79]'
- en: 'And `curl` the service in another terminal window:'
  id: totrans-373
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE80]'
  id: totrans-374
  prefs: []
  type: TYPE_PRE
  zh: '[PRE80]'
- en: '[![1](assets/1.png)](#co_helm_CO25-1)'
  id: totrans-375
  prefs: []
  type: TYPE_NORMAL
- en: Configured greeting is used
  id: totrans-376
  prefs: []
  type: TYPE_NORMAL
- en: 'Now, let’s update the `ConfigMap` file to a new greeting message:'
  id: totrans-377
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE81]'
  id: totrans-378
  prefs: []
  type: TYPE_PRE
  zh: '[PRE81]'
- en: '[![1](assets/1.png)](#co_helm_CO26-1)'
  id: totrans-379
  prefs: []
  type: TYPE_NORMAL
- en: New greeting message
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
- en: 'Update the `appVersion` field from the *Chart.yaml* file to `1.0.1` and upgrade
    the Chart by running the following command:'
  id: totrans-381
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE82]'
  id: totrans-382
  prefs: []
  type: TYPE_PRE
  zh: '[PRE82]'
- en: 'Restart the `kubectl port-forward` process and `curl` the service again:'
  id: totrans-383
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE83]'
  id: totrans-384
  prefs: []
  type: TYPE_PRE
  zh: '[PRE83]'
- en: '[![1](assets/1.png)](#co_helm_CO27-1)'
  id: totrans-385
  prefs: []
  type: TYPE_NORMAL
- en: Greeting message isn’t updated
  id: totrans-386
  prefs: []
  type: TYPE_NORMAL
- en: 'The `ConfigMap` object is updated during the upgrade, but since there are no
    changes in the `Deployment` object, there is no restart of the pod; hence the
    environment variable is not set to the new value. Listing the pods shows no execution
    of the rolling update:'
  id: totrans-387
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE84]'
  id: totrans-388
  prefs: []
  type: TYPE_PRE
  zh: '[PRE84]'
- en: '[![1](assets/1.png)](#co_helm_CO28-1)'
  id: totrans-389
  prefs: []
  type: TYPE_NORMAL
- en: Age value shows no rolling update
  id: totrans-390
  prefs: []
  type: TYPE_NORMAL
- en: '[Figure 5-4](#fig-572) summarizes the change.'
  id: totrans-391
  prefs: []
  type: TYPE_NORMAL
- en: '![Greetings application with new configuration value](assets/gocb_0504.png)'
  id: totrans-392
  prefs: []
  type: TYPE_IMG
- en: Figure 5-4\. Greetings application with new configuration value
  id: totrans-393
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
- en: 'Let’s use the `sha256sum` function to calculate an SHA-256 value of the *configmap.yaml*
    file content and set it as a pod annotation, which effectively triggers a rolling
    update as the pod definition has changed:'
  id: totrans-394
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE85]'
  id: totrans-395
  prefs: []
  type: TYPE_PRE
  zh: '[PRE85]'
- en: '[![1](assets/1.png)](#co_helm_CO29-1)'
  id: totrans-396
  prefs: []
  type: TYPE_NORMAL
- en: Includes the *configmap.yaml* file, calculates the SHA-256 value, and sets it
    as an annotation
  id: totrans-397
  prefs: []
  type: TYPE_NORMAL
- en: 'Update the `ConfigMap` again with a new value:'
  id: totrans-398
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE86]'
  id: totrans-399
  prefs: []
  type: TYPE_PRE
  zh: '[PRE86]'
- en: '[![1](assets/1.png)](#co_helm_CO30-1)'
  id: totrans-400
  prefs: []
  type: TYPE_NORMAL
- en: New greeting message
  id: totrans-401
  prefs: []
  type: TYPE_NORMAL
- en: 'Update the `appVersion` field from *Chart.yaml* to `1.0.1` and upgrade the
    Chart by running the following command:'
  id: totrans-402
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE87]'
  id: totrans-403
  prefs: []
  type: TYPE_PRE
  zh: '[PRE87]'
- en: 'Restart the `kubectl port-forward` process and `curl` the service again:'
  id: totrans-404
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE88]'
  id: totrans-405
  prefs: []
  type: TYPE_PRE
  zh: '[PRE88]'
- en: '[![1](assets/1.png)](#co_helm_CO31-1)'
  id: totrans-406
  prefs: []
  type: TYPE_NORMAL
- en: Greeting message is the new one
  id: totrans-407
  prefs: []
  type: TYPE_NORMAL
- en: 'List the pods deployed in the cluster again, and you’ll notice that a rolling
    update is happening:'
  id: totrans-408
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE89]'
  id: totrans-409
  prefs: []
  type: TYPE_PRE
  zh: '[PRE89]'
- en: '[![1](assets/1.png)](#co_helm_CO32-1)'
  id: totrans-410
  prefs: []
  type: TYPE_NORMAL
- en: A rolling update is happening
  id: totrans-411
  prefs: []
  type: TYPE_NORMAL
- en: 'Describe the pod to validate that the annotation with the SHA-256 value is
    present:'
  id: totrans-412
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE90]'
  id: totrans-413
  prefs: []
  type: TYPE_PRE
  zh: '[PRE90]'
- en: 'The output shows all pod parameters. The important one is the `annotations`
    placed at the top of the output showing the `checksum/config` annotation containing
    the calculated SHA-256 value:'
  id: totrans-414
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE91]'
  id: totrans-415
  prefs: []
  type: TYPE_PRE
  zh: '[PRE91]'
- en: '[![1](assets/1.png)](#co_helm_CO33-1)'
  id: totrans-416
  prefs: []
  type: TYPE_NORMAL
  zh: '[![1](assets/1.png)](#co_helm_CO33-1)'
- en: Calculated value
  id: totrans-417
  prefs: []
  type: TYPE_NORMAL
  zh: 计算出的数值
- en: '[Figure 5-5](#fig-573) summarizes the elements that changed when the application
    was updated.'
  id: totrans-418
  prefs: []
  type: TYPE_NORMAL
  zh: '[图 5-5](#fig-573) 总结了更新应用程序时发生变化的元素。'
- en: '![Final overview of the Greetings application](assets/gocb_0505.png)'
  id: totrans-419
  prefs: []
  type: TYPE_IMG
  zh: '![Greetings 应用程序的最终概述](assets/gocb_0505.png)'
- en: Figure 5-5\. Final overview of the Greetings application
  id: totrans-420
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 图 5-5\. Greetings 应用程序的最终概述
- en: 5.8 Final Thoughts
  id: totrans-421
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 5.8 总结
- en: In the previous chapter, we saw Kustomize; in this chapter, we’ve seen another
    tool to help deploy Kubernetes applications.
  id: totrans-422
  prefs: []
  type: TYPE_NORMAL
  zh: 在前一章中，我们看到了 Kustomize；在本章中，我们看到了另一个帮助部署 Kubernetes 应用程序的工具。
- en: When you need to choose between Kustomize or Helm, you might have questions
    on which one to use.
  id: totrans-423
  prefs: []
  type: TYPE_NORMAL
  zh: 当你需要在 Kustomize 和 Helm 之间进行选择时，你可能会对该使用哪一个有疑问。
- en: In our experience, the best way to proceed is with Kustomize for simple projects,
    where only simple changes might be required between new deployments.
  id: totrans-424
  prefs: []
  type: TYPE_NORMAL
  zh: 根据我们的经验，对于简单项目，其中可能只需要在新部署之间进行简单更改，最佳方法是使用 Kustomize。
- en: If the project is complex with external dependencies, and several deployment
    parameters, then Helm is a better option.
  id: totrans-425
  prefs: []
  type: TYPE_NORMAL
  zh: 如果项目复杂且具有外部依赖关系以及多个部署参数，则 Helm 是更好的选择。
