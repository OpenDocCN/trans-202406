<html><head></head><body><section data-pdf-bookmark="Chapter 20. Networking and Our App" data-type="chapter" epub:type="chapter"><div class="chapter" id="app_network">&#13;
<h1><span class="label">Chapter 20. </span>Networking and Our App</h1>&#13;
&#13;
&#13;
<p>Wow. We’ve come a long way with our app. The last chapter, dealing with databases, was a doozy. We’ve now got a great app for browsing through our catalog of books. We can <em>even</em> favorite some books for later to check them out again. That’s great! It’s probably time to set this app aside and start working on another project.</p>&#13;
&#13;
<p>But wait! The librarian from before, our octogenarian guide and muse, ambles up to you from out of the shadows of wherever you’re working and lets you in on a secret that makes your hair stand on end: this isn’t the only library of this type. There are multiple locations scattered throughout the globe in different countries and they all must be displayed in this app to help patrons—such as yourself—unlock the knowledge contained within.</p>&#13;
&#13;
<p>Looks like we’re not done yet with this project.</p>&#13;
&#13;
<p>Now, how might we go about supporting this new feature? It’s possible we could use the same approach as before with our catalog: bundle the list of locations with the app. However, that approach seems a bit static and unchanging. What if a location closes and a weary traveler searches for the knowledge of mankind in vain? It might be best, instead, to use this as an opportunity to finally break down the barriers around this app and let it communicate with the outside world via, you guessed it, the Internet! This will allow our data to be dynamic and changing, just like the world around it.</p>&#13;
&#13;
<p>So buckle up. Let’s dial in and start searching!</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Searching the World" data-type="sect1"><div class="sect1" id="idm46177197184920">&#13;
<h1>Searching the World</h1>&#13;
&#13;
<p>Fundamentally, interacting<a data-primary="networking" data-secondary="interacting with search endpoints" data-type="indexterm" id="idm46177197183352"/><a data-primary="Android" data-secondary="networking" data-tertiary="interacting with search endpoints" data-type="indexterm" id="idm46177197182408"/><a data-primary="iOS" data-secondary="networking" data-tertiary="interacting with search endpoints" data-type="indexterm" id="idm46177197181224"/><a data-primary="application networking" data-secondary="interacting with search endpoints" data-type="indexterm" id="idm46177197180040"/> with a search endpoint is the same for Android as it is for iOS. It consists of the following steps:</p>&#13;
<ol>&#13;
<li>&#13;
<p>A button or search bar to initiate the search.</p>&#13;
</li>&#13;
<li>&#13;
<p>A string of text to pass to a network service somewhere.</p>&#13;
</li>&#13;
<li>&#13;
<p>A response containing the results of our query.</p>&#13;
</li>&#13;
<li>&#13;
<p>A screen that displays our results—most likely a list or table view.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>The first thing we need is a way to initiate the search in the UI. On Android, since again we’ve omitted the <code>ActionBar</code> for our <code>Activities</code>, we’ll add an AOSP-provided component called <code>SearchView</code> to the top of the <code>BrowseContentActivity</code> UI. When a string is entered and actionable (button press, Enter key, IME action), we’ll pass that value to a web service, which will open the returns in a new <code>Activity</code> when it returns successfully and complete.</p>&#13;
&#13;
<p>For now, let’s modify the layout of <em>res/layout/activity_browse.xml</em> to include a <code>SearchView</code>:</p>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</code>&#13;
<code class="nt">&lt;LinearLayout</code>&#13;
    <code class="na">xmlns:android=</code><code class="s">"http://schemas.android.com/apk/res/android"</code>&#13;
    <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
    <code class="na">android:layout_height=</code><code class="s">"match_parent"</code>&#13;
    <code class="na">android:orientation=</code><code class="s">"vertical"</code><code class="nt">&gt;</code>&#13;
&#13;
  <code class="nt">&lt;SearchView</code>&#13;
      <code class="na">android:id=</code><code class="s">"@+id/search_locations"</code>&#13;
      <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
      <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code>&#13;
      <code class="na">android:background=</code><code class="s">"#FFFFFFFF"</code> <code class="nt">/&gt;</code>&#13;
&#13;
  <code class="nt">&lt;androidx.recyclerview.widget.RecyclerView</code>&#13;
      <code class="na">android:id=</code><code class="s">"@+id/browse_content_recyclerview"</code>&#13;
      <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
      <code class="na">android:layout_height=</code><code class="s">"match_parent"</code>&#13;
      <code class="na">android:background=</code><code class="s">"#FFFFFFFF"</code> <code class="nt">/&gt;</code>&#13;
&#13;
<code class="nt">&lt;/LinearLayout&gt;</code></pre>&#13;
&#13;
<p>Now, let’s wire up some basic functionality in our existing <code>Activity</code>:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Add new search activity to manifest.</p>&#13;
</li>&#13;
<li>&#13;
<p>Show search activity and layout.</p>&#13;
</li>&#13;
<li>&#13;
<p>Update this log statement to call the search method in the local project.</p>&#13;
</li>&#13;
<li>&#13;
<p>Fix emoji.<a data-primary="Java" data-secondary="networking" data-tertiary="interacting with search endpoints" data-type="indexterm" id="idm46177197117096"/><a data-primary="Kotlin" data-secondary="networking" data-tertiary="interacting with search endpoints" data-type="indexterm" id="idm46177197115912"/></p>&#13;
</li>&#13;
&#13;
</ol>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177197114296">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">BrowseContentActivity</code> <code class="kd">extends</code> <code class="n">Activity</code> <code class="o">{</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">onCreate</code><code class="o">(</code><code class="n">Bundle</code> <code class="n">savedInstanceState</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="kd">super</code><code class="o">.</code><code class="na">onCreate</code><code class="o">(</code><code class="n">savedInstanceState</code><code class="o">);</code>&#13;
    <code class="n">setContentView</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">layout</code><code class="o">.</code><code class="na">activity_browse</code><code class="o">);</code>&#13;
    <code class="n">SearchView</code> <code class="n">searchView</code> <code class="o">=</code> <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">search_locations</code><code class="o">);</code>&#13;
    <code class="n">searchView</code><code class="o">.</code><code class="na">setOnQueryTextListener</code><code class="o">(</code><code class="k">new</code> <code class="n">SearchView</code><code class="o">.</code><code class="na">OnQueryTextListener</code><code class="o">()</code> <code class="o">{</code>&#13;
      <code class="nd">@Override</code>&#13;
      <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">onQueryTextSubmit</code><code class="o">(</code><code class="n">String</code> <code class="n">query</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyApp"</code><code class="o">,</code> <code class="s">"searching on "</code> <code class="o">+</code> <code class="n">query</code><code class="o">);</code>&#13;
        <code class="k">return</code> <code class="kc">false</code><code class="o">;</code>&#13;
      <code class="o">}</code>&#13;
      <code class="nd">@Override</code>&#13;
      <code class="kd">public</code> <code class="kt">boolean</code> <code class="nf">onQueryTextChange</code><code class="o">(</code><code class="n">String</code> <code class="n">newText</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">return</code> <code class="kc">false</code><code class="o">;</code>&#13;
      <code class="o">}</code>&#13;
    <code class="o">});</code>&#13;
    <code class="n">RecyclerView</code> <code class="n">recyclerView</code> <code class="o">=</code> <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">browse_content_recyclerview</code><code class="o">);</code>&#13;
    <code class="k">try</code> <code class="o">{</code>&#13;
      <code class="n">InputStream</code> <code class="n">stream</code> <code class="o">=</code> <code class="n">getAssets</code><code class="o">().</code><code class="na">open</code><code class="o">(</code><code class="s">"catalog.json"</code><code class="o">);</code>&#13;
      <code class="n">String</code> <code class="n">json</code> <code class="o">=</code> <code class="n">Files</code><code class="o">.</code><code class="na">getStringFromStream</code><code class="o">(</code><code class="n">stream</code><code class="o">);</code>&#13;
      <code class="n">Books</code> <code class="n">source</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Gson</code><code class="o">().</code><code class="na">fromJson</code><code class="o">(</code><code class="n">json</code><code class="o">,</code> <code class="n">Books</code><code class="o">.</code><code class="na">class</code><code class="o">);</code>&#13;
      <code class="n">BrowseBooksAdapter</code> <code class="n">adapter</code> <code class="o">=</code> <code class="k">new</code> <code class="n">BrowseBooksAdapter</code><code class="o">(</code><code class="n">source</code><code class="o">);</code>&#13;
      <code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyApp"</code><code class="o">,</code> <code class="s">"books = "</code> <code class="o">+</code> <code class="n">adapter</code><code class="o">.</code><code class="na">getItemCount</code><code class="o">());</code>&#13;
      <code class="n">recyclerView</code><code class="o">.</code><code class="na">setAdapter</code><code class="o">(</code><code class="n">adapter</code><code class="o">);</code>&#13;
      <code class="n">recyclerView</code><code class="o">.</code><code class="na">setLayoutManager</code><code class="o">(</code><code class="k">new</code> <code class="n">LinearLayoutManager</code><code class="o">(</code><code class="k">this</code><code class="o">));</code>&#13;
    <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyApp"</code><code class="o">,</code> <code class="s">"Oops! Something went wrong trying to read our catalog json"</code><code class="o">);</code>&#13;
      <code class="n">e</code><code class="o">.</code><code class="na">printStackTrace</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
  <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">BrowseContentActivity</code> <code class="p">:</code> <code class="n">Activity</code><code class="p">()</code> <code class="p">{</code>&#13;
&#13;
    <code class="k">override</code> <code class="k">fun</code> <code class="nf">onCreate</code><code class="p">(</code><code class="n">savedInstanceState</code><code class="p">:</code> <code class="n">Bundle</code><code class="p">?)</code> <code class="p">{</code>&#13;
        <code class="k">super</code><code class="p">.</code><code class="n">onCreate</code><code class="p">(</code><code class="n">savedInstanceState</code><code class="p">)</code>&#13;
        <code class="n">setContentView</code><code class="p">(</code><code class="n">R</code><code class="p">.</code><code class="n">layout</code><code class="p">.</code><code class="n">activity_browse</code><code class="p">)</code>&#13;
        <code class="n">search_locations</code><code class="p">.</code><code class="n">setOnQueryTextListener</code><code class="p">(</code><code class="k">object</code> <code class="err">: </code><code class="nc">SearchView</code><code class="p">.</code><code class="n">OnQueryTextListener</code> <code class="p">{</code>&#13;
          <code class="k">override</code> <code class="k">fun</code> <code class="nf">onQueryTextSubmit</code><code class="p">(</code><code class="n">query</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Boolean</code> <code class="p">{</code>&#13;
            <code class="n">Log</code><code class="p">.</code><code class="n">d</code><code class="p">(</code><code class="s">"MyApp"</code><code class="p">,</code> <code class="s">"searching on $query"</code><code class="p">)</code>&#13;
            <code class="k">return</code> <code class="k">false</code>&#13;
          <code class="p">}</code>&#13;
          <code class="k">override</code> <code class="k">fun</code> <code class="nf">onQueryTextChange</code><code class="p">(</code><code class="n">newText</code><code class="p">:</code> <code class="n">String</code><code class="p">):</code> <code class="n">Boolean</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="k">false</code>&#13;
          <code class="p">}</code>&#13;
        <code class="p">})</code>&#13;
        <code class="k">try</code> <code class="p">{</code>&#13;
            <code class="k">val</code> <code class="py">stream</code> <code class="p">=</code> <code class="n">assets</code><code class="p">.</code><code class="k">open</code><code class="p">(</code><code class="s">"catalog.json"</code><code class="p">)</code>&#13;
            <code class="k">val</code> <code class="py">json</code> <code class="p">=</code> <code class="n">Files</code><code class="p">.</code><code class="n">getStringFromStream</code><code class="p">(</code><code class="n">stream</code><code class="p">)</code>&#13;
            <code class="k">val</code> <code class="py">books</code> <code class="p">=</code> <code class="n">Gson</code><code class="p">().</code><code class="n">fromJson</code><code class="p">(</code><code class="n">json</code><code class="p">,</code> <code class="n">Books</code><code class="o">::</code><code class="k">class</code><code class="p">.</code><code class="n">java</code><code class="p">)</code>&#13;
            <code class="n">Log</code><code class="p">.</code><code class="n">d</code><code class="p">(</code><code class="s">"MyApp"</code><code class="p">,</code> <code class="s">"${books.size}, ${books[0].title}"</code><code class="p">)</code>&#13;
            <code class="n">browse_content_recyclerview</code><code class="p">.</code><code class="n">adapter</code> <code class="p">=</code> <code class="n">BrowseBooksAdapter</code><code class="p">(</code><code class="n">books</code><code class="p">)</code>&#13;
            <code class="n">browse_content_recyclerview</code><code class="p">.</code><code class="n">layoutManager</code> <code class="p">=</code> <code class="n">LinearLayoutManager</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>&#13;
        <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">e</code><code class="p">:</code> <code class="n">IOException</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="n">Log</code><code class="p">.</code><code class="n">d</code><code class="p">(</code><code class="s">"MyApp"</code><code class="p">,</code> <code class="s">"Oops! Something went wrong trying to read our catalog json"</code><code class="p">)</code>&#13;
            <code class="n">e</code><code class="p">.</code><code class="n">printStackTrace</code><code class="p">()</code>&#13;
        <code class="p">}</code>&#13;
&#13;
    <code class="p">}</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>Meanwhile, on iOS, we’ll add a search button to the top of the catalog screen. That will display a <code>UISearchController</code> with a <code>UISearchBar</code> that we’ll use to capture the text a search user is searching for; we’ll use that for a request to our search endpoint.</p>&#13;
&#13;
<p>Let’s get started with the UI!</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Android" data-type="sect2"><div class="sect2" id="idm46177196846728">&#13;
<h2>Android</h2>&#13;
&#13;
<p>Let’s<a data-primary="Android" data-secondary="networking" data-tertiary="displaying search results" data-type="indexterm" id="idm46177196652328"/><a data-primary="networking" data-secondary="Android" data-tertiary="displaying search results" data-type="indexterm" id="idm46177196651080"/><a data-primary="application networking" data-secondary="displaying search results" data-tertiary="Android" data-type="indexterm" id="idm46177196649848"/> prepare a simple layout and <code>Activity</code> to display our search results:</p>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</code>&#13;
<code class="nt">&lt;FrameLayout</code>&#13;
    <code class="na">xmlns:android=</code><code class="s">"http://schemas.android.com/apk/res/android"</code>&#13;
    <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
    <code class="na">android:layout_height=</code><code class="s">"match_parent"</code>&#13;
    <code class="na">android:background=</code><code class="s">"#FFFFFFFF"</code><code class="nt">&gt;</code>&#13;
&#13;
  <code class="nt">&lt;androidx.recyclerview.widget.RecyclerView</code>&#13;
      <code class="na">android:id=</code><code class="s">"@+id/search_results_recyclerview"</code>&#13;
      <code class="na">android:layout_width=</code><code class="s">"match_parent"</code>&#13;
      <code class="na">android:layout_height=</code><code class="s">"match_parent"</code>&#13;
      <code class="na">android:visibility=</code><code class="s">"gone"</code>&#13;
      <code class="na">android:background=</code><code class="s">"#FFFFFFFF"</code> <code class="nt">/&gt;</code>&#13;
&#13;
  <code class="nt">&lt;ProgressBar</code>&#13;
      <code class="na">android:id=</code><code class="s">"@+id/search_progress"</code>&#13;
      <code class="na">android:indeterminate=</code><code class="s">"true"</code>&#13;
      <code class="na">android:layout_width=</code><code class="s">"wrap_content"</code>&#13;
      <code class="na">android:layout_height=</code><code class="s">"wrap_content"</code>&#13;
      <code class="na">android:layout_gravity=</code><code class="s">"center"</code> <code class="nt">/&gt;</code>&#13;
&#13;
<code class="nt">&lt;/FrameLayout&gt;</code></pre>&#13;
&#13;
<p>This will provide a spinner to show the user that something is happening while we wait for the results to arrive from the server.</p>&#13;
&#13;
<p>Our <code>Activity</code> should expect a <code>String</code> extra for the query passed from the <code>SearchView</code>—we’ll use this to perform a fetch to the web service and manipulate the UI as appropriate.</p>&#13;
&#13;
<p>Let’s make some assumptions here. Let’s say our URL is <em>magic://my.app/search</em> (we’re going to use the scheme “magic://” so that we don’t forget the missing pieces—most Java HTTP clients will reject that scheme with a friendly, descriptive error), and it accepts a <code>GET</code> query parameter named <code>query</code>. It will return a JSON response that is an array of <code>Location</code> objects, or an empty array if none matches.</p>&#13;
&#13;
<p>Let’s say the JSON looks something like this:</p>&#13;
<pre data-code-language="javascript" data-type="programlisting">&#13;
<code class="p">[</code><code>&#13;
    </code><code class="p">{</code><code>&#13;
        </code><code class="s2">"street_address"</code><code class="o">:</code><code> </code><code class="s2">"123 Eiffel Tower Street"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"city"</code><code class="o">:</code><code> </code><code class="s2">"Paris"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"country"</code><code class="o">:</code><code> </code><code class="s2">"France"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"emoji"</code><code class="o">:</code><code> </code><code class="s2">"</code><img alt="us flag" class="emoji" src="assets/us.png"/><code class="s2">"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"hours"</code><code class="o">:</code><code> </code><code class="s2">"8am–7pm"</code><code>&#13;
    </code><code class="p">}</code><code class="p">,</code><code>&#13;
    </code><code class="p">{</code><code>&#13;
        </code><code class="s2">"street_address"</code><code class="o">:</code><code> </code><code class="s2">"86 Libery Boulevard"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"city"</code><code class="o">:</code><code> </code><code class="s2">"New York"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"country"</code><code class="o">:</code><code> </code><code class="s2">"America"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"emoji"</code><code class="o">:</code><code> </code><code class="s2">"</code><img alt="french flag" class="emoji" src="assets/fr.png"/><code class="s2">"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"hours"</code><code class="o">:</code><code> </code><code class="s2">"6am–10pm"</code><code>&#13;
    </code><code class="p">}</code><code>&#13;
</code><code class="p">]</code><code>&#13;
</code></pre>&#13;
&#13;
<p>And<a data-primary="Java" data-secondary="networking" data-tertiary="displaying search results" data-type="indexterm" id="idm46177196437880"/> our data structure will look something like this:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177196436616">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Location</code> <code class="o">{</code>&#13;
&#13;
  <code class="nd">@SerializedName</code><code class="o">(</code><code class="s">"street_address"</code><code class="o">)</code>&#13;
  <code class="kd">private</code> <code class="n">String</code> <code class="n">mStreetAddress</code><code class="o">;</code>&#13;
  <code class="nd">@SerializedName</code><code class="o">(</code><code class="s">"city"</code><code class="o">)</code>&#13;
  <code class="kd">private</code> <code class="n">String</code> <code class="n">mCity</code><code class="o">;</code>&#13;
  <code class="nd">@SerializedName</code><code class="o">(</code><code class="s">"country"</code><code class="o">)</code>&#13;
  <code class="kd">private</code> <code class="n">String</code> <code class="n">mCountry</code><code class="o">;</code>&#13;
  <code class="nd">@SerializedName</code><code class="o">(</code><code class="s">"emoji"</code><code class="o">)</code>&#13;
  <code class="kd">private</code> <code class="n">String</code> <code class="n">mEmoji</code><code class="o">;</code>&#13;
  <code class="nd">@SerializedName</code><code class="o">(</code><code class="s">"hours"</code><code class="o">)</code>&#13;
  <code class="kd">private</code> <code class="n">String</code> <code class="n">mHours</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">public</code> <code class="n">String</code> <code class="nf">getStreetAddress</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">mStreetAddress</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">setStreetAddress</code><code class="o">(</code><code class="n">String</code> <code class="n">streetAddress</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">mStreetAddress</code> <code class="o">=</code> <code class="n">streetAddress</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="n">String</code> <code class="nf">getCity</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">mCity</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">setCity</code><code class="o">(</code><code class="n">String</code> <code class="n">city</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">mCity</code> <code class="o">=</code> <code class="n">city</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="n">String</code> <code class="nf">getCountry</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">mCountry</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">setCountry</code><code class="o">(</code><code class="n">String</code> <code class="n">country</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">mCountry</code> <code class="o">=</code> <code class="n">country</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="n">String</code> <code class="nf">getEmoji</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">mEmoji</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">setEmoji</code><code class="o">(</code><code class="n">String</code> <code class="n">emoji</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">mEmoji</code> <code class="o">=</code> <code class="n">emoji</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="n">String</code> <code class="nf">getHours</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="k">return</code> <code class="n">mHours</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">setHours</code><code class="o">(</code><code class="n">String</code> <code class="n">hours</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">mHours</code> <code class="o">=</code> <code class="n">hours</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre data-code-language="kotlin" data-type="programlisting"><code class="n">data</code> <code class="k">class</code> <code class="nc">Location</code><code class="p">(</code>&#13;
    <code class="k">var</code> <code class="py">streetAddress</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">var</code> <code class="py">city</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">var</code> <code class="py">country</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">var</code> <code class="py">emoji</code><code class="p">:</code> <code class="n">String</code><code class="p">,</code>&#13;
    <code class="k">var</code> <code class="py">hours</code><code class="p">:</code> <code class="n">String</code>&#13;
<code class="p">)</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>We’ve<a data-primary="Kotlin" data-secondary="networking" data-tertiary="displaying search results" data-type="indexterm" id="idm46177196266312"/> got a layout, a model, and a general strategy—what’s left is the actual implementation of our logic. We’ll take the deep dive in the next section.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="iOS" data-type="sect2"><div class="sect2" id="idm46177196846136">&#13;
<h2>iOS</h2>&#13;
&#13;
<p>The<a data-primary="networking" data-secondary="iOS" data-tertiary="displaying search results" data-type="indexterm" id="Niosdisplay20"/><a data-primary="application networking" data-secondary="displaying search results" data-tertiary="iOS" data-type="indexterm" id="ANiosdisplay20"/><a data-primary="iOS" data-secondary="networking" data-tertiary="displaying search results" data-type="indexterm" id="IOSnetdisp20"/> approach we’ll take on iOS is very similar, but ever so slightly different. On iOS, it’s common to have a button in our navigation bar to initiate the search process. To start, open up <em>Main.storyboard</em> and head over to the welcome scene. From the library, drag a bar button item onto the right side of the navigation bar. An outline should appear where you can drop the bar button item. Using the<a data-primary="Attributes inspector" data-type="indexterm" id="idm46177196236136"/><a data-primary="Xcode" data-secondary="Attributes inspector" data-type="indexterm" id="idm46177196235432"/> Attributes inspector, set the value for System Item to “Search.” Notice that this will change the button displayed on the screen from a plain button labeled “Item” to a button with a magnifying glass icon.</p>&#13;
&#13;
<p>Now, the welcome screen will function as our jump-off point. We’re going to segue to another view controller to handle displaying our search bar and search results. To facilitate this action, drag a new Table View Controller object from the library onto the canvas near the welcome scene. Next, in the Table View scene, expand the table view and select the table view cell object in the<a data-primary="Document Outline" data-type="indexterm" id="idm46177196233352"/> Document Outline. Inside the Attributes inspector on the right side of the screen, set the Reuse Identifier value to <code>LocationCell</code>. Then, if you’d like, in the Identity inspector set the Title value to “Locations” so that this title will display on this screen whenever it’s shown.</p>&#13;
&#13;
<p>Finally, head back over the welcome screen and Control-click and drag from the search button we placed earlier over to the new Locations scene with the Kind set to Show. This will wire up a segue that will present the Table View scene whenever we click on the magnifying glass button on the welcome screen.</p>&#13;
&#13;
<p>Build and run the app and you’ll see the new search button at the top right of screen. Tap the icon and it should present a blank table view with no results shown.</p>&#13;
&#13;
<p>Unfortunately, this is where our journey ends with the storyboard editor when it comes to searching. We’ve got one more step and that’s to create a custom class for the results view controller so we’re able to initiate the searching. Add<a data-primary="Cocoa Touch" data-secondary="adding new classes" data-type="indexterm" id="idm46177196229832"/> a new Cocoa Touch Class inheriting from <code>UITableViewController</code> named <code>LocationsTableViewController</code> to the project by going to File &gt; New &gt; File in the menu bar. To switch our table view controller over to this class, select the Locations scene, and in the Identity inspector, set the value for Custom Class to “LocationsTableViewController.”</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Controlling our searches" data-type="sect3"><div class="sect3" id="idm46177196227512">&#13;
<h3>Controlling our searches</h3>&#13;
&#13;
<p>There is a handy class in iOS called <code>UISearchController</code> that makes updating the UI for searching fairly straightforward and simple. However, it’s not possible to utilize this class in the storyboard editor or Interface Builder. We’ll have to re-create it <span class="keep-together">manually</span>.</p>&#13;
&#13;
<p>Open up <em>LocationsTableViewController.swift</em>. The first thing we’re going to do is delete all the boilerplate code that Xcode gives us whenever we inherit from <code>UITableViewController</code>. Delete some of the existing methods you see so you end up with a view controller that looks like this:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">import</code> <code class="nc">UIKit</code>&#13;
&#13;
<code class="kd">class</code> <code class="nc">LocationsTableViewController</code><code class="p">:</code> <code class="bp">UITableViewController</code> <code class="p">{</code>&#13;
&#13;
    <code class="kr">override</code> <code class="kd">func</code> <code class="nf">viewDidLoad</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="kc">super</code><code class="p">.</code><code class="n">viewDidLoad</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// </code><code class="cs">MARK:</code><code class="c1"> - Table view data source</code>&#13;
&#13;
    <code class="kr">override</code> <code class="kd">func</code> <code class="nf">numberOfSections</code><code class="p">(</code><code class="k">in</code> <code class="n">tableView</code><code class="p">:</code> <code class="bp">UITableView</code><code class="p">)</code> <code class="p">-&gt;</code>&#13;
    <code class="nb">Int</code> <code class="p">{</code>&#13;
        <code class="c1">// #warning Incomplete implementation, return the number of sections</code>&#13;
        <code class="k">return</code> <code class="mi">0</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kr">override</code> <code class="kd">func</code> <code class="nf">tableView</code><code class="p">(</code><code class="kc">_</code> <code class="n">tableView</code><code class="p">:</code> <code class="bp">UITableView</code><code class="p">,</code> <code class="n">numberOfRowsInSection</code> <code class="n">section</code><code class="p">:</code>&#13;
    <code class="nb">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">Int</code> <code class="p">{</code>&#13;
        <code class="c1">// #warning Incomplete implementation, return the number of rows</code>&#13;
        <code class="k">return</code> <code class="mi">0</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The first thing we’re going to do is instantiate and save our search controller to use whenever our initial view controller, <code>LocationsTableViewController</code>, loads its view. If you’ll recall from our discussion of the life of a view controller in <a data-type="xref" href="ch02.html#topics_views">Chapter 2</a>, this is done by overriding the <code>viewDidLoad</code> method on a view controller. In this instance, we’re using a <code>UITableViewController</code> as our parent class; however, <code>UITableViewController</code> inherits from <code>UIViewController</code> so it adheres to the same set of <span class="keep-together">methods</span>.</p>&#13;
&#13;
<p>Inside the body of <code>viewDidLoad</code>, add the following code:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kr">override</code> <code class="kd">func</code> <code class="nf">viewDidLoad</code><code class="p">()</code> <code class="p">{</code>&#13;
	<code class="kc">super</code><code class="p">.</code><code class="n">viewDidLoad</code><code class="p">()</code>&#13;
&#13;
	<code class="kd">let</code> <code class="nv">searchController</code> <code class="p">=</code> <code class="bp">UISearchController</code><code class="p">(</code><code class="n">searchResultsController</code><code class="p">:</code> <code class="kc">nil</code><code class="p">)</code>&#13;
	<code class="n">searchController</code><code class="p">.</code><code class="n">searchBar</code><code class="p">.</code><code class="n">delegate</code> <code class="p">=</code> <code class="kc">self</code>&#13;
	<code class="n">searchController</code><code class="p">.</code><code class="n">searchBar</code><code class="p">.</code><code class="n">placeholder</code> <code class="p">=</code> <code class="s">"Search Locations by Country"</code>&#13;
	<code class="n">searchController</code><code class="p">.</code><code class="n">obscuresBackgroundDuringPresentation</code> <code class="p">=</code> <code class="kc">false</code>&#13;
	<code class="n">definesPresentationContext</code> <code class="p">=</code> <code class="kc">true</code>&#13;
&#13;
	<code class="n">navigationItem</code><code class="p">.</code><code class="n">searchController</code> <code class="p">=</code> <code class="n">searchController</code>&#13;
	<code class="n">navigationItem</code><code class="p">.</code><code class="n">hidesSearchBarWhenScrolling</code> <code class="p">=</code> <code class="kc">false</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This code creates a new <code>UISearchController</code> object and assigns it to the variable <code>searchController</code>. We then set the <code>delegate</code> on the search bar to respond to whenever a search is done being entered by the user. We’ll adhere to that protocol momentarily, so let’s continue—ignoring the compiler error for now, of course. Next, we set some placeholder text for the search bar that’s created. In this instance, it’s just “Search Locations by Country,” but it could be whatever we desire to give users some guidance about what we’re actually searching.</p>&#13;
&#13;
<p>The next two lines are important for the display of the search results. <code>UISearchController</code> is utilized to provide a consistent experience for searching in iOS. There are some predefined behaviors that we want to configure to make searching as best of an experience as possible. The first property, <code>obscuresBackgroundDuringPresentation</code>, prevents the search controller from dimming the current view controller we’re in to display the search results. This is important because when we initialize our search controller, we’re not providing a new <code>searchResultsViewController</code> directly, so our search results are going to display in this view controller. If this view controller is dimmed, the experience might seem a bit off for users.</p>&#13;
&#13;
<p>Because of this, we also need to make sure that <code>definesPresentationContext</code> is set to <code>true</code> so that when the <code>UISearchController</code> displays its results view, the view controller we’re in is the one that provides the context of the results display and the search bar display. It basically means this view controller will prevent the search bar from remaining on-screen if we navigate to another view.</p>&#13;
&#13;
<p>The last thing we do is set the <code>searchController</code> we just created as the search controller for the navigation item. This allows the parent navigation controller that controls this view to display the search bar inside its navigation bar (among other things). We also set a property called <code>hidesSearchBarWhenScrolling</code> that keeps the search bar visible at all times.</p>&#13;
&#13;
<p>Now, we need to make our view controller adhere to <code>UISearchBarDelegate</code>. This is the protocol necessary to update the table view that’s displaying the search results. Whenever the Search button is tapped on the keyboard (or the Return key hit), this method is called. A simple, but temporarily incomplete, version of this method could be added as an extension onto <code>LocationsTableViewController</code> like so:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">extension</code> <code class="nc">LocationsTableViewController</code><code class="p">:</code> <code class="bp">UISearchBarDelegate</code> <code class="p">{</code>&#13;
    <code class="kd">func</code> <code class="nf">searchBarTextDidEndEditing</code><code class="p">(</code><code class="kc">_</code> <code class="n">searchBar</code><code class="p">:</code> <code class="bp">UISearchBar</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="c1">// </code><code class="cs">TODO:</code><code class="c1"> Update the table view from the search results</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>If you build and run the project, you’ll see something like this whenever you tap on the magnifying glass to view the location search screen.</p>&#13;
&#13;
<p>We’re very close to populating this table view. It’s time to start communicating with the network!<a data-primary="" data-startref="Niosdisplay20" data-type="indexterm" id="idm46177195934184"/><a data-primary="" data-startref="ANiosdisplay20" data-type="indexterm" id="idm46177195876008"/><a data-primary="" data-startref="IOSnetdisp20" data-type="indexterm" id="idm46177195875064"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Building a Search Endpoint" data-type="sect1"><div class="sect1" id="idm46177197268792">&#13;
<h1>Building a Search Endpoint</h1>&#13;
&#13;
<p>Now, you<a data-primary="networking" data-secondary="building search endpoints" data-tertiary="approaches to" data-type="indexterm" id="idm46177195872792"/><a data-primary="application networking" data-secondary="building search endpoints" data-tertiary="approaches to" data-type="indexterm" id="idm46177195871544"/> might have noticed this <em>isn’t</em> a book on web services, per se. This puts us in something of a conundrum because in order to communicate with a web service we need to have…a web service. There are a number of ways you can approach this. If you’d like, you could just follow along in the code without actually hitting a web service. Luckily, the app should still function just fine, there just won’t be any results. In a second, we’ll look at what our library locations JSON that the app is going to consume will look like, so you could put that somewhere locally and have the app consume that file.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>If you add a file locally, you’ll need to make sure you specify the <code>Content-Type</code> of the content as <code>application/json</code>. Some services, like Google Drive, have support for this, but this is outside the scope of this book.</p>&#13;
</div>&#13;
&#13;
<p>A perfectly viable option, however, is to write a very quick-and-dirty node.js service to handle serving out the content. In fact, the authors have written such a service. It uses Express to make things simple. If you know anything about Node, it’s very easy to work with a service locally.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Installing Node and Express" data-type="sect2"><div class="sect2" id="idm46177195866248">&#13;
<h2>Installing Node and Express</h2>&#13;
&#13;
<p>What<a data-primary="networking" data-secondary="building search endpoints" data-tertiary="installing Node and Express" data-type="indexterm" id="idm46177195925112"/><a data-primary="application networking" data-secondary="building search endpoints" data-tertiary="installing Node and Express" data-type="indexterm" id="idm46177195923752"/><a data-primary="Node" data-type="indexterm" id="idm46177195922504"/><a data-primary="Express" data-type="indexterm" id="idm46177195921832"/> follows is the quickest “get up and running” with a web service you’ll ever find. If you are already up to speed with Node, you can probably skip this part. Or, if you’re not interested in installing and working with Node, you can safely skip this part as well. The instructions were largely taken from the Node and Express websites. Let’s go!</p>&#13;
<ol>&#13;
<li>&#13;
<p>Navigate to <a href="https://nodejs.org"><em class="hyperlink">https://nodejs.org</em></a> and install the latest version of Node.</p>&#13;
</li>&#13;
<li>&#13;
<p>Open up Terminal and create a directory to hold your project called <em>library-node-service</em>.</p>&#13;
&#13;
<pre data-type="programlisting">$ mkdir library-node-service&#13;
$ cd library-node-service</pre>&#13;
</li>&#13;
<li>&#13;
<p>Initialize a new Node project by calling <code>npm init</code> at the prompt. There will be a number of options, and you can safely hit Enter to go past all of them and use the default values.</p>&#13;
</li>&#13;
<li>&#13;
<p>Run the command <code>npm install express --save</code> to install Express to the project. Express is a lightweight framework useful for writing quick-and-dirty Node services. Perfect for our use case.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create a file named <em>index.js</em> if it doesn’t exist already and put the following code in that file:</p>&#13;
&#13;
<pre class="small" data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">)</code>&#13;
<code class="kr">const</code> <code class="nx">PORT</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code>&#13;
&#13;
<code class="nx">express</code><code class="p">()</code>&#13;
  <code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/catalog'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="nx">catalog</code><code class="p">(</code><code class="nx">req</code><code class="p">)))</code>&#13;
  <code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/locations'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="nx">locations</code><code class="p">(</code><code class="nx">req</code><code class="p">)))</code>&#13;
  <code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">PORT</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Listening on </code><code class="si">${</code> <code class="nx">PORT</code> <code class="si">}</code><code class="sb">`</code><code class="p">))</code>&#13;
&#13;
<code class="nx">catalog</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
	<code class="kd">var</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>&#13;
	<code class="kd">var</code> <code class="nx">json</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">fs</code><code class="p">.</code><code class="nx">readFileSync</code><code class="p">(</code><code class="s1">'catalog.json'</code><code class="p">,</code> <code class="s1">'utf8'</code><code class="p">));</code>&#13;
	<code class="kr">const</code> <code class="nx">query</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">q</code> <code class="o">||</code> <code class="s2">""</code><code class="p">).</code><code class="nx">toLowerCase</code><code class="p">()</code>&#13;
	<code class="k">return</code> <code class="nx">json</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="nx">book</code> <code class="o">=&gt;</code> <code class="nx">book</code><code class="p">.</code><code class="nx">title</code><code class="p">.</code><code class="nx">toLowerCase</code><code class="p">().</code><code class="nx">startsWith</code><code class="p">(</code><code class="nx">query</code><code class="p">))</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="nx">locations</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
	<code class="kd">var</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>&#13;
	<code class="kd">var</code> <code class="nx">json</code> <code class="o">=</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">fs</code><code class="p">.</code><code class="nx">readFileSync</code><code class="p">(</code><code class="s1">'locations.json'</code><code class="p">,</code> <code class="s1">'utf8'</code><code class="p">));</code>&#13;
	<code class="kr">const</code> <code class="nx">query</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">country</code> <code class="o">||</code> <code class="s2">""</code><code class="p">).</code><code class="nx">toLowerCase</code><code class="p">()</code>&#13;
	<code class="k">return</code> <code class="nx">json</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="nx">loc</code> <code class="o">=&gt;</code> <code class="nx">loc</code><code class="p">.</code><code class="nx">country</code><code class="p">.</code><code class="nx">toLowerCase</code><code class="p">().</code><code class="nx">startsWith</code><code class="p">(</code><code class="nx">query</code><code class="p">))</code>&#13;
<code class="p">}</code></pre>&#13;
</li>&#13;
<li>&#13;
<p>Copy a version of <em>catalog.json</em> from the Xcode or Android Studio project and put it in the same directory as <em>index.js</em>. (Do the same with <em>locations.json</em> when we create it in just a moment.)</p>&#13;
</li>&#13;
<li>&#13;
<p>To run the app locally, type <code>node index.js</code> from the command prompt. Your app should now be accessible at <em><a href="http://localhost:3000"><em class="hyperlink">http://localhost:3000</em></a></em>. You can check this by going to <em><a href="http://localhost:3000/catalog"><em class="hyperlink">http://localhost:3000/catalog</em></a></em>; you should see a list of all the books in our <em>catalog.json</em> file.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Locations JSON File" data-type="sect2"><div class="sect2" id="idm46177195651144">&#13;
<h2>Locations JSON File</h2>&#13;
&#13;
<p>We’re<a data-primary="networking" data-secondary="building search endpoints" data-tertiary="locations JSON file" data-type="indexterm" id="idm46177195649816"/><a data-primary="application networking" data-secondary="building search endpoints" data-tertiary="installing Node and Express" data-type="indexterm" id="idm46177195648568"/> going to be using JSON again as the transport structure for the data we’re receiving from our web service. Here’s what our <code>locations.json</code> file should look like:</p>&#13;
<pre data-code-language="javascript" data-type="programlisting">&#13;
<code class="p">[</code><code>&#13;
    </code><code class="p">{</code><code>&#13;
        </code><code class="s2">"street_address"</code><code class="o">:</code><code> </code><code class="s2">"123 Eiffel Tower Street"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"city"</code><code class="o">:</code><code> </code><code class="s2">"Paris"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"country"</code><code class="o">:</code><code> </code><code class="s2">"France"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"emoji"</code><code class="o">:</code><code> </code><code class="s2">"</code><img alt="French flag" class="emoji" src="assets/fr.png"/><code class="s2">"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"hours"</code><code class="o">:</code><code> </code><code class="s2">"8am–7pm"</code><code>&#13;
    </code><code class="p">}</code><code class="p">,</code><code>&#13;
    </code><code class="p">{</code><code>&#13;
        </code><code class="s2">"street_address"</code><code class="o">:</code><code> </code><code class="s2">"86 Libery Boulevard"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"city"</code><code class="o">:</code><code> </code><code class="s2">"New York"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"country"</code><code class="o">:</code><code> </code><code class="s2">"America"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"emoji"</code><code class="o">:</code><code> </code><code class="s2">"</code><img alt="us flag" class="emoji" src="assets/us.png"/><code class="s2">"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"hours"</code><code class="o">:</code><code> </code><code class="s2">"6am–10pm"</code><code>&#13;
    </code><code class="p">}</code><code class="p">,</code><code>&#13;
    </code><code class="p">{</code><code>&#13;
        </code><code class="s2">"street_address"</code><code class="o">:</code><code> </code><code class="s2">"49 Lombard Street"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"city"</code><code class="o">:</code><code> </code><code class="s2">"San Francisco"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"country"</code><code class="o">:</code><code> </code><code class="s2">"America"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"emoji"</code><code class="o">:</code><code> </code><code class="s2">"</code><img alt="us flag" class="emoji" src="assets/us.png"/><code class="s2">"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"hours"</code><code class="o">:</code><code> </code><code class="s2">"8am–8pm"</code><code>&#13;
    </code><code class="p">}</code><code class="p">,</code><code>&#13;
    </code><code class="p">{</code><code>&#13;
        </code><code class="s2">"street_address"</code><code class="o">:</code><code> </code><code class="s2">"1901 Aussie Way"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"city"</code><code class="o">:</code><code> </code><code class="s2">"Melbourne"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"country"</code><code class="o">:</code><code> </code><code class="s2">"Australia"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"emoji"</code><code class="o">:</code><code> </code><code class="s2">"</code><img alt="Australian flag" class="emoji" src="assets/aus.png"/><code class="s2">"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"hours"</code><code class="o">:</code><code> </code><code class="s2">"7am–8pm"</code><code>&#13;
    </code><code class="p">}</code><code class="p">,</code><code>&#13;
    </code><code class="p">{</code><code>&#13;
        </code><code class="s2">"street_address"</code><code class="o">:</code><code> </code><code class="s2">"302 Deutsch Avenue"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"city"</code><code class="o">:</code><code> </code><code class="s2">"Berlin"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"country"</code><code class="o">:</code><code> </code><code class="s2">"Germany"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"emoji"</code><code class="o">:</code><code> </code><code class="s2">"</code><img alt="German flag" class="emoji" src="assets/ger.png"/><code class="s2">"</code><code class="p">,</code><code>&#13;
        </code><code class="s2">"hours"</code><code class="o">:</code><code> </code><code class="s2">"9am–6pm"</code><code>&#13;
    </code><code class="p">}</code><code>&#13;
</code><code class="p">]</code><code>&#13;
</code></pre>&#13;
&#13;
<p>As you might have noticed, this contains a few locations. These are just example locations (and not actually real) and used to illustrate the structure of our data. Feel free to add more locations as you see fit. It’s an opportunity to be a bit creative!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Calling Our Service" data-type="sect1"><div class="sect1" id="idm46177195393736">&#13;
<h1>Calling Our Service</h1>&#13;
&#13;
<p>In order to send a request to our service, it’s good practice in Android and iOS to build an object that’s responsible for handling the communication instead of directly dealing with API calls in our view layer. The object we’re creating will be called <span class="keep-together"><code>LocationsController</code></span>, and it’ll be an intermediary between our search user interface and our network service. Once the object is created, we’ll wire everything up.</p>&#13;
&#13;
<p>Let’s check out how this is done in Android first.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Android" data-type="sect2"><div class="sect2" id="idm46177195390600">&#13;
<h2>Android</h2>&#13;
&#13;
<p>So<a data-primary="networking" data-secondary="handling communications" data-tertiary="Android" data-type="indexterm" id="Ncommand20"/><a data-primary="application networking" data-secondary="handling communications" data-tertiary="Android" data-type="indexterm" id="ANcommand20"/> while there are a number of services that can aid in interacting with RESTful web services, we’re going to again defer to standard libraries (for the most part) to make the network request as shown in <a data-type="xref" href="ch09.html#topics_networking">Chapter 9</a>. Since we’re assuming the result will come back as a JSON string, we’ll once again fall back on the Gson library discussed in <a data-type="xref" href="ch12.html#topics_transports">Chapter 12</a>. Since we’ve seen so much of this already in our evolving app, like deserializing JSON, the <code>RecyclerView</code> with <code>Adapter</code> mechanism, and passing data via <code>Intents</code>, let’s just jump right in. What follows is a single <code>Activity</code> with all of the relevant search and UI code encapsulated. If this app were to get any larger or need more flexibility in its feature set, you’d probably want to start separating out logical blocks into the appropriate classes and interfaces right away—but since we’ve seen almost all of this before, let’s just blast out a quick and dirty feature-full file<a data-primary="Java" data-secondary="networking" data-tertiary="handling communications" data-type="indexterm" id="Jnetcomm20"/><a data-primary="Kotlin" data-secondary="networking" data-tertiary="handling communications" data-type="indexterm" id="Knetcomm20"/> and ship to our client (who’re never known for either their patience or their appreciation of elegant code):</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177195356072">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">SearchResultsActivity</code> <code class="kd">extends</code> <code class="n">Activity</code> <code class="o">{</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kd">static</code> <code class="kd">final</code> <code class="n">String</code> <code class="n">QUERY</code> <code class="o">=</code> <code class="s">"QUERY"</code><code class="o">;</code>&#13;
&#13;
  <code class="kd">private</code> <code class="n">ProgressBar</code> <code class="n">mProgressBar</code><code class="o">;</code>&#13;
  <code class="kd">private</code> <code class="n">RecyclerView</code> <code class="n">mRecyclerView</code><code class="o">;</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">onCreate</code><code class="o">(</code><code class="nd">@Nullable</code> <code class="n">Bundle</code> <code class="n">savedInstanceState</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="kd">super</code><code class="o">.</code><code class="na">onCreate</code><code class="o">(</code><code class="n">savedInstanceState</code><code class="o">);</code>&#13;
    <code class="n">setContentView</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">layout</code><code class="o">.</code><code class="na">activity_search</code><code class="o">);</code>&#13;
    <code class="n">mProgressBar</code> <code class="o">=</code> <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">search_progress</code><code class="o">);</code>&#13;
    <code class="n">mRecyclerView</code> <code class="o">=</code> <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">search_results_recyclerview</code><code class="o">);</code>&#13;
    <code class="n">mRecyclerView</code><code class="o">.</code><code class="na">setLayoutManager</code><code class="o">(</code><code class="k">new</code> <code class="n">LinearLayoutManager</code><code class="o">(</code><code class="k">this</code><code class="o">));</code>&#13;
    <code class="n">String</code> <code class="n">query</code> <code class="o">=</code> <code class="n">getIntent</code><code class="o">().</code><code class="na">getStringExtra</code><code class="o">(</code><code class="n">QUERY</code><code class="o">);</code>&#13;
    <code class="k">new</code> <code class="nf">Thread</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">fetchResults</code><code class="o">(</code><code class="s">"magic://my.app/search?query="</code> <code class="o">+</code> <code class="n">query</code><code class="o">)).</code><code class="na">start</code><code class="o">();</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">private</code> <code class="kt">void</code> <code class="nf">onResultsReceived</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Location</code><code class="o">&gt;</code> <code class="n">locations</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="n">mProgressBar</code><code class="o">.</code><code class="na">setVisibility</code><code class="o">(</code><code class="n">View</code><code class="o">.</code><code class="na">GONE</code><code class="o">);</code>&#13;
    <code class="n">mRecyclerView</code><code class="o">.</code><code class="na">setVisibility</code><code class="o">(</code><code class="n">View</code><code class="o">.</code><code class="na">VISIBLE</code><code class="o">);</code>&#13;
    <code class="n">Adapter</code> <code class="n">adapter</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Adapter</code><code class="o">(</code><code class="n">locations</code><code class="o">);</code>&#13;
    <code class="n">mRecyclerView</code><code class="o">.</code><code class="na">setAdapter</code><code class="o">(</code><code class="n">adapter</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">private</code> <code class="kt">void</code> <code class="nf">fetchResults</code><code class="o">(</code><code class="n">String</code> <code class="n">urlWithQuery</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">try</code> <code class="o">{</code>&#13;
      <code class="n">StringBuilder</code> <code class="n">builder</code> <code class="o">=</code> <code class="k">new</code> <code class="n">StringBuilder</code><code class="o">();</code>&#13;
      <code class="n">URL</code> <code class="n">url</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URL</code><code class="o">(</code><code class="n">urlWithQuery</code><code class="o">);</code>&#13;
      <code class="n">HttpURLConnection</code> <code class="n">connection</code> <code class="o">=</code> <code class="o">(</code><code class="n">HttpURLConnection</code><code class="o">)</code> <code class="n">url</code><code class="o">.</code><code class="na">openConnection</code><code class="o">();</code>&#13;
      <code class="kt">int</code> <code class="n">data</code><code class="o">;</code>&#13;
      <code class="k">while</code> <code class="o">((</code><code class="n">data</code> <code class="o">=</code> <code class="n">connection</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">().</code><code class="na">read</code><code class="o">())</code> <code class="o">!=</code> <code class="o">-</code><code class="mi">1</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">builder</code><code class="o">.</code><code class="na">append</code><code class="o">((</code><code class="kt">char</code><code class="o">)</code> <code class="n">data</code><code class="o">);</code>&#13;
      <code class="o">}</code>&#13;
      <code class="n">String</code> <code class="n">json</code> <code class="o">=</code> <code class="n">builder</code><code class="o">.</code><code class="na">toString</code><code class="o">();</code>&#13;
      <code class="n">List</code><code class="o">&lt;</code><code class="n">Location</code><code class="o">&gt;</code> <code class="n">locations</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Gson</code><code class="o">().</code><code class="na">fromJson</code><code class="o">(</code><code class="n">json</code><code class="o">,</code>&#13;
        <code class="k">new</code> <code class="n">TypeToken</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Location</code><code class="o">&gt;&gt;(){}.</code><code class="na">getType</code><code class="o">());</code>&#13;
      <code class="n">onResultsReceived</code><code class="o">(</code><code class="n">locations</code><code class="o">);</code>&#13;
    <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">IOException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyApp"</code><code class="o">,</code>&#13;
        <code class="s">"Something went wrong when fetching results. Probably the fake URL! "</code> <code class="o">+</code>&#13;
        <code class="n">e</code><code class="o">.</code><code class="na">getMessage</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">private</code> <code class="kd">static</code> <code class="kd">class</code> <code class="nc">Adapter</code> <code class="kd">extends</code> <code class="n">RecyclerView</code><code class="o">.</code><code class="na">Adapter</code><code class="o">&lt;</code><code class="n">Adapter</code><code class="o">.</code><code class="na">ViewHolder</code><code class="o">&gt;</code> <code class="o">{</code>&#13;
&#13;
    <code class="kd">private</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Location</code><code class="o">&gt;</code> <code class="n">mLocations</code><code class="o">;</code>&#13;
&#13;
    <code class="kd">public</code> <code class="nf">Adapter</code><code class="o">(</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Location</code><code class="o">&gt;</code> <code class="n">locations</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="n">mLocations</code> <code class="o">=</code> <code class="n">locations</code><code class="o">;</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Override</code>&#13;
    <code class="kd">public</code> <code class="n">ViewHolder</code> <code class="nf">onCreateViewHolder</code><code class="o">(</code><code class="nd">@NonNull</code> <code class="n">ViewGroup</code> <code class="n">parent</code><code class="o">,</code> <code class="kt">int</code> <code class="n">viewType</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="k">return</code> <code class="k">new</code> <code class="nf">ViewHolder</code><code class="o">(</code><code class="k">new</code> <code class="n">TextView</code><code class="o">(</code><code class="n">parent</code><code class="o">.</code><code class="na">getContext</code><code class="o">()));</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Override</code>&#13;
    <code class="kd">public</code> <code class="kt">void</code> <code class="nf">onBindViewHolder</code><code class="o">(</code><code class="nd">@NonNull</code> <code class="n">ViewHolder</code> <code class="n">holder</code><code class="o">,</code> <code class="kt">int</code> <code class="n">position</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="n">Location</code> <code class="n">location</code> <code class="o">=</code> <code class="n">mLocations</code><code class="o">.</code><code class="na">get</code><code class="o">(</code><code class="n">position</code><code class="o">);</code>&#13;
      <code class="n">holder</code><code class="o">.</code><code class="na">mTextView</code><code class="o">.</code><code class="na">setText</code><code class="o">(</code><code class="n">location</code><code class="o">.</code><code class="na">getStreetAddress</code><code class="o">()</code> <code class="o">+</code> <code class="s">", "</code> <code class="o">+</code> <code class="n">location</code><code class="o">.</code><code class="na">getCity</code><code class="o">()</code> <code class="o">+</code>&#13;
      <code class="s">", "</code> <code class="o">+</code> <code class="n">location</code><code class="o">.</code><code class="na">getCountry</code><code class="o">());</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="nd">@Override</code>&#13;
    <code class="kd">public</code> <code class="kt">int</code> <code class="nf">getItemCount</code><code class="o">()</code> <code class="o">{</code>&#13;
      <code class="k">return</code> <code class="n">mLocations</code><code class="o">.</code><code class="na">size</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">static</code> <code class="kd">class</code> <code class="nc">ViewHolder</code> <code class="kd">extends</code> <code class="n">RecyclerView</code><code class="o">.</code><code class="na">ViewHolder</code> <code class="o">{</code>&#13;
      <code class="kd">private</code> <code class="n">TextView</code> <code class="n">mTextView</code><code class="o">;</code>&#13;
      <code class="kd">public</code> <code class="nf">ViewHolder</code><code class="o">(</code><code class="n">View</code> <code class="n">itemView</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="kd">super</code><code class="o">(</code><code class="n">itemView</code><code class="o">);</code>&#13;
        <code class="n">mTextView</code> <code class="o">=</code> <code class="o">(</code><code class="n">TextView</code><code class="o">)</code> <code class="n">itemView</code><code class="o">;</code>&#13;
      <code class="o">}</code>&#13;
    <code class="o">}</code>&#13;
  <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="python" data-type="programlisting"><code class="k">class</code> <code class="nc">SearchResultsActivity</code> <code class="p">:</code> <code class="n">Activity</code><code class="p">()</code> <code class="p">{</code>&#13;
&#13;
  <code class="n">override</code> <code class="n">fun</code> <code class="n">onCreate</code><code class="p">(</code><code class="n">savedInstanceState</code><code class="p">:</code> <code class="n">Bundle</code><code class="err">?</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nb">super</code><code class="o">.</code><code class="n">onCreate</code><code class="p">(</code><code class="n">savedInstanceState</code><code class="p">)</code>&#13;
    <code class="n">setContentView</code><code class="p">(</code><code class="n">R</code><code class="o">.</code><code class="n">layout</code><code class="o">.</code><code class="n">activity_search</code><code class="p">)</code>&#13;
    <code class="n">search_results_recyclerview</code><code class="o">.</code><code class="n">layoutManager</code> <code class="o">=</code> <code class="n">LinearLayoutManager</code><code class="p">(</code><code class="n">this</code><code class="p">)</code>&#13;
    <code class="n">val</code> <code class="n">query</code> <code class="o">=</code> <code class="n">intent</code><code class="o">.</code><code class="n">getStringExtra</code><code class="p">(</code><code class="n">QUERY</code><code class="p">)</code>&#13;
    <code class="n">Thread</code> <code class="p">{</code> <code class="n">fetchResults</code><code class="p">(</code><code class="s2">"magic://my.app/search?query=$query"</code><code class="p">)</code> <code class="p">}</code><code class="o">.</code><code class="n">start</code><code class="p">()</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="n">private</code> <code class="n">fun</code> <code class="n">onResultsReceived</code><code class="p">(</code><code class="n">locations</code><code class="p">:</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Location</code><code class="o">&gt;</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="n">search_progress</code><code class="o">.</code><code class="n">visibility</code> <code class="o">=</code> <code class="n">View</code><code class="o">.</code><code class="n">GONE</code>&#13;
    <code class="n">search_results_recyclerview</code><code class="o">.</code><code class="n">visibility</code> <code class="o">=</code> <code class="n">View</code><code class="o">.</code><code class="n">VISIBLE</code>&#13;
    <code class="n">search_results_recyclerview</code><code class="o">.</code><code class="n">adapter</code> <code class="o">=</code> <code class="n">Adapter</code><code class="p">(</code><code class="n">locations</code><code class="p">)</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="n">private</code> <code class="n">fun</code> <code class="n">fetchResults</code><code class="p">(</code><code class="n">urlWithQuery</code><code class="p">:</code> <code class="n">String</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">try</code> <code class="p">{</code>&#13;
      <code class="n">val</code> <code class="n">builder</code> <code class="o">=</code> <code class="n">StringBuilder</code><code class="p">()</code>&#13;
      <code class="n">val</code> <code class="n">url</code> <code class="o">=</code> <code class="n">URL</code><code class="p">(</code><code class="n">urlWithQuery</code><code class="p">)</code>&#13;
      <code class="n">val</code> <code class="n">connection</code> <code class="o">=</code> <code class="n">url</code><code class="o">.</code><code class="n">openConnection</code><code class="p">()</code> <code class="k">as</code> <code class="n">HttpURLConnection</code>&#13;
      <code class="n">var</code> <code class="n">data</code><code class="p">:</code> <code class="n">Int</code> <code class="o">=</code> <code class="n">connection</code><code class="o">.</code><code class="n">inputStream</code><code class="o">.</code><code class="n">read</code><code class="p">()</code>&#13;
      <code class="k">while</code> <code class="p">(</code><code class="n">data</code> <code class="o">!=</code> <code class="o">-</code><code class="mi">1</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">builder</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">data</code><code class="o">.</code><code class="n">toChar</code><code class="p">())</code>&#13;
        <code class="n">data</code> <code class="o">=</code> <code class="n">connection</code><code class="o">.</code><code class="n">inputStream</code><code class="o">.</code><code class="n">read</code><code class="p">()</code>&#13;
      <code class="p">}</code>&#13;
      <code class="n">val</code> <code class="n">json</code> <code class="o">=</code> <code class="n">builder</code><code class="o">.</code><code class="n">toString</code><code class="p">()</code>&#13;
      <code class="n">val</code> <code class="n">locations</code> <code class="o">=</code> <code class="n">Gson</code><code class="p">()</code><code class="o">.</code><code class="n">fromJson</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Location</code><code class="o">&gt;&gt;</code><code class="p">(</code><code class="n">json</code><code class="p">,</code>&#13;
        <code class="nb">object</code> <code class="p">:</code> <code class="n">TypeToken</code><code class="o">&lt;</code><code class="n">List</code><code class="o">&lt;</code><code class="n">Location</code><code class="o">&gt;&gt;</code><code class="p">()</code> <code class="p">{}</code><code class="o">.</code><code class="n">type</code><code class="p">)</code>&#13;
      <code class="n">onResultsReceived</code><code class="p">(</code><code class="n">locations</code><code class="p">)</code>&#13;
    <code class="p">}</code> <code class="n">catch</code> <code class="p">(</code><code class="n">e</code><code class="p">:</code> <code class="n">IOException</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="n">Log</code><code class="o">.</code><code class="n">d</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="s2">"Something went wrong when fetching results.</code>&#13;
      <code class="n">Probably</code> <code class="n">the</code> <code class="n">fake</code> <code class="n">URL</code><code class="err">!</code><code class="s2">")</code>&#13;
    <code class="p">}</code>&#13;
&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="n">private</code> <code class="k">class</code> <code class="nc">Adapter</code><code class="p">(</code><code class="n">private</code> <code class="n">val</code> <code class="n">locations</code><code class="p">:</code> <code class="n">List</code><code class="o">&lt;</code><code class="n">Location</code><code class="o">&gt;</code><code class="p">)</code> <code class="p">:</code>&#13;
    <code class="n">RecyclerView</code><code class="o">.</code><code class="n">Adapter</code><code class="o">&lt;</code><code class="n">Adapter</code><code class="o">.</code><code class="n">ViewHolder</code><code class="o">&gt;</code><code class="p">()</code> <code class="p">{</code>&#13;
&#13;
    <code class="n">override</code> <code class="n">fun</code> <code class="n">onCreateViewHolder</code><code class="p">(</code><code class="n">parent</code><code class="p">:</code> <code class="n">ViewGroup</code><code class="p">,</code> <code class="n">viewType</code><code class="p">:</code> <code class="n">Int</code><code class="p">):</code> <code class="n">ViewHolder</code> <code class="p">{</code>&#13;
      <code class="k">return</code> <code class="n">ViewHolder</code><code class="p">(</code><code class="n">TextView</code><code class="p">(</code><code class="n">parent</code><code class="o">.</code><code class="n">context</code><code class="p">))</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="n">override</code> <code class="n">fun</code> <code class="n">onBindViewHolder</code><code class="p">(</code><code class="n">holder</code><code class="p">:</code> <code class="n">ViewHolder</code><code class="p">,</code> <code class="n">position</code><code class="p">:</code> <code class="n">Int</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="n">val</code> <code class="p">(</code><code class="n">streetAddress</code><code class="p">,</code> <code class="n">city</code><code class="p">,</code> <code class="n">country</code><code class="p">)</code> <code class="o">=</code> <code class="n">locations</code><code class="p">[</code><code class="n">position</code><code class="p">]</code>&#13;
      <code class="n">holder</code><code class="o">.</code><code class="n">textView</code><code class="o">.</code><code class="n">text</code> <code class="o">=</code> <code class="s2">"$streetAddress, $city, $country"</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="n">override</code> <code class="n">fun</code> <code class="n">getItemCount</code><code class="p">():</code> <code class="n">Int</code> <code class="p">{</code>&#13;
      <code class="k">return</code> <code class="n">locations</code><code class="o">.</code><code class="n">size</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="n">private</code> <code class="k">class</code> <code class="nc">ViewHolder</code><code class="p">(</code><code class="n">itemView</code><code class="p">:</code> <code class="n">View</code><code class="p">)</code> <code class="p">:</code> <code class="n">RecyclerView</code><code class="o">.</code><code class="n">ViewHolder</code><code class="p">(</code><code class="n">itemView</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="n">val</code> <code class="n">textView</code><code class="p">:</code> <code class="n">TextView</code> <code class="o">=</code> <code class="n">itemView</code> <code class="k">as</code> <code class="n">TextView</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="n">companion</code> <code class="nb">object</code> <code class="p">{</code>&#13;
      <code class="n">val</code> <code class="n">QUERY</code> <code class="o">=</code> <code class="s2">"QUERY"</code>&#13;
  <code class="p">}</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>(Remember to add this <code>Activity</code> to your <em>AndroidManifest.xml</em>!)</p>&#13;
&#13;
<p>Pretty long! So what’s going on in there? Previously, we’ve broken operations down line by line and explained precisely what each statement or expression was intended to do. As we mature as developers, let’s depart from that a bit—we’ll do our best to explain what’s happening here like we would to an experienced colleague, one who may be about to review the code or run some QA, or even just catch up with the feature for potential extensions.</p>&#13;
&#13;
<p>Obviously, we’ have an <code>Activity</code>, so a dedicated screenful of information. The <code>Activity</code> expects a <code>String</code> to be passed to it immediately, representing a search query, that it got from the <code>SearchView</code> in the <code>BrowseContentActivity</code>.</p>&#13;
&#13;
<p>The <code>Activity</code>’s layout initially shows a <code>ProgressBar</code> spinning in the center of the screen to show we’re doing work in the background. The <code>RecyclerView</code> is not rendered until we’ve successfully fetched content.</p>&#13;
&#13;
<p>During the creation cycle, we’ll take that search term and append it to the known URL of our search web service. We’ll use standard library classes like <code>URL</code> and <code>HttpConnection</code> to get the server’s response as bytes and read them into a <code>String</code>.</p>&#13;
&#13;
<p>Let’s make sure we do that in a background <code>Thread</code> so we don’t block the UI while the network request is happening; we’ve all seen even simple responses sometimes take several seconds (or more) to resolve—it’s not  good if our UI is frozen that whole time.</p>&#13;
&#13;
<p>Since we know we’re dealing with a traditional RESTful JSON response, we’ll use Gson to parse it into what we expect: a collection of <code>Location</code> objects. Assuming that’s successful, let’s hide the <code>ProgressBar</code> and show the <code>RecyclerView</code> and then pass those <code>Location</code> instances to a custom <code>Adapter</code> and attach it. If there’s a failure in the network call, or the deserialization operation, we’re just logging out failure—in a production-ready app, you’d probably want some kind of UI to display to the user, report it back to you, or even retry the operation.</p>&#13;
&#13;
<p>Now that our <code>RecyclerView</code> has a primed and populated <code>Adapter</code>, we should see a list of all the <code>Location</code> objects returned from our search, presented in an arbitrary <code>String</code> representing the physical location of the library.</p>&#13;
&#13;
<p>Even poorly designed, high line count code can be pretty straightforward if we know how to use the tools we’re given.<a data-primary="" data-startref="Knetcomm20" data-type="indexterm" id="idm46177194442600"/><a data-primary="" data-startref="Jnetcomm20" data-type="indexterm" id="idm46177194441624"/><a data-primary="" data-startref="ANcommand20" data-type="indexterm" id="idm46177194440680"/><a data-primary="" data-startref="Ncommand20" data-type="indexterm" id="idm46177194439736"/></p>&#13;
&#13;
<p>Let’s see how our iOS friends handle this…</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="iOS" data-type="sect2"><div class="sect2" id="idm46177195389976">&#13;
<h2>iOS</h2>&#13;
&#13;
<p>In<a data-primary="networking" data-secondary="handling communications" data-tertiary="iOS" data-type="indexterm" id="Ncommios20"/><a data-primary="application networking" data-secondary="handling communications" data-tertiary="iOS" data-type="indexterm" id="ANcommios20"/><a data-primary="iOS" data-secondary="networking" data-tertiary="handling communications" data-type="indexterm" id="IOSnetcomm20"/> Xcode, add a new Swift file to the project called <code>LocationsController</code>. If you’ll recall, our UI has one primary purpose: retrieve a list of additional library locations from a given country. The service we built has an endpoint that does just this. If you hit <em>http://localhost:3000/locations?country=<code>&lt;country name&gt;</code></em>, you’ll see a list of filtered locations for a given country. So, we have a parameter, <code>country</code>, where we can pass our country name.</p>&#13;
&#13;
<p>In code, we might think of <code>LocationsController</code> as having one method that fetches the locations for a given country. We can express that with a method like so:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">func</code> <code class="nf">fetchLocations</code><code class="p">(</code><code class="k">for</code> <code class="n">country</code><code class="p">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="p">[</code><code class="n">Location</code><code class="p">]</code> <code class="p">{</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>We need to define <code>Location</code> as well. We know we’ll be working with JSON, so we can utilize a structure and <code>Codable</code> similar to how we did earlier for <code>Book</code> in our <em>catalog.json</em> file. Using our <em>locations.json</em> file as a guide, we arrive at a <code>Location</code> object that looks like this:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">struct</code> <code class="nc">Location</code><code class="p">:</code> <code class="n">Codable</code> <code class="p">{</code>&#13;
    <code class="kd">let</code> <code class="nv">streetAddress</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">city</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">country</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">emoji</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">hours</code><code class="p">:</code> <code class="nb">String</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">enum</code> <code class="nc">CodingKeys</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">CodingKey</code> <code class="p">{</code>&#13;
        <code class="k">case</code> <code class="n">streetAddress</code> <code class="p">=</code> <code class="s">"the_address"</code>&#13;
        <code class="k">case</code> <code class="n">city</code>&#13;
        <code class="k">case</code> <code class="n">country</code>&#13;
        <code class="k">case</code> <code class="n">emoji</code>&#13;
        <code class="k">case</code> <code class="n">hours</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Note the property <code>streetAddress</code>. In our JSON, that property is named <code>the_address</code>. Because these don’t match, a private enum called <code>CodingKeys</code> has been created that provides mapping between the JSON values and the structure values. Unfortunately, when one property doesn’t match, you have to specify all the values being encoded and decoded in the JSON, so it makes <code>Codable</code> a bit more manual, but still mostly automatic.</p>&#13;
&#13;
<p>That being said, <code>JSONDecoder</code> can help you for some cases like converting from snake-case in the JSON to camel-case in the properties like so:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">let</code> <code class="nv">decoder</code> <code class="p">=</code> <code class="n">JSONDecoder</code><code class="p">()</code>&#13;
<code class="n">decoder</code><code class="p">.</code><code class="n">keyDecodingStrategy</code> <code class="p">=</code> <code class="p">.</code><code class="n">convertFromSnakeCase</code>&#13;
<code class="p">...</code></pre>&#13;
</div>&#13;
&#13;
<p>Now, if we were to use the <code>fetchLocations(for:)</code> method we just declared, it would work well on a fast connection, but there is a major problem that could hamper it as our dataset grows or as our network connection degrades: it’s synchronous and potentially all on the main thread. This means that if we call this from the main thread, we would need to sit and wait for the process to finish before anything else could happen; our app would be unresponsive and appear to freeze.</p>&#13;
&#13;
<p>That’s not a great experience.</p>&#13;
&#13;
<p>Fortunately, it’s pretty easy to fix using closures. A common, Swift-y pattern for network operations is to supply a completion handler that’s executed whenever the operation completes. Keeping that in mind, let’s adjust our method signature so that the <code>[Location]</code> array that’s returned is returned in the completion handler. We’ll also use an error handler to provide a closure to execute code if the operation was a not a success. This ends up looking like so:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">func</code> <code class="nf">fetchLocations</code><code class="p">(</code><code class="k">for</code> <code class="n">country</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code>&#13;
  <code class="n">completionHandler</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">([</code><code class="n">Location</code><code class="p">])</code> <code class="p">-&gt;</code> <code class="p">(),</code> <code class="n">errorHandler</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">(</code><code class="n">Error</code><code class="p">?)</code> <code class="p">-&gt;</code> <code class="p">())</code> <code class="p">{</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>If we include our <code>Location</code> structure, we have a file that looks like this:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">import</code> <code class="nc">Foundation</code>&#13;
&#13;
<code class="kd">class</code> <code class="nc">LocationsController</code> <code class="p">{</code>&#13;
    <code class="kd">func</code> <code class="nf">fetchLocations</code><code class="p">(</code><code class="k">for</code> <code class="n">country</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code>&#13;
      <code class="n">completionHandler</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">([</code><code class="n">Location</code><code class="p">])</code> <code class="p">-&gt;</code> <code class="p">(),</code> <code class="n">errorHandler</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">(</code><code class="n">Error</code><code class="p">?)</code> <code class="p">-&gt;</code>&#13;
      <code class="p">())</code> <code class="p">{</code>&#13;
&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">struct</code> <code class="nc">Location</code><code class="p">:</code> <code class="n">Codable</code> <code class="p">{</code>&#13;
    <code class="kd">let</code> <code class="nv">streetAddress</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">city</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">country</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">emoji</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">hours</code><code class="p">:</code> <code class="nb">String</code>&#13;
&#13;
    <code class="kd">private</code> <code class="kd">enum</code> <code class="nc">CodingKeys</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">CodingKey</code> <code class="p">{</code>&#13;
        <code class="k">case</code> <code class="n">streetAddress</code> <code class="p">=</code> <code class="s">"street_address"</code>&#13;
        <code class="k">case</code> <code class="n">city</code>&#13;
        <code class="k">case</code> <code class="n">country</code>&#13;
        <code class="k">case</code> <code class="n">emoji</code>&#13;
        <code class="k">case</code> <code class="n">hours</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="URLSession and friends" data-type="sect3"><div class="sect3" id="idm46177194174312">&#13;
<h3>URLSession and friends</h3>&#13;
&#13;
<p>Let’s take our <code>fetchLocations(for:completionHandler:errorHandler:)</code> method and define the functionality it provides. For that, we’ll delve into the <code>URLSession</code> library with a specific type of <code>URLSessionTask</code>—namely, <code>URLSessionDataTask</code>.</p>&#13;
&#13;
<p>There are a number of ways to interact with the web, but <code>URLSession</code> has broken up the interactions into three types with three different implementations of <code>URLSessionTask</code>—essentially, one network request—to make things a bit easier to use: the types of tasks are <code>URLSessionDataTask</code>, <code>URLSessionDownloadTask</code>, and <code>URLSessionUploadTask</code>.</p>&#13;
&#13;
<p>Each of these are purpose-built and provide functionality unique to that purpose. The data task, or <code>URLSessionDataTask</code>, we’ll be using is intended to be used to retrieve data from a URL—in other words, our use case. For a more thorough look at these objects, check out <a data-type="xref" href="ch09.html#topics_networking">Chapter 9</a>.</p>&#13;
&#13;
<p>Let’s take a look at how we’ll use <code>URLSessionDataTask</code> in our code:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"http://localhost:3000/locations?country=</code><code class="si">\(</code><code class="n">country</code><code class="si">)</code><code class="s">"</code><code class="p">)</code><code class="o">!</code>&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">dataTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
&#13;
<code class="p">}</code>&#13;
<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code></pre>&#13;
&#13;
<p>The first thing we do is create a URL to where our location search service resides. It’s currently at <em><a href="http://localhost:3000/locations"><em class="hyperlink">http://localhost:3000/locations</em></a></em> if you followed along with the Node part of this chapter, but if not, then you’ll need to use whatever URL is relevant here. The <code>URL(string:)</code> initializer generates a nullable <code>URL</code>—or <code>URL?</code> type—so we are also force unwrapping that property with a <code>!</code> because, in this instance, we know it won’t be <code>nil</code>. (And if it is, we probably want to know about by having the app crash versus silently failing too!)</p>&#13;
&#13;
<p>Next, we use the <code>shared</code> class property on <code>URLSession</code> to grab the shared session. The session itself generates our <code>URLSessionDataTask</code> through the <code>dataTask(with:completionHandler:)</code> method; we are never creating and instantiating <code>URLSessionDataTask</code> directly. This task is saved to the <code>task</code> variable.</p>&#13;
&#13;
<p>The completion handler passed has three parameters: <code>data</code>, <code>response</code>, and <code>error</code>. The <code>data</code> parameter is an object of type <code>Any?</code> that contains the data retrieved by the response. The <code>response</code> parameter contains the raw <code>URLResponse</code> received, and the <code>error</code> property is an <code>Error?</code> object used to validate the success or failure of the response.</p>&#13;
&#13;
<p>Right now, adding this to our <code>fetchLocations(for:completionHandler:errorHandler)</code> method would call our service, but because the body of the completion closure passed in is empty, nothing would happen. Let’s fix that. Here’s what the entire body of our method should look like:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">func</code> <code class="nf">fetchLocations</code><code class="p">(</code><code class="k">for</code> <code class="n">country</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">completionHandler</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">([</code><code class="n">Location</code><code class="p">])</code> <code class="p">-&gt;</code> <code class="p">(),</code>&#13;
  <code class="n">errorHandler</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">(</code><code class="n">Error</code><code class="p">?)</code> <code class="p">-&gt;</code> <code class="p">())</code> <code class="p">{</code>&#13;
	<code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"http://localhost:3000/locations?country=</code><code class="si">\(</code><code class="n">country</code><code class="si">)</code><code class="s">"</code><code class="p">)</code><code class="o">!</code>&#13;
	<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">dataTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
		<code class="k">if</code> <code class="kd">let</code> <code class="nv">error</code> <code class="p">=</code> <code class="n">error</code> <code class="p">{</code>&#13;
			<code class="c1">// Server error encountered</code>&#13;
			<code class="n">errorHandler</code><code class="p">(</code><code class="n">error</code><code class="p">)</code>&#13;
			<code class="k">return</code>&#13;
		<code class="p">}</code>&#13;
&#13;
		<code class="k">guard</code> <code class="kd">let</code> <code class="nv">response</code> <code class="p">=</code> <code class="n">response</code> <code class="k">as</code><code class="p">?</code> <code class="n">HTTPURLResponse</code><code class="p">,</code>&#13;
      <code class="n">response</code><code class="p">.</code><code class="n">statusCode</code> <code class="o">&lt;</code> <code class="mi">300</code> <code class="k">else</code> <code class="p">{</code>&#13;
			<code class="c1">// Client error encountered</code>&#13;
			<code class="n">errorHandler</code><code class="p">(</code><code class="kc">nil</code><code class="p">)</code>&#13;
			<code class="k">return</code>&#13;
		<code class="p">}</code>&#13;
&#13;
		<code class="k">guard</code> <code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="n">data</code> <code class="k">else</code> <code class="p">{</code>&#13;
			<code class="c1">// No valid data</code>&#13;
			<code class="n">errorHandler</code><code class="p">(</code><code class="kc">nil</code><code class="p">)</code>&#13;
			<code class="k">return</code>&#13;
		<code class="p">}</code>&#13;
&#13;
		<code class="c1">// Take our data and convert it to a [Location] object</code>&#13;
	<code class="p">}</code>&#13;
	<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Inside the body of <code>dataTask(with:completionHandler:)</code> we’re passing in a trailing closure that does the following:</p>&#13;
<ol>&#13;
<li>&#13;
<p>It checks for a server error via the <code>error</code> parameter that was passed into the method. If an error occurred, we call the <code>errorHandler</code> closure that was passed in and then <code>return</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>If everything is good server side (i.e., <code>error</code> is <code>nil</code>), then we proceed to check to make sure our response was a valid HTTP status code, which is anything less than <code>300</code>. If the response isn’t valid, we also call <code>errorHandler</code>, but there is no server error to pass along, so we just pass <code>nil</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>If we’re good server side and client side with errors, we check the data returned. The <code>data</code> object shouldn’t be empty, and we’re expecting a <code>Data</code> object that we’re going to use, momentarily, to decode. If the data is empty, we call <code>errorHandler</code>, yet again, with a <code>nil</code> error so we can execute our error-handling code.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Let’s wrap up this object by taking our <code>data</code> object and decoding it from raw JSON into an array of <code>Location</code>s. After adding this, we end up with the following code in our <em>LocationsController.swift</em> file:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">import</code> <code class="nc">Foundation</code>&#13;
&#13;
<code class="kd">class</code> <code class="nc">LocationsController</code> <code class="p">{</code>&#13;
    <code class="kd">func</code> <code class="nf">fetchLocations</code><code class="p">(</code><code class="k">for</code> <code class="n">country</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">completionHandler</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">([</code><code class="n">Location</code><code class="p">])</code> <code class="p">-&gt;</code>&#13;
    <code class="p">(),</code>&#13;
      <code class="n">errorHandler</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">(</code><code class="n">Error</code><code class="p">?)</code> <code class="p">-&gt;</code> <code class="p">())</code> <code class="p">{</code>&#13;
        <code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"http://localhost:3000/locations?country=</code><code class="si">\(</code><code class="n">country</code><code class="si">)</code><code class="s">"</code><code class="p">)</code><code class="o">!</code>&#13;
        <code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">dataTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
            <code class="k">if</code> <code class="kd">let</code> <code class="nv">error</code> <code class="p">=</code> <code class="n">error</code> <code class="p">{</code>&#13;
                <code class="n">errorHandler</code><code class="p">(</code><code class="n">error</code><code class="p">)</code>&#13;
                <code class="k">return</code>&#13;
            <code class="p">}</code>&#13;
&#13;
            <code class="k">guard</code> <code class="kd">let</code> <code class="nv">response</code> <code class="p">=</code> <code class="n">response</code> <code class="k">as</code><code class="p">?</code> <code class="n">HTTPURLResponse</code><code class="p">,</code> <code class="n">response</code><code class="p">.</code><code class="n">statusCode</code> <code class="o">&lt;</code>&#13;
            <code class="mi">300</code> <code class="k">else</code> <code class="p">{</code>&#13;
                <code class="n">errorHandler</code><code class="p">(</code><code class="kc">nil</code><code class="p">)</code>&#13;
                <code class="k">return</code>&#13;
            <code class="p">}</code>&#13;
&#13;
            <code class="k">guard</code> <code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="n">data</code><code class="p">,</code> <code class="kd">let</code> <code class="nv">locations</code> <code class="p">=</code>&#13;
            <code class="k">try</code><code class="p">?</code> <code class="n">JSONDecoder</code><code class="p">().</code><code class="n">decode</code><code class="p">([</code><code class="n">Location</code><code class="p">].</code><code class="kc">self</code><code class="p">,</code>&#13;
              <code class="n">from</code><code class="p">:</code> <code class="n">data</code><code class="p">)</code> <code class="k">else</code> <code class="p">{</code>&#13;
                <code class="n">errorHandler</code><code class="p">(</code><code class="kc">nil</code><code class="p">)</code>&#13;
                <code class="k">return</code>&#13;
            <code class="p">}</code>&#13;
&#13;
            <code class="c1">// Call our completion handler with our locations</code>&#13;
            <code class="n">completionHandler</code><code class="p">(</code><code class="n">locations</code><code class="p">)</code>&#13;
        <code class="p">}</code>&#13;
        <code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">struct</code> <code class="nc">Location</code><code class="p">:</code> <code class="n">Codable</code> <code class="p">{</code>&#13;
    <code class="kd">let</code> <code class="nv">streetAddress</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">city</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">country</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">emoji</code><code class="p">:</code> <code class="nb">String</code>&#13;
    <code class="kd">let</code> <code class="nv">hours</code><code class="p">:</code> <code class="nb">String</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>All right. We’ve got a working network client we can use to search for locations. We’re <em>almost</em> done, but the final missing piece of this is that we need to add it to the original UI we created. Let’s head back over to <code>LocationsTableViewController</code> and add the following to our <code>UISearchBarDelegate</code> method, <code>searchBarTextDidEndEditing(_:)</code>:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">func</code> <code class="nf">searchBarTextDidEndEditing</code><code class="p">(</code><code class="kc">_</code> <code class="n">searchBar</code><code class="p">:</code> <code class="bp">UISearchBar</code><code class="p">)</code> <code class="p">{</code>&#13;
	<code class="kd">let</code> <code class="nv">country</code> <code class="p">=</code> <code class="n">searchBar</code><code class="p">.</code><code class="n">text</code> <code class="p">??</code> <code class="s">""</code>&#13;
	<code class="n">locationsController</code><code class="p">.</code><code class="n">fetchLocations</code><code class="p">(</code><code class="k">for</code><code class="p">:</code> <code class="n">country</code><code class="p">,</code> <code class="n">completionHandler</code><code class="p">:</code>&#13;
	<code class="p">{</code> <code class="p">(</code><code class="n">locations</code><code class="p">)</code> <code class="k">in</code>&#13;
		<code class="n">DispatchQueue</code><code class="p">.</code><code class="n">main</code><code class="p">.</code><code class="n">async</code> <code class="p">{</code>&#13;
			<code class="kc">self</code><code class="p">.</code><code class="n">locations</code> <code class="p">=</code> <code class="n">locations</code>&#13;
			<code class="kc">self</code><code class="p">.</code><code class="n">tableView</code><code class="p">.</code><code class="n">reloadData</code><code class="p">()</code>&#13;
		<code class="p">}</code>&#13;
	<code class="p">})</code> <code class="p">{</code> <code class="p">(</code><code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
		<code class="n">DispatchQueue</code><code class="p">.</code><code class="n">main</code><code class="p">.</code><code class="n">async</code> <code class="p">{</code>&#13;
			<code class="kc">self</code><code class="p">.</code><code class="n">locations</code> <code class="p">=</code> <code class="p">[]</code>&#13;
			<code class="kc">self</code><code class="p">.</code><code class="n">tableView</code><code class="p">.</code><code class="n">reloadData</code><code class="p">()</code>&#13;
		<code class="p">}</code>&#13;
	<code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Let’s walk through this code.</p>&#13;
&#13;
<p>First, we grab the <code>country</code> we’re searching for from the search bar’s <code>text</code> property. This is a <code>String</code> type, so it could be <code>nil</code>; we fix this with the <code>??</code> operator that means “if the thing preceding this operator is <code>nil</code>, use the thing after this operator as the value.” In our case, we set it to an empty string. After that, we call <code>fetchLocations</code> on a new property we’ve added to the class that holds the <code>LocationsController</code> we just created. We pass in a <code>completionHandler</code> and an <code>errorHandler</code> closure that set a local property that contains the locations returned and reloads the table view contained in this view.</p>&#13;
&#13;
<p>Notice that we dispatch to the main thread in order to update the table view from our closure. We don’t know what thread this call is coming from, and any UI updates <em>must</em> be done on the main thread.</p>&#13;
&#13;
<p>We’ve got one more thing to adjust in this class before we’re ready to test it out. We need to make our table view get its data from the <code>locations</code> array that we’re storing in the class now. Luckily, if you’ll recall, this class is the table view’s <code>dataSource</code> so it’s as easy as updating the <code>UITableViewDataSource</code> protocol method definitions to the following:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kr">override</code> <code class="kd">func</code> <code class="nf">tableView</code><code class="p">(</code><code class="kc">_</code> <code class="n">tableView</code><code class="p">:</code> <code class="bp">UITableView</code><code class="p">,</code> <code class="n">numberOfRowsInSection</code> <code class="n">section</code><code class="p">:</code> <code class="nb">Int</code><code class="p">)</code> <code class="p">-&gt;</code>&#13;
<code class="nb">Int</code> <code class="p">{</code>&#13;
	<code class="k">return</code> <code class="n">locations</code><code class="p">.</code><code class="bp">count</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kr">override</code> <code class="kd">func</code> <code class="nf">tableView</code><code class="p">(</code><code class="kc">_</code> <code class="n">tableView</code><code class="p">:</code> <code class="bp">UITableView</code><code class="p">,</code>&#13;
    <code class="n">cellForRowAt</code> <code class="n">indexPath</code><code class="p">:</code> <code class="n">IndexPath</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="bp">UITableViewCell</code> <code class="p">{</code>&#13;
	<code class="c1">// Dequeue a table view cell</code>&#13;
	<code class="kd">let</code> <code class="nv">cell</code> <code class="p">=</code> <code class="n">tableView</code><code class="p">.</code><code class="n">dequeueReusableCell</code><code class="p">(</code><code class="n">withIdentifier</code><code class="p">:</code> <code class="s">"LocationCell"</code><code class="p">,</code> <code class="k">for</code><code class="p">:</code>&#13;
	<code class="n">indexPath</code><code class="p">)</code>&#13;
&#13;
	<code class="c1">// Find the correct location based on the row being populated</code>&#13;
	<code class="kd">let</code> <code class="nv">location</code> <code class="p">=</code> <code class="n">locations</code><code class="p">[</code><code class="n">indexPath</code><code class="p">.</code><code class="n">row</code><code class="p">]</code>&#13;
&#13;
	<code class="c1">// Style the cell</code>&#13;
	<code class="n">cell</code><code class="p">.</code><code class="n">textLabel</code><code class="p">?.</code><code class="n">text</code> <code class="p">=</code> <code class="n">location</code><code class="p">.</code><code class="n">emoji</code>&#13;
	<code class="n">cell</code><code class="p">.</code><code class="n">detailTextLabel</code><code class="p">?.</code><code class="n">text</code> <code class="p">=</code>&#13;
    <code class="s">"</code><code class="si">\(</code><code class="n">location</code><code class="p">.</code><code class="n">streetAddress</code><code class="si">)</code><code class="se">\n</code><code class="si">\(</code><code class="n">location</code><code class="p">.</code><code class="n">city</code><code class="si">)</code><code class="s">,</code>&#13;
<code class="s">    </code><code class="si">\(</code><code class="n">location</code><code class="p">.</code><code class="n">country</code><code class="si">)</code><code class="se">\n</code><code class="s">Hours: </code><code class="si">\(</code><code class="n">location</code><code class="p">.</code><code class="n">hours</code><code class="si">)</code><code class="s">"</code>&#13;
&#13;
	<code class="k">return</code> <code class="n">cell</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The full <code>LocationsViewController</code> class looks like this now:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">import</code> <code class="nc">UIKit</code>&#13;
&#13;
<code class="kd">class</code> <code class="nc">LocationsTableViewController</code><code class="p">:</code> <code class="bp">UITableViewController</code> <code class="p">{</code>&#13;
&#13;
    <code class="kd">let</code> <code class="nv">locationsController</code> <code class="p">=</code> <code class="n">LocationsController</code><code class="p">()</code>&#13;
    <code class="kd">var</code> <code class="nv">locations</code><code class="p">:</code> <code class="p">[</code><code class="n">Location</code><code class="p">]</code> <code class="p">=</code> <code class="p">[]</code>&#13;
&#13;
    <code class="kr">override</code> <code class="kd">func</code> <code class="nf">viewDidLoad</code><code class="p">()</code> <code class="p">{</code>&#13;
        <code class="kc">super</code><code class="p">.</code><code class="n">viewDidLoad</code><code class="p">()</code>&#13;
&#13;
        <code class="kd">let</code> <code class="nv">searchController</code> <code class="p">=</code> <code class="bp">UISearchController</code><code class="p">(</code><code class="n">searchResultsController</code><code class="p">:</code> <code class="kc">nil</code><code class="p">)</code>&#13;
        <code class="n">searchController</code><code class="p">.</code><code class="n">searchBar</code><code class="p">.</code><code class="n">delegate</code> <code class="p">=</code> <code class="kc">self</code>&#13;
        <code class="n">searchController</code><code class="p">.</code><code class="n">searchBar</code><code class="p">.</code><code class="n">placeholder</code> <code class="p">=</code> <code class="s">"Search Locations by Country"</code>&#13;
        <code class="n">searchController</code><code class="p">.</code><code class="n">obscuresBackgroundDuringPresentation</code> <code class="p">=</code> <code class="kc">false</code>&#13;
        <code class="n">definesPresentationContext</code> <code class="p">=</code> <code class="kc">true</code>&#13;
&#13;
        <code class="n">navigationItem</code><code class="p">.</code><code class="n">searchController</code> <code class="p">=</code> <code class="n">searchController</code>&#13;
        <code class="n">navigationItem</code><code class="p">.</code><code class="n">hidesSearchBarWhenScrolling</code> <code class="p">=</code> <code class="kc">false</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// </code><code class="cs">MARK:</code><code class="c1"> - Table view data source</code>&#13;
    <code class="kr">override</code> <code class="kd">func</code> <code class="nf">tableView</code><code class="p">(</code><code class="kc">_</code> <code class="n">tableView</code><code class="p">:</code> <code class="bp">UITableView</code><code class="p">,</code>&#13;
        <code class="n">numberOfRowsInSection</code> <code class="n">section</code><code class="p">:</code> <code class="nb">Int</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="nb">Int</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="n">locations</code><code class="p">.</code><code class="bp">count</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kr">override</code> <code class="kd">func</code> <code class="nf">tableView</code><code class="p">(</code><code class="kc">_</code> <code class="n">tableView</code><code class="p">:</code> <code class="bp">UITableView</code><code class="p">,</code>&#13;
        <code class="n">cellForRowAt</code> <code class="n">indexPath</code><code class="p">:</code> <code class="n">IndexPath</code><code class="p">)</code> <code class="p">-&gt;</code> <code class="bp">UITableViewCell</code> <code class="p">{</code>&#13;
        <code class="c1">// Dequeue a table view cell</code>&#13;
        <code class="kd">let</code> <code class="nv">cell</code> <code class="p">=</code> <code class="n">tableView</code><code class="p">.</code><code class="n">dequeueReusableCell</code><code class="p">(</code><code class="n">withIdentifier</code><code class="p">:</code> <code class="s">"LocationCell"</code><code class="p">,</code> <code class="k">for</code><code class="p">:</code>&#13;
        <code class="n">indexPath</code><code class="p">)</code>&#13;
&#13;
        <code class="c1">// Find the correct location based on the row being populated</code>&#13;
        <code class="kd">let</code> <code class="nv">location</code> <code class="p">=</code> <code class="n">locations</code><code class="p">[</code><code class="n">indexPath</code><code class="p">.</code><code class="n">row</code><code class="p">]</code>&#13;
&#13;
        <code class="c1">// Style the cell</code>&#13;
        <code class="n">cell</code><code class="p">.</code><code class="n">textLabel</code><code class="p">?.</code><code class="n">text</code> <code class="p">=</code>&#13;
          <code class="s">"</code><code class="si">\(</code><code class="n">location</code><code class="p">.</code><code class="n">streetAddress</code><code class="si">)</code><code class="se">\n</code><code class="si">\(</code><code class="n">location</code><code class="p">.</code><code class="n">city</code><code class="si">)</code><code class="s">, </code><code class="si">\(</code><code class="n">location</code><code class="p">.</code><code class="n">country</code><code class="si">)</code><code class="se">\n</code><code class="s">Hours:</code>&#13;
<code class="s">          </code><code class="si">\(</code><code class="n">location</code><code class="p">.</code><code class="n">hours</code><code class="si">)</code><code class="s">"</code>&#13;
        <code class="n">cell</code><code class="p">.</code><code class="n">detailTextLabel</code><code class="p">?.</code><code class="n">text</code> <code class="p">=</code> <code class="n">location</code><code class="p">.</code><code class="n">emoji</code>&#13;
&#13;
        <code class="k">return</code> <code class="n">cell</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">extension</code> <code class="nc">LocationsTableViewController</code><code class="p">:</code> <code class="bp">UISearchBarDelegate</code> <code class="p">{</code>&#13;
    <code class="kd">func</code> <code class="nf">searchBarTextDidEndEditing</code><code class="p">(</code><code class="kc">_</code> <code class="n">searchBar</code><code class="p">:</code> <code class="bp">UISearchBar</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="kd">let</code> <code class="nv">country</code> <code class="p">=</code> <code class="n">searchBar</code><code class="p">.</code><code class="n">text</code> <code class="p">??</code> <code class="s">""</code>&#13;
        <code class="k">guard</code> <code class="n">country</code> <code class="o">!=</code> <code class="s">""</code> <code class="k">else</code> <code class="p">{</code>&#13;
            <code class="kc">self</code><code class="p">.</code><code class="n">locations</code> <code class="p">=</code> <code class="p">[]</code>&#13;
            <code class="kc">self</code><code class="p">.</code><code class="n">tableView</code><code class="p">.</code><code class="n">reloadData</code><code class="p">()</code>&#13;
            <code class="k">return</code>&#13;
        <code class="p">}</code>&#13;
        <code class="n">locationsController</code><code class="p">.</code><code class="n">fetchLocations</code><code class="p">(</code><code class="k">for</code><code class="p">:</code> <code class="n">country</code><code class="p">,</code> <code class="n">completionHandler</code><code class="p">:</code>&#13;
        <code class="p">{</code> <code class="p">(</code><code class="n">locations</code><code class="p">)</code> <code class="k">in</code>&#13;
            <code class="n">DispatchQueue</code><code class="p">.</code><code class="n">main</code><code class="p">.</code><code class="n">async</code> <code class="p">{</code>&#13;
                <code class="kc">self</code><code class="p">.</code><code class="n">locations</code> <code class="p">=</code> <code class="n">locations</code>&#13;
                <code class="kc">self</code><code class="p">.</code><code class="n">tableView</code><code class="p">.</code><code class="n">reloadData</code><code class="p">()</code>&#13;
            <code class="p">}</code>&#13;
        <code class="p">})</code> <code class="p">{</code> <code class="p">(</code><code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
            <code class="n">DispatchQueue</code><code class="p">.</code><code class="n">main</code><code class="p">.</code><code class="n">async</code> <code class="p">{</code>&#13;
                <code class="kc">self</code><code class="p">.</code><code class="n">locations</code> <code class="p">=</code> <code class="p">[]</code>&#13;
                <code class="kc">self</code><code class="p">.</code><code class="n">tableView</code><code class="p">.</code><code class="n">reloadData</code><code class="p">()</code>&#13;
            <code class="p">}</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kd">func</code> <code class="nf">searchBarCancelButtonClicked</code><code class="p">(</code><code class="kc">_</code> <code class="n">searchBar</code><code class="p">:</code> <code class="bp">UISearchBar</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="kc">self</code><code class="p">.</code><code class="n">locations</code> <code class="p">=</code> <code class="p">[]</code>&#13;
        <code class="kc">self</code><code class="p">.</code><code class="n">tableView</code><code class="p">.</code><code class="n">reloadData</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Build and run the application, click the magnifying glass, and search for a country and you’ll get…nothing. Why?</p>&#13;
&#13;
<p>Well, if you look at the console, you’ll notice the following error:</p>&#13;
&#13;
<pre class="small" data-type="programlisting">App Transport Security((("App Transport Security"))) has blocked a cleartext HTTP (http://)&#13;
    resource load since it is insecure. Temporary exceptions can be configured via your&#13;
    app's((("Info.plist file"))) Info.plist file.</pre>&#13;
&#13;
<p>The reason for this is Apple’s security practices request an <em>https://</em> URL and we’re using an <em>http://</em> URL. The fix for this is easy and, in fact, is mentioned in the error message. You’ll need to add an exception to your app’s <em>Info.plist</em> file. This file is where application-level configurable values go.</p>&#13;
&#13;
<p>To add the exception to your domain, go to <em>Info.plist</em> and in the last row of data displayed, click the “+” button to add a new property. From the drop-down, select App Transport Security Settings. Then, add a new child property for Allow Arbitrary Loads and set its value from NO to YES. This makes it so that any nonsecure URL can be used by the app. If you build and run the app now and search for “France,” you should see <a data-type="xref" href="#france">Figure 20-1</a> in the simulator.</p>&#13;
&#13;
<figure class="width-30"><div class="figure" id="france">&#13;
<img alt="Vive lé Simulator!" src="assets/nmdv_2001.png"/>&#13;
<h6><span class="label">Figure 20-1. </span>Vive lé Simulator!</h6>&#13;
</div></figure>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Look out! You made your app less secure by allowing arbitrary loads. In the interests of this example, we’re using this technique. Really, you should be using an HTTPS URL to communicate with your service. Don’t deploy an app in the wild with this enabled unless you know what you’re doing. Another available option is to set <code>NSAllowsLocalNetworking</code> to <code>YES</code> in your app’s <em>Info.plist</em> instead, which allows local file loads.</p>&#13;
&#13;
<p>If you submit an app with Allow Arbitrary Loads enabled, be prepared: you’ll have to justify that decision during App Review!</p>&#13;
</div>&#13;
&#13;
<p>There’s one more thing we can do to make it apparent a network call is happening. We can add calls to <code>UIApplication.shared.isNetworkActivityIndicatorVisible</code> to make the network activity indicator in the status bar active and inactive whenever a call is happening. We can do this before we start the <code>URLSessionDataTask</code> we created in our <code>LocationsController</code> like so:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">func</code> <code class="nf">fetchLocations</code><code class="p">(</code><code class="k">for</code> <code class="n">country</code><code class="p">:</code> <code class="nb">String</code><code class="p">,</code> <code class="n">completionHandler</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">([</code><code class="n">Location</code><code class="p">])</code> <code class="p">-&gt;</code> <code class="p">(),</code>&#13;
  <code class="n">errorHandler</code><code class="p">:</code> <code class="p">@</code><code class="n">escaping</code> <code class="p">(</code><code class="n">Error</code><code class="p">?)</code> <code class="p">-&gt;</code> <code class="p">())</code> <code class="p">{</code>&#13;
&#13;
	<code class="p">...</code>&#13;
&#13;
	<code class="n">DispatchQueue</code><code class="p">.</code><code class="n">main</code><code class="p">.</code><code class="n">async</code> <code class="p">{</code>&#13;
		<code class="bp">UIApplication</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">isNetworkActivityIndicatorVisible</code> <code class="p">=</code> <code class="kc">true</code>&#13;
	<code class="p">}</code>&#13;
	<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Then, we can set <code>UIApplication.shared.isNetworkActivityIndicatorVisible</code> to <code>false</code> inside the completion handler whenever it completes.</p>&#13;
&#13;
<p>That’s all we’ll cover on networking for now with iOS.<a data-primary="" data-startref="IOSnetcomm20" data-type="indexterm" id="idm46177192676232"/><a data-primary="" data-startref="ANcommios20" data-type="indexterm" id="idm46177192675288"/><a data-primary="" data-startref="Ncommios20" data-type="indexterm" id="idm46177192674344"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What We’ve Learned" data-type="sect1"><div class="sect1" id="idm46177194437752">&#13;
<h1>What We’ve Learned</h1>&#13;
&#13;
<p>We’ve seen how to talk to the internet in both Android and iOS. There are similarities, but each operating also has its own unique way of handling communication with a web service. There are a lot of moving parts, but we’ve seen how to:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Add a new screen that handles searching</p>&#13;
</li>&#13;
<li>&#13;
<p>Create a network client to communicate with an API</p>&#13;
</li>&#13;
<li>&#13;
<p>Wire up a search UI with the network client</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>There is a lot more functionality contained inside Android and iOS, and we’ve just scratched the surface. Check out <a data-type="xref" href="ch09.html#topics_networking">Chapter 9</a> for more detail and examples of how to add networking to your app.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>