<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 6. Observability and Security"><div class="chapter" id="observability_and_security">
<h1><span class="label">Chapter 6. </span>Observability and Security</h1>
<p>This chapter will explain how an observability platform can help improve the security of your Kubernetes cluster. We will cover the following topics:</p>
<dl>
<dt>Alerting</dt>
<dd>In <a data-type="xref" href="ch05.xhtml#observability-id000002">Chapter 5</a> we covered best practices for implementing log collection. In this chapter, we will focus on how to build a system that helps generate high-fidelity alerts. We will also discuss the use of machine learning for anomaly detection.</dd>
<dt>Security operations center</dt>
<dd>We will review a reference implementation of a security operations center (SOC) and how observability can help you build an SOC for your Kubernetes cluster.</dd>
<dt>Behavioral analytics</dt>
<dd>We will cover the concept of user and entity behavior analytics (UEBA) and how to implement it in your Kubernetes cluster.</dd>
</dl>
<section data-type="sect1" data-pdf-bookmark="Alerting"><div class="sect1" id="alerting">
<h1>Alerting</h1>
<p>In the previous chapter we discussed how to implement logging for your Kubernetes cluster. <a contenteditable="false" data-type="indexterm" data-primary="alerting" id="ch06-alert"/><a contenteditable="false" data-type="indexterm" data-primary="monitoring" data-secondary="alerting" id="ch06-alert2"/><a contenteditable="false" data-type="indexterm" data-primary="logs" data-secondary="alerting systems" id="ch06-alert3"/>An effective alerting system must include the following:</p>
<ul>
<li><p>The system should be able to automatically run queries across various log data sources (e.g., Kubernetes activity logs, network logs, application logs, DNS logs, etc.).</p></li>
<li><p>The system must be able to support a state machine that is used to generate events for a specified number of threshold violations in a specified duration. The system must also support setting a time period for the query (known as <em>lookback</em>). We will cover an example in the next section.</p></li>
<li><p>The system must be able to export actionable alerts to external<a contenteditable="false" data-type="indexterm" data-primary="security, information, and event management (SIEM)" data-secondary="alerts exported to" id="idm45326826545648"/> security, information, and event management (SIEM) so that they can be a part of the incident response process in an enterprise.</p></li>
</ul>
<p>Alerting systems are available from major cloud providers that can<a contenteditable="false" data-type="indexterm" data-primary="monitoring" data-secondary="alerting" data-tertiary="cloud provider systems" id="idm45326826543088"/><a contenteditable="false" data-type="indexterm" data-primary="cloud environments" data-secondary="alerting systems" id="idm45326826541360"/><a contenteditable="false" data-type="indexterm" data-primary="alerting" data-secondary="cloud provider systems" id="idm45326826539984"/><a contenteditable="false" data-type="indexterm" data-primary="cloud environments" data-secondary="alerting systems" data-tertiary="Google Cloud capabilities" id="idm45326826538608"/><a contenteditable="false" data-type="indexterm" data-primary="Google Cloud" data-secondary="alerting capabilities" id="idm45326826536992"/><a contenteditable="false" data-type="indexterm" data-primary="resources online" data-secondary="Google Cloud alerting capabilities" id="idm45326826535616"/><a contenteditable="false" data-type="indexterm" data-primary="alerting" data-secondary="cloud provider systems" data-tertiary="Google Cloud capabilities" id="idm45326826534272"/> help you define alerts on logs collected in the cloud provider environment. Google Cloud has an excellent resource to <a href="https://oreil.ly/DyLh3">learn about its alerting capabilities</a>. <a contenteditable="false" data-type="indexterm" data-primary="AWS (Amazon Web Services)" data-secondary="alerting capabilities" id="idm45326826531712"/>Amazon Web Services (AWS) also has similar alerting capabilities. These alerts work on logs collected in the cloud provider’s logging system and allow you to define rules to trigger alerts based on thresholds. For example, the number of API calls to an API endpoint in a given time period can be an indicator of a potential denial of service (DoS) attack. While these systems are good for general logging and alerting, a log collection system that is native to Kubernetes, like the one we covered in <a data-type="xref" href="ch05.xhtml#observability-id000002">Chapter 5</a>, is necessary to detect security-based events in your Kubernetes cluster, as it correlates data at the time of collection and makes it easy to define alerts on one log source. Also, an alerting system native to Kubernetes will help you define alerts using Kubernetes constructs like deployments, labels, etc., as it will be able to enhance log data with the right context so queries are simple. (For example, you do not need to join a set of labels to services and labels to IPs in network flow logs to query network activity for a service.)</p>
<p>Figures <a data-type="xref" data-xrefstyle="select:labelnumber" href="#configuring_an_alert_operation">6-1</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#query_configuration_for_an_alert">6-2</a>  show you an <a contenteditable="false" data-type="indexterm" data-primary="alerting" data-secondary="example of lateral movement detection" id="idm45326826525296"/><a contenteditable="false" data-type="indexterm" data-primary="lateral movement in stages of attack" data-secondary="example of detection" id="idm45326826523856"/><a contenteditable="false" data-type="indexterm" data-primary="IP addresses" data-secondary="lateral movement in stages of attack" data-tertiary="example of detection" id="idm45326826522464"/>example of how you can define an alert to detect lateral movement in your Kubernetes cluster.</p>
<figure><div id="configuring_an_alert_operation" class="figure">
<img src="Images/ksao_0601.png" alt="" width="1692" height="340"/>
<h6><span class="label">Figure 6-1. </span>Configuring an alert operation</h6>
</div></figure>
<p><a data-type="xref" href="#configuring_an_alert_operation">Figure 6-1</a> shows how you can configure the operation of an alert and metadata like name, description, severity, and time period to poll for the data and the lookback period, which is how far back the system will look when querying the data. You can also define thresholds for occurrences of threshold violations before an alert is triggered. It is also important to be able to configure the format of the output; in this example the data will be aggregated by the source of the traffic (namespace and deployment) when the alert is reported. The output alert data helps facilitate the management of the alert by downstream systems (e.g., SIEM).</p>
<figure><div id="query_configuration_for_an_alert" class="figure">
<img src="Images/ksao_0602.png" alt="" width="1669" height="1336"/>
<h6><span class="label">Figure 6-2. </span>Query configuration for an alert</h6>
</div></figure>
<p><a data-type="xref" href="#query_configuration_for_an_alert">Figure 6-2</a> shows an example of query configuration for the alert. The things to note in the query are the ability to use Kubernetes metadata (e.g., labels) with network flow activity (e.g., destination, protocol) and policy verdict (e.g., action) in a single query. This gives you a lot of flexibility in defining alerts that are effective in your Kubernetes cluster. Please note that this is a representative example of how you should think about building an effective alerting system. <a contenteditable="false" data-type="indexterm" data-primary="monitoring" data-secondary="alerting" data-tertiary="tools for" id="idm45326826512800"/><a contenteditable="false" data-type="indexterm" data-primary="alerting" data-secondary="tools for" id="idm45326826511184"/><a contenteditable="false" data-type="indexterm" data-primary="Calico Enterprise" data-secondary="alerting" id="idm45326826509808"/><a contenteditable="false" data-type="indexterm" data-primary="alerting" data-secondary="Calico Enterprise" id="idm45326826508432"/><a contenteditable="false" data-type="indexterm" data-primary="Datadog" data-secondary="alerting" id="idm45326826507056"/>In addition to the cloud provider’s alerting systems, there are several other tools like Datadog, Sysdig, and Calico Enterprise that provide Kubernetes-native alerting systems.</p>
<p>The alerting systems we covered previously are great at detecting and reporting alerts when your system has predictable behavior and you can easily define thresholds for normal activity of the system. It would be great for an alerting system to be able to “learn” the behavior of the system and be able to dynamically define thresholds; this will help generate high-fidelity alerts and reduce false positives due to thresholds not changing with the state of the system. Let’s explore how machine learning can be used to help with this issue.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-alert" id="idm45326826504384"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-alert2" id="idm45326826503008"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-alert3" id="idm45326826501632"/></p>
<section data-type="sect2" data-pdf-bookmark="Machine Learning"><div class="sect2" id="machine_learning">
<h2>Machine Learning</h2>
<p>Machine learning fundamentals and how it works are outside the scope of this book.<a contenteditable="false" data-type="indexterm" data-primary="alerting" data-secondary="machine learning" id="ch06-mla"/><a contenteditable="false" data-type="indexterm" data-primary="monitoring" data-secondary="alerting" data-tertiary="machine learning with examples" id="ch06-mla2"/><a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="alerting" id="ch06-mla3"/> In this section we will review a few concepts of machine learning that will show us how it can help with learning the behavior of a given metric and alerting on deviations from the expected behavior. Before we do that, let’s review the high-level techniques in machine learning:</p>
<dl>
<dt>Supervised learning </dt>
<dd>This is a technique where the system is trained by labeling test data<a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="supervised learning definition" id="idm45326826491232"/><a contenteditable="false" data-type="indexterm" data-primary="supervised learning definition" id="idm45326826489808"/> over a period of time. It allows the system to use the learnings to classify new data and predict outcomes.</dd>
<dt>Unsupervised learning</dt>
<dd>This is a technique where algorithms are used to detect and classify patterns<a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="unsupervised learning definition" id="idm45326826487344"/><a contenteditable="false" data-type="indexterm" data-primary="unsupervised learning definition" id="idm45326826486000"/><a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="article online" id="idm45326826484880"/><a contenteditable="false" data-type="indexterm" data-primary="resources online" data-secondary="machine learning" data-tertiary="supervised versus unsupervised" id="idm45326826483504"/> in data that is not labeled. Please note that there are many resources to understand these concepts; one example is Julianna Delua’s<a href="https://oreil.ly/9aBfa">“Supervised vs. Unsupervised Learning: What’s the Difference?”</a>. <a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="anomaly detection" data-tertiary="unsupervised learning for" id="idm45326826480880"/><a contenteditable="false" data-type="indexterm" data-primary="anomaly detection via machine learning" data-secondary="unsupervised learning for" id="idm45326826479136"/>Given the ephemeral nature of entities (e.g., pods) in a Kubernetes cluster and our goal of detecting anomalies in the data generated from that activity, we recommend using the technique of unsupervised learning for detecting anomalies.</dd>
<dt>Baselining</dt>
<dd>Baselining is a technique used to build a model in machine learning that can <a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="baselining" id="idm45326826476384"/><a contenteditable="false" data-type="indexterm" data-primary="baselining for anomaly detection" id="idm45326826475008"/><a contenteditable="false" data-type="indexterm" data-primary="anomaly detection via machine learning" data-secondary="baselining" id="idm45326826473936"/><a contenteditable="false" data-type="indexterm" data-primary="anomaly detection via machine learning" data-secondary="baselining" data-tertiary="article online" id="idm45326826472592"/><a contenteditable="false" data-type="indexterm" data-primary="baselining for anomaly detection" data-secondary="article online" id="idm45326826470928"/><a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="anomaly detection" data-tertiary="baselining" id="idm45326826469536"/><a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="baselining" data-tertiary="article online" id="idm45326826467888"/><a contenteditable="false" data-type="indexterm" data-primary="resources online" data-secondary="machine learning" data-tertiary="baselining" id="idm45326826466240"/>continuously predict values for a given metric (e.g., connections per second) and detect anomalies (deviations) from the expected value. <a href="https://oreil.ly/zpeNO">CMU ML’s blog post “3–Baselines”</a> is a great resource for understanding how baselines work and the different types of models that can be built using baselining. As mentioned in the blog, it is possible to create simple models that are very effective in achieving human-level performance. This is exactly what we want in our alerting system: The system should automatically define thresholds and alert on deviations from the baseline.</dd>
</dl>
<p>Now that we understand the high-level techniques we should use, let’s look at some example machine learning jobs that help with implementing observability and securing a Kubernetes cluster. In a dynamic environment like Kubernetes, where workloads are ephemeral and can be restarted/scheduled on a different node, it is not practical in most cases to use a rule-based engine to detect anomalies. What is needed is the anomaly-detection engine layered over a machine learning engine that reports deviations from the baseline for any given metric.</p>
</div></section>
<section data-type="sect2" class="pagebreak-before" data-pdf-bookmark="Examples of Machine Learning Jobs"><div class="sect2" id="examples_of_machine_learning_left_paren">
<h2 class="less_space">Examples of Machine Learning Jobs</h2>
<p>How to create a machine learning model is outside the scope of this book;<a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="alerting" data-tertiary="examples" id="ch06-mlex"/><a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="anomaly detection" data-tertiary="examples" id="ch06-mlex3"/><a contenteditable="false" data-type="indexterm" data-primary="anomaly detection via machine learning" data-secondary="examples" id="ch06-mlex4"/> you should have the data science team build models for your deployments. Major cloud providers like Google Cloud offer a <a href="https://oreil.ly/0JxKq">service to build machine learning models for Kubernetes workloads</a> that can help the data science team implement the right ML model. The following are some examples of ML jobs that are effective to detect anomalous events in your cluster:</p>
<dl>
<dt>IP sweep detection</dt>
<dd>The job looks for pods in your cluster that are sending packets to many destinations.<a contenteditable="false" data-type="indexterm" data-primary="IP addresses" data-secondary="IP sweep detection via machine learning" id="idm45326826451568"/> This may indicate an attacker has gained control of a pod and is gathering reconnaissance on what else they can reach. The job compares pods both with other pods in their replica set and with other pods in the cluster generally.</dd>
<dt>Port scan detection</dt>
<dd>The job looks for pods in your cluster that are sending packets<a contenteditable="false" data-type="indexterm" data-primary="port scan detection via machine learning" id="idm45326826448896"/> to one destination on multiple ports. This may indicate an attacker has gained control of a pod and is gathering reconnaissance on what else they can reach. The job compares pods both with other pods in their replica set and with other pods in the cluster <span class="keep-together">generally.</span></dd>
<dt>Service bytes anomaly</dt>
<dd>The job looks for services that receive/send an anomalously high amount of data.<a contenteditable="false" data-type="indexterm" data-primary="services sending anomylous data" id="idm45326826445792"/> This could indicate a denial of service attack, data exfiltrating, or other attacks. The job looks for services that are unusual with respect to their replica set, and replica sets that are unusual with respect to the rest of the cluster.</dd>
<dt>Process restarts anomaly</dt>
<dd>The job looks for pods with an excessive number of the process restarts.<a contenteditable="false" data-type="indexterm" data-primary="process monitoring" data-secondary="process restarts anomaly" id="idm45326826443360"/><a contenteditable="false" data-type="indexterm" data-primary="monitoring" data-secondary="process monitoring" data-tertiary="process restarts anomaly" id="idm45326826441824"/> This could indicate problems with the processes, such as resource problems or attacks. The job looks for pods that are unusual with respect to their process restart behavior.</dd>
<dt>DNS latency anomaly</dt>
<dd>The job looks for the clients that have too-high latency of DNS requests.<a contenteditable="false" data-type="indexterm" data-primary="DNS activity logs" data-secondary="DNS latency anomaly" id="idm45326826438976"/><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="observability and security" data-tertiary="DNS activity logs" id="idm45326826437504"/><a contenteditable="false" data-type="indexterm" data-primary="observability" data-secondary="security strategy via" data-tertiary="DNS activity logs" id="idm45326826435840"/> This could indicate a denial of service attack.</dd>
<dt>L7 latency anomaly</dt>
<dd>The job looks for the pods that have too-high latency of L7 requests.<a contenteditable="false" data-type="indexterm" data-primary="L7 latency anomaly" id="idm45326826433200"/> All HTTP requests are measured here. This anomaly could indicate a denial of service attack or other attacks.</dd>
<dt>HTTP connection spike anomaly</dt>
<dd>The job looks for services that get too many HTTP inbound connections.<a contenteditable="false" data-type="indexterm" data-primary="HTTP connection spike anomaly" id="idm45326826430928"/> This anomaly could indicate a denial of service attack.</dd>
</dl>
<p>This list gives you examples of jobs you can use to detect anomalies. <a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="Google machine learning services" data-tertiary="resource for building ML jobs" id="idm45326826429216"/><a contenteditable="false" data-type="indexterm" data-primary="resources online" data-secondary="machine learning" data-tertiary="building machine learning jobs" id="idm45326826427504"/>You can use <a href="https://oreil.ly/1FaTm">this resource offered by Google Cloud</a> to build a machine learning job for your Kubernetes cluster.  Note the descriptions of each job rely on a set of context-rich logs that are native to Kubernetes (e.g., comparing pods to other pods in a replica set, using bytes sent to/from a service).</p>
<p>Now that we have covered how to build an effective alerting system to detect and report anomalies, let’s look at an example implementation of a security operations center for your Kubernetes cluster.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-mla" id="idm45326826424112"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-mla2" id="idm45326826422736"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-mla3" id="idm45326826421360"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-mlex" id="idm45326826419984"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-mlex3" id="idm45326826418608"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-mlex4" id="idm45326826417232"/></p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Security Operations Center"><div class="sect1" id="security_operations_center">
<h1>Security Operations Center</h1>
<p>In this section we will review a reference implementation for a security operations center (SOC) <a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="observability and security" data-tertiary="security operations center" id="ch06-soc"/><a contenteditable="false" data-type="indexterm" data-primary="security operations center (SOC)" id="ch06-soc2"/><a contenteditable="false" data-type="indexterm" data-primary="SaaS (software as a service) security operations center" id="ch06-soc3"/><a contenteditable="false" data-type="indexterm" data-primary="cloud environments" data-secondary="alerting systems" data-tertiary="security operations center" id="ch06-soc4"/><a contenteditable="false" data-type="indexterm" data-primary="Google Cloud" data-secondary="security operations center" id="ch06-soc5"/><a contenteditable="false" data-type="indexterm" data-primary="alerting" data-secondary="security operations center" id="ch06-soc6"/><a contenteditable="false" data-type="indexterm" data-primary="observability" data-secondary="security strategy via" data-tertiary="security operations center" id="ch06-soc7"/>for a SaaS service based on Kubernetes. An SOC is used to detect and respond to security events; we will explore how to leverage observability when you implement an SOC for your Kubernetes-based services. Note this is a sample and should be used as an example to guide your implementation. When you implement this in production, you should use these concepts but will need to design and implement an SOC suited to your use case. <a data-type="xref" href="#sample_implementation_of_an_soc_in_goog">Figure 6-3</a> shows an SOC implementation for your service hosted in Google Cloud.</p>
<figure><div id="sample_implementation_of_an_soc_in_goog" class="figure">
<img src="Images/ksao_0603.png" alt="" width="1232" height="961"/>
<h6><span class="label">Figure 6-3. </span>Sample implementation of an SOC in Google Cloud</h6>
</div></figure>
<p><a data-type="xref" href="#sample_implementation_of_an_soc_in_goog">Figure 6-3</a> shows a set of Kubernetes clusters running in Google Cloud with a namespace representing a tenant. <a contenteditable="false" data-type="indexterm" data-primary="Google Kubernetes Engine (GKE)" id="idm45326826396480"/>Each tenant cluster can be deployed in Google Kubernetes Engine (GKE) or as an upstream Kubernetes cluster in Google Cloud. There is an ingress representing how the service is accessed by external entities. The details of the workload deployment and provisioning are omitted from the figure, as we want to focus on how you can secure the service. <a contenteditable="false" data-type="indexterm" data-primary="Google Cloud" data-secondary="operations suite" id="idm45326826394928"/>In order to secure the service, you need logging and monitoring and alerting. This can be achieved by using the <a href="https://oreil.ly/9rTas">Google Cloud operations suite</a>, which provides capabilities to support logging and monitoring and alerting. <a contenteditable="false" data-type="indexterm" data-primary="Google Kubernetes Engine (GKE)" data-secondary="alerting article link" id="idm45326826392608"/><a contenteditable="false" data-type="indexterm" data-primary="clusters" data-secondary="Google alerting resource" id="idm45326826391200"/>In case you are using GKE, <a href="https://oreil.ly/QCGa0">Google Cloud’s blog</a> describes how to leverage these services to detect and manage alerts for your Kubernetes clusters. As mentioned before, you need to leverage ML for baselining and to improve the quality of alerts. <a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="Google machine learning services" id="idm45326826388784"/><a contenteditable="false" data-type="indexterm" data-primary="Google Cloud" data-secondary="machine learning services" id="idm45326826387344"/><a contenteditable="false" data-type="indexterm" data-primary="Google AI Hub" id="idm45326826385952"/>Google offers a set of ML services known as <a href="https://oreil.ly/ICHTe">AI Hub</a>. Note you still need to build ML models that are relevant and effective for your SaaS service (see the example ML jobs earlier in this chapter). <a contenteditable="false" data-type="indexterm" data-primary="alerting" data-secondary="tools for" id="idm45326826383808"/><a contenteditable="false" data-type="indexterm" data-primary="monitoring" data-secondary="alerting" data-tertiary="tools for" id="idm45326826382432"/><a contenteditable="false" data-type="indexterm" data-primary="OpsGenie" id="idm45326826380784"/>You can then use well-known tools like <a href="https://oreil.ly/gNSbr">OpsGenie</a> to route alerts for alert management to SIEM, Slack, PagerDuty, JIRA, and other tools. These alerts will then trigger the remediation workflows as defined by the security team. Note we have used Google Cloud as an example, but <a contenteditable="false" data-type="indexterm" data-primary="AWS (Amazon Web Services)" data-secondary="alerting capabilities" data-tertiary="security operations center" id="idm45326826378624"/><a contenteditable="false" data-type="indexterm" data-primary="Azure cloud (Microsoft)" data-secondary="security operations center" id="idm45326826376896"/>you can use the previously mentioned approach to build an SOC for AWS and Azure. These cloud providers also have a similar set of services available to users.</p>
<p>The previously mentioned approach is very effective in case you are using only one cloud provider and do not have any workloads running on-premise or in other cloud provider environments. <a contenteditable="false" data-type="indexterm" data-primary="deploying a workload" data-secondary="costs increased with alerting" id="idm45326826374864"/><a contenteditable="false" data-type="indexterm" data-primary="workloads" data-secondary="deploying" data-tertiary="costs increased with alerting" id="idm45326826373424"/><a contenteditable="false" data-type="indexterm" data-primary="cloud environments" data-secondary="alerting systems" data-tertiary="agnostic to provider" id="idm45326826371760"/><a contenteditable="false" data-type="indexterm" data-primary="alerting" data-secondary="cloud provider systems" data-tertiary="agnostic to provider" id="idm45326826370112"/>Also, all the services mentioned earlier will increase the cost of deployment, and you also need to delegate some of your DevOps/DevSecOps resources to implement and manage these services. Therefore, we recommend that you build your SOC using a tool that is agnostic to any cloud provider and can be used across cloud providers/on-premise environments.</p>
<p><a data-type="xref" href="#soc_using_a_kubernetes_native_platform">Figure 6-4</a> shows how you can replace some of the cloud provider–specific components and create an SOC using a Kubernetes-native observability and security platform. <a contenteditable="false" data-type="indexterm" data-primary="alerting" data-secondary="security operations center" data-tertiary="products that offer" id="idm45326826366528"/><a contenteditable="false" data-type="indexterm" data-primary="Calico Enterprise" data-secondary="security operations center" id="idm45326826364848"/><a contenteditable="false" data-type="indexterm" data-primary="Datadog" data-secondary="security operations center" id="idm45326826363456"/>You can build the platform yourself or you can choose to use products that offer these platforms, such as Datadog, VMware, and Calico Enterprise. When you choose products, keep in mind the concepts covered in the previous section about alerting, and ensure that the platform supports integrations to your remediation/management systems.</p>

<p>Now that we have reviewed how you build an SOC that is effective for your Kubernetes cluster, let’s review another application of observability to secure your Kubernetes cluster.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-soc" id="idm45326826360976"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-soc2" id="idm45326826359600"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-soc3" id="idm45326826358224"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-soc4" id="idm45326826356848"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-soc5" id="idm45326826355472"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-soc6" id="idm45326826354096"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-soc7" id="idm45326826352720"/></p>
<figure><div id="soc_using_a_kubernetes_native_platform" class="figure">
<img src="Images/ksao_0604.png" alt="" width="1232" height="831"/>
<h6><span class="label">Figure 6-4. </span>SOC using a Kubernetes-native platform</h6>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="User and Entity Behavior Analytics"><div class="sect1" id="user_and_entity_behavior_analytics">
<h1>User and Entity Behavior Analytics</h1>
<p>User and entity behavior analytics (UEBA) is an area where you <a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="anomaly detection" data-tertiary="user and entity behavior analytics" id="ch06-ueba"/><a contenteditable="false" data-type="indexterm" data-primary="anomaly detection via machine learning" data-secondary="user and entity behavior analytics" id="ch06-ueba2"/><a contenteditable="false" data-type="indexterm" data-primary="user and entity behavior analytics (UEBA)" id="ch06-ueba3"/><a contenteditable="false" data-type="indexterm" data-primary="observability" data-secondary="analytics" data-tertiary="user and entity behavior analytics" id="ch06-ueba4"/><a contenteditable="false" data-type="indexterm" data-primary="artificial intelligence" data-see="machine learning" id="idm45326826339984"/><a contenteditable="false" data-type="indexterm" data-primary="AI" data-see="machine learning" id="idm45326826338608"/><a contenteditable="false" data-type="indexterm" data-primary="ML" data-see="machine learning" id="idm45326826337232"/>use ML- and AI-based techniques to profile the behavior of a user or an entity (e.g., a pod, service, or deployment) over time and detect anomalous behavior by the user/entity. <a contenteditable="false" data-type="indexterm" data-primary="Azure cloud (Microsoft)" data-secondary="user and entity behavior analytics" id="idm45326826335536"/><a contenteditable="false" data-type="indexterm" data-primary="Microsoft Azure cloud" data-see="Azure cloud" id="idm45326826334144"/><a contenteditable="false" data-type="indexterm" data-primary="user and entity behavior analytics (UEBA)" data-secondary="article on security use cases" id="idm45326826332768"/><a contenteditable="false" data-type="indexterm" data-primary="resources online" data-secondary="user and entity behavior analytics" id="idm45326826331344"/>Microsoft Azure offers UEBA as a part of its cloud platform. Microsoft Azure’s blog post, <a href="https://oreil.ly/FDspV">Identify Advanced Threats with User and Entity Behavior Analytics (UEBA) in Azure Sentinel”</a>, and an excellent resources that describes how you can use UEBA for security use cases. Note that anomalous behavior by an entity is not always suspicious behavior; you need to map the behavior to frameworks like the MITRE attack framework or other indicators of compromise to confirm it is a security issue.</p>
<p>Let’s take a simple example of how you can implement UEBA for an entity in Kubernetes, such as a service.</p>
<p><a data-type="xref" href="#profiling_the_behavior_of_a_kubernetes">Figure 6-5</a> shows a service in your Kubernetes cluster and the various interactions of the service we will consider when we profile the behavior of the service. As a part of its normal operation, the service will interact with the Kubernetes API server and the Kubernetes datastore. In addition, it will interact with the ingress resource to communicate with entities external to the cluster and use cluster networking to interact with other entities inside the cluster. The service will also use the DNS service in the cluster for its operation.</p>
<figure><div id="profiling_the_behavior_of_a_kubernetes" class="figure">
<img src="Images/ksao_0605.png" alt="" width="1028" height="1097"/>
<h6><span class="label">Figure 6-5. </span>Profiling the behavior of a Kubernetes service</h6>
</div></figure>
<p>In order to build a profile for the service, we would need to consider the following aspects of the service. These are known as features in machine learning.</p>
<ul>
<li><p>Service composition (number of endpoints such as pods, RBAC, policies)</p></li>
<li><p>Filesystem activity, process information, and system call activity for the service</p></li>
<li><p>Service accounts associated with the service</p></li>
<li><p>Service life cycle operations (e.g., create, delete, scale up/down)</p></li>
<li><p>Traffic to and from the service (network, application)</p></li>
<li><p>DNS activity by pods in the service</p></li>
</ul>
<p>The UEBA engine shown in <a data-type="xref" href="#profiling_the_behavior_of_a_kubernetes">Figure 6-5</a> will collect logs from various data sources (network flow logs, application flow logs, Kubernetes audit logs, DNS activity logs, process information, filesystem, syscall activity logs) and store them in the datastore. These logs are aggregated and correlated by the analytics engine to generate correlated logs for the service across various features.</p>
<p class="pagebreak-before">The machine learning engine uses a complex model to baseline <a contenteditable="false" data-type="indexterm" data-primary="machine learning (ML)" data-secondary="baselining" data-tertiary="user and entity behavior analytics" id="idm45326826317248"/><a contenteditable="false" data-type="indexterm" data-primary="baselining for anomaly detection" data-secondary="user and entity behavior analytics" id="idm45326826315456"/><a contenteditable="false" data-type="indexterm" data-primary="anomaly detection via machine learning" data-secondary="baselining" data-tertiary="user and entity behavior analytics" id="idm45326826314048"/>the behavior of the service across various features. This is an advanced concept in machine learning where the model considers each feature and interactions between features, among other things, to build a profile for the service. This is best implemented by your data science team. This profile is then used to predict anomalies and generate alerts for deviations. There is a dashboard to allow SOC operators to review analyzed data and use it for forensics or to hunt threats. Please note a security and observability platform built using the concepts described in <a data-type="xref" href="ch05.xhtml#observability-id000002">Chapter 5</a> will help build an effective UEBA system.</p>
<p>UEBA is an advanced technique and is complex to implement, but it is a very effective way to quickly find out which entities in your cluster are potentially vulnerable. This makes SOC operation very efficient and scalable. Once your deployment scales up to several clusters (50+), it is not practical to use alerts/manual reviews of dashboards to find real issues. UEBA will alert you to entities that are abnormal and need immediate attention.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-ueba" id="idm45326826309760"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-ueba2" id="idm45326826308384"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-ueba3" id="idm45326826307008"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ch06-ueba4" id="idm45326826305632"/></p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="conclusion-id000011">
<h1>Conclusion</h1>
<p>When you think about how you can use observability to help secure your cluster, please consider the following:</p>
<ul>
<li><p>The alerting system you use must be Kubernetes-native and must support baselining using ML so that you do not have to manually define thresholds for various features.</p></li>
<li><p>It is recommended that you consider a Kubernetes-native platform that works across your cloud and on-premise deployments to build your SOC.</p></li>
<li><p>UEBA is an advanced concept and is complex to implement, but it can be very effective in securing a Kubernetes cluster.</p></li>
</ul>
</div></section>
</div></section></div></body></html>