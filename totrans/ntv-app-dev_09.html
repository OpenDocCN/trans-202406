<html><head></head><body><section data-pdf-bookmark="Chapter 8. Concurrency (Multi-Threading)" data-type="chapter" epub:type="chapter"><div class="chapter" id="topics_concurrency">&#13;
<h1><span class="label">Chapter 8. </span>Concurrency (Multi-Threading)</h1>&#13;
&#13;
&#13;
<p>Concurrency, also<a data-primary="multi-threading" data-see="concurrency (multi-threading)" data-type="indexterm" id="idm46177227715880"/><a data-primary="concurrency (multi-threading)" data-secondary="defined" data-type="indexterm" id="idm46177227714904"/> sometimes known as parallelism or multi-threading, is the concept of performing multiple tasks at the same time, dividing the computer’s resources into distinct entities that very quickly alternate between each other until any entity has its entire workload completed, at which time it’s removed from this procedure. The act of computation jumping between different processes (small-p) is known as “context switching,” which has a more common, and very different, definition in computer science (switching your brain’s resources from one domain to another).</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Tasks" data-type="sect1"><div class="sect1" id="idm46177227713096">&#13;
<h1>Tasks</h1>&#13;
&#13;
<p>In<a data-primary="concurrency (multi-threading)" data-secondary="task overview" data-type="indexterm" id="idm46177227711800"/> this chapter, you’ll learn to:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Perform a task in a background thread.</p>&#13;
</li>&#13;
<li>&#13;
<p>Act on the results of work performed in the background thread on the main thread.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Android" data-type="sect1"><div class="sect1" id="idm46177227708200">&#13;
<h1>Android</h1>&#13;
&#13;
<p>In<a data-primary="concurrency (multi-threading)" data-secondary="Android" data-tertiary="creating and working with Threads" data-type="indexterm" id="idm46177227706248"/><a data-primary="Android" data-secondary="concurrency (multi-threading)" data-tertiary="creating and working with Threads" data-type="indexterm" id="idm46177227704936"/><a data-primary="Threads" data-secondary="Android" data-type="indexterm" id="idm46177227703688"/> Java, a processing context is known as a <code>Thread</code>. A <code>Thread</code> is an object instance and<a data-primary="Java" data-secondary="concurrency (multi-threading)" data-tertiary="creating Threads" data-type="indexterm" id="idm46177227701784"/><a data-primary="Kotlin" data-secondary="concurrency (multi-threading)" data-tertiary="creating Threads" data-type="indexterm" id="idm46177227700472"/> is created exactly as you’d expect:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177227699112">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">Thread</code> <code class="n">thread</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Thread</code><code class="o">(...);</code></pre>&#13;
&#13;
<p class="less_space pagebreak-before"><em>Kotlin</em></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">val</code> <code class="n">thread</code> <code class="o">=</code> <code class="n">Thread</code><code class="o">(...)</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>A <code>Thread</code> is passed in a <code>Runnable</code> instance. Once a thread is started (by calling the <code>start</code> method), the thread invokes the <code>run</code> method of that <code>Runnable</code>. As soon as that method is complete (by returning or throwing), the thread terminates.</p>&#13;
&#13;
<p>In Android, there is a single <code>Thread</code> instance that all work is performed on by default, including and especially UI work. That is important—in fact, the concept is sometimes called the “UI thread,” but is more commonly known as the “main” thread. Since the first release of Android to the time of this writing, the main thread has drawn pixels on the screen 60 times per second—that’s about once every 16 milliseconds and is known as a “frame.” This is an extremely resource-intensive process, and it’s absolutely critical that we allow the system to have unfettered access to as much power as possible to do this work. For this reason, extremely computationally expensive tasks should be done “off” the main thread (meaning on any other thread; a thread like this—one that is <em>not</em> responsible for UI, or the original thread the program runs on—is sometimes known as a “background thread”). Any I/O work, like filesystem access, or database transactions, should be done in a background thread, and long-lasting operations like network requests should definitely be done off the main thread as well. In fact, you may see errors or warnings when you do something obvious like make a network request on the main thread. Further, when the main thread is doing too much work, you’ll see “jank” in the UI. For example, a <code>RecyclerView</code> might scroll unevenly, or the screen might freeze for some time. Android Studio<a data-primary="Android Studio" data-secondary="alerts in" data-type="indexterm" id="idm46177227663080"/> is kind enough to alert us in logcat; you’ll often see messages like this:</p>&#13;
<blockquote>&#13;
<p>I/Choreographer(1234): Skipped 20 frames! The application may be doing too much work on its main thread.</p></blockquote>&#13;
&#13;
<p>That means that the system tried <em>twenty times</em> to draw your UI but was unable to do so because it was deprived of the resources necessary.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Perform a Task in a Background Thread" data-type="sect2"><div class="sect2" id="idm46177227654504">&#13;
<h2>Perform a Task in a Background Thread</h2>&#13;
&#13;
<p>So how<a data-primary="concurrency (multi-threading)" data-secondary="Android" data-tertiary="using background threads" data-type="indexterm" id="idm46177227652584"/><a data-primary="Android" data-secondary="concurrency (multi-threading)" data-tertiary="using background threads" data-type="indexterm" id="idm46177227624408"/><a data-primary="background threads" data-secondary="Android" data-type="indexterm" id="idm46177227623192"/> do we do work off the main thread? It’s pretty simple, actually. As we’ve described, create a new <code>Thread</code> instance, do some work in the <code>run</code> method of the <span class="keep-together"><code>Runnable</code></span> instance passed to the constructor, and fire it off by calling <code>start</code>:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177227619944">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="k">new</code> <code class="nf">Thread</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyTag"</code><code class="o">,</code> <code class="s">"This log is from a background thread"</code><code class="o">)).</code><code class="na">start</code><code class="o">();</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="n">Thread</code><code class="o">({</code><code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyTag"</code><code class="o">,</code> <code class="s">"This log is from a background thread"</code><code class="o">)}).</code><code class="na">start</code><code class="o">()</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>That’s it! There also exist a number of classes that help manage <code>Threads</code>, including <code>ThreadPoolExecutor</code> and the <code>Executors</code> static helper functions (which generally return preconfigured instances of <code>ThreadPoolExecutor</code>). The benefit of a thread pool is that you control exactly how much work is happening in the background at any time, and you can queue and remove tasks as they are requested and completed. Check the developer docs for <a href="https://oreil.ly/9pV5G">ThreadPoolExecutor</a> and <a href="https://oreil.ly/WKIRY">Executors</a>.</p>&#13;
&#13;
<p>You may have heard that concurrency is one of the hardest things to master in computer science, and we won’t pretend that there aren’t some extremely sophisticated concepts in play, but most of these are under the covers, provided by the system, or easily avoidable. Mike has been known to say that “threading is easy; synchronization is hard.” That’s to say that, as we can see, it’s simple enough to fire off some work in a background thread, but there are about 3,500 asterisks attached to that statement (excuse the hyperbole). For example, in the Android framework, you can’t access any <code>View</code> instance whatsoever, except on the main thread. That’s kind of a big deal! In the <code>Runnable.run</code> method passed in the preceding example, you couldn’t even <em>reference</em> a <code>View</code> instance without a <code>RuntimeException</code>. Further, you have no guarantee in what order multiple background threads will resolve; this is where we start to get into the weeds of concurrency—the byte code your Java generates doesn’t always look exactly like the Java you write.</p>&#13;
&#13;
<p>The classic example of an “unsafe” thread would be something like the following:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177227574168">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">MainActivity</code> <code class="kd">extends</code> <code class="n">Activity</code> <code class="o">{</code>&#13;
&#13;
  <code class="kd">private</code> <code class="kd">static</code> <code class="kd">final</code> <code class="kt">int</code> <code class="n">MAX</code> <code class="o">=</code> <code class="mi">1000</code><code class="o">;</code>&#13;
  <code class="kd">private</code> <code class="kt">int</code> <code class="n">mCounter</code><code class="o">;</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">onCreate</code><code class="o">(</code><code class="n">Bundle</code> <code class="n">savedInstanceState</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="kd">super</code><code class="o">.</code><code class="na">onCreate</code><code class="o">(</code><code class="n">savedInstanceState</code><code class="o">);</code>&#13;
    <code class="n">setContentView</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">layout</code><code class="o">.</code><code class="na">activity_main</code><code class="o">);</code>  <code class="c1">// has a View with an id "button" in it</code>&#13;
    <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">button</code><code class="o">).</code><code class="na">setOnClickListener</code><code class="o">(</code><code class="n">view</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
      <code class="k">while</code> <code class="o">(</code><code class="n">mCounter</code> <code class="o">&lt;</code> <code class="n">MAX</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="k">new</code> <code class="nf">Thread</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
          <code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyTag"</code><code class="o">,</code> <code class="n">String</code><code class="o">.</code><code class="na">valueOf</code><code class="o">(</code><code class="n">mCounter</code><code class="o">++));</code>&#13;
        <code class="o">}).</code><code class="na">start</code><code class="o">();</code>&#13;
      <code class="o">}</code>&#13;
    <code class="o">});</code>&#13;
  <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">MainActivity</code> <code class="p">:</code> <code class="n">Activity</code><code class="p">()</code> <code class="p">{</code>&#13;
&#13;
  <code class="k">private</code> <code class="n">const</code> <code class="k">val</code> <code class="py">MAX</code> <code class="p">=</code> <code class="m">1000</code>&#13;
  <code class="k">private</code> <code class="k">var</code> <code class="py">counter</code><code class="p">:</code> <code class="n">Int</code> <code class="p">=</code> <code class="m">0</code>&#13;
&#13;
  <code class="k">override</code> <code class="k">fun</code> <code class="nf">onCreate</code><code class="p">(</code><code class="n">savedInstanceState</code><code class="p">:</code> <code class="n">Bundle</code><code class="p">?)</code> <code class="p">{</code>&#13;
    <code class="k">super</code><code class="p">.</code><code class="n">onCreate</code><code class="p">(</code><code class="n">savedInstanceState</code><code class="p">)</code>&#13;
    <code class="n">setContentView</code><code class="p">(</code><code class="n">R</code><code class="p">.</code><code class="n">layout</code><code class="p">.</code><code class="n">activity_main</code><code class="p">)</code> <code class="c1">// has a View with an id "button" in it</code>&#13;
    <code class="n">findViewById</code><code class="p">(</code><code class="n">R</code><code class="p">.</code><code class="n">id</code><code class="p">.</code><code class="n">button</code><code class="p">).</code><code class="n">setOnClickListener</code> <code class="p">{</code>&#13;
      <code class="k">while</code> <code class="p">(</code><code class="n">counter</code> <code class="p">&lt;</code> <code class="n">MAX</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">Thread</code> <code class="p">{</code> <code class="n">Log</code><code class="p">.</code><code class="n">d</code><code class="p">(</code><code class="s">"MyTag"</code><code class="p">,</code> <code class="n">counter</code><code class="p">++.</code><code class="n">toString</code><code class="p">())</code> <code class="p">}.</code><code class="n">start</code><code class="p">()</code>&#13;
      <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>Depending on your hardware and environment, the exact number of concurrent tasks may need to be higher (or lower) to see the effect, but play around with that basic task, and sooner or later you’ll see a final log that is <em>not</em> 9,999. Without spending a ton of time on the nuances of thread safety, we know that the bytecode for the increment operator probably looks something like this when converted to byte code:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Get the value of <code>mCounter</code> from memory.</p>&#13;
</li>&#13;
<li>&#13;
<p>Add 1 to the value of <code>mCounter</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Write the value of <code>mCounter</code> back to memory.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Since concurrent threads switch between each other rapidly to simulate simultaneous operations (this is known as “context switching”), thread #391 might read the value right between steps 1 and 2 occurring in thread #390. This<a data-primary="thread safety" data-type="indexterm" id="idm46177227283896"/> specific example is called a race condition, and this problem generally is known as thread interference, or thread interleaving, and is one example of a <em>lack</em> of <em>thread safety</em>. This is far from a complete examination of the perils of concurrent programming—some implementations of Java allow individual threads to make copies of variables to avoid expensive<a data-primary="interprocess communication (IPC)" data-type="indexterm" id="idm46177227281848"/> IPC (interprocess communication) calls, so when multiple threads mutate a single object instance, state cannot be guaranteed.</p>&#13;
&#13;
<p>There are mechanisms to avoid this, like the <code>synchronized</code> and <code>volatile</code> keywords, and the <code>Atomic</code> classes, and since data structures are especially vulnerable (imagine one thread looping through a data structure while another adds or removes items to it), there are a number of thread-safe (but less performant) versions of several data structures or helper methods to mitigate the threat.</p>&#13;
&#13;
<p>That said, this is all well beyond the scope of this chapter. It can takes years to master multi-threaded programming in even a single technology stack, and some developers never truly understand what’s happening under the hood—and in many cases, this is perfectly appropriate! A terrific UI programmer might use concurrent programming very differently than a programmer who works with big data. One simple trick in the Android framework is to do your computation on a background thread, then either <code>Activity.runOnUiThread</code>, <code>View.post</code>, or <code>Handler.post</code> those results back to the main thread, where you’re guaranteed serial execution and immune to competition from other processes.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Act on the Results of Work Performed in the Background Thread on the Main Thread" data-type="sect2"><div class="sect2" id="idm46177227653880">&#13;
<h2>Act on the Results of Work Performed in the Background Thread <span class="keep-together">on the Main Thread</span></h2>&#13;
&#13;
<p>As<a data-primary="concurrency (multi-threading)" data-secondary="Android" data-tertiary="acting on background results" data-type="indexterm" id="idm46177227274376"/><a data-primary="Android" data-secondary="concurrency (multi-threading)" data-tertiary="acting on background results" data-type="indexterm" id="idm46177227273160"/> just mentioned, whenever you’re updating your UI as the result of some background thread operation (which is a very common occurrence—you may want to get data from a local database, a remote server, the filesystem, etc.), you’ll need to return to the main/UI thread before referencing any <code>View</code> instances. Even beyond <code>View</code> classes, it can be helpful to update common objects on a single thread (the main thread) to avoid the synchronization issues described earlier.</p>&#13;
&#13;
<p>There are three primary ways to send a message from a background thread to the main thread:</p>&#13;
<ol>&#13;
<li>&#13;
<p>The <code>View.post</code> method will accept a <code>Runnable</code> instance and call that instance’s <code>run</code> method on the main thread.</p>&#13;
</li>&#13;
<li>&#13;
<p>The <code>Activity.runOnUiThread</code> functions almost identically to <code>View.post</code> but does make a check first to see if the invocation is already happening on the main thread—if it is, the <code>run</code> method will be called immediately, rather than posted to the end of a message queue (see the following code).</p>&#13;
</li>&#13;
<li>&#13;
<p>A <code>Handler</code> instance will <code>post</code> messages to the <code>Looper</code> it is associated with, so a <code>Handler</code> created with <code>new Handler(Looper.getMainLooper())</code> will post messages on the main thread. Again, this method accepts a <code>Runnable</code> instance and will call that instance’s <code>run</code> method. Note that both of the preceding operations actually end up here, unless <code>Activity.runOnUiThread</code> is called from the UI thread directly.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Here’s<a data-primary="Java" data-secondary="concurrency (multi-threading)" data-tertiary="acting on background results" data-type="indexterm" id="idm46177227259960"/><a data-primary="Kotlin" data-secondary="concurrency (multi-threading)" data-tertiary="acting on background results" data-type="indexterm" id="idm46177227258648"/> a simple example:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177227257144">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">MainActivity</code> <code class="kd">extends</code> <code class="n">Activity</code> <code class="o">{</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">onCreate</code><code class="o">(</code><code class="n">Bundle</code> <code class="n">savedInstanceState</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="kd">super</code><code class="o">.</code><code class="na">onCreate</code><code class="o">(</code><code class="n">savedInstanceState</code><code class="o">);</code>&#13;
    <code class="n">setContentView</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">layout</code><code class="o">.</code><code class="na">activity_main</code><code class="o">);</code> <code class="c1">// has a View with an id "button" in it</code>&#13;
    <code class="n">Button</code> <code class="n">button</code> <code class="o">=</code> <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">button</code><code class="o">);</code>&#13;
    <code class="n">button</code><code class="o">.</code><code class="na">setOnClickListener</code><code class="o">(</code><code class="n">view</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
      <code class="n">button</code><code class="o">.</code><code class="na">setText</code><code class="o">(</code><code class="s">"Sleeping"</code><code class="o">);</code>&#13;
      <code class="k">new</code> <code class="nf">Thread</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
          <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">2000</code><code class="o">);</code>&#13;
          <code class="n">button</code><code class="o">.</code><code class="na">post</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="n">button</code><code class="o">.</code><code class="na">setText</code><code class="o">(</code><code class="s">"Awake"</code><code class="o">));</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">InterruptedException</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
          <code class="n">e</code><code class="o">.</code><code class="na">printStackTrace</code><code class="o">();</code>&#13;
        <code class="o">}</code>&#13;
      <code class="o">}).</code><code class="na">start</code><code class="o">();</code>&#13;
    <code class="o">});</code>&#13;
  <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">class</code> <code class="nc">MainActivity</code> <code class="o">:</code> <code class="n">Activity</code><code class="o">()</code> <code class="o">{</code>&#13;
&#13;
  <code class="n">override</code> <code class="n">fun</code> <code class="nf">onCreate</code><code class="o">(</code><code class="nl">savedInstanceState:</code> <code class="n">Bundle</code><code class="o">?)</code> <code class="o">{</code>&#13;
    <code class="kd">super</code><code class="o">.</code><code class="na">onCreate</code><code class="o">(</code><code class="n">savedInstanceState</code><code class="o">)</code>&#13;
    <code class="n">setContentView</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">layout</code><code class="o">.</code><code class="na">activity_main</code><code class="o">)</code> <code class="c1">// has a View with an id "button" in it</code>&#13;
    <code class="n">button</code><code class="o">.</code><code class="na">setOnClickListener</code> <code class="o">{</code> <code class="n">view</code> <code class="o">-&gt;</code>&#13;
      <code class="n">button</code><code class="o">.</code><code class="na">text</code> <code class="o">=</code> <code class="s">"Sleeping"</code>&#13;
      <code class="n">Thread</code> <code class="o">{</code>&#13;
        <code class="k">try</code> <code class="o">{</code>&#13;
          <code class="n">Thread</code><code class="o">.</code><code class="na">sleep</code><code class="o">(</code><code class="mi">2000</code><code class="o">)</code>&#13;
          <code class="n">button</code><code class="o">.</code><code class="na">post</code> <code class="o">{</code> <code class="n">button</code><code class="o">.</code><code class="na">text</code> <code class="o">=</code> <code class="s">"Awake"</code> <code class="o">}</code>&#13;
        <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="nl">e:</code> <code class="n">InterruptedException</code><code class="o">)</code> <code class="o">{</code>&#13;
          <code class="c1">// no op</code>&#13;
        <code class="o">}</code>&#13;
      <code class="o">}.</code><code class="na">start</code><code class="o">()</code>&#13;
    <code class="o">}</code>&#13;
  <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Terminating a Thread" data-type="sect2"><div class="sect2" id="idm46177227059336">&#13;
<h2>Terminating a Thread</h2>&#13;
&#13;
<p>Again, this<a data-primary="concurrency (multi-threading)" data-secondary="Android" data-tertiary="thread termination" data-type="indexterm" id="CMTanterm08"/><a data-primary="Android" data-secondary="concurrency (multi-threading)" data-tertiary="thread termination" data-type="indexterm" id="AcCterm08"/> is a topic with some controversy and perhaps a lack of consensus. Normally, a thread will terminate when it has completed its work—when the <code>run</code> method of the <code>Runnable</code> would normally return. However, it’s often desirable to stop a background thread prematurely. For example, if a user started downloading a large video clip, which could be several hundred megabytes, they might decide after a few minutes that it’s not worth the bandwidth or space and terminate the download.</p>&#13;
&#13;
<p>If you were doing this same process in your own thread and used some third-party downloader library, which had an atomic <code>download</code> method, it’d be impossible<a data-primary="Java" data-secondary="concurrency (multi-threading)" data-tertiary="thread termination" data-type="indexterm" id="JCterm08"/><a data-primary="Kotlin" data-secondary="concurrency (multi-threading)" data-tertiary="thread termination" data-type="indexterm" id="KCterm08"/> to break out:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177226994776">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="c1">// imagine downloader to be an instance of a third-party downloader</code>&#13;
<code class="c1">// library, already configured</code>&#13;
<code class="n">Downloader</code> <code class="n">downloader</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Downloader</code><code class="o">(</code><code class="n">url</code><code class="o">);</code>&#13;
<code class="k">new</code> <code class="nf">Thread</code><code class="o">(</code><code class="nl">downloader:</code><code class="o">:</code><code class="n">download</code><code class="o">).</code><code class="na">start</code><code class="o">();</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="c1">// imagine downloader to be an instance of a third-party downloader</code>&#13;
<code class="c1">// library, already configured</code>&#13;
<code class="n">val</code> <code class="n">downloader</code> <code class="o">=</code> <code class="n">Downloader</code><code class="o">(</code><code class="n">url</code><code class="o">);</code>&#13;
<code class="n">Thread</code><code class="o">(</code><code class="n">Runnable</code> <code class="o">{</code> <code class="n">downloader</code><code class="o">.</code><code class="na">download</code><code class="o">()</code> <code class="o">}).</code><code class="na">start</code><code class="o">()</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>There is a deprecated <code>Thread</code> method, <code>stop</code>, but its use is discouraged and it may be removed from the standard library in the future.</p>&#13;
&#13;
<p>The <code>join</code> method is often tempting to those learning the <code>Thread</code> API, but it’s commonly misunderstood. The Java 8 docs at the time of this writing explain the <code>join</code> method like so:</p>&#13;
<blockquote>&#13;
<p>This implementation uses a loop of this.wait calls conditioned on this.isAlive. As a thread terminates the this.notifyAll method is invoked. It is recommended that applications not use wait, notify, or notifyAll on Thread instances.</p>&#13;
</blockquote>&#13;
&#13;
<p>This may <em>seem</em> like the thread functionally terminates, especially when working with a “main” or UI thread, but in reality it’s still in memory, and continues to maintain all references as reachable, until the thread that invoked the method itself terminates. So, in the case of Android that does use a UI thread, which serves as the default context, if you start a “background” thread and call <code>join</code> on it, it’ll exist but just spin until the main thread terminates (typically the end of the application or resource reclamation). Since this often involves the entire process collapsing, you may not even notice the background thread, but know that it <em>is</em> still there, holding on to references (memory leaks) and spinning until the program itself exits.</p>&#13;
&#13;
<p>There is another very misunderstood method on the <code>Thread</code> class called <code>interrupt</code>, but this does not do what most people think it does. It simply sets a boolean flag on the thread; prior to calling <code>interrupt</code>, calls to <code>isInterrupted</code> will return <code>false</code>. Subsequent to calling <code>interrupt</code>, calls will return <code>true</code>. <em>By itself, <code>interrupt</code> does nothing to stop the <code>Thread</code>’s operation</em>.</p>&#13;
&#13;
<p>This API was created almost as a convention; library writers should periodically check <code>isInterrupted</code> and either <code>throw</code> an <code>Exception</code> or return out immediately when it’s true, <em>but this is in no way guaranteed</em>. We can <em>hope</em> the authors of the <code>Downloader</code> library did this, and did this in a fashion that makes sense, but we can’t be sure of it, which may mean you need to handle delicate tasks like this yourself. Again using download as an example, you may want to check <code>isInterrupted</code> in each iteration of the <code>InputStream.read</code>/<code>OutputStream.write</code> loop. For example, let’s refer to the simple download method in <a href="ch09.html#topics_networking">Networking</a> and modify it to be cancellable:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177226877144">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">Networking</code> <code class="o">{</code>&#13;
 <code class="kd">public</code> <code class="kd">static</code> <code class="kt">void</code> <code class="nf">downloadBinaryData</code><code class="o">(</code><code class="n">Context</code> <code class="n">context</code><code class="o">)</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
   <code class="n">File</code> <code class="n">file</code> <code class="o">=</code> <code class="k">new</code> <code class="n">File</code><code class="o">(</code><code class="n">context</code><code class="o">.</code><code class="na">getFilesDir</code><code class="o">(),</code> <code class="s">"downloaded-image.png"</code><code class="o">);</code>&#13;
   <code class="n">FileOutputStream</code> <code class="n">fileOutputStream</code> <code class="o">=</code> <code class="k">new</code> <code class="n">FileOutputStream</code><code class="o">(</code><code class="n">file</code><code class="o">);</code>&#13;
   <code class="n">URL</code> <code class="n">url</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URL</code><code class="o">(</code><code class="s">"http://moagrius.com/assets/images/hero-trips.png"</code><code class="o">);</code>&#13;
   <code class="n">HttpURLConnection</code> <code class="n">connection</code> <code class="o">=</code> <code class="o">(</code><code class="n">HttpURLConnection</code><code class="o">)</code> <code class="n">url</code><code class="o">.</code><code class="na">openConnection</code><code class="o">();</code>&#13;
   <code class="kt">int</code> <code class="n">data</code><code class="o">;</code>&#13;
   <code class="k">while</code> <code class="o">((</code><code class="n">data</code> <code class="o">=</code> <code class="n">connection</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">().</code><code class="na">read</code><code class="o">())</code> <code class="o">!=</code> <code class="o">-</code><code class="mi">1</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="c1">// let's drop out if interrupted</code>&#13;
    <code class="k">if</code> <code class="o">(</code><code class="n">Thread</code><code class="o">.</code><code class="na">currentThread</code><code class="o">().</code><code class="na">isInterrupted</code><code class="o">())</code> <code class="o">{</code>&#13;
      <code class="k">throw</code> <code class="k">new</code> <code class="nf">InterruptedException</code><code class="o">(</code><code class="s">"Download cancelled!"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
    <code class="n">fileOutputStream</code><code class="o">.</code><code class="na">write</code><code class="o">(</code><code class="n">data</code><code class="o">);</code>&#13;
   <code class="o">}</code>&#13;
   <code class="n">fileOutputStream</code><code class="o">.</code><code class="na">flush</code><code class="o">();</code>&#13;
  <code class="o">}</code>&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre data-code-language="java" data-type="programlisting"><code class="n">fun</code> <code class="nf">downloadBinaryData</code><code class="o">(</code><code class="nl">context:</code> <code class="n">Context</code><code class="o">)</code> <code class="o">{</code>&#13;
  <code class="n">val</code> <code class="n">file</code> <code class="o">=</code> <code class="n">File</code><code class="o">(</code><code class="n">context</code><code class="o">.</code><code class="na">filesDir</code><code class="o">,</code> <code class="s">"downloaded-image.png"</code><code class="o">)</code>&#13;
  <code class="n">val</code> <code class="n">fileOutputStream</code> <code class="o">=</code> <code class="n">FileOutputStream</code><code class="o">(</code><code class="n">file</code><code class="o">)</code>&#13;
  <code class="n">val</code> <code class="n">url</code> <code class="o">=</code> <code class="n">URL</code><code class="o">(</code><code class="s">"http://moagrius.com/assets/images/hero-trips.png"</code><code class="o">)</code>&#13;
  <code class="n">val</code> <code class="n">connection</code> <code class="o">=</code> <code class="n">url</code><code class="o">.</code><code class="na">openConnection</code><code class="o">()</code> <code class="n">as</code> <code class="n">HttpURLConnection</code>&#13;
  <code class="n">var</code> <code class="n">data</code> <code class="o">=</code> <code class="n">connection</code><code class="o">.</code><code class="na">inputStream</code><code class="o">.</code><code class="na">read</code><code class="o">()</code>&#13;
  <code class="k">while</code> <code class="o">(</code><code class="n">data</code> <code class="o">!=</code> <code class="o">-</code><code class="mi">1</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="c1">// let's drop out if interrupted</code>&#13;
    <code class="k">if</code> <code class="o">(</code><code class="n">Thread</code><code class="o">.</code><code class="na">currentThread</code><code class="o">().</code><code class="na">isInterrupted</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="k">throw</code> <code class="nf">InterruptedException</code><code class="o">(</code><code class="s">"Download cancelled!"</code><code class="o">)</code>&#13;
    <code class="o">}</code>&#13;
    <code class="n">fileOutputStream</code><code class="o">.</code><code class="na">write</code><code class="o">(</code><code class="n">data</code><code class="o">)</code>&#13;
    <code class="n">data</code> <code class="o">=</code> <code class="n">connection</code><code class="o">.</code><code class="na">inputStream</code><code class="o">.</code><code class="na">read</code><code class="o">()</code>&#13;
  <code class="o">}</code>&#13;
  <code class="n">fileOutputStream</code><code class="o">.</code><code class="na">flush</code><code class="o">()</code>&#13;
<code class="o">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>In the <code>try/catch</code> block that performs the <code>downloadBinaryData</code> operation, you’d probably want to delete the partially written file and possibly update the UI to hide progress or show the status to the user. You’d probably also want a <code>cancel</code> method that’d call <code>Thread.interrupt()</code> on the background thread. Something like this (modified to be Android-ready and dressed up a bit) might do the trick:</p>&#13;
<aside class="java-kotlin" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46177226709240">&#13;
<h5/>&#13;
<p><em>Java</em></p>&#13;
&#13;
<pre class="small" data-code-language="java" data-type="programlisting"><code class="kd">public</code> <code class="kd">class</code> <code class="nc">MainActivity</code> <code class="kd">extends</code> <code class="n">Activity</code> <code class="o">{</code>&#13;
&#13;
  <code class="kd">private</code> <code class="n">Thread</code> <code class="n">mBackgroundThread</code><code class="o">;</code>&#13;
&#13;
  <code class="nd">@Override</code>&#13;
  <code class="kd">protected</code> <code class="kt">void</code> <code class="nf">onCreate</code><code class="o">(</code><code class="n">Bundle</code> <code class="n">savedInstanceState</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="kd">super</code><code class="o">.</code><code class="na">onCreate</code><code class="o">(</code><code class="n">savedInstanceState</code><code class="o">);</code>&#13;
    <code class="n">setContentView</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">layout</code><code class="o">.</code><code class="na">activity_main</code><code class="o">);</code> <code class="c1">// has a View with an id "button" in it</code>&#13;
    <code class="n">Button</code> <code class="n">button</code> <code class="o">=</code> <code class="n">findViewById</code><code class="o">(</code><code class="n">R</code><code class="o">.</code><code class="na">id</code><code class="o">.</code><code class="na">button</code><code class="o">);</code>&#13;
    <code class="n">button</code><code class="o">.</code><code class="na">setOnClickListener</code><code class="o">(</code><code class="k">this</code><code class="o">::</code><code class="n">clickHandler</code><code class="o">);</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">clickHandler</code><code class="o">(</code><code class="n">View</code> <code class="n">view</code><code class="o">)</code> <code class="o">{</code>&#13;
    <code class="k">if</code> <code class="o">(</code><code class="n">mBackgroundThread</code> <code class="o">!=</code> <code class="kc">null</code><code class="o">)</code> <code class="o">{</code>&#13;
      <code class="n">cancel</code><code class="o">();</code>&#13;
    <code class="o">}</code> <code class="k">else</code> <code class="o">{</code>&#13;
      <code class="n">downloadInBackground</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">downloadInBackground</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">mBackgroundThread</code> <code class="o">=</code> <code class="k">new</code> <code class="n">Thread</code><code class="o">(()</code> <code class="o">-&gt;</code> <code class="o">{</code>&#13;
      <code class="k">try</code> <code class="o">{</code>&#13;
        <code class="n">downloadBinaryData</code><code class="o">();</code>&#13;
      <code class="o">}</code> <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">e</code><code class="o">)</code> <code class="o">{</code>&#13;
        <code class="n">Log</code><code class="o">.</code><code class="na">d</code><code class="o">(</code><code class="s">"MyTag"</code><code class="o">,</code> <code class="s">"cancelled!"</code><code class="o">);</code>&#13;
      <code class="o">}</code> <code class="k">finally</code> <code class="o">{</code>&#13;
        <code class="n">mBackgroundThread</code> <code class="o">=</code> <code class="kc">null</code><code class="o">;</code>&#13;
      <code class="o">}</code>&#13;
    <code class="o">});</code>&#13;
    <code class="n">mBackgroundThread</code><code class="o">.</code><code class="na">start</code><code class="o">();</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">cancel</code><code class="o">()</code> <code class="o">{</code>&#13;
    <code class="n">mBackgroundThread</code><code class="o">.</code><code class="na">interrupt</code><code class="o">();</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">private</code> <code class="kt">boolean</code> <code class="nf">assetDownloadIsNotCancelled</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">InterruptedException</code> <code class="o">{</code>&#13;
    <code class="k">if</code> <code class="o">(</code><code class="n">mBackgroundThread</code><code class="o">.</code><code class="na">isInterrupted</code><code class="o">())</code> <code class="o">{</code>&#13;
      <code class="k">throw</code> <code class="k">new</code> <code class="nf">InterruptedException</code><code class="o">(</code><code class="s">"Download cancelled!"</code><code class="o">);</code>&#13;
    <code class="o">}</code>&#13;
    <code class="k">return</code> <code class="kc">true</code><code class="o">;</code>&#13;
  <code class="o">}</code>&#13;
&#13;
  <code class="kd">public</code> <code class="kt">void</code> <code class="nf">downloadBinaryData</code><code class="o">()</code> <code class="kd">throws</code> <code class="n">Exception</code> <code class="o">{</code>&#13;
    <code class="n">File</code> <code class="n">file</code> <code class="o">=</code> <code class="k">new</code> <code class="n">File</code><code class="o">(</code><code class="n">getFilesDir</code><code class="o">(),</code> <code class="s">"downloaded-image.png"</code><code class="o">);</code>&#13;
    <code class="k">if</code> <code class="o">(</code><code class="n">file</code><code class="o">.</code><code class="na">exists</code><code class="o">())</code> <code class="o">{</code>&#13;
      <code class="n">file</code><code class="o">.</code><code class="na">delete</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
    <code class="n">FileOutputStream</code> <code class="n">fileOutputStream</code> <code class="o">=</code> <code class="k">new</code> <code class="n">FileOutputStream</code><code class="o">(</code><code class="n">file</code><code class="o">);</code>&#13;
    <code class="n">assetDownloadIsNotCancelled</code><code class="o">();</code>&#13;
    <code class="n">URL</code> <code class="n">url</code> <code class="o">=</code> <code class="k">new</code> <code class="n">URL</code><code class="o">(</code><code class="s">"http://moagrius.com/assets/images/hero-trips.png"</code><code class="o">);</code>&#13;
    <code class="n">assetDownloadIsNotCancelled</code><code class="o">();</code>&#13;
    <code class="n">HttpURLConnection</code> <code class="n">connection</code> <code class="o">=</code> <code class="o">(</code><code class="n">HttpURLConnection</code><code class="o">)</code> <code class="n">url</code><code class="o">.</code><code class="na">openConnection</code><code class="o">();</code>&#13;
    <code class="n">assetDownloadIsNotCancelled</code><code class="o">();</code>&#13;
    <code class="n">InputStream</code> <code class="n">inputStream</code> <code class="o">=</code> <code class="n">connection</code><code class="o">.</code><code class="na">getInputStream</code><code class="o">();</code>&#13;
    <code class="kt">byte</code><code class="o">[]</code> <code class="n">buffer</code> <code class="o">=</code> <code class="k">new</code> <code class="kt">byte</code><code class="o">[</code><code class="mi">1024</code><code class="o">];</code>&#13;
    <code class="k">try</code> <code class="o">{</code>&#13;
      <code class="k">while</code> <code class="o">(</code><code class="n">assetDownloadIsNotCancelled</code><code class="o">())</code> <code class="o">{</code>&#13;
        <code class="kt">int</code> <code class="n">data</code> <code class="o">=</code> <code class="n">inputStream</code><code class="o">.</code><code class="na">read</code><code class="o">(</code><code class="n">buffer</code><code class="o">);</code>&#13;
        <code class="k">if</code> <code class="o">(</code><code class="n">data</code> <code class="o">==</code> <code class="o">-</code><code class="mi">1</code><code class="o">)</code> <code class="o">{</code>&#13;
          <code class="k">break</code><code class="o">;</code> <code class="c1">// EOF</code>&#13;
        <code class="o">}</code>&#13;
        <code class="n">fileOutputStream</code><code class="o">.</code><code class="na">write</code><code class="o">(</code><code class="n">buffer</code><code class="o">,</code> <code class="mi">0</code><code class="o">,</code> <code class="n">data</code><code class="o">);</code>&#13;
        <code class="n">fileOutputStream</code><code class="o">.</code><code class="na">flush</code><code class="o">();</code>&#13;
      <code class="o">}</code>&#13;
    <code class="o">}</code> <code class="k">finally</code> <code class="o">{</code>&#13;
      <code class="n">fileOutputStream</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
      <code class="n">inputStream</code><code class="o">.</code><code class="na">close</code><code class="o">();</code>&#13;
    <code class="o">}</code>&#13;
  <code class="o">}</code>&#13;
&#13;
<code class="o">}</code></pre>&#13;
&#13;
<p><em>Kotlin</em></p>&#13;
&#13;
<pre class="small" data-code-language="kotlin" data-type="programlisting"><code class="k">class</code> <code class="nc">MainActivity</code> <code class="p">:</code> <code class="n">Activity</code><code class="p">()</code> <code class="p">{</code>&#13;
&#13;
  <code class="k">private</code> <code class="k">var</code> <code class="py">backgroundThread</code><code class="p">:</code> <code class="n">Thread</code><code class="p">?</code> <code class="p">=</code> <code class="k">null</code>&#13;
&#13;
  <code class="k">override</code> <code class="k">fun</code> <code class="nf">onCreate</code><code class="p">(</code><code class="n">savedInstanceState</code><code class="p">:</code> <code class="n">Bundle</code><code class="p">?)</code> <code class="p">{</code>&#13;
    <code class="k">super</code><code class="p">.</code><code class="n">onCreate</code><code class="p">(</code><code class="n">savedInstanceState</code><code class="p">)</code>&#13;
    <code class="n">setContentView</code><code class="p">(</code><code class="n">R</code><code class="p">.</code><code class="n">layout</code><code class="p">.</code><code class="n">activity_main</code><code class="p">)</code> <code class="c1">// has a View with an id "button" in it</code>&#13;
    <code class="k">val</code> <code class="py">button</code> <code class="p">=</code> <code class="n">findViewById</code><code class="p">&lt;</code><code class="n">Button</code><code class="p">&gt;(</code><code class="n">R</code><code class="p">.</code><code class="n">id</code><code class="p">.</code><code class="n">browse_button</code><code class="p">)</code>&#13;
    <code class="n">button</code><code class="p">.</code><code class="n">setOnClickListener</code><code class="p">(</code><code class="o">::</code><code class="n">clickHandler</code><code class="p">)</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">fun</code> <code class="nf">clickHandler</code><code class="p">(</code><code class="n">view</code><code class="p">:</code> <code class="n">View</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">backgroundThread</code> <code class="p">!=</code> <code class="k">null</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="n">cancel</code><code class="p">()</code>&#13;
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
      <code class="n">downloadInBackground</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">fun</code> <code class="nf">downloadInBackground</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">backgroundThread</code> <code class="p">=</code> <code class="n">Thread</code> <code class="p">{</code>&#13;
      <code class="k">try</code> <code class="p">{</code>&#13;
        <code class="n">downloadBinaryData</code><code class="p">()</code>&#13;
      <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="n">e</code><code class="p">:</code> <code class="n">Exception</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="n">Log</code><code class="p">.</code><code class="n">d</code><code class="p">(</code><code class="s">"MyTag"</code><code class="p">,</code> <code class="s">"cancelled!"</code><code class="p">)</code>&#13;
      <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>&#13;
        <code class="n">backgroundThread</code> <code class="p">=</code> <code class="k">null</code>&#13;
      <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
    <code class="n">backgroundThread</code><code class="o">?.</code><code class="n">start</code><code class="p">()</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="k">fun</code> <code class="nf">cancel</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="n">backgroundThread</code><code class="o">?.</code><code class="n">interrupt</code><code class="p">()</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="n">@Throws</code><code class="p">(</code><code class="n">InterruptedException</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
  <code class="k">private</code> <code class="k">fun</code> <code class="nf">assetDownloadIsNotCancelled</code><code class="p">():</code> <code class="n">Boolean</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">backgroundThread</code><code class="o">?.</code><code class="n">isInterrupted</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="k">throw</code> <code class="n">InterruptedException</code><code class="p">(</code><code class="s">"Download cancelled!"</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">return</code> <code class="k">true</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="n">@Throws</code><code class="p">(</code><code class="n">Exception</code><code class="o">::</code><code class="k">class</code><code class="p">)</code>&#13;
  <code class="k">fun</code> <code class="nf">downloadBinaryData</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">val</code> <code class="py">file</code> <code class="p">=</code> <code class="n">File</code><code class="p">(</code><code class="n">filesDir</code><code class="p">,</code> <code class="s">"downloaded-image.png"</code><code class="p">)</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="n">file</code><code class="p">.</code><code class="n">exists</code><code class="p">())</code> <code class="p">{</code>&#13;
      <code class="n">file</code><code class="p">.</code><code class="n">delete</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
    <code class="k">val</code> <code class="py">fileOutputStream</code> <code class="p">=</code> <code class="n">FileOutputStream</code><code class="p">(</code><code class="n">file</code><code class="p">)</code>&#13;
    <code class="n">assetDownloadIsNotCancelled</code><code class="p">()</code>&#13;
    <code class="k">val</code> <code class="py">url</code> <code class="p">=</code> <code class="n">URL</code><code class="p">(</code><code class="s">"http://moagrius.com/assets/images/hero-trips.png"</code><code class="p">)</code>&#13;
    <code class="n">assetDownloadIsNotCancelled</code><code class="p">()</code>&#13;
    <code class="k">val</code> <code class="py">connection</code> <code class="p">=</code> <code class="n">url</code><code class="p">.</code><code class="n">openConnection</code><code class="p">()</code> <code class="k">as</code> <code class="n">HttpURLConnection</code>&#13;
    <code class="n">assetDownloadIsNotCancelled</code><code class="p">()</code>&#13;
    <code class="k">val</code> <code class="py">inputStream</code> <code class="p">=</code> <code class="n">connection</code><code class="p">.</code><code class="n">inputStream</code>&#13;
    <code class="k">val</code> <code class="py">buffer</code> <code class="p">=</code> <code class="n">ByteArray</code><code class="p">(</code><code class="m">1024</code><code class="p">)</code>&#13;
    <code class="k">try</code> <code class="p">{</code>&#13;
      <code class="k">while</code> <code class="p">(</code><code class="n">assetDownloadIsNotCancelled</code><code class="p">())</code> <code class="p">{</code>&#13;
        <code class="k">val</code> <code class="py">data</code> <code class="p">=</code> <code class="n">inputStream</code><code class="p">.</code><code class="n">read</code><code class="p">(</code><code class="n">buffer</code><code class="p">)</code>&#13;
        <code class="k">if</code> <code class="p">(</code><code class="n">data</code> <code class="p">==</code> <code class="p">-</code><code class="m">1</code><code class="p">)</code> <code class="p">{</code>&#13;
          <code class="k">break</code> <code class="c1">// EOF</code>&#13;
        <code class="p">}</code>&#13;
        <code class="n">fileOutputStream</code><code class="p">.</code><code class="n">write</code><code class="p">(</code><code class="n">buffer</code><code class="p">,</code> <code class="m">0</code><code class="p">,</code> <code class="n">data</code><code class="p">)</code>&#13;
        <code class="n">fileOutputStream</code><code class="p">.</code><code class="n">flush</code><code class="p">()</code>&#13;
      <code class="p">}</code>&#13;
    <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>&#13;
      <code class="n">fileOutputStream</code><code class="p">.</code><code class="n">close</code><code class="p">()</code>&#13;
      <code class="n">inputStream</code><code class="p">.</code><code class="n">close</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>The <a href="https://oreil.ly/HyJnl">RxJava</a> library provides a robust set of APIs for dealing with concurrent work, with layers of abstraction to separate your development code from the perils of low-level thread unsafety. This can be a nice tool to get your team up to speed quickly, and share a common codebase, and is a great fit for many people. That said, as with most abstractions, you’ll find the finest-grained control with standard library classes, like <code>Thread</code>.</p>&#13;
&#13;
<p>The <code>AsyncTask</code> class in the Android framework provides a way to do background work and post results back to the main thread. However, be aware that there are valid criticisms of the class. For one, the earliest versions used multiple threads from a <code><span class="keep-together">ThreadPool</span>Executor</code> but was later changed to use a single thread, which again was reversed in a later version. Similarly, there’s no way to break out of an <code>AsyncTask</code>s worker method if the task needs to be cancelled. There seems to be a community consensus that <code>AsyncTask</code> does not provide enough value to justify the drawbacks—the authors believe that in almost all cases, the simple <code>Thread</code> and <code>post</code> back pattern described previously is more simple, reliable, and controllable.</p>&#13;
&#13;
<p>Also, many of the higher-level topics touched on in this chapter are covered in great detail in <em>Efficient Android Threading</em> by Anders Göransson (O’Reilly). And of course, Joshua Bloch’s <em>Efficient Java</em> (O’Reilly) can be helpful to programmers across a wide range of expertise.<a data-primary="" data-startref="KCterm08" data-type="indexterm" id="idm46177225769528"/><a data-primary="" data-startref="JCterm08" data-type="indexterm" id="idm46177225768552"/><a data-primary="" data-startref="AcCterm08" data-type="indexterm" id="idm46177225767608"/><a data-primary="" data-startref="CMTanterm08" data-type="indexterm" id="idm46177225766664"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="iOS" data-type="sect1"><div class="sect1" id="idm46177227707704">&#13;
<h1>iOS</h1>&#13;
&#13;
<p>Concurrency in<a data-primary="concurrency (multi-threading)" data-secondary="iOS" data-tertiary="options available for" data-type="indexterm" id="idm46177225764136"/><a data-primary="iOS" data-secondary="concurrency (multi-threading)" data-tertiary="options available for" data-type="indexterm" id="idm46177225762840"/> iOS can best be described as being fundamentally rooted in the classical antiquity of C, while being modernized through the clever mechanics of Grand Central Dispatch. There<a data-primary="DispatchQueues" data-type="indexterm" id="idm46177225761288"/><a data-primary="Operations" data-type="indexterm" id="idm46177225760616"/><a data-primary="Threads" data-secondary="iOS" data-type="indexterm" id="idm46177225759944"/> are primarily three options available to get work done in the background that a developer is likely to see within an application: <code>DispatchQueue</code>s, <code>Operation</code>s, and <code>Thread</code>s.</p>&#13;
&#13;
<p>There are times to use both, but for the purposes of this chapter, we’ll focus on<a data-primary="Grand Central Dispatch (GCD)" data-type="indexterm" id="idm46177225757128"/> Grand Central Dispatch and <code>DispatchQueue</code>s; they are arguably used the most despite being slightly lower level in iOS. This is due to their simplicity and ease of creation.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Perform a Task in a Background Thread" data-type="sect2"><div class="sect2" id="idm46177225755672">&#13;
<h2>Perform a Task in a Background Thread</h2>&#13;
&#13;
<p>So how<a data-primary="background threads" data-secondary="iOS" data-type="indexterm" id="idm46177225754104"/><a data-primary="concurrency (multi-threading)" data-secondary="iOS" data-tertiary="using background threads" data-type="indexterm" id="idm46177225753096"/><a data-primary="iOS" data-secondary="concurrency (multi-threading)" data-tertiary="using background threads" data-type="indexterm" id="idm46177225751800"/> do you perform work in the background on iOS? Here’s a simple example:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="n">DispatchQueue</code><code class="p">.</code><code class="n">global</code><code class="p">().</code><code class="n">async</code> <code class="p">{</code>&#13;
    <code class="bp">print</code><code class="p">(</code><code class="s">"Do something"</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The first line accesses a global background work queue that’s part of Grand Central Dispatch, or “GCD.” We take this global queue and call <code>async</code> on a closure that’s passed in. The second line is the body of that closure, which just <code>print</code>s a line of text in our simple example.</p>&#13;
&#13;
<p>There are two options for completing operations in GCD: asynchronous and synchronous. Synchronous calls can be made by using the <code>sync()</code> method instead of <code>async()</code>; they are guaranteed to be called in the order they are made. Asynchronous calls will be executed some time in the future, with little to no visibility into when.</p>&#13;
&#13;
<p>Honestly, the preceding code is sufficient for most calls, but often it’s necessary to have a little bit more control on the priority of a particular background operation that needs to be completed. This is possible with code that might look something like this:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="n">DispatchQueue</code><code class="p">.</code><code class="n">global</code><code class="p">(</code><code class="n">qos</code><code class="p">:</code> <code class="p">.</code><code class="n">userInitiated</code><code class="p">).</code><code class="n">async</code> <code class="p">{</code>&#13;
    <code class="bp">print</code><code class="p">(</code><code class="s">"Do something"</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>A new argument is passed into the <code>global()</code> method from before named <code>qos</code>. This parameter is an enum that maps to a set priority of execution within iOS. The different options available are:</p>&#13;
<dl>&#13;
<dt><code>userInteractive</code></dt>&#13;
<dd>&#13;
<p>Highest priority and used for operations that are interactive with the user. Operations that are slow running here make the user interface appear frozen.</p>&#13;
</dd>&#13;
<dt><code>userInitiated</code></dt>&#13;
<dd>&#13;
<p>Slightly lower priority, and more commonly used for background work than <code>userInteractive</code>. Officially, this is an operation the user has started, and it needs results quickly.</p>&#13;
</dd>&#13;
<dt><code>default</code></dt>&#13;
<dd>&#13;
<p>The default level at which work without a<a data-primary="quality of service (QoS)" data-type="indexterm" id="idm46177225684440"/> quality of service (QoS) is performed. It’s not meant to be specified by developers directly.</p>&#13;
</dd>&#13;
<dt><code>utility</code></dt>&#13;
<dd>&#13;
<p>Lower priority than <code>default</code> and meant to be used for utility-type operations, such as downloading a book or video, within an application that are still user-facing.</p>&#13;
</dd>&#13;
<dt><code>background</code></dt>&#13;
<dd>&#13;
<p>Lowest priority of operation. This work isn’t visible to the user.</p>&#13;
</dd>&#13;
<dt><code>unspecified</code></dt>&#13;
<dd>&#13;
<p>The system is intended to infer what the QoS should be. More than likely, you shouldn’t use this.</p>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>These levels of quality also map to levels of performance and energy efficiency. Work performed at the <code>userInteractive</code> level is more performant but less energy efficient. Work done at the <code>background</code> service level is not as performant, but it is more energy <span class="keep-together">efficient</span>.</p>&#13;
</div>&#13;
&#13;
<p>In our preceding example, we’ve passed in <code>userInitiated</code>, indicating that the operation should be performed outside of the main thread in the global queue with a fairly high priority.</p>&#13;
&#13;
<p>Quality of service rules are one of the only ways to customize the global dispatch queues available. However, there is another level of customization:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">let</code> <code class="nv">queue</code> <code class="p">=</code> <code class="n">DispatchQueue</code><code class="p">(</code>&#13;
    <code class="n">label</code><code class="p">:</code> <code class="s">"com.oreilly.nativeappdevelopment"</code><code class="p">,</code> <code class="n">qos</code><code class="p">:</code> <code class="p">.</code><code class="n">background</code><code class="p">,</code> <code class="n">attributes</code><code class="p">:</code> <code class="p">[.</code><code class="n">concurrent</code><code class="p">])</code>&#13;
<code class="n">queue</code><code class="p">.</code><code class="n">async</code> <code class="p">{</code>&#13;
    <code class="bp">print</code><code class="p">(</code><code class="s">"Do something"</code><code class="p">)</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In this example, we start by creating our own <code>DispatchQueue</code> instance. Every dispatch queue needs a unique label. Apple recommends reverse DNS-style labels as the default, but as long as the label provided is unique, that is sufficient. For our example, we’ve passed in a <code>qos</code> value of <code>background</code>, which means operations in this queue will run at the lowest priority.</p>&#13;
&#13;
<p>In addition, we’ve passed in the <code>.concurrent</code> option inside the <code>attributes</code> parameter. Doing this means each operation—or closure in this instance—we pass into the queue will run concurrent of the other operations. The default for the global dispatch queue is <code>.concurrent</code>. The opposite is true for custom dispatch queues—they do not run concurrently by default.</p>&#13;
&#13;
<p>We’re storing this new dispatch queue in the <code>queue</code> variable. The next line takes that <code>queue</code> object and calls the same <code>async(_:)</code> as our previous examples to execute a bit of code.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Act on the Results of Work Performed in the Background Thread on the Main Thread" data-type="sect2"><div class="sect2" id="idm46177225755048">&#13;
<h2>Act on the Results of Work Performed in the Background Thread <span class="keep-together">on the Main Thread</span></h2>&#13;
&#13;
<p>Now, we’ve<a data-primary="concurrency (multi-threading)" data-secondary="iOS" data-tertiary="acting on background results" data-type="indexterm" id="idm46177225626504"/><a data-primary="iOS" data-secondary="concurrency (multi-threading)" data-tertiary="acting on background results" data-type="indexterm" id="idm46177225625240"/> shown how to perform an operation on a background thread. But sometimes you need to get back to the main thread to do some important work. You’ll often see this on iOS whenever the UI needs updating because all UI work happens on the main thread within iOS.</p>&#13;
&#13;
<p>It’s simple enough to head back over to the main thread on iOS:</p>&#13;
&#13;
<pre data-code-language="swift" data-type="programlisting"><code class="n">DispatchQueue</code><code class="p">.</code><code class="n">main</code><code class="p">.</code><code class="n">async</code> <code class="p">{</code>&#13;
    <code class="c1">// Update the UI</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Notice the <code>main</code> property on <code>DispatchQueue</code>. This is a shared queue that all the UI objects operate on within the run loop. Any updates to the UI require a call like this. As an example, after making a network call using <code>URLSessionDataTask</code>, it might be necessary to provide some updated information to the UI. The following code accomplishes this task:</p>&#13;
&#13;
<pre class="small" data-code-language="swift" data-type="programlisting"><code class="kd">let</code> <code class="nv">url</code> <code class="p">=</code> <code class="nb">URL</code><code class="p">(</code><code class="n">string</code><code class="p">:</code> <code class="s">"https://www.example.com"</code><code class="p">)</code><code class="o">!</code>&#13;
<code class="kd">let</code> <code class="nv">task</code> <code class="p">=</code> <code class="n">URLSession</code><code class="p">.</code><code class="n">shared</code><code class="p">.</code><code class="n">dataTask</code><code class="p">(</code><code class="n">with</code><code class="p">:</code> <code class="n">url</code><code class="p">)</code> <code class="p">{</code> <code class="p">(</code><code class="n">data</code><code class="p">,</code> <code class="n">response</code><code class="p">,</code> <code class="n">error</code><code class="p">)</code> <code class="k">in</code>&#13;
    <code class="c1">// Handle errors, etc.</code>&#13;
&#13;
    <code class="k">guard</code> <code class="kd">let</code> <code class="nv">data</code> <code class="p">=</code> <code class="n">data</code><code class="p">,</code> <code class="kd">let</code> <code class="nv">string</code> <code class="p">=</code> <code class="nb">String</code><code class="p">(</code><code class="n">data</code><code class="p">:</code> <code class="n">data</code><code class="p">,</code> <code class="n">encoding</code><code class="p">:</code> <code class="p">.</code><code class="n">utf8</code><code class="p">)</code> <code class="k">else</code> <code class="p">{</code>&#13;
        <code class="bp">print</code><code class="p">(</code><code class="s">"No data returned."</code><code class="p">)</code>&#13;
        <code class="k">return</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="n">DispatchQueue</code><code class="p">.</code><code class="n">main</code><code class="p">.</code><code class="n">async</code> <code class="p">{</code>&#13;
		<code class="c1">// Update UI</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
<code class="n">task</code><code class="p">.</code><code class="n">resume</code><code class="p">()</code></pre>&#13;
&#13;
<p>Without too much explanation about how <code>URLSession</code> works in iOS (see <a data-type="xref" href="ch09.html#topics_networking">Chapter 9</a>), notice the <code>DispatchQueue.main.async(_:)</code> call within the body of the completion handler passed to the request operation. This could be used to update text in a label, change the UI, or just jump to the main thread for simple data synchronization.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Cancelling a GCD operation is not for the faint of heart. It’s generally recommended that if you need cancellable operations, switch to <code>Operation</code> objects with <code>OperationQueue</code>s. This is beyond the scope of this chapter, however. Feel free to check out Apple’s developer documentation on <code>Operation</code> and <code>OperationQueue</code>.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What We’ve Learned" data-type="sect1"><div class="sect1" id="idm46177225429080">&#13;
<h1>What We’ve Learned</h1>&#13;
&#13;
<p>Concurrent operations can get remarkably complex beyond the confines of a simple line or two of example code. There are classes of bugs that exist solely because of concurrent programming.</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Android has a few methods by which to run concurrent operation, but <code>Thread</code> is one of the most widely used and standard approaches to exercising control over the operations being run.</p>&#13;
</li>&#13;
<li>&#13;
<p>GCD offers a convenient scheduling library through which iOS (and macOS) applications can leverage concurrent programming.</p>&#13;
</li>&#13;
<li>&#13;
<p>It’s important to make sure the main thread is not blocked on Android and iOS. Doing so will cause the UI to stutter or appear locked up to the user, which results in a negative experience.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>We’ve also seen that there are some places in code where background threads are inherently useful—like networking code. Now that we’ve learned how to kick off operations in the background of our apps, let’s learn a little bit more about networking within Android and iOS in the next chapter.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>