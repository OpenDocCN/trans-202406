<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 9. Installing Falco"><div class="chapter" id="installing_falco">
<h1><span class="label">Chapter 9. </span>Installing Falco</h1>
<p><a contenteditable="false" data-primary="installing Falco" data-type="indexterm" id="ch09.html0"/>Welcome to <a data-type="xref" href="part03.xhtml#iii_running_falco_in_production">Part III</a> of this book, which will walk you through using Falco in the real world. Now that you know how Falco and its architecture work, the next step is to start using it to protect your applications and systems. In this chapter, you will learn what you need to know to install Falco in production. We will show you different scenarios and common best practices so that you can find the right instructions for your use case.</p>
<p>We’ll start by giving you an overview of common usage scenarios, then we’ll describe different installation methods for each of them. We strongly recommend reading about all of the installation methods, even if you need only some of them, to get a complete picture of the possibilities and choose which fits your needs best.</p>
<section data-type="sect1" data-pdf-bookmark="Choosing Your Setup"><div class="sect1" id="choosing_your_setup">
<h1>Choosing Your Setup</h1>
<p><a contenteditable="false" data-primary="installing Falco" data-secondary="setup choice" data-type="indexterm" id="idm45324224775408"/>The Falco Project officially supports three ways to run Falco in production:</p>
<ul>
<li><p>Running Falco directly on a host</p></li>
<li><p>Running Falco in a container</p></li>
<li><p>Deploying Falco to a Kubernetes cluster</p></li>
</ul>
<p>Each option has a different installation method, and there are a few important differences between the first option and the others. Installing Falco directly on the host is your <em>only</em> choice when your environment does not include a container runtime or Kubernetes. It is also the most secure way to run Falco, because it’s isolated from the container system (and thus difficult to breach in case of compromise). However, installing Falco directly on the host is usually the most difficult solution to maintain. It’s also not always possible (for example, when your applications live in a managed Kubernetes cluster and you don’t have full access to the host machines). The other options are usually more straightforward and easier to manage. Especially if your applications run on a Kubernetes cluster, deploying Falco to Kubernetes is a common choice. Consider the pros and cons of each and your requirements before making your choice.</p>
<p>Before installing Falco with any of these methods, you need to decide how you’re going to use Falco, which can have a significant impact on the installation process and configuration. The two most common scenarios are monitoring syscalls and working with data sources provided by plugins.</p>
<p>The default scenario is instrumenting the system to monitor syscalls. In this case you will need to deploy a Falco sensor on each machine or cluster node, as well as installing a driver on each underlying host.</p>
<p>When you work with data sources provided by plugins, you will likely need to install only one Falco sensor (or one for each event producer), and you won’t need a driver. Although there may be small differences in the actual setup of each data source, for simplicity we can treat this as a single installation scenario because the overall process is very similar. Generally, this latter scenario has fewer requirements and is simpler to implement.</p>
<p>If you need to satisfy more than one scenario at the same time, you will need more Falco installations. You can then aggregate the notifications coming from each sensor by using other tools, like Falcosidekick (discussed in <a data-type="xref" href="ch12.xhtml#consuming_falco_events">Chapter 12</a>).</p>
<p>Your final setup will depend on your needs and choices. The following sections provide instructions for each installation method in the two scenarios mentioned above (monitoring syscalls and working with data sources provided by plugins).</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Installing Directly on the Host"><div class="sect1" id="installing_directly_on_the_host">
<h1>Installing Directly on the Host</h1>
<p><a contenteditable="false" data-primary="installing Falco" data-secondary="installing directly on host" data-type="indexterm" id="ch09.html1"/>Installing Falco directly on a host is a straightforward task—you learned the essential aspects in <a data-type="xref" href="ch02.xhtml#getting_started_with_falco">Chapter 2</a>. This installation method is mainly intended for the default scenario where Falco uses system calls to secure and monitor a system, so it also installs the driver and configures Falco to use it. (In <a data-type="xref" href="ch10.xhtml#configuring_and_running">Chapter 10</a>, we’ll discuss how to change the Falco configuration and set it up for other data sources.)</p>
<p>This method installs the following:</p>
<ul>
<li><p>The user-space program <em>falco</em></p></li>
<li><p>The driver (the kernel module, by default)</p></li>
<li><p>The default configuration file and the default ruleset files in <em>/etc/falco</em></p></li>
<li><p>The <em>falco-driver-loader</em> utility (you can use this to manage the driver)</p></li>
<li><p>A few bundled plugins (these may vary from version to version)</p></li>
</ul>
<p>To install Falco, you will use one of the following artifacts provided by <a href="https://oreil.ly/sOLzu">Falco’s “Download” page</a>:</p>
<ul>
<li><p><em>.rpm</em> package</p></li>
<li><p><em>.deb</em> package</p></li>
<li><p><em>.tar.gz</em> (binary) package</p></li>
</ul>
<p>You should use one of the first two packages if you intend to install Falco via a compatible package manager; otherwise, use the binary package. Read on for more details.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The following subsections include various commands that you need to run on your system. Ensure that you have sufficient privileges to execute them (for example, using <code>sudo</code>).</p>
</div>
<section data-type="sect2" data-pdf-bookmark="Using a Package Manager"><div class="sect2" id="using_a_package_manager">
<h2>Using a Package Manager</h2>
<p><a contenteditable="false" data-primary="installing Falco" data-secondary="package managers for" data-type="indexterm" id="ch09.html2"/><a contenteditable="false" data-primary="package manager" data-secondary="installing Falco with" data-type="indexterm" id="ch09.html3"/>This installation method is for Linux distributions with a package manager that supports <em>.deb</em> or <em>.rpm</em> packages. The setup process for a <em>.deb</em> or <em>.rpm</em> package will also install a systemd unit to use Falco as a service on your system, as well as the kernel module—the default driver—via Dynamic Kernel Module Support (dkms).</p>
<p><em>apt</em> and <em>yum</em> are the most popular package managers that allow installing, respectively, <em>.deb</em> and <em>.rpm</em> packages. If you’re using a different package manager that supports <em>.deb</em> or <em>.rpm</em> packages, the installation procedure will be very similar, though the exact instructions may vary. Refer to its documentation for further details.</p>
<section data-type="sect3" data-pdf-bookmark="Using apt (.deb package)"><div class="sect3" id="using_apt_left_parenthesisdotdeb_packag">
<h3>Using apt (.deb package)</h3>
<p><a contenteditable="false" data-primary="apt (package manager)" data-type="indexterm" id="idm45324224736688"/><a contenteditable="false" data-primary="Debian" data-type="indexterm" id="idm45324224735584"/><a contenteditable="false" data-primary="installing Falco" data-secondary="apt for" data-type="indexterm" id="idm45324224734480"/>apt is the default package manager for Debian and Debian-based distributions like Ubuntu. It allows you to install software applications distributed as <em>.deb</em> packages. To install Falco using apt, you first need to trust The Falco Project’s <a href="https://oreil.ly/Egkoo">GPG key</a> and configure the apt repository that holds Falco packages:</p>
<pre data-type="programlisting">$ <strong>curl -s https://falco.org/repo/falcosecurity-3672BA8F.asc | apt-key add -</strong>
$ <strong>echo "deb https://download.falco.org/packages/deb stable main" | tee \</strong>
<strong>    -a /etc/apt/sources.list.d/falcosecurity.list</strong></pre>
<p>Then update the apt package list:</p>
<pre data-type="programlisting">$ <strong>apt-get update -y</strong></pre>
<p>Since this installation method will also install Falco’s kernel module, you must install the Linux kernel headers as a precondition:</p>
<pre data-type="programlisting">$ <strong>apt-get -y install linux-headers-$(uname -r)</strong></pre>
<p>Finally, install Falco:</p>
<pre data-type="programlisting">$ <strong>apt-get install -y falco</strong></pre>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Using yum (.rpm package)"><div class="sect3" id="using_yum_left_parenthesisdotrpm_packag">
<h3>Using yum (.rpm package)</h3>
<p><a contenteditable="false" data-primary="installing Falco" data-secondary="yum for" data-type="indexterm" id="idm45324224723856"/><a contenteditable="false" data-primary="RPM Package Manager" data-type="indexterm" id="idm45324224722480"/>yum is a command-line utility for Linux distributions that use the RPM Package Manager, such as CentOS, RHEL, Fedora, and Amazon Linux. It allows you to install software applications distributed as <em>.rpm</em> packages. Before installing Falco with yum, you must ensure that the make package and the dkms package are present on your system. You can check that by running:</p>
<pre data-type="programlisting">$ <strong>yum list make dkms</strong></pre>
<p>If they are not present, install them:</p>
<pre data-type="programlisting">$ <strong>yum install epel-release</strong>
$ <strong>yum install make dkms</strong></pre>
<p>Next, trust The Falco Project’s <a href="https://oreil.ly/t5WaG">GPG key</a> and configure the RPM repository that holds Falco packages:</p>
<pre data-type="programlisting">$ <strong>rpm --import https://falco.org/repo/falcosecurity-3672BA8F.asc</strong>
$ <strong>curl -s -o /etc/yum.repos.d/falcosecurity.repo \</strong>
<strong>    https://falco.org/repo/falcosecurity-rpm.repo</strong></pre>
<p>Since this installation method will also install Falco’s kernel module, you must install the Linux kernel headers as a precondition:</p>
<pre data-type="programlisting">$ <strong>yum -y install kernel-devel-$(uname -r)</strong></pre>
<div data-type="tip"><h6>Tip</h6>
<p>If <code>yum -y install kernel-devel-$(uname -r)</code> does not find the kernel headers package, run <code>yum distro-sync</code> and then reboot the system. After the reboot, try the preceding command again.</p>
</div>
<p>Finally, install Falco:</p>
<pre data-type="programlisting">$ <strong>yum -y install falco</strong></pre>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Completing the installation"><div class="sect3" id="completing_the_installation">
<h3>Completing the installation</h3>
<p>You should now have the kernel module installed via dkms and a systemd unit installed to run Falco as a service.</p>
<p>Before you start using Falco, you need to enable the Falco systemd service:</p>
<pre data-type="programlisting">$ <strong>systemctl enable falco</strong></pre>
<p>Your installation is now complete. The service will automatically start running at the next reboot. If you want to start it immediately, just run:</p>
<pre data-type="programlisting">$ <strong>systemctl start falco</strong></pre>
<p>From now on, you can manage the Falco service through the functions provided by systemd.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Switching to the eBPF probe"><div class="sect3" id="switching_to_the_ebpf_probe">
<h3>Switching to the eBPF probe</h3>
<p><a contenteditable="false" data-primary="eBPF probe" data-secondary="Falco installation" data-type="indexterm" id="idm45324224702000"/><a contenteditable="false" data-primary="installing Falco" data-secondary="switching to eBPF probe" data-type="indexterm" id="idm45324224700624"/>Falco packages use the kernel module by default, and this is usually the best choice when installing Falco directly on the host. However, if you have particular requirements or other reasons not to use the kernel module, you can easily switch to the eBPF probe.</p>
<p>First, make sure you have an eBPF probe installed on your system. You can install it using the <em>falco-driver-loader</em> script, as explained in <a data-type="xref" href="#managing_the_driver">“Managing the Driver”</a>.</p>
<p>Then you need to edit the systemd unit file, located at <em>/usr/lib/systemd/user/falco­.ser⁠vice</em> (the path may vary depending on your distro). You can use <code>systemctl edit falco</code> to modify it. You need to add an option to set the <code>FALCO_BPF_PROBE</code> environment variable in the <code>[Service]</code> section of that file. Also, in the same section, comment (or remove) the <code>ExecStartPre</code> and <code>ExecStartPost</code> options, so the Falco service will not load the kernel module anymore. The changes are highlighted in the following excerpt from the <em>falco.service</em> file:</p>
<pre data-type="programlisting">[Unit]
Description=Falco: Container Native Runtime Security
Documentation=https://falco.org/docs/
  
[Service]
Type=simple
User=root
<strong>Environment='FALCO_BPF_PROBE=""'</strong>
<strong>#ExecStartPre=/sbin/modprobe falco</strong>
ExecStart=/usr/bin/falco --pidfile=/var/run/falco.pid
<strong>#ExecStopPost=/sbin/rmmod falco</strong></pre>
<p>Once you’re done, don’t forget to restart the Falco service:</p>
<pre data-type="programlisting">$ <strong>systemctl restart falco</strong></pre>
<p>Falco should now start using the eBPF probe.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Using a plugin"><div class="sect3" id="using_a_plugin">
<h3>Using a plugin</h3>
<p><a contenteditable="false" data-primary="installing Falco" data-secondary="plugins for" data-type="indexterm" id="idm45324224687392"/><a contenteditable="false" data-primary="plugins" data-secondary="installing Falco using" data-type="indexterm" id="idm45324224685792"/>Falco packages come configured for the syscalls instrumentation scenario, so the included systemd unit loads the kernel module when Falco starts. However, if you’re not using syscalls, you don’t need to load the driver. As described in the previous section, to prevent the Falco service from loading the kernel module, edit the <em>/usr/lib/systemd/user/falco.service</em> file and remove (or comment out) the <code>ExecStartPre</code> and <code>ExecStartPost</code> options. Optionally, you can also configure the service to run Falco with a less privileged user by modifying the value of the <code>User</code> option.</p>
<p>Next, you’ll need to configure Falco to use the plugin of your choice (we’ll explain how to do this in <a data-type="xref" href="ch10.xhtml#configuring_and_running">Chapter 10</a>) and restart the Falco service. Falco will then run using the new configuration.<a contenteditable="false" data-primary="" data-startref="ch09.html3" data-type="indexterm" id="idm45324224680592"/><a contenteditable="false" data-primary="" data-startref="ch09.html2" data-type="indexterm" id="idm45324224679152"/></p>
</div></section>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Without Using a Package Manager"><div class="sect2" id="without_using_a_package_manager">
<h2>Without Using a Package Manager</h2>
<p><a contenteditable="false" data-primary="installing Falco" data-secondary="without package manager" data-type="indexterm" id="idm45324224675888"/><a contenteditable="false" data-primary="package manager" data-secondary="installing Falco without" data-type="indexterm" id="idm45324224674512"/>Installing Falco without using a package manager is quick and easy. This installation method is intended for distributions that do not support a compatible package manager. We walked through the steps in detail in <a data-type="xref" href="ch02.xhtml#getting_started_with_falco">Chapter 2</a>, but we’ll give you a short refresher here.</p>
<p>All you need to do is grab the link to the latest available version of the binary package from the <a href="https://oreil.ly/HEvdB">Falco “Download” page</a>, and download it into a local folder:</p>
<pre data-type="programlisting">$ <strong>curl -L -O \</strong>
    <strong>https://download.falco.org/packages/bin/x86_64/falco-0.32.0-x86_64.tar.gz</strong></pre>
<p>Then extract the package and copy its content to your filesystem’s root:</p>
<pre data-type="programlisting">$ <strong>tar -xvf falco-0.32.0-x86_64.tar.gz</strong>
$ <strong>cp -R falco-0.32.0-x86_64/* /</strong></pre>
<p>Finally, if you’re planning to use system calls as your data source, install the driver manually before using Falco (you’ll find instructions in the following section). You don’t need to install the driver if you want to use a plugin. Also note that the binary package does not provide a systemd unit or any other mechanism to run Falco when your system starts automatically, so whether to execute Falco or run it as a service is entirely up to you.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Managing the Driver"><div class="sect2" id="managing_the_driver">
<h2>Managing the Driver</h2>
<p><a contenteditable="false" data-primary="installing Falco" data-secondary="managing the driver" data-type="indexterm" id="idm45324224664416"/><a contenteditable="false" data-primary="system calls" data-secondary="managing the driver" data-type="indexterm" id="idm45324224663040"/>If you use syscalls as a data source, you will likely need to manage the driver. If you installed Falco without a package manager, you’ll have to install the driver before using Falco manually. All the available packages provide a helpful script called <em>falco-driver-loader</em> (introduced in <a data-type="xref" href="ch02.xhtml#getting_started_with_falco">Chapter 2</a>) that you can use for this purpose. If you followed the instructions earlier in this chapter, you should already have it installed on your system.</p>
<p>Our suggestion is to familiarize yourself with the script by using <code>--help</code> to get its command-line usage. To do that, just run:</p>
<pre class="pagebreak-after" data-type="programlisting">$ <strong>falco-driver-loader --help</strong></pre>
<p>The script allows you to perform several actions, including installing a driver (either the kernel module or the eBPF probe) by compiling it or downloading it. It also allows you to remove a previously installed driver.</p>
<p>If you run the script without any options:</p>
<pre data-type="programlisting">$ <strong>falco-driver-loader</strong></pre>
<p>by default it will try to install a kernel module via dkms. To be precise, it will first try to download a prebuilt driver, if one is available for your distribution and kernel version. Otherwise, it will try to compile the driver locally. The script will also inform you if any required dependencies are missing (for example, if dkms or make is not present on your system).</p>
<p>If you want to install the eBPF probe instead, run:<a contenteditable="false" data-primary="" data-startref="ch09.html1" data-type="indexterm" id="idm45324224654400"/></p>
<pre data-type="programlisting">$ <strong>falco-driver-loader bpf</strong></pre>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Running Falco in a Container"><div class="sect1" id="running_falco_in_a_container">
<h1>Running Falco in a Container</h1>
<p><a contenteditable="false" data-primary="containers" data-secondary="running Falco in" data-type="indexterm" id="ch09.html4"/><a contenteditable="false" data-primary="installing Falco" data-secondary="running in a container" data-type="indexterm" id="ch09.html5"/>The Falco Project provides several container images that you can use to run Falco in a container. Although the Falco container images described in this section will work with almost any container runtime, we’ll use Docker in our examples for simplicity. If you want to use a different tool, including Kubernetes, you can apply the same concepts. Even if you are only interested in deploying Falco on Kubernetes, we still advise you to read this section as it presents some essential concepts.</p>
<p><a data-type="xref" href="Images/#falco_container_images_hosted_by_the_do">Table 9-1</a> lists the main available images, which you can get from the <a href="https://oreil.ly/rkZoV">Falco “Download” page</a>. These images contain all the necessary components to install the driver and run Falco. Later in this section, we’ll discuss how to use them to support some common use cases.</p>
<table class="border" id="falco_container_images_hosted_by_the_do">
<caption><span class="label">Table 9-1. </span>Falco container images hosted by the docker.io registry</caption>
<thead>
<tr>
<th>Image name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>falcosecurity/falco</em></td>
<td>This is the default Falco image. It contains Falco, the <em>falco-driver-loader</em> script, and the building toolchain (required to build the driver on the fly). The entry point of this image will call the <em>falco-driver-loader</em> script to automatically install the driver on the host before running Falco in the container.</td>
</tr>
<tr>
<td><em>falcosecurity/falco-driver-loader</em></td>
<td>This image is similar to the default one, but it will not run Falco. The image entry point will only run the <em>falco-driver-loader</em> script. You can use it when you want to install the driver at a different moment or when using the principle of least privilege (see <a data-type="xref" href="#least_privileged_mode">“Least privileged mode”</a>). Since this image alone cannot run Falco, use it in combination with another image, like <em>falcosecurity/falco-no-driver</em>.</td>
</tr>
<tr>
<td><em>falcosecurity/falco-no-driver</em></td>
<td>This alternative to the default image only contains Falco, so it cannot install the driver. Use it when using the principle of least privilege or when your data source does not need a driver (for example, when using a plugin).</td>
</tr>
</tbody>
</table>
<p>Different tags are available for each distributed image. Tags allow you to choose a specific Falco version: for example, <em>falcosecurity/falco:0.32.0</em> contains Falco’s 0.32.0 release. The <em>:latest</em> tag points to the latest released version of Falco.</p>
<p>If you want to experiment with a not-yet-released version of Falco, the <em>:master</em> tag ships the latest available development version. An automatic process builds and publishes images with this tag every time new code changes are merged into the master branch of Falco’s GitHub repository. This means it is not a stable release—don’t use it in production unless you want to try an experimental feature or debug a particular issue. Generally, we suggest always using the <em>:latest</em> tag, since it ships the latest Falco version and ruleset updates.</p>
<p>Next, we will describe how to use these images in the two common scenarios we’ve been discussing: syscall instrumentation, which requires a driver, and using a plugin as a data source, which does not.</p>
<section data-type="sect2" data-pdf-bookmark="Syscall Instrumentation Scenario"><div class="sect2" id="syscall_instrumentation_scenario">
<h2>Syscall Instrumentation Scenario</h2>
<p><a contenteditable="false" data-primary="containers" data-secondary="syscall instrumentation scenario" data-type="indexterm" id="ch09.html6"/><a contenteditable="false" data-primary="installing Falco" data-secondary="syscall instrumentation scenario" data-type="indexterm" id="ch09.html7"/>A Falco driver (either a kernel module or an eBPF probe) installed directly on the host is required for syscall instrumentation. Falco needs to run with enough privileges to interact with the driver; of course, if you want to use a container image to install the driver, that image needs to run with full privileges.</p>
<p>The Falco Project provides two modes for installing the driver on the fly and then running Falco in a container. The first and simplest mode uses just one container image with full privileges. The second uses two images: one image that temporarily runs with full privileges just to install the driver, and another image that then runs Falco with lesser privileges. The second approach allows enhanced security since the long-running container gets a restricted set of privileges, making life harder for a possible attacker. We recommend using least privileged mode to run Falco in a container.</p>
<section data-type="sect3" data-pdf-bookmark="Fully privileged mode"><div class="sect3" id="fully_privileged_mode">
<h3>Fully privileged mode</h3>
<p><a contenteditable="false" data-primary="containers" data-secondary="fully privileged mode" data-type="indexterm" id="idm45324224621120"/><a contenteditable="false" data-primary="fully privileged mode" data-type="indexterm" id="idm45324224619744"/>Running Falco in Docker with full privileges is quite straightforward. You just have to pull the default image:</p>
<pre data-type="programlisting">$ <strong>docker pull falcosecurity/falco:latest</strong></pre>
<p>Then run Falco with the following command:</p>
<pre data-type="programlisting">$ <strong>docker run --rm -i -t \</strong>
<strong>    --privileged \</strong>
<strong>    -v /var/run/docker.sock:/host/var/run/docker.sock \</strong>
<strong>    -v /dev:/host/dev \</strong>
<strong>    -v /proc:/host/proc:ro \</strong>
<strong>    -v /boot:/host/boot:ro \</strong>
<strong>    -v /lib/modules:/host/lib/modules:ro \</strong>
<strong>    -v /usr:/host/usr:ro \</strong>
<strong>    -v /etc:/host/etc:ro \</strong>
<strong>    falcosecurity/falco:latest</strong></pre>
<p>This command will install the driver on the fly before running Falco. The container image uses the kernel module by default. If you want to use the eBPF probe instead, just add the <code>-e FALCO_BPF_PROBE=""</code> option and remove <code>-v /dev:/host/dev</code> (only the kernel module requires <em>/dev</em>).</p>
<p>As you can see, aside from the <code>--privileged</code> option, the preceding command mounts a set of paths from the host into the container (each <code>-v</code> option is a bind mount).</p>
<p>Specifically, the <code>-v /var/run/docker.sock:/host/var/run/docker.sock</code> option shares the Docker socket, so Falco can use Docker to obtain container metadata (as described in <a data-type="xref" href="ch05.xhtml#data_enrichment">Chapter 5</a>, where we discussed Falco’s data enrichment techniques). You can add similar options for each container runtime available on your system. For example, if you also have containerd, include <code>-v /run/containerd/contain⁠erd​.sock:/host/run/containerd/containerd.sock</code>.</p>
<p>Falco requires sharing <em>/dev</em> and <em>/proc</em> to interface with the driver and the system, respectively. Other shared paths are needed to install the driver.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Least privileged mode"><div class="sect3" id="least_privileged_mode">
<h3>Least privileged mode</h3>
<p><a contenteditable="false" data-primary="containers" data-secondary="least privileged mode" data-type="indexterm" id="idm45324224602496"/><a contenteditable="false" data-primary="least privileged mode" data-type="indexterm" id="idm45324224601120"/>This running mode follows the <a href="https://oreil.ly/PKosx">principle of least privilege</a> for enhanced security. Although this mode is the recommended way to run Falco in a container, it might not necessarily work for all systems and configurations. We advise you to give it a try anyway and fall back to the fully privileged mode only if this does not fit your environment.</p>
<p>As noted, this approach uses two different container images. The first step, which requires full privileges, is to install the driver using the <em>falcosecurity/falco-driver-loader</em> image. You’ll need to do this before running Falco for the first time, and if you want to upgrade the driver at any point. (Alternatively, as explained earlier, you can install the driver directly on the host using the <em>falco-driver-loader</em> script shipped with the binary package. If you did so, skip this step.)</p>
<p>To install the driver using a container image, pull the image first:</p>
<pre data-type="programlisting">$ <strong>docker pull falcosecurity/falco-driver-loader:latest</strong></pre>
<p>Then run the installation command:</p>
<pre data-type="programlisting">$ <strong>docker run --rm -i -t \</strong>
<strong>    --privileged \</strong>
<strong>    -v /root/.falco:/root/.falco \</strong>
<strong>    -v /proc:/host/proc:ro \</strong>
<strong>    -v /boot:/host/boot:ro \</strong>
<strong>    -v /lib/modules:/host/lib/modules:ro \</strong>
<strong>    -v /usr:/host/usr:ro \</strong>
<strong>    -v /etc:/host/etc:ro \</strong>
<strong>    falcosecurity/falco-driver-loader:latest</strong></pre>
<p>This command installs the kernel module by default. If you want to use the eBPF probe instead, just add the <code>-e FALCO_BPF_PROBE=""</code> option.</p>
<p>The last step is to run Falco. Since the driver is already installed, you will just need to use the <em>falcosecurity/falco-no-driver</em> image. So, pull it first:</p>
<pre data-type="programlisting">$ <strong>docker pull falcosecurity/falco-no-driver:latest</strong></pre>
<p>Then run Falco:</p>
<pre data-type="programlisting">$ <strong>docker run --rm -i -t \</strong>
<strong>    -e HOST_ROOT=/ \</strong>
<strong>    --cap-add SYS_PTRACE --pid=host $(ls /dev/falco* | xargs -I {}</strong> 
$ <strong>echo --device {}) \</strong>
<strong>    -v /var/run/docker.sock:/var/run/docker.sock \</strong>
<strong>    falcosecurity/falco-no-driver:latest</strong></pre>
<p>If you use another container runtime, customize this command by adding a <code>-v</code> option accordingly.</p>
<p>Finally, there are some caveats when using the eBPF probe. You cannot use least privileged mode unless you have at least kernel version 5.8. This is because, with previous kernel versions, loading the eBPF probe required the <code>--privileged</code> flag. If you are running a kernel version equal to or greater than 5.8, you can use the <code>SYS_BPF</code> capability to overcome this issue by customizing the command as follows:</p>
<pre data-type="programlisting">$ <strong>docker run --rm -i -t \</strong>
<strong>    -e FALCO_BPF_PROBE=""</strong>
<strong>    -e HOST_ROOT=/ \</strong>
<strong>    --cap-add SYS_PTRACE --cap-add SYS_BPF -pid=host \</strong>
<strong>    -v /root/.falco:/root/.falco \</strong>
<strong>    -v /var/run/docker.sock:/var/run/docker.sock \</strong>
<strong>    falcosecurity/falco-no-driver:latest</strong></pre>
<p>Note that on systems with the AppArmor Linux Security Module (LSM) enabled, you will also need to pass the following:</p>
<pre data-type="programlisting">--security-opt apparmor:unconfined</pre>
<div data-type="tip"><h6>Tip</h6>
<p>Depending on the Falco version you are using and your environment, you might need to customize the commands described in this section; refer to the <a href="https://oreil.ly/TXTge">online documentation</a>.<a contenteditable="false" data-primary="" data-startref="ch09.html7" data-type="indexterm" id="idm45324224573776"/><a contenteditable="false" data-primary="" data-startref="ch09.html6" data-type="indexterm" id="idm45324224572368"/></p>
</div>
</div></section>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Plugin Scenario"><div class="sect2" id="plugin_scenario">
<h2>Plugin Scenario</h2>
<p><a contenteditable="false" data-primary="containers" data-secondary="plugin scenario" data-type="indexterm" id="idm45324224569312"/>When you’re using a plugin as your data source, there’s no need to install a driver, nor will Falco need full privileges to run, so we recommend you use the <em>falcosecur⁠ity/​falco-no-driver</em> image for this scenario. Whatever container image you choose, the default Falco configuration it contains won’t work out of the box; you’ll have to give Falco the required configuration for the plugin. You can do that by using an external configuration file and mounting it in the container.</p>
<p>As a preparation step, you’ll have to create a local copy of <a href="https://oreil.ly/E31wy"><em>falco.yaml</em></a> and modify it according to your plugin configuration. We will explain how to do that in the next chapter.</p>
<p>Once you’ve prepared your custom <em>falco.yaml</em>, to run Falco, use the following <span class="keep-together">command:</span></p>
<pre data-type="programlisting">$ <strong>docker run --rm -i -t \</strong>
<strong>    -v falco.yaml:/etc/falco/falco.yaml \</strong>
<strong>    falcosecurity/falco-no-driver:latest</strong></pre>
<p>If you want to use a plugin not shipped in the default Falco distribution, you will have to mount the plugin file and its rules file in the container, too. For example, to mount <em>libmyplugin.so</em> and <em>myplugin_rules.yaml</em>, add the following options to the preceding command:<a contenteditable="false" data-primary="" data-startref="ch09.html5" data-type="indexterm" id="idm45324224560624"/><a contenteditable="false" data-primary="" data-startref="ch09.html4" data-type="indexterm" id="idm45324224559248"/></p>
<pre data-type="programlisting">-v /path/to/libmyplugin.so:/usr/share/falco/plugins/libmyplugin.so 
-v /path/to/myplugin_rules.yaml:/etc/falco/myplugin_rules.yaml</pre>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Deploying to a Kubernetes Cluster"><div class="sect1" id="deploying_to_a_kubernetes_cluster">
<h1>Deploying to a Kubernetes Cluster</h1>
<p><a contenteditable="false" data-primary="cluster security" data-type="indexterm" id="ch09.html8"/><a contenteditable="false" data-primary="installing Falco" data-secondary="deploying to a Kubernetes cluster" data-type="indexterm" id="ch09.html9"/><a contenteditable="false" data-primary="Kubernetes cluster" data-secondary="deploying Falco to" data-type="indexterm" id="ch09.html10"/>One of the most common Falco use cases is securing clusters, so deploying Falco to Kubernetes is perhaps the most important installation method to be aware of. The Falco Project recommends two approaches for this:</p>
<dl>
<dt>Helm</dt>
<dd><p>The first installation method uses Helm, a very popular tool to install and manage software built for Kubernetes. The Falco community provides and maintains a Helm chart for Falco and other tools that integrate with Falco. Installing Falco using the provided chart is straightforward and mostly automatic.</p></dd>
<dt>Kubernetes manifest files</dt>
<dd><p>The other installation method, geared toward flexibility, is based on a set of Kubernetes manifest files. These files provide default installation settings, which users can customize based on their needs. Although this approach requires a bit more effort, it permits the installation of Falco on virtually any Kubernetes cluster without the need for extra tools.</p></dd>
</dl>
<p>Both approaches are solid, and you should select the one that best suits your environment and your organization’s requirements. In the following subsections, we will walk you through each of them. The only requirement is having a Kubernetes cluster installed and running.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The installation methods for Kubernetes described in this section use the default Falco container image discussed in <a data-type="xref" href="#running_falco_in_a_container">“Running Falco in a Container”</a>.</p>
</div>
<section data-type="sect2" data-pdf-bookmark="Using Helm"><div class="sect2" id="using_helm">
<h2>Using Helm</h2>
<p><a contenteditable="false" data-primary="Helm" data-type="indexterm" id="idm45324224542336"/><a contenteditable="false" data-primary="Kubernetes cluster" data-secondary="Helm for installation" data-type="indexterm" id="idm45324224541232"/>If you prefer a fully automated installation process or are already using Helm in your environment, this installation method is for you. Having <a href="https://helm.sh">Helm</a> installed is a prerequisite; for instructions, see the <a href="https://oreil.ly/YCiLB">online documentation</a>.</p>
<p>Falco’s Helm chart will add Falco to all nodes in your cluster using a DaemonSet. Then each deployed Falco Pod will try to install the driver on its own node. That <span class="keep-together">is the default</span> configuration that reflects the most common scenario, syscall <span class="keep-together">instrumentation.</span></p>
<div data-type="tip"><h6>Tip</h6>
<p><a contenteditable="false" data-primary="falco-driver-loader" data-type="indexterm" id="idm45324224535456"/>Falco Pods internally use <em>falco-driver-loader</em>, which tries to download a prebuilt driver; failing that, it will build the driver on the fly. Usually, no action is required. If you notice that the Falco Pods are continuously restarting after being deployed, the process was probably unable to install the driver. This issue usually happens when a prebuilt driver is unavailable for your distribution or kernel and no kernel headers are available on the host. To build the driver, kernel headers must be installed on the host. You can fix the issue by manually installing the kernel headers and then deploying Falco again.</p>
</div>
<p>Helm uses the Kubernetes context provided by <a href="https://oreil.ly/S7tqe">kubectl</a> to access your cluster. Before installing Falco with Helm, ensure that your local configuration points to the proper context. You can check that by running:</p>
<pre data-type="programlisting">$ <strong>kubectl config current-context</strong></pre>
<p>If the context is not pointing to your targeted cluster or kubectl cannot access your cluster, you will have to address this issue. Otherwise, you can proceed with the next step.</p>
<p class="pagebreak-before">Before installing the chart, add Falco’s Helm repository so that your local Helm installation can find the Falco chart:</p>
<pre data-type="programlisting">$ <strong>helm repo add falcosecurity https://falcosecurity.github.io/charts</strong></pre>
<p>Running this command is usually a one-time operation. To get the latest information about the Falco chart, use:</p>
<pre data-type="programlisting">$ <strong>helm repo update</strong></pre>
<p>Execute this command whenever you want to install and update Falco with Helm.</p>
<p>The next and final step is actually to install the chart by running:</p>
<pre data-type="programlisting">$ <strong>helm install falco falcosecurity/falco</strong></pre>
<p>The chart installs the kernel module by default. If you want to use the eBPF probe instead, just append <code>--set ebpf.enabled=true</code> to this command.</p>
<p>And you’re done! After a while, Falco’s Pods will show up in your cluster. You can use the following command to check whether they are ready:</p>
<pre data-type="programlisting">$ <strong>kubectl get all</strong></pre>
<p>The chart installs Falco for the default scenario (syscall instrumentation), as per the default settings. The Helm installation process for other scenarios is very similar; just provide the appropriate configuration. We will discuss how to customize your Falco deployment in <a data-type="xref" href="ch10.xhtml#configuring_and_running">Chapter 10</a>. You can find more information about Falco’s chart configuration in its <a href="https://oreil.ly/pcJWP">online documentation</a>.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Using Manifests"><div class="sect2" id="using_manifests">
<h2>Using Manifests</h2>
<p><a contenteditable="false" data-primary="Kubernetes cluster" data-secondary="manifests for installation" data-type="indexterm" id="idm45324224518480"/><a contenteditable="false" data-primary="Kubernetes manifest files" data-type="indexterm" id="idm45324224517088"/><a contenteditable="false" data-primary="manifests" data-type="indexterm" id="idm45324224515968"/>Kubernetes manifests are JSON or YAML files (mainly YAML) that contain the specifications for one or more Kubernetes API objects and describe your application and its configurations. The kubectl command-line utility lets you deploy your workload in Kubernetes using these files. Projects often provide almost-ready-to-use example manifests, but you’ll usually need to adapt them to your needs.</p>
<p>Since Falco supports very different scenarios and environments, The Falco Project does not officially provide manifests for all use cases. However, for the syscall instrumentation scenario, you can use the <a href="https://oreil.ly/qWW1w">Falco example manifests</a> (listed in <a data-type="xref" href="#example_manifest_files_for_falco">Table 9-2</a>) as a starting point to make your customized manifests.<sup><a data-type="noteref" id="ch01fn10-marker" href="ch09.xhtml#ch01fn10">1</a></sup></p>
<table class="border" id="example_manifest_files_for_falco">
<caption><span class="label">Table 9-2. </span>Example manifest files for Falco</caption>
<thead>
<tr>
<th>Filename</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>daemonset.yaml</em></td>
<td>Specifies a <a href="https://oreil.ly/9YwAV">DaemonSet</a> so that a copy of the Falco Pod will run on each node (required by the syscall instrumentation scenario). The <a href="https://oreil.ly/WRtRb">Pod specification</a> uses the <em>falcosecurity/falco</em> container image. It also includes all settings needed to run the image in this scenario, similar to those described in <a data-type="xref" href="#running_falco_in_a_container">“Running Falco in a Container”</a>.</td>
</tr>
<tr>
<td><em>configmap.yaml</em></td>
<td>Specifies a <a href="https://oreil.ly/vTAdd">ConfigMap</a> containing the default <em>falco.yaml</em> file and rules files. Modify it according to your needs.</td>
</tr>
<tr>
<td><em>serviceaccount.yaml</em></td>
<td>Specifies a <a href="https://oreil.ly/sXkl9">ServiceAccount</a> for running Falco’s Pods. Falco requires this to talk with the Kubernetes API. You usually don’t need to alter it, unless you want to change the service account name.</td>
</tr>
<tr>
<td><em>clusterrole.yaml</em></td>
<td>Specifies a <a href="https://oreil.ly/gWjN4">ClusterRole</a>, including the role-based access control (RBAC) authorizations required by Falco to talk with the Kubernetes API. Don’t change the list of permissions needed, or Falco will not enrich the Kubernetes metadata correctly.</td>
</tr>
<tr>
<td><em>clusterrolebinding.yaml</em></td>
<td>Specifies a <a href="https://oreil.ly/PTEcU">ClusterRoleBinding</a> that grants the permissions defined in <em>clusterrole.yaml</em> to the service account defined in <em>serviceaccount.yaml</em>. You usually won’t need to change this, unless you’ve changed the service account or the cluster role name in the other files.</td>
</tr>
</tbody>
</table>
<p>Once you’ve modified the manifest files according to your needs, to apply them to Kubernetes (that is, to deploy Falco to Kubernetes) just run the following command:</p>
<pre data-type="programlisting">$ <strong>kubectl apply \</strong>
<strong>    -f ./templates/serviceaccount.yaml \</strong>
<strong>    -f ./templates/clusterrole.yaml \</strong>
<strong>    -f ./templates/clusterrolebinding.yaml \</strong>
<strong>    -f ./templates/configmap.yaml \</strong>
<strong>    -f ./templates/daemonset.yaml</strong></pre>
<p>Falco’s Pods should show up in your cluster after a while. To check whether they are ready, use:</p>
<pre data-type="programlisting">$ <strong>kubectl get all</strong></pre>
<p>If everything went well, Falco is now up and running in your production cluster—and you have learned how to customize your Falco deployment. Congratulations!<a contenteditable="false" data-primary="" data-startref="ch09.html10" data-type="indexterm" id="idm45324224484864"/><a contenteditable="false" data-primary="" data-startref="ch09.html9" data-type="indexterm" id="idm45324224483488"/><a contenteditable="false" data-primary="" data-startref="ch09.html8" data-type="indexterm" id="idm45324224482112"/></p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="conclusion-id000008">
<h1>Conclusion</h1>
<p>This chapter introduced the different installation methods available for Falco and explained the difference between the two most common installation scenarios. However, in some cases, your installation will need specific configurations or customizations. The next chapter gives you all the complementary information you need to finally run Falco in production and completely control your Falco installation.<a contenteditable="false" data-primary="" data-startref="ch09.html0" data-type="indexterm" id="idm45324224479072"/></p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="ch01fn10"><sup><a href="ch09.xhtml#ch01fn10-marker">1</a></sup> The actual URLs of the Falco manifest example files for Kubernetes may change from time to time, but you can always find links to them in the <a href="https://oreil.ly/P5BUa">official documentation</a>. Falco’s Helm chart can generate those files, too. Surprisingly, The Falco Project uses this Helm functionality to automatically publish up-to-date manifest example files under the <a href="https://oreil.ly/6QhH3">Falcosecurity GitHub organization</a>.</p></div></div></section></div></body></html>