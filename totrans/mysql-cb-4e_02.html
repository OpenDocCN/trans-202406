<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 2. Using MySQL Shell"><div class="chapter" id="nch-mysqlshell"><h1><span class="label">Chapter 2. </span>Using MySQL Shell</h1><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45820410454464"><h5>A note for Early Release readers</h5><p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p></div></aside><section data-type="sect1" data-pdf-bookmark="2.0 Introduction"><div class="sect1" id="nch-mysqlshell-mysqlshell-intro"><h1>2.0 Introduction</h1><p>
      We discussed the mysql Client Program in <a data-type="xref" href="ch01.xhtml#nch-mysql">Chapter 1</a>. MySQL Shell is modern alternative client. In addition to SQL, it supports non-relational syntax for the database queries, also known as NoSQL, via JavaScript or Python programming interface and provides reach set of features to automate routine tasks.
    </p><p>
      In this chapter we will discuss how to:
      </p><ul><li><p>Connect to MySQL Shell and select the right protocol.</p></li><li><p>Select SQL, JavaScript or Python interface.</p></li><li><p>Use both SQL and NoSQL syntax.</p></li><li><p>Control output format.</p></li><li><p>Use MySQL Shell built-in utilities.</p></li><li><p>Script to automate your custom needs.</p></li><li><p>Use Admin API.</p></li><li><p>Re-use your scripts.</p></li></ul><p>
    </p><p>
      Although MySQL Shell is a standard tool for certain tasks, it is not included in MySQL packages and needs to be installed separately. You can download it from the <a href="https://dev.mysql.com/downloads/shell/">MySQL Shell download page</a> or install using the standard package manager of your operating system. We will not cover MySQL Shell installation in this book, because it is straight forward.
    </p><p>
      The MySQL Shell’s command name is <span class="command"><em>mysqlsh</em></span>. You can invoke it by typing <span class="command"><em>mysqlsh</em></span> in the terminal.
    </p><p>
      MySQL Shell supports two protocols: the classic MySQL protocol (similar to the one that the <span class="command"><em>mysql</em></span> client uses), and the new X protocol. X protocol is a modern protocol that communicates with the MySQL server on a separate port (default is 33060). It supports both SQL and NoSQL APIs, and provides asynchronous API, allowing clients to send multiple queries to the server without waiting for the result from the previous ones. X protocol is preferred way to work with MySQL Shell. It is especially important if you want to use NoSQL features.
    </p></div></section><section data-type="sect1" data-pdf-bookmark="2.1 Connecting to MySQL Server with MySQL Shell"><div class="sect1" id="nch-mysqlshell-mysqlshell-connecting"><h1>2.1 Connecting to MySQL Server with MySQL Shell</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820410442368"><h2>Problem</h2><p>
        When you invoke <span class="command"><em>mysqlsh</em></span> it opens new session, but does not connect to any MySQL Server.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820410440544"><h2>Solution</h2><p>
        Use command <span class="command"><em>\connect</em></span> inside MySQL Shell or provide your MySQL server URI at startup.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820410438752"><h2>Discussion</h2><p>
        MySQL Shell allows you to connect to MySQL server after you started the tool by providing connections options as a command line parameter. You may also put default connection parameters in a startup script.
      </p><p>
        MySQL Shell is flexible regarding connection options. You can supply them as a URI or name-value pairs, similar to one that <span class="command"><em>mysql</em></span> client accepts.
      </p><p>
        URI uses this format:
        </p><pre data-type="programlisting" data-code-language="bash"><code class="o">[</code>scheme://<code class="o">][</code>user<code class="o">[</code>:password<code class="o">]</code>@<code class="o">]</code>&lt;host<code class="o">[</code>:port<code class="o">]</code><code class="p">|</code>socket&gt;<code class="o">[</code>/schema<code class="o">]</code>↩
<code class="o">[</code>?option<code class="o">=</code>value<code class="p">&amp;</code><code class="nv">option</code><code class="o">=</code>value...<code class="o">]</code></pre><p>
        where meanings of the parameters explained in the <a data-type="xref" href="#nch-mysqlshell-mysqlshell-connecting-uri">Table 2-1</a>.
      </p><table id="nch-mysqlshell-mysqlshell-connecting-uri"><caption><span class="label">Table 2-1. </span>Connection Options in URI</caption><thead><tr><th>Parameter</th><th>Explanation</th><th>Default</th></tr></thead><tbody><tr><td><code>scheme</code></td><td>A protocol to use. Could be one of <code>mysql</code> if you want to use Classic protocol or <code>mysqlx</code> for X protocol.</td><td><code>mysqlx</code></td></tr><tr><td><code>user</code></td><td>User name to connect as.</td><td>Your operating system account.</td></tr><tr><td><code>password</code></td><td>Password</td><td>Asks for a password.</td></tr><tr><td><code>host</code></td><td>Host to connect to.</td><td>No default. This is the only <strong>required</strong> parameter unless option <code>socket</code> is specified.</td></tr><tr><td><code>port</code></td><td>Port to connect to.</td><td>3306 for the Classic protocol and 33060 for the X protocol.</td></tr><tr><td><code>socket</code></td><td>Socket, used for the localhost connection.</td><td>You must provide this or the <code>host</code> parameter.</td></tr><tr><td><code>schema</code></td><td>Database schema to connect to.</td><td>No value. Do not select any schema.</td></tr><tr><td><code>option</code></td><td>Any additional option you want to use.</td><td>No value. Choose any or no option.</td></tr></tbody></table><p>
        So, to connect to MySQL server on your local machine using interactive interface, type <span class="command"><em>\connect 127.0.0.1</em></span>:
        </p><pre data-type="programlisting" data-code-language="bash"> MySQL  localhost  JS &gt; <strong><code>\connect 127.0.0.1</code></strong>
Creating a session to 'sveta@127.0.0.1'
Please provide the password for 'sveta@127.0.0.1': 
Save password for 'sveta@127.0.0.1'? [Y]es/[N]o/Ne[v]er (default No): 
Fetching schema names for autocompletion... Press ^C to stop.
Your MySQL connection id is 1066144 (X protocol)
Server version: 8.0.27 MySQL Community Server - GPL
No default schema selected; type \use &lt;schema&gt; to set one.</pre><p>
        This will create a connection using X protocol.
      </p><div data-type="note" epub:type="note"><h6>Note</h6><p>
          When connecting without specifying user name MySQL Shell uses the operating system login. This is why connection is created for user <code>sveta</code> and not for the user <code>cbuser</code> we used everywhere else in the book. We will cover how to specify MySQL user account when connecting later.
        </p></div><p>
        To exit from the MySQL Shell session use command <code>\exit</code> or <code>\quit</code> and its short form <code>\q</code>.
        </p><pre data-type="programlisting" data-code-language="js"> MySQL  JS &gt; <strong><code>\exit</code></strong>
Bye!</pre><p>
      </p><p>
        To connect interactively using a socket, type <span class="command"><em>\c (/var/run/mysqld/mysqld.sock)</em></span>:
        </p><pre data-type="programlisting" data-code-language="bash"> MySQL  127.0.0.1:33060+ ssl  JS &gt; <strong><code>\c (/var/run/mysqld/mysqld.sock)</code></strong>
Creating a session to 'sveta@/var%2Frun%2Fmysqld%2Fmysqld.sock'
Fetching schema names for autocompletion... Press ^C to stop.
Your MySQL connection id is 1067565
Server version: 8.0.27 MySQL Community Server - GPL
No default schema selected; type \use &lt;schema&gt; to set one.</pre><p>
        This will create connection using Classic protocol. If you want to connect via socket with X protocol use <code>mysqlx_socket</code>. You will find value of the <code>mysqlx_socket</code> if run query
        </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">@</code><code class="o">@</code><code class="n">mysqlx_socket</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">-----------------------------+
</code><code class="o">|</code><code> </code><code class="o">@</code><code class="o">@</code><code class="n">mysqlx_socket</code><code>             </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">-----------------------------+
</code><code class="o">|</code><code> </code><code class="o">/</code><code class="n">var</code><code class="o">/</code><code class="n">run</code><code class="o">/</code><code class="n">mysqld</code><code class="o">/</code><code class="n">mysqlx</code><code class="p">.</code><code class="n">sock</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">-----------------------------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      </p><p>
        Command <span class="command"><em>\connect</em></span> has shorter version <span class="command"><em>\c</em></span> that we used in the connection via socket example. Note parentheses in the command argument. Without parentheses the command will fail with syntax error. Alternatively you can replace all following slash symbols with their URI encoded value <code>%2F</code>:
        </p><pre data-type="programlisting"> MySQL  localhost  JS &gt; <strong><code>\connect /var%2Frun%2Fmysqld%2Fmysqld.sock</code></strong>
Creating a session to 'sveta@/var%2Frun%2Fmysqld%2Fmysqld.sock'
Fetching schema names for autocompletion... Press ^C to stop.
Your MySQL connection id is 1073606
Server version: 8.0.27 MySQL Community Server - GPL
No default schema selected; type \use &lt;schema&gt; to set one.</pre><p>
      </p><p>
        To connect using URI when opening a MySQL Shell session, use the command:
        </p><pre data-type="programlisting" data-code-language="bash">$ <strong><code>mysqlsh mysqlx://cbuser:cbpass@127.0.0.1/cookbook</code></strong>
Please provide the password for 'cbuser@127.0.0.1:33060': ******
Save password for 'cbuser@127.0.0.1:33060'? [Y]es/[N]o/Ne[v]er (default No): 
MySQL Shell 8.0.27

Copyright (c) 2016, 2021, Oracle and/or its affiliates.
Oracle is a registered trademark of Oracle Corporation and/or its affiliates.
Other names may be trademarks of their respective owners.

Type '\help' or '\?' for help; '\quit' to exit.
Creating a session to 'cbuser@127.0.0.1:33060/cookbook'
Fetching schema names for autocompletion... Press ^C to stop.
Your MySQL connection id is 1076096 (X protocol)
Server version: 8.0.27 MySQL Community Server - GPL
Default schema `cookbook` accessible through db.
 MySQL  127.0.0.1:33060+ ssl  cookbook  JS &gt;</pre><p>
        In this case we specified a user name and a password via command line and selected <code>cookbook</code> as a default database.
      </p><p>
        When connecting while invoking <span class="command"><em>mysqlsh</em></span> command you can also specify connection credentials separately, similar to when you connected with the <span class="command"><em>mysql</em></span> client.
        </p><pre data-type="programlisting" data-code-language="bash">$ <strong><code>mysqlsh --host=127.0.0.1 --port=33060 --user=cbuser --schema=cookbook</code></strong>
Please provide the password for 'cbuser@127.0.0.1:33060': ******
MySQL Shell 8.0.22

Copyright (c) 2016, 2020, Oracle and/or its affiliates.
Oracle is a registered trademark of Oracle Corporation and/or its affiliates.
Other names may be trademarks of their respective owners.

Type '\help' or '\?' for help; '\quit' to exit.
Creating a session to 'cbuser@127.0.0.1:33060/cookbook'
Fetching schema names for autocompletion... Press ^C to stop.
Your MySQL connection id is 8738 (X protocol)
Server version: 8.0.22-13 Percona Server (GPL), Release '13', Revision '6f7822f'
Default schema `cookbook` accessible through db.
 MySQL  127.0.0.1:33060+ ssl  cookbook  JS &gt;</pre><p>
        If you want to specify default schema, you need to pass it as a parameter to the configuration option <code>schema</code>. Otherwise <span class="command"><em>mysqlsh</em></span> will treat it as a host name and fail with an error.
      </p><p>
        Inside MySQL Shell you can also specify options via named parameters. First you need to create a dictionary with connection parameters, then pass it as an option to the <span class="command"><em>connect()</em></span> method of the built-in automatically created <code>shell</code> object.
        </p><pre data-type="programlisting" data-code-language="js"> MySQL  127.0.0.1:33060+ ssl  JS &gt; <strong><code>connectionData={</code></strong>
                                -&gt; <strong><code>"host": "127.0.0.1",</code></strong>
                                -&gt; <strong><code>"user": "cbuser",</code></strong>
                                -&gt; <strong><code>"schema": "cookbook"</code></strong>
                                -&gt; <strong><code>}</code></strong>
                                -&gt; 
{
    "host": "127.0.0.1", 
    "schema": "cookbook", 
    "user": "cbuser"
}
 MySQL  127.0.0.1:33060+ ssl  JS &gt; <strong><code>shell.connect(connectionData)</code></strong>
Creating a session to 'cbuser@127.0.0.1/cookbook'
Please provide the password for 'cbuser@127.0.0.1': ******
Save password for 'cbuser@127.0.0.1'? [Y]es/[N]o/Ne[v]er (default No): 
Fetching schema names for autocompletion... Press ^C to stop.
Your MySQL connection id is 1077318 (X protocol)
Server version: 8.0.27 MySQL Community Server - GPL
Default schema `cookbook` accessible through db.
&lt;Session:cbuser@127.0.0.1:33060&gt;
 MySQL  127.0.0.1:33060+ ssl  cookbook  JS &gt;</pre><p>
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820410438384"><h2>See Also</h2><p>For additional information about how to connect to MySQL Server via MySQL Shell, see <a href="https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-connections.html">MySQL Shell Connections</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.2 Selecting the Protocol"><div class="sect1" id="nch-mysqlshell-mysqlshell-protocol"><h1>2.2 Selecting the Protocol</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820410271984"><h2>Problem</h2><p>
        You don’t want to use MySQL Shell’s default, and you want to select either the X protocol or the classic protocol yourself.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820410270816"><h2>Solution</h2><p>
        To select X protocol: use one of options <code>mysqlx</code>, <code>mx</code>, <code>sqlx</code>. To select classic protocol: use one of options <code>mysql</code>, <code>mc</code> and <code>sqlc</code>.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820410269872"><h2>Discussion</h2><p>
        MySQL Shell selects protocol automatically using connection options and server response. If a port or socket option is not used, it tries to connect using a default portor socket for the X protocol. If that’s not available, it defaults to the classic protocol. If this is not a desired behavior or you simply want to control which protocol to use explicitly, you can specify it by passing options <code>mysqlx</code>, <code>mx</code>, <code>sqlx</code> when starting the <span class="command"><em>mysqlsh</em></span> client to select X protocol and options <code>mysql</code>, <code>mc</code> and <code>sqlc</code> to select classic protocol.
        </p><pre data-type="programlisting">$ <strong><code>mysqlsh --host=127.0.0.1  --user=cbuser --schema=cookbook --mysqlx</code></strong>
Please provide the password for 'cbuser@127.0.0.1': ******
MySQL Shell 8.0.22
...
Your MySQL connection id is 9143 (X protocol)

$ <strong><code>mysqlsh --host=127.0.0.1  --user=cbuser --schema=cookbook --mysql</code></strong>
Please provide the password for 'cbuser@127.0.0.1': ******
MySQL Shell 8.0.22
...
Creating a Classic session to 'cbuser@127.0.0.1/cookbook'</pre><p>
      </p><p>
        Inside MySQL Shell, when opening a new connection, specify value for the <code>scheme</code> key when passing options to the <code>connectionData</code> dictionary:
        </p><pre data-type="programlisting"> MySQL  127.0.0.1:3306 ssl  cookbook  JS &gt; <strong><code>connectionData={ </code></strong>
                                        -&gt; <strong><code>  "scheme": "mysql", "host": "127.0.0.1", </code></strong>
                                        -&gt; <strong><code>  "user": "cbuser", "schema": "cookbook" </code></strong>
                                        -&gt; <strong><code>}</code></strong>
{
    "host": "127.0.0.1", 
    "schema": "cookbook", 
    "scheme": "mysql", 
    "user": "cbuser"
}
 MySQL  127.0.0.1:3306 ssl  cookbook  JS &gt; <strong><code>shell.connect(connectionData, "cbpass")</code></strong>
Creating a Classic session to 'cbuser@127.0.0.1/cookbook'</pre><p>
      </p><p>
        In both cases, when specifying a URI, you can prefix connection options by the <code>scheme</code>:
     </p><pre data-type="programlisting" data-code-language="sh">mysqlsh mysqlx://cbuser:cbpass@127.0.0.1/cookbook</pre><pre data-type="programlisting" data-code-language="sh"><code class="se">\c</code> mysql://cbuser:cbpass@127.0.0.1/cookbook</pre><p>
        If the specified protocol could not be used MySQL Shell will fail with an error:
        </p><pre data-type="programlisting"> MySQL  JS &gt; <strong><code>\c mysql://cbuser:cbpass@127.0.0.1:33060/cookbook</code></strong>
Creating a Classic session to 'cbuser@127.0.0.1:33060/cookbook'
MySQL Error 2007 (HY000): Protocol mismatch; server version = 11, client version = 10</pre><p>
        
        </p><pre data-type="programlisting">$ <strong><code>mysqlsh --host=127.0.0.1 --port=3306 --user=cbuser --schema=cookbook --mx</code></strong>
Please provide the password for 'cbuser@127.0.0.1:3306': ******
MySQL Shell 8.0.22

Copyright (c) 2016, 2020, Oracle and/or its affiliates.
Oracle is a registered trademark of Oracle Corporation and/or its affiliates.
Other names may be trademarks of their respective owners.

Type '\help' or '\?' for help; '\quit' to exit.
Creating an X protocol session to 'cbuser@127.0.0.1:3306/cookbook' ↩
MySQL Error 2027: Requested session assumes MySQL X Protocol but '127.0.0.1:3306' ↩
seems to speak the classic MySQL protocol
(Unexpected response received from server, msg-id:10)</pre><p>
      </p><p>
        You can find details of your current MySQL Shell connection by running command <span class="command"><em>shell.status()</em></span>:
        </p><pre data-type="programlisting"> MySQL  127.0.0.1:33060+ ssl  cookbook  JS &gt; <strong><code>shell.status()</code></strong>
MySQL Shell version 8.0.22

Connection Id:                61
Default schema:               cookbook
Current schema:               cookbook
Current user:                 cbuser@localhost
SSL:                          Cipher in use: TLS_AES_256_GCM_SHA384 TLSv1.3
Using delimiter:              ;
Server version:               8.0.22-13 Percona Server (GPL), Release '13', ↩
                              Revision '6f7822f'
Protocol version:             X protocol
Client library:               8.0.22
Connection:                   127.0.0.1 via TCP/IP
TCP port:                     33060
Server characterset:          utf8mb4
Schema characterset:          utf8mb4
Client characterset:          utf8mb4
Conn. characterset:           utf8mb4
Result characterset:          utf8mb4
Compression:                  Enabled (DEFLATE_STREAM)
Uptime:                       4 min 57.0000 sec</pre><p>
      </p><div data-type="tip"><h6>Tip</h6><p>
          MySQL Shell, like MySQL CLI, allows to customize its prompt. To do it you need to edit file <code>prompt.json</code>, located in the configuration home of MySQL Shell. This is a file in JSON format. MySQL Shell comes with good number of custom templates of the prompt and the <code>README.prompt</code> file, explaining how to modify the prompt.
        </p><p>
          We will not cover in detail how to customize the MySQL Shell user prompt, but will remove the host, port, and protocol information from the default prompt, so our examples will take less space in the book.
        </p><p>
          Configuration home of the MySQL Shell is either <code> ~/.mysqlsh/</code> on Unix or <code>%AppData%\MySQL\mysqlsh\</code> on Windows. You can overwrite this location if set variable <code> MYSQLSH_USER_CONFIG_HOME</code>. <code>README.prompt</code> and examples are located in the <code>share/mysqlsh/prompt/</code> directory under MySQL Shell installation root.
        </p></div></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820410222112"><h2>See Also</h2><p>For additional information about <span class="command"><em>mysqlsh</em></span> command options, see <a href="https://dev.mysql.com/doc/mysql-shell/8.0/en/mysqlsh.html">A.1 mysqlsh — The MySQL Shell</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.3 Selecting SQL, JavaScript or Python Mode"><div class="sect1" id="nch-mysqlshell-mysqlshell-mode"><h1>2.3 Selecting SQL, JavaScript or Python Mode</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820410216720"><h2>Problem</h2><p>
        MySQL Shell starts in the wrong mode, and you want to select a different mode than the default.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820410215616"><h2>Solution</h2><p>
        Use options <code>sql</code>, <code>js</code> or <code>py</code> or switch the mode after starting <span class="command"><em>mysqlsh</em></span>.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820410200128"><h2>Discussion</h2><p>
        By default MySQL Shell starts in JavaScript mode. You can see it by looking at the prompt string:
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt;</pre><p>
      </p><p>
        You can change default mode if start the tool with the option <code>--sql</code> to select SQL mode or <code>--py</code> to select Python mode. To select JavaScript mode explicitly at startup use option <code>--js</code>. You will see that the prompt message of the MySQL Shell client will change to the selected mode. Here, we select the Python mode.
        </p><pre data-type="programlisting">$ <strong><code>mysqlsh cbuser:cbpass@127.0.0.1/cookbook --py</code></strong>
...
Default schema `cookbook` accessible through db.
 MySQL  cookbook  Py &gt;</pre><p>
      </p><div data-type="tip"><h6>Tip</h6><p>
          For SQL mode you can explicitly instruct the tool to use not only desired mode, but also a desired protocol with option <code>sqlx</code> to select X protocol and option <code>sqlc</code> to select Classic protocol. This could be handy when you connect via default TCP/IP port.
        </p></div><p>
        Inside <span class="command"><em>mysqlsh</em></span> you can change the processing mode with commands <span class="command"><em>\js</em></span>, <span class="command"><em>\py</em></span>, and <span class="command"><em>\sql</em></span> to switch to Javascript, Python, and SQL modes.
        </p><pre data-type="programlisting"> MySQL  cookbook  SQL &gt; <strong><code>\js</code></strong>
Switching to JavaScript mode...
 MySQL  cookbook  JS &gt; <strong><code>\py</code></strong>
Switching to Python mode...
 MySQL  cookbook  Py &gt; <strong><code>\sql</code></strong>
Switching to SQL mode... Commands end with ;
 MySQL  cookbook  SQL &gt;</pre><p>
      </p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.4 Running SQL Session"><div class="sect1" id="nch-mysqlshell-mysqlshell-sqlc"><h1>2.4 Running SQL Session</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820413011552"><h2>Problem</h2><p>
        You want to have functionality that’s a <span class="command"><em>mysql</em></span> client has, but you do not want to leave MySQL Shell.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820413009632"><h2>Solution</h2><p>
        Use SQL mode.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820413008720"><h2>Discussion</h2><p>
        With SQL mode MySQL Shell behaves exactly the same as the <span class="command"><em>mysql</em></span> client that we describe in <a data-type="xref" href="ch01.xhtml#nch-mysql">Chapter 1</a>. You can run queries, control output using <span class="command"><em>\pager</em></span> command, edit SQL in the system editor with <span class="command"><em>\edit</em></span> command, execute SQL from a file with <span class="command"><em>\source</em></span> command and execute a system shell commands with <span class="command"><em>\system</em></span>. You can view and edit the command line history.
      </p><p>
        There is no shortcut <code>\d</code> for the <span class="command"><em>delimiter</em></span> command, but the command itself works.
        </p><pre data-type="programlisting" data-code-language="mysql"> MySQL  cookbook  SQL &gt; <strong><code>delimiter |</code></strong>
 MySQL  cookbook  SQL &gt; <strong><code>CREATE PROCEDURE get_client_info()</code></strong>
                     -&gt; <strong><code>BEGIN</code></strong>
                     -&gt; <strong><code>SELECT GROUP_CONCAT(ATTR_NAME, '=', ATTR_VALUE) </code></strong>
                     -&gt; <strong><code>FROM performance_schema.session_account_connect_attrs </code></strong>
                     -&gt; <strong><code>WHERE ATTR_NAME IN ('_client_name', '_client_version');</code></strong>
                     -&gt; <strong><code>END</code></strong>
                     -&gt; <strong><code>|</code></strong>
Query OK, 0 rows affected (0.0163 sec)
 MySQL  cookbook  SQL &gt; <strong><code>delimiter ;</code></strong>
 MySQL  cookbook  SQL &gt; <strong><code>CALL get_client_info();</code></strong>
+----------------------------------------------+
| GROUP_CONCAT(ATTR_NAME, '=', ATTR_VALUE)     |
+----------------------------------------------+
| _client_name=libmysql,_client_version=8.0.22 |
+----------------------------------------------+
1 row in set (0.0017 sec)

Query OK, 0 rows affected (0.0017 sec)</pre><p>
      </p><p>
        There is no <span class="command"><em>tee</em></span> command. If you want to log query results into a file, set the pager to <code>tee -a &lt;DESIRED LOG FILE LOCATION&gt;</code>. However, it will not log SQL statements. They are available only in the history file.
      </p><div data-type="tip"><h6>Tip</h6><p>
          By default MySQL Shell does not save history between client sessions. This means that you cannot access your previous commands once you exit the shell. You can overwrite this behavior if enable option <code>history.autoSave</code>:
          </p><pre data-type="programlisting" data-code-language="bash"> MySQL  JS &gt; <code class="se">\o</code>ption --persist history.autoSave<code class="o">=</code><code class="m">1</code></pre><p>
        </p></div></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.5 Running SQL in JavaScript Mode"><div class="sect1" id="nch-mysqlshell-mysqlshell-sqljs"><h1>2.5 Running SQL in JavaScript Mode</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820412986880"><h2>Problem</h2><p>
        You are in JavaScript mode, but want to execute traditional SQL
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820412986000"><h2>Solution</h2><p>
        Use the command <span class="command"><em>\sql</em></span>, or use the methods <code>sql()</code> and <code>runSQL()</code> that belong to the class <code>Session</code>.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820412983088"><h2>Discussion</h2><p>
        JavaScript mode supports the object-oriented style of querying your database. Or, you can run plain SQL.
      </p><p>
        If you want to run single SQL statement and get results like you can in the MySQL client without leaving JavaScript mode use command <span class="command"><em>\sql</em></span>. In the example below we run plain SQL statement, selecting data from the table <code>limbs</code> for things that have two or more arms:
        </p><pre data-type="programlisting" data-code-language="mysql"> MySQL  cookbook  JS &gt; <strong><code>\sql SELECT * FROM limbs WHERE arms &gt;=2 ORDER BY arms;</code></strong>
Fetching table and column names from `cookbook` for auto-completion...↩
Press ^C to stop.
+--------------+------+------+
| thing        | legs | arms |
+--------------+------+------+
| human        |    2 |    2 |
| armchair     |    4 |    2 |
| Peg Leg Pete |    1 |    2 |
| squid        |    0 |   10 |
+--------------+------+------+
4 rows in set (0.0002 sec)</pre><p>
      </p><p>
        The object-oriented style of running SQL is more flexible and provides more options. To run single statement use method <span class="command"><em>runSQL</em></span> of the class <code>Session</code>.
        </p><pre data-type="programlisting" data-code-language="mysql"> MySQL  cookbook  JS &gt; <strong><code>session.runSql(
                     &gt; "SELECT * FROM limbs WHERE arms &gt;=2 ORDER BY arms")</code></strong>
+--------------+------+------+
| thing        | legs | arms |
+--------------+------+------+
| human        |    2 |    2 |
| armchair     |    4 |    2 |
| Peg Leg Pete |    1 |    2 |
| squid        |    0 |   10 |
+--------------+------+------+
4 rows in set (0.0014 sec)</pre><p>
      </p><div data-type="tip"><h6>Tip</h6><p>
          When you connect to MySQL Shell it creates a default instance of the class <code>Session</code>. It is accessible via global object <code>session</code>.
        </p></div><p>
        Method <span class="command"><em>runSQL</em></span> supports placeholders: just replace variable values with <code>?</code> sign and pass parameters as an array.
        </p><pre data-type="programlisting" data-code-language="mysql"> MySQL  cookbook  JS &gt; <strong><code>session.runSql("SELECT * FROM limbs ↩
        WHERE arms &gt;= ? AND legs != ? ↩
        ORDER BY arms", [2, 0])</code></strong>
+--------------+------+------+
| thing        | legs | arms |
+--------------+------+------+
| human        |    2 |    2 |
| armchair     |    4 |    2 |
| Peg Leg Pete |    1 |    2 |
+--------------+------+------+
3 rows in set (0.0005 sec)</pre><p>
      </p><p>
        You can combine this method with standard JavaScript syntax and create a script that can do more than just running SQL queries:
      </p><p>
      </p><pre data-type="programlisting" data-code-language="js"> MySQL  cookbook  JS &gt; <strong><code>for (i = 1; </code></strong>
                    -&gt; <strong><code>   i &lt;= session.sql("SELECT MAX(arms) AS maxarms FROM limbs").</code></strong> <a class="co" id="co_select_max_co" href="#callout_select_max_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a>
                    -&gt; <strong><code>     execute().fetchOne().</code></strong> <a class="co" id="co_fetch_one_co" href="#callout_fetch_one_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a>
                    -&gt; <strong><code>     getField('maxarms');</code></strong> <a class="co" id="co_get_field_co" href="#callout_get_field_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a>
                    -&gt; <strong><code>   i++) </code></strong> <a class="co" id="co_for_loop_co" href="#callout_for_loop_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a>
                    -&gt; <strong><code>{</code></strong>
                    -&gt;   <strong><code>species=session.sql("SELECT COUNT(*) AS countarms \</code></strong>
                    -&gt;   <strong><code>                     FROM limbs WHERE arms =?").</code></strong>
                    -&gt;   <strong><code>                     bind(i).execute();</code></strong> <a class="co" id="co_bind_co" href="#callout_bind_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a>
                    -&gt;   <strong><code>if (species.hasData() &amp;&amp; (armscount = species.fetchOne().</code></strong>
                    -&gt;   <strong><code>  getField('countarms')) &gt; 0 )</code></strong> <a class="co" id="co_result_co" href="#callout_result_co"><img src="Images/6.png" alt="6" width="12" height="12"/></a>
                    -&gt;   <strong><code>{</code></strong>
                    -&gt;     <strong><code>print("We have " + armscount + " species with " + i +</code></strong> <a class="co" id="co_print_co" href="#callout_print_co"><img src="Images/7.png" alt="7" width="12" height="12"/></a>
                    -&gt;     <strong><code>(i == 1 ? " arm\n" : " arms\n"));</code></strong>
                    -&gt;   <strong><code>}</code></strong>
                    -&gt; <strong><code>}</code></strong>
                    -&gt; 
We have 1 species with 1 arm
We have 3 species with 2 arms
We have 1 species with 10 arms</pre><p>
      
      </p><dl class="calloutlist"><dt><a class="co" id="callout_select_max_co" href="#co_select_max_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>Select maximum number of arms, stored in the <code>limbs</code> table.</p></dd><dt><a class="co" id="callout_fetch_one_co" href="#co_fetch_one_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>Method <span class="command"><em>session.sql.execute()</em></span> returns a <code>SqlResult</code> object that has a method,  called <span class="command"><em>fetchOne</em></span>, returning the first row of the result set.</p></dd><dt><a class="co" id="callout_get_field_co" href="#co_get_field_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>Since our query is supposed to return one row we did not traverse the result set,  but simply called a method <span class="command"><em>getField</em></span>  that takes a column name or its alias as a parameter, to get maxium number of arms, stored in the table <code>limbs</code>.</p></dd><dt><a class="co" id="callout_for_loop_co" href="#co_for_loop_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt><dd><p>We used this number as a stopping condition for the <span class="command"><em>for</em></span> loop.</p></dd><dt><a class="co" id="callout_bind_co" href="#co_bind_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt><dd><p>In the loop we executed queries to get number of the species with the specified  number of arms. We used method <span class="command"><em>sql</em></span> and its method <span class="command"><em>bind</em></span> to bind value of the loop iterator <code>i</code> to the query.</p></dd><dt><a class="co" id="callout_result_co" href="#co_result_co"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt><dd><p>Check if we received a result and if number of arms is greater than 0.</p></dd><dt><a class="co" id="callout_print_co" href="#co_print_co"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt><dd><p>If both conditions are true: print the result.</p></dd></dl><p>

      </p><div data-type="note" epub:type="note"><h6>Note</h6><p>
          When you execute <span class="command"><em>sql</em></span> or <span class="command"><em>runSQL</em></span> methods separately MySQL Shell calls method <span class="command"><em>execute</em></span> for them automatically. But if using these methods in more complicated code, like in the loops or multiple-statements blocks you need to call method <span class="command"><em>execute</em></span> explicitly. Otherwise only last statement will be executed and all previous invocations will be ignored.
        </p></div></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820412982784"><h2>See Also</h2><p>For additional information about MySQL Shell API, see the <a href="https://dev.mysql.com/doc/dev/mysqlsh-api-javascript/8.0/group___shell_a_p_i.html">ShellAPI in the advanced MySQL User Reference Manual</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.6 Running SQL in Python Mode"><div class="sect1" id="nch-mysqlshell-mysqlshell-sqlpy"><h1>2.6 Running SQL in Python Mode</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820412896768"><h2>Problem</h2><p>
        You are in Python mode, but want to execute traditional SQL
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820412895792"><h2>Solution</h2><p>
        Use the command <span class="command"><em>\sql</em></span>, or the methods <code>sql</code>, <code>run_sql</code> of the class <code>Session</code>.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820412892640"><h2>Discussion</h2><p>
        Just as we saw with JavaScript mode, the Python mode also supports the <span class="command"><em>\sql</em></span> command. You can use it if you want to execute a SQL statement and do not want to do anything with its result. The following code selects all rows from the table <code>movies</code>.
       </p><pre data-type="programlisting" data-code-language="mysql"> MySQL  cookbook  Py &gt; <strong><code>\sql SELECT * FROM movies;</code></strong>
+----+------+----------------------------+
| id | year | movie                      |
+----+------+----------------------------+
|  1 | 1997 | The Fifth Element          |
|  2 | 1999 | The Phantom Menace         |
|  3 | 2001 | The Fellowship of the Ring |
|  4 | 2005 | Kingdom of Heaven          |
|  5 | 2010 | Red                        |
|  6 | 2011 | Unknown                    |
+----+------+----------------------------+
6 rows in set (0.0008 sec)</pre><p>
        Method names in Python mode are slightly different from those in JavaScript mode. Thus, to run SQL statement, using <code>Session</code> object and bind parameters to it as an array use method <span class="command"><em>run_sql</em></span>.
        </p><pre data-type="programlisting" data-code-language="mysql"> MySQL  cookbook  Py &gt; <strong><code>session.run_sql("SELECT * FROM movies WHERE year &lt; ?",[2000])</code></strong>
+----+------+--------------------+
| id | year | movie              |
+----+------+--------------------+
|  1 | 1997 | The Fifth Element  |
|  2 | 1999 | The Phantom Menace |
+----+------+--------------------+
2 rows in set (0.0009 sec)</pre><p>
        
        This example selects all movies, created before 2000.
      </p><p>
        You can program in Python as well as in JavaScript. For example, if you want to know the number of movies each actor was featured in as well as years when they were starred, join table <code>movies</code> with table <code>movies_actors</code>, then print result using Python code.
        </p><pre data-type="programlisting" data-code-language="py"> MySQL  cookbook  Py &gt; <strong><code>myres=session.sql("SELECT actor, COUNT(movie) as movies,</code></strong>↩ <a class="co" id="co_query_co" href="#callout_query_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a>
                          <strong><code>  GROUP_CONCAT(year SEPARATOR ', ') AS years_string,</code></strong>↩
                          <strong><code>  COUNT(year) AS years FROM movies_actors </code></strong>↩
                          <strong><code>  GROUP BY actor ORDER BY movies DESC").</code></strong>↩
                          <strong><code>  execute().fetch_all()</code></strong>
 MySQL  cookbook  Py &gt; <strong><code>for myrow in myres:</code></strong> <a class="co" id="co_loop_co" href="#callout_loop_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a>
                    -&gt; <strong><code>print(myrow[0] + " was featured in " + str(myrow[1]) +</code></strong>↩ <a class="co" id="co_print_py_co" href="#callout_print_py_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a>
                      <strong><code>(" movies" if (myrow[1] &gt; 1) else " movie") + </code></strong>↩
                      <strong><code>" in " + ("years " if (myrow[3] &gt; 1) else "the year ") +</code></strong>↩
                      <strong><code>myrow[2] + ".")</code></strong>
                    -&gt; 
Liam Neeson was featured in 3 movies in years 2005, 1999, 2011.
Bruce Willis was featured in 2 movies in years 1997, 2010.
Ian Holm was featured in 2 movies in years 1997, 2001.
Orlando Bloom was featured in 2 movies in years 2005, 2001.
Diane Kruger was featured in 1 movie in the year 2011.
Elijah Wood was featured in 1 movie in the year 2001.
Ewan McGregor was featured in 1 movie in the year 1999.
Gary Oldman was featured in 1 movie in the year 1997.
Helen Mirren was featured in 1 movie in the year 2010.
Ian McKellen was featured in 1 movie in the year 2001.</pre><p>
        </p><dl class="calloutlist"><dt><a class="co" id="callout_query_co" href="#co_query_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>Run the query and fetch all the rows that it returns into a variable <code>myres</code>.</p></dd><dt><a class="co" id="callout_loop_co" href="#co_loop_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>Traverse this variable in a <span class="command"><em>for ... in</em></span> loop.</p></dd><dt><a class="co" id="callout_print_py_co" href="#co_print_py_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>Print result.</p></dd></dl><p>
      </p><div data-type="tip"><h6>Tip</h6><p>
          If you are not familiar with the query syntax yet, do not worry: we will discuss ways of querying data in <a data-type="xref" href="ch05.xhtml#nch-select">Chapter 5</a> and how to join two or more tables in <a data-type="xref" href="ch16.xhtml#nch-multi-multi-intro">Recipe 16.0</a>.
        </p></div></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820412860672"><h2>See Also</h2><p>For additional information about Python MySQL Shell API, use command <span class="command"><em>\? mysqlx</em></span> inside the Python shell session.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.7 Working with Tables in JavaScript Mode"><div class="sect1" id="nch-mysqlshell-mysqlshell-js-tables"><h1>2.7 Working with Tables in JavaScript Mode</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820412857872"><h2>Problem</h2><p>
        You want to query your tables using object-oriented style in JavaScript mode.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820412856816"><h2>Solution</h2><p>
        Use method <span class="command"><em>getTable</em></span> to select a table, then methods <span class="command"><em>select</em></span>, <span class="command"><em>count</em></span>, <span class="command"><em>insert</em></span>, <span class="command"><em>update</em></span>, <span class="command"><em>delete</em></span> to select, retrieve number of rows, insert, update or delete from the table.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820412855824"><h2>Discussion</h2><p>
        MySQL Shell supports object-oriented syntax for querying and modifying database objects. Thus, to select all rows from the table <code>limbs</code> we can use <span class="command"><em>select</em></span> method.
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>session.getDefaultSchema().getTable('limbs').select()</code></strong>
+--------------+------+------+
| thing        | legs | arms |
+--------------+------+------+
| human        |    2 |    2 |
| insect       |    6 |    0 |
| squid        |    0 |   10 |
| fish         |    0 |    0 |
| centipede    |   99 |    0 |
| table        |    4 |    0 |
| armchair     |    4 |    2 |
| phonograph   |    0 |    1 |
| tripod       |    3 |    0 |
| Peg Leg Pete |    1 |    2 |
| space alien  | NULL | NULL |
+--------------+------+------+
11 rows in set (0.0003 sec)</pre><p>
        In the listing above we firstly selected schema using <span class="command"><em>getDefaultSchema</em></span> method, then selected a table with method <span class="command"><em>getTable</em></span> and, finally, retrieved all rows with <span class="command"><em>select</em></span>.
      </p><p>
        Method <span class="command"><em>select</em></span> returns <code>TableSelect</code> object that supports methods allowing to specify <code>WHERE</code> condition, <code>ORDER BY</code>, <code>GROUP BY</code> clauses and other features that SQL <code>SELECT</code> has. It also supports prepared statements and parameters binding. Thus, to select only those species from the table <code>limbs</code> that have four or more legs and order them by number of legs try the following code:
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>session.getDefaultSchema().getTable('limbs').select().</code></strong>
                    -&gt; <strong><code>where('legs &gt;= :legs').orderBy('legs').bind('legs', 4)</code></strong>
+-----------+------+------+
| thing     | legs | arms |
+-----------+------+------+
| table     |    4 |    0 |
| armchair  |    4 |    2 |
| insect    |    6 |    0 |
| centipede |   99 |    0 |
+-----------+------+------+
4 rows in set (0.0004 sec)</pre><p>
      </p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>
          Notice that here we are using named parameters for placeholders instead of question marks like we did when queried database with SQL.
        </p></div><p>
        MySQL Shell API also supports methods to insert, update and delete data in the object-oriented style as well as starting and finishing transactions. Like, if we want to experiment with <code>cookbook</code> database without actually modifying data we can do it inside a transaction.
        </p><pre id="jst" data-type="programlisting" data-code-language="js"> MySQL  cookbook  JS &gt; <strong><code>limbs = session.getDefaultSchema().getTable('limbs')</code></strong> <a class="co" id="co_jst_limbs_co" href="#callout_jst_limbs_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a>
&lt;Table:limbs&gt;
 MySQL  cookbook  JS &gt; <strong><code>session.startTransaction()</code></strong> <a class="co" id="co_jst_transaction_co" href="#callout_jst_transaction_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a>
Query OK, 0 rows affected (0.0006 sec)
 MySQL  cookbook  JS &gt; <strong><code>limbs.insert('thing', 'legs', 'arms').</code></strong> <a class="co" id="co_jst_insert_co" href="#callout_jst_insert_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a>
                    -&gt; <strong><code>values('cat', 4, 0).</code></strong>
                    -&gt; <strong><code>values('dog', 2, 2)</code></strong>
                    -&gt; 
Query OK, 2 items affected (0.0012 sec)

Records: 2  Duplicates: 0  Warnings: 0
 MySQL  cookbook  JS &gt; <strong><code>limbs.count()</code></strong> <a class="co" id="co_jst_count_co" href="#callout_jst_count_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a>
13
 MySQL  cookbook  JS &gt; <strong><code>limbs.update().set('legs', 4).set('arms', 0).</code></strong>
                    -&gt; <strong><code>where("thing='dog'")</code></strong> <a class="co" id="co_jst_update_co" href="#callout_jst_update_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a>
Query OK, 1 item affected (0.0012 sec)

Rows matched: 1  Changed: 1  Warnings: 0
 MySQL  cookbook  JS &gt; <strong><code>limbs.select().where("thing='dog'")</code></strong> <a class="co" id="co_jst_select_co" href="#callout_jst_select_co"><img src="Images/6.png" alt="6" width="12" height="12"/></a>
+-------+------+------+
| thing | legs | arms |
+-------+------+------+
| dog   |    4 |    0 |
+-------+------+------+
1 row in set (0.0004 sec)
 MySQL  cookbook  JS &gt; <strong><code>limbs.delete().where("thing='cat'")</code></strong> <a class="co" id="co_jst_delete_co" href="#callout_jst_delete_co"><img src="Images/7.png" alt="7" width="12" height="12"/></a>
Query OK, 1 item affected (0.0010 sec)
 MySQL  cookbook  JS &gt; <strong><code>limbs.count()</code></strong> <a class="co" id="co_jst_count2_co" href="#callout_jst_count2_co"><img src="Images/8.png" alt="8" width="12" height="12"/></a>
12
 MySQL  cookbook  JS &gt; <strong><code>session.rollback()</code></strong> <a class="co" id="co_jst_rollback_co" href="#callout_jst_rollback_co"><img src="Images/9.png" alt="9" width="12" height="12"/></a>
Query OK, 0 rows affected (0.0054 sec)
 MySQL  cookbook  JS &gt; <strong><code>limbs.count()</code></strong> <a class="co" id="co_jst_confirm_co" href="#callout_jst_confirm_co"><img src="Images/10.png" alt="10" width="12" height="12"/></a>
11
 MySQL  cookbook  JS &gt; <strong><code>limbs.select().where("thing='dog' or thing='cat'")</code></strong>
Empty set (0.0010 sec)</pre><p>
        
       </p><dl class="calloutlist"><dt><a class="co" id="callout_jst_limbs_co" href="#co_jst_limbs_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>Save the table object for the table <code>limbs</code> into a variable <code>limbs</code>.</p></dd><dt><a class="co" id="callout_jst_transaction_co" href="#co_jst_transaction_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>Start a transaction, so we can rollback our experiments.</p></dd><dt><a class="co" id="callout_jst_insert_co" href="#co_jst_insert_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>Insert two rows into table <code>limbs</code> using method <span class="command"><em>insert</em></span> that takes list of columns as a parameter and method <span class="command"><em>values</em></span> that takes list of values to be inserted as a parameter.</p></dd><dt><a class="co" id="callout_jst_count_co" href="#co_jst_count_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt><dd><p>Check the number of rows that now exist in the table.</p></dd><dt><a class="co" id="callout_jst_update_co" href="#co_jst_update_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt><dd><p>If look back to the rows that we inserted you may notice an error. A dog actually has four legs and not two legs and two arms. To fix this mistake call method <span class="command"><em>update</em></span>.</p></dd><dt><a class="co" id="callout_jst_select_co" href="#co_jst_select_co"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt><dd><p>Following <span class="command"><em>select</em></span> call confirmed that our changes were applied to the table <code>limbs</code>.</p></dd><dt><a class="co" id="callout_jst_delete_co" href="#co_jst_delete_co"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt><dd><p>Then we figured out that cats and dogs are not always friends with each other and removed a cat from the table with method <span class="command"><em>delete</em></span>.</p></dd><dt><a class="co" id="callout_jst_count2_co" href="#co_jst_count2_co"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt><dd><p>Confirm that the cat was successfully removed.</p></dd><dt><a class="co" id="callout_jst_rollback_co" href="#co_jst_rollback_co"><img src="Images/9.png" alt="9" width="12" height="12"/></a></dt><dd><p>Roll back the transaction to restore the table to its initial state.</p></dd><dt><a class="co" id="callout_jst_confirm_co" href="#co_jst_confirm_co"><img src="Images/10.png" alt="10" width="12" height="12"/></a></dt><dd><p>Methods <span class="command"><em>count</em></span> and <span class="command"><em>select</em></span> confirm that the table is in its initial state.</p></dd></dl><p>

      </p><div data-type="note" epub:type="note"><h6>Note</h6><p>
          Since we executed all statements one-by-one in the interactive session we ommitted method <span class="command"><em>execute</em></span>. This method required if you are executing SQL commands in loops or program scripts. 
        </p></div></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820412776544"><h2>See Also</h2><p>For additional information about how to work with tables in JavaScript mode, see <a href="https://dev.mysql.com/doc/dev/mysqlsh-api-javascript/8.0/classmysqlsh_1_1mysqlx_1_1_table.html">User Reference Manual for the object <code>Table</code></a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.8 Working with Tables in Python Mode"><div class="sect1" id="nch-mysqlshell-mysqlshell-python-tables"><h1>2.8 Working with Tables in Python Mode</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820412773504"><h2>Problem</h2><p>
        You have tables in your database and want to work with them in Python mode.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820412772416"><h2>Solution</h2><p>
        Use the method <span class="command"><em>get_table</em></span> to get the Table object, then the methods <span class="command"><em>select</em></span>, <span class="command"><em>count</em></span>, <span class="command"><em>insert</em></span>, <span class="command"><em>update</em></span>, <span class="command"><em>delete</em></span> to select, retrieve number of rows, insert, update or delete from the table.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820412771424"><h2>Discussion</h2><p>
        Like JavaScript, Python supports working with tables in object-oriented style. Thus, to select all rows from the table <code>movies</code> try method <span class="command"><em>select</em></span> of the class <code>Table</code>:
        </p><pre data-type="programlisting" data-code-language="py"> MySQL  cookbook  Py &gt; <strong><code>session.get_schema('cookbook').get_table('movies').select()</code></strong> 
+----+------+----------------------------+
| id | year | movie                      |
+----+------+----------------------------+
|  1 | 1997 | The Fifth Element          |
|  2 | 1999 | The Phantom Menace         |
|  3 | 2001 | The Fellowship of the Ring |
|  4 | 2005 | Kingdom of Heaven          |
|  5 | 2010 | Red                        |
|  6 | 2011 | Unknown                    |
+----+------+----------------------------+
6 rows in set (0.0003 sec)</pre><p>
        In this example we used the method <span class="command"><em>get_schema</em></span> that allows us to select any schema stored in the database to which the session user has been granted access.
      </p><p>
        Python mode supports methods, allowing to modify data in the tables as well as transaction statements.
      </p><p>
        For our examples we will save tables <code>movies</code> and <code>movies_actors</code> into the variables first:
        </p><pre data-type="programlisting" data-code-language="py"> MySQL  cookbook  Py &gt; <strong><code>movies=session.get_schema('cookbook').get_table('movies')</code></strong>
 MySQL  cookbook  Py &gt; <strong><code>movies_actors=session.get_schema('cookbook').</code></strong>↩
                          <strong><code>get_table('movies_actors')</code></strong></pre><p>
      </p><p>
        Then, we will open a transaction, so our changes will appy either to both tables or to none at all, and we will insert a movie <em>“Darkest Hour”</em> starring Gary Oldman. Finally, we will commit the transaction:
        </p><pre data-type="programlisting" data-code-language="py"> MySQL  cookbook  Py &gt; <strong><code>session.start_transaction()</code></strong>
Query OK, 0 rows affected (0.0003 sec)
 MySQL  cookbook  Py &gt; <strong><code>movies.insert('year', 'movie').</code></strong>↩
                          <strong><code>values(2017, 'Darkest Hour')</code></strong>
Query OK, 1 item affected (0.0013 sec)
 MySQL  cookbook  Py &gt; <strong><code>movies_actors.insert().</code></strong>↩
                          <strong><code>values(1997, 'Darkest Hour', 'Gary Oldman')</code></strong>
Query OK, 1 item affected (0.0011 sec)
 MySQL  cookbook  Py &gt; <strong><code>session.commit()</code></strong>
Query OK, 0 rows affected (0.0075 sec)</pre><p>
      </p><p>
        To find all movies, starring Gary Oldman, we will use SQL query, because X API does not support joins:
        </p><pre data-type="programlisting" data-code-language="py"> MySQL  cookbook  Py &gt; <strong><code>session.sql("SELECT * FROM movies </code></strong>↩
                          <strong><code>JOIN movies_actors USING(movie) WHERE actor = 'Gary Oldman'")</code></strong>
+-------------------+----+------+------+-------------+
| movie             | id | year | year | actor       |
+-------------------+----+------+------+-------------+
| The Fifth Element |  1 | 1997 | 1997 | Gary Oldman |
| Darkest Hour      |  7 | 2017 | 1997 | Gary Oldman |
+-------------------+----+------+------+-------------+
2 rows in set (0.0012 sec)</pre><p>
      </p><p>
        Oops! The year for the movie <em>“Darkest Hour”</em> is not correct in one of tables. Let’s update it:
        </p><pre id="pyt" data-type="programlisting" data-code-language="py"> MySQL  cookbook  Py &gt; <strong><code>session.start_transaction()</code></strong> <a class="co" id="co_pyt_begin_co" href="#callout_pyt_begin_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a>
Query OK, 0 rows affected (0.0007 sec)
 MySQL  cookbook  Py &gt; <strong><code>movies.update().set('year', 2017).where("movie='Darkest Hour'") </code></strong><a class="co" id="co_pyt_update_movies_co" href="#callout_pyt_update_movies_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a>
Query OK, 0 items affected (0.0013 sec)

Rows matched: 1  Changed: 0  Warnings: 0
 MySQL  cookbook  Py &gt; <strong><code>movies_actors.update().set('year', 2017).</code></strong>↩ <a class="co" id="co_pyt_update_movies_actors_co" href="#callout_pyt_update_movies_actors_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a>
 <strong><code>where("movie='Darkest Hour'")</code></strong>
Query OK, 1 item affected (0.0012 sec)

Rows matched: 1  Changed: 1  Warnings: 0
 MySQL  cookbook  Py &gt; <strong><code>session.commit()</code></strong> <a class="co" id="co_pyt_commit_co" href="#callout_pyt_commit_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a>
Query OK, 0 rows affected (0.0073 sec)
 MySQL  cookbook  Py &gt; <strong><code>session.run_sql("SELECT * FROM movies JOIN movies_actors</code></strong>↩ <a class="co" id="co_pyt_confirm_co" href="#callout_pyt_confirm_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a>
                          <strong><code> USING(movie) WHERE actor = 'Gary Oldman'")</code></strong>
+-------------------+----+------+------+-------------+
| movie             | id | year | year | actor       |
+-------------------+----+------+------+-------------+
| The Fifth Element |  1 | 1997 | 1997 | Gary Oldman |
| Darkest Hour      |  7 | 2017 | 2017 | Gary Oldman |
+-------------------+----+------+------+-------------+
2 rows in set (0.0005 sec)</pre><p>
        
</p><dl class="calloutlist"><dt><a class="co" id="callout_pyt_begin_co" href="#co_pyt_begin_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>Start a transaction, so we update either all tables, or no tables.</p></dd><dt><a class="co" id="callout_pyt_update_movies_co" href="#co_pyt_update_movies_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>Update table <code>movies</code>.</p></dd><dt><a class="co" id="callout_pyt_update_movies_actors_co" href="#co_pyt_update_movies_actors_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>Update table <code>movies_actors</code>.</p></dd><dt><a class="co" id="callout_pyt_commit_co" href="#co_pyt_commit_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt><dd><p>Commit the changes.</p></dd><dt><a class="co" id="callout_pyt_confirm_co" href="#co_pyt_confirm_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt><dd><p>Confirm that the changes were applied to the table.</p></dd></dl><p>

      </p><p>
        If we want to remove our newly inserted movie we can use method <span class="command"><em>delete</em></span>:
        </p><pre data-type="programlisting" data-code-language="py"> MySQL  cookbook  Py &gt; <strong><code>session.start_transaction()</code></strong>
Query OK, 0 rows affected (0.0006 sec)
 MySQL  cookbook  Py &gt; <strong><code>movies.delete().where("movie='Darkest Hour'")</code></strong>
Query OK, 1 item affected (0.0012 sec)
 MySQL  cookbook  Py &gt; <strong><code>movies_actors.delete().where("movie='Darkest Hour'")</code></strong>
Query OK, 1 item affected (0.0004 sec)
 MySQL  cookbook  Py &gt; <strong><code>session.commit()</code></strong>
Query OK, 0 rows affected (0.0061 sec)</pre><p>
        In this example we also started transaction first, then called method <span class="command"><em>delete</em></span> on two tables and, finally, committed the transaction.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820412765792"><h2>See Also</h2><p>For additional information about accessing tables in object-oriented style while in Python mode, see interactive help of the MySQL Shell that could be invoked by a command <span class="command"><em>\?</em></span>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.9 Working with Collections in JavaScript Mode"><div class="sect1" id="nch-mysqlshell-mysqlshell-js-collections"><h1>2.9 Working with Collections in JavaScript Mode</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820412711216"><h2>Problem</h2><p>
        You have semi-structured data and want to use MySQL as a Document Store. You also want to query your data with NoSQL, without leaving programming style of your preferred language.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820412710240"><h2>Solution</h2><p>
        Use <code>Collection</code> object and its methods.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820412708848"><h2>Discussion</h2><p>
        MySQL supports not only SQL syntax, but also NoSQL. When you use SQL you query tables and when you use NoSQL you query collections. Physically such collections are stored in tables that have three columns: generated unique identifier that is also a primary key, a <code>JSON</code> column that stores the document and an internal column that stores JSON schema. You can create a collection by using the method <span class="command"><em>createCollection</em></span> of the class <code>Schema</code>:
      </p><pre data-type="programlisting" data-code-language="js"> MySQL  cookbook  JS &gt; <strong><code>collectionLimbs=session.getCurrentSchema().</code></strong>
                    -&gt; <strong><code>  createCollection('CollectionLimbs')</code></strong>
&lt;Collection:CollectionLimbs&gt;</pre><p>
        The code above creates NoSQL collection <code>CollectionLimbs</code>.
      </p><p>
        Collections support schema validation. There is no method to add a schema validation for the existent collection, but we can add schema when creating the collection:
        </p><pre data-type="programlisting" data-code-language="js"> MySQL  cookbook  JS &gt; <strong><code>session.getCurrentSchema().</code></strong>
                    -&gt; <strong><code>dropCollection('collectionLimbs')</code></strong>
                    -&gt; 
 MySQL  cookbook  JS &gt; <strong><code>schema={</code></strong>
                    -&gt;   <strong><code>"$schema": "http://json-schema.org/draft-07/schema",</code></strong>
                    -&gt;   <strong><code>"id": "http://example.com/cookbook.json",</code></strong>
                    -&gt;   <strong><code>"type": "object",</code></strong>
                    -&gt;   <strong><code>"description": "Table limbs as a collection",</code></strong>
                    -&gt;   <strong><code>"properties": {</code></strong>
                    -&gt;       <strong><code>"thing": {"type": "string"},</code></strong>
                    -&gt;       <strong><code>"legs": {</code></strong>
                    -&gt;           <strong><code>"anyOf": [{"type": "number"},{"type": "null"}],</code></strong>
                    -&gt;           <strong><code>"default": 0</code></strong>
                    -&gt;       <strong><code>},</code></strong>
                    -&gt;       <strong><code>"arms": {</code></strong>
                    -&gt;           <strong><code>"anyOf": [{"type": "number"},{"type": "null"}],</code></strong>
                    -&gt;           <strong><code>"default": 0</code></strong>
                    -&gt;       <strong><code>}</code></strong>
                    -&gt;   <strong><code>},</code></strong>
                    -&gt;   <strong><code>"required": ["thing","legs","arms"]</code></strong>
                    -&gt; <strong><code>}</code></strong>
                    -&gt; 
{
    "$schema": "http://json-schema.org/draft-07/schema", 
    "description": "Table limbs as a collection", 
    "id": "http://example.com/cookbook.json", 
    "properties": {
        "arms": {
            "anyOf": [
                {
                    "type": "number"
                }, 
                {
                    "type": "null"
                }
            ], 
            "default": 0
        }, 
        "legs": {
            "anyOf": [
                {
                    "type": "number"
                }, 
                {
                    "type": "null"
                }
            ], 
            "default": 0
        }, 
        "thing": {
            "type": "string"
        }
    }, 
    "required": [
        "thing", 
        "legs", 
        "arms"
    ], 
    "type": "object"
}
 MySQL  cookbook  JS &gt; <strong><code>collectionLimbs=session.getCurrentSchema().</code></strong>
                    -&gt; <strong><code>createCollection('collectionLimbs',</code></strong>
                    -&gt; <strong><code>{"validation": {"level": "strict", "schema": schema}})</code></strong>
                    -&gt; 
&lt;Collection:CollectionLimbs&gt;</pre><p>
      </p><p>
        Once NoSQL collection is created you can insert, update, delete and search documents.
      </p><p>
        For example, to insert documents from the table <code>limbs</code> into collection <code>CollectionLimbs</code> we can use the following code:
        </p><pre id="jsc" data-type="programlisting" data-code-language="js"> MySQL  cookbook  JS &gt; <strong><code>{</code></strong>
                    -&gt;   <strong><code>limbs=session.getCurrentSchema().</code></strong>
                    -&gt;     <strong><code>getTable('limbs').select().execute();</code></strong> <a class="co" id="co_jsc_select_co" href="#callout_jsc_select_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a>
                    -&gt;   <strong><code>while (limb = limbs.fetchOneObject()) {</code></strong> <a class="co" id="co_jsc_fetch_co" href="#callout_jsc_fetch_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a>
                    -&gt;     <strong><code>collectionLimbs.add(</code></strong> <a class="co" id="co_jsc_add_co" href="#callout_jsc_add_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a>
                    -&gt;       <strong><code>mysqlx.expr(JSON.stringify(limb))</code></strong> <a class="co" id="co_jsc_convert_co" href="#callout_jsc_convert_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a>
                    -&gt;       <strong><code>).execute();</code></strong> <a class="co" id="co_jsc_execute_co" href="#callout_jsc_execute_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a>
                    -&gt;   <strong><code>}</code></strong>
                    -&gt; <strong><code>}</code></strong>
                    -&gt; 
Query OK, 1 item affected (0.0049 sec)</pre><p>
        </p><dl class="calloutlist"><dt><a class="co" id="callout_jsc_select_co" href="#co_jsc_select_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>Select all rows from the table <code>limbs</code>.</p></dd><dt><a class="co" id="callout_jsc_fetch_co" href="#co_jsc_fetch_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>Method <span class="command"><em>fetchOneObject</em></span> returns a dictionary object.</p></dd><dt><a class="co" id="callout_jsc_convert_co" href="#co_jsc_convert_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>A dictionary object cannot be saved in the collection without converting it to the proper JSON object. Therefore we converted it into JSON string first, then created an expression out of this string that could be inserted into the collection.</p></dd><dt><a class="co" id="callout_jsc_add_co" href="#co_jsc_add_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt><dd><p>Method <span class="command"><em>add</em></span> inserts a document into the collection.</p></dd><dt><a class="co" id="callout_jsc_execute_co" href="#co_jsc_execute_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt><dd><p>Method <span class="command"><em>execute</em></span> is required all the time when we update a database inside script blocks.</p></dd></dl><p>
        We enclosed the code into curly braces, because otherwise, if code put on the multiple lines, MySQL Shell will output result of <span class="command"><em>session.getCurrentSchema().getTable('limbs').select().execute()</em></span> and variable <code>limbs</code> will contain only diagnostic message about the number of rows affected. 
      </p><p>
        Finally, we can examine data, just inserted into the collection <code>CollectionLimbs</code>:
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>collectionLimbs.count()</code></strong>
11
 MySQL  cookbook  JS &gt; <strong><code>collectionLimbs.find().limit(3)</code></strong>
{
    "_id": "00006002f0650000000000000060",
    "arms": 2,
    "legs": 2,
    "thing": "human"
}
{
    "_id": "00006002f0650000000000000061",
    "arms": 0,
    "legs": 6,
    "thing": "insect"
}
{
    "_id": "00006002f0650000000000000062",
    "arms": 10,
    "legs": 0,
    "thing": "squid"
}
3 documents in set (0.0010 sec)</pre><p>
      </p><p>
        You can also modify and remove documents from your collections. We will show examples on how to do it in <a data-type="xref" href="#nch-mysqlshell-mysqlshell-python-collections">Recipe 2.10</a>
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820412708544"><h2>See Also</h2><p>For additional information about how to use MySQL with JSON documents and NoSQL, see <a data-type="xref" href="ch19.xhtml#nch-json">Chapter 19</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.10 Working with Collections in Python Mode"><div class="sect1" id="nch-mysqlshell-mysqlshell-python-collections"><h1>2.10 Working with Collections in Python Mode</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820412647264"><h2>Problem</h2><p>
        You want to use DocumentStore and NoSQL in Python mode.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820412646288"><h2>Solution</h2><p>
        Use <code>Collection</code> object and its methods.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820412644848"><h2>Discussion</h2><p>
        Just as you can do in the JavaScript mode, you can also work with NoSQL in Python mode. Syntax is also similar to JavaScript mode. However, method names follow naming style, recommended for the programs, written in Python.
      </p><p>
        Thus, to assign a collection to a variable use method <span class="command"><em>get_collection</em></span> of the class <code>Schema</code>:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>collectionLimbs=session.get_current_schema().</code></strong>↩
                          <strong><code>get_collection('collectionLimbs')</code></strong></pre><p>
      </p><p>
        To select documents use method <span class="command"><em>find</em></span>:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>collectionLimbs.find('legs &gt; 3 and arms &gt; 1')</code></strong>
{
    "_id": "00006002f0650000000000000066",
    "arms": 2,
    "legs": 4,
    "thing": "armchair"
}
1 document in set (0.0010 sec)</pre><p>
      </p><p>
        Method <span class="command"><em>find</em></span> supports arguments, allowing to search for specific documents, similarly to the syntax of the clause <code>WHERE</code> in SQL. It also allows to aggregate results, sort them and select specific fields. It does not support joining of the collections.
      </p><p>
        To insert a new document use method <span class="command"><em>add</em></span>:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>collectionLimbs.add(mysqlx.expr(</code></strong>↩
                          <strong><code>'{"thing": "cat", "legs": 2, "arms": 2}'))</code></strong>
Query OK, 1 item affected (0.0093 sec)
 MySQL  cookbook  Py &gt; <strong><code>collectionLimbs.find('thing="cat"')</code></strong>
{
    "_id": "00006002f065000000000000006b",
    "arms": 2,
    "legs": 2,
    "thing": "cat"
}
1 document in set (0.0012 sec)
 MySQL  cookbook  Py &gt; <strong><code>collectionLimbs.add(mysqlx.expr(</code></strong>↩
                          <strong><code>'{"thing": "dog", "legs": 2, "arms": 2}'))</code></strong>
Query OK, 1 item affected (0.0086 sec)</pre><p>
      </p><p>
        To modify existing row use either method <span class="command"><em>add_or_replace_one</em></span> or <span class="command"><em>modify</em></span>:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>collectionLimbs.add_or_replace_one(</code></strong>↩
                         <strong><code>'00006002f065000000000000006b',</code></strong>↩
                         <strong><code>{"thing": "cat", "legs": 4, "arms": 0})</code></strong>
Query OK, 2 items affected (0.0056 sec)</pre><p>
        Method <span class="command"><em>add_or_replace_one</em></span> takes document <code>_id</code> as the first parameter and a JSON document as the second one. If a document with specified <code>_id</code> is not found, it inserts new document. If found: replaces existing one.
      </p><p>
        Method <span class="command"><em>modify</em></span> takes a search condition as an argument and returns an object of the class <code>CollectionModify</code> that supports methods, allowing to modify parameters such as <span class="command"><em>set</em></span>. You can chain calls to method <code>set</code> as many times as needed:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>collectionLimbs.modify('thing = "dog"').set("legs", 4).set("arms", 0)</code></strong> 
Query OK, 1 item affected (0.0077 sec)

Rows matched: 1  Changed: 1  Warnings: 0</pre><p>
      </p><p>
        To check if we successfully changed quantity of arms and legs for the newly inserted documents <code>cat</code> and <code>dog</code> we can use method <span class="command"><em>find</em></span>:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>collectionLimbs.find('thing in ("dog", "cat")')</code></strong>
{
    "_id": "00006002f065000000000000006b",
    "arms": 0,
    "legs": 4,
    "thing": "cat"
}
{
    "_id": "00006002f065000000000000006c",
    "arms": 0,
    "legs": 4,
    "thing": "dog"
}
2 documents in set (0.0013 sec)</pre><p>
      </p><p>
        Method <span class="command"><em>remove</em></span> deletes documents from the collection:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>collectionLimbs.remove('thing in ("dog", "cat")')</code></strong>
Query OK, 2 items affected (0.0119 sec)
 MySQL  cookbook  Py &gt; <strong><code>collectionLimbs.find('thing in ("dog", "cat")')</code></strong>
Empty set (0.0011 sec)
 MySQL  cookbook  Py &gt; <strong><code>collectionLimbs.count()</code></strong>
11</pre><p>
        Method <span class="command"><em>remove</em></span> supports searching condition similarly to the <span class="command"><em>modify</em></span> and <span class="command"><em>find</em></span> methods.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820412644384"><h2>See Also</h2><p>For additional information about using MySQL with JSON documents and NoSQL, see <a data-type="xref" href="ch19.xhtml#nch-json">Chapter 19</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.11 Controlling the Output Format"><div class="sect1" id="nch-mysqlshell-mysqlshell-output"><h1>2.11 Controlling the Output Format</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820412606272"><h2>Problem</h2><p>
        You want to print results in a format, different from the default.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820412605296"><h2>Solution</h2><p>
        Use the configuration option <code>resultFormat</code>, or the command-line parameters <code>--result-format</code>, <code>--table</code>, <code>--tabbed</code>, <code>--vertical</code>, or <code>--json</code>.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820412604304"><h2>Discussion</h2><p>
        By default MySQL Shell prints result in a table format, similar to the default one of the <span class="command"><em>mysql</em></span> client. However, this format could be customized.
      </p><p>
        Inside MySQL Shell you can do it with help of the command <span class="command"><em>\option</em></span> or the method <span class="command"><em>set</em></span> of the <code>shell.options</code> member of the class <code>Shell</code>.
      </p><p>
        Thus, to print content of the table <code>artist</code> in tabbed format run:
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>\option resultFormat=tabbed</code></strong>
 MySQL  cookbook  JS &gt; <strong><code>artist=session.getCurrentSchema().getTable('artist')</code></strong>
&lt;Table:artist&gt;
 MySQL  cookbook  JS &gt; <strong><code>artist.select()</code></strong>
a_id	name
1	Da Vinci
2	Monet
4	Renoir
3	Van Gogh
4 rows in set (0.0009 sec)</pre><p>
      </p><p>
        To switch to the vertical format run:
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>shell.options.set('resultFormat', 'vertical')</code></strong>
 MySQL  cookbook  JS &gt; <strong><code>artist.select()</code></strong>
*************************** 1. row ***************************
a_id: 1
name: Da Vinci
*************************** 2. row ***************************
a_id: 2
name: Monet
*************************** 3. row ***************************
a_id: 4
name: Renoir
*************************** 4. row ***************************
a_id: 3
name: Van Gogh
4 rows in set (0.0009 sec)</pre><p>
      </p><p>
        JSON format supports few options. By default, if the value of the option <code>resultFormat</code> is set to <code>json</code> or MySQL Shell started with option <code>--json</code> it is same as <code>json/pretty</code> or <code>--json=pretty</code> that means that the result printed as a JSON, formatted for better readability:
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>shell.options.set('resultFormat', 'json')</code></strong>
 MySQL  cookbook  JS &gt; <strong><code>artist.select()</code></strong>
{
    "a_id": 1,
    "name": "Da Vinci"
}
{
    "a_id": 2,
    "name": "Monet"
}
{
    "a_id": 4,
    "name": "Renoir"
}
{
    "a_id": 3,
    "name": "Van Gogh"
}
4 rows in set (0.0008 sec)</pre><p>
      </p><p>
        Options <code>ndjson</code>, <code>json/raw</code> or <code>--json=raw</code> produce more compact raw JSON output.
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>shell.options.set('resultFormat', 'json/raw')</code></strong>
 MySQL  cookbook  JS &gt; <strong><code>artist.select()</code></strong>
{"a_id":1,"name":"Da Vinci"}
{"a_id":2,"name":"Monet"}
{"a_id":4,"name":"Renoir"}
{"a_id":3,"name":"Van Gogh"}
4 rows in set (0.0003 sec)</pre><p>
      </p><p>
        Option <code>json/array</code> represents result as an array of JSON documents.
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>shell.options.set('resultFormat', 'json/array')</code></strong>
 MySQL  cookbook  JS &gt; <strong><code>artist.select()</code></strong>
[
{"a_id":1,"name":"Da Vinci"},
{"a_id":2,"name":"Monet"},
{"a_id":4,"name":"Renoir"},
{"a_id":3,"name":"Van Gogh"}
]
4 rows in set (0.0010 sec)</pre><p>
      </p><p>
        That could be especially useful if selecting the data from the command line and later passing it to another program.
        </p><pre data-type="programlisting">$ <strong><code>mysqlsh cbuser:cbpass@127.0.0.1:33060/cookbook \</code></strong>
&gt; <strong><code>-i --execute="session.getSchema('cookbook').\</code></strong>
&gt; <strong><code>getTable('artist').select().execute()" \</code></strong>
&gt; <strong><code>--result-format=json/array --quiet-start=2 \</code></strong>
&gt; <strong><code>| head -n -1 \</code></strong>
&gt; <strong><code>| jq '.[] | .name'</code></strong>
"Da Vinci"
"Monet"
"Renoir"
"Van Gogh"</pre><p>
        In the code above we started <span class="command"><em>mysqlsh</em></span> with the option <code>-i</code> that enables interative mode, so MySQL Shell behaves like if it was run interactively and option <code>--quiet-start=2</code> that disables all welcome messages. Then we set option <code>--result-format</code> to <code>json/array</code> to enable JSON array output, used option <code>--execute</code> to select from the table <code>artist</code> and passed output to the <span class="command"><em>jq</em></span> command that removed all metadata information and printed only names of artists.
      </p><div data-type="tip"><h6>Tip</h6><p>
          Command <span class="command"><em>head -n -1</em></span> removes last line from the result that shows number of rows, returned by the method <span class="command"><em>select</em></span>. Note that specifying negative number as a command <span class="command"><em>head -n</em></span> parameter may not work everywhere. If you or on such a system you can ignore error message that the command <span class="command"><em>jq</em></span> will print or redirect it somewhere else:
          </p><pre data-type="programlisting" data-code-language="bash">$ <strong><code>mysqlsh cbuser:cbpass@127.0.0.1:33060/cookbook \</code></strong>
&gt; <strong><code>-i --execute="session.getSchema('cookbook').\</code></strong>
&gt; <strong><code>getTable('artist').select().execute()" \</code></strong>
&gt; <strong><code>--result-format=json/array --quiet-start=2 \</code></strong>
&gt; <strong><code>| jq '.[] | .name' 2&gt;/dev/null</code></strong>
"Da Vinci"
"Monet"
"Renoir"
"Van Gogh"</pre><p>
        </p></div><p>
        When JSON wrapping is enabled at the MySQL Shell startup with option <code>--json[=pretty|raw]</code> it will also print diagnostic information in the resulting JSON output.
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>session.getCurrentSchema().getTable('artist').select()</code></strong>
{
    "hasData": true,
    "rows": [
        {
            "a_id": 1,
            "name": "Da Vinci"
        },
        {
            "a_id": 2,
            "name": "Monet"
        },
        {
            "a_id": 4,
            "name": "Renoir"
        },
        {
            "a_id": 3,
            "name": "Van Gogh"
        }
    ],
    "executionTime": "0.0007 sec",
    "affectedRowCount": 0,
    "affectedItemsCount": 0,
    "warningCount": 0,
    "warningsCount": 0,
    "warnings": [],
    "info": "",
    "autoIncrementValue": 0
}</pre><p>
        If you enabled JSON output using command-line option <code>--result-format=json[/pretty|/raw|/array]</code> this additional information is not printed.
      </p><p>
        All output formats are independent from how you select data and available in all modes.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820412601120"><h2>See Also</h2><p>For additional information about MySQL Shell output formats, see <a href="https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-output-formats.html">MySQL User Reference Manual</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.12 Running Reports with MySQL Shell"><div class="sect1" id="idm45820412556256"><h1>2.12 Running Reports with MySQL Shell</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820412555584"><h2>Problem</h2><p>
        You want to run periodic reports.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820412554544"><h2>Solution</h2><p>
        Use the commands <span class="command"><em>\show</em></span> and <span class="command"><em>\watch</em></span>.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820412551760"><h2>Discussion</h2><p>
        MySQL Shell commands <span class="command"><em>\show</em></span> and <span class="command"><em>\watch</em></span> execute reports, both built-in and user-defined. <span class="command"><em>\show</em></span> executes a report once while <span class="command"><em>\watch</em></span> runs the report continiously, until interrupted.
      </p><p>
        Report is a pre-defined sequence of commands. Reports may support arguments. For example, the built-in report <code>query</code> takes SQL query as an argument. Built-in report <code>thread</code> reports details about a specific thread. By default it reports details about the current thead.
        </p><pre data-type="programlisting"> MySQL  cookbook  SQL &gt; <strong><code>\show thread</code></strong>
GENERAL
Thread ID:                1434
Connection ID:            1382
Thread type:              FOREGROUND
Program name:             mysqlsh
User:                     sveta
Host:                     localhost
Database:                 cookbook
Command:                  Query
Time:                     00:00:00
State:                    executing
Transaction state:        NULL
Prepared statements:      0
Bytes received:           20280
Bytes sent:               40227
Info:                     SELECT json_object('tid',t.THR ... ↩
                          JOIN information_schema.innodb
Previous statement:       NULL</pre><p>
      </p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>
          Built-in report <code>thread</code> queries tables in <code>performance_schema</code> and <code>sys</code>, therefore you should connect as a user that has <code>SELECT</code> privilege on <code>performance_schema</code> and <code>sys</code> schemas and <code>EXECUTE</code> privilege on <code>sys</code> schema. Otherwise the report will fail with an <q>Access denied</q> error.
        </p></div><p>
        But report <code>thread</code> supports arguments, so you can specify, for example, <code>Connection ID</code> of the thread and output information about the specific one.
        </p><pre data-type="programlisting"> MySQL  cookbook  SQL &gt; <strong><code>\show thread -c 1386</code></strong>
GENERAL
Thread ID:                1438
Connection ID:            1386
Thread type:              FOREGROUND
Program name:             mysql
User:                     sveta
Host:                     localhost
Database:                 cookbook
Command:                  Sleep
Time:                     00:05:44
State:                    NULL
Transaction state:        RUNNING
Prepared statements:      0
Bytes received:           1720
Bytes sent:               29733
Info:                     NULL
Previous statement:       select * from adcount for update</pre><p>
      </p><p>
        The output of the <code>thread</code> report is similar to the stdandard <code>PROCESSLIST</code> output, but contains additional information, such as <code>Transaction state</code> and <code>Previous statement</code>. The latter could be especially useful when you are figuring out what is preventing your transaction from finishing. For example, if one of the transactions runs in multiple statements and locks a record, it may cause other transactions to wait until the lock is released. But since the statement was already executed it would not be visible in the regular <code>PROCESSLIST</code> output.
      </p><p>
        Even more useful information could be found in the <code>threads</code> report that by default outputs information about all threads belong to the current user. It runs the MySQL Shell session, but can print information about all the threads running on the server and also fiter them and define output format.
      </p><p>
        For example, to find all blocked and blocking transactions you can define option <code>--where "nblocked &gt; 0 or nblocking &gt; 0"</code>.
        </p><pre data-type="programlisting"> MySQL  cookbook  SQL &gt; <strong><code>\show threads --foreground </code></strong>↩
                           <strong><code>--where "nblocked &gt; 0 or nblocking &gt; 0" </code></strong>↩
                           <strong><code>-o tid,cid,txid,txstate,nblocked,nblocking,info,pinfo</code></strong>↩
                           <strong><code>--vertical</code></strong>
*************************** 1. row ***************************
      tid: 1438
      cid: 1386
     txid: 292253
  txstate: RUNNING
 nblocked: 1
nblocking: 0
     info: NULL
    pinfo: select * from adcount for update
*************************** 2. row ***************************
      tid: 3320
      cid: 3268
     txid: 292254
  txstate: LOCK WAIT
 nblocked: 0
nblocking: 1
     info: update adcount set impressions = impressions + 1 where id=3
    pinfo: NULL</pre><p>
        Thus in the example above thread with <code>Connection ID 3268</code> is trying to execute an update 
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">UPDATE</code> <code class="n">adcount</code> <code class="k">SET</code> <code class="n">impressions</code> <code class="o">=</code> <code class="n">impressions</code> <code class="o">+</code> <code class="mi">1</code> <code class="k">WHERE</code> <code class="n">id</code><code class="o">=</code><code class="mi">3</code><code class="p">;</code></pre><p>, 
        but is blocked by another transcation. Otherwise, the thread with <code>Connection ID 1386</code> is not executing anything, but blocks a thread. Its previous statement was 
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">adcount</code> <code class="k">FOR</code> <code class="k">UPDATE</code><code class="p">;</code></pre><p> 
        that blocks all rows in the table <code>adcount</code> for writing. This way we easily found why the <span class="command"><em>UPDATE</em></span> in the connection 3268 cannot finish at the moment.
      </p><p>
        The report <span class="command"><em>threads</em></span> has more options. You can find all of them if run <span class="command"><em>\show</em></span> command with the report name, followed by the option <code>--help</code>.
        </p><pre data-type="programlisting"> MySQL  cookbook  SQL &gt; <strong><code>\show threads --help</code></strong>
NAME
      threads - Lists threads that belong to the user who owns the current
      session.

SYNTAX
      \show threads [OPTIONS]
      \watch threads [OPTIONS]

DESCRIPTION
      This report may contain the following columns:
...</pre><p>
      </p><div data-type="tip"><h6>Tip</h6><p>
          All MySQL Shell commands support help options. For built-in commands run <span class="command"><em>\? COMMAND</em></span>, <span class="command"><em>\help COMMAND</em></span> or <span class="command"><em>\h COMMAND</em></span>. For commands with parameters additionally try option <span class="command"><em>--help</em></span>.
        </p></div><p>
        Command <span class="command"><em>\watch</em></span> not only executes report, but does it repeatedly, with certain intervals. It could be very useful when you want to watch changes of the certain parameter. For example, to watch number of internal temporary tables, created to resolve queries, run command:
        </p><pre data-type="programlisting">MySQL  cookbook  SQL &gt; <strong><code>\watch query --nocls </code></strong>↩
                          	<strong><code>SHOW GLOBAL STATUS LIKE 'Created\_tmp\_%tables'</code></strong>
+-------------------------+-------+
| Variable_name           | Value |
+-------------------------+-------+
| Created_tmp_disk_tables | 4758  |
| Created_tmp_tables      | 25306 |
+-------------------------+-------+
+-------------------------+-------+
| Variable_name           | Value |
+-------------------------+-------+
| Created_tmp_disk_tables | 4758  |
| Created_tmp_tables      | 25309 |
+-------------------------+-------+
+-------------------------+-------+
| Variable_name           | Value |
+-------------------------+-------+
| Created_tmp_disk_tables | 4758  |
| Created_tmp_tables      | 25310 |
+-------------------------+-------+
+-------------------------+-------+
| Variable_name           | Value |
+-------------------------+-------+
| Created_tmp_disk_tables | 4760  |
| Created_tmp_tables      | 25318 |
+-------------------------+-------+
+-------------------------+-------+
| Variable_name           | Value |
+-------------------------+-------+
| Created_tmp_disk_tables | 4760  |
| Created_tmp_tables      | 25319 |
+-------------------------+-------+
...</pre><p>
        The query uses operator <code>LIKE</code> and patterns to much names of two system variables. We discuss how operator <code>LIKE</code> works and matches patterns at <a data-type="xref" href="ch07.xhtml#nch-strings-strings-pat-sql">Recipe 7.10</a>
      </p><p>
        The query runs with a default interval 2 seconds. The parameter <code>--nocls</code> instructs the command to not clear the screen before printing the latest result. To stop watching issue termination command <span class="command"><em>Ctrl+C</em></span>.
      </p><div data-type="tip"><h6>Tip</h6><p>
          
        </p></div></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.13 Using MySQL Shell Utilities"><div class="sect1" id="nch-mysqlshell-mysqlshell-utils"><h1>2.13 Using MySQL Shell Utilities</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820407567152"><h2>Problem</h2><p>
        You want to use MySQL Shell utilities.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820407566112"><h2>Solution</h2><p>
        In JavaScript or Python modes: use the methods of the global <code>util</code> object interactively or pass the method via the command line.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820407564752"><h2>Discussion</h2><p>
        MySQL Shell comes with a number of the built-in utilities that allows you to perform common adminstrative tasks, such as checking if your MySQL Server could be safely updated to the new version or making a reserve copy of the data. These utilities could be called as methods of the global object <code>util</code> in JavaScript and Python modes or specified as a command line option.
      </p><p>
        To find out which utilities MySQL Shell supports run the command <span class="command"><em>\? util</em></span>. The names of methods are different in JavaScript and Python modes and follow naming best practices for each of languages. Global object <code>util</code> is not available in the SQL mode, as well as utilities.
      </p><p>
        To figure out how one or another utility works use the help command with the name of the utility as an argument. For example, <span class="command"><em>\? checkForServerUpgrade</em></span> will print exhausted help for the upgrade checker utility in JavaScript mode. <span class="command"><em>\? dump_instance</em></span> will print detailed usage instructions for the utility that dumps the instance in Python mode.
      </p><p>
        Calling utility methods is no different than calling any other method. For example, the following code exports table limbs into file <code>limbs.csv</code> in fully-quoted CSV format.
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>util.exportTable(</code></strong>
                    -&gt;   <strong><code>'limbs', 'BACKUP/cookbook/limbs.csv', </code></strong>
                    -&gt;   <strong><code>{dialect: "csv-unix"})</code></strong>
Preparing data dump for table `cookbook`.`limbs`
Data dump for table `cookbook`.`limbs` will not use an index
Running data dump using 1 thread.
NOTE: Progress information uses estimated values and may not be accurate.
Data dump for table `cookbook`.`limbs` will be written to 1 file
91% (11 rows / ~12 rows), 0.00 rows/s, 0.00 B/s
Duration: 00:00:00s                            
Data size: 203 bytes                           
Rows written: 11                               
Bytes written: 203 bytes                       
Average throughput: 203.00 B/s                 
                                               
The dump can be loaded using:                  
util.importTable("BACKUP/cookbook/limbs.csv", {
    "characterSet": "utf8mb4",
    "dialect": "csv-unix",
    "schema": "cookbook",
    "table": "limbs"
})</pre><p>
      </p><p>
        You need to create directory <code>BACKUP/cookbook</code> before running this command or use different location.
      </p><p>
        This Python code restores the table into the table limbs in the database test:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>\sql CREATE TABLE test.limbs LIKE limbs;</code></strong>
Fetching table and column names from `cookbook` for auto-completion... ↩
Press ^C to stop.
Query OK, 0 rows affected (0.0264 sec)
 MySQL  cookbook  Py &gt; <strong><code>util.import_table("BACKUP/cookbook/limbs.csv", </code></strong>↩
                          <strong><code>{"dialect": "csv-unix", "schema": "test"})</code></strong>
Importing from file '/home/sveta/BACKUP/cookbook/limbs.csv' to table `test`.`limbs` ↩ 
in MySQL Server at 127.0.0.1:3306 using 1 thread
[Worker000] limbs.csv: Records: 11  Deleted: 0  Skipped: 0  Warnings: 0
100% (203 bytes / 203 bytes), 0.00 B/s
File '/home/sveta/BACKUP/cookbook/limbs.csv' (203 bytes) ↩
was imported in 0.0109 sec at 203.00 B/s
Total rows affected in test.limbs: Records: 11  Deleted: 0  Skipped: 0 Warnings: 0</pre><p>
      </p><p>
        We omitted all but necessary options for the import example to make it shorter.
      </p><p>
        In order to use <span class="command"><em>import_table</em></span> you need to be in the Classic protocol session. Otherwise the command will fail with an error:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>util.import_table("BACKUP/cookbook/limbs.csv", </code></strong>↩
                          <strong><code>{"dialect": "csv-unix", "schema": "test"})</code></strong>
Traceback (most recent call last):
  File "&lt;string&gt;", line 1, in &lt;module&gt;
SystemError: RuntimeError: Util.import_table: ↩
A classic protocol session is required to perform this operation.</pre><p>
      </p><div data-type="tip"><h6>Tip</h6><p>
          It is always good to read error messages, because they clearly show what is wrong and often contain instructions on how to fix the failure.
        </p></div><p>
        Another error you can hit is:
        </p><pre data-type="programlisting" data-code-language="sql"><code class="n">ERROR</code><code class="p">:</code> <code class="n">The</code> <code class="s1">'local_infile'</code> <code class="k">global</code> <code class="k">system</code> <code class="k">variable</code> <code class="n">must</code> <code class="n">be</code> <code class="k">set</code> <code class="k">to</code> <code class="k">ON</code> <code class="err">↩</code>
<code class="k">in</code> <code class="n">the</code> <code class="n">target</code> <code class="n">server</code><code class="p">,</code> <code class="k">after</code> <code class="n">the</code> <code class="n">server</code> <code class="k">is</code> <code class="n">verified</code> <code class="k">to</code> <code class="n">be</code> <code class="k">trusted</code><code class="p">:</code></pre><p>
        To bypass this error enable <code>local_infile</code> option with the command:
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">SET</code> <code class="k">GLOBAL</code> <code class="n">local_infile</code><code class="o">=</code><code class="mi">1</code><code class="p">;</code></pre><p>
        Or leave this example until you get to the <a data-type="xref" href="ch13.xhtml#nch-xfer">Chapter 13</a> that covers export and import of the MySQL database objects.
      </p><div data-type="tip"><h6>Tip</h6><p>
          If you do not understand what the utility is doing in these examples: do not worry. We will cover export and import of the MySQL database objects in <a data-type="xref" href="ch13.xhtml#nch-xfer">Chapter 13</a>.
        </p></div><p>
        If you want to run utilities without entering interactive mode you may specify them after the two dashes, following standard <span class="command"><em>mysqlsh</em></span> options:
        </p><pre data-type="programlisting">$ <strong><code> mysqlsh -- util check-for-server-upgrade root@127.0.0.1:13000 --output-format=JSON</code></strong>
Please provide the password for 'root@127.0.0.1:13000': 
Save password for 'root@127.0.0.1:13000'? [Y]es/[N]o/Ne[v]er (default No): 
{
    "serverAddress": "127.0.0.1:13000",
    "serverVersion": "8.0.23-debug - Source distribution",
    "targetVersion": "8.0.27",
    "errorCount": 0,
    "warningCount": 0,
    "noticeCount": 0,
    "summary": "No known compatibility errors or issues were found.",
...</pre><p>
        In this example we first specified the command name, then added two dashes, followed by the global object name, the method we wanted to use, the connection string and, finally, the method arguments.
      </p><p>
        The command line uses the method names of either JavaScript mode Camel case syntax: <span class="command"><em>checkForServerUpgrade</em></span>, the Kebab case syntax: <span class="command"><em>check-for-server-upgrade</em></span>, or the Snake case syntax: <span class="command"><em>check_for_server_upgrade</em></span>. For more information on how to use global objects without entering interactive mode use command <span class="command"><em>\? cmdline</em></span> interactively.
      </p><div data-type="tip"><h6>Tip</h6><p>
          You can use <code>--</code> syntax to call methods of other global objects on the command line:
          </p><pre data-type="programlisting">$ <strong><code>mysqlsh cbuser:cbpass@127.0.0.1:33060/cookbook</code></strong> 
          &gt; <strong><code>-- shell status</code></strong>
WARNING: Using a password on the command line interface ↩ 
can be insecure.
MySQL Shell version 8.0.22

Connection Id:                23563
Default schema:               cookbook
Current schema:               cookbook
Current user:                 cbuser@localhost
SSL:                          Cipher in use: ↩
                              TLS_AES_256_GCM_SHA384 ↩ 
                              TLSv1.3
...</pre><p>
          However, not all global objects are supported. Check <span class="command"><em>\? cmdline</em></span> for the list of supported objects.
        </p></div></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820407564288"><h2>See Also</h2><p>For additional information about MySQL Shell utilities, see <a href="https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-utilities.html">MySQL Shell Utilities</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.14 Using the Admin API to Automate Replication Management"><div class="sect1" id="nch-mysqlshell-mysqlshell-admin"><h1>2.14 Using the Admin API to Automate Replication Management</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820407441872"><h2>Problem</h2><p>
        You want to automate routine DBA tasks, such as deploying MySQL servers.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820407440784"><h2>Solution</h2><p>
        Use AdminAPI.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820407439840"><h2>Discussion</h2><p>
        MySQL Shell supports not only the X Dev API for querying the database, but also the AdminAPI allowing you to manage InnoDB ReplicaSet and InnoDB Cluster. AdminAPI consists of three classes: <code>Dba</code>, <code>Cluster</code> and <code>ReplicaSet</code>.
      </p><p>
        AdminAPI is accessible from the global object <code>dba</code> of class <code>DBA</code>. It allows you to configure MySQL instances and start either a standalone sandbox, or ReplicaSet, or Cluster.
      </p><p>
        To configure a standalone sandbox use the method <span class="command"><em>deploySandboxInstance</em></span> in the JavaScript mode or <span class="command"><em>deploy_sandbox_instance</em></span> in Python mode. This method takes a port number  and a dicitionary of parameters as arguments:
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>dba.deploySandboxInstance(13000, </code></strong>
                    -&gt; <strong><code>{"portx": 13010, "mysqldOptions": ["log-bin=cookbook"]})</code></strong>
A new MySQL sandbox instance will be created on this host in 
/home/sveta/mysql-sandboxes/13000

Warning: Sandbox instances are only suitable for deploying and 
running on your local machine for testing purposes and are not 
accessible from external networks.

Please enter a MySQL root password for the new instance: 

Deploying new MySQL instance...

Instance localhost:13000 successfully deployed and started.
Use shell.connect('root@localhost:13000') to connect to the instance.</pre><p>
        This will create a sandbox instance with X port 13010 and enabled binary log with a name, starting from <em>cookbook</em>:
        </p><pre data-type="programlisting"> MySQL  localhost:13000 ssl  JS &gt; <strong><code>shell.connect('root@localhost:13000')</code></strong>
Creating a session to 'root@localhost:13000'
Please provide the password for 'root@localhost:13000': 
Fetching schema names for autocompletion... Press ^C to stop.
Closing old connection...
Your MySQL connection id is 13
Server version: 8.0.22-13 Percona Server (GPL), Release '13', Revision '6f7822f'
No default schema selected; type \use &lt;schema&gt; to set one.
 MySQL  localhost:13000 ssl  JS &gt; <strong><code>\sql show variables like 'log_bin_basename';</code></strong>
+------------------+--------------------------------------------------------+
| Variable_name    | Value                                                  |
+------------------+--------------------------------------------------------+
| log_bin_basename | /home/sveta/mysql-sandboxes/13000/sandboxdata/cookbook |
+------------------+--------------------------------------------------------+
1 row in set (0.0027 sec)</pre><p>
      </p><p>
        To stop the instance use method <span class="command"><em>stopSandboxInstance</em></span> in JavaScript mode or <span class="command"><em>stop_sandbox_instance</em></span> in Python mode:
        </p><pre data-type="programlisting"> MySQL  localhost:13000 ssl  JS &gt; <strong><code>dba.stopSandboxInstance(13000)</code></strong>
The MySQL sandbox instance on this host in 
/home/sveta/mysql-sandboxes/13000 will be stopped

Please enter the MySQL root password for the instance 'localhost:13000': 

Stopping MySQL instance...

Instance localhost:13000 successfully stopped.</pre><p>
      </p><p>
        To destroy the instance use method <span class="command"><em>deleteSandboxInstance</em></span> in JavaScript mode or <span class="command"><em>delete_sandbox_instance</em></span> in Python mode:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>dba.delete_sandbox_instance(13000)</code></strong>

Deleting MySQL instance...

Instance localhost:13000 successfully deleted.</pre><p>
      </p><p>
        Global object <code>dba</code> is accessible from the command line:
        </p><pre data-type="programlisting">$ <strong><code>mysqlsh cbuser:cbpass@127.0.0.1:33060/cookbook -- dba kill-sandbox-instance 13000</code></strong>
WARNING: Using a password on the command line interface can be insecure.

Killing MySQL instance...

Instance localhost:1300 successfully killed.</pre><p>
      </p><p>
        Global object <code>dba</code> is not available in SQL mode.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820407419568"><h2>See Also</h2><p>For additional information about using AdminApi to create and manage a ReplicaSet, see <a data-type="xref" href="ch03.xhtml#nch-replication-replication-automation">Recipe 3.17</a>. For additional information about using AdminApi to create and manage InnoDB Cluster, see <a data-type="xref" href="ch03.xhtml#nch-replication-replication-automation-innodbcluster">“InnoDB Cluster”</a></p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.15 Working with JavaScript Objects"><div class="sect1" id="nch-mysqlshell-mysqlshell-javascript"><h1>2.15 Working with JavaScript Objects</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820407415632"><h2>Problem</h2><p>
        You want to work with your documents as objects, and you want to modify them and store them in the database using own methods and properties.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820407414688"><h2>Solution</h2><p>
        Create an object that will have all necessary methods to communicate with the database and use it as a prototype of your data objects.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820407413744"><h2>Discussion</h2><p>
        JavaScript is an object-oriented programming language and it is easy to create objects, modify them, and store them in the database. Sometimes it maybe easier to simply write <span class="command"><em>myObject.save()</em></span> instead of calling the full chain of methods of the X DevAPI Collection class. For example you may want to replace the following:
        </p><pre data-type="programlisting" data-code-language="js"><code class="nx">session</code><code class="p">.</code><code class="nx">getCurrentSchema</code><code class="p">().</code><code class="nx">getCollection</code><code class="p">(</code><code class="s1">'CollectionLimbs'</code><code class="p">).</code><code class="err">↩</code>
        <code class="nx">addOrReplaceOne</code><code class="p">(</code><code class="nx">myObject</code><code class="p">).</code><code class="nx">execute</code><code class="p">()</code></pre><p>
        with single 
        </p><pre data-type="programlisting" data-code-language="js"><code class="nx">CollectionLimbs</code><code class="p">.</code><code class="nx">save</code><code class="p">()</code></pre><p>
        call.
      </p><p>
        JavaScript supports inheritance, therefore you can create an object that will have all necessary methods, working with the <code>Collection</code> class methods, and use it as a prototype of the object, containing your business logic.
      </p><p>
        Let’s create as en example a <code>CookbookCollection</code> object that will have the methods <span class="command"><em>find</em></span>, <span class="command"><em>save</em></span> and <span class="command"><em>remove</em></span>. They will search for an object in the collection, save it after modification and remove from the database if necessary. The <code>CookbookCollection</code> object will also have a property <code>collection</code> that will store an object, representing collection where our object is stored.
      </p><p>
        In order to make our methods very simple for clarity, we will not add error handling. You can add this functionality yourself. For example, if a user forgets to set a collection property, you can throw a custom exception or have a default collection that will be used instead. We are relying on JavaScript built-in exceptions.
      </p><p>
        Let’s get started and create our object:
        </p><pre data-type="programlisting">mysql-js [cookbook]&gt; <strong><code>var CookbookCollection = { </code></strong>
                  -&gt; <strong><code>  // Collection where the object is stored</code></strong>
                  -&gt; <strong><code>  collection: null,</code></strong></pre><p>
        First we define the property collection where the object is stored. We do not set the name of the collection here, because want our prototype to work with any collection:
        </p><pre data-type="programlisting">                  -&gt; <strong><code>  // Searches collection and returns first</code></strong>
                  -&gt; <strong><code>  // object that satisfy search condition.</code></strong>
                  -&gt; <strong><code>  find: function(searchCondition) { </code></strong>
                  -&gt; <strong><code>    return this.collection.find(searchCondition).</code></strong>
                  -&gt; <strong><code>             execute().fetchOne(); </code></strong>
                  -&gt; <strong><code>  },</code></strong></pre><p>
        Function <span class="command"><em>find</em></span> searches the collection using any search condition. It could be <code>'_id = "00006002f0650000000000000061"'</code> or <code>'thing="human"'</code>. In other words: any condition, that the method <span class="command"><em>Collection.find</em></span> accepts. Then we fetch one document and return it as a result. We intentionally did not add any unique check code or any other way to ensure that there is only one document, satisfying our condition, because wanted to make the example as simple as possible and have it working with any collection:
        </p><pre data-type="programlisting">                  -&gt; <strong><code>  // Saves the object in the database</code></strong>
                  -&gt; <strong><code>  save: function() {</code></strong>
                  -&gt; <strong><code>    // If we know _id of the object we are </code></strong>
                  -&gt; <strong><code>    // updating the existing one</code></strong>
                  -&gt; <strong><code>    // We use not so effective method addOrReplaceOne</code></strong>
                  -&gt; <strong><code>    // instead of modify for simplicity.</code></strong>
                  -&gt; <strong><code>    if ('_id' in this) {</code></strong>
                  -&gt; <strong><code>      this.collection.addOrReplaceOne(this._id,</code></strong>
                  -&gt; <strong><code>        // We use double conversion, because we cannot</code></strong>
                  -&gt; <strong><code>        // store an object with methods in the database</code></strong>
                  -&gt; <strong><code>        JSON.parse(</code></strong>
                  -&gt; <strong><code>          JSON.stringify(</code></strong>
                  -&gt; <strong><code>            this, Object.getOwnPropertyNames(</code></strong>
                  -&gt; <strong><code>                    Object.getPrototypeOf(this))</code></strong>
                  -&gt; <strong><code>          )</code></strong>
                  -&gt; <strong><code>        )</code></strong>
                  -&gt; <strong><code>      )</code></strong>
                  -&gt; <strong><code>    } else {</code></strong>
                  -&gt; <strong><code>      // In case the object does not exist in the</code></strong>
                  -&gt; <strong><code>      //  database yet, we add it and assign </code></strong>
                  -&gt; <strong><code>      // generated _id to its own property.</code></strong>
                  -&gt; <strong><code>      // This _id could be used later if we want to update</code></strong>
                  -&gt; <strong><code>      // or remove the database entry.</code></strong>
                  -&gt; <strong><code>      this._id = this.collection.add(</code></strong>
                  -&gt; <strong><code>        JSON.parse(</code></strong>
                  -&gt; <strong><code>          JSON.stringify(</code></strong>
                  -&gt; <strong><code>            this, Object.getOwnPropertyNames(</code></strong>
                  -&gt; <strong><code>                    Object.getPrototypeOf(this))</code></strong>
                  -&gt; <strong><code>          )</code></strong>
                  -&gt; <strong><code>        )</code></strong>
                  -&gt; <strong><code>      ).execute().getGeneratedIds()[0]</code></strong>
                  -&gt; <strong><code>    }</code></strong>
                  -&gt; <strong><code>  },</code></strong></pre><p>
        The method <span class="command"><em>save</em></span> stores the object in the database. If there is no <code>_id</code> field in the object that usually means that there is no such object yet in the database. So, we use the method <span class="command"><em>add</em></span> to insert it into the database and set the property <code>_id</code> of the object to the value, generated by MySQL. If such a property already exists that either means that such object is already in the database or we want to set <code>_id</code> explicitly. In this case we use method <span class="command"><em>addOrReplaceOne</em></span> that either adds new object with the specified unique identifier or replaces existing one:
        </p><pre data-type="programlisting">                  -&gt; <strong><code>  // Removes the entry from the database.</code></strong>
                  -&gt; <strong><code>  // Once removed we unset property _id of the object.</code></strong>
                  -&gt; <strong><code>  remove: function() {</code></strong>
                  -&gt; <strong><code>    this.collection.remove("_id = '" + this._id + "'").</code></strong>
                  -&gt; <strong><code>      execute()</code></strong>
                  -&gt; <strong><code>    delete Object.getPrototypeOf(this)._id</code></strong>
                  -&gt; <strong><code>    delete this._id</code></strong>
                  -&gt; <strong><code>  }</code></strong>
                  -&gt; <strong><code>}</code></strong></pre><p>
        The method <span class="command"><em>remove</em></span> deletes the record from the database and additionally deletes property <code>_id</code> of our object, so that, in case we want to store it in the database again, it will be considered as a new one and new unique identifier will be generated. We remove property <code>_id</code> from both prototype and the object.
      </p><p>
        Let’s take the collection <code>CollectionLimbs</code> that we created in the <a data-type="xref" href="#nch-mysqlshell-mysqlshell-js-collections">Recipe 2.9</a> as an example. First, we retrieve it from the current <code>session</code> and set as a <code>collection</code> property of the <code>CookbookCollection</code> object.
        </p><pre data-type="programlisting">mysql-js [cookbook]&gt; <strong><code>CookbookCollection.collection=session.getCurrentSchema().</code></strong>
                  -&gt; <strong><code>getCollection('CollectionLimbs')</code></strong>
                  -&gt; 
&lt;Collection:CollectionLimbs&gt;</pre><p>
      </p><div data-type="tip"><h6>Tip</h6><p>
         In <a data-type="xref" href="#nch-mysqlshell-mysqlshell-js-collections">Recipe 2.9</a> we rolled back all our modifications to the <code>CollectionLimbs</code>. If you continued your own experiments further before running examples in this recipe, execute:
         </p><pre data-type="programlisting" data-code-language="js"><code class="nx">CookbookCollection</code><code class="p">.</code><code class="nx">collection</code> <code class="err">↩</code>
<code class="p">.</code><code class="nx">remove</code><code class="p">(</code><code class="s2">"thing='cat' or thing='dog'"</code><code class="p">)</code></pre><p>
       </p></div><p>
        Then let’s create an object <code>cat</code> with 2 arms and 2 legs:
        </p><pre data-type="programlisting">mysql-js [cookbook]&gt; <strong><code>var cat = {</code></strong>
                  -&gt; <strong><code>  thing: "cat",</code></strong>
                  -&gt; <strong><code>  arms: 2,</code></strong>
                  -&gt; <strong><code>  legs: 2</code></strong>
                  -&gt; <strong><code>}</code></strong>
                  -&gt;</pre><p>
      </p><p>
        To be able to store our cat in the database we need to assign object <code>CookbookCollection</code> as a prototype of the object <code>cat</code>:
        </p><pre data-type="programlisting">mysql-js [cookbook]&gt; <strong><code>cat = Object.setPrototypeOf(CookbookCollection, cat)</code></strong>
{
    "arms": 2, 
    "collection": &lt;Collection:CollectionLimbs&gt;, 
    "find": &lt;Function:find&gt;, 
    "legs": 2, 
    "remove": &lt;Function:remove&gt;, 
    "save": &lt;Function:save&gt;, 
    "thing": "cat"
}</pre><p>
      </p><p>
        Now we can save our object in the database:
        </p><pre data-type="programlisting">mysql-js [cookbook]&gt; <strong><code>cat.save()</code></strong></pre><p>
      </p><p>
        We can check if we can retrieve such an object with method <span class="command"><em>find</em></span>:
        </p><pre data-type="programlisting">mysql-js [cookbook]&gt; <strong><code>CookbookCollection.find('thing = "cat"')</code></strong>
{
    "_id": "000060140a2d0000000000000007", 
    "arms": 2, 
    "legs": 2, 
    "thing": "cat"
}</pre><p>
      </p><p>
        We can also confirm that our object now has <code>_id</code> property:
        </p><pre data-type="programlisting">mysql-js [cookbook]&gt; <strong><code>cat._id</code></strong>
000060140a2d0000000000000007</pre><p>
      </p><p>
        Do you see anything wrong here? Yes! The cat has two arms and two legs while usually cats have no arms and four legs. Let’s fix it:
        </p><pre data-type="programlisting">mysql-js [cookbook]&gt; <strong><code>cat.arms=0</code></strong>
0
mysql-js [cookbook]&gt; <strong><code>cat.legs=4</code></strong>
4
mysql-js [cookbook]&gt; <strong><code>cat.save()</code></strong>
mysql-js [cookbook]&gt; <strong><code>CookbookCollection.find('thing = "cat"')</code></strong>
{
    "_id": "000060140a2d0000000000000007", 
    "arms": 0, 
    "legs": 4, 
    "thing": "cat"
}</pre><p>
      </p><p>
        Now our cat is in good shape.
      </p><p>
        If we want to clean up the collection and leave it in a state as it was before our experiments we can remove document <code>cat</code> from the database:
        </p><pre data-type="programlisting">mysql-js [cookbook]&gt; <strong><code> cat.remove()</code></strong></pre><p>
      </p><p>
        We may also notice that the property <code>cat._id</code> does not exist in our object anymore:
        </p><pre data-type="programlisting">mysql-js [cookbook]&gt; <strong><code>cat._id</code></strong>
mysql-js [cookbook]&gt;</pre><p>
        If we decide to store the object in the database again new unique identifier will be generated.
      </p><p>
        You will find <code>CookbookCollection</code> code in the file <em class="filename">mysql_shell/CookbookCollection.js</em> of the <code>recipes</code> distribution.
      </p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.16 Filling Test Data Using Python’s Data Science Modules"><div class="sect1" id="nch-mysqlshell-mysqlshell-python"><h1>2.16 Filling Test Data Using Python’s Data Science Modules</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820407210752"><h2>Problem</h2><p>
        You want to fill a test table with partially random data. For example, you need IDs to follow a sequence. You also want them to have realistic names and surnames. The rest of values in the table could be random, but index should have certain cardinality.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820407209488"><h2>Solution</h2><p>
        Script data population using Python and its specific data science modules.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820407208432"><h2>Discussion</h2><p>
        We often are in a situation when it is necessary to fill a table with fake data that mimics real world data for testing purposes. For example, when you develop an application and want to check what happens if the volume of data stored in it will increase. Or you hit a situation where a particular query works slow in production and you want to experiment on the test server, but do not want to copy production data due to security or performance reasons. This task may also be required when you want to ask third-party consultants for help.
      </p><p>
        One such example is the table <code>patients</code> that we use in <a data-type="xref" href="ch24.xhtml#nch-security-security-views">Recipe 24.12</a>. This is a table, storing patients records that spent more than one day in a hospital. It stores such data as national ID, name, surname, gender, diagnosis of the person and outcome, such as dates that this patient spent in the hospital and if they were recovered, checked out with same symphtoms or even died. You can find details if run <span class="command"><em>SHOW CREATE TABLE</em></span> command:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>session.sql('SHOW CREATE TABLE patients')</code></strong>
*************************** 1. row ***************************
       Table: patients
Create Table: CREATE TABLE `patients` (
  `id` int NOT NULL AUTO_INCREMENT,
  `national_id` char(32) DEFAULT NULL,
  `name` varchar(255) DEFAULT NULL,
  `surname` varchar(255) DEFAULT NULL,
  `gender` enum('F','M') DEFAULT NULL,
  `age` tinyint unsigned DEFAULT NULL,
  `additional_data` json DEFAULT NULL,
  `diagnosis` varchar(255) DEFAULT NULL,
  `result` enum('R','N','D') DEFAULT NULL↩
   COMMENT 'R=Recovered, N=Not Recovered, D=Dead',
  `date_arrived` date NOT NULL,
  `date_departed` date DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1101 ↩
DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.0009 sec)</pre><p>
      </p><p>
        Of course, we could not even think about using real data for examples with this table. However, we still want to pretend that the data is real. For example, names and surnames should be ones that are popular. Like someone named John Doe or Ann Smith, genders should correspond to right names. E.g. John is, likely, a male and Ann is, likely, a female. Ages should fail in realistic range, departure date should be greater than the date when the patient arrived to the hospital, and it is unlikely that a patient would spend 10 years there. So we need a smart way to fill the table with fake values.
      </p><p>
        Python is a programming language often used for data analysis and statistics. It has libraries, such as <code>pandas</code>, that help to manipulate with large data sets. It has convenient methods to read and generate data. This is why Python is one of the ideal ways to perform our task.
      </p><p>
        To use module <code>pandas</code> in MySQL Shell you need to have it installed on your machine and add the path where the library is located, into MySQL Shell’s <code>sys.path</code>. Here are the steps that will help you to perform this task.
        </p><ul><li><p>
              First check which version of Python MySQL Shell is running. In our case this is version 3.7.7:
              </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>import sys</code></strong>
 MySQL  cookbook  Py &gt; <strong><code>sys.version</code></strong>
3.7.7 (default, Aug 12 2020, 09:13:48) 
[GCC 4.4.7 20120313 (Red Hat 4.4.7-23.0.1)]</pre><p>
            </p></li><li><p>
              MySQL Shell does not come with <span class="command"><em>python</em></span> executable and <span class="command"><em>pip</em></span> that you can run from outside MySQL Shell. Therefore you need to install the same version as the MySQL Shell’s Python. We preferred to keep system-wide installed version 3.8.5 untouched and install the same version which our MySQL Shell instance used: 3.7.7 into a local directory from the source code. You may decide to have the same version system-wide.
            </p></li><li><p>
              Once the necessary version of Python is installed check where it stores its modules and add this directory to the <code>sys.path</code> of the MySQL Shell:
              </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>sys.path.append(</code></strong>↩
 <strong><code>"/home/sveta/bin/python-3.7.7/lib/python3.7/site-packages")</code></strong></pre><p>
            </p><div data-type="tip"><h6>Tip</h6><p>
                To avoid typing this command each time when you want to use modules that are not part of the MySQL Shell distribution, add this command to the Python mode configuration file. This file, by default, is located at <code>~/.mysqlsh/mysqlshrc.py</code>
              </p></div></li><li><p>
              Install necessary packages. For our example we used <code>numpy</code>, <code>pandas</code>, <code>random</code>, <code>string</code> and <code>datetime</code>.
            </p></li></ul><p>
        Once these prerequisites are met we are ready to fill our table with example data.
      </p><section data-type="sect3" data-pdf-bookmark="Data filling step-by-step"><div class="sect3" id="nch-mysqlshell-mysqlshell-python-dataexample"><h3>Data filling step-by-step</h3><p>
          First, we need to import all necessary packages. Type the following in the MySQL Shell Python protocol session:
          </p><pre data-type="programlisting" data-code-language="py"><code class="kn">import</code> <code class="nn">numpy</code>
<code class="kn">from</code> <code class="nn">pandas</code> <code class="kn">import</code> <code class="n">pandas</code>
<code class="kn">import</code> <code class="nn">random</code>
<code class="kn">import</code> <code class="nn">string</code>
<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">datetime</code>
<code class="kn">from</code> <code class="nn">datetime</code> <code class="kn">import</code> <code class="n">timedelta</code></pre><p>
          Now we are ready to generate data.
        </p><p>
          For names and surnames we decided to use real names found in the datasets, available on the Internet. You will find datasets we used, their licenses and distribution rights in the directory <em class="filename">datasets</em> of the <code>recipes</code> distribution. For diagnoses we also used publicly available data of the top 8 diagnosises with their frequency, and fake diagnose “Data Phobia” with even higher frequency. Data for genders is stored together with names. All other values are generated. We did not care if this data looks real. For example, we may end up with a 16-year-old patient dying from Alcoholic liver disease that will unlikely happen in real life, but for demonstrating purposes that should be enough. However, Python allows to solve such collisions. You may change our example, so it will create even more realistic data.
        </p><p>
          It is convenient to have a variable, defining the final number of rows in the table:
          </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>num_rows=1000</code></strong></pre><p>
        </p><p>
          Now, once we are ready, let’s discuss how we will process each of the table <code>patients</code> column.
        </p><dl><dt>Names and genders</dt><dd><p>
                Names and genders are stored in file <code>top-350-male-and-female-names-since-1848-2019-02-26.csv</code> in the following format:
                </p><pre data-type="programlisting">$ <strong><code>head datasets/top-350-male-and-female-names-since-1848-2019-02-26.csv</code></strong>
Rank,Female Name,Count,Male Name,Count_
1,Mary,54276,John,108533
2,Margaret,49170,William,87239
3,Elizabeth,36556,James,69987
4,Sarah,28230,David,62774
5,Patricia,20689,Robert,56511
6,Catherine,19713,Michael,51768
7,Susan,19165,Peter,44758
8,Helen,18881,Thomas,42467
9,Emma,18192,George,39195</pre><p>
                That means each row contains a rank from 1 to 350, one name that is traditionally female, and one name that is traditionally male of this rank and count of such names. We are not interested in the rank and count. We just need female and male names with gender information. Therefore we need to perform slight manipulation on this dataset after reading.
              </p><p>
                First, we read the file using <span class="command"><em>read_csv</em></span> method of <code>pandas</code>. We will read the file twice: once for traditional female names and once for traditional male names. We will use only the <code>Female Name</code> column in the first attempt and only <code>Male Name</code> column in the second attempt. We will also rename this column, so it corresponds name of the column in our database:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>female_names=pandas.\</code></strong>
                    -&gt; <strong><code>read_csv(</code></strong>
                    -&gt; <strong><code>  "top-350-male-and-female-names-since-1848-2019-02-26.csv",</code></strong>
                    -&gt; <strong><code>  usecols=["Female Name"]</code></strong>
                    -&gt; <strong><code>).rename(columns={'Female Name': 'name'})</code></strong>
                    -&gt; 
 MySQL  cookbook  Py &gt; <strong><code>male_names=pandas.\</code></strong>
                    -&gt; <strong><code>read_csv(</code></strong>
                    -&gt; <strong><code>  "top-350-male-and-female-names-since-1848-2019-02-26.csv",</code></strong>
                    -&gt; <strong><code>  usecols=["Male Name"]</code></strong>
                    -&gt; <strong><code>).rename(columns={'Male Name': 'name'})</code></strong>
                    -&gt;</pre><p>
                Once done add a <code>gender</code> column to our datasets:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>female_names['gender']=(['F']*</code></strong>↩
                          <strong><code>female_names.count()['name'])</code></strong>
 MySQL  cookbook  Py &gt; <strong><code>male_names['gender']=(['M']*</code></strong>↩
                          <strong><code>male_names.count()['name'])</code></strong></pre><p>
                And, finally, concatenate two datasets into one:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>names=pandas.\</code></strong>
                    -&gt; <strong><code>concat([female_names, male_names],</code></strong>
                    -&gt; <strong><code>  ignore_index=True)</code></strong>
                    -&gt;</pre><p>
              </p><p>
                In order to read file <code>top-350-male-and-female-names-since-1848-2019-02-26.csv</code> it should be either in current working directory or you need to provide absolute path to this file. To find your current working directory, run:
                </p><pre data-type="programlisting" data-code-language="py"><code class="n">os</code><code class="o">.</code><code class="n">getcwd</code><code class="p">()</code></pre><p>
                To change the working directory, run:
                </p><pre data-type="programlisting" data-code-language="py"><code class="n">os</code><code class="o">.</code><code class="n">chdir</code><code class="p">(</code><code class="s1">'/mysqlcookbook/recipes/datasets'</code><code class="p">)</code></pre><p>
                This will allow to read files, located in <code>/mysqlcookbook/recipes/datasets</code>. Adjust directory path to reflect your environment.
              </p><div data-type="tip"><h6>Tip</h6><p>Method <code>concat</code> of the Python module <code>pandas</code> works similarly to SQL <code>UNION</code> clause.</p></div><p>
                We can examine content of our dataset that uses <code>pandas</code> data structure <code>DataFrame</code> by typing its name:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>names</code></strong>
          name gender
0         Mary      F
1     Margaret      F
2    Elizabeth      F
3        Sarah      F
4     Patricia      F
..         ...    ...
695    Quentin      M
696     Henare      M
697        Joe      M
698      Darcy      M
699       Wade      M

[700 rows x 2 columns]</pre><p>
              </p><p>
                Number of rows in the DataFrame is smaller than the number of rows we want to have in our table, so we need to generate more. We also want to shuffle the data, so we have random distribution of names. We will use method <span class="command"><em>sample</em></span> for this purpose. Since we are creating a set, larger than the initial one, we need to specify an option <code>replace=True</code>. We will also re-create index for the new DataFrame using method <span class="command"><em>pandas.Series</em></span>, so it will be ordered.
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>names=names.sample(num_rows, replace=True).\</code></strong>
                    -&gt; <strong><code>set_index(pandas.Series(range(num_rows)))</code></strong>
                    -&gt;</pre><p>
              </p></dd><dt>Surnames</dt><dd><p>
                For surnames we will use a dataset, stored in the file <code>Names_2010Census.csv</code>. It has multiple columns, such as a rank, the number of surnames and so on. But we are only interested in the first column: <code>name</code>. We also do not need last row of this file, containing a record for <code>ALL OTHER NAMES</code>. Surnames in this file are stored in uppercase. We could format them differently, but we decided to leave them as is. We will also rename column <code>name</code> to <code>surname</code>, so it is a same as in our table definition.
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>surnames=pandas.read_csv("Names_2010Census.csv", </code></strong>
                    -&gt; <strong><code>  usecols=['name'], skipfooter=1, engine='python').\</code></strong>
                    -&gt; <strong><code>rename(columns={'name': 'surname'})</code></strong>
                    -&gt;</pre><p>
                <span class="command"><em>pandas</em></span> prints a warning that it will use slower, but more powerful <code>python</code> engine to process the file, but this warning can be ignored.
              </p><p>
                We will shuffle surnames using the same method that we used for the names.
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>surnames=surnames.sample(num_rows, replace=True).\</code></strong>
                    -&gt; <strong><code>set_index(pandas.Series(range(num_rows)))</code></strong>
                    -&gt;</pre><p>
              </p></dd><dt>Diagnoses</dt><dd><p>
                We manually prepared file <code>diagnosis.csv</code> that is just of 9 diagnosises, therefore we only need to read it and do not need to specify any option.
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>diagnosises=pandas.read_csv('diagnosis.csv')</code></strong>
 MySQL  cookbook  Py &gt; <strong><code>diagnosises</code></strong>
                               diagnosis  frequency
0                Acute coronary syndrome        2.1
1                Alcoholic liver disease        0.3
2                              Pneumonia        3.6
3  Chronic obstructive pulmonary disease        2.1
4                Gastro-intestinal bleed        0.8
5                          Heart failure        0.8
6                                 Sepsis        0.8
7                Urinary tract infection        2.4
8                            Data Phobia        6.2</pre><p>
              </p><p>
                Diagnoses are different from the names and surnames, because they have different frequency and we want them distributed in our final dataset according to those frequencies. Therefore we will pass parameter <code>weights</code> to the method <code>sample</code>.
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>diagnosises=diagnosises.sample(</code></strong>
                    -&gt; <strong><code>  num_rows, replace=True,</code></strong>
                    -&gt; <strong><code>  weights=diagnosises['frequency']</code></strong>
                    -&gt; <strong><code>).set_index(pandas.Series(range(num_rows)))</code></strong>
                    -&gt;</pre><p>
              </p></dd><dt>Results</dt><dd><p>
                Data type for results is <code>ENUM</code> that could contain only three possible values: <code>R</code> for recovered, <code>N</code> for not recovered and <code>D</code> for dead. We would not use any source for such results, but generate a DataFrame interactively.
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>results = pandas.DataFrame({</code></strong>
                    -&gt; <strong><code>  "result": ["R", "N", "D"],</code></strong>
                    -&gt; <strong><code>  "frequency": [6,3,1]</code></strong>
                    -&gt; <strong><code>})</code></strong>
                    -&gt;</pre><p>
                We added a frequency to our results. These frequencies have nothing to do with reality: we only need them to distribute our results differently.
              </p><p>
                Since we have a frequency for our results we will generate the data set similarly like we did for diagnosises.
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>results=results.sample(</code></strong>
                    -&gt; <strong><code>  num_rows, replace=True,</code></strong>
                    -&gt; <strong><code>  weights=results['frequency']</code></strong>
                    -&gt; <strong><code>).set_index(pandas.Series(range(num_rows)))</code></strong>
                    -&gt;</pre><p>
              </p></dd><dt>The table</dt><dd><p>
                Our main datasets are prepared. Now we can start inserting rows into the table one-by-one.
              </p><p>
                First, let’s retrieve a <code>Table</code> object, so we can query it comfortably.
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>patients=session.get_schema('cookbook').</code></strong>↩
                          <strong><code>get_table('patients')</code></strong></pre><p>
                Then start the loop
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>for i in range(num_rows):</code></strong></pre><p>
                All subsequent generations will be proceeded in the loop.
              </p></dd><dt>National ID</dt><dd><p>
                Format of the national ID can vary between countries and we simply need something unique that can follow some pattern. We decided to use format of two digits, followed by two uppercase letters and followed by six digits. To generate random digits we will use method <span class="command"><em>randrange</em></span> of the module <code>random</code> and to generate letters we will use method <span class="command"><em>sample</em></span> from the module <code>random</code>. We will use pre-defined set <code>string.ascii_uppercase</code> as a dataset to sample. Then we will join generated array to empty string, so it will create a string:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>national_id=str(random.randrange(10,99)) +\</code></strong>
                    -&gt; <strong><code>''.join(random.sample(string.ascii_uppercase, 2)) + \</code></strong>
                    -&gt; <strong><code>str(random.randrange(100000, 999999))</code></strong>
                    -&gt;</pre><p>
              </p></dd><dt>Age</dt><dd><p>
                For the age we will simpy choose a number between 15 and 99. We would not care about frequency of ages or about how many of patients of certain age have a certain disease:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>age=random.randrange(15, 99)</code></strong></pre><p>
              </p></dd><dt>Dates which a patient spent in the hospital</dt><dd><p>
                For the <code>date_arrived</code> column we decided to just use any date in year 2020. We can generate such a date by specifying a start date as January 1, 2020 and using method <span class="command"><em>timedelta</em></span>:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>date_arrived=datetime.\</code></strong>
                    -&gt; <strong><code>strptime('2020-01-01', '%Y-%m-%d') +\</code></strong>
                    -&gt; <strong><code>timedelta(days=random.randrange(365))</code></strong>
                    -&gt;</pre><p>
                For the column <code>date_departed</code> we will use the same idea, but we will use <code>date_arrived</code> as a starting date and interval of two months:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>date_departed=date_arrived +\</code></strong>
                    -&gt; <strong><code>timedelta(days=random.randrange(60))</code></strong>
                    -&gt;</pre><p>
                This code creates values for <code>date_arrived</code> and <code>date_departed</code> as <code>datetime</code> Python objects that could not be inserted into MySQL table, therefore we need to convert them into string format:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>date_arrived=date_arrived.strftime('%Y-%m-%d')</code></strong>
 MySQL  cookbook  Py &gt; <strong><code>date_departed=date_departed.strftime('%Y-%m-%d')</code></strong></pre><p>
              </p></dd><dt>Preparing the row</dt><dd><p>
                We have values to be inserted into <code>i-</code>th row of our table into columns <code>national_id</code>, <code>age</code>, <code>date_arrived</code> and <code>date_departed</code>. But rest of the values are stored in <code>DataFrame</code>s of exactly desired number of rows size. We only need to retrieve specific row from the <code>DataFrame</code>:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>name=names['name'][i]</code></strong>
 MySQL  cookbook  Py &gt; <strong><code>gender=names['gender'][i]</code></strong>
 MySQL  cookbook  Py &gt; <strong><code>surname=surnames['surname'][i]</code></strong>
 MySQL  cookbook  Py &gt; <strong><code>result=results['result'][i]</code></strong>
 MySQL  cookbook  Py &gt; <strong><code>diagnosis=diagnosises['diagnosis'][i]</code></strong></pre><p>
              </p></dd><dt>Inserting row into a table</dt><dd><p>
                Now we are ready to insert a row into our table. We will use method <span class="command"><em>insert</em></span> of the class <code>Table</code> that we discussed in detail in <a data-type="xref" href="#nch-mysqlshell-mysqlshell-python-tables">Recipe 2.8</a>:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>patients.insert(</code></strong>
                    -&gt; <strong><code>  'national_id', 'name', 'surname',</code></strong>
                    -&gt; <strong><code>  'gender', 'age', 'diagnosis',</code></strong>
                    -&gt; <strong><code>  'result', 'date_arrived', 'date_departed'</code></strong>
                    -&gt; <strong><code>).values(</code></strong>
                    -&gt; <strong><code>  national_id, name, surname,</code></strong>
                    -&gt; <strong><code>  gender, age, diagnosis,</code></strong>
                    -&gt; <strong><code>  result, date_arrived, date_departed</code></strong>
                    -&gt; <strong><code>).execute()</code></strong></pre><p>
              </p></dd><dt>Putting all together</dt><dd><p>
                It maybe convenient to define the code we just wrote as a function, so we can re-use it. Let’s create one, called <span class="command"><em>generate_patients_data</em></span>.
                </p><pre data-type="programlisting" data-code-language="python"><code class="k">def</code> <code class="nf">generate_patients_data</code><code class="p">(</code><code class="n">num_rows</code><code class="p">):</code>
    <code class="c1"># read datasets</code>
    <code class="c1"># names and genders</code>
    <code class="n">female_names</code> <code class="o">=</code> <code class="n">pandas</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code>
        <code class="s2">"top-350-male-and-female-names-since-1848-2019-02-26.csv"</code><code class="p">,</code> 
        <code class="n">usecols</code> <code class="o">=</code> <code class="p">[</code><code class="s2">"Female Name"</code><code class="p">]</code>
    <code class="p">)</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code> <code class="o">=</code> <code class="p">{</code><code class="s1">'Female Name'</code><code class="p">:</code> <code class="s1">'name'</code><code class="p">})</code>
    <code class="n">female_names</code><code class="p">[</code><code class="s1">'gender'</code><code class="p">]</code> <code class="o">=</code> <code class="p">([</code><code class="s1">'F'</code><code class="p">]</code><code class="o">*</code><code class="n">female_names</code><code class="o">.</code><code class="n">count</code><code class="p">()[</code><code class="s1">'name'</code><code class="p">])</code>
    <code class="n">male_names</code> <code class="o">=</code> <code class="n">pandas</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code>
        <code class="s2">"top-350-male-and-female-names-since-1848-2019-02-26.csv"</code><code class="p">,</code> 
        <code class="n">usecols</code> <code class="o">=</code> <code class="p">[</code><code class="s2">"Male Name"</code><code class="p">]</code>
    <code class="p">)</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code> <code class="o">=</code> <code class="p">{</code><code class="s1">'Male Name'</code><code class="p">:</code> <code class="s1">'name'</code><code class="p">})</code>
    <code class="n">male_names</code><code class="p">[</code><code class="s1">'gender'</code><code class="p">]</code> <code class="o">=</code> <code class="p">([</code><code class="s1">'M'</code><code class="p">]</code><code class="o">*</code><code class="n">male_names</code><code class="o">.</code><code class="n">count</code><code class="p">()[</code><code class="s1">'name'</code><code class="p">])</code>
    <code class="n">names</code> <code class="o">=</code> <code class="n">pandas</code><code class="o">.</code><code class="n">concat</code><code class="p">([</code><code class="n">female_names</code><code class="p">,</code> <code class="n">male_names</code><code class="p">],</code> <code class="n">ignore_index</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
    <code class="n">surnames</code> <code class="o">=</code> <code class="n">pandas</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code>
        <code class="s2">"Names_2010Census.csv"</code><code class="p">,</code> 
        <code class="n">usecols</code><code class="o">=</code><code class="p">[</code><code class="s1">'name'</code><code class="p">],</code> <code class="n">skipfooter</code><code class="o">=</code><code class="mi">1</code>
    <code class="p">)</code><code class="o">.</code><code class="n">rename</code><code class="p">(</code><code class="n">columns</code><code class="o">=</code><code class="p">{</code><code class="s1">'name'</code><code class="p">:</code> <code class="s1">'surname'</code><code class="p">})</code>
    <code class="c1"># diagnosises</code>
    <code class="n">diagnosises</code> <code class="o">=</code> <code class="n">pandas</code><code class="o">.</code><code class="n">read_csv</code><code class="p">(</code><code class="s1">'diagnosis.csv'</code><code class="p">)</code>
    <code class="c1"># Possible results</code>
    <code class="n">results</code> <code class="o">=</code> <code class="n">pandas</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">({</code>
        <code class="s2">"result"</code><code class="p">:</code> <code class="p">[</code><code class="s2">"R"</code><code class="p">,</code> <code class="s2">"N"</code><code class="p">,</code> <code class="s2">"D"</code><code class="p">],</code> 
        <code class="s2">"frequency"</code><code class="p">:</code> <code class="p">[</code><code class="mi">6</code><code class="p">,</code><code class="mi">3</code><code class="p">,</code><code class="mi">1</code><code class="p">]</code>
    <code class="p">})</code>
    <code class="c1"># Start building data</code>
    <code class="n">diagnosises</code> <code class="o">=</code> <code class="n">diagnosises</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code>
        <code class="n">num_rows</code><code class="p">,</code> <code class="n">replace</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> 
        <code class="n">weights</code><code class="o">=</code><code class="n">diagnosises</code><code class="p">[</code><code class="s1">'frequency'</code><code class="p">]</code>
    <code class="p">)</code><code class="o">.</code><code class="n">set_index</code><code class="p">(</code><code class="n">pandas</code><code class="o">.</code><code class="n">Series</code><code class="p">(</code><code class="nb">range</code><code class="p">(</code><code class="n">num_rows</code><code class="p">)))</code>
    <code class="n">results</code> <code class="o">=</code> <code class="n">results</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code>
        <code class="n">num_rows</code><code class="p">,</code> <code class="n">replace</code><code class="o">=</code><code class="bp">True</code><code class="p">,</code> 
        <code class="n">weights</code><code class="o">=</code><code class="n">results</code><code class="p">[</code><code class="s1">'frequency'</code><code class="p">]</code>
    <code class="p">)</code><code class="o">.</code><code class="n">set_index</code><code class="p">(</code><code class="n">pandas</code><code class="o">.</code><code class="n">Series</code><code class="p">(</code><code class="nb">range</code><code class="p">(</code><code class="n">num_rows</code><code class="p">)))</code>
    <code class="n">names</code><code class="o">=</code><code class="n">names</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code>
        <code class="n">num_rows</code><code class="p">,</code> <code class="n">replace</code><code class="o">=</code><code class="bp">True</code>
    <code class="p">)</code><code class="o">.</code><code class="n">set_index</code><code class="p">(</code><code class="n">pandas</code><code class="o">.</code><code class="n">Series</code><code class="p">(</code><code class="nb">range</code><code class="p">(</code><code class="n">num_rows</code><code class="p">)))</code>
    <code class="n">surnames</code><code class="o">=</code><code class="n">surnames</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code>
        <code class="n">num_rows</code><code class="p">,</code> <code class="n">replace</code><code class="o">=</code><code class="bp">True</code>
    <code class="p">)</code><code class="o">.</code><code class="n">set_index</code><code class="p">(</code><code class="n">pandas</code><code class="o">.</code><code class="n">Series</code><code class="p">(</code><code class="nb">range</code><code class="p">(</code><code class="n">num_rows</code><code class="p">)))</code>
    <code class="c1"># Get table object</code>
    <code class="n">patients</code><code class="o">=</code><code class="n">session</code><code class="o">.</code><code class="n">get_schema</code><code class="p">(</code><code class="s1">'cookbook'</code><code class="p">)</code><code class="o">.</code><code class="n">get_table</code><code class="p">(</code><code class="s1">'patients'</code><code class="p">)</code>
    <code class="c1"># Loop, inserting rows</code>
    <code class="k">for</code> <code class="n">i</code> <code class="ow">in</code> <code class="nb">range</code><code class="p">(</code><code class="n">num_rows</code><code class="p">):</code>
        <code class="n">national_id</code> <code class="o">=</code> <code class="nb">str</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">randrange</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code class="mi">99</code><code class="p">))</code> <code class="o">+</code> \
            <code class="s1">''</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">sample</code><code class="p">(</code><code class="n">string</code><code class="o">.</code><code class="n">ascii_uppercase</code><code class="p">,</code> <code class="mi">2</code><code class="p">))</code> <code class="o">+</code> \
            <code class="nb">str</code><code class="p">(</code><code class="n">random</code><code class="o">.</code><code class="n">randrange</code><code class="p">(</code><code class="mi">100000</code><code class="p">,</code> <code class="mi">999999</code><code class="p">))</code>
        <code class="n">age</code> <code class="o">=</code> <code class="n">random</code><code class="o">.</code><code class="n">randrange</code><code class="p">(</code><code class="mi">15</code><code class="p">,</code> <code class="mi">99</code><code class="p">)</code>
        <code class="n">date_arrived</code> <code class="o">=</code> <code class="n">datetime</code><code class="o">.</code><code class="n">strptime</code><code class="p">(</code><code class="s1">'2020-01-01'</code><code class="p">,</code> <code class="s1">'</code><code class="si">%Y</code><code class="s1">-</code><code class="si">%m</code><code class="s1">-</code><code class="si">%d</code><code class="s1">'</code><code class="p">)</code> <code class="o">+</code> \
            <code class="n">timedelta</code><code class="p">(</code><code class="n">days</code><code class="o">=</code><code class="n">random</code><code class="o">.</code><code class="n">randrange</code><code class="p">(</code><code class="mi">365</code><code class="p">))</code>
        <code class="n">date_departed</code> <code class="o">=</code> <code class="n">date_arrived</code> <code class="o">+</code> <code class="n">timedelta</code><code class="p">(</code><code class="n">days</code><code class="o">=</code><code class="n">random</code><code class="o">.</code><code class="n">randrange</code><code class="p">(</code><code class="mi">60</code><code class="p">))</code>
        <code class="n">date_arrived</code> <code class="o">=</code> <code class="n">date_arrived</code><code class="o">.</code><code class="n">strftime</code><code class="p">(</code><code class="s1">'</code><code class="si">%Y</code><code class="s1">-</code><code class="si">%m</code><code class="s1">-</code><code class="si">%d</code><code class="s1">'</code><code class="p">)</code>
        <code class="n">date_departed</code> <code class="o">=</code> <code class="n">date_departed</code><code class="o">.</code><code class="n">strftime</code><code class="p">(</code><code class="s1">'</code><code class="si">%Y</code><code class="s1">-</code><code class="si">%m</code><code class="s1">-</code><code class="si">%d</code><code class="s1">'</code><code class="p">)</code>
        <code class="n">name</code> <code class="o">=</code> <code class="n">names</code><code class="p">[</code><code class="s1">'name'</code><code class="p">][</code><code class="n">i</code><code class="p">]</code>
        <code class="n">gender</code> <code class="o">=</code> <code class="n">names</code><code class="p">[</code><code class="s1">'gender'</code><code class="p">][</code><code class="n">i</code><code class="p">]</code>
        <code class="n">surname</code> <code class="o">=</code> <code class="n">surnames</code><code class="p">[</code><code class="s1">'surname'</code><code class="p">][</code><code class="n">i</code><code class="p">]</code>
        <code class="n">result</code> <code class="o">=</code> <code class="n">results</code><code class="p">[</code><code class="s1">'result'</code><code class="p">][</code><code class="n">i</code><code class="p">]</code>
        <code class="n">diagnosis</code> <code class="o">=</code> <code class="n">diagnosises</code><code class="p">[</code><code class="s1">'diagnosis'</code><code class="p">][</code><code class="n">i</code><code class="p">]</code>
        <code class="n">patients</code><code class="o">.</code><code class="n">insert</code><code class="p">(</code>
            <code class="s1">'national_id'</code><code class="p">,</code> <code class="s1">'name'</code><code class="p">,</code> <code class="s1">'surname'</code><code class="p">,</code> 
            <code class="s1">'gender'</code><code class="p">,</code> <code class="s1">'age'</code><code class="p">,</code> <code class="s1">'diagnosis'</code><code class="p">,</code> 
            <code class="s1">'result'</code><code class="p">,</code> <code class="s1">'date_arrived'</code><code class="p">,</code> <code class="s1">'date_departed'</code>
        <code class="p">)</code><code class="o">.</code><code class="n">values</code><code class="p">(</code>
            <code class="n">national_id</code><code class="p">,</code> <code class="n">name</code><code class="p">,</code> <code class="n">surname</code><code class="p">,</code> 
            <code class="n">gender</code><code class="p">,</code> <code class="n">age</code><code class="p">,</code> <code class="n">diagnosis</code><code class="p">,</code> 
            <code class="n">result</code><code class="p">,</code> <code class="n">date_arrived</code><code class="p">,</code> <code class="n">date_departed</code>
        <code class="p">)</code><code class="o">.</code><code class="n">execute</code><code class="p">()</code></pre><p>
              </p><p>
                We can check how it works by truncating table patients and then calling the function:
                </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code> \sql truncate table patients</code></strong>
Query OK, 0 rows affected (0.0477 sec)
 MySQL  cookbook  Py &gt; <strong><code> session.get_schema('cookbook').get_table('patients').count()</code></strong>
0
 MySQL  cookbook  Py &gt; <strong><code> generate_patients_data(1000)</code></strong>
__main__:17: ParserWarning: Falling back to the 'python' engine ↩
because the 'c' engine does not support skipfooter; ↩
you can avoid this warning by specifying engine='python'.
 MySQL  cookbook  Py &gt; <strong><code> session.get_schema('cookbook').</code></strong> ↩
 <strong><code>get_table('patients').count()</code></strong>
1000
 MySQL  cookbook  Py &gt; <strong><code> session.get_schema('cookbook').</code></strong> ↩
<strong><code>get_table('patients').select().limit(10)</code></strong>
+----+-------------+----------+------------+--------+-----+-----------------+....
| id | national_id | name     | surname    | gender | age | additional_data | ...
+----+-------------+----------+------------+--------+-----+-----------------+....
|  1 | 74LM282144  | May      | NESSELRODE | F      |  83 | NULL            | ...
|  2 | 44PR883357  | Kathryn  | DAKROUB    | F      |  44 | NULL            | ...
|  3 | 60JP130066  | Owen     | CIELINSKI  | M      |  47 | NULL            | ...
|  4 | 28ST588095  | Diana    | KILAR      | F      |  35 | NULL            | ...
|  5 | 77RP202627  | Beryl    | ANGIONE    | F      |  43 | NULL            | ...
|  6 | 27MU569536  | Brian    | HOUDEK     | M      |  84 | NULL            | ...
|  7 | 94AG787006  | Fredrick | WOHLMAN    | M      |  20 | NULL            | ...
|  8 | 42BX974594  | Jarrod   | DECAPUA    | M      |  64 | NULL            | ...
|  9 | 63XJ322387  | Ruth     | PAHUJA     | F      |  16 | NULL            | ...
| 10 | 91AT797455  | Frances  | VANBRUGGEN | F      |  63 | NULL            | ...
+----+-------------+----------+------------+--------+-----+-----------------+....

+----+.....+-------------------------+--------+--------------+---------------+
| id | ... | diagnosis               | result | date_arrived | date_departed |
+----+.....+-------------------------+--------+--------------+---------------+
|  1 | ... | Data Phobia             | D      | 2020-03-20   | 2020-04-26    |
|  2 | ... | Data Phobia             | R      | 2020-03-20   | 2020-05-09    |
|  3 | ... | Pneumonia               | R      | 2020-04-05   | 2020-04-23    |
|  4 | ... | Acute coronary syndrome | R      | 2020-04-18   | 2020-05-01    |
|  5 | ... | Pneumonia               | R      | 2020-01-31   | 2020-02-07    |
|  6 | ... | Acute coronary syndrome | D      | 2020-01-25   | 2020-03-06    |
|  7 | ... | Data Phobia             | R      | 2020-08-10   | 2020-09-04    |
|  8 | ... | Pneumonia               | R      | 2020-02-12   | 2020-03-31    |
|  9 | ... | Pneumonia               | N      | 2020-11-17   | 2020-12-19    |
| 10 | ... | Sepsis                  | R      | 2020-12-11   | 2020-12-29    |
+----+.....+-------------------------+--------+--------------+---------------+
10 rows in set (0.0004 sec)</pre><p>
              </p></dd></dl><p>
          We can also store this function in a file and re-use it later. We will discuss re-using user code in <a data-type="xref" href="#nch-mysqlshell-mysqlshell-reuse">Recipe 2.17</a>.
        </p><p>
          You will find code of the function <span class="command"><em>generate_patients_data</em></span> in file <em class="filename">mysql_shell/generate_patients_data.py</em> of the <code>recipes</code> distribution.
        </p></div></section></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820407189040"><h2>See Also</h2><p>For additional information about Python module <code>pandas</code>, see <a href="https://pandas.pydata.org/pandas-docs/stable/index.html">pandas documentation</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="2.17 Reusing Your Scripts for MySQL Shell"><div class="sect1" id="nch-mysqlshell-mysqlshell-reuse"><h1>2.17 Reusing Your Scripts for MySQL Shell</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820411272960"><h2>Problem</h2><p>
        You wrote code for MySQL Shell and want to re-use it later.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820411271984"><h2>Solution</h2><p>
        Store your work, and later load the files using the command <span class="command"><em>\source</em></span>.  Or, set up the files as startup scripts. 
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820411270192"><h2>Discussion</h2><p>
        MySQL Shell allows to re-use your code. You can do it either by using command <span class="command"><em>\source</em></span> or by setting your scripts to be executed at startup. Let’s examine each of these possibilities in detail.
      </p><p>
        The command <span class="command"><em>\source</em></span> is available for each of modes and works similarly to the command <span class="command"><em>\source</em></span> of <span class="command"><em>mysql</em></span> client. The only difference is that your source files should be written in the same language as the selected mode.
      </p><p>
        For example, to load the object <code>CookbookCollection</code> that we discussed in <a data-type="xref" href="#nch-mysqlshell-mysqlshell-javascript">Recipe 2.15</a>, we can type this command:
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>\source /cookbook/recipes/mysql_shell/CookbookCollection.js</code></strong>
 MySQL  cookbook  JS &gt; <strong><code>CookbookCollection</code></strong>
{
    "collection": null, 
    "find": &lt;Function:find&gt;, 
    "remove": &lt;Function:remove&gt;, 
    "save": &lt;Function:save&gt;
}</pre><p>
        As you see, it immediately becomes available for use.
      </p><p>
        Similarly you can import the definition of the function <span class="command"><em>generate_patients_data</em></span> that we discussed in <a data-type="xref" href="#nch-mysqlshell-mysqlshell-python">Recipe 2.16</a>:
        </p><pre data-type="programlisting"> MySQL  cookbook  Py &gt; <strong><code>\source /cookbook/recipes/mysql_shell/generate_patients_data.py</code></strong></pre><p>
      </p><p>
        Or, in SQL mode, we can load any SQL file:
        </p><pre data-type="programlisting"> MySQL  cookbook  SQL &gt; <strong><code>\source /cookbook/recipes/tables/patients.sql</code></strong>
Query OK, 0 rows affected (0.0003 sec)
Query OK, 0 rows affected (0.0202 sec)
Query OK, 0 rows affected (0.0001 sec)
Query OK, 0 rows affected (0.0334 sec)
Query OK, 0 rows affected (0.0001 sec)
Query OK, 20 rows affected (0.0083 sec)

Records: 20  Duplicates: 0  Warnings: 0</pre><p>
      </p><p>
        If you want to execute scripts at startup you need to edit file <code>mysqlshrc.js</code> for JavaScript mode and <code>mysqlshrc.py</code> for Python mode, located in one of the locations that MySQL Shell uses to search for the startup scripts. These can be located in any of the following:
        </p><ul><li><p>
            The global configuration file, located in <code>/etc/mysql/mysqlsh/mysqlshrc.[js|py]</code> on Unix, or <code> %PROGRAMDATA%\MySQL\mysqlsh\mysqlshrc.[js|py]</code> on Windows.
          </p></li><li><p>
            Your personal configuration file, located either under <code>$HOME/.mysqlsh/mysqlshrc.[js|py]</code> on Unix, or under <code> %APPDATA%\MySQL\mysqlsh\mysqlshrc.[js|py]</code> on Windows. Alternatively you can specify the variable <code>MYSQLSH_USER_CONFIG_HOME</code> and store file <code>mysqlshrc.[js|py]</code> under it.
          </p></li><li><p>
            The <code>share/mysqlsh</code> directory, located either under MySQL Shell installation root or specified by the variable <code>MYSQLSH_HOME</code>.
          </p></li></ul><p>
      </p><p>
        Format of the <code>mysqlshrc.[js|py]</code> is the same as for the corresponding modes. Thus, to pre-load the <code>CookbookCollection</code> object, you need to convert <code>CookbookCollection.js</code> into a module by exporting our object <code>CookbookCollection</code>:
        </p><pre data-type="programlisting">exports.CookbookCollection = { 
  // Collection where the object is stored
  collection: null, 
  ...</pre><p>
        Then you need to put two lines in the file <code>mysqlshrc.js</code>:
        </p><pre data-type="programlisting">sys.path = [...sys.path, '/cookbook/recipes/mysql_shell'];
const cookbook=require('CookbookCollectionModule.js')</pre><p>
        In the first line we added a directory where our modules are located into the modules search path. On the second line we imported the module itself. Object <code>CookbookCollection</code> is available as a property of the global object <code>cookbook</code>.
        </p><pre data-type="programlisting"> MySQL  cookbook  JS &gt; <strong><code>cookbook</code></strong>
{
    "CookbookCollection": {
        "collection": null, 
        "find": &lt;Function:find&gt;, 
        "remove": &lt;Function:remove&gt;, 
        "save": &lt;Function:save&gt;
    }
}</pre><p>
      </p><div data-type="tip"><h6>Tip</h6><p>
          MySQL Shell uses Node.js modules. Use <a href="https://nodejs.org/api/modules.html"> Node.js documentation</a> to find details about how to write and use JavaScript modules in MySQL Shell.
        </p></div><p>
        <em class="filename">CookbookCollectionModule.js</em> is located in the <em class="filename">mysql_shell</em> directory of the <code>recipes</code> distribution.
      </p><p>
        To import the Python function <code>generate_patients_data</code> in the startup script we need to add instruction <span class="command"><em>import mysqlsh</em></span> to our Python file, because at the time when the module is loaded, global objects of the MySQL Shell are not yet available. We will also change the line
        </p><pre data-type="programlisting">patients=session.get_schema('cookbook').get_table('patients')</pre><p>
        to
        </p><pre data-type="programlisting">patients=mysqlsh.globals.session.get_schema('cookbook').get_table('patients')</pre><p>
        Otherwise Python will fail with an error that the name <code>session</code> is not yet defined.
      </p><p>
        We will name our module <code>cookbook.py</code> for brevity.
      </p><p>
        In our function we use local paths from the current directory to the files, therefore we will change the default search path to the directory that has all datasets in it. To do this we will import module <code>os</code> and use its method <code>chdir</code>. Then we simply import module <code>cookbook</code>. Resulting <code>mysqlshrc.py</code> will have this code.
        </p><pre data-type="programlisting">sys.path.append("/home/sveta/bin/python-3.7.7/lib/python3.7/site-packages")
sys.path.append("/cookbook/recipes/mysql_shell")

import os
os.chdir('/cookbook/recipes/datasets')
import cookbook</pre><p>
      </p><p>
        Module <em class="filename">cookbook.py</em> is located in the <em class="filename">mysql_shell</em> directory of the <code>recipes</code> distribution.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820411269728"><h2>See Also</h2><p>For additional information about customizing MySQL Shell with external scripts, see <a href="https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-customizing.html">Customizing MySQL Shell</a> in the MySQL User Reference Manual.</p></div></section></div></section></div></section></div></body></html>