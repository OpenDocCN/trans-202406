<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 16. Managing Local Name Services with Dnsmasq and the hosts File"><div class="chapter" id="cha-dns-dhcp">
<h1><span class="label">Chapter 16. </span>Managing Local Name Services with Dnsmasq and the hosts File</h1>


<p><a href="https://oreil.ly/MUa4U">Dnsmasq</a> is an <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="purpose of" id="dnsmasq-purpose"/><a data-type="indexterm" data-primary="name resolution" data-seealso="Dnsmasq" id="idm46466155554872"/>excellent server for
LAN name services, both<a data-type="indexterm" data-primary="Domain Name System" data-see="DNS" id="idm46466155552760"/> Domain Name System (DNS) and<a data-type="indexterm" data-primary="Dynamic Host Configuration Protocol" data-see="DHCP" id="idm46466155553384"/> Dynamic Host
Discovery Protocol (DHCP). Dnsmasq also provides BOOTP, PXE, and TFTP, which are for network booting and installing operating systems from a network server.
Dnsmasq supports IPv4 and IPv6, provides local DNS caching, and acts as a stub
resolver.</p>

<p>This chapter covers setting up local DNS and DHCP using
Dnsmasq and the <em>/etc/hosts</em> file together. <em>/etc/hosts</em> is the <a data-type="indexterm" data-primary="/etc/hosts file" data-secondary="purpose of" id="idm46466155550696"/>very old way of
setting up DNS, mapping hostnames to IP addresses in a static file. <em>/etc/hosts</em>
by itself is sufficient for very small networks.</p>

<p>Dnsmasq is designed for LAN name services. It is lightweight and simple to
configure, especially in comparison to BIND, the dominant DNS server, which
is heavyweight and has a rather steep learning curve.</p>

<p>Dnsmasq and <em>/etc/hosts</em> work great together. Dnsmasq reads the entries in
<em>/etc/hosts</em> into DNS.</p>

<p>The DHCP server in Dnsmasq automatically integrates with DNS.
All you need for Dnsmasq to create DNS entries for your DHCP clients is to
configure your DHCP clients to send their hostnames to the DHCP server, which is
the default in most Linux distributions.</p>

<p>There<a data-type="indexterm" data-primary="DNS (Domain Name System)" data-secondary="server types" id="dns-server-types"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DNS" data-tertiary="server types" id="nameres-dns-server-types"/> are four types of DNS servers: recursive resolvers, root name servers,
top-level domain (TLD) name servers, and authoritative name servers.</p>

<p>Recursive resolvers <a data-type="indexterm" data-primary="recursive resolvers" id="idm46466155540248"/>answer DNS requests. A stub resolver, like Dnsmasq and
systemd-resolved, forwards any requests it cannot answer from its cache to an
upstream resolver. When you visit a website a recursive resolver finds the site’s DNS information by querying the other three types of DNS servers. Recursive resolvers cache this information to make it available more quickly. Your ISP’s name servers, and services like
<a href="https://oreil.ly/oCRsV">OpenDNS</a>,
<a href="https://oreil.ly/9Fgqc">Cloudflare</a>, and
<a href="https://oreil.ly/lc9ep">Google Public DNS</a> are all
recursive resolvers.</p>

<p>There <a data-type="indexterm" data-primary="root name servers" id="idm46466155539352"/>are 13 types of root name servers, spread all over the planet, and there are
currently several hundred root name servers. A root server accepts a query from
a recursive resolver, then the root server directs the request to the appropriate<a data-type="indexterm" data-primary="top-level domain (TLD) name servers" id="idm46466155535608"/><a data-type="indexterm" data-primary="TLD (top-level domain) name servers" id="idm46466155535000"/>
TLD server according to the top-level domain: .com, .net, .org, .me, .biz, .int, .biz, .gov, .edu, and so on. The Internet Corporation for Assigned Names and Numbers—<a href="https://icann.org">ICANN</a>—oversees all of these servers and domains.</p>

<p>Authoritative name servers <a data-type="indexterm" data-primary="authoritative name servers" id="idm46466155537256"/>are the source records for a domain and are
controlled by the owner of the domain. Dnsmasq can serve as your authoritative
name server, though I recommend using BIND. See the Authoritative Configuration
section of <em>man 8 dnsmasq</em> to learn<a data-type="indexterm" data-primary="DNS (Domain Name System)" data-secondary="server types" data-startref="dns-server-types" id="idm46466155536488"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DNS" data-tertiary="server types" data-startref="nameres-dns-server-types" id="idm46466155531464"/><a data-type="indexterm" data-primary="Dnsmasq" data-secondary="purpose of" data-startref="dnsmasq-purpose" id="idm46466155530136"/> more.</p>
<div data-type="note" epub:type="note"><h1>Too Many Name Service Utilities</h1>
<p>Linux<a data-type="indexterm" data-primary="NetworkManager" data-secondary="name resolution" id="idm46466155526376"/><a data-type="indexterm" data-primary="systemd-resolved" id="idm46466155525528"/><a data-type="indexterm" data-primary="resolvconf" id="idm46466155524920"/><a data-type="indexterm" data-primary="name resolution" data-secondary="Linux utilities for" id="idm46466155524312"/> distributions are still transitioning to NetworkManager
and <em>systemd-resolved</em> from the legacy <em>resolvconf</em>, which has long been the
default DNS resolver on Linux systems. This presents a bit of a tangle
for Linux users, with continual changes and the various distros making the
transition at different rates. Pay close attention to the documentation, forums,
and release notes for your particular Linux.</p>

<p>It should be possible to use Dnsmasq as the DNS backend for NetworkManager,
because NetworkManager has a plug-in for this. But on some Linux distributions,
this does not yet work correctly (<a data-type="xref" href="#rec-play-nice">Recipe 16.5</a>).</p>

<p>You don’t need systemd-resolved running on your Dnsmasq server because it will
contend with Dnsmasq for control of the system’s stub DNS resolver.</p>

<p>By the time you read this, all of this may be different, but for now the recipes
aim to be reliable rather than cutting edge.</p>
</div>






<section data-type="sect1" data-pdf-bookmark="16.1 Simple Name Resolution with /etc/hosts"><div class="sect1" id="idm46466155521416">
<h1>16.1 Simple Name Resolution with /etc/hosts</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155518136">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="name resolution" data-secondary="with /etc/hosts file" data-secondary-sortas="/etc/hosts file" id="nameres-etc-hosts"/><a data-type="indexterm" data-primary="/etc/hosts file" data-secondary="name resolution with" id="etc-hosts-nameres"/> want a simple, fast way to set up name resolution without having to run a
DNS server.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155514040">
<h2>Solution</h2>

<p>This is what the <em>/etc/hosts</em> file is made for. Your LAN computers must have
static IP addresses. The following is an example for three computers:</p>

<pre data-type="programlisting">127.0.0.1 localhost
::1 localhost ip6-localhost ip6-loopback
192.168.43.81 host1
192.168.43.82 host2
192.168.43.83 host3</pre>

<p>Copy these entries to all three hosts, then try pinging each other by hostnames,
like this example for pinging <em>host2</em> from <em>host3</em>:</p>
<pre>host3:~$ <strong>ping -c2 host2</strong>
PING host2 (192.168.43.82) 56(84) bytes of data.
64 bytes from host2 (192.168.43.82): icmp_seq=1 ttl=64 time=3.00 ms
64 bytes from host2 (192.168.43.82): icmp_seq=2 ttl=64 time=3.81 ms

--- host2 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 3.001/3.403/3.806/0.402 ms
</pre>

<p><em>/etc/hosts</em> also manages domain names, so you can give your LAN a cool domain.
In the following examples, that is <em>sqr3l.nut</em>. First enter the IP address, then
the fully qualified domain name (FQDN), then the hostname:</p>

<pre data-type="programlisting">127.0.0.1 localhost
::1 localhost ip6-localhost ip6-loopback
192.168.43.81 host1.sqr3l.nut host1
192.168.43.82 host2.sqr3l.nut host2
192.168.43.83 host3.sqr3l.nut host3</pre>

<p>Now your hosts can connect to each other with their hostnames, like <em>host1</em>,
or their FQDNs, like <em>host1.sqr3l.nut</em>.</p>
<div data-type="note" epub:type="note"><h1>Shared and Individual Hosts Entries</h1>
<p>You can have both shared and private entries in <em>/etc/hosts</em>. Anything you want
shared must be copied to all the relevant hosts. Anything else in your hosts file
that is not copied to other hosts will work only for you. See
<a data-type="xref" href="#rec-hosts-blocking">Recipe 16.2</a> to learn more.</p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155501304">
<h2>Discussion</h2>

<p><em>127.0.0.1 localhost</em> and <em>::1 localhost ip6-localhost ip6-loopback</em> are
required. Yours might look a little different, but however they are written, do
not delete them. They are assigned to the<a data-type="indexterm" data-primary="loopback devices" id="loopback"/> loopback device, a special
virtual network interface that your Linux system uses to communicate with itself.</p>

<p class="pagebreak-before less_space">You can ping them and use them to connect to local servers.
For example, when you use the CUPS web administration page, you are using the loopback
device. Enter <em>127.0.0.1:631</em> or <em>localhost:631</em> to open it (<a data-type="xref" href="#fig-dnsmasq-2">Figure 16-1</a>).</p>

<figure><div id="fig-dnsmasq-2" class="figure">
<img src="Images/lcb2_1601.png" alt="Opening a local web page with the loopback device" width="585" height="160"/>
<h6><span class="label">Figure 16-1. </span>Opening a local web page with the loopback device</h6>
</div></figure>

<p>The virtual network interface for the loopback device is <em>lo</em>. Use <a data-type="indexterm" data-primary="ip command" id="idm46466155491720"/>the <em>ip</em>
command to 
<span class="keep-together">see it:</span></p>
<pre>$ <strong>ip addr show dev lo</strong>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group
  default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever</pre>

<p>Your system does not need a physical network interface for the loopback device

<span class="keep-together">to work.</span></p>

<p>Use the <em>hostname</em> command<a data-type="indexterm" data-primary="hostname command" id="idm46466155487976"/> to confirm that your configuration is correct. Check
the hostname of your computer:</p>
<pre>$ <strong>hostname</strong>
host1
</pre>

<p>Check the FQDN:</p>
<pre>$ <strong>hostname -f</strong>
host1.sqr3l.nut
</pre>

<p>Check the domain name:</p>
<pre>$ <strong>hostname -d</strong>
sqr3l.nut
</pre>

<p><em>/etc/hosts</em> does not scale well, but for small networks it may be all you ever
need for your local<a data-type="indexterm" data-primary="loopback devices" data-startref="loopback" id="idm46466155479944"/><a data-type="indexterm" data-primary="name resolution" data-secondary="with /etc/hosts file" data-secondary-sortas="/etc/hosts file" data-startref="nameres-etc-hosts" id="idm46466155479208"/><a data-type="indexterm" data-primary="/etc/hosts file" data-secondary="name resolution with" data-startref="etc-hosts-nameres" id="idm46466155477720"/> DNS.</p>
</div></section>













<section data-type="sect2" class="pagebreak-before less_space" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155480904">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 5 hosts</em></p>
</li>
<li>
<p><em>man 8 ping</em></p>
</li>
<li>
<p><a data-type="xref" href="#rec-hosts-blocking">Recipe 16.2</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.2 Using /etc/hosts for Testing and Blocking Annoyances"><div class="sect1" id="rec-hosts-blocking">
<h1>16.2 Using /etc/hosts for Testing and Blocking Annoyances</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155470824">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="/etc/hosts file" data-secondary="testing/blocking sites" id="etc-hosts-test-block"/><a data-type="indexterm" data-primary="testing" data-secondary="sites with /etc/hosts file" id="test-site-etc-hosts"/><a data-type="indexterm" data-primary="blocking" data-secondary="sites with /etc/hosts file" id="block-site-etc-hosts"/>are working on development servers, and you want to manage their DNS without
hassles. Or, you want a simple way to block annoying sites.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155465272">
<h2>Solution</h2>

<p>Suppose the name of a dev server you are working on is <em>dev.stashcat.com</em>.
Make an entry for it your <em>/etc/hosts</em> file:</p>
<pre><i>192.168.10.15 dev.stashcat.com</i></pre>

<p>You don’t have to bother your network admin or mess with your DNS server, but can
create and remove entries in <em>/etc/hosts</em> as you need.</p>

<p>Another fun trick is to map annoying websites to bogus IP addresses:</p>
<pre><i>12.34.56.78  badsite.com</i>
<i>12.34.56.78  www.badsite.com</i></pre>

<p>This makes the site unreachable from your computer. Most how-tos use the loopback
address, 127.0.0.1, and it works, but I prefer to keep the annoying sites separate.
You can use the same fake IP address for multiple annoying sites.</p>

<p>If your web browser still reaches the site after adding it to <em>/etc/hosts</em>,
clear your browser cache and try again.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155458024">
<h2>Discussion</h2>

<p>When you <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="/etc/hosts on" id="idm46466155455928"/><a data-type="indexterm" data-primary="/etc/hosts file" data-secondary="on Dnsmasq servers" data-secondary-sortas="Dnsmasq servers" id="idm46466155455416"/>run a LAN Dnsmasq server, keep in mind that all entries in <em>/etc/hosts</em>
on the Dnsmasq server will be applied to all Dnsmasq clients, so don’t put your
name server on your development computer.</p>

<p class="pagebreak-before less_space">Linux has a number of DNS managers, and <em>/etc/hosts</em> is read first. The order is
set in the <em>/etc/nsswitch.conf</em> file on the <em>hosts</em> line. The following example
is from Ubuntu 20.04:</p>

<pre data-type="programlisting">hosts: files mdns4_minimal [NOTFOUND=return] dns mymachines</pre>

<p><em>files</em> is <em>/etc/hosts</em>.</p>

<p><em>mdns4_minimal</em> uses the Avahi autodiscovery service to locate network services.</p>

<p><em>[NOTFOUND=return]</em> means that if <em>mdns4_minimal</em> is working but the requested host is not found, the DNS lookup should stop and return an error. If the <em>mdns4_minimal</em> service is not found, continue the lookup.</p>

<p><em>dns</em> uses any available DNS server.</p>

<p><em>mymachines</em> refers to the <em>systemd-machined</em> service, which tracks local
virtual machines and containers.</p>

<p>You should put <em>files dns</em> first on your Dnsmasq <a data-type="indexterm" data-primary="/etc/hosts file" data-secondary="testing/blocking sites" data-startref="etc-hosts-test-block" id="idm46466155443224"/><a data-type="indexterm" data-primary="testing" data-secondary="sites with /etc/hosts file" data-startref="test-site-etc-hosts" id="idm46466155442248"/><a data-type="indexterm" data-primary="blocking" data-secondary="sites with /etc/hosts file" data-startref="block-site-etc-hosts" id="idm46466155441160"/>server.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155456920">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 5 hosts</em></p>
</li>
<li>
<p><em>man 5 nsswitch.conf</em></p>
</li>
<li>
<p><em>man 8 systemd-machined.service</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.3 Finding All DNS and DHCP Servers on Your Network"><div class="sect1" id="idm46466155481464">
<h1>16.3 Finding All DNS and DHCP Servers on Your Network</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155433592">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="name resolution" data-secondary="DNS" data-tertiary="finding servers" id="nameres-dns-find"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="finding servers" id="nameres-dhcp-find"/><a data-type="indexterm" data-primary="DNS (Domain Name System)" data-secondary="finding servers" id="dns-server-find"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="finding servers" id="dhcp-find"/><a data-type="indexterm" data-primary="finding" data-secondary="DNS and DHCP servers" id="find-dns-dhcp"/><a data-type="indexterm" data-primary="nmap command" id="nmap"/><a data-type="indexterm" data-primary="port scanning" id="portscan"/> want to know if there are any DNS and DHCP servers on your LAN, other than
your Dnsmasq server.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155422664">
<h2>Solution</h2>

<p>Probe your LAN with <em>nmap</em>. The following example searches the local network
for all open TCP ports and finds an open TCP port 53, which is used by DNS.
This is indicated by “53/tcp open domain”:</p>
<pre>$ <strong>sudo nmap --open <i>192.168.1.0/24</i></strong>
Starting Nmap 7.70 ( https://nmap.org ) at 2021-05-23 13:25 PDT
[...]
Nmap scan report for dns-server.sqr3l.nut (192.168.1.10)
Host is up (0.12s latency).
Not shown: 998 filtered ports
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT   STATE SERVICE
22/tcp open  ssh
53/tcp open  domain
[...]

Nmap done: 256 IP addresses (3 hosts up) scanned in 81.38 seconds</pre>

<p>By default, <em>nmap</em> only looks for TCP ports. DNS servers listen to TCP and UDP
53, and DHCP listens on UDP 67. The following example looks only for ports UDP 53
and 67:</p>
<pre>$ <strong>sudo nmap -sU -p 53,67 <i>192.168.1.0/24</i></strong>
Starting Nmap 7.80 ( https://nmap.org ) at 2021-05-27 18:05 PDT

Nmap scan report for dns-server.sqr3l.nut (192.168.1.10)
Host is up (0.085s latency).

PORT   STATE         SERVICE
53/udp open          domain
67/udp open|filtered dhcps

Nmap done: 256 IP addresses (3 hosts up) scanned in 13.85 seconds
</pre>

<p><em>nmap</em> found one DNS/DHCP server, on dns-server.sqr3l.nut.</p>

<p>The following command searches for all open TCP and UDP ports on the network:</p>
<pre>$ <strong>sudo nmap -sU -sT <i>192.168.1.0/24</i></strong></pre>

<p>This takes several minutes to complete, and then you have a list of the active
services on all up hosts in your network, including any services running on
nonstandard ports.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155413560">
<h2>Discussion</h2>

<p>Be very careful with port scanning, and use it only on networks that you have
permission for. Port scanning other networks is often treated as a hostile act,
like you are probing for vulnerabilities to exploit.</p>

<p>Multiple name servers can cause conflicts, and in any case it is good to know
if your users are running any servers.</p>

<p>On most Linux systems, the package to install <a data-type="indexterm" data-primary="name resolution" data-secondary="DNS" data-tertiary="finding servers" data-startref="nameres-dns-find" id="idm46466155410040"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="finding servers" data-startref="nameres-dhcp-find" id="idm46466155411512"/><a data-type="indexterm" data-primary="DNS (Domain Name System)" data-secondary="finding servers" data-startref="dns-server-find" id="idm46466155407352"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="finding servers" data-startref="dhcp-find" id="idm46466155406168"/><a data-type="indexterm" data-primary="finding" data-secondary="DNS and DHCP servers" data-startref="find-dns-dhcp" id="idm46466155404952"/><a data-type="indexterm" data-primary="nmap command" data-startref="nmap" id="idm46466155403704"/><a data-type="indexterm" data-primary="port scanning" data-startref="portscan" id="idm46466155402728"/>is <em>nmap</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See also"><div class="sect2" id="idm46466155409432">
<h2>See also</h2>

<ul>
<li>
<p><em>man 1 nmap</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.4 Installing Dnsmasq"><div class="sect1" id="idm46466155398520">
<h1>16.4 Installing Dnsmasq</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155397592">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="Dnsmasq" data-secondary="installing" id="dnsmasq-install"/><a data-type="indexterm" data-primary="installing" data-secondary="Dnsmasq" id="install-dnsmasq"/> want to install Dnsmasq and take care of any prerequisites.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155393960">
<h2>Solution</h2>

<p>Install the <em>dnsmasq</em> package. In this recipe the Dnsmasq server is named
<em>dns-server</em>. You will use both Dnsmasq and the <em>/etc/hosts</em> file to configure
your DNS server.</p>

<p>After installation, stop Dnsmasq if it is running:</p>
<pre>$ <strong>systemctl status dnsmasq.service</strong>
● dnsmasq.service - dnsmasq - A lightweight DHCP and caching DNS server
     Loaded: loaded (/lib/systemd/system/dnsmasq.service; enabled; vendor
     preset: enabled)
     Active: active (running) since Mon 2021-05-24 05:49:36 PDT; 6h ago
[...]
$ <strong>sudo systemctl stop dnsmasq.service</strong>
</pre>

<p>Give your Dnsmasq server a static IP address, if it does not already have one.
Do this with NetworkManager’s graphical control panel
(<em>nm-connection-editor</em>), or with <a data-type="indexterm" data-primary="nmcli command" id="idm46466155387448"/>the <em>nmcli</em> command.</p>

<p>The following example uses <em>nmcli</em> to find  your active connections:</p>
<pre>$ <strong>nmcli connection show --active</strong>
NAME       UUID                     TYPE      DEVICE
<i>1local</i>     3e348c97-4c5f-4bbf-967e  wifi      <i>wlan1</i>
<i>1wired</i>     0460d735-e14d-3c3f-92c0  ethernet  <i>eth1</i></pre>

<p>Then assign the static IP address you want your DNS server to use, using the
NAME to identify the correct connection:</p>
<pre>$ <strong>nmcli con mod "<i>1wired</i>" \</strong>
  ipv4.addresses "<i>192.168.1.30/24</i>" \
  ipv4.gateway "<i>192.168.1.1</i>" \
  ipv4.method "manual"</pre>

<p>Then restart NetworkManager:</p>
<pre>$ <strong>sudo systemctl restart NetworkManager.service</strong>
</pre>

<p>Next, check if your Linux is running <em>systemd-resolved.service</em>:</p>
<pre>$ <strong>systemctl status systemd-resolved.service</strong></pre>

<p>If it is, see <a data-type="xref" href="#rec-play-nice">Recipe 16.5</a> before configuring Dnsmasq, and also to learn
how to configure NetworkManager on your Dnsmasq server.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155393496">
<h2>Discussion</h2>

<p>systemd is<a data-type="indexterm" data-primary="systemd" data-secondary="Dnsmasq installation" id="idm46466155373416"/> implemented differently amongst the various Linuxes. For example,
openSUSE Leap 15.2 does not use the <em>systemd-resolved.service</em>, so you should
not have to make any systemd changes to enable Dnsmasq to control your LAN DNS.
Fedora 33 and up, and Ubuntu 17.04 and up, run <em>systemd-resolved.service</em>, and it
should be disabled on your Dnsmasq <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="installing" data-startref="dnsmasq-install" id="idm46466155370824"/><a data-type="indexterm" data-primary="installing" data-secondary="Dnsmasq" data-startref="install-dnsmasq" id="idm46466155369496"/>server.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155371320">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="#rec-play-nice">Recipe 16.5</a></p>
</li>
<li>
<p><a href="https://oreil.ly/vvfHg">Dnsmasq</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.5 Making systemd-resolved and NetworkManager Play Nice with Dnsmasq"><div class="sect1" id="rec-play-nice">
<h1>16.5 Making systemd-resolved and NetworkManager Play Nice with Dnsmasq</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155363096">
<h2>Problem</h2>

<p><em>systemd-resolved</em> and<a data-type="indexterm" data-primary="Dnsmasq" data-secondary="systemd-resolved and NetworkManager conflicts" id="dnsmasq-conflict"/><a data-type="indexterm" data-primary="systemd-resolved" id="systemd-resolved-conflict"/><a data-type="indexterm" data-primary="NetworkManager" data-secondary="Dnsmasq conflicts" id="networkmanager-conflict"/><a data-type="indexterm" data-primary="resolving Dnsmasq conflicts" id="resolve-dnsmasq-conflict"/><a data-type="indexterm" data-primary="troubleshooting" data-secondary="Dnsmasq conflicts" id="troubleshoot-dnsmasq-conflict"/> NetworkManager are conflicting with Dnsmasq, and you want
them out of the way.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155355032">
<h2>Solution</h2>

<p>Check if the <em>systemd-resolved.service</em> is running:</p>
<pre>$ <strong>systemctl status systemd-resolved.service</strong>

● systemd-resolved.service - Network Name Resolution
     Loaded: loaded (/usr/lib/systemd/system/systemd-resolved.service; enabled;
     vendor preset: enabled)
     Active: active (running) since Sat 2021-05-22 12:57:34 PDT; 1min 21s ago
[...]</pre>

<p>That shows that it is running. <em>systemd-resolved.service</em> is fine for providing
a stub DNS resolver for client machines, but not DNS servers. Disable it:</p>
<pre>$ <strong>sudo systemctl stop systemd-resolved.service</strong>
$ <strong>sudo systemctl disable systemd-resolved.service</strong></pre>

<p>Then look at <em>/etc/resolv.conf</em>, which should be a symlink:</p>
<pre>$ <strong>ls -l /etc/resolv.conf</strong>
lrwxrwxrwx 1 root root 39 May 21 20:38 /etc/resolv.conf -&gt;
   ../run/systemd/resolve/stub-resolv.conf
</pre>

<p>When it is a symlink, it is managed by <em>systemd-resolved.service</em>. To remove
control from <em>systemd-resolved.service</em>, delete the symlink and create a plain-text file with the same name:</p>
<pre>$ <strong>sudo rm /etc/resolv.conf</strong>
$ <strong>sudo touch /etc/resolv.conf</strong>
</pre>

<p>Now that <em>/etc/resolv.conf</em> is a file and not a symlink, it is managed by
NetworkManager. Open your NetworkManager configuration file and look for the
<em>[main]</em> section, then add or change the <em>dns=</em> value to <em>none</em>:</p>
<pre>$ <strong>sudo nano /etc/NetworkManager/NetworkManager.conf</strong>

[main]
dns=none</pre>

<p>Enter your Dnsmasq server’s IPv4 and IPv6 localhost addresses in
<em>/etc/resolv.conf</em> and your local domain, if you have one:</p>
<pre>search <i>sqr3l.nut</i>
nameserver 127.0.0.1
nameserver ::1</pre>

<p>Then reboot and configure your new Dnsmasq installation.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155354408">
<h2>Discussion</h2>

<p>NetworkManager and <em>systemd-resolved</em> are wonderful on client machines.
On your Dnsmasq server, you must have control of <em>/etc/resolv.conf</em>, and
Dnsmasq should be the only stub <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="systemd-resolved and NetworkManager conflicts" data-startref="dnsmasq-conflict" id="idm46466155336728"/><a data-type="indexterm" data-primary="systemd-resolved" data-startref="systemd-resolved-conflict" id="idm46466155335432"/><a data-type="indexterm" data-primary="NetworkManager" data-secondary="Dnsmasq conflicts" data-startref="networkmanager-conflict" id="idm46466155334584"/><a data-type="indexterm" data-primary="resolving Dnsmasq conflicts" data-startref="resolve-dnsmasq-conflict" id="idm46466155333336"/><a data-type="indexterm" data-primary="troubleshooting" data-secondary="Dnsmasq conflicts" data-startref="troubleshoot-dnsmasq-conflict" id="idm46466155332328"/>resolver.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155330648">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 systemd-resolved.service</em></p>
</li>
<li>
<p><em>man 8 networkmanager</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.6 Configuring Dnsmasq for LAN DNS"><div class="sect1" id="idm46466155327064">
<h1>16.6 Configuring Dnsmasq for LAN DNS</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155326168">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="configuring for LAN DNS" id="dnsmasq-configure-dns"/><a data-type="indexterm" data-primary="configuring" data-secondary="Dnsmasq for LAN DNS" id="configure-dnsmasq-dns"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DNS" data-tertiary="configuring Dnsmasq for" id="nameres-dns-configure"/><a data-type="indexterm" data-primary="DNS (Domain Name System)" data-secondary="configuring Dnsmasq for" id="dns-configure"/>want to set up Dnmasq as your LAN DNS server.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155319144">
<h2>Solution</h2>

<p>Any hosts that you enter in <em>/etc/hosts</em> need static IP addresses, and Dnsmasq
will automatically enter them into DNS. At a minimum, enter your Dnsmasq server.
The following example includes the Dnsmasq server, a backup server, and an internal
web server:</p>
<pre>127.0.0.1 localhost
::1 localhost ip6-localhost ip6-loopback
192.168.43.81 dns-server
192.168.43.82 backups
192.168.43.83 https
</pre>
<div data-type="tip"><h1>Configure Static Hosts from DHCP</h1>
<p>See <a data-type="xref" href="#rec-static-dnsmasq">Recipe 16.12</a> to learn how to manage static IP address assignments
from DHCP, instead of <em>/etc/hosts</em>.</p>
</div>

<p>Now it is time to configure Dnsmasq. Rename the default configuration file so you
can start with a new empty file, and use the original as a reference:</p>
<pre>$ <strong>sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf-old</strong>
$ <strong>sudo nano /etc/dnsmasq.conf</strong>
</pre>

<p>Copy the following configuration, replacing the second <em>listen-address</em> with your
own server’s IP address, and use your own domain name. The upstream name servers are OpenDNS, and you may use whatever upstream
name servers you wish. Dnsmasq looks for <em>/etc/resolv.conf</em> by default, but it
doesn’t hurt to be explicit:</p>
<pre># global options
resolv-file=/etc/resolv.conf
domain-needed
bogus-priv
expand-hosts
domain=<i>sqr3l.nut</i>
local=/<i>sqr3l.nut</i>/
listen-address=127.0.0.1
listen-address=<i>192.168.43.81</i>

# upstream name servers
server=<i>208.67.222.222</i>
server=<i>208.67.220.220</i>
</pre>

<p>Run Dnsmasq’s syntax checker:</p>
<pre>$ <strong>dnsmasq --test</strong>
dnsmasq: syntax check OK.
</pre>

<p>The syntax checker won’t find configuration errors, but only typos. Start up
Dnsmasq, and if there are errors it will not start. The following example shows
a successful start:</p>
<pre>$ <strong>sudo systemctl start dnsmasq.service</strong>
$ <strong>systemctl status dnsmasq.service</strong>
● dnsmasq.service - dnsmasq - A lightweight DHCP and caching DNS server
     Loaded: loaded (/lib/systemd/system/dnsmasq.service; enabled; vendor preset:
     enabled)
     Active: active (running) since Mon 2021-05-24 17:13:48 PDT; 1min 0s ago
    Process: 11023 ExecStartPre=/usr/sbin/dnsmasq --test (code=exited,
     status=0/SUCCESS)
    Process: 11024 ExecStart=/etc/init.d/dnsmasq systemd-exec (code=exited,
     status=0/SUCCESS)
    Process: 11033 ExecStartPost=/etc/init.d/dnsmasq systemd-start-resolvconf
     (code=exited, status=0/SUCCESS)
   Main PID: 11032 (dnsmasq)
      Tasks: 1 (limit: 18759)
     Memory: 2.5M
     CGroup: /system.slice/dnsmasq.service
             └─11032 /usr/sbin/dnsmasq -x /run/dnsmasq/dnsmasq.pid -u dnsmasq -7
              /etc/dnsmasq.d,.dpkg-dist,.dpkg-old,.dpkg-new --local-&gt;

May 24 17:13:48 dns-server systemd[1]: Starting dnsmasq - A lightweight DHCP and
 caching DNS server...
May 24 17:13:48 dns-server dnsmasq[11023]: dnsmasq: syntax check OK.
May 24 17:13:48 dns-server systemd[1]: Started dnsmasq - A lightweight DHCP and
 caching DNS server.
</pre>

<p>Run some tests on your Dnsmasq server <a data-type="indexterm" data-primary="nslookup command" id="idm46466155300488"/>with <em>nslookup</em> using your server’s
hostname and FQDN:</p>
<pre>$ <strong>nslookup <i>dns-server</i></strong>
Server:         127.0.0.1
Address:        127.0.0.1#53

Name:   <i>dns-server</i>
Address: <i>192.168.43.81</i>

$ <strong>nslookup <i>dns-server.sqr3l.nut</i></strong>
Server:         127.0.0.1
Address:        127.0.0.1#53

Name:   <i>dns-server.sqr3l.nut</i>
Address: <i>192.168.43.81</i>

$ <strong>nslookup <i>192.168.43.81</i></strong>
<i>18.43.168.192</i>.in-addr.arpa       name = <i>host1.sqr3l.nut.</i>
</pre>

<p>Use the <em>ss</em> command <a data-type="indexterm" data-primary="ss command" id="idm46466155292184"/>to verify the listening ports. In the following example, the 
<span class="keep-together">Recv-Q</span>, Send-Q, and Peer Address:Port columns have been removed for clarity:</p>
<pre>$ <strong>sudo ss -lp "sport = :domain"</strong>
Netid  State   Local Address:Port    Process
udp    UNCONN     127.0.0.1:domain   users:(("dnsmasq",pid=1531,fd=8))
udp    UNCONN  <i>192.168.1.10</i>:domain   users:(("dnsmasq",pid=1531,fd=6))
tcp    LISTEN     127.0.0.1:domain   users:(("dnsmasq",pid=1531,fd=9))
tcp    LISTEN  <i>192.168.1.10</i>:domain   users:(("dnsmasq",pid=1531,fd=7))
</pre>

<p>You should see your server address, localhost address, and only <em>dnsmasq</em> in the
Process column. Add the <em>-r</em> option to see hostnames instead of IP addresses.</p>

<p>When all of these commands succeed, your configuration is correct.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155293544">
<h2>Discussion</h2>

<p>If Dnsmasq fails to start, run <em>journalctl -ru dnsmasq</em> to see why. (If your
Dnsmasq logs are sent somewhere else, then look there; see
<a data-type="xref" href="#rec-dnsmasq-logging">Recipe 16.14</a>.)</p>

<p><em>nslookup</em> is in the <em>bindutils</em> package.</p>

<p><em>ss</em>, socket statistics, is in the <em>iproute2</em> package.</p>

<p>If your <em>nslookup</em> commands fail, try restarting networking, and then
restarting Dnsmasq. If they still fail, reboot. If this doesn’t fix it,
recheck all your 
<span class="keep-together">configurations</span>.</p>

<p><em>domain-needed</em> prevents Dnsmasq from forwarding queries for your plain
hostnames to upstream nameservers. If the name is not known from <em>/etc/hosts</em> or
DHCP, then a “not found” answer is returned. This keeps requests for your LAN
addresses from leaking out into the world and possibly being answered incorrectly
if your LAN domain is the same as a public domain name.</p>

<p><em>bogus-priv</em> blocks bogus private reverse lookups. All reverse lookups for
private IP ranges which are not found in <em>/etc/hosts</em> or the DHCP leases file
are answered with “no such domain” rather than being forwarded upstream.</p>

<p><em>expand-hosts</em> automatically adds your private domain name to the plain hostnames
in <em>/etc/hosts</em>.</p>

<p><em>domain=</em> is your local domain name.</p>

<p><em>local=/[domain]/</em> tells Dnsmasq to resolve queries for the local domain directly,
and not forward them <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="configuring for LAN DNS" data-startref="dnsmasq-configure-dns" id="idm46466155273800"/><a data-type="indexterm" data-primary="configuring" data-secondary="Dnsmasq for LAN DNS" data-startref="configure-dnsmasq-dns" id="idm46466155272936"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DNS" data-tertiary="configuring Dnsmasq for" data-startref="nameres-dns-configure" id="idm46466155271848"/><a data-type="indexterm" data-primary="DNS (Domain Name System)" data-secondary="configuring Dnsmasq for" data-startref="dns-configure" id="idm46466155270520"/>upstream.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155287720">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 5 hosts</em></p>
</li>
<li>
<p><a href="https://oreil.ly/vvfHg">Dnsmasq</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.7 Configuring firewalld to Allow DNS and DHCP"><div class="sect1" id="idm46466155266248">
<h1>16.7 Configuring firewalld to Allow DNS and DHCP</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155265272">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="firewalld" data-secondary="configuring for DNS and DHCP" id="idm46466155263672"/><a data-type="indexterm" data-primary="configuring" data-secondary="firewalld" data-tertiary="for DNS and DHCP" id="idm46466155262824"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DNS" data-tertiary="configuring firewalld for" id="idm46466155261736"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="configuring firewalld for" id="idm46466155260648"/><a data-type="indexterm" data-primary="DNS (Domain Name System)" data-secondary="configuring firewalld for" id="idm46466155259464"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="configuring firewalld for" id="idm46466155258456"/> need to open your Dnsmasq server’s firewall to allow your LAN clients access

<span class="keep-together">to it.</span></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155255640">
<h2>Solution</h2>

<p>Open TCP and UDP ports 53 for DNS, and UDP 67 for DHCP. If you are running
<em>firewalld</em>, use this command:</p>
<pre>$ <strong>sudo firewall-cmd --permanent --add-service=\{dns,dhcp\}</strong>
</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155252920">
<h2>Discussion</h2>

<p>One of the first things to check, when you have connectivity problems, is
firewall 
<span class="keep-together">settings</span>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155250920">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="ch14.xhtml#cha-firewalld">Chapter 14</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.8 Testing Your Dnsmasq Server from a Client Machine"><div class="sect1" id="rec-test-connect-dns">
<h1>16.8 Testing Your Dnsmasq Server from a Client Machine</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155246312">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="testing from client machine" id="dnsmasq-test"/><a data-type="indexterm" data-primary="testing" data-secondary="Dnsmasq from client machine" id="test-dnsmasq"/><a data-type="indexterm" data-primary="clients" data-secondary="testing Dnsmasq from" id="client-test-dnsmasq"/><a data-type="indexterm" data-primary="dig command" id="dig"/>want to test your nice new Dnsmasq DNS server from a client computer.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155239576">
<h2>Solution</h2>

<p>Use the <em>dig</em> command from any host on your network to query any website,
via the IP address for your Dnsmasq server:</p>
<pre>$ <strong>dig @<i>192.168.1.10</i> oreilly.com</strong>

; &lt;&lt;&gt;&gt; DiG 9.16.6 &lt;&lt;&gt;&gt; @<i>192.168.1.10</i> oreilly.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 29387
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;oreilly.com.                   IN      A

;; ANSWER SECTION:
oreilly.com.            240     IN      A       199.27.145.65
oreilly.com.            240     IN      A       199.27.145.64

;; Query time: 108 msec
;; SERVER: <i>192.168.1.10</i>#53(<i>192.168.1.10</i>)
;; WHEN: Mon May 24 17:49:32 PDT 2021
;; MSG SIZE  rcvd: 72</pre>

<p>That is a successful test, confirmed by “status: NOERROR” and the SERVER line
showing the IP address of your Dnsmasq server.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155233096">
<h2>Discussion</h2>

<p>You can also test using your server’s hostname and fully qualified domain <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="testing from client machine" data-startref="dnsmasq-test" id="idm46466155230408"/><a data-type="indexterm" data-primary="testing" data-secondary="Dnsmasq from client machine" data-startref="test-dnsmasq" id="idm46466155229432"/><a data-type="indexterm" data-primary="clients" data-secondary="testing Dnsmasq from" data-startref="client-test-dnsmasq" id="idm46466155228344"/><a data-type="indexterm" data-primary="dig command" data-startref="dig" id="idm46466155227224"/>name
(FQDN):</p>
<pre>$ <strong>dig @<i>dns-server</i> oreilly.com</strong>
$ <strong>dig @<i>dns-server.sqr3l.nut</i> oreilly.com</strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155223928">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 1 dig</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.9 Managing DHCP with Dnsmasq"><div class="sect1" id="rec-manage-dhcp">
<h1>16.9 Managing DHCP with Dnsmasq</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155220360">
<h2>Problem</h2>

<p>Your<a data-type="indexterm" data-primary="Dnsmasq" data-secondary="DHCP" data-tertiary="configuring" id="dnsmasq-dhcp-configure"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="configuring" id="nameres-dhcp-configure"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="configuring" id="dhcp-configure"/><a data-type="indexterm" data-primary="configuring" data-secondary="DHCP" id="configure-dhcp"/> DNS is working, and now you want to set up DHCP.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155213736">
<h2>Solution</h2>

<p>No problem. Add these lines to your <em>/etc/dnsmasq.conf</em> file to define a single
pool of addresses, substituting your own desired addressing:</p>
<pre># DHCP range
dhcp-range=<i>192.168.1.25,192.168.1.75,12h</i>
dhcp-lease-max=<i>25</i>
</pre>

<p>Restart Dnsmasq:</p>
<pre>$ <strong>sudo systemctl restart dnsmasq.service</strong>
</pre>

<p>Try getting<a data-type="indexterm" data-primary="nmcli command" id="idm46466155207640"/> an address on a LAN computer. First, make sure it is configured to
get its IP address via DHCP:</p>
<pre>$ <strong>nmcli con show --active</strong>
NAME    UUID                     TYPE     DEVICE
<i>1net</i>    de7c00e7-8e4d-45e6-acaf  ethernet eth0

$ <strong>nmcli con show <i>1net</i> | grep ipv..method</strong>
ipv4.method:           auto
ipv6.method:           auto
</pre>

<p><em>auto</em> confirms it is a DHCP client. (If it says <em>manual</em> then it is not.) Bring
the interface down, then back up again:</p>
<pre>$ <strong>sudo nmcli con down <i>1net</i></strong>
Connection '1net' successfully deactivated (D-Bus active path: /org/freedesktop/
NetworkManager/ActiveConnection/11

$ <strong>sudo nmcli con up <i>1net</i></strong>
Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkMan
ager/ActiveConnection/15)</pre>

<p>Check your Dnsmasq server logs:</p>
<pre>$ <strong>journalctl -ru dnsmasq</strong>
-- Logs begin at Sun 2021-02-28 14:35:01 PST, end at Mon 2021-05-31 17:36:04
 PDT. --
May 31 17:34:56 dns-server dnsmasq-dhcp[8080]: DHCPACK(eth0) 192.168.1.45
 9c:ef:d5:fe:01:7c client2
May 31 17:34:56 dns-server dnsmasq-dhcp[8080]: DHCPREQUEST(eth0) 192.168.1.45
9c:ef:d5:fe:01:7c</pre>

<p>That shows a successful IP address assignment from <em>dns-server</em> to <em>client2</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155198264">
<h2>Discussion</h2>

<p>You can<a data-type="indexterm" data-primary="NetworkManager" data-secondary="configuring DHCP" id="networkmanager-dhcp-config"/> use the NetworkManager panel applet instead of <em>nmcli</em>, or run the
<em>nm-connection-editor</em> command to open NetworkManager’s graphical configurator,
then disconnect and connect with a mouse click (<a data-type="xref" href="#fig-dnsmasq-4">Figure 16-2</a>).</p>

<p>Most Linux distributions use NetworkManager to control client DHCP. If yours does not, it probably <a data-type="indexterm" data-primary="dhclient command" id="idm46466155191000"/>uses <em>dhclient</em>. Look for a <em>dhclient.conf</em> configuration file, if this exists, then request a new lease with the <em>dhclient</em> command:</p>
<pre>$ <strong>sudo dhclient -v</strong>
Internet Systems Consortium DHCP Client 4.3.6-P1
Copyright 2004-2018 Internet Systems Consortium.
All rights reserved.
For info, please visit https://www.isc.org/software/dhcp/

Listening on LPF/<i>eth0/9c:ef:d5:fe:01:7c</i>
Sending on   LPF/<i>eth0/9c:ef:d5:fe:01:7c</i>
Sending on   Socket/fallback
DHCPREQUEST on <i>eth0</i> to 255.255.255.255 port 67 (xid=0xec8923)
DHCPACK from <i>192.168.1.10</i> (xid=0xec8923)
bound to <i>192.168.1.27</i> -- renewal in 1415 seconds.
</pre>

<p>You can send, over DHCP, some of the information your client machines need to
access network services. See <a data-type="xref" href="#rec-advertise">Recipe 16.10</a> to learn more.</p>

<figure class="width-40"><div id="fig-dnsmasq-4" class="figure">
<img src="Images/lcb2_1602.png" alt="Managing network connections with nm-connection-editor" width="298" height="421"/>
<h6><span class="label">Figure 16-2. </span>Managing network connections with nm-connection-editor</h6>
</div></figure>

<p><em>dhcp-range=192.168.1.25,192.168.10.75,24h</em> defines a range of 50
available address leases, with a lease time of 24 hours. This range must not
include your Dnsmasq server, nor any hosts with static IP addresses. Define the
lease time in seconds, minutes, or hours. The default is one hour, and the
minimum is two minutes. If you want leases that never expire, don’t specify a
lease time.</p>

<p><em>dhcp-lease-max=25</em> defines how many leases can be active at one time. You
can have a large address pool available, and then limit the number of <a data-type="indexterm" data-primary="NetworkManager" data-secondary="configuring DHCP" data-startref="networkmanager-dhcp-config" id="idm46466155180872"/><a data-type="indexterm" data-primary="Dnsmasq" data-secondary="DHCP" data-tertiary="configuring" data-startref="dnsmasq-dhcp-configure" id="idm46466155182504"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="configuring" data-startref="nameres-dhcp-configure" id="idm46466155179672"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="configuring" data-startref="dhcp-configure" id="idm46466155178152"/><a data-type="indexterm" data-primary="configuring" data-secondary="DHCP" data-startref="configure-dhcp" id="idm46466155176872"/>active
leases.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155174296">
<h2>See Also</h2>

<ul>
<li>
<p><a data-type="xref" href="#rec-advertise">Recipe 16.10</a></p>
</li>
<li>
<p><a href="https://oreil.ly/vvfHg">Dnsmasq</a></p>
</li>
<li>
<p><em>man 8 dhclient</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.10 Advertising Important Services over DHCP"><div class="sect1" id="rec-advertise">
<h1>16.10 Advertising Important Services over DHCP</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155186008">
<h2>Problem</h2>

<p>You<a data-type="indexterm" data-primary="Dnsmasq" data-secondary="DHCP" data-tertiary="advertising services" id="dnsmasq-dhcp-advertise"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="advertising services" id="nameres-dhcp-advertise"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="advertising services" id="dhcp-advertise"/><a data-type="indexterm" data-primary="advertising services over DHCP" id="advertise-dhcp"/><a data-type="indexterm" data-primary="services" data-secondary="advertising over DHCP" id="service-advertise"/> want to advertise various servers to your LAN clients over DHCP.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155159240">
<h2>Solution</h2>

<p>Some services, like the default route to your internet gateway, DNS
server, and NTP server, can be advertised to your LAN clients so that they
automatically use them. The following examples show how to configure
<em>/etc/dnsmasq.conf</em> to advertise some 
<span class="keep-together">services</span>.</p>

<p>Set the default router:</p>
<pre>dhcp-option=3,<i>192.168.1.1</i></pre>

<p>Advertise your DNS server:</p>
<pre>dhcp-option=6,<i>192.168.1.10</i></pre>

<p>This example points the way to your local NTP server:</p>
<pre>dhcp-option=42,<i>192.168.1.11</i></pre>

<p>How do you know which numbers to use? Use this command to list all of them:</p>
<pre>$ <strong>dnsmasq --help dhcp</strong>
Known DHCP options:
  1 netmask
  2 time-offset
  3 router
  6 dns-server
  7 log-server
  9 lpr-server
  [...]
</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155158824">
<h2>Discussion</h2>

<p><em>dnsmasq --help dhcp</em> displays the known DHCPv4 configuration options. See the
Discussion in <a data-type="xref" href="#rec-dhcp-zones">Recipe 16.11</a> for more information on the DHCPv4 configuration
<a data-type="indexterm" data-primary="Dnsmasq" data-secondary="DHCP" data-tertiary="advertising services" data-startref="dnsmasq-dhcp-advertise" id="idm46466155147944"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="advertising services" data-startref="nameres-dhcp-advertise" id="idm46466155146616"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="advertising services" data-startref="dhcp-advertise" id="idm46466155145160"/><a data-type="indexterm" data-primary="advertising services over DHCP" data-startref="advertise-dhcp" id="idm46466155143944"/><a data-type="indexterm" data-primary="services" data-secondary="advertising over DHCP" data-startref="service-advertise" id="idm46466155142904"/>options.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155141464">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/vvfHg">Dnsmasq</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.11 Creating DHCP Zones for Subnets"><div class="sect1" id="rec-dhcp-zones">
<h1>16.11 Creating DHCP Zones for Subnets</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155137608">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="DHCP" data-tertiary="subnet zones" id="dnsmasq-dhcp-subnet-zone"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="subnet zones" id="nameres-dhcp-subnet"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="subnet zones" id="dhcp-subnet"/><a data-type="indexterm" data-primary="subnet zones (DHCP)" id="subnet-zone"/>have two subnets, and you want  to configure Dnsmasq to apply different
options to them, such as different default routers and servers.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155130504">
<h2>Solution</h2>

<p>Define your zones with whatever names you want to give them, like <em>zone1</em> and
<em>zone2</em>, and set their address ranges:</p>
<pre>dhcp-range=<i>zone1,192.168.50.20,192.168.50.120</i>
dhcp-range=<i>zone2,192.168.60.20,192.168.60.50,24h</i>
</pre>

<p>The two zones have different routers:</p>
<pre>dhcp-option=<i>zone1,3,192.168.50.1</i>
dhcp-option=<i>zone2,3,192.168.60.2</i>
</pre>

<p>They use the same DNS server:</p>
<pre>dhcp-option=<i>zone1,6,192.168.1.10</i>
dhcp-option=<i>zone2,6,192.168.1.10</i></pre>

<p><em>zone2</em> gets an NTP server:</p>
<pre>dhcp-option=<i>zone2,42,192.168.60.15</i>
</pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155120744">
<h2>Discussion</h2>

<p>Only a few of the DHCP options are useful. They are very old, and some are
mysterious, for example:</p>
<blockquote>
<p>option default-url string;</p>

<p>The format and meaning of this option is not described in any standards
document, but is claimed to be in use by Apple Computer. It is not known what
clients may reasonably do if supplied with this option. Use at your own risk.</p>
<p data-type="attribution">man 5 DHCP options</p>
</blockquote>

<p>Client support is inconsistent for many of them. The only ones I use are NTP,
routers, and <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="DHCP" data-tertiary="subnet zones" data-startref="dnsmasq-dhcp-subnet-zone" id="idm46466155115288"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="subnet zones" data-startref="nameres-dhcp-subnet" id="idm46466155114168"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="subnet zones" data-startref="dhcp-subnet" id="idm46466155113400"/><a data-type="indexterm" data-primary="subnet zones (DHCP)" data-startref="subnet-zone" id="idm46466155112760"/>DNS servers.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155111240">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 5 dhcp</em></p>
</li>
<li>
<p><a href="https://oreil.ly/vvfHg">Dnsmasq</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.12 Assigning Static IP Addresses from DHCP"><div class="sect1" id="rec-static-dnsmasq">
<h1>16.12 Assigning Static IP Addresses from DHCP</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155106168">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="DHCP" data-tertiary="static IP addresses" id="idm46466155104680"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="static IP addresses" id="idm46466155103592"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="static IP addresses" id="idm46466155102504"/><a data-type="indexterm" data-primary="static IP addresses, assigning via DHCP" id="idm46466155101432"/>want to centralize IP addressing as much as possible, including assigning
static IP addresses.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155100360">
<h2>Solution</h2>

<p>Use the <em>dhcp-host</em> option in <em>/etc/dnsmasq.conf</em>. Identify the client
machine by its hostname, and assign an unused address from your LAN’s address block.
(It is not necessary to use the DHCP address range you defined with the
<em>_dhcp-range=</em>* option in <em>/etc/dnsmasq.conf</em> for static addresses.) The following
example assigns an address to <em>server2</em> in the 192.168.3.0/24 network:</p>
<pre>dhcp-host=<i>server2,192.168.3.45</i></pre>

<p>Restart Dnsmasq, then the next time <em>server2</em> requests an address it will
receive the address specified by the <em>dhcp-host=</em> option.</p>

<p>Use multiple <em>dhcp-host=</em> lines to configure multiple clients, one per line.</p>

<p>You may use the client’s MAC address in place of the hostname.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155099896">
<h2>Discussion</h2>

<p>In general, centralizing administration chores saves time and headaches.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155090664">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/vvfHg">Dnsmasq</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.13 Configuring DHCP Clients for Automatic DNS Entries"><div class="sect1" id="rec-send-hostname">
<h1>16.13 Configuring DHCP Clients for Automatic DNS Entries</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155086344">
<h2>Problem</h2>

<p>You <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="DHCP" data-tertiary="automatic DNS entries" id="dnsmasq-dhcp-auto-entries"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="automatic DNS entries" id="nameres-dhcp-auto-entries"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="automatic DNS entries" id="dhcp-auto-entries"/><a data-type="indexterm" data-primary="DNS (Domain Name System)" data-secondary="automatic entries for DHCP clients" id="dns-auto-entries"/><a data-type="indexterm" data-primary="automatic DHCP DNS entries" id="auto-dhcp-entries"/>want your DHCP clients to be entered into DNS automatically by Dnsmasq.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155077832">
<h2>Solution</h2>

<p>The only thing the clients have to do is send their hostnames to Dnsmasq’s DHCP
server, which is the default in most Linuxes.</p>

<p>Suppose a DHCP client on the local <em>sqr3l.nut</em> domain has the host name
<em>client4</em>. <em>client4</em> starts up, and receives its IP address and other network
information from Dnsmasq. Dnsmasq receives <em>client4</em>’s hostname and enters it
into DNS. Now other hosts on the network can access <em>client4</em> and
<em>client4.sqr3l.nut</em>.</p>

<p>There must not be any duplicate entries for <em>client4</em> in <em>/etc/hosts</em>.</p>

<p>There are three different ways to check your DHCP client configuration: in <em>dhclient.conf</em>, NetworkManager’s graphical configuration tool
(<em>nm-connection-editor</em>), and with the <em>nmcli</em> command.</p>

<p>First check <em>dhclient</em>, which has been the default DHCP client on Linux
for years. On most Linux systems its configuration file is
<em>/etc/dhcp/dhclient.conf</em>. Look for this line, which automatically finds
the system’s hostname and sends it to the DHCP server:</p>

<pre data-type="programlisting">send host-name = gethostname();</pre>

<p>Or a line like this, specifying the system’s hostname:</p>
<pre>send host-name = <i>myhostname</i></pre>

<p>If there is no <em>dhclient.conf</em> file, then NetworkManager is your DHCP client
manager. You can check this in your graphical <em>nm-connection-editor</em>
(<a data-type="xref" href="#fig-dnsmasq-3">Figure 16-3</a>).</p>

<figure><div id="fig-dnsmasq-3" class="figure">
<img src="Images/lcb2_1603.png" alt="NetworkManager sends client hostname to DHCP server" width="509" height="193"/>
<h6><span class="label">Figure 16-3. </span>NetworkManager sends client hostname to DHCP server</h6>
</div></figure>

<p>When the connection method is “Automatic (DHCP),” NetworkManager sends the
hostname to the DHCP server. “Automatic (addresses only)” does not send the
hostname to the DHCP server, but only provides DNS to the client.</p>

<p>You may also use<a data-type="indexterm" data-primary="nmcli command" id="idm46466155060840"/> the <em>nmcli</em> command. First, find your active network connection:</p>
<pre>$ <strong>nmcli connection show --active</strong>
NAME    UUID                                  TYPE      DEVICE
<i>wifi1   3e348c97-4c5f-4bbf-967e-7624f3e1e4f0</i>  wifi      <i>wlan1</i></pre>

<p>Then verify that it sends the hostname to your DHCP server. The following
example confirms that it does:</p>
<pre>$ <strong>nmcli connection show <i>wifi1</i> | grep send-hostname</strong>
ipv4.dhcp-send-hostname:                yes
ipv6.dhcp-send-hostname:                yes</pre>

<p>If it says <em>no</em>, run the following commands to set it to <em>yes</em>. After that, reload the 
<span class="keep-together">configuration</span>:</p>
<pre>$ <strong>sudo nmcli con mod <i>wifi1</i> ipv4.dhcp-send-hostname yes</strong>
$ <strong>sudo nmcli con mod <i>wifi1</i> ipv6.dhcp-send-hostname yes</strong>
$ <strong>sudo nmcli con reload</strong></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155050488">
<h2>Discussion</h2>

<p>If you prefer a graphical tool to manage NetworkManager, it’s best to use
NetworkManager’s <a data-type="indexterm" data-primary="NetworkManager" data-secondary="nm-connection-editor" id="idm46466155049048"/><a data-type="indexterm" data-primary="nm-connection-editor" id="idm46466155046568"/>graphical configuration utility, <em>nm-connection-editor</em>, rather
than a different graphical tool, such as the network module in the GNOME control
panel. The <em>nm-connection-editor</em> offers the most complete configuration
options, and it is the same on all Linux <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="DHCP" data-tertiary="automatic DNS entries" data-startref="dnsmasq-dhcp-auto-entries" id="idm46466155045512"/><a data-type="indexterm" data-primary="name resolution" data-secondary="DHCP" data-tertiary="automatic DNS entries" data-startref="nameres-dhcp-auto-entries" id="idm46466155043976"/><a data-type="indexterm" data-primary="DHCP (Domain Name Configuration Protocol)" data-secondary="automatic DNS entries" data-startref="dhcp-auto-entries" id="idm46466155042552"/><a data-type="indexterm" data-primary="DNS (Domain Name System)" data-secondary="automatic entries for DHCP clients" data-startref="dns-auto-entries" id="idm46466155041208"/><a data-type="indexterm" data-primary="automatic DHCP DNS entries" data-startref="auto-dhcp-entries" id="idm46466155039928"/>distros.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155038696">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 1 nmcli</em></p>
</li>
<li>
<p><em>man 1 nmcli-examples</em></p>
</li>
<li>
<p><em>man 5 nm-settings</em></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.14 Managing Dnsmasq Logging"><div class="sect1" id="rec-dnsmasq-logging">
<h1>16.14 Managing Dnsmasq Logging</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155033336">
<h2>Problem</h2>

<p>Dnsmasq <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="logging" id="dnsmasq-logging"/><a data-type="indexterm" data-primary="logging" data-secondary="in Dnsmasq" data-secondary-sortas="Dnsmasq" id="logging-dnsmasq"/><a data-type="indexterm" data-primary="configuring" data-secondary="logging in Dnsmasq" id="configure-logging-dnsmasq"/>has the option to send its messages to a file of your choice using the
legacy <em>syslog</em> daemon, rather than to <em>journalctl</em>, and you want to know which is
the best option.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466155026536">
<h2>Solution</h2>

<p>It does not matter which one you use: the same information is logged either way.
The default behavior is to log to the systemd journal.</p>

<p>It can be convenient to isolate Dnsmasq logs in their own directory, such as
<em>/var/log/dnsmasq/dnsmasq.log</em>. Use the <em>log-facility=</em> option in
<em>/etc/dnsmasq.conf</em> to specify the log file you want to use, then restart
Dnsmasq. The file must already exist or Dnsmasq will not start.</p>

<p>Your logfile will grow very large unless you set up log rotation. The
following example configuration, <em>/etc/logrotate.d/dnsmasq</em>, sets up a simple
weekly rotation:</p>

<pre data-type="programlisting">/var/log/dnsmasq/dnsmasq.log {
    missingok
    compress
    notifempty
    rotate 4
    weekly
    create
    }</pre>

<p class="pagebreak-before less_space">Test it with<a data-type="indexterm" data-primary="logrotate command" id="idm46466155020472"/> the <em>logrotate</em> command:</p>
<pre>$ <strong>sudo /etc/logrotate.conf --debug</strong>
[...]
rotating pattern: /var/log/dnsmasq/dnssmasq.log  weekly (4 rotations)
empty log files are not rotated, old logs are removed
switching euid to 0 and egid to 4
considering log /var/log/dnsmasq/dnssmasq.log
Creating new state
  Now: 2021-06-01 13:08
  Last rotated at 2021-06-01 13:00
  log does not need rotating (log has been already rotated)
switching euid to 0 and egid to 0
[...]</pre>

<p>This shows no errors and it is working correctly.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466155017400">
<h2>Discussion</h2>

<p>systemd supports both <em>journalctl</em> and the <em>syslog</em> daemon. They will probably
exist together for a long time, so you can set up logging in whatever way <a data-type="indexterm" data-primary="Dnsmasq" data-secondary="logging" data-startref="dnsmasq-logging" id="idm46466155013080"/><a data-type="indexterm" data-primary="logging" data-secondary="in Dnsmasq" data-secondary-sortas="Dnsmasq" data-startref="logging-dnsmasq" id="idm46466155012440"/><a data-type="indexterm" data-primary="configuring" data-secondary="logging in Dnsmasq" data-startref="configure-logging-dnsmasq" id="idm46466155011672"/>you
prefer.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466155010328">
<h2>See Also</h2>

<ul>
<li>
<p><em>man 8 rsyslog</em></p>
</li>
<li>
<p><a href="https://oreil.ly/vvfHg">Dnsmasq</a></p>
</li>
<li>
<p><em>man 1 journalctl</em></p>
</li>
<li>
<p><a data-type="xref" href="ch20.xhtml#cha-trouble">Chapter 20</a></p>
</li>
</ul>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="16.15 Configuring Wildcard Domains"><div class="sect1" id="idm46466155003976">
<h1>16.15 Configuring Wildcard Domains</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm46466155003080">
<h2>Problem</h2>

<p>You want to<a data-type="indexterm" data-primary="Dnsmasq" data-secondary="wildcard domains" id="idm46466155001464"/><a data-type="indexterm" data-primary="wildcard domains in Dnsmasq" id="idm46466155000728"/><a data-type="indexterm" data-primary="configuring" data-secondary="wildcard domains in Dnsmasq" id="idm46466155000024"/> create a wildcard domain in Dnsmasq, so that requests for the domain’s
subdomains resolve without manually adding the subdomains to your DNS.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm46466154998632">
<h2>Solution</h2>

<p>Use the <em>address</em> option in <em>/etc/dnsmasq.conf</em> to create the top-level
domain (TLD):</p>
<pre>address=/<i>wildcard.net/192.168.1.35</i></pre>

<p>Restart Dnsmasq, then<a data-type="indexterm" data-primary="nslookup command" id="idm46466154994744"/> run <em>nslookup</em> to test:</p>
<pre>$ <strong>sudo systemctl restart dnsmasq.service</strong>
$ <strong>nslookup <i>foo.wildcard.net</i></strong>
Server:         127.0.0.1
Address:        127.0.0.1#53

Name:   <i>foo.wildcard.net</i>
Address: 192.168.1.35</pre>

<p><em>foo.wildcard.net</em> resolves, showing that it works.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm46466154990040">
<h2>Discussion</h2>

<p>Use DNS wildcards carefully. Wildcards are useful when you’re doing development
work on complex services such as Kubernetes. Make sure to use address ranges that
are different from the ranges on your LAN’s name server, and are available only
to LAN clients.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm46466154984920">
<h2>See Also</h2>

<ul>
<li>
<p><a href="https://oreil.ly/vvfHg">Dnsmasq</a></p>
</li>
</ul>
</div></section>





</div></section>







</div></section></div></body></html>