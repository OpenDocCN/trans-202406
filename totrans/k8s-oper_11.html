<html><head></head><body><section data-pdf-bookmark="Appendix A. Running an Operator as a Deployment Inside a Cluster" data-type="appendix" epub:type="appendix"><div class="appendix" id="appendix_operator_as_deployment">&#13;
<h1><span class="label">Appendix A. </span>Running an Operator as a <span class="keep-together">Deployment Inside a Cluster</span></h1>&#13;
&#13;
&#13;
<p>Running an Operator outside of the cluster, is convenient for testing and debugging purposes, but production Operators run as Kubernetes<a data-primary="deployment" data-secondary="running Operator as deployment in a cluster" data-type="indexterm" id="ix_depop"/><a data-primary="Operators" data-secondary="running as a Kubernetes deployment" data-type="indexterm" id="ix_Opsdepcl"/> deployments. There are a few extra steps involved for this deployment style:</p>&#13;
<ol>&#13;
<li>&#13;
<p><em>Build the image</em>. The Operator SDK’s <code>build</code> command chains to the underlying Docker daemon to build the Operator image, and takes <a data-primary="Operator SDK command" data-secondary="build" data-type="indexterm" id="idm45261327922200"/>the full image name and version when run:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>operator-sdk</code><code> </code><code>build</code><code> </code><code>jdob/visitors-operator:0.1</code></strong><code>&#13;
</code></pre>&#13;
</li>&#13;
<li>&#13;
<p><em>Configure the deployment.</em> Update the <em>deploy/operator.yaml</em> file that the SDK generates with the name of the image. The field to update is named <code>image</code> and can be found under:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">spec -&gt; template -&gt; spec -&gt; containers</pre>&#13;
&#13;
<p>The generated file defaults the value to <code>REPLACE_IMAGE</code>, which you should update to reflect the name of the image built in the previous command.</p>&#13;
&#13;
<p>Once built, push the image to an externally accessible repository such as <a href="https://quay.io">Quay.io</a> or <a href="https://hub.docker.com">Docker Hub</a>.</p>&#13;
</li>&#13;
<li>&#13;
<p><em>Deploy the CRD</em>. The SDK generates a skeleton CRD that will function correctly, but see <a data-type="xref" href="app02.html#appendix_crd_validation">Appendix B</a> for more information on fleshing out this file:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>deploy/crds/*_crd.yaml</code></strong><code>&#13;
</code></pre>&#13;
</li>&#13;
<li>&#13;
<p><em>Deploy the service account and role</em>. The SDK generates the service account and role required by the Operator. Update these to limit the permissions of the role to the minimum of what is needed for the Operator to function.</p>&#13;
&#13;
<p>Once you have scoped the role permissions appropriately, deploy the resources into the cluster:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>deploy/service_account.yaml</code></strong><code>&#13;
</code><code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>deploy/role.yaml</code></strong><code>&#13;
</code><code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>deploy/role_binding.yaml</code></strong><code>&#13;
</code></pre>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>You must deploy these files in the order listed, as the role binding requires both the role and the service account to be in place.</p>&#13;
</div>&#13;
</li>&#13;
<li>&#13;
<p><em>Create the Operator deployment</em>. The last step is to deploy the Operator itself. You can use the previously edited <em>operator.yaml</em> file to deploy the Operator image into<a data-primary="deployment" data-secondary="running Operator as deployment in a cluster" data-startref="ix_depop" data-type="indexterm" id="idm45261327817288"/><a data-primary="Operators" data-secondary="running as a Kubernetes deployment" data-startref="ix_Opsdepcl" data-type="indexterm" id="idm45261327816184"/> the cluster:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>deploy/operator.yaml</code></strong><code>&#13;
</code></pre>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section></body></html>