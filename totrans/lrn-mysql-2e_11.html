<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Configuring and Tuning the Server"><div class="chapter" id="CH11_CONFIGURE_TUNE">
<h1><span class="label">Chapter 11. </span>Configuring and Tuning the Server</h1>


<p>The MySQL installation process (see <a data-type="xref" href="ch01.xhtml#CH1_INSTALL">Chapter 1</a>) provides everything necessary to install the MySQL process and start using it. However, it is required for production systems to do some fine-tuning, adjusting MySQL parameters and the operating system to optimize MySQL Server’s performance. This chapter will cover the recommended best practices for different installations and show you the parameters that need to be adjusted based on the expected or current workload. As you’ll see, it is not necessary to memorize all the MySQL parameters. Based on the <a href="https://oreil.ly/1d58s"><em>Pareto principle</em></a>, which states that, for many events, roughly 80% of the effects come from 20% of the causes, we will concentrate on the MySQL and operating system parameters that are responsible for most of the performance issues. There are some advanced topics in this chapter related to computer architecture (such as NUMA); the intent here is to introduce you to a few components that can affect MySQL performance that you will need to interact with sooner or later in your career.</p>






<section data-type="sect1" data-pdf-bookmark="The MySQL Server Daemon"><div class="sect1" id="CH11_CONFIGURE_DAEMON_EXPLANATION">
<h1>The MySQL Server Daemon</h1>

<p>Since 2015, the majority of Linux distributions have adopted <code>systemd</code>. <a data-type="indexterm" data-primary="tuning MySQL Server" data-secondary="mysqld" id="idm46177451437528"/><a data-type="indexterm" data-primary="mysqld (daemon)" data-secondary="about" id="idm46177451436552"/><a data-type="indexterm" data-primary="server tuning" data-see="tuning MySQL Server" id="idm46177451435576"/><a data-type="indexterm" data-primary="MySQL" data-secondary="tuning the server" data-see="tuning MySQL Server" id="idm46177451434632"/>Because of that, Linux operating systems do not use the <code>mysqld_safe</code> process to start MySQL anymore. <code>mysqld_safe</code> is called an <em>angel process</em>, because it adds some safety features, such as restarting the server when an error occurs and logging runtime information to the MySQL error log. For operating systems that use <code>systemd</code> (controlled and configured with the <code>systemctl</code> command), these functionalities have been incorporated into <code>systemd</code> and the <code>mysqld</code> process.</p>

<p><code>mysqld</code> is the core process of MySQL Server. It is a single multithreaded program that does most of the work in the server. It does not spawn additional processes—we’re talking about a single process with multiple threads, making <a data-type="indexterm" data-primary="multithreaded process definition" id="idm46177451429304"/><a data-type="indexterm" data-primary="MySQL" data-secondary="multithreaded process" id="idm46177451428584"/>MySQL a <em>multithreaded process</em>.</p>

<p>Let’s take a closer look at some of those terms. A <em>program</em> is code<a data-type="indexterm" data-primary="program definition" id="idm46177451426232"/> that is designed to accomplish a specific objective. There are many types of programs, including ones to assist parts of the operating system and others that are designed for user needs, such as web browsing.</p>

<p>A <em>process</em> is what we call a program that has been loaded into<a data-type="indexterm" data-primary="process definition" id="idm46177451424248"/> memory along with all the resources it needs to operate. The operating system allocates memory and other resources for it.</p>

<p>A <em>thread</em> is the unit of execution within a process. A process<a data-type="indexterm" data-primary="thread" data-secondary="definition" id="idm46177451422376"/> can have just one thread or many threads. In single-threaded processes, the process contains one thread, so only one command is executed at a time.</p>

<p>Because modern CPUs have multiple cores, they can execute multiple threads at the same time, so multithreaded processes are widespread nowadays. It’s important to be aware of this concept to understand some of the proposed settings in the following sections.</p>

<p>To conclude, MySQL is single-process software that spawns multiple threads for various purposes, such as serving user activities and executing background tasks.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="MySQL Server Variables"><div class="sect1" id="idm46177451419736">
<h1>MySQL Server Variables</h1>

<p>MySQL Server has many variables that allow tuning its operation.<a data-type="indexterm" data-primary="tuning MySQL Server" data-secondary="server variables" id="idm46177451418232"/><a data-type="indexterm" data-primary="system variables" data-secondary="server variables" id="idm46177451417176"/><a data-type="indexterm" data-primary="variables" data-secondary="server variables" id="idm46177451416232"/><a data-type="indexterm" data-primary="server variables" id="idm46177451415288"/> For example, MySQL Server 8.0.25 has an impressive <em>588</em> server variables!</p>

<p>Each system variable has a default value. Also, we can adjust most system variables dynamically (or “on the fly”); <a data-type="indexterm" data-primary="system variables" data-secondary="server variables" data-tertiary="static" id="idm46177451413464"/><a data-type="indexterm" data-primary="my.cnf configuration file" data-secondary="static server variables" id="idm46177451412216"/><a data-type="indexterm" data-primary="static server variables" id="idm46177451411304"/>however, a few of them are static, which means that we need to change the <em>my.cnf</em> file and restart the MySQL process so they can take effect (as discussed in <a data-type="xref" href="ch09.xhtml#CH9_OPTIONS_FILE">Chapter 9</a>).</p>

<p>The system variables can have two different scopes: <code>SESSION</code> and <code>GLOBAL</code>.<a data-type="indexterm" data-primary="system variables" data-secondary="SESSION and GLOBAL scopes" id="idm46177451407720"/><a data-type="indexterm" data-primary="SESSION scope of system variables" id="idm46177451406744"/><a data-type="indexterm" data-primary="GLOBAL scope of system variables" id="idm46177451406056"/><a data-type="indexterm" data-primary="scope of system variables" id="idm46177451405368"/> That is, a system variable can have a global value that affects server operation as a whole, like the <code>innodb_log_file_size</code>, or a session value that affects only a specific session, like the <code>sql_mode</code>.</p>








<section data-type="sect2" data-pdf-bookmark="Checking Server Settings"><div class="sect2" id="idm46177451403560">
<h2>Checking Server Settings</h2>

<p>Databases are not static entities; on the contrary, their workload<a data-type="indexterm" data-primary="tuning MySQL Server" data-secondary="checking server settings" id="idm46177451402088"/><a data-type="indexterm" data-primary="SHOW" data-secondary="VARIABLES" data-tertiary="GLOBAL|SESSION VARIABLES" id="idm46177451400968"/> is dynamic and changes over time, with a tendency to growth. This organic behavior requires constant monitoring, analysis, and adjustment. The command to show the MySQL settings is:</p>

<pre data-type="programlisting">SHOW [GLOBAL|SESSION] VARIABLES;</pre>

<p>When you use the <code>GLOBAL</code> modifier, the statement displays global system variable values. When you use <code>SESSION</code>, it displays the system variable values that affect the current connection. Observe that different connections can have different values.</p>

<p>If no modifier is present, the default is <code>SESSION</code>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Best Practices"><div class="sect2" id="idm46177451396296">
<h2>Best Practices</h2>

<p>There are many aspects to optimize in a database. If the<a data-type="indexterm" data-primary="bare metal database hosts" id="idm46177451394760"/><a data-type="indexterm" data-primary="virtualized database hosting" data-see="cloud databases" id="idm46177451393960"/><a data-type="indexterm" data-primary="cloud databases" data-secondary="resource control limited" id="idm46177451393000"/><a data-type="indexterm" data-primary="managed databases in cloud" data-see="cloud databases" id="idm46177451392040"/><a data-type="indexterm" data-primary="tuning MySQL Server" data-secondary="cloud database tuning limitations" id="idm46177451391080"/> database runs on <em>bare metal</em> (a physical host), we can control hardware and operating system resources. When we move to virtualized machines, we have reduced control over these resources because we can’t control what happens with the underlying host. The last option is managed databases in the cloud, like those provided by Amazon Relational Database Service (RDS), where only a few database settings are available. There’s a trade-off between being able to perform fine-grained tuning to extract the most performance and the comfort of having most of the tasks automated (at the cost of a few extra dollars).</p>

<p>Let’s start by reviewing some settings at the operating system level. After that, we will check out the MySQL parameters.</p>










<section data-type="sect3" data-pdf-bookmark="Operating system best practices"><div class="sect3" id="opbest">
<h3>Operating system best practices</h3>

<p>There are several operating system settings that can affect the performance of MySQL. We’ll run through some of the most important ones here.<a data-type="indexterm" data-primary="tuning MySQL Server" data-secondary="best practices" data-tertiary="operating system" id="ch11-bpos"/><a data-type="indexterm" data-primary="operating systems" data-secondary="best practices" id="ch11-bpos2"/><a data-type="indexterm" data-primary="best practices" data-secondary="operating system" id="ch11-bpos3"/></p>












<section data-type="sect4" data-pdf-bookmark="The swappiness setting and swap usage"><div class="sect4" id="idm46177451382296">
<h4>The swappiness setting and swap usage</h4>

<p>The <code>swappiness</code> parameter controls the behavior of the Linux<a data-type="indexterm" data-primary="swappiness server parameter" id="idm46177451380136"/> operating system in the swap area. Swapping is the process of transferring data between memory and the disk. This can have a significant effect on performance, because disk access (even with NVMe disks) is at least an order of magnitude slower than memory access.</p>

<p>The default setting (<code>60</code>) encourages the server to swap. You will want your MySQL server to keep swapping to a minimum for performance reasons. The recommended value is <code>1</code>, which means do not swap until it is absolutely necessary for the OS to be functional. To adjust this parameter, execute the following command as root:</p>

<pre data-type="programlisting"># <strong>echo 1 &gt; /proc/sys/vm/swappiness</strong></pre>

<p>Note that this is a nonpersistent change; the setting will revert to its original value when you reboot the OS. To make this change persistent after an operating system reboot, adjust the setting in <em>sysctl.conf</em>:<a data-type="indexterm" data-primary="sysctl.conf swappiness parameter" id="idm46177451375352"/></p>

<pre data-type="programlisting"># <strong>sudo sysctl -w vm.swappiness=1</strong></pre>

<p class="pagebreak-before">You can get information on swap space usage using the following command:</p>

<pre data-type="programlisting"># <strong>free -m</strong></pre>

<p>Or, if you want more detailed information, you can run the following snippet in the shell:</p>

<pre data-type="programlisting" data-code-language="shell"><code class="c">#!/bin/bash</code>
<code class="nv">SUM</code><code class="o">=</code>0
<code class="nv">OVERALL</code><code class="o">=</code>0
<code class="k">for</code> DIR in <code class="sb">`</code>find /proc/ -maxdepth <code class="m">1</code> -type d <code class="p">|</code> egrep <code class="s2">"^/proc/[0-9]"</code><code class="sb">`</code> <code class="p">;</code> <code class="k">do</code>
        <code class="nv">PID</code><code class="o">=</code><code class="sb">`</code><code class="nb">echo</code> <code class="nv">$DIR</code> <code class="p">|</code> cut -d / -f 3<code class="sb">`</code>
        <code class="nv">PROGNAME</code><code class="o">=</code><code class="sb">`</code>ps -p <code class="nv">$PID</code> -o comm --no-headers<code class="sb">`</code>
        <code class="k">for</code> SWAP in <code class="sb">`</code>grep Swap <code class="nv">$DIR</code>/smaps 2&gt;/dev/null<code class="p">|</code> awk <code class="s1">'{ print $2 }'</code><code class="sb">`</code>
        <code class="k">do</code>
                <code class="nb">let </code><code class="nv">SUM</code><code class="o">=</code><code class="nv">$SUM</code>+<code class="nv">$SWAP</code>
        <code class="k">done</code>
        <code class="nb">echo</code> <code class="s2">"PID=</code><code class="nv">$PID</code><code class="s2"> - Swap used: </code><code class="nv">$SUM</code><code class="s2"> - (</code><code class="nv">$PROGNAME</code><code class="s2"> )"</code>
        <code class="nb">let </code><code class="nv">OVERALL</code><code class="o">=</code><code class="nv">$OVERALL</code>+<code class="nv">$SUM</code>
        <code class="nv">SUM</code><code class="o">=</code>0
<code class="k">done</code>
<code class="nb">echo</code> <code class="s2">"Overall swap used: </code><code class="nv">$OVERALL</code><code class="s2">"</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The difference between setting <code>vm.swappiness</code> to <code>1</code> and <code>0</code> is negligible. We chose the value of <code>1</code> because in some kernels there is a bug that can lead the Out of Memory (OOM) Killer to terminate MySQL when it’s set to <code>0</code>.</p>
</div>
</div></section>













<section data-type="sect4" data-pdf-bookmark="I/O scheduler"><div class="sect4" id="idm46177451381704">
<h4>I/O scheduler</h4>

<p>The I/O scheduler is an algorithm the kernel uses to commit reads<a data-type="indexterm" data-primary="I/O scheduler" id="idm46177451300168"/> and writes to disk. By default, most Linux installs use the Completely Fair Queuing (<code>cfq</code>) scheduler. This works well for many general use cases, but offers few latency guarantees. Two other schedulers are <code>deadline</code> and <code>noop</code>. The <code>deadline</code> scheduler excels at latency-sensitive use cases (like databases), and <code>noop</code> is closer to no scheduling at all. For bare-metal installations, either <code>deadline</code> or <code>noop</code> (the performance difference between them is imperceptible) will be better than <code>cfq</code>.</p>

<p>If you are running MySQL in a VM (which has its own I/O scheduler), it is best to use <code>noop</code> and let the virtualization layer take care of the I/O scheduling itself.</p>

<p>First, verify which algorithm is currently in use by Linux:</p>

<pre data-type="programlisting">#  <strong>cat /sys/block/xvda/queue/scheduler</strong></pre>

<pre data-type="programlisting">noop [deadline] cfq</pre>

<p>To change it dynamically, run this command as root:</p>

<pre data-type="programlisting"># <strong>echo "noop" &gt; /sys/block/xvda/queue/scheduler</strong></pre>

<p>In  order  to  make  this  change  persistent,  you  need  to  edit  the  GRUB  configuration 
<span class="keep-together">file (usually</span> <em>/etc/sysconfig/grub</em>) and add the <code>elevator</code> option to <code>GRUB_CMDLINE_LINUX_DEFAULT</code>. For example, you would replace this line:</p>

<pre data-type="programlisting">GRUB_CMDLINE_LINUX="console=tty0 crashkernel=auto console=ttyS0,115200</pre>

<p>with this line:</p>

<pre data-type="programlisting">GRUB_CMDLINE_LINUX="console=tty0 crashkernel=auto console=ttyS0,115200
    elevator=noop"</pre>

<p>It is essential to take extra care when editing the GRUB config. Errors or incorrect settings can make the server unusable and require installing the operating system again.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>There are cases where the I/O scheduler has a value of <code>none</code>—most notably in AWS VM instance types where EBS volumes are exposed as NVMe block devices. This is because the setting has no use in modern PCIe/NVMe devices, which have a substantial internal queue and bypass the I/O scheduler altogether. The <code>none</code> setting is optimal in such disks.</p>
</div>
</div></section>













<section data-type="sect4" data-pdf-bookmark="Filesystems and mount options"><div class="sect4" id="idm46177451301528">
<h4>Filesystems and mount options</h4>

<p>Choosing the filesystem appropriate for your database is an<a data-type="indexterm" data-primary="filesystem options" id="idm46177451282520"/><a data-type="indexterm" data-primary="XFS filesystem option" id="idm46177451281816"/> important decision due to the many options available and the trade-offs involved. It is worth mentioning two important ones that are frequently used: <em>XFS</em> and <em>ext4</em>.</p>

<p>XFS is a high-performance journaling filesystem designed for high scalability. It provides near-native I/O performance even when the filesystem spans multiple storage devices. XFS has features that make it suitable for very large filesystems, supporting files up to 8 EiB in size. Other features include fast recovery, fast transactions, delayed allocation for reduced fragmentation, and near-raw I/O performance with direct I/O.</p>

<p>The <a href="https://oreil.ly/IJ9em">make filesystem XFS command</a> (<code>mkfs.xfs</code>) <a data-type="indexterm" data-primary="XFS filesystem option" data-secondary="make filesystem XFS command" id="idm46177451277576"/><a data-type="indexterm" data-primary="web links in book" data-secondary="make filesystem XFS" id="idm46177451276600"/>has several options to configure the filesystem. However, the default options for <code>mkfs.xfs</code> are good for optimal speed, so the default command to create the filesystem will provide good performance while ensuring data integrity:</p>

<pre data-type="programlisting"># <strong>mkfs.xfs /dev/target_volume</strong></pre>

<p>Regarding the filesystem mount options, the defaults again should fit most cases.<a data-type="indexterm" data-primary="filesystem options" data-secondary="mount options" id="idm46177451273368"/><a data-type="indexterm" data-primary="mount options for filesystem" id="idm46177451272392"/> You may see a performance increase on some filesystems by adding the <code>noatime</code> mount option to the <em>/etc/fstab</em> file.  For XFS filesystems, the default <code>atime</code> behavior is <code>relatime</code>, which has almost no overhead compared to <code>noatime</code> and still maintains sane <code>atime</code> values.  If you create an XFS filesystem on a logical unit number (LUN) that has a battery-backed, nonvolatile cache, you can further increase the filesystem’s 
<span class="keep-together">performance</span> by disabling the write barrier with the mount option <code>nobarrier</code>. These settings help you avoid flushing data more often than necessary. If a backup battery unit (BBU) is not present, however, or you are unsure about it, leave barriers on; otherwise, you may jeopardize data consistency. The example below shows two imaginary mountpoints with these options:</p>

<pre data-type="programlisting" data-code-language="shell">/dev/sda2              /datastore              xfs     noatime,nobarrier
/dev/sdb2              /binlog                 xfs     noatime,nobarrier</pre>

<p>The other popular option is ext4, developed as the successor to<a data-type="indexterm" data-primary="ext4 filesystem option" id="idm46177451265784"/> ext3 with added performance improvements. It is a solid option that will fit most workloads. We should note here that it supports files up to 16 TB in size, a smaller limit than XFS. This is something you should consider if excessive tablespace size/growth is a requirement. Regarding mount options, the same considerations apply. We recommend the defaults for a robust filesystem without risks to data consistency. However, if an enterprise storage controller with a BBU cache is present, the following mount options will provide the best performance:</p>

<pre data-type="programlisting" data-code-language="shell">/dev/sda2              /datastore              ext4
noatime,data<code class="o">=</code>writeback,barrier<code class="o">=</code>0,nobh,errors<code class="o">=</code>remount-ro
/dev/sdb2              /binlog                 ext4
noatime,data<code class="o">=</code>writeback,barrier<code class="o">=</code>0,nobh,errors<code class="o">=</code>remount-ro</pre>
</div></section>













<section data-type="sect4" data-pdf-bookmark="Transparent Huge Pages"><div class="sect4" id="idm46177451283720">
<h4>Transparent Huge Pages</h4>

<p>The operating system manages memory in blocks known as <em>pages</em>. <a data-type="indexterm" data-primary="page of memory definition" id="idm46177451215352"/><a data-type="indexterm" data-primary="memory management" data-secondary="Transparent Huge Pages" id="idm46177451214760"/><a data-type="indexterm" data-primary="scalability" data-secondary="memory management" id="idm46177451213816"/><a data-type="indexterm" data-primary="Transparent Huge Pages (THP)" id="idm46177451212872"/>A page has a size of 4,096 bytes (or 4 KB); 1 MB of memory is equal to 256 pages, 1 GB of memory is equivalent to 256,000 pages, etc. <a data-type="indexterm" data-primary="page of memory definition" data-secondary="page table entry" id="idm46177451260504"/>CPUs have a built-in memory management unit that contains a list of these pages, with each page referenced through a <em>page table entry</em>. It is common to see servers nowadays with hundreds or terabytes of memory. There are two ways to enable the system to manage large amounts of memory:</p>

<ul>
<li>
<p>Increase the number of page table entries in the hardware memory management unit.</p>
</li>
<li>
<p>Increase the page size.</p>
</li>
</ul>

<p>The first method is expensive since the hardware memory management unit in a modern processor only supports hundreds or thousands of page table entries. Besides, hardware and memory management algorithms that work well with thousands of pages (megabytes of memory) may have problems performing well with millions (or even billions) of pages. To address the scalability issue, operating systems started using huge pages. Simply put, huge pages are blocks of memory that can come in sizes of 2 MB, 4 MB, 1 GB size, etc. Using huge page memory increases the CPU cache hits against the transaction lookaside buffer (TLB).</p>

<p class="pagebreak-before">You can run <code>cpuid</code> to verify the processor cache and TLB:</p>

<pre data-type="programlisting"># <strong>cpuid | grep "cache and TLB information" -A 5</strong>
   cache and TLB information (2):
      0x5a: data TLB: 2M/4M pages, 4-way, 32 entries
      0x03: data TLB: 4K pages, 4-way, 64 entries
      0x76: instruction TLB: 2M/4M pages, fully, 8 entries
      0xff: cache data is in CPUID 4
      0xb2: instruction TLB: 4K, 4-way, 64 entries</pre>

<p>Transparent Huge Pages (THP), as the name suggests, is intended to bring huge page support automatically to applications without requiring custom configuration.</p>

<p>For MySQL in particular, using THP is not recommended, for a couple of reasons. First, MySQL databases use small memory pages (16 KB), and using THP can cause excessive I/O because MySQL believes it is accessing 16 KB while THP is scanning a page larger than that. Also, the huge pages tend to become fragmented and impact performance. There have also been some cases reported over the years where using THP can result in memory leaking, eventually crashing MySQL.</p>

<p>To disable THP for RHEL/CentOS 6 and RHEL/CentOS 7, execute the following commands:</p>

<pre data-type="programlisting"># <strong>echo "never" &gt; /sys/kernel/mm/transparent_hugepage/enabled</strong>
# <strong>echo "never" &gt; /sys/kernel/mm/transparent_hugepage/defrag</strong></pre>

<p>To ensure that this change will survive a server restart, you’ll have<a data-type="indexterm" data-primary="kernel options for Transparent Huge Pages" id="idm46177451187560"/> to add the flag <code>transparent_hugepage=never</code>  to your kernel options (<em>/etc/sysconfig/grub</em>):</p>

<pre data-type="programlisting">GRUB_CMDLINE_LINUX="console=tty0 crashkernel=auto console=ttyS0,115200
elevator=noop transparent_hugepage=never"</pre>

<p>Back up the existing GRUB2 configuration file (<em>/boot/grub2/grub.cfg</em>), and then rebuild it. On BIOS-based machines, you can do this with the following command:</p>

<pre data-type="programlisting"># <strong>grub2-mkconfig -o /boot/grub2/grub.cfg</strong></pre>

<p>If THP is still not disabled, it may be necessary to disable the <code>tuned</code> services:</p>

<pre data-type="programlisting"># <strong>systemctl stop tuned</strong>
# <strong>systemctl disable tuned</strong></pre>

<p>To disable THP for Ubuntu 20.04 (Focal Fossa), we recommend you use the <code>sysfsutils</code> package. To install it, execute the following command:<a data-type="indexterm" data-primary="sysfsutils" id="idm46177451162920"/><a data-type="indexterm" data-primary="Ubuntu Linux" data-secondary="Transparent Huge Pages disabled" id="idm46177451162216"/><a data-type="indexterm" data-primary="Linux" data-secondary="Ubuntu" data-tertiary="Transparent Huge Pages disabled" id="idm46177451161256"/></p>

<pre data-type="programlisting"># <strong>apt install sysfsutils</strong></pre>

<p>Then append the following lines to the <em>/etc/sysfs.conf</em> file:</p>

<pre data-type="programlisting">kernel/mm/transparent_hugepage/enabled = never
kernel/mm/transparent_hugepage/defrag = never</pre>

<p class="pagebreak-before">Reboot the server and check if the settings are in place:</p>

<pre data-type="programlisting"># <strong>cat /sys/kernel/mm/transparent_hugepage/enabled</strong>
always madvise [never]
# <strong>cat /sys/kernel/mm/transparent_hugepage/defrag</strong>
always defer defer+madvise madvise [never]</pre>
</div></section>













<section data-type="sect4" data-pdf-bookmark="jemalloc"><div class="sect4" id="idm46177451216520">
<h4>jemalloc</h4>

<p>MySQL Server uses dynamic memory allocation, so a good<a data-type="indexterm" data-primary="jemalloc" id="ch11-jem"/><a data-type="indexterm" data-primary="memory management" data-secondary="memory allocator" id="ch11-jem2"/> memory allocator is important for proper CPU and RAM resource utilization. An efficient memory allocator should improve scalability, increase throughput, and keep the memory footprint under control.</p>

<p>It is important to mention a characteristic of InnoDB here. <a data-type="indexterm" data-primary="InnoDB" data-secondary="about" data-tertiary="memory allocation" id="idm46177451150728"/>InnoDB creates a read view for every transaction and allocates memory for this structure from the <code>heap</code> area. The problem is that MySQL deallocates the heap on each commit, and thus the read view memory is reallocated on the next transaction, leading to memory fragmentation.</p>

<p><code>jemalloc</code> is a memory allocator that emphasizes fragmentation avoidance and scalable concurrency support.</p>

<p>Using <code>jemalloc</code> (with THP disabled), you have less memory fragmentation and more efficient resource management of the available server memory. You can install the <code>jemalloc</code> package from the <a href="https://oreil.ly/NZMtb"><code>jemalloc</code> repository</a> or the Percona <em>yum</em> or <em>apt</em> repository. We prefer to use the Percona repository because we consider it simpler to install and manage. We describe the steps to install the <em>yum</em> repository in <a data-type="xref" href="ch01.xhtml#PERCONA-YUM-REPO-INSTALL">“Installing Percona Server 8.0”</a> and the <em>apt</em> repository in <a data-type="xref" href="ch01.xhtml#INSTALL-APT-PERCONA-REPO">“Installing Percona Server 8”</a>.</p>

<p>Once you have the repo, you run the install command for your operating system.</p>
<div data-type="tip"><h6>Tip</h6>
<p>In CentOS, if the server has the Extra Packages for Enterprise Linux (EPEL) repository installed, it is possible to install <code>jemalloc</code> from this repo with <code>yum</code>. To install the EPEL package, use:</p>

<pre data-type="programlisting"># <strong>yum install epel-release -y</strong></pre>
</div>

<p>If you are using Ubuntu 20.04, then you need to execute the following steps to enable <code>jemalloc</code>:<a data-type="indexterm" data-primary="Linux" data-secondary="Ubuntu" data-tertiary="jemalloc" id="idm46177451137096"/><a data-type="indexterm" data-primary="Ubuntu Linux" data-secondary="jemalloc" id="idm46177451135816"/></p>
<ol>
<li>
<p>Install <code>jemalloc</code>:</p>

<pre data-type="programlisting"># <strong>apt-get install libjemalloc2</strong>
# <strong>dpkg -L libjemalloc2</strong></pre>
</li>
<li>
<p>The <code>dpkg</code> command will show the location of the <code>jemalloc</code> library:</p>

<pre data-type="programlisting"># <strong>dpkg -L libjemalloc2</strong>
/.
/usr
/usr/lib
/usr/lib/x86_64-linux-gnu
/usr/lib/x86_64-linux-gnu/libjemalloc.so.2
/usr/share
/usr/share/doc
/usr/share/doc/libjemalloc2
/usr/share/doc/libjemalloc2/README
/usr/share/doc/libjemalloc2/changelog.Debian.gz
/usr/share/doc/libjemalloc2/copyright</pre>
</li>
<li>
<p>Override the default configuration of the service with the command:</p>

<pre data-type="programlisting"># <strong>systemctl edit mysql</strong></pre>

<p>which will create the <em>/etc/systemd/system/mysql.service.d/override.conf</em> file.</p>
</li>
<li>
<p>Add the following configuration to the file:</p>

<pre data-type="programlisting">[Service]
Environment="LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so.2"</pre>
</li>
<li>
<p>Restart the MySQL service to enable the <code>jemalloc</code> library:</p>

<pre data-type="programlisting"># <strong>systemctl restart mysql</strong></pre>
</li>
<li>
<p>To verify if it worked, with the <code>mysqld</code> process running, execute the following command:</p>

<pre data-type="programlisting"># <strong>lsof -Pn -p $(pidof mysqld) |  grep "jemalloc"</strong></pre>

<p>You should see similar output to the following:</p>

<pre data-type="programlisting">mysqld  3844 mysql  mem       REG              253,0   744776  36550
/usr/lib/x86_64-linux-gnu/libjemalloc.so.2</pre>
</li>

</ol>

<p>If you are using CentOS/RHEL, you need to execute the following steps:<a data-type="indexterm" data-primary="Linux" data-secondary="CentOS 7 Linux" data-tertiary="jemalloc" id="idm46177451117272"/><a data-type="indexterm" data-primary="Linux" data-secondary="CentOS 8 Linux" data-tertiary="jemalloc" id="idm46177451115912"/><a data-type="indexterm" data-primary="CentOS 7 Linux" data-secondary="jemalloc" id="idm46177451114696"/><a data-type="indexterm" data-primary="CentOS 8 Linux" data-secondary="jemalloc" id="idm46177451113752"/></p>
<ol>
<li>
<p>Install the <code>jemalloc</code> package:</p>

<pre data-type="programlisting"># <strong>yum install jemalloc</strong>
# <strong>rpm -ql jemalloc</strong></pre>
</li>
<li>
<p>The <code>rpm -ql</code> command will show the library location:</p>

<pre data-type="programlisting">/usr/bin/jemalloc.sh
/usr/lib64/libjemalloc.so.1
/usr/share/doc/jemalloc-3.6.0
/usr/share/doc/jemalloc-3.6.0/COPYING
/usr/share/doc/jemalloc-3.6.0/README
/usr/share/doc/jemalloc-3.6.0/VERSION
/usr/share/doc/jemalloc-3.6.0/jemalloc.html</pre>
</li>
<li>
<p>Override the default configuration of the service with the command:</p>

<pre data-type="programlisting"># <strong>systemctl edit mysqld</strong></pre>

<p>which will create the <em>/etc/systemd/system/mysqld.service.d/override.conf</em> file.</p>
</li>
<li>
<p>Add the following configuration to the file:</p>

<pre data-type="programlisting">[Service]
Environment="LD_PRELOAD=/usr/lib64/libjemalloc.so.1"</pre>
</li>
<li>
<p>Restart the MySQL service to enable the <code>jemalloc</code> library:</p>

<pre data-type="programlisting"># <strong>systemctl restart mysqld</strong></pre>
</li>
<li>
<p>To verify if it worked, with the <code>mysqld</code> process running, execute the following command:</p>

<pre data-type="programlisting"># <strong>lsof -Pn -p $(pidof mysqld) |  grep "jemalloc"</strong></pre>

<p>You should see similar output to the following:<a data-type="indexterm" data-startref="ch11-jem" id="idm46177451097512"/><a data-type="indexterm" data-startref="ch11-jem2" id="idm46177451096808"/></p>

<pre data-type="programlisting">mysqld  4784 mysql  mem       REG              253,0    212096  33985101
/usr/lib64/libjemalloc.so.1</pre>
</li>

</ol>
</div></section>













<section data-type="sect4" data-pdf-bookmark="CPU governor"><div class="sect4" id="idm46177451154680">
<h4>CPU governor</h4>

<p>One of the most effective ways to reduce the power consumption<a data-type="indexterm" data-primary="power consumption reduction" id="idm46177451093608"/><a data-type="indexterm" data-primary="CPUfreq governor" id="idm46177451092856"/> and heat output on your system is to use CPUfreq. CPUfreq, also referred to as CPU frequency scaling or CPU speed scaling, allows the processor’s clock speed to be adjusted on the fly. This feature enables the system to run at a reduced clock speed to save power. The rules for shifting frequencies—whether and when to shift to a faster or slower clock speed—are defined by the CPUfreq <em>governor</em>. The governor defines the power characteristics of the system CPU, which in turn affects CPU performance. Each governor has its own unique behavior, purpose, and suitability in terms of workload. However, for MySQL databases, we recommend using the maximum performance setting to achieve the best throughput.</p>

<p>For CentOS, you can view which CPU governor is currently being used by executing:</p>

<pre data-type="programlisting"># <strong>cat /sys/devices/system/cpu/cpu/cpufreq/scaling_governor</strong></pre>

<p>You can enable performance mode by running:</p>

<pre data-type="programlisting"># <strong>cpupower frequency-set --governor performance</strong></pre>

<p>For Ubuntu, we recommend installing the <code>linux-tools-common</code> package so you have access to the <code>cpupower</code> utility:</p>

<pre data-type="programlisting"># <strong>apt install linux-tools-common</strong></pre>

<p>Once you’ve installed it, you can change the governor to performance mode with the following command:<a data-type="indexterm" data-startref="ch11-bpos" id="idm46177451085048"/><a data-type="indexterm" data-startref="ch11-bpos2" id="idm46177451084344"/><a data-type="indexterm" data-startref="ch11-bpos3" id="idm46177451083672"/></p>

<pre data-type="programlisting"># <strong>cpupower frequency-set --governor performance</strong></pre>
</div></section>

</div></section>













<section data-type="sect3" data-pdf-bookmark="MySQL best practices"><div class="sect3" id="idm46177451094648">
<h3>MySQL best practices</h3>

<p>Now let’s look at MySQL Server settings. This section<a data-type="indexterm" data-primary="best practices" data-secondary="server settings" id="ch11-ss"/><a data-type="indexterm" data-primary="tuning MySQL Server" data-secondary="best practices" data-tertiary="server settings" id="ch11-ss2"/> proposes recommended values for the main MySQL parameters that have a direct impact on performance. You’ll see that it’s not necessary to change the default values for the majority of the parameters.</p>












<section data-type="sect4" data-pdf-bookmark="Buffer pool size"><div class="sect4" id="CH11_conf_IBP">
<h4>Buffer pool size</h4>

<p>The <code>innodb_buffer_pool_size</code> parameter controls the size in<a data-type="indexterm" data-primary="buffer pool size" id="idm46177451074664"/><a data-type="indexterm" data-primary="InnoDB" data-secondary="buffer pool size" id="idm46177451073960"/> bytes of the InnoDB buffer pool, the memory area where InnoDB caches table and index data. There’s no question that for tuning InnoDB, this is the most important parameter. The typical rule of thumb is to set it to around 70% of the total available RAM for a MySQL dedicated server.</p>

<p>However, the larger the server is, the more likely it is that this will end up wasting RAM. For a server with 512 GB of RAM, for example, this would leave 153 GB of RAM for the operating system, which is more than it needs.</p>

<p>So what’s a better rule of thumb? Set the <code>innodb_buffer_pool_size</code> as large as possible, without causing swapping when the system is running the production workload. This will require some tuning.</p>

<p>In MySQL 5.7 and later this is a dynamic parameter, so you can change it on the fly without the need to restart the database. For example, to set it to 1 GB, use this command:</p>
<pre data-type="programlisting" data-code-language="mysql">
<code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="kt">SET</code><code> </code><code class="n">global</code><code> </code><code class="n">innodb_buffer_pool_size</code><code> </code><code class="o">=</code><code> </code><code class="mi">1024</code><code class="o">*</code><code class="mi">1024</code><code class="o">*</code><code class="mi">1024</code><code class="p">;</code></strong><code>
</code></pre>

<pre data-type="programlisting">Query OK, 0 rows affected (0.00 sec)</pre>

<p>To make the change persistent across restarts, you’ll need to add this parameter to <em>my.cnf</em>, under the <code>[mysqld]</code> section:</p>

<pre data-type="programlisting">[mysqld]
innodb_buffer_pool_size = 1G</pre>
</div></section>













<section data-type="sect4" data-pdf-bookmark="The innodb_buffer_pool_instances parameter"><div class="sect4" id="idm46177451076584">
<h4>The innodb_buffer_pool_instances parameter</h4>

<p>One of the more obscure MySQL parameters is<a data-type="indexterm" data-primary="buffer pool instances" id="idm46177451042104"/><a data-type="indexterm" data-primary="InnoDB" data-secondary="buffer pool instances" id="idm46177451041400"/> <code>innodb_buffer_pool_instances</code>. This parameter defines the number of instances that InnoDB will split the buffer pool into. For systems with buffer pools in the multigigabyte range, dividing the buffer pool into separate instances can improve concurrency by reducing contention as different threads read and write to cached pages.</p>

<p>However, in our experience, setting a high value for this parameter may also introduce additional overhead. The reason is that each buffer pool instance manages its own free list, flush list, LRU list, and all other data structures connected to a buffer pool, and is protected by its own buffer pool mutex.</p>

<p>Unless you run benchmarks that prove performance gains, we suggest using the default value (<code>8</code>).</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The <code>innodb_buffer_pool_instances</code> parameter was deprecated in MariaDB 10.5.1 and removed in MariaDB 10.6. According to MariaDB architect Marko Makela, this is because the original reasons for splitting the buffer pool have mostly gone away nowadays. You can find more details in the <a href="https://oreil.ly/HOCNA">MariaDB Jira ticket</a>.</p>
</div>
</div></section>













<section data-type="sect4" data-pdf-bookmark="Redo log size"><div class="sect4" id="CH11_CONFIGURE_TUNE_REDO">
<h4>Redo log size</h4>

<p>The redo log is a structure used during crash recovery to correct<a data-type="indexterm" data-primary="redo log files" data-secondary="redo log size" id="idm46177451021320"/><a data-type="indexterm" data-primary="redo log files" id="idm46177451020312"/> data written by incomplete transactions. The main goal is to guarantee the durability (D) property of ACID transactions by providing redo recovery for committed transactions. Because the redo file logs all data written to MySQL even before the commit, having the right redo log size is fundamental for MySQL to run smoothly without struggling. An undersized redo log can even lead to errors in operations!</p>

<p>Here’s an example of the kind of error you might see if using a small redo log file:</p>

<pre data-type="programlisting">[ERROR] InnoDB: The total blob data length (12299456) is greater than 10%
of the total redo log size (100663296). Please increase total redo log size.</pre>

<p>In this case MySQL was using the default value for the <code>innodb_log_file_size</code> parameter, which is 48 MB. To estimate the optimal redo log size, there is a formula that we can use in the majority of cases. Take a look at the following commands:</p>
<pre data-type="programlisting" data-code-language="mysql">
<code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="n">pager</code><code> </code><code class="n">grep</code><code> </code><code class="n">sequence</code></strong><code>
</code><code class="n">PAGER</code><code> </code><code class="kt">set</code><code> </code><code class="k">to</code><code> </code><code class="s1">'grep sequence'</code><code>
</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><code class="k">show</code><code> </code><code class="kp">engine</code><code> </code><code class="n">innodb</code><code> </code><code class="n">status</code><code class="err">\</code><code class="n">G</code><code> </code><code class="k">select</code><code> </code><code class="nf">sleep</code><code class="p">(</code><code class="mi">60</code><code class="p">)</code><code class="p">;</code><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="k">show</code><code> </code><code class="kp">engine</code><code> </code><code class="n">innodb</code><code> </code><code class="n">status</code><code class="err">\</code><code class="n">G</code><code>
</code></pre>

<pre data-type="programlisting">Log sequence number 3836410803
1 row in set (0.06 sec)

1 row in set (1 min 0.00 sec)

Log sequence number 3838334638
1 row in set (0.05 sec)</pre>

<p>The log sequence number is the total number of bytes written to the redo log. Using the <code>SLEEP()</code> command, we can calculate the delta for that period. Then, using the following formula, we can reach an estimated value for the amount of space needed to hold an hour or so of logs (a good rule of thumb):</p>
<pre data-type="programlisting" data-code-language="mysql">
<code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="p">(</code><code class="p">(</code><code class="p">(</code><code class="mi">3838334638</code><code> </code><code class="o">-</code><code> </code><code class="mi">3836410803</code><code class="p">)</code><code class="o">/</code><code class="mi">1024</code><code class="o">/</code><code class="mi">1024</code><code class="p">)</code><code class="o">*</code><code class="mi">60</code><code class="p">)</code><code class="o">/</code><code class="mi">2</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="k">AS</code><code> </code><code class="n">Estimated_innodb_log_file_size</code><code class="p">;</code><code>
</code></pre>

<pre data-type="programlisting">+--------------------------------+
| Estimated_innodb_log_file_size |
+--------------------------------+
|                55.041360855088 |
+--------------------------------+
1 row in set (0.00 sec)</pre>

<p>We usually round up, so the final number will be 56 MB. This is the value that needs to be added to <em>my.cnf</em> under the <code>[mysqld]</code> section:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="p">[</code><code class="n">mysqld</code><code class="p">]</code>
<code class="n">innodb_log_file_size</code><code class="o">=</code><code class="mi">56</code><code class="n">M</code></pre>
</div></section>













<section data-type="sect4" data-pdf-bookmark="The sync_binlog parameter"><div class="sect4" id="idm46177451022424">
<h4>The sync_binlog parameter</h4>

<p>The binary log is a set of log files that contain information about<a data-type="indexterm" data-primary="binary logs" data-secondary="sync_binlog parameter" id="idm46177450888904"/><a data-type="indexterm" data-primary="binary logs" data-secondary="about" id="idm46177450887960"/><a data-type="indexterm" data-primary="sync_binlog parameter" id="idm46177450887016"/> data modifications made to a MySQL server instance. They are different from the redo files and have other uses. For example, they are used to create replicas and InnoDB Clusters, and are helpful for performing PITR.</p>

<p>By default, the MySQL server synchronizes its binary log to disk (using <code>fdatasync()</code>) before transactions are committed. The advantage is that in the event of a power failure or operating system crash, transactions that are missing from the binary log are only in a prepared state; this allows the automatic recovery routine to roll back the transactions, guaranteeing that no transaction is lost from the binary log. However, the default value (<code>sync_binlog = 1</code>) brings a penalty in performance. As this is a dynamic option, you can change it while the server is running with the following command:</p>
<pre data-type="programlisting" data-code-language="mysql">
<code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="kt">SET</code><code> </code><code class="n">GLOBAL</code><code> </code><code class="n">sync_binlog</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="p">;</code></strong><code>
</code></pre>

<p>For the change to persist after a restart, add the parameter to your <em>my.cnf</em> file under the <code>[mysqld]</code> section:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="p">[</code><code class="n">mysqld</code><code class="p">]</code>
<code class="n">sync_binlog</code><code class="o">=</code><code class="mi">0</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Most of the time, using <code>sync_binlog=0</code> will provide good performance (when binary logs are enabled). However, the performance variance can be significant because MySQL will rely on the OS flushing to flush the binary logs. Depending on the workload, using <code>sync_binlog=1000</code> or higher will provide better performance than <code>sync_binlog=1</code> and less variance than <code>sync_binlog=0</code>.</p>
</div>
</div></section>













<section data-type="sect4" data-pdf-bookmark="The binlog_expire_logs_seconds and expire_logs_days parameters"><div class="sect4" id="idm46177450843704">
<h4>The binlog_expire_logs_seconds and expire_logs_days parameters</h4>

<p>To avoid MySQL filling the entire disk with binary logs, you can adjust the settings of the parameters<a data-type="indexterm" data-primary="binlog_expire_logs_seconds" id="idm46177450825384"/><a data-type="indexterm" data-primary="expire_logs_days" id="idm46177450824712"/> <code>binlog_expire_logs_seconds</code> and <code>expire_logs_days</code>. <code>expire_logs_days</code> specifies the number of days before automatic removal of binary log files. However, this parameter is deprecated in MySQL 8.0, and you should expect it to be removed in a future release.</p>

<p>Consequently, a better option is to use <code>binlog_expire_logs_seconds</code>, which sets the binary log expiration period in seconds. The default value for this parameter is <code>2592000</code> (30 days). MySQL can automatically remove the binary log files after this expiration period ends, either at startup or the next time the binary log is flushed.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you want to flush the binary log manually, you can execute the following command:<a data-type="indexterm" data-primary="FLUSH BINARY LOGS" id="idm46177450819128"/><a data-type="indexterm" data-primary="binary logs" data-secondary="FLUSH BINARY LOGS" id="idm46177450818424"/></p>
<pre data-type="programlisting" data-code-language="mysql">
<code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="n">FLUSH</code><code> </code><code class="k">BINARY</code><code> </code><code class="n">LOGS</code><code class="p">;</code></strong><code>
</code></pre>
</div>
</div></section>













<section data-type="sect4" data-pdf-bookmark="The innodb_flush_log_at_trx_commit parameter"><div class="sect4" id="idm46177450786920">
<h4>The innodb_flush_log_at_trx_commit parameter</h4>

<p><code>innodb_flush_log_at_trx_commit</code>  controls the balance between<a data-type="indexterm" data-primary="ACID transactions" data-secondary="innodb_flush_log_at_trx_commit" id="idm46177450785384"/><a data-type="indexterm" data-primary="committing transactions" data-secondary="innodb_flush_log_at_trx_commit" id="idm46177450784552"/><a data-type="indexterm" data-primary="innodb_flush_log_at_trx_commit" id="idm46177450783640"/> strict ACID compliance for commit operations and the higher performance possible when commit-related I/O operations are rearranged and done in batches. It is a delicate option, and many prefer to use the default value (<code>innodb_flush_log_at_trx_commit=1</code>) in the source servers, while for replicas they use a value of <code>0</code> or <code>2</code>. The value <code>2</code> instructs InnoDB to write to the log files after each transaction commit, but to flush them to disk only once per second. This means you can lose up to a second of updates if the OS crashes, which, with modern hardware that supports up to one million inserts per second, is not negligible. The value <code>0</code> is even worse: logs are written and flushed to disk just once per second, so you may lose up to a second’s worth of transactions even if the <code>mysqld</code> process crashes.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Many operating systems, and some disk hardware, “fool” the flush-to-disk operation. They may tell <code>mysqld</code> that the flush has taken place, even though it has not. In this case, the durability of transactions is not guaranteed even with the recommended settings, and in the worst case, a power outage can corrupt InnoDB data. Using a battery-backed disk cache in the SCSI disk controller or in the disk itself speeds up file flushes and makes the operation safer. You can also disable the caching of disk writes in hardware caches if the battery is not working correctly.</p>
</div>
</div></section>













<section data-type="sect4" data-pdf-bookmark="The innodb_thread_concurrency parameter"><div class="sect4" id="idm46177450758856">
<h4>The innodb_thread_concurrency parameter</h4>

<p><code>innodb_thread_concurrency</code> is set to <code>0</code> by default, which<a data-type="indexterm" data-primary="innodb_thread_concurrency" id="idm46177450756600"/><a data-type="indexterm" data-primary="thread" data-secondary="innodb_thread_concurrency" id="idm46177450755800"/> means that an infinite number (up to the hardware limit) of threads can be opened and executed inside MySQL. The usual recommendation is to leave this parameter with its default value and only change it to solve contention problems.</p>

<p>If your workload is consistently heavy or has occasional spikes, you can set the value of <code>innodb_thread_concurrency</code> using the following formula:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="n">innodb_thread_concurrency</code> <code class="o">=</code> <code class="n">Number</code> <code class="n">of</code> <code class="n">Cores</code> <code class="o">*</code> <code class="mi">2</code></pre>

<p>Because MySQL does not use multiple cores to execute a single query (it is a 1:1 relation), each core will run one query per single unit of time. Based on our experience, because modern CPUs are fast in general, setting the maximum number of executing threads to double the CPUs available is a good start.</p>

<p>Once the number of executing threads reaches this limit, additional threads sleep for a number of microseconds, set by the configuration parameter <code>innodb_​​thread_sleep_delay</code>, before being placed into the queue.</p>

<p><code>innodb_thread_concurrency</code> is a dynamic variable, and we can change it at runtime:</p>
<pre data-type="programlisting" data-code-language="mysql">
<code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="kt">SET</code><code> </code><code class="n">GLOBAL</code><code> </code><code class="n">innodb_thread_concurrency</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="p">;</code></strong><code>
</code></pre>

<p>To make the change persistent, you’ll also need to add this to <em>my.cnf</em>, under the <code>[mysqld]</code> section:</p>

<pre data-type="programlisting" data-code-language="mysql"><code class="p">[</code><code class="n">mysqld</code><code class="p">]</code>
<code class="n">innodb</code><code class="o">-</code><code class="n">thread</code><code class="o">-</code><code class="n">concurrency</code><code class="o">=</code><code class="mi">0</code></pre>

<p>You can validate that MySQL applied the setting with this command:</p>
<pre data-type="programlisting" data-code-language="mysql">
<code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SHOW</code><code> </code><code class="n">GLOBAL</code><code> </code><code class="n">VARIABLES</code><code> </code><code class="k">LIKE</code><code> </code><code class="s1">'%innodb_thread_concurrency%'</code><code class="p">;</code></strong><code>
</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The MySQL 8.0.14 <a href="https://oreil.ly/EqPrG">release notes</a> state: “As of MySQL 8.0.14, InnoDB supports parallel clustered index reads, which can improve <code>CHECK TABLE</code> performance.” Parallel clustered index reads also work for a simple <code>COUNT(*)</code> (without a <code>WHERE</code> condition). You can control the number of parallel threads with the <code>innodb_parallel_read_threads</code> parameter.</p>

<p>This feature is currently limited and available only for queries without a <code>WHERE</code> condition (full scans). However, it is a great start for MySQL and opens the road to real parallel query execution.</p>
</div>
</div></section>













<section data-type="sect4" data-pdf-bookmark="NUMA architecture"><div class="sect4" id="CH11_conf_NUMA">
<h4>NUMA architecture</h4>

<p>Non-uniform memory access (NUMA) is a shared memory<a data-type="indexterm" data-primary="NUMA (non-uniform memory access) architecture" id="idm46177450662184"/><a data-type="indexterm" data-primary="memory management" data-secondary="NUMA architecture" id="idm46177450661512"/> architecture that describes the placement of main memory modules relative to processors in a multiprocessor system. In the NUMA shared memory architecture, each processor has its own local memory module, leading to a distinct performance advantage because the memory and the processor are physically closer. At the same time, it can also access any memory module belonging to another processor using a shared bus (or some other type of interconnect), as shown in <a data-type="xref" href="#FIG-NUMA">Figure 11-1</a>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>A nice alternative that can show memory usage across NUMA nodes is the <code>numastat</code> command. You can get a more detailed memory usage per node by executing:</p>

<pre data-type="programlisting"># numastat -m</pre>

<p>Another way to visualize this is by specific process. For example, to check the memory usage in NUMA nodes of the mysqld process:</p>

<pre data-type="programlisting"># numastat -p $(pidof mysqld)</pre>
</div>

<figure><div id="FIG-NUMA" class="figure">
<img src="Images/lm2e_1101.png" alt="lm2e 1101" width="1187" height="571"/>
<h6><span class="label">Figure 11-1. </span>NUMA architecture overview</h6>
</div></figure>

<p>The following command shows an example of the available nodes on a server that has NUMA enabled:</p>

<pre data-type="programlisting">shell&gt; <strong>numactl --hardware</strong>

available: 2 nodes (0-1)
node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 24 25 26 27 28 29 30 31 32 33 34 35
node 0 size: 130669 MB
node 0 free: 828 MB
node 1 cpus: 12 13 14 15 16 17 18 19 20 21 22 23 36 37 38 39 40 41 42 43 44 45 46
node 1 size: 131072 MB
node 1 free: 60 MB
node distances:
node   0   1
  0:  10  21
  1:  21  10</pre>

<p>As we can see, node 0 has more free memory than node 1. There is an issue with this that causes the OS to swap even with memory available, as explained in the excellent article <a href="https://oreil.ly/lBRSk">“The MySQL <em>Swap Insanity</em> Problem and the Effects of the NUMA Architecture”</a> by Jeremy Cole.</p>

<p>In MySQL 5.7 the <code>innodb_buffer_pool_populate</code> and <code>numa_interleave</code> parameters were removed, and their functions are now controlled by the <code>innodb_numa_interleave</code> parameter. When we enable it, we balance memory allocation across nodes in a NUMA system, avoiding the swap insanity problem.</p>

<p>This parameter is not dynamic, so to enable it we need to add it to the <em>my.cnf</em> file, under the <code>[mysqld]</code> section, and restart MySQL:<a data-type="indexterm" data-startref="ch11-ss" id="idm46177450606984"/><a data-type="indexterm" data-startref="ch11-ss2" id="idm46177450606280"/></p>

<pre data-type="programlisting" data-code-language="mysql"><code class="p">[</code><code class="n">mysqld</code><code class="p">]</code>
<code class="n">innodb_numa_interleave</code> <code class="o">=</code> <code class="mi">1</code></pre>
</div></section>

</div></section>



</div></section>





</div></section>







</div></section></div></body></html>