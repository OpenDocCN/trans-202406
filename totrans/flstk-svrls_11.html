<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Hosting: Deploying Your Application to the Amplify Console with CI and CD"><div class="chapter" id="ch11">
<h1><span class="label">Chapter 11. </span>Hosting: Deploying Your Application to <span class="keep-together">the Amplify Console with CI and CD</span></h1>


<p><a data-type="indexterm" data-primary="CI/CD (continuous integration and continuous deployment)" id="ci_ch"/><a data-type="indexterm" data-primary="Amplify Console, deploying apps to with CI and CD" id="ac_cha"/><a data-type="indexterm" data-primary="deploying" data-secondary="apps to Amplify Console with CI and CD" id="dep_cha"/><a data-type="indexterm" data-primary="hosting" data-secondary="about" id="idm45364346368216"/>Now that we’ve looked at building out our apps, how do we make them live and show them to the world? In this chapter, we’ll look at a couple of different hosting options with Amplify, and also how to deploy your app using a custom domain name.</p>

<p><a data-type="indexterm" data-primary="repository (repo)" id="idm45364346366632"/>The service we’ll be using is the Amplify Console hosting service. The Amplify Console is a fully managed hosting service that provides a simple workflow for deploying static sites and full stack serverless applications. Using Amplify Console, you deploy your code using the CLI, a GitHub repository, or manually, and the service will build and deploy your app for you.</p>

<p><a data-type="indexterm" data-primary="Vue" id="idm45364346365160"/><a data-type="indexterm" data-primary="Angular" id="idm45364346364456"/><a data-type="indexterm" data-primary="Gatsby" id="idm45364346363784"/><a data-type="indexterm" data-primary="Next" id="idm45364346363112"/><a data-type="indexterm" data-primary="Nuxt" id="idm45364346362440"/>When working with frameworks like React, Vue, Angular, or even frameworks like Gatsby, Next, or Nuxt, there is typically a <em>build</em> phase that needs to be run. This phase will take all of the JavaScript, CSS, and images and, using a module bundler such as webpack, create a deployable build of your website.</p>

<p>The Amplify Console will allow you to configure the app’s build settings so that when you are ready to deploy a new version, the service will be able to take your raw files, then build and deploy your app to your live domain for you.</p>

<p class="less_space pagebreak-before">In this chapter, we’ll learn about the following:</p>
<dl>
<dt><em>CLI-based deployments</em></dt>
<dd>
<p>Using our local project, we will deploy an app to Amplify Console hosting directly from the CLI.</p>
</dd>
<dt><em>Git-based deployments</em></dt>
<dd>
<p>Using a GitHub repository, we will deploy an app to Amplify Console hosting and learn how to trigger new builds when changes are merged into the master branch.</p>
</dd>
<dt><em>Access control</em></dt>
<dd>
<p>Add access control to restrict access to your branches with a username and password.</p>
</dd>
<dt><em>Custom domains</em></dt>
<dd>
<p>Use your custom domain name for the deployment.</p>
</dd>
</dl>

<p>Let’s get started.</p>






<section data-type="sect1" data-pdf-bookmark="CLI-Based Deployments"><div class="sect1" id="idm45364346352344">
<h1>CLI-Based Deployments</h1>

<p><a data-type="indexterm" data-primary="CLI-based deployments" id="idm45364346350456"/><a data-type="indexterm" data-primary="deploying" data-secondary="CLI-based" id="idm45364346349752"/><a data-type="indexterm" data-primary="hosting" data-secondary="CLI-based deployments" id="idm45364346348808"/>In this section, we will learn how to deploy a project to Amplify Console hosting directly from the CLI.</p>

<p>To get started, create a new React app:</p>

<pre data-type="programlisting">~ npx create-react-app fullstack-app
~ cd full-stack-app
~ npm install aws-amplify @aws-amplify/ui-react</pre>

<p>Next, we’ll initialize a new Amplify project and add a single service, authentication:</p>

<pre data-type="programlisting">~ amplify init
# Follow the steps to give the project a name, environment name, and set the
  default text editor.
# Accept defaults for everything else and choose your AWS Profile.

~ amplify add auth
? Do you want to use the default authentication and security configuration?
  Default configuration
? How do you want users to be able to sign in? Username
? Do you want to configure advanced settings? No, I am done.</pre>

<p><a data-type="indexterm" data-primary="init command" id="idm45364346344472"/>When running the <code>init</code> command, we are walked through the same set of questions we’ve been walked through in all of the previous chapters.</p>

<p class="less_space pagebreak-before">We are asked questions like what our source and distribution directories are, as well as the build command. By default, the Amplify CLI will detect the framework and automatically set these for you for many popular frameworks, like in our React projects.</p>

<p>If you are using a framework that is not recognized by the Amplify CLI, or have a custom build configuration, you may need to set these values to be something <span class="keep-together">different.</span></p>

<p>To add hosting, we can use the <code>hosting</code> category:</p>

<pre data-type="programlisting">~ amplify add hosting

? Select the plugin module to execute: Hosting with Amplify Console
? Choose a type: Manual Deployment</pre>

<p>Next, let’s update our frontend code to add a basic greeting as well as authentication.</p>

<p>Start by opening <em>src/index.js</em> and configuring the Amplify app by adding the following code below the last import:</p>

<pre data-type="programlisting">import Amplify from 'aws-amplify'
import config from './aws-exports'
Amplify.configure(config)</pre>

<p>Then update <em>src/App.js</em> with the following code:</p>

<pre data-type="programlisting">import React from 'react'
import logo from './logo.svg'
import './App.css'

import { withAuthenticator } from '@aws-amplify/ui-react'

function App() {
  return (
    &lt;div className="App"&gt;
      &lt;header className="App-header"&gt;
        &lt;img src={logo} className="App-logo" alt="logo" /&gt;
        &lt;h1&gt;Hello World!&lt;/h1&gt;
      &lt;/header&gt;
    &lt;/div&gt;
  );
}

export default withAuthenticator(App, { includeGreetings: true })</pre>

<p><a data-type="indexterm" data-primary="publish command" id="idm45364346334808"/>Our app is now ready to deploy. To deploy both the frontend and backend, we can run the <code>publish</code> command. The <code>publish</code> command will deploy both the frontend <em>and</em> backend code to the Amplify Console:</p>

<pre data-type="programlisting">~ amplify publish</pre>

<p>Now, we should be able to view the app in the console with both the frontend deployment as well as backend service configuration:</p>

<pre data-type="programlisting">~ amplify console</pre>

<p><a data-type="indexterm" data-primary="frontend" id="idm45364346330232"/><a data-type="indexterm" data-primary="backend" id="idm45364346329528"/>From the Amplify Console dashboard, click the app name that was just deployed. Here, you should be able to see a toggle to view both the frontend (<em>Frontend environments</em>) as well as the backend (<em>Backend environments</em>) deployments, as shown in <a data-type="xref" href="#fig11a">Figure 11-1</a>.</p>

<figure><div id="fig11a" class="figure">
<img src="Images/fssl_1101.png" alt="Amplify Console Overview" width="1400" height="766"/>
<h6><span class="label">Figure 11-1. </span>Amplify Console overview</h6>
</div></figure>

<p>From the <em>Frontend environments</em> view, you should be able to click the domain to view the live website hosted by the Amplify Console. The domain URL should look something like this:</p>

<pre data-type="programlisting">https://env_name.deployment_id.amplifyapp.com</pre>

<p>In the lefthand menu are options for things like domain management for custom domains (covered in <a data-type="xref" href="#custom_domains">“Custom Domains”</a>), email notifications for build events, access control (something we will cover in this chapter), logs, and redirects.</p>

<p>When you make an update and need to deploy a new version, you can run the <code>publish</code> command again to deploy the updated version of the app.</p>
</div></section>













<section data-type="sect1" class="less_space pagebreak-before" data-pdf-bookmark="Git-Based Deployments"><div class="sect1" id="idm45364346351368">
<h1>Git-Based Deployments</h1>

<p><a data-type="indexterm" data-primary="deploying" data-secondary="Git-based" id="dep_git"/><a data-type="indexterm" data-primary="Git-based deployments" id="git_ab"/><a data-type="indexterm" data-primary="hosting" data-secondary="Git-based deployments" id="hos_git"/>Now let’s look at how you can enable Git-based deployments using an Amplify app stored in a GitHub repository. While deploying from your local project works well, many times you will be working from a Git repository either alone or with a team. The Amplify Console supports Git-based hosting for your applications, along with built-in features automatic deployments on merges and feature branch deployments (branch deployments linked to each feature branch).</p>

<p>Let’s look at how to take the app we have already built and deploy it to the Amplify Console from a GitHub repository.</p>

<p>The first step is to remove the existing amplify backend that we have set up:</p>

<pre data-type="programlisting">~ amplify delete</pre>

<p>Then, create a new Amplify app and add authentication:</p>

<pre data-type="programlisting">~ amplify init
# Follow the steps to give the project a name, environment name, and set the
  default text editor.
# Accept defaults for everything else and choose your AWS Profile.

~ amplify add auth
? Do you want to use the default authentication and security configuration?
  Default configuration
? How do you want users to be able to sign in? Username
? Do you want to configure advanced settings? No, I am done.</pre>

<p>Now, deploy the backend using the Amplify <code>push</code> command:</p>

<pre data-type="programlisting">~ amplify push</pre>

<p>We now need to create a GitHub repository to hold the app.</p>








<section data-type="sect2" data-pdf-bookmark="Creating the GitHub Repository"><div class="sect2" id="idm45364346309656">
<h2>Creating the GitHub Repository</h2>

<p><a data-type="indexterm" data-primary="creating" data-secondary="GitHub repository" id="idm45364346308104"/><a data-type="indexterm" data-primary="GitHub repository, creating" id="idm45364346307128"/>The next thing you will need to do is go to GitHub.com and create a new repository. I’ll create a new repo called <em>my-react-app</em>, as shown in <a data-type="xref" href="#fig11b">Figure 11-2</a>.</p>

<figure><div id="fig11b" class="figure">
<img src="Images/fssl_1102.png" alt="Creating a GitHub repository" width="727" height="759"/>
<h6><span class="label">Figure 11-2. </span>Creating a GitHub repository</h6>
</div></figure>

<p>Once you’ve created the repo, you will be given a repo URI that looks like what’s shown in <a data-type="xref" href="#fig11c">Figure 11-3</a>:</p>

<pre data-type="programlisting">git@github.com:dabit3/my-react-app.git</pre>

<figure><div id="fig11c" class="figure">
<img src="Images/fssl_1103.png" alt="GitHub Project URI" width="1004" height="808"/>
<h6><span class="label">Figure 11-3. </span>GitHub project URI</h6>
</div></figure>

<p>Copy this repo URI and return to the command line. From here, we will initialize a new GitHub project in our local app:</p>

<pre data-type="programlisting">~ git init
~ git remote add origin git@github.com:your_github_username/my-react-app.git</pre>

<p>We’ll then add the files to be tracked and push the changes to our repo:</p>

<pre data-type="programlisting">~ git add .
~ git commit -m 'initial commit'
~ git push origin master</pre>

<p>Now that the app has been pushed to GitHub, we can connect to Amplify Console hosting. To do so, let’s add it via the CLI:</p>

<pre data-type="programlisting">~ amplify add hosting

? Select the plugin module to execute: Hosting with Amplify Console
? Choose a type: Continuous deployment (Git-based deployments)</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The CLI should open the Amplify Console in your web browser, allowing you to choose GitHub as your source code provider.</p>
</div>
<ol>
<li>
<p>As your first step (in the Amplify Console), choose GitHub as the source code provider and then click Connect branch.</p>
</li>
<li>
<p>Next, sign in with GitHub, then choose the new repo you just created and the master branch. Click Next.</p>
</li>
<li>
<p>In the Configure build settings page, when asked to “select a backend environment,” choose the environment name you already have created.</p>
</li>
<li>
<p>Next, in the Configure build settings page, when asked to “select an existing service role or create a new one so Amplify Console may access your resources,” click Create new role to create a new IAM role:</p>
<ol>
<li>
<p>Click Next: Permissions, Next: Tags, Next: Review, and then Create Role to create a new IAM role.</p>
</li>
<li>
<p>Go back to the Configure build settings page, click the refresh button, and select the newly created role from the dropdown.</p>
</li>

</ol>
</li>
<li>
<p>Click Next.</p>
</li>
<li>
<p>In the Review page, click Save and deploy to deploy the app.</p>
</li>

</ol>

<p>The app has now been deployed to the Amplify Console and a new build will begin. When the build finishes, you should be given a live URL to view your app.<a data-type="indexterm" data-primary="" data-startref="dep_git" id="idm45364346283752"/><a data-type="indexterm" data-primary="" data-startref="git_ab" id="idm45364346282744"/><a data-type="indexterm" data-primary="" data-startref="hos_git" id="idm45364346281800"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Git-Based CI/CD"><div class="sect2" id="idm45364346308984">
<h2>Git-Based CI/CD</h2>

<p><a data-type="indexterm" data-primary="Git-based CI/CD" id="idm45364346279544"/>Now that the app has been deployed, let’s look at how to implement CD into the app.</p>

<p>The basic idea with Git-based CI and CD is that you can deploy and test builds to any branch by pushing directly to Git. Once the changes are merged, a new build is kicked off and a live URL is given to you to try out.</p>

<p>In this way, you can have feature/branch deployments, like <em>prod</em> (for production), <em>dev</em> (for development), and <em>feature_name</em> (for new features). When building in this way, you are able to test out new changes in a live environment, testing out not only the frontend but also the backend changes.</p>

<p>Let’s try kicking off a new build. To do so, make a change to one of the local files. Update <em>src/App.js</em> with some updated text, then add the changes and push to GitHub:</p>

<pre data-type="programlisting">~ git add .
~ git commit -m 'updates to App.js'
~ git push origin master</pre>

<p>Now, when you open your app in the Amplify Console, you should notice a new build has been kicked off automatically for you.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Access Control"><div class="sect1" id="idm45364346320408">
<h1>Access Control</h1>

<p><a data-type="indexterm" data-primary="access control" id="idm45364346272536"/><a data-type="indexterm" data-primary="hosting" data-secondary="access control" id="idm45364346271832"/>Next, let’s look at how to enable access control to password protect our deployment.</p>

<p>Using access control, you can specify that a visitor must have a username and password to view either a deployment or a specific branch deployment. This is especially useful if you are testing out new private features that you wish to keep undiscoverable by anyone outside your team.</p>

<p>Here’s how to enable access controls:</p>
<ol>
<li>
<p>In the lefthand menu, click Access Control.</p>
</li>
<li>
<p>Next, click Manage Access.</p>
</li>
<li>
<p>Here, for the master branch, set the Access setting to Restricted, then set a username and password.</p>
</li>

</ol>

<p>Now, open the URL for the deployment. You will notice that you will be unable to view it without entering the username and password.</p>

<p>In the Access Control menu, you can also choose to set access control on a branch-by-branch basis.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Custom Domains"><div class="sect1" id="custom_domains">
<h1>Custom Domains</h1>

<p><a data-type="indexterm" data-primary="custom domains, hosting and" id="idm45364346263224"/><a data-type="indexterm" data-primary="hosting" data-secondary="custom domains" id="idm45364346262552"/><a data-type="indexterm" data-primary="DNS" id="idm45364346261608"/><a data-type="indexterm" data-primary="nameservers" id="idm45364346260936"/>Finally, let’s learn how to use a custom domain name for our app.</p>

<p>To enable a custom domain, we need to do three things:</p>

<ul>
<li>
<p>Add the domain in Amazon Route53.</p>
</li>
<li>
<p>Set the nameservers in the DNS settings of the domain provider for the domain you are using.</p>
</li>
<li>
<p>Configure the Amplify Console app to use the domain added in Route 53.</p>
</li>
</ul>

<p>Let’s walk through how to do this:</p>
<ol>
<li>
<p>In the Services dropdown menu in the main AWS dashboard, search for or click Route53.</p>
</li>
<li>
<p>Click Hosted Zones.</p>
</li>
<li>
<p>Click Create Hosted Zone.</p>
</li>
<li>
<p>Set the domain name by adding the URL to the Domain name input field, then click Create.</p>
</li>

</ol>

<p>After creating the Hosted Zone, you will be given four nameserver values. You will need those values in the next step, so keep them handy. You can also navigate back to them at any time by visiting the Route53 dashboard and clicking on the domain you would like to retrieve the values for. The nameservers will look something like this:</p>

<pre data-type="programlisting">ns-1020.awsdns-63.net
ns-1523.awsdns-62.org
ns-244.awsdns-30.com
ns-1724.awsdns-23.co.uk</pre>
<ol>
<li>
<p>Now, go into your hosting account (e.g., GoDaddy or Google Domains), and set these custom nameservers in your DNS setting for the domain you’re using.</p>
</li>
<li>
<p>Next, back in the Amplify Console for the app for which you would like to enable a custom domain, click Domain Management in the left menu, then click the Add Domain button.</p>
</li>
<li>
<p>Here, the drop-down menu should show you the domain you have in Route53. Choose this domain and click Configure domain.</p>
</li>

</ol>

<p>This should deploy the app to your custom domain (it will take 5–30 minutes for the DNS to propagate)<a data-type="indexterm" data-primary="" data-startref="ci_ch" id="idm45364346246088"/><a data-type="indexterm" data-primary="" data-startref="ac_cha" id="idm45364346245112"/><a data-type="indexterm" data-primary="" data-startref="dep_cha" id="idm45364346244168"/>.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="idm45364346264440">
<h1>Summary</h1>

<p>Here are a few things to keep in mind from this chapter:</p>

<ul>
<li>
<p>The Amplify Console hosts both backend and as well as frontend deployments.</p>
</li>
<li>
<p>There are two main ways to deploy the frontend to the Amplify Console, from your local project or from a Git repository. You can also upload projects manually or host them from Dropbox.</p>
</li>
<li>
<p>Once your app is hosted, you can then set up things like password protection, custom domains, and branch deployments by configuring your deployment in the Amplify Console.</p>
</li>
</ul>
</div></section>







</div></section></div>



  </body></html>