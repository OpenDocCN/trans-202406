<html><head></head><body><section data-pdf-bookmark="Chapter 8. Incorporating Data" data-type="chapter" epub:type="chapter"><div class="chapter" id="incorporating-data">&#13;
<h1><span class="label">Chapter 8. </span>Incorporating Data</h1>&#13;
&#13;
&#13;
<p>Data<a data-primary="data management" data-secondary="challenges of" data-type="indexterm" id="idm45901630773464"/> is the lifeblood of our applications. It flows like water, and it nourishes our components with value. The user interface components we’ve composed are vessels for data. We fill our applications with data from the internet. We collect, create, and send new data to the internet. The value of our applications is not the components themselves—it’s the data that flows through those components.</p>&#13;
&#13;
<p>When we talk about data, it may sound a little like we’re talking about water or food. <em>The cloud</em> is the abundantly endless source from which we send and receive data. It’s the internet. It’s the networks, services, systems, and databases where we manipulate and store zettabytes of data. The cloud <em>hydrates</em> our clients with the latest and freshest data from the source. We work with this data locally and even store it locally. But when our local data becomes out of sync with the source, it loses its freshness and is said to be <em>stale</em>.</p>&#13;
&#13;
<p>These are the challenges we face as developers working with data. We need to keep our applications hydrated with fresh data from the cloud. In this chapter, we’re going to take a look at various techniques for loading and working with data from the source.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Requesting Data" data-type="sect1"><div class="sect1" id="requesting-data">&#13;
<h1>Requesting Data</h1>&#13;
&#13;
<p>In<a data-primary="data management" data-secondary="requesting data" data-tertiary="fetch requests" data-type="indexterm" id="idm45901630766856"/><a data-primary="fetch() function" data-type="indexterm" id="idm45901630765576"/><a data-primary="asynchronous programming" data-secondary="fetch() function" data-type="indexterm" id="idm45901630764904"/> the movie Star Wars, the droid C-3P0 is a protocol droid. His specialty, of course, is communication. He speaks over six million languages. Surely, C-3P0 knows how to send an HTTP request, because the Hyper Text Transfer Protocol is one of the most popular ways to transmit data to and from the internet.</p>&#13;
&#13;
<p>HTTP provides the backbone for our internet communication. Every time we load <em>http://www.google.com</em> into our browser, we’re asking Google to send us a search form. The files necessary for us to search are transmitted to the browser over HTTP. When we interact with Google by searching for “cat photos,” we’re asking Google to find us cat photos. Google responds with data, and images are transferred to our browser over HTTP.</p>&#13;
&#13;
<p>In JavaScript, the most popular way to make an HTTP request is to use fetch. If we wanted to ask GitHub for information about Moon Highway, we could do so by sending a fetch request:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">fetch</code><code class="p">(</code><code class="sb">`https://api.github.com/users/moonhighway`</code><code class="p">)</code>&#13;
  <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">response</code> <code class="o">=&gt;</code> <code class="nx">response</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>&#13;
  <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">)</code>&#13;
  <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code></pre>&#13;
&#13;
<p>The <code>fetch</code> function returns a promise. Here, we’re making an<a data-primary="asynchronous programming" data-secondary="fetch() function" data-type="indexterm" id="idm45901630722888"/> asynchronous request to a specific URL: <em>https://api.github.com/users/moonhighway</em>. It takes time for that request to traverse the internet and respond with information. When it does, that information is passed to a callback using the <code>.then(callback)</code> method. The GitHub API will respond with JSON data, but that data is contained in the body of the HTTP response, so we call <code>response.json()</code> to obtain that data and parse it as JSON. Once obtained, we log that data to the console. If anything goes wrong, we’ll pass the error to the <code>console.error</code> method.</p>&#13;
&#13;
<p>GitHub will respond to this request with a JSON object:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"login"</code><code class="p">:</code> <code class="s2">"MoonHighway"</code><code class="p">,</code>&#13;
  <code class="nt">"id"</code><code class="p">:</code> <code class="mi">5952087</code><code class="p">,</code>&#13;
  <code class="nt">"node_id"</code><code class="p">:</code> <code class="s2">"MDEyOk9yZ2FuaXphdGlvbjU5NTIwODc="</code><code class="p">,</code>&#13;
  <code class="nt">"avatar_url"</code><code class="p">:</code> <code class="s2">"https://avatars0.githubusercontent.com/u/5952087?v=4"</code><code class="p">,</code>&#13;
  <code class="nt">"bio"</code><code class="p">:</code> <code class="s2">"Web Development classroom training materials."</code><code class="p">,</code>&#13;
&#13;
  <code class="err">...</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>On GitHub, basic information about user accounts is made available by their API. Go ahead, try searching for yourself: <em>https://api.github.com/users/&lt;YOUR_GITHUB_USER_NAME&gt;</em>.</p>&#13;
&#13;
<p>Another<a data-primary="data management" data-secondary="requesting data" data-tertiary="async/await and" data-type="indexterm" id="idm45901630699368"/><a data-primary="promises" data-secondary="simple with fetch() function" data-type="indexterm" id="idm45901630663608"/><a data-primary="await function" data-type="indexterm" id="idm45901630662696"/><a data-primary="async function" data-type="indexterm" id="idm45901630662024"/><a data-primary="asynchronous programming" data-secondary="async and await functions" data-type="indexterm" id="idm45901630661352"/> way of working with promises is to use <code>async/await</code>. Since <code>fetch</code> returns a promise, we can <code>await</code> a fetch request inside of an <code>async</code> function:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">async</code> <code class="kd">function</code> <code class="nx">requestGithubUser</code><code class="p">(</code><code class="nx">githubLogin</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="k">try</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code>&#13;
      <code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">githubLogin</code><code class="si">}</code><code class="sb">`</code>&#13;
    <code class="p">);</code>&#13;
    <code class="kr">const</code> <code class="nx">userData</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">response</code><code class="p">.</code><code class="nx">json</code><code class="p">();</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">userData</code><code class="p">);</code>&#13;
  <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This code achieves the exact same results as the previous fetch request that was made by chaining <code>.then</code> functions on to the request. When we <code>await</code> a promise, the next line of code will not be executed until the promise has resolved. This format gives us a nice way to work with promises in code. We’ll be using both approaches for the remainder of this chapter.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sending Data with a Request" data-type="sect2"><div class="sect2" id="sending-data-with-request">&#13;
<h2>Sending Data with a Request</h2>&#13;
&#13;
<p>A<a data-primary="data management" data-secondary="requesting data" data-tertiary="sending data with requests" data-type="indexterm" id="idm45901630565608"/> lot of requests require us to upload data with the request. For instance, we need to collect information about a user in order to create an account, or we may need new information about a user to update their account.</p>&#13;
&#13;
<p>Typically, we use a<a data-primary="POST requests" data-type="indexterm" id="idm45901630563512"/> POST request when we’re creating data and a<a data-primary="PUT requests" data-type="indexterm" id="idm45901630562648"/> PUT request when we’re modifying it. The second argument of the <code>fetch</code> function allows us to pass an object of options that <code>fetch</code> can use when creating our HTTP request:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">fetch</code><code class="p">(</code><code class="s2">"/create/user"</code><code class="p">,</code> <code class="p">{</code>&#13;
  <code class="nx">method</code><code class="o">:</code> <code class="s2">"POST"</code><code class="p">,</code>&#13;
  <code class="nx">body</code><code class="o">:</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">({</code> <code class="nx">username</code><code class="p">,</code> <code class="nx">password</code><code class="p">,</code> <code class="nx">bio</code> <code class="p">})</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>This fetch is using the POST method to create a new user. The <code>username</code>, <code>password</code>, and user’s <code>bio</code> are being passed as string content in the <code>body</code> of the request.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Uploading Files with fetch" data-type="sect2"><div class="sect2" id="uploading-files-with-fetch">&#13;
<h2>Uploading Files with fetch</h2>&#13;
&#13;
<p>Uploading<a data-primary="data management" data-secondary="requesting data" data-tertiary="uploading files with fetch" data-type="indexterm" id="idm45901630536872"/><a data-primary="multipart-formdata requests" data-type="indexterm" id="idm45901630535624"/> files requires a different type of HTTP request: a <code>multipart-formdata</code> request. This type of request tells the server that a file or multiple files are located in the body of the request. To make this request in JavaScript, all we have to do is pass a <code>FormData</code> object in the body of our request:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">formData</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">FormData</code><code class="p">();</code>&#13;
<code class="nx">formData</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"username"</code><code class="p">,</code> <code class="s2">"moontahoe"</code><code class="p">);</code>&#13;
<code class="nx">formData</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"fullname"</code><code class="p">,</code> <code class="s2">"Alex Banks"</code><code class="p">);</code>&#13;
<code class="nx">forData</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="s2">"avatar"</code><code class="p">,</code> <code class="nx">imgFile</code><code class="p">);</code>&#13;
&#13;
<code class="nx">fetch</code><code class="p">(</code><code class="s2">"/create/user"</code><code class="p">,</code> <code class="p">{</code>&#13;
  <code class="nx">method</code><code class="o">:</code> <code class="s2">"POST"</code><code class="p">,</code>&#13;
  <code class="nx">body</code><code class="o">:</code> <code class="nx">formData</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>This time, when we create a user, we’re passing the <code>username</code>, <code>fullname</code>, and <code>avatar</code> image along with the request as a <code>formData</code> object. Although these values are <span class="keep-together">hardcoded</span> here, we could easily collect them from a form.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authorized Requests" data-type="sect2"><div class="sect2" id="authorized-requests">&#13;
<h2>Authorized Requests</h2>&#13;
&#13;
<p>Sometimes, we<a data-primary="authorization" data-type="indexterm" id="idm45901630426552"/><a data-primary="data management" data-secondary="requesting data" data-tertiary="authorized requests" data-type="indexterm" id="idm45901630425816"/> need to be authorized to make requests. Authorization is typically required to obtain personal or sensitive data. Additionally, authorization is almost always required for users to take action on the server with POST, PUT, or DELETE requests.</p>&#13;
&#13;
<p>Users typically identify themselves with each request by adding a unique token to the request that a service can use to identify the user. This token is usually added as the <code>Authorization</code> header. On GitHub, you can see your personal account information if you send a token along with your request:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">fetch</code><code class="p">(</code><code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code><code class="p">,</code> <code class="p">{</code>&#13;
  <code class="nx">method</code><code class="o">:</code> <code class="s2">"GET"</code><code class="p">,</code>&#13;
  <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>&#13;
    <code class="nx">Authorization</code><code class="o">:</code> <code class="sb">`Bearer </code><code class="si">${</code><code class="nx">token</code><code class="si">}</code><code class="sb">`</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>Tokens are typically obtained when a user signs into a service by providing their username and password. Tokens can also be obtained from third parties like GitHub or Facebook using with an open standard protocol called OAuth.</p>&#13;
&#13;
<p>GitHub allows you to generate a<a data-primary="Personal User tokens" data-type="indexterm" id="idm45901630410696"/> Personal User token. You can generate one by logging in to GitHub and navigating to: Settings &gt; Developer Settings &gt; Personal Access Tokens. From here, you can create tokens with specific read/write rules and then use those tokens to obtain personal information from the GitHub API. If you generate a<a data-primary="Personal Access tokens" data-type="indexterm" id="idm45901630409640"/> Personal Access Token and send it along with the fetch request, GitHub will provide additional private information about your account.</p>&#13;
&#13;
<p>Fetching<a data-primary="state management" data-secondary="useState hook" data-type="indexterm" id="SMuseState08"/><a data-primary="hooks" data-secondary="useState hook" data-type="indexterm" id="HuseState08"/><a data-primary="useState hook" data-type="indexterm" id="useState08"/><a data-primary="useEffect hook" data-secondary="data requests" data-type="indexterm" id="idm45901630404680"/><a data-primary="hooks" data-secondary="useEffect hook" data-tertiary="data requests" data-type="indexterm" id="idm45901630403736"/> data from within a React component requires us to orchestrate the <code>useState</code> and <code>useEffect</code> hooks. The <code>useState</code> hook is used to store the response in state, and the <code>useEffect</code> hook is used to make the fetch request. For example, if we wanted to display information about a GitHub user in a component, we could use the following code:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useState</code><code class="p">,</code> <code class="nx">useEffect</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
&#13;
<code class="kd">function</code> <code class="nx">GitHubUser</code><code class="p">({</code> <code class="nx">login</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">();</code>&#13;
&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">login</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
    <code class="nx">fetch</code><code class="p">(</code><code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">response</code> <code class="o">=&gt;</code> <code class="nx">response</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">setData</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">},</code> <code class="p">[</code><code class="nx">login</code><code class="p">]);</code>&#13;
&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">pre</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">2</code><code class="p">)}</code><code class="o">&lt;</code><code class="err">/pre&gt;;</code>&#13;
&#13;
  <code class="k">return</code> <code class="kc">null</code><code class="p">;</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">GitHubUser</code> <code class="nx">login</code><code class="o">=</code><code class="s2">"moonhighway"</code> <code class="o">/&gt;</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In this code, our <code>App</code> renders a <code>GitHubUser</code> component and displays JSON data about <code>moonhighway</code>. On the first render, <code>GitHubUser</code> sets up a state variable for <code>data</code> using the <code>useState</code> hook. Then, because <code>data</code> is initially <code>null</code>, the component returns <code>null</code>. Returning <code>null</code> from a component tells React to render nothing. It doesn’t cause an error; we’ll just see a black screen.</p>&#13;
&#13;
<p>After the component is rendered, the <code>useEffect</code> hook is invoked. This is where we make the fetch request. When we get a response, we obtain and parse the data in that response as JSON. Now we can pass that JSON object to the <code>setData</code> function, which causes our component to render once again, but this time it will have data. This <code>useEffect</code> hook will not be invoked again unless the value for <code>login</code> changes. When it does, we’ll need to request more information about a different user from GitHub.</p>&#13;
&#13;
<p>When there is <code>data</code>, we’re rendering it as a JSON string in a <code>pre</code> element. The <code>JSON.stringify</code> method takes three arguments: the JSON data to convert to a string, a replacer function that can be used to replace properties of the JSON object, and the number of spaces to use when formatting the data. In this case, we sent <code>null</code> as the replacer because we don’t want to replace anything. The <code>2</code> represents the number of spaces to be used when formatting the code. This will indent the JSON string two spaces. Using the <code>pre</code> element honors whitespace, so readable JSON is what is finally rendered.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Saving Data Locally" data-type="sect2"><div class="sect2" id="saving-data-locally">&#13;
<h2>Saving Data Locally</h2>&#13;
&#13;
<p>We<a data-primary="data management" data-secondary="requesting data" data-tertiary="saving data locally" data-type="indexterm" id="idm45901630222920"/> can save data locally to the browser using the<a data-primary="Web Storage API" data-type="indexterm" id="idm45901630221448"/> Web Storage API. Data can be saved by either using the<a data-primary="window.localStorage object" data-type="indexterm" id="idm45901630220584"/><a data-primary="window.sessionStorage object" data-type="indexterm" id="idm45901630219944"/> <code>window.localStorage</code> or <code>window.sessionStorage</code> objects. The <code>sessionStorage</code> API only saves data for the user’s session. Closing the tabs or restarting the browser will clear any data saved to <code>sessionStorage</code>. On the other hand, <code>localStorage</code> will save data indefinitely until you remove it.</p>&#13;
&#13;
<p>JSON data should be saved in browser storage as a string. This means converting an object into a JSON string before saving it and parsing that string into JSON while loading it. Some function to handle saving and loading JSON data to the browser could look like:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">loadJSON</code> <code class="o">=</code> <code class="nx">key</code> <code class="o">=&gt;</code>&#13;
  <code class="nx">key</code> <code class="o">&amp;&amp;</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">localStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="nx">key</code><code class="p">));</code>&#13;
<code class="kr">const</code> <code class="nx">saveJSON</code> <code class="o">=</code> <code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code>&#13;
  <code class="nx">localStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code></pre>&#13;
&#13;
<p>The <code>loadJSON</code> function loads an item from <code>localStorage</code> using the <code>key</code>. The <code>localStorage.getItem</code> function is used to load the data. If the item is there, it’s then parsed into JSON before being returned. If it’s not there, the <code>loadJSON</code> function will return <code>null</code>.</p>&#13;
&#13;
<p>The <code>saveJSON</code> function will save some data to <code>localStorage</code> using a unique <code>key</code> identifier. The <code>localStorage.setItem</code> function can be used to save data to the browser. Before saving the data, we’ll need to convert it to a JSON string.</p>&#13;
&#13;
<p>Loading data from web storage, saving data to web storage, stringifying data, and parsing JSON strings are all synchronous tasks. Both the <code>loadJSON</code> and <code>saveJSON</code> functions are synchronous. So be careful—calling these functions too often with too much data can lead to performance issues. It’s typically a good idea to throttle or debounce these functions for the sake of performance.</p>&#13;
&#13;
<p>We could save the user’s data that we received from our GitHub request. Then the next time that same user is requested, we could use the data saved to <code>localStorage</code> instead of sending another request to GitHub. We’ll add the following code to the <code>GitHubUser</code> component:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">loadJSON</code><code class="p">(</code><code class="sb">`user:</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code><code class="p">));</code>&#13;
<code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">data</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">login</code> <code class="o">===</code> <code class="nx">login</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">name</code><code class="p">,</code> <code class="nx">avatar_url</code><code class="p">,</code> <code class="nx">location</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>&#13;
  <code class="nx">saveJSON</code><code class="p">(</code><code class="sb">`user:</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">name</code><code class="p">,</code>&#13;
    <code class="nx">login</code><code class="p">,</code>&#13;
    <code class="nx">avatar_url</code><code class="p">,</code>&#13;
    <code class="nx">location</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">},</code> <code class="p">[</code><code class="nx">data</code><code class="p">]);</code></pre>&#13;
&#13;
<p>The <code>loadJSON</code> function is synchronous, so we can use it when we invoke <code>useState</code> to set the initial value for data. If there was user data saved to the browser under <code>user:moonhighway</code>, we’ll initially set the data using that value. Otherwise, <code>data</code> will initially be <code>null</code>.</p>&#13;
&#13;
<p>When <code>data</code> changes here after it has been loaded from GitHub, we’ll invoke <code>saveJSON</code> to save only those user details that we need: <code>name</code>, <code>login</code>, <code>avatar_url</code>, and <code>location</code>. No need to save the rest of the user object when we’re not using it. We also skip saving the <code>data</code> when that object is empty, <code>!data</code>. Also, if the current login and <code>data.login</code> are equal to each other, then we already have saved data for that user. We’ll skip the step of saving that data again.</p>&#13;
&#13;
<p>Here’s a look at the entire <code>GitHubUser</code> component that uses <code>localStorage</code> to save data in the browser:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useState</code><code class="p">,</code> <code class="nx">useEffect</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">loadJSON</code> <code class="o">=</code> <code class="nx">key</code> <code class="o">=&gt;</code>&#13;
  <code class="nx">key</code> <code class="o">&amp;&amp;</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">localStorage</code><code class="p">.</code><code class="nx">getItem</code><code class="p">(</code><code class="nx">key</code><code class="p">));</code>&#13;
<code class="kr">const</code> <code class="nx">saveJSON</code> <code class="o">=</code> <code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code>&#13;
  <code class="nx">localStorage</code><code class="p">.</code><code class="nx">setItem</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>&#13;
&#13;
<code class="kd">function</code> <code class="nx">GitHubUser</code><code class="p">({</code> <code class="nx">login</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code>&#13;
    <code class="nx">loadJSON</code><code class="p">(</code><code class="sb">`user:</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>&#13;
  <code class="p">);</code>&#13;
&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">data</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">login</code> <code class="o">===</code> <code class="nx">login</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
    <code class="kr">const</code> <code class="p">{</code> <code class="nx">name</code><code class="p">,</code> <code class="nx">avatar_url</code><code class="p">,</code> <code class="nx">location</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>&#13;
    <code class="nx">saveJSON</code><code class="p">(</code><code class="sb">`user:</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code><code class="p">,</code> <code class="p">{</code>&#13;
      <code class="nx">name</code><code class="p">,</code>&#13;
      <code class="nx">login</code><code class="p">,</code>&#13;
      <code class="nx">avatar_url</code><code class="p">,</code>&#13;
      <code class="nx">location</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">},</code> <code class="p">[</code><code class="nx">data</code><code class="p">]);</code>&#13;
&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">login</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">data</code> <code class="o">&amp;&amp;</code> <code class="nx">data</code><code class="p">.</code><code class="nx">login</code> <code class="o">===</code> <code class="nx">login</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
    <code class="nx">fetch</code><code class="p">(</code><code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">response</code> <code class="o">=&gt;</code> <code class="nx">response</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">setData</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">},</code> <code class="p">[</code><code class="nx">login</code><code class="p">]);</code>&#13;
&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">pre</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">2</code><code class="p">)}</code><code class="o">&lt;</code><code class="err">/pre&gt;;</code>&#13;
&#13;
  <code class="k">return</code> <code class="kc">null</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Notice the <code>GitHubUser</code> component now has two <code>useEffect</code> hooks. The first hook is used to save the data to the browser. It’s invoked whenever the value for <code>data</code> changes. The second hook is used to request more data from GitHub. The fetch request is not sent when there’s already data saved locally for that user. This is handled by the second <code>if</code> statement in the second <code>useEffect</code> hook: <code>if (data &amp;&amp; data.login === login) return;</code>. If there is <code>data</code> and the <code>login</code> for that data matches the <code>login</code> property, then there’s no need to send an additional request to GitHub. We’ll just use the local data.</p>&#13;
&#13;
<p>The first time we run the application, if the <code>login</code> is set to <code>moonhighway</code>, the following object will be rendered to the page:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"login"</code><code class="p">:</code> <code class="s2">"MoonHighway"</code><code class="p">,</code>&#13;
  <code class="nt">"id"</code><code class="p">:</code> <code class="mi">5952087</code><code class="p">,</code>&#13;
  <code class="nt">"node_id"</code><code class="p">:</code> <code class="s2">"MDEyOk9yZ2FuaXphdGlvbjU5NTIwODc="</code><code class="p">,</code>&#13;
  <code class="nt">"avatar_url"</code><code class="p">:</code> <code class="s2">"https://avatars0.githubusercontent.com/u/5952087?v=4"</code><code class="p">,</code>&#13;
  <code class="nt">"gravatar_id"</code><code class="p">:</code> <code class="s2">""</code><code class="p">,</code>&#13;
  <code class="nt">"url"</code><code class="p">:</code> <code class="s2">"https://api.github.com/users/MoonHighway"</code><code class="p">,</code>&#13;
  <code class="nt">"html_url"</code><code class="p">:</code> <code class="s2">"https://github.com/MoonHighway"</code><code class="p">,</code>&#13;
&#13;
  <code class="err">...</code>&#13;
&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This is the response from GitHub. We can tell because this object contains a lot of extra information about the user that we don’t need. The first time we run this page we’ll see this lengthy response. But the second time we run the page, the response is much shorter:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Moon Highway"</code><code class="p">,</code>&#13;
  <code class="nt">"login"</code><code class="p">:</code> <code class="s2">"moonhighway"</code><code class="p">,</code>&#13;
  <code class="nt">"avatar_url"</code><code class="p">:</code> <code class="s2">"https://avatars0.githubusercontent.com/u/5952087?v=4"</code><code class="p">,</code>&#13;
  <code class="nt">"location"</code><code class="p">:</code> <code class="s2">"Tahoe City, CA"</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This time, the data we saved locally for <code>moonhighway</code> is being rendered to the browser. Since we only needed four fields of data, we only saved four fields of data. We’ll always see this smaller offline object until we clear the storage:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">localStorage</code><code class="p">.</code><code class="nx">clear</code><code class="p">();</code></pre>&#13;
&#13;
<p>Both <code>sessionStorage</code> and <code>localStorage</code> are essential weapons for web developers. We can work with this local data when we’re offline, and they allow us to increase the performance of our applications by sending fewer network requests. However, we must know when to use them. Implementing offline storage adds complexity to our applications, and it can make them tough to work with in development. Additionally, we don’t need to work with web storage to cache data. If we’re simply looking for a performance bump, we could try letting HTTP handle caching. Our browser will automatically cache content if we add <code>Cache-Control: max-age=&lt;EXP_DATE&gt;</code> to our headers. The <code>EXP_DATE</code> defines the expiration date for the content.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Handling Promise States" data-type="sect2"><div class="sect2" id="handling-promise-states">&#13;
<h2>Handling Promise States</h2>&#13;
&#13;
<p>HTTP<a data-primary="state management" data-secondary="handling promise states" data-type="indexterm" id="idm45901629657352"/><a data-primary="promises" data-secondary="handling promise states" data-type="indexterm" id="idm45901629656344"/><a data-primary="data management" data-secondary="requesting data" data-tertiary="handling promise states" data-type="indexterm" id="idm45901629655400"/> requests and promises both have three states: pending, success (fulfilled), and fail (rejected). A request is <em>pending</em> when we make the request and are waiting for a response. That response can only go one of two ways: success or fail. If a response is successful, it means we’ve successfully connected to the server and have received data. In the world of promises, a successful response means that the promise has been <em>resolved</em>. If something goes wrong during this process, we can say the HTTP request has failed or the promise has been <em>rejected</em>. In both cases, we’ll receive an <code>error</code> explaining what happened.</p>&#13;
&#13;
<p>We really need to handle all three of these states when we make HTTP requests. We can modify the GitHub user component to render more than just a successful response. We can add a “loading…” message when the request is pending, or we can render the <code>error</code> details if something goes wrong:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">GitHubUser</code><code class="p">({</code> <code class="nx">login</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">();</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">error</code><code class="p">,</code> <code class="nx">setError</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">();</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">loading</code><code class="p">,</code> <code class="nx">setLoading</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>&#13;
&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">login</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
    <code class="nx">setLoading</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>&#13;
    <code class="nx">fetch</code><code class="p">(</code><code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">data</code> <code class="o">=&gt;</code> <code class="nx">data</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">setData</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">setLoading</code><code class="p">(</code><code class="kc">false</code><code class="p">))</code>&#13;
      <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">setError</code><code class="p">);</code>&#13;
  <code class="p">},</code> <code class="p">[</code><code class="nx">login</code><code class="p">]);</code>&#13;
&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="nx">loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/h1&gt;;</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">pre</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">2</code><code class="p">)}</code><code class="o">&lt;</code><code class="err">/pre&gt;;</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">data</code><code class="p">)</code> <code class="k">return</code> <code class="kc">null</code><code class="p">;</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"githubUser"</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">img</code>&#13;
        <code class="nx">src</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">avatar_url</code><code class="p">}</code>&#13;
        <code class="nx">alt</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">login</code><code class="p">}</code>&#13;
        <code class="nx">style</code><code class="o">=</code><code class="p">{{</code> <code class="nx">width</code><code class="o">:</code> <code class="mi">200</code> <code class="p">}}</code>&#13;
      <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">login</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/h1&gt;</code>&#13;
        <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">name</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
        <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">location</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">location</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
      <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>When this request is successful, Moon Highway’s information is rendered for the user to see on the screen, as shown in <a data-type="xref" href="#fig0801">Figure 8-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig0801">&#13;
<img alt="Sample Output" src="assets/lrc2_0801.png"/>&#13;
<h6><span class="label">Figure 8-1. </span>Sample output</h6>&#13;
</div></figure>&#13;
&#13;
<p>If something goes wrong, we’re simply displaying the <code>error</code> object as a JSON string. In production, we would do more with the error. Maybe we would track it, log it, or try to make another request. While in development, it’s OK to render error details, which gives the developer instant feedback.</p>&#13;
&#13;
<p>Finally, while the request is pending, we simply display a “loading…” message using an <code>h1</code>.</p>&#13;
&#13;
<p>Sometimes an HTTP request can succeed with an error. This happens when the request was successful—successfully connected to a server and received a response—but the response body contains an error. Sometimes servers pass additional errors as successful responses.</p>&#13;
&#13;
<p>Handling all three of these states bloats our code a little bit, but it’s essential to do so on every request. Requests take time and a lot could go wrong. Because all requests—and promises—have these three states, it makes it possible to handle all HTTP requests with a reusable hook, or a component, or even a React feature called Suspense. We’ll cover each of these approaches, but first, we must introduce the concept of render props.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Render Props" data-type="sect1"><div class="sect1" id="render-props">&#13;
<h1>Render Props</h1>&#13;
&#13;
<p><em>Render props</em> are<a data-primary="data management" data-secondary="render props" data-type="indexterm" id="idm45901629323560"/><a data-primary="render props pattern" data-type="indexterm" id="idm45901629322552"/> exactly what they sound like: properties that are rendered. This can mean components that are sent as properties that are rendered when specific conditions are met, or it can mean function properties that return components that will be rendered. In the second case, when they’re functions, data can be passed as arguments and used when rendering the returned component.</p>&#13;
&#13;
<p>Render<a data-primary="asynchronous programming" data-secondary="render props pattern" data-type="indexterm" id="idm45901629320984"/> props are useful when maximizing reusability in asynchronous components. With this pattern, we can create components that abstract away complex mechanics or monotonous boilerplate that’s necessary for application development.</p>&#13;
&#13;
<p>Consider the task of displaying a list:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">tahoe_peaks</code> <code class="o">=</code> <code class="p">[</code>&#13;
  <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Freel Peak"</code><code class="p">,</code> <code class="nx">elevation</code><code class="o">:</code> <code class="mi">10891</code> <code class="p">},</code>&#13;
  <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Monument Peak"</code><code class="p">,</code> <code class="nx">elevation</code><code class="o">:</code> <code class="mi">10067</code> <code class="p">},</code>&#13;
  <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Pyramid Peak"</code><code class="p">,</code> <code class="nx">elevation</code><code class="o">:</code> <code class="mi">9983</code> <code class="p">},</code>&#13;
  <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"Mt. Tallac"</code><code class="p">,</code> <code class="nx">elevation</code><code class="o">:</code> <code class="mi">9735</code> <code class="p">}</code>&#13;
<code class="p">];</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">ul</code><code class="o">&gt;</code>&#13;
      <code class="p">{</code><code class="nx">tahoe_peaks</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">peak</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">li</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">i</code><code class="p">}</code><code class="o">&gt;</code>&#13;
          <code class="p">{</code><code class="nx">peak</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code> <code class="o">-</code> <code class="p">{</code><code class="nx">peak</code><code class="p">.</code><code class="nx">elevation</code><code class="p">.</code><code class="nx">toLocaleString</code><code class="p">()}</code><code class="nx">ft</code>&#13;
        <code class="o">&lt;</code><code class="err">/li&gt;</code>&#13;
      <code class="p">))}</code>&#13;
    <code class="o">&lt;</code><code class="err">/ul&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In this example, the four tallest peaks in Tahoe are rendered into an unordered list. This code makes sense, but mapping over an array to render each item individually does introduce some code complexity. Mapping over an array of items is also a pretty common task. We may find ourselves frequently repeating this pattern. We could create a <code>List</code> component that we can reuse as a solution whenever we need to render an unordered list.</p>&#13;
&#13;
<p>In JavaScript, arrays either contain values or they’re empty. When a list is empty, we need to display a message to our users. However, that message may change upon implementation. No worries—we can pass a component to render when the list is empty:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">List</code><code class="p">({</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[],</code> <code class="nx">renderEmpty</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="k">return</code> <code class="nx">renderEmpty</code><code class="p">;</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">length</code><code class="p">}</code> <code class="nx">items</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">List</code> <code class="nx">renderEmpty</code><code class="o">=</code><code class="p">{</code><code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">This</code> <code class="nx">list</code> <code class="nx">is</code> <code class="nx">empty</code><code class="o">&lt;</code><code class="sr">/p&gt;} /</code><code class="o">&gt;</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>List</code> component expects two properties: <code>data</code> and <code>renderEmpty</code>. The first argument, <code>data</code>, represents the array of items that are to be mapped over. Its default value is an empty array. The second argument, <code>renderEmpty</code>, is a component that will be rendered if the list is empty. So when <code>data.length</code> is <code>0</code>, the <code>List</code> component renders whatever was passed as the <code>renderEmpty</code> property by returning that property.</p>&#13;
&#13;
<p>In this case, users would see the following message: <code>This list is empty</code>.</p>&#13;
&#13;
<p><code>renderEmpty</code> is a render prop because it contains a component to render when a particular condition has been met—in this case, when the list is empty or the <code>data</code> property has not been provided.</p>&#13;
&#13;
<p>We can send this component an actual array of <code>data</code>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">List</code>&#13;
      <code class="nx">data</code><code class="o">=</code><code class="p">{</code><code class="nx">tahoe_peaks</code><code class="p">}</code>&#13;
      <code class="nx">renderEmpty</code><code class="o">=</code><code class="p">{</code><code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">This</code> <code class="nx">list</code> <code class="nx">is</code> <code class="nx">empty</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
    <code class="err">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Doing so at this point only renders the number of items found within the array: <code>4 items</code>.</p>&#13;
&#13;
<p>We can also tell our <code>List</code> component what to render for each item found within the array. For example, we can send a <code>renderItem</code> property:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">List</code>&#13;
      <code class="nx">data</code><code class="o">=</code><code class="p">{</code><code class="nx">tahoe_peaks</code><code class="p">}</code>&#13;
      <code class="nx">renderEmpty</code><code class="o">=</code><code class="p">{</code><code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">This</code> <code class="nx">list</code> <code class="nx">is</code> <code class="nx">empty</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
      <code class="nx">renderItem</code><code class="o">=</code><code class="p">{</code><code class="nx">item</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
        <code class="o">&lt;&gt;</code>&#13;
          <code class="p">{</code><code class="nx">item</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code> <code class="o">-</code> <code class="p">{</code><code class="nx">item</code><code class="p">.</code><code class="nx">elevation</code><code class="p">.</code><code class="nx">toLocaleString</code><code class="p">()}</code><code class="nx">ft</code>&#13;
        <code class="o">&lt;</code><code class="err">/&gt;</code>&#13;
      <code class="p">)}</code>&#13;
    <code class="o">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This time, the render prop is a function. The data (the item itself) is passed to this function as an argument so that it can be used when what to render for each Tahoe Peak is decided. In this case, we render a React fragment that displays the item’s <code>name</code> and <code>elevation</code>. If the array is <code>tahoe_peaks</code>, we expect the <code>renderItem</code> property to be invoked four times: once for each of the peaks in the array.</p>&#13;
&#13;
<p>This approach allows us to abstract away the mechanics of mapping over arrays. Now the <code>List</code> component will handle the mapping; we just have to tell it what to render:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">List</code><code class="p">({</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[],</code> <code class="nx">renderItem</code><code class="p">,</code> <code class="nx">renderEmpty</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="o">!</code><code class="nx">data</code><code class="p">.</code><code class="nx">length</code> <code class="o">?</code> <code class="p">(</code>&#13;
    <code class="nx">renderEmpty</code>&#13;
  <code class="p">)</code> <code class="o">:</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">ul</code><code class="o">&gt;</code>&#13;
      <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">item</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">li</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">i</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">renderItem</code><code class="p">(</code><code class="nx">item</code><code class="p">)}</code><code class="o">&lt;</code><code class="err">/li&gt;</code>&#13;
      <code class="p">))}</code>&#13;
    <code class="o">&lt;</code><code class="err">/ul&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>When the <code>data</code> array is not empty, the <code>List</code> component renders an unordered list, <code>&lt;ul&gt;</code>. It maps over each item within the array using the <code>.map</code> method and renders a list item, <code>&lt;li&gt;</code>, for every value within the array. The <code>List</code> component makes sure each list item receives a unique <code>key</code>. Within each <code>&lt;li&gt;</code> element, the <code>renderItem</code> property is invoked and the item itself is passed to that function property as an argument. The result is an unordered list that displays the name and elevation of each of Tahoe’s tallest peaks.</p>&#13;
&#13;
<p>The good news is we have a reusable <code>List</code> component that we can use whenever we need to render an unordered list. The bad news is our component is a bit bare bones. There are better components we can use to handle this task.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Virtualized Lists" data-type="sect1"><div class="sect1" id="virtualized-lists">&#13;
<h1>Virtualized Lists</h1>&#13;
&#13;
<p>If <a data-primary="data management" data-secondary="virtualized lists" data-tertiary="purpose of" data-type="indexterm" id="idm45901628773656"/><a data-primary="virtualized lists" data-secondary="purpose of" data-type="indexterm" id="idm45901628772376"/>it’s our job to develop a reusable component for rendering lists, there are many different use cases to consider and solutions to implement. One of the most important things to consider is what happens when the list is very large. Many of the data points we work with in production can feel infinite. A Google search yields pages and pages of results. Searching for a place to stay in Tahoe on Airbnb results in a list of houses and apartments that seems to never end. Production applications typically have a lot of data that needs to be rendered, but we can’t render it all at once.</p>&#13;
&#13;
<p>There’s a limit to what the browser can render. Rendering takes time, processing power, and memory, all three of which have eventual limitations. This should be taken into consideration when developing a reusable list component. When the <code>data</code> array is very large, what should we do?</p>&#13;
&#13;
<p>Even though our search for a place to stay may have yielded one thousand results, we cannot possibly look at all those results at the same time—there’s not enough screen space for all the images, names, and prices. We might only be able to see about five results at a time. When scrolling, we can see more results, but we have to scroll down pretty far to see a thousand results. Rendering a thousand results in a scrollable layer is asking a lot of the phone.</p>&#13;
&#13;
<p>Instead of rendering 1,000 results at a time, what if we only rendered 11? Remember that the user can only see about five results on one screen. So we render the five items the user can see and render six items off screen both above and below the visible window of items. Rendering items above and below the visible window will allow the user to scroll in both directions. We can see that in <a data-type="xref" href="#fig0802">Figure 8-2</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig0802">&#13;
<img alt="Windowing Diagram" src="assets/lrc2_0802.png"/>&#13;
<h6><span class="label">Figure 8-2. </span>Windowing with off-screen content</h6>&#13;
</div></figure>&#13;
&#13;
<p>As the user scrolls, we can unmount the results that have already been viewed as well as render new results off screen, ready for the user to reveal via the scroll. This resulting solution means that the browser will only render 11 elements at a time while the data for the rest of the elements is there waiting to be rendered. This technique is called<a data-primary="windowing" data-type="indexterm" id="idm45901628764328"/><a data-primary="virtualization" data-type="indexterm" id="idm45901628763624"/> <em>windowing</em> or <em>virtualization</em>. It allows us to scroll very large, sometimes infinite lists of data without crashing our browser.</p>&#13;
&#13;
<p>There’s a lot to consider when building a virtualized list component. Thankfully, we don’t have to start from scratch; the community has already developed many virtualized list components for us to use. The most popular of these for the browser are <code>react-window</code> and <code>react-virtualized</code>. Virtualized lists are so important that React Native even ships with one: the <code>FlatList</code>. Most of us will not have to build virtualized list components, but we do need to know how to use them.</p>&#13;
&#13;
<p>To<a data-primary="data management" data-secondary="virtualized lists" data-tertiary="implementing" data-type="indexterm" id="idm45901628759336"/><a data-primary="virtualized lists" data-secondary="implementing" data-type="indexterm" id="idm45901628758056"/> implement a virtualized list, we’re going to need a lot of data—in this case, fake<a data-primary="fake data" data-type="indexterm" id="idm45901628756984"/> data:</p>&#13;
&#13;
<pre data-type="programlisting">npm i faker</pre>&#13;
&#13;
<p>Installing faker will allow us to create a large array of fake data. For this example, we’ll use fake users. We’ll create five thousand fake users at random:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">faker</code> <code class="nx">from</code> <code class="s2">"faker"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">bigList</code> <code class="o">=</code> <code class="p">[...</code><code class="nb">Array</code><code class="p">(</code><code class="mi">5000</code><code class="p">)].</code><code class="nx">map</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">({</code>&#13;
  <code class="nx">name</code><code class="o">:</code> <code class="nx">faker</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">findName</code><code class="p">(),</code>&#13;
  <code class="nx">email</code><code class="o">:</code> <code class="nx">faker</code><code class="p">.</code><code class="nx">internet</code><code class="p">.</code><code class="nx">email</code><code class="p">(),</code>&#13;
  <code class="nx">avatar</code><code class="o">:</code> <code class="nx">faker</code><code class="p">.</code><code class="nx">internet</code><code class="p">.</code><code class="nx">avatar</code><code class="p">()</code>&#13;
<code class="p">}));</code></pre>&#13;
&#13;
<p>The <code>bigList</code> variable was created by mapping over an array of five thousand empty values and replacing those empty values with information about a fake user. The <code>name</code>, <code>email</code>, and <code>avatar</code> for each user are generated at random using functions supplied by <code>faker</code>.</p>&#13;
&#13;
<p>If we use the <code>List</code> component we created in the last section, it will render all five thousand users at the same time:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">renderItem</code> <code class="o">=</code> <code class="nx">item</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">style</code><code class="o">=</code><code class="p">{{</code> <code class="nx">display</code><code class="o">:</code> <code class="s2">"flex"</code> <code class="p">}}</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">img</code> <code class="nx">src</code><code class="o">=</code><code class="p">{</code><code class="nx">item</code><code class="p">.</code><code class="nx">avatar</code><code class="p">}</code> <code class="nx">alt</code><code class="o">=</code><code class="p">{</code><code class="nx">item</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code> <code class="nx">width</code><code class="o">=</code><code class="p">{</code><code class="mi">50</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code>&#13;
        <code class="p">{</code><code class="nx">item</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code> <code class="o">-</code> <code class="p">{</code><code class="nx">item</code><code class="p">.</code><code class="nx">email</code><code class="p">}</code>&#13;
      <code class="o">&lt;</code><code class="err">/p&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">List</code> <code class="nx">data</code><code class="o">=</code><code class="p">{</code><code class="nx">bigList</code><code class="p">}</code> <code class="nx">renderItem</code><code class="o">=</code><code class="p">{</code><code class="nx">renderItem</code><code class="p">}</code> <code class="o">/&gt;</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This code creates a <code>div</code> element for each user. Within that <code>div</code>, an <code>img</code> element is rendered for that user’s photo, and the user <code>name</code> and <code>email</code> are rendered with a paragraph element, as shown in <a data-type="xref" href="#fig0803">Figure 8-3</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig0803">&#13;
<img alt="Performance Results" src="assets/lrc2_0803.png"/>&#13;
<h6><span class="label">Figure 8-3. </span>Performance results</h6>&#13;
</div></figure>&#13;
&#13;
<p>The combination of React and modern browsers is already pretty amazing. We’re most likely able to render all five thousand users, but it takes a while. In this example, it took 52ms to be exact. As the number of users in our list goes up, so does this time, until we eventually reach a tipping point.</p>&#13;
&#13;
<p>Let’s render the same fake user list using <code>react-window</code>:</p>&#13;
&#13;
<pre data-type="programlisting">npm i react-window</pre>&#13;
&#13;
<p><code>react-window</code> is a library that has several components we can use to render virtualized lists. In this example, we’ll use the <code>FixSizeList</code> component from <code>react-window</code>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">FixedSizeList</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"react-window"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">faker</code> <code class="nx">from</code> <code class="s2">"faker"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">bigList</code> <code class="o">=</code> <code class="p">[...</code><code class="nb">Array</code><code class="p">(</code><code class="mi">5000</code><code class="p">)].</code><code class="nx">map</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">({</code>&#13;
  <code class="nx">name</code><code class="o">:</code> <code class="nx">faker</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">findName</code><code class="p">(),</code>&#13;
  <code class="nx">email</code><code class="o">:</code> <code class="nx">faker</code><code class="p">.</code><code class="nx">internet</code><code class="p">.</code><code class="nx">email</code><code class="p">(),</code>&#13;
  <code class="nx">avatar</code><code class="o">:</code> <code class="nx">faker</code><code class="p">.</code><code class="nx">internet</code><code class="p">.</code><code class="nx">avatar</code><code class="p">()</code>&#13;
<code class="p">}));</code>&#13;
&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">renderRow</code> <code class="o">=</code> <code class="p">({</code> <code class="nx">index</code><code class="p">,</code> <code class="nx">style</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">style</code><code class="o">=</code><code class="p">{{</code> <code class="p">...</code><code class="nx">style</code><code class="p">,</code> <code class="p">...{</code> <code class="nx">display</code><code class="o">:</code> <code class="s2">"flex"</code> <code class="p">}</code> <code class="p">}}</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">img</code>&#13;
        <code class="nx">src</code><code class="o">=</code><code class="p">{</code><code class="nx">bigList</code><code class="p">[</code><code class="nx">index</code><code class="p">].</code><code class="nx">avatar</code><code class="p">}</code>&#13;
        <code class="nx">alt</code><code class="o">=</code><code class="p">{</code><code class="nx">bigList</code><code class="p">[</code><code class="nx">index</code><code class="p">].</code><code class="nx">name</code><code class="p">}</code>&#13;
        <code class="nx">width</code><code class="o">=</code><code class="p">{</code><code class="mi">50</code><code class="p">}</code>&#13;
      <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code>&#13;
        <code class="p">{</code><code class="nx">bigList</code><code class="p">[</code><code class="nx">index</code><code class="p">].</code><code class="nx">name</code><code class="p">}</code> <code class="o">-</code> <code class="p">{</code><code class="nx">bigList</code><code class="p">[</code><code class="nx">index</code><code class="p">].</code><code class="nx">email</code><code class="p">}</code>&#13;
      <code class="o">&lt;</code><code class="err">/p&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">FixedSizeList</code>&#13;
      <code class="nx">height</code><code class="o">=</code><code class="p">{</code><code class="nb">window</code><code class="p">.</code><code class="nx">innerHeight</code><code class="p">}</code>&#13;
      <code class="nx">width</code><code class="o">=</code><code class="p">{</code><code class="nb">window</code><code class="p">.</code><code class="nx">innerWidth</code> <code class="o">-</code> <code class="mi">20</code><code class="p">}</code>&#13;
      <code class="nx">itemCount</code><code class="o">=</code><code class="p">{</code><code class="nx">bigList</code><code class="p">.</code><code class="nx">length</code><code class="p">}</code>&#13;
      <code class="nx">itemSize</code><code class="o">=</code><code class="p">{</code><code class="mi">50</code><code class="p">}</code>&#13;
    <code class="o">&gt;</code>&#13;
      <code class="p">{</code><code class="nx">renderRow</code><code class="p">}</code>&#13;
    <code class="o">&lt;</code><code class="err">/FixedSizeList&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p><code>FixedSizeList</code> is slightly different from our <code>List</code> component. It requires the total number of items in the list along with the number of pixels each row requires as the <code>itemSize</code> property. Another big difference in this syntax is that the render prop is being passed to <code>FixedSizeList</code> as the <code>children</code> property. This render props pattern is used quite frequently.</p>&#13;
&#13;
<p>So, let’s see what happens when five thousand fake users are rendered with the <code>FixSizeList</code> component (see <a data-type="xref" href="#fig0804">Figure 8-4</a>).</p>&#13;
&#13;
<p>This time, not all of the users are being rendered at once. Only those rows that the user can see or easily scroll to are being rendered. Notice that it only takes 2.6ms for this initial render.</p>&#13;
&#13;
<p>As you scroll down to reveal more users, the <code>FixedSizeList</code> is hard at work rendering more users off screen as well as removing users that have scrolled off screen. This component automatically handles scrolling in both directions. This component may render quite frequently, but the renders are fast. It also doesn’t matter how many users are in our array: the <code>FixedSizeList</code> can handle it.</p>&#13;
&#13;
<figure><div class="figure" id="fig0804">&#13;
<img alt="Performance Results" src="assets/lrc2_0804.png"/>&#13;
<h6><span class="label">Figure 8-4. </span>2.6ms for this render</h6>&#13;
</div></figure>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a Fetch Hook" data-type="sect2"><div class="sect2" id="creating-a-fetch-hook">&#13;
<h2>Creating a Fetch Hook</h2>&#13;
&#13;
<p>We<a data-primary="data management" data-secondary="virtualized lists" data-tertiary="creating fetch hooks" data-type="indexterm" id="idm45901628338104"/><a data-primary="virtualized lists" data-secondary="creating fetch hooks" data-type="indexterm" id="idm45901628336824"/><a data-primary="useFetch hook" data-type="indexterm" id="idm45901628335880"/><a data-primary="hooks" data-secondary="creating fetch hooks" data-type="indexterm" id="idm45901628335208"/> know that a request is either pending, successful, or failed. We can reuse the logic that’s necessary for making a fetch request by creating a custom hook. We’ll call this hook <code>useFetch</code>, and we can use it in components across our application whenever we need to make a fetch request:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useState</code><code class="p">,</code> <code class="nx">useEffect</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="kd">function</code> <code class="nx">useFetch</code><code class="p">(</code><code class="nx">uri</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">data</code><code class="p">,</code> <code class="nx">setData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">();</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">error</code><code class="p">,</code> <code class="nx">setError</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">();</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">loading</code><code class="p">,</code> <code class="nx">setLoading</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>&#13;
&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">uri</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
    <code class="nx">fetch</code><code class="p">(</code><code class="nx">uri</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">data</code> <code class="o">=&gt;</code> <code class="nx">data</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">setData</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">setLoading</code><code class="p">(</code><code class="kc">false</code><code class="p">))</code>&#13;
      <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">setError</code><code class="p">);</code>&#13;
  <code class="p">},</code> <code class="p">[</code><code class="nx">uri</code><code class="p">]);</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">{</code>&#13;
    <code class="nx">loading</code><code class="p">,</code>&#13;
    <code class="nx">data</code><code class="p">,</code>&#13;
    <code class="nx">error</code>&#13;
  <code class="p">};</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This<a data-primary="hooks" data-secondary="custom hooks" data-type="indexterm" id="idm45901628331352"/> custom hook was created by composing the <code>useState</code> and <code>useEffect</code> hooks. The three states of a fetch request are represented in this hook: pending, success, and error. When the request is pending, the hook will return <code>true</code> for <code>loading</code>. When the request is successful and <code>data</code> is retrieved, it will be passed to the component from this hook. If something goes wrong, then this hook will return the error.</p>&#13;
&#13;
<p>All three of these states are managed inside of the <code>useEffect</code> hook. This hook is invoked every time the value for <code>uri</code> changes. If there’s no <code>uri</code>, the fetch request is not made. When there’s a <code>uri</code>, the fetch request begins. If the request is successful, we pass the resulting JSON to the <code>setData</code> function, changing the state value for <code>data</code>. After that, we then change the state value for <code>loading</code> to false because the request was successful (i.e., it’s no longer pending). Finally, if anything goes wrong, we catch it and pass it to <code>setError</code>, which changes the state value for <code>error</code>.</p>&#13;
&#13;
<p>Now we can use this hook to make fetch requests within our components. Anytime the values for <code>loading</code>, <code>data</code>, or <code>error</code> change, this hook causes the <code>GitHubUser</code> component to rerender with those new values:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">GitHubUser</code><code class="p">({</code> <code class="nx">login</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">data</code><code class="p">,</code> <code class="nx">error</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useFetch</code><code class="p">(</code>&#13;
    <code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code>&#13;
  <code class="p">);</code>&#13;
&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="nx">loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/h1&gt;;</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">pre</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">2</code><code class="p">)}</code><code class="o">&lt;</code><code class="err">/pre&gt;;</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"githubUser"</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">img</code>&#13;
        <code class="nx">src</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">avatar_url</code><code class="p">}</code>&#13;
        <code class="nx">alt</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">login</code><code class="p">}</code>&#13;
        <code class="nx">style</code><code class="o">=</code><code class="p">{{</code> <code class="nx">width</code><code class="o">:</code> <code class="mi">200</code> <code class="p">}}</code>&#13;
      <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">login</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/h1&gt;</code>&#13;
        <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">name</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
        <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">location</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">location</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
      <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Although the component now has less logic, it still handles all three states. Assuming we have a <code>SearchForm</code> component ready to collect search strings from the user, we can add the <code>GitHubUser</code> component to our main <code>App</code> component:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useState</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">GitHubUser</code> <code class="nx">from</code> <code class="s2">"./GitHubUser"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">SearchForm</code> <code class="nx">from</code> <code class="s2">"./SearchForm"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">login</code><code class="p">,</code> <code class="nx">setLogin</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="s2">"moontahoe"</code><code class="p">);</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">SearchForm</code> <code class="nx">value</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{</code><code class="nx">setLogin</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">GitHubUser</code> <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The main <code>App</code> component stores the username of the GitHub user in state. The only way to change this value is to use the search form to search for a new user. Whenever the value of <code>login</code> changes, the value sent to <code>useFetch</code> changes because it depends on the login property: <em>https://api.github.com/users/${login}</em>. This changes the <code>uri</code> within our hook and triggers a fetch request for the new user login. We’ve created a custom hook and used it to successfully create a small application that can be used to look up and display GitHub user details. We’ll continue to use this hook as we iterate on this application.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a Fetch Component" data-type="sect2"><div class="sect2" id="creating-a-fetch-component">&#13;
<h2>Creating a Fetch Component</h2>&#13;
&#13;
<p>Hooks<a data-primary="data management" data-secondary="virtualized lists" data-tertiary="creating fetch components" data-type="indexterm" id="idm45901627733160"/><a data-primary="virtualized lists" data-secondary="creating fetch components" data-type="indexterm" id="idm45901627731864"/><a data-primary="components" data-secondary="creating fetch components" data-type="indexterm" id="idm45901627730904"/> typically allow us to reuse functionality across components. There are times when we find ourselves repeating the exact same pattern when it comes to rendering within our components. For example, the loading spinner we choose to render may be the exact same spinner we want to render across our entire application whenever a fetch request is pending. The way we handle errors with our fetch requests may also be consistent across our application.</p>&#13;
&#13;
<p>Instead of replicating the exact same code in multiple components across our application, we can create one component to render consistent loading spinners and consistently handle all of our errors across our entire domain. Let’s create a <code>Fetch</code> component:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">Fetch</code><code class="p">({</code>&#13;
  <code class="nx">uri</code><code class="p">,</code>&#13;
  <code class="nx">renderSuccess</code><code class="p">,</code>&#13;
  <code class="nx">loadingFallback</code> <code class="o">=</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;,</code>&#13;
  <code class="nx">renderError</code> <code class="o">=</code> <code class="nx">error</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">pre</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">2</code><code class="p">)}</code><code class="o">&lt;</code><code class="err">/pre&gt;</code>&#13;
  <code class="p">)</code>&#13;
<code class="p">})</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">data</code><code class="p">,</code> <code class="nx">error</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useFetch</code><code class="p">(</code><code class="nx">uri</code><code class="p">);</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="nx">loadingFallback</code><code class="p">;</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="nx">renderError</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="k">return</code> <code class="nx">renderSuccess</code><code class="p">({</code> <code class="nx">data</code> <code class="p">});</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The custom hook, <code>useFetch</code>, is one layer of abstraction: it abstracts away the mechanics of making a fetch request. The <code>Fetch</code> component is an additional layer of abstraction: it abstracts away the mechanics of handling what to render. When the request is loading, the <code>Fetch</code> component will render whatever was passed to the optional <span class="keep-together"><code>loadingFallback</code></span> property. When it’s successful, the JSON response data is passed to the <code>renderSuccess</code> property. If there’s an error, it’s rendered using the optional <code>renderError</code> property. The <code>loadingFallback</code> and <code>renderError</code> properties provide an optional layer of customization. However, when they’re not supplied, they fall back to their default values.</p>&#13;
&#13;
<p>With the <code>Fetch</code> component in our arsenal, we can really simplify the logic in our <code>GitHubUser</code> component:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">Fetch</code> <code class="nx">from</code> <code class="s2">"./Fetch"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">GitHubUser</code><code class="p">({</code> <code class="nx">login</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">Fetch</code>&#13;
      <code class="nx">uri</code><code class="o">=</code><code class="p">{</code><code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code><code class="p">}</code>&#13;
      <code class="nx">renderSuccess</code><code class="o">=</code><code class="p">{</code><code class="nx">UserDetails</code><code class="p">}</code>&#13;
    <code class="o">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kd">function</code> <code class="nx">UserDetails</code><code class="p">({</code> <code class="nx">data</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"githubUser"</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">img</code>&#13;
        <code class="nx">src</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">avatar_url</code><code class="p">}</code>&#13;
        <code class="nx">alt</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">login</code><code class="p">}</code>&#13;
        <code class="nx">style</code><code class="o">=</code><code class="p">{{</code> <code class="nx">width</code><code class="o">:</code> <code class="mi">200</code> <code class="p">}}</code>&#13;
      <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">login</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/h1&gt;</code>&#13;
        <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">name</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
        <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">location</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">location</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
      <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>GitHubUser</code> component receives a <code>login</code> for a user to look up on GitHub. We use that login to construct the <code>uri</code> property we send to the <code>fetch</code> component. If successful, the <code>UserDetails</code> component is rendered. When the <code>Fetch</code> component is loading, the default “loading…” message will be displayed. If something goes wrong, the error details are automatically displayed.</p>&#13;
&#13;
<p>We can provide custom values for these properties. Here’s an example of how we can alternatively use our flexible component:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="o">&lt;</code><code class="nx">Fetch</code>&#13;
  <code class="nx">uri</code><code class="o">=</code><code class="p">{</code><code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code><code class="p">}</code>&#13;
  <code class="nx">loadingFallback</code><code class="o">=</code><code class="p">{</code><code class="o">&lt;</code><code class="nx">LoadingSpinner</code> <code class="o">/&gt;</code><code class="p">}</code>&#13;
  <code class="nx">renderError</code><code class="o">=</code><code class="p">{</code><code class="nx">error</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="c1">// handle error</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Something</code> <code class="nx">went</code> <code class="nx">wrong</code><code class="p">...</code> <code class="p">{</code><code class="nx">error</code><code class="p">.</code><code class="nx">message</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="p">}}</code>&#13;
  <code class="nx">renderSuccess</code><code class="o">=</code><code class="p">{({</code> <code class="nx">data</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
    <code class="o">&lt;&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="nx">Todo</code><code class="o">:</code> <code class="nx">Render</code> <code class="nx">UI</code> <code class="k">for</code> <code class="nx">data</code><code class="o">&lt;</code><code class="err">/h1&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">pre</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">2</code><code class="p">)}</code><code class="o">&lt;</code><code class="err">/pre&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/&gt;</code>&#13;
  <code class="p">)}</code>&#13;
<code class="err">/&gt;</code></pre>&#13;
&#13;
<p>This time, the <code>Fetch</code> component will render our custom loading spinner. If something goes wrong, we hide the error details. When the request is successful, we’ve chosen to alternatively render the raw data along with a TODO message for <span class="keep-together">ourselves</span>.</p>&#13;
&#13;
<p>Be careful: extra layers of abstraction, whether through hooks or components, can add complexity to our code. It’s our job to reduce complexity wherever we can. However, in this case, we’ve reduced complexity by abstracting away reusable logic into a component and a hook.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Handling Multiple Requests" data-type="sect2"><div class="sect2" id="handling-multiple-requests">&#13;
<h2>Handling Multiple Requests</h2>&#13;
&#13;
<p>Once<a data-primary="data management" data-secondary="virtualized lists" data-tertiary="handling multiple requests" data-type="indexterm" id="idm45901627477160"/><a data-primary="virtualized lists" data-secondary="handling multiple requests" data-type="indexterm" id="idm45901627475912"/> we start making requests for data from the internet, we won’t be able to stop. More often than not, we need to make several HTTP requests to obtain all the data required to hydrate our application. For example, we’re currently asking GitHub to provide information about a user’s account. We’ll also need to obtain information about that user’s repositories. Both of these data points are obtained by making separate HTTP requests.</p>&#13;
&#13;
<p>GitHub users typically have many repositories. Information about a user’s repositories is passed as an array of objects. We’re<a data-primary="hooks" data-secondary="custom hooks" data-type="indexterm" id="idm45901627473880"/> going to create a special custom hook called <code>useIterator</code> that will allow us to iterate through any array of objects:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="kr">const</code> <code class="nx">useIterator</code> <code class="o">=</code> <code class="p">(</code>&#13;
  <code class="nx">items</code> <code class="o">=</code> <code class="p">[],</code>&#13;
  <code class="nx">initialIndex</code> <code class="o">=</code> <code class="mi">0</code>&#13;
<code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">i</code><code class="p">,</code> <code class="nx">setIndex</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">initialIndex</code><code class="p">);</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">prev</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">i</code> <code class="o">===</code> <code class="mi">0</code><code class="p">)</code> <code class="k">return</code> <code class="nx">setIndex</code><code class="p">(</code><code class="nx">items</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">);</code>&#13;
    <code class="nx">setIndex</code><code class="p">(</code><code class="nx">i</code> <code class="o">-</code> <code class="mi">1</code><code class="p">);</code>&#13;
  <code class="p">};</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">next</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">i</code> <code class="o">===</code> <code class="nx">items</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="k">return</code> <code class="nx">setIndex</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>&#13;
    <code class="nx">setIndex</code><code class="p">(</code><code class="nx">i</code> <code class="o">+</code> <code class="mi">1</code><code class="p">);</code>&#13;
  <code class="p">};</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">[</code><code class="nx">items</code><code class="p">[</code><code class="nx">i</code><code class="p">],</code> <code class="nx">prev</code><code class="p">,</code> <code class="nx">next</code><code class="p">];</code>&#13;
<code class="p">};</code></pre>&#13;
&#13;
<p>This hook will allow us to cycle through any array. Because it returns items inside of an array, we can take advantage of array destructuring to give these values names that make sense:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="p">[</code><code class="nx">letter</code><code class="p">,</code> <code class="nx">previous</code><code class="p">,</code> <code class="nx">next</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useIterator</code><code class="p">([</code>&#13;
  <code class="s2">"a"</code><code class="p">,</code>&#13;
  <code class="s2">"b"</code><code class="p">,</code>&#13;
  <code class="s2">"c"</code>&#13;
<code class="p">]);</code></pre>&#13;
&#13;
<p>In this case, the initial <code>letter</code> is “b.” If the user invokes next, the component will rerender, but this time, the value for <code>letter</code> will be “b.” Invoke <code>next</code> two more times, and the value for <code>letter</code> will once again be “a” because this iterator circles back around to the first item in the array instead of letting the <code>index</code> go out of bounds.</p>&#13;
&#13;
<p>The <code>useIterator</code> hook takes in an array of <code>items</code> and an initial index. The key value to this iterator hook is the index, <code>i</code>, which was created with the <code>useState</code> hook. <code>i</code> is used to identify the current item in the array. This hook returns the current item, <code>item[i]</code>, as well as functions for iterating through that array: <code>prev</code> and <code>next</code>. Both the <code>prev</code> and <code>next</code> functions either decrement or increment the value of <code>i</code> by invoking <code>setIndex</code>. This action causes the hook to rerender with a new <code>index</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Memozing Values" data-type="sect2"><div class="sect2" id="memoizing-values">&#13;
<h2>Memozing Values</h2>&#13;
&#13;
<p>The<a data-primary="data management" data-secondary="virtualized lists" data-tertiary="memoizing values" data-type="indexterm" id="idm45901627230424"/><a data-primary="virtualized lists" data-secondary="memoizing values" data-type="indexterm" id="idm45901627229144"/><a data-primary="memoization" data-type="indexterm" id="idm45901627228200"/> <code>useIterator</code> hook is pretty cool. But we can do even better by memoizing the value for <code>item</code> as well as the function for <code>prev</code> and <code>next</code>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useCallback</code><code class="p">,</code> <code class="nx">useMemo</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="kr">const</code> <code class="nx">useIterator</code> <code class="o">=</code> <code class="p">(</code>&#13;
  <code class="nx">items</code> <code class="o">=</code> <code class="p">[],</code>&#13;
  <code class="nx">initialValue</code> <code class="o">=</code> <code class="mi">0</code>&#13;
<code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">i</code><code class="p">,</code> <code class="nx">setIndex</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="nx">initialValue</code><code class="p">);</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">prev</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">i</code> <code class="o">===</code> <code class="mi">0</code><code class="p">)</code> <code class="k">return</code> <code class="nx">setIndex</code><code class="p">(</code><code class="nx">items</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">);</code>&#13;
    <code class="nx">setIndex</code><code class="p">(</code><code class="nx">i</code> <code class="o">-</code> <code class="mi">1</code><code class="p">);</code>&#13;
  <code class="p">},</code> <code class="p">[</code><code class="nx">i</code><code class="p">]);</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">next</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">i</code> <code class="o">===</code> <code class="nx">items</code><code class="p">.</code><code class="nx">length</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="k">return</code> <code class="nx">setIndex</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>&#13;
    <code class="nx">setIndex</code><code class="p">(</code><code class="nx">i</code> <code class="o">+</code> <code class="mi">1</code><code class="p">);</code>&#13;
  <code class="p">},</code> <code class="p">[</code><code class="nx">i</code><code class="p">]);</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">item</code> <code class="o">=</code> <code class="nx">useMemo</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">items</code><code class="p">[</code><code class="nx">i</code><code class="p">],</code> <code class="p">[</code><code class="nx">i</code><code class="p">]);</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">[</code><code class="nx">item</code> <code class="o">||</code> <code class="nx">items</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code> <code class="nx">prev</code><code class="p">,</code> <code class="nx">next</code><code class="p">];</code>&#13;
<code class="p">};</code></pre>&#13;
&#13;
<p>Here, both <code>prev</code> and <code>next</code> are created with the <code>useCallback</code> hook. This ensures that the function for <code>prev</code> will always be the same until the value for <code>i</code> changes. Likewise, the <code>item</code> value will always point to the same item object unless the value for <code>i</code> changes.</p>&#13;
&#13;
<p>Memoizing these values does not give us huge performance gains, or at least not enough to justify the code complexity. However, when a consumer uses the <code>useIterator</code> component, the memoized values will always point to the exact same object and function. This makes it easier on our consumers when they need to compare these values or use them in their own dependency arrays.</p>&#13;
&#13;
<p>Now, we’re going to create a repository menu component. Within this component, we’ll use the <code>useIterator</code> hook to allow the users to cycle through their list of <span class="keep-together">repositories</span>:</p>&#13;
&#13;
<pre data-type="programlisting">&lt; learning-react &gt;</pre>&#13;
&#13;
<p>If they click the Next button, they’ll see the name of the next repository. Likewise, if they click the Previous button, they’ll see the name of the previous repository. <code>RepoMenu</code> is the component we’ll create to provide this feature:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useIterator</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"../hooks"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="kd">function</code> <code class="nx">RepoMenu</code><code class="p">({</code>&#13;
  <code class="nx">repositories</code><code class="p">,</code>&#13;
  <code class="nx">onSelect</code> <code class="o">=</code> <code class="nx">f</code> <code class="o">=&gt;</code> <code class="nx">f</code>&#13;
<code class="p">})</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[{</code> <code class="nx">name</code> <code class="p">},</code> <code class="nx">previous</code><code class="p">,</code> <code class="nx">next</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useIterator</code><code class="p">(</code>&#13;
    <code class="nx">repositories</code>&#13;
  <code class="p">);</code>&#13;
&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">name</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
    <code class="nx">onSelect</code><code class="p">(</code><code class="nx">name</code><code class="p">);</code>&#13;
  <code class="p">},</code> <code class="p">[</code><code class="nx">name</code><code class="p">]);</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">style</code><code class="o">=</code><code class="p">{{</code> <code class="nx">display</code><code class="o">:</code> <code class="s2">"flex"</code> <code class="p">}}</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="nx">previous</code><code class="p">}</code><code class="o">&gt;&amp;</code><code class="nx">lt</code><code class="p">;</code><code class="o">&lt;</code><code class="err">/button&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">name</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="nx">next</code><code class="p">}</code><code class="o">&gt;&amp;</code><code class="nx">gt</code><code class="p">;</code><code class="o">&lt;</code><code class="err">/button&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p><code>RepoMenu</code> receives a list of <code>repositories</code> as a prop. It then destructures the <code>name</code> from the current repository object and the <code>previous</code> and <code>next</code> functions from <code>useIterator</code>. <code>&amp;lt;</code> is an entity for “Less Than,” and a less than sign, “&lt;”, is displayed. The same is true for <code>&amp;gt;</code>, greater than. These are indicators for previous and next, and when the user clicks on either of these indicators, the component is rerendered with a new repository name. If the <code>name</code> changes, then the user has selected a different repository, so we invoke the <code>onSelect</code> function and pass the <code>name</code> of the new repository to that function as an argument.</p>&#13;
&#13;
<p>Remember, array destructuring allows us to name the items whatever we want. Even though we named those functions <code>prev</code> and <code>next</code> within the hook, here, when we use the hook, we can change their names to <code>previous</code> and <code>next</code>.</p>&#13;
&#13;
<p>Now we can create the <code>UserRepositories</code> component. This component should request a list of a GitHub user’s repositories first, and once received, pass that list to the <code>RepoMenu</code> component:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">Fetch</code> <code class="nx">from</code> <code class="s2">"./Fetch"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">RepoMenu</code> <code class="nx">from</code> <code class="s2">"./RepoMenu"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">UserRepositories</code><code class="p">({</code>&#13;
  <code class="nx">login</code><code class="p">,</code>&#13;
  <code class="nx">selectedRepo</code><code class="p">,</code>&#13;
  <code class="nx">onSelect</code> <code class="o">=</code> <code class="nx">f</code> <code class="o">=&gt;</code> <code class="nx">f</code>&#13;
<code class="p">})</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">Fetch</code>&#13;
      <code class="nx">uri</code><code class="o">=</code><code class="p">{</code><code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">/repos`</code><code class="p">}</code>&#13;
      <code class="nx">renderSuccess</code><code class="o">=</code><code class="p">{({</code> <code class="nx">data</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">RepoMenu</code>&#13;
          <code class="nx">repositories</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code>&#13;
          <code class="nx">selectedRepo</code><code class="o">=</code><code class="p">{</code><code class="nx">selectedRepo</code><code class="p">}</code>&#13;
          <code class="nx">onSelect</code><code class="o">=</code><code class="p">{</code><code class="nx">onSelect</code><code class="p">}</code>&#13;
        <code class="o">/&gt;</code>&#13;
      <code class="p">)}</code>&#13;
    <code class="o">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>UserRepositories</code> component requires a <code>login</code> to use in order to make the fetch request for a list of repositories. That <code>login</code> is used to create the URI and pass it to the <code>Fetch</code> component. Once the fetch has successfully resolved, we’ll render the <code>RepoMenu</code> along with the list of repositories that was returned from the <code>Fetch</code> component as <code>data</code>. When the user selects a different repository, we simply pass the name of that new repository along to the parent object:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">UserDetails</code><code class="p">({</code> <code class="nx">data</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"githubUser"</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">img</code> <code class="nx">src</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">avatar_url</code><code class="p">}</code> <code class="nx">alt</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">login</code><code class="p">}</code> <code class="nx">style</code><code class="o">=</code><code class="p">{{</code> <code class="nx">width</code><code class="o">:</code> <code class="mi">200</code> <code class="p">}}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">login</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/h1&gt;</code>&#13;
        <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">name</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
        <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">location</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">location</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;}</code>&#13;
      <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">UserRepositories</code>&#13;
        <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">login</code><code class="p">}</code>&#13;
        <code class="nx">onSelect</code><code class="o">=</code><code class="p">{</code><code class="nx">repoName</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`</code><code class="si">${</code><code class="nx">repoName</code><code class="si">}</code><code class="sb"> selected`</code><code class="p">)}</code>&#13;
      <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code></pre>&#13;
&#13;
<p>Now we need to add our new component to the <code>UserDetails</code> component. When the <code>UserDetails</code> component is rendered, we’ll also render that user’s repository list. Assuming the <code>login</code> value is <code>eveporcello</code>, the rendered output for the above component would look something like <a data-type="xref" href="#fig0805">Figure 8-5</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig0805">&#13;
<img alt="repository output" src="assets/lrc2_0805.png"/>&#13;
<h6><span class="label">Figure 8-5. </span>Repository output</h6>&#13;
</div></figure>&#13;
&#13;
<p>In order to get information about Eve’s account along with her list of repositories, we need to send two separate HTTP requests. A majority of our lives as React developers will be spent like this: making multiple requests for information and composing all of the information received into beautiful user interface applications. Making two requests for information is just the beginning. In the next section, we’ll continue to make more requests of GitHub so we can see the README.md for the selected repository.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Waterfall Requests" data-type="sect2"><div class="sect2" id="waterfall-requests">&#13;
<h2>Waterfall Requests</h2>&#13;
&#13;
<p>In<a data-primary="data management" data-secondary="virtualized lists" data-tertiary="waterfall requests" data-type="indexterm" id="idm45901626553752"/><a data-primary="virtualized lists" data-secondary="waterfall requests" data-type="indexterm" id="idm45901626552472"/><a data-primary="waterfall requests" data-type="indexterm" id="idm45901626551528"/> the last section, we made two HTTP requests. The first request was for a user’s details, then once we had those details, we made a second request for that user’s repositories. These requests happen one at a time, one after the other.</p>&#13;
&#13;
<p>The first request is made when we initially fetch the user’s details:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="o">&lt;</code><code class="nx">Fetch</code>&#13;
  <code class="nx">uri</code><code class="o">=</code><code class="p">{</code><code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">`</code><code class="p">}</code>&#13;
  <code class="nx">renderSuccess</code><code class="o">=</code><code class="p">{</code><code class="nx">UserDetails</code><code class="p">}</code>&#13;
<code class="err">/&gt;</code></pre>&#13;
&#13;
<p>Once we have that user’s details, the <code>UserDetails</code> component is rendered. It in turn renders <code>UserRepositories</code>, which then sends a fetch request for that user’s <span class="keep-together">repositories</span>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="o">&lt;</code><code class="nx">Fetch</code>&#13;
  <code class="nx">uri</code><code class="o">=</code><code class="p">{</code><code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">/repos`</code><code class="p">}</code>&#13;
  <code class="nx">renderSuccess</code><code class="o">=</code><code class="p">{({</code> <code class="nx">data</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">RepoMenu</code> <code class="nx">repositories</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code> <code class="nx">onSelect</code><code class="o">=</code><code class="p">{</code><code class="nx">onSelect</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
  <code class="p">)}</code>&#13;
<code class="err">/&gt;</code></pre>&#13;
&#13;
<p>We call these requests <em>waterfall</em> requests because they happen one right after the other—they’re dependent on each other. If something goes wrong with the user details request, the request for that user’s repositories is never made.</p>&#13;
&#13;
<p>Let’s add some more layers (water?) to this waterfall. First, we request the user’s info, then their repository list, then, once we have their repository list, we make a request for the first repository’s README.md file. As the user cycles through the list of <span class="keep-together">repositories</span>, we’ll make additional requests for the associated README to each <span class="keep-together">repository</span>.</p>&#13;
&#13;
<p>Repository README files are written using Markdown, which is a text format that can be easily rendered as HTML with the <code>ReactMarkdown</code> component. First, let’s install <code>react-markdown</code>:</p>&#13;
&#13;
<pre data-type="programlisting">npm i react-markdown</pre>&#13;
&#13;
<p>Requesting the contents of a repository’s README file also requires a waterfall of requests. First, we have to make a data request to the repository’s README route: <em>https://api.github.com/repos/${login}/${repo}/readme</em>. GitHub will respond to this route with the details about a repository’s README file but not the contents of that file. It does provide us with a <code>download_url</code> that we can use to request the contents of the README file. But to get the Markdown content, we’ll have to make an additional request. Both of these requests can be made within a single async function:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">loadReadme</code> <code class="o">=</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">login</code><code class="p">,</code> <code class="nx">repo</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">uri</code> <code class="o">=</code> <code class="sb">`https://api.github.com/repos/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">/</code><code class="si">${</code><code class="nx">repo</code><code class="si">}</code><code class="sb">/readme`</code><code class="p">;</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">download_url</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="nx">uri</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="nx">res</code> <code class="o">=&gt;</code>&#13;
    <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">()</code>&#13;
  <code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="nx">markdown</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="nx">download_url</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="nx">res</code> <code class="o">=&gt;</code>&#13;
    <code class="nx">res</code><code class="p">.</code><code class="nx">text</code><code class="p">()</code>&#13;
  <code class="p">);</code>&#13;
&#13;
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Markdown for </code><code class="si">${</code><code class="nx">repo</code><code class="si">}</code><code class="err">\</code><code class="sb">n</code><code class="err">\</code><code class="sb">n</code><code class="si">${</code><code class="nx">markdown</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>&#13;
<code class="p">};</code></pre>&#13;
&#13;
<p>In order to find a repository README, we need the repository owner’s <code>login</code> and the name of the <code>repository</code>. Those values are used to construct a unique URL: <em>https://api.github.com/repos/moonhighway/learning-react/readme</em>. When this request is successful, we destructure the <code>download_url</code> from its response. Now we can use this value to download the contents of the README; all we have to do is fetch the <code>download_url</code>. We’ll parse this text as text—<code>res.text()</code>—rather than JSON because the body of the response is Markdown text.</p>&#13;
&#13;
<p>Once we have the Markdown, let’s render it by wrapping the <code>loadReadme</code> function inside of a React component:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code>&#13;
  <code class="nx">useState</code><code class="p">,</code>&#13;
  <code class="nx">useEffect</code><code class="p">,</code>&#13;
  <code class="nx">useCallback</code>&#13;
<code class="p">}</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">ReactMarkdown</code> <code class="nx">from</code> <code class="s2">"react-markdown"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">RepositoryReadme</code><code class="p">({</code> <code class="nx">repo</code><code class="p">,</code> <code class="nx">login</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">loading</code><code class="p">,</code> <code class="nx">setLoading</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">error</code><code class="p">,</code> <code class="nx">setError</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">();</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">markdown</code><code class="p">,</code> <code class="nx">setMarkdown</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="s2">""</code><code class="p">);</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">loadReadme</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="p">(</code><code class="nx">async</code> <code class="p">(</code><code class="nx">login</code><code class="p">,</code> <code class="nx">repo</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">setLoading</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>&#13;
    <code class="kr">const</code> <code class="nx">uri</code> <code class="o">=</code> <code class="sb">`https://api.github.com/repos/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">/</code><code class="si">${</code><code class="nx">repo</code><code class="si">}</code><code class="sb">/readme`</code><code class="p">;</code>&#13;
    <code class="kr">const</code> <code class="p">{</code> <code class="nx">download_url</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="nx">uri</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="nx">res</code> <code class="o">=&gt;</code>&#13;
      <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">()</code>&#13;
    <code class="p">);</code>&#13;
    <code class="kr">const</code> <code class="nx">markdown</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="nx">download_url</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="nx">res</code> <code class="o">=&gt;</code>&#13;
      <code class="nx">res</code><code class="p">.</code><code class="nx">text</code><code class="p">()</code>&#13;
    <code class="p">);</code>&#13;
    <code class="nx">setMarkdown</code><code class="p">(</code><code class="nx">markdown</code><code class="p">);</code>&#13;
    <code class="nx">setLoading</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>&#13;
  <code class="p">},</code> <code class="p">[]);</code>&#13;
&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">repo</code> <code class="o">||</code> <code class="o">!</code><code class="nx">login</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
    <code class="nx">loadReadme</code><code class="p">(</code><code class="nx">login</code><code class="p">,</code> <code class="nx">repo</code><code class="p">).</code><code class="k">catch</code><code class="p">(</code><code class="nx">setError</code><code class="p">);</code>&#13;
  <code class="p">},</code> <code class="p">[</code><code class="nx">repo</code><code class="p">]);</code>&#13;
&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="o">&lt;</code><code class="nx">pre</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">2</code><code class="p">)}</code><code class="o">&lt;</code><code class="err">/pre&gt;;</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">ReactMarkdown</code> <code class="nx">source</code><code class="o">=</code><code class="p">{</code><code class="nx">markdown</code><code class="p">}</code> <code class="o">/&gt;</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>First, we add the <code>loadReadme</code> function to the component using the <code>useCallback</code> hook to memoize the function when the component initially renders. This function now changes the loading state to <code>true</code> before the fetch request and changes it back to <code>false</code> after the request. When the Markdown is received, it’s saved in state using the <code>setMarkdown</code> function.</p>&#13;
&#13;
<p>Next, we need to actually call <code>loadReadme</code>, so we add a <code>useEffect</code> hook to load the README file after the component initially renders. If for some reason the properties for <code>repo</code> and <code>login</code> are not present, the README will not be loaded. The dependency array in this hook contains <code>[repo]</code>. This is because we want to load another README if the value for <code>repo</code> changes. If anything goes wrong while loading the README, it will be caught and sent to the <code>setError</code> function.</p>&#13;
&#13;
<p>Notice we have to handle the same three render states that we do for every fetch request: pending, success, and fail. Finally, when we have a successful response, the Markdown itself is rendered using the <code>ReactMarkdown</code> component.</p>&#13;
&#13;
<p>All there is left to do is render the <code>RepositoryReadme</code> component inside of the <code>RepoMenu</code> component. As the user cycles through repositories using the <code>RepoMenu</code> component, the README for each repository will also be loaded and displayed:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="kd">function</code> <code class="nx">RepoMenu</code><code class="p">({</code> <code class="nx">repositories</code><code class="p">,</code> <code class="nx">login</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[{</code> <code class="nx">name</code> <code class="p">},</code> <code class="nx">previous</code><code class="p">,</code> <code class="nx">next</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useIterator</code><code class="p">(</code>&#13;
    <code class="nx">repositories</code>&#13;
  <code class="p">);</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">style</code><code class="o">=</code><code class="p">{{</code> <code class="nx">display</code><code class="o">:</code> <code class="s2">"flex"</code> <code class="p">}}</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="nx">previous</code><code class="p">}</code><code class="o">&gt;&amp;</code><code class="nx">lt</code><code class="p">;</code><code class="o">&lt;</code><code class="err">/button&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">name</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">button</code> <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="nx">next</code><code class="p">}</code><code class="o">&gt;&amp;</code><code class="nx">gt</code><code class="p">;</code><code class="o">&lt;</code><code class="err">/button&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">RepositoryReadme</code> <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="nx">repo</code><code class="o">=</code><code class="p">{</code><code class="nx">name</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Now our application is really making multiple requests; initially, it makes four requests: one for the user’s details, then one for that user’s repository list, then one for information about the selected repository’s README, and finally one more request for the text contents of the README. These are all waterfall requests because they happen one after another.</p>&#13;
&#13;
<p>Additionally, as the user interacts with the application, more requests are made. Two waterfall requests are made to obtain the README file every time the user changes the current repository. All four initial waterfall requests are made every time the user searches for a different GitHub account.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Throttling the Network Speed" data-type="sect2"><div class="sect2" id="throttling-the-network-speed">&#13;
<h2>Throttling the Network Speed</h2>&#13;
&#13;
<p>All<a data-primary="data management" data-secondary="virtualized lists" data-tertiary="throttling network speed" data-type="indexterm" id="idm45901625996744"/><a data-primary="virtualized lists" data-secondary="throttling network speed" data-type="indexterm" id="idm45901625995496"/><a data-primary="network speed, throttling" data-type="indexterm" id="idm45901625994536"/> of these requests are visible from the Network tab under your developer tools. From this tab, you can see every request, and you can throttle your network speed to see how these requests unfold on slow networks. If you want to see how the waterfall requests happen one after another you can slow down your network speed and see the loading messages as they’re rendered.</p>&#13;
&#13;
<p>The Network tab is available under the developer tools of most major browsers. To throttle the network speed in Google Chrome, select the arrow next to the word “Online,” as demonstrated in <a data-type="xref" href="#fig0806">Figure 8-6</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig0806">&#13;
<img alt="change speed" src="assets/lrc2_0806.png"/>&#13;
<h6><span class="label">Figure 8-6. </span>Changing the speed of the network request</h6>&#13;
</div></figure>&#13;
&#13;
<p>This will open a menu where you can choose various speeds, as you can see in <a data-type="xref" href="#fig0807">Figure 8-7</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig0807">&#13;
<img alt="select speed" src="assets/lrc2_0807.png"/>&#13;
<h6><span class="label">Figure 8-7. </span>Selecting the speed of the network request</h6>&#13;
</div></figure>&#13;
&#13;
<p>Selecting “Fast 3G” or “Slow 3G” will significantly throttle your network requests.</p>&#13;
&#13;
<p>Additionally, the Network tab displays a timeline for all of the HTTP requests. You can filter this timeline to only view “XHR” requests. This means it will only show the request made using <code>fetch</code> (<a data-type="xref" href="#fig0808">Figure 8-8</a>).</p>&#13;
&#13;
<figure><div class="figure" id="fig0808">&#13;
<img alt="The waterfall of a request" src="assets/lrc2_0808.png"/>&#13;
<h6><span class="label">Figure 8-8. </span>The waterfall of a request</h6>&#13;
</div></figure>&#13;
&#13;
<p>Here, we see that four requests were made one after the other. Notice that the loading graphic is titled “Waterfall.” This shows that each request is made after the other is complete.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Parallel Requests" data-type="sect2"><div class="sect2" id="parallel-requests">&#13;
<h2>Parallel Requests</h2>&#13;
&#13;
<p>Sometimes, it’s<a data-primary="data management" data-secondary="virtualized lists" data-tertiary="parallel requests" data-type="indexterm" id="idm45901625979720"/><a data-primary="virtualized lists" data-secondary="parallel requests" data-type="indexterm" id="idm45901625978440"/><a data-primary="parallel requests" data-type="indexterm" id="idm45901625977496"/> possible to make an application faster by sending all requests at once. Instead of having each request occur one after another in a waterfall, we can send our requests in <em>parallel</em>, or at the same time.</p>&#13;
&#13;
<p>The reason our application is currently making a waterfall of request is that the components are rendered inside of one another. <code>GitHubUser</code> eventually renders <code>UserRepositories</code>, which eventually renders <code>RepositoryReadme</code>. Requests are not made until each component has been rendered.</p>&#13;
&#13;
<p>Making these requests in parallel is going to require a different approach. First, we’ll need to remove the <code>&lt;RepositoryReadme /&gt;</code> from the <code>RepoMenu</code>’s render function. This is a good move. The <code>RepoMenu</code> should only focus on the logistics of creating a menu of repositories that the user can cycle through. The <code>RepositoryReadme</code> component should be handed in a different component.</p>&#13;
&#13;
<p>Next, we’ll need to remove <code>&lt;RepoMenu /&gt;</code> from the <code>renderSuccess</code> property of <code>UserRepositories</code>. Likewise, <code>&lt;UserRepositories /&gt;</code> needs to be removed from the <code>UserDetails</code> component.</p>&#13;
&#13;
<p>Instead of nesting these components inside of one another, we’ll place them all on the same level next to one another, all within the <code>App</code> component:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code><code class="p">,</code> <code class="p">{</code> <code class="nx">useState</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">SearchForm</code> <code class="nx">from</code> <code class="s2">"./SearchForm"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">GitHubUser</code> <code class="nx">from</code> <code class="s2">"./GitHubUser"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">UserRepositories</code> <code class="nx">from</code> <code class="s2">"./UserRepositories"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">RepositoryReadme</code> <code class="nx">from</code> <code class="s2">"./RepositoryReadme"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">login</code><code class="p">,</code> <code class="nx">setLogin</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="s2">"moonhighway"</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">repo</code><code class="p">,</code> <code class="nx">setRepo</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="s2">"learning-react"</code><code class="p">);</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">SearchForm</code> <code class="nx">value</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{</code><code class="nx">setLogin</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">GitHubUser</code> <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">UserRepositories</code>&#13;
        <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code>&#13;
        <code class="nx">repo</code><code class="o">=</code><code class="p">{</code><code class="nx">repo</code><code class="p">}</code>&#13;
        <code class="nx">onSelect</code><code class="o">=</code><code class="p">{</code><code class="nx">setRepo</code><code class="p">}</code>&#13;
      <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">RepositoryReadme</code> <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="nx">repo</code><code class="o">=</code><code class="p">{</code><code class="nx">repo</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>GitHubUser</code>, <code>UserRepositories</code>, and <code>RepositoryReadme</code> components all send HTTP requests to GitHub for data. Rending them side-by-side on the same level will cause all of these requests to happen at the same time, in parallel.</p>&#13;
&#13;
<p>Each component requires specific information in order to make the request. We need a <code>login</code> to obtain a GitHub user. We need a <code>login</code> to obtain a list of user repositories. The <code>RepositoryReadme</code> requires both a <code>login</code> and a <code>repo</code> to work properly. To make sure all of the components have what they need to make their requests, we initialize the app to display the details for the user “moonhighway” and the repository “learning-react.”</p>&#13;
&#13;
<p>If the user searches for another <code>GitHubUser</code> with the <code>SearchForm</code>, the value for <code>login</code> will change, which will trigger the <code>useEffect</code> hooks within our components, causing them to make additional requests for data. If the user cycles through the list of repositories, then the <code>onSelect</code> property for <code>UserRepositories</code> will be invoked, which causes the <code>repo</code> value to change. Changing the <code>repo</code> value will trigger the <code>useEffect</code> hook inside of the <code>RepositoryReadme</code> component, and a new README will be requested.</p>&#13;
&#13;
<p>The <code>RepoMenu</code> component always starts with the first repository, no matter what. We have to see if there’s a <code>selectedRepo</code> property. If there is, we need to use it to find the initial index for the repository to be displayed:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="kd">function</code> <code class="nx">RepoMenu</code><code class="p">({</code> <code class="nx">repositories</code><code class="p">,</code> <code class="nx">selected</code><code class="p">,</code> <code class="nx">onSelect</code> <code class="o">=</code> <code class="nx">f</code> <code class="o">=&gt;</code> <code class="nx">f</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[{</code> <code class="nx">name</code> <code class="p">},</code> <code class="nx">previous</code><code class="p">,</code> <code class="nx">next</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useIterator</code><code class="p">(</code>&#13;
    <code class="nx">repositories</code><code class="p">,</code>&#13;
    <code class="nx">selected</code> <code class="o">?</code> <code class="nx">repositories</code><code class="p">.</code><code class="nx">findIndex</code><code class="p">(</code><code class="nx">repo</code> <code class="o">=&gt;</code> <code class="nx">repo</code><code class="p">.</code><code class="nx">name</code> <code class="o">===</code> <code class="nx">selected</code><code class="p">)</code> <code class="o">:</code> <code class="kc">null</code>&#13;
  <code class="p">);</code>&#13;
  <code class="p">...</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The second argument for the <code>useIterator</code> hook is the initial index to start with. If there’s a <code>selected</code> property, then we’ll search for the index of the selected repository by <code>name</code>. This is required to make sure the repository menu displays the correct repository initially. We also need to pass this <code>selected</code> property to this component from <code>UserRepositories</code>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="o">&lt;</code><code class="nx">Fetch</code>&#13;
  <code class="nx">uri</code><code class="o">=</code><code class="p">{</code><code class="sb">`https://api.github.com/users/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">/repos`</code><code class="p">}</code>&#13;
  <code class="nx">renderSuccess</code><code class="o">=</code><code class="p">{({</code> <code class="nx">data</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">RepoMenu</code>&#13;
      <code class="nx">repositories</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code>&#13;
      <code class="nx">selected</code><code class="o">=</code><code class="p">{</code><code class="nx">repo</code><code class="p">}</code>&#13;
      <code class="nx">onSelect</code><code class="o">=</code><code class="p">{</code><code class="nx">onSelect</code><code class="p">}</code>&#13;
    <code class="o">/&gt;</code>&#13;
  <code class="p">)}</code>&#13;
<code class="err">/&gt;</code></pre>&#13;
&#13;
<p>Now that the <code>repo</code> property is being passed down to the <code>RepoMenu</code>, the menu should select the initial repository, which in our case is “learning-react.”</p>&#13;
&#13;
<p>If you take a look at the Network tab, you’ll notice we’ve made three requests in parallel, as shown in <a data-type="xref" href="#fig0809">Figure 8-9</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig0809">&#13;
<img alt="Creating a parallel request" src="assets/lrc2_0809.png"/>&#13;
<h6><span class="label">Figure 8-9. </span>Creating a parallel request</h6>&#13;
</div></figure>&#13;
&#13;
<p>So each component made its request at the same time. The <code>RepoReadme</code> component still has to make a waterfall request to obtain the contents of the README file. This is OK. It’s hard to make every request right when your app initially renders. Parallel and waterfall requests can work in conjunction with each other.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Waiting for Values" data-type="sect2"><div class="sect2" id="waiting-for-values">&#13;
<h2>Waiting for Values</h2>&#13;
&#13;
<p>We<a data-primary="data management" data-secondary="virtualized lists" data-tertiary="waiting for values" data-type="indexterm" id="idm45901625450744"/><a data-primary="virtualized lists" data-secondary="waiting for values" data-type="indexterm" id="idm45901625449464"/> currently initialize the values for <code>login</code> and <code>repo</code> to “moonhighway” and “learning-react.” We may not always be able to guess which data to render first. When that’s the case, we simply don’t render the component until the data it requires is present:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">login</code><code class="p">,</code> <code class="nx">setLogin</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">();</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">repo</code><code class="p">,</code> <code class="nx">setRepo</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">();</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">SearchForm</code> <code class="nx">value</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{</code><code class="nx">setLogin</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="p">{</code><code class="nx">login</code> <code class="o">&amp;&amp;</code> <code class="o">&lt;</code><code class="nx">GitHubUser</code> <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="o">/&gt;</code><code class="p">}</code>&#13;
      <code class="p">{</code><code class="nx">login</code> <code class="o">&amp;&amp;</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">UserRepositories</code>&#13;
          <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code>&#13;
          <code class="nx">repo</code><code class="o">=</code><code class="p">{</code><code class="nx">repo</code><code class="p">}</code>&#13;
          <code class="nx">onSelect</code><code class="o">=</code><code class="p">{</code><code class="nx">setRepo</code><code class="p">}</code>&#13;
        <code class="o">/&gt;</code>&#13;
      <code class="p">)}</code>&#13;
      <code class="p">{</code><code class="nx">login</code> <code class="o">&amp;&amp;</code> <code class="nx">repo</code> <code class="o">&amp;&amp;</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">RepositoryReadme</code> <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="nx">repo</code><code class="o">=</code><code class="p">{</code><code class="nx">repo</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="p">)}</code>&#13;
    <code class="o">&lt;</code><code class="err">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In this scenario, none of the components are rendered until their required props have values. Initially, the only component rendered is the <code>SearchForm</code>. Searching for a user will change the value for <code>login</code>, causing the <code>UserRepositories</code> component to render. When this component looks up the repositories, it will select the first repository in the list, causing <code>setRepo</code> to be invoked. Finally, we have a <code>login</code> and a <code>repo</code>, so the <code>RepositoryReadme</code> component will be rendered.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Canceling Requests" data-type="sect2"><div class="sect2" id="cancelling-requests">&#13;
<h2>Canceling Requests</h2>&#13;
&#13;
<p>Thinking<a data-primary="data management" data-secondary="virtualized lists" data-tertiary="canceling requests" data-type="indexterm" id="idm45901625299784"/><a data-primary="virtualized lists" data-secondary="canceling requests" data-type="indexterm" id="idm45901625298504"/> about our application a little bit more, we realize that the user could empty the search field and search for no user at all. In this case, we would also want to make sure that the value for <code>repo</code> is also empty. Let’s add a <code>handleSearch</code> method that makes sure the <code>repo</code> value changes when there’s no value for <code>login</code>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">login</code><code class="p">,</code> <code class="nx">setLogin</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="s2">"moonhighway"</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">repo</code><code class="p">,</code> <code class="nx">setRepo</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="s2">"learning-react"</code><code class="p">);</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">handleSearch</code> <code class="o">=</code> <code class="nx">login</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">login</code><code class="p">)</code> <code class="k">return</code> <code class="nx">setLogin</code><code class="p">(</code><code class="nx">login</code><code class="p">);</code>&#13;
    <code class="nx">setLogin</code><code class="p">(</code><code class="s2">""</code><code class="p">);</code>&#13;
    <code class="nx">setRepo</code><code class="p">(</code><code class="s2">""</code><code class="p">);</code>&#13;
  <code class="p">};</code>&#13;
&#13;
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">login</code><code class="p">)</code>&#13;
    <code class="k">return</code> <code class="p">(</code>&#13;
      <code class="o">&lt;</code><code class="nx">SearchForm</code> <code class="nx">value</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{</code><code class="nx">handleSearch</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
    <code class="p">);</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">SearchForm</code> <code class="nx">value</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{</code><code class="nx">handleSearch</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">GitHubUser</code> <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">UserRepositories</code>&#13;
        <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code>&#13;
        <code class="nx">repo</code><code class="o">=</code><code class="p">{</code><code class="nx">repo</code><code class="p">}</code>&#13;
        <code class="nx">onSelect</code><code class="o">=</code><code class="p">{</code><code class="nx">setRepo</code><code class="p">}</code>&#13;
      <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">RepositoryReadme</code> <code class="nx">login</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="nx">repo</code><code class="o">=</code><code class="p">{</code><code class="nx">repo</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>We’ve added a <code>handleSearch</code> method. Now, when the user clears the search field and searches for an empty string, the repo value is also set to an empty string. If for some reason there’s not a login, we only render one component: the <code>SearchForm</code>. When we have a value for <code>login</code>, we’ll render all four components.</p>&#13;
&#13;
<p>Now, technically our app has two screens. One screen only displays a search form. The other screen only shows when the search form contains a value, in which case, it shows all four components. We’ve set ourselves up to mount or unmount components based on user interactivity. Let’s say we were looking at the details for “moonhighway.” If the user empties the search field, then the <code>GitHubUser</code>, <code>UserRepositories</code>, and <code>RepositoryReadme</code> components are unmounted and will no longer be displayed. But what if these components were in the middle of loading data when they were unmounted?</p>&#13;
&#13;
<p>You can try it out:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Throttle the network to “Slow 3G” to have enough time to cause problems</p>&#13;
</li>&#13;
<li>&#13;
<p>Change the value of the search field from “moonhighway” to “eveporcello”</p>&#13;
</li>&#13;
<li>&#13;
<p>While the data is loading, search for an empty string, “”</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>These steps will cause the <code>GitHubUser</code>, <code>UserRepositories</code>, and <code>RepositoryReadme</code> to become unmounted while they’re in the middle of making fetch requests. Eventually, when there’s a response to the fetch request, these components are no longer mounted. Attempting to change state values in an unmounted component will cause the error shown in <a data-type="xref" href="#fig0810">Figure 8-10</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig0810">&#13;
<img alt="mounted error" src="assets/lrc2_0810.png"/>&#13;
<h6><span class="label">Figure 8-10. </span>Mounted error</h6>&#13;
</div></figure>&#13;
&#13;
<p>Whenever our users load data over a slow network, these errors can occur. But we can protect ourselves. First, we can create a hook that will tell us whether or not the current component is mounted:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="kd">function</code> <code class="nx">useMountedRef</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">mounted</code> <code class="o">=</code> <code class="nx">useRef</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">mounted</code><code class="p">.</code><code class="nx">current</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>&#13;
    <code class="k">return</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">(</code><code class="nx">mounted</code><code class="p">.</code><code class="nx">current</code> <code class="o">=</code> <code class="kc">false</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
  <code class="k">return</code> <code class="nx">mounted</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>useMountedRef</code> hook uses a ref. When the component unmounts, state is wiped clean, but refs are still available. The above <code>useEffect</code> doesn’t have a dependency array; it’s invoked every time a component renders and ensures that the value for the ref is <code>true</code>. Whenever the component unmounts, the function returned from <code>useEffect</code> is invoked, which changes the value of the ref to <code>false</code>.</p>&#13;
&#13;
<p>Now we can use this hook inside of the <code>RepoReadme</code> component. This will allow us to make sure the component is mounted before applying any state updates:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">mounted</code> <code class="o">=</code> <code class="nx">useMountedRef</code><code class="p">();</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">loadReadme</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="p">(</code><code class="nx">async</code> <code class="p">(</code><code class="nx">login</code><code class="p">,</code> <code class="nx">repo</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">setLoading</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="nx">uri</code> <code class="o">=</code> <code class="sb">`https://api.github.com/repos/</code><code class="si">${</code><code class="nx">login</code><code class="si">}</code><code class="sb">/</code><code class="si">${</code><code class="nx">repo</code><code class="si">}</code><code class="sb">/readme`</code><code class="p">;</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">download_url</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="nx">uri</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="nx">res</code> <code class="o">=&gt;</code>&#13;
    <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">()</code>&#13;
  <code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="nx">markdown</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="nx">download_url</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="nx">res</code> <code class="o">=&gt;</code>&#13;
    <code class="nx">res</code><code class="p">.</code><code class="nx">text</code><code class="p">()</code>&#13;
  <code class="p">);</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">mounted</code><code class="p">.</code><code class="nx">current</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">setMarkdown</code><code class="p">(</code><code class="nx">markdown</code><code class="p">);</code>&#13;
    <code class="nx">setLoading</code><code class="p">(</code><code class="kc">false</code><code class="p">);</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">},</code> <code class="p">[]);</code></pre>&#13;
&#13;
<p>Now we have a ref that tells us whether or not the component is mounted. It will take time for both of these requests to finish. When they do, we check to make sure the component is still mounted before calling <code>setMarkdown</code> or <code>setLoading</code>.</p>&#13;
&#13;
<p>Let’s add the same logic to our <code>useFetch</code> hook:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">mounted</code> <code class="o">=</code> <code class="nx">useMountedRef</code><code class="p">();</code>&#13;
&#13;
<code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">uri</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">mounted</code><code class="p">.</code><code class="nx">current</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
  <code class="nx">setLoading</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>&#13;
  <code class="nx">fetch</code><code class="p">(</code><code class="nx">uri</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">data</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">mounted</code><code class="p">.</code><code class="nx">current</code><code class="p">)</code> <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s2">"component is not mounted"</code><code class="p">);</code>&#13;
      <code class="k">return</code> <code class="nx">data</code><code class="p">;</code>&#13;
    <code class="p">})</code>&#13;
    <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">data</code> <code class="o">=&gt;</code> <code class="nx">data</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>&#13;
    <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">setData</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">then</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="nx">setLoading</code><code class="p">(</code><code class="kc">false</code><code class="p">))</code>&#13;
    <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">error</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">mounted</code><code class="p">.</code><code class="nx">current</code><code class="p">)</code> <code class="k">return</code><code class="p">;</code>&#13;
      <code class="nx">setError</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>&#13;
    <code class="p">});</code></pre>&#13;
&#13;
<p>The <code>useFetch</code> hook is used to make the rest of the fetch requests in our app. In this hook, we compose the fetch request using thenables, chainable <code>.then()</code> functions, instead of <code>async/await</code>. When the fetch is complete, we check to see if the component is mounted in the first <code>.then</code> callback. If the component is mounted, the <code>data</code> is returned and the rest of the <code>.then</code> functions are invoked. When the component is not mounted, the first <code>.then</code> function throws an error, preventing the rest of the <code>.then</code> functions from executing. Instead, the <code>.catch</code> function is invoked and the new error is passed to that function. The <code>.catch</code> function will check to see if the component is mounted before it tries to invoke <code>setError</code>.</p>&#13;
&#13;
<p>We’ve successfully canceled our requests. We didn’t stop the HTTP request itself from occurring, but we did protect the state calls we make after the request is resolved. It’s always a good idea to test your app under slow network conditions. These bugs will be revealed and eliminated.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Introducing GraphQL" data-type="sect1"><div class="sect1" id="introducing-graphql">&#13;
<h1>Introducing GraphQL</h1>&#13;
&#13;
<p>Just<a data-primary="data management" data-secondary="GraphQL" data-type="indexterm" id="DMgraph08"/><a data-primary="GraphQL" data-type="indexterm" id="graphql08"/> like React, GraphQL was designed at Facebook. And, just like React is a declarative solution for composing user interfaces, GraphQL is a declarative solution for communicating with APIs. When we make parallel data requests, we’re attempting to get all the data we need immediately at the same time. GraphQL was designed to do just that.</p>&#13;
&#13;
<p>In order to get data from a GraphQL API, we still need to make an HTTP request to a specific URI. However, we also need to send a query along with the request. A GraphQL query is a declarative description of the data we’re requesting. The service will parse this description and will package all the data we’re asking for into a single response.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="GitHub GraphQL API" data-type="sect2"><div class="sect2" id="github-graphql-api">&#13;
<h2>GitHub GraphQL API</h2>&#13;
&#13;
<p>In order to use GraphQL in your React application, the backend service you’re communicating with needs to be built following GraphQL specifications. Fortunately, GitHub also exposes a GraphQL API. Most GraphQL services provide a way to explore the GraphQL API. At GitHub, this is called the <a href="https://developer.github.com/v4/explorer">GraphQL Explorer</a>. In order to use the Explorer, you must sign in with your GitHub account.</p>&#13;
&#13;
<p>The left panel of the Explorer is where we draft our GraphQL query. Inside of this panel, we could add a query to obtain information about a single GitHub user:</p>&#13;
&#13;
<pre class="pagebreak-before" data-type="programlisting">query {&#13;
  user(login: "moontahoe") {&#13;
    id&#13;
    login&#13;
    name&#13;
    location&#13;
    avatarUrl&#13;
  }&#13;
}</pre>&#13;
&#13;
<p>This is a GraphQL query. We’re asking for information about the GitHub user “moontahoe.” Instead of getting all of the public information available about moontahoe, we only get the data we want: <code>id</code>, <code>login</code>, <code>avatarUrl</code>, <code>name</code>, and <code>location</code>. When we press the Play button on this page, we send this query as an HTTP POST request to <em>https://api.github.com/graphql</em>. All GitHub GraphQL queries are sent to this URI. GitHub will parse this query and return only the data we asked for:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"data"</code><code class="p">:</code> <code class="p">{</code>&#13;
    <code class="nt">"user"</code><code class="p">:</code> <code class="p">{</code>&#13;
      <code class="nt">"id"</code><code class="p">:</code> <code class="s2">"MDQ6VXNlcjU5NTIwODI="</code><code class="p">,</code>&#13;
      <code class="nt">"login"</code><code class="p">:</code> <code class="s2">"MoonTahoe"</code><code class="p">,</code>&#13;
      <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Alex Banks"</code><code class="p">,</code>&#13;
      <code class="nt">"location"</code><code class="p">:</code> <code class="s2">"Tahoe City, CA"</code><code class="p">,</code>&#13;
      <code class="nt">"avatarUrl"</code><code class="p">:</code> <code class="s2">"https://github.com/moontahoe.png"</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>We can formalize this GraphQL query into a reusable operation named <code>findRepos</code>. Every time we want to find information about a user and their repositories, we could do so by sending a <code>login</code> variable to this query:</p>&#13;
&#13;
<pre data-type="programlisting">query findRepos($login: String!) {&#13;
  user(login: $login) {&#13;
    login&#13;
    name&#13;
    location&#13;
    avatar_url: avatarUrl&#13;
    repositories(first: 100) {&#13;
      totalCount&#13;
      nodes {&#13;
        name&#13;
      }&#13;
    }&#13;
  }&#13;
}</pre>&#13;
&#13;
<p>Now we’ve created a formal <code>findRepos</code> query that we can reuse simply by chaining the value of the <code>$login</code> variable. We set this variable using the Query Variables panel shown in <a data-type="xref" href="#fig0811">Figure 8-11</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig0811">&#13;
<img alt="GitHub GraphQL Explorer" src="assets/lrc2_0811.png"/>&#13;
<h6><span class="label">Figure 8-11. </span>GitHub GraphQL Explorer</h6>&#13;
</div></figure>&#13;
&#13;
<p>In addition to obtaining details about a user, we’re also asking for that user’s first hundred repositories. We’re asking for the number of repositories returned by the query, the <code>totalCount</code>, along with the <code>name</code> of each repository. GraphQL only returns the data we ask for. In this case, we’ll only get the <code>name</code> for each repository, nothing else.</p>&#13;
&#13;
<p>There’s one more change that we made to this query: we used an alias for the <code>avatarUrl</code>. The GraphQL field to obtain a user’s avatar is called <code>avatarUrl</code>, but we want that variable to be named <code>avatar_url</code>. The alias tells GitHub to rename that field in the data response.</p>&#13;
&#13;
<p>GraphQL is a huge topic. We wrote a whole book about it: <a class="orm:hideurl" href="http://shop.oreilly.com/product/0636920137269.do"><em>Learning GraphQL</em></a>. We’re only scratching the surface here, but GraphQL is increasingly becoming more of a requirement for any developer. In order to be a successful developer in the 21st century, it’s important to understand the fundamentals of GraphQL.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Making a GraphQL Request" data-type="sect2"><div class="sect2" id="making-a-graphql-request">&#13;
<h2>Making a GraphQL Request</h2>&#13;
&#13;
<p>A GraphQL request is an HTTP request that contains a query in the body of the request. You can use <code>fetch</code> to make a GraphQL request. There are also a number of libraries and frameworks that can handle the details of making these types of requests for you. In this next section, we’ll see how we can hydrate our applications with GraphQL data using a library called <code>graphql-request</code>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>GraphQL is not restricted to HTTP. It’s a specification of how data requests should be made over a network. It can technically work with any network protocol. Additionally, GraphQL is language-agnostic.</p>&#13;
</div>&#13;
&#13;
<p>First, let’s install <code>graphql-request</code>:</p>&#13;
&#13;
<pre data-type="programlisting">npm i graphql-request</pre>&#13;
&#13;
<p>GitHub’s GraphQL API requires identification to send requests from client applications. In order to complete this next sample, you must obtain a personal access token from GitHub, and this token must be sent with every request.</p>&#13;
&#13;
<p>To obtain a personal access token for GraphQL requests, navigate to Settings &gt; Developer Settings &gt; Personal Access Tokens. On this form, you can create an access token that has specific rights. The token must have the following read access in order to make GraphQL requests:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>user</p>&#13;
</li>&#13;
<li>&#13;
<p>public_repo</p>&#13;
</li>&#13;
<li>&#13;
<p>repo</p>&#13;
</li>&#13;
<li>&#13;
<p>repo_deployment</p>&#13;
</li>&#13;
<li>&#13;
<p>repo:status</p>&#13;
</li>&#13;
<li>&#13;
<p>read:repo_hook</p>&#13;
</li>&#13;
<li>&#13;
<p>read:org</p>&#13;
</li>&#13;
<li>&#13;
<p>read:public_key</p>&#13;
</li>&#13;
<li>&#13;
<p>read:gpg_key</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>We can use <code>graphql-request</code> to make GraphQL requests from JavaScript:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="p">{</code> <code class="nx">GraphQLClient</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"graphql-request"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">query</code> <code class="o">=</code> <code class="sb">`</code>&#13;
<code class="sb">  query findRepos($login:String!) {</code>&#13;
<code class="sb">    user(login:$login) {</code>&#13;
<code class="sb">      login</code>&#13;
<code class="sb">      name</code>&#13;
<code class="sb">      location</code>&#13;
<code class="sb">      avatar_url: avatarUrl</code>&#13;
<code class="sb">      repositories(first:100) {</code>&#13;
<code class="sb">        totalCount</code>&#13;
<code class="sb">        nodes {</code>&#13;
<code class="sb">          name</code>&#13;
<code class="sb">        }</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">client</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">GraphQLClient</code><code class="p">(</code>&#13;
  <code class="s2">"https://api.github.com/graphql"</code><code class="p">,</code>&#13;
  <code class="p">{</code>&#13;
    <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>&#13;
      <code class="nx">Authorization</code><code class="o">:</code> <code class="sb">`Bearer &lt;PERSONAL_ACCESS_TOKEN&gt;`</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">);</code>&#13;
&#13;
<code class="nx">client</code>&#13;
  <code class="p">.</code><code class="nx">request</code><code class="p">(</code><code class="nx">query</code><code class="p">,</code> <code class="p">{</code> <code class="nx">login</code><code class="o">:</code> <code class="s2">"moontahoe"</code> <code class="p">})</code>&#13;
  <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">results</code> <code class="o">=&gt;</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">results</code><code class="p">,</code> <code class="kc">null</code><code class="p">,</code> <code class="mi">2</code><code class="p">))</code>&#13;
  <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">)</code>&#13;
  <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code></pre>&#13;
&#13;
<p>We send this request using the <code>GraphQLClient</code> constructor from <code>graphql-request</code>. When we create the client, we use the URI for GitHub’s GraphQL API: <em>https://api.github.com/graphql</em>. We also send some additional headers that contain our personal access token. This token identifies us and is required by GitHub when using their GraphQL API. We can now use the <code>client</code> to make our GraphQL requests.</p>&#13;
&#13;
<p>In order to make a GraphQL request, we’ll need a <code>query</code>. The <code>query</code> is simply a string that contains the GraphQL query from above. We send the <code>query</code> to the <code>request</code> function along with any variables that the query may require. In this case, the <code>query</code> requires a variable named <code>$login</code>, so we send an object that contains a value for <code>$login</code> in the <code>login</code> field.</p>&#13;
&#13;
<p>Here, we’re simply converting the resulting JSON to a string and logging it to the <span class="keep-together">console</span>:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"user"</code><code class="p">:</code> <code class="p">{</code>&#13;
    <code class="nt">"id"</code><code class="p">:</code> <code class="s2">"MDQ6VXNlcjU5NTIwODI="</code><code class="p">,</code>&#13;
    <code class="nt">"login"</code><code class="p">:</code> <code class="s2">"MoonTahoe"</code><code class="p">,</code>&#13;
    <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Alex Banks"</code><code class="p">,</code>&#13;
    <code class="nt">"location"</code><code class="p">:</code> <code class="s2">"Tahoe City, CA"</code><code class="p">,</code>&#13;
    <code class="nt">"avatar_url"</code><code class="p">:</code> <code class="s2">"https://avatars0.githubusercontent.com/u/5952082?v=4"</code><code class="p">,</code>&#13;
    <code class="nt">"repositories"</code><code class="p">:</code> <code class="p">{</code>&#13;
      <code class="nt">"totalCount"</code><code class="p">:</code> <code class="mi">52</code><code class="p">,</code>&#13;
      <code class="nt">"nodes"</code><code class="p">:</code> <code class="p">[</code>&#13;
        <code class="p">{</code>&#13;
          <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"snowtooth"</code>&#13;
        <code class="p">},</code>&#13;
        <code class="p">{</code>&#13;
          <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Memory"</code>&#13;
        <code class="p">},</code>&#13;
        <code class="p">{</code>&#13;
          <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"snowtooth-status"</code>&#13;
        <code class="p">},</code>&#13;
&#13;
        <code class="err">...</code>&#13;
&#13;
      <code class="p">]</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Just like <code>fetch</code>, <code>client.request</code> returns a promise. Getting this data inside of your React component will feel very similar to fetching data from a route:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">App</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">login</code><code class="p">,</code> <code class="nx">setLogin</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="s2">"moontahoe"</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">userData</code><code class="p">,</code> <code class="nx">setUserData</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">();</code>&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">client</code>&#13;
      <code class="p">.</code><code class="nx">request</code><code class="p">(</code><code class="nx">query</code><code class="p">,</code> <code class="p">{</code> <code class="nx">login</code> <code class="p">})</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(({</code> <code class="nx">user</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="nx">user</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">setUserData</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="k">catch</code><code class="p">(</code><code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">},</code> <code class="p">[</code><code class="nx">client</code><code class="p">,</code> <code class="nx">query</code><code class="p">,</code> <code class="nx">login</code><code class="p">]);</code>&#13;
&#13;
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">userData</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">SearchForm</code> <code class="nx">value</code><code class="o">=</code><code class="p">{</code><code class="nx">login</code><code class="p">}</code> <code class="nx">onSearch</code><code class="o">=</code><code class="p">{</code><code class="nx">setLogin</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">UserDetails</code> <code class="p">{...</code><code class="nx">userData</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">userData</code><code class="p">.</code><code class="nx">repositories</code><code class="p">.</code><code class="nx">totalCount</code><code class="p">}</code> <code class="o">-</code> <code class="nx">repos</code><code class="o">&lt;</code><code class="err">/p&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">List</code>&#13;
        <code class="nx">data</code><code class="o">=</code><code class="p">{</code><code class="nx">userData</code><code class="p">.</code><code class="nx">repositories</code><code class="p">.</code><code class="nx">nodes</code><code class="p">}</code>&#13;
        <code class="nx">renderItem</code><code class="o">=</code><code class="p">{</code><code class="nx">repo</code> <code class="o">=&gt;</code> <code class="o">&lt;</code><code class="nx">span</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">repo</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/span&gt;}</code>&#13;
      <code class="err">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>We make the <code>client.request</code> inside of a <code>useEffect</code> hook. If the <code>client</code>, <code>query</code>, or <code>login</code> changes, the <code>useEffect</code> hook will make another request. Then we’ll render the resulting JSON with React, as shown in <a data-type="xref" href="#fig0812">Figure 8-12</a>.</p>&#13;
&#13;
<figure><div class="figure" id="fig0812">&#13;
<img alt="GraphQL app" src="assets/lrc2_0812.png"/>&#13;
<h6><span class="label">Figure 8-12. </span>GraphQL app</h6>&#13;
</div></figure>&#13;
&#13;
<p>This example doesn’t put care into handling <code>loading</code> and <code>error</code> states, but we can apply everything we learned in the rest of this chapter to GraphQL. React doesn’t really care how we get the data. As long as we understand how to work with asynchronous objects like promises within our components, we’ll be ready for anything.</p>&#13;
&#13;
<p>Loading data from the internet is an asynchronous task. When we request data, it takes some time for it to be delivered, and stuff can go wrong. Handling the <code>pending</code>, <code>success</code>, and <code>fail</code> states of a promise within a React component is an orchestration of stateful hooks with the <code>useEffect</code> hook.</p>&#13;
&#13;
<p>We spent much of this chapter covering promises, <code>fetch</code>, and HTTP. This is because HTTP is still the most popular way to request data from the internet, and promises fit nicely with HTTP requests. Sometimes, you may work with a different protocol like WebSockets. No worries: this is accomplished by working with stateful hooks and <code>useEffect</code>.</p>&#13;
&#13;
<p>Here’s a brief example of how we can incorporate socket.io into a custom <code>useChatRoom</code> hook:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">reducer</code> <code class="o">=</code> <code class="p">(</code><code class="nx">messages</code><code class="p">,</code> <code class="nx">incomingMessage</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
  <code class="nx">messages</code><code class="p">,</code>&#13;
  <code class="p">...</code><code class="nx">incomingMessage</code>&#13;
<code class="p">];</code>&#13;
&#13;
<code class="kr">export</code> <code class="kd">function</code> <code class="nx">useChatRoom</code><code class="p">(</code><code class="nx">socket</code><code class="p">,</code> <code class="nx">messages</code> <code class="o">=</code> <code class="p">[])</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">status</code><code class="p">,</code> <code class="nx">setStatus</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="p">(</code><code class="kc">null</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="p">[</code><code class="nx">messages</code><code class="p">,</code> <code class="nx">appendMessage</code><code class="p">]</code> <code class="o">=</code> <code class="nx">useReducer</code><code class="p">(</code>&#13;
    <code class="nx">reducer</code><code class="p">,</code>&#13;
    <code class="nx">messages</code>&#13;
  <code class="p">);</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">send</code> <code class="o">=</code> <code class="nx">message</code> <code class="o">=&gt;</code> <code class="nx">socket</code><code class="p">.</code><code class="nx">emit</code><code class="p">(</code><code class="s2">"message"</code><code class="p">,</code> <code class="nx">message</code><code class="p">);</code>&#13;
&#13;
  <code class="nx">useEffect</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">socket</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"connection"</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">setStatus</code><code class="p">(</code><code class="s2">"connected"</code><code class="p">));</code>&#13;
    <code class="nx">socket</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"disconnecting"</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code>&#13;
      <code class="nx">setStatus</code><code class="p">(</code><code class="s2">"disconnected"</code><code class="p">)</code>&#13;
    <code class="p">);</code>&#13;
    <code class="nx">socket</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"message"</code><code class="p">,</code> <code class="nx">setStatus</code><code class="p">);</code>&#13;
    <code class="k">return</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="nx">socket</code><code class="p">.</code><code class="nx">removeAllListeners</code><code class="p">(</code><code class="s2">"connect"</code><code class="p">);</code>&#13;
      <code class="nx">socket</code><code class="p">.</code><code class="nx">removeAllListeners</code><code class="p">(</code><code class="s2">"disconnect"</code><code class="p">);</code>&#13;
      <code class="nx">socket</code><code class="p">.</code><code class="nx">removeAllListeners</code><code class="p">(</code><code class="s2">"message"</code><code class="p">);</code>&#13;
    <code class="p">};</code>&#13;
  <code class="p">},</code> <code class="p">[]);</code>&#13;
&#13;
  <code class="k">return</code> <code class="p">{</code>&#13;
    <code class="nx">status</code><code class="p">,</code>&#13;
    <code class="nx">messages</code><code class="p">,</code>&#13;
    <code class="nx">send</code>&#13;
  <code class="p">};</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This hook provides an array of chat <code>messages</code>, the websocket <code>connection</code> status, and a function that can be used to broadcast new messages to the socket. All of these values are affected by listeners that are defined in the <code>useEffect</code> hook. When the socket raises <code>connection</code> or <code>disconnecting</code> events, the value for <code>status</code> changes. When new messages are received, they’re appended to the array of messages via the <code>useReducer</code> hook.<a data-primary="" data-startref="DMgraph08" data-type="indexterm" id="idm45901623980856"/><a data-primary="" data-startref="graphql08" data-type="indexterm" id="idm45901623979848"/><a data-primary="" data-startref="SMuseState08" data-type="indexterm" id="idm45901623978904"/><a data-primary="" data-startref="HuseState08" data-type="indexterm" id="idm45901623977960"/><a data-primary="" data-startref="useState08" data-type="indexterm" id="idm45901623977016"/></p>&#13;
&#13;
<p>In this chapter, we’ve discussed some techniques for handling asynchronous data in applications. This is a hugely important topic, and in the next chapter, we’ll show how Suspense might lead to future changes in this area.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>