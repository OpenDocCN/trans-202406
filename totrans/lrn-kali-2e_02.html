<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xml:lang="en"
      lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<title>Learning Kali Linux, 2nd Edition</title>
<link rel="stylesheet" type="text/css" href="override_v1.css"/>
<link rel="stylesheet" type="text/css" href="epub.css"/>
</head>
<body>
<div id="book-content">
<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 2. Network Security Testing Basics"><div class="chapter" id="network_security_testing_basics">
<h1><span class="label">Chapter 2. </span>Network Security Testing Basics</h1>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id282">
<h1>A Note for Early Release Readers</h1>
<p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p>

<p>This will be the 2nd chapter of the final book. Please note that the GitHub repo will be made active later on.</p>

<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the editor at <a href="mailto:rfernando@oreilly.com">rfernando@oreilly.com</a>.</p>
</div></aside>

<p><em>Security testing</em> is a broad term<a data-type="indexterm" data-primary="network security testing" data-secondary="security testing defined" id="id283"></a><a data-type="indexterm" data-primary="Kali Linux" data-secondary="network security testing basics" id="KLbasic02"></a> that means a lot of different things. Often, penetration testing is done remotely, over the network. Not all security testing is penetration testing, though. Sometimes, development teams may want applications tested, including web applications. These web applications may include a number of network services. Sometimes, you may be testing not only networked applications but devices. Both the application and the device may need to be stress-tested to ensure it can handle types of traffic or even large volumes of traffic.</p>

<p>Understanding how<a data-type="indexterm" data-primary="network security testing" data-secondary="network protocol stacks and" id="id284"></a> network protocol stacks are defined is essential if you want to perform any sort of network-based security testing. One<a data-type="indexterm" data-primary="protocols, defining" id="id285"></a> way of defining protocols and, more specifically, their interactions, is using the<a data-type="indexterm" data-primary="Open Systems Interconnection (OSI) model" id="id286"></a><a data-type="indexterm" data-primary="network security testing" data-secondary="Open Systems Interconnection (OSI) model" id="id287"></a> Open Systems Interconnection (OSI) model. Using the OSI model, we can break the communications into different functional elements and see clearly where different pieces of information are added to the<a data-type="indexterm" data-primary="packets" data-secondary="OSI model and" id="id288"></a> network packets as they are being created. Additionally, you can see the interaction from system to system across the functional elements.</p>

<p>Stress testing<a data-type="indexterm" data-primary="network security testing" data-secondary="stress testing" id="id289"></a><a data-type="indexterm" data-primary="stress testing" data-secondary="information generated by" id="id290"></a> is not only about generating a lot of traffic and sending it at an application or device. In some cases, you may stress an application or device by sending it data that isn’t expected. Applications, even applications running on limited-use devices (think Internet of Things like thermostats, locks, light switches), have an expectation about the type and structure of data that would be received. Sending something other than what was expected may cause an application failure. This is something useful to know. This is another type of stress testing, since you are stressing the logic of the application.</p>

<p>This is part of the reason why understanding how communications protocols are constructed. Performing network security testing requires understsanding how the different layers of the communications model come together. Once you have done that, you can think about how you want to approach security testing. Of course, it’s also helpful to understand what security testing is, so let’s start there then we can get into how the communications stacks work.</p>






<section data-type="sect1" data-pdf-bookmark="Security Testing"><div class="sect1" id="id21">
<h1>Security Testing</h1>

<p>When<a data-type="indexterm" data-primary="network security testing" data-secondary="penetration testing" id="id291"></a><a data-type="indexterm" data-primary="penetration testing" id="id292"></a> many people hear the term <em>security testing</em>, they may think of penetration testing where the goal is to get into systems and acquire the highest privileges possible. Security testing isn’t entirely about popping boxes. In fact, you might suggest that the majority of security testing isn’t penetration testing. There are just so many areas of protecting systems and software that aren’t related to what would commonly be thought of as penetration testing. Before we start talking about what we can do with Kali Linux when it comes to network security testing, we should go over what security is so you can better understand what testing means in this context.</p>

<p>When<a data-type="indexterm" data-primary="network security testing" data-secondary="CIA triad" id="id293"></a><a data-type="indexterm" data-primary="CIA triad" id="id294"></a><a data-type="indexterm" data-primary="triad" id="id295"></a> professionals, and certainly certification organizations, talk about security, they make reference to what is commonly known as the <em>triad</em>. Some will add elements, but at the core of information security are three fundamentals: confidentiality, integrity, and availability. Anything that may impact one of these aspects of systems or software impacts the security of that software or system. Security testing will or should take all of those aspects into consideration and not the limited view that a penetration test may provide insight into.</p>

<p>As you may know, the triad is can be represented as an equilateral triangle. The triangle is equilateral because all three elements are considered to have equal weight. Additionally, if any of the elements are lost, you no longer have a triangle. You can see a common representation in <a data-type="xref" href="#the_cia_triad">Figure 2-1</a>, where all three sides are the same length. Every one of these elements is considered crucial for information to be considered reliable and trustworthy. These days, because businesses and people rely so heavily on information that is stored digitally, it’s essential that information be available, be confidential when necessary, and have integrity.</p>

<figure><div id="the_cia_triad" class="figure">
<img src="assets/lklx_0201.png" alt="images/Ch2Fig1.png" width="729" height="506"/>
<h6><span class="label">Figure 2-1. </span>The CIA triad</h6>
</div></figure>

<p>Most<a data-type="indexterm" data-primary="network security testing" data-secondary="confidentiality" id="id296"></a><a data-type="indexterm" data-primary="confidentiality" id="id297"></a> businesses run on secrets. People also have secrets: their social security number, passwords they use, tax information, medical information, and a variety of other pieces of data. Businesses need to protect their intellectual property, for one thing. They may have many trade secrets that could have negative impacts on the business if the information were to get out of the organization. Keeping this information secret, regardless of what it is, is <em>confidentiality</em>. Anytime information can be retrieved by anyone who doesn’t have permission to retrieve it, confidentiality has been breached. This is the primary element that has been impacted in countless thefts of data, from Target, to the Office of Personnel Management, to Equifax and Sony. When consumer information is stolen, the confidentiality of that information has been compromised. Modern ransomware attacks also impact confidentiality. Attackers will steal data with the threat of releasing it publicly.</p>

<p>Generally, we expect<a data-type="indexterm" data-primary="network security testing" data-secondary="integrity" id="id298"></a><a data-type="indexterm" data-primary="integrity" id="id299"></a> that when we store something, it will be the same when we go to retrieve it. Corrupted or altered data may be caused by various factors, which may not necessarily be malicious in nature. Just because we talk about security doesn’t always mean we are talking about malicious behavior. Certainly, the cases I mentioned previously were malicious. However, bad or failing memory can cause data corruption on a disk. I say this from personal experience. Similarly, failing hard drives or other storage media can cause data corruption. Of course, in some cases malicious and deliberate actions will lead to corrupted or incorrect data. When that information has been corrupted, no matter the cause, it’s a failure or breach of integrity. <em>Integrity</em> is entirely about something being in a state you reasonably expect it to be in. Consider ransomware again. When data has been encrypted by an attacker, it has lost its integrity since it’s not in the state it was when the user last accessed it.</p>

<p>Finally, let’s<a data-type="indexterm" data-primary="network security testing" data-secondary="availability" id="id300"></a> consider <em>availability</em>. If I kick the plug to your computer out of the wall, likely falling to the floor and maybe hitting my head in the process, your computer will become unavailable (as long as we are talking about a desktop system and not a system with a battery). Similarly, if you have a network cable and the clip has come off such that the connector won’t stay in the wall jack or in the network interface card, your system will be unavailable on the network. This may impact you, of course, and your ability to do your job, but it may also impact others if they need anything that’s on your computer. Anytime there is a server failure, that’s an impact to availability. If an attacker can cause a service or entire operating system to fail, even temporarily, that’s an impact to availability, which can have serious ramifications to the business. It may mean consumers can’t get to advertised services. It may mean a lot of expenditure in manpower and other resources to keep the services running and available, as in the case of the banks that were hit with enormous, sustained, and lengthy denial-of-service attacks. While the attempt at an availability failure wasn’t successful, there was an impact to the business in fighting it. One more visit to the house of ransomware to say that encrypted data when you don’t have the decryption key is an availability problem. If it’s not readable, it’s not available, at least in a usable form.</p>

<p>This raises the issue of the limitations of the CIA triad. Donn Parker proposed three additional properties of information security to add to the three properties of the CIA triad. According to Parker, security also extends to Control, Authenticity, and Utility. Control is about possession. If I have posssession of a resource, I am in control of it. Authenticity is about verification. Is the item in question what it is supposed to be? This includes the source of material, including emails. Digital signatures are ways of verifying authenticity. Finally, utility is whether something is useful. This is perhaps a better term for when data has been encrypted by a ransomware threat actor. Technically, the files are available, they just aren’t very useful in the form they are in.</p>

<p>Testing<a data-type="indexterm" data-primary="network security testing" data-secondary="security testing defined" id="id301"></a> anything related to these elements is security testing, no matter what form that testing may take. When it comes to network security testing, we may be testing service fragility, encryption strength, and other factors. What we will be looking at when we talk about network testing is a set of stress-testing tools to start with. We will also look at other tools that are sometimes known to cause network failures. While a lot of bugs in the network stacks of operating systems were likely fixed years ago, you may sometimes run into lighter weight, fragile devices that may be attached to the network. These devices may be more susceptible to these sorts of attacks. These devices may include printers, Voice over IP phones, thermostats, refrigerators, and nearly countless other devices that are being connected, more and more, to networks these days.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Network Security Testing"><div class="sect1" id="id64">
<h1>Network Security Testing</h1>

<p>We live by the network; we die by the network. How much of your personal information is currently either stored outright or at least available by way of the internet, whether your information is stored on a device on your local network, the enterprise network of your employer or somewhere else on the internet, a place commonly called <em>the cloud</em>? When we live our lives expecting everything to be available and accessible by way of the network, it’s essential that we assure that our devices are capable of sustaining attack.</p>








<section data-type="sect2" data-pdf-bookmark="Monitoring"><div class="sect2" id="id22">
<h2>Monitoring</h2>

<p>Before<a data-type="indexterm" data-primary="network security testing" data-secondary="monitoring" id="NSTmonitor02"></a><a data-type="indexterm" data-primary="monitoring" id="monitor02"></a> we do any testing at all, we need to talk about the importance of monitoring. If you are doing any of the testing we are talking about for your company or a customer, ideally you aren’t taking anything down deliberately unless you have been asked to. However, no matter how careful you are, there is always the possibility that something bad may happen and services or systems may get knocked over. This is why it’s essential to communicate with the people who own the systems so they can keep an eye on their systems and services. Businesses are not going to want to impact their customers, so they will often want staff to be available to restart services or systems if that’s necessary.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Some companies may want to test their operations staff, meaning they expect you to do what you can to infiltrate and knock over systems and services, without doing any long-term or permanent damage. This is commonly called red teaming. In this case, you wouldn’t communicate with anyone but the management who hired you. In most cases, though, companies are going to want to make sure they keep their production environment operational. If part of the operations staff or its management is in on it, trying to see whether they are able to detect the infiltration, the testing is called purple teaming. The operations staff is the blue team, the attack team is the red team. You put the two together, you get a purple team.</p>
</div>

<p>If<a data-type="indexterm" data-primary="log management" data-secondary="role in network security testing" id="id302"></a> the operations staff is involved, they will want to have some sort of monitoring in place. This could be watching logs, which is generally advisable. However, logs are not always reliable. After all, if you are able to crash a service, the service may not have long enough to write anything useful to the logs before failing. This does not mean, though, that you should discount logs. Keep in mind that the purpose of security testing is to help improve the security posture of the company you are working for. The logs may be essential to get hints as to what is happening with the process before it fails. Services may not fail in the sense that the process stops, but sometimes the service may not behave as expected. This is where logs can be important, to get a sense of what the application was trying to do.</p>

<p>There<a data-type="indexterm" data-primary="watchdog capability" id="id303"></a> may be a watchdog in place. Watchdogs are sometimes used to ensure that a process stays up. Should the process fail, the PID would no longer appear in the process table, and the watchdog would know to restart that process. This same sort of watchdog capability can be used to determine whether the process has failed. Even if you don’t want the process restarted, just keeping an eye on the process table to see whether the process has failed will be an indicator if something has happened to the process.</p>

<p>With the older init system initialization, you could use the /etc/inittab file to specify processes that should be restarted on crashing. With the modern system initialization software systemd, you can configure services to automatically restart if they crash. This is done in the configuration file with the setting <em>Restart=</em>. You could set this parameter to <em>always</em> or maybe <em>on-failure</em>. Not all applications, though, are services. You could turn anything into a service by creating a systemd configuration file and starting/stopping the service using <em>systemctl</em>. You may not want to go through that process, though. You could use something like a Python script to automatically restart a process when it crashes. The script here generates a message when the process fails, then starts it up again. You just need to provide the executable name on the command line when you run the script.</p>

<p>+import sys
from datetime import datetime
import subprocess</p>

<p>cmd = sys.argv[1]
retcode = 1
while retcode != 0:
    prog = subprocess.run(cmd)
    retcode = prog.returncode
    if retcode != 0:
       print(“Program failed at “, datetime.now())<br/></p>

<p>Runaway processes<a data-type="indexterm" data-primary="memory usage, listing" id="id304"></a><a data-type="indexterm" data-primary="processor usage, listing" id="id305"></a><a data-type="indexterm" data-primary="resources, listing programs consuming" id="id306"></a> can start chewing up processor resources. As a result, looking at processor utilization and memory utilization is essential. This can be done using open source monitoring utilities. You can also use commercial software or, in the case of Windows or macOS, built-in operating system utilities for the monitoring. One popular monitoring program is Nagios Core. On one of my \ systems, I have Nagios Core installed. There is a commercial version of Nagios, which has long been an open source monitoring solution, but Nagios Core is still free and is available in many distribution repositories, including Ubuntu and Kali. In <a data-type="xref" href="#monitoring_resources">Figure 2-2</a>, you can see the Services page, which shows the status of services on the host Nagios Core is running on. Without any additional configuration, Nagios monitors the number of processes, processor utilization, and service state of both the SSH and HTTP servers.</p>

<figure><div id="monitoring_resources" class="figure">
<img src="assets/lklx_0203.png" alt="images/Ch2Fig2.png" width="2314" height="730"/>
<h6><span class="label">Figure 2-2. </span>Monitoring resources</h6>
</div></figure>

<p>If you aren’t getting the cooperation, for whatever reason, of the operations staff, and you don’t have direct access to the systems under test, you may need to be able to track at least the<a data-type="indexterm" data-primary="service management" data-secondary="tracking service state remotely" id="id307"></a> service state remotely. When you are using some of the network test tools that we’ll be talking about here, they may stop getting responses from the service being tested. This may or may not be a result of the service failing. It could be a problem with the monitoring or it could be some security mechanism in place to shut down network abuses. Manually verifying the service to ensure it is down is important.</p>
<div data-type="tip"><h1>Essential to Reporting</h1>
<p>When<a data-type="indexterm" data-primary="service management" data-secondary="monitoring service failures" id="id308"></a> you are testing and you notice that a service has failed, make sure you have noted, to the best of your ability, where the failure occurred. Telling a customer or your employer that a service failed isn’t very helpful because they won’t know how to fix it. Keeping detailed notes will help you when you get to reporting so you can tell them exactly what you were doing when the service failed if they need to be able to recreate it in order to resolve the problem. Specific times may allow them to find details in the logs, which can help them pinpoint the underlying issue.</p>
</div>

<p>Manual testing<a data-type="indexterm" data-primary="manual testing, tools for" id="id309"></a><a data-type="indexterm" data-primary="netcat" id="id310"></a><a data-type="indexterm" data-primary="Telnet protocol" id="id311"></a> can be done using a tool like <em>netcat</em> or even the <em>telnet</em> client. When you connect to a service port by using one of these tools, you will get an indication as to whether the service is responsive. This, of course, relies on you testing a network service rather than a local application. Doing this manual verification, especially if it’s done from a separate system to rule out being blocked or blacklisted, can help to rule out false positives. Ultimately, a lot of security testing can come down to ruling out false positives that result from the different tools that we use. Monitoring and validation are essential to make sure that what you are presenting to your employer or customer is valid as well as actionable. Remember, you are trying to help them improve their security posture, not just point out where things are broken.<a data-type="indexterm" data-primary="" data-startref="monitor02" id="id312"></a><a data-type="indexterm" data-primary="" data-startref="NSTmonitor02" id="id313"></a></p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Layers"><div class="sect2" id="id23">
<h2>Layers</h2>

<p>As<a data-type="indexterm" data-primary="network security testing" data-secondary="layers" id="NSTlayer02"></a><a data-type="indexterm" data-primary="layers" data-secondary="cake analogy for network layers" id="id314"></a> Donkey in the movie <em>Shrek</em> suggests, layers are important. Actually, Shrek says that ogres have layers, and Donkey says cakes have layers, but Shrek likens ogres to onions, and cake is better than onions. Plus, I still hear Eddie Murphy as Donkey saying cakes have layers. None of which is really the point, of course. Except for cake. Cake may be the point—because when we talk about networks and communications between systems, we usually talk about layers. If you think about a seven-layer cake, with thin layers of cake, you may be able to envision the way we think about networks. Plus, in order to envision the best process, you’d need to envision two slices of cake. Two slices of cake have to be better than one slice of cake, right?</p>

<p><a data-type="xref" href="#osi_model_showing_system_to_system_communication">Figure 2-3</a> shows a simple representation of the seven layers<a data-type="indexterm" data-primary="layers" data-secondary="Open Systems Interconnection (OSI) model" id="id315"></a><a data-type="indexterm" data-primary="Open Systems Interconnection (OSI) model" id="id316"></a> of the OSI model and how each layer communicates with the same layer on remote systems. You can imagine that the lines between each of the layers is really icing and maybe jam, just to make it more interesting. Plus, the jam will help the layers adhere to one another since it’s sticky. Each layer on every system you are communicating with is exactly the same, so when you are sending a message from one slice of cake to the other slice of cake, it’s the matching layer from the sending cake to the receiving cake.</p>

<figure><div id="osi_model_showing_system_to_system_communication" class="figure">
<img src="assets/lklx_0202.png" alt="images/Ch2Fig3.png" width="803" height="670"/>
<h6><span class="label">Figure 2-3. </span>OSI model showing system-to-system communication</h6>
</div></figure>

<p>Let’s think<a data-type="indexterm" data-primary="physical layer" id="id317"></a><a data-type="indexterm" data-primary="layers" data-secondary="physical layer" id="id318"></a> about it this way. Our first layer at the very bottom is the <em>physical layer</em>, so we can think of that as pistachio. Our pistachio (physical) layer is where we connect to the network or, in this case, the plate that the cake sits on. As with cake, nothing is between the physical layer of the system and the network. You take your network interface and plug a cable into it, connecting it on the other end into a jack. That’s all the physical layer. In our cake, the pistachio sits directly on the plate, with nothing between.</p>

<p>Our next layer, which has to pass through icing and jam so the operating system can distinguish between one layer and another, is dulce de leche (think caramel made from milk). This<a data-type="indexterm" data-primary="layers" data-secondary="data layer" id="id319"></a><a data-type="indexterm" data-primary="data layer" id="id320"></a> is our <em>data layer</em>. The addressing<a data-type="indexterm" data-primary="MAC (media access control) address" id="id321"></a><a data-type="indexterm" data-primary="OUI (organizationally unique identifier)" id="id322"></a> of this layer is done using the media access control (MAC) address. This address includes 3 bytes that belong to the vendor (sometimes referred to as the <em>organizationally unique identifier</em>, or OUI). The other 3 bytes, since the entire MAC address is 6 bytes long, are the unique identifier for your network interface. The two components together are the MAC address. Any communication on your local network has to happen at this layer. If I want to talk to you from my dulce de leche to your dulce de leche (because who else would understand dulce de leche but another dulce de leche), I would need to use the MAC address because it’s the only address that your network interface and my network interface understand. The address is physically wired into the interface itself, which is why it’s sometimes called the physical address. In <a data-type="xref" href="#EX_2_1">Example 2-1</a>, you can see a MAC address in the second column from the output of the program <em>ifconfig</em>.</p>
<div id="EX_2_1" data-type="example">
<h5><span class="label">Example 2-1. </span>MAC address</h5>

<pre data-type="programlisting" data-code-language="bash">ether<code class="w"> </code><code class="m">52</code>:54:00:11:73:65<code class="w">  </code>txqueuelen<code class="w"> </code><code class="m">1000</code><code class="w">  </code><code class="o">(</code>Ethernet<code class="o">)</code><code class="w"></code></pre></div>

<p>The<a data-type="indexterm" data-primary="layers" data-secondary="network layer" id="id323"></a><a data-type="indexterm" data-primary="network layer" id="id324"></a><a data-type="indexterm" data-primary="IP (Internet Protocol) addresses" id="id325"></a> next layer we come across, again crossing through our icing and jam to clearly distinguish one from the other, is Nilla wafer (vanilla), and our <em>network layer</em>. At the Nilla wafer layer (network), we address using IP addresses. This is also the address that enables us to pass outside our local network. The MAC address never passes outside the local network. The IP address does, though. Since we can communicate with different bakeries, all having cakes designed exactly like ours, using IP addresses, this is the layer that enables<a data-type="indexterm" data-primary="routers" data-secondary="network layer controlling routing" id="id326"></a> routing. It’s the routing address that allows us to get directions from one bakery to another by using the IP address. <a data-type="xref" href="#EX_2_2">Example 2-2</a> shows an IP address, which is comprised of 4 bytes, sometimes known as <em>octets</em> because they are each 8 bits long. This<a data-type="indexterm" data-primary="IPv4 addresses" id="id327"></a><a data-type="indexterm" data-primary="IPv6 addresses" id="id328"></a> is a version 4 IP address. Version 6 IP addresses are 16 bytes (128 bits) long, represented as hexadecimal values. As with the earlier example, this is from the output of <em>ifconfig</em>. You can see both IPv4 and IPv6 addresses here.</p>
<div id="EX_2_2" data-type="example">
<h5><span class="label">Example 2-2. </span>IP address</h5>

<pre data-type="programlisting" data-code-language="bash">inet<code class="w"> </code><code class="m">192</code>.168.1.253<code class="w">  </code>netmask<code class="w"> </code><code class="m">255</code>.255.255.0<code class="w">  </code>broadcast<code class="w"> </code><code class="m">192</code>.168.1.255<code class="w"></code>
inet6<code class="w"> </code>fe80::20c:29ff:fee2:e2c5<code class="w">  </code>prefixlen<code class="w"> </code><code class="m">64</code><code class="w">  </code>scopeid<code class="w"> </code>0x20&lt;link&gt;<code class="w"></code>
inet6<code class="w"> </code>fd23:5d5f:cd75:40d2:20c:29ff:fee2:e2c5<code class="w">  </code>prefixlen<code class="w"> </code><code class="m">64</code><code class="w">  </code>scopeid<code class="w"> </code>0x0&lt;global&gt;<code class="w"></code>
inet6<code class="w"> </code>fd23:5d5f:cd75:40d2:2627:83d5:9f9b:59ec<code class="w">  </code>prefixlen<code class="w"> </code><code class="m">64</code><code class="w">  </code>scopeid<code class="w"> </code>0x0&lt;global&gt;<code class="w"></code>
inet6<code class="w"> </code><code class="m">2601</code>:18d:8b7f:e33a::d9<code class="w">  </code>prefixlen<code class="w"> </code><code class="m">128</code><code class="w">  </code>scopeid<code class="w"> </code>0x0&lt;global&gt;<code class="w"></code></pre></div>

<p>The<a data-type="indexterm" data-primary="layers" data-secondary="transport layer" id="id329"></a><a data-type="indexterm" data-primary="transport layer" id="id330"></a> fourth layer in our cake is the teaberry layer (<em>transport</em>). Yes, it’s going to be a strangely flavored cake, but stay with me. Plus, if you don’t know what teaberry is, you should find it. Teaberry gum is very good. So, the teaberry layer gives us ports. This is another form of addressing. Think about it this way. Once you get to the bakery, you need to know which shelf you are looking for. This is the same sort of thing with ports. Once you have found your bakery with the IP address, you then need to find the shelf in the bakery, which is your port. The port will connect you to a service (program) that is running and has attached itself to that shelf (port). There are well-known ports that particular services run on. These are registered, and while the services (e.g., web server) can bind to a different port and listen on that, the well-known port is common because it’s what everyone knows to look for.</p>

<p>At<a data-type="indexterm" data-primary="layers" data-secondary="session layer" id="id331"></a><a data-type="indexterm" data-primary="session layer" id="id332"></a> layer five, it becomes challenging, simply because this layer is not always well understood. The fifth layer is strawberry, because we need some fruit in our cake, even if it’s just fruit flavoring. This is the <em>session layer</em>. The session layer is all about coordinating long-standing communications to make sure everything is synchronized. You can think about it as the session layer making sure that when you and I are eating our slices of cake at the same time (communicating), we are going at the same pace, so we start and finish at the same time. If we need to stop and take a drink of water, the session layer will make sure we do that at the same time. If we want to drink milk rather than water, the session layer will make sure that we are completely in sync so that we can start and finish at the same time and essentially look the same while we are eating. Because it’s all about how it looks.</p>

<p>Which<a data-type="indexterm" data-primary="layers" data-secondary="presentation layer" id="id333"></a><a data-type="indexterm" data-primary="presentation layer" id="id334"></a> brings us to the peanut butter layer, because what’s a cake without peanut butter? Especially if we have jam in our cake. This is the <em>presentation layer</em>. The presentation layer takes care of making everything look okay and correct. The presentation layer will make sure that there aren’t crumbs all over the place, for instance, making sure that what you are putting in your mouth actually looks like cake.</p>

<p>Finally, we have the amaretto layer. This<a data-type="indexterm" data-primary="layers" data-secondary="application layer" id="id335"></a><a data-type="indexterm" data-primary="application layer" id="id336"></a> is the <em>application layer</em>. Ultimately, this is the layer that sits closest to the eater (user). This takes what comes out of the presentation layer and gets it to the user in a way that it can be consumed as the user expects it to be consumed. One element of the cake analogy here that’s important is that when you use your fork to get a mouthful, you cut through the layers from amaretto down to pistachio. That’s how you load it onto the fork. When it’s consumed, however, it goes into your mouth pistachio end first. This is the same way we send and receive data messages. They are constructed from the application layer down and sent along. When they are received, they are <em>consumed</em> from the physical layer up, pulling off the headers at each layer to expose the next layer.</p>

<p>As we are working on network testing, we may be working at different layers of our cake. This is why it’s important to understand what each layer is. You need to understand the expectations of each layer so you can determine whether the behavior you are seeing is correct. We will be dealing with testing across multiple layers as we go forward, but generally each tool we will look at will target a specific layer. Network communication is about consuming the entire cake, but sometimes we need to focus our efforts (taste buds) on a specific layer to make sure that it tastes correctly all by itself, outside the context of the rest of the cake, even if we have to consume the entire cake to get that layer.<a data-type="indexterm" data-primary="" data-startref="NSTlayer02" id="id337"></a></p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Stress Testing"><div class="sect2" id="id24">
<h2>Stress Testing</h2>

<p>Some<a data-type="indexterm" data-primary="network security testing" data-secondary="stress testing" id="NSTstress02"></a><a data-type="indexterm" data-primary="stress testing" data-secondary="reasons for failures during" id="id338"></a> software, and even hardware, has a hard time handling enormous loads. There are many reasons for this. In the case of hardware, such as devices that are purpose built or devices that fall into the category of Internet of Things (IoT), there may be several reasons that it can’t survive a lot of traffic. The processor that’s built into the network interface could be underpowered because the design of the overall device never expected to see a lot of traffic. The application could be written poorly, and even if it is built into the hardware, a poorly designed application can still cause problems. As a result, it’s important for security testers to ensure that the infrastructure systems they are responsible for will not simply fall over when something bad <span class="keep-together">happens</span>.</p>

<p>It<a data-type="indexterm" data-primary="stress testing" data-secondary="potential ways of" id="id339"></a> may be easy to think of stress testing as flooding attacks. However, there are other ways to stress applications. One way is to send the application unexpected data that it may not know how to handle. There are techniques to handle this sort of attack, so we’re going to focus primarily on overwhelming systems here and deal with fuzzing attacks, where we deliberately generate bogus data, later. Having<a data-type="indexterm" data-primary="stress testing" data-secondary="fragroute program" id="id340"></a><a data-type="indexterm" data-primary="fragroute program" id="id341"></a> said that, though, in some cases network stacks in embedded devices may not be able to handle traffic that doesn’t look like it’s supposed to.</p>
<div data-type="warning" epub:type="warning"><h1>Ethics Warning</h1>
<p>You need to ensure<a data-type="indexterm" data-primary="ethical issues" data-secondary="permission for security testing" id="id342"></a><a data-type="indexterm" data-primary="network security testing" data-secondary="ethical considerations" id="id343"></a> that the systems you are working on—especially when there could be damage or disruption, and just about everything we will be talking about has that potential—are either yours or systems you have permission to be testing. It’s unethical at a minimum and likely even illegal to be testing any system you don’t own or have permission to be testing. Testing, no matter how simple it may seem to be, always has the potential to cause damage. Get your permission in writing, always!</p>
</div>

<p>Ultimately, any failure resulting<a data-type="indexterm" data-primary="availability" id="id344"></a> from a stress test is a problem with availability. If the system crashes, no one can get to anything. If the application fails, the service isn’t available to users. What you are performing is a denial-of-service attack. As a result, it’s important to be careful when performing these sorts of attacks. There are definitely ethical implications, as noted earlier, but there are also very real possibilities to cause damage, including significant outage to customer-facing services. More on that in a moment. A<a data-type="indexterm" data-primary="stress testing" data-secondary="hping3 tool" id="id345"></a><a data-type="indexterm" data-primary="hping3 tool" id="id346"></a><a data-type="indexterm" data-primary="packets" data-secondary="flooding tools for stress testing" id="id347"></a><a data-type="indexterm" data-primary="flooding tools" id="id348"></a> simple way to do stress testing is to use a tool like <em>hping3</em>. This fabulous tool can be used to craft packets on the command line. Essentially, you tell <em>hping3</em> what you want different fields to be set to, and it will create the packet the way you want.</p>

<p>This is not to say that you need to always specify all of the fields. You can specify what you want, and <em>hping3</em> will fill the rest of the fields in the IP and transport headers as normal. <em>hping3</em> is capable of flooding by not bothering to wait for any responses or even bothering to use any waiting periods. The tool will send out as much traffic as it can, as fast as it can. You can see the output from the tool in <a data-type="xref" href="#EX_2_3">Example 2-3</a>.</p>
<div id="EX_2_3" data-type="example">
<h5><span class="label">Example 2-3. </span>Using hping3 for flooding</h5>

<pre data-type="programlisting" data-code-language="bash">kilroy@rosebud:~$<code class="w"> </code>sudo<code class="w"> </code>hping3<code class="w"> </code>--flood<code class="w"> </code>-S<code class="w"> </code>-p<code class="w"> </code><code class="m">80</code><code class="w"> </code><code class="m">192</code>.168.86.1<code class="w"></code>
HPING<code class="w"> </code><code class="m">192</code>.168.86.1<code class="w"> </code><code class="o">(</code>eth0<code class="w"> </code><code class="m">192</code>.168.86.1<code class="o">)</code>:<code class="w"> </code>S<code class="w"> </code>set,<code class="w"> </code><code class="m">40</code><code class="w"> </code>headers<code class="w"> </code>+<code class="w"> </code><code class="m">0</code><code class="w"> </code>data<code class="w"> </code>bytes<code class="w"></code>
hping<code class="w"> </code><code class="k">in</code><code class="w"> </code>flood<code class="w"> </code>mode,<code class="w"> </code>no<code class="w"> </code>replies<code class="w"> </code>will<code class="w"> </code>be<code class="w"> </code>shown<code class="w"></code>
^C<code class="w"></code>
---<code class="w"> </code><code class="m">192</code>.168.86.1<code class="w"> </code>hping<code class="w"> </code>statistic<code class="w"> </code>---<code class="w"></code>
<code class="m">75425</code><code class="w"> </code>packets<code class="w"> </code>transmitted,<code class="w"> </code><code class="m">0</code><code class="w"> </code>packets<code class="w"> </code>received,<code class="w"> </code><code class="m">100</code>%<code class="w"> </code>packet<code class="w"> </code>loss<code class="w"></code>
round-trip<code class="w"> </code>min/avg/max<code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="m">0</code>.0/0.0/0.0<code class="w"> </code>ms<code class="w"></code></pre></div>
<div data-type="note" epub:type="note"><h1>Using sudo</h1>
<p>In previous versions of Kali and back to BackTrack before it, you logged in as the root user. There was no separate user account created during installation. This meant everything ran as the root user by default, which is a serious security no-no. Currently, Kali has you create a regular user account. Just as with other Linux distributions, to perform tasks that require administrative privileges, like packet crafting as <em>hping3</em> does, you need to use the <em>sudo</em> command.</p>
</div>

<p>When I ran this, I was connected to my Kali system remotely. As soon as I started it up, I tried to kill it because I had the output I was looking for. However, the system was cramming packets down the wire (and getting responses) as fast as it could. This made it hard to get the Ctrl-C I was trying to send to my Kali system, meaning <em>hping3</em> wasn’t dying—it was just merrily sending a lot of packets out into the network (fortunately, I used my local network to test on, rather than trying to test someone else’s system). The operating system and network were otherwise engaged, so there was no response for a long period of time. In <a data-type="xref" href="#EX_2_5">Example 2-5</a>, I am using <em>hping3</em> to send SYN messages to port 80. This is a SYN flood. In this example, I’m not only testing the ability of the system to handle the flood at the network stack (operating system) with just the capability of the hardware and operating system to respond to the traffic, but also testing the transport layer.</p>

<p>The<a data-type="indexterm" data-primary="TCP (Transport Control Protocol) connections" id="id349"></a> operating system has to hold out a small chunk of memory with Transport Control Protocol (TCP) connections. Years ago, the number of slots<a data-type="indexterm" data-primary="half-open connections" id="id350"></a> available for these initial messages, called <em>half-open connections</em>, wasn’t very large. The expectation was that the connecting system was well-behaved and it would complete the connection, at which point it was up to the application to manage. Once the number of slots available to take half-open connections is exhausted, no new connections, including connections from legitimate clients, will be accepted. These days, most systems<a data-type="indexterm" data-primary="stress testing" data-secondary="SYN floods" id="id351"></a><a data-type="indexterm" data-primary="SYN floods" id="id352"></a> are far more capable of handling SYN floods. The operating system will just handle these inbound, half-open connections and dispose of them using a variety of techniques, including reducing the timeout period during which the connection is allowed to be half-open.</p>

<p>This test uses SYN messages (<em>-S</em>) to port 80 (<em>-p 80</em>). The idea is that we should get a SYN/ACK message back as the second stage of the three-way handshake. I don’t have to specify a protocol because that’s accomplished by just saying that I want to send a SYN message. TCP is the only protocol that has the SYN message. Finally, I tell <em>hping3</em> that I want it to use flood mode (<em>--flood</em>). Other command-line flags will do the same thing by specifying the interleave rate (the amount of time to wait before sending the next message). This way is easier to remember and also pretty explicit.</p>
<div data-type="note" epub:type="note"><h1>hping and hping3</h1>
<p>The program <em>hping</em> has been through a few versions, as you can likely guess from the use of the 3 at the end. This tool is commonly available across multiple Linux distributions. You may call the program by <em>hping</em> on some systems, while on others, you may need to specify the version number—<em>hping2</em> or <em>hping3</em>, for instance.</p>
</div>

<p><em>hping3</em> is also useful for packet crafting testing, where you create packets that just shouldn’t exist in the real world to see whether the target system can handle it. Almost any kind of packet mangling attack you can think of is possible with this tool. As an example, there has been a denial of service attack called a LAND attack, which is short for local area network denial of service. In this attack, you send a SYN message to a device with the source address the same as the destination. If the network stack on the receiving end is unable to recognize this, the system will send a SYN/ACK back to the destination, which is itself. This could result in an endless loop of messages on the network interface. In the late 1990s, many operating systems were vulnerable to this and it could result in operating system crashes. While it was largely fixed in operating systems, there have been services that have been discovered to be vulnerable. Additionally, a lot of organizations have legacy operating systems that may still be susceptible and sometimes devices may be vulnerable, depending on the embedded OS. Mostly, though, demonstrating the LAND attack, as seen in <a data-type="xref" href="#EX_2_4">Example 2-4</a>, shows some of what <em>hping3</em> can do. You will also see the packet capture showing some of the messages that were generated to show the source and destination addresses are the same. The tool itself generates no output because no responses are ever received. The -a flag you see here will spoof a source address.</p>
<div id="EX_2_4" data-type="example">
<h5><span class="label">Example 2-4. </span>Using hping3 for a LAND attack</h5>

<pre data-type="programlisting" data-code-language="bash">┌──<code class="o">(</code>kilroy㉿badmilo<code class="o">)</code>-<code class="o">[</code>~<code class="o">]</code><code class="w"></code>
└─$<code class="w"> </code>sudo<code class="w"> </code>hping3<code class="w"> </code>-S<code class="w"> </code>-p<code class="w"> </code><code class="m">80</code><code class="w"> </code><code class="m">192</code>.168.1.1<code class="w"> </code>-a<code class="w"> </code><code class="m">192</code>.168.1.1<code class="w"></code>
HPING<code class="w"> </code><code class="m">192</code>.168.1.1<code class="w"> </code><code class="o">(</code>eth0<code class="w"> </code><code class="m">192</code>.168.1.1<code class="o">)</code>:<code class="w"> </code>S<code class="w"> </code>set,<code class="w"> </code><code class="m">40</code><code class="w"> </code>headers<code class="w"> </code>+<code class="w"> </code><code class="m">0</code><code class="w"> </code>data<code class="w"> </code>bytes<code class="w"></code>


<code class="m">18</code>:20:58.843654<code class="w"> </code>IP<code class="w"> </code><code class="m">192</code>.168.1.1.2258<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.http:<code class="w"> </code>Flags<code class="w"> </code><code class="o">[</code>S<code class="o">]</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">337020249</code>,<code class="w"> </code>win<code class="w"> </code><code class="m">512</code>,<code class="w"> </code>length<code class="w"> </code><code class="m">0</code><code class="w"></code>
<code class="m">18</code>:20:59.844076<code class="w"> </code>IP<code class="w"> </code><code class="m">192</code>.168.1.1.2259<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.http:<code class="w"> </code>Flags<code class="w"> </code><code class="o">[</code>S<code class="o">]</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">2123048602</code>,<code class="w"> </code>win<code class="w"> </code><code class="m">512</code>,<code class="w"> </code>length<code class="w"> </code><code class="m">0</code><code class="w"></code>
<code class="m">18</code>:21:00.844382<code class="w"> </code>IP<code class="w"> </code><code class="m">192</code>.168.1.1.2260<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.http:<code class="w"> </code>Flags<code class="w"> </code><code class="o">[</code>S<code class="o">]</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">1588084076</code>,<code class="w"> </code>win<code class="w"> </code><code class="m">512</code>,<code class="w"> </code>length<code class="w"> </code><code class="m">0</code><code class="w"></code>
<code class="m">18</code>:21:01.844912<code class="w"> </code>IP<code class="w"> </code><code class="m">192</code>.168.1.1.2261<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.http:<code class="w"> </code>Flags<code class="w"> </code><code class="o">[</code>S<code class="o">]</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">1297206682</code>,<code class="w"> </code>win<code class="w"> </code><code class="m">512</code>,<code class="w"> </code>length<code class="w"> </code><code class="m">0</code><code class="w"></code>
<code class="m">18</code>:21:02.845663<code class="w"> </code>IP<code class="w"> </code><code class="m">192</code>.168.1.1.2262<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.http:<code class="w"> </code>Flags<code class="w"> </code><code class="o">[</code>S<code class="o">]</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">1143979736</code>,<code class="w"> </code>win<code class="w"> </code><code class="m">512</code>,<code class="w"> </code>length<code class="w"> </code><code class="m">0</code><code class="w"></code>
<code class="m">18</code>:21:03.846443<code class="w"> </code>IP<code class="w"> </code><code class="m">192</code>.168.1.1.2263<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.http:<code class="w"> </code>Flags<code class="w"> </code><code class="o">[</code>S<code class="o">]</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">1068622138</code>,<code class="w"> </code>win<code class="w"> </code><code class="m">512</code>,<code class="w"> </code>length<code class="w"> </code><code class="m">0</code><code class="w"></code>
<code class="m">18</code>:21:04.847084<code class="w"> </code>IP<code class="w"> </code><code class="m">192</code>.168.1.1.2264<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.http:<code class="w"> </code>Flags<code class="w"> </code><code class="o">[</code>S<code class="o">]</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">894688939</code>,<code class="w"> </code>win<code class="w"> </code><code class="m">512</code>,<code class="w"> </code>length<code class="w"> </code><code class="m">0</code><code class="w"></code></pre></div>

<p>All of the TCP flags are available to be altered in anyway you would like. However, you are not limited to simple things like TCP SYN messages. You can also send UDP messages. <a data-type="xref" href="#EX_2_5">Example 2-5</a> shows an example of a UDP message. In this example, the source port is set to 0, which would not be a port that should be used. It would be unusual to see it in normal traffic. You can also see we have set the source address to be random. This is something you should be very careful of, however. Keep in mind that when you send out messages with a random source address, the responses to whatever you send will be sent to that random source address. If you are watching the network traffic, you will see the responses coming from the hosts on the internet that the responses to your messages were sent to. Confused yet? Just be careful about the network traffic you are sending because if you are connected in anyway to the internet, that traffic will get out and it may cause issues.</p>
<div id="EX_2_5" data-type="example">
<h5><span class="label">Example 2-5. </span>Using hping3 for UDP messages</h5>

<pre data-type="programlisting" data-code-language="bash">──<code class="o">(</code>kilroy㉿badmilo<code class="o">)</code>-<code class="o">[</code>~<code class="o">]</code><code class="w"></code>
└─$<code class="w"> </code>sudo<code class="w"> </code>hping3<code class="w"> </code>--udp<code class="w"> </code>--rand-source<code class="w"> </code>--baseport<code class="w"> </code><code class="m">0</code><code class="w"> </code>--destport<code class="w"> </code><code class="m">53</code><code class="w"> </code><code class="m">192</code>.168.1.15<code class="w"></code>
HPING<code class="w"> </code><code class="m">192</code>.168.1.15<code class="w"> </code><code class="o">(</code>eth0<code class="w"> </code><code class="m">192</code>.168.1.15<code class="o">)</code>:<code class="w"> </code>udp<code class="w"> </code>mode<code class="w"> </code>set,<code class="w"> </code><code class="m">28</code><code class="w"> </code>headers<code class="w"> </code>+<code class="w"> </code><code class="m">0</code><code class="w"> </code>data<code class="w"> </code>bytes<code class="w"></code>
ICMP<code class="w"> </code>Port<code class="w"> </code>Unreachable<code class="w"> </code>from<code class="w"> </code><code class="nv">ip</code><code class="o">=</code><code class="m">192</code>.168.1.15<code class="w"> </code><code class="nv">name</code><code class="o">=</code>UNKNOWN<code class="w"></code>
<code class="nv">status</code><code class="o">=</code><code class="m">0</code><code class="w"> </code><code class="nv">port</code><code class="o">=</code><code class="m">8</code><code class="w"> </code><code class="nv">seq</code><code class="o">=</code><code class="m">8</code><code class="w"></code>
ICMP<code class="w"> </code>Port<code class="w"> </code>Unreachable<code class="w"> </code>from<code class="w"> </code><code class="nv">ip</code><code class="o">=</code><code class="m">192</code>.168.1.15<code class="w"> </code><code class="nv">name</code><code class="o">=</code>UNKNOWN<code class="w"></code>
<code class="nv">status</code><code class="o">=</code><code class="m">0</code><code class="w"> </code><code class="nv">port</code><code class="o">=</code><code class="m">9</code><code class="w"> </code><code class="nv">seq</code><code class="o">=</code><code class="m">9</code><code class="w"></code>
ICMP<code class="w"> </code>Port<code class="w"> </code>Unreachable<code class="w"> </code>from<code class="w"> </code><code class="nv">ip</code><code class="o">=</code><code class="m">192</code>.168.1.15<code class="w"> </code><code class="nv">name</code><code class="o">=</code>UNKNOWN<code class="w"></code>
<code class="nv">status</code><code class="o">=</code><code class="m">0</code><code class="w"> </code><code class="nv">port</code><code class="o">=</code><code class="m">11</code><code class="w"> </code><code class="nv">seq</code><code class="o">=</code><code class="m">11</code><code class="w"></code></pre></div>

<p>Testing at the lower layers of the network stack using tools like <em>hping3</em> can lead to turning up issues on systems, especially on more fragile devices. Looking higher up in the network stack, though, Kali Linux has numerous tools that will tackle different services. When you think about the internet, what service springs to mind first? Spotify? Facebook? Twitter? Instagram? All of these are offered over HTTP, so you’re interacting, often, with a web server. Not<a data-type="indexterm" data-primary="stress testing" data-secondary="of web servers" data-secondary-sortas="web servers" id="id353"></a><a data-type="indexterm" data-primary="web servers" data-secondary="stress testing for" id="id354"></a> surprisingly, we can take on testing web servers. This is different from the application running on the web server, which is a different thing altogether and something we’ll take on much later. In the meantime, we want to make sure that web servers themselves will stay up.</p>

<p>Although Kali comes with tests for other protocols including<a data-type="indexterm" data-primary="SIP (Session Initiation Protocol)" id="id355"></a><a data-type="indexterm" data-primary="RTP (Real-time Transport Protocol)" id="id356"></a><a data-type="indexterm" data-primary="VoIP (Voice over IP)" id="id357"></a> the Session Initiation Protocol (SIP) and the Real-time Transport Protocol (RTP), both used for Voice over IP (VoIP). SIP uses a set of HTTP-like protocol commands to interact between servers and endpoints. When an endpoint wants to initiate a call, it sends an INVITE request. In order to get the INVITE to the recipient, it will need to be sent through multiple servers or proxies. Since VoIP is a mission-critical application in enterprises that use it, it can be essential to determine whether the devices in the network are capable of withstanding a large number of requests.</p>

<p>SIP can use either TCP or<a data-type="indexterm" data-primary="UDP (User Datagram Protocol)" id="id358"></a> User Datagram Protocol (UDP) as a transport, though earlier versions of the protocol favored UDP as the transport protocol. As a result, some tools, particularly if they are older, will lean toward using UDP. Modern implementations not only support TCP but also support<a data-type="indexterm" data-primary="TLS (Transport Layer Security)" id="id359"></a> Transport Layer Security (TLS) to ensure the headers can’t be read. Keep in mind that SIP is based on HTTP, which means all the headers and other information are text-based, unlike<a data-type="indexterm" data-primary="H.323 protocol" id="id360"></a> H.323, another VoIP protocol, which is binary and can’t generally be read visually without something to do a protocol decode. The<a data-type="indexterm" data-primary="inviteflood tool" id="id361"></a> tool <em>inviteflood</em> uses UDP as the transport protocol, without the ability to switch to TCP. This does, though, have the benefit of allowing the flood to happen faster because there is no time waiting for the connection to be established. In <a data-type="xref" href="#EX_2_6">Example 2-6</a>, you can see a run of <em>inviteflood</em>. This is not installed by default on Kali Linux, so you would need to install it before you can use it. You’ll note the old date referenced with the version. This is the still the most recent version.</p>
<div id="EX_2_6" data-type="example">
<h5><span class="label">Example 2-6. </span>SIP invite flood</h5>

<pre data-type="programlisting" data-code-language="bash">kilroy@rosebud:~$<code class="w"> </code>sudo<code class="w"> </code>inviteflood<code class="w"> </code>eth0<code class="w"> </code>kilroy<code class="w"> </code>dummy.com<code class="w"> </code><code class="m">192</code>.168.86.238<code class="w"> </code><code class="m">150000</code><code class="w"></code>

inviteflood<code class="w"> </code>-<code class="w"> </code>Version<code class="w"> </code><code class="m">2</code>.0<code class="w"></code>
<code class="w">              </code>June<code class="w"> </code><code class="m">09</code>,<code class="w"> </code><code class="m">2006</code><code class="w"></code>

<code class="nb">source</code><code class="w"> </code>IPv4<code class="w"> </code>addr:port<code class="w">   </code><code class="o">=</code><code class="w"> </code><code class="m">192</code>.168.86.35:9<code class="w"></code>
dest<code class="w">   </code>IPv4<code class="w"> </code>addr:port<code class="w">   </code><code class="o">=</code><code class="w"> </code><code class="m">192</code>.168.86.238:5060<code class="w"></code>
targeted<code class="w"> </code><code class="nv">UA</code><code class="w">             </code><code class="o">=</code><code class="w"> </code>kilroy@dummy.com<code class="w"></code>

Flooding<code class="w"> </code>destination<code class="w"> </code>with<code class="w"> </code><code class="m">150000</code><code class="w"> </code>packets<code class="w"></code>
sent:<code class="w"> </code><code class="m">150000</code><code class="w"></code></pre></div>

<p>We can break down what is happening on the command line. First, we specify the interface that <em>inviteflood</em> is supposed to use to send the messages out. Next, is the username. Since SIP is a VoIP protocol, it’s possible that this may be a number, like a phone number. In this case, I am targeting a SIP server that was configured with usernames. Following the username is the domain for the username. This may be an IP address, depending on how the target server is configured. If you don’t know the domain for the users, you could try using the IP address of the target system. In that case, you’d have the same value twice, since the target is the next value on the command line. At the end is the number of requests to send. That 150,000 requests took seconds to send off, meaning that the server was capable of supporting a large volume of requests per second.</p>

<p>Before<a data-type="indexterm" data-primary="stress testing" data-secondary="IPv6 addresses" id="id362"></a><a data-type="indexterm" data-primary="IPv6 addresses" id="id363"></a> moving on to other matters, we need to talk about IPv6. While it isn’t necessarily used as a transport protocol from your network to any other network, it can be used. If you were to connect to Google, for instance, it would still be done over IPv4 from your network more than likely. I mention Google in particular because Google publishes an IPv6 address through its Domain Name System (DNS) servers. It is far from the only one, but it was definitely one of the early companies that did. Beyond being able to send IPv6 through the internet, though, you may very well be using IPv6 on local networks. Even though IPv6 is approaching 30 years old as of this writing, it has not had the same run-in time that<a data-type="indexterm" data-primary="IPv4 addresses" id="id364"></a> IPv4 has had—and it took decades to chase some of the most egregious bugs out of various IPv4 implementations. This is all to say that in spite of the time that operating system vendors like Microsoft and the Linux team have put into development and testing, it’s possible that some devices may have issues with IPv6 implementations.</p>

<p>Kali includes IPv6 testing tool suites. There are two of them, and each suite has a good-sized collection of tools because in the end, IPv6 includes more than just changes to addressing. A complete implementation of IPv6 includes addressing, host configuration, security, multicasting, large datagrams, router processing, and a few other differences. Since these are different functional areas, multiple scripts are necessary to handle those areas.</p>

<p>The way IPv6 behaves on the local network has changed. Instead of the<a data-type="indexterm" data-primary="Address Resolution Protocol (ARP)" id="id365"></a> Address Resolution Protocol (ARP) being used to identify neighbors on the local network, IPv6 replaces and enhances that functionality through new<a data-type="indexterm" data-primary="Internet Control Message Protocol (ICMP)" id="id366"></a> Internet Control Message Protocol (ICMP) messages. Coming with IPv6 is the<a data-type="indexterm" data-primary="Neighbor Discovery Protocol" id="id367"></a> Neighbor Discovery Protocol, which is used to help a system connecting to the network by providing details about the local network. ICMPv6 has been enhanced with the<a data-type="indexterm" data-primary="routers" data-secondary="Router Solicitation and Router Advertisement in ICMPv6" id="id368"></a> Router Solicitation and Router Advertisement messages as well as the Neighbor Solicitation and Neighbor Advertisement messages. These four messages help a system to get situated on a network with all the relevant information needed, including the local gateway and domain name servers used on that network.</p>

<p>We will be able to test some of these features to determine how a system might perform under load but also by manipulating the messages in ways that may cause the target system to misbehave. The<a data-type="indexterm" data-primary="na6 and ns6 tools" id="id369"></a><a data-type="indexterm" data-primary="ra6 and rs6 tools" id="id370"></a> tools <em>na6</em>, <em>ns6</em>, <em>ra6</em>, and <em>rs6</em> all focus on sending arbitrary messages to the network by using the different ICMPv6 messages indicated previously. Whereas most systems will provide reasonable information to the network, to the best of their knowledge and configuration, these tools allow us to inject potentially broken messages out to the network to see how systems behave with such messages. In addition to those programs, the suite<a data-type="indexterm" data-primary="tcp6 tool" id="id371"></a> provides <em>tcp6</em>, which can be used to send arbitrary TCP messages out to the network, allowing the possibility of TCP-based attacks.</p>
<div data-type="note" epub:type="note"><h1>hping and hping3</h1>
<p>The tools referenced here are available in the package <em>ipv6toolkit</em>. This is not installed in the default installation of Kali Linux, however.</p>
</div>

<p>Another tool that can be used for stress testing in Kali Linux is <em>t50</em>. This supports multiple protocols, including TCP, UDP, RIP, IGMP, OSPF, and several others. In addition to being able to send protocol-specific messages, <em>t50</em> supports flooding mode, though not all protocols support flooding. <a data-type="xref" href="#EX_2_7">Example 2-7</a> shows not only a list of protocols supported by <em>t50</em> but also the use of <em>t50</em> to flood IGMP version 1 messages.</p>
<div id="EX_2_7" data-type="example">
<h5><span class="label">Example 2-7. </span>Using t50 to flood IGMP messages</h5>

<pre id="source" data-type="programlisting">┌──(kilroy㉿badmilo)-[~]
└─$ sudo t50 -l
T50 Experimental Mixed Packet Injector Tool v5.8.7b
Originally created by Nelson Brito &lt;nbrito@sekure.org&gt;
Previously maintained by Fernando Mercês &lt;fernando@mentebinaria.com.br&gt;
Maintained by Frederico Lamberti Pissarra &lt;fredericopissarra@gmail.com&gt;

[INFO]  List of supported protocols (--protocol):
         1 - ICMP       (Internet Control Message Protocol)
         2 - IGMPv1     (Internet Group Message Protocol v1)
         3 - IGMPv3     (Internet Group Message Protocol v3)
         4 - TCP        (Transmission Control Protocol)
         5 - EGP        (Exterior Gateway Protocol)
         6 - UDP        (User Datagram Protocol)
         7 - RIPv1      (Routing Internet Protocol v1)
         8 - RIPv2      (Routing Internet Protocol v2)
         9 - DCCP       (Datagram Congestion Control Protocol)
         10 - RSVP      (Resource Reservation Protocol)
         11 - IPSEC     (Internet Security Protocl (AH/ESP))
         12 - EIGRP     (Enhanced Interior Gateway Routing Protocol)
         13 - OSPF      (Open Shortest Path First)
┌──(kilroy㉿badmilo)-[~]
└─$ sudo t50 192.168.1.1 --protocol IGMPv1 --flood -B
T50 Experimental Mixed Packet Injector Tool v5.8.7b
Originally created by Nelson Brito &lt;nbrito@sekure.org&gt;
Previously maintained by Fernando Mercês &lt;fernando@mentebinaria.com.br&gt;
Maintained by Frederico Lamberti Pissarra &lt;fredericopissarra@gmail.com&gt;

[INFO] Entering flood mode...[INFO] Performing stress testing...
[INFO] Hit Ctrl+C to stop...
[INFO] PID=46521
[INFO] t50 5.8.7b successfully launched at Tue Jun 13 18:53:35 2023

[INFO] (PID:46521) packets:    302395 (8467060 bytes sent).
[INFO] (PID:46521) throughput: 52449.93 packets/second.</pre></div>

<p>No matter what sort of stress testing you are doing, it’s important to keep as many notes as possible so you can provide detailed information as to what was going on when a failure occurred. Monitoring and logging are important here.<a data-type="indexterm" data-primary="" data-startref="NSTstress02" id="id372"></a></p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Denial-of-Service Tools"><div class="sect2" id="id39">
<h2>Denial-of-Service Tools</h2>

<p>Denial of service<a data-type="indexterm" data-primary="attacks" data-secondary="denial-of-service attacks" id="ATdenial02"></a><a data-type="indexterm" data-primary="network security testing" data-secondary="denial-of-service tools" id="NSTdenial02"></a><a data-type="indexterm" data-primary="denial-of-service testing" data-secondary="stress testing and" id="id373"></a><a data-type="indexterm" data-primary="stress testing" data-secondary="denial-of-service testing and" id="id374"></a> is not the same as stress testing. The objective may be different when it comes to the two sets of tools being used. Stress testing is commonly done by development tools to be able to provide performance metrics. It is used to determine the functionality of a program or system under stress—​whether it’s the stress of volume or the stress of malformed messages. There is a fine line, though. In some cases, stress testing will cause a failure of the application or the operating system. This will result in a denial-of-service attack. However, stress testing may also just lead to CPU or memory spikes. These are also valuable findings, since this would be an opportunity to improve the programming. CPU or memory spikes are bugs, and bugs should be eradicated. What we are looking at in this section will be programs that are specifically developed for the purpose of knocking over services.</p>










<section data-type="sect3" data-pdf-bookmark="Slowloris attack"><div class="sect3" id="id25">
<h3>Slowloris attack</h3>

<p>Much<a data-type="indexterm" data-primary="attacks" data-secondary="Slowloris attack" id="ATslow02"></a><a data-type="indexterm" data-primary="denial-of-service testing" data-secondary="Slowloris attack" id="DOSslow02"></a><a data-type="indexterm" data-primary="Slowloris attack" id="slow02"></a><a data-type="indexterm" data-primary="web servers" data-secondary="Slowloris attack" id="WSslow02"></a> like the SYN flood that intends to fill up the partial connection queue, there are attacks that will do similar things to a web server. Applications don’t necessarily have unlimited resources at their disposal. Often there are caps on the connections the application server will take on. This depends on how the application is designed, and not all web servers are susceptible to these attacks. One thing to note here is that embedded devices often have limited resources when it comes to their memory and processor. Think about any device that has a web server for remote management—​your wireless access point, your cable modem/router, a printer. These devices have web servers to make management easier, but the primary purpose of these devices isn’t to provide web services; it’s to act as a wireless access point, a cable modem/router, or a printer. The resources for these devices will be primarily applied to the device’s intended function.</p>

<p>These devices are one place to use this sort of testing, because they simply won’t expect a lot of connections. This means that an attack such as Slowloris may be able to take these servers offline, denying service to anyone else who may try to connect. The Slowloris attack is designed to hold a lot of connections open to a web server. The difference between this attack and a flooding attack is this is a slow play attack. It’s not a flood. Instead, the attack tool holds the connection open by sending small amounts of data over a long period of time. The server will maintain these connections as long as the attack tool continues to send even small amounts of data partial requests that never quite get completed.</p>

<p>Slowloris is not the only type of attack that goes after web servers, though. In recent years, there have been a few vulnerabilities that go after web servers. Another one is<a data-type="indexterm" data-primary="Apache Killer" id="id375"></a><a data-type="indexterm" data-primary="web servers" data-secondary="Apache Killer" id="id376"></a> Apache Killer, which sends bytes in chunks that overlap. The web server, in trying to put the chunks together, eventually runs out of memory trying to make it work correctly. This was a vulnerability found in both the 1.x and 2.x versions of Apache.</p>

<p>One<a data-type="indexterm" data-primary="slowhttptest program" id="id377"></a> program that Kali has available is <em>slowhttptest</em>. Using <em>slowhttptest</em>, you can launch one of four HTTP attacks at your target. The first is a slow headers attack, otherwise known as Slowloris (as noted previously). The<a data-type="indexterm" data-primary="R-U-Dead-Yet" id="id378"></a> second is a slow body attack, otherwise known as R-U-Dead-Yet. The range attack, known as Apache Killer, is also available, as is a slow read attack. All of these are essentially the reverse of the flooding attacks discussed earlier in that they accomplish the denial of service with a limited number of network messages. In <a data-type="xref" href="#EX_2_7b">Example 2-8</a>, the default slow headers attack (Slowloris) was run against Apache on my Kali box. No traffic has left my system, and you can see that after the 26th second, the test ended with no connections left available. Of course, this was a simply configured web server with very few threads configured. A web application with multiple web servers available to manage load would survive considerably longer, if they were available at all.</p>
<div id="EX_2_7b" data-type="example">
<h5><span class="label">Example 2-8. </span>slowhttp output</h5>

<pre data-type="programlisting" data-code-language="bash">┌──<code class="o">(</code>kilroy㉿badmilo<code class="o">)</code>-<code class="o">[</code>~<code class="o">]</code><code class="w"></code>
└─$<code class="w"> </code>slowhttptest<code class="w"> </code>-H<code class="w"> </code>-u<code class="w"> </code>http://192.168.1.15<code class="w"></code>

<code class="w">        </code>slowhttptest<code class="w"> </code>version<code class="w"> </code><code class="m">1</code>.8.2<code class="w"></code>
<code class="w"> </code>-<code class="w"> </code>https://github.com/shekyan/slowhttptest<code class="w"> </code>-<code class="w"></code>
<code class="nb">test</code><code class="w"> </code>type:<code class="w">                        </code>SLOW<code class="w"> </code>HEADERS<code class="w"></code>
number<code class="w"> </code>of<code class="w"> </code>connections:<code class="w">            </code><code class="m">50</code><code class="w"></code>
URL:<code class="w">                              </code>http://192.168.1.15/<code class="w"></code>
verb:<code class="w">                             </code>GET<code class="w"></code>
cookie:<code class="w"></code>
Content-Length<code class="w"> </code>header<code class="w"> </code>value:<code class="w">      </code><code class="m">4096</code><code class="w"></code>
follow<code class="w"> </code>up<code class="w"> </code>data<code class="w"> </code>max<code class="w"> </code>size:<code class="w">          </code><code class="m">68</code><code class="w"></code>
interval<code class="w"> </code>between<code class="w"> </code>follow<code class="w"> </code>up<code class="w"> </code>data:<code class="w">  </code><code class="m">10</code><code class="w"> </code>seconds<code class="w"></code>
connections<code class="w"> </code>per<code class="w"> </code>seconds:<code class="w">          </code><code class="m">50</code><code class="w"></code>
probe<code class="w"> </code>connection<code class="w"> </code>timeout:<code class="w">         </code><code class="m">5</code><code class="w"> </code>seconds<code class="w"></code>
<code class="nb">test</code><code class="w"> </code>duration:<code class="w">                    </code><code class="m">240</code><code class="w"> </code>seconds<code class="w"></code>
using<code class="w"> </code>proxy:<code class="w">                      </code>no<code class="w"> </code>proxy<code class="w"></code>

Tue<code class="w"> </code>Jun<code class="w"> </code><code class="m">13</code><code class="w"> </code><code class="m">19</code>:05:51<code class="w"> </code><code class="m">2023</code>:<code class="w"></code>
slow<code class="w"> </code>HTTP<code class="w"> </code><code class="nb">test</code><code class="w"> </code>status<code class="w"> </code>on<code class="w"> </code>10th<code class="w"> </code>second:<code class="w"></code>

initializing:<code class="w">        </code><code class="m">0</code><code class="w"></code>
pending:<code class="w">             </code><code class="m">0</code><code class="w"></code>
connected:<code class="w">           </code><code class="m">50</code><code class="w"></code>
error:<code class="w">               </code><code class="m">0</code><code class="w"></code>
closed:<code class="w">              </code><code class="m">0</code><code class="w"></code>
service<code class="w"> </code>available:<code class="w">   </code>YES<code class="w"></code></pre></div>

<p>The Apache server targeted here uses multiple child processes and multiple threads to handle requests. Caps are set in the Apache configuration: the default here is 2 servers, a thread limit of 64, 25 threads per child, and a maximum of 150 request workers. As soon as the number of connections available was maxed out by <em>slowhttptest</em>, the number of Apache processes was 54 on this system. That would be 53 child processes and a master or parent process. To handle the number of connections required for the requests being made, Apache spawned multiple children and would have had multiple threads per child. That’s a lot of processes that have been started up. Considering that the Apache server that was running was completely up-to-date at the time of this writing, it seems clear that these types of attacks can be successful, in spite of how many years they have been around. Of course, as noted earlier, that entirely depends on the architecture of the site under test.<a data-type="indexterm" data-primary="" data-startref="DOSslow02" id="id379"></a><a data-type="indexterm" data-primary="" data-startref="slow02" id="id380"></a><a data-type="indexterm" data-primary="" data-startref="WSslow02" id="id381"></a><a data-type="indexterm" data-primary="" data-startref="ATslow02" id="id382"></a></p>
</div></section>










<section data-type="sect3" data-pdf-bookmark="SSL-based stress testing"><div class="sect3" id="id26">
<h3>SSL-based stress testing</h3>

<p>Another<a data-type="indexterm" data-primary="denial-of-service testing" data-secondary="SSL-based stress testing" id="id383"></a><a data-type="indexterm" data-primary="SSL-based stress testing" id="id384"></a><a data-type="indexterm" data-primary="stress testing" data-secondary="SSL-based stress testing" id="id385"></a><a data-type="indexterm" data-primary="web servers" data-secondary="SSL-based stress testing" id="id386"></a> resource-based attack that isn’t about bandwidth, but instead is about processor utilization, targets the processing requirements for encryption. For a long time, e-commerce sites have used<a data-type="indexterm" data-primary="SSL (Secure Sockets Layer)" id="id387"></a><a data-type="indexterm" data-primary="TLS (Transport Layer Security)" id="id388"></a> Secure Sockets Layer (SSL) or Transport Layer Security (TLS) to maintain encryption between the client and the server in order to ensure the privacy of all communication. While it’s often still referred to as SSL/TLS, SSL has been deprecated since 2015. TLS has been in use for longer than SSL was. As a result, you’ll see it referred to as TLS here, since that’s what we’re using. These days, many servers use TLS as a matter of course. If you attempt to search at Google, you will see that it is encrypted by default. Similarly, many other large sites, such as Microsoft and Apple, encrypt all traffic by default. If you try to visit the site by using an unencrypted uniform resource locator (URL) by specifying <em>http://</em> instead of <em>https://</em>, you would find that the server converts the connection automatically to <em>https</em> for you.</p>

<p>The thing about TLS, though, is that encryption requires processing power. Modern processors are more than capable of keeping up with normal encryption loads, especially as modern encryption algorithms are generally efficient with processor utilization. However, any server that uses TLS incurs some processing overhead. First, the messages that are sent from the server are generally larger, which means that it takes more processing to encrypt those larger messages than the comparably small messages originating from a client. Additionally, the client system is probably sending only a few messages at a time whereas the server is expected to be encrypting messages to a number of concurrent clients, which may all have multiple concurrent connections going to the server. The load primarily comes from the creation of the keys that are needed to encrypt the session.</p>

<p>Capabilities exist in Kali to target outdated services and capabilities. The problem is that some of these long superseded programs still remain in service in a lot of places. As a result, it’s still important to be able to test them. One of those services is the SSL encryption. The final denial-of-service testing program we’ll look at here targets servers that use SSL. SSL should no longer be in use, having been supplanted by  technology that doesn’t have the vulnerabilities that SSL had, but that’s not to say that you won’t run across one. The program <em>thc-ssl-dos</em> targets servers based on the idea that encryption is computationally expensive, especially on the server side.</p>

<p><a data-type="xref" href="#EX_2_8">Example 2-9</a> shows<a data-type="indexterm" data-primary="thc-ssl-dos program" id="id389"></a> a run of <em>thc-ssl-dos</em> against a server that has been configured to use SSL. However, the issues with SSL have been known for so long that the underlying libraries often have SSL disabled. In spite of running against an older installation, you can see that the program was unable to achieve a complete SSL handshake. However, if you were to find a server that did have SSL configured, you would be able to test whether it was vulnerable to a denial of service.</p>
<div id="EX_2_8" data-type="example">
<h5><span class="label">Example 2-9. </span>SSL DoS using thc-ssl-dos utility</h5>

<pre data-type="programlisting" data-code-language="bash">root@rosebud:~#<code class="w"> </code>thc-ssl-dos<code class="w"> </code>-l<code class="w"> </code><code class="m">100</code><code class="w"> </code><code class="m">192</code>.168.86.239<code class="w">  </code><code class="m">443</code><code class="w"> </code>--accept<code class="w"></code>
<code class="w">     </code>______________<code class="w"> </code>___<code class="w">  </code>_________<code class="w"></code>
<code class="w">     </code><code class="se">\_</code>_<code class="w">    </code>___/<code class="w">   </code><code class="p">|</code><code class="w">   </code><code class="se">\ \_</code><code class="w">   </code>___<code class="w"> </code><code class="se">\</code>
<code class="w">       </code><code class="p">|</code><code class="w">    </code><code class="p">|</code><code class="w"> </code>/<code class="w">    </code>~<code class="w">    </code><code class="se">\/</code><code class="w">    </code><code class="se">\ </code><code class="w"> </code><code class="se">\/</code><code class="w"></code>
<code class="w">       </code><code class="p">|</code><code class="w">    </code><code class="p">|</code><code class="w"> </code><code class="se">\ </code><code class="w">   </code>Y<code class="w">    </code>/<code class="se">\ </code><code class="w">    </code><code class="se">\_</code>___<code class="w"></code>
<code class="w">       </code><code class="p">|</code>____<code class="p">|</code><code class="w">  </code><code class="se">\_</code>__<code class="p">|</code>_<code class="w">  </code>/<code class="w">  </code><code class="se">\_</code>_____<code class="w">  </code>/<code class="w"></code>
<code class="w">                     </code><code class="se">\/</code><code class="w">          </code><code class="se">\/</code><code class="w"></code>
<code class="w">            </code>http://www.thc.org<code class="w"></code>

<code class="w">          </code>Twitter<code class="w"> </code>@hackerschoice<code class="w"></code>

Greetingz:<code class="w"> </code>the<code class="w"> </code>french<code class="w"> </code>underground<code class="w"></code>

Waiting<code class="w"> </code><code class="k">for</code><code class="w"> </code>script<code class="w"> </code>kiddies<code class="w"> </code>to<code class="w"> </code>piss<code class="w"> </code>off................<code class="w"></code>
The<code class="w"> </code>force<code class="w"> </code>is<code class="w"> </code>with<code class="w"> </code>those<code class="w"> </code>who<code class="w"> </code><code class="nb">read</code><code class="w"> </code>the<code class="w"> </code>source...<code class="w"></code>
Handshakes<code class="w"> </code><code class="m">0</code><code class="w"> </code><code class="o">[</code><code class="m">0</code>.00<code class="w"> </code>h/s<code class="o">]</code>,<code class="w"> </code><code class="m">1</code><code class="w"> </code>Conn,<code class="w"> </code><code class="m">0</code><code class="w"> </code>Err<code class="w"></code>
SSL:<code class="w"> </code>error:140770FC:SSL<code class="w"> </code>routines:SSL23_GET_SERVER_HELLO:unknown<code class="w"> </code>protocol<code class="w"></code>
<code class="c1">#0: This does not look like SSL!</code></pre></div>

<p>This <em>failure</em> highlights one of the challenges of doing security testing: finding vulnerabilities can be hard. Exploiting<a data-type="indexterm" data-primary="vulnerability analysis" data-secondary="technical versus human vulnerabilities" id="id390"></a> known vulnerabilities can also be hard. This is one reason that modern attacks commonly use social engineering to make use of humans and their tendency toward trust and behaviors that can lead to exploitation—often technical vulnerabilities are harder to exploit than manipulating people. This does not mean that these nonhuman issues are not possible given the number of vulnerabilities discovered and announced on a regular basis. See <a href="http://seclists.org/bugtraq/">Bugtraq</a> and the <a href="http://cve.mitre.org/">Common Vulnerabilities and Exposures project</a> for evidence of this.</p>
</div></section>










<section data-type="sect3" data-pdf-bookmark="DHCP attacks"><div class="sect3" id="id27">
<h3>DHCP attacks</h3>

<p>The<a data-type="indexterm" data-primary="attacks" data-secondary="DHCP attacks" id="id391"></a><a data-type="indexterm" data-primary="denial-of-service testing" data-secondary="DHCP attacks" id="id392"></a><a data-type="indexterm" data-primary="DHCP (Dynamic Host Configuration Protocol)" id="id393"></a> Dynamic Host Configuration Protocol (DHCP) has a test program called <em>DHCPig</em>, which is another consumption attack, designed to exhaust resources available in a DHCP server. This is sometimes called a DHCP starvation attack, since the goal is to make it impossible for other consumers to “eat” from the DHCP server.  Since the DHCP server hands out IP addresses and other IP configuration, it would be a problem for enterprises if their workers weren’t able to obtain addresses. While it’s not uncommon for the DHCP server to hand out addresses with long leases (the period of time a client can use the address without having to renew it) a lot of DHCP servers have short lease times. A short lease time is important when everyone is mobile. As users come on and off the network regularly, sometimes staying for short periods of time, having clients hang onto leases can also consume those resources. What this means, though, is that when clients have short leases, a tool<a data-type="indexterm" data-primary="DHCPig tool" id="id394"></a> like <em>DHCPig</em> can grab expiring leases before the client can get them, leaving the clients out in the cold without an address and unable to do anything on the network. Running <em>DHCPig</em> is as simple as running the<a data-type="indexterm" data-primary="dhcpig" id="id395"></a> Python script <em>dhcpig</em> and specifying the interface that is on the network you want to test against.<a data-type="indexterm" data-primary="" data-startref="NSTdenial02" id="id396"></a><a data-type="indexterm" data-primary="" data-startref="ATdenial02" id="id397"></a></p>

<p>In practical terms, a DHCP starvation attack can be used by an attacker to help get control of network traffic. The attacker launches a DHCP starvation attack, consuming all the available IP addresses. At the same time, the attacker starts up their own DHCP server that maybe points systems to a DNS server controlled by the attacker. Maybe it points the default router to a system controlled by the attacker so all network traffic going off-net will pass through the attacker’s system. In <a data-type="xref" href="#EX_2_9">Example 2-10</a>, you can see the use of <em>dhcpig</em> to consume all the available leases from the local DHCP server.</p>
<div id="EX_2_9" data-type="example">
<h5><span class="label">Example 2-10. </span>Using dhcpig</h5>

<pre data-type="programlisting" data-code-language="bash">┌──<code class="o">(</code>kilroy㉿badmilo<code class="o">)</code>-<code class="o">[</code>~<code class="o">]</code><code class="w"></code>
└─$<code class="w"> </code>sudo<code class="w"> </code>dhcpig<code class="w"> </code>-l<code class="w"> </code>eth0<code class="w"></code>
<code class="o">[</code><code class="w"> </code>--<code class="w"> </code><code class="o">]</code><code class="w"> </code><code class="o">[</code>INFO<code class="o">]</code><code class="w"> </code>-<code class="w"> </code>using<code class="w"> </code>interface<code class="w"> </code>eth0<code class="w"></code>
<code class="o">[</code>DBG<code class="w"> </code><code class="o">]</code><code class="w"> </code>Thread<code class="w"> </code><code class="m">0</code><code class="w"> </code>-<code class="w"> </code><code class="o">(</code>Sniffer<code class="o">)</code><code class="w"> </code>READY<code class="w"></code>
<code class="o">[</code>DBG<code class="w"> </code><code class="o">]</code><code class="w"> </code>Thread<code class="w"> </code><code class="m">1</code><code class="w"> </code>-<code class="w"> </code><code class="o">(</code>Sender<code class="o">)</code><code class="w"> </code>READY<code class="w"></code>
<code class="o">[</code>---&gt;<code class="o">]</code><code class="w"> </code>DHCP_Discover<code class="w"></code>
<code class="o">[</code><code class="w"> </code>??<code class="w"> </code><code class="o">]</code><code class="w">          </code>waiting<code class="w"> </code><code class="k">for</code><code class="w"> </code>first<code class="w"> </code>DHCP<code class="w"> </code>Server<code class="w"> </code>response<code class="w"></code>
<code class="o">[</code><code class="w"> </code>??<code class="w"> </code><code class="o">]</code><code class="w">          </code>waiting<code class="w"> </code><code class="k">for</code><code class="w"> </code>first<code class="w"> </code>DHCP<code class="w"> </code>Server<code class="w"> </code>response<code class="w"></code></pre></div>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Using Scapy to Build Packets"><div class="sect3" id="id65">
<h3>Using Scapy to Build Packets</h3>

<p>If you are looking for complete programmatic access to network packet creation, you can use the tool Scapy. Scapy is a library that provides access to network protocols so you can create a packet to look anyway you would like it to. While you can use Scapy to write Python scripts, you can also use the command line interface with the <em>scapy</em> tool. You can write Python in the <em>scapy</em> tool in real-time, meaning it executes as you are writing it. <a data-type="xref" href="#EX_2_10">Example 2-11</a> shows the use of <em>scapy</em> to build a TCP segment on top of an IP packet since <em>scapy</em> allows you to layer the creation of the messages. Once the packet has been defined, you can send it, but there are several ways to send it. You’ll see three of them in <a data-type="xref" href="#EX_2_10">Example 2-11</a>.</p>
<div id="EX_2_10" data-type="example">
<h5><span class="label">Example 2-11. </span>Using scapy</h5>

<pre data-type="programlisting" data-code-language="bash">&gt;&gt;&gt;<code class="w"> </code><code class="nv">p</code><code class="o">=</code>IP<code class="o">(</code><code class="nv">dst</code><code class="o">=</code><code class="s2">"192.168.1.1"</code>,<code class="w"> </code><code class="nv">ttl</code><code class="o">=</code><code class="m">2</code>,<code class="w"> </code><code class="nv">id</code><code class="o">=</code><code class="m">15</code><code class="o">)</code>/TCP<code class="o">(</code><code class="nv">seq</code><code class="o">=</code>RandInt<code class="o">()</code>,<code class="w"> </code><code class="nv">sport</code><code class="o">=</code>RandShort<code class="o">(</code><code class="w"></code>
...:<code class="w"> </code><code class="o">)</code>,<code class="w"> </code><code class="nv">dport</code><code class="o">=</code>RandShort<code class="o">())</code><code class="w"></code>
&gt;&gt;&gt;<code class="w"> </code>send<code class="o">(</code>p<code class="o">)</code><code class="w"></code>
.<code class="w"></code>
Sent<code class="w"> </code><code class="m">1</code><code class="w"> </code>packets.<code class="w"></code>
&gt;&gt;&gt;<code class="w"> </code>sr<code class="o">(</code>p<code class="o">)</code><code class="w"></code>
Begin<code class="w"> </code>emission:<code class="w"></code>
Finished<code class="w"> </code>sending<code class="w"> </code><code class="m">1</code><code class="w"> </code>packets.<code class="w"></code>
*<code class="w"></code>
Received<code class="w"> </code><code class="m">1</code><code class="w"> </code>packets,<code class="w"> </code>got<code class="w"> </code><code class="m">1</code><code class="w"> </code>answers,<code class="w"> </code>remaining<code class="w"> </code><code class="m">0</code><code class="w"> </code>packets<code class="w"></code>
<code class="o">(</code>&lt;Results:<code class="w"> </code>TCP:1<code class="w"> </code>UDP:0<code class="w"> </code>ICMP:0<code class="w"> </code>Other:0&gt;,<code class="w"></code>
<code class="w"> </code>&lt;Unanswered:<code class="w"> </code>TCP:0<code class="w"> </code>UDP:0<code class="w"> </code>ICMP:0<code class="w"> </code>Other:0&gt;<code class="o">)</code><code class="w"></code>
&gt;&gt;&gt;<code class="w"> </code>sr1<code class="o">(</code>p<code class="o">)</code><code class="w"></code>
Begin<code class="w"> </code>emission:<code class="w"></code>
Finished<code class="w"> </code>sending<code class="w"> </code><code class="m">1</code><code class="w"> </code>packets.<code class="w"></code>
*<code class="w"></code>
Received<code class="w"> </code><code class="m">1</code><code class="w"> </code>packets,<code class="w"> </code>got<code class="w"> </code><code class="m">1</code><code class="w"> </code>answers,<code class="w"> </code>remaining<code class="w"> </code><code class="m">0</code><code class="w"> </code>packets<code class="w"></code>
&lt;IP<code class="w">  </code><code class="nv">version</code><code class="o">=</code><code class="m">4</code><code class="w"> </code><code class="nv">ihl</code><code class="o">=</code><code class="m">5</code><code class="w"> </code><code class="nv">tos</code><code class="o">=</code>0x0<code class="w"> </code><code class="nv">len</code><code class="o">=</code><code class="m">40</code><code class="w"> </code><code class="nv">id</code><code class="o">=</code><code class="m">40192</code><code class="w"> </code><code class="nv">flags</code><code class="o">=</code><code class="w"> </code><code class="nv">frag</code><code class="o">=</code><code class="m">0</code><code class="w"> </code><code class="nv">ttl</code><code class="o">=</code><code class="m">128</code><code class="w"> </code><code class="nv">proto</code><code class="o">=</code>tcp<code class="w"> </code><code class="nv">chksum</code><code class="o">=</code>0xcbf3<code class="w"> </code><code class="nv">src</code><code class="o">=</code><code class="m">192</code>.168.1.1<code class="w"> </code><code class="nv">dst</code><code class="o">=</code><code class="m">192</code>.168.79.138<code class="w"> </code><code class="p">|</code>&lt;TCP<code class="w">  </code><code class="nv">sport</code><code class="o">=</code><code class="m">849</code><code class="w"> </code><code class="nv">dport</code><code class="o">=</code><code class="m">26901</code><code class="w"> </code><code class="nv">seq</code><code class="o">=</code><code class="m">2570441854</code><code class="w"> </code><code class="nv">ack</code><code class="o">=</code><code class="m">913161814</code><code class="w"> </code><code class="nv">dataofs</code><code class="o">=</code><code class="m">5</code><code class="w"> </code><code class="nv">reserved</code><code class="o">=</code><code class="m">0</code><code class="w"> </code><code class="nv">flags</code><code class="o">=</code>RA<code class="w"> </code><code class="nv">window</code><code class="o">=</code><code class="m">64240</code><code class="w"> </code><code class="nv">chksum</code><code class="o">=</code>0x1425<code class="w"> </code><code class="nv">urgptr</code><code class="o">=</code><code class="m">0</code><code class="w"> </code><code class="p">|</code>&lt;Padding<code class="w">  </code><code class="nv">load</code><code class="o">=</code><code class="s1">'\x00\x00\x00\x00\x00\x00'</code><code class="w"> </code><code class="p">|</code>&gt;&gt;&gt;<code class="w"></code></pre></div>

<p>Because we are using a programmatic interface, we are not restricted to just using numeric values for different fields. Instead, we can generate random values. This example uses random values on the TCP source and destination ports, which is probably not a valuable packet to create and send, but it demonstrates the use of generating random values. We have the ability to generate full integers or we can generate short integers, which would be required if we had a field size of 16 bits, such as that for the port value. As indicated, we have control over all the fields in the protocols. This doesn’t show the Ethernet layer, but we could add that in if we wanted to. You could, for instance, set the media access control (MAC) address to the system you want to set it to but change the IP address to see how the system handles it.</p>

<p>When it comes to sending and receiving, we can just send it, as you can see in the first send example. You can also use sr(), which is send and receive, but you don’t get the details from the response. Finally, shown is sr1(), which is the function used if you want to see the full packet details from the received message after the send. This assumes that you will actually get a response, depending on what sort of packet you have created. With send(), you can also add a loop parameter to tell <em>scapy</em> you want the packet to be sent until you type a Ctrl-C character to stop it. For our packet, p, you can send it with a loop with <em>send(p, loop=1)</em>.</p>

<p>Because we have full control over the packet and its parameters, we can also manipulate both the source and destination IP address, as shown in <a data-type="xref" href="#EX_2_11">Example 2-12</a>, where we recreate the LAND attack referenced earlier. In this case, we don’t get a response, as you can see. That’s because the source IP address is not our address and the network stack on the receiving system is sending it back to the system that has that IP address.</p>
<div id="EX_2_11" data-type="example">
<h5><span class="label">Example 2-12. </span>Using scapy for LAND attack</h5>

<pre data-type="programlisting" data-code-language="bash">&gt;&gt;&gt;<code class="w"> </code><code class="nv">p</code><code class="o">=</code>IP<code class="o">(</code><code class="nv">dst</code><code class="o">=</code><code class="s2">"192.168.1.1"</code>,<code class="w"> </code><code class="nv">src</code><code class="o">=</code><code class="s2">"192.168.1.1"</code><code class="o">)</code>/TCP<code class="o">(</code><code class="nv">dport</code><code class="o">=</code><code class="m">80</code><code class="o">)</code><code class="w"></code>
&gt;&gt;&gt;<code class="w"> </code>sr1<code class="o">(</code>p<code class="o">)</code><code class="w"></code>
Begin<code class="w"> </code>emission:<code class="w"></code>
Finished<code class="w"> </code>sending<code class="w"> </code><code class="m">1</code><code class="w"> </code>packets.<code class="w"></code>
....................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................^C<code class="w"></code>
Received<code class="w"> </code><code class="m">548</code><code class="w"> </code>packets,<code class="w"> </code>got<code class="w"> </code><code class="m">0</code><code class="w"> </code>answers,<code class="w"> </code>remaining<code class="w"> </code><code class="m">1</code><code class="w"> </code>packets<code class="w"></code></pre></div>

<p>You can, of course, also use <em>scapy</em> to send legitimate messages and it handles a lot of different protocols. Because a common protocol is HTTP, we can use <em>scapy</em> to create a web request and send it. There are two approaches shown in <a data-type="xref" href="#EX_2_12">Example 2-13</a>. The first is to use a socket directly with the HTTP text to be sent. It gets added to the packet creation syntax you’ve seen before. In other words, the text just gets added as payload. The second approach is to load the <em>http</em> layer so we can use HTTP methods. We’ll create a request using <em>HTTP()/HTTPRequest()</em>, which creates all the necessary data we need. We haven’t added any parameters to HTTPRequest, though we could use Method, which defaults to GET, as well as Path, to specify which resource we want to retrieve from the server.</p>
<div id="EX_2_12" data-type="example">
<h5><span class="label">Example 2-13. </span>Using scapy for HTTP messages</h5>

<pre data-type="programlisting" data-code-language="bash">&gt;&gt;&gt;<code class="w"> </code><code class="nv">p</code><code class="w"> </code><code class="o">=</code><code class="w"> </code>IP<code class="o">(</code><code class="nv">dst</code><code class="o">=</code><code class="s2">"192.168.1.15"</code><code class="o">)</code>/TCP<code class="o">()</code>/<code class="s2">"GET / HTTP/1.1\rHost:192.168.1.15\r\n"</code><code class="w"></code>
&gt;&gt;&gt;<code class="w"> </code><code class="nv">reply</code><code class="w"> </code><code class="o">=</code><code class="w"> </code>sr1<code class="o">(</code>p<code class="o">)</code><code class="w"></code>
Begin<code class="w"> </code>emission:<code class="w"></code>
Finished<code class="w"> </code>sending<code class="w"> </code><code class="m">1</code><code class="w"> </code>packets.<code class="w"></code>
*<code class="w"></code>
Received<code class="w"> </code><code class="m">1</code><code class="w"> </code>packets,<code class="w"> </code>got<code class="w"> </code><code class="m">1</code><code class="w"> </code>answers,<code class="w"> </code>remaining<code class="w"> </code><code class="m">0</code><code class="w"> </code>packets<code class="w"></code>
&gt;&gt;&gt;<code class="w"> </code>print<code class="o">(</code>reply<code class="o">)</code><code class="w"></code>
IP<code class="w"> </code>/<code class="w"> </code>TCP<code class="w"> </code><code class="m">192</code>.168.1.15:http<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.79.138:ftp_data<code class="w"> </code>SA<code class="w"> </code>/<code class="w"> </code>Padding<code class="w"></code>
&gt;&gt;&gt;<code class="w"> </code>load_layer<code class="o">(</code><code class="s2">"http"</code><code class="o">)</code><code class="w"></code>
&gt;&gt;&gt;<code class="w"> </code><code class="nv">request</code><code class="w"> </code><code class="o">=</code><code class="w"> </code>HTTP<code class="o">()</code>/HTTPRequest<code class="o">()</code><code class="w"></code>
&gt;&gt;&gt;<code class="w"> </code><code class="nv">socket</code><code class="w"> </code><code class="o">=</code><code class="w"> </code>TCP_client.tcplink<code class="o">(</code>HTTP,<code class="w"> </code><code class="s2">"192.168.1.15"</code>,<code class="w"> </code><code class="m">80</code><code class="o">)</code><code class="w"></code>
&gt;&gt;&gt;<code class="w"> </code><code class="nv">answer</code><code class="w"> </code><code class="o">=</code><code class="w"> </code>socket.sr1<code class="o">(</code>request<code class="o">)</code><code class="w"></code>
Begin<code class="w"> </code>emission:<code class="w"></code>
Finished<code class="w"> </code>sending<code class="w"> </code><code class="m">1</code><code class="w"> </code>packets.<code class="w"></code></pre></div>

<p>This barely scrapes the surface of what is possible with <em>scapy</em>. As said already, this provides us easy ways to programmatically script network messages, getting full control over the different elements of the protocols. You could easily send broken messages using <em>scapy</em>. For example, you don’t have to use a standard request known by HTTP servers. You can create your own request verb, just to see how the server responds to it. When it comes to binary-based protocols like IP or TCP, where it’s clearly blocked out byte sequences, you are going to be limited in what you can send. You wouldn’t be able to send <em>AAAAAAAAAAA</em> in the destination address. First, the destination address for IPv4 is only 4 bytes. We are trying to send 11 bytes, which will fill up the destination address with 41414141. This translates to 65.65.65.65. We don’t get a lot out of that. Each byte is only going to support values of 0-255, so you need to get a little creative if you want to play with these binary-based protocols.</p>
</div></section>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Encryption Testing"><div class="sect1" id="id28">
<h1>Encryption Testing</h1>

<p>We’ve<a data-type="indexterm" data-primary="encryption testing" data-secondary="encryption basics" id="id398"></a><a data-type="indexterm" data-primary="network security testing" data-secondary="encryption testing" id="NSTencrypt02"></a> had the ability to encrypt traffic over internet connections for over 20 years now. Encryption, like so much else that’s information security related, is a moving target. When the first version of SSL was released by Netscape in 1995, one version had already been discarded because of identified problems with it. The second version didn’t last long before identified problems with it forced a third version, released the following year in 1996. Both SSLv2 and SSLv3 were both determined to be prohibited as a result of the problems with the way they handle encryption.</p>

<p>Network traffic that is encrypted follows a process that is not as simple as just taking a message, encrypting it, and sending it along, though that’s a part of the overall process. Encryption relies on keys. The<a data-type="indexterm" data-primary="keys" id="id399"></a> most sensitive part of any encryption process is always the key. A message that is encrypted is valuable only if it can be decrypted, of course. If I were to send you an encrypted message, you would need the key to be able to decrypt it. This is where the challenge starts to come in.</p>

<p>There<a data-type="indexterm" data-primary="encryption testing" data-secondary="key handling" id="id400"></a><a data-type="indexterm" data-primary="encryption testing" data-secondary="encryption types" id="id401"></a><a data-type="indexterm" data-primary="asymmetric encryption" id="id402"></a><a data-type="indexterm" data-primary="public key encryption" id="id403"></a> are two means of handling keys. The first is <em>asymmetric encryption</em>. This is where there are two keys, one for encryption and one for decryption. You may also hear this referred to as <em>public key encryption</em>. The idea is that everyone has two keys—​a public key and a private key. The public key is something everyone can have. In fact, it works only if everyone has the ability to access everyone else’s public key. Encrypting a message using a public key means that the message can be decrypted only by using the private key. The two keys are mathematically related and based on calculations using large numbers. This all seems like a reasonable approach, right? The problem with asymmetric encryption is that it is computationally hard.</p>

<p>This<a data-type="indexterm" data-primary="symmetric encryption" id="id404"></a> leads us to <em>symmetric encryption</em>. With symmetric encryption, as you may have guessed, we have a single key. The same key encrypts and decrypts. Symmetric key encryption is computationally easier. However, symmetric key encryption has two problems. The first is that the longer a symmetric key is used, the more vulnerable to attack it is. This is because an attacker can gather a large volume of ciphertext (the result of feeding plain text into an encryption algorithm) and start performing analysis on it in the hopes of deriving the key. Once the key has been identified, any traffic encrypted with that key can be easily decrypted.</p>

<p>The second and more important problem is that after we have a key, how do we both get it? This works, after all, only if both of us have the key. So, how do we both have the key if we are not physically proximate? And if we are physically proximate, do we need to encrypt messages between us? We could have met at some point and shared the key, but that means that we are stuck using the key until we meet again and can create a new key so we both have it. The longer we use the same key without meeting again brings us to problem #1 noted previously.</p>

<p>As<a data-type="indexterm" data-primary="encryption testing" data-secondary="Diffie-Hellman key" id="id405"></a><a data-type="indexterm" data-primary="Diffie-Hellman key" id="id406"></a> it turns out, two mathematicians solved this problem, though they were not the first. They were just the first who could publish their work. Those whose work came first worked for government agencies who were not allowed to share the work they were doing with anyone. Whitfield Diffie and Martin Hellman came up with the idea of having both sides independently derive the key. Essentially, we both start with a value that is shared. This can be safely shared unencrypted because it’s what happens to it after that matters. We both take this initial value and apply a secret value using a mathematical formula that we both know. Again, it doesn’t matter whether this is public because it’s the secret value that matters. We share each other’s result from our individual computations and then reapply our secret values to the other’s result. In this way, we will have both gone through the same mathematical process from a single starting point, so we will both have the same key in the end.</p>

<p>The reason for going through all of this is that in practice, all of these mechanisms are used. The Diffie-Hellman key exchanged is used along with public-key cryptography to derive a session key, which is a symmetric key. This means that the session uses a less computationally intensive key and algorithm to do the heavy lifting of encrypting and decrypting the bulk of the communication between the server and the client.</p>

<p>As noted earlier, SSL is no longer used as the cryptographic protocol. Instead, TLS is the current protocol used. It has been through a few versions itself, again demonstrating the challenges of encryption. The current version is 1.2, while 1.3 is in draft stage at the moment. Each version introduces fixes and updates based on continuing research in breaking the protocol.</p>

<p>One<a data-type="indexterm" data-primary="sslscan tool" id="sslscan02"></a><a data-type="indexterm" data-primary="encryption testing" data-secondary="sslscan tool" id="ETsslscan02"></a><a data-type="indexterm" data-primary="web servers" data-secondary="testing for outdated protocols" id="id407"></a> way to determine whether a server you are testing is using outdated protocols is to use a tool like <em>sslscan</em>. This program probes the server to identify what encryption algorithms are in use. This is easy to determine, because as part of the handshake with the server, it will provide a list of ciphers that are supported for the client to select from. So, all <em>sslscan</em> needs to do is initiate an encrypted session with the server to get all the information needed. <a data-type="xref" href="#EX_2_13">Example 2-14</a> shows the results of testing an Apache server with encryption configured.</p>
<div id="EX_2_13" data-type="example">
<h5><span class="label">Example 2-14. </span>Running sslscan against local system</h5>

<pre data-type="programlisting" data-code-language="bash">┌──<code class="o">(</code>kilroy㉿badmilo<code class="o">)</code>-<code class="o">[</code>~<code class="o">]</code><code class="w"></code>
└─$<code class="w"> </code>sslscan<code class="w"> </code><code class="m">192</code>.168.1.15<code class="w"></code>
Version:<code class="w"> </code><code class="m">2</code>.0.16-static<code class="w"></code>
OpenSSL<code class="w"> </code><code class="m">1</code>.1.1u-dev<code class="w">  </code>xx<code class="w"> </code>XXX<code class="w"> </code>xxxx<code class="w"></code>

Connected<code class="w"> </code>to<code class="w"> </code><code class="m">192</code>.168.1.15<code class="w"></code>

Testing<code class="w"> </code>SSL<code class="w"> </code>server<code class="w"> </code><code class="m">192</code>.168.1.15<code class="w"> </code>on<code class="w"> </code>port<code class="w"> </code><code class="m">443</code><code class="w"> </code>using<code class="w"> </code>SNI<code class="w"> </code>name<code class="w"> </code><code class="m">192</code>.168.1.15<code class="w"></code>

<code class="w">  </code>SSL/TLS<code class="w"> </code>Protocols:<code class="w"></code>
SSLv2<code class="w">     </code>disabled<code class="w"></code>
SSLv3<code class="w">     </code>disabled<code class="w"></code>
TLSv1.0<code class="w">   </code>disabled<code class="w"></code>
TLSv1.1<code class="w">   </code>disabled<code class="w"></code>
TLSv1.2<code class="w">   </code>enabled<code class="w"></code>
TLSv1.3<code class="w">   </code>enabled<code class="w"></code>

<code class="w">  </code>TLS<code class="w"> </code>Fallback<code class="w"> </code>SCSV:<code class="w"></code>
Server<code class="w"> </code>supports<code class="w"> </code>TLS<code class="w"> </code>Fallback<code class="w"> </code>SCSV<code class="w"></code>

<code class="w">  </code>TLS<code class="w"> </code>renegotiation:<code class="w"></code>
Session<code class="w"> </code>renegotiation<code class="w"> </code>not<code class="w"> </code>supported<code class="w"></code>

<code class="w">  </code>TLS<code class="w"> </code>Compression:<code class="w"></code>
Compression<code class="w"> </code>disabled<code class="w"></code>

<code class="w">  </code>Heartbleed:<code class="w"></code>
TLSv1.3<code class="w"> </code>not<code class="w"> </code>vulnerable<code class="w"> </code>to<code class="w"> </code>heartbleed<code class="w"></code>
TLSv1.2<code class="w"> </code>not<code class="w"> </code>vulnerable<code class="w"> </code>to<code class="w"> </code>heartbleed<code class="w"></code>

<code class="w">  </code>Supported<code class="w"> </code>Server<code class="w"> </code>Cipher<code class="o">(</code>s<code class="o">)</code>:<code class="w"></code>
Preferred<code class="w"> </code>TLSv1.3<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>TLS_AES_256_GCM_SHA384<code class="w">        </code>Curve<code class="w"> </code><code class="m">25519</code><code class="w"> </code>DHE<code class="w"> </code><code class="m">253</code><code class="w"></code>
Accepted<code class="w">  </code>TLSv1.3<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>TLS_CHACHA20_POLY1305_SHA256<code class="w">  </code>Curve<code class="w"> </code><code class="m">25519</code><code class="w"> </code>DHE<code class="w"> </code><code class="m">253</code><code class="w"></code>
Accepted<code class="w">  </code>TLSv1.3<code class="w">  </code><code class="m">128</code><code class="w"> </code>bits<code class="w">  </code>TLS_AES_128_GCM_SHA256<code class="w">        </code>Curve<code class="w"> </code><code class="m">25519</code><code class="w"> </code>DHE<code class="w"> </code><code class="m">253</code><code class="w"></code>
Preferred<code class="w"> </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>ECDHE-RSA-AES256-GCM-SHA384<code class="w">   </code>Curve<code class="w"> </code><code class="m">25519</code><code class="w"> </code>DHE<code class="w"> </code><code class="m">253</code><code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>DHE-RSA-AES256-GCM-SHA384<code class="w">     </code>DHE<code class="w"> </code><code class="m">2048</code><code class="w"> </code>bits<code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>ECDHE-RSA-CHACHA20-POLY1305<code class="w">   </code>Curve<code class="w"> </code><code class="m">25519</code><code class="w"> </code>DHE<code class="w"> </code><code class="m">253</code><code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>DHE-RSA-CHACHA20-POLY1305<code class="w">     </code>DHE<code class="w"> </code><code class="m">2048</code><code class="w"> </code>bits<code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>DHE-RSA-AES256-CCM8<code class="w">           </code>DHE<code class="w"> </code><code class="m">2048</code><code class="w"> </code>bits<code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>DHE-RSA-AES256-CCM<code class="w">            </code>DHE<code class="w"> </code><code class="m">2048</code><code class="w"> </code>bits<code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>ECDHE-ARIA256-GCM-SHA384<code class="w">      </code>Curve<code class="w"> </code><code class="m">25519</code><code class="w"> </code>DHE<code class="w"> </code><code class="m">253</code><code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>DHE-RSA-ARIA256-GCM-SHA384<code class="w">    </code>DHE<code class="w"> </code><code class="m">2048</code><code class="w"> </code>bits<code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">128</code><code class="w"> </code>bits<code class="w">  </code>ECDHE-RSA-AES128-GCM-SHA256<code class="w">   </code>Curve<code class="w"> </code><code class="m">25519</code><code class="w"> </code>DHE<code class="w"> </code><code class="m">253</code><code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">128</code><code class="w"> </code>bits<code class="w">  </code>DHE-RSA-AES128-SHA<code class="w">            </code>DHE<code class="w"> </code><code class="m">2048</code><code class="w"> </code>bits<code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">128</code><code class="w"> </code>bits<code class="w">  </code>DHE-RSA-CAMELLIA128-SHA<code class="w">       </code>DHE<code class="w"> </code><code class="m">2048</code><code class="w"> </code>bits<code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>AES256-GCM-SHA384<code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>AES256-CCM8<code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>AES256-CCM<code class="w"></code>
Accepted<code class="w">  </code>TLSv1.2<code class="w">  </code><code class="m">256</code><code class="w"> </code>bits<code class="w">  </code>ARIA256-GCM-SHA384<code class="w"></code>

<code class="w">  </code>Server<code class="w"> </code>Key<code class="w"> </code>Exchange<code class="w"> </code>Group<code class="o">(</code>s<code class="o">)</code>:<code class="w"></code>
TLSv1.3<code class="w">  </code><code class="m">128</code><code class="w"> </code>bits<code class="w">  </code>secp256r1<code class="w"> </code><code class="o">(</code>NIST<code class="w"> </code>P-256<code class="o">)</code><code class="w"></code>
TLSv1.3<code class="w">  </code><code class="m">192</code><code class="w"> </code>bits<code class="w">  </code>secp384r1<code class="w"> </code><code class="o">(</code>NIST<code class="w"> </code>P-384<code class="o">)</code><code class="w"></code>
TLSv1.3<code class="w">  </code><code class="m">260</code><code class="w"> </code>bits<code class="w">  </code>secp521r1<code class="w"> </code><code class="o">(</code>NIST<code class="w"> </code>P-521<code class="o">)</code><code class="w"></code>
TLSv1.3<code class="w">  </code><code class="m">128</code><code class="w"> </code>bits<code class="w">  </code>x25519<code class="w"></code>
TLSv1.3<code class="w">  </code><code class="m">224</code><code class="w"> </code>bits<code class="w">  </code>x448<code class="w"></code>
TLSv1.3<code class="w">  </code><code class="m">112</code><code class="w"> </code>bits<code class="w">  </code>ffdhe2048<code class="w"></code>
TLSv1.3<code class="w">  </code><code class="m">128</code><code class="w"> </code>bits<code class="w">  </code>ffdhe3072<code class="w"></code>
TLSv1.3<code class="w">  </code><code class="m">150</code><code class="w"> </code>bits<code class="w">  </code>ffdhe4096<code class="w"></code>
TLSv1.3<code class="w">  </code><code class="m">175</code><code class="w"> </code>bits<code class="w">  </code>ffdhe6144<code class="w"></code>
TLSv1.3<code class="w">  </code><code class="m">192</code><code class="w"> </code>bits<code class="w">  </code>ffdhe8192<code class="w"></code>
TLSv1.2<code class="w">  </code><code class="m">128</code><code class="w"> </code>bits<code class="w">  </code>secp256r1<code class="w"> </code><code class="o">(</code>NIST<code class="w"> </code>P-256<code class="o">)</code><code class="w"></code>
TLSv1.2<code class="w">  </code><code class="m">192</code><code class="w"> </code>bits<code class="w">  </code>secp384r1<code class="w"> </code><code class="o">(</code>NIST<code class="w"> </code>P-384<code class="o">)</code><code class="w"></code>
TLSv1.2<code class="w">  </code><code class="m">260</code><code class="w"> </code>bits<code class="w">  </code>secp521r1<code class="w"> </code><code class="o">(</code>NIST<code class="w"> </code>P-521<code class="o">)</code><code class="w"></code>
TLSv1.2<code class="w">  </code><code class="m">128</code><code class="w"> </code>bits<code class="w">  </code>x25519<code class="w"></code>
TLSv1.2<code class="w">  </code><code class="m">224</code><code class="w"> </code>bits<code class="w">  </code>x448<code class="w"></code>

<code class="w">  </code>SSL<code class="w"> </code>Certificate:<code class="w"></code>
Signature<code class="w"> </code>Algorithm:<code class="w"> </code>sha256WithRSAEncryption<code class="w"></code>
RSA<code class="w"> </code>Key<code class="w"> </code>Strength:<code class="w">    </code><code class="m">2048</code><code class="w"></code>

Subject:<code class="w">  </code>portnoy.washere.com<code class="w"></code>
Issuer:<code class="w">   </code>portnoy.washere.com<code class="w"></code>

Not<code class="w"> </code>valid<code class="w"> </code>before:<code class="w"> </code>Jun<code class="w"> </code><code class="m">17</code><code class="w"> </code><code class="m">21</code>:32:45<code class="w"> </code><code class="m">2023</code><code class="w"> </code>GMT<code class="w"></code>
Not<code class="w"> </code>valid<code class="w"> </code>after:<code class="w">  </code>Jun<code class="w"> </code><code class="m">16</code><code class="w"> </code><code class="m">21</code>:32:45<code class="w"> </code><code class="m">2024</code><code class="w"> </code>GMT<code class="w"></code></pre></div>

<p><em>sslscan</em> will determine whether the server is vulnerable<a data-type="indexterm" data-primary="encryption testing" data-secondary="Heartbleed" id="id408"></a><a data-type="indexterm" data-primary="Heartbleed" id="id409"></a> to Heartbleed, a vulnerability that was identified and that targeted server/client encryption, leading to the exposure of keys to malicious users. Most important, though, <em>sslscan</em> will give us the list of ciphers supported. In the list, labeled “Supported Server Cipher(s)”, which has been edited for length, you will see multiple columns with information that may not mean a lot to you. The first column is easily readable. It indicates whether the protocol and cipher suite are accepted and whether they are preferred. The first preferred cipher suite is for TLS version 1.3 with a 256-bit AES key. You will note that each of the versions of TLS has its own preferred cipher suite. There are only two versions of TLS which are in use, so there are only two preferred ciphers. The second column is the protocol and version. SSL is not enabled on this server at all, as a result of support for SSL having been removed from the underlying libraries. The next column is the key strength.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Key sizes can’t be compared except within the same algorithm. Rivest-Shamir-Adleman<a data-type="indexterm" data-primary="RSA (Rivest-Shamir-Adleman) algorithm" id="id410"></a> (RSA) is an asymmetric encryption algorithm and has key sizes that are multiples of 1,024. AES is a symmetric encryption algorithm and has key sizes of 128 and 256. That doesn’t mean that RSA is orders of magnitude stronger than AES, because they use the key in different ways. Even comparing algorithms that are the same type (asymmetric versus symmetric) is misleading because the algorithms will use the keys in entirely different ways.</p>
</div>

<p>The<a data-type="indexterm" data-primary="cipher suites" id="id411"></a><a data-type="indexterm" data-primary="encryption testing" data-secondary="cipher suite of algorithms" id="id412"></a> next column is the cipher suite. You will note that it’s called a <em>cipher suite</em> because it takes into account multiple algorithms that have different purposes. Let’s take this listing as an example: DHE-RSA-AES256-GCM-SHA384. The first part, DHE, indicates that we are using<a data-type="indexterm" data-primary="Diffie-Hellman key" id="id413"></a> Ephemeral Diffie-Hellman for key exchange. The second part is RSA, which stands<a data-type="indexterm" data-primary="RSA (Rivest-Shamir-Adleman) algorithm" id="id414"></a> for Rivest-Shamir-Adleman, the three men who developed the algorithm. RSA is an asymmetric-key algorithm. This is used to authenticate the parties, since the keys are stored in certificates that also include identification information about the server. If the client also has a certificate, there can be mutual authentication. Otherwise, the client can authenticate the server based on the hostname the client intended to go to and the hostname that is listed in the certificate. Asymmetric encryption is also used to encrypt keys that are being sent between the client and the server.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>I am using the words <em>client</em> and <em>server</em> a lot through this discussion, and it’s useful for you to understand what these words mean. In any conversation over a network, there is always a client and a server. This does not mean that the server is an actual server sitting in a data center. What it means is that there is a service that is being consumed. The client is always the side originating the conversation, and the server is always the one responding. That makes it easy to “see” the two parties—​who originated and who responded to the origination.</p>
</div>

<p>The next part is the symmetric encryption algorithm. This<a data-type="indexterm" data-primary="AES (Advanced Encryption Standard)" id="id415"></a> suggests that the Advanced Encryption Standard (AES) is being offered with a key size of 256 bits. It’s worth noting here that AES is not an algorithm itself but a standard. The algorithm has its own name. For decades, the standard in use was the Data Encryption Standard, based on the Lucifer cipher<a data-type="indexterm" data-primary="Lucifer cipher" id="id416"></a> developed at IBM by<a data-type="indexterm" data-primary="Feistel, Horst" id="id417"></a> Horst Feistel and his colleagues. In the 1990s it was determined that DES was a bit long in the tooth and would soon be breakable. A search for a new algorithm was undertaken, resulting in the algorithm Rijndael being selected as the foundation for the Advanced Encryption Standard. Initially, AES used a key size of 128 bits. It’s only been relatively recently that the key strength is commonly increased to 256.</p>

<p>AES is the algorithm used for encrypting the session. This means a 256-bit key is used for the session key. It is the key that was derived and shared at the beginning of the session. If the session were to last long enough, the session key may be regenerated to protect against key derivation attacks. As noted before, the key is used by both sides of the conversation for encryption and decryption.</p>

<p>The GCM part is Galois/Counter Mode, which is a way block ciphers operate to provide data integrity and confidentiality. Encrypted data is associated with a tag that is generated at the time the data is encrypted. This tag is used to verify that neither the data nor the tag have been tampered with at all.</p>

<p>Finally, you’ll notice the<a data-type="indexterm" data-primary="SHA (Secure Hash Algorithm)" id="id418"></a> algorithm SHA384. This is the Secure Hash Algorithm using 384 bits for the length of the hash value. SHA is a cryptographic algorithm that is used to verify that no data has changed. You may be familiar with<a data-type="indexterm" data-primary="MD5 (Message Digest 5) algorithm" id="id419"></a> the Message Digest 5 (MD5) algorithm that does the same thing. The difference is the length of the output. With MD5, the length of the output is always 32 characters, which is 128 bits (only 4 bits out of every byte are used). This has been generally replaced with SHA1 or higher. SHA1 generates 40 characters, or 160 bits (again, only 4 bits out of every byte are used). In our case, we are using SHA384, which generates 96 hexadecimal characters, since it would be 48 bytes with each byte being represented by two hexadecimal characters. No matter the length of the data, the output length is always the same. This value is sent from one side to the other as a way of determining whether the data has changed. If even a single bit is different, the value of the hash—​the word used for the output of the SHA or MD5 algorithm—​will be different.</p>

<p>All of these algorithms work together to make up the protocol<a data-type="indexterm" data-primary="TLS (Transport Layer Security)" id="id420"></a><a data-type="indexterm" data-primary="SSL (Secure Sockets Layer)" id="id421"></a> of TLS (and previously SSL). To accomplish effective encryption that is protected against compromise, all of these algorithms are necessary. We need to be able to derive a session key. We need to be able to authenticate the parties and share information using encryption before we have generated our session key. We need to have a session key and an algorithm to encrypt and then decrypt our session data. Finally, we need to make sure that nothing has been tampered with. What you see in the example is a collection of strong encryption suites.</p>

<p>If you were to see something like 3DES in the output, you would have an example of a server that was susceptible to attacks against the session key. This could result in the key being compromised, which would result in the ciphertext being decrypted into plain text in the hands of someone for whom it was not meant. Additionally, though it was breezed over earlier, a tool like <em>sslscan</em> can verify that the protocols used are not vulnerable to attack using known exploits.</p>

<p>You may on rare occasions see NULL in the place where we have seen AES384. This means that the request is that no encryption is used. There are reasons for this. You may not care so much about protecting the contents of the transmissions, but you may care very much that you know who you are talking to and that the data hasn’t been modified in transit. So, you ask for no encryption so as not to incur any overhead from the encryption, but you get the benefit of the other parts of the cipher suite selected.</p>

<p>The war over encryption never ends. Even now research is being done to identify vulnerabilities that can be exploited in the encryption algorithms and protocols in use. You will see differences in the suites listed in your testing output over time as stronger keys begin to be used and new algorithms are developed.<a data-type="indexterm" data-primary="" data-startref="NSTencrypt02" id="id422"></a><a data-type="indexterm" data-primary="" data-startref="sslscan02" id="id423"></a><a data-type="indexterm" data-primary="" data-startref="ETsslscan02" id="id424"></a></p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Packet Captures"><div class="sect1" id="id29">
<h1>Packet Captures</h1>

<p>As<a data-type="indexterm" data-primary="network security testing" data-secondary="packet captures" id="NSTpacket02"></a><a data-type="indexterm" data-primary="packet captures" data-secondary="purpose of" id="id425"></a> you are performing network testing, you will find it useful to be able to see what is being transmitted over the network. To see what is sent, we need to use a program that captures packets. In fairness, though, what we are doing is capturing frames. The reason I say that is each layer of the network stack has a different term for the bundle of data that includes that layer. Keep in mind that headers are tacked on as we move down the network stack, so the last set of headers added is the layer 2 headers. The<a data-type="indexterm" data-primary="PDU (protocol data unit)" id="id426"></a> protocol data unit (PDU) at that layer is the frame. When we get up to layer 3, we are talking about a packet. Layer 4 has datagrams or segments, depending on the protocol used there.</p>

<p>Years ago, capturing packets was an expensive proposition, because it required a special network interface that could be put into promiscuous mode. The reason it’s called that is because by default, network interfaces look at the MAC address. The network interface knows its own address because it is attached to the hardware. If the address of an inbound frame matches the MAC address, the frame is forwarded up to the operating system. Similarly, if the MAC address is the broadcast address, the frame is forwarded up. In promiscuous mode, all comers are welcome. This means that all frames, whether they are addressed for this particular system or not, are forwarded up to the operating system. Being able to look at only frames addressed to that interface is nice and valuable, but it’s far more valuable to be able to see all frames that come across a network interface.</p>

<p>Modern network interfaces typically support not only things like full duplex and auto-negotiation but also promiscuous mode. This<a data-type="indexterm" data-primary="protocol analyzers" id="id427"></a> means we don’t need protocol analyzers anymore (as the hardware that could do this work was often called) because every system is capable of being a protocol analyzer. All we need is to know how to grab the frames and then peer into them to see what is going on.</p>








<section data-type="sect2" data-pdf-bookmark="Using tcpdump"><div class="sect2" id="id30">
<h2>Using tcpdump</h2>

<p>While<a data-type="indexterm" data-primary="packet captures" data-secondary="tcpdump" id="PCtcpdump02"></a><a data-type="indexterm" data-primary="tcpdump" id="tcpdump02"></a> other operating systems have had other packet capture programs, like Solaris had <em>snoop</em>, the de facto packet capture program these days, especially on Linux systems, is <em>tcpdump</em> if all you have is access to a command line. We will take a look at a GUI a little later, but there is a lot of value in learning about <em>tcpdump</em>. You won’t always have access to a full desktop with a GUI. In many cases, you will have only a console or just an SSH session that you can use to run command-line programs. As a result, <em>tcpdump</em> will become a good friend. As an example, I used it earlier to verify that the protocol being used by our SIP testing program was really just using UDP and not using TCP. It has a lot of value in understanding what is going on with a program that isn’t otherwise telling you.</p>

<p>Before we start looking at options, let’s take a look at the output from <em>tcpdump</em>. Being able to read what is happening by looking at the output takes some getting used to. When we run <em>tcpdump</em> without any options, we get a short summary of the packets that are passing through. <a data-type="xref" href="#EX_2_14">Example 2-15</a> is a sample of <em>tcpdump</em> output.</p>
<div id="EX_2_14" data-type="example">
<h5><span class="label">Example 2-15. </span>tcpdump output</h5>

<pre data-type="programlisting" data-code-language="bash"><code class="m">10</code>:26:26.543550<code class="w"> </code>IP<code class="w"> </code>binkley.lan.57137<code class="w"> </code>&gt;<code class="w"> </code>testwifi.here.domain:<code class="w"> </code><code class="m">32636</code>+<code class="w"> </code>PTR?<code class="w"></code>
<code class="w">  </code>c.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.2.0.f.f.ip6.arpa.<code class="w"> </code><code class="o">(</code><code class="m">90</code><code class="o">)</code><code class="w"></code>
<code class="m">10</code>:26:26.555133<code class="w"> </code>IP<code class="w"> </code>testwifi.here.domain<code class="w"> </code>&gt;<code class="w"> </code>binkley.lan.57137:<code class="w"> </code><code class="m">32636</code><code class="w"> </code>NXDomain<code class="w"></code>
<code class="w">  </code><code class="m">0</code>/1/0<code class="w"> </code><code class="o">(</code><code class="m">154</code><code class="o">)</code><code class="w"></code>
<code class="m">10</code>:26:26.557367<code class="w"> </code>IP<code class="w"> </code>binkley.lan.57872<code class="w"> </code>&gt;<code class="w"> </code>testwifi.here.domain:<code class="w"> </code><code class="m">44057</code>+<code class="w"> </code>PTR?<code class="w"></code>
<code class="w">  </code><code class="m">201</code>.86.168.192.in-addr.arpa.<code class="w"> </code><code class="o">(</code><code class="m">45</code><code class="o">)</code><code class="w"></code>
<code class="m">10</code>:26:26.560368<code class="w"> </code>IP<code class="w"> </code>testwifi.here.domain<code class="w"> </code>&gt;<code class="w"> </code>binkley.lan.57872:<code class="w"> </code><code class="m">44057</code>*<code class="w"> </code><code class="m">1</code>/0/0<code class="w"> </code>PTR<code class="w"></code>
<code class="w">  </code>kilroyhue.lan.<code class="w"> </code><code class="o">(</code><code class="m">99</code><code class="o">)</code><code class="w"></code>
<code class="m">10</code>:26:26.561678<code class="w"> </code>IP<code class="w"> </code>binkley.lan.57726<code class="w"> </code>&gt;<code class="w"> </code>testwifi.here.domain:<code class="w"> </code><code class="m">901</code>+<code class="w"> </code>PTR?<code class="w"></code>
<code class="w">  </code><code class="m">211</code>.1.217.172.in-addr.arpa.<code class="w"> </code><code class="o">(</code><code class="m">44</code><code class="o">)</code><code class="w"></code>
<code class="m">10</code>:26:26.583550<code class="w"> </code>IP<code class="w"> </code>testwifi.here.domain<code class="w"> </code>&gt;<code class="w"> </code>binkley.lan.57726:<code class="w"> </code><code class="m">901</code><code class="w"> </code><code class="m">4</code>/0/0<code class="w"> </code>PTR<code class="w"></code>
<code class="w">  </code>den16s02-in-f19.1e100.net.,<code class="w"> </code>PTR<code class="w"> </code>iad23s26-in-f211.1e100.net.,<code class="w"> </code>PTR<code class="w"></code>
<code class="w">  </code>den16s02-in-f19.1e100.net.,<code class="w"> </code>PTR<code class="w"> </code>iad23s26-in-f211.1e100.net.<code class="w"> </code><code class="o">(</code><code class="m">142</code><code class="o">)</code><code class="w"></code>
<code class="m">10</code>:26:26.585725<code class="w"> </code>IP<code class="w"> </code>binkley.lan.64437<code class="w"> </code>&gt;<code class="w"> </code>testwifi.here.domain:<code class="w"> </code><code class="m">23125</code>+<code class="w"> </code>PTR?<code class="w"></code>
<code class="w">  </code><code class="m">0</code>.0.0.0.in-addr.arpa.<code class="w"> </code><code class="o">(</code><code class="m">38</code><code class="o">)</code><code class="w"></code>
<code class="m">10</code>:26:26.598434<code class="w"> </code>IP<code class="w"> </code>testwifi.here.domain<code class="w"> </code>&gt;<code class="w"> </code>binkley.lan.64437:<code class="w"> </code><code class="m">23125</code><code class="w"> </code>NXDomain<code class="w"></code>
<code class="w">  </code><code class="m">0</code>/1/0<code class="w"> </code><code class="o">(</code><code class="m">106</code><code class="o">)</code><code class="w"></code>
<code class="m">10</code>:26:26.637639<code class="w"> </code>IP<code class="w"> </code>binkley.lan.51994<code class="w"> </code>&gt;<code class="w"> </code><code class="m">239</code>.255.255.250.ssdp:<code class="w"> </code>UDP,<code class="w"> </code>length<code class="w"> </code><code class="m">174</code><code class="w"></code></pre></div>

<p>The first column in the output in <a data-type="xref" href="#EX_2_14">Example 2-15</a> is the timestamp. This is not anything that has been determined from the packet itself, since time is not transmitted as part of any of the headers. What we get is the time as the hours, minutes, seconds, and fractions of seconds after midnight. In other words, it’s the time of day down to a fraction of a second. The second field is the transport protocol. We don’t get the layer 2 protocol because it’s determined by the network interface, so it goes without saying. In order to know the layer 2 protocol, you need to know something about your network interface. Commonly, the layer 2 protocol will be Ethernet.</p>

<p>The next set of data is the two endpoints of the conversation. This includes not only the IP addresses but also the port information. So, <em>binkley.lan</em> is the source of the first packet, and <em>testwifi.here</em> is the destination. Without telling it not to, <em>tcpdump</em> will convert IP addresses to hostnames. To disable that function, you would need to provide an <em>-n</em> on the command line. This would speed up your capture and lower the number of packets captured, since your system won’t be doing a DNS lookup for every frame that comes by.</p>

<p>You will notice that along with each IP address is another value. From our source address, <em>binkley.lan.57137</em>, the 57137 is a port number. This is the source port, and on the receiving side, you can see <em>testwifi.here.domain</em>. This means that <em>testwifi.here</em> is receiving a message on the port used by domain name servers. Again, just as in the hostname versus IP address, if you don’t want <em>tcpdump</em> to do a lookup on the port number, based on well-known port numbers, you can add <em>-n</em> to the command line, and <em>tcpdump</em> will just present you numeric information. In this case <em>.domain</em> translates to <em>.53</em>, which is the numeric value. We know that this is a UDP message because it tells us after the destination information.</p>

<p>Primarily, what you see in <a data-type="xref" href="#EX_2_14">Example 2-15</a> are DNS requests and responses. This is a result of having <em>tcpdump</em> doing reverse DNS lookups to determine the hostname associated with the IP address. The remainder of each line from <em>tcpdump</em> output is a description of the packet. In the case of a TCP message, you may see the flags that are set in the TCP header or you may see sequence number information.</p>

<p>This time, we’ll take a look at more verbose output by using the <em>-v</em> flag. <em>tcpdump</em> supports multiple <em>-v</em> flags, depending on the level of verbosity you are looking for. We’ll also take a look at using the <em>-n</em> flag to see what it looks like without any address lookup. <a data-type="xref" href="#EX_2_15">Example 2-16</a> shows the more verbose output.</p>
<div id="EX_2_15" data-type="example">
<h5><span class="label">Example 2-16. </span>Verbose output for tcpdump</h5>

<pre data-type="programlisting" data-code-language="bash"><code class="m">11</code>:39:09.703339<code class="w"> </code>STP<code class="w"> </code><code class="m">802</code>.1d,<code class="w"> </code>Config,<code class="w"> </code>Flags<code class="w"> </code><code class="o">[</code>none<code class="o">]</code>,<code class="w"> </code>bridge-id<code class="w"></code>
<code class="w">  </code>7b00.18:d6:c7:7d:f4:8a.8004,<code class="w"> </code>length<code class="w"> </code><code class="m">35</code><code class="w"> </code>message-age<code class="w"> </code><code class="m">0</code>.75s,<code class="w"> </code>max-age<code class="w"> </code><code class="m">20</code>.00s,<code class="w"></code>
<code class="w">  </code>hello-time<code class="w"> </code><code class="m">1</code>.00s,<code class="w"> </code>forwarding-delay<code class="w"> </code><code class="m">4</code>.00s<code class="w"> </code>root-id<code class="w"> </code><code class="m">7000</code>.2c:08:8c:1c:3b:db,<code class="w"></code>
<code class="w">  </code>root-pathcost<code class="w"> </code><code class="m">4</code><code class="w"></code>
<code class="m">11</code>:39:09.710628<code class="w"> </code>IP<code class="w"> </code><code class="o">(</code>tos<code class="w"> </code>0x0,<code class="w"> </code>ttl<code class="w"> </code><code class="m">233</code>,<code class="w"> </code>id<code class="w"> </code><code class="m">12527</code>,<code class="w"> </code>offset<code class="w"> </code><code class="m">0</code>,<code class="w"> </code>flags<code class="w"> </code><code class="o">[</code>DF<code class="o">]</code>,<code class="w"> </code>proto<code class="w"> </code>TCP<code class="w"> </code><code class="o">(</code><code class="m">6</code><code class="o">)</code>,<code class="w"></code>
<code class="w">  </code>length<code class="w"> </code><code class="m">553</code><code class="o">)</code><code class="w"> </code><code class="m">54</code>.231.176.224.443<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.86.223.62547:<code class="w"> </code>Flags<code class="w"> </code><code class="o">[</code>P.<code class="o">]</code>,<code class="w"></code>
<code class="w">  </code>cksum<code class="w"> </code>0x6518<code class="w"> </code><code class="o">(</code>correct<code class="o">)</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">3199</code>:3712,<code class="w"> </code>ack<code class="w"> </code><code class="m">1164</code>,<code class="w"> </code>win<code class="w"> </code><code class="m">68</code>,<code class="w"> </code>length<code class="w"> </code><code class="m">513</code><code class="w"></code>
<code class="m">11</code>:39:09.710637<code class="w"> </code>IP<code class="w"> </code><code class="o">(</code>tos<code class="w"> </code>0x0,<code class="w"> </code>ttl<code class="w"> </code><code class="m">233</code>,<code class="w"> </code>id<code class="w"> </code><code class="m">12528</code>,<code class="w"> </code>offset<code class="w"> </code><code class="m">0</code>,<code class="w"> </code>flags<code class="w"> </code><code class="o">[</code>DF<code class="o">]</code>,<code class="w"> </code>proto<code class="w"> </code>TCP<code class="w"> </code><code class="o">(</code><code class="m">6</code><code class="o">)</code>,<code class="w"></code>
<code class="w">  </code>length<code class="w"> </code><code class="m">323</code><code class="o">)</code><code class="w"> </code><code class="m">54</code>.231.176.224.443<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.86.223.62547:<code class="w"> </code>Flags<code class="w"> </code><code class="o">[</code>P.<code class="o">]</code>,<code class="w"></code>
<code class="w">  </code>cksum<code class="w"> </code>0x7f26<code class="w"> </code><code class="o">(</code>correct<code class="o">)</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">3712</code>:3995,<code class="w"> </code>ack<code class="w"> </code><code class="m">1164</code>,<code class="w"> </code>win<code class="w"> </code><code class="m">68</code>,<code class="w"> </code>length<code class="w"> </code><code class="m">283</code><code class="w"></code>
<code class="m">11</code>:39:09.710682<code class="w"> </code>IP<code class="w"> </code><code class="o">(</code>tos<code class="w"> </code>0x0,<code class="w"> </code>ttl<code class="w"> </code><code class="m">64</code>,<code class="w"> </code>id<code class="w"> </code><code class="m">0</code>,<code class="w"> </code>offset<code class="w"> </code><code class="m">0</code>,<code class="w"> </code>flags<code class="w"> </code><code class="o">[</code>DF<code class="o">]</code>,<code class="w"> </code>proto<code class="w"> </code>TCP<code class="w"> </code><code class="o">(</code><code class="m">6</code><code class="o">)</code>,<code class="w"></code>
<code class="w">  </code>length<code class="w"> </code><code class="m">40</code><code class="o">)</code><code class="w"> </code><code class="m">192</code>.168.86.223.62547<code class="w"> </code>&gt;<code class="w"> </code><code class="m">54</code>.231.176.224.443:<code class="w"> </code>Flags<code class="w"> </code><code class="o">[</code>.<code class="o">]</code>,<code class="w"></code>
<code class="w">  </code>cksum<code class="w"> </code>0x75f2<code class="w"> </code><code class="o">(</code>correct<code class="o">)</code>,<code class="w"> </code>ack<code class="w"> </code><code class="m">3712</code>,<code class="w"> </code>win<code class="w"> </code><code class="m">8175</code>,<code class="w"> </code>length<code class="w"> </code><code class="m">0</code><code class="w"></code>
<code class="m">11</code>:39:09.710703<code class="w"> </code>IP<code class="w"> </code><code class="o">(</code>tos<code class="w"> </code>0x0,<code class="w"> </code>ttl<code class="w"> </code><code class="m">64</code>,<code class="w"> </code>id<code class="w"> </code><code class="m">0</code>,<code class="w"> </code>offset<code class="w"> </code><code class="m">0</code>,<code class="w"> </code>flags<code class="w"> </code><code class="o">[</code>DF<code class="o">]</code>,<code class="w"> </code>proto<code class="w"> </code>TCP<code class="w"> </code><code class="o">(</code><code class="m">6</code><code class="o">)</code>,<code class="w"></code>
<code class="w">  </code>length<code class="w"> </code><code class="m">40</code><code class="o">)</code><code class="w"></code></pre></div>

<p>The output looks largely the same except that this is all numbers with no hostnames or port names. This is a result of using the <em>-n</em> flag when running <em>tcpdump</em>. You will still see the two endpoints of each conversation identified by IP address and port number. What you get with <em>-v</em> is more details from the headers. You will see that checksums are verified as correct (or incorrect). You will also see other fields including the time-to-live value and the IP identification value.</p>

<p>Even if we switch to <em>-vvv</em> for the most verbosity, you aren’t going to get a complete packet decode for analysis. We can, though, use <em>tcpdump</em> to capture packets and write them out to a file. What we need to talk about is the <em>snap length</em>. This is the snapshot length, or the amount of each packet that is captured in bytes. By default, tcpdump grabs 262144 bytes. You may be able to set that value lower. Setting the value to 0 says that <em>tcpdump</em> should grab the maximum size. In effect, this tells <em>tcpdump</em> to set the snap length to the default value of 262144. To write the packet capture out, we need to use the <em>-w</em> flag and specify a file. Once we’ve done that, we have a packet capture (pcap) file that we can import into any tool that will read these files. We’ll take a look at one of those tools a little later.<a data-type="indexterm" data-primary="" data-startref="tcpdump02" id="id428"></a><a data-type="indexterm" data-primary="" data-startref="PCtcpdump02" id="id429"></a></p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Berkeley Packet Filters"><div class="sect2" id="id31">
<h2>Berkeley Packet Filters</h2>

<p>Another<a data-type="indexterm" data-primary="packet captures" data-secondary="Berkeley Packet Filter (BPF)" id="id430"></a><a data-type="indexterm" data-primary="BPF (Berkeley Packet Filter)" id="id431"></a> important feature of <em>tcpdump</em>, which will serve us well shortly, is the Berkeley Packet Filter (BPF). This set of fields and parameters allows us to limit the packets that we are grabbing. On a busy network, grabbing packets can result in a lot of data on your disk in a short period of time. If you have an idea of what you are looking for ahead of time, you can create a filter to capture only what you are going to be looking at. This can also make it quite a bit easier to visually parse through what you have captured, saving you a lot of time.</p>

<p>A basic filter is to specify which protocol you want to capture. As an example, I could choose to capture only TCP or UDP packets. I might also say I want to capture only IP or other protocols. In <a data-type="xref" href="#EX_2_16">Example 2-17</a>, you can see a capture of ICMP-only packets. You will notice that in order to apply a filter, I just put it on the end of the command line. What results is the display of only ICMP packets. Everything still comes into the interface and is sent up to <em>tcpdump</em>, but it then determines what to display or write out to a file, if that’s what you are doing.</p>
<div id="EX_2_16" data-type="example">
<h5><span class="label">Example 2-17. </span>tcpdump using BPF</h5>

<pre data-type="programlisting" data-code-language="bash">root@rosebud:~#<code class="w"> </code>tcpdump<code class="w"> </code>icmp<code class="w"></code>
tcpdump:<code class="w"> </code>verbose<code class="w"> </code>output<code class="w"> </code>suppressed,<code class="w"> </code>use<code class="w"> </code>-v<code class="w"> </code>or<code class="w"> </code>-vv<code class="w"> </code><code class="k">for</code><code class="w"> </code>full<code class="w"> </code>protocol<code class="w"> </code>decode<code class="w"></code>
listening<code class="w"> </code>on<code class="w"> </code>eth0,<code class="w"> </code>link-type<code class="w"> </code>EN10MB<code class="w"> </code><code class="o">(</code>Ethernet<code class="o">)</code>,<code class="w"> </code>capture<code class="w"> </code>size<code class="w"> </code><code class="m">262144</code><code class="w"> </code>bytes<code class="w"></code>
<code class="m">12</code>:01:14.602895<code class="w"> </code>IP<code class="w"> </code>binkley.lan<code class="w"> </code>&gt;<code class="w"> </code>rosebud.lan:<code class="w"> </code>ICMP<code class="w"> </code><code class="nb">echo</code><code class="w"> </code>request,<code class="w"> </code>id<code class="w"> </code><code class="m">8203</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">0</code>,<code class="w"></code>
<code class="w">  </code>length<code class="w"> </code><code class="m">64</code><code class="w"></code>
<code class="m">12</code>:01:14.602952<code class="w"> </code>IP<code class="w"> </code>rosebud.lan<code class="w"> </code>&gt;<code class="w"> </code>binkley.lan:<code class="w"> </code>ICMP<code class="w"> </code><code class="nb">echo</code><code class="w"> </code>reply,<code class="w"> </code>id<code class="w"> </code><code class="m">8203</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">0</code>,<code class="w"></code>
<code class="w">  </code>length<code class="w"> </code><code class="m">64</code><code class="w"></code>
<code class="m">12</code>:01:15.604118<code class="w"> </code>IP<code class="w"> </code>binkley.lan<code class="w"> </code>&gt;<code class="w"> </code>rosebud.lan:<code class="w"> </code>ICMP<code class="w"> </code><code class="nb">echo</code><code class="w"> </code>request,<code class="w"> </code>id<code class="w"> </code><code class="m">8203</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">1</code>,<code class="w"></code>
<code class="w">  </code>length<code class="w"> </code><code class="m">64</code><code class="w"></code>
<code class="m">12</code>:01:15.604171<code class="w"> </code>IP<code class="w"> </code>rosebud.lan<code class="w"> </code>&gt;<code class="w"> </code>binkley.lan:<code class="w"> </code>ICMP<code class="w"> </code><code class="nb">echo</code><code class="w"> </code>reply,<code class="w"> </code>id<code class="w"> </code><code class="m">8203</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">1</code>,<code class="w"></code>
<code class="w">  </code>length<code class="w"> </code><code class="m">64</code><code class="w"></code>
<code class="m">12</code>:01:16.604295<code class="w"> </code>IP<code class="w"> </code>binkley.lan<code class="w"> </code>&gt;<code class="w"> </code>rosebud.lan:<code class="w"> </code>ICMP<code class="w"> </code><code class="nb">echo</code><code class="w"> </code>request,<code class="w"> </code>id<code class="w"> </code><code class="m">8203</code>,<code class="w"> </code>seq<code class="w"> </code><code class="m">2</code>,<code class="w"></code>
<code class="w">  </code>length<code class="w"> </code><code class="m">64</code><code class="w"></code></pre></div>

<p>One thing I can do with these filters is use Boolean logic; I can use logic operators to be able to develop complex filters. Let’s say, for instance, that I want to capture web traffic. One way I could do that would be to say <em>tcp and port 80</em>: I am grabbing all TCP packets that have the port as 80. You’ll notice that I don’t mention source or destination with respect to the port number. I certainly can. I could use src port 80 or dst port 80. However, if I don’t specify source or destination, I get both ends of the conversation. When a message goes out with port 80 as its destination, when the receiving system replies, the port numbers get swapped. Port 80 on the response becomes the source port. If I were to  capture only src port 80, I wouldn’t get any of the messages in the other direction. This may be exactly what you are looking for, of course, but it’s something to keep in mind. You may find that you need to indicate a range of ports to be grabbed. You could use the port-range primitive to capture a range of ports, like 80–88, for example.</p>

<p>The language used for BPF provides a lot of capability. If you need really complex filters, you can certainly look up the syntax for BPF and examples that may provide you something specific that you are looking for. What I have often found is that specifying the port is valuable. Also, I often know the host I want to capture traffic from. In that case, I would use <em>host 192.168.86.35</em> to grab only traffic with that IP address. Again, I have not specified either source or destination for the address. I could by specifying src host or dst host. If I don’t indicate, I get both directions of the conversation.</p>

<p>Developing even a simple understanding of BPF will help you focus what you are looking at down to data that is relevant. When we start looking at packet captures, you will see how complex a job it can be to do packet analysis because there are just so many frames that contain a lot of detail to look over.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Wireshark"><div class="sect2" id="id32">
<h2>Wireshark</h2>

<p>When<a data-type="indexterm" data-primary="packet captures" data-secondary="Wireshark" id="PCwireshark02"></a><a data-type="indexterm" data-primary="Wireshark" id="wireshark02"></a> you have your packet capture file, you will probably want to do some analysis. One of the best tools for that is Wireshark. Of course, Wireshark can also capture packets itself and generate pcap files if you want to store the capture for later analysis or for analysis by someone else. The major advantage to Wireshark, though, is providing a way to really dig deep into the contents of the packet. Rather than spending time walking through what Wireshark looks like or how we can use Wireshark for capturing packets, let’s jump into breaking apart a packet using Wireshark. <a data-type="xref" href="#header-fields-in-wireshark">Figure 2-4</a> shows the IP and TCP headers from an HTTP packet.</p>

<figure><div id="header-fields-in-wireshark" class="figure">
<img src="assets/lklx_02in01.png" alt="images/Ch2Fig4.png" width="2888" height="1120"/>
<h6><span class="label">Figure 2-4. </span>Header fields in Wireshark</h6>
</div></figure>

<p>You can see from just this image that Wireshark provides far more details than we were getting from <em>tcpdump</em>. This is one area where GUIs have a significant advantage. There is just more room here and a better way to present the amount of data in each of these headers. Each field in the header is presented on its own line so it’s clear what is happening. You’ll also see here that some of the fields can be broken out even more. The flags field, for example, can be broken open to see the details. This is because the flags field is really a series of bits, so if you want, you can open that field by clicking the arrow (or triangle) and you will be able to see the value of each of the bits. Of course, you can also see what is set just by looking at the line we have presented by Wireshark because it has done the work for us. For this frame, the Don’t Fragment bit is set.</p>

<p>Another advantage to using a tool like Wireshark is that we can more easily get to the contents of the packet. By finding a frame that we are interested in because it’s part of a conversation that we think has some value, we just need to select Follow TCP Stream. What we will get, in addition to only the frames that are part of that conversation, is a window showing the ASCII decode of the payloads from all of the frames. You can see this in <a data-type="xref" href="#follow-tcp-stream-output">Figure 2-5</a>. Wireshark also color-codes the output. Red is the client messages, and blue is the server messages. You will also get a brief summary at the bottom of the window indicating how much of the conversation was the client’s and how much was the server’s.</p>

<figure class="width_set_80"><div id="follow-tcp-stream-output" class="figure">
<img src="assets/lklx_02in02.png" alt="images/Ch2Fig5.png" width="1752" height="1100"/>
<h6><span class="label">Figure 2-5. </span>Follow TCP stream output</h6>
</div></figure>

<p>Wireshark has the same filtering capabilities that we had with <em>tcpdump</em>. In the case of Wireshark, we can apply the filter as a capture filter, meaning we will capture only packets that match the filter, or we can apply the filter as a display filter to be applied to packets already captured. Wireshark will provide a lot of help when it comes to filtering. When you start typing in the filter box at the top of the screen, Wireshark will start trying to autocomplete. It will also indicate whether you have a valid filter by color-coding the box red when you have an invalid filter, and green when it’s valid. Wireshark has the ability to get to about every field or property of the protocols it knows about. As an example, we could filter on the type of HTTP response code that was seen. This may be valuable if you generated an error and you want to look at the conversation that led to the error.</p>

<p>Wireshark<a data-type="indexterm" data-primary="fragroute program" id="id432"></a> will also do a lot of analysis for us. As an example, when we were fragmenting packets earlier using <em>fragroute</em>, Wireshark would have colored frames that weren’t right. If a packet’s checksum didn’t match, for instance, the frames belonging to that packet would have been colored black. Any error in the protocol where the packet is malformed would result in a frame that was colored red. Similarly, TCP resets will get a frame colored red. A warning would be colored yellow and may result from an application generating an unusual error code. You may also see yellow if there are connection problems. If you want to save a little time, you can use the Analyze menu and select Expert Info to see the entire list of frames that have been flagged. You can see a sample of this view in <a data-type="xref" href="#expert-information-output">Figure 2-6</a>.</p>

<figure class="width_set_80"><div id="expert-information-output" class="figure">
<img src="assets/lklx_02in03.png" alt="images/Ch2Fig6.png" width="1748" height="1016"/>
<h6><span class="label">Figure 2-6. </span>Expert information output</h6>
</div></figure>

<p>Wireshark has so many capabilities; we aren’t even skimming the surface of what it can do. A lot of what you may find it useful for is just to see the headers for each protocol broken out in a way that you can easily read them. This will help you see what is happening if you run into issues with your testing. One other feature I should mention is the statistics menu. Wireshark will provide graphs and different views of the data you have captured. One such view is the protocol hierarchy, as you can see in <a data-type="xref" href="#protocol-hierarchy-in-wireshark">Figure 2-7</a>.</p>

<figure><div id="protocol-hierarchy-in-wireshark" class="figure">
<img src="assets/lklx_02in04.png" alt="images/Ch2Fig7.png" width="2376" height="1172"/>
<h6><span class="label">Figure 2-7. </span>Protocol hierarchy in Wireshark</h6>
</div></figure>

<p>The protocol hierarchy view is good for, among other things, quickly identifying protocols that you don’t recognize. It also helps you to determine which protocols are the most used. If you believe, for instance, that you are using a lot of UDP-based attacks, but UDP is a small fraction of the total number of messages sent, you may want to do some further investigation.</p>

<p>Wireshark comes installed out of the box, so to speak, with Kali Linux. However, it can also be installed on other operating systems such as Windows and macOS as well as other Linux distributions. I can’t emphasize enough the value of this particular tool and the amount of work it can save after you get the hang of using it. Being able to completely decode application layer protocols so it can give you a little summary of what is happening with the application can be invaluable.<a data-type="indexterm" data-primary="" data-startref="NSTpacket02" id="id433"></a><a data-type="indexterm" data-primary="" data-startref="wireshark02" id="id434"></a><a data-type="indexterm" data-primary="" data-startref="PCwireshark02" id="id435"></a></p>

<p>There is a challenge with the use of encrypted traffic for almost all websites today, but it is possible to get around that. You can add encryption keys into the Preferences but it’s a lot of work ensuring that you have the right keys for the communications streams you want to decode. For everything not encrypted, you can do full protocol decodes and you can always look at headers to see who is communicating with whom.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Poisoning Attacks"><div class="sect1" id="id33">
<h1>Poisoning Attacks</h1>

<p>One<a data-type="indexterm" data-primary="network security testing" data-secondary="poisoning attacks" id="NSTpoison02"></a><a data-type="indexterm" data-primary="attacks" data-secondary="poisoning attacks" id="ATpoison02"></a><a data-type="indexterm" data-primary="poisoning attacks" data-secondary="switched networks and" id="id436"></a> of the challenges we have is that most networks are switched. The device you are connecting to sends messages only to the network port where your recipient is located. In the old days, we used hubs. Whereas a switch is a unicast device, a hub is a broadcast device. Any message that came into a hub was sent out to all other ports in the hub, letting the endpoints figure out who the frame belonged to, based on the MAC address. There was no intelligence in the hub at all. It was simply a repeater.</p>

<p>A switch changes all that. The switch reads the layer 2 header to determine the destination MAC address. It knows the port where the system that owns that MAC address is. It determines this by watching traffic coming into each port. The source MAC address gets attached to the port. The switch will commonly store these mappings in<a data-type="indexterm" data-primary="CAM (content addressable memory)" id="id437"></a> content addressable memory (CAM). Rather than having to scan through an entire table, the switch looks up the details by referring directly to the MAC address. This is the content that becomes the address the switch refers to in order to get the port information.</p>

<p>Why is this relevant here? Because you will sometimes want to collect information from a system that you don’t have access to. If you owned the network and had access to the switch, you may be able to configure the switch to forward traffic from one or more ports to another port. This would be a mirror, rather than a redirection. The recipient gets the traffic, but also a monitoring device or someone capturing traffic for analysis would get the packets.</p>

<p>To<a data-type="indexterm" data-primary="poisoning attacks" data-secondary="spoofing attacks" id="id438"></a><a data-type="indexterm" data-primary="attacks" data-secondary="spoofing attacks" id="id439"></a><a data-type="indexterm" data-primary="spoofing attacks" data-secondary="ethics considerations" id="id440"></a><a data-type="indexterm" data-primary="ethical issues" data-secondary="spoofing attacks" id="id441"></a> obtain the messages you need if you can’t get legitimate access to them, you can use a spoofing attack. In a <em>spoofing attack</em>, you pretend to be someone you are not in order to get traffic. There are a couple of ways to do that, and we’ll take a look at these different attacks.</p>
<div data-type="warning" epub:type="warning"><h1>Ethics Warning</h1>
<p>While spoofing attacks are used by attackers, they are not something that you should be doing on a network you are testing, unless it falls into the scope of what you have said you would test against. There is the possibility of data loss using this technique.</p>
</div>








<section data-type="sect2" data-pdf-bookmark="ARP Spoofing"><div class="sect2" id="id34">
<h2>ARP Spoofing</h2>

<p>The<a data-type="indexterm" data-primary="ARP (Address Resolution Protocol)" id="id442"></a><a data-type="indexterm" data-primary="poisoning attacks" data-secondary="ARP spoofing" id="Parp02"></a><a data-type="indexterm" data-primary="spoofing attacks" data-secondary="ARP spoofing" id="SAarp02"></a> Address Resolution Protocol (ARP) is a simple protocol. The assumption is when your system needs to communicate on the network but it has only the IP address and not the MAC address, it will send out a request (who-has) to the network. The system that has that IP address will respond (is-at) by filling in the MAC address for its system. Your system then knows the MAC address for the target system and can send the message it’s been holding to the correct destination.</p>

<p>To be efficient, your system will cache that mapping. In fact, it will cache any mapping that it sees go by. ARP assumes that the only time a system will indicate that it owns an IP address is when someone has asked. As it turns out, though, that’s not the case. If I were to have my system send out an ARP response (is-at) saying that I owned your IP address and that anyone trying to get to that IP address should send to my MAC address, I would get messages destined for you. By sending out an ARP response indicating your IP address is at my MAC address, I put myself into the middle of the communication flow.</p>

<p>This is only single-direction, though. If I end up spoofing your IP address with my MAC address, I’m getting only messages that were supposed to go to you. To get the other end of the conversation, I would need to spoof other addresses. You may, for example, spoof the local gateway in order to capture messages to and from you and the internet. This takes care of only getting the messages to me. I have to also get the messages back out to the intended targets, or the communication just stops because no one is getting messages they expect to get. This requires my system to forward the initial message out to the intended target.</p>

<p>Since ARP caches do time out, if I don’t keep having my system sending these messages, eventually the cache will time out and then I won’t get the messages I want anymore. This<a data-type="indexterm" data-primary="gratuitous ARP messages" id="id443"></a> means that I need to keep sending out these messages, called gratuitous ARP messages. A <em>gratuitous ARP message</em> is one that hasn’t been requested but offered nonetheless. There are legitimate reasons for this behavior, but they aren’t common.</p>

<p>While other tools can be used for this, we can use the program Ettercap. Ettercap has two modes of functioning. The first is a curses-style interface, meaning it runs in a console but isn’t strictly command line. It presents a character-based GUI. The other one is a full Windows-based GUI. <a data-type="xref" href="#using-ettercap">Figure 2-8</a> shows Ettercap after our target hosts have been selected and the ARP poisoning has been started. To start the spoofing attack, I scanned for hosts to get all of the MAC addresses on the network. Then, I selected the two targets and started the ARP spoofing attack.</p>

<figure><div id="using-ettercap" class="figure">
<img src="assets/lklx_02in05.png" alt="images/Ch2Fig8.png" width="2152" height="1456"/>
<h6><span class="label">Figure 2-8. </span>Using Ettercap</h6>
</div></figure>

<p>The reason for having two targets is to make sure to get both sides of a conversation. If I poison only one party, I will get only half of the conversation. I assume that what I want to gather is communication between my target and the internet. As a result, I set my target as one host and the router on my network as the second host. If I needed to acquire traffic between two systems on my network, I would select those. One would be in Target 1, and the other would be in Target 2. In <a data-type="xref" href="#EX_2_17">Example 2-18</a>, you can see what an ARP poison attack looks like from a packet capture. You will see the two ARP replies where the IP addresses belong to my targets. I included a portion of the <em>ifconfig</em> output on my system so you can see that the MAC address caught in the packet capture is the MAC address of my system, where I was running the ARP spoofing attack.</p>
<div id="EX_2_17" data-type="example">
<h5><span class="label">Example 2-18. </span>tcpdump showing ARP poison attack</h5>

<pre data-type="programlisting" data-code-language="bash"><code class="m">17</code>:06:46.690545<code class="w"> </code>ARP,<code class="w"> </code>Reply<code class="w"> </code>rosebud.lan<code class="w"> </code>is-at<code class="w"> </code><code class="m">00</code>:0c:29:94:ce:06<code class="w"> </code><code class="o">(</code>oui<code class="w"> </code>Unknown<code class="o">)</code>,<code class="w"></code>
length<code class="w"> </code><code class="m">28</code><code class="w"></code>
<code class="m">17</code>:06:46.690741<code class="w"> </code>ARP,<code class="w"> </code>Reply<code class="w"> </code>testwifi.here<code class="w"> </code>is-at<code class="w"> </code><code class="m">00</code>:0c:29:94:ce:06<code class="w"> </code><code class="o">(</code>oui<code class="w"> </code>Unknown<code class="o">)</code>,<code class="w"></code>
length<code class="w"> </code><code class="m">28</code><code class="w"></code>
<code class="m">17</code>:06:46.786532<code class="w"> </code>ARP,<code class="w"> </code>Request<code class="w"> </code>who-has<code class="w"> </code>localhost.lan<code class="w"> </code>tell<code class="w"> </code>savagewood.lan,<code class="w"> </code>length<code class="w"> </code><code class="m">46</code><code class="w"></code>
^C<code class="w"></code>
<code class="m">43</code><code class="w"> </code>packets<code class="w"> </code>captured<code class="w"></code>
<code class="m">43</code><code class="w"> </code>packets<code class="w"> </code>received<code class="w"> </code>by<code class="w"> </code>filter<code class="w"></code>
<code class="m">0</code><code class="w"> </code>packets<code class="w"> </code>dropped<code class="w"> </code>by<code class="w"> </code>kernel<code class="w"></code>
root@kali:~#<code class="w"> </code>ifconfig<code class="w"> </code>eth0<code class="w"></code>
eth0:<code class="w"> </code><code class="nv">flags</code><code class="o">=</code><code class="m">4163</code>&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;<code class="w">  </code>mtu<code class="w"> </code><code class="m">1500</code><code class="w"></code>
<code class="w">        </code>inet<code class="w"> </code><code class="m">192</code>.168.86.227<code class="w">  </code>netmask<code class="w"> </code><code class="m">255</code>.255.255.0<code class="w">  </code>broadcast<code class="w"> </code><code class="m">192</code>.168.86.255<code class="w"></code>
<code class="w">        </code>inet6<code class="w"> </code>fe80::20c:29ff:fe94:ce06<code class="w">  </code>prefixlen<code class="w"> </code><code class="m">64</code><code class="w">  </code>scopeid<code class="w"> </code>0x20&lt;link&gt;<code class="w"></code>
<code class="w">        </code>ether<code class="w"> </code><code class="m">00</code>:0c:29:94:ce:06<code class="w">  </code>txqueuelen<code class="w"> </code><code class="m">1000</code><code class="w">  </code><code class="o">(</code>Ethernet<code class="o">)</code><code class="w"></code></pre></div>

<p>Once I have an ARP spoofing attack in place, I can capture entire conversations by using <em>tcpdump</em> or Wireshark. Keep in mind that this sort of attack works on only the local network. This is because the MAC address is a layer 2 address so it stays on the local network and doesn’t cross over any layer 3 boundary (moving from one network to another). Ettercap also supports other layer 2 attacks like DHCP poisoning and ICMP redirect attacks. Any of these may be ways to ensure you are grabbing traffic from other systems on your local network.<a data-type="indexterm" data-primary="" data-startref="Parp02" id="id444"></a><a data-type="indexterm" data-primary="" data-startref="SAarp02" id="id445"></a></p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="DNS Spoofing"><div class="sect2" id="id35">
<h2>DNS Spoofing</h2>

<p>One<a data-type="indexterm" data-primary="poisoning attacks" data-secondary="DNS spoofing" id="id446"></a><a data-type="indexterm" data-primary="spoofing attacks" data-secondary="DNS spoofing" id="id447"></a> solution to the issue of needing to capture traffic that may be outside the local network is using a DNS spoofing attack. In this attack, you interfere with a DNS lookup to ensure that when your target attempts to resolve a hostname into an IP address, the target gets the IP address of a system you control. This<a data-type="indexterm" data-primary="attacks" data-secondary="cache poisoning attacks" id="id448"></a><a data-type="indexterm" data-primary="cache poisoning attacks" id="id449"></a> type of attack is sometimes called a <em>cache poisoning attack</em>. The reason for this is that what you may do is exploit a DNS server close to your target. This would generally be a caching server, meaning it looks up addresses from authoritative servers on your behalf and then caches the answer for a period of time determined by the authoritative server.</p>

<p>Once you have access to the caching server, you can modify the cache that’s in place to direct your targets to systems that you control. You can also include any entries that don’t exist by editing the cache. This would impact anyone who used that caching server. This process has the benefit of working outside the local network but has the disadvantage of requiring you to compromise a remote DNS server.</p>

<p>Perhaps<a data-type="indexterm" data-primary="dnsspoof program" id="id450"></a> easier, though still requiring you to be on the local network, is the program <em>dnsspoof</em>. When a system sends out a DNS request to a server, it expects a response from that server. The request includes an identifier so it is protected against attackers sending blind responses. If the attacker can see the request go out, though, it can capture the identifier and include it in a response that has the IP address belonging to the attacker. <em>dnsspoof</em> was written by<a data-type="indexterm" data-primary="Song, Dug" id="id451"></a> Dug Song many years ago, at a time when it may have been less likely that you would be on a switched network. If you are on a switched network, you would have to go through the extra step of grabbing the DNS messages in order to see the request. This program is not installed by default, but can be installed as part of the package <em>dsniff</em>.</p>

<p>Running <em>dnsspoof</em> is easy, even if preparing for running it may not be. You need a hosts file mapping IP addresses to hostnames. This takes the form of single-line entries with the IP address followed by spaces and then the hostname that is meant to be associated with that IP address. Once you have the hosts file, you can run <em>dnsspoof</em>, as you can see in <a data-type="xref" href="#EX_2_14b">Example 2-19</a>.</p>
<div id="EX_2_14b" data-type="example">
<h5><span class="label">Example 2-19. </span>Using dnsspoof</h5>

<pre data-type="programlisting" data-code-language="bash">┌──<code class="o">(</code>kilroy㉿badmilo<code class="o">)</code>-<code class="o">[</code>~<code class="o">]</code><code class="w"></code>
└─$<code class="w"> </code>sudo<code class="w"> </code>dnsspoof<code class="w"> </code>-i<code class="w"> </code>eth0<code class="w"> </code>-f<code class="w"> </code>myhosts<code class="w"> </code>udp<code class="w"> </code>dst<code class="w"> </code>port<code class="w"> </code><code class="m">53</code><code class="w"></code>
dnsspoof:<code class="w"> </code>listening<code class="w"> </code>on<code class="w"> </code>eth0<code class="w"> </code><code class="o">[</code>udp<code class="w"> </code>dst<code class="w"> </code>port<code class="w"> </code><code class="m">53</code><code class="o">]</code><code class="w"></code>
<code class="m">192</code>.168.1.253.39071<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.53:<code class="w">  </code><code class="m">45040</code>+<code class="w"> </code>A?<code class="w"> </code>www.bogusserver.com<code class="w"></code>
<code class="m">192</code>.168.1.253.34786<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.53:<code class="w">  </code><code class="m">39506</code>+<code class="w"> </code>A?<code class="w"> </code>www.bogusserver.com<code class="w"></code>
<code class="m">192</code>.168.1.253.55556<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.53:<code class="w">  </code><code class="m">12829</code>+<code class="w"> </code>PTR?<code class="w"> </code><code class="m">15</code>.1.168.192.in-addr.arpa<code class="w"></code>
<code class="m">192</code>.168.1.253.46864<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.53:<code class="w">  </code><code class="m">40977</code>+<code class="w"> </code>PTR?<code class="w"> </code><code class="m">15</code>.1.168.192.in-addr.arpa<code class="w"></code>
<code class="m">192</code>.168.1.253.41132<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.53:<code class="w">  </code><code class="m">58799</code>+<code class="w"> </code>PTR?<code class="w"> </code><code class="m">15</code>.1.168.192.in-addr.arpa<code class="w"></code>
<code class="m">192</code>.168.1.253.33490<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.53:<code class="w">  </code><code class="m">4611</code>+<code class="w"> </code>PTR?<code class="w"> </code><code class="m">15</code>.1.168.192.in-addr.arpa<code class="w"></code>
<code class="m">192</code>.168.1.253.53561<code class="w"> </code>&gt;<code class="w"> </code><code class="m">192</code>.168.1.1.53:<code class="w">  </code><code class="m">31549</code>+<code class="w"> </code>PTR?<code class="w"> </code><code class="m">15</code>.1.168.192.in-addr.arpa<code class="w"></code></pre></div>

<p>You’ll notice that at the end of the command line, I have included BPF to focus the packets that are captured. Without this, the output would default to looking only datagrams captured to UDP port 53 if they do not originate from the system you are running <em>dnsspoof</em> on. You can use BPF just as you would with <em>tcpdump</em> to see a broader set of traffic. I removed the part that didn’t capture traffic from the local system and included my own BPF in order to run tests locally. You’ll see any request matching your BPF parameters get printed when they come in. This output is similar to what you might see from <em>tcpdump</em>.</p>

<p>You may be wondering why you’d bother to take the extra step of using <em>dnsspoof</em> if you have to use<a data-type="indexterm" data-primary="Ettercap" id="id452"></a> Ettercap or<a data-type="indexterm" data-primary="arpspoof" id="id453"></a> <em>arpspoof</em> (another ARP spoofing utility, though this one was written by Dug Song and included in the same suite of tools as <em>dnsspoof</em>). What you can do with <em>dnsspoof</em> that you can’t do with just ARP spoofing is directing a system to actually visit another IP address, thinking they are going to somewhere legitimate. You could create a rogue web server, for example, making it look like the real server but including some malicious code to gather data or infect the target. This is not the only purpose for doing DNS spoofing, but is a popular one.<a data-type="indexterm" data-primary="" data-startref="NSTpoison02" id="id454"></a><a data-type="indexterm" data-primary="" data-startref="ATpoison02" id="id455"></a></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="id36">
<h1>Summary</h1>

<p>Typically, attacks against systems will happen over the network. Although not all attacks go after network protocols, there are enough that do that it’s worth spending some time understanding the network elements and the protocols associated with the different layers. Here are some key points to take away from this chapter:</p>

<ul>
<li>
<p>Security testing is about finding deficiencies in confidentiality, integrity, and availability.</p>
</li>
<li>
<p>The network stack based on the OSI model is physical, data, network, transport, session, presentation, and application.</p>
</li>
<li>
<p>Stress testing can reveal impacts to at least availability.</p>
</li>
<li>
<p>Encryption can make it difficult to observe network connections, but weak encryption can reveal issues with confidentiality.</p>
</li>
<li>
<p>Spoofing attacks can provide a way to observe and capture network traffic from remote sources.</p>
</li>
<li>
<p>Capturing packets using tools like tcpdump and Wireshark can provide insights into what’s happening with applications.</p>
</li>
<li>
<p>Kali provides tools that are useful for network security testing.<a data-type="indexterm" data-primary="" data-startref="KLbasic02" id="id456"></a></p>
</li>
</ul>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Quiz Questions"><div class="sect1" id="id66">
<h1>Quiz Questions</h1>

<p>1) What tool would you use to help you with spoofing attacks that would help you capture packets from other systems?
a) Wireshark
b) Dhcpig
c) Scapy
d) EttercapSS</p>

<p>2) Which layer of the OSI model is where the IP address is?
a) Data link
b) Network
c) Transport
d) Application</p>

<p>3) Which encryption element is used to mutually derive encryption keys?
a) AES
b) DES
c) SHA384
d) Diffie-Hellman</p>

<p>4) If you wanted to perform a SYN flood against a network target, which of these tools would you be most likely to use?
a) Hping
b) Dhcpig
c) Ettercap
d) Slowhttp</p>

<p>5) What security property would be impacted if you were to cause a network device to fail if you were performing network testing?
a) Confidentiality
b) Integrity
c) Availability
d) Authenticity</p>

<p>6) What might be the outcome of running <em>slowhttptest</em>?
a) Web server failure
b) Compromised credentials
c) Obtaining cookies
d) Stealing data</p>

<p>7) What do you call an application that watches a process to ensure the process stays running?
a) System manager
b) Application manager
c) Watchdog
d) Log monitor</p>

<p>8) What BPF syntax would you use to capture only unencrypted web packets with 192.168.10.250 as an address?
a) host 192.168.10.250 and web
b) host 192.168.10.250 and port 80
c) ip 192.168.10.250 and port 80
d) ip 192.168.10.250 and port 443</p>

<p>9) What function would you use to send and receive using Scapy, printing details from the packet header that has been received?
a) sendrecv()
b) send()
c) sr()
d) sr1()</p>

<p>10) If you wanted to make sure devices on a network obtained IP configuration that you controlled, what tool could you use to help you?
a) Scapy
b) Ettercap
c) Dhcpig
d) Wireshark</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Useful Resources"><div class="sect1" id="id67">
<h1>Useful Resources</h1>

<ul>
<li>
<p>Dug Song’s <a href="https://monkey.org/~dugsong/dsniff/">dsniff Page</a></p>
</li>
<li>
<p>Ric Messier’s <a href="http://bit.ly/tcp-ip-video">“TCP/IP” video</a> (Infinite Skills, 2013)</p>
</li>
<li>
<p><a href="http://bit.ly/tcp-ip-network-admin-3e"><em>TCP/IP Network Administration</em>, 3e</a>, by Craig Hunt (O’Reilly, 2010)</p>
</li>
</ul>
</div></section>
</div></section></div>
</div>
</body>
</html>