<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. Middleware"><div class="chapter" id="ch_middleware">
<h1><span class="label">Chapter 10. </span>Middleware</h1>


<p><a data-type="indexterm" data-primary="middleware" id="ix_ch-10-middleware-asciidoc0"/>By now, we’ve already had some exposure to middleware: we’ve used
existing middleware (<code>body-parser</code>, <code>cookie-parser</code>, <code>static</code>, and
<code>express-session</code>, to name a few), and we’ve even written some of our own
(for adding weather data to our template context, configuring flash
messages, and our 404 handler). But what is middleware, exactly?</p>

<p>Conceptually, <em>middleware</em> is a way to encapsulate functionality—specifically, functionality that operates on an HTTP request to your
application. Practically, middleware is
simply a function that takes three arguments: a request object, a response
object, and a <code>next()</code> function, which will be explained shortly. (There is
also a form that takes four arguments, for error handling, which will be
covered at the end of this chapter.)</p>

<p><a data-type="indexterm" data-primary="pipeline" id="idm45053589743144"/>Middleware is executed in what’s known as a <em>pipeline</em>.
You can imagine a physical pipe, carrying water. The water gets pumped in
at one end, and then there are gauges and valves before the water gets
where it’s going. The important part about this analogy is that <em>order
matters</em>; if you put a pressure gauge before a valve, it has a different
effect than if you put the pressure gauge after the valve. Similarly, if
you have a valve that injects something into the water, everything
“downstream” from that valve will contain the added ingredient. In an
Express app, you insert middleware into the pipeline by calling
<code>app.use</code>.</p>

<p><a data-type="indexterm" data-primary="routing" data-secondary="pipeline and" id="idm45053589740200"/>Prior to Express 4.0, the pipeline was complicated by your having to link in the <em>router</em>
explicitly. Depending on where you linked in the router, routes could be
linked in out of order, making the pipeline sequence less clear when you
mix middleware and route handlers. In Express 4.0, middleware and route
handlers are invoked in the order in which they were linked in, making the sequence
much clearer.</p>

<p>It’s common practice to have the last middleware in your pipeline be a
catchall handler for any request that doesn’t match any other routes.
This middleware usually returns a status code of 404 (Not Found).</p>

<p>So how is a request “terminated” in the pipeline? That’s what the <code>next</code> function passed to each middleware does:
if you <em>don’t</em> call <code>next()</code>, the request terminates with that middleware.</p>






<section data-type="sect1" data-pdf-bookmark="Middleware Principles"><div class="sect1" id="idm45053589735752">
<h1>Middleware Principles</h1>

<p><a data-type="indexterm" data-primary="middleware" data-secondary="route handlers versus" id="idm45053589734552"/><a data-type="indexterm" data-primary="route handlers" data-secondary="middleware versus" id="idm45053589733576"/>Learning how to think flexibly about middleware and route handlers is key
to understanding how Express works. Here are the things you should keep
in mind:</p>

<ul>
<li>
<p>Route handlers (<code>app.get</code>, <code>app.post</code>, etc.—often referred to
collectively as <code>app.METHOD</code>) can be
thought of as middleware that handles only a
specific HTTP verb (<code>GET</code>, <code>POST</code>, etc.). Conversely, middleware can be thought of as a route
handler that handles all HTTP verbs (this is essentially
equivalent to <code>app.all</code>, which handles any HTTP verb; there are some
minor differences with exotic verbs such as <code>PURGE</code>, but for the common
verbs, the effect is the same).</p>
</li>
<li>
<p><a data-type="indexterm" data-primary="path(s)" data-secondary="route handlers and" id="idm45053589726664"/>Route handlers require a path as their first parameter. If you want that
path to match any route, simply use <code>\*</code>. Middleware can also take a
path as its first parameter, but it is optional (if it is omitted, it
will match any path, as if you had specified <code>*</code>).</p>
</li>
<li>
<p><a data-type="indexterm" data-primary="callback function" id="idm45053589723704"/>Route handlers and middleware take a callback function that takes two,
three, or four parameters (technically, you could also have zero or one
parameters, but there is no sensible use for these forms). If there are
two or three parameters, the first two parameters are the request and
response objects, and the third parameter is the <code>next</code> function. <a data-type="indexterm" data-primary="errorhandler middleware" id="idm45053589722136"/>If
there are four parameters, it becomes <em>error-handling</em>
middleware, and the first parameter
becomes an error object, followed by the request, response, and next
objects.</p>
</li>
<li>
<p><a data-type="indexterm" data-primary="next() function" id="idm45053589719960"/>If you <em>don’t</em> call <code>next()</code>, the pipeline will be terminated, and no more
route handlers or middleware will be processed.  If you don’t call
<code>next()</code>, you should send a response to the client (<code>res.send</code>,
<code>res.json</code>, <code>res.render</code>, etc.); if you don’t, the client will hang and
eventually time out.</p>
</li>
<li>
<p>If you <em>do</em> call <code>next()</code>, it’s generally inadvisable to send a response to
the client. If you do, middleware or route handlers further down the
pipeline will be executed, but any client responses they send will be
ignored.</p>
</li>
</ul>
</div></section>













<section data-type="sect1" class="pagebreak-before" data-pdf-bookmark="Middleware Examples"><div class="sect1" id="idm45053589713880">
<h1>Middleware Examples</h1>

<p>If you want to see this in action, let’s try some really simple middleware
(<em>ch10/00-simple-middleware.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`processing request for </code><code class="si">${</code><code class="nx">req</code><code class="p">.</code><code class="nx">url</code><code class="si">}</code><code class="sb">....`</code><code class="p">)</code>
  <code class="nx">next</code><code class="p">()</code>
<code class="p">})</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'terminating request'</code><code class="p">)</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'thanks for playing!'</code><code class="p">)</code>
  <code class="c1">// note that we do NOT call next() here...this terminates the request</code>
<code class="p">})</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`whoops, i'll never get called!`</code><code class="p">)</code>
<code class="p">})</code></pre>

<p>Here we have three examples of middleware. The first one simply logs a message to the
console before passing on the request to the next middleware in the
pipeline by calling <code>next()</code>. Then the next middleware actually handles
the request. Note that if we omitted the <code>res.send</code> here, no response would ever be returned to the client. Eventually,
the client would time out. The last middleware will never execute, because
all requests are terminated in the prior middleware.</p>

<p>Now let’s consider a more complicated, complete example
(<em>ch10/01-routing-example.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">()</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'\n\nALLWAYS'</code><code class="p">)</code>
  <code class="nx">next</code><code class="p">()</code>
<code class="p">})</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/a'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'/a: route terminated'</code><code class="p">)</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'a'</code><code class="p">)</code>
<code class="p">})</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/a'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'/a: never called'</code><code class="p">);</code>
<code class="p">})</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/b'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'/b: route not terminated'</code><code class="p">)</code>
  <code class="nx">next</code><code class="p">()</code>
<code class="p">})</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'SOMETIMES'</code><code class="p">)</code>
  <code class="nx">next</code><code class="p">()</code>
<code class="p">})</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/b'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'/b (part 2): error thrown'</code> <code class="p">)</code>
  <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'b failed'</code><code class="p">)</code>
<code class="p">})</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="s1">'/b'</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'/b error detected and passed on'</code><code class="p">)</code>
  <code class="nx">next</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code>
<code class="p">})</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/c'</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'/c: error thrown'</code><code class="p">)</code>
  <code class="k">throw</code> <code class="k">new</code> <code class="nb">Error</code><code class="p">(</code><code class="s1">'c failed'</code><code class="p">)</code>
<code class="p">})</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="s1">'/c'</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'/c: error detected but not passed on'</code><code class="p">)</code>
  <code class="nx">next</code><code class="p">()</code>
<code class="p">})</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">((</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'unhandled error detected: '</code> <code class="o">+</code> <code class="nx">err</code><code class="p">.</code><code class="nx">message</code><code class="p">)</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'500 - server error'</code><code class="p">)</code>
<code class="p">})</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'route not handled'</code><code class="p">)</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'404 - not found'</code><code class="p">)</code>
<code class="p">})</code>

<code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code> <code class="sb">`Express started on http://localhost:</code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">`</code> <code class="o">+</code>
  <code class="s1">'; press Ctrl-C to terminate.'</code><code class="p">))</code></pre>

<p>Before trying this example, imagine what the result will be. What
are the different routes? What will the client see? What will be printed
on the console? If you can correctly answer all of those questions,
you’ve got the hang of routes in Express! Pay particular attention to the
difference between a request to <em>/b</em> and a request to <em>/c</em>; in both
instances, there was an error, but one results in a 404, and the other
results in a 500.</p>

<p>Note that middleware <em>must</em> be a function. Keep in mind that in JavaScript, it’s quite easy (and
common) to return a function from a function. For example, you’ll note
that <code>express.static</code> is a function, but we actually invoke it, so it must
return another function. Consider the following:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">)</code>         <code class="c1">// this will NOT work as expected</code>

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">())</code>   <code class="c1">// will log "function", indicating</code>
                                <code class="c1">// that express.static is a function</code>
                                <code class="c1">// that itself returns a function</code></pre>

<p>Note also that a module can export a function, which can in turn be used
directly as middleware.
For example, here’s a module called <em>lib/tourRequiresWaiver.js</em>
(Meadowlark Travel’s rock-climbing packages require a liability waiver):</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code><code class="nx">res</code><code class="p">,</code><code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">cart</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code>
  <code class="k">if</code><code class="p">(</code><code class="o">!</code><code class="nx">cart</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">()</code>
  <code class="k">if</code><code class="p">(</code><code class="nx">cart</code><code class="p">.</code><code class="nx">items</code><code class="p">.</code><code class="nx">some</code><code class="p">(</code><code class="nx">item</code> <code class="o">=&gt;</code> <code class="nx">item</code><code class="p">.</code><code class="nx">product</code><code class="p">.</code><code class="nx">requiresWaiver</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">cart</code><code class="p">.</code><code class="nx">warnings</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="s1">'One or more of your selected '</code> <code class="o">+</code>
      <code class="s1">'tours requires a waiver.'</code><code class="p">)</code>
  <code class="p">}</code>
  <code class="nx">next</code><code class="p">()</code>
<code class="p">}</code></pre>

<p>We could link this middleware in like so (<em>ch10/02-item-waiver.example.js</em>
in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">requiresWaiver</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./lib/tourRequiresWaiver'</code><code class="p">)</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">requiresWaiver</code><code class="p">)</code></pre>

<p>More commonly, though, you would export an object that contains properties
that are middleware. For example, let’s put all of our shopping cart validation
code in <em>lib/cartValidation.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>

  <code class="nx">resetValidation</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code> <code class="nx">cart</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code>
    <code class="k">if</code><code class="p">(</code><code class="nx">cart</code><code class="p">)</code> <code class="nx">cart</code><code class="p">.</code><code class="nx">warnings</code> <code class="o">=</code> <code class="nx">cart</code><code class="p">.</code><code class="nx">errors</code> <code class="o">=</code> <code class="p">[]</code>
    <code class="nx">next</code><code class="p">()</code>
  <code class="p">},</code>

  <code class="nx">checkWaivers</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code> <code class="nx">cart</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code>
    <code class="k">if</code><code class="p">(</code><code class="o">!</code><code class="nx">cart</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">()</code>
    <code class="k">if</code><code class="p">(</code><code class="nx">cart</code><code class="p">.</code><code class="nx">items</code><code class="p">.</code><code class="nx">some</code><code class="p">(</code><code class="nx">item</code> <code class="o">=&gt;</code> <code class="nx">item</code><code class="p">.</code><code class="nx">product</code><code class="p">.</code><code class="nx">requiresWaiver</code><code class="p">))</code> <code class="p">{</code>
      <code class="nx">cart</code><code class="p">.</code><code class="nx">warnings</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="s1">'One or more of your selected '</code> <code class="o">+</code>
        <code class="s1">'tours requires a waiver.'</code><code class="p">)</code>
    <code class="p">}</code>
    <code class="nx">next</code><code class="p">()</code>
  <code class="p">},</code>

  <code class="nx">checkGuestCounts</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code> <code class="nx">cart</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code>
    <code class="k">if</code><code class="p">(</code><code class="o">!</code><code class="nx">cart</code><code class="p">)</code> <code class="k">return</code> <code class="nx">next</code><code class="p">()</code>
    <code class="k">if</code><code class="p">(</code><code class="nx">cart</code><code class="p">.</code><code class="nx">items</code><code class="p">.</code><code class="nx">some</code><code class="p">(</code><code class="nx">item</code> <code class="o">=&gt;</code> <code class="nx">item</code><code class="p">.</code><code class="nx">guests</code> <code class="o">&gt;</code> <code class="nx">item</code><code class="p">.</code><code class="nx">product</code><code class="p">.</code><code class="nx">maxGuests</code> <code class="p">))</code> <code class="p">{</code>
      <code class="nx">cart</code><code class="p">.</code><code class="nx">errors</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="s1">'One or more of your selected tours '</code> <code class="o">+</code>
        <code class="s1">'cannot accommodate the number of guests you '</code> <code class="o">+</code>
        <code class="s1">'have selected.'</code><code class="p">)</code>
    <code class="p">}</code>
    <code class="nx">next</code><code class="p">()</code>
  <code class="p">},</code>

<code class="p">}</code></pre>

<p>Then you could link the middleware in like this
(<em>ch10/03-more-cart-validation.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">cartValidation</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./lib/cartValidation'</code><code class="p">)</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">cartValidation</code><code class="p">.</code><code class="nx">resetValidation</code><code class="p">)</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">cartValidation</code><code class="p">.</code><code class="nx">checkWaivers</code><code class="p">)</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">cartValidation</code><code class="p">.</code><code class="nx">checkGuestCounts</code><code class="p">)</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>In the previous example, we have middleware aborting early with the
statement <code>return next()</code>. Express doesn’t expect middleware to return a
value (and it doesn’t do anything with any return values), so this is just
a shortened way of writing <code>next(); return</code>.</p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Common Middleware"><div class="sect1" id="idm45053589713256">
<h1>Common Middleware</h1>

<p><a data-type="indexterm" data-primary="middleware" data-secondary="common projects" id="ix_ch-10-middleware-asciidoc1"/>While there are thousands of middleware projects on npm, there are a
handful that are common and fundamental, and at least some of these will
be found in every non-trivial Express project. Some of this middleware
was so common that it was actually bundled with Express, but it has long
since been moved into individual packages. The only middleware
still bundled with Express itself is <code>static</code>.</p>

<p>This list attempts to cover the most common middleware:</p>
<dl>
<dt><code>basicauth-middleware</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="basicauth-middleware" id="idm45053588622840"/>Provides basic access authorization. Keep in mind that basic auth offers
only the most basic security, and you should use basic auth <em>only</em> over HTTPS (otherwise, usernames and passwords
are transmitted in the clear). You should use basic auth only when you
need something quick and easy <em>and</em> you’re using HTTPS.</p>
</dd>
<dt><code>body-parser</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="body-parser middleware" id="idm45053588619400"/>Provides parsing for HTTP request bodies. Provides middleware for parsing
both URL-encoded and JSON-encoded bodies, as well as others.</p>
</dd>
<dt><code>busboy</code>, <code>multiparty</code>, <code>formidable</code>, <code>multer</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="multiparty middleware" id="idm45053588615640"/>All of these middleware options parse request bodies encoded with
<code>multipart/form-data</code>.</p>
</dd>
<dt><code>compression</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="compression middleware" id="idm45053588612920"/><a data-type="indexterm" data-primary="cookie-parser middleware" id="idm45053588612184"/>Compresses response data with gzip or deflate. This is a good thing, and
your users will thank you, especially those on slow or mobile connections.
It should be linked in early, before any middleware that might send a
response. The only thing that I recommend linking in before <code>compress</code> is
debugging or logging middleware (which do not send responses). Note that
in most production environments, compression is handled by a proxy like
NGINX, making this middleware unnecessary.</p>
</dd>
<dt><code>cookie-parser</code></dt>
<dd>
<p>  Provides cookie support. See
<a data-type="xref" href="ch09.xhtml#ch_cookies_and_sessions">Chapter 9</a>.</p>
</dd>
<dt><code>cookie-session</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="cookie-session middleware" id="idm45053588606856"/>Provides cookie-storage session support.
I do not generally recommend this approach to sessions. It must be linked in
after <code>cookie-parser</code>. See <a data-type="xref" href="ch09.xhtml#ch_cookies_and_sessions">Chapter 9</a>.</p>
</dd>
<dt><code>express-session</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="express-session middleware" id="idm45053588603176"/>Provides session ID (stored in a cookie) session
support. Defaults to a memory store,
which is not suitable for production and can be configured to use a
database store. See <a data-type="xref" href="ch09.xhtml#ch_cookies_and_sessions">Chapter 9</a> and
<a data-type="xref" href="ch13.xhtml#ch_persistence">Chapter 13</a>.</p>
</dd>
<dt><code>csurf</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="cross-site request forgery (CSRF)" id="idm45053588599016"/><a data-type="indexterm" data-primary="csurf middleware" id="idm45053588598264"/>Provides protection against cross-site request forgery (CSRF)
attacks. This uses sessions, so it must be linked in after
<code>express-session</code> middleware. Unfortunately, simply linking in this middleware does not magically protect against CSRF attacks; see <a data-type="xref" href="ch18.xhtml#ch_security">Chapter 18</a> for
more information.</p>
</dd>
<dt><code>serve-index</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="serve-index middleware" id="idm45053588712776"/>Provides directory listing support for static files. There is no need to include this middleware unless you
specifically need directory listing.</p>
</dd>
<dt><code>errorhandler</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="errorhandler middleware" id="idm45053588710344"/>Provides stack traces and error messages to the client. I do not recommend linking this in on a production server,
as it exposes implementation details, which can have security or privacy
consequences. See <a data-type="xref" href="ch20.xhtml#ch_debugging">Chapter 20</a> for more information.</p>
</dd>
<dt><code>serve-favicon</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="serve-favicon middleware" id="idm45053588707016"/>Serves the <em>favicon</em> (the icon that appears in the title bar of your
browser). This is not strictly necessary;
you can simply put a <em>favicon.ico</em> in the root of your static directory,
but this middleware can improve performance. If you use it, it should be
linked in high in the middleware stack. It also allows you to
designate a filename other than <em>favicon.ico</em>.</p>
</dd>
<dt><code>morgan</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="morgan middleware" id="idm45053588703064"/>Provides automated logging support; all requests will be
logged.  See <a data-type="xref" href="ch20.xhtml#ch_debugging">Chapter 20</a> for more
information.</p>
</dd>
<dt><code>method-override</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="method-override middleware" id="idm45053588699960"/>Provides support for the <code>x-http-method-override</code> request header, which
allows browsers to “fake” using HTTP methods other than <code>GET</code> and
<code>POST</code>. This can be useful for debugging. This is needed only if you’re
writing APIs.</p>
</dd>
<dt><code>response-time</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="response-time middleware" id="idm45053588696296"/>Adds the <code>X-Response-Time</code> header to the response, providing the response time in milliseconds. You usually
don’t need this middleware unless you are doing performance tuning.</p>
</dd>
<dt><code>static</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="static middleware" id="idm45053588693256"/>Provides support for serving static (public) files. You can link in this middleware multiple times, specifying
different directories. See <a data-type="xref" href="ch17.xhtml#ch_static_content">Chapter 17</a> for more details.</p>
</dd>
<dt><code>vhost</code></dt>
<dd>
<p>  <a data-type="indexterm" data-primary="vhost middleware" id="idm45053588689992"/>Virtual hosts (vhosts), a term borrowed from
Apache, makes subdomains easier to manage in Express. See <a data-type="xref" href="ch14.xhtml#ch_routing">Chapter 14</a>
for more information.<a data-type="indexterm" data-startref="ix_ch-10-middleware-asciidoc1" id="idm45053588688216"/></p>
</dd>
</dl>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Third-Party Middleware"><div class="sect1" id="idm45053588623976">
<h1>Third-Party Middleware</h1>

<p><a data-type="indexterm" data-primary="middleware" data-secondary="third-party" id="idm45053588686472"/>Currently, there is no comprehensive “store” or index for third-party
middleware. Almost all Express
middleware, however, will be available on npm, so if you search npm for
“Express” and “middleware,” you’ll get a pretty good list. The official
Express documentation also contains a useful
<a href="http://bit.ly/36UrbnL">list of middleware</a>.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="idm45053588684136">
<h1>Conclusion</h1>

<p>In this chapter, we delved into what middleware is, how to write our own,
and how it’s processed as part of an Express application. If you’re
starting to think that an Express application is simply a collection of
middleware, you’re starting to understand Express! Even the route handlers
we’ve been using heretofore are just specialized cases of middleware.</p>

<p>In the next chapter, we’ll be looking at another common infrastructure
need: sending email (and you had better believe there is going to be some
middleware involved!).<a data-type="indexterm" data-startref="ix_ch-10-middleware-asciidoc0" id="idm45053588681784"/></p>
</div></section>







</div></section></div>



  </body></html>