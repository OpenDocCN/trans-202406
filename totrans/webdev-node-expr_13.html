<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 13. Persistence"><div class="chapter" id="ch_persistence">
<h1><span class="label">Chapter 13. </span>Persistence</h1>


<p><a data-type="indexterm" data-primary="persistence" id="ix_ch-13-persistence-asciidoc0"/>All but the simplest websites and web applications are going to require
<em>persistence</em> of some kind; that is, some way to store data
that’s more
permanent than volatile memory so that your data will survive server
crashes, power outages, upgrades, and relocations. In this chapter, we’ll
be discussing the options available for persistence and demonstrating both
document databases and relational databases. Before we jump in to
databases, however, we’ll start with the most basic form of persistence:
filesystem persistence.</p>






<section data-type="sect1" data-pdf-bookmark="Filesystem Persistence"><div class="sect1" id="idm45053586181432">
<h1>Filesystem Persistence</h1>

<p><a data-type="indexterm" data-primary="filesystem persistence" id="ix_ch-13-persistence-asciidoc1"/><a data-type="indexterm" data-primary="persistence" data-secondary="filesystem" id="ix_ch-13-persistence-asciidoc2"/>One way to achieve <a data-type="indexterm" data-primary="flat files" id="idm45053586177528"/>persistence is to simply save data to so-called flat
files (<em>flat</em> because there’s no inherent structure in a file; it’s just a
sequence of bytes). Node makes filesystem
persistence possible through the <code>fs</code> (filesystem) module.</p>

<p>Filesystem persistence has some drawbacks. In particular, it doesn’t scale
well. The minute you need more than one server to meet traffic demands, you
will run into problems with filesystem persistence, unless all of your
servers have access to a shared filesystem. Also, because flat files have
no inherent structure, the burden of locating, sorting, and filtering data
will be on your application. <a data-type="indexterm" data-primary="databases" data-secondary="file systems versus" id="idm45053586174872"/>For these reasons, you should favor databases
over filesystems for storing data. <a data-type="indexterm" data-primary="binary files" data-secondary="storage of" id="idm45053586173768"/>The one exception is storing binary
files, such as images, audio files, or videos. While many databases can
handle this type of data, they rarely do so more efficiently than a
filesystem (though information <em>about</em> the binary files is usually stored
in a database to enable searching, sorting, and filtering).</p>

<p>If you do need to store binary data, keep in mind that filesystem storage
still has the problem of not scaling well. If your hosting doesn’t have access to a shared
filesystem (which is usually the case), you should consider storing binary
files in a database (which usually requires some configuration so the
database doesn’t grind to a stop) or a cloud-based storage service, like
Amazon S3 or Microsoft Azure Storage.</p>

<p>Now that we have the caveats out of the way, let’s look at Node’s
filesystem support. We’ll revisit the vacation photo contest from
<a data-type="xref" href="ch08.xhtml#ch_form_handling">Chapter 8</a>. In our application file, let’s fill in the handler
that processes that form (<em>ch13/00-mongodb/lib/handlers.js</em> in the
companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">pathUtils</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'path'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">)</code>

<code class="c1">// create directory to store vacation photos (if it doesn't already exist)</code>
<code class="kr">const</code> <code class="nx">dataDir</code> <code class="o">=</code> <code class="nx">pathUtils</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'..'</code><code class="p">,</code> <code class="s1">'data'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">vacationPhotosDir</code> <code class="o">=</code> <code class="nx">pathUtils</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">dataDir</code><code class="p">,</code> <code class="s1">'vacation-photos'</code><code class="p">)</code>
<code class="k">if</code><code class="p">(</code><code class="o">!</code><code class="nx">fs</code><code class="p">.</code><code class="nx">existsSync</code><code class="p">(</code><code class="nx">dataDir</code><code class="p">))</code> <code class="nx">fs</code><code class="p">.</code><code class="nx">mkdirSync</code><code class="p">(</code><code class="nx">dataDir</code><code class="p">)</code>
<code class="k">if</code><code class="p">(</code><code class="o">!</code><code class="nx">fs</code><code class="p">.</code><code class="nx">existsSync</code><code class="p">(</code><code class="nx">vacationPhotosDir</code><code class="p">))</code> <code class="nx">fs</code><code class="p">.</code><code class="nx">mkdirSync</code><code class="p">(</code><code class="nx">vacationPhotosDir</code><code class="p">)</code>

<code class="kd">function</code> <code class="nx">saveContestEntry</code><code class="p">(</code><code class="nx">contestName</code><code class="p">,</code> <code class="nx">email</code><code class="p">,</code> <code class="nx">year</code><code class="p">,</code> <code class="nx">month</code><code class="p">,</code> <code class="nx">photoPath</code><code class="p">)</code> <code class="p">{</code>
  <code class="c1">// TODO...this will come later</code>
<code class="p">}</code>

<code class="c1">// we'll want these promise-based versions of fs functions later</code>
<code class="kr">const</code> <code class="p">{</code> <code class="nx">promisify</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'util'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">mkdir</code> <code class="o">=</code> <code class="nx">promisify</code><code class="p">(</code><code class="nx">fs</code><code class="p">.</code><code class="nx">mkdir</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">rename</code> <code class="o">=</code> <code class="nx">promisify</code><code class="p">(</code><code class="nx">fs</code><code class="p">.</code><code class="nx">rename</code><code class="p">)</code>

<code class="nx">exports</code><code class="p">.</code><code class="nx">api</code><code class="p">.</code><code class="nx">vacationPhotoContest</code> <code class="o">=</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">fields</code><code class="p">,</code> <code class="nx">files</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">photo</code> <code class="o">=</code> <code class="nx">files</code><code class="p">.</code><code class="nx">photo</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code>
  <code class="kr">const</code> <code class="nx">dir</code> <code class="o">=</code> <code class="nx">vacationPhotosDir</code> <code class="o">+</code> <code class="s1">'/'</code> <code class="o">+</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">now</code><code class="p">()</code>
  <code class="kr">const</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">dir</code> <code class="o">+</code> <code class="s1">'/'</code> <code class="o">+</code> <code class="nx">photo</code><code class="p">.</code><code class="nx">originalFilename</code>
  <code class="nx">await</code> <code class="nx">mkdir</code><code class="p">(</code><code class="nx">dir</code><code class="p">)</code>
  <code class="nx">await</code> <code class="nx">rename</code><code class="p">(</code><code class="nx">photo</code><code class="p">.</code><code class="nx">path</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
  <code class="nx">saveContestEntry</code><code class="p">(</code><code class="s1">'vacation-photo'</code><code class="p">,</code> <code class="nx">fields</code><code class="p">.</code><code class="nx">email</code><code class="p">,</code>
    <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">year</code><code class="p">,</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">month</code><code class="p">,</code> <code class="nx">path</code><code class="p">)</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">({</code> <code class="nx">result</code><code class="o">:</code> <code class="s1">'success'</code> <code class="p">})</code>
<code class="p">}</code></pre>

<p>There’s a lot going on there, so let’s break it down. We first create a
directory to store the uploaded files (if it doesn’t already
exist). You’ll probably want to add the <em>data</em> directory to your
<em>.gitignore</em> file so you don’t accidentally commit uploaded files. Recall
from <a data-type="xref" href="ch08.xhtml#ch_form_handling">Chapter 8</a> that we’re handling the actual file upload in
<em>meadowlark.js</em> and calling our handler with the files already decoded.
What we get is an object (<code>files</code>) that contains the information about the
uploaded files. Since we want to prevent collisions, we can’t
just use the filename the user uploaded (in case two users both upload
<em>portland.jpg</em>). To avoid this problem, we create a unique directory
based on the timestamp; it’s pretty unlikely that two users will both
upload <em>portland.jpg</em> in the same millisecond! Then we rename (move) the
uploaded file (our file processor will have given it a temporary name,
which we can get from the <code>path</code> property) to our constructed name.</p>

<p>Finally, we need some way to associate the files that users upload with
their email addresses (and the month and year of the submission). We could
encode this information into the file or directory names, but we are going
to prefer storing this information in a database. Since we haven’t learned
how to do that yet, we’re going to encapsulate that functionality in the
<code>vacationPhotoContest</code> function and complete that function later in this
chapter.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>In general, you should never trust anything that the user uploads because it’s a
possible vector for your website to be attacked. For example, a malicious user could easily take a harmful
executable, rename it with a <em>.jpg</em> extension, and upload it as the first
step in an attack (hoping to find some way to execute it at a later point).
Likewise, we are taking a little risk here by naming the file using the
<code>name</code> property <span class="keep-together">provided</span> by the
browser; someone could also abuse this by inserting special characters into
the filename. To make this code completely safe, we would give the file a
random name, taking only the extension (making sure it consists only of
alphanumeric characters).</p>
</div>

<p>Even though filesystem persistence has its drawbacks, it’s frequently used
for intermediate file storage, and it’s useful to know how to use the Node
filesystem library. However, to address the deficiencies of filesystem
storage, let’s turn our attention to cloud persistence.<a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc2" id="idm45053585936120"/><a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc1" id="idm45053585935400"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Cloud Persistence"><div class="sect1" id="idm45053586180808">
<h1>Cloud Persistence</h1>

<p><a data-type="indexterm" data-primary="cloud storage" id="idm45053585933272"/><a data-type="indexterm" data-primary="persistence" data-secondary="cloud storage" id="idm45053585932568"/>Cloud storage is becoming increasingly popular, and I highly recommend you
take advantage of one of these inexpensive, robust services.</p>

<p>When using cloud services, there’s a certain amount of up-front work you
have to do. Obviously, you have to create an account, but you also have to
understand how your application authenticates with the cloud service, and
it’s also helpful to understand some basic terminology (for example, AWS
calls its file storage mechanism <em>buckets</em>, while Azure calls them
<em>containers</em>). It’s beyond the scope of this book to detail all of that
information, and it is well-documented:</p>

<ul>
<li>
<p><a href="https://amzn.to/2CCYk9s">AWS: Getting Started in Node.js</a></p>
</li>
<li>
<p><a href="http://bit.ly/2NEkTku">Azure for JavaScript and Node.js Developers</a></p>
</li>
</ul>

<p>The good news is that once you get past this initial configuration, using
cloud persistence is quite easy. <a data-type="indexterm" data-primary="Amazon" data-secondary="S3" id="idm45053585926152"/><a data-type="indexterm" data-primary="S3" id="idm45053585925176"/>Here’s an example of how easy it is to
save a file to an Amazon S3 account:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">filename</code> <code class="o">=</code> <code class="s1">'customerUpload.jpg'</code>

<code class="nx">s3</code><code class="p">.</code><code class="nx">putObject</code><code class="p">({</code>
  <code class="nx">Bucket</code><code class="o">:</code> <code class="s1">'uploads'</code><code class="p">,</code>
  <code class="nx">Key</code><code class="o">:</code> <code class="nx">filename</code><code class="p">,</code>
  <code class="nx">Body</code><code class="o">:</code> <code class="nx">fs</code><code class="p">.</code><code class="nx">readFileSync</code><code class="p">(</code><code class="nx">__dirname</code> <code class="o">+</code> <code class="err">'</code><code class="o">/</code><code class="nx">tmp</code><code class="o">/</code> <code class="o">+</code> <code class="nx">filename</code><code class="p">),</code>
<code class="p">})</code></pre>

<p>See the <a href="https://amzn.to/2O3e1MA">AWS SDK documentation</a> for more
<span class="keep-together">information</span>.</p>

<p><a data-type="indexterm" data-primary="Azure" id="idm45053585813624"/><a data-type="indexterm" data-primary="Microsoft Azure" id="idm45053585812920"/>Here’s an example of how to do the same thing with Microsoft Azure:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">filename</code> <code class="o">=</code> <code class="s1">'customerUpload.jpg'</code>

<code class="kr">const</code> <code class="nx">blobService</code> <code class="o">=</code> <code class="nx">azure</code><code class="p">.</code><code class="nx">createBlobService</code><code class="p">()</code>
<code class="nx">blobService</code><code class="p">.</code><code class="nx">createBlockBlobFromFile</code><code class="p">(</code><code class="s1">'uploads'</code><code class="p">,</code> <code class="nx">filename</code><code class="p">,</code> <code class="nx">__dirname</code> <code class="o">+</code>
  <code class="s1">'/tmp/'</code> <code class="o">+</code> <code class="nx">filename</code><code class="p">)</code></pre>

<p>See the <a href="http://bit.ly/2Kd3rRK">Microsoft Azure
documentation</a> for more information.</p>

<p>Now that we know a couple of techniques for file storage,
let’s consider the storage of structured data with databases.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Database Persistence"><div class="sect1" id="idm45053585934120">
<h1>Database Persistence</h1>

<p><a data-type="indexterm" data-primary="databases" data-secondary="persistence" id="ix_ch-13-persistence-asciidoc3"/><a data-type="indexterm" data-primary="persistence" data-secondary="database persistence" data-seealso="database" id="ix_ch-13-persistence-asciidoc4"/>All except the simplest websites and web applications require a
database. Even
if the bulk of your data is binary and you’re using a shared filesystem or
cloud storage, the chances are you’ll want a database to help catalog that
binary data.</p>

<p><a data-type="indexterm" data-primary="RDBMS (relational database management system)" id="idm45053585895192"/><a data-type="indexterm" data-primary="relational database management system (RDBMS)" id="idm45053585894456"/>Traditionally, the word <em>database</em> is shorthand
 for <em>relational database management system</em>
(RDBMS). Relational databases, such as Oracle,
MySQL, PostgreSQL, or SQL Server, are based on decades of research and formal
database theory. It is a technology that is quite mature at this point, and
the power of these databases is unquestionable. However, we now have the
luxury of expanding our ideas of what constitutes a database. <a data-type="indexterm" data-primary="NoSQL databases" id="idm45053585892440"/>NoSQL
databases have come into vogue in recent years, and they’re challenging the
status quo of internet data storage.</p>

<p>It would be foolish to claim that NoSQL databases are somehow better than
relational databases, but they do have certain advantages (and vice versa).
While it is quite easy to integrate a relational database with Node apps,
there are NoSQL databases that seem almost to have been designed for Node.</p>

<p><a data-type="indexterm" data-primary="document databases" id="idm45053585890504"/><a data-type="indexterm" data-primary="key-value databases" id="idm45053585889800"/>The two most popular types of NoSQL databases are <em>document databases</em> and
<em class="keep-together">key-value</em> databases. Document
databases excel at storing objects,
 which makes them a natural fit for Node and JavaScript.
Key-value databases, as the name implies, are extremely simple and are a
great choice for applications with data schemas that are easily mapped into
key-value pairs.</p>

<p>I feel that document databases represent the optimal compromise between the
constraints of relational databases and the simplicity of key-value
databases, and for that reason, we will be using a document database for
our first example. MongoDB is the leading document
database and is robust and established at this point.</p>

<p>For our second example, we’ll be using PostgreSQL, a popular and robust
open source RDBMS.</p>








<section data-type="sect2" data-pdf-bookmark="A Note on Performance"><div class="sect2" id="idm45053585886200">
<h2>A Note on Performance</h2>

<p><a data-type="indexterm" data-primary="databases" data-secondary="optimization of NoSQL databases" id="idm45053585885000"/><a data-type="indexterm" data-primary="performance optimization" data-secondary="NoSQL databases" id="idm45053585883960"/>The simplicity of NoSQL databases is a double-edged sword. Carefully planning a
relational database can be an involved task, but the benefit of that
careful planning is a database that offers excellent performance. Don’t be
fooled into thinking that because NoSQL databases are generally simpler, there isn’t an art and a science to tuning them for maximum
performance.</p>

<p>Relational databases have traditionally relied on their rigid data
structures and decades of optimization research to achieve high
performance. NoSQL databases, on the other hand, have embraced the
distributed nature of the internet and, like Node, have instead focused on
concurrency to scale performance (relational databases also support
concurrency, but this is usually reserved for the most demanding
applications).</p>

<p>Planning for database performance and scalability is a large, complex topic
that is <span class="keep-together">beyond</span> the scope of this
book. If your application requires a high level of database performance, I
recommend starting with Kristina Chodorow and Michael Dirolf’s <em><a class="orm:hideurl" href="http://bit.ly/Mongo_DB_Guide">MongoDB: The
Definitive Guide</a></em> (O’Reilly).</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Abstracting the Database Layer"><div class="sect2" id="idm45053585879000">
<h2>Abstracting the Database Layer</h2>

<p><a data-type="indexterm" data-primary="abstracting of database layer" id="ix_ch-13-persistence-asciidoc5"/><a data-type="indexterm" data-primary="databases" data-secondary="abstracting the database layer" id="ix_ch-13-persistence-asciidoc6"/>In this book, we’ll be implementing the same features and demonstrating how
to do that with two databases (and not just two databases but two
substantially different database architectures). While the objective in
this book is to cover two popular options for database architecture, it
reflects a real-world scenario: switching a major component of your web
application midproject. This could happen for many reasons. Usually it boils
down to discovering that a different technology is going to be more
cost-effective or allow you to implement necessary features more quickly.</p>

<p>Whenever possible, there is value in <em>abstracting</em> your technology choices,
which refers to writing some kind of API layer to generalize the underlying
technology choices. If done right, it reduces the cost of switching out the
component in question. However, it comes at a cost: writing the abstraction
layer is one more thing you have to write and maintain.</p>

<p>Happily, our abstraction layer will be very small, as we’re supporting only a
handful of features for the purposes of this book. For now, the features will
be as follows:</p>

<ul>
<li>
<p>Returning a list of active vacations from the database</p>
</li>
<li>
<p>Storing the email address of users who want to be notified when certain vacations are in season</p>
</li>
</ul>

<p>While this seems simple enough, there are a lot of details here. What does a
vacation look like? Do we always want to get all the vacations from the
database, or do we want to be able to filter them or paginate them? How do
we identify vacations? And so on.</p>

<p>We’re going to keep our abstraction layer simple for the purposes of this
book. We’ll contain it in a file called <em>db.js</em> that will export two methods
that we’ll start by just providing dummy implementations:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">getVacations</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">options</code> <code class="o">=</code> <code class="p">{})</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// let's fake some vacation data:</code>
    <code class="kr">const</code> <code class="nx">vacations</code> <code class="o">=</code> <code class="p">[</code>
      <code class="p">{</code>
        <code class="nx">name</code><code class="o">:</code> <code class="s1">'Hood River Day Trip'</code><code class="p">,</code>
        <code class="nx">slug</code><code class="o">:</code> <code class="s1">'hood-river-day-trip'</code><code class="p">,</code>
        <code class="nx">category</code><code class="o">:</code> <code class="s1">'Day Trip'</code><code class="p">,</code>
        <code class="nx">sku</code><code class="o">:</code> <code class="s1">'HR199'</code><code class="p">,</code>
        <code class="nx">description</code><code class="o">:</code> <code class="s1">'Spend a day sailing on the Columbia and '</code> <code class="o">+</code>
          <code class="s1">'enjoying craft beers in Hood River!'</code><code class="p">,</code>
        <code class="nx">location</code><code class="o">:</code> <code class="p">{</code>
          <code class="c1">// we'll use this for geocoding later in the book</code>
          <code class="nx">search</code><code class="o">:</code> <code class="s1">'Hood River, Oregon, USA'</code><code class="p">,</code>
        <code class="p">},</code>
        <code class="nx">price</code><code class="o">:</code> <code class="mf">99.95</code><code class="p">,</code>
        <code class="nx">tags</code><code class="o">:</code> <code class="p">[</code><code class="s1">'day trip'</code><code class="p">,</code> <code class="s1">'hood river'</code><code class="p">,</code> <code class="s1">'sailing'</code><code class="p">,</code> <code class="s1">'windsurfing'</code><code class="p">,</code> <code class="s1">'breweries'</code><code class="p">],</code>
        <code class="nx">inSeason</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
        <code class="nx">maximumGuests</code><code class="o">:</code> <code class="mi">16</code><code class="p">,</code>
        <code class="nx">available</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
        <code class="nx">packagesSold</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="p">}</code>
    <code class="p">]</code>
    <code class="c1">// if the "available" option is specified, return only vacations that match</code>
    <code class="k">if</code><code class="p">(</code><code class="nx">options</code><code class="p">.</code><code class="nx">available</code> <code class="o">!==</code> <code class="kc">undefined</code><code class="p">)</code>
      <code class="k">return</code> <code class="nx">vacations</code><code class="p">.</code><code class="nx">filter</code><code class="p">(({</code> <code class="nx">available</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="nx">available</code> <code class="o">===</code> <code class="nx">options</code><code class="p">.</code><code class="nx">available</code><code class="p">)</code>
    <code class="k">return</code> <code class="nx">vacations</code>
  <code class="p">},</code>
  <code class="nx">addVacationInSeasonListener</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">email</code><code class="p">,</code> <code class="nx">sku</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// we'll just pretend we did this...since this is</code>
    <code class="c1">// an async function, a new promise will automatically</code>
    <code class="c1">// be returned that simply resolves to undefined</code>
  <code class="p">},</code>
<code class="p">}</code></pre>

<p>This sets an expectation about how our database implementation should look to
the application…and all we have to do is make our databases conform to that
interface. Note that we’re introducing the concept of vacation
“availability”; we’re doing this so we can easily disable vacations
temporarily instead of deleting them from the database. An example use case
for this would be a bed and breakfast that contacts you to let you know they
are closed for several months for remodeling. We’re keeping this separate
from the concept of being “in season” because we may want to list
out-of-season vacations on the website because people like to plan in
advance.</p>

<p>We also include some very generic “location” information; we’ll be getting more specific about this in <a data-type="xref" href="ch19.xhtml#ch_integrating_with_third_party_rest_apis">Chapter 19</a>.</p>

<p>Now that we have an abstraction foundation for our database layer, let’s look
at how we can implement database storage with MongoDB.<a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc6" id="idm45053585554840"/><a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc5" id="idm45053585554168"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Setting Up MongoDB"><div class="sect2" id="idm45053585878408">
<h2>Setting Up MongoDB</h2>

<p><a data-type="indexterm" data-primary="databases" data-secondary="MongoDB setup" id="idm45053585552072"/><a data-type="indexterm" data-primary="MongoDB" data-secondary="setup" id="idm45053585551096"/>The difficulty involved in setting up a MongoDB instance varies with your
operating system. <a data-type="indexterm" data-primary="mLab" id="idm45053585549912"/>For this reason, we’ll be avoiding the problem altogether by
using an excellent free MongoDB hosting service, mLab.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>mLab is not the only MongoDB service available.
<a data-type="indexterm" data-primary="MongoDB Atlas" id="idm45053585548008"/>The MongoDB company itself is now offering free and low-cost database
hosting through its product <a href="https://www.mongodb.com">MongoDB Atlas</a>.
Free accounts are not recommended for production purposes, though.  Both
mLab and MongoDB Atlas offer production-ready accounts, so you should look
into their pricing before making a choice. It will be less hassle to stay
with the same hosting service when you make the switch to production.</p>
</div>

<p>Getting started with mLab is simple. Just go to <a href="https://mlab.com"><em class="hyperlink">https://mlab.com</em></a>
and click Sign Up. Fill out the registration form and log in, and you’ll
be at your home screen. Under Databases, you’ll see “no databases at this
time.” Click “Create new,” and you will be taken to a page with some
options for your new database. The first thing you’ll select is a cloud
provider. For a free (sandbox) account, the choice is largely irrelevant,
though you should look for a data center near you (not every data center
will offer sandbox accounts, however). Select SANDBOX, and choose a
region. Then choose a database name, and click through to Submit Order
(it’s still an order even though it’s free!). You will be taken back to
the list of your databases, and after a few seconds, your database will be
available for use.</p>

<p>Having a database set up is half the battle. Now we have to know how to
access it with Node, and that’s where Mongoose comes in.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Mongoose"><div class="sect2" id="idm45053585543016">
<h2>Mongoose</h2>

<p><a data-type="indexterm" data-primary="databases" data-secondary="Mongoose setup" id="idm45053585541704"/><a data-type="indexterm" data-primary="Mongoose" data-secondary="setup" id="idm45053585540728"/><a data-type="indexterm" data-primary="object document mapper (ODM)" id="idm45053585539784"/>While there’s a low-level driver available for
<a href="http://bit.ly/2Kfw0hE">MongoDB</a>, you’ll probably want to use an
object document mapper (ODM). The most popular ODM for MongoDB is
<em>Mongoose</em>.</p>

<p>One of the advantages of JavaScript is that its object model is extremely
flexible. If you want to add a property or method to an object, you just do
it, and you don’t need to worry about modifying a class. Unfortunately,
that kind of freewheeling flexibility can have a negative impact on your
databases because they can become fragmented and hard to optimize. Mongoose
attempts to strike a balance by introducing <em>schemas</em> and <em>models</em>
(combined, schemas and models are similar to classes in traditional
object-oriented programming). The
schemas are flexible but still provide some necessary structure for your
database.</p>

<p>Before we get started, we’ll need to install the Mongoose module:</p>

<pre data-type="programlisting">npm install mongoose</pre>

<p>Then we’ll add our database credentials to our
<em>.credentials.development.json</em> file:</p>

<pre data-type="programlisting" data-code-language="js"><code class="s2">"mongo"</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"connectionString"</code><code class="o">:</code> <code class="s2">"your_dev_connection_string"</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>You’ll find your connection string on the database page in mLab. From
your home screen, click the appropriate database. You’ll see a box with
your MongoDB connection URI (it starts with <em>mongodb://</em>). You’ll also
need a user for your database. To create one, click Users, and then “Add
database user.”</p>

<p>Notice that we could establish a second set of credentials for production
by creating a <em>.credentials.production.js</em> file and using
<code>NODE_ENV=production</code>; you’ll want to do this when it’s time to go live!</p>

<p>Now that we have all the configuration done, let’s actually make a connection
to the database and do something useful!</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Database Connections with Mongoose"><div class="sect2" id="idm45053585542392">
<h2>Database Connections with Mongoose</h2>

<p><a data-type="indexterm" data-primary="databases" data-secondary="connections with Mongoose" id="idm45053585524776"/><a data-type="indexterm" data-primary="Mongoose" data-secondary="database connections with" id="idm45053585523832"/>We’ll start by creating a connection to our
database. We’ll put our database initialization code in <em>db.js</em>, along with
the dummy API we created earlier (<em>ch13/00-mongodb/db.js</em> in the companion
repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">mongoose</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongoose'</code><code class="p">)</code>
<code class="kr">const</code> <code class="p">{</code> <code class="nx">connectionString</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">credentials</code><code class="p">.</code><code class="nx">mongo</code>
<code class="k">if</code><code class="p">(</code><code class="o">!</code><code class="nx">connectionString</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'MongoDB connection string missing!'</code><code class="p">)</code>
  <code class="nx">process</code><code class="p">.</code><code class="nx">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="p">}</code>
<code class="nx">mongoose</code><code class="p">.</code><code class="nx">connect</code><code class="p">(</code><code class="nx">connectionString</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">mongoose</code><code class="p">.</code><code class="nx">connection</code>
<code class="nx">db</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'error'</code> <code class="nx">err</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'MongoDB error: '</code> <code class="o">+</code> <code class="nx">err</code><code class="p">.</code><code class="nx">message</code><code class="p">)</code>
  <code class="nx">process</code><code class="p">.</code><code class="nx">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="p">})</code>
<code class="nx">db</code><code class="p">.</code><code class="nx">once</code><code class="p">(</code><code class="s1">'open'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'MongoDB connection established'</code><code class="p">))</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">getVacations</code><code class="o">:</code> <code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">//...return fake vacation data</code>
  <code class="p">},</code>
  <code class="nx">addVacationInSeasonListener</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">email</code><code class="p">,</code> <code class="nx">sku</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">//...do nothing</code>
  <code class="p">},</code>
<code class="p">}</code></pre>

<p>Any file that needs to access the database can simply import <em>db.js</em>.
However, we want the initialization to happen right away, before we need the
API, so we’ll go ahead and import this from <em>meadowlark.js</em> (where we don’t
need to do anything with the API):</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">require</code><code class="p">(</code><code class="s1">'./db'</code><code class="p">)</code></pre>

<p>Now that we’re connecting to the database, it’s time to consider how we’re
going to structure data that we’re transferring to and from the database.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Creating Schemas and Models"><div class="sect2" id="idm45053585308216">
<h2>Creating Schemas and Models</h2>

<p><a data-type="indexterm" data-primary="databases" data-secondary="creating schemas and models" id="idm45053585332632"/><a data-type="indexterm" data-primary="models" id="idm45053585331688"/><a data-type="indexterm" data-primary="schemas" id="idm45053585331016"/>Let’s create a vacation package database for Meadowlark
Travel. We start by defining a
schema and creating a model from it. Create the file <em>models/vacation.js</em>
(<em>ch13/00-mongodb/models/vacation.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">mongoose</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongoose'</code><code class="p">)</code>

<code class="kr">const</code> <code class="nx">vacationSchema</code> <code class="o">=</code> <code class="nx">mongoose</code><code class="p">.</code><code class="nx">Schema</code><code class="p">({</code>
  <code class="nx">name</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
  <code class="nx">slug</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
  <code class="nx">category</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
  <code class="nx">sku</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
  <code class="nx">description</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
  <code class="nx">location</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">search</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
    <code class="nx">coordinates</code><code class="o">:</code> <code class="p">{</code>
      <code class="nx">lat</code><code class="o">:</code> <code class="nb">Number</code><code class="p">,</code>
      <code class="nx">lng</code><code class="o">:</code> <code class="nb">Number</code><code class="p">,</code>
    <code class="p">},</code>
  <code class="p">},</code>
  <code class="nx">price</code><code class="o">:</code> <code class="nb">Number</code><code class="p">,</code>
  <code class="nx">tags</code><code class="o">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">],</code>
  <code class="nx">inSeason</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
  <code class="nx">available</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
  <code class="nx">requiresWaiver</code><code class="o">:</code> <code class="nb">Boolean</code><code class="p">,</code>
  <code class="nx">maximumGuests</code><code class="o">:</code> <code class="nb">Number</code><code class="p">,</code>
  <code class="nx">notes</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
  <code class="nx">packagesSold</code><code class="o">:</code> <code class="nb">Number</code><code class="p">,</code>
<code class="p">})</code>

<code class="kr">const</code> <code class="nx">Vacation</code> <code class="o">=</code> <code class="nx">mongoose</code><code class="p">.</code><code class="nx">model</code><code class="p">(</code><code class="s1">'Vacation'</code><code class="p">,</code> <code class="nx">vacationSchema</code><code class="p">)</code>
<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">Vacation</code></pre>

<p>This code declares the properties that make up our vacation model, and the
types of those properties. You’ll see there are several string properties,
some numeric properties, two Boolean properties, and an array of strings
(denoted by <code>[String]</code>). At this point, we can also define methods on our
schema. Each product has a stock keeping unit (SKU); even though we
don’t think about vacations being “stock items,” the concept of an SKU is
pretty standard for accounting, even when tangible goods aren’t being sold.</p>

<p>Once we have the schema, we create a model using <code>mongoose.model</code>: at this
point, <code>Vacation</code> is very much like a class in traditional object-oriented
programming. Note that we have to define our methods before we create our
model.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="financial computations, in JavaScript" id="idm45053585157496"/><a data-type="indexterm" data-primary="floating-point numbers" id="idm45053585156824"/><a data-type="indexterm" data-primary="JavaScript" data-secondary="floating-point numbers in" id="idm45053585156152"/>Because of the nature of floating-point numbers, you should always be careful
with financial computations in JavaScript. We could store our prices in cents
instead of dollars, which would help, but it doesn’t eliminate the
problems. For the modest purposes of our travel website, we’re not going
to worry about it, but if your application involves very large or very
small financial amounts (for example, fractional cents from interest or
volume trading), you should consider using a library such as
<a href="https://currency.js.org">currency.js</a> or
<a href="http://bit.ly/2X6kbQ5">decimal.js-light</a>. Also,
JavaScript’s
<a href="https://mzl.la/2Xhs45r">BigInt</a>
built-in object, which is available as of Node 10 (with limited browser
support as I write this), can be used for this purpose.</p>
</div>

<p>We are exporting the <code>Vacation</code> model object created by Mongoose. While we
could use this model directly, that would be undermining our effort to
provide a database abstraction layer. So we will choose to import it only
from the <em>db.js</em> file and let the rest of our application use its methods.
Add the <code>Vacation</code> model to <em>db.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">Vacation</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./models/vacation'</code><code class="p">)</code></pre>

<p>All of our structures are now defined, but our database isn’t very
interesting because there’s nothing actually in it. Let’s make it useful by
seeding it with some data.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Seeding Initial Data"><div class="sect2" id="idm45053585143912">
<h2>Seeding Initial Data</h2>

<p><a data-type="indexterm" data-primary="databases" data-secondary="seeding initial data" id="ix_ch-13-persistence-asciidoc7"/>We don’t yet have any vacation packages in our database, so we’ll
add some to get us started. Eventually, you may want to create a way to
manage products, but for the purposes of this book, we’re just going to do
it in code (<em>ch13/00-mongodb/db.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">Vacation</code><code class="p">.</code><code class="nx">find</code><code class="p">((</code><code class="nx">err</code><code class="p">,</code> <code class="nx">vacations</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">if</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="k">return</code> <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code>
  <code class="k">if</code><code class="p">(</code><code class="nx">vacations</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="k">return</code>

  <code class="k">new</code> <code class="nx">Vacation</code><code class="p">({</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s1">'Hood River Day Trip'</code><code class="p">,</code>
    <code class="nx">slug</code><code class="o">:</code> <code class="s1">'hood-river-day-trip'</code><code class="p">,</code>
    <code class="nx">category</code><code class="o">:</code> <code class="s1">'Day Trip'</code><code class="p">,</code>
    <code class="nx">sku</code><code class="o">:</code> <code class="s1">'HR199'</code><code class="p">,</code>
    <code class="nx">description</code><code class="o">:</code> <code class="s1">'Spend a day sailing on the Columbia and '</code> <code class="o">+</code>
      <code class="s1">'enjoying craft beers in Hood River!'</code><code class="p">,</code>
    <code class="nx">location</code><code class="o">:</code> <code class="p">{</code>
      <code class="nx">search</code><code class="o">:</code> <code class="s1">'Hood River, Oregon, USA'</code><code class="p">,</code>
    <code class="p">},</code>
    <code class="nx">price</code><code class="o">:</code> <code class="mf">99.95</code><code class="p">,</code>
    <code class="nx">tags</code><code class="o">:</code> <code class="p">[</code><code class="s1">'day trip'</code><code class="p">,</code> <code class="s1">'hood river'</code><code class="p">,</code> <code class="s1">'sailing'</code><code class="p">,</code> <code class="s1">'windsurfing'</code><code class="p">,</code> <code class="s1">'breweries'</code><code class="p">],</code>
    <code class="nx">inSeason</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="nx">maximumGuests</code><code class="o">:</code> <code class="mi">16</code><code class="p">,</code>
    <code class="nx">available</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="nx">packagesSold</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="p">}).</code><code class="nx">save</code><code class="p">()</code>

  <code class="k">new</code> <code class="nx">Vacation</code><code class="p">({</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s1">'Oregon Coast Getaway'</code><code class="p">,</code>
    <code class="nx">slug</code><code class="o">:</code> <code class="s1">'oregon-coast-getaway'</code><code class="p">,</code>
    <code class="nx">category</code><code class="o">:</code> <code class="s1">'Weekend Getaway'</code><code class="p">,</code>
    <code class="nx">sku</code><code class="o">:</code> <code class="s1">'OC39'</code><code class="p">,</code>
    <code class="nx">description</code><code class="o">:</code> <code class="s1">'Enjoy the ocean air and quaint coastal towns!'</code><code class="p">,</code>
    <code class="nx">location</code><code class="o">:</code> <code class="p">{</code>
      <code class="nx">search</code><code class="o">:</code> <code class="s1">'Cannon Beach, Oregon, USA'</code><code class="p">,</code>
    <code class="p">},</code>
    <code class="nx">price</code><code class="o">:</code> <code class="mf">269.95</code><code class="p">,</code>
    <code class="nx">tags</code><code class="o">:</code> <code class="p">[</code><code class="s1">'weekend getaway'</code><code class="p">,</code> <code class="s1">'oregon coast'</code><code class="p">,</code> <code class="s1">'beachcombing'</code><code class="p">],</code>
    <code class="nx">inSeason</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="nx">maximumGuests</code><code class="o">:</code> <code class="mi">8</code><code class="p">,</code>
    <code class="nx">available</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="nx">packagesSold</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
  <code class="p">}).</code><code class="nx">save</code><code class="p">()</code>

  <code class="k">new</code> <code class="nx">Vacation</code><code class="p">({</code>
      <code class="nx">name</code><code class="o">:</code> <code class="s1">'Rock Climbing in Bend'</code><code class="p">,</code>
      <code class="nx">slug</code><code class="o">:</code> <code class="s1">'rock-climbing-in-bend'</code><code class="p">,</code>
      <code class="nx">category</code><code class="o">:</code> <code class="s1">'Adventure'</code><code class="p">,</code>
      <code class="nx">sku</code><code class="o">:</code> <code class="s1">'B99'</code><code class="p">,</code>
      <code class="nx">description</code><code class="o">:</code> <code class="s1">'Experience the thrill of climbing in the high desert.'</code><code class="p">,</code>
      <code class="nx">location</code><code class="o">:</code> <code class="p">{</code>
        <code class="nx">search</code><code class="o">:</code> <code class="s1">'Bend, Oregon, USA'</code><code class="p">,</code>
      <code class="p">},</code>
      <code class="nx">price</code><code class="o">:</code> <code class="mf">289.95</code><code class="p">,</code>
      <code class="nx">tags</code><code class="o">:</code> <code class="p">[</code><code class="s1">'weekend getaway'</code><code class="p">,</code> <code class="s1">'bend'</code><code class="p">,</code> <code class="s1">'high desert'</code><code class="p">,</code> <code class="s1">'rock climbing'</code><code class="p">],</code>
      <code class="nx">inSeason</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
      <code class="nx">requiresWaiver</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
      <code class="nx">maximumGuests</code><code class="o">:</code> <code class="mi">4</code><code class="p">,</code>
      <code class="nx">available</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
      <code class="nx">packagesSold</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
      <code class="nx">notes</code><code class="o">:</code> <code class="s1">'The tour guide is currently recovering from a skiing accident.'</code><code class="p">,</code>
  <code class="p">}).</code><code class="nx">save</code><code class="p">()</code>
<code class="p">})</code></pre>

<p>There are two Mongoose methods being used here. <a data-type="indexterm" data-primary="find() method, Mongoose" id="idm45053585133160"/>The first, <code>find</code>, does
just what it says. In this case, it’s finding all instances of <code>Vacation</code>
in the database and invoking the callback with that list. We’re doing that
because we don’t want to keep re-adding our seed vacations: if there are
already vacations in the database, it’s been seeded, and we can go on our
merry way. The first time this executes, though, <code>find</code> will return an
empty list, so we proceed to create two vacations <a data-type="indexterm" data-primary="save() method, Mongoose" id="idm45053585130952"/>and then call the <code>save</code>
method on them, which saves these new objects to the database.</p>

<p>Now that data is <em>in</em> the database, it’s time to get it back out!<a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc7" id="idm45053585128904"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Retrieving Data"><div class="sect2" id="idm45053584750568">
<h2>Retrieving Data</h2>

<p><a data-type="indexterm" data-primary="databases" data-secondary="retrieving data" id="ix_ch-13-persistence-asciidoc8"/>We’ve already seen the <code>find</code> method, which is what we’ll use to display a
list of vacations. However, this time we’re going to pass
an
option to <code>find</code> that will filter the data. Specifically, we want to
display only vacations that are currently available.</p>

<p>Create a view for the products page, <em>views/vacations.handlebars</em>:</p>

<pre data-type="programlisting" data-code-language="html"><code class="nt">&lt;h1&gt;</code>Vacations<code class="nt">&lt;/h1&gt;</code>
{{#each vacations}}
  <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"vacation"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;h3&gt;</code>{{name}}<code class="nt">&lt;/h3&gt;</code>
    <code class="nt">&lt;p&gt;</code>{{description}}<code class="nt">&lt;/p&gt;</code>
    {{#if inSeason}}
      <code class="nt">&lt;span</code> <code class="na">class=</code><code class="s">"price"</code><code class="nt">&gt;</code>{{price}}<code class="nt">&lt;/span&gt;</code>
      <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"/cart/add?sku={{sku}}"</code> <code class="na">class=</code><code class="s">"btn btn-default"</code><code class="nt">&gt;</code>Buy Now!<code class="nt">&lt;/a&gt;</code>
    {{else}}
      <code class="nt">&lt;span</code> <code class="na">class=</code><code class="s">"outOfSeason"</code><code class="nt">&gt;</code>We're sorry, this vacation is currently
      not in season.
      {{! The "notify me when this vacation is in season"
          page will be our next task. }}
      <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"/notify-me-when-in-season?sku={{sku}}"</code><code class="nt">&gt;</code>Notify me when
      this vacation is in season.<code class="nt">&lt;/a&gt;</code>
    {{/if}}
  <code class="nt">&lt;/div&gt;</code>
{{/each}}</pre>

<p>Now we can create route handlers that hook it all up. In
<em>lib/handlers.js</em> (don’t forget to import <code>../db</code>), we create
the handler:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">exports</code><code class="p">.</code><code class="nx">listVacations</code> <code class="o">=</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">vacations</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">db</code><code class="p">.</code><code class="nx">getVacations</code><code class="p">({</code> <code class="nx">available</code><code class="o">:</code> <code class="kc">true</code> <code class="p">})</code>
  <code class="kr">const</code> <code class="nx">context</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">vacations</code><code class="o">:</code> <code class="nx">vacations</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">vacation</code> <code class="o">=&gt;</code> <code class="p">({</code>
      <code class="nx">sku</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">sku</code><code class="p">,</code>
      <code class="nx">name</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code>
      <code class="nx">description</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">description</code><code class="p">,</code>
      <code class="nx">price</code><code class="o">:</code> <code class="s1">'$'</code> <code class="o">+</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">price</code><code class="p">.</code><code class="nx">toFixed</code><code class="p">(</code><code class="mi">2</code><code class="p">),</code>
      <code class="nx">inSeason</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">inSeason</code><code class="p">,</code>
    <code class="p">}))</code>
  <code class="p">}</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'vacations'</code><code class="p">,</code> <code class="nx">context</code><code class="p">)</code>
<code class="p">}</code></pre>

<p>We add a route that calls the handler in <em>meadowlark.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/vacations'</code><code class="p">,</code> <code class="nx">handlers</code><code class="p">.</code><code class="nx">listVacations</code><code class="p">)</code></pre>

<p>If you run this example, you’ll see only the one vacation from our dummy
database implementation. That’s because we’ve initialized the database and
seeded its data, but we haven’t replaced the dummy implementation with a real
one. So let’s do that now. Open <em>db.js</em> and modify <code>getVacations</code>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">getVacations</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">options</code> <code class="o">=</code> <code class="p">{})</code> <code class="o">=&gt;</code> <code class="nx">Vacation</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="nx">options</code><code class="p">),</code>
  <code class="nx">addVacationInSeasonListener</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">email</code><code class="p">,</code> <code class="nx">sku</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">//...</code>
  <code class="p">},</code>
<code class="p">}</code></pre>

<p>That was easy! A one-liner. Partially this is because Mongoose is doing a lot
of the heavy lifting for us, and the way we’ve designed our API is
similar to the way Mongoose works. When we adapt this later to PostgreSQL,
you’ll see we have to do a little more work.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The astute reader may worry that our database abstraction layer isn’t doing
much to “protect” its technology-neutral objective. For example, a developer
may read this code and see that they can pass any Mongoose options along to
the vacation model, and then the application would be using features that
are specific to Mongoose, which will make it harder to switch databases. We
could take some steps to prevent this. Instead of just passing things to
Mongoose, we could look for specific options and handle them explicitly,
making it clear that any implementation would have to provide those options.
But for the sake of this example, we’re going to let this slide and keep
this code simple.</p>
</div>

<p>Most of this should be looking pretty familiar, but there might be some
things that surprise you. For instance, how we’re handling the view
context for the vacation listing might seem odd. Why did we map the products returned from the
database to a nearly identical object? One reason is that we want to
display the price in a neatly formatted way, so we have to convert it to a
formatted string.</p>

<p>We could have saved some typing by doing this:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">context</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">vacations</code><code class="o">:</code> <code class="nx">products</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">vacations</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">vacation</code><code class="p">.</code><code class="nx">price</code> <code class="o">=</code> <code class="s1">'$'</code> <code class="o">+</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">price</code><code class="p">.</code><code class="nx">toFixed</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>
    <code class="k">return</code> <code class="nx">vacation</code>
  <code class="p">})</code>
<code class="p">}</code></pre>

<p>That would certainly save us a few lines of code, but in my experience,
there are good reasons not to pass unmapped database objects directly to
views.  The view gets a bunch of properties it may not need, possibly in
formats that are incompatible with it. Our example is pretty simple so
far, but once it starts to get more complicated, you’ll probably want to do
even more customization of the data that’s passed to a view. It also makes
it easy to accidentally expose confidential information or information
that could compromise the security of your website. For these reasons, I
recommend mapping the data that’s returned from the database and passing
only what’s needed onto the view (transforming as necessary, as we did with
<code>price</code>).</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="view model" id="idm45053584372680"/>In some variations of the MVC architecture, a third component called a
<em>view model</em> is introduced. A view model essentially distills and
transforms a model (or models) so that it’s more
appropriate for display in a view. What we’re doing here is
creating a view model on the fly.</p>
</div>

<p>We’ve come a long way at this point. We’re successfully using a database to
store information about our vacations. But databases wouldn’t be very useful
if we couldn’t update them. Let’s turn our attention to that aspect of
interfacing with databases.<a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc8" id="idm45053584370424"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Adding Data"><div class="sect2" id="idm45053584749976">
<h2>Adding Data</h2>

<p><a data-type="indexterm" data-primary="databases" data-secondary="adding data to MongoDB" id="ix_ch-13-persistence-asciidoc9"/>We’ve already seen how we can add data (we added data when we seeded the
vacation collection) and how we can update data (we update the count of
packages sold when we book a vacation), but let’s take a
look at a slightly more involved scenario that highlights the flexibility
of document databases.</p>

<p>When a vacation is out of season, we display a link that invites the
customer to be notified when the vacation is in season again. Let’s hook
up that functionality. First, we create the schema and model
(<em>models/vacationInSeasonListener.js</em>):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">mongoose</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'mongoose'</code><code class="p">)</code>

<code class="kr">const</code> <code class="nx">vacationInSeasonListenerSchema</code> <code class="o">=</code> <code class="nx">mongoose</code><code class="p">.</code><code class="nx">Schema</code><code class="p">({</code>
  <code class="nx">email</code><code class="o">:</code> <code class="nb">String</code><code class="p">,</code>
  <code class="nx">skus</code><code class="o">:</code> <code class="p">[</code><code class="nb">String</code><code class="p">],</code>
<code class="p">})</code>
<code class="kr">const</code> <code class="nx">VacationInSeasonListener</code> <code class="o">=</code> <code class="nx">mongoose</code><code class="p">.</code><code class="nx">model</code><code class="p">(</code><code class="s1">'VacationInSeasonListener'</code><code class="p">,</code>
  <code class="nx">vacationInSeasonListenerSchema</code><code class="p">)</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">VacationInSeasonListener</code></pre>

<p>Then we’ll create our view, <em>views/notify-me-when-in-season.handlebars</em>:</p>

<pre data-type="programlisting" data-code-language="html"><code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"formContainer"</code><code class="nt">&gt;</code>
  <code class="nt">&lt;form</code> <code class="na">class=</code><code class="s">"form-horizontal newsletterForm"</code> <code class="na">role=</code><code class="s">"form"</code>
      <code class="na">action=</code><code class="s">"/notify-me-when-in-season"</code> <code class="na">method=</code><code class="s">"POST"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"hidden"</code> <code class="na">name=</code><code class="s">"sku"</code> <code class="na">value=</code><code class="s">"{{sku}}"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"form-group"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"fieldEmail"</code> <code class="na">class=</code><code class="s">"col-sm-2 control-label"</code><code class="nt">&gt;</code>Email<code class="nt">&lt;/label&gt;</code>
      <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"col-sm-4"</code><code class="nt">&gt;</code>
        <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"email"</code> <code class="na">class=</code><code class="s">"form-control"</code> <code class="na">required</code>
          <code class="na">id=</code><code class="s">"fieldEmail"</code> <code class="na">name=</code><code class="s">"email"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;/div&gt;</code>
    <code class="nt">&lt;/div&gt;</code>
    <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"form-group"</code><code class="nt">&gt;</code>
      <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"col-sm-offset-2 col-sm-4"</code><code class="nt">&gt;</code>
        <code class="nt">&lt;button</code> <code class="na">type=</code><code class="s">"submit"</code> <code class="na">class=</code><code class="s">"btn btn-default"</code><code class="nt">&gt;</code>Submit<code class="nt">&lt;/button&gt;</code>
      <code class="nt">&lt;/div&gt;</code>
    <code class="nt">&lt;/div&gt;</code>
  <code class="nt">&lt;/form&gt;</code>
<code class="nt">&lt;/div&gt;</code></pre>

<p>Then the route handlers:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">exports</code><code class="p">.</code><code class="nx">notifyWhenInSeasonForm</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'notify-me-when-in-season'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">sku</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">sku</code> <code class="p">})</code>

<code class="nx">exports</code><code class="p">.</code><code class="nx">notifyWhenInSeasonProcess</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">email</code><code class="p">,</code> <code class="nx">sku</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code>
  <code class="nx">await</code> <code class="nx">db</code><code class="p">.</code><code class="nx">addVacationInSeasonListener</code><code class="p">(</code><code class="nx">email</code><code class="p">,</code> <code class="nx">sku</code><code class="p">)</code>
  <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="mi">303</code><code class="p">,</code> <code class="s1">'/vacations'</code><code class="p">)</code>
<code class="p">}</code></pre>

<p>Finally, we add a real implementation to <em>db.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">VacationInSeasonListener</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./models/vacationInSeasonListener'</code><code class="p">)</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">getVacations</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">options</code> <code class="o">=</code> <code class="p">{})</code> <code class="o">=&gt;</code> <code class="nx">Vacation</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="nx">options</code><code class="p">),</code>
  <code class="nx">addVacationInSeasonListener</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">email</code><code class="p">,</code> <code class="nx">sku</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">await</code> <code class="nx">VacationInSeasonListener</code><code class="p">.</code><code class="nx">updateOne</code><code class="p">(</code>
      <code class="p">{</code> <code class="nx">email</code> <code class="p">},</code>
      <code class="p">{</code> <code class="nx">$push</code><code class="o">:</code> <code class="p">{</code> <code class="nx">skus</code><code class="o">:</code> <code class="nx">sku</code> <code class="p">}</code> <code class="p">},</code>
      <code class="p">{</code> <code class="nx">upsert</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}</code>
    <code class="p">)</code>
  <code class="p">},</code>
<code class="p">}</code></pre>

<p>What magic is this? How can we “update” a record in the
<code>VacationInSeasonListener</code> collection before it even exists? The answer
lies in a Mongoose convenience
called an <em>upsert</em> (a portmanteau of “update” and “insert”). Basically, if
a record with the given email address doesn’t exist, it will be created.
If a record does exist, it will be updated. Then we use the magic variable
<code>$push</code> to indicate that we want to add a value to an array.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>This code doesn’t prevent multiple SKUs from being added to the record if
the user fills out the form multiple times. When a vacation comes into
season and we find all the customers who want to be notified, we will have
to be careful not to notify them multiple times.</p>
</div>

<p>We’ve certainly covered the important bases by now! We learned how to
connect to a MongoDB instance, seed it with data, read that data out, and
write updates to it! However, you may prefer to use an RDBMS, so let’s shift
gears and see how we can do the same thing with PostgreSQL instead.<a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc9" id="idm45053583993432"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="PostgreSQL"><div class="sect2" id="idm45053584369496">
<h2>PostgreSQL</h2>

<p><a data-type="indexterm" data-primary="databases" data-secondary="PostgreSQL" id="ix_ch-13-persistence-asciidoc10"/><a data-type="indexterm" data-primary="PostgreSQL" id="ix_ch-13-persistence-asciidoc11"/>Object databases like MongoDB are great and are generally quicker to get
started with, but if you’re trying to build a robust application, you may
put as much work—or more—into structuring your object databases as
you would planning out a traditional relational database. Furthermore, you
may already have experience with relational databases, or you might have an
existing relational database you want to connect with.</p>

<p>Fortunately, there is robust support for every major relational database in
the JavaScript ecosystem, and if you want or need to use a relational
database, you shouldn’t have any problem.</p>

<p>Let’s take our vacation database and reimplement it using a relational
database. For this example, we’ll use PostgreSQL, a popular and
sophisticated open source relational database. The techniques and
principles we’ll use will be similar for any relational database.</p>

<p><a data-type="indexterm" data-primary="object-relational mapping (ORM)" id="idm45053583986552"/>Similar to the ODM we used for MongoDB, there are object-relational
mapping (ORM) tools available for relational databases. However, since
most readers interested in this topic are probably already familiar with
relational databases and SQL, we’ll use a Node PostgreSQL client directly.</p>

<p>Like MongoDB, we’ll use a free online PostgreSQL service. Of course, if
you’re comfortable installing and configuring your own PostgreSQL database,
you are welcome to do that as well. All that will change is the connection
string. If you do use your own PostgreSQL instance, make sure you’re using
9.4 or later, because we will be using the JSON data type, which was
introduced in 9.4 (as I write this, I am using 11.3).</p>

<p><a data-type="indexterm" data-primary="ElephantSQL" id="idm45053583984280"/>There are many options for online PostgreSQL; for this example, I’ll be
using <a href="https://www.elephantsql.com">ElephantSQL</a>. Getting started couldn’t
be simpler: create an account (you can use your GitHub account to log in),
and click Create New Instance. All you have to do is give it a name (for
example, “meadowlark”) and select a plan (you can use their free plan).
You’ll also specify a region (try to pick the one closest to you). Once
you’re all set up, you’ll find a Details section that lists information
about your instance. Copy the URL (connection string), which includes the
username, password, and instance location all in one convenient string.</p>

<p>Put that string in your <em>.credentials.development.json</em> file:</p>

<pre data-type="programlisting" data-code-language="js"><code class="s2">"postgres"</code><code class="o">:</code> <code class="p">{</code>
  <code class="s2">"connectionString"</code><code class="o">:</code> <code class="s2">"your_dev_connection_string"</code>
<code class="p">}</code></pre>

<p><a data-type="indexterm" data-primary="object databases" id="idm45053583976760"/><a data-type="indexterm" data-primary="RDBMS (relational database management system)" id="idm45053583976152"/><a data-type="indexterm" data-primary="relational database management system (RDBMS)" id="idm45053583975096"/>One difference between object databases and RDBMSs is that you typically do
more up-front work to define the schema of an RDBMS and use
data definition SQL to create the schema before adding or retrieving data.
In keeping with this paradigm, we’ll do that as a separate step instead of
letting our ODM or ORM handle it, as we did with MongoDB.</p>

<p>We could create SQL scripts and use a command-line client to execute the
data definition scripts that will create our tables, or we could do this work
in JavaScript with the PostgreSQL client API, but in a separate step
that’s done only once. Since this is a book about Node and Express, we’ll
do the latter.</p>

<p>First, we’ll have to install the <code>pg</code> client library (<code>npm install pg</code>).
Then create <em>db-init.js</em>, which will be run only to initialize our
database and is distinct from our <em>db.js</em> file, which is used every time
the server starts up (<em>ch13/01-postgres/db.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="p">{</code> <code class="nx">credentials</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./config'</code><code class="p">)</code>

<code class="kr">const</code> <code class="p">{</code> <code class="nx">Client</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'pg'</code><code class="p">)</code>
<code class="kr">const</code> <code class="p">{</code> <code class="nx">connectionString</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">credentials</code><code class="p">.</code><code class="nx">postgres</code>
<code class="kr">const</code> <code class="nx">client</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Client</code><code class="p">({</code> <code class="nx">connectionString</code> <code class="p">})</code>

<code class="kr">const</code> <code class="nx">createScript</code> <code class="o">=</code> <code class="sb">`</code>
<code class="sb">  CREATE TABLE IF NOT EXISTS vacations (</code>
<code class="sb">    name varchar(200) NOT NULL,</code>
<code class="sb">    slug varchar(200) NOT NULL UNIQUE,</code>
<code class="sb">    category varchar(50),</code>
<code class="sb">    sku varchar(20),</code>
<code class="sb">    description text,</code>
<code class="sb">    location_search varchar(100) NOT NULL,</code>
<code class="sb">    location_lat double precision,</code>
<code class="sb">    location_lng double precision,</code>
<code class="sb">    price money,</code>
<code class="sb">    tags jsonb,</code>
<code class="sb">    in_season boolean,</code>
<code class="sb">    available boolean,</code>
<code class="sb">    requires_waiver boolean,</code>
<code class="sb">    maximum_guests integer,</code>
<code class="sb">    notes text,</code>
<code class="sb">    packages_sold integer</code>
<code class="sb">  );</code>
<code class="sb">`</code>

<code class="kr">const</code> <code class="nx">getVacationCount</code> <code class="o">=</code> <code class="nx">async</code> <code class="nx">client</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">rows</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">client</code><code class="p">.</code><code class="nx">query</code><code class="p">(</code><code class="s1">'SELECT COUNT(*) FROM VACATIONS'</code><code class="p">)</code>
  <code class="k">return</code> <code class="nb">Number</code><code class="p">(</code><code class="nx">rows</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">count</code><code class="p">)</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">seedVacations</code> <code class="o">=</code> <code class="nx">async</code> <code class="nx">client</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">sql</code> <code class="o">=</code> <code class="sb">`</code>
<code class="sb">    INSERT INTO vacations(</code>
<code class="sb">      name,</code>
<code class="sb">      slug,</code>
<code class="sb">      category,</code>
<code class="sb">      sku,</code>
<code class="sb">      description,</code>
<code class="sb">      location_search,</code>
<code class="sb">      price,</code>
<code class="sb">      tags,</code>
<code class="sb">      in_season,</code>
<code class="sb">      available,</code>
<code class="sb">      requires_waiver,</code>
<code class="sb">      maximum_guests,</code>
<code class="sb">      notes,</code>
<code class="sb">      packages_sold</code>
<code class="sb">    ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14)</code>
<code class="sb">  `</code>
  <code class="nx">await</code> <code class="nx">client</code><code class="p">.</code><code class="nx">query</code><code class="p">(</code><code class="nx">sql</code><code class="p">,</code> <code class="p">[</code>
    <code class="s1">'Hood River Day Trip'</code><code class="p">,</code>
    <code class="s1">'hood-river-day-trip'</code><code class="p">,</code>
    <code class="s1">'Day Trip'</code><code class="p">,</code>
    <code class="s1">'HR199'</code><code class="p">,</code>
    <code class="s1">'Spend a day sailing on the Columbia and enjoying craft beers in Hood River!'</code><code class="p">,</code>
    <code class="s1">'Hood River, Oregon, USA'</code><code class="p">,</code>
    <code class="mf">99.95</code><code class="p">,</code>
    <code class="sb">`["day trip", "hood river", "sailing", "windsurfing", "breweries"]`</code><code class="p">,</code>
    <code class="kc">true</code><code class="p">,</code>
    <code class="kc">true</code><code class="p">,</code>
    <code class="kc">false</code><code class="p">,</code>
    <code class="mi">16</code><code class="p">,</code>
    <code class="kc">null</code><code class="p">,</code>
    <code class="mi">0</code><code class="p">,</code>
  <code class="p">])</code>
  <code class="c1">// we can use the same pattern to insert other vacation data here...</code>
<code class="p">}</code>

<code class="nx">client</code><code class="p">.</code><code class="nx">connect</code><code class="p">().</code><code class="nx">then</code><code class="p">(</code><code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="k">try</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'creating database schema'</code><code class="p">)</code>
    <code class="nx">await</code> <code class="nx">client</code><code class="p">.</code><code class="nx">query</code><code class="p">(</code><code class="nx">createScript</code><code class="p">)</code>
    <code class="kr">const</code> <code class="nx">vacationCount</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">getVacationCount</code><code class="p">(</code><code class="nx">client</code><code class="p">)</code>
    <code class="k">if</code><code class="p">(</code><code class="nx">vacationCount</code> <code class="o">===</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'seeding vacations'</code><code class="p">)</code>
      <code class="nx">await</code> <code class="nx">seedVacations</code><code class="p">(</code><code class="nx">client</code><code class="p">)</code>
    <code class="p">}</code>
  <code class="p">}</code> <code class="k">catch</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'ERROR: could not initialize database'</code><code class="p">)</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">err</code><code class="p">.</code><code class="nx">message</code><code class="p">)</code>
  <code class="p">}</code> <code class="k">finally</code> <code class="p">{</code>
    <code class="nx">client</code><code class="p">.</code><code class="nx">end</code><code class="p">()</code>
  <code class="p">}</code>
<code class="p">})</code></pre>

<p>Let’s start at the bottom of this file. We take our database client
(<code>client</code>) and call <code>connect()</code> on it, which establishes a database
connection and returns a promise. When that promise resolves, we can take
actions against the database.</p>

<p><a data-type="indexterm" data-primary="client.query() method" id="idm45053583962040"/>The first thing we do is invoke <code>client.query(createScript)</code>, which will
create our <code>vacations</code> table (also known as a <em>relation</em>). If we look at
<code>createScript</code>, we’ll see this is data definition SQL. It’s beyond the
scope of this book to delve into SQL, but if you’re reading this section, I
assume you have at least a passing understanding of SQL. One thing you may
note is that we use snake_case to name our fields instead of camelCase.
That is, what was “inSeason” has become “in_season.” While it is possible
to use camelCase to name structures in PostgreSQL, you have to quote any
identifiers with capital letters, which ends up being more trouble than
it’s worth. We’ll come back to that a little later.</p>

<p>You’ll see we’re already having to put more thought into our schema. How
long can a vacation name be? (We’re arbitrarily capping it at 200
characters here.) How long can category names and the SKU be? Notice
we’re using PostgreSQL’s <code>money</code> type for the price and making the slug be
our primary key (instead of adding a separate ID).</p>

<p>If you’re already familiar with relational databases, there won’t be anything
surprising about this simple schema. However, the way we’ve handled “tags”
might have jumped out at you.</p>

<p>In traditional database design, we would probably create a new table to
relate vacations to tags (this is called <em>normalization</em>). And we could do
that here. But here is where we might decide to strike some compromises
between traditional relational database design and doing things in the
“JavaScript way.” If we went with two tables (<code>vacations</code> and
<code>vacation_tags</code>, for example), we’d have to query data from both tables to
create a single object that contains all the information about a vacation,
as we had in our MongoDB example. And there may be performance reasons for
that extra complexity, but let’s assume there isn’t, and we just want to be
able to quickly determine the tags for a particular vacation. We could
make this a text field and separate our tags with commas, but then we would
have to parse out our tags, and PostgreSQL gives us a better way in JSON
data types. We’ll see shortly that by specifying this as JSON (<code>jsonb</code>, a
binary representation that’s usually higher performance), we can store this
as a JavaScript array, and a JavaScript array comes out, just as we had
in MongoDB.</p>

<p>Finally, we insert our seed data into the database by using the same basic
concept as before: if the <code>vacations</code> table is empty, we add some initial
data; otherwise, we assume we’ve already done that.</p>

<p>You’ll note that inserting our data is a little more unwieldy than it was
with MongoDB. There are ways to solve this problem, but for this example,
I want to be explicit about the use of SQL. We could write a function to
make insert statements more naturally, or we could use an ORM (more on this
later). But for now, the SQL gets the job done, and it should be
comfortable for anyone who already knows SQL.</p>

<p>Note that although this script is designed to be run only once to
initialize and seed our database, we’ve written it in a way that it’s safe
to run multiple times. We included the <code>IF NOT EXISTS</code> option, and we check
to see whether the <code>vacations</code> table is empty before adding seed data.</p>

<p>We can now run the script to initialize our database:</p>

<pre data-type="programlisting">$ node db-init.js</pre>

<p>Now that we have our database set up, we can write some code to <em>use</em> it
in our website.</p>

<p><a data-type="indexterm" data-primary="connection pooling" id="idm45053583607560"/>Database servers can typically handle only a limited number of connections
at a time, so web servers usually implement a strategy called <em>connection
pooling</em> to balance the overhead of establishing a connection with the
danger of leaving connections open too long and choking the server.
Fortunately, the details of this are handled for you by the PostgreSQL
Node client.</p>

<p>We’ll take a slightly different strategy with our <em>db.js</em> file this time.
Instead of a file we just require to establish the database connection, it
will return an API that we write that handles the details of communicating
with the database.</p>

<p>We also have a decision to make about our vacation model. Recall that when
we created our model, we used snake_case for our database schema, but all
of our JavaScript code uses camelCase. Broadly speaking, we have three
options here:</p>

<ul>
<li>
<p>Refactor our schema to use camelCase. This will make our SQL uglier
because we have to remember to quote our property names correctly.</p>
</li>
<li>
<p>Use snake_case in our JavaScript. This is less than ideal because we
like standards (right?).</p>
</li>
<li>
<p>Use snake_case on the database side, and translate to camelCase on the
JavaScript side. This is more work that we have to do, but it keeps our
SQL and our JavaScript pristine.</p>
</li>
</ul>

<p>Fortunately, the third option can be done automatically. We could write
our own function to do that translation, but we’ll rely on a popular
utility library called <a href="https://lodash.com">Lodash</a>, which makes it extremely
easy. Just run <code>npm install lodash</code> to install it.</p>

<p>Right now, our database needs are very modest. All we need to do is fetch
all available vacation packages, so our <em>db.js</em> file will look like this
(<em>ch13/01-postgres/db.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="p">{</code> <code class="nx">Pool</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'pg'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">_</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'lodash'</code><code class="p">)</code>

<code class="kr">const</code> <code class="p">{</code> <code class="nx">credentials</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./config'</code><code class="p">)</code>

<code class="kr">const</code> <code class="p">{</code> <code class="nx">connectionString</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">credentials</code><code class="p">.</code><code class="nx">postgres</code>
<code class="kr">const</code> <code class="nx">pool</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Pool</code><code class="p">({</code> <code class="nx">connectionString</code> <code class="p">})</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">getVacations</code><code class="o">:</code> <code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code> <code class="nx">rows</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">pool</code><code class="p">.</code><code class="nx">query</code><code class="p">(</code><code class="s1">'SELECT * FROM VACATIONS'</code><code class="p">)</code>
    <code class="k">return</code> <code class="nx">rows</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">row</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="kr">const</code> <code class="nx">vacation</code> <code class="o">=</code> <code class="nx">_</code><code class="p">.</code><code class="nx">mapKeys</code><code class="p">(</code><code class="nx">row</code><code class="p">,</code> <code class="p">(</code><code class="nx">v</code><code class="p">,</code> <code class="nx">k</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">_</code><code class="p">.</code><code class="nx">camelCase</code><code class="p">(</code><code class="nx">k</code><code class="p">))</code>
      <code class="nx">vacation</code><code class="p">.</code><code class="nx">price</code> <code class="o">=</code> <code class="nb">parseFloat</code><code class="p">(</code><code class="nx">vacation</code><code class="p">.</code><code class="nx">price</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/^\$/</code><code class="p">,</code> <code class="s1">''</code><code class="p">))</code>
      <code class="nx">vacation</code><code class="p">.</code><code class="nx">location</code> <code class="o">=</code> <code class="p">{</code>
        <code class="nx">search</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">locationSearch</code><code class="p">,</code>
        <code class="nx">coordinates</code><code class="o">:</code> <code class="p">{</code>
          <code class="nx">lat</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">locationLat</code><code class="p">,</code>
          <code class="nx">lng</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">locationLng</code><code class="p">,</code>
        <code class="p">},</code>
      <code class="p">}</code>
      <code class="k">return</code> <code class="nx">vacation</code>
    <code class="p">})</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>Short and sweet! We’re exporting a single method called <code>getVacations</code>
that does as advertised. It also uses Lodash’s <code>mapKeys</code> and <code>camelCase</code>
functions to convert our database properties to camelCase.</p>

<p>One thing to note is that we have to handle the <code>price</code> attribute
carefully. PostgreSQL’s <code>money</code> type is converted to an already-formatted
string by the <code>pg</code> library. And for good reason: as we’ve already
discussed, JavaScript has only recently added support for arbitrary
precision numeric types (<code>BigInt</code>), but there isn’t yet a PostgreSQL
adapter that takes advantage of that (and it might not be the most
efficient data type in any event). We could change our database schema to
use a numeric type instead of the <code>money</code> type, but we shouldn’t let our
frontend choices drive our schema. We could also deal with the
preformatted strings that are being returned from <code>pg</code>, but then we would
have to change all of our existing code, which is relying on <code>price</code> being
a number. Furthermore, that approach would undermine our ability to do
numeric calculations on the frontend (such as summing the prices of the
items in your cart). For all of these reasons, we’re opting to parse the
string to a number when we retrieve it from the database.</p>

<p>We also take our location information—which is “flat” in the table—and turn it into a more JavaScript-like structure. We’re doing this only to achieve parity with our MongoDB example; we could use the data structured as it is (or modify our MongoDB example to have a flat structure).</p>

<p>The last thing we need to learn to do with PostgreSQL is to update data, so
let’s fill in the “vacation in season” listener feature.<a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc11" id="idm45053583523912"/><a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc10" id="idm45053583523240"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Adding Data"><div class="sect2" id="idm45053583991912">
<h2>Adding Data</h2>

<p><a data-type="indexterm" data-primary="databases" data-secondary="adding data to PostgreSQL" id="idm45053583521496"/>As with the MongoDB example, we’ll use our “vacation in season” listener
example. We’ll start by adding the following data definition to the
<code>createScript</code> string in <em>db-init.js</em>:</p>

<pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">IF</code> <code class="k">NOT</code> <code class="k">EXISTS</code> <code class="n">vacation_in_season_listeners</code> <code class="p">(</code>
  <code class="n">email</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="n">sku</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">20</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="n">email</code><code class="p">,</code> <code class="n">sku</code><code class="p">)</code>
<code class="p">);</code></pre>

<p>Remember that we took care to write <em>db-init.js</em> in a nondestructive fashion
so we could run it at any time. So we can just run it again to create the
<code>vacation_in_season_listeners</code> table.</p>

<p>Now we can modify <em>db.js</em> to include a method to update this table:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>
  <code class="c1">//...</code>
  <code class="nx">addVacationInSeasonListener</code><code class="o">:</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">email</code><code class="p">,</code> <code class="nx">sku</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">await</code> <code class="nx">pool</code><code class="p">.</code><code class="nx">query</code><code class="p">(</code>
      <code class="s1">'INSERT INTO vacation_in_season_listeners (email, sku) '</code> <code class="o">+</code>
      <code class="s1">'VALUES ($1, $2) '</code> <code class="o">+</code>
      <code class="s1">'ON CONFLICT DO NOTHING'</code><code class="p">,</code>
      <code class="p">[</code><code class="nx">email</code><code class="p">,</code> <code class="nx">sku</code><code class="p">]</code>
    <code class="p">)</code>
  <code class="p">},</code>
<code class="p">}</code></pre>

<p>PostgreSQL’s <code>ON CONFLICT</code> clause essentially enables upserts. In this case,
if the exact combination of email and SKU is already present, the user has
already registered to be notified, so we don’t need to do anything. If we had
other columns in this table (such as the date of last registration), we might
want to use a more sophisticated <code>ON CONFLICT</code> clause (see the
<a href="http://bit.ly/3724FJI">PostgreSQL INSERT
documentation</a> for more information). Note also that this behavior is
dependent on the way we defined the table. We made email and SKU a composite
primary key, meaning that there can’t be any duplicates, which in turn
necessitated the <code>ON CONFLICT</code> clause (otherwise, the <code>INSERT</code> command would
result in an error the second time a user tried to register for a
notification on the same vacation).</p>

<p>Now we’ve seen a complete example of hooking up two types of databases, an
object database and an RDBMS. It should be clear that the function of the
database is the same: storing, retrieving, and updating data in a consistent
and scalable fashion. Because the function is the same, we were able to
create an abstraction layer so we could choose a different database
technology. The last thing we might need a database for is for persistent
session storage, which we hinted at in <a data-type="xref" href="ch09.xhtml#ch_cookies_and_sessions">Chapter 9</a>.<a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc4" id="idm45053583174328"/><a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc3" id="idm45053583173608"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Using a Database for Session Storage"><div class="sect1" id="idm45053585899480">
<h1>Using a Database for Session Storage</h1>

<p><a data-type="indexterm" data-primary="databases" data-secondary="session storage" id="ix_ch-13-persistence-asciidoc12"/><a data-type="indexterm" data-primary="sessions" data-secondary="database for session data storage" id="ix_ch-13-persistence-asciidoc13"/>As we discussed in <a data-type="xref" href="ch09.xhtml#ch_cookies_and_sessions">Chapter 9</a>, using a memory
store for session data is unsuitable in a production environment.
Fortunately, it’s easy to use a database as a session store.</p>

<p>While we could use our existing MongoDB or PostgreSQL database for a session
store, a full-blown database is overkill for session storage, which is a
perfect use case for a key-value database. <a data-type="indexterm" data-primary="Redis" id="idm45053583123560"/>As I write this, the most popular
key-value databases for session stores are <a href="https://redis.io">Redis</a> and
<a href="https://memcached.org">Memcached</a>. In keeping with the other examples in this
chapter, we’ll be using a free online service to provide a Redis database.</p>

<p>Start by heading over to <a href="https://redislabs.com">Redis Labs</a> and create an
account. Then create a free subscription and plan. Choose Cache for the
plan and give the database a name; you can leave the rest of the settings at
their defaults.</p>

<p>You’ll reach a View Database screen, and, as I write this, the critical
information doesn’t populate for a few seconds, so be patient. What you’ll
want is the Endpoint field and the Redis Password under Access Control &amp;
Security (it’s hidden by default, but there’s a little button next to it
that will show it). Take these and put them in your
<em>.credentials.development.json</em> file:</p>

<pre data-type="programlisting" data-code-language="js"><code class="s2">"redis"</code><code class="o">:</code> <code class="p">{</code>
  <code class="s2">"url"</code><code class="o">:</code> <code class="s2">"redis://:&lt;YOUR PASSWORD&gt;@&lt;YOUR ENDPOINT&gt;"</code>
<code class="p">}</code></pre>

<p>Note the slightly odd URL: normally there would be a username before the
colon preceding your password, but Redis allows connection with a password
only; the colon that separates username from password is still required,
however.</p>

<p>We’ll be using a package called <code>connect-redis</code> to provide Redis session
storage. Once you’ve installed it (<code>npm install connect-redis</code>), we can
set it up in our main application file. We still use <code>expression-session</code>,
but now we pass a new property to it, <code>store</code>, which configures it to use a
database. Note that we have to pass <code>expressSession</code> to the function returned from
<code>connect-redis</code> to get the constructor: this is a pretty common quirk of
session stores (<em>ch13/00-mongodb/meadowlark.js</em> or
<em>ch13/01-postgres/meadowlark.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">expressSession</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express-session'</code><code class="p">)</code>
<code class="kr">const</code> <code class="nx">RedisStore</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'connect-redis'</code><code class="p">)(</code><code class="nx">expressSession</code><code class="p">)</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">cookieParser</code><code class="p">(</code><code class="nx">credentials</code><code class="p">.</code><code class="nx">cookieSecret</code><code class="p">))</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">expressSession</code><code class="p">({</code>
  <code class="nx">resave</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
  <code class="nx">saveUninitialized</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
  <code class="nx">secret</code><code class="o">:</code> <code class="nx">credentials</code><code class="p">.</code><code class="nx">cookieSecret</code><code class="p">,</code>
  <code class="nx">store</code><code class="o">:</code> <code class="k">new</code> <code class="nx">RedisStore</code><code class="p">({</code>
    <code class="nx">url</code><code class="o">:</code> <code class="nx">credentials</code><code class="p">.</code><code class="nx">redis</code><code class="p">.</code><code class="nx">url</code><code class="p">,</code>
    <code class="nx">logErrors</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>  <code class="c1">// highly recommended!</code>
  <code class="p">}),</code>
<code class="p">}))</code></pre>

<p>Let’s use our newly minted session store for something useful. Imagine we
want to be able to display vacation prices in different currencies.
Furthermore, we want the site to remember the user’s currency preference.</p>

<p>We’ll start by adding a currency picker at the bottom of our vacations
page:</p>

<pre data-type="programlisting" data-code-language="html"><code class="nt">&lt;hr&gt;</code>
<code class="nt">&lt;p&gt;</code>Currency:
    <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"/set-currency/USD"</code> <code class="na">class=</code><code class="s">"currency {{currencyUSD}}"</code><code class="nt">&gt;</code>USD<code class="nt">&lt;/a&gt;</code> |
    <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"/set-currency/GBP"</code> <code class="na">class=</code><code class="s">"currency {{currencyGBP}}"</code><code class="nt">&gt;</code>GBP<code class="nt">&lt;/a&gt;</code> |
    <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"/set-currency/BTC"</code> <code class="na">class=</code><code class="s">"currency {{currencyBTC}}"</code><code class="nt">&gt;</code>BTC<code class="nt">&lt;/a&gt;</code>
<code class="nt">&lt;/p&gt;</code></pre>

<p>Now here’s a little CSS (you can put this inline in your
<em>views/layouts/main.handlebars</em> file or link to a CSS file in your
<em>public</em> directory):</p>

<pre data-type="programlisting" data-code-language="css"><code class="nt">a</code><code class="nc">.currency</code> <code class="p">{</code>
  <code class="k">text-decoration</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>
<code class="p">}</code>
<code class="nc">.currency.selected</code> <code class="p">{</code>
  <code class="k">font-weight</code><code class="o">:</code> <code class="nb">bold</code><code class="p">;</code>
  <code class="k">font-size</code><code class="o">:</code> <code class="m">150%</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Lastly, we’ll add a route handler to set the currency and modify our route
handler for <em class="keep-together">/vacations</em> to display
prices in the current currency (<em>ch13/00-mongodb/lib/handlers.js</em> or
<em>ch13/01-postgres/lib/handlers.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">exports</code><code class="p">.</code><code class="nx">setCurrency</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">currency</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">currency</code>
  <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="mi">303</code><code class="p">,</code> <code class="s1">'/vacations'</code><code class="p">)</code>
<code class="p">}</code>

<code class="kd">function</code> <code class="nx">convertFromUSD</code><code class="p">(</code><code class="nx">value</code><code class="p">,</code> <code class="nx">currency</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">switch</code><code class="p">(</code><code class="nx">currency</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">case</code> <code class="s1">'USD'</code><code class="o">:</code> <code class="k">return</code> <code class="nx">value</code> <code class="o">*</code> <code class="mi">1</code>
    <code class="k">case</code> <code class="s1">'GBP'</code><code class="o">:</code> <code class="k">return</code> <code class="nx">value</code> <code class="o">*</code> <code class="mf">0.79</code>
    <code class="k">case</code> <code class="s1">'BTC'</code><code class="o">:</code> <code class="k">return</code> <code class="nx">value</code> <code class="o">*</code> <code class="mf">0.000078</code>
    <code class="k">default</code><code class="o">:</code> <code class="k">return</code> <code class="kc">NaN</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="nx">exports</code><code class="p">.</code><code class="nx">listVacations</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">Vacation</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code> <code class="nx">available</code><code class="o">:</code> <code class="kc">true</code> <code class="p">},</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">vacations</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">currency</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">currency</code> <code class="o">||</code> <code class="s1">'USD'</code>
    <code class="kr">const</code> <code class="nx">context</code> <code class="o">=</code> <code class="p">{</code>
      <code class="nx">currency</code><code class="o">:</code> <code class="nx">currency</code><code class="p">,</code>
      <code class="nx">vacations</code><code class="o">:</code> <code class="nx">vacations</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">vacation</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="k">return</code> <code class="p">{</code>
          <code class="nx">sku</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">sku</code><code class="p">,</code>
          <code class="nx">name</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code>
          <code class="nx">description</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">description</code><code class="p">,</code>
          <code class="nx">inSeason</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">inSeason</code><code class="p">,</code>
          <code class="nx">price</code><code class="o">:</code> <code class="nx">convertFromUSD</code><code class="p">(</code><code class="nx">vacation</code><code class="p">.</code><code class="nx">price</code><code class="p">,</code> <code class="nx">currency</code><code class="p">),</code>
          <code class="nx">qty</code><code class="o">:</code> <code class="nx">vacation</code><code class="p">.</code><code class="nx">qty</code><code class="p">,</code>
        <code class="p">}</code>
      <code class="p">})</code>
    <code class="p">}</code>
    <code class="k">switch</code><code class="p">(</code><code class="nx">currency</code><code class="p">){</code>
      <code class="k">case</code> <code class="s1">'USD'</code><code class="o">:</code> <code class="nx">context</code><code class="p">.</code><code class="nx">currencyUSD</code> <code class="o">=</code> <code class="s1">'selected'</code><code class="p">;</code> <code class="k">break</code>
      <code class="k">case</code> <code class="s1">'GBP'</code><code class="o">:</code> <code class="nx">context</code><code class="p">.</code><code class="nx">currencyGBP</code> <code class="o">=</code> <code class="s1">'selected'</code><code class="p">;</code> <code class="k">break</code>
      <code class="k">case</code> <code class="s1">'BTC'</code><code class="o">:</code> <code class="nx">context</code><code class="p">.</code><code class="nx">currencyBTC</code> <code class="o">=</code> <code class="s1">'selected'</code><code class="p">;</code> <code class="k">break</code>
    <code class="p">}</code>
    <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'vacations'</code><code class="p">,</code> <code class="nx">context</code><code class="p">)</code>
  <code class="p">})</code>
<code class="p">}</code></pre>

<p>You’ll also have to add a route for setting the currency in
<em>meadowlark.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/set-currency/:currency'</code><code class="p">,</code> <code class="nx">handlers</code><code class="p">.</code><code class="nx">setCurrency</code><code class="p">)</code></pre>

<p>This isn’t a great way to perform currency conversion, of course. We would
want to utilize a third-party currency conversion API to make sure our
rates are up-to-date. But this will suffice
for demonstration purposes. You can now switch between the various
<span class="keep-together">currencies</span> and—go ahead and try
it—stop and restart your server. You’ll find it remembers your currency
preference! If you clear your cookies, the currency preference will be
forgotten. You’ll notice that now we’ve lost our pretty currency
formatting; it’s now more complicated, and I will leave that as an exercise
for the reader.</p>

<p>Another reader’s exercise would be to make the <code>set-currency</code> route
general-purpose to make it more useful. Currently, it will always redirect
to the vacations page, but what if you wanted to use it on a shopping cart
page? See if you can think of one or two ways of solving this problem.</p>

<p>If you look in your database, you’ll find there’s a new collection called
<em>sessions</em>. If you explore that collection, you’ll find a document with
your session ID (property <code>sid</code>) and your currency preference.<a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc13" id="idm45053582533768"/><a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc12" id="idm45053582533096"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="idm45053583128744">
<h1>Conclusion</h1>

<p>We’ve certainly covered a lot of ground in this chapter. For most web
applications, the database is at the heart of what makes the application
useful. Designing and tuning databases is a vast topic that could span many
books, but I hope this has given you the basic tools you need to connect
two types of databases and move data around.<a data-type="indexterm" data-startref="ix_ch-13-persistence-asciidoc0" id="idm45053582531208"/></p>

<p>Now that we have this fundamental piece in place, we’re going to revisit
routing and the importance it plays in web applications.</p>
</div></section>







</div></section></div>



  </body></html>