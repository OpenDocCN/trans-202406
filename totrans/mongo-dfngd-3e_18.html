<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. Introduction to Sharding"><div class="chapter" id="chapter_d1e10482"><h1><span class="label">Chapter 14. </span>Introduction to Sharding</h1><p>This chapter covers how to scale with MongoDB. We’ll look at:</p><ul><li><p>What sharding is and the components of a cluster</p></li><li><p>How to configure sharding</p></li><li><p>The basics of how sharding interacts with your application</p></li></ul><section data-type="sect1" data-pdf-bookmark="What Is Sharding?"><div class="sect1" id="idm45882349196712"><h1>What Is Sharding?</h1><p><em>Sharding</em> refers<a data-type="indexterm" data-primary="sharding, basics of" data-secondary="definition of sharding" id="idm45882349195512"/> to the process of splitting data up across machines; the
    term <em>partitioning<a data-type="indexterm" data-primary="partitioning" id="idm45882349193960"/></em> is also sometimes used to describe this concept.
    By<a data-type="indexterm" data-primary="sharding, basics of" data-secondary="benefits of sharding" id="idm45882349192968"/> putting a subset of data on each machine, it becomes
    possible to store more data and handle more load without requiring larger
    or more powerful machines—just a larger quantity of less-powerful
    machines. Sharding may be used for other purposes as well, including
    placing more frequently accessed data on more performant hardware or
    splitting a dataset based on geography to locate a subset of documents in
    a collection (e.g., for users based in a particular locale) close to the
    application servers from which they are most commonly accessed.</p><p><span class="firstterm">Manual sharding<a data-type="indexterm" data-primary="manual sharding" id="idm45882349190488"/></span><a data-type="indexterm" data-primary="sharding, basics of" data-secondary="manual sharding" id="idm45882349189624"/> can be done with almost any database software. With this
    approach, an application maintains connections to several different
    database servers, each of which are completely independent. The
    application manages storing different data on different servers and
    querying against the appropriate server to get data back. This setup can
    work well but becomes difficult to maintain when adding or removing nodes
    from the cluster or in the face of changing data distributions or load
    patterns.</p><p>MongoDB supports<a data-type="indexterm" data-primary="autosharding" id="idm45882349187640"/><a data-type="indexterm" data-primary="sharding, basics of" data-secondary="autosharding" id="idm45882349186776"/> <span class="firstterm">autosharding</span>, which tries to both
    abstract the architecture away from the application and simplify the
    administration of such a system. MongoDB allows your application to ignore
    the fact that it isn’t talking to a standalone MongoDB server, to some
    extent. On the operations side, MongoDB automates balancing data across
    shards and makes it easier to add and remove capacity.</p><p>Sharding<a data-type="indexterm" data-primary="sharding, basics of" data-secondary="complexity of sharding" id="idm45882349184168"/> is the most complex way of configuring MongoDB, both from a
    development and an operational point of view. There are many components to
    configure and monitor, and data moves around the cluster automatically.
    You should be comfortable with standalone servers and replica sets before
    attempting to deploy or use a sharded cluster. Also, as with replica sets,
    the recommended means of configuring and deploying sharded clusters is
    through either MongoDB Ops Manager<a data-type="indexterm" data-primary="Ops Manager" id="idm45882349182408"/> or MongoDB Atlas<a data-type="indexterm" data-primary="MongoDB Atlas" id="idm45882349181448"/>. Ops Manager is recommended if you need to maintain control
    of your computing infrastructure. MongoDB Atlas is recommended if you can
    leave the infrastructure management to MongoDB (you have the option of
    running in Amazon AWS, Microsoft Azure, or Google Compute Cloud).</p><section data-type="sect2" data-pdf-bookmark="Understanding the Components of a Cluster"><div class="sect2" id="idm45882349180152"><h2>Understanding the Components of a Cluster</h2><p>MongoDB’s<a data-type="indexterm" data-primary="clusters" data-secondary="components of" id="idm45882349179144"/> sharding allows you to create a cluster of many machines
      (<span class="firstterm">shards</span>) and break up a collection across them,
      putting a subset of data on each shard. This allows your application to
      grow beyond the resource limits of a standalone server or replica
      set.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>Many<a data-type="indexterm" data-primary="replication" data-secondary="versus sharding" id="idm45882349176280"/><a data-type="indexterm" data-primary="sharding, basics of" data-secondary="sharding versus replication" id="idm45882349175144"/> people are confused about the difference between
        replication and sharding. Remember that replication creates an exact
        copy of your data on multiple servers, so every server is a mirror
        image of every other server. Conversely, every shard contains a
        different subset of data.</p></div><p>One<a data-type="indexterm" data-primary="sharding, basics of" data-secondary="goals of sharding" id="idm45882349173096"/> of the goals of sharding is to make a cluster of 2, 3,
      10, or even hundreds of shards look like a single machine to your
      application. To hide these details from the application, we run one or
      more routing processes called a <em>mongos</em> in front of
      the shards. A<a data-type="indexterm" data-primary="mongos" data-secondary="purpose of" id="idm45882349171192"/> <em>mongos</em> keeps a “table of contents”
      that tells it which shard contains which data. Applications can connect
      to this router and issue requests normally, as shown in <a data-type="xref" href="#sharded_client_connection">Figure 14-1</a>. The router, knowing what data is
      on which shard, is able to forward the requests to the appropriate
      shard(s). If there are responses to a request the router collects them
      and, if necessary, merges them, and sends them back to the application.
      As far as the application knows, it’s connected to a standalone
      <em>mongod</em>, as illustrated in <a data-type="xref" href="#nonsharded_client_connection">Figure 14-2</a>.</p><figure style="float: none"><div id="sharded_client_connection" class="figure"><img src="Images/mdb3_1401.png" width="659" height="534"/><h6><span class="label">Figure 14-1. </span>Sharded client connection</h6></div></figure><figure style="float: none"><div id="nonsharded_client_connection" class="figure"><img src="Images/mdb3_1402.png" width="148" height="254"/><h6><span class="label">Figure 14-2. </span>Nonsharded client connection</h6></div></figure></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Sharding on a Single-Machine Cluster"><div class="sect1" id="idm45882349163912"><h1>Sharding on a Single-Machine Cluster</h1><p>We’ll start<a data-type="indexterm" data-primary="clusters" data-secondary="sharding on single-machine" id="Csingle14"/><a data-type="indexterm" data-primary="sharding, basics of" data-secondary="sharding on single-machine clusters" id="Ssingle14"/> by setting up a quick cluster on a single machine. First,
    start a <em>mongo</em> shell with the <code class="option">--nodb<a data-type="indexterm" data-primary="--nodb option" data-primary-sortas="nodb option" id="idm45882349158264"/></code> and <code class="option">--norc<a data-type="indexterm" data-primary="--norc options" data-primary-sortas="norc options" id="idm45882349156440"/> </code>options:</p><pre data-type="programlisting">$ mongo --nodb --norc</pre><p>To create a cluster, use the <code class="classname">ShardingTest</code>
    class<a data-type="indexterm" data-primary="ShardingTest class" id="idm45882349153512"/>. Run the following in the <em>mongo</em> shell
    you just launched:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">st</code> <code class="o">=</code> <code class="nx">ShardingTest</code><code class="p">({</code>
  <code class="nx">name</code><code class="o">:</code><code class="s2">"one-min-shards"</code><code class="p">,</code>
  <code class="nx">chunkSize</code><code class="o">:</code><code class="mi">1</code><code class="p">,</code>
  <code class="nx">shards</code><code class="o">:</code><code class="mi">2</code><code class="p">,</code>
  <code class="nx">rs</code><code class="o">:</code><code class="p">{</code>
    <code class="nx">nodes</code><code class="o">:</code><code class="mi">3</code><code class="p">,</code>
    <code class="nx">oplogSize</code><code class="o">:</code><code class="mi">10</code>
  <code class="p">},</code>
  <code class="nx">other</code><code class="o">:</code><code class="p">{</code>
    <code class="nx">enableBalancer</code><code class="o">:</code><code class="kc">true</code>
  <code class="p">}</code>
<code class="p">});</code></pre><p>The <code class="option">chunksize</code> option is covered in <a data-type="xref" href="ch17.xhtml#chapter-sharding-admin">Chapter 17</a>. For now, simply set it to <code>1</code>. As for the other options passed to <code>ShardingTest</code> here, <code class="option">name</code> simply
    provides a label for our <span class="keep-together">sharded</span> cluster, <code class="option">shards</code>
    specifies that our cluster will be composed of two shards (we do this to
    keep the resource requirements low for this example), and
    <code class="option">rs</code> defines<a data-type="indexterm" data-primary="oplogs" data-secondary="defining size of" id="idm45882349111480"/> each shard as a three-node replica set with an <code>oplogSize</code> of 10 MiB (again, to keep resource
    shard as a three-node replica set with an <code>oplogSize</code> of 10 MiB (again, to keep resource
    utilization low). Though it is possible to run one standalone
    <em>mongod</em> for each shard, it paints a clearer picture of
    the typical architecture of a sharded cluster if we create each shard as a
    replica set. In the last option specified, we are instructing <code>ShardingTest</code> to enable the balancer once the
    cluster is spun up. This will ensure that data is evenly distributed
    across both shards.</p><p><code>ShardingTest</code> is a class designed
    for internal use by MongoDB Engineering and is therefore undocumented
    externally. However, because it ships with the MongoDB server, it provides
    the most straightforward means of experimenting with a sharded cluster.
    <code>ShardingTest</code> was originally designed to
    support server test suites and is still used for this purpose. By default
    it provides a number of conveniences that help in keeping resource
    utilization as small as possible and in setting up the relatively complex
    architecture of a sharded cluster. It makes an assumption about the
    presence of a <code>/data /db</code> directory on
    your machine; if <code>ShardingTest</code> fails to
    run then create this directory and rerun the command again.</p><p>When you run this command, <code>ShardingTest</code> will do a lot for you
    automatically. It will create a new cluster with two shards, each of which
    is a replica set. It will configure the replica sets and launch each node
    with the necessary options to establish replication protocols. It will
    launch a <em>mongos</em> to manage requests across the shards
    so that clients can interact with the cluster as if communicating with a
    standalone <em>mongod</em>, to some extent. Finally, it will
    launch an additional replica set for the config servers that maintain the
    routing table information necessary to ensure queries are directed to the
    correct shard. Remember<a data-type="indexterm" data-primary="sharding, basics of" data-secondary="primary use case for" id="idm45882349103752"/> that the primary use cases for sharding are to split a
    dataset to address hardware and cost constraints or to provide better
    performance to applications (e.g., geographical partitioning). MongoDB
    sharding provides these capabilities in a way that is seamless to the
    application in many respects.</p><p>Once <code>ShardingTest</code> has finished
    setting up your cluster, you will have 10 processes up and running to
    which you can connect: two replica sets of three nodes each, one config
    server replica set of three nodes, and one <em>mongos</em>. By
    default, these processes should begin at port 20000. The
    <em>mongos</em> should be running at port 20009. Other
    processes you have running on your local machine and previous calls to
    <code>ShardingTest</code> can have an effect on
    which ports <code>ShardingTest</code> uses, but you
    should not have too much difficulty determining the ports on which your
    cluster processes are running.</p><p>Next, you’ll connect to the <em class="filename">mongos</em> to play around with the cluster. Your
    entire cluster will be dumping its logs to your current shell, so open up
    a second terminal window and launch another <em>mongo</em>
    shell:</p><pre data-type="programlisting">$ mongo --nodb</pre><p>Use this shell to connect to your cluster’s <em class="filename">mongos</em>. Again, your <em>mongos</em>
    should be running on port 20009:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code> <code class="o">=</code> <code class="p">(</code><code class="k">new</code> <code class="nx">Mongo</code><code class="p">(</code><code class="s2">"localhost:20009"</code><code class="p">)).</code><code class="nx">getDB</code><code class="p">(</code><code class="s2">"accounts"</code><code class="p">)</code></pre><p>Note<a data-type="indexterm" data-primary="mongo shell" data-secondary="prompt when connected" id="idm45882349087416"/> that the prompt in your <em>mongo</em> shell
    should change to reflect that you are connected to a
    <em>mongos</em>. Now you are in the situation shown earlier,
    in <a data-type="xref" href="#sharded_client_connection">Figure 14-1</a>: the shell is the client
    and is connected to a <em class="filename">mongos</em>. You can
    start passing requests to the <em class="filename">mongos</em>
    and it’ll route them to the shards. You don’t really have to know anything
    about the shards, like how many there are or what their addresses are. So
    long as there are some shards out there, you can pass the requests to the
    <em class="filename">mongos</em> and allow it to forward them
    appropriately.</p><p>Start by inserting some data:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="nx">i</code><code class="o">&lt;</code><code class="mi">100000</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="p">...</code>     <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user"</code><code class="o">+</code><code class="nx">i</code><code class="p">,</code> <code class="s2">"created_at"</code> <code class="o">:</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">()});</code>
<code class="p">...</code> <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">count</code><code class="p">()</code>
<code class="mi">100000</code></pre><p>As you can see, interacting with <em class="filename">mongos</em> works the same way as interacting with a
    standalone server does.</p><p>You can get an overall view of your cluster by running <code class="function">sh.status()</code>. It will give you a summary of your
    shards, databases, and collections:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">status</code><code class="p">()</code>
<code class="o">---</code> <code class="nx">Sharding</code> <code class="nx">Status</code> <code class="o">---</code> 
<code class="nx">sharding</code> <code class="nx">version</code><code class="o">:</code> <code class="p">{</code>
  <code class="s2">"_id"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
  <code class="s2">"minCompatibleVersion"</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
  <code class="s2">"currentVersion"</code><code class="o">:</code> <code class="mi">6</code><code class="p">,</code>
  <code class="s2">"clusterId"</code><code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5a4f93d6bcde690005986071"</code><code class="p">)</code>
<code class="p">}</code>
<code class="nx">shards</code><code class="o">:</code>
<code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"one-min-shards-rs0"</code><code class="p">,</code> 
  <code class="s2">"host"</code> <code class="o">:</code> 
    <code class="s2">"one-min-shards-rs0/MBP:20000,MBP:20001,MBP:20002"</code><code class="p">,</code>
  <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"one-min-shards-rs1"</code><code class="p">,</code>  
   <code class="s2">"host"</code> <code class="o">:</code> 
     <code class="s2">"one-min-shards-rs1/MBP:20003,MBP:20004,MBP:20005"</code><code class="p">,</code>
   <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="nx">active</code> <code class="nx">mongoses</code><code class="o">:</code>
  <code class="s2">"3.6.1"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="nx">autosplit</code><code class="o">:</code>
  <code class="nx">Currently</code> <code class="nx">enabled</code><code class="o">:</code> <code class="nx">no</code>
<code class="nx">balancer</code><code class="o">:</code>
  <code class="nx">Currently</code> <code class="nx">enabled</code><code class="o">:</code>  <code class="nx">no</code>
  <code class="nx">Currently</code> <code class="nx">running</code><code class="o">:</code>  <code class="nx">no</code>
  <code class="nx">Failed</code> <code class="nx">balancer</code> <code class="nx">rounds</code> <code class="k">in</code> <code class="nx">last</code> <code class="mi">5</code> <code class="nx">attempts</code><code class="o">:</code>  <code class="mi">0</code>
  <code class="nx">Migration</code> <code class="nx">Results</code> <code class="k">for</code> <code class="nx">the</code> <code class="nx">last</code> <code class="mi">24</code> <code class="nx">hours</code><code class="o">:</code> 
    <code class="nx">No</code> <code class="nx">recent</code> <code class="nx">migrations</code>
<code class="nx">databases</code><code class="o">:</code>
  <code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"accounts"</code><code class="p">,</code>  <code class="s2">"primary"</code> <code class="o">:</code> <code class="s2">"one-min-shards-rs1"</code><code class="p">,</code>  
     <code class="s2">"partitioned"</code> <code class="o">:</code> <code class="kc">false</code> <code class="p">}</code>
  <code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"config"</code><code class="p">,</code>  <code class="s2">"primary"</code> <code class="o">:</code> <code class="s2">"config"</code><code class="p">,</code>  
     <code class="s2">"partitioned"</code> <code class="o">:</code> <code class="kc">true</code> <code class="p">}</code>
  <code class="nx">config</code><code class="p">.</code><code class="nx">system</code><code class="p">.</code><code class="nx">sessions</code>
<code class="nx">shard</code> <code class="nx">key</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="nx">unique</code><code class="o">:</code> <code class="kc">false</code>
<code class="nx">balancing</code><code class="o">:</code> <code class="kc">true</code>
<code class="nx">chunks</code><code class="o">:</code>
  <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs0</code>	<code class="mi">1</code>
  <code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$minKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> <code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$maxKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code> 
  <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs0</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code></pre><div data-type="note" epub:type="note"><h6>Note</h6><p><code>sh</code> is<a data-type="indexterm" data-primary="sh global variable" id="idm45882348960760"/><a data-type="indexterm" data-primary="sharding, basics of" data-secondary="sh global variable" id="idm45882348959992"/> similar to <code>rs</code>, but for
      sharding: it is a global variable that defines a number of sharding
      helper functions, which you can see by running <code class="function">sh.help()<a data-type="indexterm" data-primary="sh.help()" id="idm45882348957592"/></code>. As you can see from the <code class="function">sh.status()<a data-type="indexterm" data-primary="sh.status()" id="idm45882348692232"/></code> output, you have two shards and two databases
      (<em class="filename">config</em> is created
      <span class="keep-together">automatically</span>).</p></div><p>Your <em class="filename">accounts</em> database may have
    a different <span class="firstterm">primary shard</span> than the one shown here.
    A primary shard is a “home base” shard that is randomly chosen for each
    database. All of your data will be on this primary shard. MongoDB cannot
    automatically distribute your data yet because it doesn’t know how (or if)
    you want it to be distributed. You have to tell it, per collection, how
    you want it to distribute data.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>A primary shard is different from a replica set primary. A primary
      shard<a data-type="indexterm" data-primary="sharding, basics of" data-secondary="primary shards" id="idm45882348687144"/><a data-type="indexterm" data-primary="primary shards" id="idm45882348686040"/> refers to the entire replica set composing a shard. A
      primary in a replica set is the single server in the set that can take
      writes.</p></div><p>To shard a particular collection, first enable sharding on the
    collection’s database. To do so, run<a data-type="indexterm" data-primary="enableSharding command" id="idm45882348684536"/> the <code class="function">enableSharding</code>
    command:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">enableSharding</code><code class="p">(</code><code class="s2">"accounts"</code><code class="p">)</code></pre><p>Now sharding is enabled on the <em class="filename">accounts</em> database, which allows you to shard
    collections within the database.</p><p>When<a data-type="indexterm" data-primary="keys" data-secondary="shard keys" id="idm45882348677080"/><a data-type="indexterm" data-primary="sharding, basics of" data-secondary="shard keys" data-seealso="shard keys, choosing" id="SBOkey14"/> you shard a collection, you choose a <span class="firstterm">shard
    key</span>. This is a field or two that MongoDB uses to break up
    data. For example, if you chose to shard on <code>"username"</code>, MongoDB would break up the data into
    ranges of usernames: <code class="varname">"a1-steak-sauce"</code> through
    <code class="varname">"defcon"</code>, <code class="varname">"defcon1"</code> through
    <code class="varname">"howie1998"</code>, and so on. Choosing a shard key can be
    thought of as choosing an ordering for the data in the collection. This is
    a similar concept to indexing, and for good reason: the shard key becomes
    the most important index on your collection as it gets bigger. To even
    create a shard key, the field(s) must be indexed.</p><p>So, before enabling sharding, you have to create an index on the key
    you want to shard by:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">({</code><code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><p>Now you can shard the collection by <code>"username"</code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">shardCollection</code><code class="p">(</code><code class="s2">"accounts.users"</code><code class="p">,</code> <code class="p">{</code><code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><p>Although we are choosing a shard key without much thought here, it
    is an important decision that should be carefully considered in a real
    system. See <a data-type="xref" href="ch16.xhtml#chapter-shardkey">Chapter 16</a> for more advice on
    choosing a shard key.</p><p>If you wait a few minutes and run <code class="function">sh.status()</code> again, you’ll see that there’s a
    lot more information displayed than there was before:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">status</code><code class="p">()</code>
<code class="o">---</code> <code class="nx">Sharding</code> <code class="nx">Status</code> <code class="o">---</code> 
<code class="nx">sharding</code> <code class="nx">version</code><code class="o">:</code> <code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
  <code class="s2">"minCompatibleVersion"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
  <code class="s2">"currentVersion"</code> <code class="o">:</code> <code class="mi">6</code><code class="p">,</code>
  <code class="s2">"clusterId"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5a4f93d6bcde690005986071"</code><code class="p">)</code>
<code class="p">}</code>
<code class="nx">shards</code><code class="o">:</code>
  <code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"one-min-shards-rs0"</code><code class="p">,</code> 
     <code class="s2">"host"</code> <code class="o">:</code> 
       <code class="s2">"one-min-shards-rs0/MBP:20000,MBP:20001,MBP:20002"</code><code class="p">,</code>  
     <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
  <code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"one-min-shards-rs1"</code><code class="p">,</code>  
     <code class="s2">"host"</code> <code class="o">:</code> 
       <code class="s2">"one-min-shards-rs1/MBP:20003,MBP:20004,MBP:20005"</code><code class="p">,</code>
     <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="nx">active</code> <code class="nx">mongoses</code><code class="o">:</code>
  <code class="s2">"3.6.1"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="nx">autosplit</code><code class="o">:</code>
  <code class="nx">Currently</code> <code class="nx">enabled</code><code class="o">:</code> <code class="nx">no</code>
<code class="nx">balancer</code><code class="o">:</code>
  <code class="nx">Currently</code> <code class="nx">enabled</code><code class="o">:</code>  <code class="nx">yes</code>
  <code class="nx">Currently</code> <code class="nx">running</code><code class="o">:</code>  <code class="nx">no</code>
  <code class="nx">Failed</code> <code class="nx">balancer</code> <code class="nx">rounds</code> <code class="k">in</code> <code class="nx">last</code> <code class="mi">5</code> <code class="nx">attempts</code><code class="o">:</code>  <code class="mi">0</code>
  <code class="nx">Migration</code> <code class="nx">Results</code> <code class="k">for</code> <code class="nx">the</code> <code class="nx">last</code> <code class="mi">24</code> <code class="nx">hours</code><code class="o">:</code> 
    <code class="mi">6</code> <code class="o">:</code> <code class="nx">Success</code>
<code class="nx">databases</code><code class="o">:</code>
  <code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"accounts"</code><code class="p">,</code>  <code class="s2">"primary"</code> <code class="o">:</code> <code class="s2">"one-min-shards-rs1"</code><code class="p">,</code>  
     <code class="s2">"partitioned"</code> <code class="o">:</code> <code class="kc">true</code> <code class="p">}</code>
<code class="nx">accounts</code><code class="p">.</code><code class="nx">users</code>
  <code class="nx">shard</code> <code class="nx">key</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
  <code class="nx">unique</code><code class="o">:</code> <code class="kc">false</code>
  <code class="nx">balancing</code><code class="o">:</code> <code class="kc">true</code>
  <code class="nx">chunks</code><code class="o">:</code>
    <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs0</code>	<code class="mi">6</code>
    <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs1</code>	<code class="mi">7</code>
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$minKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user17256"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs0</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user17256"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user24515"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs0</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user24515"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user31775"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs0</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user31775"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user39034"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs0</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user39034"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user46294"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs0</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">6</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user46294"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user53553"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs0</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">7</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user53553"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user60812"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs1</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">7</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user60812"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user68072"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs1</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">7</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user68072"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user75331"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs1</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user75331"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user82591"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs1</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">9</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user82591"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user89851"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs1</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">10</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user89851"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user9711"</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs1</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">11</code><code class="p">)</code> 
    <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user9711"</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$maxKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs1</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">12</code><code class="p">)</code> 
    <code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"config"</code><code class="p">,</code>  <code class="s2">"primary"</code> <code class="o">:</code> <code class="s2">"config"</code><code class="p">,</code>  <code class="s2">"partitioned"</code> <code class="o">:</code> <code class="kc">true</code> <code class="p">}</code>
<code class="nx">config</code><code class="p">.</code><code class="nx">system</code><code class="p">.</code><code class="nx">sessions</code>
  <code class="nx">shard</code> <code class="nx">key</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
  <code class="nx">unique</code><code class="o">:</code> <code class="kc">false</code>
  <code class="nx">balancing</code><code class="o">:</code> <code class="kc">true</code>
  <code class="nx">chunks</code><code class="o">:</code>
    <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs0</code>	<code class="mi">1</code>
    <code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$minKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
      <code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$maxKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">one</code><code class="o">-</code><code class="nx">min</code><code class="o">-</code><code class="nx">shards</code><code class="o">-</code><code class="nx">rs0</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code></pre><p>The collection has been split up into 13 chunks, where each chunk is
    a subset of your data. These are listed by shard key range (the
    <code>{"username" : <em><code>minValue</code></em>} --&gt;&gt;
    {"username" : <em><code>maxValue</code></em>}</code> denotes the
    range of each chunk). Looking at the <code>"on" :
    <em><code>shard</code></em></code> part of the output, you can see
    that these chunks have been evenly distributed between the shards.</p><p>This process of a collection<a data-type="indexterm" data-primary="collections" data-secondary="sharding" id="idm45882348346040"/> being split into chunks is shown graphically in Figures <a data-type="xref" data-xrefstyle="select: labelnumber" href="#figure-unsplit-coll">14-3</a> through <a data-type="xref" data-xrefstyle="select: labelnumber" href="#figure-dist-coll">14-5</a>. Before sharding, the collection is
    essentially a single chunk. Sharding splits it into smaller chunks based
    on the shard key, as shown in <a data-type="xref" href="#figure-split-coll">Figure 14-4</a>. These
    chunks can then be distributed across the cluster, as <a data-type="xref" href="#figure-dist-coll">Figure 14-5</a> shows.</p><figure style="float: 0"><div id="figure-unsplit-coll" class="figure"><img src="Images/mdb3_1403.png" width="1239" height="163"/><h6><span class="label">Figure 14-3. </span>Before a collection is sharded, it can be thought of as a single
      chunk from the smallest value of the shard key to the largest</h6></div></figure><figure style="float: 0"><div id="figure-split-coll" class="figure"><img src="Images/mdb3_1404.png" width="1327" height="243"/><h6><span class="label">Figure 14-4. </span>Sharding splits the collection into many chunks based on shard
      key ranges</h6></div></figure><figure style="float: 0"><div id="figure-dist-coll" class="figure"><img src="Images/mdb3_1405.png" width="1356" height="430"/><h6><span class="label">Figure 14-5. </span>Chunks are evenly distributed across the available shards</h6></div></figure><p>Notice the keys at the beginning and end of the chunk list:
    <code class="varname">$minKey</code><a data-type="indexterm" data-primary="$minKey" id="idm45882347965944"/> and <code class="varname">$maxKey</code><a data-type="indexterm" data-primary="$maxKey" id="idm45882347964392"/>. <code class="varname">$minKey</code> can be thought of as “negative
    infinity.” It is smaller than any other value in MongoDB. Similarly,
    <code class="varname">$maxKey</code> is like “positive infinity.” It is greater than
    any other value. Thus, you’ll always see these as the “caps” on your chunk
    ranges. The values for your shard key will always be between
    <code class="varname">$minKey</code> and <code class="varname">$maxKey</code>. These values
    are actually BSON types and should not be used in your application; they
    are mainly for internal use. If you wish to refer to them in the shell,
    use the <code class="classname">MinKey<a data-type="indexterm" data-primary="MinKey constant" id="idm45882347959512"/></code> and <code class="classname">MaxKey</code>
    <span class="keep-together">constants</span><a data-type="indexterm" data-primary="MaxKey constant" id="idm45882347957240"/>.</p><p>Now<a data-type="indexterm" data-primary="queries" data-secondary="across multiple shards" id="idm45882347966472"/><a data-type="indexterm" data-primary="sharding, basics of" data-secondary="querying" id="idm45882347955336"/> that the data is distributed across multiple shards, let’s
    try doing some queries. First, try a query on a specific username:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">username</code><code class="o">:</code> <code class="s2">"user12345"</code><code class="p">})</code>
<code class="p">{</code> 
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5a4fb11dbb9ce6070f377880"</code><code class="p">),</code> 
    <code class="s2">"username"</code> <code class="o">:</code> <code class="s2">"user12345"</code><code class="p">,</code> 
    <code class="s2">"created_at"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2018-01-05T17:08:45.657Z"</code><code class="p">)</code> 
<code class="p">}</code></pre><p>As you can see, querying works normally. However, let’s run an
    <code class="function">explain</code> to see what MongoDB is doing
    under the covers:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">username</code><code class="o">:</code> <code class="s2">"user12345"</code><code class="p">}}).</code><code class="nx">explain</code><code class="p">()</code>
<code class="p">{</code>
  <code class="s2">"queryPlanner"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"mongosPlannerVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"winningPlan"</code> <code class="o">:</code> <code class="p">{</code>
      <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"SINGLE_SHARD"</code><code class="p">,</code>
      <code class="s2">"shards"</code> <code class="o">:</code> <code class="p">[{</code>
    <code class="s2">"shardName"</code> <code class="o">:</code> <code class="s2">"one-min-shards-rs0"</code><code class="p">,</code>
    <code class="s2">"connectionString"</code> <code class="o">:</code>
      <code class="s2">"one-min-shards-rs0/MBP:20000,MBP:20001,MBP:20002"</code><code class="p">,</code>
    <code class="s2">"serverInfo"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"MBP"</code><code class="p">,</code>
        <code class="s2">"port"</code> <code class="o">:</code> <code class="mi">20000</code><code class="p">,</code>
      <code class="s2">"version"</code> <code class="o">:</code> <code class="s2">"3.6.1"</code><code class="p">,</code>
      <code class="s2">"gitVersion"</code> <code class="o">:</code> <code class="s2">"025d4f4fe61efd1fb6f0005be20cb45a004093d1"</code>
    <code class="p">},</code>
    <code class="s2">"plannerVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"namespace"</code> <code class="o">:</code> <code class="s2">"accounts.users"</code><code class="p">,</code>
    <code class="s2">"indexFilterSet"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"parsedQuery"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"username"</code> <code class="o">:</code> <code class="p">{</code>
         <code class="s2">"$eq"</code> <code class="o">:</code> <code class="s2">"user12345"</code>
       <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"winningPlan"</code> <code class="o">:</code> <code class="p">{</code>
      <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"FETCH"</code><code class="p">,</code>
      <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"SHARDING_FILTER"</code><code class="p">,</code>
          <code class="s2">"inputStage"</code> <code class="o">:</code> <code class="p">{</code>
              <code class="s2">"stage"</code> <code class="o">:</code> <code class="s2">"IXSCAN"</code><code class="p">,</code>
          <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"username"</code> <code class="o">:</code> <code class="mi">1</code>
          <code class="p">},</code>
          <code class="s2">"indexName"</code> <code class="o">:</code> <code class="s2">"username_1"</code><code class="p">,</code>
          <code class="s2">"isMultiKey"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
          <code class="s2">"multiKeyPaths"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
          <code class="p">},</code>
          <code class="s2">"isUnique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
              <code class="s2">"isSparse"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"isPartial"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
          <code class="s2">"indexVersion"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
          <code class="s2">"direction"</code> <code class="o">:</code> <code class="s2">"forward"</code><code class="p">,</code>
          <code class="s2">"indexBounds"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"username"</code> <code class="o">:</code> <code class="p">[</code>
                  <code class="s2">"[\"user12345\", \"user12345\"]"</code>
        <code class="p">]</code>
          <code class="p">}</code>
        <code class="p">}</code>
          <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"rejectedPlans"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
      <code class="p">}]</code>
    <code class="p">}</code>
  <code class="p">},</code>
  <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
  <code class="s2">"$clusterTime"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"clusterTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1515174248</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
    <code class="s2">"signature"</code> <code class="o">:</code> <code class="p">{</code>
      <code class="s2">"hash"</code> <code class="o">:</code> <code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
      <code class="s2">"keyId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
    <code class="p">}</code>
  <code class="p">},</code>
  <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1515173700</code><code class="p">,</code> <code class="mi">201</code><code class="p">)</code>
<code class="p">}</code></pre><p>From the <code class="option">"winningPlan"</code> field in the <code>explain</code> output, we can see that our cluster
    satisfied this query using a single shard, <em class="filename">one-min-shards-rs0</em>. Based on the output of
    <span class="keep-together"><code class="function">sh.status()</code> shown earlier</span>, we can see
    that <em>user12345</em> does fall within the key range for the
    first chunk listed for that shard in our cluster.</p><p>Because <code>"username"</code> is the shard
    key, <em class="filename">mongos</em> was able to route the
    query directly to the correct shard. Contrast that with the results for
    querying for all of the users:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">users</code><code class="p">.</code><code class="nx">find</code><code class="p">().</code><code class="nx">explain</code><code class="p">()</code>
<code class="p">{</code>
  <code class="s2">"queryPlanner"</code><code class="o">:</code><code class="p">{</code>
    <code class="s2">"mongosPlannerVersion"</code><code class="o">:</code><code class="mi">1</code><code class="p">,</code>
    <code class="s2">"winningPlan"</code><code class="o">:</code><code class="p">{</code>
      <code class="s2">"stage"</code><code class="o">:</code><code class="s2">"SHARD_MERGE"</code><code class="p">,</code>
      <code class="s2">"shards"</code><code class="o">:</code><code class="p">[</code>
        <code class="p">{</code>
          <code class="s2">"shardName"</code><code class="o">:</code><code class="s2">"one-min-shards-rs0"</code><code class="p">,</code>
          <code class="s2">"connectionString"</code><code class="o">:</code> 
            <code class="s2">"one-min-shards-rs0/MBP:20000,MBP:20001,MBP:20002"</code><code class="p">,</code>
          <code class="s2">"serverInfo"</code><code class="o">:</code><code class="p">{</code>
            <code class="s2">"host"</code><code class="o">:</code><code class="s2">"MBP.fios-router.home"</code><code class="p">,</code>
            <code class="s2">"port"</code><code class="o">:</code><code class="mi">20000</code><code class="p">,</code>
            <code class="s2">"version"</code><code class="o">:</code><code class="s2">"3.6.1"</code><code class="p">,</code>
            <code class="s2">"gitVersion"</code><code class="o">:</code><code class="s2">"025d4f4fe61efd1fb6f0005be20cb45a004093d1"</code>
          <code class="p">},</code>
          <code class="s2">"plannerVersion"</code><code class="o">:</code><code class="mi">1</code><code class="p">,</code>
          <code class="s2">"namespace"</code><code class="o">:</code><code class="s2">"accounts.users"</code><code class="p">,</code>
          <code class="s2">"indexFilterSet"</code><code class="o">:</code><code class="kc">false</code><code class="p">,</code>
          <code class="s2">"parsedQuery"</code><code class="o">:</code><code class="p">{</code>

          <code class="p">},</code>
          <code class="s2">"winningPlan"</code><code class="o">:</code><code class="p">{</code>
            <code class="s2">"stage"</code><code class="o">:</code><code class="s2">"SHARDING_FILTER"</code><code class="p">,</code>
            <code class="s2">"inputStage"</code><code class="o">:</code><code class="p">{</code>
              <code class="s2">"stage"</code><code class="o">:</code><code class="s2">"COLLSCAN"</code><code class="p">,</code>
              <code class="s2">"direction"</code><code class="o">:</code><code class="s2">"forward"</code>
            <code class="p">}</code>
          <code class="p">},</code>
          <code class="s2">"rejectedPlans"</code><code class="o">:</code><code class="p">[</code>

          <code class="p">]</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"shardName"</code><code class="o">:</code><code class="s2">"one-min-shards-rs1"</code><code class="p">,</code>
          <code class="s2">"connectionString"</code><code class="o">:</code>
            <code class="s2">"one-min-shards-rs1/MBP:20003,MBP:20004,MBP:20005"</code><code class="p">,</code>
          <code class="s2">"serverInfo"</code><code class="o">:</code><code class="p">{</code>
            <code class="s2">"host"</code><code class="o">:</code><code class="s2">"MBP.fios-router.home"</code><code class="p">,</code>
            <code class="s2">"port"</code><code class="o">:</code><code class="mi">20003</code><code class="p">,</code>
            <code class="s2">"version"</code><code class="o">:</code><code class="s2">"3.6.1"</code><code class="p">,</code>
            <code class="s2">"gitVersion"</code><code class="o">:</code><code class="s2">"025d4f4fe61efd1fb6f0005be20cb45a004093d1"</code>
          <code class="p">},</code>
          <code class="s2">"plannerVersion"</code><code class="o">:</code><code class="mi">1</code><code class="p">,</code>
          <code class="s2">"namespace"</code><code class="o">:</code><code class="s2">"accounts.users"</code><code class="p">,</code>
          <code class="s2">"indexFilterSet"</code><code class="o">:</code><code class="kc">false</code><code class="p">,</code>
          <code class="s2">"parsedQuery"</code><code class="o">:</code><code class="p">{</code>

          <code class="p">},</code>
          <code class="s2">"winningPlan"</code><code class="o">:</code><code class="p">{</code>
            <code class="s2">"stage"</code><code class="o">:</code><code class="s2">"SHARDING_FILTER"</code><code class="p">,</code>
            <code class="s2">"inputStage"</code><code class="o">:</code><code class="p">{</code>
              <code class="s2">"stage"</code><code class="o">:</code><code class="s2">"COLLSCAN"</code><code class="p">,</code>
              <code class="s2">"direction"</code><code class="o">:</code><code class="s2">"forward"</code>
            <code class="p">}</code>
          <code class="p">},</code>
          <code class="s2">"rejectedPlans"</code><code class="o">:</code><code class="p">[</code>

          <code class="p">]</code>
        <code class="p">}</code>
      <code class="p">]</code>
    <code class="p">}</code>
  <code class="p">},</code>
  <code class="s2">"ok"</code><code class="o">:</code><code class="mi">1</code><code class="p">,</code>
  <code class="s2">"$clusterTime"</code><code class="o">:</code><code class="p">{</code>
    <code class="s2">"clusterTime"</code><code class="o">:</code><code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1515174893</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
    <code class="s2">"signature"</code><code class="o">:</code><code class="p">{</code>
      <code class="s2">"hash"</code><code class="o">:</code><code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
      <code class="s2">"keyId"</code><code class="o">:</code><code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
    <code class="p">}</code>
  <code class="p">},</code>
  <code class="s2">"operationTime"</code><code class="o">:</code><code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1515173709</code><code class="p">,</code> <code class="mi">514</code><code class="p">)</code>
<code class="p">}</code></pre><p>As you can see from this <code>explain</code>,
    this query has to visit both shards to find all the data. In general, if
    we are not using the shard key in the query, <em class="filename">mongos</em> will have to send the query to every
    shard.</p><p>Queries that contain the shard key and can be sent to a single shard
    or a subset of shards are called <em><span class="firstterm">targeted</span>
    queries<a data-type="indexterm" data-primary="queries" data-secondary="targeted" id="idm45882347182376"/><a data-type="indexterm" data-primary="targeted queries" id="idm45882347181240"/></em>. Queries that must be sent to all shards are
    called <em>scatter-gather</em> (broadcast) queries<a data-type="indexterm" data-primary="queries" data-secondary="scatter-gather (broadcast)" id="idm45882347179896"/><a data-type="indexterm" data-primary="broadcast (scatter-gather) queries" id="idm45882347178792"/><a data-type="indexterm" data-primary="scatter-gather (broadcast) queries" id="idm45882347177944"/>: <em class="filename">mongos</em> scatters the
    query to all the shards and then gathers up the results.</p><p>Once you are finished experimenting, shut down the set. Switch back
    to your original shell and hit Enter a few times to get back to the
    command line, then run <code class="function">st.stop()<a data-type="indexterm" data-primary="st.stop()" id="idm45882347175384"/></code> to cleanly shut down all of the servers:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">st</code><code class="p">.</code><code class="nx">stop</code><code class="p">()</code></pre><p>If you are ever unsure of what an operation will do, it can be
    helpful to use <span class="keep-together"><code class="classname">ShardingTest</code> to</span> spin
    up a quick local cluster and try it<a data-type="indexterm" data-startref="Ssingle14" id="idm45882347147384"/><a data-type="indexterm" data-startref="SBOkey14" id="idm45882347146616"/><a data-type="indexterm" data-startref="Csingle14" id="idm45882347145784"/> out.</p></div></section></div></section></div>



  </body></html>