<html><head></head><body><section data-pdf-bookmark="Chapter 5. IndexedDB" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_indexedDb">&#13;
<h1><span class="label">Chapter 5. </span>IndexedDB</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Introduction" data-type="sect1"><div class="sect1" id="id55">&#13;
<h1>Introduction</h1>&#13;
&#13;
<p><a data-primary="IndexedDB" data-type="indexterm" id="ix_05-indexeddb-asciidoc0"/><a data-type="xref" href="ch02.html#ch_webStorage">Chapter 2</a> covered <a data-primary="IndexedDB" data-secondary="basics" data-type="indexterm" id="ix_05-indexeddb-asciidoc1"/>data persistence with local or session storage. This works well for string values and serializable objects, but querying is not ideal and objects require JSON serialization. <em>IndexedDB</em> is a newer, more powerful data persistence mechanism present in all modern browsers. An IndexedDB database contains <em>object stores</em> (sort of like tables in a relational database). Each object store can have indexes on certain properties for more efficient querying. It also supports more advanced concepts like versioning and transactions.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Object Stores and Indexes" data-type="sect2"><div class="sect2" id="id56">&#13;
<h2>Object Stores and Indexes</h2>&#13;
&#13;
<p><a data-primary="IndexedDB" data-secondary="object stores and indexes" data-type="indexterm" id="id829"/><a data-primary="indexes" data-secondary="in IndexedDB" data-type="indexterm" id="id830"/><a data-primary="object stores, IndexedDB" data-type="indexterm" id="id831"/>An IndexedDB database has one or more object stores. All operations to add, remove, or query data are done on an object store. An object store is a collection of JavaScript objects that are persisted in the database. You can define <em>indexes</em> on an object store. An index stores extra information to the database that lets you query objects by the indexed property. For example, suppose you are creating a database to store product information. Each product has a key, likely a product ID or SKU code. This lets you quickly search the database for a given product.</p>&#13;
&#13;
<p>If you want to also be able to query the data by price, you can create an index on the price property. This lets you look up objects by their price. With an index, you can specify a specific price or a range of prices, and the index can quickly find those records for you.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Keys" data-type="sect2"><div class="sect2" id="id57">&#13;
<h2>Keys</h2>&#13;
&#13;
<p><a data-primary="IndexedDB" data-secondary="keys" data-type="indexterm" id="id832"/><a data-primary="keys" data-secondary="in IndexedDB" data-type="indexterm" id="id833"/>Objects in a store have a <em>key</em> that uniquely identifies that object within that store. This is similar to a primary key in a relational database table. There are two types of keys in an IndexedDB object store.</p>&#13;
&#13;
<p><a data-primary="in-line keys" data-type="indexterm" id="id834"/><em>In-line</em> keys are defined on the object itself. For example, here’s a to-do item with an in-line key:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="c1">// Here, id is the key.</code>&#13;
  <code class="nx">id</code><code class="o">:</code> <code class="mi">100</code><code class="p">,</code>&#13;
  <code class="nx">name</code><code class="o">:</code> <code class="s1">'Take out the trash'</code><code class="p">,</code>&#13;
  <code class="nx">completed</code><code class="o">:</code> <code class="kc">false</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Here, the key is the <code>id</code> property. When adding to-do items to such an object store, they must have an <code>id</code> property defined. <a data-primary="key path" data-type="indexterm" id="id835"/>Additionally, when creating the object store, you would specify a <em>key path</em> of <code>id</code>. The key path tells IndexedDB the name of the property that contains the key when using in-line keys:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">todosStore</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">createObjectStore</code><code class="p">(</code><code class="s1">'todos'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">keyPath</code><code class="o">:</code> <code class="s1">'id'</code> <code class="p">});</code></pre>&#13;
&#13;
<p>If you want to use in-line keys and don’t want to worry about maintaining unique keys, you can tell IndexedDB to use auto-incrementing keys:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">todosStore</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">createObjectStore</code><code class="p">(</code><code class="s1">'todos'</code><code class="p">,</code>&#13;
  <code class="p">{</code> <code class="nx">keyPath</code><code class="o">:</code> <code class="s1">'id'</code><code class="p">,</code> <code class="nx">autoIncrement</code><code class="o">:</code> <code class="kc">true</code> <code class="p">});</code></pre>&#13;
&#13;
<p><a data-primary="out-of-line keys" data-type="indexterm" id="id836"/><em>Out-of-line</em> keys are not stored within the object. An out-of-line key is specified as a separate argument with <code>add</code> or <code>put</code> when storing an object. Following the previous example, you could also use out-of-line keys for to-do items. This means the key, or the <code>id</code> property, would not be stored as part of the object:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">todo</code> <code class="o">=</code> <code class="p">{</code>&#13;
  <code class="nx">name</code><code class="o">:</code> <code class="s1">'Take out the trash'</code><code class="p">,</code>&#13;
  <code class="nx">completed</code><code class="o">:</code> <code class="kc">false</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="c1">// later, when adding the new to-do</code>&#13;
<code class="nx">todoStore</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="nx">todo</code><code class="p">,</code> <code class="mi">100</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Transactions" data-type="sect2"><div class="sect2" id="id58">&#13;
<h2>Transactions</h2>&#13;
&#13;
<p><a data-primary="IndexedDB" data-secondary="transactions" data-type="indexterm" id="id837"/><a data-primary="transactions, in IndexedDB" data-type="indexterm" id="id838"/>IndexedDB operations use <em>transactions</em>. A transaction is a logical grouping of database tasks executed together to perform some work. They are meant to protect the integrity of the data in the database. If one of the operations within a transaction fails, the entire transaction fails and any completed work is rolled back to the state that existed before the transaction.</p>&#13;
&#13;
<p>A transaction can be read-only or read-write, depending on the type of operation you want to perform. You can create a transaction by calling the <code>transaction</code> method of an IndexedDB database. You pass the names of any object stores that should be involved in this transaction and the transaction type (<code>readonly</code> or <code>readwrite</code>).</p>&#13;
&#13;
<p>Once you have a transaction, you can get a reference to the object store(s) you need. From there you can start performing your database operation. These operations return an IndexedDB <em>request</em>. All read and write operations in an IndexedDB database require a transaction.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Requests" data-type="sect2"><div class="sect2" id="id59">&#13;
<h2>Requests</h2>&#13;
&#13;
<p><a data-primary="IndexedDB" data-secondary="requests" data-type="indexterm" id="id839"/><a data-primary="requests" data-secondary="in IndexedDB" data-type="indexterm" id="id840"/>When you perform an operation on an object store, within a transaction, you’ll get back a request object that implements the <code>IDBRequest</code> interface, and the requested work begins asynchronously.</p>&#13;
&#13;
<p>When the work is done, the request object triggers a <code>success</code> event containing the results. For example, a query operation’s <code>success</code> event includes the objects found by the query.</p>&#13;
&#13;
<p><a data-type="xref" href="#figure_indexedDbParts">Figure 5-1</a> shows the general flow of an IndexedDB operation: creating a transaction, opening the object store, creating a request, and listening for events<a data-startref="ix_05-indexeddb-asciidoc1" data-type="indexterm" id="id841"/>.</p>&#13;
&#13;
<figure><div class="figure" id="figure_indexedDbParts">&#13;
<img alt="The parts of an IndexedDB operation" src="assets/wacb_0501.png"/>&#13;
<h6><span class="label">Figure 5-1. </span>The parts of an IndexedDB operation</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating, Reading, and Deleting Objects in a Database" data-type="sect1"><div class="sect1" id="recipe_basicDb">&#13;
<h1>Creating, Reading, and Deleting Objects in a Database</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id275">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="database" data-secondary="creating/reading/deleting objects in" data-type="indexterm" id="ix_05-indexeddb-asciidoc2"/><a data-primary="IndexedDB" data-secondary="creating/reading/deleting objects in a database" data-type="indexterm" id="ix_05-indexeddb-asciidoc3"/>You want to create a basic IndexedDB database where objects can be created, read, and deleted. For example, this could be a contact list database.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id442">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Create a database with a single object store, and define the create/read/delete &#13;
<span class="keep-together">operations.</span></p>&#13;
&#13;
<p>To create or open the database, call <code>indexedDB.open</code> (see <a data-type="xref" href="#example5-1">Example 5-1</a>). If the database was not previously created, it triggers an <code>upgradeneeded</code> event. In the handler for that event, you can create the object store. When the database is opened and ready for use, it triggers a <code>success</code> event.</p>&#13;
<div data-type="example" id="example5-1">&#13;
<h5><span class="label">Example 5-1. </span>Opening the database</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Opens the database, creating the object store if needed.</code>&#13;
<code class="cm"> * Because this is asynchronous, it takes a callback function, onSuccess. Once the</code>&#13;
<code class="cm"> * database is ready, onSucces will be called with the database object.</code>&#13;
<code class="cm"> *</code>&#13;
<code class="cm"> * @param onSuccess A callback function that is executed when the database is ready</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">openDatabase</code><code class="p">(</code><code class="nx">onSuccess</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">indexedDB</code><code class="p">.</code><code class="nx">open</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// Create the object store if needed.</code>&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'upgradeneeded'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
&#13;
    <code class="c1">// The contact objects will have an 'id' property that will</code>&#13;
    <code class="c1">// be used as the key. When you add a new contact object, you don't need to</code>&#13;
    <code class="c1">// set an 'id' property; the autoIncrement flag means that the database will</code>&#13;
    <code class="c1">// automatically set an 'id' for you.</code>&#13;
    <code class="nx">db</code><code class="p">.</code><code class="nx">createObjectStore</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="p">{</code>&#13;
      <code class="nx">keyPath</code><code class="o">:</code> <code class="s1">'id'</code><code class="p">,</code>&#13;
      <code class="nx">autoIncrement</code><code class="o">:</code> <code class="kc">true</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// When the database is ready for use, it triggers a 'success' event.</code>&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
&#13;
    <code class="c1">// Call the given callback with the database.</code>&#13;
    <code class="nx">onSuccess</code><code class="p">(</code><code class="nx">db</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// Always handle errors!</code>&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error opening database:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Before rendering the contacts, you’ll need to load them from the database. For this, use a <code>readonly</code> transaction and call the object store’s <code>getAll</code> method, which retrieves all objects in the object store (see <a data-type="xref" href="#example5-2">Example 5-2</a>).</p>&#13;
<div data-type="example" id="example5-2">&#13;
<h5><span class="label">Example 5-2. </span>Reading the contacts</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Reads the contacts from the database and renders them in the table.</code>&#13;
<code class="cm"> * @param contactsDb The IndexedDB database</code>&#13;
<code class="cm"> * @param onSuccess A callback function that is executed when the contacts are loaded</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">getContacts</code><code class="p">(</code><code class="nx">contactsDb</code><code class="p">,</code> <code class="nx">onSuccess</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">contactsDb</code>&#13;
    <code class="p">.</code><code class="nx">transaction</code><code class="p">([</code><code class="s1">'contacts'</code><code class="p">],</code> <code class="s1">'readonly'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">objectStore</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">getAll</code><code class="p">();</code>&#13;
&#13;
&#13;
  <code class="c1">// When the data has been loaded, the database triggers a 'success' event on the</code>&#13;
  <code class="c1">// request object.</code>&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Got contacts:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
    <code class="nx">onSuccess</code><code class="p">(</code><code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error loading contacts:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Adding a contact requires a <code>readwrite</code> transaction. Pass the contact object to the object store’s <code>add</code> method (see <a data-type="xref" href="#example5-3">Example 5-3</a>).</p>&#13;
<div data-type="example" id="example5-3">&#13;
<h5><span class="label">Example 5-3. </span>Adding a contact</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Adds a new contact to the database, then re-renders the table.</code>&#13;
<code class="cm"> * @param contactsDb The IndexedDB database</code>&#13;
<code class="cm"> * @param contact The new contact object to add</code>&#13;
<code class="cm"> * @param onSuccess A callback function that is executed when the contact is added</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">addContact</code><code class="p">(</code><code class="nx">contactsDb</code><code class="p">,</code> <code class="nx">contact</code><code class="p">,</code> <code class="nx">onSuccess</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">contactsDb</code>&#13;
    <code class="p">.</code><code class="nx">transaction</code><code class="p">([</code><code class="s1">'contacts'</code><code class="p">],</code> <code class="s1">'readwrite'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">objectStore</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="nx">contact</code><code class="p">);</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Added new contact:'</code><code class="p">,</code> <code class="nx">contact</code><code class="p">);</code>&#13;
    <code class="nx">onSuccess</code><code class="p">();</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error adding contact:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You’ll also need a <code>readwrite</code> transaction for deleting a contact (see <a data-type="xref" href="#example5-4">Example 5-4</a>).</p>&#13;
<div data-type="example" id="example5-4">&#13;
<h5><span class="label">Example 5-4. </span>Deleting a contact</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Deletes a contact from the database, then re-renders the table.</code>&#13;
<code class="cm"> * @param contactsDb The IndexedDB database.</code>&#13;
<code class="cm"> * @param contact The contact object to delete</code>&#13;
<code class="cm"> * @param onSuccess A callback function that is executed when the contact is deleted</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">deleteContact</code><code class="p">(</code><code class="nx">contactsDb</code><code class="p">,</code> <code class="nx">contact</code><code class="p">,</code> <code class="nx">onSuccess</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">contactsDb</code>&#13;
    <code class="p">.</code><code class="nx">transaction</code><code class="p">([</code><code class="s1">'contacts'</code><code class="p">],</code> <code class="s1">'readwrite'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">objectStore</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="k">delete</code><code class="p">(</code><code class="nx">contact</code><code class="p">.</code><code class="nx">id</code><code class="p">);</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Deleted contact:'</code><code class="p">,</code> <code class="nx">contact</code><code class="p">);</code>&#13;
    <code class="nx">onSuccess</code><code class="p">();</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error deleting contact:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id60">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>When creating the database, you call <code>indexedDB.open</code>, which creates a request to open the database. If it triggers an <code>upgradeneeded</code> event, you can create the necessary object store.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id842">&#13;
<h1>IndexedDB Versions</h1>&#13;
<p><a data-primary="IndexedDB" data-secondary="versioned databases" data-type="indexterm" id="id843"/><a data-primary="versioned databases, IndexedDB and" data-type="indexterm" id="id844"/>IndexedDB has the notion of a <em>versioned</em> database. Any time you make changes to your database schema (in the case of IndexedDB, the set of object stores and indexes), you need to consider all the users out there that already have an older version of the database persisted in their browsers.</p>&#13;
&#13;
<p><a data-primary="upgradeneeded event" data-type="indexterm" id="id845"/>This is where the <code>upgradeneeded</code> event comes in. When you call <code>indexedDB.open</code>, you can specify a version number for the database. Each time you modify the &#13;
<span class="keep-together">schema, you</span> increment this number. If a user with an older version of your database &#13;
<span class="keep-together">encounters</span> this new version number, IndexedDB triggers the <code>upgradeneeded</code> event. This event tells you the old version and new version of the database. Given these, you can determine what changes you need to make to the database.</p>&#13;
&#13;
<p>This allows your database design to evolve while keeping users’ data intact.</p>&#13;
</div></aside>&#13;
&#13;
<p>Each object in the object store must have a unique key. If you try to add an object with a duplicate key, you’ll get an error.</p>&#13;
&#13;
<p>The pattern for the other operations is generally the same:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Create a transaction.</p>&#13;
</li>&#13;
<li>&#13;
<p>Access the object store.</p>&#13;
</li>&#13;
<li>&#13;
<p>Call the desired method on the object store.</p>&#13;
</li>&#13;
<li>&#13;
<p>Listen for the <code>success</code> event.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Each of these functions takes an argument called <code>onSuccess</code>. Because IndexedDB is asynchronous, you need to wait until an operation is complete before proceeding. The <code>openDatabase</code> function passes the database to the <code>onSuccess</code> function where you can save it to a variable for later (see <a data-type="xref" href="#example5-5">Example 5-5</a>).</p>&#13;
<div data-type="example" id="example5-5">&#13;
<h5><span class="label">Example 5-5. </span>Using the <code>openDatabase</code> function</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">let</code> <code class="nx">contactsDb</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// Open the database and do the initial contact list render.</code>&#13;
<code class="c1">// The success handler sets contactsDb to the new database object for later use,</code>&#13;
<code class="c1">// then loads and renders the contacts.</code>&#13;
<code class="nx">openDatabase</code><code class="p">(</code><code class="nx">db</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">contactsDb</code> <code class="o">=</code> <code class="nx">db</code><code class="p">;</code>&#13;
  <code class="nx">renderContacts</code><code class="p">(</code><code class="nx">contactsDb</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Once you have the <code>contactsDb</code> variable set, you can pass it to the other database operations. When you want to render the contact list, you have to wait until they are loaded first, so you’d pass a success handler that receives the contact objects and renders them (see <a data-type="xref" href="#example5-6">Example 5-6</a>).</p>&#13;
<div data-type="example" id="example5-6">&#13;
<h5><span class="label">Example 5-6. </span>Loading and rendering contacts</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">getContacts</code><code class="p">(</code><code class="nx">contactsDb</code><code class="p">,</code> <code class="nx">contacts</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// Contacts have been loaded, now render them.</code>&#13;
  <code class="nx">renderContacts</code><code class="p">(</code><code class="nx">contacts</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Similarly, when adding a new contact, you have to wait until the new object is added, then load and render the updated contact list (see <a data-type="xref" href="#example5-7">Example 5-7</a>).</p>&#13;
<div data-type="example" id="example5-7">&#13;
<h5><span class="label">Example 5-7. </span>Adding and rerendering contacts</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">newContact</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="s1">'Connie Myers'</code><code class="p">,</code> <code class="nx">email</code><code class="o">:</code> <code class="s1">'cmyers@example.com'</code> <code class="p">};</code>&#13;
<code class="nx">addContact</code><code class="p">(</code><code class="nx">contactsDb</code><code class="p">,</code> <code class="nx">newContact</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// Contact has been added, now load the updated list and render it.</code>&#13;
  <code class="nx">getContacts</code><code class="p">(</code><code class="nx">contactsDb</code><code class="p">,</code> <code class="nx">contacts</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">renderContacts</code><code class="p">(</code><code class="nx">contacts</code><code class="p">);</code>&#13;
  <code class="p">})</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>If you don’t want to be constantly passing around a database reference, you could encapsulate your database reference and functions inside a new object, as shown in <a data-type="xref" href="#example5-8">Example 5-8</a>.</p>&#13;
<div data-type="example" id="example5-8">&#13;
<h5><span class="label">Example 5-8. </span>An encapsulated database</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">contactsDb</code> <code class="o">=</code> <code class="p">{</code>&#13;
  <code class="nx">open</code><code class="p">(</code><code class="nx">onSuccess</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">indexedDB</code><code class="p">.</code><code class="nx">open</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">);</code>&#13;
&#13;
    <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'upgradeneeded'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="kr">const</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
      <code class="nx">db</code><code class="p">.</code><code class="nx">createObjectStore</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="p">{</code>&#13;
        <code class="nx">keyPath</code><code class="o">:</code> <code class="s1">'id'</code><code class="p">,</code>&#13;
        <code class="nx">autoIncrement</code><code class="o">:</code> <code class="kc">true</code>&#13;
      <code class="p">});</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="k">this</code><code class="p">.</code><code class="nx">db</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
      <code class="nx">onSuccess</code><code class="p">();</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">},</code>&#13;
&#13;
  <code class="nx">getContacts</code><code class="p">(</code><code class="nx">onSuccess</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">db</code>&#13;
      <code class="p">.</code><code class="nx">transaction</code><code class="p">([</code><code class="s1">'contacts'</code><code class="p">],</code> <code class="s1">'readonly'</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">objectStore</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">getAll</code><code class="p">();</code>&#13;
&#13;
    <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Got contacts:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
      <code class="nx">onSuccess</code><code class="p">(</code><code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">},</code>&#13;
&#13;
  <code class="c1">// Other operations follow similarly.</code>&#13;
<code class="p">};</code></pre></div>&#13;
&#13;
<p>With this approach, you still need callbacks to notify you when the operations are done, but the <code>contactsDb</code> object keeps track of the database reference for you (and avoids a global variable!)<a data-startref="ix_05-indexeddb-asciidoc3" data-type="indexterm" id="id846"/><a data-startref="ix_05-indexeddb-asciidoc2" data-type="indexterm" id="id847"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Upgrading an Existing Database" data-type="sect1"><div class="sect1" id="recipe_upgradeDb">&#13;
<h1>Upgrading an Existing Database</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id61">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="database" data-secondary="upgrading" data-type="indexterm" id="ix_05-indexeddb-asciidoc4"/><a data-primary="IndexedDB" data-secondary="upgrading an existing database" data-type="indexterm" id="ix_05-indexeddb-asciidoc5"/><a data-primary="indexedDB.open call" data-type="indexterm" id="ix_05-indexeddb-asciidoc6"/><a data-primary="upgradeneeded event" data-type="indexterm" id="ix_05-indexeddb-asciidoc7"/>You want to update an existing database to add a new object store.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id444">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use a new database version. When handling the <code>upgradeneeded</code> event, determine if the current user’s database needs the new object store to be added based on the &#13;
<span class="keep-together">version.</span></p>&#13;
&#13;
<p>Imagine you have a to-do list database with a <code>todos</code> object store. Later, in an update to your app, you want to add a new <code>people</code> object store so that tasks can be assigned to people.</p>&#13;
&#13;
<p>The <code>indexedDB.open</code> call now needs a new version number. You can increment the version number to <code>2</code> (see <a data-type="xref" href="#example5-9">Example 5-9</a>).</p>&#13;
<div data-type="example" id="example5-9">&#13;
<h5><span class="label">Example 5-9. </span>Upgrading a database</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// todoList database is now at version 2</code>&#13;
<code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">indexedDB</code><code class="p">.</code><code class="nx">open</code><code class="p">(</code><code class="s1">'todoList'</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// If the user's database is still at version 1, an 'upgradeneeded' event</code>&#13;
<code class="c1">// is triggered so that the new object store can be added.</code>&#13;
<code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'upgradeneeded'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// This event is also triggered when no database exists yet, so you still need</code>&#13;
  <code class="c1">// to handle this case and create the to-dos object store.</code>&#13;
  <code class="c1">// The oldVersion property specifies the user's current version of the database.</code>&#13;
  <code class="c1">// If the database is just being created, the oldVersion is 0.</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">event</code><code class="p">.</code><code class="nx">oldVersion</code> <code class="o">&lt;</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">db</code><code class="p">.</code><code class="nx">createObjectStore</code><code class="p">(</code><code class="s1">'todos'</code><code class="p">,</code> <code class="p">{</code>&#13;
      <code class="nx">keyPath</code><code class="o">:</code> <code class="s1">'id'</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="c1">// If this database has not yet been upgraded to version 2, create the</code>&#13;
  <code class="c1">// new object store.</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">event</code><code class="p">.</code><code class="nx">oldVersion</code> <code class="o">&lt;</code> <code class="mi">2</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">db</code><code class="p">.</code><code class="nx">createObjectStore</code><code class="p">(</code><code class="s1">'people'</code><code class="p">,</code> <code class="p">{</code>&#13;
      <code class="nx">keyPath</code><code class="o">:</code> <code class="s1">'id'</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// Database is ready to go.</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// Log any error that might have occurred. The error object is</code>&#13;
<code class="c1">// stored in the request's 'error' property.</code>&#13;
<code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error opening database:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id62">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>When you call <code>indexedDB.open</code>, you can specify a database version. If you don’t specify a version, it defaults to <code>1</code>.</p>&#13;
&#13;
<p>Whenever the database is opened, the current database version in the browser (if any) is compared with the version number passed to <code>indexedDB.open</code>. If the database doesn’t exist yet or the version is not up to date, you’ll get an <code>upgradeneeded</code> event.</p>&#13;
&#13;
<p>In the <code>upgradeneeded</code> event handler, you can check the event’s <code>oldVersion</code> property to determine the browser’s current database version. If the database doesn’t exist yet, <code>oldVersion</code> is <code>0</code>.</p>&#13;
&#13;
<p>Based on the <code>oldVersion</code>, you can determine which object stores and indexes already exist and which need to be added.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>If you try to create an object store or index that already exists, the browser throws an exception. Before creating these objects, make sure to check the event’s <code>oldVersion</code> property<a data-startref="ix_05-indexeddb-asciidoc7" data-type="indexterm" id="id848"/><a data-startref="ix_05-indexeddb-asciidoc6" data-type="indexterm" id="id849"/><a data-startref="ix_05-indexeddb-asciidoc5" data-type="indexterm" id="id850"/><a data-startref="ix_05-indexeddb-asciidoc4" data-type="indexterm" id="id851"/>.</p>&#13;
</div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Querying with Indexes" data-type="sect1"><div class="sect1" id="id445">&#13;
<h1>Querying with Indexes</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id63">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="IndexedDB" data-secondary="querying with indexes" data-type="indexterm" id="ix_05-indexeddb-asciidoc8"/><a data-primary="indexes" data-secondary="querying with" data-type="indexterm" id="ix_05-indexeddb-asciidoc9"/><a data-primary="querying, with IndexedDB" data-type="indexterm" id="ix_05-indexeddb-asciidoc10"/>You want to efficiently query for data based on a property value other than the key (commonly referred to as the “primary key”).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id446">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Create an index on that property, then query on that index.</p>&#13;
&#13;
<p>Consider the example of a database of employees. Each employee has a name, department, and a unique ID as its key. You might want to filter the employees by a certain department.</p>&#13;
&#13;
<p>When the <code>upgradeneeded</code> event is triggered and you create the object store, you can also define indexes on that object store (see <a data-type="xref" href="#example5-10">Example 5-10</a>). <a data-type="xref" href="#example5-11">Example 5-11</a> shows how to query by the index that is defined.</p>&#13;
<div data-type="example" id="example5-10">&#13;
<h5><span class="label">Example 5-10. </span>Defining an index when the object store is created</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Opens the database, creating the object store and index if needed.</code>&#13;
<code class="cm"> * Once the database is ready, onSuccess will be called with the database object.</code>&#13;
<code class="cm"> *</code>&#13;
<code class="cm"> * @param onSuccess A callback function that is executed when the database is ready</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">openDatabase</code><code class="p">(</code><code class="nx">onSuccess</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">indexedDB</code><code class="p">.</code><code class="nx">open</code><code class="p">(</code><code class="s1">'employees'</code><code class="p">);</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'upgradeneeded'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
&#13;
    <code class="c1">// New employee objects will be given an autogenerated</code>&#13;
    <code class="c1">// 'id' property that serves as its key.</code>&#13;
    <code class="kr">const</code> <code class="nx">employeesStore</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">createObjectStore</code><code class="p">(</code><code class="s1">'employees'</code><code class="p">,</code> <code class="p">{</code>&#13;
      <code class="nx">keyPath</code><code class="o">:</code> <code class="s1">'id'</code><code class="p">,</code>&#13;
      <code class="nx">autoIncrement</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Create an index on the 'department' property called 'department'.</code>&#13;
    <code class="nx">employeesStore</code><code class="p">.</code><code class="nx">createIndex</code><code class="p">(</code><code class="s1">'department'</code><code class="p">,</code> <code class="s1">'department'</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">onSuccess</code><code class="p">(</code><code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
<div data-type="example" id="example5-11">&#13;
<h5><span class="label">Example 5-11. </span>Querying the employees by the department index</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Gets the employees for a given department, or all employees</code>&#13;
<code class="cm"> * if no department is given</code>&#13;
<code class="cm"> *</code>&#13;
<code class="cm"> * @param department The department to filter by</code>&#13;
<code class="cm"> * @param onSuccess A callback function that is executed when the employees</code>&#13;
<code class="cm"> * are loaded</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">getEmployees</code><code class="p">(</code><code class="nx">department</code><code class="p">,</code> <code class="nx">onSuccess</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">employeeDb</code>&#13;
    <code class="p">.</code><code class="nx">transaction</code><code class="p">([</code><code class="s1">'employees'</code><code class="p">],</code> <code class="s1">'readonly'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">objectStore</code><code class="p">(</code><code class="s1">'employees'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">index</code><code class="p">(</code><code class="s1">'department'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">getAll</code><code class="p">(</code><code class="nx">department</code><code class="p">);</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Got employees:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
    <code class="nx">onSuccess</code><code class="p">(</code><code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Error loading employees:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id64">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>An IndexedDB object store can have more than one index, depending on your needs.</p>&#13;
&#13;
<p><a data-primary="IDBKeyRange interface" data-type="indexterm" id="id852"/>This example uses specific values for querying the index, but an index can also be queried for a <em>range</em> of keys. These ranges are defined with the <code>IDBKeyRange</code> interface. A range is defined in terms of its <em>bounds</em>—it defines a starting and ending point for the range, and all keys within that range are returned.</p>&#13;
&#13;
<p>The <code>IDBKeyRange</code> interface supports four types of bounds:</p>&#13;
<dl>&#13;
<dt><code>IDBKeyRange.lowerBound</code></dt>&#13;
<dd>&#13;
<p>Matches keys starting at the given lower bound</p>&#13;
</dd>&#13;
<dt><code>IDBKeyRange.upperBound</code></dt>&#13;
<dd>&#13;
<p>Matches keys ending at the given upper bound</p>&#13;
</dd>&#13;
<dt><code>IDBKeyRange.bound</code></dt>&#13;
<dd>&#13;
<p>Specifies a lower <em>and</em> upper bound</p>&#13;
</dd>&#13;
<dt><code>IDBKeyRange.only</code></dt>&#13;
<dd>&#13;
<p>Specifies a single key only</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The <code>lowerBound</code>, <code>upperBound</code>, and <code>bound</code> key ranges also accept a second boolean parameter to specify whether the range is open or closed. If <code>true</code>, then it’s considered an <em>open</em> range and excludes the bounds&#13;
themselves. <code>IDBKeyRange.upperBound(10)</code> matches all keys less than <em>or equal to</em> <code>10</code>, but <code>IDBKeyRange.upperBound(10, true)</code> matches all keys <em>less than</em> <code>10</code> because 10&#13;
itself is excluded. The bounds for a key range don’t have to be numbers. Other object types such as strings and <code>Date</code> objects can be used as <a data-startref="ix_05-indexeddb-asciidoc10" data-type="indexterm" id="id853"/><a data-startref="ix_05-indexeddb-asciidoc9" data-type="indexterm" id="id854"/><a data-startref="ix_05-indexeddb-asciidoc8" data-type="indexterm" id="id855"/>keys.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Searching for String Values with Cursors" data-type="sect1"><div class="sect1" id="id447">&#13;
<h1>Searching for String Values with Cursors</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id65">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="cursors, searching for string values with" data-type="indexterm" id="ix_05-indexeddb-asciidoc11"/><a data-primary="IndexedDB" data-secondary="searching for string values with cursors" data-type="indexterm" id="ix_05-indexeddb-asciidoc12"/><a data-primary="string values, cursors for finding" data-type="indexterm" id="ix_05-indexeddb-asciidoc13"/>You want to query an IndexedDB object store for objects with a string property matching a pattern.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id448">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use a cursor, checking each object’s property to see if it contains the given string.</p>&#13;
&#13;
<p>Imagine an employee list application. You want to search for all contacts whose name contains the entered text. For this example, assume the database has already been opened and the object store is called <code>employees</code>.</p>&#13;
&#13;
<p>A <em>cursor</em> iterates through each object in the object store. It stops at each object, where you can access the current item and/or move on to the next item. You can check if the contact name includes the query text and collect the results in an array (see <a data-type="xref" href="#example5-12">Example 5-12</a>).</p>&#13;
<div data-type="example" id="example5-12">&#13;
<h5><span class="label">Example 5-12. </span>Searching string values with a cursor</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Searches for employees by name</code>&#13;
<code class="cm"> *</code>&#13;
<code class="cm"> * @param name A query string to match employee names</code>&#13;
<code class="cm"> * @param onSuccess Success callback that will receive the matching employees.</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">searchEmployees</code><code class="p">(</code><code class="nx">name</code><code class="p">,</code> <code class="nx">onSuccess</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="c1">// An array to hold all contacts with a name containing the query text</code>&#13;
  <code class="kr">const</code> <code class="nx">results</code> <code class="o">=</code> <code class="p">[];</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">query</code> <code class="o">=</code> <code class="nx">name</code><code class="p">.</code><code class="nx">toLowerCase</code><code class="p">();</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">employeeDb</code>&#13;
    <code class="p">.</code><code class="nx">transaction</code><code class="p">([</code><code class="s1">'employees'</code><code class="p">],</code> <code class="s1">'readonly'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">objectStore</code><code class="p">(</code><code class="s1">'employees'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">openCursor</code><code class="p">();</code>&#13;
&#13;
&#13;
  <code class="c1">// The cursor request will emit a 'success' event for each object it finds.</code>&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">cursor</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">cursor</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="kr">const</code> <code class="nx">name</code> <code class="o">=</code> <code class="sb">`</code><code class="si">${</code><code class="nx">cursor</code><code class="p">.</code><code class="nx">value</code><code class="p">.</code><code class="nx">firstName</code><code class="si">}</code><code class="sb"> </code><code class="si">${</code><code class="nx">cursor</code><code class="p">.</code><code class="nx">value</code><code class="p">.</code><code class="nx">lastName</code><code class="si">}</code><code class="sb">`</code>&#13;
      <code class="p">.</code><code class="nx">toLowerCase</code><code class="p">();</code>&#13;
      <code class="c1">// Add the contact to the result array if it matches the query.</code>&#13;
      <code class="k">if</code> <code class="p">(</code><code class="nx">name</code><code class="p">.</code><code class="nx">includes</code><code class="p">(</code><code class="nx">query</code><code class="p">))</code> <code class="p">{</code>&#13;
        <code class="nx">results</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">cursor</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>&#13;
      <code class="p">}</code>&#13;
&#13;
      <code class="c1">// Continue to the next record.</code>&#13;
      <code class="nx">cursor</code><code class="p">.</code><code class="k">continue</code><code class="p">();</code>&#13;
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
      <code class="nx">onSuccess</code><code class="p">(</code><code class="nx">results</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error searching employees:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id66">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>When you call <code>openCursor</code> on the object store, it returns an <code>IDBRequest</code> request object. It fires a <code>success</code> event for the first object in the store. For every <code>success</code> event, the request has a <code>result</code> property that is the cursor object itself. You can access the current value that the cursor is pointing to with its <code>value</code> property.</p>&#13;
&#13;
<p>The success handler checks the current object’s first and last name fields, converting both to lowercase first so that it’s a case-insensitive search. If it matches, it’s added to a result array.</p>&#13;
&#13;
<p>When you’re done processing the current object, you can call <code>continue</code> on the cursor. This advances to the next object and emits another <code>success</code> event. If you have reached the end of the object store, and there are no objects left, <code>request.result</code> is <code>null</code>. When this happens, you know that the search is complete and you have the matching contacts.</p>&#13;
&#13;
<p>At each iteration of the cursor, any objects that match the search query are added to a <code>results</code> array. This is passed to the success callback when the cursor is complete<a data-startref="ix_05-indexeddb-asciidoc13" data-type="indexterm" id="id856"/><a data-startref="ix_05-indexeddb-asciidoc12" data-type="indexterm" id="id857"/><a data-startref="ix_05-indexeddb-asciidoc11" data-type="indexterm" id="id858"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Paginating a Large Data Set" data-type="sect1"><div class="sect1" id="id449">&#13;
<h1>Paginating a Large Data Set</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id67">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="IndexedDB" data-secondary="paginating a large data set" data-type="indexterm" id="ix_05-indexeddb-asciidoc14"/><a data-primary="pagination, of large data set in IndexedDB" data-type="indexterm" id="ix_05-indexeddb-asciidoc15"/>You want to break up a large data set into pages, each with an offset and a length.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id450">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use a cursor to skip to the first item on the requested page and collect the desired number of items (see <a data-type="xref" href="#example5-13">Example 5-13</a>).</p>&#13;
<div data-type="example" id="example5-13">&#13;
<h5><span class="label">Example 5-13. </span>Using a cursor to get a page of records</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Uses a cursor to fetch a single "page" of data from an IndexedDB object store</code>&#13;
<code class="cm"> *</code>&#13;
<code class="cm"> * @param db The IndexedDB database object</code>&#13;
<code class="cm"> * @param storeName The name of the object store</code>&#13;
<code class="cm"> * @param offset The starting offset (0 being the first item)</code>&#13;
<code class="cm"> * @param length The number of items after the offset to return</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">getPaginatedRecords</code><code class="p">(</code><code class="nx">db</code><code class="p">,</code> <code class="nx">storeName</code><code class="p">,</code> <code class="nx">offset</code><code class="p">,</code> <code class="nx">length</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">cursor</code> <code class="o">=</code> <code class="nx">db</code>&#13;
    <code class="p">.</code><code class="nx">transaction</code><code class="p">([</code><code class="nx">storeName</code><code class="p">],</code> <code class="s1">'readonly'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">objectStore</code><code class="p">(</code><code class="nx">storeName</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">openCursor</code><code class="p">();</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">results</code> <code class="o">=</code> <code class="p">[];</code>&#13;
&#13;
  <code class="c1">// This flag indicates whether or not the cursor has skipped ahead to the</code>&#13;
  <code class="c1">// offset yet.</code>&#13;
  <code class="kd">let</code> <code class="nx">skipped</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">cursor</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">target</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
&#13;
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">skipped</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="c1">// Set the flag and skip ahead by the given offset. Next time around,</code>&#13;
      <code class="c1">// the cursor will be in the starting position and can start collecting</code>&#13;
      <code class="c1">// records.</code>&#13;
      <code class="nx">skipped</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>&#13;
      <code class="nx">cursor</code><code class="p">.</code><code class="nx">advance</code><code class="p">(</code><code class="nx">offset</code><code class="p">);</code>&#13;
    <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">cursor</code> <code class="o">&amp;&amp;</code> <code class="nx">result</code><code class="p">.</code><code class="nx">length</code> <code class="o">&lt;</code> <code class="nx">length</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="c1">// Collect the record the cursor is currently pointing to.</code>&#13;
      <code class="nx">results</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">cursor</code><code class="p">.</code><code class="nx">value</code><code class="p">);</code>&#13;
&#13;
      <code class="c1">// Continue on to the next record.</code>&#13;
      <code class="nx">cursor</code><code class="p">.</code><code class="k">continue</code><code class="p">();</code>&#13;
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
      <code class="c1">// There are either no records left, or the length has been reached.</code>&#13;
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Got records:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error getting records:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id68">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>You may not want to start at the first record—that’s what the <code>offset</code> argument is for. The first time through, the event handler calls <code>advance</code> with the requested offset. This tells the cursor to jump ahead to the starting item you want. Technically speaking, <code>advance</code> doesn’t move to the specified offset but rather advances by the given number <em>starting at the current index</em>. For this example, though, it’s effectively the same because it always starts at index zero.</p>&#13;
&#13;
<p>You can’t start collecting values until the next iteration of the cursor. To handle this, there’s a <code>skipped</code> flag that is set to indicate that the cursor has now skipped ahead. The next time through, this flag is seen as <code>true</code> and it won’t try to skip again.</p>&#13;
&#13;
<p>Once the cursor has advanced, another <code>success</code> event is fired. Now the cursor is pointing to the first item to be collected (assuming there are items remaining—the <code>cursor</code> object is <code>null</code> if there are no more objects). It adds the current value to the result array. Finally, it calls <code>continue</code> on the cursor to move on to the next value.</p>&#13;
&#13;
<p>This process continues until the result array has reached the requested length, or there are no more objects remaining in the object store. This would happen if <code>offset + length</code> was greater than the number of objects in the object store.</p>&#13;
&#13;
<p>Once there are no more objects to collect, the full page of results is ready<a data-startref="ix_05-indexeddb-asciidoc15" data-type="indexterm" id="id859"/><a data-startref="ix_05-indexeddb-asciidoc14" data-type="indexterm" id="id860"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Promises with the IndexedDB API" data-type="sect1"><div class="sect1" id="id451">&#13;
<h1>Using Promises with the IndexedDB API</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id276">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="IndexedDB" data-secondary="using Promises with the IndexedDB API" data-type="indexterm" id="ix_05-indexeddb-asciidoc16"/><a data-primary="Promises" data-secondary="using with IndexedDB API" data-type="indexterm" id="ix_05-indexeddb-asciidoc17"/>You want a <code>Promise</code>-based API for working with an IndexedDB database.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id452">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Create <code>Promise</code> wrappers around IndexedDB requests. When the request triggers the <code>success</code> event, resolve the <code>Promise</code>. If it triggers the <code>error</code> event, reject it.</p>&#13;
&#13;
<p><a data-type="xref" href="#code_promiseCreateDb">Example 5-14</a> creates a wrapper around the <code>indexedDb.open</code> function. It opens or creates the database and returns a <code>Promise</code> that is resolved when the database is ready.</p>&#13;
<div data-type="example" id="code_promiseCreateDb">&#13;
<h5><span class="label">Example 5-14. </span>Creating a database with a <code>Promise</code></h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Opens the database, creating the object store if needed.</code>&#13;
<code class="cm"> * @returns a Promise that is resolved with the database, or rejected with an error</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">openDatabase</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="k">new</code> <code class="nb">Promise</code><code class="p">((</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">indexedDB</code><code class="p">.</code><code class="nx">open</code><code class="p">(</code><code class="s1">'contacts-promise'</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// Create the object store if needed.</code>&#13;
    <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'upgradeneeded'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="kr">const</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">;</code>&#13;
      <code class="nx">db</code><code class="p">.</code><code class="nx">createObjectStore</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="p">{</code>&#13;
        <code class="nx">keyPath</code><code class="o">:</code> <code class="s1">'id'</code><code class="p">,</code>&#13;
        <code class="nx">autoIncrement</code><code class="o">:</code> <code class="kc">true</code>&#13;
      <code class="p">});</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">resolve</code><code class="p">(</code><code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">));</code>&#13;
    <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">reject</code><code class="p">(</code><code class="nx">request</code><code class="p">.</code><code class="nx">error</code><code class="p">));</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>To load some data from the database, <a data-type="xref" href="#code_promiseGetAllDb">Example 5-15</a> provides a wrapper around the <code>getAll</code> method. It requests the data, then returns a <code>Promise</code> that is resolved with an array of the objects when they have been loaded.</p>&#13;
<div data-type="example" id="code_promiseGetAllDb">&#13;
<h5><span class="label">Example 5-15. </span>Getting objects from a store with a <code>Promise</code></h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Reads the contacts from the database.</code>&#13;
<code class="cm"> * @returns a Promise that is resolved with the contacts, or rejected with an error</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">getContacts</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="k">new</code> <code class="nb">Promise</code><code class="p">((</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">request</code> <code class="o">=</code> <code class="nx">contactsDb</code>&#13;
      <code class="p">.</code><code class="nx">transaction</code><code class="p">([</code><code class="s1">'contacts'</code><code class="p">],</code> <code class="s1">'readonly'</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">objectStore</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
      <code class="p">.</code><code class="nx">getAll</code><code class="p">();</code>&#13;
&#13;
    <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'success'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Got contacts:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
      <code class="nx">resolve</code><code class="p">(</code><code class="nx">request</code><code class="p">.</code><code class="nx">result</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="nx">request</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error loading contacts:'</code><code class="p">,</code> <code class="nx">request</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
      <code class="nx">reject</code><code class="p">(</code><code class="nx">request</code><code class="p">.</code><code class="nx">error</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Now that you have an API that returns <code>Promise</code>s, you can use <code>then</code> or <code>async</code>/<code>await</code> when working with your database (see <a data-type="xref" href="#code_awaitDatabase">Example 5-16</a>).</p>&#13;
<div data-type="example" id="code_awaitDatabase">&#13;
<h5><span class="label">Example 5-16. </span>Using the promisified database</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">async</code> <code class="kd">function</code> <code class="nx">loadAndPrintContacts</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">try</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">db</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">openDatabase</code><code class="p">();</code>&#13;
    <code class="kr">const</code> <code class="nx">contacts</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">getContacts</code><code class="p">();</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Got contacts:'</code><code class="p">,</code> <code class="nx">contacts</code><code class="p">);</code>&#13;
  <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">error</code><code class="p">(</code><code class="s1">'Error:'</code><code class="p">,</code> <code class="nx">error</code><code class="p">);</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id69">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Using a <code>Promise</code> API with <code>async</code>/<code>await</code> removes the need to pass success handler callbacks around. As <a data-type="xref" href="#code_awaitDatabase">Example 5-16</a> shows, you can also take advantage of <code>Promise</code> chaining to avoid nested callbacks and event handlers<a data-startref="ix_05-indexeddb-asciidoc17" data-type="indexterm" id="id861"/><a data-startref="ix_05-indexeddb-asciidoc16" data-type="indexterm" id="id862"/>.<a data-startref="ix_05-indexeddb-asciidoc0" data-type="indexterm" id="id863"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section></body></html>