<html><head></head><body><section data-pdf-bookmark="Chapter 8. The Web Animations API" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_webAnimationsApi">&#13;
<h1><span class="label">Chapter 8. </span>The Web Animations API</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Introduction" data-type="sect1"><div class="sect1" id="id101">&#13;
<h1>Introduction</h1>&#13;
&#13;
<p><a data-primary="Web Animations API" data-type="indexterm" id="ix_08-web-animations-api-asciidoc0"/> <a data-primary="Web Animations API" data-secondary="basics" data-type="indexterm" id="id937"/>There are a few different ways to animate elements in modern web browsers. <a data-type="xref" href="ch01.html#ch_async">Chapter 1</a> had an example of using the <code>requestAnimationFrame</code> API to manually animate an element (see <a data-type="xref" href="ch01.html#requestAnimationFrame">“Animating an Element with requestAnimationFrame”</a>). This gives you a lot of control, but at a cost. It requires keeping track of timestamps to calculate frame rates, and you must calculate each incremental change of the animation in JavaScript.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Keyframe-Based Animation" data-type="sect2"><div class="sect2" id="id286">&#13;
<h2>Keyframe-Based Animation</h2>&#13;
&#13;
<p><a data-primary="keyframe animation" data-secondary="basics" data-type="indexterm" id="id938"/><a data-primary="Web Animations API" data-secondary="keyframe-based" data-type="indexterm" id="id939"/>CSS3 <a data-primary="animations" data-secondary="keyframe-based" data-type="indexterm" id="ix_08-web-animations-api-asciidoc1"/>introduced keyframe animations. You specify the beginning style, ending style, and a duration within CSS rules. The browser automatically interpolates, or fills in, the intermediate frames of the animation. Animations are defined with the <code>@keyframes</code> rule and used via the <code>animation</code> property. <a data-type="xref" href="#css_animation">Example 8-1</a> defines a fade-in &#13;
<span class="keep-together">animation</span>.</p>&#13;
<div data-type="example" id="css_animation">&#13;
<h5><span class="label">Example 8-1. </span>Using a CSS keyframe animation</h5>&#13;
&#13;
<pre data-code-language="css" data-type="programlisting"><code class="k">@keyframes</code> <code class="nt">fade</code> <code class="p">{</code>&#13;
  <code class="nt">from</code> <code class="p">{</code>&#13;
    <code class="k">opacity</code><code class="o">:</code> <code class="m">0</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="nt">to</code> <code class="p">{</code>&#13;
    <code class="k">opacity</code><code class="o">:</code> <code class="m">1</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="nc">.some-element</code> <code class="p">{</code>&#13;
  <code class="k">animation</code><code class="o">:</code> <code class="n">fade</code> <code class="m">250ms</code><code class="p">;</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>A fade-in animation starts with an opacity of 0 and ends with an opacity of 1. When the animation runs, the browser calculates the intermediate style frames over the course of 250 milliseconds. The animation starts as soon as the element enters the DOM or the <code>some-element</code> class is applied.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Keyframe Animation with JavaScript" data-type="sect2"><div class="sect2" id="id102">&#13;
<h2>Keyframe Animation with JavaScript</h2>&#13;
&#13;
<p><a data-primary="JavaScript, keyframe animation with" data-type="indexterm" id="id940"/><a data-primary="keyframe animation" data-secondary="using JavaScript" data-type="indexterm" id="id941"/>The Web Animations API lets you use keyframe animations in your JavaScript code. The <code>Element</code> interface has an <code>animate</code> method where you can define the keyframes and other options of the animation. <a data-type="xref" href="#example8-2">Example 8-2</a> shows the same animation from <a data-type="xref" href="#css_animation">Example 8-1</a> using the Web Animations API.</p>&#13;
<div data-type="example" id="example8-2">&#13;
<h5><span class="label">Example 8-2. </span>Fading in with the Web Animations API</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">element</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'.some-element'</code><code class="p">);</code>&#13;
<code class="nx">element</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
  <code class="p">{</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mi">0</code> <code class="p">},</code>&#13;
  <code class="p">{</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>&#13;
<code class="p">],</code> <code class="p">{</code>&#13;
  <code class="c1">// Animate for 250 milliseconds</code>&#13;
  <code class="nx">duration</code><code class="o">:</code> <code class="mi">250</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>The result is the same. The element fades in over the course of 250 milliseconds. In this case, the animation is triggered by the <code>element.animate</code> call.<a data-startref="ix_08-web-animations-api-asciidoc1" data-type="indexterm" id="id942"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Animation Objects" data-type="sect2"><div class="sect2" id="id103">&#13;
<h2>Animation Objects</h2>&#13;
&#13;
<p><a data-primary="Animation objects" data-type="indexterm" id="id943"/><a data-primary="Web Animations API" data-secondary="Animation objects" data-type="indexterm" id="id944"/>When you call <code>element.animate</code>, an <code>Animation</code> object is returned. This allows you to pause, resume, cancel, or even reverse an animation. It also provides you with a <code>Promise</code> that you can use to wait until the animation completes.</p>&#13;
&#13;
<p>Be careful what properties you animate. Some properties, like <code>height</code> or <code>padding</code>, affect the layout of the rest of the page; animating them can cause performance issues, and the animations are usually not smooth. The best properties to animate are <code>opacity</code> and <code>transform</code>, as these don’t affect the page layout and can even be accelerated by the system’s GPU.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Applying a “Ripple” Effect on Click" data-type="sect1"><div class="sect1" id="id488">&#13;
<h1>Applying a “Ripple” Effect on Click</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id104">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="“ripple” animation" data-primary-sortas="ripple" data-type="indexterm" id="ix_08-web-animations-api-asciidoc2"/><a data-primary="Web Animations API" data-secondary="applying a “ripple” effect on click" data-type="indexterm" id="ix_08-web-animations-api-asciidoc3"/>You want to show a “ripple” animation when clicking a button, starting at the position within the button that the user clicked.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id489">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>When the button is clicked, create a temporary child element for the “ripple”. This is the element that will be animated.</p>&#13;
&#13;
<p>First, create some styles for the ripple element. The button also needs a couple of styles applied (see <a data-type="xref" href="#example8-3">Example 8-3</a>).</p>&#13;
<div data-type="example" id="example8-3">&#13;
<h5><span class="label">Example 8-3. </span>Styles for the button and ripple elements</h5>&#13;
&#13;
<pre data-code-language="css" data-type="programlisting"><code class="nc">.ripple-button</code> <code class="p">{</code>&#13;
  <code class="k">position</code><code class="o">:</code> <code class="nb">relative</code><code class="p">;</code>&#13;
  <code class="k">overflow</code><code class="o">:</code> <code class="nb">hidden</code><code class="p">;</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="nc">.ripple</code> <code class="p">{</code>&#13;
  <code class="k">background</code><code class="o">:</code> <code class="nb">white</code><code class="p">;</code>&#13;
  <code class="k">pointer-events</code><code class="o">:</code> <code class="nb">none</code><code class="p">;</code>&#13;
  <code class="k">transform-origin</code><code class="o">:</code> <code class="nb">center</code><code class="p">;</code>&#13;
  <code class="k">opacity</code><code class="o">:</code> <code class="m">0</code><code class="p">;</code>&#13;
  <code class="k">position</code><code class="o">:</code> <code class="nb">absolute</code><code class="p">;</code>&#13;
  <code class="k">border-radius</code><code class="o">:</code> <code class="m">50%</code><code class="p">;</code>&#13;
  <code class="k">width</code><code class="o">:</code> <code class="m">150px</code><code class="p">;</code>&#13;
  <code class="k">height</code><code class="o">:</code> <code class="m">150px</code><code class="p">;</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>In the button’s click handler, dynamically create a new ripple element and add it to the button, then update its position and&#13;
perform the animation (see <a data-type="xref" href="#example8-4">Example 8-4</a>).</p>&#13;
<div data-type="example" id="example8-4">&#13;
<h5><span class="label">Example 8-4. </span>Performing the ripple animation</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">button</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="nx">async</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// Create the temporary element for the ripple, set its class, and</code>&#13;
  <code class="c1">// add it to the button.</code>&#13;
  <code class="kr">const</code> <code class="nx">ripple</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'div'</code><code class="p">);</code>&#13;
  <code class="nx">ripple</code><code class="p">.</code><code class="nx">className</code> <code class="o">=</code> <code class="s1">'ripple'</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// Find the largest dimension (width or height) of the button and</code>&#13;
  <code class="c1">// use that as the ripple's size.</code>&#13;
  <code class="kr">const</code> <code class="nx">rippleSize</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">max</code><code class="p">(</code><code class="nx">button</code><code class="p">.</code><code class="nx">offsetWidth</code><code class="p">,</code> <code class="nx">button</code><code class="p">.</code><code class="nx">offsetHeight</code><code class="p">);</code>&#13;
  <code class="nx">ripple</code><code class="p">.</code><code class="nx">style</code><code class="p">.</code><code class="nx">width</code> <code class="o">=</code> <code class="sb">`</code><code class="si">${</code><code class="nx">rippleSize</code><code class="si">}</code><code class="sb">px`</code><code class="p">;</code>&#13;
  <code class="nx">ripple</code><code class="p">.</code><code class="nx">style</code><code class="p">.</code><code class="nx">height</code> <code class="o">=</code> <code class="sb">`</code><code class="si">${</code><code class="nx">rippleSize</code><code class="si">}</code><code class="sb">px`</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// Center the ripple element on the click location.</code>&#13;
  <code class="nx">ripple</code><code class="p">.</code><code class="nx">style</code><code class="p">.</code><code class="nx">top</code> <code class="o">=</code> <code class="sb">`</code><code class="si">${</code><code class="nx">event</code><code class="p">.</code><code class="nx">offsetY</code> <code class="o">-</code> <code class="p">(</code><code class="nx">rippleSize</code> <code class="o">/</code> <code class="mi">2</code><code class="p">)</code><code class="si">}</code><code class="sb">px`</code><code class="p">;</code>&#13;
  <code class="nx">ripple</code><code class="p">.</code><code class="nx">style</code><code class="p">.</code><code class="nx">left</code> <code class="o">=</code> <code class="sb">`</code><code class="si">${</code><code class="nx">event</code><code class="p">.</code><code class="nx">offsetX</code> <code class="o">-</code> <code class="p">(</code><code class="nx">rippleSize</code> <code class="o">/</code> <code class="mi">2</code><code class="p">)</code><code class="si">}</code><code class="sb">px`</code><code class="p">;</code>&#13;
&#13;
  <code class="nx">button</code><code class="p">.</code><code class="nx">appendChild</code><code class="p">(</code><code class="nx">ripple</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// Perform the ripple animation and wait for it to complete.</code>&#13;
  <code class="nx">await</code> <code class="nx">ripple</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
    <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'scale(0)'</code><code class="p">,</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mf">0.5</code> <code class="p">},</code>&#13;
    <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'scale(2.5)'</code><code class="p">,</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mi">0</code> <code class="p">}</code>&#13;
  <code class="p">],</code> <code class="p">{</code>&#13;
    <code class="c1">// Animate for 500 milliseconds.</code>&#13;
    <code class="nx">duration</code><code class="o">:</code> <code class="mi">500</code><code class="p">,</code>&#13;
    <code class="c1">// Use the ease-in easing function.</code>&#13;
    <code class="nx">easing</code><code class="o">:</code> <code class="s1">'ease-in'</code>&#13;
  <code class="p">}).</code><code class="nx">finished</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// All done, remove the ripple element.</code>&#13;
  <code class="nx">ripple</code><code class="p">.</code><code class="nx">remove</code><code class="p">();</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id105">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The ripple element is a circle, sized relative to the size of the button. You achieve the ripple effect by animating its opacity and scale transform.</p>&#13;
&#13;
<p>There are a few things here to point out about the element styles. First, the button itself has its <code>position</code> set to <code>relative</code>. This is so that when you set the ripple’s &#13;
<span class="keep-together"><code>absolute</code></span> position, it is relative to the button itself.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id945">&#13;
<h1>CSS Absolute Positioning</h1>&#13;
<p><a data-primary="CSS" data-secondary="absolute positioning" data-type="indexterm" id="id946"/>When you set an element’s <code>position</code> property to <code>absolute</code>, the browser removes it from the document layout and positions it relative to its nearest ancestor element that is <em>positioned</em>. An element is considered positioned if it has a <code>position</code> property set to anything but the default of <code>static</code>.</p>&#13;
&#13;
<p>If you have an element with absolute positioning, and the position doesn’t seem right, check to make sure that it’s using the correct positioned ancestor. This may or may not be the element’s immediate parent.</p>&#13;
</div></aside>&#13;
&#13;
<p>The button also has <code>overflow: hidden</code>. This prevents the ripple effect from being visible outside of the button.</p>&#13;
&#13;
<p>You may also notice that the ripple has <code>pointer-events: none</code> set. Because the ripple is inside the button, the browser delegates any click events on the ripple up to the button. This means clicking the ripple triggers a new ripple, but the position is wrong because it’s based on the click position within the ripple rather than within the &#13;
<span class="keep-together">button.</span></p>&#13;
&#13;
<p>The easiest way to get around this is to set <code>pointer-events: none</code>, which makes the ripple element ignore click events. If you click on a ripple while it is animating, the click event goes to the button, which is what you want in order to have the next ripple be positioned properly.</p>&#13;
&#13;
<p>Next, the ripple code sets the top and left position such that the center of the ripple is where you just clicked.</p>&#13;
&#13;
<p>Then the ripple is animated. The animation returned by <code>ripple.animate</code> has a <code>finished</code> property, which is a <code>Promise</code> that you can wait for. Once this <code>Promise</code> resolves, the ripple animation is complete and you can remove the element from the DOM.</p>&#13;
&#13;
<p>If you click the button while a ripple is in progress, another ripple starts and they’ll animate together—the first animation isn’t interrupted. This is more difficult to achieve with regular CSS animations.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id947">&#13;
<h1>Easing Functions</h1>&#13;
<p><a data-primary="easing functions" data-type="indexterm" id="id948"/>An easing function, specified by the <code>easing</code> property, defines the rate of change of the properties being animated. Customizing and fine-tuning these are beyond the scope of this book, but there are a few built-in ones to understand:</p>&#13;
<dl>&#13;
<dt><code>linear</code> (the default)</dt>&#13;
<dd>&#13;
<p>The animation happens at a constant rate.</p>&#13;
</dd>&#13;
<dt><code>ease-out</code></dt>&#13;
<dd>&#13;
<p>The animation starts faster, then gradually slows down.</p>&#13;
</dd>&#13;
<dt><code>ease-in</code></dt>&#13;
<dd>&#13;
<p>The animation starts slow, then gradually speeds up.</p>&#13;
</dd>&#13;
<dt><code>ease-in-out</code></dt>&#13;
<dd>&#13;
<p>The animation starts slow, speeds up, then slows down again at the end<a data-startref="ix_08-web-animations-api-asciidoc3" data-type="indexterm" id="id949"/><a data-startref="ix_08-web-animations-api-asciidoc2" data-type="indexterm" id="id950"/>.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></aside>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Starting and Stopping Animations" data-type="sect1"><div class="sect1" id="id490">&#13;
<h1>Starting and Stopping Animations</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id287">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="animations" data-secondary="starting and stopping" data-type="indexterm" id="id951"/><a data-primary="Web Animations API" data-secondary="starting and stopping" data-type="indexterm" id="id952"/>You want to be able to programmatically start or stop an animation.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id491">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the animation’s <code>pause</code> and <code>play</code> functions (see <a data-type="xref" href="#example8-5">Example 8-5</a>).</p>&#13;
<div data-type="example" id="example8-5">&#13;
<h5><span class="label">Example 8-5. </span>Toggling an animation’s play state</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Given an animation, toggles the animation state.</code>&#13;
<code class="cm"> * If the animation is running, it will be paused.</code>&#13;
<code class="cm"> * If it is paused, it will be resumed.</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">toggleAnimation</code><code class="p">(</code><code class="nx">animation</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">animation</code><code class="p">.</code><code class="nx">playState</code> <code class="o">===</code> <code class="s1">'running'</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">animation</code><code class="p">.</code><code class="nx">pause</code><code class="p">();</code>&#13;
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="nx">animation</code><code class="p">.</code><code class="nx">play</code><code class="p">();</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id492">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The <code>Animation</code> object returned from an <code>element.animate</code> call has a <code>playState</code> property, which you can use to determine if the animation is currently running or not. If it is running, its value is the string <code>running</code>. Other values are:</p>&#13;
<dl>&#13;
<dt><code>paused</code></dt>&#13;
<dd>&#13;
<p>The animation was running, but was stopped before it finished.</p>&#13;
</dd>&#13;
<dt><code>finished</code></dt>&#13;
<dd>&#13;
<p>The animation ran to completion and stopped.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Depending on the <code>playState</code> property, the <code>toggleAnimation</code> function calls either <code>pause</code> or <code>play</code> to set the desired animation state.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Animating DOM Insertion and Removal" data-type="sect1"><div class="sect1" id="id493">&#13;
<h1>Animating DOM Insertion and Removal</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id288">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="DOM elements" data-secondary="animating insertion and removal" data-type="indexterm" id="ix_08-web-animations-api-asciidoc4"/><a data-primary="Web Animations API" data-secondary="animating DOM insertion and removal" data-type="indexterm" id="ix_08-web-animations-api-asciidoc5"/>You want to add to, or remove elements from, the DOM with an animation effect.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id494">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>The solution differs slightly for each operation.</p>&#13;
&#13;
<p>For <em>adding</em> an element, add the element to the DOM first then immediately run the animation (such as a fade in). Since only elements in the DOM can be animated, you need to add it before running the animation (see <a data-type="xref" href="#example8-6">Example 8-6</a>).</p>&#13;
<div data-type="example" id="example8-6">&#13;
<h5><span class="label">Example 8-6. </span>Showing an element with an animation</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Shows an element that was just added to the DOM with a fade-in animation.</code>&#13;
<code class="cm"> * @param element The element to show</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">showElement</code><code class="p">(</code><code class="nx">element</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">appendChild</code><code class="p">(</code><code class="nx">element</code><code class="p">);</code>&#13;
  <code class="nx">element</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
    <code class="p">{</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mi">0</code> <code class="p">},</code>&#13;
    <code class="p">{</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>&#13;
  <code class="p">],</code> <code class="p">{</code>&#13;
    <code class="c1">// Animate for 250 milliseconds.</code>&#13;
    <code class="nx">duration</code><code class="o">:</code> <code class="mi">250</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>To <em>remove</em> an element, you need to run the animation <em>first</em> (such as a fade out). Once the animation completes, immediately remove the element from the DOM  (see <a data-type="xref" href="#example8-7">Example 8-7</a>).</p>&#13;
<div data-type="example" id="example8-7">&#13;
<h5><span class="label">Example 8-7. </span>Removing an element with an animation</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Removes an element from the DOM after performing a fade-out animation.</code>&#13;
<code class="cm"> * @param element The element to remove</code>&#13;
<code class="cm"> */</code>&#13;
<code class="nx">async</code> <code class="kd">function</code> <code class="nx">removeElement</code><code class="p">(</code><code class="nx">element</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="c1">// First, perform the animation and make the element disappear from view.</code>&#13;
  <code class="c1">// The resulting animation's 'finished' property is a Promise.</code>&#13;
  <code class="nx">await</code> <code class="nx">element</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
    <code class="p">{</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mi">1</code> <code class="p">},</code>&#13;
    <code class="p">{</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mi">0</code> <code class="p">}</code>&#13;
  <code class="p">],</code> <code class="p">{</code>&#13;
    <code class="c1">// Animate for 250 milliseconds.</code>&#13;
    <code class="nx">duration</code><code class="o">:</code> <code class="mi">250</code>&#13;
  <code class="p">}).</code><code class="nx">finished</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// Animation is done, now remove the element from the DOM.</code>&#13;
  <code class="nx">element</code><code class="p">.</code><code class="nx">remove</code><code class="p">();</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id106">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>When you run the animation at the same time you add the element, it begins animating from zero opacity before it has a chance to initially be rendered. This produces the effect you want—an element that is hidden and fades into view.</p>&#13;
&#13;
<p>When you’re removing the element, you can use the animation’s <code>finished</code> <code>Promise</code> to wait until the animation is finished. You don’t want to remove the element from the DOM until the animation is completely finished, otherwise the effect could only run partially and the element would disappear<a data-startref="ix_08-web-animations-api-asciidoc5" data-type="indexterm" id="id953"/><a data-startref="ix_08-web-animations-api-asciidoc4" data-type="indexterm" id="id954"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Reversing Animations" data-type="sect1"><div class="sect1" id="id495">&#13;
<h1>Reversing Animations</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id107">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="animations" data-secondary="reversing" data-type="indexterm" id="ix_08-web-animations-api-asciidoc6"/><a data-primary="hover effect" data-type="indexterm" id="ix_08-web-animations-api-asciidoc7"/><a data-primary="Web Animations API" data-secondary="reversing" data-type="indexterm" id="ix_08-web-animations-api-asciidoc8"/>You want to cancel an in-progress animation, such as a hover effect, and smoothly revert it back to the initial state.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id496">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the <code>Animation</code> object’s <code>reverse</code> method to start playing in the reverse direction.</p>&#13;
&#13;
<p>You can keep track of the in-progress animation with a variable. When you change the desired animation state, and this variable has a value, it means another animation is already in progress and the browser should reverse it.</p>&#13;
&#13;
<p>In the example of a hover effect (see <a data-type="xref" href="#example8-8">Example 8-8</a>), you can start the animation when the mouse hovers over the element.</p>&#13;
<div data-type="example" id="example8-8">&#13;
<h5><span class="label">Example 8-8. </span>The hover effect</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">element</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'mouseover'</code><code class="p">,</code> <code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">animation</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// There was already an animation in progress. Instead of starting a new</code>&#13;
    <code class="c1">// animation, reverse the current one.</code>&#13;
    <code class="nx">animation</code><code class="p">.</code><code class="nx">reverse</code><code class="p">();</code>&#13;
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="c1">// Nothing is in progress, so start a new animation.</code>&#13;
    <code class="nx">animation</code> <code class="o">=</code> <code class="nx">element</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
      <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'scale(1)'</code> <code class="p">},</code>&#13;
      <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'scale(2)'</code> <code class="p">}</code>&#13;
    <code class="p">],</code> <code class="p">{</code>&#13;
      <code class="c1">// Animate for 1 second.</code>&#13;
      <code class="nx">duration</code><code class="o">:</code> <code class="mi">1000</code><code class="p">,</code>&#13;
      <code class="c1">// Apply the initial and end styles.</code>&#13;
      <code class="nx">fill</code><code class="o">:</code> <code class="s1">'both'</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Once the animation finishes, set the current animation to null.</code>&#13;
    <code class="nx">await</code> <code class="nx">animation</code><code class="p">.</code><code class="nx">finished</code><code class="p">;</code>&#13;
    <code class="nx">animation</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>When the mouse moves away, the same logic applies (see <a data-type="xref" href="#example8-9">Example 8-9</a>).</p>&#13;
<div data-type="example" id="example8-9">&#13;
<h5><span class="label">Example 8-9. </span>Removing the hover effect</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">button</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'mouseout'</code><code class="p">,</code> <code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">animation</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// There was already an animation in progress. Instead of starting a new</code>&#13;
    <code class="c1">// animation, reverse the current one.</code>&#13;
    <code class="nx">animation</code><code class="p">.</code><code class="nx">reverse</code><code class="p">();</code>&#13;
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="c1">// Nothing is in progress, so start a new animation.</code>&#13;
    <code class="nx">animation</code> <code class="o">=</code> <code class="nx">button</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
      <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'scale(2)'</code> <code class="p">},</code>&#13;
      <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'scale(1)'</code> <code class="p">}</code>&#13;
    <code class="p">],</code> <code class="p">{</code>&#13;
      <code class="c1">// Animate for 1 second.</code>&#13;
      <code class="nx">duration</code><code class="o">:</code> <code class="mi">1000</code><code class="p">,</code>&#13;
      <code class="c1">// Apply the initial and end styles.</code>&#13;
      <code class="nx">fill</code><code class="o">:</code> <code class="s1">'both'</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Once the animation finishes, set the current animation to null.</code>&#13;
    <code class="nx">await</code> <code class="nx">animation</code><code class="p">.</code><code class="nx">finished</code><code class="p">;</code>&#13;
    <code class="nx">animation</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id108">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Since the keyframes are the same in each case (they only differ in their order), you can have a single animation function that sets the animation’s <code>direction</code> property. When the mouse hovers over the element, you want to run the element in the <code>forward</code>, or normal, direction. When the mouse leaves, you’ll run the same animation, but with the direction set to <code>reverse</code> (see <a data-type="xref" href="#example8-10">Example 8-10</a>).</p>&#13;
<div data-type="example" id="example8-10">&#13;
<h5><span class="label">Example 8-10. </span>A single animation function</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">async</code> <code class="kd">function</code> <code class="nx">animate</code><code class="p">(</code><code class="nx">element</code><code class="p">,</code> <code class="nx">direction</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">animation</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">animation</code><code class="p">.</code><code class="nx">reverse</code><code class="p">();</code>&#13;
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="nx">animation</code> <code class="o">=</code> <code class="nx">element</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
      <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'scale(1)'</code> <code class="p">},</code>&#13;
      <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'scale(2)'</code> <code class="p">}</code>&#13;
    <code class="p">],</code> <code class="p">{</code>&#13;
      <code class="c1">// Animate for 1 second.</code>&#13;
      <code class="nx">duration</code><code class="o">:</code> <code class="mi">1000</code><code class="p">,</code>&#13;
      <code class="c1">// Apply the end style after the animation is done.</code>&#13;
      <code class="nx">fill</code><code class="o">:</code> <code class="s1">'forward'</code><code class="p">,</code>&#13;
      <code class="c1">// Run the animation forward (normal) or backward (reverse)</code>&#13;
      <code class="c1">// depending on the direction argument.</code>&#13;
      <code class="nx">direction</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Once the animation finishes, set the variable to</code>&#13;
    <code class="c1">// null to signal that there is no animation in progress.</code>&#13;
    <code class="nx">await</code> <code class="nx">animation</code><code class="p">.</code><code class="nx">finished</code><code class="p">;</code>&#13;
    <code class="nx">animation</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="nx">element</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'mouseover'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">animate</code><code class="p">(</code><code class="nx">element</code><code class="p">,</code> <code class="s1">'normal'</code><code class="p">);</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">element</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'mouseout'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="nx">animate</code><code class="p">(</code><code class="nx">element</code><code class="p">,</code> <code class="s1">'reverse'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>The result is the same as before. When you hover over the element, it starts to increase in size due to the <code>scale(2)</code> transform. If you move the mouse away, it starts shrinking again by reversing the animation’s direction.</p>&#13;
&#13;
<p>The difference is in the event handlers. They both call a single function, using different values for the animation’s <code>direction</code> option.</p>&#13;
&#13;
<p><a data-type="xref" href="#example8-8">Example 8-8</a> sets the animation’s <em>fill</em> mode to <code>both</code>. The animation’s fill mode determines the style of the element before and after the animation. By default, the fill mode is <code>none</code>. This means that when the animation completes, the element’s style jumps back to what it was before the animation.</p>&#13;
&#13;
<p>In practice, this means that when you hover over the element, it starts growing until it reaches its final size, but then it immediately jumps back to its original size, due to no fill mode being set.</p>&#13;
&#13;
<p>There are three options (other than <code>none</code>) for the fill mode:</p>&#13;
<dl>&#13;
<dt><code>backward</code></dt>&#13;
<dd>&#13;
<p>The element’s style is set to the animation’s starting keyframe before the animation starts. This is usually only applicable when using an animation delay, as it defines what the element’s style is within the delay period.</p>&#13;
</dd>&#13;
<dt><code>forward</code></dt>&#13;
<dd>&#13;
<p>After the animation finishes, the ending keyframe styles remain applied.</p>&#13;
</dd>&#13;
<dt><code>both</code></dt>&#13;
<dd>&#13;
<p>Applies the rules of both <code>backward</code> and <code>forward</code>.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The animation in <a data-type="xref" href="#example8-10">Example 8-10</a> has no delay, so the <code>forward</code> option is used to retain the style after the animation ends<a data-startref="ix_08-web-animations-api-asciidoc8" data-type="indexterm" id="id955"/><a data-startref="ix_08-web-animations-api-asciidoc7" data-type="indexterm" id="id956"/><a data-startref="ix_08-web-animations-api-asciidoc6" data-type="indexterm" id="id957"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Showing a Scroll Progress Indicator" data-type="sect1"><div class="sect1" id="id497">&#13;
<h1>Showing a Scroll Progress Indicator</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id109">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="scroll progress indicator" data-type="indexterm" id="ix_08-web-animations-api-asciidoc9"/><a data-primary="Web Animations API" data-secondary="showing a scroll progress indicator" data-type="indexterm" id="ix_08-web-animations-api-asciidoc10"/>You want to show a bar at the top of the page that moves as you scroll. As you scroll down, the bar moves to the right.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id498">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use a scroll-linked animation by creating a <code>ScrollTimeline</code> and passing it to the element’s <code>animate</code> method. To make the element grow from left to right, you can animate the <code>transition</code> property from <code>scaleX(0)</code> to <code>scaleX(1)</code>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>This API may not be supported by all browsers yet. See <a href="https://oreil.ly/l-hvN">CanIUse</a> for the latest compatibility data.</p>&#13;
</div>&#13;
&#13;
<p>First, set some styles for the progress bar element, as shown in <a data-type="xref" href="#example8-11">Example 8-11</a>.</p>&#13;
<div data-type="example" id="example8-11">&#13;
<h5><span class="label">Example 8-11. </span>Scroll progress bar styles</h5>&#13;
&#13;
<pre data-code-language="css" data-type="programlisting"><code class="nc">.scroll-progress</code> <code class="p">{</code>&#13;
  <code class="k">height</code><code class="o">:</code> <code class="m">8px</code><code class="p">;</code>&#13;
  <code class="k">transform-origin</code><code class="o">:</code> <code class="nb">left</code><code class="p">;</code>&#13;
  <code class="k">position</code><code class="o">:</code> <code class="n">sticky</code><code class="p">;</code>&#13;
  <code class="k">top</code><code class="o">:</code> <code class="m">0</code><code class="p">;</code>&#13;
  <code class="k">transform</code><code class="o">:</code> <code class="n">scaleX</code><code class="p">(</code><code class="m">0</code><code class="p">);</code>&#13;
  <code class="k">background</code><code class="o">:</code> <code class="nb">blue</code><code class="p">;</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>The <code>position: sticky</code> property ensures that the element remains visible as you scroll down the page. Also, its initial style is set to <code>scaleX(0)</code>, which effectively hides it. Without this, the bar would appear at its full width for an instant then disappear. This ensures you won’t see the bar at all until you scroll.</p>&#13;
&#13;
<p>Next, create a <code>ScrollTimeline</code> object and pass it as the animation’s <code>timeline</code> option, as shown in <a data-type="xref" href="#code_scrollTimeline">Example 8-12</a>.</p>&#13;
<div data-type="example" id="code_scrollTimeline">&#13;
<h5><span class="label">Example 8-12. </span>Creating the scroll timeline</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">progress</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'.scroll-progress'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Create a timeline that's linked to the document's</code>&#13;
<code class="c1">// scroll position.</code>&#13;
<code class="kr">const</code> <code class="nx">timeline</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ScrollTimeline</code><code class="p">({</code>&#13;
  <code class="nx">source</code><code class="o">:</code> <code class="nb">document</code><code class="p">.</code><code class="nx">documentElement</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// Start the animation, passing the timeline you just created.</code>&#13;
<code class="nx">progress</code><code class="p">.</code><code class="nx">animate</code><code class="p">(</code>&#13;
  <code class="p">[</code>&#13;
    <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'scaleX(0)'</code> <code class="p">},</code>&#13;
    <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'scaleX(1)'</code> <code class="p">}</code>&#13;
  <code class="p">],</code>&#13;
  <code class="p">{</code> <code class="nx">timeline</code> <code class="p">});</code></pre></div>&#13;
&#13;
<p>You now have a scroll-linked animation.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id110">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p><a data-primary="AnimationTimeline interface" data-type="indexterm" id="id958"/><a data-primary="timeline, of animation" data-type="indexterm" id="id959"/>An animation’s <em>timeline</em> is an object that implements the <code>AnimationTimeline</code> interface. By default, an animation uses the document’s default timeline, which is a &#13;
<span class="keep-together"><code>DocumentTimeline</code></span> object. This is a timeline that’s linked to elapsed time on the clock. When you start an animation with the default timeline, it starts at the initial keyframe and runs forward until it reaches the end (or you stop it manually). Because this type of timeline is linked to elapsed time, it has a defined start value and continuously increases as time passes.</p>&#13;
&#13;
<p><a data-primary="scroll-linked animation" data-type="indexterm" id="id960"/>However, a <em>scroll-linked</em> animation provides a timeline linked to the scroll position. When you scroll all the way to the top, the scroll position is 0 and the animation remains at its initial state. As you scroll down, the position increases and the animation advances. Once you have scrolled all the way to the bottom, the animation reaches its end. If you scroll back up, the animation runs in reverse.</p>&#13;
&#13;
<p><a data-primary="ScrollTimeline" data-type="indexterm" id="id961"/>A <code>ScrollTimeline</code> is given a source element. In <a data-type="xref" href="#code_scrollTimeline">Example 8-12</a>, the source is the document element (the <code>body</code> tag). You can pass any scrollable element as the source, and the <code>ScrollTimeline</code> uses that element’s scroll position to determine the current progress.</p>&#13;
&#13;
<p>At the time of writing, <code>DocumentTimeline</code> is supported in all modern browsers but <code>ScrollTimeline</code> is not. Be sure to always check browser support before using a &#13;
<span class="keep-together"><code>ScrollTimeline</code>.</span><a data-startref="ix_08-web-animations-api-asciidoc10" data-type="indexterm" id="id962"/><a data-startref="ix_08-web-animations-api-asciidoc9" data-type="indexterm" id="id963"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Making an Element Bounce" data-type="sect1"><div class="sect1" id="recipe_bounce">&#13;
<h1>Making an Element Bounce</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id111">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="bouncing effect" data-type="indexterm" id="ix_08-web-animations-api-asciidoc11"/><a data-primary="Web Animations API" data-secondary="making an element bounce" data-type="indexterm" id="ix_08-web-animations-api-asciidoc12"/>You want to apply a momentary bouncing effect to an element.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id500">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Apply a series of animations, one after another. Use an animation’s <code>finished</code> <code>Promise</code> to wait for it to finish before running the next one.</p>&#13;
&#13;
<p>The element moves up and down three times. On each pass, the element is moved up the page by applying a <code>translateY</code> transform, then back down to its original position. The first pass bounces the element by 40 pixels, the second by 20 pixels, and the third by 10 pixels. This gives the appearance of gravity slowing the bounce down each time. This can be done with a <code>for</code>-<code>of</code> loop (see <a data-type="xref" href="#example8-13">Example 8-13</a>).</p>&#13;
<div data-type="example" id="example8-13">&#13;
<h5><span class="label">Example 8-13. </span>Applying the bounce animations in series</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">async</code> <code class="kd">function</code> <code class="nx">animateBounce</code><code class="p">(</code><code class="nx">element</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">distances</code> <code class="o">=</code> <code class="p">[</code> <code class="s1">'40px'</code><code class="p">,</code> <code class="s1">'20px'</code><code class="p">,</code> <code class="s1">'10px'</code> <code class="p">];</code>&#13;
  <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">distance</code> <code class="k">of</code> <code class="nx">distances</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Wait for this animation to complete before continuing.</code>&#13;
    <code class="nx">await</code> <code class="nx">element</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
      <code class="c1">// Start at the bottom.</code>&#13;
      <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'translateY(0)'</code> <code class="p">},</code>&#13;
&#13;
      <code class="c1">// Move up by the current distance.</code>&#13;
      <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="sb">`translateY(-</code><code class="si">${</code><code class="nx">distance</code><code class="si">}</code><code class="sb">)`</code><code class="p">,</code> <code class="nx">offset</code><code class="o">:</code> <code class="mf">0.5</code> <code class="p">},</code>&#13;
&#13;
      <code class="c1">// Back to the bottom</code>&#13;
      <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'translateY(0)'</code> <code class="p">}</code>&#13;
    <code class="p">],</code> <code class="p">{</code>&#13;
      <code class="c1">// Animate for 250 milliseconds.</code>&#13;
      <code class="nx">duration</code><code class="o">:</code> <code class="mi">250</code><code class="p">,</code>&#13;
&#13;
      <code class="c1">// Use a more fluid easing function than linear</code>&#13;
      <code class="c1">// (the default).</code>&#13;
      <code class="nx">easing</code><code class="o">:</code> <code class="s1">'ease-in-out'</code>&#13;
    <code class="p">}).</code><code class="nx">finished</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id112">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>This example demonstrates an advantage of the Web Animations API: dynamic keyframe values. Each iteration through the loop uses a different <code>distance</code> value inside the keyframe effect.</p>&#13;
&#13;
<p>The <code>for</code>-<code>of</code> loop walks through the three distances (40px, 20px, and 10px) and animates them in turn. In each iteration, it moves the element up by the given distance and back down again. The key is the last line, where it references the animation’s &#13;
<span class="keep-together"><code>finished</code></span> property. This ensures that the next loop iteration doesn’t start until the current animation finishes. The result is the animations run in series, one after the other, providing the bounce effect.</p>&#13;
&#13;
<p>You may be wondering why this example uses a <code>for</code>-<code>of</code> loop rather than a <code>forEach()</code> call on the array. Using <code>await</code> inside array methods such as <code>forEach</code> does not work as you’d expect. These methods were not designed for asynchronous use. If you used a <code>forEach</code> call, the <code>element.animate</code> calls would all be called immediately after one another, resulting in only the last animation being played. Using a <code>for</code>-<code>of</code> loop (a regular <code>for</code> loop would work as well) works as expected with <code>async</code>/<code>await</code> and gives the desired result<a data-startref="ix_08-web-animations-api-asciidoc12" data-type="indexterm" id="id964"/><a data-startref="ix_08-web-animations-api-asciidoc11" data-type="indexterm" id="id965"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running Multiple Animations Simultaneously" data-type="sect1"><div class="sect1" id="id501">&#13;
<h1>Running Multiple Animations Simultaneously</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id113">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="animations" data-secondary="running multiple animations simultaneously" data-type="indexterm" id="ix_08-web-animations-api-asciidoc13"/><a data-primary="transform animations" data-type="indexterm" id="ix_08-web-animations-api-asciidoc14"/><a data-primary="Web Animations API" data-secondary="running multiple animations simultaneously" data-type="indexterm" id="ix_08-web-animations-api-asciidoc15"/>You want to apply multiple transforms to an element using multiple animations.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id502">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Call <code>animate</code> on the element multiple times, with the different transform keyframes. You must also specify the <code>composite</code> property to combine the transforms, as shown in <a data-type="xref" href="#example8-14">Example 8-14</a>.</p>&#13;
<div data-type="example" id="example8-14">&#13;
<h5><span class="label">Example 8-14. </span>Combining two transform animations</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// The first animation will move the element back and forth on the x-axis.</code>&#13;
<code class="nx">element</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
  <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'translateX(0)'</code> <code class="p">},</code>&#13;
  <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'translateX(250px)'</code> <code class="p">}</code>&#13;
<code class="p">],</code> <code class="p">{</code>&#13;
  <code class="c1">// Animate for 5 seconds.</code>&#13;
  <code class="nx">duration</code><code class="o">:</code> <code class="mi">5000</code><code class="p">,</code>&#13;
  <code class="c1">// Run the animation forward, then run it in reverse.</code>&#13;
  <code class="nx">direction</code><code class="o">:</code> <code class="s1">'alternate'</code><code class="p">,</code>&#13;
  <code class="c1">// Repeat the animation forever.</code>&#13;
  <code class="nx">iterations</code><code class="o">:</code> <code class="kc">Infinity</code><code class="p">,</code>&#13;
  <code class="c1">// Slow to start, fast in the middle, slow at the end.</code>&#13;
  <code class="nx">easing</code><code class="o">:</code> <code class="s1">'ease-in-out'</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// The second animation rotates the element.</code>&#13;
<code class="nx">element</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
  <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'rotate(0deg)'</code> <code class="p">},</code>&#13;
  <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'rotate(360deg)'</code> <code class="p">}</code>&#13;
<code class="p">],</code> <code class="p">{</code>&#13;
  <code class="c1">// Animate for 3 seconds.</code>&#13;
  <code class="nx">duration</code><code class="o">:</code> <code class="mi">3000</code><code class="p">,</code>&#13;
  <code class="c1">// Repeat the animation forever.</code>&#13;
  <code class="nx">iterations</code><code class="o">:</code> <code class="kc">Infinity</code><code class="p">,</code>&#13;
  <code class="c1">// Combine the effects with other running animations.</code>&#13;
  <code class="nx">composite</code><code class="o">:</code> <code class="s1">'add'</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>The <code>alternate</code> direction means the animation runs forward to completion, then runs backward to completion. Because <code>iterations</code> is set to <code>Infinity</code>, the animation runs forever.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id114">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The key to this effect is the <code>composite</code> property added to the second animation. If you don’t specify <code>composite: add</code>, you <em>only</em> see the <code>rotate</code> transform because it overrides the <code>translateX</code> transform. The element would rotate but not move horizontally.</p>&#13;
&#13;
<p>This, in effect, combines both transforms into a single transform. Also note, however, that these transforms are happening at different rates. The rotation lasts for three seconds, while the translation lasts for five. The animations use different easing functions as well. Despite the different options, the browser smoothly combines the animations<a data-startref="ix_08-web-animations-api-asciidoc15" data-type="indexterm" id="id966"/><a data-startref="ix_08-web-animations-api-asciidoc14" data-type="indexterm" id="id967"/><a data-startref="ix_08-web-animations-api-asciidoc13" data-type="indexterm" id="id968"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Showing a Loading Animation" data-type="sect1"><div class="sect1" id="id503">&#13;
<h1>Showing a Loading Animation</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id115">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="loading indicator, for animation" data-type="indexterm" id="ix_08-web-animations-api-asciidoc16"/><a data-primary="Web Animations API" data-secondary="showing a loading animation" data-type="indexterm" id="ix_08-web-animations-api-asciidoc17"/>You want to show a loading indicator to the user while waiting for a network request to complete.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id116">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Create and style the loading indicator, then apply an infinite rotation animation to it until the <code>Promise</code> returned by <code>fetch</code> resolves.</p>&#13;
&#13;
<p><a data-primary="fade animation" data-type="indexterm" id="ix_08-web-animations-api-asciidoc18"/>To make a smooth effect, you can first apply a fade-in animation. Once the <code>Promise</code> resolves, you can fade it out.</p>&#13;
&#13;
<p>First, create a loader element and define some styles, as shown in <a data-type="xref" href="#example8-15">Example 8-15</a>.</p>&#13;
<div data-type="example" id="example8-15">&#13;
<h5><span class="label">Example 8-15. </span>The loader element</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">style</code><code class="p">&gt;</code>&#13;
  <code class="nf">#loader</code> <code class="p">{</code>&#13;
    <code class="k">width</code><code class="o">:</code> <code class="m">64px</code><code class="p">;</code>&#13;
    <code class="k">height</code><code class="o">:</code> <code class="m">64px</code><code class="p">;</code>&#13;
&#13;
    <code class="c">/* Make a circle shape */</code>&#13;
    <code class="k">border-radius</code><code class="o">:</code> <code class="m">50%</code><code class="p">;</code>&#13;
    <code class="k">border-width</code><code class="o">:</code> <code class="m">10px</code><code class="p">;</code>&#13;
    <code class="k">border-style</code><code class="o">:</code> <code class="nb">solid</code><code class="p">;</code>&#13;
    <code class="k">border-color</code><code class="o">:</code> <code class="nb">skyblue</code> <code class="nb">blue</code> <code class="nb">skyblue</code> <code class="nb">blue</code><code class="p">;</code>&#13;
&#13;
    <code class="c">/* Set the initial opacity so the animation that appears is smooth */</code>&#13;
    <code class="k">opacity</code><code class="o">:</code> <code class="m">0</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
<code class="nt">&lt;/style&gt;</code>&#13;
&#13;
<code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"loader"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code></pre></div>&#13;
&#13;
<p>The loader is a ring with alternating border colors, as shown in <a data-type="xref" href="#loaderImage">Figure 8-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="loaderImage">&#13;
<img alt="The styled loader" src="assets/wacb_0801.png"/>&#13;
<h6><span class="label">Figure 8-1. </span>The styled loader</h6>&#13;
</div></figure>&#13;
&#13;
<p>Next, define a function that starts the animation and wait for the <code>Promise</code>, as shown in <a data-type="xref" href="#example8-16">Example 8-16</a>.</p>&#13;
<div data-type="example" id="example8-16">&#13;
<h5><span class="label">Example 8-16. </span>The loader animations</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">async</code> <code class="kd">function</code> <code class="nx">showLoader</code><code class="p">(</code><code class="nx">promise</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">loader</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'#loader'</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// Start the spin animation before fading in.</code>&#13;
  <code class="kr">const</code> <code class="nx">spin</code> <code class="o">=</code> <code class="nx">loader</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
    <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'rotate(0deg)'</code> <code class="p">},</code>&#13;
    <code class="p">{</code> <code class="nx">transform</code><code class="o">:</code> <code class="s1">'rotate(360deg)'</code> <code class="p">}</code>&#13;
  <code class="p">],</code> <code class="p">{</code> <code class="nx">duration</code><code class="o">:</code> <code class="mi">1000</code><code class="p">,</code> <code class="nx">iterations</code><code class="o">:</code> <code class="kc">Infinity</code> <code class="p">});</code>&#13;
&#13;
  <code class="c1">// Since the opacity is 0, the loader isn't visible yet.</code>&#13;
  <code class="c1">// Show it with a fade-in animation.</code>&#13;
  <code class="c1">// The loader will continue spinning as it fades in.</code>&#13;
  <code class="nx">loader</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
    <code class="p">{</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mi">0</code> <code class="p">},</code>&#13;
    <code class="p">{</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>&#13;
  <code class="p">],</code> <code class="p">{</code> <code class="nx">duration</code><code class="o">:</code> <code class="mi">500</code><code class="p">,</code> <code class="nx">fill</code><code class="o">:</code> <code class="s1">'both'</code> <code class="p">});</code>&#13;
&#13;
  <code class="c1">// Wait for the Promise to resolve.</code>&#13;
  <code class="nx">await</code> <code class="nx">promise</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// The Promise is done. Now fade the loader out.</code>&#13;
  <code class="c1">// Don't stop the spin animation until the fade out is complete.</code>&#13;
  <code class="c1">// You can wait by awaiting the 'finished' Promise.</code>&#13;
  <code class="nx">await</code> <code class="nx">loader</code><code class="p">.</code><code class="nx">animate</code><code class="p">([</code>&#13;
    <code class="p">{</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mi">1</code> <code class="p">},</code>&#13;
    <code class="p">{</code> <code class="nx">opacity</code><code class="o">:</code> <code class="mi">0</code> <code class="p">}</code>&#13;
  <code class="p">],</code> <code class="p">{</code> <code class="nx">duration</code><code class="o">:</code> <code class="mi">500</code><code class="p">,</code> <code class="nx">fill</code><code class="o">:</code> <code class="s1">'both'</code> <code class="p">}).</code><code class="nx">finished</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// Finally, stop the spin animation.</code>&#13;
  <code class="nx">spin</code><code class="p">.</code><code class="nx">cancel</code><code class="p">();</code>&#13;
&#13;
  <code class="c1">// Return the original Promise to allow chaining.</code>&#13;
  <code class="k">return</code> <code class="nx">promise</code><code class="p">;</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You can now pass your <code>fetch</code> call as an argument to <code>showLoader</code>, as shown in <a data-type="xref" href="#example8-17">Example 8-17</a>.</p>&#13;
<div data-type="example" id="example8-17">&#13;
<h5><span class="label">Example 8-17. </span>Using the loader</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">showLoader</code><code class="p">(</code>&#13;
  <code class="nx">fetch</code><code class="p">(</code><code class="s1">'https://example.com/api/users'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">response</code> <code class="o">=&gt;</code> <code class="nx">response</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>&#13;
<code class="p">);</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id117">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>You don’t necessarily need the Web Animations API to create an animated loader—you can do that with plain CSS. As this example shows, though, the Web Animations API lets you combine multiple animations. The infinite spin animation continues to run while the fade-in animation runs. This is a little tricky to do with regular CSS <a data-startref="ix_08-web-animations-api-asciidoc18" data-type="indexterm" id="id969"/>animations<a data-startref="ix_08-web-animations-api-asciidoc17" data-type="indexterm" id="id970"/><a data-startref="ix_08-web-animations-api-asciidoc16" data-type="indexterm" id="id971"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Respecting the User’s Animation Preference" data-type="sect1"><div class="sect1" id="id504">&#13;
<h1>Respecting the User’s Animation Preference</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id289">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="animations" data-secondary="respecting the user’s preference" data-type="indexterm" id="id972"/><a data-primary="Web Animations API" data-secondary="respecting the user’s animation preference" data-type="indexterm" id="id973"/>You want to tone down, or disable, animations if the user has configured their operating system to reduce motion.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id505">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use <code>window.matchMedia</code> to check the <code>prefers-reduced-motion</code> media query (see <a data-type="xref" href="#example8-18">Example 8-18</a>).</p>&#13;
<div data-type="example" id="example8-18">&#13;
<h5><span class="label">Example 8-18. </span>Using the prefers-reduced-motion media query</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nb">window</code><code class="p">.</code><code class="nx">matchMedia</code><code class="p">(</code><code class="s1">'(prefers-reduced-motion: reduce)'</code><code class="p">).</code><code class="nx">matches</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="c1">// Reduced motion is not enabled, so animate normally.</code>&#13;
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
  <code class="c1">// Skip this animation or run a less intense one.</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id118">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>This is extremely important for accessibility. Users with epilepsy or vestibular disorders could have seizures, migraines, or other ill effects triggered by a large or fast-moving animation.</p>&#13;
&#13;
<p>You don’t necessarily have to disable animation altogether; you could instead use a more subtle one. Suppose you are showing an element with a bounce effect that looks really good but could be disorienting for some users. If the user has reduced motion enabled, you could instead provide a simple fade-in animation.<a data-startref="ix_08-web-animations-api-asciidoc0" data-type="indexterm" id="id974"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section></body></html>