<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 20. Performing Transactions"><div class="chapter" id="nch-xact"><h1><span class="label">Chapter 20. </span>Performing Transactions</h1><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45820327167712"><h5>A note for Early Release readers</h5><p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p></div></aside><section data-type="sect1" data-pdf-bookmark="20.0 Introduction"><div class="sect1" id="nch-xact-xact-intro"><h1>20.0 Introduction</h1><p>The MySQL server can handle multiple clients at the same time
    because it is multithreaded. To deal with contention among clients, the
    server performs any necessary locking so that two clients cannot modify
    the same data at once. However, as the server executes SQL statements,
    it’s very possible that successive statements received from a given client
    will be interleaved with statements from other clients. If a client
    executes multiple statements that are dependent on each other, the fact
    that other clients may be updating tables in between those statements can
    cause difficulties. 
    </p><p>Statement failures can be problematic, too, if a
    multiple-statement operation does not run to completion. Suppose that a
    <code>flight</code> table contains information about
    airline flight schedules and you want to update the row for Flight 578 by
    choosing a pilot from among those available. You might do so using three
    statements as follows:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SET</code> <code class="o">@</code><code class="n">p_val</code> <code class="o">=</code> <code class="p">(</code><code class="k">SELECT</code> <code class="n">pilot_id</code> <code class="k">FROM</code> <code class="n">pilot</code> <code class="k">WHERE</code> <code class="n">available</code> <code class="o">=</code> <code class="s1">'yes'</code> <code class="k">LIMIT</code> <code class="mi">1</code><code class="p">);</code>
<code class="k">UPDATE</code> <code class="n">pilot</code> <code class="k">SET</code> <code class="n">available</code> <code class="o">=</code> <code class="s1">'no'</code> <code class="k">WHERE</code> <code class="n">pilot_id</code> <code class="o">=</code> <code class="o">@</code><code class="n">p_val</code><code class="p">;</code>
<code class="k">UPDATE</code> <code class="n">flight</code> <code class="k">SET</code> <code class="n">pilot_id</code> <code class="o">=</code> <code class="o">@</code><code class="n">p_val</code> <code class="k">WHERE</code> <code class="n">flight_id</code> <code class="o">=</code> <code class="mi">578</code><code class="p">;</code></pre><p>The first statement chooses an available pilot, the second marks the
    pilot as unavailable, and the third assigns the pilot to the flight.
    That’s straightforward enough in principle, but in practice there are
    significant difficulties:</p><dl><dt>Concurrency issues</dt><dd><p>If two clients want to schedule pilots, it’s possible for
          both to run the initial <code>SELECT</code>
          query and retrieve the same pilot ID number before either has a
          chance to set the pilot’s status to unavailable. If that happens,
          the same pilot is scheduled for two flights at once.</p></dd><dt>Integrity issues</dt><dd><p>All three statements must execute successfully as a unit.
          For example, if the <code>SELECT</code> and
          the first <code>UPDATE</code> run
          successfully, but the second <code>UPDATE</code> fails, the pilot’s status is set to
          unavailable without the pilot being assigned a flight. The database
          becomes inconsistent.</p></dd></dl><p>To prevent concurrency and integrity problems in these types of
    situations, transactions are helpful. A transaction groups a set of
    statements and guarantees the following properties:</p><ul><li><p>No other client can update the data used in the transaction
        while the transaction is in progress; it’s as though you have the
        server all to yourself. For example, other clients cannot modify the
        pilot or flight records while you’re booking a pilot for a flight.
        Transactions solve concurrency problems arising from the
        multiple-client nature of the MySQL server. In effect, transactions
        serialize access to a shared resource across multiple-statement
        operations.</p></li><li><p>Statements grouped within a transaction are committed (take
        effect) as a unit, but only if they all succeed. If an error occurs,
        any actions that occurred prior to the error are rolled back, leaving
        the relevant tables unaffected as though none of the statements had
        been executed. This keeps the database from becoming inconsistent. For
        example, if an update to the <code>flights</code> table fails, rollback causes the
        change to the <code>pilots</code> table to be
        undone, leaving the pilot still available. Rollback frees you from
        having to figure out how to undo a partially completed operation
        yourself.</p></li></ul><p>This chapter shows the syntax for the SQL statements that begin and
    end transactions. It also describes how to implement transactional
    operations from within programs, using error detection to determine
    whether to commit or roll back.</p><p>Scripts related to the examples shown here are located in the
    <em class="filename">transactions</em> directory of the
    <code>recipes</code> distribution.</p></div></section><section data-type="sect1" data-pdf-bookmark="20.1 Choosing a Transactional Storage Engine"><div class="sect1" id="nch-xact-xact-requirements"><h1>20.1 Choosing a Transactional Storage Engine</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820327068688"><h2>Problem</h2><p>You want to use transactions.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820327067808"><h2>Solution</h2><p>To use transactions, you must use a transaction-safe engine. Check your MySQL server to determine which transactional storage engines it
      supports.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820327066928"><h2>Discussion</h2><p>MySQL supports several storage engines. Currently, the transactional
      engines, shipped with the standard distribution, include InnoDB and NDB. To see which your MySQL server supports, use this
      statement:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT ENGINE FROM INFORMATION_SCHEMA.ENGINES</code></strong>
    -&gt; <strong><code>WHERE SUPPORT IN ('YES','DEFAULT') AND TRANSACTIONS='YES';</code></strong>
+--------+
| ENGINE |
+--------+
| InnoDB |
+--------+</pre><p>If MySQL Cluster is enabled, you’ll also see a line that says
      <code>ndbcluster</code>.</p><p>Transactional engines are those that have a <code>TRANSACTIONS</code> value of <code>YES</code>; those actually usable have a <code>SUPPORT</code> value of <code>YES</code> or <code>DEFAULT</code>.</p><p>After determining which transactional storage engines are
      available, to create a table that uses a given engine, add an <code>ENGINE</code> <code>=</code>
      <em><code>tbl_engine</code></em> clause to your <code>CREATE</code> <code>TABLE</code> statement:</p><pre data-type="programlisting" data-code-language="sql">CREATE TABLE <em><code>t</code></em> (i INT) ENGINE = InnoDB;</pre><p>If you need to modify an existing application to perform
      transactions, but it uses nontransactional tables, you can alter the
      tables to use a transactional storage engine. For example, MyISAM tables are nontransactional and trying to use them
      for transactions will yield incorrect results because they do not
      support rollback. In this case, you can use <code>ALTER</code> <code>TABLE</code>
      to convert the tables to a transactional type. Suppose that
      <code>t</code> is a MyISAM table. To make it an
      InnoDB table, do this:</p><pre data-type="programlisting" data-code-language="sql">ALTER TABLE <em><code>t</code></em> ENGINE = InnoDB;</pre><p>One thing to consider before altering a table is that changing it
      to use a transactional storage engine may affect its behavior in other
      ways. For example, the MyISAM engine provides more flexible handling of
      <code>AUTO_INCREMENT</code> columns than do other storage engines. If you rely on MyISAM-only
      sequence features, changing the storage engine will cause
      problems.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="20.2 Performing Transactions Using SQL"><div class="sect1" id="nch-xact-xact-general"><h1>20.2 Performing Transactions Using SQL</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820327053632"><h2>Problem</h2><p>A set of statements must succeed or fail as a unit—that is, you require a
      transaction.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820327052640"><h2>Solution</h2><p>Manipulate MySQL’s auto-commit mode to enable multiple-statement
      transactions, and then commit or roll back the statements depending on
      whether they succeed or fail.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820327051760"><h2>Discussion</h2><p>This recipe describes the SQL statements that control
      transactional behavior in MySQL. The immediately following recipes
      discuss how to perform transactions from within programs. Some APIs
      require that you implement transactions by executing the SQL statements
      discussed in this recipe; others provide a special mechanism that
      enables transaction management without writing SQL directly. However,
      even in the latter case, the API mechanism maps program operations onto
      transactional SQL statements, so reading this recipe will give you a
      better understanding of what the API does on your behalf.</p><p>MySQL normally operates in auto-commit mode, which commits the
      effect of each statement as soon as it executes. (In effect, each
      statement is its own transaction.) To perform a transaction, you must
      disable auto-commit mode, execute the statements that make up the
      transaction, and then either commit or roll back your changes. In MySQL,
      you can do this two ways:</p><ul><li><p>Execute a <code>START</code> <code>TRANSACTION</code> (or <code>BEGIN</code>) statement to suspend auto-commit mode, then execute the statements
          that make up the transaction. If the statements succeed, record
          their effect in the database and terminate the transaction by
          executing a <code>COMMIT</code>
          statement:</p><pre data-type="programlisting">mysql&gt; <strong><code>CREATE TABLE t (i INT) ENGINE = InnoDB;</code></strong>
mysql&gt; <strong><code>START TRANSACTION;</code></strong>
mysql&gt; <strong><code>INSERT INTO t (i) VALUES(1);</code></strong>
mysql&gt; <strong><code>INSERT INTO t (i) VALUES(2);</code></strong>
mysql&gt; <strong><code>COMMIT;</code></strong>
mysql&gt; <strong><code>SELECT * FROM t;</code></strong>
+------+
| i    |
+------+
|    1 |
|    2 |
+------+</pre><p>If an error occurs, don’t use <code>COMMIT</code>. Instead, cancel the transaction by
          executing a <code>ROLLBACK</code> statement. In the following
          example, <code>t</code> remains empty after
          the transaction because the effects of the <code>INSERT</code> statements are rolled back:</p><pre data-type="programlisting">mysql&gt; <strong><code>CREATE TABLE t (i INT) ENGINE = InnoDB;</code></strong>
mysql&gt; <strong><code>START TRANSACTION;</code></strong>
mysql&gt; <strong><code>INSERT INTO t (i) VALUES(1);</code></strong>
mysql&gt; <strong><code>INSERT INTO t (x) VALUES(2);</code></strong>
ERROR 1054 (42S22): Unknown column 'x' in 'field list'
mysql&gt; <strong><code>ROLLBACK;</code></strong>
mysql&gt; <strong><code>SELECT * FROM t;</code></strong>
Empty set (0.00 sec)</pre></li><li><p>Another way to group statements is to turn off auto-commit mode explicitly by setting the <code>autocommit</code>
          session variable to 0. After that, each statement you execute
          becomes part of the current transaction. To end the transaction and
          begin the next one, execute a <code>COMMIT</code> or <code>ROLLBACK</code> statement:</p><pre data-type="programlisting">mysql&gt; <strong><code>CREATE TABLE t (i INT) ENGINE = InnoDB;</code></strong>
mysql&gt; <strong><code>SET autocommit = 0;</code></strong>
mysql&gt; <strong><code>INSERT INTO t (i) VALUES(1);</code></strong>
mysql&gt; <strong><code>INSERT INTO t (i) VALUES(2);</code></strong>
mysql&gt; <strong><code>COMMIT;</code></strong>
mysql&gt; <strong><code>SELECT * FROM t;</code></strong>
+------+
| i    |
+------+
|    1 |
|    2 |
+------+</pre><p>To turn auto-commit mode back on, use this statement:</p><pre data-type="programlisting">mysql&gt; <strong><code>SET autocommit = 1;</code></strong></pre></li></ul><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>Transactions have their limits because not all statements can be
        part of a transaction. For example, if you execute a <code>DROP</code> <code>DATABASE</code> statement, don’t expect to restore the database by executing a
        <code>ROLLBACK</code>.</p></div></div></section></div></section><section data-type="sect1" data-pdf-bookmark="20.3 Performing Transactions from Within Programs"><div class="sect1" id="nch-xact-xact-program"><h1>20.3 Performing Transactions from Within Programs</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820327030064"><h2>Problem</h2><p>You’re writing a program that must implement transactional operations.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820327029184"><h2>Solution</h2><p>Use the transaction abstraction provided by your language API, if
      it has such a thing. If it doesn’t, use the API’s usual
      statement-execution mechanism to execute the transactional SQL
      statements directly.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820327028304"><h2>Discussion</h2><p>To perform transactional processing from within a program, use
      your API language to detect errors and take appropriate action. This
      recipe provides general background on doing this. The next recipes
      provide language-specific details for the MySQL APIs for Perl, Ruby,
      PHP, Python, Go, and Java.</p><p>Every MySQL API supports transactions, even if only in the sense
      that you can explicitly execute transaction-related SQL statements such
      as <code>START</code> <code>TRANSACTION</code> and <code>COMMIT</code>. However, some APIs also provide a
      transaction abstraction that enables control over transactional behavior
      without working directly with SQL. That approach hides the details and
      provides better portability to other database engines that have
      different underlying transaction SQL syntax. An API abstraction is
      available for each language that we use in this book.</p><p>The next few recipes each implement the same example to illustrate
      how to perform program-based transactions. They use a table <code>money</code> containing the following initial rows that
      show how much money two people have:</p><pre data-type="programlisting">+------+------+
| name | amt  |
+------+------+
| Eve  |   10 |
| Ida  |    0 |
+------+------+</pre><p>The sample transaction is a simple financial transfer that uses
      two <code>UPDATE</code> statements to give six
      dollars of Eve’s money to Ida:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">UPDATE</code> <code class="n">money</code> <code class="k">SET</code> <code class="n">amt</code> <code class="o">=</code> <code class="n">amt</code> <code class="o">-</code> <code class="mi">6</code> <code class="k">WHERE</code> <code class="n">name</code> <code class="o">=</code> <code class="s1">'Eve'</code><code class="p">;</code>
<code class="k">UPDATE</code> <code class="n">money</code> <code class="k">SET</code> <code class="n">amt</code> <code class="o">=</code> <code class="n">amt</code> <code class="o">+</code> <code class="mi">6</code> <code class="k">WHERE</code> <code class="n">name</code> <code class="o">=</code> <code class="s1">'Ida'</code><code class="p">;</code></pre><p>The intended result is that the table should look like
      this:</p><pre data-type="programlisting">+------+------+
| name | amt  |
+------+------+
| Eve  |    4 |
| Ida  |    6 |
+------+------+</pre><p>It’s necessary to execute both statements within a transaction to
      ensure that both of them take effect at once. Without a transaction,
      Eve’s money disappears without being credited to Ida if the second
      statement fails. By using a transaction, the table is left unchanged if
      statement failure occurs.</p><p>The sample programs for each language are located in the <em class="filename">transactions</em> directory of the <code>recipes</code> distribution. If you compare them,
      you’ll see that they all employ a similar framework for performing
      transactional processing:</p><ul><li><p>The transaction statements are grouped within a control
          structure, along with a commit operation.</p></li><li><p>If the status of the control structure indicates that it did
          not execute successfully to completion, the transaction is rolled
          back.</p></li></ul><p>That logic can be expressed as follows, where <code>block</code> represents the control structure used to
      group statements:</p><pre data-type="programlisting">block:
  statement 1
  statement 2
  ...
  statement <em><code>n</code></em>
  commit
if the block failed:
  roll back</pre><p>If the statements in the block succeed, you reach the end of the
      block and perform a commit. Otherwise, occurrence of an error raises an
      exception that triggers execution of the error-handling code where you
      roll back the transaction.</p><p>The benefit of structuring your code as just described is that it
      minimizes the number of tests needed to determine whether to roll back.
      The alternative—checking the result of each statement within the
      transaction and rolling back on individual statement errors—quickly
      turns your code into an unreadable mess.</p><p>A subtle point to be aware of when rolling back within languages
      that raise exceptions is that it may be possible for the rollback itself
      to fail, causing another exception to be raised. If you don’t deal with
      that, your program itself may terminate. To handle this, execute the
      rollback within another block that has an empty exception handler. The
      sample programs do this as necessary.</p><p>Those sample programs that disable auto-commit mode explicitly
      when performing a transaction enable auto-commit afterward. In
      applications that perform all database processing in transactional
      fashion, it’s unnecessary to do this. Just disable auto-commit mode once
      after you connect to the database server, and leave it off.</p><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45820326962400"><h5>Checking How API Transaction Abstractions Map onto SQL
        Statements</h5><p>For APIs that provide a transaction abstraction, you can see how the interface
        maps onto the underlying SQL statements: enable the general query log
        for your MySQL server, then watch the log to see what statements the
        API executes when you run a transactional program. For instructions on
        enabling the log, see <a data-type="xref" href="ch22.xhtml#nch-admin-server-logs">Recipe 22.3</a>.</p></div></aside></div></section></div></section><section data-type="sect1" data-pdf-bookmark="20.4 Performing Transactions in Perl Programs"><div class="sect1" id="nch-xact-xact-perl"><h1>20.4 Performing Transactions in Perl Programs</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820326959792"><h2>Problem</h2><p>You want to perform a transaction in a Perl DBI script.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820326958912"><h2>Solution</h2><p>Use the standard DBI transaction support mechanism.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820326958032"><h2>Discussion</h2><p>The Perl DBI transaction mechanism is based on explicit
      manipulation of auto-commit mode:</p><ol><li><p>Turn on the <code>RaiseError</code>
          attribute if it’s not enabled and disable <code>PrintError</code> if it’s on. You want errors to raise exceptions without printing
          anything, and leaving <code>PrintError</code>
          enabled can interfere with failure detection in some cases.</p></li><li><p>Disable the <code>AutoCommit</code>
          attribute so that a commit will be done only when you say
          so.</p></li><li><p>Execute the statements that make up the transaction within an
          <code>eval</code> block so that errors raise
          an exception and terminate the block. The last thing in the block
          should be a call to <code>commit()</code>,
          which commits the transaction if all its statements completed
          successfully.</p></li><li><p>After the <code>eval</code> executes,
          check the <code>$@</code> variable. If
          <code>$@</code> contains the empty string, the
          transaction succeeded. Otherwise, the <code>eval</code> will have failed due to the
          occurrence of some error and <code>$@</code>
          will contain an error message. Invoke <code>rollback()</code>
          to cancel the transaction. To display an error message, print
          <code>$@</code> before calling <code>rollback()</code>.</p></li><li><p>If desired, restore the original values of the <code>RaiseError</code> and <code>PrintError</code> attributes.</p></li></ol><p>Because it can be messy to change and restore the error-handling
      and auto-commit attributes if an application performs multiple
      transactions, let’s put the code to begin and end a transaction into
      convenience functions that handle the processing that occurs before and
      after the <code>eval</code>:</p><pre data-type="programlisting" data-code-language="perl"><code class="k">sub</code> <code class="nf">transaction_init</code>
<code class="p">{</code>
<code class="k">my</code> <code class="nv">$dbh</code> <code class="o">=</code> <code class="nb">shift</code><code class="p">;</code>
<code class="k">my</code> <code class="nv">$attr_ref</code> <code class="o">=</code> <code class="p">{};</code>  <code class="c1"># create hash in which to save attributes</code>

  <code class="nv">$attr_ref</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">RaiseError</code><code class="p">}</code> <code class="o">=</code> <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">RaiseError</code><code class="p">};</code>
  <code class="nv">$attr_ref</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">PrintError</code><code class="p">}</code> <code class="o">=</code> <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">PrintError</code><code class="p">};</code>
  <code class="nv">$attr_ref</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">AutoCommit</code><code class="p">}</code> <code class="o">=</code> <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">AutoCommit</code><code class="p">};</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">RaiseError</code><code class="p">}</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code> <code class="c1"># raise exception if an error occurs</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">PrintError</code><code class="p">}</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="c1"># don't print an error message</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">AutoCommit</code><code class="p">}</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="c1"># disable auto-commit</code>
  <code class="k">return</code> <code class="nv">$attr_ref</code><code class="p">;</code>       <code class="c1"># return attributes to caller</code>
<code class="p">}</code>

<code class="k">sub</code> <code class="nf">transaction_finish</code>
<code class="p">{</code>
<code class="k">my</code> <code class="p">(</code><code class="nv">$dbh</code><code class="p">,</code> <code class="nv">$attr_ref</code><code class="p">,</code> <code class="nv">$error</code><code class="p">)</code> <code class="o">=</code> <code class="nv">@_</code><code class="p">;</code>

  <code class="k">if</code> <code class="p">(</code><code class="nv">$error</code><code class="p">)</code> <code class="c1"># an error occurred</code>
  <code class="p">{</code>
    <code class="k">print</code> <code class="s">"Transaction failed, rolling back. Error was:\n$error\n"</code><code class="p">;</code>
    <code class="c1"># roll back within eval to prevent rollback</code>
    <code class="c1"># failure from terminating the script</code>
    <code class="nb">eval</code> <code class="p">{</code> <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="n">rollback</code> <code class="p">();</code> <code class="p">};</code>
  <code class="p">}</code>
  <code class="c1"># restore error-handling and auto-commit attributes</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">AutoCommit</code><code class="p">}</code> <code class="o">=</code> <code class="nv">$attr_ref</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">AutoCommit</code><code class="p">};</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">PrintError</code><code class="p">}</code> <code class="o">=</code> <code class="nv">$attr_ref</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">PrintError</code><code class="p">};</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">RaiseError</code><code class="p">}</code> <code class="o">=</code> <code class="nv">$attr_ref</code><code class="o">-&gt;</code><code class="p">{</code><code class="n">RaiseError</code><code class="p">};</code>
<code class="p">}</code></pre><p>By using those two functions, our sample transaction can be
      performed easily as follows:</p><pre data-type="programlisting" data-code-language="perl"><code class="nv">$ref</code> <code class="o">=</code> <code class="n">transaction_init</code> <code class="p">(</code><code class="nv">$dbh</code><code class="p">);</code>
<code class="nb">eval</code>
<code class="p">{</code>
  <code class="c1"># move some money from one person to the other</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="k">do</code> <code class="p">(</code><code class="s">"UPDATE money SET amt = amt - 6 WHERE name = 'Eve'"</code><code class="p">);</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="k">do</code> <code class="p">(</code><code class="s">"UPDATE money SET amt = amt + 6 WHERE name = 'Ida'"</code><code class="p">);</code>
  <code class="c1"># all statements succeeded; commit transaction</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="n">commit</code> <code class="p">();</code>
<code class="p">};</code>
<code class="n">transaction_finish</code> <code class="p">(</code><code class="nv">$dbh</code><code class="p">,</code> <code class="nv">$ref</code><code class="p">,</code> <code class="vg">$@</code><code class="p">);</code></pre><p>In Perl DBI, an alternative to manipulating the <code>AutoCommit</code> attribute manually is to begin a
      transaction by invoking <code>begin_work()</code>.
      This method disables <code>AutoCommit</code> and
      causes it to be enabled again automatically when you invoke <code>commit()</code> or
      <code>rollback()</code> later.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="20.5 Performing Transactions in Ruby Programs"><div class="sect1" id="nch-xact-xact-ruby"><h1>20.5 Performing Transactions in Ruby Programs</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820326710096"><h2>Problem</h2><p>You want to perform a transaction in a Ruby Mysql2 script.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820326709120"><h2>Solution</h2><p>Send transaction management statements, such as <code>START TRANSACTIONS</code>, <code>BEGIN</code>, <code>COMMIT</code>, and <code>ROLLBACK</code> as regular queries.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820326706416"><h2>Discussion</h2><p>
        The Ruby Mysql2 module does not have built-in functions for the transaction support. Instead, it expects its users to run transaction management statements as regular queries.
      </p><p>
        To start transaction, execute <code>client.query("START TRANSACTION")</code>, then execute required updates, and finish the block with <code>client.query("COMMIT")</code>.
      </p><p>
        Put your transaction into a <code>begin ... rescue</code> block, so you can call <code>ROLLBACK</code> if something goes wrong.
      </p><pre data-type="programlisting" data-code-language="ruby"><code class="k">begin</code>
  <code class="n">client</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="s2">"START TRANSACTION"</code><code class="p">)</code>
  <code class="n">client</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="s2">"UPDATE money SET amt = amt - 6 WHERE name = 'Eve'"</code><code class="p">)</code>
  <code class="n">client</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="s2">"UPDATE money SET amt = amt + 6 WHERE name = 'Ida'"</code><code class="p">)</code>
  <code class="n">client</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="s2">"COMMIT"</code><code class="p">)</code>
<code class="k">rescue</code> <code class="no">Mysql2</code><code class="o">::</code><code class="no">Error</code> <code class="o">=&gt;</code> <code class="n">e</code>
  <code class="nb">puts</code> <code class="s2">"Transaction failed, rolling back. Error was:"</code>
  <code class="nb">puts</code> <code class="s2">"</code><code class="si">#{</code><code class="n">e</code><code class="o">.</code><code class="n">errno</code><code class="si">}</code><code class="s2">: </code><code class="si">#{</code><code class="n">e</code><code class="o">.</code><code class="n">message</code><code class="si">}</code><code class="s2">"</code>
  <code class="k">begin</code>           <code class="c1"># empty exception handler in case rollback fails</code>
    <code class="n">client</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="s2">"ROLLBACK"</code><code class="p">)</code>
  <code class="k">rescue</code>
  <code class="k">end</code>
<code class="k">end</code></pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="20.6 Performing Transactions in PHP Programs"><div class="sect1" id="nch-xact-xact-php"><h1>20.6 Performing Transactions in PHP Programs</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820326591280"><h2>Problem</h2><p>You want to perform a transaction in a PHP script.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820326590400"><h2>Solution</h2><p>Use the standard PDO transaction support mechanism.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820326589456"><h2>Discussion</h2><p>The PDO extension supports a transaction abstraction that can be
      used to perform transactions. To begin a transaction, use the <code>beginTransaction()</code> method. Then, after
      executing your statements, invoke either <code>commit()</code> or
      <code>rollback()</code> to commit or roll back the
      transaction. The following code illustrates this. It uses exceptions to
      detect transaction failure, so it assumes that exceptions are enabled
      for PDO errors:</p><pre data-type="programlisting" data-code-language="php"><code class="k">try</code>
<code class="p">{</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="na">beginTransaction</code> <code class="p">();</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="na">exec</code> <code class="p">(</code><code class="s2">"UPDATE money SET amt = amt - 6 WHERE name = 'Eve'"</code><code class="p">);</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="na">exec</code> <code class="p">(</code><code class="s2">"UPDATE money SET amt = amt + 6 WHERE name = 'Ida'"</code><code class="p">);</code>
  <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="na">commit</code> <code class="p">();</code>
<code class="p">}</code>
<code class="k">catch</code> <code class="p">(</code><code class="nx">Exception</code> <code class="nv">$e</code><code class="p">)</code>
<code class="p">{</code>
  <code class="k">print</code> <code class="p">(</code><code class="s2">"Transaction failed, rolling back. Error was:</code><code class="se">\n</code><code class="s2">"</code><code class="p">);</code>
  <code class="k">print</code> <code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code> <code class="p">()</code> <code class="o">.</code> <code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">);</code>
  <code class="c1"># empty exception handler in case rollback fails</code>
  <code class="k">try</code>
  <code class="p">{</code>
    <code class="nv">$dbh</code><code class="o">-&gt;</code><code class="na">rollback</code> <code class="p">();</code>
  <code class="p">}</code>
  <code class="k">catch</code> <code class="p">(</code><code class="nx">Exception</code> <code class="nv">$e2</code><code class="p">)</code> <code class="p">{</code> <code class="p">}</code>
<code class="p">}</code></pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="20.7 Performing Transactions in Python Programs"><div class="sect1" id="nch-xact-xact-python"><h1>20.7 Performing Transactions in Python Programs</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820326653728"><h2>Problem</h2><p>You want to perform a transaction in a Python DB API script.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820326529888"><h2>Solution</h2><p>Use the standard DB API transaction support mechanism.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820326529008"><h2>Discussion</h2><p>The Python DB API abstraction provides transaction processing
      control through connection object methods. The DB API specification
      indicates that database connections should begin with auto-commit mode
      disabled. Therefore, when you open a connection to the database server,
      Connector/Python disables auto-commit mode, which implicitly begins a
      transaction. End each transaction with either <code>commit()</code> or
      <code>rollback()</code>. The <code>commit()</code> call occurs within a <code>try</code> statement, and the <code>rollback()</code> occurs within the <code>except</code> clause to cancel the transaction if an
      error occurs:</p><pre data-type="programlisting" data-code-language="python"><code class="k">try</code><code class="p">:</code>
  <code class="n">cursor</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="n">cursor</code><code class="p">()</code>
  <code class="c1"># move some money from one person to the other</code>
  <code class="n">cursor</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s2">"UPDATE money SET amt = amt - 6 WHERE name = 'Eve'"</code><code class="p">)</code>
  <code class="n">cursor</code><code class="o">.</code><code class="n">execute</code><code class="p">(</code><code class="s2">"UPDATE money SET amt = amt + 6 WHERE name = 'Ida'"</code><code class="p">)</code>
  <code class="n">cursor</code><code class="o">.</code><code class="n">close</code><code class="p">()</code>
  <code class="n">conn</code><code class="o">.</code><code class="n">commit</code><code class="p">()</code>
<code class="k">except</code> <code class="n">mysql</code><code class="o">.</code><code class="n">connector</code><code class="o">.</code><code class="n">Error</code> <code class="k">as</code> <code class="n">e</code><code class="p">:</code>
  <code class="k">print</code><code class="p">(</code><code class="s2">"Transaction failed, rolling back. Error was:"</code><code class="p">)</code>
  <code class="k">print</code><code class="p">(</code><code class="n">e</code><code class="p">)</code>
  <code class="k">try</code><code class="p">:</code>  <code class="c1"># empty exception handler in case rollback fails</code>
    <code class="n">conn</code><code class="o">.</code><code class="n">rollback</code><code class="p">()</code>
  <code class="k">except</code><code class="p">:</code>
    <code class="k">pass</code></pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="20.8 Performing Transactions in Go Programs"><div class="sect1" id="nch-xact-xact-go"><h1>20.8 Performing Transactions in Go Programs</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820326389696"><h2>Problem</h2><p>
        You want to perform a transaction in a Go Program
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820326388816"><h2>Solution</h2><p>
        Use the standard transaction support mechanism, provided by the <code>database/sql</code> package.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820326387520"><h2>Discussion</h2><p>
          The Go <code>sql</code> interface supports a transaction abstraction that could be used to perform transactions. To begin a transaction, use the <code>DB.Begin()</code> function. Then, after executing your statements, invoke either <code>Tx.Commit()</code> or <code>Tx.Rollback()</code> to commit or rollback the transaction. The following code illustrates this.
        </p><pre data-type="programlisting" data-code-language="go"><code class="kd">var</code><code class="w"> </code><code class="nx">queries</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="p">[]</code><code class="kt">string</code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="s">"UPDATE money SET amt = amt - 6 WHERE name = 'Eve'"</code><code class="p">,</code><code class="w"/>
<code class="w">  </code><code class="s">"UPDATE money SET amt = amt + 6 WHERE name = 'Ida'"</code><code class="p">,</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="nx">tx</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">db</code><code class="p">.</code><code class="nx">Begin</code><code class="p">()</code><code class="w"/>
<code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">query</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">queries</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">tx</code><code class="p">.</code><code class="nx">Exec</code><code class="p">(</code><code class="nx">query</code><code class="p">)</code><code class="w"/>
<code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Transaction failed, rolling back.\nError was: %s\n"</code><code class="p">,</code><code class="w"/>
<code class="w">               </code><code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">())</code><code class="w"/>
<code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">txerr</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">tx</code><code class="p">.</code><code class="nx">Rollback</code><code class="p">();</code><code class="w"> </code><code class="nx">txerr</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">      </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Rollback failed"</code><code class="p">)</code><code class="w"/>
<code class="w">      </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">txerr</code><code class="p">)</code><code class="w"/>
<code class="w">    </code><code class="p">}</code><code class="w"/>
<code class="w">  </code><code class="p">}</code><code class="w"/>
<code class="p">}</code><code class="w"/>

<code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">tx</code><code class="p">.</code><code class="nx">Commit</code><code class="p">();</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w"/>
<code class="w">  </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w"/>
<code class="p">}</code><code class="w"/></pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="20.9 Using Context-Aware Functions to Handle Transactions in Go"><div class="sect1" id="nch-xact-xact-go-context"><h1>20.9 Using Context-Aware Functions to Handle Transactions in Go</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820326312304"><h2>Problem</h2><p>
    You want to rollback transactions automatically in your Go program.
  </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820326311424"><h2>Solution</h2><p>
            The Go-MySQL-Driver supports context cancellation. This means that you can cancel database operations, such as running a query, if cancel the context. 
          </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820326175360"><h2>Discussion</h2><p>
            To use the package <a href="https://pkg.go.dev/context">context</a> with SQL you need to create the object of type <code>Context</code> first, then pass it to the database function. Function names of the <code>sql</code> interface that support context are similar to ones that do not, but have prefix <code>Context</code>. For example, function <code>Query()</code> does not support <code>Context</code> while the function <code>QueryContext()</code> does.
          </p><p>
            The following example uses <code>Context</code> to handle database transactions. You will find code for it in the file <em class="filename">transaction_context.go</em> in the <em class="filename">transactions</em> directory of the <code>recipes</code> distribution.
          </p><p>
          </p><pre data-type="programlisting" data-code-language="go"><code class="c1">// transaction_context.go: simple transaction demonstration </code><code class="w">
</code><code class="c1">//                         with use of Context</code><code class="w">
</code><code class="w">
</code><code class="c1">// By default, this creates an InnoDB table.  If you specify a storage</code><code class="w">
</code><code class="c1">// engine on the command line, that will be used instead.  Normally,</code><code class="w">
</code><code class="c1">// this should be a transaction-safe engine that is supported by your</code><code class="w">
</code><code class="c1">// server.  However, you can pass a nontransactional storage engine</code><code class="w">
</code><code class="c1">// to verify that rollback doesn't work properly for such engines.</code><code class="w">
</code><code class="w">
</code><code class="c1">// The script uses a table named "money" and drops it if necessary.</code><code class="w">
</code><code class="c1">// Change the name if you have a valuable table with that name. :-)</code><code class="w">
</code><code class="kn">package</code><code class="w"> </code><code class="nx">main</code><code class="w">
</code><code class="w">
</code><code class="kn">import</code><code class="w"> </code><code class="p">(</code><code class="w">
</code><code class="w">  </code><code class="s">"log"</code><code class="w">
</code><code class="w">  </code><code class="s">"fmt"</code><code class="w">
</code><code class="w">  </code><code class="s">"flag"</code><code class="w">
</code><code class="w">  </code><code class="s">"context"</code><code class="w"> </code><a class="co" id="co_nch-xact-xact-go-context_import_co" href="#callout_nch-xact-xact-go-context_import_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="w">
  </code><code class="s">"database/sql"</code><code class="w">
</code><code class="w">  </code><code class="s">"github.com/svetasmirnova/mysqlcookbook/recipes/lib"</code><code class="w">
</code><code class="p">)</code><code class="w">
</code><code class="w">
</code><code class="kd">func</code><code class="w"> </code><code class="nx">initTable</code><code class="p">(</code><code class="nx">ctx</code><code class="w"> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code class="w"> </code><code class="nx">db</code><code class="w"> </code><code class="o">*</code><code class="nx">sql</code><code class="p">.</code><code class="nx">DB</code><code class="p">,</code><code class="w"> </code><code class="nx">tblEngine</code><code class="w"> </code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w"> </code><a class="co" id="co_nch-xact-xact-go-context_funcparam_co" href="#callout_nch-xact-xact-go-context_funcparam_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="w">
  </code><code class="nx">queries</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="p">[</code><code class="mi">4</code><code class="p">]</code><code class="kt">string</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="s">"DROP TABLE IF EXISTS money"</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="s">"CREATE TABLE money (name CHAR(5), amt INT, PRIMARY KEY(name)) ENGINE = "</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="nx">tblEngine</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="s">"INSERT INTO money (name, amt) VALUES('Eve', 10)"</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="s">"INSERT INTO money (name, amt) VALUES('Ida', 0)"</code><code class="p">,</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">query</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">queries</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">db</code><code class="p">.</code><code class="nx">ExecContext</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">query</code><code class="p">)</code><code class="w"> </code><a class="co" id="co_nch-xact-xact-go-context_exec_co" href="#callout_nch-xact-xact-go-context_exec_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code class="w">
    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">      </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Cannot initialize test table"</code><code class="p">)</code><code class="w">
</code><code class="w">      </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Error: %s\n"</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">      </code><code class="k">return</code><code class="w"> </code><code class="nx">err</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="w">
</code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="kd">func</code><code class="w"> </code><code class="nx">displayTable</code><code class="p">(</code><code class="nx">ctx</code><code class="w"> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code class="w"> </code><code class="nx">db</code><code class="w"> </code><code class="o">*</code><code class="nx">sql</code><code class="p">.</code><code class="nx">DB</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">  </code><code class="nx">rows</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">db</code><code class="p">.</code><code class="nx">QueryContext</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="s">"SELECT name, amt FROM money"</code><code class="p">)</code><code class="w"> </code><a class="co" id="co_nch-xact-xact-go-context_query_co" href="#callout_nch-xact-xact-go-context_query_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code class="w">
  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">err</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">  </code><code class="k">defer</code><code class="w"> </code><code class="nx">rows</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">for</code><code class="w"> </code><code class="nx">rows</code><code class="p">.</code><code class="nx">Next</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="kd">var</code><code class="w"> </code><code class="p">(</code><code class="w">
</code><code class="w">      </code><code class="nx">name</code><code class="w"> </code><code class="kt">string</code><code class="w">
</code><code class="w">      </code><code class="nx">amt</code><code class="w">  </code><code class="kt">int32</code><code class="w">
</code><code class="w">    </code><code class="p">)</code><code class="w">
</code><code class="w">    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">rows</code><code class="p">.</code><code class="nx">Scan</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">name</code><code class="p">,</code><code class="w"> </code><code class="o">&amp;</code><code class="nx">amt</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">      </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Cannot display contents of test table"</code><code class="p">)</code><code class="w">
</code><code class="w">      </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Error: %s\n"</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">      </code><code class="k">return</code><code class="w"> </code><code class="nx">err</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">    </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"%s has $%d\n"</code><code class="p">,</code><code class="w"> </code><code class="nx">name</code><code class="p">,</code><code class="w"> </code><code class="nx">amt</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="w">
</code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="kd">func</code><code class="w"> </code><code class="nx">runTransaction</code><code class="p">(</code><code class="nx">ctx</code><code class="w"> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Context</code><code class="p">,</code><code class="w"> 
                    </code><code class="nx">db</code><code class="w"> </code><code class="o">*</code><code class="nx">sql</code><code class="p">.</code><code class="nx">DB</code><code class="p">,</code><code class="w"> </code><code class="nx">queries</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">)</code><code class="w"> </code><code class="p">(</code><code class="kt">error</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">  </code><code class="nx">tx</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">db</code><code class="p">.</code><code class="nx">BeginTx</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="kc">nil</code><code class="p">)</code><code class="w"> </code><a class="co" id="co_nch-xact-xact-go-context_begin_co" href="#callout_nch-xact-xact-go-context_begin_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code class="w">
  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">err</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">for</code><code class="w"> </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">query</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="k">range</code><code class="w"> </code><code class="nx">queries</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">_</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">tx</code><code class="p">.</code><code class="nx">ExecContext</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">query</code><code class="p">)</code><code class="w"> </code><a class="co" id="co_nch-xact-xact-go-context_tx_co" href="#callout_nch-xact-xact-go-context_tx_co"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code class="w">
    </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">      </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Transaction failed, rolling back.\nError was: %s\n"</code><code class="p">,</code><code class="w">
</code><code class="w">                 </code><code class="nx">err</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w">
</code><code class="w">      </code><code class="k">if</code><code class="w"> </code><code class="nx">txerr</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">tx</code><code class="p">.</code><code class="nx">Rollback</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">        </code><code class="k">return</code><code class="w"> </code><code class="nx">txerr</code><code class="w">
</code><code class="w">      </code><code class="p">}</code><code class="w">
</code><code class="w">      </code><code class="k">return</code><code class="w"> </code><code class="nx">err</code><code class="w">
</code><code class="w">    </code><code class="p">}</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">tx</code><code class="p">.</code><code class="nx">Commit</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="k">return</code><code class="w"> </code><code class="nx">err</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">return</code><code class="w"> </code><code class="kc">nil</code><code class="w">
</code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="kd">func</code><code class="w"> </code><code class="nx">main</code><code class="p">(</code><code class="p">)</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">  </code><code class="nx">db</code><code class="p">,</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">cookbook</code><code class="p">.</code><code class="nx">Connect</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">  </code><code class="k">defer</code><code class="w"> </code><code class="nx">db</code><code class="p">.</code><code class="nx">Close</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="kd">var</code><code class="w"> </code><code class="nx">tblEngine</code><code class="w"> </code><code class="kt">string</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="s">"InnoDB"</code><code class="w">
</code><code class="w">  </code><code class="nx">flag</code><code class="p">.</code><code class="nx">Parse</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="nx">values</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">flag</code><code class="p">.</code><code class="nx">Args</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nb">len</code><code class="p">(</code><code class="nx">values</code><code class="p">)</code><code class="w"> </code><code class="p">&gt;</code><code class="w"> </code><code class="mi">0</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">tblEngine</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">values</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">  </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Printf</code><code class="p">(</code><code class="s">"Using storage engine %s to test transactions\n"</code><code class="p">,</code><code class="w"> </code><code class="nx">tblEngine</code><code class="p">)</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">cancel</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">context</code><code class="p">.</code><code class="nx">WithCancel</code><code class="p">(</code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code class="w"> </code><a class="co" id="co_nch-xact-xact-go-context_ctx_co" href="#callout_nch-xact-xact-go-context_ctx_co"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code class="w">
  </code><code class="k">defer</code><code class="w"> </code><code class="nx">cancel</code><code class="p">(</code><code class="p">)</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"----------"</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"This transaction should succeed."</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Table contents before transaction:"</code><code class="p">)</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">initTable</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">db</code><code class="p">,</code><code class="w"> </code><code class="nx">tblEngine</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">displayTable</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">db</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="kd">var</code><code class="w"> </code><code class="nx">trx</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="s">"UPDATE money SET amt = amt - 6 WHERE name = 'Eve'"</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="s">"UPDATE money SET amt = amt + 6 WHERE name = 'Ida'"</code><code class="p">,</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">runTransaction</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">db</code><code class="p">,</code><code class="w"> </code><code class="nx">trx</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Table contents after transaction:"</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">displayTable</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">db</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"----------"</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"This transaction should fail."</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Table contents before transaction:"</code><code class="p">)</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">:=</code><code class="w"> </code><code class="nx">initTable</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">db</code><code class="p">,</code><code class="w"> </code><code class="nx">tblEngine</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">displayTable</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">db</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="nx">trx</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="s">"UPDATE money SET amt = amt - 6 WHERE name = 'Eve'"</code><code class="p">,</code><code class="w">
</code><code class="w">    </code><code class="s">"UPDATE money SET xamt = amt + 6 WHERE name = 'Ida'"</code><code class="p">,</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">runTransaction</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">db</code><code class="p">,</code><code class="w"> </code><code class="nx">trx</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="w">
</code><code class="w">  </code><code class="nx">fmt</code><code class="p">.</code><code class="nx">Println</code><code class="p">(</code><code class="s">"Table contents after transaction:"</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="k">if</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="p">=</code><code class="w"> </code><code class="nx">displayTable</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code class="w"> </code><code class="nx">db</code><code class="p">)</code><code class="p">;</code><code class="w"> </code><code class="nx">err</code><code class="w"> </code><code class="o">!=</code><code class="w"> </code><code class="kc">nil</code><code class="w"> </code><code class="p">{</code><code class="w">
</code><code class="w">    </code><code class="nx">log</code><code class="p">.</code><code class="nx">Fatal</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="w">
</code><code class="w">  </code><code class="p">}</code><code class="w">
</code><code class="p">}</code></pre><p>

          </p><dl class="calloutlist"><dt><a class="co" id="callout_nch-xact-xact-go-context_import_co" href="#co_nch-xact-xact-go-context_import_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>Import statement for the context support.</p></dd><dt><a class="co" id="callout_nch-xact-xact-go-context_funcparam_co" href="#co_nch-xact-xact-go-context_funcparam_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>Our user-defined functions take <code>context.Context</code> as a parameter.</p></dd><dt><a class="co" id="callout_nch-xact-xact-go-context_exec_co" href="#co_nch-xact-xact-go-context_exec_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>To execute statements that do not return a result set, use a context-aware function <code>ExecContext()</code>.</p></dd><dt><a class="co" id="callout_nch-xact-xact-go-context_query_co" href="#co_nch-xact-xact-go-context_query_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt><dd><p>To execute queries that do return a result set, use a context-aware function <code>QueryContext()</code>.</p></dd><dt><a class="co" id="callout_nch-xact-xact-go-context_begin_co" href="#co_nch-xact-xact-go-context_begin_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt><dd><p>To start a transaction that will automatically rollback if context is cancelled, use a context-aware function <code>BeginTx()</code>.</p></dd><dt><a class="co" id="callout_nch-xact-xact-go-context_tx_co" href="#co_nch-xact-xact-go-context_tx_co"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt><dd><p>To execute a statement that could be cancelled inside the transaction, use context-aware function <code>Tx.ExecContext()</code>.</p></dd><dt><a class="co" id="callout_nch-xact-xact-go-context_ctx_co" href="#co_nch-xact-xact-go-context_ctx_co"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt><dd><p>Before using context, you need to create it. In our example we created a cancellable context. Function <code>context.WithCancel()</code> takes parent context as a parameter and returns just created new context, and a <code>cancel()</code> function. We deferred its call to the end of the <code>main()</code> function execution. You have options to call the <code>cancel()</code> function in whatever place of the code when appropriate. You may prefer to use <code>context.WithDeadline()</code> or <code>context.WithTimeout()</code>, so your SQL execution code will be cancelled if runs longer than certain time.</p></dd></dl><p>
          </p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="20.10 Performing Transactions in Java Programs"><div class="sect1" id="nch-xact-xact-java"><h1>20.10 Performing Transactions in Java Programs</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820325566272"><h2>Problem</h2><p>You want to perform a transaction in a JDBC application.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820325565296"><h2>Solution</h2><p>Use the standard JDBC transaction support mechanism.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820325564352"><h2>Discussion</h2><p>To perform transactions in Java, use your <code>Connection</code>
      object to turn off auto-commit mode. Then, after executing your
      statements, use the object’s <code>commit()</code>
      method to commit the transaction or <code>rollback()</code> to cancel it. Typically, you
      execute the statements for the transaction in a <code>try</code> block, with <code>commit()</code> at the end of the block. To handle
      failures, invoke <code>rollback()</code> in the
      corresponding exception handler:</p><pre data-type="programlisting" data-code-language="java"><code class="k">try</code>
<code class="o">{</code>
  <code class="n">conn</code><code class="o">.</code><code class="na">setAutoCommit</code> <code class="o">(</code><code class="kc">false</code><code class="o">);</code>
  <code class="n">Statement</code> <code class="n">s</code> <code class="o">=</code> <code class="n">conn</code><code class="o">.</code><code class="na">createStatement</code> <code class="o">();</code>
  <code class="c1">// move some money from one person to the other</code>
  <code class="n">s</code><code class="o">.</code><code class="na">executeUpdate</code> <code class="o">(</code><code class="s">"UPDATE money SET amt = amt - 6 WHERE name = 'Eve'"</code><code class="o">);</code>
  <code class="n">s</code><code class="o">.</code><code class="na">executeUpdate</code> <code class="o">(</code><code class="s">"UPDATE money SET amt = amt + 6 WHERE name = 'Ida'"</code><code class="o">);</code>
  <code class="n">s</code><code class="o">.</code><code class="na">close</code> <code class="o">();</code>
  <code class="n">conn</code><code class="o">.</code><code class="na">commit</code> <code class="o">();</code>
  <code class="n">conn</code><code class="o">.</code><code class="na">setAutoCommit</code> <code class="o">(</code><code class="kc">true</code><code class="o">);</code>
<code class="o">}</code>
<code class="k">catch</code> <code class="o">(</code><code class="n">SQLException</code> <code class="n">e</code><code class="o">)</code>
<code class="o">{</code>
  <code class="n">System</code><code class="o">.</code><code class="na">err</code><code class="o">.</code><code class="na">println</code> <code class="o">(</code><code class="s">"Transaction failed, rolling back. Error was:"</code><code class="o">);</code>
  <code class="n">Cookbook</code><code class="o">.</code><code class="na">printErrorMessage</code> <code class="o">(</code><code class="n">e</code><code class="o">);</code>
  <code class="c1">// empty exception handler in case rollback fails</code>
  <code class="k">try</code>
  <code class="o">{</code>
    <code class="n">conn</code><code class="o">.</code><code class="na">rollback</code> <code class="o">();</code>
    <code class="n">conn</code><code class="o">.</code><code class="na">setAutoCommit</code> <code class="o">(</code><code class="kc">true</code><code class="o">);</code>
  <code class="o">}</code>
  <code class="k">catch</code> <code class="o">(</code><code class="n">Exception</code> <code class="n">e2</code><code class="o">)</code> <code class="o">{</code> <code class="o">}</code>
<code class="o">}</code></pre></div></section></div></section></div></section></div></body></html>