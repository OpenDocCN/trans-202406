<html><head></head><body><section data-pdf-bookmark="Chapter 12. React and the Server" data-type="chapter" epub:type="chapter"><div class="chapter" id="react-and-the-server">&#13;
<h1><span class="label">Chapter 12. </span>React and the Server</h1>&#13;
&#13;
&#13;
<p>So far, we’ve<a data-primary="server-side rendering" data-secondary="need for" data-type="indexterm" id="idm45901614508360"/> built small applications with React that run entirely in the browser. They’ve collected data in the browser and saved the data using browser storage. This makes sense because React is a view layer; it’s intended to render UI. However, most applications require at least the existence of some sort of a backend, and we will need to understand how to structure applications with a server in mind.</p>&#13;
&#13;
<p>Even if you have a client application that’s relying entirely on cloud services for the backend, you still need to get and send data to these services. There are specific places where these transactions should be made and libraries that can help you deal with the latency associated with HTTP requests.</p>&#13;
&#13;
<p>Additionally, React can be rendered <em>isomorphically</em>, which means that it can be in platforms other than the browser. This means we can render our UI on the server before it ever gets to the browser. Taking advantage of server rendering, we can improve the performance, portability, and security of our applications.</p>&#13;
&#13;
<p>We start this chapter with a look at the differences between isomorphism and universalism and how both concepts relate to React. Next, we’ll look at how to make an isomorphic application using universal JavaScript. Finally, we’ll improve the color organizer by adding a server and rendering the UI on the server first.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Isomorphic Versus Universal" data-type="sect1"><div class="sect1" id="isomorphic-vs-universal">&#13;
<h1>Isomorphic Versus Universal</h1>&#13;
&#13;
<p>The<a data-primary="server-side rendering" data-secondary="isomorphic versus universal rendering" data-type="indexterm" id="idm45901614502072"/><a data-primary="isomorphic applications" data-type="indexterm" id="idm45901614501096"/><a data-primary="universal code" data-type="indexterm" id="idm45901614500424"/> terms <em>isomorphic</em> and <em>universal</em> are often used to describe applications that work on both the client and the server. Although these terms are used interchangeably to describe the same application, there’s a subtle difference between them that’s worth investigating.  <em>Isomorphic</em> applications are applications that can be rendered on <span class="keep-together">multiple</span> platforms.  <em>Universal</em> code means that the exact same code can run in multiple environments.<sup><a data-type="noteref" href="ch12.html#idm45901614496952" id="idm45901614496952-marker">1</a></sup></p>&#13;
&#13;
<p>Node.js<a data-primary="Node.js" data-secondary="code reuse with" data-type="indexterm" id="idm45901614495416"/> will allow us to reuse the same code we’ve written in the browser in other applications such as servers, CLIs, and even native applications. Let’s take a look at some universal JavaScript:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">userDetails</code> <code class="o">=</code> <code class="nx">response</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">login</code> <code class="o">=</code> <code class="nx">response</code><code class="p">.</code><code class="nx">login</code><code class="p">;</code>&#13;
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">login</code><code class="p">);</code>&#13;
<code class="p">};</code></pre>&#13;
&#13;
<p>The <code>printNames</code> function is universal. The exact same code can be invoked in the browser or on a server. This means that if we constructed a server with Node.js, we could potentially reuse code between the two environments. Universal JavaScript is JavaScript that can run on the server or in the browser without error (see <a data-type="xref" href="#fig1201">Figure 12-1</a>).</p>&#13;
&#13;
<figure><div class="figure" id="fig1201">&#13;
<img alt="lrc2 1201" src="assets/lrc2_1201.png"/>&#13;
<h6><span class="label">Figure 12-1. </span>Client and server domains</h6>&#13;
</div></figure>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Client and Server Domains" data-type="sect2"><div class="sect2" id="client-and-server-domains">&#13;
<h2>Client and Server Domains</h2>&#13;
&#13;
<p>The server and the client are completely different domains, so all of our JavaScript code won’t automatically work between them. Let’s take a look at creating an AJAX request with the browser:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">fetch</code><code class="p">(</code><code class="s2">"https://api.github.com/users/moonhighway"</code><code class="p">)</code>&#13;
  <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">res</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>&#13;
  <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">);</code></pre>&#13;
&#13;
<p>Here, we’re making a fetch request to the GitHub API, converting the response to JSON, then calling a function on the JSON results to parse it.</p>&#13;
&#13;
<p>However, if we try to run the exact same code with Node.js, we get an error:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">fetch</code><code class="p">(</code><code class="s2">"https://api.github.com/users/moonhighway"</code><code class="p">)</code>&#13;
<code class="o">^</code>&#13;
&#13;
<code class="nx">ReferenceError</code><code class="o">:</code> <code class="nx">fetch</code> <code class="nx">is</code> <code class="nx">not</code> <code class="nx">defined</code>&#13;
<code class="nx">at</code> <code class="nb">Object</code><code class="p">.</code><code class="o">&lt;</code><code class="nx">anonymous</code><code class="o">&gt;</code> <code class="p">(</code><code class="err">/Users/eveporcello/Desktop/index.js:7:1)</code>&#13;
<code class="nx">at</code> <code class="nx">Module</code><code class="p">.</code><code class="err">\</code><code class="nx">_compile</code> <code class="p">(</code><code class="nx">internal</code><code class="o">/</code><code class="nx">modules</code><code class="o">/</code><code class="nx">cjs</code><code class="o">/</code><code class="nx">loader</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">1063</code><code class="o">:</code><code class="mi">30</code><code class="p">)</code>&#13;
<code class="nx">at</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">Module</code><code class="p">.</code><code class="err">\</code><code class="nx">_extensions</code><code class="p">..</code><code class="nx">js</code> <code class="p">(</code><code class="nx">internal</code><code class="o">/</code><code class="nx">modules</code><code class="o">/</code><code class="nx">cjs</code><code class="o">/</code><code class="nx">loader</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">1103</code><code class="o">:</code><code class="mi">10</code><code class="p">)</code>&#13;
<code class="nx">at</code> <code class="nx">Module</code><code class="p">.</code><code class="nx">load</code> <code class="p">(</code><code class="nx">internal</code><code class="o">/</code><code class="nx">modules</code><code class="o">/</code><code class="nx">cjs</code><code class="o">/</code><code class="nx">loader</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">914</code><code class="o">:</code><code class="mi">32</code><code class="p">)</code>&#13;
<code class="nx">at</code> <code class="nb">Function</code><code class="p">.</code><code class="nx">Module</code><code class="p">.</code><code class="err">\</code><code class="nx">_load</code> <code class="p">(</code><code class="nx">internal</code><code class="o">/</code><code class="nx">modules</code><code class="o">/</code><code class="nx">cjs</code><code class="o">/</code><code class="nx">loader</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">822</code><code class="o">:</code><code class="mi">14</code><code class="p">)</code>&#13;
<code class="nx">at</code> <code class="nb">Function</code><code class="p">.</code><code class="nx">Module</code><code class="p">.</code><code class="nx">runMain</code> <code class="p">(</code><code class="nx">internal</code><code class="o">/</code><code class="nx">modules</code><code class="o">/</code><code class="nx">cjs</code><code class="o">/</code><code class="nx">loader</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">1143</code><code class="o">:</code><code class="mi">12</code><code class="p">)</code>&#13;
<code class="nx">at</code> <code class="nx">internal</code><code class="o">/</code><code class="nx">main</code><code class="o">/</code><code class="nx">run_main_module</code><code class="p">.</code><code class="nx">js</code><code class="o">:</code><code class="mi">16</code><code class="o">:</code><code class="mi">11</code></pre>&#13;
&#13;
<p>This error occurs because Node.js does not have a built-in <code>fetch</code> function like the browser does. With Node.js, we can use <code>isomorphic-fetch</code> from npm, or use the built-in <code>https</code> module. Since we’ve already used the <code>fetch</code> syntax, let’s incorporate <code>isomorphic-fetch</code>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">npm</code> <code class="nx">install</code> <code class="nx">isomorphic</code><code class="o">-</code><code class="nx">fetch</code></pre>&#13;
&#13;
<p>Then we’ll just import <code>isomorphic-fetch</code> with no changes to the code:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">fetch</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s2">"isomorphic-fetch"</code><code class="p">);</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">userDetails</code> <code class="o">=</code> <code class="nx">response</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">login</code> <code class="o">=</code> <code class="nx">response</code><code class="p">.</code><code class="nx">login</code><code class="p">;</code>&#13;
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">login</code><code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="nx">fetch</code><code class="p">(</code><code class="s2">"https://api.github.com/users/moonhighway"</code><code class="p">)</code>&#13;
  <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">res</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">())</code>&#13;
  <code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">userDetails</code><code class="p">);</code></pre>&#13;
&#13;
<p>Loading data from an API with Node.js requires the use of core modules. It requires different code. In these samples, the <code>userDetails</code> function is universal, so the same function works in both environments.</p>&#13;
&#13;
<p>This JavaScript file is now isomorphic. It contains universal JavaScript. All of the code is not universal, but the file itself will work in both environments. It can run it with Node.js or include it in a <code>&lt;script&gt;</code> tag in the browser.</p>&#13;
&#13;
<p>Let’s take a look at the <code>Star</code> component. Is this component universal?</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">Star</code><code class="p">({</code>&#13;
  <code class="nx">selected</code> <code class="o">=</code> <code class="kc">false</code><code class="p">,</code>&#13;
  <code class="nx">onClick</code> <code class="o">=</code> <code class="nx">f</code> <code class="o">=&gt;</code> <code class="nx">f</code>&#13;
<code class="p">})</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code>&#13;
      <code class="nx">className</code><code class="o">=</code><code class="p">{</code>&#13;
        <code class="nx">selected</code> <code class="o">?</code> <code class="s2">"star selected"</code> <code class="o">:</code> <code class="s2">"star"</code>&#13;
      <code class="p">}</code>&#13;
      <code class="nx">onClick</code><code class="o">=</code><code class="p">{</code><code class="nx">onClick</code><code class="p">}</code>&#13;
    <code class="o">&gt;&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Sure it is; remember, the JSX compiles to JavaScript. The <code>Star</code> component is simply a function:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">Star</code><code class="p">({</code>&#13;
  <code class="nx">selected</code> <code class="o">=</code> <code class="kc">false</code><code class="p">,</code>&#13;
  <code class="nx">onClick</code> <code class="o">=</code> <code class="nx">f</code> <code class="o">=&gt;</code> <code class="nx">f</code>&#13;
<code class="p">})</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="nx">React</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s2">"div"</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">className</code><code class="o">:</code> <code class="nx">selected</code>&#13;
      <code class="o">?</code> <code class="s2">"star selected"</code>&#13;
      <code class="o">:</code> <code class="s2">"star"</code><code class="p">,</code>&#13;
    <code class="nx">onClick</code><code class="o">:</code> <code class="nx">onClick</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>We can render this component directly in the browser, or render it in a different environment and capture the HTML output as a string. <code>ReactDOM</code> has a <code>renderToString</code> method that we can use to render UI to an HTML string:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// Renders html directly in the browser</code>&#13;
<code class="nx">ReactDOM</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="o">&lt;</code><code class="nx">Star</code> <code class="o">/&gt;</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Renders html as a string</code>&#13;
<code class="kd">let</code> <code class="nx">html</code> <code class="o">=</code> <code class="nx">ReactDOM</code><code class="p">.</code><code class="nx">renderToString</code><code class="p">(</code><code class="o">&lt;</code><code class="nx">Star</code> <code class="o">/&gt;</code><code class="p">);</code></pre>&#13;
&#13;
<p>We can build isomorphic applications that render components on different platforms, and we can architect these applications in a way that reuses JavaScript code universally across multiple environments. Additionally, we can build isomorphic applications using other languages such as Go or Python—we’re not restricted to Node.js.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Server Rendering React" data-type="sect1"><div class="sect1" id="server-rendering-react">&#13;
<h1>Server Rendering React</h1>&#13;
&#13;
<p>Using<a data-primary="server-side rendering" data-secondary="with React" data-type="indexterm" id="SSRreact12"/><a data-primary="ReactDOM.renderToString method" data-type="indexterm" id="idm45901613903896"/> the <code>ReactDOM.renderToString</code> method allows us to render UI on the server. Servers are powerful; they have access to all kinds of resources that browsers do not. Servers can be secure and access secure data. You can use all of these added benefits to your advantage by rendering initial content on the server.</p>&#13;
&#13;
<p>The app we’ll server render is our Recipes app that we built in <a data-type="xref" href="ch05.html#react-with-jsx">Chapter 5</a>. You can run Create React App and place this code over the contents of the <em>index.js</em> file:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">ReactDOM</code> <code class="nx">from</code> <code class="s2">"react-dom"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="s2">"./index.css"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">Menu</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"./Menu"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="p">[</code>&#13;
  <code class="p">{</code>&#13;
    <code class="nx">name</code><code class="o">:</code> <code class="s2">"Baked Salmon"</code><code class="p">,</code>&#13;
    <code class="nx">ingredients</code><code class="o">:</code> <code class="p">[</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s2">"Salmon"</code><code class="p">,</code>&#13;
        <code class="nx">amount</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>&#13;
        <code class="nx">measurement</code><code class="o">:</code> <code class="s2">"lb"</code>&#13;
      <code class="p">},</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s2">"Pine Nuts"</code><code class="p">,</code>&#13;
        <code class="nx">amount</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>&#13;
        <code class="nx">measurement</code><code class="o">:</code> <code class="s2">"cup"</code>&#13;
      <code class="p">},</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s2">"Butter Lettuce"</code><code class="p">,</code>&#13;
        <code class="nx">amount</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>&#13;
        <code class="nx">measurement</code><code class="o">:</code> <code class="s2">"cups"</code>&#13;
      <code class="p">},</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s2">"Yellow Squash"</code><code class="p">,</code>&#13;
        <code class="nx">amount</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>&#13;
        <code class="nx">measurement</code><code class="o">:</code> <code class="s2">"med"</code>&#13;
      <code class="p">},</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s2">"Olive Oil"</code><code class="p">,</code>&#13;
        <code class="nx">amount</code><code class="o">:</code> <code class="mf">0.5</code><code class="p">,</code>&#13;
        <code class="nx">measurement</code><code class="o">:</code> <code class="s2">"cup"</code>&#13;
      <code class="p">},</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s2">"Garlic"</code><code class="p">,</code>&#13;
        <code class="nx">amount</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code>&#13;
        <code class="nx">measurement</code><code class="o">:</code> <code class="s2">"cloves"</code>&#13;
      <code class="p">}</code>&#13;
    <code class="p">],</code>&#13;
    <code class="nx">steps</code><code class="o">:</code> <code class="p">[</code>&#13;
      <code class="s2">"Preheat the oven to 350 degrees."</code><code class="p">,</code>&#13;
      <code class="s2">"Spread the olive oil around a glass baking dish."</code><code class="p">,</code>&#13;
      <code class="s2">"Add the yellow squash and place in the oven for 30 mins."</code><code class="p">,</code>&#13;
      <code class="s2">"Add the salmon, garlic, and pine nuts to the dish."</code><code class="p">,</code>&#13;
      <code class="s2">"Bake for 15 minutes."</code><code class="p">,</code>&#13;
      <code class="s2">"Remove from oven. Add the lettuce and serve."</code>&#13;
    <code class="p">]</code>&#13;
  <code class="p">},</code>&#13;
  <code class="p">{</code>&#13;
    <code class="nx">name</code><code class="o">:</code> <code class="s2">"Fish Tacos"</code><code class="p">,</code>&#13;
    <code class="nx">ingredients</code><code class="o">:</code> <code class="p">[</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s2">"Whitefish"</code><code class="p">,</code>&#13;
        <code class="nx">amount</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>&#13;
        <code class="nx">measurement</code><code class="o">:</code> <code class="s2">"l lb"</code>&#13;
      <code class="p">},</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s2">"Cheese"</code><code class="p">,</code>&#13;
        <code class="nx">amount</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>&#13;
        <code class="nx">measurement</code><code class="o">:</code> <code class="s2">"cup"</code>&#13;
      <code class="p">},</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s2">"Iceberg Lettuce"</code><code class="p">,</code>&#13;
        <code class="nx">amount</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>&#13;
        <code class="nx">measurement</code><code class="o">:</code> <code class="s2">"cups"</code>&#13;
      <code class="p">},</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s2">"Tomatoes"</code><code class="p">,</code>&#13;
        <code class="nx">amount</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>&#13;
        <code class="nx">measurement</code><code class="o">:</code> <code class="s2">"large"</code>&#13;
      <code class="p">},</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s2">"Tortillas"</code><code class="p">,</code>&#13;
        <code class="nx">amount</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code>&#13;
        <code class="nx">measurement</code><code class="o">:</code> <code class="s2">"med"</code>&#13;
      <code class="p">}</code>&#13;
    <code class="p">],</code>&#13;
    <code class="nx">steps</code><code class="o">:</code> <code class="p">[</code>&#13;
      <code class="s2">"Cook the fish on the grill until hot."</code><code class="p">,</code>&#13;
      <code class="s2">"Place the fish on the 3 tortillas."</code><code class="p">,</code>&#13;
      <code class="s2">"Top them with lettuce, tomatoes, and cheese."</code>&#13;
    <code class="p">]</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">];</code>&#13;
&#13;
<code class="nx">ReactDOM</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code>&#13;
  <code class="o">&lt;</code><code class="nx">Menu</code>&#13;
    <code class="nx">recipes</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">}</code>&#13;
    <code class="nx">title</code><code class="o">=</code><code class="s2">"Delicious Recipes"</code>&#13;
  <code class="o">/&gt;</code><code class="p">,</code>&#13;
  <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s2">"root"</code><code class="p">)</code>&#13;
<code class="p">);</code></pre>&#13;
&#13;
<p>The components will live in a new file called <em>Menu.js</em>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">Recipe</code><code class="p">({</code> <code class="nx">name</code><code class="p">,</code> <code class="nx">ingredients</code><code class="p">,</code> <code class="nx">steps</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">section</code>&#13;
      <code class="nx">id</code><code class="o">=</code><code class="p">{</code><code class="nx">name</code><code class="p">.</code><code class="nx">toLowerCase</code><code class="p">().</code><code class="nx">replace</code><code class="p">(</code><code class="sr">/ /g</code><code class="p">,</code> <code class="s2">"-"</code><code class="p">)}</code>&#13;
    <code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">name</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/h1&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">ul</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"ingredients"</code><code class="o">&gt;</code>&#13;
        <code class="p">{</code><code class="nx">ingredients</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">ingredient</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
          <code class="o">&lt;</code><code class="nx">li</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">i</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">ingredient</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/li&gt;</code>&#13;
        <code class="p">))}</code>&#13;
      <code class="o">&lt;</code><code class="err">/ul&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">section</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"instructions"</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">h2</code><code class="o">&gt;</code><code class="nx">Cooking</code> <code class="nx">Instructions</code><code class="o">&lt;</code><code class="err">/h2&gt;</code>&#13;
        <code class="p">{</code><code class="nx">steps</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">step</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
          <code class="o">&lt;</code><code class="nx">p</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">i</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">step</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;</code>&#13;
        <code class="p">))}</code>&#13;
      <code class="o">&lt;</code><code class="err">/section&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/section&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="kr">export</code> <code class="kd">function</code> <code class="nx">Menu</code><code class="p">({</code> <code class="nx">title</code><code class="p">,</code> <code class="nx">recipes</code> <code class="p">})</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">article</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">header</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/h1&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/header&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"recipes"</code><code class="o">&gt;</code>&#13;
        <code class="p">{</code><code class="nx">recipes</code><code class="p">.</code><code class="nx">map</code><code class="p">((</code><code class="nx">recipe</code><code class="p">,</code> <code class="nx">i</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
          <code class="o">&lt;</code><code class="nx">Recipe</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">i</code><code class="p">}</code> <code class="p">{...</code><code class="nx">recipe</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
        <code class="p">))}</code>&#13;
      <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/article&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Throughout the book, we’ve rendered components on the client. Client-side rendering is typically the first approach we’ll use when building an app. We serve up the Create React App <em>build</em> folder, and the browser runs the HTML and makes calls to the <em>script.js</em> file to load any JavaScript.</p>&#13;
&#13;
<p>Doing this can be time consuming. The user might have to wait to see anything load for a few seconds depending on their network speed. Using Create React App with an Express server, we can create a hybrid experience of client- and server-side rendering.</p>&#13;
&#13;
<p>We’re rendering a <code>Menu</code> component that renders several recipes. The first change we’ll make to this app is to use <code>ReactDOM.hydrate</code> instead of <code>ReactDOM.render</code>.</p>&#13;
&#13;
<p>These two functions are the same except <code>hydrate</code> is used to add content to a container that was rendered by <code>ReactDOMServer</code>. The order of operations will look like this:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Render a static version of the app, allowing users to see that something has happened and the page has “loaded.”</p>&#13;
</li>&#13;
<li>&#13;
<p>Make the request for the dynamic JavaScript.</p>&#13;
</li>&#13;
<li>&#13;
<p>Replace the static content with the dynamic content.</p>&#13;
</li>&#13;
<li>&#13;
<p>User clicks on something and it works.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>We’re rehydrating the app after a server-side render. By rehydrate, we mean statically loading the content as static HTML and then loading the JavaScript. This allows users to experience perceived performance. They’ll see that something is happening on the page, and that makes them want to stay on the page.</p>&#13;
&#13;
<p>Next, we need to set up our project’s server, and we’ll use Express, a lightweight Node server. Install it first:</p>&#13;
&#13;
<pre data-type="programlisting">npm install express</pre>&#13;
&#13;
<p>Then we’ll create a server folder called <em>server</em> and create an <em>index.js</em> file inside of that. This file will build a server that will serve up the <em>build</em> folder but also preload some static HTML content:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">express</code> <code class="nx">from</code> <code class="s2">"express"</code><code class="p">;</code>&#13;
<code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>&#13;
&#13;
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="s2">"./build"</code><code class="p">));</code></pre>&#13;
&#13;
<p>This imports and statically serves the <em>build</em> folder. Next, we want to use <code>renderToString</code> from <code>ReactDOM</code> to render the app as a static HTML string:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">ReactDOMServer</code> <code class="nx">from</code> <code class="s2">"react-dom/server"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">Menu</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"../src/Menu.js"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">PORT</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">4000</code><code class="p">;</code>&#13;
&#13;
<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s2">"/*"</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">ReactDOMServer</code><code class="p">.</code><code class="nx">renderToString</code><code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">Menu</code> <code class="o">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">PORT</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code>&#13;
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code>&#13;
    <code class="sb">`Server is listening on port </code><code class="si">${</code><code class="nx">PORT</code><code class="si">}</code><code class="sb">`</code>&#13;
  <code class="p">)</code>&#13;
<code class="p">);</code></pre>&#13;
&#13;
<p>We’ll pass the <code>Menu</code> component to this function because that’s what we want to render statically. We then want to read the static <em>index.html</em> file from the built client app, inject the app’s content in the <code>div</code>, and send that as the response to the request:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s2">"/*"</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">ReactDOMServer</code><code class="p">.</code><code class="nx">renderToString</code><code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">Menu</code> <code class="o">/&gt;</code>&#13;
  <code class="p">);</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">indexFile</code> <code class="o">=</code> <code class="nx">path</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code>&#13;
    <code class="s2">"./build/index.html"</code>&#13;
  <code class="p">);</code>&#13;
&#13;
  <code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="nx">indexFile</code><code class="p">,</code> <code class="s2">"utf8"</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code>&#13;
      <code class="nx">data</code><code class="p">.</code><code class="nx">replace</code><code class="p">(</code>&#13;
        <code class="s1">'&lt;div id="root"&gt;&lt;/div&gt;'</code><code class="p">,</code>&#13;
        <code class="sb">`&lt;div id="root"&gt;</code><code class="si">${</code><code class="nx">app</code><code class="si">}</code><code class="sb">&lt;/div&gt;`</code>&#13;
      <code class="p">)</code>&#13;
    <code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>Once we’ve completed this, we’ll need to do some configuration with webpack and Babel. Remember, Create React App can take care of compiling and building out of the box, but we need to set up and enforce different rules with the server project.</p>&#13;
&#13;
<p>Start by installing a few dependencies (OK, a lot of dependencies):</p>&#13;
&#13;
<pre data-type="programlisting">npm install @babel/core @babel/preset-env babel-loader nodemon npm-run-all&#13;
webpack webpack-cli webpack-node-externals</pre>&#13;
&#13;
<p>With Babel installed, let’s create a <code>.babelrc</code> with some presets:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"presets"</code><code class="p">:</code> <code class="p">[</code><code class="s2">"@babel/preset-env"</code><code class="p">,</code> <code class="s2">"react-app"</code><code class="p">]</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>You’ll add <code>react-app</code> because the project uses Create React App, and it has already been installed.</p>&#13;
&#13;
<p>Next, add a webpack configuration file for the server called <em>webpack.server.js</em>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s2">"path"</code><code class="p">);</code>&#13;
<code class="kr">const</code> <code class="nx">nodeExternals</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s2">"webpack-node-externals"</code><code class="p">);</code>&#13;
&#13;
<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code>&#13;
  <code class="nx">entry</code><code class="o">:</code> <code class="s2">"./server/index.js"</code><code class="p">,</code>&#13;
  <code class="nx">target</code><code class="o">:</code> <code class="s2">"node"</code><code class="p">,</code>&#13;
  <code class="nx">externals</code><code class="o">:</code> <code class="p">[</code><code class="nx">nodeExternals</code><code class="p">()],</code>&#13;
  <code class="nx">output</code><code class="o">:</code> <code class="p">{</code>&#13;
    <code class="nx">path</code><code class="o">:</code> <code class="nx">path</code><code class="p">.</code><code class="nx">resolve</code><code class="p">(</code><code class="s2">"build-server"</code><code class="p">),</code>&#13;
    <code class="nx">filename</code><code class="o">:</code> <code class="s2">"index.js"</code>&#13;
  <code class="p">},</code>&#13;
  <code class="nx">module</code><code class="o">:</code> <code class="p">{</code>&#13;
    <code class="nx">rules</code><code class="o">:</code> <code class="p">[</code>&#13;
      <code class="p">{</code>&#13;
        <code class="nx">test</code><code class="o">:</code> <code class="sr">/\.js$/</code><code class="p">,</code>&#13;
        <code class="nx">use</code><code class="o">:</code> <code class="s2">"babel-loader"</code>&#13;
      <code class="p">}</code>&#13;
    <code class="p">]</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">};</code></pre>&#13;
&#13;
<p>The babel-loader will transform JavaScript files as expected, and <code>nodeExternals</code> will scan the <em>node_modules</em> folder for all <code>node_modules</code> names. Then, it will build an external function that tells webpack not to bundle those modules or any <span class="keep-together">submodules</span>.</p>&#13;
&#13;
<p>Also, you might run into a webpack error due to a version conflict between the version you’ve installed with Create React App and the version we just installed. To fix the conflict, just add a <em>.env</em> file to the root of the project and add:</p>&#13;
&#13;
<pre data-type="programlisting">SKIP_PREFLIGHT_CHECK=true</pre>&#13;
&#13;
<p>Finally, we can add a few extra npm scripts to run our dev commands:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"scripts"</code><code class="p">:</code> <code class="p">{</code>&#13;
    <code class="err">//...</code>&#13;
    <code class="nt">"dev:build-server"</code><code class="p">:</code> <code class="s2">"NODE_ENV=development webpack --config webpack.server.js</code>&#13;
<code class="s2">    --mode=development -w"</code><code class="p">,</code>&#13;
    <code class="nt">"dev:start"</code><code class="p">:</code> <code class="s2">"nodemon ./server-build/index.js"</code><code class="p">,</code>&#13;
    <code class="nt">"dev"</code><code class="p">:</code> <code class="s2">"npm-run-all --parallel build dev:*"</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
<ol>&#13;
<li>&#13;
<p><code>dev:build-server</code>: Passes <code>development</code> as an environment variable and runs <code>webpack</code> with the new server config.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>dev:start</code>: Runs the server file with <code>nodemon</code>, which will listen for any changes.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>dev</code>: Runs both processes in parallel.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Now when we run <code>npm run dev</code>, both of the processes will run. You should be able to see the app running on <code>localhost:4000</code>. When the app runs, the content will load in sequence, first as prerendered HTML and then with the JavaScript bundle.</p>&#13;
&#13;
<p>Using a technique like this can mean faster load times and will yield a boost in perceived performance. With users expecting page-load times of two seconds or less, any improved performance can mean the difference between users using your website or bouncing to a competitor.<a data-primary="" data-startref="SSRreact12" data-type="indexterm" id="idm45901612895240"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Server Rendering with Next.js" data-type="sect1"><div class="sect1" id="server-rendering-nextjs">&#13;
<h1>Server Rendering with Next.js</h1>&#13;
&#13;
<p>Another<a data-primary="server-side rendering" data-secondary="with Next.js" data-type="indexterm" id="SSRnext12"/><a data-primary="Next.js" data-type="indexterm" id="next12"/> powerful and widely used tool in the server rendering ecosystem is Next.js. Next is an open source technology that was released by Zeit to help engineers write server-rendered apps more easily. This includes features for intuitive routing, statically optimizing, automatic splitting, and more. In the next section, we’ll take a closer look at how to work with Next.js to enable server rendering in our app.</p>&#13;
&#13;
<p>To start, we’ll create a whole new project, running the following commands:</p>&#13;
&#13;
<pre data-type="programlisting">mkdir project-next&#13;
cd project-next&#13;
npm init -y&#13;
npm install --save react react-dom next&#13;
mkdir pages</pre>&#13;
&#13;
<p class="pagebreak-after">Then we’ll create some npm scripts to run common commands more easily:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="err">//...</code>&#13;
  <code class="nt">"scripts"</code><code class="p">:</code> <code class="p">{</code>&#13;
    <code class="nt">"dev"</code><code class="p">:</code> <code class="s2">"next"</code><code class="p">,</code>&#13;
    <code class="nt">"build"</code><code class="p">:</code> <code class="s2">"next build"</code><code class="p">,</code>&#13;
    <code class="nt">"start"</code><code class="p">:</code> <code class="s2">"next start"</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>In the <em>pages</em> folder, we’ll create an <em>index.js</em> file. We’ll write our component, but we won’t worry about importing React or ReactDOM. Instead, we’ll just write a <span class="keep-together">component</span>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">Index</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Hello</code> <code class="nx">everyone</code><code class="o">!&lt;</code><code class="err">/p&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Once we’ve created this, we can run <code>npm run dev</code> to see the page running on <code>localhost:3000</code>. It displays the expected component.</p>&#13;
&#13;
<p>You’ll also notice there’s a small lightning bolt icon in the lower righthand corner of the screen. Hovering over this will display a button that reads <code>Prerendered Page</code>. When you click on it, it will take you to documentation about the Static Optimization Indicator. This means that the page fits the criteria for automatic static optimization, meaning that it can be prerendered. There are no data requirements that block it. If a page is automatically statically optimized (a mouthful, but useful!), the page is faster to load because there’s no server-side effort needed. The page can be streamed from a CDN, yielding a super-fast user experience. You don’t have to do anything to pick up on this performance enhancement.</p>&#13;
&#13;
<p>What if the page does have data requirements? What if the page cannot be prerendered? To explore this, let’s make our app a bit more robust and build toward a component that fetches some remote data from an API. In a new file called <em>Pets.js</em>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">Pets</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="nx">Pets</code><code class="o">!&lt;</code><code class="err">/h1&gt;;</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>To start, we’ll render an <code>h1</code>. Now we can visit <code>localhost:3000/pets</code> to see that our page is now loaded on that route. That’s good, but we can improve this by adding links and a layout component that will display the correct content for each page. We’ll create a header that can be used on both pages and will display links:</p>&#13;
&#13;
<pre class="pagebreak-before" data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">Link</code> <code class="nx">from</code> <code class="s2">"next/link"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">Header</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">Link</code> <code class="nx">href</code><code class="o">=</code><code class="s2">"/"</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">a</code><code class="o">&gt;</code><code class="nx">Home</code><code class="o">&lt;</code><code class="err">/a&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/Link&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">Link</code> <code class="nx">href</code><code class="o">=</code><code class="s2">"/pets"</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">a</code><code class="o">&gt;</code><code class="nx">Pets</code><code class="o">&lt;</code><code class="err">/a&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/Link&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>Link</code> component is a wrapper around a couple of links. These look similar to the links we created with React Router. We can also add a style to each of the <code>&lt;a&gt;</code> tags:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">linkStyle</code> <code class="o">=</code> <code class="p">{</code>&#13;
  <code class="nx">marginRight</code><code class="o">:</code> <code class="mi">15</code><code class="p">,</code>&#13;
  <code class="nx">color</code><code class="o">:</code> <code class="s2">"salmon"</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">Header</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">Link</code> <code class="nx">href</code><code class="o">=</code><code class="s2">"/"</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">a</code> <code class="nx">style</code><code class="o">=</code><code class="p">{</code><code class="nx">linkStyle</code><code class="p">}</code><code class="o">&gt;</code><code class="nx">Home</code><code class="o">&lt;</code><code class="err">/a&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/Link&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">Link</code> <code class="nx">href</code><code class="o">=</code><code class="s2">"/pets"</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">a</code> <code class="nx">style</code><code class="o">=</code><code class="p">{</code><code class="nx">linkStyle</code><code class="p">}</code><code class="o">&gt;</code><code class="nx">Pets</code><code class="o">&lt;</code><code class="err">/a&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/Link&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Next, we’ll incorporate the <code>Header</code> component into a new file called <em>Layout.js</em>. This will dynamically display the component based on the correct route:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">Header</code> <code class="nx">from</code> <code class="s2">"./Header"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="kd">function</code> <code class="nx">Layout</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">Header</code> <code class="o">/&gt;</code>&#13;
      <code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">children</code><code class="p">}</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>Layout</code> component will take in props and display any additional content in the component underneath the <code>Header</code>. Then in each page, we can create content blocks that can be passed to the <code>Layout</code> component when rendered. For example, the <em>index.js</em> file would now look like this:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">Layout</code> <code class="nx">from</code> <code class="s2">"./Layout"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">Index</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">Layout</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="nx">Hello</code> <code class="nx">everyone</code><code class="o">!&lt;</code><code class="err">/h1&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/Layout&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>We’ll do the same in the <em>Pets.js</em> file:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">Layout</code> <code class="nx">from</code> <code class="s2">"./Layout"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">Pets</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">Layout</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="nx">Hey</code> <code class="nx">pets</code><code class="o">!&lt;</code><code class="err">/h1&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/Layout&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Now if we visit the homepage, we should see the header, then when we click the <code>Pets</code> link, we should see the Pets page.</p>&#13;
&#13;
<p>When we click on the lightning bolt button in the lower righthand corner, we’ll notice that these pages are still being prerendered. This is to be expected as we continue to render static content. Let’s use the Pets page to load some data and see how this changes.</p>&#13;
&#13;
<p>To start, we’ll install <code>isomorphic-unfetch</code> like we did earlier in the chapter:</p>&#13;
&#13;
<pre data-type="programlisting">npm install isomorphic-unfetch</pre>&#13;
&#13;
<p>We’ll use this to make a fetch call to the Pet Library API. Start by importing it in the <em>Pages.js</em> file:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">fetch</code> <code class="nx">from</code> <code class="s2">"isomorphic-unfetch"</code><code class="p">;</code></pre>&#13;
&#13;
<p>Then we’re going to add a function called <code>getInitialProps</code>. This will handle fetching and loading the data:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">Pets</code><code class="p">.</code><code class="nx">getInitialProps</code> <code class="o">=</code> <code class="nx">async</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">res</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code>&#13;
    <code class="sb">`http://pet-library.moonhighway.com/api/pets`</code>&#13;
  <code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="nx">data</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">();</code>&#13;
  <code class="k">return</code> <code class="p">{</code>&#13;
    <code class="nx">pets</code><code class="o">:</code> <code class="nx">data</code>&#13;
  <code class="p">};</code>&#13;
<code class="p">};</code></pre>&#13;
&#13;
<p>When we return the data as the value for <code>pets</code>, we then can map over the data in the component.</p>&#13;
&#13;
<p>Adjust the component to map over the <code>pets</code> property:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">Pets</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">Layout</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="nx">Pets</code><code class="o">!&lt;</code><code class="err">/h1&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">ul</code><code class="o">&gt;</code>&#13;
          <code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">pets</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">pet</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
            <code class="o">&lt;</code><code class="nx">li</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">pet</code><code class="p">.</code><code class="nx">id</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">pet</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/li&gt;</code>&#13;
          <code class="p">))}</code>&#13;
        <code class="o">&lt;</code><code class="err">/ul&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/Layout&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>If <code>getInitialProps</code> is present in the component, Next.js will render the page in response to each request. This means that the page will be server-side rendered instead of statically prerendered, so the data from the API will be current on each request.</p>&#13;
&#13;
<p>Once we’re satisfied with the state of the application, we can run a build with <code>npm run build</code>. Next.js is concerned with performance, so it will give us a full rundown of the number of kilobytes present for each file. This is a quick spot-check for unusually large files.</p>&#13;
&#13;
<p>Next to each file, we’ll see an icon for whether a site is server-rendered at runtime (λ), automatically rendered as HTML (○), or automatically generated as static HTML + JSON (●).</p>&#13;
&#13;
<p>Once you’ve built the app, you can deploy it. Next.js is an open source product of Zeit, a cloud-hosting provider, so the experience of deploying with Zeit is the most straightforward. However, you can use many different hosting providers to deploy your application.</p>&#13;
&#13;
<p>To recap, there are some important bits of terminology that are important to understand when setting out to build your own apps:</p>&#13;
<dl>&#13;
<dt>CSR (client-side rendering)</dt>&#13;
<dd>&#13;
<p>Rendering an app in a browser, generally using the DOM. This is what we do with an unmodified Create React App.</p>&#13;
</dd>&#13;
<dt>SSR (server-side rendering)</dt>&#13;
<dd>&#13;
<p>Rendering a client-side or universal app to HTML on the server.</p>&#13;
</dd>&#13;
<dt>Rehydration</dt>&#13;
<dd>&#13;
<p>Loading JavaScript views on the client to reuse the server-rendered HTML’s DOM tree and data.</p>&#13;
</dd>&#13;
<dt>Prerendering</dt>&#13;
<dd>&#13;
<p>Running a client-side application at build time and capturing initial state as static HTML.<a data-primary="" data-startref="next12" data-type="indexterm" id="idm45901612168712"/><a data-primary="" data-startref="SSRnext12" data-type="indexterm" id="idm45901612167736"/></p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Gatsby" data-type="sect1"><div class="sect1" id="gatsby">&#13;
<h1>Gatsby</h1>&#13;
&#13;
<p>Another<a data-primary="server-side rendering" data-secondary="with Gatsby" data-type="indexterm" id="idm45901612165368"/><a data-primary="Gatsby" data-type="indexterm" id="idm45901612164360"/> popular site generator that’s based on React is Gatsby. Gatsby is taking over the world as a straightforward way to create a content-driven website. It aims to offer smarter defaults to manage concerns like performance, accessibility, image handling, and more. And if you’re reading this book, it’s likely that you might work on a Gatsby project at some point!</p>&#13;
&#13;
<p>Gatsby is used for a range of projects, but it’s often used to build content-driven websites. In other words, if you have a blog or static content, Gatsby is a great choice, particularly now that you know React. Gatsby can also handle dynamic content like loading data from APIs, integration with frameworks, and more.</p>&#13;
&#13;
<p>In this section, we’ll start building a quick Gatsby site to demonstrate how it works. Essentially, we’ll build our small Next.js app as a Gatsby app:</p>&#13;
&#13;
<pre data-type="programlisting">npm install -g gatsby-cli&#13;
gatsby new pets</pre>&#13;
&#13;
<p>If you have yarn installed globally, the CLI will ask you whether to use yarn or npm. Either is fine. Then you’ll change directory into the <em>pets</em> folder:</p>&#13;
&#13;
<pre data-type="programlisting">cd pets</pre>&#13;
&#13;
<p>Now you can start the project with <code>gatsby develop</code>. When you visit <code>localhost:8000</code>, you’ll see your Gatsby starter site running. Now you can take a tour of the files.</p>&#13;
&#13;
<p>If you open up the project’s <em>src</em> folder, you’ll see three subfolders: <em>components</em>, <em>images</em>, and <em>pages</em>.</p>&#13;
&#13;
<p>Within the <em>pages</em> folder, you’ll find a <em>404.js</em> error page, an <em>index.js</em> page (the page that renders when you visit <code>localhost:8000</code>), and a <em>page-2.js</em> that renders the content of the second page.</p>&#13;
&#13;
<p>If you visit the <em>components</em> folder, this where the magic of Gatsby is located. Remember when we built the <code>Header</code> and <code>Layout</code> components with Next.js? Both of these components are already created as templates in the <em>components</em> folder.</p>&#13;
&#13;
<p>A few particularly interesting things to note:</p>&#13;
<dl>&#13;
<dt><em>layout.js</em></dt>&#13;
<dd>&#13;
<p>This contains the <code>Layout</code> component. It uses the <code>useStaticQuery</code> hook to query some data about the site using GraphQL.</p>&#13;
</dd>&#13;
<dt><em>seo.js</em></dt>&#13;
<dd>&#13;
<p>This component lets us access the page’s metadata for search engine optimization purposes.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>If you add additional pages to the <em>pages</em> folder, this will add additional pages to your site. Let’s try it and add a <em>page-3.js</em> file to the <em>pages</em> folder. Then we’ll add the following code to that file to stand up a quick page:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">Link</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"gatsby"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="nx">Layout</code> <code class="nx">from</code> <code class="s2">"../components/layout"</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">SEO</code> <code class="nx">from</code> <code class="s2">"../components/seo"</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">ThirdPage</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
  <code class="o">&lt;</code><code class="nx">Layout</code><code class="o">&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">SEO</code> <code class="nx">title</code><code class="o">=</code><code class="s2">"Page three"</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;</code><code class="nx">Hi</code> <code class="nx">from</code> <code class="nx">the</code> <code class="nx">third</code> <code class="nx">page</code><code class="o">&lt;</code><code class="err">/h1&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">Link</code> <code class="nx">to</code><code class="o">=</code><code class="s2">"/"</code><code class="o">&gt;</code><code class="nx">Go</code> <code class="nx">back</code> <code class="nx">to</code> <code class="nx">the</code> <code class="nx">homepage</code><code class="o">&lt;</code><code class="err">/Link&gt;</code>&#13;
  <code class="o">&lt;</code><code class="err">/Layout&gt;</code>&#13;
<code class="p">);</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">ThirdPage</code><code class="p">;</code></pre>&#13;
&#13;
<p>We’ll use the <code>Layout</code> component to wrap the content so that it’s displayed as <span class="keep-together"><code>children</code></span>. Not only does <code>Layout</code> display the dynamic content, but as soon as we create it, the page is autogenerated.</p>&#13;
&#13;
<p>That’s the tip of the iceberg with what you can do with Gatsby, but we’ll leave you with some information about some of its additional features:</p>&#13;
<dl>&#13;
<dt>Static content</dt>&#13;
<dd>&#13;
<p>You can build your site as static files, which can be deployed without a server.</p>&#13;
</dd>&#13;
<dt>CDN support</dt>&#13;
<dd>&#13;
<p>It’s possible to cache your site on CDNs all over the world to improve performance and availability.</p>&#13;
</dd>&#13;
<dt>Responsive and progressive images</dt>&#13;
<dd>&#13;
<p>Gatsby loads images as blurry placeholders, then fades in the full assets. This tactic, popularized by Medium, allows users to see something rendering before the full resource is available.</p>&#13;
</dd>&#13;
<dt>Prefetching of linked pages</dt>&#13;
<dd>&#13;
<p>All of the content needed to load the next page will load in the background before you click on the next link.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>All of these features and more are used to ensure a seamless user experience. Gatsby has made a lot of decisions for you. That could be good or bad, but these constraints aim to let you focus on your content.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="React in the Future" data-type="sect1"><div class="sect1" id="react-in-the-future">&#13;
<h1>React in the Future</h1>&#13;
&#13;
<p>While<a data-primary="React" data-secondary="future of" data-type="indexterm" id="idm45901612011768"/> Angular, Ember, and Vue continue to have substantial marketshare in the JavaScript ecosystem, it’s hard to argue with the fact that React is currently the most widely used and influential library for building JavaScript apps. In addition to the library itself, the wider JavaScript community, as evidenced particularly by Next.js and Gatsby, has embraced React as the tool of choice.</p>&#13;
&#13;
<p>So where do we go from here? We’d encourage you to use these skills to build your own projects. If you’re looking to build mobile applications, you can check out React Native. If you’re looking to declaratively fetch data, you can check out GraphQL. If you’re looking to build content-based websites, dig deeper into Next.js and Gatsby.</p>&#13;
&#13;
<p>There are a number of avenues you can travel down, but these skills you’ve picked up in React will serve you well as you set out to build your own applications. When you’re doing so, we hope that this book will serve as a reference and a foundation. Although React and its related libraries will almost certainly go through changes, these are stable tools that you can feel confident about using right away. Building apps with React and functional, declarative JavaScript is a lot of fun, and we can’t wait to see what you’ll build.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm45901614496952"><sup><a href="ch12.html#idm45901614496952-marker">1</a></sup> Gert Hengeveld, <a href="https://oreil.ly/i70W2">“Isomorphism vs Universal JavaScript”</a>, Medium.</p></div></div></section></body></html>