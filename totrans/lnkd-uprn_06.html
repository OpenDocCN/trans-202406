<html><head></head><body><section data-pdf-bookmark="Chapter 6. The Linkerd CLI" data-type="chapter" epub:type="chapter" class="preface"><div class="preface" id="LUAR_cli">
<h1 class="calibre7"><span class="calibre">Chapter 6. </span>The Linkerd CLI</h1>


<p class="author1">The Linkerd command line interface (CLI) is <a data-primary="Linkerd CLI" data-secondary="about" data-type="indexterm" id="id951" class="calibre4"/><a data-primary="control plane of Linkerd" data-secondary="CLI for working with" data-seealso="Linkerd CLI" data-type="indexterm" id="id952" class="calibre4"/>a useful tool for
interacting with the Linkerd control plane. The CLI can help you check on the
health of a Linkerd instance, view details about proxies and certificates,
troubleshoot aberrant behavior, and view policy. It is the recommended way to
directly interface with Linkerd. It handles all the major tasks you’ll need to
work with your Linkerd installs and provides important tools for validating
and examining Linkerd.</p>

<p class="author1">In this chapter, we’ll cover some of the most useful things the CLI can do
and illustrate how to take best advantage of it. <a data-primary="Linkerd CLI" data-secondary="documentation URL" data-type="indexterm" id="id953" class="calibre4"/><a data-primary="documentation for Linkerd online" data-secondary="CLI" data-type="indexterm" id="id954" class="calibre4"/><a data-primary="Linkerd" data-secondary="documentation URL" data-tertiary="CLI" data-type="indexterm" id="id955" class="calibre4"/><a data-primary="resources online" data-secondary="Linkerd documentation" data-tertiary="CLI" data-type="indexterm" id="id956" class="calibre4"/>The CLI is, of course,
constantly evolving as new Linkerd releases come out, so it’s always important
to keep an eye on the <a href="https://oreil.ly/0GjuM" class="calibre4">official
documentation</a>.</p>






<section data-pdf-bookmark="Installing the CLI" data-type="sect1" class="preface"><div class="preface" id="id137">
<h1 class="calibre8">Installing the CLI</h1>

<p class="author1">The CLI is versioned along with the rest of Linkerd, so when you install the CLI, you’ll start by choosing which release channel to use.</p>

<p class="author1">To install from the stable channel, you’ll refer to the vendor instructions (such as those for <a href="https://oreil.ly/6apOU" class="calibre4">Buoyant Enterprise for Linkerd</a>).</p>

<p class="author1">To install completely open source Linkerd from the edge channel, you’ll refer to the <a href="https://oreil.ly/A3Lyl" class="calibre4">Linkerd quickstart</a>. <a data-primary="Linkerd CLI" data-secondary="installing" data-type="indexterm" id="id957" class="calibre4"/><a data-primary="Linkerd CLI" data-secondary="installing" data-tertiary="Linkerd quickstart guide URL" data-type="indexterm" id="id958" class="calibre4"/><a data-primary="Linkerd" data-secondary="documentation URL" data-tertiary="quickstart guide" data-type="indexterm" id="id959" class="calibre4"/><a data-primary="documentation for Linkerd online" data-secondary="quickstart guide" data-type="indexterm" id="id960" class="calibre4"/><a data-primary="resources online" data-secondary="Linkerd documentation" data-tertiary="quickstart guide" data-type="indexterm" id="id961" class="calibre4"/>At the time of this writing, that boils 
<span class="calibre">down to:</span></p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>curl<code class="w"> </code>--proto<code class="w"> </code><code class="s">'=https'</code><code class="w"> </code>--tlsv1.2<code class="w"> </code>-sSfL<code class="w"> </code>https://run.linkerd.io/install-edge<code class="w"> </code><code class="p">|</code><code class="w"> </code>sh<code class="w"/></pre>

<p class="author1">In either case, once you install the CLI you’ll need to add it to your <code class="calibre9">PATH</code> in the
appropriate manner for your shell. For example, if you use <code class="calibre9">bash</code> you can
alter the <code class="calibre9">PATH</code> variable directly:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code><code class="nb">export</code><code class="w"> </code><code class="nv">PATH</code><code class="o">=</code><code class="nv">$HOME</code>/.linkerd2/bin:<code class="nv">$PATH</code><code class="w"/></pre>








<section data-pdf-bookmark="Updating the CLI" data-type="sect2" class="preface"><div class="preface" id="id205">
<h2 class="calibre27">Updating the CLI</h2>

<p class="author1">To update the CLI, just rerun<a data-primary="Linkerd CLI" data-secondary="installing" data-tertiary="updating" data-type="indexterm" id="id962" class="calibre4"/> the installation command. Over time, you’ll end
up with multiple versions stored locally, and you can choose among them.</p>
</div></section>








<section data-pdf-bookmark="Installing a Specific Version" data-type="sect2" class="preface"><div class="preface" id="id47">
<h2 class="calibre27">Installing a Specific Version</h2>

<p class="author1">Normally, the Linkerd CLI installer (for either channel) <a data-primary="Linkerd CLI" data-secondary="installing" data-tertiary="installing a specific version" data-type="indexterm" id="id963" class="calibre4"/>will install the most recent version of
the CLI. You can force it to install a specific version by setting the

<span class="calibre"><code class="calibre9">LINKERD2_VERSION</code></span> environment variable when you run the install script. For example, using the edge channel:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>curl<code class="w"> </code>--proto<code class="w"> </code><code class="s">'=https'</code><code class="w"> </code>--tlsv1.2<code class="w"> </code>-sSfL<code class="w"> </code>https://run.linkerd.io/install-edge<code class="w"> </code><code class="se">\</code>
<code class="w">    </code><code class="p">|</code><code class="w"> </code><code class="nv">LINKERD2_VERSION</code><code class="o">=</code><code class="s">"stable-2.13.12"</code><code class="w"> </code>sh<code class="w"/></pre>
<div data-type="note" epub:type="note" class="calibre16"><h1 class="calibre26">Set LINKERD2_VERSION for sh, Not curl</h1>
<p class="author1">Pay attention to where the<a data-primary="Linkerd CLI" data-secondary="installing" data-tertiary="LINKERD2_VERSION" data-type="indexterm" id="id964" class="calibre4"/><a data-primary="LINKERD2_VERSION environment variable" data-type="indexterm" id="id965" class="calibre4"/><a data-primary="environment variables" data-secondary="LINKERD2_VERSION" data-type="indexterm" id="id966" class="calibre4"/> <code class="calibre9">LINKERD2_VERSION</code> environment variable is set
in the preceding command: it needs to be set for the <code class="calibre9">sh</code> command executing the script that
<code class="calibre9">curl</code> has downloaded, not for the <code class="calibre9">curl</code> command itself. Setting the
environment variable for <code class="calibre9">curl</code> won’t do anything.</p>
</div>
</div></section>








<section data-pdf-bookmark="Alternate Ways to Install" data-type="sect2" class="preface"><div class="preface" id="id206">
<h2 class="calibre27">Alternate Ways to Install</h2>

<p class="author1">If you’re on a Mac, <a href="https://brew.sh" class="calibre4">Homebrew</a> is a<a data-primary="Linkerd CLI" data-secondary="installing" data-tertiary="alternative ways to install" data-type="indexterm" id="id967" class="calibre4"/> simple way to install the
CLI: just <code class="calibre9">brew install linkerd</code>. You can also download the CLI directly from
the <a href="https://oreil.ly/vcUOa" class="calibre4">Linkerd releases page</a>.</p>
</div></section>
</div></section>






<section data-pdf-bookmark="Using the CLI" data-type="sect1" class="preface"><div class="preface" id="id138">
<h1 class="calibre8">Using the CLI</h1>

<p class="author1">The CLI works broadly like any other Go CLI, such as <code class="calibre9">kubectl</code>:<a data-primary="Linkerd CLI" data-secondary="using the CLI" data-seealso="linkerd" data-type="indexterm" id="id968" class="calibre4"/><a data-primary="linkerd" data-secondary="using the CLI" data-type="indexterm" id="id969" class="calibre4"/></p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36"><code class="calibre9">$</code><code class="w"> </code><code class="calibre9">linkerd</code><code class="w"> </code><em class="calibre37"><code class="nb1">command</code></em><code class="w"> </code><em class="calibre37"><code class="o1">[</code><code class="calibre15">options</code><code class="o1">]</code></em></pre>

<p class="author1">The <code class="calibre9"><em class="calibre37">command</em></code> tells the CLI what exactly you want to do; the <code class="calibre9"><em class="calibre37">options</em></code> are
optional arguments to the specific command. <a data-primary="linkerd" data-secondary="--help for available commands" data-type="indexterm" id="id970" class="calibre4"/><a data-primary="Linkerd CLI" data-secondary="using the CLI" data-tertiary="--help for available commands" data-type="indexterm" id="id971" class="calibre4"/>You can always use the <code class="calibre9">--help</code>
option to get help. For instance, <code class="calibre9">linkerd --help</code> will tell you what
commands are available:</p>

<pre class="calibre36" data-code-language="bash" data-type="programlisting">$<code class="w"> </code>linkerd<code class="w"> </code>--help<code class="w"/></pre>

<pre class="wrap" data-type="programlisting">linkerd manages the Linkerd service mesh.

Usage:
  linkerd [command]

Available Commands:
  authz        List authorizations for a resource
  check        Check the Linkerd installation for potential problems
  completion   Output shell completion code for the specified shell (bash, zsh
               or fish)
  diagnostics  Commands used to diagnose Linkerd components
  help         Help about any command
  identity     Display the certificate(s) of one or more selected pod(s)
  inject       Add the Linkerd proxy to a Kubernetes config
  install      Output Kubernetes configs to install Linkerd
  install-cni  Output Kubernetes configs to install Linkerd CNI
  jaeger       jaeger manages the jaeger extension of Linkerd service mesh
  multicluster Manages the multicluster setup for Linkerd
  profile      Output service profile config for Kubernetes
  prune        Output extraneous Kubernetes resources in the linkerd control
               plane
  uninject     Remove the Linkerd proxy from a Kubernetes config
  uninstall    Output Kubernetes resources to uninstall Linkerd control plane
  upgrade      Output Kubernetes configs to upgrade an existing Linkerd control
               plane
  version      Print the client and server version information
  viz          viz manages the linkerd-viz extension of Linkerd service mesh

Flags:
      --api-addr string            Override kubeconfig and communicate directly
                                   with the control plane at host:port (mostly
                                   for testing)
      --as string                  Username to impersonate for Kubernetes
                                   operations
      --as-group stringArray       Group to impersonate for Kubernetes
                                   operations
      --cni-namespace string       Namespace in which the Linkerd CNI plugin is
                                   installed (default "linkerd-cni")
      --context string             Name of the kubeconfig context to use
  -h, --help                       help for linkerd
      --kubeconfig string          Path to the kubeconfig file to use for CLI
                                   requests
  -L, --linkerd-namespace string   Namespace in which Linkerd is installed
                                   ($LINKERD_NAMESPACE) (default "linkerd")
      --verbose                    Turn on debug logging

Use "linkerd [command] --help" for more information about a command.</pre>

<p class="author1">As this output shows, you can<a data-primary="linkerd" data-secondary="--help for available commands" data-tertiary="--help with specific commands" data-type="indexterm" id="id972" class="calibre4"/><a data-primary="linkerd" data-secondary="check command" data-tertiary="--help" data-type="indexterm" id="id973" class="calibre4"/><a data-primary="deploying Linkerd" data-secondary="linkerd check command" data-tertiary="--help" data-type="indexterm" id="id974" class="calibre4"/> also get help on specific commands. For
example, <code class="calibre9">linkerd check --help</code> will get help for the <code class="calibre9">check</code> command, as
shown here:</p>

<pre class="calibre36" data-code-language="bash" data-type="programlisting">$<code class="w"> </code>linkerd<code class="w"> </code>check<code class="w"> </code>--help<code class="w"/></pre>
<pre class="wrap" data-type="programlisting">Check the Linkerd installation for potential problems.

The check command will perform a series of checks to validate that the linkerd
CLI and control plane are configured correctly. If the command encounters a
failure it will print additional information about the failure and exit with a
non-zero exit code.

Usage:
  linkerd check [flags]

Examples:
  # Check that the Linkerd control plane is up and running
  linkerd check

  # Check that the Linkerd control plane can be installed in the "test"
  # namespace
  linkerd check --pre --linkerd-namespace test

  # Check that the Linkerd data plane proxies in the "app" namespace are up and
  # running
  linkerd check --proxy --namespace app

Flags:
      --cli-version-override string   Used to override the version of the cli
                                      (mostly for testing)
      --crds                          Only run checks which determine if the
                                      Linkerd CRDs have been installed
      --expected-version string       Overrides the version used when checking
                                      if Linkerd is running the latest version
                                      (mostly for testing)
  -h, --help                          help for check
      --linkerd-cni-enabled           When running pre-installation checks
                                      (--pre), assume the linkerd-cni plugin is
                                      already installed, and a NET_ADMIN check
                                      is not needed
  -n, --namespace string              Namespace to use for --proxy checks
                                      (default: all namespaces)
  -o, --output string                 Output format. One of: table, json, short
                                      (default "table")
      --pre                           Only run pre-installation checks, to
                                      determine if the control plane can be
                                      installed
      --proxy                         Only run data-plane checks, to determine
                                      if the data plane is healthy
      --wait duration                 Maximum allowed time for all tests to pass
                                      (default 5m0s)

<?pdf-nl ??>Global Flags:
      --api-addr string            Override kubeconfig and communicate directly
                                   with the control plane at host:port (mostly
                                   for testing)
      --as string                  Username to impersonate for Kubernetes
                                   operations
      --as-group stringArray       Group to impersonate for Kubernetes
                                   operations
      --cni-namespace string       Namespace in which the Linkerd CNI plugin is
                                   installed (default "linkerd-cni")
      --context string             Name of the kubeconfig context to use
      --kubeconfig string          Path to the kubeconfig file to use for CLI
                                   requests
  -L, --linkerd-namespace string   Namespace in which Linkerd is installed
                                   ($LINKERD_NAMESPACE) (default "linkerd")
      --verbose                    Turn on debug logging</pre>
</div></section>






<section data-pdf-bookmark="Selected Commands" data-type="sect1" class="preface"><div class="preface" id="id139">
<h1 class="calibre8">Selected Commands</h1>

<p class="author1">The <code class="calibre9">linkerd</code> CLI supports a lot of commands. <a data-primary="linkerd" data-secondary="documentation URL" data-type="indexterm" id="id975" class="calibre4"/><a data-primary="Linkerd CLI" data-secondary="documentation URL" data-type="indexterm" id="id976" class="calibre4"/><a data-primary="documentation for Linkerd online" data-secondary="CLI" data-type="indexterm" id="id977" class="calibre4"/><a data-primary="Linkerd" data-secondary="documentation URL" data-tertiary="CLI" data-type="indexterm" id="id978" class="calibre4"/><a data-primary="resources online" data-secondary="Linkerd documentation" data-tertiary="CLI" data-type="indexterm" id="id979" class="calibre4"/>The
<a href="https://oreil.ly/M3qdg" class="calibre4">official documentation</a>, as always, has
the full set; in this chapter, we’re going to summarize some of the most
broadly useful commands. These are the ones you should always have close to hand.</p>








<section data-pdf-bookmark="linkerd version" data-type="sect2" class="preface"><div class="preface" id="id140">
<h2 class="calibre27">linkerd version</h2>

<p class="author1">The first command to know<a data-primary="linkerd" data-secondary="version command" data-type="indexterm" id="id980" class="calibre4"/> about is <code class="calibre9">linkerd version</code>, which simply reports the
running version of the <code class="calibre9">linkerd</code> CLI and (if possible) of the Linkerd control plane:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>version<code class="w"/>
Client<code class="w"> </code>version:<code class="w"> </code>stable-2.14.6<code class="w"/>
Server<code class="w"> </code>version:<code class="w"> </code>stable-2.14.6<code class="w"/></pre>

<p class="author1">If you don’t have Linkerd running<a data-primary="linkerd" data-secondary="version command" data-tertiary="unavailable if not in cluster" data-type="indexterm" id="id981" class="calibre4"/> in your cluster, <code class="calibre9">linkerd version</code> will show
<code class="calibre9">unavailable</code> for the server version.</p>

<p class="author1">If <code class="calibre9">linkerd version</code> can’t talk to your cluster, it will treat that as an error. <a data-primary="linkerd" data-secondary="version command" data-tertiary="--client to avoid cluster" data-type="indexterm" id="id982" class="calibre4"/>You can use
the <code class="calibre9">--client</code> option to just check the version of the CLI itself, without even trying to talk to the cluster, though:</p>

<pre class="calibre36" data-code-language="bash" data-type="programlisting">$<code class="w"> </code>linkerd<code class="w"> </code>version<code class="w"> </code>--client<code class="w"/>
Client<code class="w"> </code>version:<code class="w"> </code>stable-2.14.6<code class="w"/></pre>
<div class="calibre16" data-type="note" epub:type="note"><h1 class="calibre26">CLI Versions Versus Control Plane Versions</h1>
<p class="author1">It’s very important to remember<a data-primary="linkerd" data-secondary="version command" data-tertiary="CLI versus control plane versions" data-type="indexterm" id="id983" class="calibre4"/><a data-primary="Linkerd CLI" data-secondary="version matching control plane version" data-type="indexterm" id="id984" class="calibre4"/><a data-primary="control plane of Linkerd" data-secondary="version matching CLI version" data-type="indexterm" id="id985" class="calibre4"/> that the CLI version is <em class="hyperlink">independent</em> of the
control plane version. Some CLI commands are quite complex and do a lot of
subtle manipulations, so it’s crucial to make sure that your CLI
version matches your control plane version. A difference of one major version
is OK, but more than one is not supported.</p>
</div>
</div></section>








<section data-pdf-bookmark="linkerd check" data-type="sect2" class="preface"><div class="preface" id="id48">
<h2 class="calibre27">linkerd check</h2>

<p class="author1">The <code class="calibre9">linkerd check</code> command gives<a data-primary="linkerd" data-secondary="check command" data-type="indexterm" id="ch06-chk" class="calibre4"/><a data-primary="deploying Linkerd" data-secondary="linkerd check command" data-type="indexterm" id="ch06-chk2" class="calibre4"/> an at-a-glance view of the health of Linkerd
in your cluster. It will test for many known failure conditions and allow you
to run extension-specific health checks. This deceptively simple command
actually offers a lot of powerful tools for validating and checking the
current state of your mesh.</p>

<p class="author1">The simplest—and most complete—way to use <code class="calibre9">linkerd check</code> is to run it
with no arguments:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>check<code class="w"/></pre>

<p class="author1">This will run a default set of checks that are both reasonably exhaustive and finish in a reasonable amount of time, including (in addition to quite a few other things):<a data-primary="linkerd" data-secondary="check command" data-tertiary="installation check" data-type="indexterm" id="id986" class="calibre4"/><a data-primary="deploying Linkerd" data-secondary="linkerd check command" data-tertiary="installation check" data-type="indexterm" id="id987" class="calibre4"/></p>

<ul class="printings">
<li class="calibre6">
<p class="author1">Making sure Linkerd is correctly installed in the default namespace</p>
</li>
<li class="calibre6">
<p class="author1">Checking that Linkerd’s certificates are valid</p>
</li>
<li class="calibre6">
<p class="author1">Running checks for all installed extensions</p>
</li>
<li class="calibre6">
<p class="author1">Double-checking necessary permissions</p>
</li>
</ul>

<p class="author1">Running this command will give you a lot of
insight into the current state of Linkerd in your cluster, and in fact if you<a data-primary="bug reports via linkerd check command" data-type="indexterm" id="id988" class="calibre4"/><a data-primary="debugging" data-secondary="bug reports via linkerd check command" data-type="indexterm" id="id989" class="calibre4"/><a data-primary="linkerd" data-secondary="check command" data-tertiary="bug reports against Linkerd" data-type="indexterm" id="id990" class="calibre4"/>
need to file a bug report against Linkerd, you will <em class="hyperlink">always</em> be asked to
include the output of <code class="calibre9">linkerd check</code>.</p>










<section data-pdf-bookmark="linkerd check --pre" data-type="sect3" class="preface"><div class="preface" id="id141">
<h3 class="calibre33">linkerd check --pre</h3>

<p class="author1">The precheck option runs<a data-primary="linkerd" data-secondary="check command" data-tertiary="--pre preinstall check" data-type="indexterm" id="id991" class="calibre4"/><a data-primary="deploying Linkerd" data-secondary="linkerd check command" data-tertiary="--pre for preinstall check" data-type="indexterm" id="id992" class="calibre4"/> a set of checks to make
sure that your Kubernetes environment is ready to have Linkerd installed:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>check<code class="w"> </code>--pre<code class="w"/></pre>

<p class="author1">This is the only use of <code class="calibre9">linkerd check</code> that does <em class="hyperlink">not</em> require Linkerd to already
be installed. The precheck makes sure both that your cluster meets the minimum technical
requirements to run Linkerd and that you have appropriate permissions to
perform a core Linkerd install. It is a useful part of preparing to install
Linkerd on a new cluster.</p>
<div data-type="warning" epub:type="warning" class="calibre18"><h1 class="calibre35">Precheck and the CNI Plugin</h1>
<p class="author1">If you plan on running Linkerd<a data-primary="deploying Linkerd" data-secondary="linkerd check command" data-tertiary="--pre and the CNI plugin" data-type="indexterm" id="id993" class="calibre4"/><a data-primary="Linkerd CNI (Container Network Interface) plugin" data-secondary="linkerd check --pre and" data-type="indexterm" id="id994" class="calibre4"/> with the CNI plugin installed, you’ll need to
run <code class="calibre9">linkerd check --pre --linkerd-cni-enabled</code> so that <code class="calibre9">linkerd check</code>
doesn’t try to check for the <code class="calibre9">NET_ADMIN</code> capability.</p>
</div>
</div></section>










<section data-pdf-bookmark="linkerd check --proxy" data-type="sect3" class="preface"><div class="preface" id="id207">
<h3 class="calibre33">linkerd check --proxy</h3>

<p class="author1">You can also tell <code class="calibre9">linkerd check</code> to specifically check the data plane:<a data-primary="linkerd" data-secondary="check command" data-tertiary="--proxy for data plane check" data-type="indexterm" id="id995" class="calibre4"/></p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>check<code class="w"> </code>--proxy<code class="w"/></pre>

<p class="author1">The proxy check runs many—though not all—of the checks performed by the
basic <code class="calibre9">linkerd check</code> command. However, it also runs extra checks specific to
the data plane, such as verifying that Linkerd proxies are running.</p>
</div></section>










<section data-pdf-bookmark="Linkerd extension checks" data-type="sect3" class="preface"><div class="preface" id="id142">
<h3 class="calibre33">Linkerd extension checks</h3>

<p class="author1">Each installed Linkerd extension<a data-primary="linkerd" data-secondary="check command" data-tertiary="Linkerd extension checks" data-type="indexterm" id="id996" class="calibre4"/><a data-primary="extensions" data-secondary="linkerd check command" data-type="indexterm" id="id997" class="calibre4"/><a data-primary="Linkerd Viz extension" data-secondary="linkerd check command" data-type="indexterm" id="id998" class="calibre4"/> has its own specific set of checks it will
run during <code class="calibre9">linkerd check</code>. If needed, you can also run <em class="hyperlink">only</em> the checks for
a specific extension with <code class="calibre9">linkerd <em class="calibre37">extension</em> check</code>. For example,
this is how you’d run only the checks for the Linkerd Viz extension:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>viz<code class="w"> </code>check<code class="w"/></pre>
<div data-type="note" epub:type="note" class="calibre16"><h1 class="calibre26">Why Limit Checks?</h1>
<p class="author1">Remember that <code class="calibre9">linkerd check</code> with no arguments will run the checks for all
installed extensions. Limiting checks to a single extension is primarily
helpful to reduce the amount of time that <code class="calibre9">linkerd check</code> takes to run.</p>
</div>
</div></section>










<section class="preface" data-pdf-bookmark="Additional options for linkerd check" data-type="sect3"><div class="preface" id="id49">
<h3 class="calibre33">Additional options for linkerd check</h3>

<p class="author1">The <code class="calibre9">linkerd check</code> command<a data-primary="linkerd" data-secondary="check command" data-tertiary="additional options" data-type="indexterm" id="id999" class="calibre4"/> obeys all the global CLI overrides, like
changing the namespace in which you have Linkerd installed (<code class="calibre9">--namespace</code>) or
modifying your <code class="calibre9">KUBECONFIG</code> (<code class="calibre9">--kubeconfig</code>) or Kubernetes context
(<code class="calibre9">--context</code>). Additionally:</p>

<ul class="printings">
<li class="calibre6">
<p class="author1"><code class="calibre9">--output</code> allows you to specify the output type, which is useful if you want to
override the default table output. Options include <code class="calibre9">json</code>, <code class="calibre9">basic</code>, <code class="calibre9">short</code>, and <code class="calibre9">table</code>.
Outputting JSON can be particularly helpful if you intend to consume the
check data programmatically.</p>
</li>
<li class="calibre6">
<p class="author1"><code class="calibre9">--wait</code> overrides the amount of time the checks will wait in the event
something isn’t right. The default value is 5 minutes, which can be unnecessarily long in many
cases.<a data-startref="ch06-chk" data-type="indexterm" id="id1000" class="calibre4"/><a data-startref="ch06-chk2" data-type="indexterm" id="id1001" class="calibre4"/></p>
</li>
</ul>
</div></section>
</div></section>








<section data-pdf-bookmark="linkerd inject" data-type="sect2" class="preface"><div class="preface" id="id143">
<h2 class="calibre27">linkerd inject</h2>

<p class="author1">The <code class="calibre9">linkerd inject</code> command<a data-primary="linkerd" data-secondary="inject command" data-type="indexterm" id="id1002" class="calibre4"/><a data-primary="Kubernetes API" data-secondary="Kubernetes resources" data-tertiary="linkerd inject command" data-type="indexterm" id="id1003" class="calibre4"/><a data-primary="APIs" data-secondary="Kubernetes API" data-tertiary="linkerd inject command" data-type="indexterm" id="id1004" class="calibre4"/> reads Kubernetes resources and outputs new
versions that have been modified to add the Linkerd proxy container as
appropriate. The <code class="calibre9">linkerd inject</code> command:</p>

<ul class="printings">
<li class="calibre6">
<p class="author1">Reads resources from its standard input, from local files, or from an
HTTPS URL</p>
</li>
<li class="calibre6">
<p class="author1">Can operate on multiple resources at once</p>
</li>
<li class="calibre6">
<p class="author1">Knows to modify only Pods and leave other kinds of resources alone</p>
</li>
<li class="calibre6">
<p class="author1">Allows you to configure the proxies as well</p>
</li>
<li class="calibre6">
<p class="author1">Outputs the modified resources on its standard output, leaving the task of actually
applying them to you</p>
</li>
</ul>

<p class="author1">That last point is worth repeating: <code class="calibre9">linkerd inject</code> will never modify any of
its sources directly. Instead, it outputs the modified Kubernetes resources
so that you can apply them yourself, include them in a Git repo, or do whatever
else is appropriate for your environment. This “output, don’t overwrite” idiom
is common across the entire <code class="calibre9">linkerd</code> CLI.</p>

<p class="author1">Using <code class="calibre9">linkerd inject</code> can be as simple as:</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>inject<code class="w"> </code>https://url.to/yml<code class="w"> </code><code class="p">|</code><code class="w"> </code>kubectl<code class="w"> </code>apply<code class="w"> </code>-f<code class="w"> </code>-<code class="w"/></pre>

<p class="author1">As always, you can find more examples and see the full docs by running <code class="calibre9">linkerd inject --help</code>.</p>
<div data-type="note" epub:type="note" class="calibre16"><h1 class="calibre26">You Must Handle Applying Injected Resources</h1>
<p class="author1">The most important thing to remember about <code class="calibre9">linkerd inject</code> is that it does
not, in and of itself, make any changes to your cluster. You’re always
responsible for applying the output of the <code class="calibre9">linkerd</code> CLI to your cluster
yourself, whether by simply feeding the output to <code class="calibre9">kubectl apply</code>,
committing it so that GitOps takes over, or something else.</p>
</div>










<section data-pdf-bookmark="Injecting in ingress mode" data-type="sect3" class="preface"><div class="preface" id="id208">
<h3 class="calibre33">Injecting in ingress mode</h3>

<p class="author1">The <code class="calibre9">--ingress</code> flag sets the <a data-primary="linkerd" data-secondary="inject command" data-tertiary="--ingress for ingress mode annotation" data-type="indexterm" id="id1005" class="calibre4"/><a data-primary="ingress and Linkerd" data-secondary="Ingress mode" data-tertiary="linkerd inject command" data-type="indexterm" id="id1006" class="calibre4"/>ingress mode annotation for a workload. Before setting this flag, or the corresponding annotation, on your ingress, please verify that it is required. You can see the <a href="https://oreil.ly/OgAej" class="calibre4">ingress docs</a> for more details on ingress mode.</p>
</div></section>










<section data-pdf-bookmark="Injecting manually" data-type="sect3" class="preface"><div class="preface" id="id209">
<h3 class="calibre33">Injecting manually</h3>

<p class="author1">By default, <code class="calibre9">linkerd inject</code> just adds<a data-primary="linkerd" data-secondary="inject command" data-tertiary="--manual for injecting manually" data-type="indexterm" id="id1007" class="calibre4"/> the <code class="calibre9">linkerd.io/inject</code> annotation to
your workload Pods, trusting the proxy injector to do the heavy
lifting. Setting the 
<span class="calibre"><code class="calibre9">--manual</code></span> flag instructs the CLI to add the sidecar
container directly to your manifest, bypassing the proxy injector.</p>

<p class="author1">The <code class="calibre9">--manual</code> flag provides a valuable tool for overriding or modifying the
proxy configuration in the event that you need to control something about the
proxy that the usual configuration mechanisms don’t support. Be careful
when tampering with the proxy configuration directly, though, as you can
quickly find yourself falling out of sync with your overall proxy
configuration.</p>
</div></section>










<section data-pdf-bookmark="Injecting the debug sidecar" data-type="sect3" class="preface"><div class="preface" id="id144">
<h3 class="calibre33">Injecting the debug sidecar</h3>

<p class="author1">Setting <code class="calibre9">--enable-debug-sidecar</code> will add<a data-primary="debugging" data-secondary="linkerd inject command debug sidecar" data-type="indexterm" id="id1008" class="calibre4"/><a data-primary="sidecar model" data-secondary="debug sidecar via linkerd inject" data-type="indexterm" id="id1009" class="calibre4"/> an annotation to your workload that
will cause the proxy injector to add an additional debug sidecar to your
Pods. <a data-primary="debugging" data-secondary="debug container documentation URL" data-type="indexterm" id="id1010" class="calibre4"/><a data-primary="Linkerd" data-secondary="documentation URL" data-tertiary="debug container" data-type="indexterm" id="id1011" class="calibre4"/><a data-primary="documentation for Linkerd online" data-secondary="debug container" data-type="indexterm" id="id1012" class="calibre4"/><a data-primary="resources online" data-secondary="Linkerd documentation" data-tertiary="debug container" data-type="indexterm" id="id1013" class="calibre4"/>Before trying to use the debug sidecar, you should definitely read
<a data-type="xref" href="ch15.html#LUAR_troubleshooting" class="calibre4">Chapter 15</a> and the
<a href="https://oreil.ly/CVc6-" class="calibre4">debug container
documentation</a>.</p>
</div></section>
</div></section>








<section class="preface" data-pdf-bookmark="linkerd identity" data-type="sect2"><div class="preface" id="id50">
<h2 class="calibre27">linkerd identity</h2>

<p class="author1">The <code class="calibre9">linkerd identity</code> command <a data-primary="linkerd" data-secondary="identity command" data-type="indexterm" id="ch06-id" class="calibre4"/><a data-primary="certificates" data-secondary="linkerd identity command for Pods" data-type="indexterm" id="id1014" class="calibre4"/><a data-primary="X.509 certificates" data-secondary="linkerd identity command for Pods" data-type="indexterm" id="id1015" class="calibre4"/><a data-primary="Pods" data-secondary="certificate troubleshooting via linkerd identity" data-type="indexterm" id="id1016" class="calibre4"/><a data-primary="debugging" data-secondary="certificate troubleshooting via linkerd identity" data-type="indexterm" id="id1017" class="calibre4"/>provides a useful tool for troubleshooting Pod
certificates. It allows you to see the certificate details of any Pod or Pods;
for example, here’s how you can get the identity of a Pod
belonging to the Linkerd destination controller:</p>

<pre class="calibre36" data-code-language="bash" data-type="programlisting">$<code class="w"> </code>linkerd<code class="w"> </code>identity<code class="w"> </code>-n<code class="w"> </code>linkerd<code class="w"> </code>linkerd-destination-7447d467f8-f4n9w<code class="w"/></pre>

<pre class="wrap" data-type="programlisting">POD linkerd-destination-7447d467f8-f4n9w (1 of 1)

Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 3 (0x3)
    Signature Algorithm: ECDSA-SHA256
        Issuer: CN=identity.linkerd.cluster.local
        Validity
            Not Before: Apr 5 13:51:13 2023 UTC
            Not After : Apr 6 13:51:53 2023 UTC
        Subject: CN=linkerd-destination.linkerd.serviceaccount.identity.linkerd.cluster.local
        Subject Public Key Info:
            Public Key Algorithm: ECDSA
                Public-Key: (256 bit)
                X:
                    98:41:63:15:e1:0e:99:81:3c:ee:18:a5:55:fe:a5:
                    40:bd:cf:a2:cd:c2:e8:30:09:8c:8a:c6:8a:20:e7:
                    3c:cf
                Y:
                    53:7e:3c:05:d4:86:de:f9:89:cb:73:e9:37:98:08:
                    8f:e5:ec:39:c3:6c:c7:42:47:f0:ea:0a:c7:66:fe:
                    8d:a5
                Curve: P-256
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment
            X509v3 Extended Key Usage:
                TLS Web Server Authentication, TLS Web Client Authentication
            X509v3 Authority Key Identifier:
                keyid:37:C0:12:A1:AC:2D:A9:36:2D:35:83:6B:5C:99:9A:A2:5E:9C:E5:C5
            X509v3 Subject Alternative Name:
                DNS:linkerd-destination.linkerd.serviceaccount.identity.linkerd.cluster.local

    Signature Algorithm: ECDSA-SHA256
         30:45:02:20:4a:fb:02:db:17:e7:df:64:a4:7b:d2:08:a2:2e:
         66:e5:a4:74:14:35:d5:1a:f7:fc:15:95:9b:73:60:dd:78:a4:
         02:21:00:8c:12:fb:bf:80:7a:c4:25:91:0c:ac:03:37:ca:e0:
         82:d5:9d:9b:54:f1:20:b0:f0:14:e0:ef:ae:a8:ba:70:00</pre>
<div data-type="note" epub:type="note" class="calibre16"><h1 class="calibre26">Your Pod Identities Will Be Different</h1>
<p class="author1">If you try this command, your Pod ID—and the specific certificate
information—will be different. However, none of the information provided by
<code class="calibre9">linkerd identity</code> is sensitive; it only shows public information. It’s always
safe to run.</p>
</div>

<p class="author1">You can use the output of this command to check the validity of a given Pod certificate. It also gives you the details of what authority signed the certificate, so you can check that it is signed by the correct intermediary and root CAs.<a data-startref="ch06-id" data-type="indexterm" id="id1018" class="calibre4"/></p>
</div></section>








<section data-pdf-bookmark="linkerd diagnostics" data-type="sect2" class="preface"><div class="preface" id="id145">
<h2 class="calibre27">linkerd diagnostics</h2>

<p class="author1">The <code class="calibre9">linkerd diagnostics</code> command<a data-primary="linkerd" data-secondary="diagnostics command" data-type="indexterm" id="ch06-diag" class="calibre4"/><a data-primary="debugging" data-secondary="linkerd diagnostics command" data-type="indexterm" id="ch06-diag2" class="calibre4"/> is a powerful tool that enables platform
operators to gather information directly from Linkerd. It will allow you to
directly scrape details from the metrics endpoints of the various Linkerd
components.</p>

<p class="author1">This command also allows you to diagnose hard-to-identify conditions, like Linkerd’s failfast error, by listing out the endpoints for a given service.<a data-primary="linkerd" data-secondary="diagnostics command" data-tertiary="documentation URL" data-type="indexterm" id="id1019" class="calibre4"/><a data-primary="Linkerd" data-secondary="documentation URL" data-tertiary="linkerd diagnostics command" data-type="indexterm" id="id1020" class="calibre4"/><a data-primary="documentation for Linkerd online" data-secondary="linkerd diagnostics command" data-type="indexterm" id="id1021" class="calibre4"/><a data-primary="resources online" data-secondary="Linkerd documentation" data-tertiary="linkerd diagnostics command" data-type="indexterm" id="id1022" class="calibre4"/><a data-primary="debugging" data-secondary="linkerd diagnostics command" data-tertiary="documentation URL" data-type="indexterm" id="id1023" class="calibre4"/> Some examples are given here; see also the <a href="https://oreil.ly/egNPA" class="calibre4">latest documentation</a> on the Linkerd site.</p>










<section data-pdf-bookmark="Gathering metrics" data-type="sect3" class="preface"><div class="preface" id="id146">
<h3 class="calibre33">Gathering metrics</h3>

<p class="author1">The <code class="calibre9">linkerd diagnostics</code> command<a data-primary="linkerd" data-secondary="diagnostics command" data-tertiary="gathering metrics" data-type="indexterm" id="id1024" class="calibre4"/><a data-primary="debugging" data-secondary="linkerd diagnostics command" data-tertiary="gathering metrics" data-type="indexterm" id="id1025" class="calibre4"/><a data-primary="metrics" data-secondary="linkerd diagnostics command" data-type="indexterm" id="id1026" class="calibre4"/> can gather data directly from the metrics endpoints of the control plane and data plane. To gather control plane metrics, use this command:</p>

<pre class="calibre36" data-code-language="bash" data-type="programlisting">$<code class="w"> </code>linkerd<code class="w"> </code>diagnostics<code class="w"> </code>controller-metrics<code class="w"/></pre>

<pre class="wrap" data-type="programlisting">#
# POD linkerd-destination-8498c6764f-96tqr (1 of 5)
# CONTAINER destination
#
# HELP cluster_store_size The number of linked clusters in the remote discove...
# TYPE cluster_store_size gauge
cluster_store_size 0
# HELP endpoint_profile_updates_queue_overflow A counter incremented whenever...
# TYPE endpoint_profile_updates_queue_overflow counter
endpoint_profile_updates_queue_overflow 0
# HELP endpoint_updates_queue_overflow A counter incremented whenever the end...
# TYPE endpoint_updates_queue_overflow counter
endpoint_updates_queue_overflow{service="kubernetes.default.svc.cluster.local...
# HELP endpoints_cache_size Number of items in the client-go endpoints cache
# TYPE endpoints_cache_size gauge
endpoints_cache_size{cluster="local"} 17
...</pre>

<p class="author1">To gather metrics data for a given proxy or set of proxies, use a command like the following:</p>

<pre class="calibre36" data-code-language="bash" data-type="programlisting">$<code class="w"> </code>linkerd<code class="w"> </code>diagnostics<code class="w"> </code>proxy-metrics<code class="w"> </code>-n<code class="w"> </code>emojivoto<code class="w"> </code>deploy/web<code class="w"/></pre>

<pre class="wrap" data-type="programlisting">#
# POD web-5b97875957-xn269 (1 of 1)
#
# HELP inbound_http_authz_allow_total The total number of inbound HTTP reques...
# TYPE inbound_http_authz_allow_total counter
inbound_http_authz_allow_total{target_addr="0.0.0.0:4191",target_ip="0.0.0.0"...
inbound_http_authz_allow_total{target_addr="0.0.0.0:4191",target_ip="0.0.0.0"...
# HELP identity_cert_expiration_timestamp_seconds Time when the this proxy's ...
# TYPE identity_cert_expiration_timestamp_seconds gauge
identity_cert_expiration_timestamp_seconds 1705071458
# HELP identity_cert_refresh_count The total number of times this proxy's mTL...
# TYPE identity_cert_refresh_count counter
identity_cert_refresh_count 1
# HELP request_total Total count of HTTP requests.
# TYPE request_total counter
request_total{direction="inbound",target_addr="0.0.0.0:4191",target_ip="0.0.0...
request_total{direction="inbound",target_addr="0.0.0.0:4191",target_ip="0.0.0...
...</pre>

<p class="author1"><code class="calibre9">linkerd diagnostics</code> produces raw Prometheus metrics, so you’ll need to already have a
sense of what information you’re looking for if you’re using these commands.
Also note that the sample output has been truncated for space reasons—these
commands produce <em class="hyperlink">much</em> more output than what’s shown here (hundreds of
lines, or more, is typical).</p>
</div></section>










<section data-pdf-bookmark="Checking for endpoints" data-type="sect3" class="preface"><div class="preface" id="id147">
<h3 class="calibre33">Checking for endpoints</h3>

<p class="author1">One of the hardest problems to debug<a data-primary="linkerd" data-secondary="diagnostics command" data-tertiary="checking for endpoints" data-type="indexterm" id="id1027" class="calibre4"/><a data-primary="debugging" data-secondary="linkerd diagnostics command" data-tertiary="checking for endpoints" data-type="indexterm" id="id1028" class="calibre4"/><a data-primary="failfast state" data-secondary="linkerd diagnostics command" data-type="indexterm" id="id1029" class="calibre4"/><a data-primary="endpoints of a Service" data-secondary="linkerd diagnostics command" data-type="indexterm" id="id1030" class="calibre4"/> in Linkerd tends to be when the
<code class="calibre9">linkerd2-proxy</code> emits a message indicating it’s in a <em class="hyperlink">failfast</em> state. The
failfast state is discussed in more detail in
<a data-type="xref" href="ch15.html#LUAR_troubleshooting" class="calibre4">Chapter 15</a>, but a very common reason to land in failfast
is that a given service doesn’t have any valid endpoints. You can check for
this condition with <code class="calibre9">linkerd diagnostics endpoints</code>. For example,
here we examine the endpoints for the <code class="calibre9">emoji-svc</code> service of the
<a href="https://oreil.ly/ZnYsL" class="calibre4">emojivoto sample application</a>:</p>

<pre class="calibre36" data-code-language="bash" data-type="programlisting">$<code class="w"> </code>linkerd<code class="w"> </code>diagnostics<code class="w"> </code>endpoints<code class="w"> </code>emoji-svc.emojivoto.svc.cluster.local:8080<code class="w"/></pre>

<pre class="wrap" data-type="programlisting">NAMESPACE   IP           PORT   POD                     SERVICE
emojivoto   10.42.0.15   8080   emoji-5b97875957-xn269  emoji-svc.emojivoto</pre>

<p class="author1">Note that you must provide the fully qualified DNS name of the service as
well as a port number. If no valid endpoints are found, <code class="calibre9">linkerd diagnostics
endpoints</code> will report <code class="calibre9">No endpoints found</code> and, importantly, requests to the
service will land in failfast.</p>
</div></section>










<section data-pdf-bookmark="Diagnosing policy" data-type="sect3" class="preface"><div class="preface" id="id51">
<h3 class="calibre33">Diagnosing policy</h3>

<p class="author1">As of Linkerd 2.13, there is a <a data-primary="debugging" data-secondary="linkerd diagnostics command" data-tertiary="diagnosing policy" data-type="indexterm" id="ch06-polc" class="calibre4"/><a data-primary="linkerd" data-secondary="diagnostics command" data-tertiary="diagnosing policy" data-type="indexterm" id="ch06-polc2" class="calibre4"/><a data-primary="policy" data-secondary="diagnosing via linkerd diagnostics" data-type="indexterm" id="ch06-polc3" class="calibre4"/>new <code class="calibre9">linkerd diagnostics policy</code> command that
can provide insight into Linkerd’s advanced routing policy engine. For
example, you can look at the policy applied to traffic on port
80 of the <code class="calibre9">smiley</code> Service in the <code class="calibre9">faces</code> namespace (as you might find if
you’re running the <a href="https://oreil.ly/a4OnB" class="calibre4">Faces demo
application</a>):</p>

<pre data-code-language="bash" data-type="programlisting" class="calibre36">$<code class="w"> </code>linkerd<code class="w"> </code>diagnostics<code class="w"> </code>policy<code class="w"> </code>-n<code class="w"> </code>faces<code class="w"> </code>svc/smiley<code class="w"> </code><code class="m">80</code><code class="w"> </code>&gt;<code class="w"> </code>smiley-diag.json<code class="w"/></pre>

<p class="author1">The output of <code class="calibre9">linkerd diagnostics policy</code> is <em class="hyperlink">extremely</em> verbose JSON, so
it’s almost always a good idea to redirect it to a file as we’ve done here (or to
<code class="calibre9">less</code>, <code class="calibre9">bat</code>, or a similar tool). You’ll see sections for <code class="calibre9">http1.1</code>, <code class="calibre9">http2</code>,
etc., and in each section will be a very detailed—and, again, verbose—breakdown
of the policy being applied.</p>

<p class="author1">As an example, you might see output like that in <a data-type="xref" href="#EX8-plain-policy" class="calibre4">Example 6-1</a> to describe what will happen
to HTTP/2 traffic with no advanced policy applied.</p>
<div data-type="example" id="EX8-plain-policy" class="calibre40">
<h5 class="calibre41"><span class="calibre">Example 6-1. </span>HTTP/2 output block without advanced policy</h5>

<pre data-code-language="yaml" data-type="programlisting" class="calibre42"><code class="nt">http2</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">routes</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">Default</code><code class="p">:</code><code class="w"> </code><code class="calibre9">http</code><code class="w"/>
<code class="w">    </code><code class="nt">rules</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">backends</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="nt">FirstAvailable</code><code class="p">:</code><code class="w"/>
<code class="w">            </code><code class="nt">backends</code><code class="p">:</code><code class="w"/>
<code class="w">            </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">backend</code><code class="p">:</code><code class="w"/>
<code class="w">                </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">                  </code><code class="nt">Balancer</code><code class="p">:</code><code class="w"/>
<code class="w">                    </code><code class="nt">Load</code><code class="p">:</code><code class="w"/>
<code class="w">                      </code><code class="nt">PeakEwma</code><code class="p">:</code><code class="w"/>
<code class="w">                        </code><code class="nt">decay</code><code class="p">:</code><code class="w"/>
<code class="w">                          </code><code class="nt">seconds</code><code class="p">:</code><code class="w"> </code><code class="calibre9">10</code><code class="w"/>
<code class="w">                        </code><code class="nt">default_rtt</code><code class="p">:</code><code class="w"/>
<code class="w">                          </code><code class="nt">nanos</code><code class="p">:</code><code class="w"> </code><code class="calibre9">30000000</code><code class="w"/>
<code class="w">                    </code><code class="nt">discovery</code><code class="p">:</code><code class="w"/>
<code class="w">                      </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">                        </code><code class="nt">Dst</code><code class="p">:</code><code class="w"/>
<code class="w">                          </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="calibre9">smiley.faces.svc.cluster.local:80</code><code class="w"/>
<code class="w">                </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">                  </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">                    </code><code class="nt">Default</code><code class="p">:</code><code class="w"> </code><code class="calibre9">service</code><code class="w"/>
<code class="w">                </code><code class="nt">queue</code><code class="p">:</code><code class="w"/>
<code class="w">                  </code><code class="nt">capacity</code><code class="p">:</code><code class="w"> </code><code class="calibre9">100</code><code class="w"/>
<code class="w">                  </code><code class="nt">failfast_timeout</code><code class="p">:</code><code class="w"/>
<code class="w">                    </code><code class="nt">seconds</code><code class="p">:</code><code class="w"> </code><code class="calibre9">3</code><code class="w"/>
<code class="w">      </code><code class="nt">matches</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">path</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">            </code><code class="nt">Prefix</code><code class="p">:</code><code class="w"> </code><code class="calibre9">/</code><code class="w"/></pre></div>

<p class="author1">Alternatively, suppose that you apply the HTTPRoute resource shown in <a data-type="xref" href="#EX8-smiley-split" class="calibre4">Example 6-2</a> to split traffic sent to <code class="calibre9">smiley</code> so that half the traffic proceeds to the <code class="calibre9">smiley</code> workload, and the other half is redirected to <code class="calibre9">smiley2</code>. (HTTPRoutes are discussed in more detail in <a data-type="xref" href="ch09.html#LUAR_route_policy" class="calibre4">Chapter 9</a>.)</p>
<div data-type="example" id="EX8-smiley-split" class="calibre40">
<h5 class="calibre41"><span class="calibre">Example 6-2. </span>HTTPRoute traffic splitting</h5>

<pre data-code-language="yaml" data-type="programlisting" class="calibre42"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre9">policy.linkerd.io/v1beta3</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre9">HTTPRoute</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre9">smiley-split</code><code class="w"/>
<code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="calibre9">faces</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">parentRefs</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre9">smiley</code><code class="w"/>
<code class="w">      </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre9">Service</code><code class="w"/>
<code class="w">      </code><code class="nt">group</code><code class="p">:</code><code class="w"> </code><code class="calibre9">core</code><code class="w"/>
<code class="w">      </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="calibre9">80</code><code class="w"/>
<code class="w">  </code><code class="nt">rules</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">backendRefs</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre9">smiley</code><code class="w"/>
<code class="w">      </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="calibre9">80</code><code class="w"/>
<code class="w">      </code><code class="nt">weight</code><code class="p">:</code><code class="w"> </code><code class="calibre9">50</code><code class="w"/>
<code class="w">    </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre9">smiley2</code><code class="w"/>
<code class="w">      </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="calibre9">80</code><code class="w"/>
<code class="w">      </code><code class="nt">weight</code><code class="p">:</code><code class="w"> </code><code class="calibre9">50</code><code class="w"/></pre></div>

<p class="author1">With that HTTPRoute in effect, <code class="calibre9">linkerd diagnostics policy</code> might produce an
<code class="calibre9">http2</code> block like the one in <a data-type="xref" href="#EX8-split-policy" class="calibre4">Example 6-3</a>, showing that traffic is
indeed being split.</p>
<div data-type="example" id="EX8-split-policy" class="calibre40">
<h5 class="calibre41"><span class="calibre">Example 6-3. </span>HTTP/2 output block with traffic splitting</h5>

<pre data-code-language="yaml" data-type="programlisting" class="calibre42"><code class="nt">http2</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">routes</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">Resource</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="nt">group</code><code class="p">:</code><code class="w"> </code><code class="calibre9">policy.linkerd.io</code><code class="w"/>
<code class="w">          </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre9">HTTPRoute</code><code class="w"/>
<code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre9">smiley-split</code><code class="w"/>
<code class="w">          </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="calibre9">faces</code><code class="w"/>
<code class="w">    </code><code class="nt">rules</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">backends</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="nt">RandomAvailable</code><code class="p">:</code><code class="w"/>
<code class="w">            </code><code class="nt">backends</code><code class="p">:</code><code class="w"/>
<code class="w">            </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">backend</code><code class="p">:</code><code class="w"/>
<code class="w">                </code><code class="nt">backend</code><code class="p">:</code><code class="w"/>
<code class="w">                  </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">                    </code><code class="nt">Balancer</code><code class="p">:</code><code class="w"/>
<code class="w">                      </code><code class="nt">Load</code><code class="p">:</code><code class="w"/>
<code class="w">                        </code><code class="nt">PeakEwma</code><code class="p">:</code><code class="w"/>
<code class="w">                          </code><code class="nt">decay</code><code class="p">:</code><code class="w"/>
<code class="w">                            </code><code class="nt">seconds</code><code class="p">:</code><code class="w"> </code><code class="calibre9">10</code><code class="w"/>
<code class="w">                          </code><code class="nt">default_rtt</code><code class="p">:</code><code class="w"/>
<code class="w">                            </code><code class="nt">nanos</code><code class="p">:</code><code class="w"> </code><code class="calibre9">30000000</code><code class="w"/>
<code class="w">                      </code><code class="nt">discovery</code><code class="p">:</code><code class="w"/>
<code class="w">                        </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">                          </code><code class="nt">Dst</code><code class="p">:</code><code class="w"/>
<code class="w">                            </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="calibre9">smiley.faces.svc.cluster.local:80</code><code class="w"/>
<code class="w">                  </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">                    </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">                      </code><code class="nt">Resource</code><code class="p">:</code><code class="w"/>
<code class="w">                        </code><code class="nt">group</code><code class="p">:</code><code class="w"> </code><code class="calibre9">core</code><code class="w"/>
<code class="w">                        </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre9">Service</code><code class="w"/>
<code class="w">                        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre9">smiley</code><code class="w"/>
<code class="w">                        </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="calibre9">faces</code><code class="w"/>
<code class="w">                        </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="calibre9">80</code><code class="w"/>
<code class="w">                  </code><code class="nt">queue</code><code class="p">:</code><code class="w"/>
<code class="w">                    </code><code class="nt">capacity</code><code class="p">:</code><code class="w"> </code><code class="calibre9">100</code><code class="w"/>
<code class="w">                    </code><code class="nt">failfast_timeout</code><code class="p">:</code><code class="w"/>
<code class="w">                      </code><code class="nt">seconds</code><code class="p">:</code><code class="w"> </code><code class="calibre9">3</code><code class="w"/>
<code class="w">              </code><code class="nt">weight</code><code class="p">:</code><code class="w"> </code><code class="calibre9">50</code><code class="w"/>
<code class="w">            </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">backend</code><code class="p">:</code><code class="w"/>
<code class="w">                </code><code class="nt">backend</code><code class="p">:</code><code class="w"/>
<code class="w">                  </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">                    </code><code class="nt">Balancer</code><code class="p">:</code><code class="w"/>
<code class="w">                      </code><code class="nt">Load</code><code class="p">:</code><code class="w"/>
<code class="w">                        </code><code class="nt">PeakEwma</code><code class="p">:</code><code class="w"/>
<code class="w">                          </code><code class="nt">decay</code><code class="p">:</code><code class="w"/>
<code class="w">                            </code><code class="nt">seconds</code><code class="p">:</code><code class="w"> </code><code class="calibre9">10</code><code class="w"/>
<code class="w">                          </code><code class="nt">default_rtt</code><code class="p">:</code><code class="w"/>
<code class="w">                            </code><code class="nt">nanos</code><code class="p">:</code><code class="w"> </code><code class="calibre9">30000000</code><code class="w"/>
<code class="w">                      </code><code class="nt">discovery</code><code class="p">:</code><code class="w"/>
<code class="w">                        </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">                          </code><code class="nt">Dst</code><code class="p">:</code><code class="w"/>
<code class="w">                            </code><code class="nt">path</code><code class="p">:</code><code class="w"> </code><code class="calibre9">smiley2.faces.svc.cluster.local:80</code><code class="w"/>
<code class="w">                  </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">                    </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">                      </code><code class="nt">Resource</code><code class="p">:</code><code class="w"/>
<code class="w">                        </code><code class="nt">group</code><code class="p">:</code><code class="w"> </code><code class="calibre9">core</code><code class="w"/>
<code class="w">                        </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre9">Service</code><code class="w"/>
<code class="w">                        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre9">smiley2</code><code class="w"/>
<code class="w">                        </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="calibre9">faces</code><code class="w"/>
<code class="w">                        </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="calibre9">80</code><code class="w"/>
<code class="w">                  </code><code class="nt">queue</code><code class="p">:</code><code class="w"/>
<code class="w">                    </code><code class="nt">capacity</code><code class="p">:</code><code class="w"> </code><code class="calibre9">100</code><code class="w"/>
<code class="w">                    </code><code class="nt">failfast_timeout</code><code class="p">:</code><code class="w"/>
<code class="w">                      </code><code class="nt">seconds</code><code class="p">:</code><code class="w"> </code><code class="calibre9">3</code><code class="w"/>
<code class="w">              </code><code class="nt">weight</code><code class="p">:</code><code class="w"> </code><code class="calibre9">50</code><code class="w"/>
<code class="w">      </code><code class="nt">matches</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="calibre9">-</code><code class="w"> </code><code class="nt">path</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="nt">Kind</code><code class="p">:</code><code class="w"/>
<code class="w">            </code><code class="nt">Prefix</code><code class="p">:</code><code class="w"> </code><code class="calibre9">/</code><code class="w"/></pre></div>

<p class="author1">As Linkerd evolves, this output will change, so take these examples with a
grain of salt. The point of <code class="calibre9">linkerd diagnostics policy</code> is to
provide sufficient detail that you can understand how Linkerd will manage
traffic to a particular workload, no matter what changes are made to the
source.<a data-startref="ch06-diag" data-type="indexterm" id="id1031" class="calibre4"/><a data-startref="ch06-diag2" data-type="indexterm" id="id1032" class="calibre4"/><a data-startref="ch06-polc" data-type="indexterm" id="id1033" class="calibre4"/><a data-startref="ch06-polc2" data-type="indexterm" id="id1034" class="calibre4"/><a data-startref="ch06-polc3" data-type="indexterm" id="id1035" class="calibre4"/></p>
</div></section>
</div></section>
</div></section>






<section data-pdf-bookmark="Summary" data-type="sect1" class="preface"><div class="preface" id="id318">
<h1 class="calibre8">Summary</h1>

<p class="author1">The <code class="calibre9">linkerd</code> CLI provides more than just the tooling you need to install
Linkerd. It gives you critical operational tools that simplify the process of
running Linkerd in your clusters. While it’s definitely possible to use
Linkerd and never run the <code class="calibre9">linkerd</code> CLI, the CLI is the most straightforward,
effective way to deal with many real-world situations.</p>
</div></section>
</div></section></body></html>