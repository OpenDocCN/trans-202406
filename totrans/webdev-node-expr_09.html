<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 9. Cookies and Sessions"><div class="chapter" id="ch_cookies_and_sessions">
<h1><span class="label">Chapter 9. </span>Cookies and Sessions</h1>


<p><a data-type="indexterm" data-primary="cookies" id="ix_ch-09-cookies_and_sessions-asciidoc0"/>In this chapter, you’ll learn how to use cookies and sessions to provide a
better experience to your users by remembering their preferences from page
to page, and even between browser sessions.</p>

<p><a data-type="indexterm" data-primary="state" data-secondary="cookies and" id="idm45053590658744"/>HTTP is a <em>stateless</em> protocol. That means that when you load a
page in your browser and then you navigate to another page on the same
website, neither the server nor the browser has any intrinsic way of
knowing that it’s the same browser visiting the same site. Another way of
saying this is that the way the web works is that <em>every HTTP request
contains all the information necessary for the server to satisfy the
request</em>.</p>

<p>This is a problem, though: if the story ended there, we could never log
in to anything. Streaming media wouldn’t work. Websites wouldn’t be able
to remember your preferences from one page to the next. So there needs be
a way to build state on top of HTTP, and that’s where cookies and sessions
enter the picture.</p>

<p>Cookies, unfortunately, have gotten a bad name thanks to the nefarious
things that people have done with them. This is unfortunate because
cookies are really quite essential to the functioning of the “modern web”
(although HTML5 has introduced some new features, like local storage, that
could be used for the same purpose).</p>

<p>The idea of a cookie is simple: the server sends a bit of information, and
the browser stores it for some configurable period of time. It’s really up
to the server what the particular bit of information is. Often it’s just a
unique ID number that identifies a specific browser so that the illusion of
state can be maintained.</p>

<p>There are some important things you need to know about cookies:</p>
<dl>
<dt>Cookies are not secret from the user</dt>
<dd>
<p>  All cookies that the server sends to the client are available for the
client to look at. There’s no reason you can’t send something encrypted to
protect its contents, but there’s seldom any need for this (at least if
you’re not doing anything nefarious!). <em>Signed</em>
cookies, which we’ll discuss in a bit, can obfuscate the contents of the
cookie, but this is in no way cryptographically secure from prying eyes.</p>
</dd>
<dt>The user can delete or disallow cookies</dt>
<dd>
<p>  Users have full control over cookies, and browsers make it possible to
delete cookies in bulk or individually. Unless you’re up to no good,
there’s no real reason for users to do this, but it is useful during
testing. Users can also disallow cookies, which is more problematic because only
the simplest web applications can make do without cookies.</p>
</dd>
<dt>Regular cookies can be tampered with</dt>
<dd>
<p>  Whenever a browser makes a request of your server that has an associated
cookie and you blindly trust the contents of that cookie, you are opening
yourself up for attack. The height of foolishness, for example, would be
to execute code contained in a cookie. To ensure cookies aren’t tampered
with, use signed cookies.</p>
</dd>
<dt>Cookies can be used for attacks</dt>
<dd>
<p>  <a data-type="indexterm" data-primary="cross-site request scripting (XSS) attacks" id="idm45053590646312"/><a data-type="indexterm" data-primary="XSS (cross-site request scripting) attacks" id="idm45053590645544"/>A category of attacks called <em>cross-site scripting</em> (XSS) attacks has
sprung up in recent years. One technique of XSS attacks involves malicious
JavaScript modifying the contents of cookies. This is an additional reason
not to trust the contents of cookies that come back to your server. Using
signed cookies helps (tampering will be evident in a signed cookie whether
the user or malicious JavaScript modified it), and there’s also a setting
that specifies that cookies are to be modified only by the server. These
cookies can be limited in usefulness, but they are certainly safer.</p>
</dd>
<dt>Users will notice if you abuse cookies</dt>
<dd>
<p>  If you set a lot of cookies on your users’ computers or store a lot of
data, it will irritate your users, which is something you should avoid. Try to keep
your use of cookies to a minimum.</p>
</dd>
<dt>Prefer sessions over cookies</dt>
<dd>
<p>  <a data-type="indexterm" data-primary="cookies" data-secondary="sessions versus" id="idm45053590640872"/><a data-type="indexterm" data-primary="sessions" data-secondary="cookies versus" id="idm45053590639864"/>For the most part, you can use <em>sessions</em> to maintain
state, and it’s generally wise
to do so. It’s easier, you don’t have to worry about abusing your users’
storage, and it can be more secure. Sessions rely on cookies, of course,
but with sessions, Express will be doing the heavy lifting for you.</p>
</dd>
</dl>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="Set-Cookie header" id="idm45053590637224"/>Cookies are not magic: when the server wants the client to store a cookie,
it sends a header called <code>Set-Cookie</code> containing
name/value pairs, and when a client sends a request to a server for which
it has cookies, it sends multiple <code>Cookie</code>
request headers containing the value of the cookies.</p>
</div>






<section data-type="sect1" data-pdf-bookmark="Externalizing Credentials"><div class="sect1" id="idm45053590635080">
<h1>Externalizing Credentials</h1>

<p><a data-type="indexterm" data-primary="cookie secret" id="idm45053590633512"/><a data-type="indexterm" data-primary="cookies" data-secondary="externalizing credentials" id="idm45053590632808"/><a data-type="indexterm" data-primary="credentials, externalizing" id="idm45053590631800"/><a data-type="indexterm" data-primary="externalizing credentials" id="idm45053590631112"/>To make cookies secure, a <em>cookie secret</em> is necessary. The cookie secret is a
string that’s known to the server and used to encrypt secure cookies before
they’re sent to the client. It’s not a password that has to be remembered,
so it can just be a random string. I usually use
<a href="http://bit.ly/2QcjuDb">a random password generator inspired by
xkcd</a> to generate the cookie secret or simply a random number.</p>

<p>It’s a common practice to externalize third-party credentials, such as the
cookie secret, database passwords, and API tokens (Twitter, Facebook,
etc.). This not only eases maintenance (by making it easy to locate
and update credentials), but also allows you to omit the credentials file
from your version control system. This is especially critical for open
source repositories hosted on GitHub or other public source control
repositories.</p>

<p>To that end, we’re going to externalize our credentials in a JSON file.
Create a file called <em>.credentials.development.json</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="p">{</code>
  <code class="s2">"cookieSecret"</code><code class="o">:</code> <code class="s2">"...your cookie secret goes here"</code>
<code class="p">}</code></pre>

<p>This will be the credentials file for our development work. In this way,
you could have different credentials files for production, test, or other
environments, which will come in handy.</p>

<p>We’re going to add a layer of abstraction on top of this credentials file
to make it easier to manage our dependencies as our application grows. Our
version will be very simple. Create a file called <em>config.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">env</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">NODE_ENV</code> <code class="o">||</code> <code class="s1">'development'</code>
<code class="kr">const</code> <code class="nx">credentials</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="sb">`./.credentials.</code><code class="si">${</code><code class="nx">env</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>
<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">credentials</code> <code class="p">}</code></pre>

<p>Now, to make sure we don’t accidentally add credentials to our repository,
add <em>.credentials.*</em> to your <em>.gitignore</em> file. To import
your credentials into
your application, all you need to do is this:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="p">{</code> <code class="nx">credentials</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./config'</code><code class="p">)</code></pre>

<p>We’ll be using this same file to store other credentials later, but for
now, all we need is our cookie secret.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you’re following along by using the companion repository, you’ll have to
create your own credentials file, as it is not included in the repository.</p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Cookies in Express"><div class="sect1" id="idm45053590634456">
<h1>Cookies in Express</h1>

<p><a data-type="indexterm" data-primary="cookie-parser middleware" id="idm45053590486200"/><a data-type="indexterm" data-primary="cookies" data-secondary="in Express" id="idm45053590485528"/><a data-type="indexterm" data-primary="Express" data-secondary="cookies in" id="idm45053590484584"/>Before you start setting and accessing cookies in your app, you
need to include the <code>cookie-parser</code>
middleware. First, use <code>npm install cookie-parser</code>, and then (<em>ch09/meadowlark.js</em>
in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">cookieParser</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'cookie-parser'</code><code class="p">)</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">cookieParser</code><code class="p">(</code><code class="nx">credentials</code><code class="p">.</code><code class="nx">cookieSecret</code><code class="p">))</code></pre>

<p>Once you’ve done this, you can set a cookie or a signed cookie anywhere
you have access to a response object:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">res</code><code class="p">.</code><code class="nx">cookie</code><code class="p">(</code><code class="s1">'monster'</code><code class="p">,</code> <code class="s1">'nom nom'</code><code class="p">)</code>
<code class="nx">res</code><code class="p">.</code><code class="nx">cookie</code><code class="p">(</code><code class="s1">'signed_monster'</code><code class="p">,</code> <code class="s1">'nom nom'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">signed</code><code class="o">:</code> <code class="kc">true</code> <code class="p">})</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Signed cookies take precedence over unsigned cookies.
If you name your signed cookie <code>signed_monster</code>, you cannot have an
unsigned cookie with the same name (it will come back as <code>undefined</code>).</p>
</div>

<p><a data-type="indexterm" data-primary="req.cookies object" id="idm45053590370296"/><a data-type="indexterm" data-primary="req.signedCookies object" id="idm45053590369624"/>To retrieve the value of a cookie (if any) sent from the client, just
access the <code>cookie</code> or <code>signedCookie</code> properties of
the request object:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">monster</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">cookies</code><code class="p">.</code><code class="nx">monster</code>
<code class="kr">const</code> <code class="nx">signedMonster</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">signedCookies</code><code class="p">.</code><code class="nx">signed_monster</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You can use any string you want for a cookie name. For example, we could have used <code>\'signed
monster'</code> instead of <code>\'signed_monster'</code>, but then we would have to use the
bracket notation to retrieve the <span class="keep-together">cookie:</span> <code>req.signedCookies[\'signed
monster']</code>. For this reason, I recommend using cookie names without
special characters.</p>
</div>

<p><a data-type="indexterm" data-primary="req.clearCookie object" id="idm45053590353704"/>To delete a cookie, use <code>req.clearCookie</code>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">res</code><code class="p">.</code><code class="nx">clearCookie</code><code class="p">(</code><code class="s1">'monster'</code><code class="p">)</code></pre>

<p>When you set a cookie, you can specify the following options:</p>
<dl>
<dt><code>domain</code></dt>
<dd>
<p>  Controls the domains the cookie is associated with; this allows you to
assign cookies to specific subdomains. Note that you cannot set a cookie
for a different domain than the server is running on; it will simply do
nothing.</p>
</dd>
<dt><code>path</code></dt>
<dd>
<p>  Controls the path this cookie applies to. Note that paths have an
implicit wildcard after them; if you use a path of <em>/</em> (the default), it
will apply to all pages on your site. If you use a path of <em>/foo</em>, it
will apply to the paths <em>/foo</em>, <em>/foo/bar</em>, etc.</p>
</dd>
<dt><code>maxAge</code></dt>
<dd>
<p>  Specifies how long the client should keep the cookie before deleting it,
in milliseconds. If you omit this, the cookie will be deleted when you
close your browser. (You can also specify a date for expiration with the
<code>expires</code> option, but the syntax is frustrating. I recommend using
<code>maxAge</code>.)</p>
</dd>
<dt><code>secure</code></dt>
<dd>
<p>  Specifies that this cookie will be sent only over a secure (HTTPS)
connection.</p>
</dd>
<dt><code>httpOnly</code></dt>
<dd>
<p>  Setting this to <code>true</code> specifies the cookie will be modified only by the
server. That is, client-side JavaScript cannot modify it. This helps
prevent XSS attacks.</p>
</dd>
<dt><code>signed</code></dt>
<dd>
<p>  Setting this to <code>true</code> signs this cookie, making it available in
<code>res.signedCookies</code> instead of <code>res.cookies</code>. Signed cookies that have
been tampered with will be rejected by the server, and the cookie value
will be reset to its original value.</p>
</dd>
</dl>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Examining Cookies"><div class="sect1" id="idm45053590313784">
<h1>Examining Cookies</h1>

<p><a data-type="indexterm" data-primary="cookies" data-secondary="examining" id="idm45053590283304"/>As part of your testing, you’ll probably want a way to examine the cookies
on your system. Most browsers have a way to view individual cookies and the
values they store. In <a data-type="indexterm" data-primary="Chrome" data-secondary="examining cookies in" id="idm45053590282008"/>Chrome, open the
developer tools, and select the Application tab. In the tree on the left,
you’ll see Cookies. Expand that, and you’ll see the site you’re currently
visiting listed. Click that, and you will see all the cookies associated
with this site. You can also right-click the domain to clear all cookies
or right-click an individual cookie to remove it specifically.<a data-type="indexterm" data-startref="ix_ch-09-cookies_and_sessions-asciidoc0" id="idm45053590280536"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Sessions"><div class="sect1" id="idm45053590279640">
<h1>Sessions</h1>

<p><a data-type="indexterm" data-primary="sessions" id="ix_ch-09-cookies_and_sessions-asciidoc1"/><em>Sessions</em> are really just a more convenient way to maintain
state. To implement
sessions, <em>something</em> has to be stored on the client; otherwise, the server
wouldn’t be able to identify the client from one request to the next. The
usual method of doing this is a cookie that contains a unique identifier. The
server then uses that identifier to retrieve the appropriate session
information.</p>

<p>Cookies aren’t the only way to accomplish this: during the
height of the “cookie scare” (when cookie abuse was rampant), many users were
simply turning off cookies, and other ways to maintain state were devised,
such as decorating URLs with session information. These techniques were
messy, difficult, and inefficient, and they are best left in the past. HTML5 provides another option for sessions called <a data-type="indexterm" data-primary="local storage, sessions and" id="idm45053590275768"/><em>local storage</em>, which offers an advantage over cookies if you need to store larger
amounts of data. See
<a href="https://mzl.la/2CDrGo4">the MDN
documentation for <code>Window.localStorage</code></a> for more information about this
option.</p>

<p><a data-type="indexterm" data-primary="cookie-based sessions" id="idm45053590256456"/>Broadly speaking, there are two ways to implement sessions: store
everything in the cookie or store only a unique identifier in the cookie
and everything else on the server. The former are called
<em>cookie-based sessions</em> and merely represent a convenience over using
cookies. However, it still means that everything you add to the session
will be stored on the client’s browser, which is an approach I don’t
recommend. I recommend this approach only if you know that you will
be storing just a small amount of information, that you don’t mind the user
having access to the information, and that it won’t be growing out of
control over time. If you want to take this approach, see the
<a href="http://bit.ly/2qNv9h6"><code>cookie-session</code> middleware</a>.</p>








<section data-type="sect2" data-pdf-bookmark="Memory Stores"><div class="sect2" id="idm45053590253432">
<h2>Memory Stores</h2>

<p><a data-type="indexterm" data-primary="sessions" data-secondary="memory stores" id="idm45053590252024"/>If you would rather store session information on the server, which I recommend, you have to have somewhere to
store it. The entry-level option is memory sessions. They are easy
to set up, but they have a huge downside: when you restart the server
(which you will be doing a lot of over the course of this book!), your
session information disappears. Even worse, if you scale out by having
multiple servers (see <a data-type="xref" href="ch12.xhtml#ch_production_concerns">Chapter 12</a>), a different server could
service a request every time; session data would sometimes be there, and
sometimes not. This is clearly an unacceptable user experience. However,
for our development and testing needs, it will suffice. We’ll see how to
permanently store session information in <a data-type="xref" href="ch13.xhtml#ch_persistence">Chapter 13</a>.</p>

<p><a data-type="indexterm" data-primary="express-session middleware" id="idm45053590248296"/>First, install <code>express-session</code> (<code>npm
install express-session</code>); then, after linking in the cookie parser,
link in <code>express-session</code> (<em>ch09/meadowalrk.js</em> in the companion repo):</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">expressSession</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express-session'</code><code class="p">)</code>
<code class="c1">// make sure you've linked in cookie middleware before</code>
<code class="c1">// session middleware!</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">expressSession</code><code class="p">({</code>
    <code class="nx">resave</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="nx">saveUninitialized</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="nx">secret</code><code class="o">:</code> <code class="nx">credentials</code><code class="p">.</code><code class="nx">cookieSecret</code><code class="p">,</code>
<code class="p">}))</code></pre>

<p>The <code>express-session</code> middleware accepts a configuration object with the
following options:</p>
<dl>
<dt><code>resave</code></dt>
<dd>
<p>Forces the session to be saved back to the store even if the request
wasn’t modified. Setting this to <code>false</code> is generally preferable; see the
<code>express-session</code> documentation for more information.</p>
</dd>
<dt><code>saveUninitialized</code></dt>
<dd>
<p>Setting this to <code>true</code> causes new (uninitialized) sessions to be saved to
the store, even if they haven’t been modified. Setting this to <code>false</code> is
generally preferable and is required when you need to get the user’s
permission before setting a cookie. See the <code>express-session</code>
documentation for more information.</p>
</dd>
<dt><code>secret</code></dt>
<dd>
<p>The key (or keys) used to sign the session ID cookie. This can be the same
key used for <code>cookie-parser</code>.</p>
</dd>
<dt><code>key</code></dt>
<dd>
<p>  The name of the cookie that will store the unique session identifier.
Defaults to <code>connect.sid</code>.</p>
</dd>
<dt><code>store</code></dt>
<dd>
<p>An instance of a session store. Defaults to an instance of
<code>MemoryStore</code>, which is fine for our current purposes. We’ll see how to
use a database store in <a data-type="xref" href="ch13.xhtml#ch_persistence">Chapter 13</a>.</p>
</dd>
<dt><code>cookie</code></dt>
<dd>
<p> Cookie settings for the session cookie (<code>path</code>, <code>domain</code>, <code>secure</code>,
etc.). Regular cookie defaults apply.</p>
</dd>
</dl>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Using Sessions"><div class="sect2" id="idm45053590213000">
<h2>Using Sessions</h2>

<p><a data-type="indexterm" data-primary="sessions" data-secondary="using" id="idm45053590196984"/>Once you’ve set up sessions, using them couldn’t
be simpler; just use properties of the request object’s
<code>session</code> variable:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userName</code> <code class="o">=</code> <code class="s1">'Anonymous'</code>
<code class="kr">const</code> <code class="nx">colorScheme</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">colorScheme</code> <code class="o">||</code> <code class="s1">'dark'</code></pre>

<p>Note that with sessions, we don’t have to use the request object for
retrieving the value and the response object for setting the value; it’s all performed on the
request object. (The response object does not have a <code>session</code> property.)
To delete a session, you can use JavaScript’s <code>delete</code> operator:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">userName</code> <code class="o">=</code> <code class="kc">null</code>       <code class="c1">// this sets 'userName' to null,</code>
                                  <code class="c1">// but doesn't remove it</code>

<code class="k">delete</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">colorScheme</code>    <code class="c1">// this removes 'colorScheme'</code></pre>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Using Sessions to Implement Flash Messages"><div class="sect1" id="idm45053590080680">
<h1>Using Sessions to Implement Flash Messages</h1>

<p><a data-type="indexterm" data-primary="flash messages" id="ix_ch-09-cookies_and_sessions-asciidoc2"/><a data-type="indexterm" data-primary="sessions" data-secondary="flash message implementation" id="ix_ch-09-cookies_and_sessions-asciidoc3"/><em>Flash</em> messages (not to be confused with Adobe Flash) are simply a way to
provide feedback to users in a way that’s not disruptive to their
navigation. The
easiest way to implement flash messages is to use sessions (you can also
use the querystring, but in addition to those having uglier URLs, the flash
messages will be included in a bookmark, which is probably not what you
want). Let’s set up our HTML first. <a data-type="indexterm" data-primary="Bootstrap" id="idm45053590140040"/>We’ll be using Bootstrap’s alert
messages to display our flash messages,
so make sure you have Bootstrap linked in (see Bootstrap’s
<a href="http://bit.ly/36YxeYf">“getting
started”</a> documentation; you can link in the Bootstrap CSS and JavaScript
files in your main template—there is an example in the companion repo).
In your template file, somewhere prominent (usually directly below your
site’s header), add the following:</p>

<pre data-type="programlisting" data-code-language="html">{{#if flash}}
  <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"alert alert-dismissible alert-{{flash.type}}"</code><code class="nt">&gt;</code>
    <code class="nt">&lt;button</code> <code class="na">type=</code><code class="s">"button"</code> <code class="na">class=</code><code class="s">"close"</code>
      <code class="na">data-dismiss=</code><code class="s">"alert"</code> <code class="na">aria-hidden=</code><code class="s">"true"</code><code class="nt">&gt;</code><code class="ni">&amp;times;</code><code class="nt">&lt;/button&gt;</code>
    <code class="nt">&lt;strong&gt;</code>{{flash.intro}}<code class="nt">&lt;/strong&gt;</code> {{{flash.message}}}
  <code class="nt">&lt;/div&gt;</code>
{{/if}}</pre>

<p>Note that we use three curly brackets for <code>flash.message</code>; this will allow
us to provide some simple HTML in our messages (we might want to emphasize
words or include hyperlinks). Now let’s add some middleware to add the
<code>flash</code> object to the context if there’s one in the session. After we’ve
displayed a flash message once, we want to remove it from the session so it
isn’t displayed on the next request. We’ll create some middleware to
check the session to see whether there’s a flash message and, if there is,
transfer it to the <code>res.locals</code> object, making it available to the views.
We’ll put our middleware in a file called <em>lib/middleware/flash.js</em>:</p>

<pre data-type="programlisting" data-code-language="js"><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// if there's a flash message, transfer</code>
  <code class="c1">// it to the context, then clear it</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">locals</code><code class="p">.</code><code class="nx">flash</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">flash</code>
  <code class="k">delete</code> <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">flash</code>
  <code class="nx">next</code><code class="p">()</code>
<code class="p">})</code></pre>

<p>And in our <em>meadowalrk.js</em> file, we’ll link in the flash message middleware,
before any of our view routes:</p>

<pre data-type="programlisting" data-code-language="js"><code class="kr">const</code> <code class="nx">flashMiddleware</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./lib/middleware/flash'</code><code class="p">)</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">flashMiddleware</code><code class="p">)</code></pre>

<p>Now let’s see how to actually use the flash message. Imagine we’re signing
up users for a newsletter and we want to redirect them to the newsletter
archive after they sign up. This is what our form handler might look like:</p>

<pre data-type="programlisting" data-code-language="js"><code class="c1">// slightly modified version of the official W3C HTML5 email regex:</code>
<code class="c1">// https://html.spec.whatwg.org/multipage/forms.html#valid-e-mail-address</code>
<code class="kr">const</code> <code class="nx">VALID_EMAIL_REGEX</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">RegExp</code><code class="p">(</code><code class="s1">'^[a-zA-Z0-9.!#$%&amp;\'*+\/=?^_`{|}~-]+@'</code> <code class="o">+</code>
  <code class="s1">'[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?'</code> <code class="o">+</code>
  <code class="s1">'(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$'</code><code class="p">)</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/newsletter'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
    <code class="kr">const</code> <code class="nx">name</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">name</code> <code class="o">||</code> <code class="s1">''</code><code class="p">,</code> <code class="nx">email</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">email</code> <code class="o">||</code> <code class="s1">''</code>
    <code class="c1">// input validation</code>
    <code class="k">if</code><code class="p">(</code><code class="nx">VALID_EMAIL_REGEX</code><code class="p">.</code><code class="nx">test</code><code class="p">(</code><code class="nx">email</code><code class="p">))</code> <code class="p">{</code>
      <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">flash</code> <code class="o">=</code> <code class="p">{</code>
        <code class="nx">type</code><code class="o">:</code> <code class="s1">'danger'</code><code class="p">,</code>
        <code class="nx">intro</code><code class="o">:</code> <code class="s1">'Validation error!'</code><code class="p">,</code>
        <code class="nx">message</code><code class="o">:</code> <code class="s1">'The email address you entered was not valid.'</code><code class="p">,</code>
      <code class="p">}</code>
      <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="mi">303</code><code class="p">,</code> <code class="s1">'/newsletter'</code><code class="p">)</code>
    <code class="p">}</code>
    <code class="c1">// NewsletterSignup is an example of an object you might create; since</code>
    <code class="c1">// every implementation will vary, it is up to you to write these</code>
    <code class="c1">// project-specific interfaces. This simply shows how a typical</code>
    <code class="c1">// Express implementation might look in your project.</code>
    <code class="k">new</code> <code class="nx">NewsletterSignup</code><code class="p">({</code> <code class="nx">name</code><code class="p">,</code> <code class="nx">email</code> <code class="p">}).</code><code class="nx">save</code><code class="p">((</code><code class="nx">err</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="k">if</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
          <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">flash</code> <code class="o">=</code> <code class="p">{</code>
            <code class="nx">type</code><code class="o">:</code> <code class="s1">'danger'</code><code class="p">,</code>
            <code class="nx">intro</code><code class="o">:</code> <code class="s1">'Database error!'</code><code class="p">,</code>
            <code class="nx">message</code><code class="o">:</code> <code class="s1">'There was a database error; please try again later.'</code><code class="p">,</code>
          <code class="p">}</code>
          <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="mi">303</code><code class="p">,</code> <code class="s1">'/newsletter/archive'</code><code class="p">)</code>
        <code class="p">}</code>
        <code class="nx">req</code><code class="p">.</code><code class="nx">session</code><code class="p">.</code><code class="nx">flash</code> <code class="o">=</code> <code class="p">{</code>
          <code class="nx">type</code><code class="o">:</code> <code class="s1">'success'</code><code class="p">,</code>
          <code class="nx">intro</code><code class="o">:</code> <code class="s1">'Thank you!'</code><code class="p">,</code>
          <code class="nx">message</code><code class="o">:</code> <code class="s1">'You have now been signed up for the newsletter.'</code><code class="p">,</code>
        <code class="p">};</code>
        <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="mi">303</code><code class="p">,</code> <code class="s1">'/newsletter/archive'</code><code class="p">)</code>
    <code class="p">})</code>
<code class="p">})</code></pre>

<p>Note that we’re careful to distinguish between input validation and database
errors. Remember that even if we do input validation on the frontend (and
you should), you should also perform it on the backend, because malicious
users can circumvent frontend validation.</p>

<p>Flash messages are a great mechanism to have available in your website,
even if other methods are more appropriate in certain areas (for example,
flash messages aren’t always appropriate for multiform “wizards” or
shopping cart checkout flows). Flash messages are also great during
development, because they are an easy way to provide feedback, even if you
replace them with a different technique later. Adding support for flash
messages is one of the first things I do when setting up a website, and
we’ll be using this technique throughout the rest of the book.</p>
<div data-type="tip"><h6>Tip</h6>
<p><a data-type="indexterm" data-primary="res.locals.flash object" id="idm45053589975208"/>Because the flash message is being transferred from
the session to <code>res.locals.flash</code> in middleware,
you have to perform a redirect for the flash message to be displayed.
If you want to display a flash message without redirecting, set
<code>res.locals.flash</code> instead of <code>req.session.flash</code>.</p>
</div>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The example in this chapter used browser form submission with redirects
because the use of sessions to control UI like this is typically not used
in applications that use Ajax for form submission. In that event, you
would want to indicate any errors in the JSON returned from the form
handler and have the frontend modify the DOM to dynamically display error
messages. That’s not to say that sessions aren’t useful for frontend
rendered applications, but they are seldom used for this purpose.<a data-type="indexterm" data-startref="ix_ch-09-cookies_and_sessions-asciidoc3" id="idm45053589758152"/><a data-type="indexterm" data-startref="ix_ch-09-cookies_and_sessions-asciidoc2" id="idm45053589757480"/></p>
</div>
</div></section>













<section data-type="sect1" data-pdf-bookmark="What to Use Sessions For"><div class="sect1" id="idm45053590143736">
<h1>What to Use Sessions For</h1>

<p><a data-type="indexterm" data-primary="sessions" data-secondary="uses for" id="idm45053589755576"/>Sessions are useful whenever you want to save a user preference that
applies across pages. Most commonly,
sessions are used to provide user authentication information: you log in,
and a session is created. After that, you don’t have to log in again every
time you reload the page. Sessions can be useful even without user
accounts, though. It’s quite common for sites to remember how you like
things sorted or what date format you prefer—all without your having to
log in.</p>

<p>While I encourage you to prefer sessions over cookies, it’s important to
understand how cookies work (especially because they enable sessions to
work). It will help you with diagnosing
issues and understanding the security and privacy considerations of your
application.<a data-type="indexterm" data-startref="ix_ch-09-cookies_and_sessions-asciidoc1" id="idm45053589753304"/></p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="idm45053589752328">
<h1>Conclusion</h1>

<p>Understanding cookies and sessions gives us a better understanding of how
web applications maintain the illusion of state when the underlying
protocol (HTTP) is stateless. We learned techniques for handling cookies
and sessions to control the user’s experience.</p>

<p>We’ve also been writing middleware as we went along without too much
explanation of middleware. In the next chapter, we’re going to dive into
middleware and learn everything there is to know about it!</p>
</div></section>







</div></section></div>



  </body></html>