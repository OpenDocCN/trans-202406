<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 23. Monitoring the MySQL Server"><div class="chapter" id="nch-monitoring"><h1><span class="label">Chapter 23. </span>Monitoring the MySQL Server</h1><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45820313484928"><h5>A note for Early Release readers</h5><p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p></div></aside><section data-type="sect1" data-pdf-bookmark="23.0 Introduction"><div class="sect1" id="nch-monitoring-monitoring-intro"><h1>23.0 Introduction</h1><p>This chapter covers how to monitor the MySQL Server using various
    command line tools:</p><ul><li><p>The mysqladmin interface</p></li><li><p>System variables</p></li><li><p>Status variables</p></li><li><p>Information and Performance Schemas</p></li><li><p>Storage engines diagnostics</p></li><li><p>Log files</p></li></ul><p>This chapter doesn’t cover managing administrative tasks. Instead,
    it focuses on the server’s observability. Administrators or developers
    should evaluate outcomes from various command line tools on the MySQL server
    carefully before taking action and modifying configuration changes listed
    in <a data-type="xref" href="ch22.xhtml#nch-admin">Chapter 22</a>. Rather it discusses what you can find out, 
    and how, by surveying the types of information available and how to use 
    that information to answer questions. The purpose is not so much to 
    consider specific monitoring problems to illustrate your options so you 
    can begin to answer your questions, whatever they are. In the case of reactive 
    monitoring on an issue, follow one of the below options.</p><ol><li><p>Determine which of the available information sources pertain
          to the problem at hand.</p></li><li><p>Choose an approach for using the information: Are you asking a
          one-time question? If so, maybe a few interactive queries are
          sufficient. If you’re trying to solve an issue that may recur or for
          which you need continuous monitoring, a program-oriented approach is
          better. Will a script written entirely in SQL do the job, or do you
          need to write a program that queries the server and performs
          additional manipulation of the information obtained? (This is
          typical for operations that cannot be done in pure SQL, that have
          special output formatting requirements, and so forth.) If a task
          must run periodically, maybe you need to set up a scheduled event or
          <span class="command"><em>cron</em></span> job. For browser display,
          write a web script.</p></li></ol><div data-type="note" epub:type="note"><h6>Note</h6><p>Some of the techniques shown here require administrative access,
      such as accessing log files in operating system <code>MySQL</code> or use statements that require the
      <code>SUPER</code> privilege. For this reason, to
      carry out the operations described here, you’ll likely need to connect
      to the server as <code>root</code> rather than as
      <code>cbuser</code> or grant SUPER to cbuser.
      MySQL installation created ‘root'@'localhost’ superuser account that 
      has all privileges as the database user.</p></div></div></section><section data-type="sect1" data-pdf-bookmark="23.1 Why Monitor MySQL Server?"><div class="sect1" id="nch-monitoring-monitoring-monitor"><h1>23.1 Why Monitor MySQL Server?</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820313473680"><h2>Problem</h2><p>You want to monitor the server to capture its state, which allows
      you to verify or change settings explained in <a data-type="xref" href="ch22.xhtml#nch-admin">Chapter 22</a> . Knowing the state of MySQL server’s wait events
      and status counters reveals so much information about the server limits.
      Wait events are performance indicators of the server. Monitoring can be
      utilized in two different areas. The most common reasons for monitoring
      needs are troubleshooting errors, crashes or failures. The others may
      include better utilization of hardware layer used for available
      resources such as memory, I/O subsystem, CPU utilization and network
      bandwidth. Due to hardware limitations MySQL can suffer significant
      degradation in performance hence hardware plays important role in
      database operations.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820313471808"><h2>Solution</h2><p>To monitor MySQL server use built-in functionality of MySQL client
      with the power of other built in tools like mysaladmin.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820313470928"><h2>Discussion</h2><p>As your MySQL server runs, you want to learn if underlying
      hardware performing well with your needs.</p><section data-type="sect3" data-pdf-bookmark="Operating System"><div class="sect3" id="idm45820313469920"><h3>Operating System</h3><p>Before getting into MySQL specific monitoring and
        troubleshooting it’s recommended to verify Operating System (OS)
        vitals accordingly. In four main categories Memory, Input/Output
        (I/O), CPU and Network resources can be considered major impacts to
        MySQL’s operational behaviour.</p><section data-type="sect4" data-pdf-bookmark="Memory Utilization"><div class="sect4" id="idm45820313469040"><h4>Memory Utilization</h4><p> Memory utilization of <em>mysqld</em> can be 
          checked via the OS command line. It’s essential to have a dedicated 
          MySQL host for each server; hence there’s no race for OS resources, 
          including memory. The rule of thumb is to have up to %80 memory 
          allocated for a dedicated MySQL server, but you must check your 
          workload and data size to calculate the memory needed.</p><pre data-type="programlisting">$ <strong><code>sudo pmap $(pidof mysqld) |grep total</code></strong>
 total          1292476K</pre><p>You may confirm this via <em>sys </em>schema using
          <span class="command"><em>mysql</em></span> client.</p><pre data-type="programlisting">mysql&gt; <strong><code>USE sys</code></strong>
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; <strong><code>SELECT * FROM memory_global_total;</code></strong>
+-----------------+
| total_allocated |
+-----------------+
| 476.81 MiB      |
+-----------------+
1 row in set (0.00 sec)</pre><p>Also watch out for Virtual Memory utilization and make sure
          your host OS is not swapping in the first place.</p><pre data-type="programlisting">$ <strong><code>free -m</code></strong>
              total        used        free      shared  buff/cache   available
Mem:           1993         453         755           5         784        1382
Swap:           979           0         979


$ <strong><code>cat /proc/$(pidof mysqld)/status | grep Swap</code></strong>
VmSwap:	       0 kB</pre><p>The following OS configuration regarding memory utilization is
          crucial to MySQL’s memory allocation. Make sure these to have been
          configured accordingly.</p><dl><dt>swappiness</dt><dd><p>This is a concept of allowing physical memory
              to be moved to a swap area by kernel. It’s recommended to set this
              value to 1 (one) hence allow kernel to perform minimum amount of
              swapping.</p><pre data-type="programlisting">$ <strong><code>sudo sysctl vm.swappiness=1</code></strong>
vm.swappiness = 1</pre></dd><dt>NUMA</dt><dd><p>This is a concept of balancing memory between each
              CPU cores. MySQL 8 supports enabling <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_numa_interleave">NUMA</a>
              interleaved mode when multiple cores are available. This value
              is OFF by default. By enabling NUMA to interleave mode operating
              system, allocated memory to be balanced amongst CPU cores for
              better utilization.</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GLOBAL VARIABLES LIKE "innodb_numa_interleave";</code></strong>
+------------------------+-------+
| Variable_name          | Value |
+------------------------+-------+
| innodb_numa_interleave | ON    |
+------------------------+-------+
1 row in set (0.00 sec)</pre></dd><dt>OOM killer</dt><dd><p>In Linux systems, MySQL generally has a concept 
      called Out of Memory killer controlled by the kernel. This is to 
      prevent the possible runaway process in Operating Systems to avoid 
      race conditions and a server crash. Since MySQL and its optimized 
      memory buffers are memory hogs, the Operating System may often kill 
      the mysqld process to avert a system-wide crash if not adjusted. As we 
      mentioned earlier, we can control how much memory MySQL should allocate 
      from the operating system. Still, if OOM kicks in, it’s possible to 
      configure on system level or altogether disable (not recommended).</p><pre data-type="programlisting">$ <strong><code>pidof mysqld</code></strong>
25046
$ <strong><code>sudo cat /proc/25046/oom_score</code></strong>
34
$ <strong><code>sudo echo -100 &gt; /proc/24633/oom_score_adj</code></strong>
$ <strong><code>sudo cat /proc/24633/oom_score</code></strong>
0</pre></dd><dt>File System Cache</dt><dd><p>Operating systems will use cache for
              all memory operations, while MySQL has it’s own optimized caches
              including InnoDB Buffer Pool. Since there is no need to cache
              data twice we opt out of using File System Cache by setting
              innodb_flush_method to O_DIRECT and its
              value needs to be changed at startup.</p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>While O_DIRECT flush method works with most
                installations, it does not work well with all storages
                subsystems. You may need to test it before setting this
                value.</p></div><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GLOBAL VARIABLES LIKE "innodb_flush_method";</code></strong>
+---------------------+-------+
| Variable_name       | Value |
+---------------------+-------+
| innodb_flush_method | fsync |
+---------------------+-------+
1 row in set (0.00 sec)</pre></dd></dl></div></section><section data-type="sect4" data-pdf-bookmark="I/O Utilization"><div class="sect4" id="idm45820313450848"><h4>I/O Utilization</h4><p>I/O performance is vital for MySQL Database. Data is read from
          disks and written back causes I/O operation. Depending on the
          available buffers’ size, all the data processed within buffers
          eventually flushed to disk, which is a very costly operation in
          terms of data transfer. Although the data is cached at the very best
          has to be flushed to the disk regularly. Also, large data sets that
          don’t fit in the memory will have to be read from disks. In modern
          hardware, we do benefit from Solid State. Disks (SSD) for better
          performance, but it’s beneficial to know where the underlying
          bottlenecks are. You may use <span class="command"><em>iotop</em></span> to observe the I/O impact per
          process on the system; hence may drill down each method for a
          specific operation. </p><div data-type="note" epub:type="note"><h6>Note</h6><p>You can use the <em>iotop</em> utility 
              interactively to monitor I/O operations. In this example we see 
              disk activity for one of the MySQL threads.</p></div><p> </p><pre data-type="programlisting">$ <strong><code>sudo iotop --only</code></strong>
Total DISK READ : 2.93 M/s | Total DISK WRITE : 9.24 M/s 
Actual DISK READ: 2.93 M/s | Actual DISK WRITE: 12.01 M/s 
TID PRIO USER DISK READ DISK WRITE SWAPIN IO&gt; COMMAND 
10692 be/4 vagrant 0.00 B/s 0.00 B/s 0.00 % 56.11 % mysqld --defaults-file=/home/sandboxes
~-socket=/tmp/mysql_sandbox8021.sock --port=8021 
10684 be/4 vagrant 0.00 B/s 0.00 B/s 0.00 % 53.33 % mysqld --defaults-file=/home/sandboxes
~-socket=/tmp/mysql_sandbox8021.sock --port=8021 
10688 be/4 vagrant 0.00 B/s 6.96 M/s 0.00 % 30.12 % mysqld --defaults-file=/home/sandboxes
~-socket=/tmp/mysql_sandbox8021.sock --port=8021 
10685 be/4 vagrant 0.00 B/s 0.00 B/s 0.00 % 26.89 % mysqld --defaults-file=/home/sandboxes
~-socket=/tmp/mysql_sandbox8021.sock --port=8021 
 ...</pre><p>In the meantime we can check the process list from MySQL
          Command Line Interface to see what’s taking priority over other
          threads: </p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT THREAD_OS_ID, PROCESSLIST_ID, PROCESSLIST_USER, </code></strong>
    -&gt; <strong><code>PROCESSLIST_DB, PROCESSLIST_COMMAND</code></strong>
    -&gt; <strong><code>FROM performance_schema.threads WHERE PROCESSLIST_COMMAND IS NOT NULL;</code></strong>
+-------+-----+----------+--------------------+---------+
| TOSID | PID | PUSR     | PDB                | PCMD    |
+-------+-----+----------+--------------------+---------+
|  1964 |   5 | NULL     | NULL               | Sleep   |
|  1968 |   7 | NULL     | NULL               | Daemon  |
|  1971 |   8 | msandbox | performance_schema | Query   |
|  2003 |   9 | root     | test               | Execute |
|  2002 |  10 | root     | test               | Execute |
|  2004 |  11 | root     | test               | Execute |
|  2001 |  12 | root     | test               | Execute |
|  2000 |  13 | root     | test               | Execute |
+-------+-----+----------+--------------------+---------+
8 rows in set (0.00 sec)</pre><p> Also we can pin point the process id to identify details
          about the query for this example. </p><pre data-type="programlisting">mysql&gt; <strong><code>EXPLAIN FOR CONNECTION 10\G</code></strong>
*************************** 1. row ***************************
           id: 1
  select_type: INSERT
        table: sbtest25
   partitions: NULL
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: NULL
     filtered: NULL
        Extra: NULL
1 row in set (0.00 sec)</pre><p>We can also gather further information about this
          thread from performance_schema by querying
          ‘table_io_waits_summary_by_table’ which aggregates all table I/O
          wait events, as generated by the wait/io/table/sql/handler
          instrument.</p><p>
             The <code>table_io_waits_summary_by_table</code> table has the following columns to indicate how the table aggregates events: <code>OBJECT_TYPE</code>, <code>OBJECT_SCHEMA</code>, and <code>OBJECT_NAME</code>. 
             These columns have the same meaning as in the <code>events_waits_current</code> table. They identify the table to which the row applies. 
            
             This table also contains information on following groups:
              </p><dl><dt><code>COUNT_*</code></dt><dd><p>How many times a user requested reads/writes/waits from this table.</p></dd><dt><code>SUM_*</code></dt><dd><p>How many reads/writes in total requests from this table.</p></dd><dt><code>MIN_*/MAX_*/AVG_*</code></dt><dd><p>Minimum, maximum and average values for this table.</p></dd></dl><p>
             </p><pre data-type="programlisting"> mysql&gt; <strong><code>SELECT * FROM performance_schema.table_io_waits_summary_by_table </code></strong>
    -&gt; <strong><code>WHERE object_schema='test' AND object_name='sbtest25'\G</code></strong>
*************************** 1. row ***************************
     OBJECT_TYPE: TABLE
   OBJECT_SCHEMA: test
     OBJECT_NAME: sbtest25
      COUNT_STAR: 3200367
  SUM_TIMER_WAIT: 1970633326256
  MIN_TIMER_WAIT: 1505980
  AVG_TIMER_WAIT: 615412
  MAX_TIMER_WAIT: 2759234856
      COUNT_READ: 3200367
  SUM_TIMER_READ: 1970633326256
  MIN_TIMER_READ: 1505980
  AVG_TIMER_READ: 615412
  MAX_TIMER_READ: 2759234856
     COUNT_WRITE: 0
 SUM_TIMER_WRITE: 0
 MIN_TIMER_WRITE: 0
 AVG_TIMER_WRITE: 0
 MAX_TIMER_WRITE: 0
     COUNT_FETCH: 3200367
 SUM_TIMER_FETCH: 1970633326256
 MIN_TIMER_FETCH: 1505980
 AVG_TIMER_FETCH: 615412
 MAX_TIMER_FETCH: 2759234856
    COUNT_INSERT: 0
...</pre><p>This table is also used by the <code>schema_table_statistics%</code> views in <em>sys</em> schema. (For further reading, please refer to the documentation at 
            <a href="https://dev.mysql.com/doc/mysql-perfschema-excerpt/5.6/en/performance-schema-table-io-waits-summary-by-table-table.html">table_io_waits_summary_by_table</a>
)</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * FROM sys.schema_table_statistics </code></strong>
    -&gt; <strong><code>WHERE table_schema="test" AND table_name="sbtest23"\G</code></strong>
*************************** 1. row ***************************
     table_schema: test
       table_name: sbtest23
    total_latency: 14.46 s
     rows_fetched: 8389964
    fetch_latency: 14.46 s
    rows_inserted: 0
   insert_latency: 0 ps
     rows_updated: 0
   update_latency: 0 ps
     rows_deleted: 0
   delete_latency: 0 ps
 io_read_requests: 3006
          io_read: 46.97 MiB
  io_read_latency: 19.48 ms
io_write_requests: 737
         io_write: 11.61 MiB
 io_write_latency: 21.09 ms
 io_misc_requests: 284
  io_misc_latency: 1.72 s
1 row in set (0.01 sec)</pre><p>
</p></div></section><section data-type="sect4" data-pdf-bookmark="Network Utilization"><div class="sect4" id="idm45820313431792"><h4>Network Utilization</h4><p>The network is also very important part of database configuration.
          Often times test and development systems run on local configuration
          which omits network hops between the nodes. If MySQL is
          running on a dedicated host all request to the database will be coming to
          via application layer or proxy server. Since monitoring requires
          continuous data flow it’s better to utilize a tool that has time
          series historical data at any given time for at least 30 days worth
          of data to analyze. For this we highly recommend <a href="https://www.percona.com/software/database-tools/percona-monitoring-and-management">Percona
          Monitoring and Management (PMM)</a>
          for monitoring network utilization, as shown in <a data-type="xref" href="#pmm_network_img">Figure 23-1</a></p><figure style="float: 0"><div id="pmm_network_img" class="figure"><img src="Images/msc4_2301.png" width="600" height="273"/><h6><span class="label">Figure 23-1. </span>Percona Monitoring and Management - MySQL Instance Summary</h6></div></figure></div></section></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.2 Discovering Sources of MySQL Monitoring Information"><div class="sect1" id="nch-monitoring-monitoring-sources"><h1>23.2 Discovering Sources of MySQL Monitoring Information</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820313427456"><h2>Problem</h2><p>You want to check how the server is operating with available resources.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820313426576"><h2>Solution</h2><p>Let the server tell you about itself using built-in
      utilities.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820313425696"><h2>Discussion</h2><p>As your MySQL server runs, you’ll have questions about aspects of its operation
      or performance. Or maybe it’s <em>not</em> running and you
      want to know why.</p><p>To find out what information sources are available so that 
        you can evaluate which are applicable and how usable they are for 
        particular questions, here are few built-in utilities and information 
        resources to check:</p><ul><li><p>System variables tell you how the server is configured. (<a data-type="xref" href="ch22.xhtml#nch-admin-server-config">Recipe 22.1</a> covers how to check these
          values.)</p></li><li><p>Status variables provide information about operations the server is
          performing, such as number of statements executed, number of disk
          accesses, memory use, or cache efficiency. Status information can
          help indicate when configuration changes are needed, such as
          increasing the size of a too-small buffer to improve performance, or
          decreasing the size of an underused resource to reduce the server’s
          memory footprint.</p></li><li><p>The Performance Schema is designed for monitoring and provides
          a wealth of measurements, from high-level information such as which
          clients are connected down to fine-grained information such as which
          locks a statement holds or which files it has open. The Performance
          Schema is enabled by default since MySQL 5.7. For prior versions to
          use the Performance Schema, it must be enabled. To enable it
          explicitly at server startup, use this configuration setting:</p><pre data-type="programlisting">[mysqld]
performance_schema=1</pre></li><li><p><code>As Performance Schema </code>
          focuses on performance data of the MySQL Server and can be used
          similarly for highly specific or complex queries, including joins.It
          also helps to clarify everything runtime</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT EVENT_NAME, COUNT_STAR</code></strong>
    -&gt; <strong><code>FROM performance_schema.events_waits_summary_global_by_event_name</code></strong>
    -&gt; <strong><code>ORDER BY COUNT_STAR DESC LIMIT 10;</code></strong>
+---------------------------------------+------------+
| EVENT_NAME                            | COUNT_STAR |
+---------------------------------------+------------+
| wait/io/file/innodb/innodb_log_file   |       6439 |
| wait/io/file/innodb/innodb_data_file  |       5994 |
| idle                                  |       5309 |
| wait/io/table/sql/handler             |       3263 |
| wait/io/file/innodb/innodb_dblwr_file |       1356 |
| wait/io/file/sql/binlog               |        798 |
| wait/lock/table/sql/handler           |        683 |
| wait/io/file/innodb/innodb_temp_file  |        471 |
| wait/io/file/sql/io_cache             |        203 |
| wait/io/file/sql/binlog_index         |         75 |
+---------------------------------------+------------+
10 rows in set (0.16 sec)</pre></li><li><p>Sys schema is a unique schema that does not contain physical 
          tables but views and stored routines over Performance Schema tables. 
          Performance Schema provides memory instrumentation information that 
          could be much easier accessed by using views in <em>SYS</em> 
          schema.  For memory usage, it is much easier to use <em>SYS</em> 
          schema; therefore, we recommend using five views that provide 
          memory allocation details. </p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW TABLES like "memory%";</code></strong>	
+-----------------------------------+
| Tables_in_sys (memory%)           |
+-----------------------------------+
| memory_by_host_by_current_bytes   |
| memory_by_thread_by_current_bytes |
| memory_by_user_by_current_bytes   |
| memory_global_by_current_bytes    |
| memory_global_total               |
+-----------------------------------+
5 rows in set (0.00 sec)</pre></li><li><p><code>SHOW</code> statements and tables in the <code>PERFORMANCE_SCHEMA</code> database provide information ranging from processes running in
          the server to active storage engines and plug-ins to system and
          status variables. In many cases, these two sources provide the same
          or similar information, but in different display formats. (For
          example, the <code>SHOW</code> <code>PLUGINS</code> statement and the <code>PLUGINS</code>
          table are related.) Familiarity with both sources helps you choose
          which is more usable in a given situation:</p><ul><li><p>For interactive use, <code>SHOW</code> is often more convenient because
              it involves less typing than <code>PERFORMANCE_SCHEMA</code> queries. Compare
              these two statements, which produce the same result:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SHOW</code> <code class="k">GLOBAL</code> <code class="n">STATUS</code> <code class="k">LIKE</code> <code class="s1">'Threads_connected'</code><code class="p">;</code></pre><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="n">VARIABLE_VALUE</code> <code class="k">FROM</code> <code class="n">PERFORMANCE_SCHEMA</code><code class="p">.</code><code class="n">GLOBAL_STATUS</code>
<code class="k">WHERE</code> <code class="n">VARIABLE_NAME</code> <code class="o">=</code> <code class="s1">'Threads_connected'</code><code class="p">;</code></pre></li><li><p><code>INFORMATION_SCHEMA</code>
              queries use <code>SELECT</code>,
              which is more expressive than <code>SHOW</code> and can be used for highly
              specific or complex queries, including joins.</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="n">t</code><code class="p">.</code><code class="n">table_schema</code><code class="p">,</code> <code class="n">t</code><code class="p">.</code><code class="k">table_name</code><code class="p">,</code> <code class="k">c</code><code class="p">.</code><code class="k">column_name</code>
  <code class="k">FROM</code> <code class="n">information_schema</code><code class="p">.</code><code class="n">tables</code> <code class="n">t</code><code class="p">,</code>
       <code class="n">information_schema</code><code class="p">.</code><code class="n">columns</code> <code class="k">c</code>
  <code class="k">WHERE</code> <code class="n">t</code><code class="p">.</code><code class="n">table_schema</code> <code class="o">=</code> <code class="k">c</code><code class="p">.</code><code class="n">table_schema</code>
        <code class="k">AND</code> <code class="n">t</code><code class="p">.</code><code class="k">table_name</code> <code class="o">=</code> <code class="k">c</code><code class="p">.</code><code class="k">table_name</code>
        <code class="k">AND</code> <code class="n">t</code><code class="p">.</code><code class="n">engine</code><code class="o">=</code><code class="s1">'InnoDB'</code><code class="p">;</code></pre></li><li><p><code>SHOW</code> output cannot be
              saved using only SQL. Should you require further processing of
              an <code>PERFORMANCE_SCHEMA</code> query
              result, you can use <code>INSERT</code>
              <code>INTO</code> … <code>SELECT</code> to save the results in a table
              for further analysis (see <a data-type="xref" href="ch06.xhtml#nch-tblmgmt-tblmgmt-into-table">Recipe 6.2</a>). To obtain an
              individual value, assign a scalar subquery result to a
              variable:</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SET</code><code> </code><code class="o">@</code><code class="n">queries</code><code> </code><code class="o">=</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="k">SELECT</code><code> </code><code class="n">VARIABLE_VALUE</code><code> </code><code class="k">FROM</code><code> </code><code class="n">PERFORMANCE_SCHEMA</code><code class="p">.</code><code class="n">GLOBAL_STATUS</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">VARIABLE_NAME</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Queries'</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">@</code><code class="n">queries</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----------+
</code><code class="o">|</code><code> </code><code class="o">@</code><code class="n">queries</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------+
</code><code class="o">|</code><code> </code><code class="mi">5338</code><code>     </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre></li></ul></li><li><p>Some storage engines make information available about
          themselves. InnoDB, for example, has its own system and status
          variables. It also provides its own <code>INFORMATION_SCHEMA</code> tables and a set of
          InnoDB Monitors. The <code>INFORMATION_SCHEMA</code> tables provide more
          structured information, and are thus more amenable to analysis using SQL, if
          they contain the information you want. To see which InnoDB-related
          tables are available, use this statement:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SHOW</code> <code class="n">TABLES</code> <code class="k">FROM</code> <code class="n">INFORMATION_SCHEMA</code> <code class="k">LIKE</code> <code class="s1">'innodb%'</code><code class="p">;</code></pre><p>The Monitors produce unstructured output. You can eyeball it,
          but for programmatic use, you must parse or extract the information
          somehow. In some cases, a simple <span class="command"><em>grep</em></span> command might suffice:</p><pre data-type="programlisting">$ <strong><code>mysql -E -e "SHOW ENGINE INNODB STATUS" | grep "Free buffers"</code></strong>
Free buffers       4733</pre></li><li><p>Server logs provide several types of information. Here are
          some suggestions for using them:</p><ul><li><p>The error log alerts you to severe problems the server
              encounters. It’s most suited to visual inspection because
              messages can originate from anywhere in the server and there is
              no fixed format to aid programmatic analysis. It’s often only
              the last part of the file that’s of interest, anyway, because
              you typically check this file to find the reason for the most
              recent problems. These problems may include corrupted table
              causing crash or even related to <span class="command"><em>mysql_upgrade</em></span> not ran further
              causing issues.</p></li><li><p>The general query log  indicates what queries clients are running. It
              can aid in assessing the nature of the server’s workload. It is
              the only log that captures everything; hence care must be taken
              when enabling this log. Depending on the server’s activity, it
              may fill up disk space quickly and cause very heavy I/O, making
              things worse while monitoring MySQL. A suggestion is to enable
              online when needed and disable afterward.</p></li><li><p>The slow log contains queries that may be inefficient. It can
              help you find candidates for optimization.</p></li></ul><p>The server is able to write the general query and slow query
          logs to files, tables, or both. Log tables facilitate analysis
          better than the files; they are more structured and hence subject to
          analysis using SQL statements. The contents are also easier to
          interpret. Each query row in the <code>general_log</code> table shows the user
          associated with it. With the logfile, users are named only on
          connection lines. To identify a user’s queries, you must extract the
          connection ID from the connection line and look for subsequent query
          lines with the same ID.</p><p>In addition, log tables are managed by the CSV storage engine,
          so the table datafiles are written in comma-separated values format.
          Look in the <em class="filename">mysql</em> directory
          under the server’s data directory for files named <em class="filename">general_log.CSV</em> and <em class="filename">slow_log.CSV</em>. You can process them with
          tools that read CSV files.</p><p>To get information from a log, it must be enabled (see <a data-type="xref" href="ch22.xhtml#nch-admin-server-logs">Recipe 22.3</a> for instructions).</p></li><li><p>The <code>EXPLAIN</code> statement
          can be useful for checking long-running queries.
          Although <code>EXPLAIN</code> is most often
          used to see execution plans for prospective queries, MySQL 5.7.2 and
          up has the capability of using <code>EXPLAIN</code> to examine queries currently
          executing in other sessions. If a query seems to be stuck, this may
          help you understand why. Use <code>SHOW</code> <code>PROCESSLIST</code> or the <code>INFORMATION_SCHEMA</code> <code>PROCESSLIST</code> table to determine the
          connection ID of the session running the problem query, then point
          <code>EXPLAIN</code> at it:</p><pre data-type="programlisting" data-code-language="sql">EXPLAIN FOR CONNECTION <em><code>connection_id</code></em>;</pre><p><code>EXPLAIN</code> can produce output
          in tabular, tree or <code>JSON</code> format.
          The latter can be parsed and manipulated by standard JSON modules in
          your programming language of choice.</p></li></ul></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.3 Checking Server Uptime and Progress"><div class="sect1" id="nch-monitoring-monitoring-uptime"><h1>23.3 Checking Server Uptime and Progress</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820313118416"><h2>Problem</h2><p>You want to know if the server is running, and if so, how long it has been up.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820313117536"><h2>Solution</h2><p>Use mysqladmin and MySQL CLI utilities to find out if it’s
      up.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820313116656"><h2>Discussion</h2><p>To tell whether the server is running, just try connecting to it.
      If the connection succeeds or you get an error that’s from the server
      itself, the server is up. <span class="command"><em>mysqladmin</em></span>
      <code class="option">ping</code> is a good choice here, for interactive use or from
      within shell scripts. This result indicates the server is running
      although you should be alerted by the monitoring system that server is
      down::
      </p><pre data-type="programlisting">$ <strong><code>mysqladmin ping</code></strong>
mysqld is alive</pre><p>This connection attempt fails, but the server itself returns the
      second error message, so it’s not down:</p><pre data-type="programlisting">$ <strong><code>mysqladmin -u baduser ping</code></strong>
mysqladmin: connect to server at '127.0.0.1' failed
error: 'Access denied for user 'baduser'@'localhost' (using password: YES)'</pre><p>This result indicates complete connection failure; the server is
      down:</p><pre data-type="programlisting">$ <strong><code>mysqladmin ping</code></strong>
mysqladmin: connect to server at '127.0.0.1' failed
error: 'Can't connect to MySQL server on '127.0.0.1' (61)'</pre><p>If the server is not up, check the error log to find out
      why.</p><p>If the server is up, its uptime (in seconds) can be determined
      multiple ways:</p><ul><li><p>Use <span class="command"><em>mysqladmin</em></span>
          <code class="option">status</code>:</p><pre data-type="programlisting">$ <strong><code>mysqladmin status</code></strong>
Uptime: 22158655  Threads: 2  Questions: 65733141  Slow queries: 34
Opens: 6570  Flush tables: 1  Open tables: 95  Queries per second
avg: 2.966</pre><p>A disadvantage of this approach for programmatic use is that
          you must parse the output to extract the value of interest.</p></li><li><p>Examine the <code>Uptime</code> status
          variable:</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SHOW</code><code> </code><code class="k">GLOBAL</code><code> </code><code class="n">STATUS</code><code> </code><code class="k">LIKE</code><code> </code><code class="s1">'Uptime'</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">---------------+---------+
</code><code class="o">|</code><code> </code><code class="n">Variable_name</code><code> </code><code class="o">|</code><code> </code><code class="n">Value</code><code>   </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">---------------+---------+
</code><code class="o">|</code><code> </code><code class="n">Uptime</code><code>        </code><code class="o">|</code><code> </code><code class="mi">1640724</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">---------------+---------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p> Use built-in CLI command to show status of the current connection </p><pre data-type="programlisting">mysql&gt; <strong><code>\status</code></strong>
...
Uptime:			18 days 23 hours 45 min 43 sec
...
--------------</pre></li></ul><p>A server not running is obviously cause for concern. But there may
      be issues even if it is running. If you frequently find that server
      uptime resets in the absence of scheduled restarts, something may be
      causing the server to exit, and you should investigate. Again, check the
      error log to see why.</p><p>As your MySQL server runs, you’ll have questions about aspects of its operation
      or performance. Or maybe it’s <em>not</em> running and you
      want to know why.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.4 Troubleshooting Server Start Problems"><div class="sect1" id="idm45820313116352"><h1>23.4 Troubleshooting Server Start Problems</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820313063664"><h2>Problem</h2><p>The server quits shortly after it’s started, and you want to 
          know what caused it and what you can do about it.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820313062640"><h2>Solution</h2><p>Check the error log for details.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820313061728"><h2>Discussion</h2><p>If the server stops shortly after you start it, a likely cause
          is a misconfiguration in the server options file. The error log
          helps you here. But don’t be misled by mere warnings, which do not
          signify that the server quit. For example, the following message
          means only that <em>innodb_ft_min_token_size</em> 
          need be corrected to make the warning go away:</p><pre data-type="programlisting">2022-02-17T15:05:25.482596Z 0 [Warning] [MY-013746] 
          [Server] A deprecated TLS version TLSv1.1 is enabled for channel 
          mysql_main 2022-02-17T15:05:25.487543Z 0 [Warning] [MY-010068] 
          [Server] CA certificate ca.pem is self signed.</pre><p>Instead, check for [ERROR] lines, such as this:</p><pre data-type="programlisting">2022-02-17T15:05:25.495461Z 0 [ERROR] [MY-000067] 
      [Server] unknown variable 'innodb_ft_min_toke_size=2'.</pre><p>
      As you can see server is complaining about a typo <em>innodb_ft_min_token_size</em> 
      that preventing it to start properly.</p><p>Other server start problems are:</p><ul><li><p> Misconfiguration of my.cnf variables.</p></li><li><p> Multiple configuration files.</p></li><li><p> Missing operating system permissions.</p></li><li><p> Incorrect path setting.</p></li><li><p>Over allocating available memory.</p></li><li><p>Missing <code>mysql_upgrade</code> step after version upgrade.</p></li></ul><div data-type="note" epub:type="note"><h6>Note</h6><p>
                  As of version 8.0.16 <span class="command"><em>mysql_upgrade</em></span> is not needed anymore. But when upgrading to any version prior 8.0.16 you must run this utility.
                </p></div></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.5 Determining the IO Utilization of the MySQL Server"><div class="sect1" id="idm45820313024448"><h1>23.5 Determining the IO Utilization of the MySQL Server</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820313023760"><h2>Problem</h2><p>You want to know the number of queries hitting MySQL server.
            </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820313022848"><h2>Solution</h2><p>Check utilization status variables for details.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820313021840"><h2>Discussion</h2><p>This question might be prompted by simple curiosity, or
      there might be a performance issue. Monitoring statement execution over
      time and summarizing the results can reveal patterns, such as a time of
      day or day of the week when activity is cumbersome. Perhaps several
      report generators are configured to start at the same time. Staggering
      them will help your server by spreading the load. It is crucial to
      capture baseline data to compare several reads for a given period.
      </p><p>In programmatic context, you might write a
      long-running application that probes the server periodically for the
      <code>Queries</code> and <code>Uptime</code> values, to determine a running display
      of statement-execution activity. To avoid reconnecting each time you
      issue the statements, ask the server for its session timeout period and
      probe it at intervals shorter than that value. To get the session
      timeout value (in seconds), use this statement:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="o">@@</code><code class="n">wait_timeout</code><code class="p">;</code></pre><p>The
      default value is 28,800 (8 hours). If it’s configured to a value shorter
      than your desired probe interval, set it higher:</p><pre data-type="programlisting" data-code-language="sql">SET wait_timeout = <em><code>seconds</code></em>;</pre><p>The
      preceding discussion uses <code>Queries</code>,
      which indicates the total number of statements executed. Options for
      more fine-grained analysis are available.</p><p>The server maintains a set of <code>Com_</code><em><code>xxx</code></em>
            status variables that count executions of particular statements.
            For example, <code>Com_insert</code> and
            <code>Com_update</code> count <code>INSERT</code> and <code>UPDATE</code> statements, respectively.</p><pre data-type="programlisting"> mysql&gt; <strong><code>SHOW GLOBAL STATUS LIKE "Com_select";</code></strong>
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| Com_select    | 100   |
+---------------+-------+
1 row in set (0.00 sec)

mysql&gt; <strong><code>SHOW GLOBAL STATUS LIKE "Com_insert";</code></strong>
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| Com_insert    | 3922  |
+---------------+-------+
1 row in set (0.00 sec)</pre><p>After MySQL version 5.7, some of the instruments in 
       <code>information_schema</code> migrated to <code>performance_schema</code>; hence querying  
       <code>performance_schema</code> was advised for such monitoring.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>Since Performance Schema has comprehensive details about events, 
       it no longer has <em>Com Stats</em> values.</p></div><pre data-type="programlisting">mysql&gt; <strong><code>SELECT EVENT_NAME, COUNT_STAR</code></strong>
    -&gt; <strong><code>FROM performance_schema.events_statements_summary_global_by_event_name</code></strong>
    -&gt; <strong><code>WHERE EVENT_NAME LIKE 'statement/sql/%';</code></strong>
+-----------------------------------------------+------------+
| EVENT_NAME                                    | COUNT_STAR |
+-----------------------------------------------+------------+
| statement/sql/select                          |        106 |
...</pre><p>
      You also may want to calculate Innodb Buffer Pool Cache hit
      ratio to answer on a question how many requests to InnoDB could be resolved without disk access.</p><p>To answer the this
      question, use status variable information:</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GLOBAL STATUS LIKE 'innodb_buffer_pool_read%s';</code></strong>
+----------------------------------+----------+
| Variable_name                    | Value    |
+----------------------------------+----------+
| Innodb_buffer_pool_read_requests | 50350973 |
| Innodb_buffer_pool_reads         | 1622447  |
+----------------------------------+----------+
2 rows in set (0.00 sec)</pre><p>
        Status variable <code>Innodb_buffer_pool_read_requests</code> holds value of how many times SQL queries requested data from the InnoDB buffer pool. This value could be also understood as a number of queries to InnoDB. Variable <code>Innodb_buffer_pool_reads</code> holds the metric on how many such queries were resolved from the InnoDB buffer pool without touching tablespace files on the disk.
      </p><p><code>SHOW GLOBAL STATUS</code> counts the number of
      queries since server startup, but it’s a variable value. If you
      wait for certain amount of time and re-run the same query you’ll have a
      hit/ratio.</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GLOBAL STATUS LIKE 'innodb_buffer_pool_read%s';</code></strong>↩
<strong><code>SELECT SLEEP(60); SHOW GLOBAL STATUS LIKE 'innodb_buffer_pool_read%s';</code></strong>
+----------------------------------+----------+
| Variable_name                    | Value    |
+----------------------------------+----------+
| Innodb_buffer_pool_read_requests | 51504330 |
| Innodb_buffer_pool_reads         | 1830647  |
+----------------------------------+----------+
2 rows in set (0.00 sec)

+-----------+
| sleep(60) |
+-----------+
|         0 |
+-----------+
1 row in set (1 min 0.00 sec)

+----------------------------------+----------+
| Variable_name                    | Value    |
+----------------------------------+----------+
| Innodb_buffer_pool_read_requests | 53626254 |
| Innodb_buffer_pool_reads         | 2214763  |
+----------------------------------+----------+
2 rows in set (0.00 sec)</pre><p>
         In this example InnoDB received <code>53626254 - 51504330 = 2121924</code> requests for data, and was able to resolve <code>2214763 - 1830647 = 384116</code> requests using buffer only. Thus InnoDB buffer pool hit ratio is <code>384116 / 2121924 = 0.18</code>. This means that the server either just started and the InnoDB buffer pool does not contain active data set yet. Or it is too small and InnoDB has to purge pages from the buffer pool too often and then re-read them back. Ideally InnoDB buffer pool hit ratio should be near 1 (one).
       </p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>If you have OLTP in memory workload you may have %100 of
          queries in memory. The profile of the queries may change
          significantly which can make hit/ratio metric surrogate. It’s
          insufficient to just to monitor hit ratio for in memory
          operations.</p></div></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.6 Determining MySQL Thread’s CPU Utilization"><div class="sect1" id="nch-monitoring-monitoring-cpu"><h1>23.6 Determining MySQL Thread’s CPU Utilization</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820312972752"><h2>Problem</h2><p>
      You want to find the process causing high cpu utilization on your server. 
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820312971760"><h2>Solution</h2><p>
      Use <code>THREAD_OS_ID</code> value to corelate from 
      Performance Schema’s  <code>THREADS</code> table.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820312970080"><h2>Discussion</h2><p>
      The CPU utilization of the process is somewhat problematic in finding 
      slowness caused by an individual query. Sometimes this can be a runaway job
      or a running process for a large data set. You may see this type of 
      behavior on month ends where a query or a job runs only once a month to 
      process quarterly or statistical computation. 
      
      The <code>threads</code> table contains information about each
      thread created after server start. It contains whether the thread is 
      historical (if instrumented see <a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-thread-filtering.html">Pre-Filtering by Thread</a>.
      ). </p><pre data-type="programlisting">mysql&gt; <strong><code>DESC performance_schema.threads;</code></strong>
+---------------------+------------------+------+-----+---------+-------+
| Field               | Type             | Null | Key | Default | Extra |
+---------------------+------------------+------+-----+---------+-------+
| THREAD_ID           | bigint unsigned  | NO   | PRI | NULL    |       |
| NAME                | varchar(128)     | NO   | MUL | NULL    |       |
| TYPE                | varchar(10)      | NO   |     | NULL    |       |
| PROCESSLIST_ID      | bigint unsigned  | YES  | MUL | NULL    |       |
| PROCESSLIST_USER    | varchar(32)      | YES  | MUL | NULL    |       |
| PROCESSLIST_HOST    | varchar(255)     | YES  | MUL | NULL    |       |
| PROCESSLIST_DB      | varchar(64)      | YES  |     | NULL    |       |
| PROCESSLIST_COMMAND | varchar(16)      | YES  |     | NULL    |       |
| PROCESSLIST_TIME    | bigint           | YES  |     | NULL    |       |
| PROCESSLIST_STATE   | varchar(64)      | YES  |     | NULL    |       |
| PROCESSLIST_INFO    | longtext         | YES  |     | NULL    |       |
| PARENT_THREAD_ID    | bigint unsigned  | YES  |     | NULL    |       |
| ROLE                | varchar(64)      | YES  |     | NULL    |       |
| INSTRUMENTED        | enum('YES','NO') | NO   |     | NULL    |       |
| HISTORY             | enum('YES','NO') | NO   |     | NULL    |       |
| CONNECTION_TYPE     | varchar(16)      | YES  |     | NULL    |       |
| THREAD_OS_ID        | bigint unsigned  | YES  | MUL | NULL    |       |
| RESOURCE_GROUP      | varchar(64)      | YES  | MUL | NULL    |       |
+---------------------+------------------+------+-----+---------+-------+</pre><p>
      On Linux systems <code>THREAD_OS_ID</code> corresponds to the value
      of <code>gettid()</code> function. This value is exposed to 
      <code>top</code> or <code>proc</code> file system 
      (/proc/[pid]/task/[tid]). To help identify related <code>THREAD_OS_ID</code>
      there are few methods outside of scraping <code>proc</code> file 
      system by using built-in command line utilities. <code>ps -L aux</code> 
      gives enough detail with the corresponding thread using higher <code>CPU</code>
      then others. Parent id of MySQL <code>mysqld_pid</code> can also 
      be identified with <code>pidof mysqld</code> in conjunction with
      <code>ps</code> command:
      </p><pre data-type="programlisting">$ <strong><code> ps -L aux |grep -e PID -e `pidof mysqld`</code></strong>
      USER         PID     LWP %CPU NLWP %MEM    VSZ   RSS TTY      STAT START↩   
      TIME COMMAND
mysql     740282  740282  0.0   68 20.9 1336272 209440 ?      Rsl   2021   0:05 ↩
/usr/sbin/mysqld
mysql     740282  740285  0.0   68 20.9 1336272 209440 ?      Ssl   2021   1:50 ↩
/usr/sbin/mysqld
mysql     740282  740286  0.0   68 20.9 1336272 209440 ?      Ssl   2021   1:52 ↩
/usr/sbin/mysqld
mysql     740282  740287  0.0   68 20.9 1336272 209440 ?      Ssl   2021   1:53 ↩
/usr/sbin/mysqld
mysql     740282  740288  0.0   68 20.9 1336272 209440 ?      Ssl   2021   1:50 ↩
/usr/sbin/mysqld
....
mysql     740282 1353650  0.0   48 21.0 1336272 210456 ?      Ssl  09:35   0:00 ↩
/usr/sbin/mysqld
mysql     740282 1533749  6.6   48 21.0 1336272 210456 ?      Dsl  10:11   0:18 ↩
/usr/sbin/mysqld
mysql     740282 1558301  0.8   48 21.0 1336272 210456 ?      Ssl  10:15   0:00 ↩
/usr/sbin/mysqld
mysql     740282 1558459  1.0   48 21.0 1336272 210456 ?      Ssl  10:15   0:00 ↩
/usr/sbin/mysqld
mysql     740282 1559291  0.7   48 21.0 1336272 210456 ?      Ssl  10:15   0:00 ↩
/usr/sbin/mysqld</pre><p>This will give us the <em>thread_os_id</em> hint that we will use 
      to figure out what it is doing?</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * from performance_schema.threads </code></strong>
    -&gt; <strong><code>WHERE THREAD_OS_ID = 1533749 \G</code></strong>
mysql&gt; <strong><code>SELECT * FROM performance_schema.threads where THREAD_OS_ID = 1533749 \G</code></strong>
*************************** 1. row ***************************
          THREAD_ID: 213957
               NAME: thread/sql/one_connection
               TYPE: FOREGROUND
     PROCESSLIST_ID: 213905
   PROCESSLIST_USER: root
   PROCESSLIST_HOST: localhost
     PROCESSLIST_DB: mysqlslap
PROCESSLIST_COMMAND: Query
   PROCESSLIST_TIME: 0
  PROCESSLIST_STATE: waiting for handler commit
   PROCESSLIST_INFO: INSERT INTO t1 VALUES (964445884,
   'DPh7kD1E6f4MMQk1ioopsoIIcoD83DD8Wu7689K6oHTAjD3Hts6lYGv8x9G0EL0k87q8G2ExJ
   jz2o3KhnIJBbEJYFROTpO5pNvxgyBT9nSCbNO9AiKL9QYhi0x3hL9')
   PARENT_THREAD_ID: NULL
               ROLE: NULL
       INSTRUMENTED: YES
            HISTORY: YES
    CONNECTION_TYPE: Socket
       THREAD_OS_ID: 1533749
     RESOURCE_GROUP: USR_default</pre><p>The other alternative would be using 
      <code>pidstat</code> command (requires sysstat package). 
      First find the process id of <em>mysqld</em> and execute
      following:
      pidstat -t -p {mysqld_pid} 
      </p><pre data-type="programlisting">$ <strong><code>pidstat -t -p 740282</code></strong>
       Linux 5.8.0-63-generic (localhost)      01/02/2022      _x86_64_        (1 CPU)
       
06:57:13 PM   UID      TGID       TID    %usr %system  %guest   %wait    %CPU   CPU  
06:57:14 PM   113    740282         -   24.75   11.88    0.00    0.00   36.63     0  
06:57:14 PM   113         -    740282    0.00    0.00    0.00    0.00    0.00     0 
06:57:14 PM   113         -    740285    0.00    0.00    0.00    0.00    0.00     0  
....
06:57:19 PM   113         -    759641    0.00    0.00    0.00    0.00    0.00     0 
06:57:19 PM   113         -    839592    1.00    0.00    0.00    1.00    1.00     0 
06:57:19 PM   113         -    839647   17.00    4.00    0.00   14.00   21.00     0 
06:57:20 PM   113    740282         -   24.00   14.00    0.00    0.00   38.00     0 
06:57:20 PM   113         -    740282    0.00    0.00    0.00    0.00    0.00     0 
06:57:20 PM   113         -    740285    0.00    0.00    0.00    0.00    0.00     0  </pre><p>
      We can see in our test run a <em>thread_os_id</em> is consuming
      %21 of CPU from above output. In order to co-relate this with MySQL running
      threads we follow the <em>Performance Schema Query</em>.
      </p><p>
</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * from performance_schema.threads 
where THREAD_OS_ID = 839647 \G</code></strong>
*************************** 1. row ***************************
          THREAD_ID: 2326
               NAME: thread/sql/one_connection
               TYPE: FOREGROUND
     PROCESSLIST_ID: 2282
   PROCESSLIST_USER: root
   PROCESSLIST_HOST: localhost
     PROCESSLIST_DB: mysqlslap
PROCESSLIST_COMMAND: Query
   PROCESSLIST_TIME: 0
  PROCESSLIST_STATE: waiting for handler commit
   PROCESSLIST_INFO: INSERT INTO t1 VALUES (964445884,'DPh7kD1E6f4MMQk1ioopso
   IIcoD83DD8Wu7689K6oHTAjD3Hts6lYGv8x9G0EL0k87q8G2ExJjz2o3KhnIJBbEJYFROTpO5pN
   vxgyBT9nSCbNO9AiKL9QYhi0x3hL9')
   PARENT_THREAD_ID: NULL
               ROLE: NULL
       INSTRUMENTED: YES
            HISTORY: YES
    CONNECTION_TYPE: Socket
       THREAD_OS_ID: 839647
     RESOURCE_GROUP: USR_default</pre><p> 
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820312948576"><h2>See Also</h2><p>For additional information about <em>THREADS</em> table
       please refer <a href="https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/performance-schema-threads-table.html">The threads Table</a>.
      </p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.7 Determining If MySQL Has Reached Its Connection Limits"><div class="sect1" id="idm45820312946176"><h1>23.7 Determining If MySQL Has Reached Its Connection Limits</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820312945568"><h2>Problem</h2><p>You want to know the limits of the MySQL server handling
            connections</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820312944592"><h2>Solution</h2><p>Check the configuration parameters.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820312943600"><h2>Discussion</h2><p>It’s often the case that a server function is assessed
      using a combination of configuration settings plus current operational
      status. Typically, the former comes from system variables, whereas the
      latter comes from status variables. Connection management is an example
      of this concept. The <code>max_connections</code>
      system variable indicates the maximum number of simultaneous connections the server
      permits, and the <code>Threads_connected</code> status variable shows how
      many clients are currently connected and and the <code>Threads_running</code> status variable shows how
      many clients are currently active. Furthermore <code>Threads_running</code> is
      very important value for following reasons. </p><ul><li><p>If number of running threads increases above number of CPU cores
              they start to compete for CPU resources.</p></li><li><p>If two threads (no matter how many threads connected)
              compete for the same row, table or other database object,
              engine-level table lock set at the server level or metadata lock
              (MD) is in place. </p></li></ul><p>Since MySQL is a single process application with 
          multi-threaded architecture, each connection creates a 
          thread. To monitor maximum connections reached, issue the following
          command. </p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GLOBAL STATUS LIKE 'Max_used_connections';</code></strong>
+----------------------+-------+
| Variable_name        | Value |
+----------------------+-------+
| Max_used_connections | 6     |
+----------------------+-------+
1 row in set (0.00 sec)

mysql&gt; <strong><code>SHOW GLOBAL STATUS LIKE 'Max_used_connections_time';</code></strong>
+---------------------------+---------------------+
| Variable_name             | Value               |
+---------------------------+---------------------+
| Max_used_connections_time | 2020-12-27 17:09:59 |
+---------------------------+---------------------+
1 row in set (0.00 sec)

mysql  &gt; <strong><code>SHOW GLOBAL STATUS LIKE 'threads_connected';</code></strong>
+-------------------+-------+
| Variable_name     | Value |
+-------------------+-------+
| Threads_connected | 6     |
+-------------------+-------+
1 row in set (0.00 sec)</pre><p>If <code class="keep-together">threads_connected</code> is regularly close to
      the value of <code>max_connections</code>, you
      might need to bump up the value of the latter. If there is always a wide
      gap, you can decrease <code>max_connections</code>. 
      For further reading this post explains how
      MySQL handles connections and its capabilities please refer <a href="https://mysqlserverteam.com/mysql-connection-handling-and-scaling/">MySQL
      Connection Handling and Scaling</a>. </p><p>One area also impacts performance of MySQL is Mutex and Meta Data 
      Locks on highly concurrent environment. As seen above reading threads 
      at some point will start competing each other when same resources 
      requested from the database. The way InnoDB handles this is to put an 
      exclusive lock on particular memory resource that the other thread have 
      to wait for same resource. While this is handled with mutex operation 
      in MySQL all DDL (Data Definition Language) as known as table structure 
      change operations handled with Meta Data Locks.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.8 Verifying that the Buffer Pool Is Sized Properly"><div class="sect1" id="idm45820312933136"><h1>23.8 Verifying that the Buffer Pool Is Sized Properly</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820312932448"><h2>Problem</h2><p>You want to know the limits of the MySQL server handling
            connections.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820312931472"><h2>Solution</h2><p>Determine storage engine memory allocation.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820312930464"><h2>Discussion</h2><p>The InnoDB storage engine has a  data buffer. To keep physical I/O minimal, DBA should 
            make sure to utilize server memory efficiently. InnoDB Buffer 
            Cache improves index key lookups, and data read operations; hence 
            most data access will occur in memory.</p><p>To determine the cache sizes, check the relevant system
          variables:</p><pre data-type="programlisting">mysql&gt; <strong><code> SELECT @@innodb_buffer_pool_size;</code></strong>
+---------------------------+
| @@innodb_buffer_pool_size |
+---------------------------+
|                 134217728 |
+---------------------------+
1 row in set (0.00 sec)</pre><p>You can also use <code>SHOW</code> <code>VARIABLES</code> or the <code>PERFORMANCE_SCHEMA</code> <code>GLOBAL_VARIABLES</code> table. For
          example:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * from performance_schema.global_variables</code></strong>
    -&gt; <strong><code>WHERE variable_name='innodb_buffer_pool_size';</code></strong>
+-------------------------+----------------+
| VARIABLE_NAME           | VARIABLE_VALUE |
+-------------------------+----------------+
| innodb_buffer_pool_size | 134217728      |
+-------------------------+----------------+
1 row in set (0.00 sec)</pre><p>The efficiency measure that determines how well the read 
          ratio is operating is its hit rate: the rate at which read requests 
          from the InnoDB Buffer Pool are satisfied from the buffer pool 
          without reading data from disk. If data is in the cache, it’s a hit; 
          if not, it’s a miss. The hit ratio is a high correlation but not a 
          guaranteed metric; hence OLTP (Online Transaction Processing) rate 
          is more important. It’s also possible to verify how well the InnoDB 
          Buffer Pool is utilized from data via Performance Schema.</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT CONCAT(FORMAT(A.num * 100.0 / B.num,2),"%") BufferPoolFullPct FROM</code></strong>
    -&gt; <strong><code>(SELECT variable_value num FROM performance_schema.GLOBAL_STATUS</code></strong>
    -&gt; <strong><code>WHERE variable_name = 'Innodb_buffer_pool_pages_data') A,</code></strong>
    -&gt; <strong><code>(SELECT variable_value num FROM performance_schema.GLOBAL_STATUS</code></strong>
    -&gt; <strong><code>WHERE variable_name = 'Innodb_buffer_pool_pages_total') B;</code></strong>
+-------------------+
| BufferPoolFullPct |
+-------------------+
| 23.46%            |
+-------------------+
1 row in set (0.02 sec)</pre><p>We can also determine memory allocation for the Buffer Pool 
          using <code>sys</code> schema. It’s crucial to configure Buffer Pool at startup 
          to allocate memory resources appropriately. </p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * FROM sys.memory_global_by_current_bytes</code></strong>
    -&gt; <strong><code>WHERE event_name like 'memory/innodb_buf_buf_pool'\G</code></strong>
*************************** 1. row ***************************
       event_name: memory/innodb/buf_buf_pool
    current_count: 1
    current_alloc: 131.00 MiB
current_avg_alloc: 131.00 MiB
       high_count: 1
       high_alloc: 131.00 MiB
   high_avg_alloc: 131.00 MiB
1 row in set (0.00 sec)</pre><p>The required information can be obtained from either <code>SHOW</code> <code>STATUS</code> or the <code>GLOBAL_STATUS</code> table. However, when
          executing queries within a program and saving the results, we must
          account for differences between <code>SHOW</code> statements and selecting from<code> performance_schema</code> tables. The following
          queries retrieve similar information, but the column headings differ
          in letter case and sometimes in name, and variable names differ in
          letter case:</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GLOBAL STATUS;</code></strong>
+-----------------------------------------------+-------------+
| Variable_name                                 | Value       |
+-----------------------------------------------+-------------+
| Aborted_clients                               | 1           |
| Aborted_connects                              | 6           |
…
…</pre><p>To enable applications to be agnostic with respect to whether
          the variable information comes from <code>SHOW</code> or <code>information_schema</code>, force variable names
          to a consistent letter case and use that case in expressions that
          reference the variables. It doesn’t matter which letter case you
          choose, as long as you use it consistently. The following discussion
          uses uppercase.</p><p>Here’s a simple routine (in Ruby) that takes a database
          handle, fetches the status variables, and returns them as a hash of
          values keyed by names:</p><pre data-type="programlisting" data-code-language="ruby"><code class="k">def</code> <code class="nf">get_status_variables</code><code class="p">(</code><code class="n">client</code><code class="p">)</code>
  <code class="n">vars</code> <code class="o">=</code> <code class="p">{}</code>
  <code class="n">query</code> <code class="o">=</code> <code class="s2">"SELECT VARIABLE_NAME, VARIABLE_VALUE FROM</code>
<code class="s2">           performance_schema.global_status"</code>
  <code class="n">client</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">query</code><code class="p">)</code><code class="o">.</code><code class="n">each</code> <code class="p">{</code> <code class="o">|</code><code class="n">row</code><code class="o">|</code> <code class="n">vars</code><code class="o">[</code><code class="n">row</code><code class="o">[</code><code class="s2">"VARIABLE_NAME"</code><code class="o">]</code><code class="err">↩</code>
  <code class="o">.</code><code class="n">upcase</code><code class="o">]</code> <code class="o">=</code> <code class="n">row</code><code class="o">[</code><code class="s2">"VARIABLE_VALUE"</code><code class="o">]</code> <code class="p">}</code>
  <code class="k">return</code> <code class="n">vars</code>
<code class="k">end</code></pre><p>To get the information using a <code>SHOW</code> statement instead, replace the query
          with this one:</p><pre data-type="programlisting" data-code-language="ruby"><code class="n">query</code> <code class="o">=</code> <code class="s2">"SHOW GLOBAL STATUS"</code></pre><p>The code applies the <code>upcase</code>
          method to the variable names. That way, no matter whether the
          routine uses <code>GLOBAL_STATUS</code> or
          <code>SHOW</code> to obtain the information,
          the resulting hash has elements accessed by uppercase variable
          names.</p><p>To calculate a hit rate, pass the variable hash and the names
          of the reads and requests variables to this routine:</p><pre data-type="programlisting" data-code-language="ruby"><code class="k">def</code> <code class="nf">cache_hit_rate</code><code class="p">(</code><code class="n">vars</code><code class="p">,</code><code class="n">reads_name</code><code class="p">,</code><code class="n">requests_name</code><code class="p">)</code>
  <code class="n">reads</code> <code class="o">=</code> <code class="n">vars</code><code class="o">[</code><code class="n">reads_name</code><code class="o">].</code><code class="n">to_f</code>
  <code class="n">requests</code> <code class="o">=</code> <code class="n">vars</code><code class="o">[</code><code class="n">requests_name</code><code class="o">].</code><code class="n">to_f</code>
  <code class="n">hit_rate</code> <code class="o">=</code> <code class="n">requests</code> <code class="o">==</code> <code class="mi">0</code> <code class="o">?</code> <code class="mi">0</code> <code class="p">:</code> <code class="mi">1</code> <code class="o">-</code> <code class="p">(</code><code class="n">reads</code><code class="o">/</code><code class="n">requests</code><code class="p">)</code>
  <code class="nb">printf</code> <code class="s2">"        Key reads: %12d (%s)</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">reads</code><code class="p">,</code> <code class="n">reads_name</code>
  <code class="nb">printf</code> <code class="s2">"Key read requests: %12d (%s)</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">requests</code><code class="p">,</code> <code class="n">requests_name</code>
  <code class="nb">printf</code> <code class="s2">"         Hit rate: %12.4f</code><code class="se">\n</code><code class="s2">"</code><code class="p">,</code> <code class="n">hit_rate</code>
<code class="k">end</code></pre><p>Now we’re all set. Call the routines that fetch status
          information and calculate the hit rates like this:</p><pre data-type="programlisting" data-code-language="ruby"><code class="n">statvars</code> <code class="o">=</code> <code class="n">get_status_variables</code><code class="p">(</code><code class="n">client</code><code class="p">)</code>
<code class="n">cache_hit_rate</code><code class="p">(</code><code class="n">statvars</code><code class="p">,</code>
               <code class="s2">"INNODB_BUFFER_POOL_READS"</code><code class="p">,</code>
               <code class="s2">"INNODB_BUFFER_POOL_READ_REQUESTS"</code><code class="p">)</code>
<code class="n">cache_hit_rate</code><code class="p">(</code><code class="n">statvars</code><code class="p">,</code>
               <code class="s2">"KEY_READS"</code><code class="p">,</code>
               <code class="s2">"KEY_READ_REQUESTS"</code><code class="p">)</code></pre><p>Run the script to see your server’s hit rates:</p><pre data-type="programlisting">$ <strong><code>hitrate.rb</code></strong>
        Key reads:         6280 (INNODB_BUFFER_POOL_READS)
Key read requests:     70138276 (INNODB_BUFFER_POOL_READ_REQUESTS)
         Hit rate:       0.9999
        Key reads:        23269 (KEY_READS)
Key read requests:      8902674 (KEY_READ_REQUESTS)
         Hit rate:       0.9974</pre><p>For tasks involving system variables, code similar to <code>get_status_variables()</code> suffices. This
          implementation uses the <code>GLOBAL_VARIABLES</code> table:</p><pre data-type="programlisting" data-code-language="ruby"><code class="k">def</code> <code class="nf">get_system_variables</code><code class="p">(</code><code class="n">client</code><code class="p">)</code>
  <code class="n">vars</code> <code class="o">=</code> <code class="p">{}</code>
  <code class="n">query</code> <code class="o">=</code> <code class="s2">"SELECT VARIABLE_NAME, VARIABLE_VALUE FROM</code>
<code class="s2">           performance_schema.global_variables"</code>
  <code class="n">client</code><code class="o">.</code><code class="n">query</code><code class="p">(</code><code class="n">query</code><code class="p">)</code><code class="o">.</code><code class="n">each</code> <code class="p">{</code> <code class="o">|</code><code class="n">row</code><code class="o">|</code> <code class="n">vars</code><code class="o">[</code><code class="n">row</code><code class="o">[</code><code class="s2">"VARIABLE_NAME"</code><code class="o">].</code><code class="n">upcase</code><code class="o">]</code><code class="err">↩</code>
  <code class="o">=</code> <code class="n">row</code><code class="o">[</code><code class="s2">"VARIABLE_VALUE"</code><code class="o">]</code> <code class="p">}</code>
  <code class="k">return</code> <code class="n">vars</code>
<code class="k">end</code></pre><p>To use <code>SHOW</code> instead,
          replace the query with this one:</p><pre data-type="programlisting" data-code-language="ruby"><code class="n">query</code> <code class="o">=</code> <code class="s2">"SHOW GLOBAL VARIABLES"</code></pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.9 Finding Information About the Storage Engine"><div class="sect1" id="nch-monitoring-monitoring-backups"><h1>23.9 Finding Information About the Storage Engine</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820312596416"><h2>Problem</h2><p>You want to pin specific problem about MySQL’s pluggable storage
      engine architecture.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820312581568"><h2>Solution</h2><p>Use MySQL’s <span class="command"><em>mysql</em></span> client
      and interact with storage engine directly.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820312610752"><h2>Discussion</h2><p>Now we’re all set. Call the <code>SHOW ENGINE</code> command from
      <span class="command"><em>mysql</em></span> client.</p><pre data-type="programlisting" data-code-language="ruby">mysql&gt; <strong><code>help show engine</code></strong>
Name: 'SHOW ENGINE'
Description:
Syntax:
SHOW ENGINE engine_name {STATUS | MUTEX}</pre><section data-type="sect3" data-pdf-bookmark="SHOW ENGINE"><div class="sect3" id="idm45820312607200"><h3>SHOW ENGINE</h3><p>SHOW ENGINE displays operational information about a storage
        engine. It requires the PROCESS privilege. The statement has these
        variants for INNODB:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SHOW</code> <code class="n">ENGINE</code> <code class="n">INNODB</code> <code class="n">STATUS</code><code class="p">;</code>
<code class="k">SHOW</code> <code class="n">ENGINE</code> <code class="n">INNODB</code> <code class="n">MUTEX</code><code class="p">;</code></pre><p>The first command
        <em>SHOW ENGINE INNODB STATUS </em>shows extensive
        information about InnoDB storage engine in sections. In order to
        digest this information it’s possible to capture output of this
        command and parse it via command line.</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW ENGINE INNODB STATUS\G</code></strong>
*************************** 1. row ***************************
  Type: InnoDB
  Name:
Status:
=====================================
2020-10-28 23:43:12 0x70000d0ae000 INNODB MONITOR OUTPUT
=====================================
Per second averages calculated from the last 6 seconds
-----------------
BACKGROUND THREAD
-----------------
srv_master_thread loops: 34 srv_active, 0 srv_shutdown, 768286 srv_idle
srv_master_thread log flush and writes: 0
----------
SEMAPHORES
----------</pre><p>For example, it can reach the Buffer Pool 
        Information easily with the same command. This information is very 
        useful when you need to acquire information fast, accurately, and 
        without any impact to running the server. 
        </p><pre data-type="programlisting">----------------------
BUFFER POOL AND MEMORY
----------------------
Total large memory allocated 137363456
Dictionary memory allocated 1539651
Buffer pool size   8191
Free buffers       6250
Database pages     1924
Old database pages 725
Modified db pages  0
Pending reads      0
Pending writes: LRU 0, flush list 0, single page 0
Pages made young 131, not young 1806
0.00 youngs/s, 0.00 non-youngs/s
Pages read 913, created 1105, written 3138
0.00 reads/s, 0.00 creates/s, 0.00 writes/s
No buffer pool page gets since the last printout
Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s
LRU len: 1924, unzip_LRU len: 0
I/O sum[0]:cur[0], unzip sum[0]:cur[0]</pre><p>If you are monitoring single event you may set the pager and
        repeatedly monitor its value.</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="n">PAGER</code><code> </code><code class="n">grep</code><code> </code><code class="o">-</code><code class="n">i</code><code> </code><code class="n">history</code></strong><code>
</code><code class="n">PAGER</code><code> </code><code class="k">set</code><code> </code><code class="k">to</code><code> </code><code class="s1">'grep -i history'</code><code>
</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SHOW</code><code> </code><code class="n">ENGINE</code><code> </code><code class="n">INNODB</code><code> </code><code class="n">STATUS</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="n">History</code><code> </code><code class="n">list</code><code> </code><code class="k">length</code><code> </code><code class="mi">0</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>Let’s have a look at Mutex information on the idle system. 
        The resulting <span class="command"><em>SHOW</em></span> statement would be much longer as if threads 
        compete for the resources.</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW ENGINE  INNODB MUTEX;</code></strong>
+--------+----------------------------+---------+
| Type   | Name                       | Status  |
+--------+----------------------------+---------+
| InnoDB | rwlock: fil0fil.cc:3206    | waits=4 |
| InnoDB | sum rwlock: buf0buf.cc:778 | waits=3 |
+--------+----------------------------+---------+
2 rows in set (0.00 sec)</pre><p>
          </p><figure style="float: 0"><div id="innodb_architecture" class="figure"><img src="Images/msc4_2302.png" width="600" height="461"/><h6><span class="label">Figure 23-2. </span>InnoDB Architecture <em>© 2021, Oracle Corporation and/or its affiliates. (2021). InnoDB Architecture [Figure]. 
https://dev.mysql.com/doc/refman/8.0/en/innodb-architecture.html</em></h6></div></figure><p>
         </p><p>As you can see above InnoDB consists of two types of
          structures. First part In-Memory and the second part is in On-Disk.
          InnoDB utilizes host OS memory efficiently by its internal memory
          management protocol. As mentioned in introduction section of this
          chapter memory utilization is important factor in MySQL
          monitoring.</p><p>As InnoDB is the far most complex and adopted storage engine
          in MySQL ecosystem it also comes with <em>Components
          </em>for even further debugging internals. Although this is an
          advanced topic it’s good know that you can add plugins to the
          MySQL server. For future reading please refer to <a href="https://dev.mysql.com/doc/refman/8.0/en/server-plugins.html">MySQL
          Documentation.</a></p></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.10 Using the Error Log File to Troubleshoot MySQL Server Crashes"><div class="sect1" id="nch-monitoring-monitoring-error-log"><h1>23.10 Using the Error Log File to Troubleshoot MySQL Server Crashes</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820312468528"><h2>Problem</h2><p>My application reports “MySQL Server has gone away” (error
      2006).</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820312467616"><h2>Solution</h2><p>There are possible scenarios for this very common error. They include:</p><ul><li><p>OOM (Out of Memory) Killer</p></li><li><p>MySQL Signals</p></li><li><p>Crashing bug</p></li><li><p>Various other reasons such as server timeout, removed system
          files etc.</p></li></ul><p>
      Sometimes
      even Error Log will be misleading to troubleshoot it. So it’s also
      advised to check system logs such as /var/log/messages.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussions"><div class="sect2" id="idm45820312436064"><h2>Discussions</h2><p>An error log is one of the most critical monitoring MySQL server 
       statuses. From startup to shutdown, it will log all events to this file. 
       Pro-actively monitoring this file will give enough information about the 
       current and past events.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>The error log is tunable in MySQL 8.0 and can be fine-tuned to log 
    and filter events by given criteria. For details please refer to <a href="https://dev.mysql.com/doc/refman/8.0/en/error-log-configuration.html"> MySQL documentation.</a>  
    </p></div><p>Here are some pointers to the monitoring and finding solution to
      this error.</p><section data-type="sect3" data-pdf-bookmark="Server Crash"><div class="sect3" id="idm45820312433424"><h3>Server Crash</h3><p>The server may have disconnected while executing a large query. 
        The client has timed out during a long running query in this case.
        </p><pre data-type="programlisting">$ <strong><code>( echo -n "SELECT '" ; for i in `seq 1 110000` ; \</code></strong>
        <strong><code>do echo -n "1234567890" ; done ; echo -n "' a") | mysql | wc</code></strong>
        
ERROR 2006 (HY000) at line 1: MySQL server has gone away
       0       0       0</pre><p>This maybe one of few reasons to check. Often times
        <code>max_allowed_packet</code> size is too small for a large query like the above
        crashing <em>for </em>loop.</p><pre data-type="programlisting">$ <strong><code>mysql -e "SHOW GLOBAL VARIABLES LIKE 'max_allowed_packet'"</code></strong>
+--------------------+---------+
| Variable_name      | Value   |
+--------------------+---------+
| max_allowed_packet | 1048576 |
+--------------------+---------+
$ <strong><code>mysql -e "SET GLOBAL max_allowed_packet=67108864"</code></strong>
$ <strong><code>mysql -e "SHOW GLOBAL VARIABLES LIKE 'max_allowed_packet'"</code></strong>
+--------------------+----------+
| Variable_name      | Value    |
+--------------------+----------+
| max_allowed_packet | 67108864 |
+--------------------+----------+
$ <strong><code>( echo -n "SELECT '" ; for i in `seq 1 110000` ; do echo -n "1234567890" ; done ; \</code></strong>
&gt; <strong><code>echo -n "' a") | mysql | wc</code></strong>
       2       2 1100003</pre></div></section><section data-type="sect3" data-pdf-bookmark="Server Timeout"><div class="sect3" id="idm45820312429136"><h3>Server Timeout</h3><p>The connection between the application and the results of the
        query returning for each request has a timeout variable. One of the
        common timeout variables to monitor is
        <em>wait_timeout</em>.</p><pre data-type="programlisting">$ <strong><code>mysql -e "SHOW GLOBAL VARIABLES LIKE 'wait_timeout'"</code></strong>
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| wait_timeout  | 28800 |
+---------------+-------+</pre><p>To demonstrate this we will set the
        <code>wait_timeout</code> value to very low of 4 seconds and
        re run the same query.</p><pre data-type="programlisting">$ <strong><code>mysql -e "SET GLOBAL wait_timeout=4"</code></strong>
$ <strong><code>time ( echo -n "SELECT '" ; for i in `seq 1 1100000` ; do echo -n "1234567890" ; done ; \</code></strong>
&gt; <strong><code>echo -n "' a") | mysql | wc</code></strong>
ERROR 2006 (HY000) at line 1: MySQL server has gone away
       0       0       0
real	0m8.062s
user	0m7.506s
sys	0m2.581s
$ mysql -e "SHOW GLOBAL VARIABLES LIKE 'wait_timeout'"
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| wait_timeout  | 4     |
+---------------+-------+</pre></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.11 Slow Query Log File"><div class="sect1" id="nch-monitoring-monitoring-slow-log"><h1>23.11 Slow Query Log File</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820312419088"><h2>Problem</h2><p>Using the slow query log to identify slow queries.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820312418112"><h2>Solution</h2><p>Enable slow query log and set threshold to filter queries to
      address them.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820312417168"><h2>Discussion</h2><p>MySQL can log all queries. By adjusting how slow queries are 
      recorded, it’s possible to capture all queries and digest them. The 
      default Slow Query Logging is set to 10 seconds, which means any query 
      taking longer than 10 seconds is only shown in the log file. </p><p>
        You can control behavior of the slow query log using number of variables.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GLOBAL VARIABLES LIKE '%slow%';</code></strong>
+---------------------------+---------------------------------------+
| Variable_name             | Value                                 |
+---------------------------+---------------------------------------+
| log_slow_admin_statements | OFF                                   |
| log_slow_extra            | OFF                                   |
| log_slow_slave_statements | OFF                                   |
| slow_launch_time          | 2                                     |
| slow_query_log            | OFF                                   |
| slow_query_log_file       | /usr/local/mysql/data/askdba-slow.log |
+---------------------------+---------------------------------------+
6 rows in set (0.01 sec)</pre><p>
       The most essential among them is <code>slow_query_log</code> that enables or disables slow query logging. It is <code>OFF</code> by default.
      </p><p>
        Slow query log threshold is controlled with the variable <code>long_query_time</code>. You may start tuning your queries that are logged with the default threshold and then decrease it in steps. Finally set <code>long_query_time</code> to 0 to log all the queries.
      </p><section data-type="sect3" data-pdf-bookmark="Logging all the queries."><div class="sect3" id="idm45820312412016"><h3>Logging all the queries.</h3><p>
        It is common practice to run slow query log with <code>long_query_time</code> set to 0. This way you will have information about performance of all the queries. Then you can run such programs as <span class="command"><em>pt-query-digest</em></span> or <span class="command"><em>mysqldumpslow</em></span> that can create digests of the queries.
      </p><p>
        To enable logging of all the queries set <code>long_query_time</code> to 0.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GLOBAL VARIABLES LIKE 'long_query_time';</code></strong>
+-----------------+-----------+
| Variable_name   | Value     |
+-----------------+-----------+
| long_query_time | 10.000000 |
+-----------------+-----------+
1 row in set (0.00 sec)

mysql&gt; <strong><code>SET GLOBAL LONG_QUERY_TIME=0;</code></strong>
Query OK, 0 rows affected (0.00 sec)

mysql&gt; <strong><code>SET GLOBAL SLOW_QUERY_LOG=1;</code></strong>
Query OK, 0 rows affected (0.02 sec)</pre><p>
      </p><p>Now we’re ready to test simple query as it will log everything by
      having long_query_time=0.</p><p>
        </p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT thing,legs,arms FROM limbs WHERE legs&gt;=2;</code></strong>

$ <strong><code>sudo tail -f /usr/local/mysql/data/askdba-slow.log</code></strong>
# Time: 2020-11-21T15:15:12.873279Z
# User@Host: root[root] @ localhost [127.0.0.1]  Id:   326
# Query_time: 0.000239  Lock_time: 0.000098 Rows_sent: 6  Rows_examined: 11
SET timestamp=1605971712;
SELECT thing,legs,arms FROM limbs WHERE legs&gt;=2;</pre><p>
In this example we may see that <code>Query_time</code> is pretty small that is expected, because the table itself is small. But number of rows that MySQL had to examine to resolve this query (<code>Rows_examined</code>) is greater (11) than the number of rows that the query sent to the client (<code>Rows_sent: 6</code>). This means that there is a very good chance that the query needs to be optimized.
</p><p>
We can start optimizing the query by running <span class="command"><em>EXPLAIN</em></span>.
</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">thing</code><code class="p">,</code><code class="n">legs</code><code class="p">,</code><code class="n">arms</code><code> </code><code class="k">FROM</code><code> </code><code class="n">limbs</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">legs</code><code class="o">&gt;</code><code class="o">=</code><code class="mi">2</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">limbs</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">ALL</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">11</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">33</code><code class="p">.</code><code class="mi">33</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      </p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>Setting value of <code>long_query_time</code> to 0 enables logging of every single query.. You need to be
        careful on busy system where your file system either can be filled or
        slowed down due to i/o operation.
        </p><p>
          Do not use logging into the table when setting <code>long_query_time</code> to 0, because storage engine CSV is not designed for working in high concurrent environments and can affect performance as well.
        </p></div></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.12 Monitoring with the General Query Log"><div class="sect1" id="nch-monitoring-monitoring-general-log"><h1>23.12 Monitoring with the General Query Log</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820312222480"><h2>Problem</h2><p>You want to identify what activity each client is engaged.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820312221600"><h2>Solution</h2><p>Enable general query log to to investigate them.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820312244960"><h2>Discussion</h2><p>MySQL general query log is proof of record for what mysqld is
      doing. By enabling this log, it allows administrator monitoring the how
      life of user connection interacts with mysqld.</p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>By enabling general query log you instruct MySQL server to log all the queries it receives. You need to be
        careful on busy system where your file system either can be filled or
        slowed down due to increased I/O operation.</p></div><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GLOBAL VARIABLES LIKE 'general%';</code></strong>
+------------------+-----------------------------------------------------+
| Variable_name    | Value                                               |
+------------------+-----------------------------------------------------+
| general_log      | OFF                                                 |
| general_log_file | /home/vagrant/sandboxes/msb_8_0_21/data/vagrant.log |
+------------------+-----------------------------------------------------+
2 rows in set (0.01 sec)</pre><p>To enable <code>general_log</code> in runtime use <span class="command"><em>SET</em></span> command.</p><pre data-type="programlisting">mysql&gt; <strong><code>SET GLOBAL general_log = 'ON';</code></strong>
Query OK, 0 rows affected (0.00 sec)

mysql&gt; <strong><code>SHOW GLOBAL VARIABLES LIKE 'general_log';</code></strong>
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| general_log   | ON    |
+---------------+-------+
1 row in set (0.00 sec)
Query OK, 0 rows affected (0.00 sec)</pre><p>

       Now we’re ready to monitor everything. This value is dynamic and we set at runtime. If you want it to set it persistently at startup see <a data-type="xref" href="ch22.xhtml#nch-admin-server-config">Recipe 22.1</a>:
       </p><pre data-type="programlisting">$ <strong><code>tail -f /home/vagrant/sandboxes/msb_8_0_21/data/vagrant.log</code></strong>
/home/vagrant/opt/mysql/8.0.21/bin/mysqld, Version: 8.0.21 (MySQL Community Server - GPL). ↩
started with:
Tcp port: 8021  Unix socket: /tmp/mysql_sandbox8021.sock
Time                 Id Command    Argument
2020-12-06T14:27:26.739541Z	    8 Query	show global variables like "general_log"
2020-12-06T14:51:08.660453Z	    8 Quit</pre><p>Connect another session and run following command while tailing
      the general query log file:</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW PROCESSLIST \G</code></strong>
*************************** 1. row ***************************
     Id: 5
   User: event_scheduler
   Host: localhost
     db: NULL
Command: Daemon
   Time: 2015
  State: Waiting on empty queue
   Info: NULL
*************************** 2. row ***************************
     Id: 10
   User: msandbox
   Host: localhost
     db: NULL
Command: Query
   Time: 0
  State: starting
   Info: show processlist
2 rows in set (0.00 sec)

$ <strong><code>tail -f /home/vagrant/sandboxes/msb_8_0_21/data/vagrant.log</code></strong>
2020-12-06T14:51:45.765019Z	   10 Connect	msandbox@localhost on  using Socket
2020-12-06T14:51:45.765785Z	   10 Query	select @@version_comment limit 1
2020-12-06T14:51:45.769113Z	   10 Query	select USER()
2020-12-06T14:52:29.130072Z	   10 Query	show processlist</pre><div data-type="note" epub:type="note"><h6>Note</h6><p>Unlike MySQL slow query log, general query log does not log
        query execution time. Instead, it logs end to end clean record of 
        what happens for each session in sequential order. This information 
        may be useful for debugging MySQL crashes or figuring out what 
        queries the application is sending.</p></div></div></section></div></section><section data-type="sect1" data-pdf-bookmark="23.13 Using the Binary Log to Identify Changes"><div class="sect1" id="nch-monitoring-monitoring-binary-log"><h1>23.13 Using the Binary Log to Identify Changes</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820312201632"><h2>Problem</h2><p>You want to track data changes for given
      period.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820312200688"><h2>Solution</h2><p>Enable binary log to investigate them.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820312199744"><h2>Discussion</h2><p>MySQL can log all data changes to a binary log format, which has 
      three purposes. </p><ul><li><p>Configure primary and 
      replica setup. By enabling this feature we can setup MySQL replicated 
      topology explained in <a data-type="xref" href="ch03.xhtml#nch-replication">Chapter 3</a></p></li><li><p>
      Point-in-time recovery after full backup taken.</p></li><li><p>
      Troubleshooting or investigating an event for a specific time period
      </p></li></ul><p>The binary log is enabled by setting <code>--log-bin</code> at startup. 
      Setting this value allows MySQL to track data changes to a binary 
      log file. Logfile contains a set of sequential log files along with 
      an index file. </p><pre data-type="programlisting"/><p>To read binary logs we must use verbose option <code>--verbose</code> or <code>-v</code>
      by using mysqlbinlog command.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>
      To see statement representation of row events use option <code>--verbose</code> (<code>-v</code>). 
      To see metadata of columns specify <code>--verbose</code>  twice: <code>--verbose --verbose</code> 
      or <code>-vv</code>. To suppress output of row events specify the option 
      <code>--base64-output=DECODE-ROWS</code></p></div><pre data-type="programlisting">$ <strong><code>/usr/bin/mysqlbinlog  binlog.000003 -v |more</code></strong>
#210208 19:39:03 server id 1  end_log_pos 517272 CRC32 0x043a9ff4 ↩
                        Write_rows: table id 112 flags: STMT_END_F
### INSERT INTO `test`.`sbtest1`
### SET
###   @1=1
###   @2=21417
###   @3='83868641912-28773972837-60736120486-75162659906-27563526494-↩
          20381887404-41576422241-93426793964-56405065102-33518432330'
###   @4='67847967377-48000963322-62604785301-91415491898-96926520291'</pre><p>To give specific start time:</p><pre data-type="programlisting" data-code-language="bash">     /usr/bin/mysqlbinlog --start-datetime<code class="o">=</code><code class="s2">"2020-11-29 10:50:32"</code>  
     binlog.000003 -v <code class="p">|</code>more</pre><p>To filter specific DML type:</p><pre data-type="programlisting">     $ <strong><code>/usr/bin/mysqlbinlog --start-datetime="2020-11-29 10:50:32"  binlog.000003 \</code></strong>
     &gt; <strong><code>-v| grep -i -e "update" -e "insert" </code></strong>
     &gt; <strong><code>-e "delete" -e "drop" -e "alter"  |cut -c1-100 | tr '[A-Z]' '[a-z]' </code></strong>
     &gt; <strong><code>| sed -e "s/\t/ /g;s/\`//g;s/(.*$//;s/ set .*$//;s/ as .*$//" </code></strong>
     &gt; <strong><code>| sed -e "s/ where .*$//" | sort | uniq -c | sort -nr</code></strong>
     
     50000 ### insert into test.sbtest9
     50000 ### insert into test.sbtest9
     50000 ### insert into test.sbtest8
     50000 ### insert into test.sbtest7
     ...</pre><p/></div></section></div></section></div></section></div></body></html>