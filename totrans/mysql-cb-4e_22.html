<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 22. Server Administration"><div class="chapter" id="nch-admin"><h1><span class="label">Chapter 22. </span>Server Administration</h1><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45820315221312"><h5>A note for Early Release readers</h5><p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p></div></aside><section data-type="sect1" data-pdf-bookmark="22.0 Introduction"><div class="sect1" id="nch-admin-admin-intro"><h1>22.0 Introduction</h1><p>This chapter covers how to perform operations involved in
    administering a MySQL server:</p><ul><li><p>General server configuration</p></li><li><p>The plug-in interface</p></li><li><p>Controlling server logging</p></li><li><p>Configuring storage engines</p></li></ul><p>The chapter doesn’t cover managing MySQL user accounts. That is an
    administrative task, and is covered in <a data-type="xref" href="ch24.xhtml#nch-security">Chapter 24</a>.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>Many of the techniques shown here require administrative access,
      such as the ability to modify tables in the <code>mysql</code> system database or use statements that
      require the <code>SUPER</code> privilege. For this
      reason, to carry out the operations described here, you’ll likely need
      to connect to the server as <code>root</code>
      rather than as <code>cbuser</code>.</p></div></div></section><section data-type="sect1" data-pdf-bookmark="22.1 Configuring the Server"><div class="sect1" id="nch-admin-server-config"><h1>22.1 Configuring the Server</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820315212592"><h2>Problem</h2><p>You want to change the server settings, and also verify that your changes
      took effect.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820315211472"><h2>Solution</h2><p>To change settings, specify them at server startup or at runtime.
      To verify the changes, examine the relevant system variables at
      runtime.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820315210368"><h2>Discussion</h2><p>The MySQL server places many configuration parameters under your
      control. For example, resources that require memory can be adjusted up
      or down to tailor resource usage. A heavily used server requires more
      memory; a lightly used one, less. You can set command options and system
      variables at server startup, and many system variables are settable at
      runtime as well. You can also examine your settings at runtime to verify
      that the configuration is as you intend.</p><section data-type="sect3" data-pdf-bookmark="Configuration control at server startup"><div class="sect3" id="idm45820315209424"><h3>Configuration control at server startup</h3><p>To configure the server at startup time, specify options on the
        command line or in an option file. The latter is usually preferable
        because you can specify settings once and they’ll apply at each
        startup. (For background on using command-line options and option
        files, see <a data-type="xref" href="ch01.xhtml#nch-mysql-mysql-options">Recipe 1.4</a>.)</p><p>Command option names typically use dashes, whereas system
        variable names use underscores. However, the server is more permissive
        at startup and recognizes command options and system variables written
        using dashes or underscores interchangeably. For example, <code>sql_mode</code> and <code>sql-mode</code> are equivalent on the command line
        or in an option file. This differs from runtime, when references to
        system variables <em>must</em> be written using
        underscores.</p><p>To specify server parameters in an option file, list them in the
        <code>[mysqld]</code> group of a file the server
        reads. To illustrate, here are some parameters you might set:</p><ul><li><p>The default character set is <code>utf8mb4 starting MySQL 8.0</code>. This character set comes with <code>utf8mb4_0900_ai_ci</code> as default collation.</p></li><li><p>The default SQL mode is <code>STRICT_TRANS_TABLES</code> (after 
            MySQL 5.7). To be more permissive by default, remove strict SQL
            mode, which is not recommended.</p></li><li><p>The event scheduler is enabled by default after MySQL 8.0. 
            If you plan to use scheduled events (see <a data-type="xref" href="ch11.xhtml#nch-routines-routines-events">Recipe 11.5</a>), you must enable
            it on prior releases.</p></li><li><p>For InnoDB engine, buffer pool size defaults to 128MB which 
            is not sufficient beyond development and testing. Consider increasing 
            to a size for running dataset in memory.</p></li><li><p>Timezone is set to SYSTEM  unless specified at startup. 
            If you aren’t intending to use SYSTEM timezone you need to set it at startup
            by setting <code>--timezone=timezone_name</code> 
            </p></li></ul><p>To implement these configuration ideas, write the <code>[mysqld]</code> group in your option file like
        this:</p><pre data-type="programlisting">[mysqld]
character_set_server=utf8mb4
sql_mode=STRICT_TRANS_TABLES
event_scheduler=1
innodb_buffer_pool_size=512M</pre><p>Those are just suggestions; adjust the server configuration for
        your own requirements. For information about plug-in and logging
        options in particular, see <a data-type="xref" href="#nch-admin-plugin-interface">Recipe 22.2</a> and <a data-type="xref" href="ch23.xhtml#nch-monitoring-monitoring-intro">Recipe 23.0</a>.</p></div></section><section data-type="sect3" data-pdf-bookmark="Configuration control and verification at runtime"><div class="sect3" id="idm45820315196896"><h3>Configuration control and verification at runtime</h3><p>After the server starts, you can make runtime adjustments by changing
        system variables using the <code>SET</code>
        statement:</p><pre data-type="programlisting" data-code-language="sql">SET GLOBAL <em><code>var_name</code></em> = <em><code>value</code></em>;</pre><p>That statement sets the global value of
        <em><code>var_name</code></em>; that is, the value that applies
        to all clients by default. Changes to the global value at runtime
        require the <code>SUPER</code>
        privilege. Many system variables also have a session value, which is
        the value specific to a particular client session. The session value
        of a given variable is initialized from the global value when the
        client connects, but the client can change it thereafter. For example,
        the DBA might set the max connections at server startup:</p><pre data-type="programlisting">[mysqld]
max_connections=1000</pre><p>That sets the global value. A DBA with the <code>SUPER</code> privilege can change the global value
        at runtime:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SET</code> <code class="k">GLOBAL</code> <code class="n">max_connections</code> <code class="o">=</code> <code class="mi">1000</code><code class="p">;</code></pre><p>Each client that connects subsequently has its session variable
        initialized to the same value, but can change the value as it likes. A
        DBA may increase this value for troubleshooting connectivity issues.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">SET</code> <code class="k">SESSION</code> <code class="n">max_connections</code> <code class="o">=</code> <code class="mi">1000</code><code class="p">;</code></pre><p>A <code>SET</code> statement that includes
        no <code>GLOBAL</code> or <code>SESSION</code> modifier changes the session value,
        if there is one.</p><p>After MySQL 8.0 you may set and persist global variables. Many 
        of global variables are dynamic and can be set at runtime. <em>PERSIST</em> close
        will help set this value permanently even if the server is restarted without saving to the configuration file. 
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">SET</code> <code class="n">PERSISTS</code> <code class="n">max_connections</code> <code class="o">=</code> <code class="mi">1000</code><code class="p">;</code></pre><p>
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">SET</code> <code class="n">PERSISTS_ONLY</code> <code class="n">max_connections</code> <code class="o">=</code> <code class="mi">1000</code><code class="p">;</code></pre><p>
        </p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT @@GLOBAL.max_connections;</code></strong>
+--------------------------+
| @@GLOBAL.max_connections |
+--------------------------+
|                     1000 |
+--------------------------+</pre><p>To reset persisted values use:
		 </p><pre data-type="programlisting" data-code-language="sql"><code class="k">RESET</code> <code class="n">PERSIST</code><code class="p">;</code></pre><p>
		 </p><pre data-type="programlisting" data-code-language="sql"><code class="k">RESET</code> <code class="n">PERSIST</code> <code class="n">max_connections</code><code class="p">;</code></pre><p>
        </p><p>There is alternative syntax for writing system variable
        references:</p><pre data-type="programlisting" data-code-language="sql">SET @@GLOBAL.<em><code>var_name</code></em> = <em><code>value</code></em>;
SET @@SESSION.<em><code>var_name</code></em> = <em><code>value</code></em>;</pre><p>The <code>@@</code> syntax is more
        flexible. It can be used in statements other than <code>SET</code>, enabling you to retrieve or examine
        individual system variables:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT @@GLOBAL.max_connections;</code></strong>
+--------------------------+
| @@GLOBAL.max_connections |
+--------------------------+
|                     1000 |
+--------------------------+</pre><p>References to system variables using <code>@@</code> syntax with no <code>GLOBAL.</code>
        or <code>SESSION.</code> modifier access the session value if
        there is one, or the global value otherwise.</p><p>Other ways to access system variables include the <code>SHOW</code> <code>VARIABLES</code> statement and selecting from the <code>INFORMATION_SCHEMA</code> <code>GLOBAL_VARIABLES</code> and <code>SESSION_VARIABLES</code> tables.</p><p>If a setting exists only as a command option with no
        corresponding system variable, you cannot check its value at runtime.
        Fortunately, such options are rare. Nowadays, most new settings are
        created as system variables that can be examined at runtime.</p></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="22.2 Managing the Plug-In Interface"><div class="sect1" id="nch-admin-plugin-interface"><h1>22.2 Managing the Plug-In Interface</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820313904352"><h2>Problem</h2><p>You want to exploit the capabilities offered by certain server
      plug-ins.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820313903440"><h2>Solution</h2><p>Learn how to control the plug-in interface.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820313902496"><h2>Discussion</h2><p>MySQL supports the use of plug-ins that extend server
      capabilities. There are plug-ins that implement storage engines,
      authentication methods, password policy, <code>PERFORMANCE_SCHEMA</code> tables, and more. The
      server enables you to specify which plug-ins to use, so that you can
      load just those you want, with no memory or processing overhead incurred
      for plug-ins you don’t want.</p><p>This section provides the general background on controlling which
      plug-ins the server loads. Discussion elsewhere describes specific
      plug-ins and what they can do for you, including the authentication
      plug-ins (see <a data-type="xref" href="ch24.xhtml#nch-security-user-table">Recipe 24.1</a>), and <code>validate_password</code> (see <a data-type="xref" href="ch24.xhtml#nch-security-password-policy">Recipe 24.3</a> and <a data-type="xref" href="ch24.xhtml#nch-security-password-strength">Recipe 24.4</a>).</p><p>The examples here refer to plug-in files using the <em class="filename">.so</em> (<q>shared object</q>) filename
      suffix. If the suffix differs on your system, adjust the names
      accordingly (for example, use <em class="filename">.dll</em>
      on Windows). If you don’t know the name of a given plug-in file, look in
      the directory named by the <code>plugin_dir</code>
      system variable, which is where the server expects to find plug-in
      files. For example:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT @@plugin_dir;</code></strong>
+------------------------------+
| @@plugin_dir                 |
+------------------------------+
| /usr/local/mysql/lib/plugin/ |
+------------------------------+</pre><p>To see which plug-ins are installed, use <code>SHOW</code> <code>PLUGINS</code> or query the <code>INFORMATION_SCHEMA</code> <code>PLUGINS</code> table.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>Some plug-ins are built in, need not be enabled explicitly,
        and cannot be disabled. The <code>mysql_native_password</code> and <code>sha256_password</code> authentication plug-ins fall
        into this category.</p></div><section data-type="sect3" data-pdf-bookmark="Plug-in control at server startup"><div class="sect3" id="idm45820313877648"><h3>Plug-in control at server startup</h3><p>To install a plug-in only for a given server invocation, use the
        <code class="option">--plugin-load-add</code> option at server startup, naming
        the file that contains the plug-in. To name multiple plug-ins as the
        option value, separate them with semicolons. Alternatively, use the
        option multiple times, with each instance naming a single plug-in.
        That makes it easy to enable or disable individual plug-ins by using
        the <code>#</code> character to selectively
        comment the corresponding lines:</p><pre data-type="programlisting">[mysqld]
plugin-load-add=caching_sha2_password.so
plugin-load-add=adt_null.so
#plugin-load-add=semisync_master.so
#plugin-load-add=semisync_slave.so</pre><p>The <code class="option">--plugin-load-add</code> option was introduced in MySQL 5.6. In MySQL 8.0, you can use
        a single <code class="option">--plugin-load</code> option that names all the plug-ins to be loaded in a
        semicolon-separated list:</p><pre data-type="programlisting">[mysqld]
plugin-load=validate_password.so;caching_sha2_password.so</pre><p>Clearly, for dealing with more than one plug-in,
        <code class="option">--plugin-load-add</code> is superior for ease of
        administration.</p></div></section><section data-type="sect3" data-pdf-bookmark="Plug-in control at runtime"><div class="sect3" id="idm45820313871856"><h3>Plug-in control at runtime</h3><p>To install a plugin at runtime and make it persistent,
        use <code>INSTALL</code> <code>PLUGIN</code>. The server loads the plug-in (which
        becomes available immediately) and registers it in the <code>mysql.plugin</code> system table to cause it to
        load automatically for subsequent restarts. For example:</p><pre data-type="programlisting" data-code-language="sql"><code class="n">INSTALL</code> <code class="n">PLUGIN</code> <code class="n">caching_sha2_password</code> <code class="n">SONAME</code> <code class="s1">'caching_sha2_password.so'</code><code class="p">;</code></pre><p>The <code>SONAME</code> (<q>shared
        object name</q>) clause specifies the file that contains the
        plug-in.</p><p>To disable a plug-in at runtime, use <code>UNINSTALL</code> <code>PLUGIN</code>. The server unloads the plug-in and
        removes its registration from the <code>mysql.plugin</code> table:</p><pre data-type="programlisting" data-code-language="sql"><code class="n">UNINSTALL</code> <code class="n">PLUGIN</code> <code class="n">caching_sha2_password</code><code class="p">;</code></pre><p><code>INSTALL</code> <code>PLUGIN</code> and <code>UNINSTALL</code> <code>PLUGIN</code> require the <code>INSERT</code> and
        <code>DELETE</code> privilege, respectively, for the <code>mysql.plugin</code> table.</p></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="22.3 Controlling Server Logging"><div class="sect1" id="nch-admin-server-logs"><h1>22.3 Controlling Server Logging</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820313831984"><h2>Problem</h2><p>You want to take advantage of log information the server can
      provide.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820313831008"><h2>Solution</h2><p>Learn the server options that control logging.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820313830064"><h2>Discussion</h2><p>The MySQL server can produce several logs:</p><dl><dt>The error log</dt><dd><p>The error log contains information about problems or
            exceptional conditions the server encounters. This is useful
            information for debugging. In particular, if the server exits,
            check the error log for the reason. For example, if an exit occurs
            immediately after startup, it’s likely that some setting in the
            server option file is misspelled or was set to an invalid value.
            The error log will contain a message to that effect.</p></dd><dt>The general query log</dt><dd><p>The general query log indicates when each client connected and
            disconnected and what SQL statements it executed. This tells you
            how much and what activity each client is engaged in.</p></dd><dt>The slow query log</dt><dd><p>The slow query log records statements that took a long time to execute
            (see the <a href="https://dev.mysql.com/doc/refman/8.0/en/slow-query-log.html">MySQL Reference Manual</a>
            for the
            meaning of <q>a long time</q> because it can be influenced
            by several options). Queries that appear repeatedly in this log
            may be bottlenecks worth investigating to see whether they can be
            made more efficient.</p></dd><dt>The binary log</dt><dd><p>The binary log contains a record of data changes made by the
            server. To set up replication, you must enable the binary log on
            the source server: it serves as the storage medium for changes to
            be sent to replica servers. The binary log is also used, together
            with backup files, during data recovery operations.</p></dd></dl><p>Each log serves a different purpose and most can be turned on at
      your discretion, enabling you to use those that suit your administrative
      requirements. Each log can be <span class="keep-together">written</span> to a file, and some can be written
      to other destinations. The error log can be sent to your terminal or to
      the <code>syslog</code> facility.
      The general and slow query logs can be written to a file, to a table in
      the <code>mysql</code> database, or both.</p><p>To control server logging, add lines to your server option file
      that specify the desired types of logging. (Some settings can also be
      changed at runtime.) For example, the following
      lines in a server option file send the error log to the <em class="filename">err.log</em> file in the data directory, enable
      writing the general query and slow query logs to tables in the <code>mysql</code> database, and enable writing the binary
      log to the <em class="filename">/var/mysql-logs</em>
      directory using files having names beginning with <em class="filename">binlog</em>:</p><pre data-type="programlisting">[mysqld]
log_error=err.log
log_output=TABLE
general_log=1
slow_query_log=1
log-bin=/var/mysql-logs/binlog</pre><p>For filenames in options that produce log output to files,
      logfiles are written under the data directory unless specified using
      full pathnames. The usual reason to use full pathnames is to write
      logfiles to a filesystem different from the one containing the data
      directory, which is useful technique for dividing disk space use and I/O
      activity among physical devices.</p><p>The rest of this section provides details specific to controlling
      individual logs. The examples show the lines to include in your server
      option file to produce specific logging behavior. For some ideas about
      using the logs for diagnostic or activity assessment purposes, see <a data-type="xref" href="#nch-admin-admin-monitor">Recipe 22.6</a>.</p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>For any log that you enable, see also <a data-type="xref" href="#nch-admin-log-file-rotation">Recipe 22.4</a> and <a data-type="xref" href="#nch-admin-log-table-rotation">Recipe 22.5</a> for log maintenance techniques.
        Logs increase in size over time, so you’ll want to have a plan for
        managing them.</p></div><section data-type="sect3" data-pdf-bookmark="The error log"><div class="sect3" id="idm45820313796736"><h3>The error log</h3><p>The error log cannot be disabled, but you can control where it’s
        written. By default, on Unix, the error output goes to your terminal
        on Unix or to <em><code>host_name</code></em><em class="filename">.err</em> in the data directory if you start the
        server using <span class="command"><em>mysqld_safe</em></span>. On
        Windows the default is <em><code>host_name</code></em><em class="filename">.err</em> in the data directory. To specify the
        error log filename, set the <code>log_error</code>
        system variable.</p><p>Examples:</p><ul><li><p>Write the error log to the <em class="filename">err.log</em> file in the data
            directory:</p><pre data-type="programlisting">[mysqld]
log_error=err.log</pre></li><li><p>As of MySQL 5.7.2, you can influence the amount of error log
            output by setting the <code>log_error_verbosity</code> system variable.
            Permitted values range from 1 (errors only) to 3
            (errors, warnings, notes; the default). To see errors only, do
            this:</p><pre data-type="programlisting">[mysqld]
log_error=err.log
log_error_verbosity=1</pre></li><li><p>On Unix, if you start the server using <span class="command"><em>mysqld_safe</em></span>, it’s possible to redirect
            the error log to the <code>syslog</code>
            facility:</p><pre data-type="programlisting">[mysqld_safe]
syslog</pre></li></ul></div></section><section data-type="sect3" data-pdf-bookmark="The general query and slow query logs"><div class="sect3" id="idm45820313787008"><h3>The general query and slow query logs</h3><p>Several system variables control the general query and slow query logs.
        Each variable can be set at server startup or changed at
        runtime:</p><ul><li><p><code>log_output</code> controls
            the log destinations. The value is <code>FILE</code> (log to files, the default),
            <code>TABLE</code> (log to tables), <code>NONE</code> (disable logging), or a
            comma-separated combination of values, in any order. <code>NONE</code> overrides any other value. If the
            value is <code>NONE</code>, other settings
            for these logs have no effect. Destination control applies to the
            general query and slow query logs together; you cannot write one
            to a file and the other to a table.</p></li><li><p><code>general_log</code> and <code>slow_query_log</code> enable or disable the respective logs. By default, each log
            is disabled. If you enable either of them, the server writes the
            log to the destinations specified by <code>log_output</code>, unless that variable is
            <code>NONE</code>.</p></li><li><p><code>general_log_file</code> and
            <code>slow_query_log_file</code> specify
            log filenames. The default names are
            <em><code>host_name</code></em><em class="filename">.log</em> and
            <em><code>host_name</code></em><em class="filename">-slow.log</em>; however, these settings have
            no effect unless <code>log_output</code>
            specifies <code>FILE</code> logging.</p></li></ul><p>Examples:</p><ul><li><p>Write the general query log to the <em class="filename">query.log</em> file in the data
            directory:</p><pre data-type="programlisting">[mysqld]
log_output=FILE
general_log=1
general_log_file=query.log</pre></li><li><p>Write the general and slow query logs to tables in the
            <code>mysql</code> database (the table names
            are <code>general_log</code> and <code>slow_log</code> and cannot be changed):</p><pre data-type="programlisting">[mysqld]
log_output=TABLE
general_log=1
slow_query_log=1</pre></li><li><p>Write the general query log to a file named <em class="filename">query.log</em> and to the <code>general_log</code> table:</p><pre data-type="programlisting">[mysqld]
log_output=FILE,TABLE
general_log=1
general_log_file=query.log</pre></li></ul></div></section><section data-type="sect3" data-pdf-bookmark="The binary log"><div class="sect3" id="idm45820313771600"><h3>The binary log</h3><p>Prior to MySQL 8 binary logging was disabled by default.
        To enable the binary log, use the <code class="option">--log-bin</code> option,
        optionally specifying the logfile basename as the option
        value. In order to disable binary logging in MySQL 8.0 you can use 
        <code class="option">--skip-log-bin</code> option or 
        <code class="option">--disable-log-bin</code> option. 
        The default basename is
        <em><code>binlog</code></em>. The value for this option is a
        basename because the server creates binary logfiles in numbered
        sequence, automatically adding to the basename suffixes of <em class="filename">.000001</em>, <em class="filename">.000002</em>, and so forth. The server advances
        to the next file in the sequence when it starts, when the logs are
        flushed, and when the current file reaches the maximum logfile size
        (controlled by the <code>max_binlog_size</code>
        system variable).  In MySQL 8.0 <code>expire_logs_days</code> is deprecated and 
        replaced with <code>binlog_expire_logs_seconds</code>. To have the server expire 
        logfiles for you,
        set the <code>binlog_expire_logs_seconds</code> system variable 
        to the age in seconds at which files become eligible for removal. The 
        default value for <em>binlog_expire_logs_seconds</em> is 
        30 days (30*24*60*60 seconds). To disable automatic purging of binary
        logs set <em>binlog_expire_logs_seconds</em> to 0.
        </p><p>Examples:</p><ul><li><p>Enable the binary log, writing numbered files in the data
            directory having names beginning with <em class="filename">binlog</em>. Additionally, expire logfiles
            after a week:</p><pre data-type="programlisting">[mysqld]
max_binlog_size=4G
binlog_expire_logs_seconds=604800</pre></li></ul><p>The binary log is an essential component for the MySQL server, 
        and the administrator needs to approach it carefully. Binary logs 
        contain events for all data changes hence used for the following areas.  
        </p><ul><li><p>Replication setup </p></li><li><p>Point-in-time recovery </p></li><li><p>Debugging a specific event </p></li></ul></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="22.4 Rotating or Expiring Logfiles"><div class="sect1" id="nch-admin-log-file-rotation"><h1>22.4 Rotating or Expiring Logfiles</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820313759440"><h2>Problem</h2><p>Files used for logging grow indefinitely unless managed.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820313758560"><h2>Solution</h2><p>Available strategies for managing log files include rotating a 
      logfile through a set of names and expiring files by age. But different 
      strategies apply to different logs, so consider the log type before 
      choosing a strategy.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820313757424"><h2>Discussion</h2><p>Logfile rotation is a technique that renames a logfile through a
      series of one or more names. This maintains the file for a certain
      number of rotations, at which point it reaches the end of the sequence
      and its contents are discarded by being overwritten. Rotation can be
      applied to the error log, general query log, or slow query log.</p><p>Logfile expiration removes files when they reach a certain age.
      This technique applies to the binary log.</p><p>Both log management methods rely on log flushing to make sure that
      the current logfile has been closed properly. When you flush the logs,
      the server closes and reopens whichever of the files it is writing. If
      you rename the error, general query, or slow query logfile first, the
      server closes the current file and reopens a new one using the original
      name; this is what enables rotation of the current file while the server
      runs. The server also closes the current binary logfile and opens a new
      one with the next number in the sequence.</p><p>To flush the server logs, execute a <code>FLUSH</code>
      <code>LOGS</code> statement or use the <span class="command"><em>mysqladmin</em></span>
      <code class="option">flush-logs</code> command. (Log flushing requires the <code>RELOAD</code>
      privilege.) The following discussion shows maintenance operations as
      performed at the command line, so it uses <span class="command"><em>mysqladmin</em></span>. The examples use <span class="command"><em>mv</em></span> as the file renaming command, which is
      applicable on Unix. On Windows, use <span class="command"><em>rename</em></span> instead.</p><section data-type="sect3" data-pdf-bookmark="Rotating the error, general query, or slow query log"><div class="sect3" id="idm45820313755232"><h3>Rotating the error, general query, or slow query log</h3><p>To maintain a single file in a log rotation, rename the current
        logfile and flush the logs. Suppose that the error logfile is named
        <em class="filename">err.log</em> in the data directory. To
        rotate it, change location to the data directory, then execute these
        commands:</p><pre data-type="programlisting">$ <strong><code>mv err.log err.log.old</code></strong>
$ <strong><code>mysqladmin flush-logs</code></strong></pre><p>When you flush the logs, the server opens a new <em class="filename">err.log</em> file. You can remove <em class="filename">err.log.old</em> at your leisure. To maintain an
        archive copy, include it in your filesystem backups before removing
        it.</p><p>To maintain a set of multiple rotated files, it’s convenient to
        use a sequence of numbered suffixes. For example, to maintain a set of
        three old general query logfiles, do this:</p><pre data-type="programlisting">$ <strong><code>mv query.log.2 query.log.3</code></strong>
$ <strong><code>mv query.log.1 query.log.2</code></strong>
$ <strong><code>mv query.log query.log.1</code></strong>
$ <strong><code>mysqladmin flush-logs</code></strong></pre><p>The first few times you execute the command sequence, the
        initial commands are unneeded until the respective <em class="filename">query.log.</em><em><code>N</code></em>
        files exist.</p><p>Successive executions of that command sequence rotate <em class="filename">query.log</em> through the names <em class="filename">query.log.1</em>, <em class="filename">query.log.2</em>, and <em class="filename">query.log.3</em>; then <em class="filename">query.log.3</em> is overwritten and its contents
        lost. To maintain an archive copy, include the rotated files in your
        filesystem backups before removing them.</p></div></section><section data-type="sect3" data-pdf-bookmark="Rotating the binary log"><div class="sect3" id="idm45820313737888"><h3>Rotating the binary log</h3><p>The server creates binary logfiles in numbered sequence. To expire them,
        you need only arrange that it removes files when they’re old enough.
        Several factors affect how many files the server creates and
        maintains:</p><ul><li><p>The frequency of server restarts and log flushing
            operations: one new file is generated each time either of those
            occurs.</p></li><li><p>The size to which files can grow: larger sizes lead to fewer
            files. To control this size, set the <code>max_binlog_size</code> system variable.</p></li><li><p>How old files are permitted to become: longer expiration
            times lead to more files. To control this age, set the <code>binlog_expire_logs_seconds</code> system variable.
            The server makes expiration checks at server startup
            and when it opens a new binary logfile.</p></li></ul><p>The following settings enable the binary log, set the maximum
        file size to 4GB, and expire files after four days:</p><pre data-type="programlisting">[mysqld]
log-bin=binlog
max_binlog_size=4G
binlog_expire_logs_seconds=4</pre><p>You can also remove binary logfiles manually with the <code>PURGE</code> <code>BINARY</code> <code>LOGS</code> statement. For example, to remove all
        files up to and including the one named <code>binlog.001028</code>, do this:</p><pre data-type="programlisting" data-code-language="sql"><code class="n">PURGE</code> <code class="nb">BINARY</code> <code class="n">LOGS</code> <code class="k">TO</code> <code class="s1">'binlog.001028'</code><code class="p">;</code></pre><p>If your server is a replication source, don’t be too aggressive
        about removing binary logfiles. No file should be removed until you’re
        certain its contents have been completely transmitted to all
        replicas.</p></div></section><section data-type="sect3" data-pdf-bookmark="Automating logfile rotation"><div class="sect3" id="idm45820313688032"><h3>Automating logfile rotation</h3><p>To make it easier to perform a rotation operation, put the
        commands that implement it in a file to create a shell script. To
        perform the rotation automatically, arrange to execute the script from
        a job scheduler such as <span class="command"><em>cron</em></span>. The
        script will need to access connection parameters that enable it to
        connect to the server to flush the logs, using an account that has the
        <code>RELOAD</code> privilege. One strategy is
        to put the parameters in an option file and pass the file to <span class="command"><em>mysqladmin</em></span> using a
        <code class="option">--defaults-file=</code><em><code>file_name</code></em>
        option. For example:</p><pre data-type="programlisting">#!/bin/sh
mv err.log err.log.old
mysqladmin --defaults-file=/usr/local/mysql/data/flush-opts.cnf flush-logs</pre></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="22.5 Rotating Log Tables or Expiring Log Table Rows"><div class="sect1" id="nch-admin-log-table-rotation"><h1>22.5 Rotating Log Tables or Expiring Log Table Rows</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820313696608"><h2>Problem</h2><p>Tables used for logging grow indefinitely unless managed.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820313728368"><h2>Solution</h2><p>Rotate the tables or expire rows within them.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820313727424"><h2>Discussion</h2><p><a data-type="xref" href="#nch-admin-log-file-rotation">Recipe 22.4</a> discussed rotation
      and expiration of logfiles. Analogous techniques apply to log
      tables:</p><ul><li><p>To rotate a log table, rename it and open a new table with the
          original name.</p></li><li><p>To expire log table contents, remove rows older than a certain
          age.</p></li></ul><p>The examples here demonstrate how to implement these methods using
      the general query log table, <code>mysql.general_log</code>. The same methods apply to
      the slow query log table, <code>mysql.slow_log</code>, or to any other table
      containing rows that have a timestamp.</p><p>To employ log table rotation, create an empty copy of the original
      table to serve as the new table (see <a data-type="xref" href="ch06.xhtml#nch-tblmgmt-tblmgmt-clone">Recipe 6.1</a>), then rename the original table
      and rename the new one to take its place:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">DROP</code> <code class="k">TABLE</code> <code class="n">IF</code> <code class="k">EXISTS</code> <code class="n">mysql</code><code class="p">.</code><code class="n">general_log_old</code><code class="p">,</code> <code class="n">mysql</code><code class="p">.</code><code class="n">general_log_new</code><code class="p">;</code>
<code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">mysql</code><code class="p">.</code><code class="n">general_log_new</code> <code class="k">LIKE</code> <code class="n">mysql</code><code class="p">.</code><code class="n">general_log</code><code class="p">;</code>
<code class="k">RENAME</code> <code class="k">TABLE</code> <code class="n">mysql</code><code class="p">.</code><code class="n">general_log</code> <code class="k">TO</code> <code class="n">mysql</code><code class="p">.</code><code class="n">general_log_old</code><code class="p">,</code>
  <code class="n">mysql</code><code class="p">.</code><code class="n">general_log_new</code> <code class="k">TO</code> <code class="n">mysql</code><code class="p">.</code><code class="n">general_log</code><code class="p">;</code></pre><p>To employ log row expiration, you can either empty the table
      completely or selectively:</p><ul><li><p>To empty a log table completely, truncate it:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">TRUNCATE</code> <code class="k">TABLE</code> <code class="n">mysql</code><code class="p">.</code><code class="n">general_log</code><code class="p">;</code></pre></li><li><p>To expire a table selectively, removing only rows older than a
          given age, you must know the name of the column that indicates
          row-creation time:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">DELETE</code> <code class="k">FROM</code> <code class="n">mysql</code><code class="p">.</code><code class="n">general_log</code> <code class="k">WHERE</code> <code class="n">event_time</code> <code class="o">&lt;</code> <code class="n">NOW</code><code class="p">()</code> <code class="o">-</code> <code class="nb">INTERVAL</code> <code class="mi">1</code> <code class="n">WEEK</code><code class="p">;</code></pre></li></ul><p>For automatic expiration, the statements for any of the techniques
      just described can be executed within a scheduled event (see <a data-type="xref" href="ch11.xhtml#nch-routines-routines-events">Recipe 11.5</a>). For example:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="n">EVENT</code> <code class="n">expire_general_log</code>
  <code class="k">ON</code> <code class="n">SCHEDULE</code> <code class="k">EVERY</code> <code class="mi">1</code> <code class="n">WEEK</code>
  <code class="k">DO</code> <code class="k">DELETE</code> <code class="k">FROM</code> <code class="n">mysql</code><code class="p">.</code><code class="n">general_log</code>
     <code class="k">WHERE</code> <code class="n">event_time</code> <code class="o">&lt;</code> <code class="n">NOW</code><code class="p">()</code> <code class="o">-</code> <code class="nb">INTERVAL</code> <code class="mi">1</code> <code class="n">WEEK</code><code class="p">;</code></pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="22.6 Configuring storage engines"><div class="sect1" id="nch-admin-admin-monitor"><h1>22.6 Configuring storage engines</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820313507680"><h2>Problem</h2><p>You want to make sure the engine of your choice is configured
      properly.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820313506800"><h2>Solution</h2><p>Understand and configure each storage engine according to its use 
      case.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820313505920"><h2>Discussion</h2><p>MySQL comes with several storage engines by default, such as 
      MyISAM and InnoDB. MySQL 8.0 onwards uses InnoDB as the default database engine. 
      Along with this popular storage engine, there are 
      some others you might want to explore. Each of these 
      storage engine will use shared resources as well as dedicated resources 
      from the operating system. Care must be taken not to give too many 
      resources while mixing and matching.</p><ul><li><p> InnoDB : Supports transactions and row level locking 
      with full ACID compliancy engine. 
      </p></li><li><p> MyISAM : Table level locking and simple engine.
      </p></li><li><p> MyRocks : LSM based b-tree key/value storage engine.
<sup><a data-type="noteref" id="idm45820313521328-marker" href="ch22.xhtml#idm45820313521328">1</a></sup>  
      </p></li><li><p> CSV : Comma separated values engine. 
      </p></li><li><p> Blackhole : All writes are sent to /dev/null no data 
      storage engine. 
      </p></li><li><p> Memory : Optimized for in memory work load storage 
      engine. 
      </p></li><li><p> Archive : Write only engine for archival data in 
      compressed format storage engine. 
      </p></li></ul><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>Using multiple storage engines at the same time can cause issues 
      and may lead to data loss if used in the same transaction. Also, be 
      careful about the compatibility of your application and tooling around 
      it. </p></div><p>
      As each of above engines store data differently, we must configure 
      them accordingly. 
      InnoDB utilizes redo and undo log spaces for modified data. This allows 
      both recovery and point in time restore with minimal data loss 
      in the event of hardware or server failures. 
      MyRocks is another advanced storage engine which writes to recovery log 
      Write Ahead Log (WAL) first and supports rollback for each transaction. 
      MyISAM and CSV type storage engines writes directly to data files. While 
      it’s easier to make binary backups and transport them, these engines will 
      not support rollback operations. </p><p>
      To check default storage engine using MySQL 8.0:
      </p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT @@default_storage_engine;</code></strong>
+--------------------------+
| @@default_storage_engine |
+--------------------------+
| InnoDB                   |
+--------------------------+</pre><p>

We can see the table storage engine type by checking the schema definition. 

</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW CREATE TABLE limbs\G</code></strong>
       Table: limbs
Create Table: CREATE TABLE `limbs` (
  `thing` varchar(20) DEFAULT NULL,
  `legs` int DEFAULT NULL,
  `arms` int DEFAULT NULL,
  PRIMARY KEY(thing)
) <strong>ENGINE=InnoDB</strong> DEFAULT CHARSET=utf8mb4 
COLLATE=utf8mb4_0900_ai_ci</pre><p>

If we want to change the storage engine type after you’ve created the table, 
issue an <em>ALTER</em> statement. 

</p><pre data-type="programlisting">mysql&gt; <strong><code>ALTER TABLE cookbook.limbs  ENGINE=MYISAM;</code></strong>
Query OK, 11 rows affected (0.16 sec)
Records: 11  Duplicates: 0  Warnings: 0

mysql&gt; SHOW CREATE TABLE limbs\G
*************************** 1. row ***************************
       Table: limbs
Create Table: CREATE TABLE `limbs` (
  `thing` varchar(20) DEFAULT NULL,
  `legs` int DEFAULT NULL,
  `arms` int DEFAULT NULL,
  PRIMARY KEY(thing)
) <strong>ENGINE=MyISAM</strong> DEFAULT CHARSET=utf8mb4 
COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.00 sec)</pre><p>
</p><div data-type="note" epub:type="note"><h6>Note</h6><p>While you can swap between storage engines after a table has been 
      created and data loaded, <em>ALTER TABLE</em> operation locks 
      for all storage engines. For large data sets, consider 
      utilizing online schema change utilities such as  <a href="https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html#:~:text=pt%2Donline%2Dschema%2Dchange%20works%20by%20creating%20an%20empty,it%20with%20the%20new%20one.">pt-online-schema-change</a> 
      or <a href="https://github.com/github/gh-ost">gh-ost</a>. These 
      tools allow schema migrations to complete without creating a metadata 
      lock and apply changes in a controlled way. </p></div><p>
      Other storage engine settings can be checked as follows:
      </p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GLOBAL VARIABLES LIKE "%engine%" ;</code></strong>
+---------------------------------+---------------+
| Variable_name                   | Value         |
+---------------------------------+---------------+
| default_storage_engine          | InnoDB        |
| default_tmp_storage_engine      | InnoDB        |
| disabled_storage_engines        |               |
| internal_tmp_mem_storage_engine | TempTable     |
| secondary_engine_cost_threshold | 100000.000000 |
+---------------------------------+---------------+</pre><p>
      </p></div></section></div></section><div data-type="footnotes"><p data-type="footnote" id="idm45820313521328"><sup><a href="ch22.xhtml#idm45820313521328-marker">1</a></sup> Third party storage 
      engine via Percona and MariaDB designed to handle write intensive 
      workloads with space saving benefits.</p></div></div></section></div></body></html>