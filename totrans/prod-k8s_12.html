<html><head></head><body><section data-pdf-bookmark="Chapter 11. Building Platform Services" data-type="chapter" epub:type="chapter"><div class="chapter" id="building_platform_services">&#13;
<h1><span class="label">Chapter 11. </span>Building Platform Services</h1>&#13;
&#13;
&#13;
<p>Platform services are those components that are installed in order to add features to the application platform.<a data-primary="platform services, building" data-type="indexterm" id="ix_pltser"/><a data-primary="application platforms" data-secondary="building platform services" data-see="platform services, building" data-type="indexterm" id="idm45611979227800"/>  They are usually deployed as containerized workloads into some <code>*-system</code> Namespace and are maintained by the platform engineering team.  These platform services are distinct from the workloads managed by platform tenants, which are maintained by the application development teams.<a data-primary="services, platform" data-see="platform services, building" data-type="indexterm" id="idm45611979225816"/></p>&#13;
&#13;
<p>The cloud native ecosystem is rich with projects you can use as part of your application platform.  Additionally, there are throngs of vendors that will be happy to provide platform service solutions.  Use these wherever they pass the cost benefit analysis.  They may even take you all the way to your app platform destination.  But we have found that it’s common for enterprise users of Kubernetes-based platforms to build custom components.  You may have to integrate your Kubernetes-based platform with some existing in-house system.  You may have some unique, sophisticated workload requirements to meet.  You may have some edge cases to account for that are uncommon or specific to your business needs.  Whatever the circumstance, this chapter addresses the details of extending your application platform with custom solutions to fill these gaps.</p>&#13;
&#13;
<p>Central to this notion of building custom platform services is the effort to remove human toil.  <a data-primary="automation" data-secondary="integration of automated components" data-type="indexterm" id="idm45611979222824"/>There is more to this than just automation.  Automation is the keystone, but integration of automated components is the mortar.  Smooth, reliable interaction of systems is both challenging and critical.  This concept of API-driven software is powerful because it fosters integration of software systems. This is part of why Kubernetes has achieved such wide adoption: it enables API-driven behavior for your entire platform without the need to build and expose an API for every piece of software you add to your platform.  This software can leverage the Kubernetes API by either &#13;
<span class="keep-together">managing</span> core resources or adding custom resources to represent the state of new objects.  If we follow these patterns of integrated automation as we build our platform &#13;
<span class="keep-together">services</span>, we stand to remove tremendous human toil.  And if we succeed in this &#13;
<span class="keep-together">effort, we</span> will open up greater opportunities for innovation, development, and &#13;
<span class="keep-together">advancement</span>.</p>&#13;
&#13;
<p>In this chapter we are addressing how to extend the Kubernetes control plane.  We are taking the effective engineering patterns used by Kubernetes and using those same patterns to build upon those systems.  We will spend much of this chapter exploring Kubernetes operators, their design pattern and use cases, and how to develop them.  However, it’s important that we first take a tour of the points of extension of Kubernetes so that we can maintain a holistic view of building platform services.  It’s important that we have a clear context and apply solutions that are harmonious with the broader system.  Finally, we will examine how we may extend possibly the most important Kubernetes controller in the ecosystem: the scheduler.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Points of Extension" data-type="sect1"><div class="sect1" id="idm45611979217096">&#13;
<h1>Points of Extension</h1>&#13;
&#13;
<p>Kubernetes is a wonderfully extensible system.<a data-primary="Kubernetes" data-secondary="points of extension" data-type="indexterm" id="ix_Kubext"/><a data-primary="platform services, building" data-secondary="points of extension in Kubernetes" data-type="indexterm" id="ix_pltserext"/>  This is certainly one of its most powerful features.  A common critical error in software development is attempting to add features to meet every imaginable use case.  The system can quickly become a maze of options with unclear paths to outcomes.  Furthermore, it often becomes unstable as internal dependencies grow and brittle connections between components of the system erode reliability.  There is good reason behind the central tenets of the Unix philosophy to do one thing well and make it interoperable.  Kubernetes could never provide for every possible requirement users might encounter while orchestrating their containerized workloads.  That would be an impossible system to build.  The core functions it does provide are challenging enough.  As it is, Kubernetes is a relatively complex distributed software system, even with a pretty narrow set of concerns.  It could never meet every requirement, and it doesn’t need to since it offers points of extension that allow specialized needs to be met by specialized solutions that may be readily integrated.  It can be extended and customized to meet virtually any requirements you may have.</p>&#13;
&#13;
<p>The context of what we are calling plug-in extensions that satisfy defined interfaces with Kubernetes are largely covered elsewhere in this book, as are some of the popular webhook extension solutions.  We present a quick review of these here to paint a picture around the operator extension topic, which is where we will spend considerable time in this chapter.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Plug-in Extensions" data-type="sect2"><div class="sect2" id="idm45611979210920">&#13;
<h2>Plug-in Extensions</h2>&#13;
&#13;
<p>This is a broad class of extensions that generally help integrate Kubernetes with adjacent systems<a data-primary="platform services, building" data-secondary="points of extension in Kubernetes" data-tertiary="plug-ins" data-type="indexterm" id="idm45611979209480"/><a data-primary="plug-ins" data-secondary="extensions to Kubernetes" data-type="indexterm" id="idm45611979208200"/> that are important, and often essential, to running workloads on Kubernetes.  They are specifications that third parties can use to implement solutions, rather than implementations themselves:</p>&#13;
<dl>&#13;
<dt>Network</dt>&#13;
<dd>&#13;
<p>The Container Network Interface (CNI) defines<a data-primary="Container Networking Interface (CNI)" data-type="indexterm" id="idm45611979205048"/><a data-primary="networks" data-secondary="Container Networking Interface" data-seealso="Container Networking Interface" data-type="indexterm" id="idm45611979204376"/> the interface that must be satisfied by a plug-in to provide a network for containers to connect to.  There are many plug-ins that exist to fulfill this requirement but they all must satisfy the CNI.  This topic is covered in <a data-type="xref" href="ch05.html#chapter5">Chapter 5</a>.</p>&#13;
</dd>&#13;
<dt>Storage</dt>&#13;
<dd>&#13;
<p>The Container Storage Interface (CSI) provides a system for exposing storage systems to containerized workloads.<a data-primary="Container Storage Interface (CSI)" data-type="indexterm" id="idm45611979200520"/><a data-primary="storage" data-secondary="CSI (Container Storage Interface)" data-type="indexterm" id="idm45611979199800"/>  Again, there are many different volume plug-ins that expose storage from different providers.  This topic is explored in <a data-type="xref" href="ch04.html#chapter4">Chapter 4</a>.</p>&#13;
</dd>&#13;
<dt>Container Runtime</dt>&#13;
<dd>&#13;
<p>The Container Runtime Interface (CRI) defines a standard for the operations that need to be exposed by a container runtime such that the kubelet does not care what runtime is in use.<a data-primary="Container Runtime Interface (CRI)" data-type="indexterm" id="idm45611979196264"/>  Docker has historically been the most popular, but there are now others with their own strengths that have become popular.  We discuss this topic in detail in <a data-type="xref" href="ch03.html#container_runtime_chapter">Chapter 3</a>.</p>&#13;
</dd>&#13;
<dt>Devices</dt>&#13;
<dd>&#13;
<p>The Kubernetes device plug-in framework allows workloads to access devices on underlying nodes.  The most common example of this we have found in the field is for graphics processing units (GPUs) used by compute-intensive workloads.  Node pools are often added to clusters for nodes that have these specialized devices, allowing workloads to be assigned to them.  See <a data-type="xref" href="ch02.html#deployment_models">Chapter 2</a> for more on this topic.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The development of these plug-ins is usually carried out by vendors that either support or sell products that are integrated.  It is very rare in our experience to find platform developers building custom solutions in this area.  Instead, it is generally a matter of evaluating the available options and leveraging those that meet your requirements.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Webhook Extensions" data-type="sect2"><div class="sect2" id="idm45611979190760">&#13;
<h2>Webhook Extensions</h2>&#13;
&#13;
<p>Webhook extensions act as a backend server for the Kubernetes API server to call to fulfill custom renditions of core API functionality.<a data-primary="API server" data-secondary="webhook extensions and" data-type="indexterm" id="idm45611979189272"/><a data-primary="platform services, building" data-secondary="points of extension in Kubernetes" data-tertiary="webhook" data-type="indexterm" id="idm45611979188296"/><a data-primary="webhooks" data-secondary="extensions to Kubernetes" data-type="indexterm" id="idm45611979187048"/>  There are several steps that each request goes through when it arrives at the API server.<a data-primary="authentication" data-secondary="requests to API server" data-type="indexterm" id="idm45611979185848"/>  The client is authenticated to ensure they are permitted access (AuthN).  The API checks to ensure the client is authorized to perform the action they are requesting (AuthZ).  The API server mutates the resource as called for by enabled admission plug-ins.  The resource schema is validated, and any specialized or custom validation is performed by validating admission control. <a data-type="xref" href="#webhook_extensions_are_back_end_servers">Figure 11-1</a> illustrates the relationship between the clients, the Kubernetes API, and the webhook extensions leveraged by the API.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authentication extensions" data-type="sect3"><div class="sect3" id="idm45611979183224">&#13;
<h3>Authentication extensions</h3>&#13;
&#13;
<p>Authentication extensions, such as <a data-primary="platform services, building" data-secondary="points of extension in Kubernetes" data-tertiary="authentication" data-type="indexterm" id="idm45611979181912"/><a data-primary="authentication" data-secondary="extensions" data-type="indexterm" id="idm45611979180584"/>OpenID Connect (OIDC), provide the opportunity to offload the task of authenticating requests to the API server.  This topic is covered in depth in <a data-type="xref" href="ch10.html#chapter10">Chapter 10</a>.</p>&#13;
&#13;
<p>You can also have the API server call out to a webhook to authorize actions that can be taken on resources by authenticated users.  This is an uncommon implementation since Kubernetes has a capable Role-Based Access Control system built in.  However, if you find this system inadequate for any reason you have this option available to you.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Admission control" data-type="sect3"><div class="sect3" id="idm45611979177528">&#13;
<h3>Admission control</h3>&#13;
&#13;
<p>Admission control<a data-primary="admission control" data-secondary="extensions" data-type="indexterm" id="idm45611979176200"/> is a particularly useful and widely used extension point.<a data-primary="platform services, building" data-secondary="points of extension in Kubernetes" data-tertiary="admission control" data-type="indexterm" id="idm45611979175064"/>  If in use, when a request is sent to the API server to perform an action, the API server calls any applicable admission webhooks according to the validating and mutating admission webhook configs.  This topic is covered in <a data-type="xref" href="ch08.html#chapter8">Chapter 8</a>.</p>&#13;
&#13;
<figure><div class="figure" id="webhook_extensions_are_back_end_servers">&#13;
<img alt="prku 1101" src="assets/prku_1101.png"/>&#13;
<h6><span class="label">Figure 11-1. </span>Webhook extensions are backend servers leveraged by the Kubernetes API server.</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Operator Extensions" data-type="sect2"><div class="sect2" id="idm45611979170104">&#13;
<h2>Operator Extensions</h2>&#13;
&#13;
<p>Operators are clients of, as opposed <a data-primary="operators (Kubernetes)" data-secondary="extensions" data-type="indexterm" id="idm45611979168552"/>to backend webhooks for, the API server.<a data-primary="API server" data-secondary="operator extensions and" data-type="indexterm" id="idm45611979167448"/><a data-primary="platform services, building" data-secondary="points of extension in Kubernetes" data-tertiary="operator" data-type="indexterm" id="idm45611979166504"/>  As shown in <a data-type="xref" href="#operators_extensions_are_clients_of_the_kubernetes_api_server">Figure 11-2</a>, software operators interact as clients of the Kubernetes API, just like human operators.  These software operators are often called <em>Kubernetes Operators</em> and follow the officially documented <a href="https://oreil.ly/HLXtJ">operator pattern</a>.  Their primary purpose is to relieve toil from human operators and perform operations on their behalf.  These operator extensions follow the same engineering principles as the core Kubernetes control plane components.  When developing operator extensions as platform services, think of them as custom extensions of the control plane for your application platform.</p>&#13;
&#13;
<figure><div class="figure" id="operators_extensions_are_clients_of_the_kubernetes_api_server">&#13;
<img alt="prku 1102" src="assets/prku_1102.png"/>&#13;
<h6><span class="label">Figure 11-2. </span>Operator extensions are clients of the Kubernetes API server.</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Operator Pattern" data-type="sect1"><div class="sect1" id="operator_pattern">&#13;
<h1>The Operator Pattern</h1>&#13;
&#13;
<p>You could say that the operator pattern boils down to extending Kubernetes with Kubernetes.<a data-primary="platform services, building" data-secondary="points of extension in Kubernetes" data-startref="ix_pltserext" data-type="indexterm" id="idm45611979158536"/><a data-primary="Kubernetes" data-secondary="points of extension" data-startref="ix_Kubext" data-type="indexterm" id="idm45611979157304"/><a data-primary="platform services, building" data-secondary="operator pattern" data-type="indexterm" id="ix_pltseroppa"/><a data-primary="operator pattern" data-type="indexterm" id="ix_oppat"/>  We create new Kubernetes resources and develop Kubernetes controllers to reconcile the state defined in them.  We use Kubernetes resources called Custom Resource Definitions (CRDs) to define our new resources.  These CRDs create new API types and tell the Kubernetes API how to validate these new objects.  Then, we take the very same principles and designs that make Kubernetes controllers so effective and use those principles to build software extensions to the system.  These are the two core mechanisms that we employ when building operators: custom resources and controllers.</p>&#13;
&#13;
<p>The notion of an operator was introduced in November 2016 by Brandon Phillips, one of the founders of CoreOS.  This early definition of an operator was that an operator was an app-specific controller that managed a complex stateful application.  This is still a very useful definition but has broadened somewhat over the years to where the Kubernetes docs now classify any controller that uses CRDs as an operator.  This more general definition is the one we will use as it applies to building platform services.  Your platform services may not be “complex stateful applications” but still can benefit from using this powerful operator pattern.</p>&#13;
&#13;
<p>The following section will look at Kubernetes controllers, which provide a model for the functionality we will use in our custom controllers.  Then we will examine the custom resources that store the desired and existing state our controllers reconcile for us.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubernetes Controllers" data-type="sect2"><div class="sect2" id="idm45611979151320">&#13;
<h2>Kubernetes Controllers</h2>&#13;
&#13;
<p>Kubernetes’ core features and functionality are provided by controllers.  They watch resource types and respond to creation, mutation, and deletion of resources by fulfilling that desired state.  For example, there is a controller that comes bundled with the kube-controller-manager that watches for ReplicaSet resource types.  When a &#13;
<span class="keep-together">ReplicaSet</span> is created, the controller creates a number of identical Pods—as many as were defined by the <code>replicas</code> field in the ReplicaSet.  Then at some point later, if you change that value, the controller will create or delete Pods to satisfy the new desired state.</p>&#13;
&#13;
<p>This watch mechanism is central to the functionality of all Kubernetes controllers.  <a data-primary="API server" data-secondary="controllers and" data-type="indexterm" id="idm45611979147656"/>It is an etcd feature that is exposed by the Kubernetes API server to the controllers that need to respond to changes in resources.  The controllers hold a connection open with the API server, which allows the API server to notify the controller when a change has occurred to a resource it cares about or manages.</p>&#13;
&#13;
<p>This enables very powerful behavior.  The user can declare the desired state of the system by submitting resource manifests.  The controllers responsible for fulfilling the desired state are notified and begin working to make the existing state match the declared, desired state.  Furthermore, in addition to users submitting manifests, controllers can also do the same which, in turn, triggers operations in other controllers.  In this way you end up with a system of controllers that can provide sophisticated functionality that is stable and reliable.</p>&#13;
&#13;
<p>One important feature of these controllers is that if they cannot fulfill the desired state due to some impediment, they will continue to try on an infinite loop.  The duration between attempts to fulfill desired state may increase over time so that undue load is not placed on the system, but try it will.  This provides a self-healing behavior that is incredibly important in complex distributed systems such as this.</p>&#13;
&#13;
<p>For example, the scheduler is responsible for assigning Pods to nodes in the cluster.  The scheduler is just another Kubernetes controller, just with a particularly important and involved task.  If there are insufficient compute resources available for one or more Pods, they will go into a “Pending” state and the scheduler will continue to attempt to schedule the Pod at some interval.  As such, if compute resources free up or are added at any point, the Pod will be scheduled and run.  So if another batch workload completes and resources free up, or if a cluster autoscaler adds some worker nodes, the Pending Pod will be assigned with no further action required from a human operator.</p>&#13;
&#13;
<p>In following the operator pattern to build extensions to your application platform, it’s essential to use these design principles used by Kubernetes controllers: (1) watch resources in the Kubernetes API to get notified when changes to their desired state occur, and (2) work to reconcile existing and desired state on a nonterminating loop.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Custom Resources" data-type="sect2"><div class="sect2" id="idm45611979142392">&#13;
<h2>Custom Resources</h2>&#13;
&#13;
<p>One of the most important features of the Kubernetes API is the ability to extend the resource types it will recognize.<a data-primary="platform services, building" data-secondary="operator pattern" data-tertiary="custom resources" data-type="indexterm" id="ix_pltseropcr"/><a data-primary="operator pattern" data-secondary="custom resources" data-type="indexterm" id="ix_oppatCR"/><a data-primary="resources" data-secondary="custom" data-type="indexterm" id="ix_rescus"/><a data-primary="custom resource definitions (CRDs)" data-type="indexterm" id="ix_CRDs"/>  If you submit a valid CRD you will immediately have a new custom API type at your disposal.  The CRD contains all the fields that you will need in your custom resource both in the <code>spec</code> where you will provide the desired state for your resource and in the <code>status</code> where you can record important information about the observed, existing state.</p>&#13;
&#13;
<p>Before diving further into this topic, let’s briefly review Kubernetes resources.  We are going to be talking a lot about resources in this chapter, so it’s important to ensure we’re crystal clear on this topic.  When we talk about <em>resources</em> in Kubernetes, we are referring to the objects that are used to record state.  An example of a common resource is the Pod resource.  When you create a Pod manifest, you are defining the attributes of what will become a Pod resource.  When you submit that to the API server with <code>kubectl apply -f pod.yaml</code> or similar, you are creating an instance of the Pod API type.  On one hand you have the API type, or “kind,” which refers to the definition and form of the object as provided in a CRD.  On the other hand we have the resource that is an instantiation or instance of that kind.  The Pod is an API type or kind.  A Pod you create with the name “my-app” is a Kubernetes resource.</p>&#13;
&#13;
<p>Unlike a relational database where relationships between objects are recorded and linked by foreign keys in the database itself, each object in the Kubernetes API exists independently.  Relationships are established using labels and selectors, and it is the job of the controllers to manage relationships defined this way.  You cannot query etcd for related objects the way you can with structured query language (SQL).  So when we talk about resources, we’re talking about actual instances of Namespaces, Pods, Deployments, Secrets, ConfigMaps, etc.<a data-primary="ConfigMaps" data-type="indexterm" id="idm45611979131272"/>  When we talk about custom resources, we’re referring to user-defined resources that have been added and defined with CRDs.  When you create a CRD, you define new API types that allow you to create and manage custom resources as you would other core Kubernetes resources.</p>&#13;
&#13;
<p>CRDs use the Open API v3 schema specification for defining fields.<a data-primary="schemas" data-secondary="CRDs, use of Open API v3 schema" data-type="indexterm" id="idm45611979129768"/>  This allows for features like setting fields as optional or required as well as setting default values.  <a data-primary="API server" data-secondary="custom resources and" data-type="indexterm" id="idm45611979128488"/>This will provide validation instructions for the API server when it receives a request to create or update one of your custom resources.  In addition, you can group your APIs for improved logical organization and, very importantly, version your API types as well.</p>&#13;
&#13;
<p>To illustrate what a <a data-primary="WebApp CRD" data-type="indexterm" id="ix_WApp"/>CRD is and what a manifest for the resulting custom resource looks like, let’s look at a fictional example of a custom WebApp API type.  <a data-primary="WebApp CRD" data-secondary="Kubernetes resources in" data-type="indexterm" id="idm45611979125448"/>In this example, a WebApp resource includes the desired state for a web application that consists of the following six Kubernetes resources:</p>&#13;
<dl>&#13;
<dt>Deployment</dt>&#13;
<dd>&#13;
<p>A stateless application that provides a user interface for clients, processes requests, and stores data in a relational database</p>&#13;
</dd>&#13;
<dt>StatefulSet</dt>&#13;
<dd>&#13;
<p>The relational database that provides the persistent data store for the web &#13;
<span class="keep-together">application</span></p>&#13;
</dd>&#13;
<dt>ConfigMap</dt>&#13;
<dd>&#13;
<p>Contains the config file for the stateless application, which is mounted into each Pod of the Deployment<a data-primary="ConfigMaps" data-type="indexterm" id="idm45611979118616"/></p>&#13;
</dd>&#13;
<dt>Secret</dt>&#13;
<dd>&#13;
<p>Contains credentials for the application to connect to its database</p>&#13;
</dd>&#13;
<dt>Service</dt>&#13;
<dd>&#13;
<p>Routes traffic to the Deployment’s backend Pods</p>&#13;
</dd>&#13;
<dt>Ingress</dt>&#13;
<dd>&#13;
<p>Contains routing rules for the Ingress controller to properly route client requests into the cluster</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The creation of a WebApp resource would prompt a WebApp Operator to create these various child resources.  <a data-primary="operators (Kubernetes)" data-secondary="WebApp Operator" data-type="indexterm" id="idm45611979113240"/>These created resources would constitute a complete, functioning instance of the web application that serves clients that are end users and customers of the business.<a data-primary="WebApp CRD" data-secondary="manifest" data-type="indexterm" id="idm45611979111960"/></p>&#13;
&#13;
<p><a data-type="xref" href="#webapp_custom_resources_definition_manifest">Example 11-1</a> illustrates what a CRD might look like to define a new WebApp API type.</p>&#13;
<div data-type="example" id="webapp_custom_resources_definition_manifest">&#13;
<h5><span class="label">Example 11-1. </span>WebApp CRD manifest</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">apiextensions.k8s.io/v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">CustomResourceDefinition</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">webapps.workloads.apps.acme.com</code><code>  </code><a class="co" href="#callout_building_platform_services_CO1-1" id="co_building_platform_services_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">group</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">workloads.apps.acme.com</code><code>&#13;
</code><code>  </code><code class="nt">names</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_platform_services_CO1-2" id="co_building_platform_services_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>    </code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">WebApp</code><code>&#13;
</code><code>    </code><code class="nt">listKind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">WebAppList</code><code>&#13;
</code><code>    </code><code class="nt">plural</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">webapps</code><code>&#13;
</code><code>    </code><code class="nt">singular</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">webapp</code><code>&#13;
</code><code>  </code><code class="nt">scope</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Namespaced</code><code>&#13;
</code><code>  </code><code class="nt">versions</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1alpha1</code><code>&#13;
</code><code>    </code><code class="nt">schema</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">openAPIV3Schema</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">WebApp</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">is</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Schema</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">for</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">webapps</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">API</code><code>&#13;
</code><code>        </code><code class="nt">properties</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="nt">apiVersion</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="s">'</code><code class="s">APIVersion</code><code class="nv"> </code><code class="s">defines</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">versioned</code><code class="nv"> </code><code class="s">schema</code><code class="nv"> </code><code class="s">of</code><code class="nv"> </code><code class="s">this</code><code>&#13;
</code><code>              </code><code class="s">representation</code><code class="nv"> </code><code class="s">of</code><code class="nv"> </code><code class="s">an</code><code class="nv"> </code><code class="s">object.</code><code class="nv"> </code><code class="s">Servers</code><code class="nv"> </code><code class="s">should</code><code class="nv"> </code><code class="s">convert</code><code class="nv"> </code><code class="s">recognized</code><code>&#13;
</code><code>              </code><code class="s">schemas</code><code class="nv"> </code><code class="s">to</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">latest</code><code class="nv"> </code><code class="s">internal</code><code class="nv"> </code><code class="s">value,</code><code class="nv"> </code><code class="s">and</code><code class="nv"> </code><code class="s">may</code><code class="nv"> </code><code class="s">reject</code><code class="nv"> </code><code class="s">unrecognized</code><code>&#13;
</code><code>              </code><code class="s">values.</code><code class="s">'</code><code>&#13;
</code><code>            </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">string</code><code>&#13;
</code><code>          </code><code class="nt">kind</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="s">'</code><code class="s">Kind</code><code class="nv"> </code><code class="s">is</code><code class="nv"> </code><code class="s">a</code><code class="nv"> </code><code class="s">string</code><code class="nv"> </code><code class="s">value</code><code class="nv"> </code><code class="s">representing</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">REST</code><code class="nv"> </code><code class="s">resource</code><code class="nv"> </code><code class="s">this</code><code>&#13;
</code><code>              </code><code class="s">object</code><code class="nv"> </code><code class="s">represents.</code><code class="nv"> </code><code class="s">Servers</code><code class="nv"> </code><code class="s">may</code><code class="nv"> </code><code class="s">infer</code><code class="nv"> </code><code class="s">this</code><code class="nv"> </code><code class="s">from</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">endpoint</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">client</code><code>&#13;
</code><code>              </code><code class="s">submits</code><code class="nv"> </code><code class="s">requests</code><code class="nv"> </code><code class="s">to.</code><code class="nv"> </code><code class="s">Cannot</code><code class="nv"> </code><code class="s">be</code><code class="nv"> </code><code class="s">updated.</code><code class="nv"> </code><code class="s">In</code><code class="nv"> </code><code class="s">CamelCase.</code><code class="s">'</code><code>&#13;
</code><code>            </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">string</code><code>&#13;
</code><code>          </code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">object</code><code>&#13;
</code><code>          </code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">WebAppSpec</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">defines</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">desired</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">state</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">of</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">WebApp</code><code>&#13;
</code><code>            </code><code class="nt">properties</code><code class="p">:</code><code>&#13;
</code><code>              </code><code class="nt">deploymentTier</code><code class="p">:</code><code> </code><a class="co" href="#callout_building_platform_services_CO1-3" id="co_building_platform_services_CO1-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>                </code><code class="nt">enum</code><code class="p">:</code><code>&#13;
</code><code>                </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">dev</code><code>&#13;
</code><code>                </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">stg</code><code>&#13;
</code><code>                </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">prod</code><code>&#13;
</code><code>                </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">string</code><code>&#13;
</code><code>              </code><code class="nt">webAppHostname</code><code class="p">:</code><code>&#13;
</code><code>                </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">string</code><code>&#13;
</code><code>              </code><code class="nt">webAppImage</code><code class="p">:</code><code>&#13;
</code><code>                </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">string</code><code>&#13;
</code><code>              </code><code class="nt">webAppReplicas</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_platform_services_CO1-4" id="co_building_platform_services_CO1-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code>                </code><code class="nt">default</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">2</code><code>&#13;
</code><code>                </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">integer</code><code>&#13;
</code><code>            </code><code class="nt">required</code><code class="p">:</code><code>  </code><a class="co" href="#callout_building_platform_services_CO1-5" id="co_building_platform_services_CO1-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">deploymentTier</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">webAppHostname</code><code>&#13;
</code><code>            </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">webAppImage</code><code>&#13;
</code><code>            </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">object</code><code>&#13;
</code><code>          </code><code class="nt">status</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">WebAppStatus</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">defines</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">observed</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">state</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">of</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">WebApp</code><code>&#13;
</code><code>            </code><code class="nt">properties</code><code class="p">:</code><code>&#13;
</code><code>              </code><code class="nt">created</code><code class="p">:</code><code>&#13;
</code><code>                </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">boolean</code><code>&#13;
</code><code>            </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">object</code><code>&#13;
</code><code>        </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">object</code><code>&#13;
</code><code>    </code><code class="nt">served</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">true</code><code>&#13;
</code><code>    </code><code class="nt">storage</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">true</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_platform_services_CO1-1" id="callout_building_platform_services_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The name of the custom resource <em>definition</em>, as distinct from the name of the custom resource itself.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO1-2" id="callout_building_platform_services_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The name of the custom resource, as distinct from the definition.  This includes the variations of the name such as the plural version.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO1-3" id="callout_building_platform_services_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The <code>deploymentTier</code> field must contain one of the values listed under <code>enum</code>.  This validation will be carried out by the API server when it receives requests to create or update an instance of this custom resource.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO1-4" id="callout_building_platform_services_CO1-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The <code>webAppReplicas</code> field includes a default value that will be applied if the field is not provided.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO1-5" id="callout_building_platform_services_CO1-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The required fields are listed here.  Note that <code>webAppReplicas</code> is not included and that it has a default value.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Now let’s examine what a manifest for a WebApp would look like.  Before submitting the manifest shown in <a data-type="xref" href="#ex_11-2">Example 11-2</a> to the API server, you must first create the CRD shown in <a data-type="xref" href="#webapp_custom_resources_definition_manifest">Example 11-1</a> so that Kubernetes has an API for it.  Otherwise, it will not recognize what you are trying to create.</p>&#13;
<div data-type="example" id="ex_11-2">&#13;
<h5><span class="label">Example 11-2. </span>An example of a manifest for a WebApp resource</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">workloads.apps.acme.com/v1alpha1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">WebApp</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">webapp-sample</code><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">webAppReplicas</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">2</code><code>  </code><a class="co" href="#callout_building_platform_services_CO2-1" id="co_building_platform_services_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>  </code><code class="nt">webAppImage</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">registry.acme.com/app/app:v1.4</code><code>&#13;
</code><code>  </code><code class="nt">webAppHostname</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">app.acme.com</code><code>&#13;
</code><code>  </code><code class="nt">deploymentTier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">dev</code><code> </code><a class="co" href="#callout_building_platform_services_CO2-2" id="co_building_platform_services_CO2-2"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_platform_services_CO2-1" id="callout_building_platform_services_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This manifest specifies the default value for an optional field, which is unnecessary but fine to do if explicitness is desired.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO2-2" id="callout_building_platform_services_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>One of the permitted values for this field is used.  Any value that is not permitted would prompt the API server to reject the request with an error.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>When this WebApp manifest is submitted to the Kubernetes API, the WebApp Operator will be notified via its watch that a new instance of the WebApp kind has been created.  It will fulfill the desired state expressed in the manifest by calling the API server to create the various child resources needed to spin up an instance of the web application.<a data-primary="WebApp CRD" data-startref="ix_WApp" data-type="indexterm" id="idm45611978037064"/></p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>While the custom resource model is powerful, do not overuse it.  Do not use custom resources as the primary data store for an end-user application.  Kubernetes is a container orchestration system.  etcd should be storing the state of your software deployments, not the internal persistent data for your application.  Doing so will put significant load on your cluster’s control plane.  Stick with relational databases, object stores, or whatever data store makes sense for your application.  Leave the control plane to manage software deployments.<a data-primary="platform services, building" data-secondary="operator pattern" data-startref="ix_pltseropcr" data-tertiary="custom resources" data-type="indexterm" id="idm45611978048920"/><a data-primary="custom resource definitions (CRDs)" data-startref="ix_CRDs" data-type="indexterm" id="idm45611978047432"/><a data-primary="operator pattern" data-secondary="custom resources" data-startref="ix_oppatCR" data-type="indexterm" id="idm45611978055816"/><a data-primary="resources" data-secondary="custom" data-startref="ix_rescus" data-type="indexterm" id="idm45611978054600"/><a data-primary="platform services, building" data-secondary="operator pattern" data-startref="ix_pltseroppa" data-type="indexterm" id="idm45611978053384"/><a data-primary="operator pattern" data-startref="ix_oppat" data-type="indexterm" id="idm45611978052200"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Operator Use Cases" data-type="sect1"><div class="sect1" id="idm45611979141800">&#13;
<h1>Operator Use Cases</h1>&#13;
&#13;
<p>When developing a Kubernetes-based platform, operators offer a compelling model for adding features to that platform.<a data-primary="platform services, building" data-secondary="operator use cases" data-type="indexterm" id="ix_pltseropuse"/><a data-primary="operators (Kubernetes)" data-secondary="use cases" data-type="indexterm" id="ix_opuse"/>  If you can represent the state of the system you need to implement in the fields of a custom resource, and if you can yield value from reconciling changes using a Kubernetes controller, an operator is often a great option.</p>&#13;
&#13;
<p>In addition to platform features, operators may be used to facilitate the management of software deployments on your platform.  They can provide the convenience of a generalized abstraction or can be custom-built for the needs of a particular sophisticated application.  In either case, using software to manage software deployments is very useful.</p>&#13;
&#13;
<p>In this section we’re going to discuss the three general operator categories that you may consider using with your platform:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Platform utilities</p>&#13;
</li>&#13;
<li>&#13;
<p>General-purpose workload operators</p>&#13;
</li>&#13;
<li>&#13;
<p>App-specific operators</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Platform Utilities" data-type="sect2"><div class="sect2" id="idm45611978409192">&#13;
<h2>Platform Utilities</h2>&#13;
&#13;
<p>Operators can be extremely useful in developing your platform.<a data-primary="operators (Kubernetes)" data-secondary="use cases" data-tertiary="platform utilities" data-type="indexterm" id="idm45611978407592"/><a data-primary="platform services, building" data-secondary="operator use cases" data-tertiary="platform utilities" data-type="indexterm" id="idm45611978406344"/><a data-primary="utilities (platform)" data-type="indexterm" id="idm45611978070488"/>  They allow you to add features to your cluster and build out functionality on top of Kubernetes in a way that leverages and integrates with the control plane seamlessly.  There is a wealth of open source projects that utilize operators to provide platform services atop Kubernetes.  These projects are already available and don’t require you develop them.  The reason we bring them up in a chapter about building them is that they help build a good mental model for how they work.  Should you find yourself having to develop custom platform utilities, looking at existing successful projects will be helpful:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The <a href="https://oreil.ly/ClgDL">Prometheus Operator</a> allows you to provide metrics collection, storage, and alerting platform services on your platform.<a data-primary="Prometheus Operator" data-type="indexterm" id="idm45611978067208"/>  In <a data-type="xref" href="ch09.html#observability_chapter">Chapter 9</a> we delve into the value that can be derived from this project.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://cert-manager.io">cert-manager</a> provides certificate management as a service functionality.<a data-primary="cert-manager controller" data-type="indexterm" id="idm45611978083704"/>  It removes significant toil and potential for downtime by offering x509 certificate creation and renewal services.</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://rook.io">Rook</a> is storage operator that integrates with providers like <a href="https://ceph.io">Ceph</a> to manage block, object, and filesystem storage as a service.<a data-primary="Rook operator" data-type="indexterm" id="idm45611978115960"/></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p class="pagebreak-before">These open source solutions are examples of what is available in the community.  There are also countless vendors that can provide and support similar platform utilities.  However, when a solution is not available or not a good fit, enterprises sometimes build their own custom platform utilities.</p>&#13;
&#13;
<p>A common example of a custom platform utility we see in the field is a Namespace operator.<a data-primary="Namespace operator" data-type="indexterm" id="idm45611978113496"/>  We have found it quite common for organizations to have a standard set of resources that are created with each Namespace, such as ResourceQuotas, LimitRanges, and Roles.  And it has been a useful pattern to use a controller to take care of the routine tedium of creating these resources for each Namespace.  In a later section, we will use this Namespace operator idea as an example to illustrate some implementation details when building operators.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="General-Purpose Workload Operators" data-type="sect2"><div class="sect2" id="idm45611978080216">&#13;
<h2>General-Purpose Workload Operators</h2>&#13;
&#13;
<p>Application developers’ core competency and concern is to add stability and features to the software they build.<a data-primary="workloads" data-secondary="general-purpose workload operators" data-type="indexterm" id="idm45611978078936"/><a data-primary="operators (Kubernetes)" data-secondary="use cases" data-tertiary="general-purpose workload operators" data-type="indexterm" id="idm45611978077944"/>  It is not writing YAML for deployment to Kubernetes.  Learning how to properly define resource limits and requests, learning how to mount a ConfigMap volume or Secret as an environment variable, learning how to use label selectors to associate Services with Pods—none of these things add features or stability to their software.</p>&#13;
&#13;
<p>In an organization that has developed common patterns for deployed workloads, the model of abstracting the complexity in a general-purpose manner has considerable promise.  This is especially relevant in organizations that have embraced microservice architectures.  In these environments there may be a considerable number of distinct pieces of software that are deployed with different functionality, but with very similar patterns of deployment.</p>&#13;
&#13;
<p>For example, if your company has a large number of workloads that consist of a Deployment, Service, and Ingress resource, there are likely patterns that can be encoded into an operator that can abstract much of the resource manifests for these objects.  In each case the Service references labels on the Pods of a Deployment.  In each case the Ingress references the Service name.  All these things can easily be handled by an operator—getting these details right is the definition of toil.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="App-Specific Operators" data-type="sect2"><div class="sect2" id="idm45611978395288">&#13;
<h2>App-Specific Operators</h2>&#13;
&#13;
<p>This type of operator hits at the core of what a Kubernetes operator is: custom resources in conjunction with a custom Kubernetes controller for managing a complex stateful application.<a data-primary="application-specific operators" data-type="indexterm" id="idm45611978393752"/><a data-primary="operators (Kubernetes)" data-secondary="use cases" data-tertiary="application-specific operators" data-type="indexterm" id="idm45611978361784"/><a data-primary="platform services, building" data-secondary="operator use cases" data-tertiary="application-specific operators" data-type="indexterm" id="idm45611978360552"/>  They are purpose-built to manage a particular application.<a data-primary="database operators" data-type="indexterm" id="idm45611978359176"/>  Popular examples of this model are the various database operators in the community.  We have operators for Cassandra, Elasticsearch, MySQL, MariaDB, PostgreSQL, MongoDB and many more.  Commonly, they handle initial deployment as well as day 2 management concerns such as configuration updates, backups, and upgrades.</p>&#13;
&#13;
<p>Operators for popular community- or vendor-supported projects have gained in popularity over the past few years.  The area where this is approach is still in its infancy is in internal enterprise applications.  In cases where your organization internally develops and maintains a sophisticated stateful application, an app-specific operator may be beneficial.  For example, if your company maintains something like an ecommerce website, transaction processing app, or inventory management system that delivers critical business functionality, you may want to consider this option.  There is tremendous opportunity for reducing human toil in the deployment and day 2 management of these kinds of workloads, especially when they are deployed widely and updated frequently.</p>&#13;
&#13;
<p>This isn’t to say that these app-specific operators are the universally right choice for managing your workloads.  For simpler use cases, they are likely to be severe overkill.  Production-ready operators are not trivial to develop, so weigh the trade-offs.  How much time do you spend in routine toil managing deployment and day 2 concerns for an application?  Is the engineering cost of building an operator likely to be less than that routine toil over the long term?  Could simpler, existing tools such as Helm or Kustomize provide enough automation to sufficiently alleviate toil?<a data-primary="platform services, building" data-secondary="operator use cases" data-startref="ix_pltseropuse" data-type="indexterm" id="idm45611978104952"/><a data-primary="operators (Kubernetes)" data-secondary="use cases" data-startref="ix_opuse" data-type="indexterm" id="idm45611978103688"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Developing Operators" data-type="sect1"><div class="sect1" id="idm45611979049608">&#13;
<h1>Developing Operators</h1>&#13;
&#13;
<p>Taking on the task of developing Kubernetes<a data-primary="operators (Kubernetes)" data-secondary="developing" data-type="indexterm" id="ix_opdev"/><a data-primary="platform services, building" data-secondary="developing operators" data-type="indexterm" id="ix_pltserdevop"/> operators is not trivial, especially if tackling a full-featured, app-specific operator.  The engineering investment to get one of these more involved projects into production can be considerable.  As with other types of software development, if getting started in this area, begin with less involved projects while you become familiar with useful patterns and successful strategies.  In this section we’ll discuss some tools and design strategies that will help make developing operators a more efficient and successful endeavor.</p>&#13;
&#13;
<p>We will cover some specific projects you can leverage to help in development of such tools.  And then we’ll break down the process of designing and implementing this kind of software in detail.  We’ll include some code snippets to illustrate the concepts and best practices.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Operator Development Tooling" data-type="sect2"><div class="sect2" id="idm45611979088824">&#13;
<h2>Operator Development Tooling</h2>&#13;
&#13;
<p>If you have a compelling use case for a custom Kubernetes operator, there are a couple of community projects that can be very helpful in your endeavor.<a data-primary="platform services, building" data-secondary="developing operators" data-tertiary="tools for" data-type="indexterm" id="ix_pltserdevoptool"/><a data-primary="operators (Kubernetes)" data-secondary="developing" data-tertiary="tools for" data-type="indexterm" id="ix_opdevtool"/>  If you are—or have on staff—an experienced Go programmer that is familiar with the Kubernetes client-go library and with developing Kubernetes operators, you can certainly write your operators from scratch.  However, there are common components to every operator, and using tools to generate boilerplate source code and utilities are expediencies that even seasoned operator developers commonly use.  They just save time.  Software development kits (SDKs) and frameworks can be helpful when they fit the pattern of software you’re developing.  However, they can be a nuisance if they make assumptions that don’t suit your purpose.  If your project fits the standard model of using one or more custom resources to define configuration, and custom controllers to implement behavior associated with these objects, it is likely the tools we discuss here will be useful.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubebuilder" data-type="sect3"><div class="sect3" id="idm45611978383800">&#13;
<h3>Kubebuilder</h3>&#13;
&#13;
<p>Kubebuilder can be described as an SDK for building Kubernetes APIs.<a data-primary="Kubebuilder project" data-type="indexterm" id="idm45611978382264"/>  This is an apt description but is not exactly what you might expect.  Using kubebuilder begins with the command-line tool that you use to generate boilerplate.  It stamps out the source code, a Dockerfile, a Makefile, sample Kubernetes manifests—all the things you need to write for every such project.  As such, it saves a ton of time in getting a project started.</p>&#13;
&#13;
<p>Kubebuilder also leverages a collection of tools in a related project called controller-runtime.  The required imports and common implementations are included in the source code generated by the CLI.  These help with much of the routine heavy lifting of running a controller and interacting with the Kubernetes API.  <a data-primary="API server" data-secondary="Kubebuilder facilitating interactions with" data-type="indexterm" id="idm45611977973560"/>It helps with setting up shared caches and clients to provide efficient interaction with the API server.  The cache allows your controller to list and get objects without new requests to the API server for each query, which eases load on the API server and speeds up reconciliation.  Controller-runtime also provides mechanisms for triggering reconcile requests in response to events such as resource changes.  These reconciliations will be triggered by default for the parent custom resource.  They can—and usually should—also be triggered when changes occur to child resources created by the controller and functions are available to do so.  If running your controller in highly available (HA) mode, controller-runtime provides the opportunity to enable leader election to ensure just one controller is active at any given time.  Furthermore, controller-runtime includes a package to implement webhooks, which are often used for admission control.  Lastly, the library includes facilities to write structured logs and expose Prometheus metrics for observability.</p>&#13;
&#13;
<p>Kubebuilder is a great choice if you are a Go programmer with Kubernetes experience.  It is even a good choice if you are an experienced software developer but are new to the Go programming language.  But it is exclusively for Go—it doesn’t cater to other languages.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>If you are going to be developing tools for Kubernetes, you should strongly consider learning Go if you don’t know it already.<a data-primary="Go language" data-type="indexterm" id="idm45611979037352"/><a data-primary="programming languages" data-type="indexterm" id="idm45611979036648"/>  You can certainly use other languages.<a data-primary="client libraries, supported programming languages" data-type="indexterm" id="idm45611979035848"/>  Kubernetes offers a REST API, after all.  And there are officially supported client libraries for Python, Java, C#, JavaScript, and Haskell, not to mention many other community-supported libraries.<a data-primary="Python" data-type="indexterm" id="idm45611979034872"/><a data-primary="Java" data-type="indexterm" id="idm45611979034200"/><a data-primary="C#" data-type="indexterm" id="idm45611979033528"/><a data-primary="JavaScript" data-type="indexterm" id="idm45611979032856"/><a data-primary="Haskell" data-type="indexterm" id="idm45611979032184"/>  If you have important reasons for using these, you can certainly be successful.  However, Kubernetes itself is written in Go, and the ecosystem for that language in the world of Kubernetes is rich and well-supported.</p>&#13;
</div>&#13;
&#13;
<p>One of the features of Kubebuilder that make it such a time-saver is its generation of CRDs.  Writing a CRD manifest by hand is no joke.  The OpenAPI v3 spec that is used to define these custom APIs is pretty detailed and involved.  The Kubebuilder CLI will generate the files where you will define the fields for your custom API types.  You add the various fields to the struct definitions and tag them with special markers that provide metadata such as default values.  Then you can use a make target to generate the CRD manifests.  It is very handy.</p>&#13;
&#13;
<p>On the subject of make targets, in addition to generating CRDs, you can generate the RBAC and sample custom resource manifests, install the custom resources in your development cluster, build and publish images for your operator, and run your controller locally against a cluster during development.  Having conveniences for all these tedious, time-consuming tasks really is a productivity boost, especially early in the project.</p>&#13;
&#13;
<p>For these reasons, we prefer and recommend Kubebuilder for building operators.  It has been adopted and used with success in a variety of projects.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Metacontroller" data-type="sect3"><div class="sect3" id="idm45611978098664">&#13;
<h3>Metacontroller</h3>&#13;
&#13;
<p>If your comfort with a particular programming language besides Go compels you to stick with it, another useful option to aid in developing operators is Metacontroller.<a data-primary="Metacontroller" data-type="indexterm" id="idm45611978097080"/>  This is an entirely different approach to developing and deploying operators, but it is one that is worth considering if you want to use a variety of languages and expect to deploy a number of custom in-house operators with your platform.  Engineers experienced in programming Kubernetes will also sometimes use Metacontroller for prototyping and then use Kubebuilder for the final project once design and implementation details have been established.  And this alludes to one of the strengths of Metacontroller: once you have the Metacontroller add-on installed in your cluster, it is fast to get going.</p>&#13;
&#13;
<p>That is essentially what Metacontroller is: a cluster add-on that abstracts away the interaction with the Kubernetes API.  Your job is to write the controller webhook that contains your controller’s logic.<a data-primary="lambda controller" data-type="indexterm" id="idm45611978095016"/>  Metacontroller calls this the <em>lambda controller</em>.  Your lambda controller makes decisions about what to do with the resources it cares about.  Metacontroller watches the resources under management and alerts your controller with an HTTP call when there is a change it needs to make a decision about.  Metacontroller itself uses custom resources that define the characteristics of your webhook, e.g., its URL and the resources it manages.  As such, once Metacontroller is running in your cluster, adding a controller consists of deploying your lambda &#13;
<span class="keep-together">controller</span> webhook and adding a Metacontroller custom resource; e.g., composite controller resource.  And all your new controller need do is expose an endpoint that will accept requests from Metacontroller, parse JSON payloads that contain the Kubernetes resource object in question, and then return a response to Metacontroller with any changes to be sent to the Kubernetes API. <a data-type="xref" href="#metacontroller_abstracts_the_kubernetes_api_for_your_lamda_controller">Figure 11-3</a> illustrates how these components interact when using Metacontroller.</p>&#13;
&#13;
<figure><div class="figure" id="metacontroller_abstracts_the_kubernetes_api_for_your_lamda_controller">&#13;
<img alt="prku 1103" src="assets/prku_1103.png"/>&#13;
<h6><span class="label">Figure 11-3. </span>Metacontroller abstracts the Kubernetes API for your lambda controller.</h6>&#13;
</div></figure>&#13;
&#13;
<p>What Metacontroller does not help with is the creation of any CRDs you may need to add to your cluster.  You are on your own there.  If you are writing a controller that responds to changes in core Kubernetes resources, this won’t be an issue.  But if you’re developing custom resources, this is an area where Kubebuilder has a significant advantage.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Operator Framework" data-type="sect3"><div class="sect3" id="idm45611979063704">&#13;
<h3>Operator Framework</h3>&#13;
&#13;
<p>The Operator Framework is a collection of open source tools that originated at Red Hat and are now under the CNCF umbrella as an incubating project.<a data-primary="Operator Framework" data-type="indexterm" id="idm45611979062216"/>  This framework facilitates the development of operators.  It includes the Operator SDK, which offers similar functionality to Kubebuilder when developing operators using Go.  Like Kubebuilder, it provides a CLI to generate boilerplate for projects.  Also like Kubebuilder, it uses the controller-runtime tools to help integrate with the Kubernetes API.  In addition to Go projects, the Operator SDK allows developers to use Helm or Ansible to manage operations.  The framework also includes the Operator Lifecycle Manager, which is what it sounds like: an operator for your operators.  It provides abstractions for installing and upgrading your operators.  The project also maintains an operator hub, which offers a way for users to discover operators for software they use.  We have not encountered platform teams using these tools in the field.  Being a Red Hat-maintained project, it is likely more common among users of OpenShift, a Red Hat Kubernetes-based offering.<a data-primary="platform services, building" data-secondary="developing operators" data-startref="ix_pltserdevoptool" data-tertiary="tools for" data-type="indexterm" id="idm45611979060392"/><a data-primary="operators (Kubernetes)" data-secondary="developing" data-startref="ix_opdevtool" data-tertiary="tools for" data-type="indexterm" id="idm45611979082760"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Data Model Design" data-type="sect2"><div class="sect2" id="idm45611979081128">&#13;
<h2>Data Model Design</h2>&#13;
&#13;
<p>Just as you might begin the design of a web application by defining the database schema the app will use to<a data-primary="operators (Kubernetes)" data-secondary="developing" data-tertiary="data model design" data-type="indexterm" id="ix_opdevDM"/><a data-primary="platform services, building" data-secondary="developing operators" data-tertiary="data model design" data-type="indexterm" id="ix_pltserdevopDM"/><a data-primary="data model design for operators" data-type="indexterm" id="ix_damod"/> persist data, a great place to start when building an operator is the data model for the custom resources your operator will use.  In fact, you will probably have some idea of what fields your custom resource will need in its spec before you get started.  As soon as you recognize a problem to solve or gap to fill, the attributes of the object that defines desired state will begin to take shape.</p>&#13;
&#13;
<p>In the example from earlier in this chapter, the Namespace operator, it could begin as an operator that will create a variety of resources: LimitRange, ResourceQuota, Roles, and NetworkPolicies to go along with a new Namespace for an app dev team.  You may want to bind a team lead to the <code>namespace-admin</code> Role right away and then hand off management of the Namespace to that person.  This would naturally lead you to add an <code>adminUsername</code> field to the spec of the custom resource.  The custom resource manifest might look something like <a data-type="xref" href="#ex_11-3">Example 11-3</a>.</p>&#13;
<div data-type="example" id="ex_11-3">&#13;
<h5><span class="label">Example 11-3. </span>An example of a manifest for an AcmeNamespace resource</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">tenancy.acme.com/v1alapha1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">AcmeNamespace</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">team-x</code><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">namespaceName</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">app-y</code><code>  </code><a class="co" href="#callout_building_platform_services_CO3-1" id="co_building_platform_services_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>  </code><code class="nt">adminUsername</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">sam</code><code>  </code><a class="co" href="#callout_building_platform_services_CO3-2" id="co_building_platform_services_CO3-2"><img alt="2" src="assets/2.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_platform_services_CO3-1" id="callout_building_platform_services_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>An arbitrary name for the Namespace—in this case it will host a workload, &#13;
<span class="keep-together">“app-y.”</span></p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO3-2" id="callout_building_platform_services_CO3-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>This username would correspond to that which is used by the company’s identity provider, usually an Active Directory system or similar.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Submitting the manifest in <a data-type="xref" href="#ex_11-3">Example 11-3</a> would result in the username <code>sam</code> being added to the subjects of a RoleBinding to the <code>namespace-admin</code> Role in the manner shown in <a data-type="xref" href="#ex_11-4">Example 11-4</a>.</p>&#13;
<div data-type="example" id="ex_11-4">&#13;
<h5><span class="label">Example 11-4. </span>Example of a Role and Rolebinding created for the <code>team-x</code> AcmeNamespace</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">rbac.authorization.k8s.io/v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Role</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">namespace-admin</code><code>&#13;
</code><code>  </code><code class="nt">namespace</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">app-y</code><code>&#13;
</code><code class="nt">rules</code><code class="p">:</code><code>&#13;
</code><code class="p-Indicator">-</code><code> </code><code class="nt">apiGroups</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="s">"</code><code class="s">*</code><code class="s">"</code><code>&#13;
</code><code>  </code><code class="nt">resources</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="s">"</code><code class="s">*</code><code class="s">"</code><code>&#13;
</code><code>  </code><code class="nt">verbs</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="s">"</code><code class="s">*</code><code class="s">"</code><code>&#13;
</code><code class="nn">---</code><code>&#13;
</code><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">rbac.authorization.k8s.io/v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">RoleBinding</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">namespace-admin</code><code>&#13;
</code><code>  </code><code class="nt">namespace</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">app-y</code><code>&#13;
</code><code class="nt">roleRef</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">apiGroup</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">rbac.authorization.k8s.io</code><code>&#13;
</code><code>  </code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Role</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">namespace-admin</code><code>&#13;
</code><code class="nt">subjects</code><code class="p">:</code><code>&#13;
</code><code class="p-Indicator">-</code><code> </code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">User</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">sam</code><code>  </code><a class="co" href="#callout_building_platform_services_CO4-1" id="co_building_platform_services_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>  </code><code class="nt">namespace</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">app-y</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_platform_services_CO4-1" id="callout_building_platform_services_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The <code>adminUsername</code> provided in the AcmeNamespace manifest would get inserted here to be bound to the <code>namespace-admin</code> Role.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>When thinking about the behavior you want, having Sam bound to the <code>namespace-admin</code> Role, the data needed to accomplish this becomes pretty clear: Sam’s username and the name of the Namespace.  So start with the obvious pieces of data that you will need to provide functionality and define fields in the spec for your CRD from that.  What that would look like as part of a Kubebuilder project would be similar to what is shown in <a data-type="xref" href="#ex_11-5">Example 11-5</a>.</p>&#13;
<div data-type="example" id="ex_11-5">&#13;
<h5><span class="label">Example 11-5. </span>Type definition for the <code>AcmeNamespaceSpec</code></h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// api/v1alpha1/acmenamespace_types.go</code>&#13;
&#13;
<code class="o">...</code>&#13;
&#13;
<code class="c1">// AcmeNamespaceSpec defines the desired state of AcmeNamespace</code>&#13;
<code class="kd">type</code> <code class="nx">AcmeNamespaceSpec</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
&#13;
    <code class="c1">// The name of the namespace</code>&#13;
    <code class="nx">NamespaceName</code> <code class="kt">string</code> <code class="s">`json:"namespaceName"`</code>&#13;
&#13;
    <code class="c1">// The username for the namespace admin</code>&#13;
    <code class="nx">AdminUsername</code> <code class="kt">string</code> <code class="s">`json:"adminUsername"`</code>&#13;
<code class="o">...</code></pre></div>&#13;
&#13;
<p>This is the source code from which Kubebuilder will generate your CRD manifest and the sample AcmeNamespace manifest to use for testing and demonstration.</p>&#13;
&#13;
<p>Now that we have a data model that we <em>think</em> will allow us to adequately manage state for the behavior we want, it’s time to start writing the controller.  It’s probable we will find our data model inadequate as we develop and find there are additional fields that will be necessary to bring about our desired outcomes.  But this is a useful place to start for now.<a data-primary="operators (Kubernetes)" data-secondary="developing" data-startref="ix_opdevDM" data-tertiary="data model design" data-type="indexterm" id="idm45611978837384"/><a data-primary="platform services, building" data-secondary="developing operators" data-startref="ix_pltserdevopDM" data-tertiary="data model design" data-type="indexterm" id="idm45611978835992"/><a data-primary="data model design for operators" data-startref="ix_damod" data-type="indexterm" id="idm45611978834072"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Logic Implementation" data-type="sect2"><div class="sect2" id="idm45611979080536">&#13;
<h2>Logic Implementation</h2>&#13;
&#13;
<p>The logic is implemented in our controller.<a data-primary="logic implementation for operators" data-type="indexterm" id="ix_logic"/><a data-primary="operators (Kubernetes)" data-secondary="developing" data-tertiary="logic implementation" data-type="indexterm" id="ix_opdevlogic"/>  The primary job of the controller is to manage one or more custom resources.  The controller will keep a watch on those custom resources under management.  This part is trivial to implement when using tools like Kubebuilder and Metacontroller.  It is pretty straightforward even if just using the client-go library, the GitHub repo for which has excellent code examples to refer to.  With a watch on its custom resource/s, your controller will be notified of any changes to resources of this type.  The job of your controller at this point is as follows:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Gather an accurate picture of the existing state of the system</p>&#13;
</li>&#13;
<li>&#13;
<p>Examine the desired state of the system</p>&#13;
</li>&#13;
<li>&#13;
<p>Take the required actions to reconcile the existing state with desired state</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Existing state" data-type="sect3"><div class="sect3" id="idm45611978845752">&#13;
<h3>Existing state</h3>&#13;
&#13;
<p>There are essentially three places <a data-primary="logic implementation for operators" data-secondary="existing state" data-type="indexterm" id="idm45611978851512"/><a data-primary="state" data-secondary="existing state of the sysem" data-type="indexterm" id="idm45611978849880"/>your controller may gather existing state information from:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The <code>status</code> of your custom resource</p>&#13;
</li>&#13;
<li>&#13;
<p>Other related resources in the cluster</p>&#13;
</li>&#13;
<li>&#13;
<p>Relevant conditions outside the cluster or in other systems</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The <code>status</code> field provides a place for controllers in Kubernetes to record observed, existing state.  For example, Kubernetes uses a <code>status.phase</code> field on some resources, such as Pods and Namespaces, to keep track of whether the resource is <code>Running</code> (for Pods) or <code>Active</code> (for Namespaces).</p>&#13;
&#13;
<p>Let’s go back to the example of a Namespace operator.  The controller is notified of a new AcmeNamespace resource along with the spec for it.  The controller cannot assume it is a new resource and just robotically create the child Namespace and Role resources.  What if it’s a preexisting resource that has simply been updated with some change?  Attempting to create the child resources again will get an error from the Kubernetes API.  However, to follow the preceding Kubernetes example, if we include a <code>phase</code> field in the <code>status</code> of our CRD, the controller can check it to evaluate existing state.  When it is first created, the controller will find the <code>status.phase</code> field empty.  This will tell the controller it is a new resource creation, and should go ahead with creating all child resources.  Once all children are created with successful responses from the API, the controller can populate the <code>status.phase</code> field with a value of <code>Created</code>.  Then if the AcmeNamespace resource is later changed, when the controller is notified, it can see from this field that it has been previously created and move on to other reconciliation steps.</p>&#13;
&#13;
<p>The use of the <code>status.phase</code> field to determine existing state as described so far has one critical flaw.  It assumes the controller itself will never fail.  What if a problem is encountered while creating the child resources?  Say, for example, the controller gets notified of a new AcmeNamespace, creates the child Namespace, but then goes down before it can create the associated Role resources.  When the controller comes back up, it will find the AcmeNamespace resource <em>without</em> <code>Created</code> in the <code>status.phase</code> field, attempt to create the child Namespace, and fail without a satisfactory way to reconcile the situation.  In order to prevent this, the controller can add a <code>CreationInProgress</code> value to the <code>status.phase</code> as the very first step when it finds a new AcmeNamespace has been created.  This way, if that failure during creation occurs, when the controller comes back up and sees the <code>CreationInProgress</code> phase, it will know that existing state cannot be accurately determined from the <code>status</code> alone.  This is where it will need to look to other related resources in the cluster to determine existing state.</p>&#13;
&#13;
<p>When existing state cannot be ascertained from the AcmeNamespace <code>status</code>, it can query the API server—or preferably the local cache of objects in the API server—for conditions it cares about.  If it finds the phase of an AcmeNamespace set to <code>CreationInProgress</code> it can start querying the API server for the existence of child resources it expects to be there.  In the failure example we’re using, it would query for a child Namespace, find it exists, and move on.  It would query for the Role resource, find it <em>doesn’t</em> exist, and proceed with creating those resources.  In this manner our controller can be tolerant of failure.  And we should always assume failure will occur and develop controller logic accordingly.</p>&#13;
&#13;
<p>Furthermore, sometimes our controller will be interested in existing state outside the cluster.  Cloud infrastructure controllers are a good example of this.  The status of infrastructure systems must be queried from cloud provider APIs outside the cluster.  What this existing state may be will be highly dependent on the purpose of the operator in question and will usually be clear.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Desired state" data-type="sect3"><div class="sect3" id="idm45611978878136">&#13;
<h3>Desired state</h3>&#13;
&#13;
<p>The desired state for a system is expressed in the <code>spec</code> for the relevant resources.<a data-primary="state" data-secondary="desired state for a system" data-type="indexterm" id="idm45611978875448"/><a data-primary="logic implementation for operators" data-secondary="desired state" data-type="indexterm" id="idm45611978882216"/>  In our Namespace operator, the desired state provided by the <code>namespaceName</code> informs the controller what the <code>metadata.name</code> field should be for the resulting Namespace.  The <code>adminUsername</code> field determines what the <code>namespace-admin</code> RoleBinding’s <code>subjects[0].name</code> should be.  These are examples of direct mappings of desired state to fields in child resources.  Often, the implementation is less direct.</p>&#13;
&#13;
<p>We saw an example of this with the use of the <code>deploymentTier</code> field in the <code>AcmeStore</code> example earlier in this chapter.  It allowed a user to specify a single variable that informed the controller logic on what default values to use.  We can apply a very similar idea to the Namespace operator.  Our new, modified AcmeNamespace manifest could look like <a data-type="xref" href="#ex_11-6">Example 11-6</a>.</p>&#13;
<div data-type="example" id="ex_11-6">&#13;
<h5><span class="label">Example 11-6. </span>The AcmeNamespace manifest with new fields added</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">tenancy.acme.com/v1alapha1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">AcmeNamespace</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">team-x</code><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">namespaceName</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">app-y</code><code>&#13;
</code><code>  </code><code class="nt">adminUsername</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">sam</code><code>&#13;
</code><code>  </code><code class="nt">deploymentTier</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">dev</code><code>  </code><a class="co" href="#callout_building_platform_services_CO5-1" id="co_building_platform_services_CO5-1"><img alt="1" src="assets/1.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_platform_services_CO5-1" id="callout_building_platform_services_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>New addition to the data model for the AcmeNamespace API type.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This will prompt the controller to create a ResourceQuota that could look like <a data-type="xref" href="#ex_11-7">Example 11-7</a>.</p>&#13;
<div data-type="example" id="ex_11-7">&#13;
<h5><span class="label">Example 11-7. </span>The ResourceQuota created for the <code>team-x</code> AcmeNamespace</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">v1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">ResourceQuota</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">dev</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="nt">hard</code><code class="p">:</code>&#13;
    <code class="nt">cpu</code><code class="p">:</code> <code class="s">"5"</code>&#13;
    <code class="nt">memory</code><code class="p">:</code> <code class="l-Scalar-Plain">10Gi</code>&#13;
    <code class="nt">pods</code><code class="p">:</code> <code class="s">"10"</code></pre></div>&#13;
&#13;
<p>Whereas the default ResourceQuota for <code>deploymentTier: prod</code> may look like <a data-type="xref" href="#ex_11-8">Example 11-8</a>.</p>&#13;
<div data-type="example" id="ex_11-8">&#13;
<h5><span class="label">Example 11-8. </span>An alternative ResourceQuota created when <code>deploymentTier:</code> <code>prod</code> is given in the AcmeNamespace</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">v1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">ResourceQuota</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">prod</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="nt">hard</code><code class="p">:</code>&#13;
    <code class="nt">cpu</code><code class="p">:</code> <code class="s">"500"</code>&#13;
    <code class="nt">memory</code><code class="p">:</code> <code class="l-Scalar-Plain">200Gi</code>&#13;
    <code class="nt">pods</code><code class="p">:</code> <code class="s">"100"</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Reconciliation" data-type="sect3"><div class="sect3" id="idm45611978204152">&#13;
<h3>Reconciliation</h3>&#13;
&#13;
<p>In Kubernetes, reconciliation is the process of altering the existing state to match the desired state.<a data-primary="reconciliation" data-type="indexterm" id="idm45611978672376"/><a data-primary="logic implementation for operators" data-secondary="reconciliation of existing and desired state" data-type="indexterm" id="idm45611978671704"/><a data-primary="state" data-secondary="reconciliation of existing state to desired state" data-type="indexterm" id="idm45611978670760"/>  This can be as simple as the kubelet requesting the container runtime stop containers associated with a deleted Pod.  Or it can be more complex, such as an operator creating an array of new resources in response to a custom resource that represents a stateful application.  These are examples of reconciliation triggered by creating or deleting the resources that express desired state.  But very often the reconciliation involves a response to a mutation.</p>&#13;
&#13;
<p>A simple mutation example is if you update the number of replicas on a Deployment resource from 5 to 10.  The existing state is 5 Pods for a workload.  The desired state is 10 Pods.  The reconciliation performed by the Deployment controller in this case involves updating the replicas on the relevant ReplicaSet.  The ReplicaSet controller then reconciles state by creating 5 new Pod resources which are, in turn, scheduled by the scheduler, which prompts the applicable kubelets to request new containers from the container runtime.</p>&#13;
&#13;
<p>Another mutation example that is a little more involved is if you change the image in a Deployment spec.  This is usually to update the version of a running application.  By default, the Deployment controller will perform a rolling update as it reconciles state.  It will create a <em>new</em> ReplicaSet for the new version of the app, increment the replicas on the new ReplicaSet, and decrement the replicas on the old ReplicaSet so that the Pods are replaced one at a time.  Once all new image versions are running with the desired number of replicas, reconciliation is complete.</p>&#13;
&#13;
<p>What reconciliation looks like for a custom controller managing a custom resource is going to vary greatly according to what the custom resource represents.  But one thing that should remain constant is that if reconciliation is not successful due to a condition that is beyond the domain of the controller, it should retry indefinitely.  Generally speaking, the reconciliation loop should implement increasing delays between iterations.  For example, if it is reasonable to expect other systems in the cluster to be actively reconciling state that is preventing a controller from completing its operations, you may retry 1 second later.  However, for the sake of preventing gratuitous resource consumption, it is recommended to exponentially increase the delay between each iteration until it reaches some reasonable limit of, say, 5 minutes.  At that point, the controller will retry reconciliation once every 5 minutes.  This allows for unattended resolving of systems while limiting resource consumption and network traffic in circumstances that aren’t resolving quickly.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Implementation details" data-type="sect3"><div class="sect3" id="idm45611978179944">&#13;
<h3>Implementation details</h3>&#13;
&#13;
<p>In broad terms, to implement initial controller functionality for the Namespace <a data-primary="logic implementation for operators" data-secondary="implementation details" data-type="indexterm" id="ix_logicimpl"/>operator, we want to be able to:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Write or generate a concise AcmeNamespace manifest like the earlier example</p>&#13;
</li>&#13;
<li>&#13;
<p>Submit the manifest to the Kubernetes API</p>&#13;
</li>&#13;
<li>&#13;
<p>Have a controller respond by creating a Namespace, ResourceQuota, LimitRange, Roles, and a RoleBinding.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In a kubebuilder project, the logic to create these resources will live in a <code>Reconcile</code> method.  The initial implementation of creating a Namespace with the controller could look like <a data-type="xref" href="#ex_11-9">Example 11-9</a>.</p>&#13;
<div data-type="example" id="ex_11-9">&#13;
<h5><span class="label">Example 11-9. </span>The <code>Reconcile</code> method for the AcmeNamespace controller</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// controllers/acmenamespace_controller.go&#13;
</code><code>&#13;
</code><code class="kn">package</code><code> </code><code class="nx">controllers</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>	</code><code class="s">"context"</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="s">"github.com/go-logr/logr"</code><code>&#13;
</code><code>	</code><code class="nx">corev1</code><code> </code><code class="s">"k8s.io/api/core/v1"</code><code>&#13;
</code><code>	</code><code class="nx">metav1</code><code> </code><code class="s">"k8s.io/apimachinery/pkg/apis/meta/v1"</code><code>&#13;
</code><code>	</code><code class="s">"k8s.io/apimachinery/pkg/runtime"</code><code>&#13;
</code><code>	</code><code class="nx">ctrl</code><code> </code><code class="s">"sigs.k8s.io/controller-runtime"</code><code>&#13;
</code><code>	</code><code class="s">"sigs.k8s.io/controller-runtime/pkg/client"</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="nx">tenancyv1alpha1</code><code> </code><code class="s">"github.com/lander2k2/namespace-operator/api/v1alpha1"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="o">...</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">r</code><code> </code><code class="o">*</code><code class="nx">AcmeNamespaceReconciler</code><code class="p">)</code><code> </code><code class="nx">Reconcile</code><code class="p">(</code><code class="nx">req</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code><code> </code><code class="p">(</code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">ctx</code><code> </code><code class="o">:=</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="nx">log</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Log</code><code class="p">.</code><code class="nx">WithValues</code><code class="p">(</code><code class="s">"acmenamespace"</code><code class="p">,</code><code> </code><code class="nx">req</code><code class="p">.</code><code class="nx">NamespacedName</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="kd">var</code><code> </code><code class="nx">acmeNs</code><code> </code><code class="nx">tenancyv1alpha1</code><code class="p">.</code><code class="nx">AcmeNamespace</code><code>  </code><a class="co" href="#callout_building_platform_services_CO6-1" id="co_building_platform_services_CO6-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
	</code><code class="nx">r</code><code class="p">.</code><code class="nx">Get</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">req</code><code class="p">.</code><code class="nx">NamespacedName</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">acmeNs</code><code class="p">)</code><code>  </code><a class="co" href="#callout_building_platform_services_CO6-2" id="co_building_platform_services_CO6-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
	</code><code class="nx">nsName</code><code> </code><code class="o">:=</code><code> </code><code class="nx">acmeNs</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">NamespaceName</code><code>&#13;
</code><code>	</code><code class="nx">adminUsername</code><code> </code><code class="o">:=</code><code> </code><code class="nx">acmeNs</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">AdminUsername</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="nx">ns</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">{</code><code>  </code><a class="co" href="#callout_building_platform_services_CO6-3" id="co_building_platform_services_CO6-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
		</code><code class="nx">ObjectMeta</code><code class="p">:</code><code> </code><code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="nx">nsName</code><code class="p">,</code><code>&#13;
</code><code>			</code><code class="nx">Labels</code><code class="p">:</code><code> </code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code>&#13;
</code><code>				</code><code class="s">"admin"</code><code class="p">:</code><code> </code><code class="nx">adminUsername</code><code class="p">,</code><code>&#13;
</code><code>			</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Create</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">ns</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>  </code><a class="co" href="#callout_building_platform_services_CO6-4" id="co_building_platform_services_CO6-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
		</code><code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code> </code><code class="s">"unable to create namespace"</code><code class="p">)</code><code>&#13;
</code><code>		</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="kc">nil</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="o">...</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_platform_services_CO6-1" id="callout_building_platform_services_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The variable that will represent the AcmeNamespace object that has been created, updated, or deleted.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO6-2" id="callout_building_platform_services_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Fetching the content of the AcmeNamespace object from the request.  Error catching omitted for brevity.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO6-3" id="callout_building_platform_services_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Creating the new Namespace object.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO6-4" id="callout_building_platform_services_CO6-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Creating the new Namespace resource in the Kubernetes API.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This simplified snippet demonstrates the controller creating the new Namespace.  Adding the Role and RoleBinding for the Namespace admin to the controller would look similar, as shown in <a data-type="xref" href="#ex_11-10">Example 11-10</a>.</p>&#13;
<div data-type="example" id="ex_11-10">&#13;
<h5><span class="label">Example 11-10. </span>The creation of the Role and RoleBinding by the AcmeNamespace controller</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// controllers/acmenamespace_controller.go</code>&#13;
<code class="o">...</code>&#13;
	<code class="nx">role</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="nx">rbacv1</code><code class="p">.</code><code class="nx">Role</code><code class="p">{</code>&#13;
		<code class="nx">ObjectMeta</code><code class="p">:</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">{</code>&#13;
			<code class="nx">Name</code><code class="p">:</code>      <code class="s">"namespace-admin"</code><code class="p">,</code>&#13;
			<code class="nx">Namespace</code><code class="p">:</code> <code class="nx">nsName</code><code class="p">,</code>&#13;
		<code class="p">},</code>&#13;
		<code class="nx">Rules</code><code class="p">:</code> <code class="p">[]</code><code class="nx">rbacv1</code><code class="p">.</code><code class="nx">PolicyRule</code><code class="p">{</code>&#13;
			<code class="p">{</code>&#13;
				<code class="nx">APIGroups</code><code class="p">:</code> <code class="p">[]</code><code class="kt">string</code><code class="p">{</code><code class="s">"*"</code><code class="p">},</code>&#13;
				<code class="nx">Resources</code><code class="p">:</code> <code class="p">[]</code><code class="kt">string</code><code class="p">{</code><code class="s">"*"</code><code class="p">},</code>&#13;
				<code class="nx">Verbs</code><code class="p">:</code>     <code class="p">[]</code><code class="kt">string</code><code class="p">{</code><code class="s">"*"</code><code class="p">},</code>&#13;
			<code class="p">},</code>&#13;
		<code class="p">},</code>&#13;
	<code class="p">}</code>&#13;
&#13;
	<code class="k">if</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">r</code><code class="p">.</code><code class="nx">Create</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code> <code class="nx">role</code><code class="p">);</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
		<code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="s">"unable to create namespace-admin role"</code><code class="p">)</code>&#13;
		<code class="k">return</code> <code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="nx">err</code>&#13;
	<code class="p">}</code>&#13;
&#13;
	<code class="nx">binding</code> <code class="o">:=</code> <code class="o">&amp;</code><code class="nx">rbacv1</code><code class="p">.</code><code class="nx">RoleBinding</code><code class="p">{</code>&#13;
		<code class="nx">ObjectMeta</code><code class="p">:</code> <code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">{</code>&#13;
			<code class="nx">Name</code><code class="p">:</code>      <code class="s">"namespace-admin"</code><code class="p">,</code>&#13;
			<code class="nx">Namespace</code><code class="p">:</code> <code class="nx">nsName</code><code class="p">,</code>&#13;
		<code class="p">},</code>&#13;
		<code class="nx">RoleRef</code><code class="p">:</code> <code class="nx">rbacv1</code><code class="p">.</code><code class="nx">RoleRef</code><code class="p">{</code>&#13;
			<code class="nx">APIGroup</code><code class="p">:</code> <code class="s">"rbac.authorization.k8s.io"</code><code class="p">,</code>&#13;
			<code class="nx">Kind</code><code class="p">:</code>     <code class="s">"Role"</code><code class="p">,</code>&#13;
			<code class="nx">Name</code><code class="p">:</code>     <code class="s">"namespace-admin"</code><code class="p">,</code>&#13;
		<code class="p">},</code>&#13;
		<code class="nx">Subjects</code><code class="p">:</code> <code class="p">[]</code><code class="nx">rbacv1</code><code class="p">.</code><code class="nx">Subject</code><code class="p">{</code>&#13;
			<code class="p">{</code>&#13;
				<code class="nx">Kind</code><code class="p">:</code>      <code class="s">"User"</code><code class="p">,</code>&#13;
				<code class="nx">Name</code><code class="p">:</code>      <code class="nx">adminUsername</code><code class="p">,</code>&#13;
				<code class="nx">Namespace</code><code class="p">:</code> <code class="nx">nsName</code><code class="p">,</code>&#13;
			<code class="p">},</code>&#13;
		<code class="p">},</code>&#13;
	<code class="p">}</code>&#13;
&#13;
	<code class="k">if</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">r</code><code class="p">.</code><code class="nx">Create</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code> <code class="nx">binding</code><code class="p">);</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
		<code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="s">"unable to create namespace-admin role binding"</code><code class="p">)</code>&#13;
		<code class="k">return</code> <code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="nx">err</code>&#13;
	<code class="p">}</code>&#13;
&#13;
	<code class="k">return</code> <code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="kc">nil</code>&#13;
<code class="p">}</code>&#13;
<code class="o">...</code></pre></div>&#13;
&#13;
<p>At this point we are able to submit an AcmeNamespace manifest to the API and our Namespace operator will create the Namespace, a Role for the Namespace admin, and a RoleBinding to the username we provided.  As we discussed earlier, this will work fine when we create a new AcmeNamespace but will break when it tries to reconcile it at any other time in the future.  This would occur if the AcmeNamespace was changed in any way.  It would also happen if the controller restarted for any reason.  When the controller restarts, it must re-list and reconcile all existing resources in case &#13;
<span class="keep-together">something</span> changed.  So at this point, simply restarting our controller will break it.  Let’s fix that by adding a simple use of the status field.  First, <a data-type="xref" href="#ex_11-11">Example 11-11</a> shows the addition of the field to <code>AcmeNamespaceStatus</code>.</p>&#13;
<div data-type="example" id="ex_11-11">&#13;
<h5><span class="label">Example 11-11. </span>Adding a field to the status of the AcmeNamespace</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// api/v1alpha1/acmenamespace_types.go</code>&#13;
&#13;
<code class="c1">// AcmeNamespaceStatus defines the observed state of AcmeNamespace</code>&#13;
<code class="kd">type</code> <code class="nx">AcmeNamespaceStatus</code> <code class="kd">struct</code> <code class="p">{</code>&#13;
&#13;
	<code class="c1">// Tracks the phase of the AcmeNamespace</code>&#13;
	<code class="c1">// +optional</code>&#13;
	<code class="c1">// +kubebuilder:validation:Enum=CreationInProgress;Created</code>&#13;
	<code class="nx">Phase</code> <code class="kt">string</code> <code class="s">`json:"phase"`</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// +kubebuilder:object:root=true</code>&#13;
<code class="c1">// +kubebuilder:subresource:status</code>&#13;
<code class="o">...</code></pre></div>&#13;
&#13;
<p>Now we can leverage this field in our controller as shown in <a data-type="xref" href="#ex_11-12">Example 11-12</a>.</p>&#13;
<div data-type="example" id="ex_11-12">&#13;
<h5><span class="label">Example 11-12. </span>Using the new status field in the AcmeNamespace controller</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// controllers/acmenamespace_controller.go</code>&#13;
<code class="o">...</code>&#13;
&#13;
<code class="kd">const</code> <code class="p">(</code>&#13;
	<code class="nx">statusCreated</code>    <code class="p">=</code> <code class="s">"Created"</code>&#13;
	<code class="nx">statusInProgress</code> <code class="p">=</code> <code class="s">"CreationInProgress"</code>&#13;
<code class="p">)</code>&#13;
&#13;
<code class="o">...</code>&#13;
&#13;
<code class="kd">func</code> <code class="p">(</code><code class="nx">r</code> <code class="o">*</code><code class="nx">AcmeNamespaceReconciler</code><code class="p">)</code> <code class="nx">Reconcile</code><code class="p">(</code><code class="nx">req</code> <code class="nx">ctrl</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code> <code class="p">(</code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">,</code> <code class="kt">error</code><code class="p">)</code> <code class="p">{</code>&#13;
	<code class="o">...</code>&#13;
&#13;
	<code class="k">switch</code> <code class="nx">acmeNs</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="p">{</code>&#13;
	<code class="k">case</code> <code class="nx">statusCreated</code><code class="p">:</code>&#13;
		<code class="c1">// do nothing</code>&#13;
		<code class="nx">log</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"AcmeNamespace child resources have been created"</code><code class="p">)</code>&#13;
	<code class="k">case</code> <code class="nx">statusInProgress</code><code class="p">:</code>&#13;
		<code class="c1">// TODO: query and create as needed</code>&#13;
		<code class="nx">log</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"AcmeNamespace child resource creation in progress"</code><code class="p">)</code>&#13;
	<code class="k">default</code><code class="p">:</code>&#13;
		<code class="nx">log</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"AcmeNamespace child resources not created"</code><code class="p">)</code>&#13;
&#13;
		<code class="c1">// set status to statusInProgress</code>&#13;
		<code class="nx">acmeNs</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="p">=</code> <code class="nx">statusInProgress</code>&#13;
		<code class="k">if</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">r</code><code class="p">.</code><code class="nx">Status</code><code class="p">().</code><code class="nx">Update</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code> <code class="o">&amp;</code><code class="nx">acmeNs</code><code class="p">);</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
			<code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="s">"unable to update AcmeNamespace status"</code><code class="p">)</code>&#13;
			<code class="k">return</code> <code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="nx">err</code>&#13;
		<code class="p">}</code>&#13;
&#13;
		<code class="c1">// create namespace, role and role binding</code>&#13;
		<code class="o">...</code>&#13;
&#13;
		<code class="c1">// set status to statusCreated</code>&#13;
		<code class="nx">acmeNs</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code> <code class="p">=</code> <code class="nx">statusCreated</code>&#13;
		<code class="k">if</code> <code class="nx">err</code> <code class="o">:=</code> <code class="nx">r</code><code class="p">.</code><code class="nx">Status</code><code class="p">().</code><code class="nx">Update</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code> <code class="o">&amp;</code><code class="nx">acmeNs</code><code class="p">);</code> <code class="nx">err</code> <code class="o">!=</code> <code class="kc">nil</code> <code class="p">{</code>&#13;
			<code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="s">"unable to update AcmeNamespace status"</code><code class="p">)</code>&#13;
			<code class="k">return</code> <code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="nx">err</code>&#13;
		<code class="p">}</code>&#13;
	<code class="p">}</code>&#13;
&#13;
	<code class="k">return</code> <code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{},</code> <code class="kc">nil</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="o">...</code></pre></div>&#13;
&#13;
<p>Now we have a controller that can restart safely.  It also now has the beginnings of a system to examine existing state using the custom resource’s status and to carry out reconciliation steps based on that existing state.</p>&#13;
&#13;
<p>One other thing we should usually do is set ownership for the child resources.  If we set the AcmeNamespace resource as the owner of the Namespace, Role, and RoleBinding, that allows us to delete all the children by simply deleting the owner AcmeNamespace resource.  This ownership will be managed by the API server.  Even if the controller is not running, if the owner AcmeNamespace resource is deleted, the children will be deleted, too.</p>&#13;
&#13;
<p>This raises the question of scoping for our AcmeNamespace API type.  When using Kubebuilder, it will default to Namespaced scoping.  However, a Namespace-scoped API type cannot be an owner of a cluster-scoped resource, such as a Namespace.  With Kubebuilder we can use convenient markers to generate the CRD manifest with the proper scoping for this usage, as shown in <a data-type="xref" href="#updated_api_definition_in_a_kubebuilder_project">Example 11-13</a>.</p>&#13;
<div data-type="example" id="updated_api_definition_in_a_kubebuilder_project">&#13;
<h5><span class="label">Example 11-13. </span>Updated API definition in a Kubebuilder project</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="c1">// api/v1alpha1/acmenamespace_types.go&#13;
</code><code class="kn">package</code><code> </code><code class="nx">v1alpha1</code><code>&#13;
</code><code>&#13;
</code><code class="kn">import</code><code> </code><code class="p">(</code><code>&#13;
</code><code>	</code><code class="nx">metav1</code><code> </code><code class="s">"k8s.io/apimachinery/pkg/apis/meta/v1"</code><code>&#13;
</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!&#13;
</code><code>&#13;
</code><code class="c1">// NOTE: json tags are required.  Any new fields you add must have json tags&#13;
</code><code class="c1">// for the fields to be serialized.&#13;
</code><code>&#13;
</code><code class="c1">// AcmeNamespaceSpec defines the desired state of AcmeNamespace&#13;
</code><code class="kd">type</code><code> </code><code class="nx">AcmeNamespaceSpec</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="c1">// The name of the namespace&#13;
</code><code>	</code><code class="nx">NamespaceName</code><code> </code><code class="kt">string</code><code> </code><code class="s">`json:"namespaceName"`</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="c1">// The username for the namespace admin&#13;
</code><code>	</code><code class="nx">AdminUsername</code><code> </code><code class="kt">string</code><code> </code><code class="s">`json:"adminUsername"`</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// AcmeNamespaceStatus defines the observed state of AcmeNamespace&#13;
</code><code class="kd">type</code><code> </code><code class="nx">AcmeNamespaceStatus</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="c1">// Tracks the phase of the AcmeNamespace&#13;
</code><code>	</code><code class="c1">// +optional&#13;
</code><code>	</code><code class="c1">// +kubebuilder:validation:Enum=CreationInProgress;Created&#13;
</code><code>	</code><code class="nx">Phase</code><code> </code><code class="kt">string</code><code> </code><code class="s">`json:"phase"`</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// +kubebuilder:resource:scope=Cluster  </code><a class="co" href="#callout_building_platform_services_CO7-1" id="co_building_platform_services_CO7-1"><img alt="1" src="assets/1.png"/></a><code class="c1">&#13;
</code><code class="c1">// +kubebuilder:object:root=true&#13;
</code><code class="c1">// +kubebuilder:subresource:status&#13;
</code><code>&#13;
</code><code class="c1">// AcmeNamespace is the Schema for the acmenamespaces API&#13;
</code><code class="kd">type</code><code> </code><code class="nx">AcmeNamespace</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">metav1</code><code class="p">.</code><code class="nx">TypeMeta</code><code>   </code><code class="s">`json:",inline"`</code><code>&#13;
</code><code>	</code><code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code> </code><code class="s">`json:"metadata,omitempty"`</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="nx">Spec</code><code>   </code><code class="nx">AcmeNamespaceSpec</code><code>   </code><code class="s">`json:"spec,omitempty"`</code><code>&#13;
</code><code>	</code><code class="nx">Status</code><code> </code><code class="nx">AcmeNamespaceStatus</code><code> </code><code class="s">`json:"status,omitempty"`</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="c1">// +kubebuilder:object:root=true&#13;
</code><code>&#13;
</code><code class="c1">// AcmeNamespaceList contains a list of AcmeNamespace&#13;
</code><code class="kd">type</code><code> </code><code class="nx">AcmeNamespaceList</code><code> </code><code class="kd">struct</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">metav1</code><code class="p">.</code><code class="nx">TypeMeta</code><code> </code><code class="s">`json:",inline"`</code><code>&#13;
</code><code>	</code><code class="nx">metav1</code><code class="p">.</code><code class="nx">ListMeta</code><code> </code><code class="s">`json:"metadata,omitempty"`</code><code>&#13;
</code><code>	</code><code class="nx">Items</code><code>           </code><code class="p">[</code><code class="p">]</code><code class="nx">AcmeNamespace</code><code> </code><code class="s">`json:"items"`</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code class="kd">func</code><code> </code><code class="nx">init</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">SchemeBuilder</code><code class="p">.</code><code class="nx">Register</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">AcmeNamespace</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">AcmeNamespaceList</code><code class="p">{</code><code class="p">}</code><code class="p">)</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_platform_services_CO7-1" id="callout_building_platform_services_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>This marker will set the correct scoping on the CRD when the manifest is generated with <code>make manifests</code>.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This will generate a CRD that looks like <a data-type="xref" href="#cluster_scoped_crd_for_acmenamespce_api_type">Example 11-14</a>.</p>&#13;
<div data-type="example" id="cluster_scoped_crd_for_acmenamespce_api_type">&#13;
<h5><span class="label">Example 11-14. </span>Cluster scoped CRD for AcmeNamespace API type</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nn">---</code><code>&#13;
</code><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">apiextensions.k8s.io/v1beta1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">CustomResourceDefinition</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">annotations</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">controller-gen.kubebuilder.io/version</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">(devel)</code><code>&#13;
</code><code>  </code><code class="nt">creationTimestamp</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">null</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">acmenamespaces.tenancy.acme.com</code><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">group</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">tenancy.acme.com</code><code>&#13;
</code><code>  </code><code class="nt">names</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">AcmeNamespace</code><code>&#13;
</code><code>    </code><code class="nt">listKind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">AcmeNamespaceList</code><code>&#13;
</code><code>    </code><code class="nt">plural</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">acmenamespaces</code><code>&#13;
</code><code>    </code><code class="nt">singular</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">acmenamespace</code><code>&#13;
</code><code>  </code><code class="nt">scope</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Cluster</code><code>  </code><a class="co" href="#callout_building_platform_services_CO8-1" id="co_building_platform_services_CO8-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>  </code><code class="nt">subresources</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">status</code><code class="p">:</code><code> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code><code>&#13;
</code><code>  </code><code class="nt">validation</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">openAPIV3Schema</code><code class="p">:</code><code>&#13;
</code><code>      </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">AcmeNamespace</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">is</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Schema</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">for</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">acmenamespaces</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">API</code><code>&#13;
</code><code>      </code><code class="nt">properties</code><code class="p">:</code><code>&#13;
</code><code>        </code><code class="nt">apiVersion</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="s">'</code><code class="s">APIVersion</code><code class="nv"> </code><code class="s">defines</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">versioned</code><code class="nv"> </code><code class="s">schema</code><code class="nv"> </code><code class="s">of</code><code class="nv"> </code><code class="s">this</code><code>&#13;
</code><code>            </code><code class="s">representation</code><code class="nv"> </code><code class="s">of</code><code class="nv"> </code><code class="s">an</code><code class="nv"> </code><code class="s">object.</code><code class="nv"> </code><code class="s">Servers</code><code class="nv"> </code><code class="s">should</code><code class="nv"> </code><code class="s">convert</code><code class="nv"> </code><code class="s">recognized</code><code>&#13;
</code><code>            </code><code class="s">schemas</code><code class="nv"> </code><code class="s">to</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">latest</code><code class="nv"> </code><code class="s">internal</code><code class="nv"> </code><code class="s">value,</code><code class="nv"> </code><code class="s">and</code><code class="nv"> </code><code class="s">may</code><code class="nv"> </code><code class="s">reject</code><code class="nv"> </code><code class="s">unrecognized</code><code>&#13;
</code><code>            </code><code class="s">values.</code><code class="s">'</code><code>&#13;
</code><code>          </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">string</code><code>&#13;
</code><code>        </code><code class="nt">kind</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="s">'</code><code class="s">Kind</code><code class="nv"> </code><code class="s">is</code><code class="nv"> </code><code class="s">a</code><code class="nv"> </code><code class="s">string</code><code class="nv"> </code><code class="s">value</code><code class="nv"> </code><code class="s">representing</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">REST</code><code class="nv"> </code><code class="s">resource</code><code class="nv"> </code><code class="s">this</code><code>&#13;
</code><code>            </code><code class="s">object</code><code class="nv"> </code><code class="s">represents.</code><code class="nv"> </code><code class="s">Servers</code><code class="nv"> </code><code class="s">may</code><code class="nv"> </code><code class="s">infer</code><code class="nv"> </code><code class="s">this</code><code class="nv"> </code><code class="s">from</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">endpoint</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">client</code><code>&#13;
</code><code>            </code><code class="s">submits</code><code class="nv"> </code><code class="s">requests</code><code class="nv"> </code><code class="s">to.</code><code class="nv"> </code><code class="s">Cannot</code><code class="nv"> </code><code class="s">be</code><code class="nv"> </code><code class="s">updated.</code><code class="nv"> </code><code class="s">In</code><code class="nv"> </code><code class="s">CamelCase.</code><code class="s">'</code><code>&#13;
</code><code>          </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">string</code><code>&#13;
</code><code>        </code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">object</code><code>&#13;
</code><code>        </code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">AcmeNamespaceSpec</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">defines</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">desired</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">state</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">of</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">AcmeNamespace</code><code>&#13;
</code><code>          </code><code class="nt">properties</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="nt">adminUsername</code><code class="p">:</code><code>&#13;
</code><code>              </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">The</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">username</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">for</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">namespace</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">admin</code><code>&#13;
</code><code>              </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">string</code><code>&#13;
</code><code>            </code><code class="nt">namespaceName</code><code class="p">:</code><code>&#13;
</code><code>              </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">The</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">name</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">of</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">namespace</code><code>&#13;
</code><code>              </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">string</code><code>&#13;
</code><code>          </code><code class="nt">required</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">adminUsername</code><code>&#13;
</code><code>          </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">namespaceName</code><code>&#13;
</code><code>          </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">object</code><code>&#13;
</code><code>        </code><code class="nt">status</code><code class="p">:</code><code>&#13;
</code><code>          </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="s">'</code><code class="s">AcmeNamespaceStatus</code><code class="nv"> </code><code class="s">defines</code><code class="nv"> </code><code class="s">the</code><code class="nv"> </code><code class="s">observed</code><code class="nv"> </code><code class="s">state</code><code class="nv"> </code><code class="s">of</code><code>&#13;
</code><code class="err">	</code><code class="err">	</code><code class="err">	</code><code class="s">AcmeNamespace</code><code class="s">'</code><code>&#13;
</code><code>          </code><code class="nt">properties</code><code class="p">:</code><code>&#13;
</code><code>            </code><code class="nt">phase</code><code class="p">:</code><code>&#13;
</code><code>              </code><code class="nt">description</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">Tracks</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">phase</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">of</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">AcmeNamespace</code><code>&#13;
</code><code>              </code><code class="nt">enum</code><code class="p">:</code><code>&#13;
</code><code>              </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">CreationInProgress</code><code>&#13;
</code><code>              </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">Created</code><code>&#13;
</code><code>              </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">string</code><code>&#13;
</code><code>          </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">object</code><code>&#13;
</code><code>      </code><code class="nt">type</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">object</code><code>&#13;
</code><code>  </code><code class="nt">version</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1alpha1</code><code>&#13;
</code><code>  </code><code class="nt">versions</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1alpha1</code><code>&#13;
</code><code>    </code><code class="nt">served</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">true</code><code>&#13;
</code><code>    </code><code class="nt">storage</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">true</code><code>&#13;
</code><code class="nt">status</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">acceptedNames</code><code class="p">:</code><code>&#13;
</code><code>    </code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">"</code><code>&#13;
</code><code>    </code><code class="nt">plural</code><code class="p">:</code><code> </code><code class="s">"</code><code class="s">"</code><code>&#13;
</code><code>  </code><code class="nt">conditions</code><code class="p">:</code><code> </code><code class="p-Indicator">[</code><code class="p-Indicator">]</code><code>&#13;
</code><code>  </code><code class="nt">storedVersions</code><code class="p">:</code><code> </code><code class="p-Indicator">[</code><code class="p-Indicator">]</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_platform_services_CO8-1" id="callout_building_platform_services_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Resource scoping properly set.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Now we can set the AcmeNamespace as an owner for all child resources.  This will introduce an <code>ownerReferences</code> field into the <code>metadata</code> for each child resource.  At this point our <code>Reconcile</code> method looks like <a data-type="xref" href="#setting_ownership_for_child_resources_of_the_acmenamespace">Example 11-15</a>.</p>&#13;
<div data-type="example" id="setting_ownership_for_child_resources_of_the_acmenamespace">&#13;
<h5><span class="label">Example 11-15. </span>Setting ownership for child resources of the AcmeNamespace</h5>&#13;
&#13;
<pre data-code-language="go" data-type="programlisting"><code class="kd">func</code><code> </code><code class="p">(</code><code class="nx">r</code><code> </code><code class="o">*</code><code class="nx">AcmeNamespaceReconciler</code><code class="p">)</code><code> </code><code class="nx">Reconcile</code><code class="p">(</code><code class="nx">req</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Request</code><code class="p">)</code><code> </code><code class="p">(</code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">,</code><code> </code><code class="kt">error</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="nx">ctx</code><code> </code><code class="o">:=</code><code> </code><code class="nx">context</code><code class="p">.</code><code class="nx">Background</code><code class="p">(</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="nx">log</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Log</code><code class="p">.</code><code class="nx">WithValues</code><code class="p">(</code><code class="s">"acmenamespace"</code><code class="p">,</code><code> </code><code class="nx">req</code><code class="p">.</code><code class="nx">NamespacedName</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="kd">var</code><code> </code><code class="nx">acmeNs</code><code> </code><code class="nx">tenancyv1alpha1</code><code class="p">.</code><code class="nx">AcmeNamespace</code><code>&#13;
</code><code>	</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Get</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">req</code><code class="p">.</code><code class="nx">NamespacedName</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">acmeNs</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>		</code><code class="k">if</code><code> </code><code class="nx">apierrs</code><code class="p">.</code><code class="nx">IsNotFound</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code> </code><code class="p">{</code><code>  </code><a class="co" href="#callout_building_platform_services_CO9-1" id="co_building_platform_services_CO9-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
			</code><code class="nx">log</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"resource deleted"</code><code class="p">)</code><code>&#13;
</code><code>			</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="kc">nil</code><code>&#13;
</code><code>		</code><code class="p">}</code><code> </code><code class="k">else</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="nx">nsName</code><code> </code><code class="o">:=</code><code> </code><code class="nx">acmeNs</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">NamespaceName</code><code>&#13;
</code><code>	</code><code class="nx">adminUsername</code><code> </code><code class="o">:=</code><code> </code><code class="nx">acmeNs</code><code class="p">.</code><code class="nx">Spec</code><code class="p">.</code><code class="nx">AdminUsername</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="k">switch</code><code> </code><code class="nx">acmeNs</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code><code> </code><code class="p">{</code><code>&#13;
</code><code>	</code><code class="k">case</code><code> </code><code class="nx">statusCreated</code><code class="p">:</code><code>&#13;
</code><code>		</code><code class="c1">// do nothing&#13;
</code><code>		</code><code class="nx">log</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"AcmeNamespace child resources have been created"</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">case</code><code> </code><code class="nx">statusInProgress</code><code class="p">:</code><code>&#13;
</code><code>		</code><code class="c1">// TODO: query and create as needed&#13;
</code><code>		</code><code class="nx">log</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"AcmeNamespace child resource creation in progress"</code><code class="p">)</code><code>&#13;
</code><code>	</code><code class="k">default</code><code class="p">:</code><code>&#13;
</code><code>		</code><code class="nx">log</code><code class="p">.</code><code class="nx">Info</code><code class="p">(</code><code class="s">"AcmeNamespace child resources not created"</code><code class="p">)</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="c1">// set status to statusInProgress&#13;
</code><code>		</code><code class="nx">acmeNs</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code><code> </code><code class="p">=</code><code> </code><code class="nx">statusInProgress</code><code>&#13;
</code><code>		</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Status</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">Update</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">acmeNs</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code> </code><code class="s">"unable to update AcmeNamespace status"</code><code class="p">)</code><code>&#13;
</code><code>			</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="nx">ns</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">corev1</code><code class="p">.</code><code class="nx">Namespace</code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">ObjectMeta</code><code class="p">:</code><code> </code><code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">{</code><code>&#13;
</code><code>				</code><code class="nx">Name</code><code class="p">:</code><code> </code><code class="nx">nsName</code><code class="p">,</code><code>&#13;
</code><code>				</code><code class="nx">Labels</code><code class="p">:</code><code> </code><code class="kd">map</code><code class="p">[</code><code class="kt">string</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code>&#13;
</code><code>					</code><code class="s">"admin"</code><code class="p">:</code><code> </code><code class="nx">adminUsername</code><code class="p">,</code><code>&#13;
</code><code>				</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>			</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="c1">// set owner reference for the namespace  </code><a class="co" href="#callout_building_platform_services_CO9-2" id="co_building_platform_services_CO9-2"><img alt="2" src="assets/2.png"/></a><code class="c1">&#13;
</code><code>		</code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">SetControllerReference</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">acmeNs</code><code class="p">,</code><code> </code><code class="nx">ns</code><code class="p">,</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Scheme</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code> </code><code class="s">"unable to set owner reference on namespace"</code><code class="p">)</code><code>&#13;
</code><code>			</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Create</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">ns</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code> </code><code class="s">"unable to create namespace"</code><code class="p">)</code><code>&#13;
</code><code>			</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="nx">role</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">rbacv1</code><code class="p">.</code><code class="nx">Role</code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">ObjectMeta</code><code class="p">:</code><code> </code><code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">{</code><code>&#13;
</code><code>				</code><code class="nx">Name</code><code class="p">:</code><code>      </code><code class="s">"namespace-admin"</code><code class="p">,</code><code>&#13;
</code><code>				</code><code class="nx">Namespace</code><code class="p">:</code><code> </code><code class="nx">nsName</code><code class="p">,</code><code>&#13;
</code><code>			</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>			</code><code class="nx">Rules</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">rbacv1</code><code class="p">.</code><code class="nx">PolicyRule</code><code class="p">{</code><code>&#13;
</code><code>				</code><code class="p">{</code><code>&#13;
</code><code>					</code><code class="nx">APIGroups</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code class="s">"*"</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>					</code><code class="nx">Resources</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code class="s">"*"</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>					</code><code class="nx">Verbs</code><code class="p">:</code><code>     </code><code class="p">[</code><code class="p">]</code><code class="kt">string</code><code class="p">{</code><code class="s">"*"</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>				</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>			</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="c1">// set owner reference for the role </code><a class="co" href="#callout_building_platform_services_CO9-3" id="co_building_platform_services_CO9-3"><img alt="3" src="assets/3.png"/></a><code class="c1">&#13;
</code><code>		</code><code class="nx">err</code><code> </code><code class="p">=</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">SetControllerReference</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">acmeNs</code><code class="p">,</code><code> </code><code class="nx">role</code><code class="p">,</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Scheme</code><code class="p">)</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code> </code><code class="s">"unable to set owner reference on role"</code><code class="p">)</code><code>&#13;
</code><code>			</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Create</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">role</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code> </code><code class="s">"unable to create namespace-admin role"</code><code class="p">)</code><code>&#13;
</code><code>			</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="nx">binding</code><code> </code><code class="o">:=</code><code> </code><code class="o">&amp;</code><code class="nx">rbacv1</code><code class="p">.</code><code class="nx">RoleBinding</code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">ObjectMeta</code><code class="p">:</code><code> </code><code class="nx">metav1</code><code class="p">.</code><code class="nx">ObjectMeta</code><code class="p">{</code><code>&#13;
</code><code>				</code><code class="nx">Name</code><code class="p">:</code><code>      </code><code class="s">"namespace-admin"</code><code class="p">,</code><code>&#13;
</code><code>				</code><code class="nx">Namespace</code><code class="p">:</code><code> </code><code class="nx">nsName</code><code class="p">,</code><code>&#13;
</code><code>			</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>			</code><code class="nx">RoleRef</code><code class="p">:</code><code> </code><code class="nx">rbacv1</code><code class="p">.</code><code class="nx">RoleRef</code><code class="p">{</code><code>&#13;
</code><code>				</code><code class="nx">APIGroup</code><code class="p">:</code><code> </code><code class="s">"rbac.authorization.k8s.io"</code><code class="p">,</code><code>&#13;
</code><code>				</code><code class="nx">Kind</code><code class="p">:</code><code>     </code><code class="s">"Role"</code><code class="p">,</code><code>&#13;
</code><code>				</code><code class="nx">Name</code><code class="p">:</code><code>     </code><code class="s">"namespace-admin"</code><code class="p">,</code><code>&#13;
</code><code>			</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>			</code><code class="nx">Subjects</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">]</code><code class="nx">rbacv1</code><code class="p">.</code><code class="nx">Subject</code><code class="p">{</code><code>&#13;
</code><code>				</code><code class="p">{</code><code>&#13;
</code><code>					</code><code class="nx">Kind</code><code class="p">:</code><code>      </code><code class="s">"User"</code><code class="p">,</code><code>&#13;
</code><code>					</code><code class="nx">Name</code><code class="p">:</code><code>      </code><code class="nx">adminUsername</code><code class="p">,</code><code>&#13;
</code><code>					</code><code class="nx">Namespace</code><code class="p">:</code><code> </code><code class="nx">nsName</code><code class="p">,</code><code>&#13;
</code><code>				</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>			</code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="c1">// set owner reference for the role binding  </code><a class="co" href="#callout_building_platform_services_CO9-4" id="co_building_platform_services_CO9-4"><img alt="4" src="assets/4.png"/></a><code class="c1">&#13;
</code><code>		</code><code class="nx">err</code><code> </code><code class="p">=</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">SetControllerReference</code><code class="p">(</code><code class="o">&amp;</code><code class="nx">acmeNs</code><code class="p">,</code><code> </code><code class="nx">binding</code><code class="p">,</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Scheme</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code>        </code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code> </code><code class="s">"unable to set reference on role binding"</code><code class="p">)</code><code>&#13;
</code><code>			</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Create</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="nx">binding</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code> </code><code class="s">"unable to create role binding"</code><code class="p">)</code><code>&#13;
</code><code>			</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>		</code><code class="c1">// set status to statusCreated&#13;
</code><code>		</code><code class="nx">acmeNs</code><code class="p">.</code><code class="nx">Status</code><code class="p">.</code><code class="nx">Phase</code><code> </code><code class="p">=</code><code> </code><code class="nx">statusCreated</code><code>&#13;
</code><code>		</code><code class="k">if</code><code> </code><code class="nx">err</code><code> </code><code class="o">:=</code><code> </code><code class="nx">r</code><code class="p">.</code><code class="nx">Status</code><code class="p">(</code><code class="p">)</code><code class="p">.</code><code class="nx">Update</code><code class="p">(</code><code class="nx">ctx</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="nx">acmeNs</code><code class="p">)</code><code class="p">;</code><code> </code><code class="nx">err</code><code> </code><code class="o">!=</code><code> </code><code class="kc">nil</code><code> </code><code class="p">{</code><code>&#13;
</code><code>			</code><code class="nx">log</code><code class="p">.</code><code class="nx">Error</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code> </code><code class="s">"unable to update AcmeNamespace status"</code><code class="p">)</code><code>&#13;
</code><code>			</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="nx">err</code><code>&#13;
</code><code>		</code><code class="p">}</code><code>&#13;
</code><code>	</code><code class="p">}</code><code>&#13;
</code><code>&#13;
</code><code>	</code><code class="k">return</code><code> </code><code class="nx">ctrl</code><code class="p">.</code><code class="nx">Result</code><code class="p">{</code><code class="p">}</code><code class="p">,</code><code> </code><code class="kc">nil</code><code>&#13;
</code><code class="p">}</code><code>&#13;
</code><code class="o">...</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_platform_services_CO9-1" id="callout_building_platform_services_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Check to see if resource was not found so we don’t try to reconcile when the AcmeNamespace has been deleted.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO9-2" id="callout_building_platform_services_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Set owner reference on Namespace.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO9-3" id="callout_building_platform_services_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Set owner reference on Role.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO9-4" id="callout_building_platform_services_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>Set owner reference on RoleBinding.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Notice that we had to add the error checking to see if the AcmeNamespace resource was found.<a data-primary="reconciliation" data-type="indexterm" id="idm45611976469624"/><a data-primary="state" data-secondary="reconciliation of existing state to desired state" data-type="indexterm" id="idm45611976468952"/>  This is because when it is deleted, normal reconciliation will fail due to there no longer being desired state to reconcile.  And, in this case, we put an owner reference on the child resources so the API server takes care of reconciling state for deletion events.</p>&#13;
&#13;
<p>This illustrates the point that reconciliation must not make assumptions about existing state.  Reconciliation is triggered when:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The controller starts or restarts</p>&#13;
</li>&#13;
<li>&#13;
<p>A resource is created</p>&#13;
</li>&#13;
<li>&#13;
<p>A change is made to a resource, including changes made by the controller itself</p>&#13;
</li>&#13;
<li>&#13;
<p>A resource is deleted</p>&#13;
</li>&#13;
<li>&#13;
<p>A periodic resync with the API is carried out to ensure an accurate view of the system</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>To this end, make sure your reconciliation doesn’t make assumptions about the event that triggered reconciliation.  Use the <code>status</code> field, determine relevant conditions in other resources as needed, and reconcile accordingly.<a data-primary="logic implementation for operators" data-secondary="implementation details" data-startref="ix_logicimpl" data-type="indexterm" id="idm45611974889176"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Admission webhooks" data-type="sect3"><div class="sect3" id="idm45611978179032">&#13;
<h3>Admission webhooks</h3>&#13;
&#13;
<p>If you find your custom resource requires defaults or validation that cannot be implemented using the OpenAPI v3 spec in the CRD that creates your new API type, you can turn to validating and mutating admission webhooks.<a data-primary="logic implementation for operators" data-secondary="admission webhooks" data-type="indexterm" id="idm45611976494216"/><a data-primary="webhooks" data-secondary="admission" data-type="indexterm" id="idm45611976493272"/><a data-primary="admission control" data-secondary="admission webhooks" data-type="indexterm" id="idm45611977094280"/>  The Kubebuilder CLI has a <code>create webhook</code> command that caters specifically to these use cases by generating boilerplate to get you going faster.</p>&#13;
&#13;
<p>An example of where a validating webhook may be useful with our Namespace operator example and its AcmeNamespace resource, is in validating the <code>adminUsername</code> field.  As a convenience, your webhook could call out to your corporate identity provider to ensure the username provided is valid, preventing mistakes that require human intervention to correct.</p>&#13;
&#13;
<p>A defaulting example could be to default the <code>deploymentTier</code> to the most common, least expensive <code>dev</code> option.  This is particularly useful for maintaining backward compatibility with existing resource definitions when you make a change that adds new fields to a custom resource data model.</p>&#13;
&#13;
<p>Admission webhooks are not often included in a prototype or pre-alpha release of an operator, but commonly come into play when refining the user experience for a stable release of a project. <a data-type="xref" href="ch08.html#chapter8">Chapter 8</a> covers the subject of admission control in depth.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Finalizers" data-type="sect3"><div class="sect3" id="idm45611978178664">&#13;
<h3>Finalizers</h3>&#13;
&#13;
<p>We have looked at examples of a custom resource being set as the owner of child resources to ensure they will be deleted when the parent custom resource is removed.<a data-primary="finalizers" data-type="indexterm" id="idm45611976708984"/><a data-primary="logic implementation for operators" data-secondary="finalizers" data-type="indexterm" id="idm45611976708392"/>  However, this mechanism is not always sufficient.  If the custom resource has relationships with other resources in the cluster where an ownership is <em>not</em> appropriate, or if conditions outside the cluster need to be updated when your custom resource is deleted, finalizers will likely be important to use.</p>&#13;
&#13;
<p>Finalizers are added to the metadata of a resource as shown <a data-type="xref" href="#ex_11-16">Example 11-16</a>.</p>&#13;
<div data-type="example" id="ex_11-16">&#13;
<h5><span class="label">Example 11-16. </span>AcmeNamespace manifest with a finalizer</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">tenancy.acme.com/v1alapha1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">AcmeNamespace</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">team-x</code><code>&#13;
</code><code>  </code><code class="nt">finalizers</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="p-Indicator">-</code><code> </code><code class="l-Scalar-Plain">namespace.finalizer.tenancy.acme.com</code><code>  </code><a class="co" href="#callout_building_platform_services_CO10-1" id="co_building_platform_services_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nt">spec</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">namespaceName</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">app-y</code><code>&#13;
</code><code>  </code><code class="nt">adminUsername</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">sam</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_platform_services_CO10-1" id="callout_building_platform_services_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>String value used as a finalizer.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>The string value used as your finalizer is not important to anything else in the system besides your controller.  Just use a value that will safely be unique in case other controllers need to apply finalizers to the same resource.</p>&#13;
&#13;
<p>When any finalizers are present on a resource, the API server will not delete the resource.<a data-primary="API server" data-secondary="resource deletions and" data-type="indexterm" id="idm45611976591800"/>  If a delete request is received, it will instead update the resource to add a <code>deletionTimestamp</code> field to its metadata.  This update to the resource will trigger a reconciliation in your controller.  A check for this <code>deletionTimestamp</code> will need to be added to your controller’s <code>Reconcile</code> method so that any pre-delete operations can be completed.  Once complete, your controller can remove the finalizer.  This will inform the API server that it may now delete the resource.</p>&#13;
&#13;
<p>Common examples of pre-delete operations are in systems outside the cluster.  In the Namespace operator example, if there are corporate chargeback systems that track Namespace usage and need to be updated when Namespaces are deleted, a finalizer could prompt your operator to update that external system before removing the Namespace.  Other common examples are when a workload uses managed services, such as databases or object storage, as a part of the application stack.  When an instance of the application is deleted, these managed service instances will likely need to be cleaned up as well.<a data-primary="operators (Kubernetes)" data-secondary="developing" data-startref="ix_opdevlogic" data-tertiary="logic implementation" data-type="indexterm" id="idm45611976518872"/><a data-primary="logic implementation for operators" data-startref="ix_logic" data-type="indexterm" id="idm45611976517352"/><a data-primary="platform services, building" data-secondary="developing operators" data-startref="ix_pltserdevop" data-type="indexterm" id="idm45611976320392"/><a data-primary="operators (Kubernetes)" data-secondary="developing" data-startref="ix_opdev" data-type="indexterm" id="idm45611976319208"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Extending the Scheduler" data-type="sect1"><div class="sect1" id="idm45611976317864">&#13;
<h1>Extending the Scheduler</h1>&#13;
&#13;
<p>The scheduler delivers core functionality in Kubernetes.<a data-primary="scheduler" data-secondary="extending" data-type="indexterm" id="ix_schedext"/><a data-primary="platform services, building" data-secondary="extending the scheduler" data-type="indexterm" id="ix_pltsersch"/>  A huge part of the value proposition of Kubernetes is the abstraction of pools of machines on which to run workloads.  It is the scheduler that makes the determination of where Pods will run.  It is fair to say that, together with the kubelet, these two controllers form the heart of Kubernetes around which all else is built.  The scheduler is a cornerstone platform service for your application platform.  In this section we will explore customizing, extending, and replacing the behavior of the scheduler.</p>&#13;
&#13;
<p>It’s helpful to keep in mind the parallels between core control plane components, like the scheduler, and the custom operators we have examined so far in this chapter.  In both cases we are dealing with Kubernetes controllers managing Kubernetes resources.  With our custom operators, we develop entirely new custom controllers, whereas the scheduler is a core controller deployed with every Kubernetes cluster.  With our custom operators, we design and create new custom resources, whereas the scheduler manages the core Pod resource.</p>&#13;
&#13;
<p>We have found it uncommon for users of Kubernetes to find a need to extend the scheduler or modify its behavior.  However, considering how important it is to a cluster’s function, it is prudent to both understand how the scheduler reaches scheduling decisions it makes and how to modify those decisions if the need arises.  It bears repeating one more time: a large part of the genius of Kubernetes is its extensibility and modularity.  If you find the scheduler doesn’t meet your needs, you can modify or augment its behavior, or replace it altogether.</p>&#13;
&#13;
<p>In exploring this topic, we’re going to examine how the scheduler determines where to assign Pods so that we can understand what goes into each scheduling decision, and then see how we can influence those decisions with scheduling policies.  We’re also going to address the option of running multiple schedulers and even writing your own custom scheduler.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Predicates and Priorities" data-type="sect2"><div class="sect2" id="idm45611974881912">&#13;
<h2>Predicates and Priorities</h2>&#13;
&#13;
<p>Before we look at how to extend or modify the scheduler, we first need to understand how the scheduler makes its decisions.<a data-primary="scheduler" data-secondary="extending" data-tertiary="predicates and priorities" data-type="indexterm" id="idm45611974880472"/><a data-primary="platform services, building" data-secondary="extending the scheduler" data-tertiary="predicates and priorities" data-type="indexterm" id="idm45611976398184"/>  The scheduler uses a two-step process to determine which Node a Pod will get scheduled to.</p>&#13;
&#13;
<p>The first is filtering.  In this step, the scheduler filters out Nodes that are ineligible to host a Pod using a number of predicates.<a data-primary="predicates" data-type="indexterm" id="idm45611976396264"/>  For example, there is a predicate that checks to see if the Pod being scheduled tolerates a Node’s taints.  The control plane nodes commonly use a taint to ensure regular workloads don’t get scheduled there.  If a Pod has no tolerations, any tainted Nodes will be filtered out as ineligible targets for a Pod.  Another predicate checks to ensure the Node has sufficient CPU and memory resources for any Pod that requests values for these resources.  As you’d expect, if the Node has insufficient resources to satisfy the Pod spec, it is filtered out as an eligible host.  When all predicates have checked for Node eligibility, the filtering step is complete.  At this point if there are no eligible Nodes, the Pod will remain in a <code>Pending</code> state until conditions change, such as a new eligible Node being added to the cluster.  If the list of Nodes consists of a single Node, scheduling may occur at this point.  If there are multiple eligible Nodes, the scheduler proceeds to the second step.</p>&#13;
&#13;
<p>The second step is scoring.<a data-primary="priorities" data-type="indexterm" id="idm45611976580200"/>  This step uses priorities to determine which Node is the <em>best</em> fit for a particular Pod.  One priority that helps to score a Node higher is the presence of a container image that is being used by the Pod.  Another priority that will score a Node higher is the lack of any Pods that share the same Service as the Pod being scheduled.  That is to say that the scheduler will attempt to distribute the Pods that share a Service across multiple Nodes for improved Node failure tolerance.  The scoring step is also where <code>preferred...</code> affinity rules on Pods are implemented.  At the end of the scoring step, each eligible Node has a score associated.  The highest scoring Node is deemed the best fit for the Pod and it is scheduled there.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Scheduling Policies" data-type="sect2"><div class="sect2" id="idm45611976577624">&#13;
<h2>Scheduling Policies</h2>&#13;
&#13;
<p>Scheduling policies are used to configure the predicates and priorities the scheduler is to use.<a data-primary="scheduler" data-secondary="extending" data-tertiary="scheduling policies" data-type="indexterm" id="idm45611976657976"/><a data-primary="platform services, building" data-secondary="extending the scheduler" data-tertiary="scheduling policies" data-type="indexterm" id="idm45611976656728"/>   You can write a config file containing a scheduling policy to disk on the control plane nodes and provide the scheduler the <code>--policy-config-file</code> flag, but the preferred method is to use a ConfigMap.  Provide the scheduler the <code>--policy-configmap</code> flag and thereafter you can update the scheduling policy via the API server.<a data-primary="API server" data-secondary="scheduling policy updates" data-type="indexterm" id="idm45611976654472"/>  Note that if you go with the ConfigMap method, you will likely need to update the <code>system:kube-scheduler</code> ClusterRole to add a rule for getting ConfigMaps.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>At the time of this writing, both the <code>--policy-config-file</code> and &#13;
<span class="keep-together"><code>--policy-configmap</code></span> flags for the scheduler still work, but they are marked as deprecated in the official documentation.  For this reason, if you are implementing new custom scheduling behavior, we recommend using the scheduling profiles discussed in the next section rather than the policies discussed here.</p>&#13;
</div>&#13;
&#13;
<p>For<a data-primary="ConfigMaps" data-secondary="example defining a scheduling policy" data-type="indexterm" id="idm45611974677624"/> example, the policy ConfigMap in <a data-type="xref" href="#ex_11-17">Example 11-17</a> will make a Node eligible for selection with a <code>nodeSelector</code> by a Pod only if it has a label with the key: &#13;
<span class="keep-together"><code>selectable</code></span>.</p>&#13;
<div data-type="example" id="ex_11-17">&#13;
<h5><span class="label">Example 11-17. </span>An example ConfigMap defining a scheduling policy</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">v1</code><code>&#13;
</code><code class="nt">kind</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">ConfigMap</code><code>&#13;
</code><code class="nt">metadata</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">name</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">scheduler-policy-config</code><code>&#13;
</code><code>  </code><code class="nt">namespace</code><code class="p">:</code><code> </code><code class="l-Scalar-Plain">kube-system</code><code>&#13;
</code><code class="nt">data</code><code class="p">:</code><code>&#13;
</code><code>  </code><code class="nt">policy.cfg</code><code class="p">:</code><code> </code><code class="p-Indicator">|</code><code class="p-Indicator">+</code><code>  </code><a class="co" href="#callout_building_platform_services_CO11-1" id="co_building_platform_services_CO11-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code>    </code><code class="no">apiVersion: v1</code><code>&#13;
</code><code>    </code><code class="no">kind: Policy</code><code>&#13;
</code><code>    </code><code class="no">predicates:</code><code>&#13;
</code><code>    </code><code class="no">- name: "PodMatchNodeSelector"  </code><a class="co" href="#callout_building_platform_services_CO11-2" id="co_building_platform_services_CO11-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code>      </code><code class="no">argument:</code><code>&#13;
</code><code>        </code><code class="no">labelsPresence:</code><code>&#13;
</code><code>          </code><code class="no">labels:</code><code>&#13;
</code><code>          </code><code class="no">- "selectable"  </code><a class="co" href="#callout_building_platform_services_CO11-3" id="co_building_platform_services_CO11-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code>          </code><code class="no">presence: true  </code><a class="co" href="#callout_building_platform_services_CO11-4" id="co_building_platform_services_CO11-4"><img alt="4" src="assets/4.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_building_platform_services_CO11-1" id="callout_building_platform_services_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The filename the scheduler will expect to use for policies.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO11-2" id="callout_building_platform_services_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The predicate name that implements <code>nodeSelectors</code>.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO11-3" id="callout_building_platform_services_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The label key you wish to use for adding a constraint to selection. In this example, if a node does not have this label key present, it will not be selectable by a Pod.</p></dd>&#13;
<dt><a class="co" href="#co_building_platform_services_CO11-4" id="callout_building_platform_services_CO11-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>This indicates the provided label must be present.  If <code>false</code> it would need to be absent.  If using the example configuration of <code>presence: true</code>, a Node without the label <code>selectable: ""</code> will not be eligible for selection by a Pod.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>With this scheduling policy in place, a Pod defined with the manifest in <a data-type="xref" href="#ex_11-18">Example 11-18</a> would be scheduled to an eligible Node only with <em>both</em> the <code>device: gpu</code> <em>and</em> the <code>selectable: ""</code> labels present.</p>&#13;
<div data-type="example" id="ex_11-18">&#13;
<h5><span class="label">Example 11-18. </span>A Pod manifest using the <code>nodeSelector</code> field to direct scheduling</h5>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code> <code class="l-Scalar-Plain">v1</code>&#13;
<code class="nt">kind</code><code class="p">:</code> <code class="l-Scalar-Plain">Pod</code>&#13;
<code class="nt">metadata</code><code class="p">:</code>&#13;
  <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">terminator</code>&#13;
<code class="nt">spec</code><code class="p">:</code>&#13;
  <code class="nt">containers</code><code class="p">:</code>&#13;
  <code class="p-Indicator">-</code> <code class="nt">image</code><code class="p">:</code> <code class="l-Scalar-Plain">registry.acme.com/skynet/t1000:v1</code>&#13;
    <code class="nt">name</code><code class="p">:</code> <code class="l-Scalar-Plain">terminator</code>&#13;
  <code class="nt">nodeSelector</code><code class="p">:</code>&#13;
    <code class="nt">device</code><code class="p">:</code> <code class="l-Scalar-Plain">gpu</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Scheduling Profiles" data-type="sect2"><div class="sect2" id="idm45611974055240">&#13;
<h2>Scheduling Profiles</h2>&#13;
&#13;
<p>Scheduling profiles allow you to enable or disable plug-ins that are compiled into the scheduler. <a data-primary="platform services, building" data-secondary="extending the scheduler" data-tertiary="scheduling profiles" data-type="indexterm" id="idm45611974077368"/><a data-primary="scheduler" data-secondary="extending" data-tertiary="scheduling profiles" data-type="indexterm" id="idm45611974076152"/> You can specify a profile by passing a filename to the <code>--config</code> flag when running the scheduler.  These plug-ins implement the various extension points that include—but are not limited to—the filter and scoring steps we covered earlier.  In our experience it is rarely necessary to customize the scheduler in this way.  But should you find a need for it, the Kubernetes documentation provides instructions.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Multiple Schedulers" data-type="sect2"><div class="sect2" id="idm45611974073800">&#13;
<h2>Multiple Schedulers</h2>&#13;
&#13;
<p>It should be noted that you are not limited to one scheduler.<a data-primary="scheduler" data-secondary="extending" data-tertiary="multiple schedulers" data-type="indexterm" id="idm45611975847032"/><a data-primary="platform services, building" data-secondary="extending the scheduler" data-tertiary="multiple schedulers" data-type="indexterm" id="idm45611975845784"/>  You can deploy any number of schedulers that are either Kubernetes schedulers with different policies and profiles, or even custom-built schedulers.  If running multiple schedulers you can supply the <code>schedulerName</code> in the spec for a Pod, which will determine which scheduler carries out the scheduling for that Pod.  Given the added complexity of following this multischeduler model, consider using dedicated clusters for workloads with such specialized scheduling requirements.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Custom Scheduler" data-type="sect2"><div class="sect2" id="idm45611975843320">&#13;
<h2>Custom Scheduler</h2>&#13;
&#13;
<p>In the unlikely event that you are unable to use the Kubernetes scheduler, even with the use of policies and profiles, you have the option to develop and use your own scheduler.<a data-primary="scheduler" data-secondary="extending" data-tertiary="custom scheduler" data-type="indexterm" id="idm45611976545928"/><a data-primary="platform services, building" data-secondary="extending the scheduler" data-tertiary="custom scheduler" data-type="indexterm" id="idm45611976544792"/>  This would entail developing a controller that watches Pod resources and whenever a new Pod is created, determine where the Pod should run and update the <code>nodeName</code> field for that Pod.  While this is a narrow scope, this is not a simple exercise.  As we have seen in this section, the core scheduler is a sophisticated controller that routinely evaluates numerous complex factors into account when making scheduling decisions.  If your requirements are specialized enough to demand a custom scheduler, it’s likely you will have to spend considerable engineering effort to refine its behavior.  We recommend proceeding with this approach only if you have exhausted your options with the existing scheduler and have deep Kubernetes expertise to tap into for the project.<a data-primary="platform services, building" data-secondary="extending the scheduler" data-startref="ix_pltsersch" data-type="indexterm" id="idm45611976542296"/><a data-primary="scheduler" data-secondary="extending" data-startref="ix_schedext" data-type="indexterm" id="idm45611976541080"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45611976317320">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>It’s important to understand the points of extension available with Kubernetes and how best to add the platform services required to meet your tenants’ needs.  Study the operator pattern and the use cases for Kubernetes operators.  If you find a compelling need to build an operator, decide what development tooling and language you will use, design your custom resource’s data model, and then build a Kubernetes controller to manage that custom resource.  Finally, if the default scheduler behavior does not meet your requirements, look into scheduling policies and profiles to modify its behavior.  In extreme edge cases, you have the option to develop your own custom scheduler to replace, or run in conjunction with, the default scheduler.</p>&#13;
&#13;
<p>Using the principles and practices laid out in this chapter, you are no longer constrained by the utilities and software provided by the community or your company’s vendors.  If you encounter important requirements for which there is no existing solution, you have at your disposal the tools and guidelines to add any specialized platform services your business needs may require.<a data-primary="platform services, building" data-startref="ix_pltser" data-type="indexterm" id="idm45611975871160"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>