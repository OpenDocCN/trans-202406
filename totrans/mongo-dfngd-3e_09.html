<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Introduction to the Aggregation Framework"><div class="chapter" id="chapter_d1e6036"><h1><span class="label">Chapter 7. </span>Introduction to the <span class="keep-together">Aggregation Framework</span></h1><p>Many applications require data analysis of one form or another.
  MongoDB provides powerful support for running analytics natively using the
  aggregation framework. In this chapter, we introduce this framework and some
  of the fundamental tools it provides. We’ll cover:</p><ul><li><p>The aggregation framework</p></li><li><p>Aggregation stages</p></li><li><p>Aggregation expressions</p></li><li><p>Aggregation accumulators</p></li></ul><p>In the next chapter we’ll dive deeper and look at more advanced
  aggregation features, including the ability to perform joins across
  collections.</p><section data-type="sect1" data-pdf-bookmark="Pipelines, Stages, and Tunables"><div class="sect1" id="sect1-agg"><h1>Pipelines, Stages, and Tunables</h1><p>The<a data-type="indexterm" data-primary="aggregation framework" data-secondary="purpose of" id="idm45882365258728"/> aggregation framework is a set of analytics tools within
    MongoDB that allow you to do analytics on documents in one or more
    collections.</p><p>The<a data-type="indexterm" data-primary="aggregation framework" data-secondary="concept of" id="idm45882365257048"/> aggregation framework is based on the concept of a
    pipeline. With an aggregation pipeline we take input from a MongoDB
    collection and pass the documents from that collection through one or more
    stages, each of which performs a different operation on its inputs (<a data-type="xref" href="#fig0701">Figure 7-1</a>). Each stage takes as input whatever the stage before
    it produced as output. The inputs and outputs for all stages are
    documents—a stream of documents, if you will.</p><figure style="float: 0"><div id="fig0701" class="figure"><img src="Images/mdb3_0701.png" width="1142" height="296"/><h6><span class="label">Figure 7-1. </span>The aggregation pipeline</h6></div></figure><p>If you’re familiar with pipelines in a Linux shell, such as bash,
    this is a very similar idea. Each stage has a specific job that it does.
    It expects a specific form of document and produces a specific output,
    which is itself a stream of documents. At the end of the pipeline we get
    access to the output, in much the same way that we would by executing a
    find query. That is, we get a stream of documents back that we can then
    use to do additional work, whether it’s creating a report of some kind,
    generating a website, or some other type of task.</p><p>Now, let’s<a data-type="indexterm" data-primary="aggregation framework" data-secondary="individual stages" id="idm45882365251880"/> dive in a little deeper and consider the individual stages.
    An individual stage of an aggregation pipeline is a data processing unit.
    It takes in a stream of input documents one at a time, processes each
    document one at a time, and produces an output stream of documents one at
    a time (<a data-type="xref" href="#fig0702">Figure 7-2</a>).</p><figure style="float: 0"><div id="fig0702" class="figure"><img src="Images/mdb3_0702.png" width="975" height="283"/><h6><span class="label">Figure 7-2. </span>Stages of the aggregation pipeline</h6></div></figure><p>Each<a data-type="indexterm" data-primary="aggregation framework" data-secondary="tunables in" id="idm45882365247720"/> stage provides a set of knobs, or
    <em>tunables</em>, that we can control to parameterize the
    stage to perform whatever task we’re interested in doing. A stage performs
    a generic, general-purpose task of some kind, and we parameterize the
    stage for the particular collection that we’re working with and exactly
    what we would like that stage to do with those documents.</p><p>These tunables typically take the form of operators that we can
    supply that will modify fields, perform arithmetic operations, reshape
    documents, or do some sort of accumulation task or a variety of other
    things.</p><p>Before<a data-type="indexterm" data-primary="aggregation framework" data-secondary="repeated stages in" id="idm45882365244920"/> we start looking at some concrete examples, there’s one
    more aspect of pipelines that is especially important to keep in mind as
    you begin to work with them. Frequently, we want to include the same type
    of stage multiple times within a single pipeline (<a data-type="xref" href="#fig0703">Figure 7-3</a>). For example, we may want to perform an initial
    filter so that we don’t have to pass the entire collection into our
    pipeline. Later, following some additional processing, we might then want
    to filter further, applying a different set of <span class="keep-together">criteria</span>.</p><figure style="float: 0"><div id="fig0703" class="figure"><img src="Images/mdb3_0703.png" width="1375" height="296"/><h6><span class="label">Figure 7-3. </span>Repeated stages in the aggregation pipeline</h6></div></figure><p>To recap, pipelines work with MongoDB collections. They’re composed
    of stages, each of which does a different data processing task on its
    input and produces documents as output to be passed to the next stage.
    Finally, at the end of the processing, a pipeline produces output that we
    can then do something with in our application or that we can send to a
    collection for later use. In many cases, in order to perform the analysis
    we need to do, we will include the same type of stage multiple times
    within an individual pipeline.</p></div></section><section data-type="sect1" data-pdf-bookmark="Getting Started with Stages: Familiar Operations"><div class="sect1" id="idm45882365259816"><h1>Getting Started with Stages: Familiar Operations</h1><p>To<a data-type="indexterm" data-primary="aggregation framework" data-secondary="match, project, sort, skip, and limit stages" id="AFmatch07"/> get started developing aggregation pipelines, we will look
    at building some pipelines that involve operations that are already
    familiar to you. For this we will look at the <em>match</em>,
    <em>project</em>, <em>sort</em>,
    <em>skip</em>, and <em>limit</em> stages.</p><p>To work through these aggregation examples, we will use a collection
    of company data. The collection has a number of fields that specify
    details about the companies, such as name, a short description of the
    company, and when the company was founded.</p><p>There are also fields describing the rounds of funding a company has
    gone through, important milestones for the company, whether or not the
    company has been through an initial public offering (IPO), and, if so, the
    details of the IPO. Here’s an example document containing data on
    Facebook, Inc.:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"52cdef7c4bab8bd675297d8e"</code><code class="p">,</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code>
  <code class="s2">"category_code"</code> <code class="o">:</code> <code class="s2">"social"</code><code class="p">,</code>
  <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">2004</code><code class="p">,</code>
  <code class="s2">"description"</code> <code class="o">:</code> <code class="s2">"Social network"</code><code class="p">,</code>
  <code class="s2">"funding_rounds"</code> <code class="o">:</code> <code class="p">[{</code>
      <code class="s2">"id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code>
      <code class="s2">"round_code"</code> <code class="o">:</code> <code class="s2">"b"</code><code class="p">,</code>
      <code class="s2">"raised_amount"</code> <code class="o">:</code> <code class="mi">27500000</code><code class="p">,</code>
      <code class="s2">"raised_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
      <code class="s2">"funded_year"</code> <code class="o">:</code> <code class="mi">2006</code><code class="p">,</code>
      <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Greylock Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"greylock"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Meritech Capital Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"meritech-capital-partners"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Founders Fund"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"founders-fund"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"SV Angel"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"sv-angel"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">}</code>
      <code class="p">]</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="s2">"id"</code> <code class="o">:</code> <code class="mi">2197</code><code class="p">,</code>
      <code class="s2">"round_code"</code> <code class="o">:</code> <code class="s2">"c"</code><code class="p">,</code>
      <code class="s2">"raised_amount"</code> <code class="o">:</code> <code class="mi">15000000</code><code class="p">,</code>
      <code class="s2">"raised_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
      <code class="s2">"funded_year"</code> <code class="o">:</code> <code class="mi">2008</code><code class="p">,</code>
      <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"European Founders Fund"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"european-founders-fund"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">}</code>
      <code class="p">]</code>
    <code class="p">}],</code>
  <code class="s2">"ipo"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"valuation_amount"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"104000000000"</code><code class="p">),</code>
    <code class="s2">"valuation_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
    <code class="s2">"pub_year"</code> <code class="o">:</code> <code class="mi">2012</code><code class="p">,</code>
    <code class="s2">"pub_month"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
    <code class="s2">"pub_day"</code> <code class="o">:</code> <code class="mi">18</code><code class="p">,</code>
    <code class="s2">"stock_symbol"</code> <code class="o">:</code> <code class="s2">"NASDAQ:FB"</code>
  <code class="p">}</code>
<code class="p">}</code></pre><p>As our first aggregation example, let’s do a simple filter looking
    for all companies that were founded in 2004:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
    <code class="p">{</code><code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="nx">founded_year</code><code class="o">:</code> <code class="mi">2004</code><code class="p">}},</code>
<code class="p">])</code></pre><p>This is equivalent to the following operation using <code>find</code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">founded_year</code><code class="o">:</code> <code class="mi">2004</code><code class="p">})</code></pre><p>Now let’s add a project stage to our pipeline to reduce the output
    to just a few fields per document. We’ll exclude the <code>"_id"</code> field, but include <code>"name"</code> and <code>"founded_year"</code>. Our pipeline will be as
    follows:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code><code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="nx">founded_year</code><code class="o">:</code> <code class="mi">2004</code><code class="p">}},</code>
  <code class="p">{</code><code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">founded_year</code><code class="o">:</code> <code class="mi">1</code>
  <code class="p">}}</code>
<code class="p">])</code></pre><p>If we run this, we get output that looks like the following:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Digg"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"AddThis"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Veoh"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Pando Networks"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Jobster"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"AllPeers"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"blinkx"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Yelp"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"KickApps"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Flickr"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"FeedBurner"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Dogster"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Sway"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Loomia"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Redfin"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Wink"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Techmeme"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Eventful"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Oodle"</code><code class="p">,</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">...</code></pre><p>Let’s<a data-type="indexterm" data-primary="aggregation framework" data-secondary="aggregate method" id="idm45882364900664"/> unpack this aggregation pipeline in a little more detail.
    The first thing you will notice is that we’re using the <code>aggregate</code> method. This is the method we call
    when we want to run an aggregation query. To aggregate, we pass in an
    aggregation pipeline. A pipeline is an array with documents as elements.
    Each of the documents must stipulate a particular stage operator. In this
    example, we have a pipeline that has two stages: a match stage for
    filtering and a project stage with which we’re limiting the output to just
    two fields per document.</p><p>The match stage filters against the collection and passes the
    resulting documents to the project stage one at a time. The project stage
    then performs its operation, reshaping the documents, and passes the
    output out of the pipeline and back to us.</p><p>Now let’s extend our pipeline a bit further to include a limit
    stage. We’re going to match using the same query, but we’ll limit our
    result set to five and then project out the fields we want. For
    simplicity, let’s limit our output to just the names of each
    <span class="keep-together">company</span>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code><code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="nx">founded_year</code><code class="o">:</code> <code class="mi">2004</code><code class="p">}},</code>
  <code class="p">{</code><code class="nx">$limit</code><code class="o">:</code> <code class="mi">5</code><code class="p">},</code>
  <code class="p">{</code><code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">}}</code>
<code class="p">])</code></pre><p>The result is as follows:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Digg"</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"AddThis"</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Veoh"</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Pando Networks"</code><code class="p">}</code></pre><p>Note that we’ve constructed this pipeline so that we limit before
    the project stage. If we ran the project stage first and then the limit,
    as in the following query, we would get exactly the same results, but we’d
    have to pass hundreds of documents through the project stage before
    finally limiting the results to five:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code><code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="nx">founded_year</code><code class="o">:</code> <code class="mi">2004</code><code class="p">}},</code>
  <code class="p">{</code><code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">}},</code>
  <code class="p">{</code><code class="nx">$limit</code><code class="o">:</code> <code class="mi">5</code><code class="p">}</code>
<code class="p">])</code></pre><p>Regardless<a data-type="indexterm" data-primary="aggregation framework" data-secondary="pipeline efficiency" id="idm45882364434168"/> of what types of optimizations the MongoDB query planner
    might be capable of in a given release, you should always consider the
    efficiency of your aggregation pipeline. Ensure that you are limiting the
    number of documents that need to be passed on from one stage to another as
    you build your pipeline.</p><p>This requires careful consideration of the entire flow of documents
    through a pipeline. In the case of the preceding query, we’re only
    interested in the first five documents that match our query, regardless of
    how they are sorted, so it’s perfectly fine to limit as our second
    stage.</p><p>However, if<a data-type="indexterm" data-primary="aggregation framework" data-secondary="presorting" id="idm45882364344776"/> the order matters, then we’ll need to sort before the limit
    stage. Sorting works in a manner similar to what we have seen already,
    except that in the aggregation framework, we specify sort as a stage
    within a pipeline as follows (in this case, we will sort by name in
    ascending order):</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
    <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="nx">founded_year</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code> <code class="p">},</code>
    <code class="p">{</code> <code class="nx">$sort</code><code class="o">:</code> <code class="p">{</code> <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">}</code> <code class="p">},</code>
    <code class="p">{</code> <code class="nx">$limit</code><code class="o">:</code> <code class="mi">5</code> <code class="p">},</code>
    <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
        <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code>
<code class="p">])</code></pre><p>We get the following result from our <em>companies</em>
    collection:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"1915 Studios"</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"1Scan"</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"2GeeksinaLab"</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"2GeeksinaLab"</code><code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"2threads"</code><code class="p">}</code></pre><p>Note that we’re looking at a different set of five companies now,
    getting instead the first five documents in alphanumeric order by
    name.</p><p>Finally, let’s take a look at including a skip stage. Here, we sort
    first, then skip the first 10 documents and again limit our result set to
    5 documents:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code><code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="nx">founded_year</code><code class="o">:</code> <code class="mi">2004</code><code class="p">}},</code>
  <code class="p">{</code><code class="nx">$sort</code><code class="o">:</code> <code class="p">{</code><code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">}},</code>
  <code class="p">{</code><code class="nx">$skip</code><code class="o">:</code> <code class="mi">10</code><code class="p">},</code>
  <code class="p">{</code><code class="nx">$limit</code><code class="o">:</code> <code class="mi">5</code><code class="p">},</code>
  <code class="p">{</code><code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">}},</code>
<code class="p">])</code></pre><p>Let’s review our pipeline one more time. We have five stages. First,
    we’re filtering the <em>companies</em> collection, looking
    only for documents where the <code>"founded_year"</code> is <code>2004</code>. Then we’re sorting based on the name in
    ascending order, skipping the first 10 matches, and limiting our end
    results to 5. Finally, we pass those five documents on to the project
    stage, where we reshape the documents such that our output documents
    contain just the company name.</p><p>Here, we’ve looked at constructing pipelines using stages that
    perform operations that should already be familiar to you. These
    operations are provided in the aggregation framework because they are
    necessary for the types of analytics that we’ll want to accomplish using
    stages discussed in later sections. As we move through the rest of this
    chapter, we will take a deep dive into the other operations that the
    aggregation framework<a data-type="indexterm" data-startref="AFmatch07" id="idm45882364154552"/> provides.</p></div></section><section data-type="sect1" data-pdf-bookmark="Expressions"><div class="sect1" id="idm45882365211176"><h1>Expressions</h1><p>As<a data-type="indexterm" data-primary="aggregation framework" data-secondary="expression classes supported" id="idm45882364152920"/> we move deeper into our discussion of the aggregation
    framework, it is important to have a sense of the different types of
    expressions available for use as you construct aggregation pipelines. The
    aggregation framework supports many different classes of
    expressions:</p><ul><li><p><em>Boolean</em> expressions allow us to use AND,
        OR, and NOT expressions.</p></li><li><p><em>Set</em> expressions allow us to work with
        arrays as sets. In particular, we can get the intersection or union of
        two or more sets. We can also take the difference of two sets and
        perform a number of other set operations.</p></li><li><p><em>Comparison</em> expressions enable us to express
        many different types of range filters.</p></li><li><p><em>Arithmetic</em> expressions enable us to
        calculate the ceiling, floor, natural log, and log, as well as perform
        simple arithmetic operations like multiplication, division, addition,
        and subtraction. We can even do more complex operations, such as
        calculating the square root of a value.</p></li><li><p><em>String</em> expressions allow us to concatenate,
        find substrings, and perform operations having to do with case and
        text search operations.</p></li><li><p><em>Array</em> expressions provide a lot of power
        for manipulating arrays, including the ability to filter array
        elements, slice an array, or just take a range of values from a
        specific array.</p></li><li><p><em>Variable</em> expressions, which we won’t dive
        into too deeply, allow us to work with literals, expressions for
        parsing date values, and conditional expressions.</p></li><li><p><em>Accumulators</em> provide the ability to
        calculate sums, descriptive statistics, and many other types of
        values.</p></li></ul></div></section><section data-type="sect1" data-pdf-bookmark="$project"><div class="sect1" id="idm45882364144552"><h1>$project</h1><p>Now<a data-type="indexterm" data-primary="$project operator" data-primary-sortas="project operator" id="poper07"/><a data-type="indexterm" data-primary="aggregation framework" data-secondary="$project operator" id="AFproject07"/> we’re going to take a deeper dive into the project stage
    and reshaping documents, exploring the types of reshaping operations that
    should be most common in the applications that you develop. We have seen
    some simple projections in aggregation pipelines, and now we’ll take a
    look at some that are a little more complex.</p><p>First, let’s look at promoting nested fields. In the following
    pipeline, we are doing a match:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code><code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="s2">"funding_rounds.investments.financial_org.permalink"</code><code class="o">:</code> <code class="s2">"greylock"</code> <code class="p">}},</code>
  <code class="p">{</code><code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> 
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">ipo</code><code class="o">:</code> <code class="s2">"$ipo.pub_year"</code><code class="p">,</code>
    <code class="nx">valuation</code><code class="o">:</code> <code class="s2">"$ipo.valuation_amount"</code><code class="p">,</code>
    <code class="nx">funders</code><code class="o">:</code> <code class="s2">"$funding_rounds.investments.financial_org.permalink"</code>
  <code class="p">}}</code>
<code class="p">]).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>As an example of the relevant fields for documents in our
    <em>companies</em> collection, let’s again look at a portion
    of the Facebook document:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"52cdef7c4bab8bd675297d8e"</code><code class="p">,</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code>
  <code class="s2">"category_code"</code> <code class="o">:</code> <code class="s2">"social"</code><code class="p">,</code>
  <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">2004</code><code class="p">,</code>
  <code class="s2">"description"</code> <code class="o">:</code> <code class="s2">"Social network"</code><code class="p">,</code>
  <code class="s2">"funding_rounds"</code> <code class="o">:</code> <code class="p">[{</code>
      <code class="s2">"id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code>
      <code class="s2">"round_code"</code> <code class="o">:</code> <code class="s2">"b"</code><code class="p">,</code>
      <code class="s2">"raised_amount"</code> <code class="o">:</code> <code class="mi">27500000</code><code class="p">,</code>
      <code class="s2">"raised_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
      <code class="s2">"funded_year"</code> <code class="o">:</code> <code class="mi">2006</code><code class="p">,</code>
      <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Greylock Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"greylock"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Meritech Capital Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"meritech-capital-partners"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Founders Fund"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"founders-fund"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"SV Angel"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"sv-angel"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">}</code>
      <code class="p">]</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="s2">"id"</code> <code class="o">:</code> <code class="mi">2197</code><code class="p">,</code>
      <code class="s2">"round_code"</code> <code class="o">:</code> <code class="s2">"c"</code><code class="p">,</code>
      <code class="s2">"raised_amount"</code> <code class="o">:</code> <code class="mi">15000000</code><code class="p">,</code>
      <code class="s2">"raised_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
      <code class="s2">"funded_year"</code> <code class="o">:</code> <code class="mi">2008</code><code class="p">,</code>
      <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"European Founders Fund"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"european-founders-fund"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">}</code>
      <code class="p">]</code>
    <code class="p">}],</code>
  <code class="s2">"ipo"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"valuation_amount"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"104000000000"</code><code class="p">),</code>
    <code class="s2">"valuation_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
    <code class="s2">"pub_year"</code> <code class="o">:</code> <code class="mi">2012</code><code class="p">,</code>
    <code class="s2">"pub_month"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
    <code class="s2">"pub_day"</code> <code class="o">:</code> <code class="mi">18</code><code class="p">,</code>
    <code class="s2">"stock_symbol"</code> <code class="o">:</code> <code class="s2">"NASDAQ:FB"</code>
  <code class="p">}</code>
<code class="p">}</code></pre><p>Going back to our match:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code><code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="s2">"funding_rounds.investments.financial_org.permalink"</code><code class="o">:</code> <code class="s2">"greylock"</code> <code class="p">}},</code>
  <code class="p">{</code><code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> 
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">ipo</code><code class="o">:</code> <code class="s2">"$ipo.pub_year"</code><code class="p">,</code>
    <code class="nx">valuation</code><code class="o">:</code> <code class="s2">"$ipo.valuation_amount"</code><code class="p">,</code>
    <code class="nx">funders</code><code class="o">:</code> <code class="s2">"$funding_rounds.investments.financial_org.permalink"</code>
  <code class="p">}}</code>
<code class="p">]).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>we are filtering for all companies that had a funding round in which
    Greylock Partners participated. The permalink value, <code>"greylock"</code>, is the unique identifier for such
    documents. Here is another view of the Facebook document with just the
    relevant fields displayed:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="p">...</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code>
  <code class="p">...</code>
  <code class="s2">"funding_rounds"</code> <code class="o">:</code> <code class="p">[{</code>
    <code class="p">...</code>
    <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[{</code>
      <code class="p">...</code>
      <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Greylock Partners"</code><code class="p">,</code>
        <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"greylock"</code>
      <code class="p">},</code>
      <code class="p">...</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="p">...</code>
      <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Meritech Capital Partners"</code><code class="p">,</code>
        <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"meritech-capital-partners"</code>
      <code class="p">},</code>
      <code class="p">...</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="p">...</code>
      <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Founders Fund"</code><code class="p">,</code>
        <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"founders-fnd"</code>
      <code class="p">},</code>
      <code class="p">...</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
      <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"SV Angel"</code><code class="p">,</code>
        <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"sv-angel"</code>
      <code class="p">},</code>
      <code class="p">...</code>
    <code class="p">}],</code>
    <code class="p">...</code>
  <code class="p">]},</code>
  <code class="p">{</code>
    <code class="p">...</code>
    <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[{</code>
      <code class="p">...</code>
      <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"European Founders Fund"</code><code class="p">,</code>
        <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"european-founders-fund"</code>
      <code class="p">},</code>
      <code class="p">...</code>
    <code class="p">}]</code>
  <code class="p">}],</code>
  <code class="s2">"ipo"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"valuation_amount"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"104000000000"</code><code class="p">),</code>
    <code class="s2">"valuation_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
    <code class="s2">"pub_year"</code> <code class="o">:</code> <code class="mi">2012</code><code class="p">,</code>
    <code class="s2">"pub_month"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
    <code class="s2">"pub_day"</code> <code class="o">:</code> <code class="mi">18</code><code class="p">,</code>
    <code class="s2">"stock_symbol"</code> <code class="o">:</code> <code class="s2">"NASDAQ:FB"</code>
  <code class="p">}</code>
<code class="p">}</code></pre><p>The project stage we have defined in this aggregation pipeline will
    suppress the <code>"_id"</code> and include the
    <code>"name"</code>. It will also promote some
    nested fields. This project uses dot notation to express field paths that
    reach into the <code>"ipo"</code> field and the
    <code>"funding_rounds"</code> field to select values
    from those nested documents and arrays. This project stage will make those
    the values of top-level fields in the documents it produces as output, as
    shown here:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Digg"</code><code class="p">,</code>
  <code class="s2">"funders"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="p">[</code>
      <code class="s2">"greylock"</code><code class="p">,</code>
      <code class="s2">"omidyar-network"</code>
    <code class="p">],</code>
    <code class="p">[</code>
      <code class="s2">"greylock"</code><code class="p">,</code>
      <code class="s2">"omidyar-network"</code><code class="p">,</code>
      <code class="s2">"floodgate"</code><code class="p">,</code>
      <code class="s2">"sv-angel"</code>
    <code class="p">],</code>
    <code class="p">[</code>
      <code class="s2">"highland-capital-partners"</code><code class="p">,</code>
      <code class="s2">"greylock"</code><code class="p">,</code>
      <code class="s2">"omidyar-network"</code><code class="p">,</code>
      <code class="s2">"svb-financial-group"</code>
    <code class="p">]</code>
  <code class="p">]</code>
<code class="p">}</code>
<code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code>
  <code class="s2">"ipo"</code> <code class="o">:</code> <code class="mi">2012</code><code class="p">,</code>
  <code class="s2">"valuation"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"104000000000"</code><code class="p">),</code>
  <code class="s2">"funders"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="p">[</code>
      <code class="s2">"accel-partners"</code>
    <code class="p">],</code>
    <code class="p">[</code>
      <code class="s2">"greylock"</code><code class="p">,</code>
      <code class="s2">"meritech-capital-partners"</code><code class="p">,</code>
      <code class="s2">"founders-fund"</code><code class="p">,</code>
      <code class="s2">"sv-angel"</code>
    <code class="p">],</code>
    <code class="p">...</code>
    <code class="p">[</code>
      <code class="s2">"goldman-sachs"</code><code class="p">,</code>
      <code class="s2">"digital-sky-technologies-fo"</code>
    <code class="p">]</code>
  <code class="p">]</code>
<code class="p">}</code>
<code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Revision3"</code><code class="p">,</code>
  <code class="s2">"funders"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="p">[</code>
      <code class="s2">"greylock"</code><code class="p">,</code>
      <code class="s2">"sv-angel"</code>
    <code class="p">],</code>
    <code class="p">[</code>
      <code class="s2">"greylock"</code>
    <code class="p">]</code>
  <code class="p">]</code>
<code class="p">}</code>
<code class="p">...</code></pre><p>In the output, each document has a <code>"name"</code> field and a <code>"funders"</code> field. For those companies that have
    gone through an IPO, the <code>"ipo"</code> field
    contains the year the company went public and the <code>"valuation"</code> field contains the value of the
    company at the time of the IPO. Note that in all of these documents, these
    are top-level fields and the values for those fields were promoted from
    nested documents and arrays.</p><p>The <code>$</code> character used to specify
    the values for <code>ipo</code>, <code>valuation</code>, and <code>funders</code> in our project stage indicates that the
    values should be interpreted as field paths and used to select the value
    that should be projected for each field, respectively.</p><p>One thing you might have noticed is that we’re seeing multiple
    values printed out for <code>funders</code>. In
    fact, we’re seeing an array of arrays. Based on our review of the Facebook
    example document, we know that all of the funders are listed within an
    array called <code>"investments"</code>. Our stage
    specifies that we want to project the <code>financial_org.permalink</code> value for each entry in
    the <code>"investments"</code> array, for every
    funding round. So, an array of arrays of funders’ names is built
    up.</p><p>In later sections we will look at how to perform arithmetic and
    other operations on strings, dates, and a number of other value types to
    project documents of all shapes and sizes. Just about the only thing we
    can’t do from a project stage is change the data type for a
    value.<a data-type="indexterm" data-startref="poper07" id="idm45882363378376"/><a data-type="indexterm" data-startref="AFproject07" id="idm45882363316856"/></p></div></section><section data-type="sect1" data-pdf-bookmark="$unwind"><div class="sect1" id="idm45882364144248"><h1>$unwind</h1><p>When<a data-type="indexterm" data-primary="$unwind operator" data-primary-sortas="unwind operator" id="unwind07"/><a data-type="indexterm" data-primary="aggregation framework" data-secondary="$unwind operator" id="AFunwind07"/> working with array fields in an aggregation pipeline, it is
    often necessary to include one or more unwind stages. This allows us to
    produce output such that there is one output document for each element in
    a specified array field.</p><figure style="float: 0"><div id="fig0704" class="figure"><img src="Images/mdb3_0704.png" width="1001" height="423"/><h6><span class="label">Figure 7-4. </span>$unwind takes an array from the input document and creates an
      output document for each element in that array</h6></div></figure><p>In the example in <a data-type="xref" href="#fig0704">Figure 7-4</a>, we have an input
    document that has three keys and their corresponding values. The third key
    has as its value an array with three elements. <code>$unwind</code> if run on this type of input document
    and configured to unwind the <code>key3</code> field
    will produce documents that look like those shown at the bottom of <a data-type="xref" href="#fig0704">Figure 7-4</a>. The thing that might not be intuitive to you about
    this is that in each of these output documents there will be a <code>key3</code> field, but that field will contain a single
    value rather than an array value, and there will be a separate document
    for each one of the elements that were in this array. In other words, if
    there were 10 elements in the array, the unwind stage would produce 10
    output documents.</p><p>Let’s go back to our <em>companies</em> example, and
    take a look at the use of an unwind stage. We’ll start with the following
    aggregation pipeline. Note that in this pipeline, as in the previous
    section, we are simply matching on a specific funder and promoting values
    from embedded <code>funding_rounds</code> documents
    using a project stage:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code><code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="s2">"funding_rounds.investments.financial_org.permalink"</code><code class="o">:</code> <code class="s2">"greylock"</code><code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code><code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">amount</code><code class="o">:</code> <code class="s2">"$funding_rounds.raised_amount"</code><code class="p">,</code>
    <code class="nx">year</code><code class="o">:</code> <code class="s2">"$funding_rounds.funded_year"</code>
  <code class="p">}}</code>
<code class="p">])</code></pre><p>Once again, here’s an example of the data model for documents in
    this collection:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"52cdef7c4bab8bd675297d8e"</code><code class="p">,</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code>
  <code class="s2">"category_code"</code> <code class="o">:</code> <code class="s2">"social"</code><code class="p">,</code>
  <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">2004</code><code class="p">,</code>
  <code class="s2">"description"</code> <code class="o">:</code> <code class="s2">"Social network"</code><code class="p">,</code>
  <code class="s2">"funding_rounds"</code> <code class="o">:</code> <code class="p">[{</code>
      <code class="s2">"id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code>
      <code class="s2">"round_code"</code> <code class="o">:</code> <code class="s2">"b"</code><code class="p">,</code>
      <code class="s2">"raised_amount"</code> <code class="o">:</code> <code class="mi">27500000</code><code class="p">,</code>
      <code class="s2">"raised_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
      <code class="s2">"funded_year"</code> <code class="o">:</code> <code class="mi">2006</code><code class="p">,</code>
      <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Greylock Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"greylock"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Meritech Capital Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"meritech-capital-partners"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Founders Fund"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"founders-fund"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"SV Angel"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"sv-angel"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">}</code>
      <code class="p">]</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="s2">"id"</code> <code class="o">:</code> <code class="mi">2197</code><code class="p">,</code>
      <code class="s2">"round_code"</code> <code class="o">:</code> <code class="s2">"c"</code><code class="p">,</code>
      <code class="s2">"raised_amount"</code> <code class="o">:</code> <code class="mi">15000000</code><code class="p">,</code>
      <code class="s2">"raised_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
      <code class="s2">"funded_year"</code> <code class="o">:</code> <code class="mi">2008</code><code class="p">,</code>
      <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"European Founders Fund"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"european-founders-fund"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">}</code>
      <code class="p">]</code>
    <code class="p">}],</code>
  <code class="s2">"ipo"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"valuation_amount"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"104000000000"</code><code class="p">),</code>
    <code class="s2">"valuation_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
    <code class="s2">"pub_year"</code> <code class="o">:</code> <code class="mi">2012</code><code class="p">,</code>
    <code class="s2">"pub_month"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
    <code class="s2">"pub_day"</code> <code class="o">:</code> <code class="mi">18</code><code class="p">,</code>
    <code class="s2">"stock_symbol"</code> <code class="o">:</code> <code class="s2">"NASDAQ:FB"</code>
  <code class="p">}</code>
<code class="p">}</code></pre><p>Our aggregation query will produce results such as the
    following:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Digg"</code><code class="p">,</code>
  <code class="s2">"amount"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="mi">8500000</code><code class="p">,</code>
    <code class="mi">2800000</code><code class="p">,</code>
    <code class="mi">28700000</code><code class="p">,</code>
    <code class="mi">5000000</code>
  <code class="p">],</code>
  <code class="s2">"year"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="mi">2006</code><code class="p">,</code>
    <code class="mi">2005</code><code class="p">,</code>
    <code class="mi">2008</code><code class="p">,</code>
    <code class="mi">2011</code>
  <code class="p">]</code>
<code class="p">}</code>
<code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code>
  <code class="s2">"amount"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="mi">500000</code><code class="p">,</code>
    <code class="mi">12700000</code><code class="p">,</code>
    <code class="mi">27500000</code><code class="p">,</code>
    <code class="p">...</code></pre><p>The query produces documents that have arrays for both <code>"amount"</code> and <code>"year"</code>, because we’re accessing the <code>"raised_amount"</code> and <code>"funded_year"</code> for every element in the <code>"funding_rounds"</code> array.</p><p>To fix this, we can include an unwind stage before our project stage
    in this aggregation pipeline, and parameterize this by specifying that it
    is the <code>"funding_rounds"</code> array that
    should be unwound (<a data-type="xref" href="#fig0705">Figure 7-5</a>).</p><figure style="float: 0"><div id="fig0705" class="figure"><img src="Images/mdb3_0705.png" width="864" height="278"/><h6><span class="label">Figure 7-5. </span>The outline of our aggregation pipeline so far, matching for
      “greylock” then unwinding the “funding_rounds”, and finally projecting
      out the name, amount, and year for each of the funding rounds</h6></div></figure><p>Returning again to our Facebook example, we can see that for each
    funding round there is a <code>"raised_amount"</code> field and a <code>"funded_year"</code> field.</p><p>The unwind stage will produce an output document for each element of
    the <code>"funding_rounds"</code> array. In this
    example our values are strings, but regardless of the type of value, the
    unwind stage will produce an output document for each one. Here’s the
    updated aggregation query:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="s2">"funding_rounds.investments.financial_org.permalink"</code><code class="o">:</code> <code class="s2">"greylock"</code><code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$unwind</code><code class="o">:</code> <code class="s2">"$funding_rounds"</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">amount</code><code class="o">:</code> <code class="s2">"$funding_rounds.raised_amount"</code><code class="p">,</code>
    <code class="nx">year</code><code class="o">:</code> <code class="s2">"$funding_rounds.funded_year"</code>
  <code class="p">}</code> <code class="p">}</code>
<code class="p">])</code></pre><p>The unwind stage produces an exact copy of every one of the
    documents that it receives as input. All the fields will have the same key
    and value, with the exception of the <code>"funding_rounds"</code> field. Rather than being an
    array of <code>"funding_rounds"</code> documents,
    instead it will have a value that is a single document, which corresponds
    to an individual funding round:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Digg"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">8500000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2006</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Digg"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">2800000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2005</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Digg"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">28700000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2008</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Digg"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">5000000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2011</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">500000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">12700000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2005</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">27500000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2006</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">240000000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2007</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">60000000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2007</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">15000000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2008</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">100000000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2008</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">60000000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2008</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">200000000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2009</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">210000000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2010</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">1500000000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2011</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Revision3"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">1000000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2006</code> <code class="p">}</code>
<code class="p">{</code><code class="s2">"name"</code><code class="o">:</code> <code class="s2">"Revision3"</code><code class="p">,</code> <code class="s2">"amount"</code><code class="o">:</code> <code class="mi">8000000</code><code class="p">,</code> <code class="s2">"year"</code><code class="o">:</code> <code class="mi">2007</code> <code class="p">}</code>
<code class="p">...</code></pre><p>Now let’s add an additional field to our output documents. In doing
    so, we’ll actually identify a small problem with this aggregation pipeline
    as currently written:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="s2">"funding_rounds.investments.financial_org.permalink"</code><code class="o">:</code> <code class="s2">"greylock"</code><code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$unwind</code><code class="o">:</code> <code class="s2">"$funding_rounds"</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">funder</code><code class="o">:</code> <code class="s2">"$funding_rounds.investments.financial_org.permalink"</code><code class="p">,</code>
    <code class="nx">amount</code><code class="o">:</code> <code class="s2">"$funding_rounds.raised_amount"</code><code class="p">,</code>
    <code class="nx">year</code><code class="o">:</code> <code class="s2">"$funding_rounds.funded_year"</code>
  <code class="p">}</code> <code class="p">}</code>
<code class="p">])</code></pre><p>In adding the <code>"funder"</code> field we
    now have a field path value that will access the <code>"investments"</code> field of the <code>"funding_rounds"</code> embedded document that it gets
    from the unwind stage and, for the financial organization, selects the
    permalink value. Note that this is very similar to what we’re doing in our
    match filter. Let’s have a look at our output:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Digg"</code><code class="p">,</code>
  <code class="s2">"funder"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="s2">"greylock"</code><code class="p">,</code>
    <code class="s2">"omidyar-network"</code>
  <code class="p">],</code>
  <code class="s2">"amount"</code> <code class="o">:</code> <code class="mi">8500000</code><code class="p">,</code>
  <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">2006</code>
<code class="p">}</code>
<code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Digg"</code><code class="p">,</code>
  <code class="s2">"funder"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="s2">"greylock"</code><code class="p">,</code>
    <code class="s2">"omidyar-network"</code><code class="p">,</code>
    <code class="s2">"floodgate"</code><code class="p">,</code>
    <code class="s2">"sv-angel"</code>
  <code class="p">],</code>
  <code class="s2">"amount"</code> <code class="o">:</code> <code class="mi">2800000</code><code class="p">,</code>
  <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">2005</code>
<code class="p">}</code>
<code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Digg"</code><code class="p">,</code>
  <code class="s2">"funder"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="s2">"highland-capital-partners"</code><code class="p">,</code>
    <code class="s2">"greylock"</code><code class="p">,</code>
    <code class="s2">"omidyar-network"</code><code class="p">,</code>
    <code class="s2">"svb-financial-group"</code>
  <code class="p">],</code>
  <code class="s2">"amount"</code> <code class="o">:</code> <code class="mi">28700000</code><code class="p">,</code>
  <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">2008</code>
<code class="p">}</code>
<code class="p">...</code>
<code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Farecast"</code><code class="p">,</code>
  <code class="s2">"funder"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="s2">"madrona-venture-group"</code><code class="p">,</code>
    <code class="s2">"wrf-capital"</code>
  <code class="p">],</code>
  <code class="s2">"amount"</code> <code class="o">:</code> <code class="mi">1500000</code><code class="p">,</code>
  <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">2004</code>
<code class="p">}</code>
<code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Farecast"</code><code class="p">,</code>
  <code class="s2">"funder"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="s2">"greylock"</code><code class="p">,</code>
    <code class="s2">"madrona-venture-group"</code><code class="p">,</code>
    <code class="s2">"wrf-capital"</code>
  <code class="p">],</code>
  <code class="s2">"amount"</code> <code class="o">:</code> <code class="mi">7000000</code><code class="p">,</code>
  <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">2005</code>
<code class="p">}</code>
<code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Farecast"</code><code class="p">,</code>
  <code class="s2">"funder"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="s2">"greylock"</code><code class="p">,</code>
    <code class="s2">"madrona-venture-group"</code><code class="p">,</code>
    <code class="s2">"par-capital-management"</code><code class="p">,</code>
    <code class="s2">"pinnacle-ventures"</code><code class="p">,</code>
    <code class="s2">"sutter-hill-ventures"</code><code class="p">,</code>
    <code class="s2">"wrf-capital"</code>
  <code class="p">],</code>
  <code class="s2">"amount"</code> <code class="o">:</code> <code class="mi">12100000</code><code class="p">,</code>
  <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">2007</code>
<code class="p">}</code></pre><p>To understand what we’re seeing here, we need to go back to our
    document and look at the <code>"investments"</code>
    field.</p><p>The <code>"funding_rounds.investments"</code>
    field is itself an array. Multiple funders can participate in each funding
    round, so <code>"investments"</code> will list every
    one of those funders. Looking at the results, as we originally saw with
    the <code>"raised_amount"</code> and <code>"funded_year"</code> fields, we’re now seeing an array
    for <code>"funder"</code> because <code>"investments"</code> is an array-valued field.</p><p>Another problem is that because of the way we’ve written our
    pipeline, many documents are passed to the project stage that represent
    funding rounds that Greylock did not participate in. We can see this by
    looking at the funding rounds for Farecast. This problem stems from the
    fact that our match stage selects all companies where Greylock
    participated in at least one funding round. If we are interested in
    considering only those funding rounds in which Greylock actually
    participated, we need to figure out a way to filter differently.</p><p>One possibility is to reverse the order of our unwind and match
    stages—that is to say, do the unwind first and then do the match. This
    guarantees that we will only match documents coming out of the unwind
    stage. But in thinking through this approach, it quickly becomes clear
    that, with unwind as the first stage, we would be doing a scan through the
    entire collection.</p><p>For efficiency, we want to match as early as possible in our
    pipeline. This enables the aggregation framework to make use of indexes,
    for example. So, in order to select only those funding rounds in which
    Greylock participated, we can include a second match stage:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="s2">"funding_rounds.investments.financial_org.permalink"</code><code class="o">:</code> <code class="s2">"greylock"</code><code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$unwind</code><code class="o">:</code> <code class="s2">"$funding_rounds"</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="s2">"funding_rounds.investments.financial_org.permalink"</code><code class="o">:</code> <code class="s2">"greylock"</code><code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">individualFunder</code><code class="o">:</code> <code class="s2">"$funding_rounds.investments.person.permalink"</code><code class="p">,</code>
    <code class="nx">fundingOrganization</code><code class="o">:</code> <code class="s2">"$funding_rounds.investments.financial_org.permalink"</code><code class="p">,</code>
    <code class="nx">amount</code><code class="o">:</code> <code class="s2">"$funding_rounds.raised_amount"</code><code class="p">,</code>
    <code class="nx">year</code><code class="o">:</code> <code class="s2">"$funding_rounds.funded_year"</code>
  <code class="p">}</code> <code class="p">}</code>
<code class="p">])</code></pre><p>This pipeline will first filter for companies where Greylock
    participated in at least one funding round. It will then unwind the
    funding rounds and filter again, so that only documents that represent
    funding rounds that Greylock actually participated in will be passed on to
    the project stage.</p><p>As mentioned at the beginning of this chapter, it is often the case
    that we need to include multiple stages of the same type. This is a good
    example: we’re filtering to reduce the number of documents that we’re
    looking at initially by narrowing down our set of documents for
    consideration to those for which Greylock participated in at least one
    funding round. Then, through our unwind stage, we end up with a number of
    documents that represent funding rounds from companies that Greylock did,
    in fact, fund, but individual funding rounds that Greylock did not
    participate in. We can get rid of all the funding rounds we’re not
    interested in by simply including another filter, using a second
    match<a data-type="indexterm" data-startref="AFunwind07" id="idm45882362104088"/><a data-type="indexterm" data-startref="unwind07" id="idm45882362103352"/> stage.</p></div></section><section data-type="sect1" data-pdf-bookmark="Array Expressions"><div class="sect1" id="idm45882363315688"><h1>Array Expressions</h1><p>Now<a data-type="indexterm" data-primary="aggregation framework" data-secondary="array expressions in project stages" id="AFarray07"/><a data-type="indexterm" data-primary="expressions, using array expression in project&#10;        stages" id="express07"/><a data-type="indexterm" data-primary="array expressions, using in project stages" id="arrayexproj07"/> let’s turn our attention to array expressions. As part of
    our deep dive, we’ll take a look at using array expressions in project
    stages.</p><p>The first expression we’ll examine is a filter expression<a data-type="indexterm" data-primary="filter expressions" id="idm45882362097896"/>. A filter expression selects a subset of the elements in an
    array based on filter criteria.</p><p>Working again with our <em>companies</em> dataset, we’ll
    match using the same criteria for funding rounds in which Greylock
    participated. Take a look at the <code>rounds</code>
    field in this pipeline:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="s2">"funding_rounds.investments.financial_org.permalink"</code><code class="o">:</code> <code class="s2">"greylock"</code><code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">founded_year</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">rounds</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$filter</code><code class="o">:</code> <code class="p">{</code>
      <code class="nx">input</code><code class="o">:</code> <code class="s2">"$funding_rounds"</code><code class="p">,</code>
      <code class="nx">as</code><code class="o">:</code> <code class="s2">"round"</code><code class="p">,</code>
      <code class="nx">cond</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$gte</code><code class="o">:</code> <code class="p">[</code><code class="s2">"$$round.raised_amount"</code><code class="p">,</code> <code class="mi">100000000</code><code class="p">]</code> <code class="p">}</code> <code class="p">}</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code><code class="s2">"rounds.investments.financial_org.permalink"</code><code class="o">:</code> <code class="s2">"greylock"</code> <code class="p">}</code> <code class="p">},</code>
<code class="p">]).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>The <code>rounds</code> field uses a filter
    expression. The <code>$filter</code> operator
    <a data-type="indexterm" data-primary="$filter operator" data-primary-sortas="filter operator" id="idm45882361942040"/>is designed to work with array fields and specifies the
    options we must supply. The first option to <code>$filter</code> is <code>input</code>. For <code>input</code>, we simply specify an array. In this case,
    we use a field path specifier to identify the <code>"funding_rounds"</code> array found in documents in our
    <em>companies</em> collection. Next, we specify the name we’d
    like to use for this <code>"funding_rounds"</code>
    array throughout the rest of our filter expression. Then, as the third
    option, we need to specify a condition. The condition should provide
    criteria used to filter whatever array we’ve provided as input, selecting
    a subset. In this case, we’re filtering such that we only select elements
    where the <code>"raised_amount"</code> for a
    <code>"funding_round"</code> is greater than or
    equal to 100 million.</p><p>In<a data-type="indexterm" data-primary="$ (dollar sign)" data-secondary="$$ (variable reference)" id="idm45882362093656"/> specifying the condition, we’ve made use of <code>$$</code>. We use <code>$$</code>
    to reference a variable defined within the expression we’re working in.
    The <code>as</code> clause defines a variable within
    our filter expression. This variable has the name <code>"round"</code> because that’s what we labeled it in the
    <code>as</code> clause. This is to disambiguate a
    reference to a variable from a field path. In this case, our comparison
    expression takes an array of two values and will return <code>true</code> if the first value provided is greater than
    or equal to the second value.</p><p>Now let’s consider what documents the project stage of this pipeline
    will produce, given this filter. The output documents will have <code>"name"</code>, <code>"founded_year"</code>, and <code>"rounds"</code> fields. The values for <code>"rounds"</code> will be arrays composed of the elements
    that match our filter condition: that the raised amount is greater than
    $100,000,000.</p><p>In the match stage that follows, as we did previously, we will
    simply filter the input documents for those that were funded in some way
    by Greylock. Documents output by this pipeline will resemble the
    following:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Dropbox"</code><code class="p">,</code>
  <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">2007</code><code class="p">,</code>
  <code class="s2">"rounds"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="p">{</code>
      <code class="s2">"id"</code> <code class="o">:</code> <code class="mi">25090</code><code class="p">,</code>
      <code class="s2">"round_code"</code> <code class="o">:</code> <code class="s2">"b"</code><code class="p">,</code>
      <code class="s2">"source_description"</code> <code class="o">:</code> 
        <code class="s2">"Dropbox Raises $250M In Funding, Boasts 45 Million Users"</code><code class="p">,</code>
      <code class="s2">"raised_amount"</code> <code class="o">:</code> <code class="mi">250000000</code><code class="p">,</code>
      <code class="s2">"raised_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
      <code class="s2">"funded_year"</code> <code class="o">:</code> <code class="mi">2011</code><code class="p">,</code>
      <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Index Ventures"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"index-ventures"</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"RIT Capital Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"rit-capital-partners"</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Valiant Capital Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"valiant-capital-partners"</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Benchmark"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"benchmark-2"</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Goldman Sachs"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"goldman-sachs"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Greylock Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"greylock"</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Institutional Venture Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"institutional-venture-partners"</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Sequoia Capital"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"sequoia-capital"</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Accel Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"accel-partners"</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Glynn Capital Management"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"glynn-capital-management"</code>
          <code class="p">}</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"SV Angel"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"sv-angel"</code>
          <code class="p">}</code>
        <code class="p">}</code>
      <code class="p">]</code>
    <code class="p">}</code>
  <code class="p">]</code>
<code class="p">}</code></pre><p>Only the <code>"rounds"</code> array items for
    which the raised amount exceeds $100,000,000 will pass through the filter.
    In the case of Dropbox, there is just one round that meets that criterion.
    You have a lot of flexibility in how you set up filter expressions, but
    this is the basic form and provides a concrete example of a use case for
    this particular array expression.</p><p>Next, let’s look at the array element operator. We’ll continue
    working with funding rounds, but in this case we simply want to pull out
    the first round and the last round. We might be interested, for example,
    in seeing when these rounds occurred or in comparing their amounts. These
    are things we can do with date and arithmetic expressions, as we’ll see in
    the next section.</p><p>The <code>$arrayElemAt</code> operator enables
    us to select an element at a particular slot within an array. The
    following pipeline provides an example of using <code>$arrayElemAt</code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2010</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">founded_year</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">first_round</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$arrayElemAt</code><code class="o">:</code> <code class="p">[</code> <code class="s2">"$funding_rounds"</code><code class="p">,</code> <code class="mi">0</code> <code class="p">]</code> <code class="p">},</code>
    <code class="nx">last_round</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$arrayElemAt</code><code class="o">:</code> <code class="p">[</code> <code class="s2">"$funding_rounds"</code><code class="p">,</code> <code class="o">-</code><code class="mi">1</code> <code class="p">]</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">}</code>
<code class="p">]).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>Note the syntax for using <code>$arrayElemAt<a data-type="indexterm" data-primary="$arrayElemAt operator" data-primary-sortas="arrayElemAt operator" id="idm45882361629256"/></code> within a project stage. We define a field that we
    want projected out and as the value specify a document with <code>$arrayElemAt</code> as the field name and a two-element
    array as the value. The first element should be a field path that
    specifies the array field we want to select from. The second element
    identifies the slot within that array that we want. Remember that arrays
    are 0-indexed.</p><p>In many cases, the length of an array is not readily available. To
    select array slots starting from the end of the array, use negative
    integers. The last element in an array is identified with <code>-1</code>.</p><p>A simple output document for this aggregation pipeline would
    resemble the <span class="keep-together">following</span>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"vufind"</code><code class="p">,</code>
  <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">2010</code><code class="p">,</code>
  <code class="s2">"first_round"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"id"</code> <code class="o">:</code> <code class="mi">19876</code><code class="p">,</code>
    <code class="s2">"round_code"</code> <code class="o">:</code> <code class="s2">"angel"</code><code class="p">,</code>
    <code class="s2">"source_url"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">,</code>
    <code class="s2">"source_description"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">,</code>
    <code class="s2">"raised_amount"</code> <code class="o">:</code> <code class="mi">250000</code><code class="p">,</code>
    <code class="s2">"raised_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
    <code class="s2">"funded_year"</code> <code class="o">:</code> <code class="mi">2010</code><code class="p">,</code>
    <code class="s2">"funded_month"</code> <code class="o">:</code> <code class="mi">9</code><code class="p">,</code>
    <code class="s2">"funded_day"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
  <code class="p">},</code>
  <code class="s2">"last_round"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"id"</code> <code class="o">:</code> <code class="mi">57219</code><code class="p">,</code>
    <code class="s2">"round_code"</code> <code class="o">:</code> <code class="s2">"seed"</code><code class="p">,</code>
    <code class="s2">"source_url"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">,</code>
    <code class="s2">"source_description"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">,</code>
    <code class="s2">"raised_amount"</code> <code class="o">:</code> <code class="mi">500000</code><code class="p">,</code>
    <code class="s2">"raised_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
    <code class="s2">"funded_year"</code> <code class="o">:</code> <code class="mi">2012</code><code class="p">,</code>
    <code class="s2">"funded_month"</code> <code class="o">:</code> <code class="mi">7</code><code class="p">,</code>
    <code class="s2">"funded_day"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">]</code>
  <code class="p">}</code>
<code class="p">}</code></pre><p>Related to <code>$arrayElemAt</code> is the
    <code>$slice</code> expression<a data-type="indexterm" data-primary="$slice operator" data-primary-sortas="slice operator" id="idm45882361583464"/>. This allows us to return not just one but multiple items
    from an array in sequence, beginning with a particular index:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2010</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">founded_year</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">early_rounds</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$slice</code><code class="o">:</code> <code class="p">[</code> <code class="s2">"$funding_rounds"</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">3</code> <code class="p">]</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">}</code>
<code class="p">]).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>Here, again with the <code>funding_rounds</code> array, we begin at index 1 and
    take three elements from the array. Perhaps we know that in this dataset
    the first funding round isn’t all that interesting, or we simply want some
    early ones but not the very first one.</p><p>Filtering and selecting individual elements or slices of arrays are
    among the more common operations we need to perform on arrays. Probably
    the most common, however, is determining an array’s size or length. To do
    this we can use the <code>$size</code>
    operator:<a data-type="indexterm" data-primary="$size operator" data-primary-sortas="size operator" id="idm45882361224936"/></p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code><code class="o">:</code> <code class="mi">2004</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">founded_year</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">total_rounds</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$size</code><code class="o">:</code> <code class="s2">"$funding_rounds"</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">}</code>
<code class="p">]).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>When used in a project stage, a <code>$size</code> expression will simply provide a value
    that is the number of elements in the array.</p><p>In this section, we’ve explored some of the most common array
    expressions. There are many more, and the list grows with each release.
    Please review the <a href="https://oreil.ly/ZtUES">Aggregation
    Pipeline Quick Reference in the MongoDB documentation</a> for a
    summary of all expressions that are<a data-type="indexterm" data-startref="express07" id="idm45882361195336"/><a data-type="indexterm" data-startref="AFarray07" id="idm45882361194600"/><a data-type="indexterm" data-startref="arrayexproj07" id="idm45882361193768"/> available.</p></div></section><section data-type="sect1" data-pdf-bookmark="Accumulators"><div class="sect1" id="idm45882362102488"><h1>Accumulators</h1><p>At<a data-type="indexterm" data-primary="accumulators" data-secondary="purpose of" id="idm45882361192072"/><a data-type="indexterm" data-primary="aggregation framework" data-secondary="accumulators" id="idm45882361190936"/> this point, we’ve covered a few different types of
    expressions. Next, let’s look at what accumulators the aggregation
    framework has to offer. Accumulators are essentially another type of
    expression, but we think about them in their own class because they
    calculate values from field values found in multiple documents.</p><p>Accumulators the aggregation framework provides enable us to perform
    operations such as summing all values in a particular field (<code>$sum<a data-type="indexterm" data-primary="$sum operator" data-primary-sortas="sum operator" id="idm45882361188440"/></code>), calculating an average (<code>$avg<a data-type="indexterm" data-primary="$avg operator" data-primary-sortas="avg operator" id="idm45882361186920"/></code>), etc. We also consider <code>$first</code><a data-type="indexterm" data-primary="$first operator" data-primary-sortas="first operator" id="idm45882361185400"/> and <code>$last<a data-type="indexterm" data-primary="$last operator" data-primary-sortas="last operator" id="idm45882361183848"/></code> to be accumulators because these consider values
    in all documents that pass through the stage in which they are used.
    <code>$max</code><a data-type="indexterm" data-primary="$max operator" data-primary-sortas="max operator" id="idm45882361182184"/> and <code>$min<a data-type="indexterm" data-primary="$min operator" data-primary-sortas="min operator" id="idm45882361180632"/></code> are two more examples of accumulators that
    consider a stream of documents and save just one of the values they see.
    We can use <code>$mergeObjects</code><a data-type="indexterm" data-primary="$mergeObjects&#10;        operator" data-primary-sortas="mergeObjects operator" id="idm45882361178952"/> to combine<a data-type="indexterm" data-primary="documents" data-secondary="combining multiple into single" id="idm45882361177752"/> multiple documents into a single document.</p><p>We<a data-type="indexterm" data-primary="accumulators" data-secondary="for arrays" id="idm45882361176104"/> also have accumulators for arrays. We can <code>$push</code> <a data-type="indexterm" data-primary="$push operator" data-primary-sortas="push operator" id="idm45882361174360"/>values onto an array as documents pass through a pipeline
    stage. <code>$addToSet<a data-type="indexterm" data-primary="$addToSet operator" data-primary-sortas="addToSet operator" id="idm45882361172808"/></code> is very similar to <code>$push</code> except that it ensures no<a data-type="indexterm" data-primary="duplicates" data-secondary="preventing in arrays" id="idm45882361171128"/> duplicate values are included in the resulting
    array.</p><p>Then there are some expressions for calculating descriptive
    statistics⁠—for example, for calculating the standard deviation of a
    sample and of a population. Both work with a stream of documents that pass
    through a pipeline stage.</p><p>Prior to MongoDB 3.2, accumulators were available only in the group
    stage. MongoDB 3.2 introduced the ability to access a subset of
    accumulators within the project stage. The primary difference<a data-type="indexterm" data-primary="accumulators" data-secondary="in group versus project&#10;        stage" id="idm45882361169032"/> between the accumulators in the group stage and the project
    stage is that in the project stage accumulators such as <code>$sum</code> and <code>$avg</code>
    must operate on arrays within a single document, whereas accumulators in
    the group stage, as we’ll see in a later section, provide you with the
    ability to perform calculations on values across multiple
    documents.</p><p>That’s a quick overview of accumulators to provide some context and
    set the stage for our deep dive into examples.</p><section data-type="sect2" data-pdf-bookmark="Using Accumulators in Project Stages"><div class="sect2" id="idm45882361166136"><h2>Using Accumulators in Project Stages</h2><p>We’ll<a data-type="indexterm" data-primary="accumulators" data-secondary="using in project stage" id="idm45882361165192"/> begin with an example of using an accumulator in a
      project stage. Note that our match stage filters for documents that
      contain a <code>"funding_rounds"</code> field and
      for which the <code>funding_rounds</code> array is
      not empty:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"funding_rounds"</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$exists</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="nx">$ne</code><code class="o">:</code> <code class="p">[</code> <code class="p">]}</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">largest_round</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$max</code><code class="o">:</code> <code class="s2">"$funding_rounds.raised_amount"</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">}</code>
<code class="p">])</code></pre><p>Because the value for <code>$funding_rounds</code> is an array within each
      company document, we can use an accumulator. Remember that in project
      stages accumulators must work on an array-valued field. In this case,
      we’re able to do something pretty cool here. We are easily identifying
      the largest value in an array by reaching into an embedded document
      within that array and projecting the max value in the output
      documents:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Wetpaint"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">25000000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Digg"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">28700000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">1500000000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Omnidrive"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">800000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Geni"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">10000000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Twitter"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">400000000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"StumbleUpon"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">17000000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Gizmoz"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">6500000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Scribd"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">13000000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Slacker"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">40000000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Lala"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">20000000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"eBay"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">6700000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"MeetMoi"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">2575000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Joost"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">45000000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Babelgum"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">13200000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Plaxo"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">9000000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Cisco"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">2500000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Yahoo!"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">4800000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Powerset"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">12500000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Technorati"</code><code class="p">,</code> <code class="s2">"largest_round"</code> <code class="o">:</code> <code class="mi">10520000</code> <code class="p">}</code>
<code class="p">...</code></pre><p>As another example, let’s use the <code>$sum</code> accumulator to calculate the total
      funding for each company in our collection:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"funding_rounds"</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$exists</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="nx">$ne</code><code class="o">:</code> <code class="p">[</code> <code class="p">]}</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">total_funding</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$sum</code><code class="o">:</code> <code class="s2">"$funding_rounds.raised_amount"</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">}</code>
<code class="p">])</code></pre><p>This is just a taste of what you can do using accumulators in
      project stages. Again, you’re encouraged to review the <a href="https://oreil.ly/SZiFx">Aggregation
      Pipeline Quick Reference in the MongoDB docs</a> for a complete
      overview of the accumulator expressions available.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Introduction to Grouping"><div class="sect1" id="idm45882360665416"><h1>Introduction to Grouping</h1><p>Historically, accumulators<a data-type="indexterm" data-primary="aggregation framework" data-secondary="group stage" data-tertiary="aggregating values from multiple documents" id="idm45882360664136"/> were the province of the group stage in the MongoDB
    aggregation framework. The group stage performs a function that is similar
    to the SQL <code>GROUP BY</code> command. In a group
    stage, we can aggregate together values from multiple documents and
    perform some type of aggregation operation on them, such as calculating an
    average. Let’s take a look at an example:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$group</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="p">{</code> <code class="nx">founded_year</code><code class="o">:</code> <code class="s2">"$founded_year"</code> <code class="p">},</code>
    <code class="nx">average_number_of_employees</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$avg</code><code class="o">:</code> <code class="s2">"$number_of_employees"</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$sort</code><code class="o">:</code> <code class="p">{</code> <code class="nx">average_number_of_employees</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code> <code class="p">}</code> <code class="p">}</code>

<code class="p">])</code></pre><p>Here, we’re using a group stage to aggregate together all companies
    based on the year they were founded, then calculate the average number of
    employees for each year. The output for this pipeline resembles the
    <span class="keep-together">following</span>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1847</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">405000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1896</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">388000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1933</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">320000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1915</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">186000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1903</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">171000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1865</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">125000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1921</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">107000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1835</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">100000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1952</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">92900</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1946</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">91500</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1947</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mf">88510.5</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1898</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">80000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1968</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">73550</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1957</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">70055</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1969</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mf">67635.1</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1928</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">51000</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1963</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">50503</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1959</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mf">47432.5</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1902</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mf">41171.5</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">1887</code> <code class="p">},</code> <code class="s2">"average_number_of_employees"</code> <code class="o">:</code> <code class="mi">35000</code> <code class="p">}</code>
<code class="p">...</code></pre><p>The output includes documents that have a document as their <code>"_id"</code> value, and then a report on the average
    number of employees. This is the type of analysis we might do as a first
    step in assessing the correlation between the year in which a company was
    founded and its growth, possibly normalizing for how old the company
    is.</p><p>As<a data-type="indexterm" data-primary="aggregation framework" data-secondary="group stage" data-tertiary="group and sort stages" id="idm45882360747912"/> you can see, the pipeline we built has two stages: a group
    stage and a sort stage. Fundamental to the group stage is the <code>"_id"</code> field that we specify as part of the
    document. This is the value of the <code>$group</code> operator<a data-type="indexterm" data-primary="$group operator" data-primary-sortas="group operator" id="idm45882360745672"/> itself, using a very strict interpretation.</p><p>We use this field to define what the group stage uses to organize
    the documents that it sees. Since the group stage is first, the<a data-type="indexterm" data-primary="aggregation framework" data-secondary="group stage" data-tertiary="aggregate command" id="idm45882360286792"/> <code>aggregate</code> command will
    pass all documents in the <em>companies</em> collection
    through this stage. The group stage will take every document that has the
    same value for <code>"founded_year"</code> and treat
    them as a single group. In constructing the value for this field, this
    stage will use the <code>$avg</code> accumulator to
    calculate an average number of employees for all companies with the same
    <code>"founded_year"</code>.</p><p>You can think of it this way. Each time the group stage encounters a
    document with a specific founding year, it adds the value for <code>"number_of_employees"</code> from that document to a
    running sum of the number of employees and adds one to a count of the
    number of documents seen so far for that year. Once all documents have
    passed through the group stage, it can then calculate the average using
    that running sum and count for every grouping of documents it identified
    based on the year of founding.</p><p>At the end of this pipeline, we sort the documents into descending
    order by <span class="keep-together"><code>average_number_of_employees</code>.</span></p><p>Let’s look at another example. One field we’ve not yet considered in
    the <em>companies</em> dataset is the relationships. The
    <code>relationships</code> field appears in
    documents in the following form:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"52cdef7c4bab8bd675297d8e"</code><code class="p">,</code>
  <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Facebook"</code><code class="p">,</code>
  <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"facebook"</code><code class="p">,</code>
  <code class="s2">"category_code"</code> <code class="o">:</code> <code class="s2">"social"</code><code class="p">,</code>
  <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">2004</code><code class="p">,</code>
  <code class="p">...</code>
  <code class="s2">"relationships"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="p">{</code>
      <code class="s2">"is_past"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
      <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"Founder and CEO, Board Of Directors"</code><code class="p">,</code>
      <code class="s2">"person"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"first_name"</code> <code class="o">:</code> <code class="s2">"Mark"</code><code class="p">,</code>
        <code class="s2">"last_name"</code> <code class="o">:</code> <code class="s2">"Zuckerberg"</code><code class="p">,</code>
        <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"mark-zuckerberg"</code>
      <code class="p">}</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="s2">"is_past"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
      <code class="s2">"title"</code> <code class="o">:</code> <code class="s2">"CFO"</code><code class="p">,</code>
      <code class="s2">"person"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"first_name"</code> <code class="o">:</code> <code class="s2">"David"</code><code class="p">,</code>
        <code class="s2">"last_name"</code> <code class="o">:</code> <code class="s2">"Ebersman"</code><code class="p">,</code>
        <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"david-ebersman"</code>
      <code class="p">}</code>
    <code class="p">},</code>
    <code class="p">...</code>
  <code class="p">],</code>
  <code class="s2">"funding_rounds"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="p">...</code>
    <code class="p">{</code>
      <code class="s2">"id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code>
      <code class="s2">"round_code"</code> <code class="o">:</code> <code class="s2">"b"</code><code class="p">,</code>
      <code class="s2">"source_url"</code> <code class="o">:</code> <code class="s2">"http://www.facebook.com/press/info.php?factsheet"</code><code class="p">,</code>
      <code class="s2">"source_description"</code> <code class="o">:</code> <code class="s2">"Facebook Funding"</code><code class="p">,</code>
      <code class="s2">"raised_amount"</code> <code class="o">:</code> <code class="mi">27500000</code><code class="p">,</code>
      <code class="s2">"raised_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
      <code class="s2">"funded_year"</code> <code class="o">:</code> <code class="mi">2006</code><code class="p">,</code>
      <code class="s2">"funded_month"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code>
      <code class="s2">"funded_day"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
      <code class="s2">"investments"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Greylock Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"greylock"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Meritech Capital Partners"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"meritech-capital-partners"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"Founders Fund"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"founders-fund"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">},</code>
        <code class="p">{</code>
          <code class="s2">"company"</code> <code class="o">:</code> <code class="kc">null</code><code class="p">,</code>
          <code class="s2">"financial_org"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"SV Angel"</code><code class="p">,</code>
            <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"sv-angel"</code>
          <code class="p">},</code>
          <code class="s2">"person"</code> <code class="o">:</code> <code class="kc">null</code>
        <code class="p">}</code>
      <code class="p">]</code>
    <code class="p">},</code>
    <code class="p">...</code>
  <code class="s2">"ipo"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"valuation_amount"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"104000000000"</code><code class="p">),</code>
    <code class="s2">"valuation_currency_code"</code> <code class="o">:</code> <code class="s2">"USD"</code><code class="p">,</code>
    <code class="s2">"pub_year"</code> <code class="o">:</code> <code class="mi">2012</code><code class="p">,</code>
    <code class="s2">"pub_month"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
    <code class="s2">"pub_day"</code> <code class="o">:</code> <code class="mi">18</code><code class="p">,</code>
    <code class="s2">"stock_symbol"</code> <code class="o">:</code> <code class="s2">"NASDAQ:FB"</code>
  <code class="p">},</code>
  <code class="p">...</code>
<code class="p">}</code></pre><p>The <code>"relationships"</code> field gives
    us the ability to dive in and look for people who have, in one way or
    another, been associated with a relatively large number of companies.
    Let’s take a look at this aggregation:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">(</code> <code class="p">[</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"relationships.person"</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$ne</code><code class="o">:</code> <code class="kc">null</code> <code class="p">}</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code> <code class="nx">relationships</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$unwind</code><code class="o">:</code> <code class="s2">"$relationships"</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$group</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="s2">"$relationships.person"</code><code class="p">,</code>
    <code class="nx">count</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$sum</code><code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$sort</code><code class="o">:</code> <code class="p">{</code> <code class="nx">count</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code> <code class="p">}</code> <code class="p">}</code>
<code class="p">]).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>We’re matching on <code>relationships.person</code>. If we look at our Facebook
    example document, we can see how relationships are structured and get a
    sense for what it means to do this. We are filtering for all relationships
    for which <code>"person"</code> is not <code>null</code>. Then we project out all relationships for
    documents that match. We will pass only relationships to the next stage in
    the pipeline, which is unwind. We unwind the relationships so that every
    relationship in the array comes through to the group stage that follows.
    In the group stage, we use a field path to identify the person within each
    <code>"relationship"</code> document. All documents
    with the same <code>"person"</code> value will be
    grouped together. As we saw previously, it’s perfectly fine for a document
    to be the value around which we group. So, every match to a document for a
    first name, last name, and permalink for a person will be aggregated
    together. We use the <code>$sum</code> accumulator
    to count the number of relationships in which each person has
    participated. Finally, we sort into descending order. The output for this
    pipeline resembles the <span class="keep-together">following</span>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"first_name"</code> <code class="o">:</code> <code class="s2">"Tim"</code><code class="p">,</code>
    <code class="s2">"last_name"</code> <code class="o">:</code> <code class="s2">"Hanlon"</code><code class="p">,</code>
    <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"tim-hanlon"</code>
  <code class="p">},</code>
  <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">28</code>
<code class="p">}</code>
<code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"first_name"</code> <code class="o">:</code> <code class="s2">"Pejman"</code><code class="p">,</code>
    <code class="s2">"last_name"</code> <code class="o">:</code> <code class="s2">"Nozad"</code><code class="p">,</code>
    <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"pejman-nozad"</code>
  <code class="p">},</code>
  <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">24</code>
<code class="p">}</code>
<code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"first_name"</code> <code class="o">:</code> <code class="s2">"David S."</code><code class="p">,</code>
    <code class="s2">"last_name"</code> <code class="o">:</code> <code class="s2">"Rose"</code><code class="p">,</code>
    <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"david-s-rose"</code>
  <code class="p">},</code>
  <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">24</code>
<code class="p">}</code>
<code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"first_name"</code> <code class="o">:</code> <code class="s2">"Saul"</code><code class="p">,</code>
    <code class="s2">"last_name"</code> <code class="o">:</code> <code class="s2">"Klein"</code><code class="p">,</code>
    <code class="s2">"permalink"</code> <code class="o">:</code> <code class="s2">"saul-klein"</code>
  <code class="p">},</code>
  <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">24</code>
<code class="p">}</code>
<code class="p">...</code></pre><p>Tim Hanlon is the individual who has participated in the most
    relationships with companies in this collection. It could be that Mr.
    Hanlon has actually had a relationship with 28 companies, but we can’t
    know that for sure, because it’s also possible that he has had multiple
    relationships with one or more companies, each with a different title.
    This example illustrates a very important point about aggregation
    pipelines: make sure you fully understand what it is you’re working with
    as you do calculations, particularly when you’re calculating aggregate
    values using accumulator expressions of some kind.</p><p>In this case, we can say that Tim Hanlon appears 28 times in
    <code>"relationships"</code> documents throughout
    the companies in our collection. We would have to dig a little deeper to
    see exactly how many unique companies he was associated with, but we’ll
    leave the construction of that pipeline to you as an exercise.</p><section data-type="sect2" data-pdf-bookmark="The _id Field in Group Stages"><div class="sect2" id="idm45882359797032"><h2>The _id Field in Group Stages</h2><p>Before<a data-type="indexterm" data-primary="aggregation framework" data-secondary="group stage" data-tertiary="_id field" data-tertiary-sortas="id field" id="AFgroupidfield07"/><a data-type="indexterm" data-primary="_id field, in group&#10;          stages" data-primary-sortas="id field, in group stages" id="idm45882359632184"/> we go any further with our discussion of the group stage,
      let’s talk a little more about the <code>_id</code> field and look at some best practices for
      constructing values for this field in group aggregation stages. We’ll
      walk through a few examples that illustrate several different ways in
      which we commonly group documents. As our first example, consider this
      pipeline:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="nx">founded_year</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$gte</code><code class="o">:</code> <code class="mi">2013</code> <code class="p">}</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$group</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="p">{</code> <code class="nx">founded_year</code><code class="o">:</code> <code class="s2">"$founded_year"</code><code class="p">},</code>
    <code class="nx">companies</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$push</code><code class="o">:</code> <code class="s2">"$name"</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$sort</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"_id.founded_year"</code><code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code>
<code class="p">]).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>The output for this pipeline resembles the
      following:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"founded_year"</code> <code class="o">:</code> <code class="mi">2013</code>
  <code class="p">},</code>
  <code class="s2">"companies"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="s2">"Fixya"</code><code class="p">,</code>
    <code class="s2">"Wamba"</code><code class="p">,</code>
    <code class="s2">"Advaliant"</code><code class="p">,</code>
    <code class="s2">"Fluc"</code><code class="p">,</code>
    <code class="s2">"iBazar"</code><code class="p">,</code>
    <code class="s2">"Gimigo"</code><code class="p">,</code>
    <code class="s2">"SEOGroup"</code><code class="p">,</code>
    <code class="s2">"Clowdy"</code><code class="p">,</code>
    <code class="s2">"WhosCall"</code><code class="p">,</code>
    <code class="s2">"Pikk"</code><code class="p">,</code>
    <code class="s2">"Tongxue"</code><code class="p">,</code>
    <code class="s2">"Shopseen"</code><code class="p">,</code>
    <code class="s2">"VistaGen Therapeutics"</code>
  <code class="p">]</code>
<code class="p">}</code>
<code class="p">...</code></pre><p>In our output we have documents with two fields: <code>"_id"</code> and <code>"companies"</code>. Each of these documents contains
      a list of the companies founded in whatever the <code>"founded_year"</code> is, <code>"companies"</code> being an array of company
      names.</p><p>Notice here how we’ve constructed the <code>"_id"</code> field in the group stage. Why not just
      provide the founding year rather than putting it inside a document with
      a field labeled <code>"founded_year"</code>. The
      reason we don’t do it that way is that if we don’t label the group
      value, it’s not explicit that we are grouping on the year in which the
      company was founded. In order to avoid confusion, it is a best practice
      to explicitly label values on which we group.</p><p>In some circumstances it might be necessary to use another
      approach in which our <code>_id</code> value is a
      document composed of multiple fields. In this case, we’re actually
      grouping documents on the basis of their founding year and category
      code:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="nx">founded_year</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$gte</code><code class="o">:</code> <code class="mi">2010</code> <code class="p">}</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$group</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="p">{</code> <code class="nx">founded_year</code><code class="o">:</code> <code class="s2">"$founded_year"</code><code class="p">,</code> <code class="nx">category_code</code><code class="o">:</code> <code class="s2">"$category_code"</code> <code class="p">},</code>
    <code class="nx">companies</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$push</code><code class="o">:</code> <code class="s2">"$name"</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$sort</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"_id.founded_year"</code><code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code>
<code class="p">]).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>It is perfectly fine to use documents with multiple fields as our
      <code>_id</code> value in group stages. In other
      cases, it might also be necessary to do something like
      this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$group</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="p">{</code> <code class="nx">ipo_year</code><code class="o">:</code> <code class="s2">"$ipo.pub_year"</code> <code class="p">},</code>
    <code class="nx">companies</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$push</code><code class="o">:</code> <code class="s2">"$name"</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$sort</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"_id.ipo_year"</code><code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code>
<code class="p">]).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>In this case, we’re grouping documents based on the year in which
      the companies had their IPO, and that year is actually a field of an
      embedded document. It is common practice to use field paths that reach
      into embedded documents as the value on which to group in a group stage.
      In this case, the output will resemble the following:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"ipo_year"</code> <code class="o">:</code> <code class="mi">1999</code>
  <code class="p">},</code>
  <code class="s2">"companies"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="s2">"Akamai Technologies"</code><code class="p">,</code>
    <code class="s2">"TiVo"</code><code class="p">,</code>
    <code class="s2">"XO Group"</code><code class="p">,</code>
    <code class="s2">"Nvidia"</code><code class="p">,</code>
    <code class="s2">"Blackberry"</code><code class="p">,</code>
    <code class="s2">"Blue Coat Systems"</code><code class="p">,</code>
    <code class="s2">"Red Hat"</code><code class="p">,</code>
    <code class="s2">"Brocade Communications Systems"</code><code class="p">,</code>
    <code class="s2">"Juniper Networks"</code><code class="p">,</code>
    <code class="s2">"F5 Networks"</code><code class="p">,</code>
    <code class="s2">"Informatica"</code><code class="p">,</code>
    <code class="s2">"Iron Mountain"</code><code class="p">,</code>
    <code class="s2">"Perficient"</code><code class="p">,</code>
    <code class="s2">"Sitestar"</code><code class="p">,</code>
    <code class="s2">"Oxford Instruments"</code>
  <code class="p">]</code>
<code class="p">}</code></pre><p>Note that the examples in this section use an accumulator we
      haven’t seen before: <code>$push</code>. As the
      group stage processes documents in its input stream, a <code>$push</code> expression will add the resulting value
      to an array that it builds throughout its run. In the case of the
      preceding pipeline, the group stage is building an array composed of
      company names.</p><p>Our final example is one we’ve already seen, but it’s included
      here for the sake of completeness:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">(</code> <code class="p">[</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"relationships.person"</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$ne</code><code class="o">:</code> <code class="kc">null</code> <code class="p">}</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code> <code class="nx">relationships</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$unwind</code><code class="o">:</code> <code class="s2">"$relationships"</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$group</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="s2">"$relationships.person"</code><code class="p">,</code>
    <code class="nx">count</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$sum</code><code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$sort</code><code class="o">:</code> <code class="p">{</code> <code class="nx">count</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code> <code class="p">}</code> <code class="p">}</code>
<code class="p">]</code> <code class="p">)</code></pre><p>In the preceding example where we were grouping on IPO year, we
      used a field path that resolved to a scalar value—the IPO year. In this
      case, our field path resolves to a document containing three fields:
      <code>"first_name</code>“, <code>"last_name"</code>, and <code>"permalink"</code>. This demonstrates that the group
      stage supports grouping on document values.</p><p>You’ve now seen several ways in which we can construct <code>_id</code> values in group stages. In general, bear
      in mind that what we want to do here is make sure that in our output,
      the semantics of our <code>_id</code> value
      are<a data-type="indexterm" data-startref="AFgroupidfield07" id="idm45882359141192"/> clear.</p></div></section><section data-type="sect2" data-pdf-bookmark="Group Versus Project"><div class="sect2" id="idm45882359796728"><h2>Group Versus Project</h2><p>To<a data-type="indexterm" data-primary="aggregation framework" data-secondary="group stage" data-tertiary="versus project stage" data-tertiary-sortas="project stage" id="idm45882359139224"/> round out our discussion of the group aggregation stage,
      we’ll take a look at a couple of additional accumulators that are not
      available in the project stage. This is to encourage you to think a
      little more deeply about what we can do in a project stage with respect
      to<a data-type="indexterm" data-primary="accumulators" data-secondary="using in project stage" id="idm45882359137096"/> accumulators, and what we can do in group. As an example,
      consider this aggregation query:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="nx">funding_rounds</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$ne</code><code class="o">:</code> <code class="p">[</code> <code class="p">]</code> <code class="p">}</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$unwind</code><code class="o">:</code> <code class="s2">"$funding_rounds"</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$sort</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"funding_rounds.funded_year"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"funding_rounds.funded_month"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"funding_rounds.funded_day"</code><code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$group</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="p">{</code> <code class="nx">company</code><code class="o">:</code> <code class="s2">"$name"</code> <code class="p">},</code>
    <code class="nx">funding</code><code class="o">:</code> <code class="p">{</code>
      <code class="nx">$push</code><code class="o">:</code> <code class="p">{</code>
        <code class="nx">amount</code><code class="o">:</code> <code class="s2">"$funding_rounds.raised_amount"</code><code class="p">,</code>
        <code class="nx">year</code><code class="o">:</code> <code class="s2">"$funding_rounds.funded_year"</code>
      <code class="p">}</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">},</code>
<code class="p">]</code> <code class="p">).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>Here, we begin by filtering for documents for which the array
      <code>funding_rounds</code> is not empty. Then we
      unwind <code>funding_rounds</code>. Therefore, the
      sort and group stages will see one document for each element of the
      <code>funding_rounds</code> array for every
      company.</p><p>Our sort stage in this pipeline sorts on first year, then month,
      then day, all in ascending order. This means that this stage will output
      the oldest funding rounds first. And as you are aware from <a data-type="xref" href="ch05.xhtml#chapter_d1e5128">Chapter 5</a>, we can support this type of sort with a
      compound index.</p><p>In the group stage that follows the sort, we group by company name
      and use the<a data-type="indexterm" data-primary="$push operator" data-primary-sortas="push operator" id="idm45882359025592"/> <code>$push</code> accumulator to
      construct a sorted array of funding rounds. The <code>funding_rounds</code> array will be sorted for each
      company because we sorted all funding rounds, globally, in the sort
      stage.</p><p>Documents output from this pipeline will resemble the
      following:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"company"</code> <code class="o">:</code> <code class="s2">"Green Apple Media"</code>
  <code class="p">},</code>
  <code class="s2">"funding"</code> <code class="o">:</code> <code class="p">[</code>
    <code class="p">{</code>
      <code class="s2">"amount"</code> <code class="o">:</code> <code class="mi">30000000</code><code class="p">,</code>
      <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">2013</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="s2">"amount"</code> <code class="o">:</code> <code class="mi">100000000</code><code class="p">,</code>
      <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">2013</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="s2">"amount"</code> <code class="o">:</code> <code class="mi">2000000</code><code class="p">,</code>
      <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">2013</code>
    <code class="p">}</code>
  <code class="p">]</code>
<code class="p">}</code></pre><p>In this pipeline, with <code>$push</code>,
      we are accumulating an array. In this case, we have specified our
      <code>$push</code> expression so that it adds
      documents to the end of the accumulation array. Since the funding rounds
      are in chronological order, pushing onto the end of the array guarantees
      that the the funding amounts for each company are sorted in
      chronological order.</p><p><code>$push</code> expressions only work in
      group stages. This is because group stages are designed to take an input
      stream of documents and accumulate values by processing each document in
      turn. Project stages, on the other hand, work with each document in
      their input stream individually.</p><p>Let’s take a look at one other example. This is a little longer,
      but it builds on the previous one:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">db</code><code class="p">.</code><code class="nx">companies</code><code class="p">.</code><code class="nx">aggregate</code><code class="p">([</code>
  <code class="p">{</code> <code class="nx">$match</code><code class="o">:</code> <code class="p">{</code> <code class="nx">funding_rounds</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$exists</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code> <code class="nx">$ne</code><code class="o">:</code> <code class="p">[</code> <code class="p">]</code> <code class="p">}</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$unwind</code><code class="o">:</code> <code class="s2">"$funding_rounds"</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$sort</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"funding_rounds.funded_year"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"funding_rounds.funded_month"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"funding_rounds.funded_day"</code><code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$group</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="p">{</code> <code class="nx">company</code><code class="o">:</code> <code class="s2">"$name"</code> <code class="p">},</code>
    <code class="nx">first_round</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$first</code><code class="o">:</code> <code class="s2">"$funding_rounds"</code> <code class="p">},</code>
    <code class="nx">last_round</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$last</code><code class="o">:</code> <code class="s2">"$funding_rounds"</code> <code class="p">},</code>
    <code class="nx">num_rounds</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$sum</code><code class="o">:</code> <code class="mi">1</code> <code class="p">},</code>
    <code class="nx">total_raised</code><code class="o">:</code> <code class="p">{</code> <code class="nx">$sum</code><code class="o">:</code> <code class="s2">"$funding_rounds.raised_amount"</code> <code class="p">}</code>
  <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$project</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">company</code><code class="o">:</code> <code class="s2">"$_id.company"</code><code class="p">,</code>
    <code class="nx">first_round</code><code class="o">:</code> <code class="p">{</code>
      <code class="nx">amount</code><code class="o">:</code> <code class="s2">"$first_round.raised_amount"</code><code class="p">,</code>
      <code class="nx">article</code><code class="o">:</code> <code class="s2">"$first_round.source_url"</code><code class="p">,</code>
      <code class="nx">year</code><code class="o">:</code> <code class="s2">"$first_round.funded_year"</code>
    <code class="p">},</code>
    <code class="nx">last_round</code><code class="o">:</code> <code class="p">{</code>
      <code class="nx">amount</code><code class="o">:</code> <code class="s2">"$last_round.raised_amount"</code><code class="p">,</code>
      <code class="nx">article</code><code class="o">:</code> <code class="s2">"$last_round.source_url"</code><code class="p">,</code>
      <code class="nx">year</code><code class="o">:</code> <code class="s2">"$last_round.funded_year"</code>
    <code class="p">},</code>
    <code class="nx">num_rounds</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">total_raised</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
  <code class="p">}</code> <code class="p">},</code>
  <code class="p">{</code> <code class="nx">$sort</code><code class="o">:</code> <code class="p">{</code> <code class="nx">total_raised</code><code class="o">:</code> <code class="o">-</code><code class="mi">1</code> <code class="p">}</code> <code class="p">}</code>
<code class="p">]</code> <code class="p">).</code><code class="nx">pretty</code><code class="p">()</code></pre><p>Again, we are unwinding <code>funding_rounds</code> and sorting chronologically.
      However, in this case, instead of accumulating an array of entries, each
      entry representing a single <code>funding_rounds</code>, we are using two accumulators
      we’ve not yet seen in action: <code>$first<a data-type="indexterm" data-primary="$last operator" data-primary-sortas="last operator" id="idm45882358996072"/><a data-type="indexterm" data-primary="$first operator" data-primary-sortas="first operator" id="idm45882358707224"/></code> and <code>$last</code>. A
      <code>$first</code> expression simply saves the
      first value that passes through the input stream for the stage. A
      <code>$last</code> expression simply tracks the
      values that pass through the group stage and hangs onto the last
      one.</p><p>As with <code>$push</code>, we can’t use
      <code>$first</code> and <code>$last</code> in project stages because, again,
      project stages are not designed to accumulate values based on multiple
      documents streaming through them. Rather, they are designed to reshape
      documents individually.</p><p>In addition to <code>$first</code> and
      <code>$last</code>, we also use <code>$sum</code> in this example to calculate the total
      number of funding rounds. For this expression we can just specify the
      value, <code>1</code>. A <code>$sum</code> expression like this simply serves to
      count the number of documents that it sees in each grouping.</p><p>Finally, this pipeline includes a fairly complex project stage.
      However, all it is really doing is making the output prettier. Rather
      than show the <code>first_round</code> values, or
      entire documents for the first and last funding rounds, this project
      stage creates a summary. Note that this maintains good semantics,
      because each value is clearly labeled. For <code>first_round</code> we’ll produce a simple embedded
      document that contains just the essential details of amount, article,
      and year, pulling those values from the original funding round document
      that will be the value of <code>$first_round</code>. The project stage does something
      similar for <code>$last_round</code>. Finally,
      this project stage just passes through to output documents the <code>num_rounds</code> and <code>total_raised</code> values for documents it receives
      in its input stream.</p><p>Documents output from this pipeline resemble the
      following:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
  <code class="s2">"first_round"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"amount"</code> <code class="o">:</code> <code class="mi">7500000</code><code class="p">,</code>
    <code class="s2">"article"</code> <code class="o">:</code> <code class="s2">"http://www.teslamotors.com/display_data/pressguild.swf"</code><code class="p">,</code>
    <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">2004</code>
  <code class="p">},</code>
  <code class="s2">"last_round"</code> <code class="o">:</code> <code class="p">{</code>
    <code class="s2">"amount"</code> <code class="o">:</code> <code class="mi">10000000</code><code class="p">,</code>
    <code class="s2">"article"</code> <code class="o">:</code> <code class="s2">"http://www.bizjournals.com/sanfrancisco/news/2012/10/10/</code>
<code class="s2">                 tesla-motors-to-get-10-million-from.html"</code><code class="p">,</code>
    <code class="s2">"year"</code> <code class="o">:</code> <code class="mi">2012</code>
  <code class="p">},</code>
  <code class="s2">"num_rounds"</code> <code class="o">:</code> <code class="mi">11</code><code class="p">,</code>
  <code class="s2">"total_raised"</code> <code class="o">:</code> <code class="mi">823000000</code><code class="p">,</code>
  <code class="s2">"company"</code> <code class="o">:</code> <code class="s2">"Tesla Motors"</code>
<code class="p">}</code></pre><p>And with that, we’ve concluded an overview of the group
      stage.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Writing Aggregation Pipeline Results to a Collection"><div class="sect1" id="idm45882359140136"><h1>Writing Aggregation Pipeline Results to a Collection</h1><p>There<a data-type="indexterm" data-primary="collections" data-secondary="writing aggregation pipeline results to" id="idm45882358694136"/><a data-type="indexterm" data-primary="aggregation framework" data-secondary="writing pipeline results to collections" id="idm45882358648088"/> are two specific stages, <code>$out<a data-type="indexterm" data-primary="$out operator" data-primary-sortas="out operator" id="idm45882358646664"/></code> and <code>$merge<a data-type="indexterm" data-primary="$merge operator" data-primary-sortas="merge operator" id="idm45882358645112"/></code>, that can write documents resulting from the
    aggregation pipeline to a collection. You can use only one of these two
    stages, and it must be the last stage of an aggregation pipeline. <code>$merge</code> was introduced in MongoDB version 4.2 and
    is the preferred stage for writing to a collection, if available. <code>$out</code> has some limitations: it can only write to
    the same database, it overwrites any existing collection if present, and
    it cannot write to a sharded collection. <code>$merge</code> can write to any database and collection,
    sharded or not. <code>$merge</code> can also
    incorporate results (insert new documents, merge with existing documents,
    fail the operation, keep existing documents, or process all documents with
    a custom update) when working with an existing collection. But the real
    advantage of using <code>$merge</code> is that it
    can create on-demand materialized views, where the content of the output
    collection is incrementally updated when the pipeline is run.</p><p>In this chapter, we have covered a number of different accumulators,
    some that are available in the project stage, and we’ve also covered how
    to think about when to use group versus project when considering various
    accumulators. Next, we’ll take a look at transactions in MongoDB.</p></div></section></div></section></div>



  </body></html>