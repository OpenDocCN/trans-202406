<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 17. Sharding Administration"><div class="chapter" id="chapter-sharding-admin"><h1><span class="label">Chapter 17. </span>Sharding Administration</h1><p>As with replica sets, you have a number of options for administering
  sharded clusters. Manual administration is one option. These days it is
  becoming increasingly common to use tools such as Ops Manager and Cloud
  Manager and the Atlas Database-as-a-Service (DBaaS) offering for all cluster
  administration. In this chapter, we will demonstrate how to administer a
  sharded cluster manually, including:</p><ul><li><p>Inspecting the cluster’s state: who its members are, where data is
      held, and what connections are open</p></li><li><p>Adding, removing, and changing members of a cluster</p></li><li><p>Administering data movement and manually moving data</p></li></ul><section data-type="sect1" data-pdf-bookmark="Seeing the Current State"><div class="sect1" id="sect1_zzz_0005"><h1>Seeing the Current State</h1><p>There<a data-type="indexterm" data-primary="administration, of sharding" data-secondary="seeing current state" id="AScurrent17"/> are several helpers available to find out what data is
    where, what the shards are, and what the cluster is doing.</p><section data-type="sect2" data-pdf-bookmark="Getting a Summary with sh.status()"><div class="sect2" id="idm45882343615640"><h2>Getting a Summary with sh.status()</h2><p><code class="function">sh.status()</code> gives<a data-type="indexterm" data-primary="chunks" data-secondary="status overview" id="idm45882343614136"/><a data-type="indexterm" data-primary="sh.status()" id="idm45882343613000"/><a data-type="indexterm" data-primary="sharding, administration of" data-secondary="seeing current state" data-tertiary="status overview" id="idm45882343612168"/> you an overview of your shards, databases, and sharded
      collections. If you have a small number of chunks, it will print a
      breakdown of which chunks are where as well. Otherwise it will simply
      give the collection’s shard key and report how many chunks each shard
      has:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">status</code><code class="p">()</code>
<code class="o">---</code> <code class="nx">Sharding</code> <code class="nx">Status</code> <code class="o">---</code> 
<code class="nx">sharding</code> <code class="nx">version</code><code class="o">:</code> <code class="p">{</code>
  <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
  <code class="s2">"minCompatibleVersion"</code> <code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
  <code class="s2">"currentVersion"</code> <code class="o">:</code> <code class="mi">6</code><code class="p">,</code>
  <code class="s2">"clusterId"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5bdf51ecf8c192ed922f3160"</code><code class="p">)</code>
<code class="p">}</code>
<code class="nx">shards</code><code class="o">:</code>
  <code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"shard01"</code><code class="p">,</code>  
     <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"shard01/localhost:27018,localhost:27019,localhost:27020"</code><code class="p">,</code>  
     <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
  <code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"shard02"</code><code class="p">,</code>  
     <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"shard02/localhost:27021,localhost:27022,localhost:27023"</code><code class="p">,</code>  
     <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
  <code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"shard03"</code><code class="p">,</code>  
     <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"shard03/localhost:27024,localhost:27025,localhost:27026"</code><code class="p">,</code>  
     <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="nx">active</code> <code class="nx">mongoses</code><code class="o">:</code>
  <code class="s2">"4.0.3"</code> <code class="o">:</code> <code class="mi">1</code>
<code class="nx">autosplit</code><code class="o">:</code>
  <code class="nx">Currently</code> <code class="nx">enabled</code><code class="o">:</code> <code class="nx">yes</code>
<code class="nx">balancer</code><code class="o">:</code>
  <code class="nx">Currently</code> <code class="nx">enabled</code><code class="o">:</code>  <code class="nx">yes</code>
  <code class="nx">Currently</code> <code class="nx">running</code><code class="o">:</code>  <code class="nx">no</code>
  <code class="nx">Failed</code> <code class="nx">balancer</code> <code class="nx">rounds</code> <code class="k">in</code> <code class="nx">last</code> <code class="mi">5</code> <code class="nx">attempts</code><code class="o">:</code>  <code class="mi">0</code>
  <code class="nx">Migration</code> <code class="nx">Results</code> <code class="k">for</code> <code class="nx">the</code> <code class="nx">last</code> <code class="mi">24</code> <code class="nx">hours</code><code class="o">:</code> 
    <code class="mi">6</code> <code class="o">:</code> <code class="nx">Success</code>
  <code class="nx">databases</code><code class="o">:</code>
    <code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"config"</code><code class="p">,</code>  <code class="s2">"primary"</code> <code class="o">:</code> <code class="s2">"config"</code><code class="p">,</code>  <code class="s2">"partitioned"</code> <code class="o">:</code> <code class="kc">true</code> <code class="p">}</code>
      <code class="nx">config</code><code class="p">.</code><code class="nx">system</code><code class="p">.</code><code class="nx">sessions</code>
        <code class="nx">shard</code> <code class="nx">key</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
        <code class="nx">unique</code><code class="o">:</code> <code class="kc">false</code>
        <code class="nx">balancing</code><code class="o">:</code> <code class="kc">true</code>
        <code class="nx">chunks</code><code class="o">:</code>
          <code class="nx">shard01</code>	<code class="mi">1</code>
          <code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$minKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
          <code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$maxKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">shard01</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
    <code class="p">{</code>  <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"video"</code><code class="p">,</code>  <code class="s2">"primary"</code> <code class="o">:</code> <code class="s2">"shard02"</code><code class="p">,</code>  <code class="s2">"partitioned"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
       <code class="s2">"version"</code> <code class="o">:</code> 
          <code class="p">{</code>  <code class="s2">"uuid"</code> <code class="o">:</code> <code class="nx">UUID</code><code class="p">(</code><code class="s2">"3d83d8b8-9260-4a6f-8d28-c3732d40d961"</code><code class="p">),</code>  
             <code class="s2">"lastMod"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code>
       <code class="nx">video</code><code class="p">.</code><code class="nx">movies</code>
         <code class="nx">shard</code> <code class="nx">key</code><code class="o">:</code> <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="s2">"hashed"</code> <code class="p">}</code>
         <code class="nx">unique</code><code class="o">:</code> <code class="kc">false</code>
         <code class="nx">balancing</code><code class="o">:</code> <code class="kc">true</code>
         <code class="nx">chunks</code><code class="o">:</code>
           <code class="nx">shard01</code> <code class="mi">3</code>
           <code class="nx">shard02</code> <code class="mi">4</code>
           <code class="nx">shard03</code> <code class="mi">3</code>
           <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$minKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
               <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-7262221363006655132"</code><code class="p">)</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> 
               <code class="nx">shard01</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
           <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-7262221363006655132"</code><code class="p">)</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
               <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-5315530662268120007"</code><code class="p">)</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> 
               <code class="nx">shard03</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
           <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-5315530662268120007"</code><code class="p">)</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
               <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-3362204802044524341"</code><code class="p">)</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> 
               <code class="nx">shard03</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
           <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-3362204802044524341"</code><code class="p">)</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
               <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-1412311662519947087"</code><code class="p">)</code> <code class="p">}</code> 
               <code class="nx">on</code> <code class="o">:</code> <code class="nx">shard01</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
           <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-1412311662519947087"</code><code class="p">)</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
               <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"524277486033652998"</code><code class="p">)</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> 
               <code class="nx">shard01</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">6</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
           <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"524277486033652998"</code><code class="p">)</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
               <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"2484315172280977547"</code><code class="p">)</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> 
               <code class="nx">shard03</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">7</code><code class="p">,</code> <code class="mi">0</code><code class="p">)</code> 
           <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"2484315172280977547"</code><code class="p">)</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
               <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"4436141279217488250"</code><code class="p">)</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> 
               <code class="nx">shard02</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">7</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code> 
           <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"4436141279217488250"</code><code class="p">)</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
               <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"6386258634539951337"</code><code class="p">)</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> 
               <code class="nx">shard02</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">7</code><code class="p">)</code> 
           <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"6386258634539951337"</code><code class="p">)</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
               <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"8345072417171006784"</code><code class="p">)</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> 
               <code class="nx">shard02</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">8</code><code class="p">)</code> 
           <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"8345072417171006784"</code><code class="p">)</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> 
               <code class="p">{</code> <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$maxKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> 
               <code class="nx">shard02</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">9</code><code class="p">)</code></pre><p>Once there are more than a few chunks, <code class="function">sh.status()</code> will summarize the chunk stats
      instead of printing each chunk. To<a data-type="indexterm" data-primary="chunks" data-secondary="seeing all" id="idm45882343405368"/> see all chunks, run <code class="function">sh.status(true)<a data-type="indexterm" data-primary="sh.status(true)" id="idm45882343403640"/></code> (the <code>true</code>
      tells <code class="function">sh.status()</code> to be
      verbose).</p><p>All the information <code class="function">sh.status()</code> shows is gathered from your
      <em class="filename">config</em> database.</p></div></section><section data-type="sect2" data-pdf-bookmark="Seeing Configuration Information"><div class="sect2" id="idm45882343399928"><h2>Seeing Configuration Information</h2><p>All<a data-type="indexterm" data-primary="sharding, administration of" data-secondary="seeing current state" data-tertiary="configuration information" id="SAOcurconfig17"/> of the configuration information about your cluster is
      kept in collections in the<a data-type="indexterm" data-primary="config database" data-secondary="seeing configuration information" data-tertiary="connecting to mongos process" id="idm45882343396696"/> <em class="filename">config</em> database on
      the config servers. The shell has several helpers for exposing this
      information in a more readable way. However, you can always directly
      query the <em class="filename">config</em> database for
      metadata about your cluster.</p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>Never connect directly to your config servers, as you do not
        want to take the chance of accidentally changing or removing config
        server data. Instead, connect to the <em class="filename">mongos</em> process and use the <em class="filename">config</em> database to see its data, as you
        would for any other database:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">use</code> <code class="nx">config</code></pre><p>If you manipulate config data through <em class="filename">mongos</em> (instead of connecting directly to
        the config servers), <em class="filename">mongos</em> will
        ensure that all of your config servers stay in sync and prevent
        various dangerous actions like accidentally dropping the <em class="filename">config</em> database.</p></div><p>In general, you should not directly change any data in the
      <em class="filename">config</em> database (exceptions are
      noted in the following sections). If you change anything, you will
      generally have to restart all of your <em class="filename">mongos</em> servers to see its effect.</p><p>There are several collections in the <em class="filename">config</em> database. This section covers what
      each one contains and how it can be used.</p><section data-type="sect3" data-pdf-bookmark="config.shards"><div class="sect3" id="idm45882343062920"><h3>config.shards</h3><p>The<a data-type="indexterm" data-primary="config database" data-secondary="seeing configuration information" data-tertiary="config.shards" id="idm45882343061944"/> <em class="filename">shards</em> collection
        keeps track of all the shards in the cluster. A typical document in
        the <em class="filename">shards</em> collection might look
        something like this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">shards</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"shard01"</code><code class="p">,</code> 
  <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"shard01/localhost:27018,localhost:27019,localhost:27020"</code><code class="p">,</code> 
  <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"shard02"</code><code class="p">,</code> 
  <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"shard02/localhost:27021,localhost:27022,localhost:27023"</code><code class="p">,</code> 
  <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"shard03"</code><code class="p">,</code> 
  <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"shard03/localhost:27024,localhost:27025,localhost:27026"</code><code class="p">,</code> 
  <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code></pre><p>The shard’s <code>"_id"</code> is picked
        up from the replica set name, so each replica set in your cluster must
        have a unique name.</p><p>When you update your replica set configuration (e.g., adding or
        removing members), the <code>"host"</code> field
        will be updated automatically.</p></div></section><section data-type="sect3" data-pdf-bookmark="config.databases"><div class="sect3" id="idm45882342989688"><h3>config.databases</h3><p>The<a data-type="indexterm" data-primary="config database" data-secondary="seeing configuration information" data-tertiary="config.databases" id="idm45882342988808"/> <em class="filename">databases</em>
        collection keeps track of all of the databases, sharded and not, that
        the cluster knows about:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">databases</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"video"</code><code class="p">,</code> <code class="s2">"primary"</code> <code class="o">:</code> <code class="s2">"shard02"</code><code class="p">,</code> <code class="s2">"partitioned"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code> 
  <code class="s2">"version"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"uuid"</code> <code class="o">:</code> <code class="nx">UUID</code><code class="p">(</code><code class="s2">"3d83d8b8-9260-4a6f-8d28-c3732d40d961"</code><code class="p">),</code> 
  <code class="s2">"lastMod"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code> <code class="p">}</code></pre><p>If <code>enableSharding</code> has been
        run on a database, <code>"partitioned"</code>
        will be <code>true</code>. The <code>"primary"</code> is the database’s “home base.” By
        default, all new collections in that database will be created on the
        database’s primary shard.</p></div></section><section data-type="sect3" data-pdf-bookmark="config.collections"><div class="sect3" id="idm45882342903304"><h3>config.collections</h3><p>The<a data-type="indexterm" data-primary="config database" data-secondary="seeing configuration information" data-tertiary="config.collections" id="idm45882342902472"/> <em class="filename">collections</em>
        collection keeps track of all sharded collections (nonsharded
        collections are not shown). A typical document looks something like
        this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">collections</code><code class="p">.</code><code class="nx">find</code><code class="p">().</code><code class="nx">pretty</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"config.system.sessions"</code><code class="p">,</code>
    <code class="s2">"lastmodEpoch"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5bdf53122ad9c6907510c22d"</code><code class="p">),</code>
    <code class="s2">"lastmod"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"1970-02-19T17:02:47.296Z"</code><code class="p">),</code>
    <code class="s2">"dropped"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"key"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code>
    <code class="p">},</code>
    <code class="s2">"unique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"uuid"</code> <code class="o">:</code> <code class="nx">UUID</code><code class="p">(</code><code class="s2">"7584e4cd-fac4-4305-a9d4-bd73e93621bf"</code><code class="p">)</code>
<code class="p">}</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"video.movies"</code><code class="p">,</code>
    <code class="s2">"lastmodEpoch"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5bdf72c021b6e3be02fabe0c"</code><code class="p">),</code>
    <code class="s2">"lastmod"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"1970-02-19T17:02:47.305Z"</code><code class="p">),</code>
    <code class="s2">"dropped"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"key"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="s2">"hashed"</code>
    <code class="p">},</code>
    <code class="s2">"unique"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"uuid"</code> <code class="o">:</code> <code class="nx">UUID</code><code class="p">(</code><code class="s2">"e6580ffa-fcd3-418f-aa1a-0dfb71bc1c41"</code><code class="p">)</code>
<code class="p">}</code></pre><p>The important fields are:</p><dl><dt><code>"_id"</code></dt><dd><p>The namespace of the collection.</p></dd><dt><code>"key"</code></dt><dd><p>The shard key. In this case, it is a hashed shard key on
              <code>"imdbId"</code>.</p></dd><dt><code>"unique"</code></dt><dd><p>Indicates that the shard key is not a unique index. By
              default, the shard key is not unique.</p></dd></dl></div></section><section data-type="sect3" data-pdf-bookmark="config.chunks"><div class="sect3" id="idm45882342634392"><h3>config.chunks</h3><p>The<a data-type="indexterm" data-primary="config database" data-secondary="seeing configuration information" data-tertiary="config.chunks" id="idm45882342633512"/> <em class="filename">chunks</em> collection
        keeps a record of each chunk in all the collections. A typical
        document in the <em class="filename">chunks</em> collection
        looks something like this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">chunks</code><code class="p">.</code><code class="nx">find</code><code class="p">().</code><code class="nx">skip</code><code class="p">(</code><code class="mi">1</code><code class="p">).</code><code class="nx">limit</code><code class="p">(</code><code class="mi">1</code><code class="p">).</code><code class="nx">pretty</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"video.movies-imdbId_MinKey"</code><code class="p">,</code>
    <code class="s2">"lastmod"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">0</code><code class="p">),</code>
    <code class="s2">"lastmodEpoch"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5bdf72c021b6e3be02fabe0c"</code><code class="p">),</code>
    <code class="s2">"ns"</code> <code class="o">:</code> <code class="s2">"video.movies"</code><code class="p">,</code>
    <code class="s2">"min"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$minKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"max"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-7262221363006655132"</code><code class="p">)</code>
    <code class="p">},</code>
    <code class="s2">"shard"</code> <code class="o">:</code> <code class="s2">"shard01"</code><code class="p">,</code>
    <code class="s2">"history"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
            <code class="s2">"validAfter"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541370579</code><code class="p">,</code> <code class="mi">3096</code><code class="p">),</code>
            <code class="s2">"shard"</code> <code class="o">:</code> <code class="s2">"shard01"</code>
        <code class="p">}</code>
    <code class="p">]</code>
<code class="p">}</code></pre><p>The most useful fields are:</p><dl><dt><code>"_id"</code></dt><dd><p>The unique identifier for the chunk. Generally this is the
              namespace, shard key, and lower chunk boundary.</p></dd><dt><code>"ns"</code></dt><dd><p>The collection that this chunk is from.</p></dd><dt><code>"min"</code></dt><dd><p>The smallest value in the chunk’s range
              (inclusive).</p></dd><dt><code>"max"</code></dt><dd><p>All values in the chunk are smaller than this
              value.</p></dd><dt><code>"shard"</code></dt><dd><p>Which shard the chunk resides on.</p></dd></dl><p>The <code>"lastmod"</code> field tracks
        chunk versioning. For example, if the chunk <code>"video.movies-imdbId_MinKey"</code> were split into
        two chunks, we’d want a way of distinguishing the new, smaller
        <code>"video.movies-imdbId_MinKey"</code> chunks
        from their previous incarnation as a single chunk. Thus, the first
        component of the <code>Timestamp</code> value
        reflects the number of times a chunk has been migrated to a new shard.
        The second component of this value reflects the number of splits. The
        <code>"lastmodEpoch"</code> field specifies the
        collection’s creation epoch. It is used to differentiate requests for
        the same collection name in the cases where the collection was dropped
        and immediately recreated.</p><p><code class="function">sh.status()</code> uses the
        <em class="filename">config.chunks</em> collection to
        gather most of its information.</p></div></section><section data-type="sect3" data-pdf-bookmark="config.changelog"><div class="sect3" id="idm45882342393080"><h3>config.changelog</h3><p>The<a data-type="indexterm" data-primary="config database" data-secondary="seeing configuration information" data-tertiary="config.changelog" id="idm45882342391960"/><a data-type="indexterm" data-primary="changelog collecion" id="changelog17"/> <em class="filename">changelog</em>
        collection is useful for keeping track of what a cluster is doing,
        since it records all of the splits and migrations that have
        occurred.</p><p>Splits are recorded in a document that looks like this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">changelog</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">what</code><code class="o">:</code> <code class="s2">"split"</code><code class="p">}).</code><code class="nx">pretty</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"router1-2018-11-05T09:58:58.915-0500-5be05ab2f8c192ed922ffbe7"</code><code class="p">,</code>
    <code class="s2">"server"</code> <code class="o">:</code> <code class="s2">"bob"</code><code class="p">,</code>
    <code class="s2">"clientAddr"</code> <code class="o">:</code> <code class="s2">"127.0.0.1:64621"</code><code class="p">,</code>
    <code class="s2">"time"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2018-11-05T14:58:58.915Z"</code><code class="p">),</code>
    <code class="s2">"what"</code> <code class="o">:</code> <code class="s2">"split"</code><code class="p">,</code>
    <code class="s2">"ns"</code> <code class="o">:</code> <code class="s2">"video.movies"</code><code class="p">,</code>
    <code class="s2">"details"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"before"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"min"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"2484315172280977547"</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"max"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"4436141279217488250"</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"lastmod"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">9</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"lastmodEpoch"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5bdf72c021b6e3be02fabe0c"</code><code class="p">)</code>
        <code class="p">},</code>
        <code class="s2">"left"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"min"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"2484315172280977547"</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"max"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"3459137475094092005"</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"lastmod"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">9</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code>
            <code class="s2">"lastmodEpoch"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5bdf72c021b6e3be02fabe0c"</code><code class="p">)</code>
        <code class="p">},</code>
        <code class="s2">"right"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"min"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"3459137475094092005"</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"max"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"4436141279217488250"</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"lastmod"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">9</code><code class="p">,</code> <code class="mi">3</code><code class="p">),</code>
            <code class="s2">"lastmodEpoch"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5bdf72c021b6e3be02fabe0c"</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>The <code>"details"</code> field gives
        information about what the original document looked like and what it
        was split into.</p><p>This output shows what the first chunk split of a collection
        looks like. Note that the second component of <code>"lastmod"</code> for each new chunk was updated so
        that the values are <code>Timestamp(9, 2)</code>
        and <code>Timestamp(9, 3)</code>,
        respectively.</p><p>Migrations are a bit more complicated and actually create four
        separate changelog documents: one noting the start of the migrate, one
        for the “from” shard, one for the “to” shard, and one for the commit
        that occurs when the migration is finalized. The middle two documents
        are of interest because these give a breakdown of how long each step
        in the process took. This can give you an idea of whether it’s the
        disk, network, or something else that is causing a bottleneck on
        migrates.</p><p>For example, the document created by the “from” shard looks like
        this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">changelog</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code><code class="nx">what</code><code class="o">:</code> <code class="s2">"moveChunk.to"</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"router1-2018-11-04T17:29:39.702-0500-5bdf72d32ad9c69075112f08"</code><code class="p">,</code>
    <code class="s2">"server"</code> <code class="o">:</code> <code class="s2">"bob"</code><code class="p">,</code>
    <code class="s2">"clientAddr"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">,</code>
    <code class="s2">"time"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2018-11-04T22:29:39.702Z"</code><code class="p">),</code>
    <code class="s2">"what"</code> <code class="o">:</code> <code class="s2">"moveChunk.to"</code><code class="p">,</code>
    <code class="s2">"ns"</code> <code class="o">:</code> <code class="s2">"video.movies"</code><code class="p">,</code>
    <code class="s2">"details"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"min"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$minKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"max"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-7262221363006655132"</code><code class="p">)</code>
        <code class="p">},</code>
        <code class="s2">"step 1 of 6"</code> <code class="o">:</code> <code class="mi">965</code><code class="p">,</code>
        <code class="s2">"step 2 of 6"</code> <code class="o">:</code> <code class="mi">608</code><code class="p">,</code>
        <code class="s2">"step 3 of 6"</code> <code class="o">:</code> <code class="mi">15424</code><code class="p">,</code>
        <code class="s2">"step 4 of 6"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"step 5 of 6"</code> <code class="o">:</code> <code class="mi">72</code><code class="p">,</code>
        <code class="s2">"step 6 of 6"</code> <code class="o">:</code> <code class="mi">258</code><code class="p">,</code>
        <code class="s2">"note"</code> <code class="o">:</code> <code class="s2">"success"</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>Each of the steps listed in <code>"details"</code> is timed and the <code>"step<em><code>N</code></em> of
        <em><code>N</code></em>"</code> messages show how long each
        step took, in milliseconds.</p><p>When the “from” shard receives a <code>moveChunk</code> command from the <em class="filename">mongos</em>, it:</p><ol><li><p>Checks the command parameters.</p></li><li><p>Confirms with the config servers that it can acquire a
            distributed lock for the <span class="keep-together">migrate</span>.</p></li><li><p>Tries to contact the “to” shard.</p></li><li><p>Copies the data. This is referred to and logged as “the
            critical section.”</p></li><li><p>Coordinates with the “to” shard and config servers to
            confirm the migration.</p></li></ol><p>Note that the “to” and “from” shards must be in close
        communication starting at <code>"step4 of
        6"</code>: the shards directly talk to one another and the config
        server to perform the migration. If the “from” server has flaky
        network connectivity during the final steps, it may end up in a state
        where it cannot undo the migration and cannot move forward with it. In
        this case, the <em class="filename">mongod</em> will shut
        down.</p><p>The “to” shard’s changelog document is similar to the “from”
        shard’s, but the steps are a bit different. It looks like this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">changelog</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">what</code><code class="o">:</code> <code class="s2">"moveChunk.from"</code><code class="p">,</code> <code class="s2">"details.max.imdbId"</code><code class="o">:</code> 
  <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-7262221363006655132"</code><code class="p">)}).</code><code class="nx">pretty</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"router1-2018-11-04T17:29:39.753-0500-5bdf72d321b6e3be02fabf0b"</code><code class="p">,</code>
    <code class="s2">"server"</code> <code class="o">:</code> <code class="s2">"bob"</code><code class="p">,</code>
    <code class="s2">"clientAddr"</code> <code class="o">:</code> <code class="s2">"127.0.0.1:64743"</code><code class="p">,</code>
    <code class="s2">"time"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2018-11-04T22:29:39.753Z"</code><code class="p">),</code>
    <code class="s2">"what"</code> <code class="o">:</code> <code class="s2">"moveChunk.from"</code><code class="p">,</code>
    <code class="s2">"ns"</code> <code class="o">:</code> <code class="s2">"video.movies"</code><code class="p">,</code>
    <code class="s2">"details"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"min"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"$minKey"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"max"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"-7262221363006655132"</code><code class="p">)</code>
        <code class="p">},</code>
        <code class="s2">"step 1 of 6"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"step 2 of 6"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code>
        <code class="s2">"step 3 of 6"</code> <code class="o">:</code> <code class="mi">191</code><code class="p">,</code>
        <code class="s2">"step 4 of 6"</code> <code class="o">:</code> <code class="mi">17000</code><code class="p">,</code>
        <code class="s2">"step 5 of 6"</code> <code class="o">:</code> <code class="mi">341</code><code class="p">,</code>
        <code class="s2">"step 6 of 6"</code> <code class="o">:</code> <code class="mi">39</code><code class="p">,</code>
        <code class="s2">"to"</code> <code class="o">:</code> <code class="s2">"shard01"</code><code class="p">,</code>
        <code class="s2">"from"</code> <code class="o">:</code> <code class="s2">"shard02"</code><code class="p">,</code>
        <code class="s2">"note"</code> <code class="o">:</code> <code class="s2">"success"</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>When the “to” shard receives a command from the “from” shard,
        it:</p><ol><li><p>Migrates indexes. If this shard has never held chunks from
            the migrated collection before, it needs to know what fields are
            indexed. If this isn’t the first time a chunk from this collection
            is being moved to this shard, then this should be a <span class="keep-together">no-op</span>.</p></li><li><p>Deletes any existing data in the chunk range. There might be
            data left over from a failed migration or restore procedure that
            we wouldn’t want to interfere with the current data.</p></li><li><p>Copies all documents in the chunk to the “to” shard.</p></li><li><p>Replays any operations that happened to these documents
            during the copy (on the “to” shard).</p></li><li><p>Waits for the “to” shard to have replicated the newly
            migrated data to a majority of servers.</p></li><li><p>Commits the migrate by changing the chunk’s metadata to say
            that it lives on the “to” shard.</p></li></ol></div></section><section data-type="sect3" data-pdf-bookmark="config.settings"><div class="sect3" id="idm45882342392776"><h3>config.settings</h3><p>This<a data-type="indexterm" data-primary="config database" data-secondary="seeing configuration information" data-tertiary="config.settings" id="idm45882341885416"/> collection contains documents representing the current
        balancer settings and chunk size. By changing the documents in this
        collection, you can turn the balancer on or off or change the chunk
        size. Note that you should always connect to <em class="filename">mongos</em>, not the config servers directly, to
        change values in this<a data-type="indexterm" data-startref="changelog17" id="idm45882341882984"/><a data-type="indexterm" data-startref="SAOcurconfig17" id="idm45882341882152"/><a data-type="indexterm" data-startref="AScurrent17" id="idm45882341881320"/> collection.</p></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Tracking Network Connections"><div class="sect1" id="idm45882343399624"><h1>Tracking Network Connections</h1><p>There<a data-type="indexterm" data-primary="networking" data-secondary="tracking network connections" id="idm45882341879608"/><a data-type="indexterm" data-primary="administration, of sharding" data-secondary="tracking network connections" id="ASnetwork17"/> are a lot of connections between the components of a
    cluster. This section covers some sharding-specific information (see <a data-type="xref" href="ch24.xhtml#chapter-ops">Chapter 24</a> for more information on <span class="keep-together">networking)</span>.</p><section data-type="sect2" data-pdf-bookmark="Getting Connection Statistics"><div class="sect2" id="idm45882341875224"><h2>Getting Connection Statistics</h2><p>The<a data-type="indexterm" data-primary="sharding, administration of" data-secondary="tracking network connections" data-tertiary="connection statistics" id="SAOnetconn17"/> command <code>connPoolStats</code><a data-type="indexterm" data-primary="connPoolStats command" id="idm45882341871992"/> returns information regarding the open outgoing
      connections from the current database instance to other members of the
      sharded cluster or replica set.</p><p>To avoid interference with any running operations, <code>connPoolStats</code> does not take any locks. As
      such, the counts may change slightly as <code>connPoolStats</code> gathers information, resulting
      in slight differences between the hosts and pools connection
      counts:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"connPoolStats"</code><code class="o">:</code> <code class="mi">1</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"numClientConnections"</code> <code class="o">:</code> <code class="mi">10</code><code class="p">,</code>
    <code class="s2">"numAScopedConnections"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"totalInUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"totalAvailable"</code> <code class="o">:</code> <code class="mi">13</code><code class="p">,</code>
    <code class="s2">"totalCreated"</code> <code class="o">:</code> <code class="mi">86</code><code class="p">,</code>
    <code class="s2">"totalRefreshing"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"pools"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"NetworkInterfaceTL-TaskExecutorPool-0"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"poolInUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"poolAvailable"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"poolCreated"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"poolRefreshing"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"localhost:27027"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">},</code>
            <code class="s2">"localhost:27019"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"NetworkInterfaceTL-ShardRegistry"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"poolInUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"poolAvailable"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"poolCreated"</code> <code class="o">:</code> <code class="mi">13</code><code class="p">,</code>
            <code class="s2">"poolRefreshing"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"localhost:27027"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">13</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">}</code>
        <code class="p">},</code>
        <code class="s2">"global"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"poolInUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"poolAvailable"</code> <code class="o">:</code> <code class="mi">10</code><code class="p">,</code>
            <code class="s2">"poolCreated"</code> <code class="o">:</code> <code class="mi">71</code><code class="p">,</code>
            <code class="s2">"poolRefreshing"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"localhost:27026"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">8</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">},</code>
            <code class="s2">"localhost:27027"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">},</code>
            <code class="s2">"localhost:27023"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">7</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">},</code>
            <code class="s2">"localhost:27024"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">6</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">},</code>
            <code class="s2">"localhost:27022"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">9</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">},</code>
            <code class="s2">"localhost:27019"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">8</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">},</code>
            <code class="s2">"localhost:27021"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">8</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">},</code>
            <code class="s2">"localhost:27025"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">9</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">},</code>
            <code class="s2">"localhost:27020"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">8</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">},</code>
            <code class="s2">"localhost:27018"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
                <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
                <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">7</code><code class="p">,</code>
                <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
            <code class="p">}</code>
        <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"hosts"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"localhost:27026"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">8</code><code class="p">,</code>
            <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">},</code>
        <code class="s2">"localhost:27027"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code>
            <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">15</code><code class="p">,</code>
            <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">},</code>
        <code class="s2">"localhost:27023"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">7</code><code class="p">,</code>
            <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">},</code>
        <code class="s2">"localhost:27024"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">6</code><code class="p">,</code>
            <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">},</code>
        <code class="s2">"localhost:27022"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">9</code><code class="p">,</code>
            <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">},</code>
        <code class="s2">"localhost:27019"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">9</code><code class="p">,</code>
            <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">},</code>
        <code class="s2">"localhost:27021"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">8</code><code class="p">,</code>
            <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">},</code>
        <code class="s2">"localhost:27025"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">9</code><code class="p">,</code>
            <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">},</code>
        <code class="s2">"localhost:27020"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">8</code><code class="p">,</code>
            <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">},</code>
        <code class="s2">"localhost:27018"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"inUse"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"available"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"created"</code> <code class="o">:</code> <code class="mi">7</code><code class="p">,</code>
            <code class="s2">"refreshing"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"replicaSets"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"shard02"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hosts"</code> <code class="o">:</code> <code class="p">[</code>
                <code class="p">{</code>
                    <code class="s2">"addr"</code> <code class="o">:</code> <code class="s2">"localhost:27021"</code><code class="p">,</code>
                    <code class="s2">"ok"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"pingTimeMillis"</code> <code class="o">:</code> <code class="mi">0</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"addr"</code> <code class="o">:</code> <code class="s2">"localhost:27022"</code><code class="p">,</code>
                    <code class="s2">"ok"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"pingTimeMillis"</code> <code class="o">:</code> <code class="mi">0</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"addr"</code> <code class="o">:</code> <code class="s2">"localhost:27023"</code><code class="p">,</code>
                    <code class="s2">"ok"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"pingTimeMillis"</code> <code class="o">:</code> <code class="mi">0</code>
                <code class="p">}</code>
            <code class="p">]</code>
        <code class="p">},</code>
        <code class="s2">"shard03"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hosts"</code> <code class="o">:</code> <code class="p">[</code>
                <code class="p">{</code>
                    <code class="s2">"addr"</code> <code class="o">:</code> <code class="s2">"localhost:27024"</code><code class="p">,</code>
                    <code class="s2">"ok"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"pingTimeMillis"</code> <code class="o">:</code> <code class="mi">0</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"addr"</code> <code class="o">:</code> <code class="s2">"localhost:27025"</code><code class="p">,</code>
                    <code class="s2">"ok"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"pingTimeMillis"</code> <code class="o">:</code> <code class="mi">0</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"addr"</code> <code class="o">:</code> <code class="s2">"localhost:27026"</code><code class="p">,</code>
                    <code class="s2">"ok"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"pingTimeMillis"</code> <code class="o">:</code> <code class="mi">0</code>
                <code class="p">}</code>
            <code class="p">]</code>
        <code class="p">},</code>
        <code class="s2">"configRepl"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hosts"</code> <code class="o">:</code> <code class="p">[</code>
                <code class="p">{</code>
                    <code class="s2">"addr"</code> <code class="o">:</code> <code class="s2">"localhost:27027"</code><code class="p">,</code>
                    <code class="s2">"ok"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"pingTimeMillis"</code> <code class="o">:</code> <code class="mi">0</code>
                <code class="p">}</code>
            <code class="p">]</code>
        <code class="p">},</code>
        <code class="s2">"shard01"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hosts"</code> <code class="o">:</code> <code class="p">[</code>
                <code class="p">{</code>
                    <code class="s2">"addr"</code> <code class="o">:</code> <code class="s2">"localhost:27018"</code><code class="p">,</code>
                    <code class="s2">"ok"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"pingTimeMillis"</code> <code class="o">:</code> <code class="mi">0</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"addr"</code> <code class="o">:</code> <code class="s2">"localhost:27019"</code><code class="p">,</code>
                    <code class="s2">"ok"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"pingTimeMillis"</code> <code class="o">:</code> <code class="mi">0</code>
                <code class="p">},</code>
                <code class="p">{</code>
                    <code class="s2">"addr"</code> <code class="o">:</code> <code class="s2">"localhost:27020"</code><code class="p">,</code>
                    <code class="s2">"ok"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
                    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
                    <code class="s2">"pingTimeMillis"</code> <code class="o">:</code> <code class="mi">0</code>
                <code class="p">}</code>
            <code class="p">]</code>
        <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541440424</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
    <code class="s2">"$clusterTime"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"clusterTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541440424</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
        <code class="s2">"signature"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hash"</code> <code class="o">:</code> <code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
            <code class="s2">"keyId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>In this output:</p><ul><li><p><code>"totalAvailable"</code> shows the
          total number of available outgoing connections from the current
          <em>mongod</em>/<em>mongos</em> instance to
          other members of the sharded cluster or replica set.</p></li><li><p><code>"totalCreated"</code> reports the
          total number of outgoing connections ever created by the current
          <em>mongod</em>/<em>mongos</em> instance to
          other members of the sharded cluster or replica set.</p></li><li><p><code>"totalInUse"</code> provides the
          total number of outgoing connections from the current
          <em>mongod</em>/<em>mongos</em> instance to
          other members of the sharded cluster or replica set that are
          currently in use.</p></li><li><p><code>"totalRefreshing"</code> displays
          the total number of outgoing connections from the current
          <em>mongod</em>/<em>mongos</em> instance to
          other members of the sharded cluster or replica set that are
          currently being refreshed.</p></li><li><p><code>"numClientConnections"</code>
          identifies the number of active and stored outgoing synchronous
          connections from the current
          <em>mongod</em>/<em>mongos</em> instance to
          other members of the sharded cluster or replica set. These represent
          a subset of the connections reported by <code>"totalAvailable"</code>, <code>"totalCreated"</code>, and <span class="keep-together"><code>"totalInUse"</code></span>.</p></li><li><p><code>"numAScopedConnection"</code>
          reports the number of active and stored outgoing scoped synchronous
          connections from the current
          <em>mongod</em>/<em>mongos</em> instance to
          other members of the sharded cluster or replica set. These represent
          a subset of the connections reported by <code>"totalAvailable"</code>, <code>"totalCreated"</code>, and <span class="keep-together"><code>"totalInUse"</code></span>.</p></li><li><p><code>"pools"</code> shows connection
          statistics (in use/available/created/refreshing) grouped by the
          connection pools. A <em>mongod</em> or
          <em>mongos</em> has two distinct families of outgoing
          connection pools:</p><ul><li><p>DBClient-based pools (the “write path,” identified by the
              field name <code>"global"</code> in the
              <code>"pools"</code> document)</p></li><li><p>NetworkInterfaceTL-based pools (the “read path”)</p></li></ul></li><li><p><code>"hosts"</code> shows connection
          statistics (in use/available/created/refreshing) grouped by the
          hosts. It reports on connections between the current
          <em>mongod</em>/<em>mongos</em> instance and
          each member of the sharded cluster or replica set.</p></li></ul><p>You might see connections to other shards in the output of
      <code>connPoolStats</code>. These indicate that
      shards are connecting to other shards to migrate data. The primary of
      one shard will connect directly to the primary of another shard and
      “suck” its data.</p><p>When a migrate occurs, a shard sets up a
      <code class="classname">ReplicaSetMonitor</code><a data-type="indexterm" data-primary="ReplicaSetMonitor" id="idm45882340647272"/> (a process that monitors replica set health) to track the
      health of the shard on the other side of the migrate. <em class="filename">mongod</em> never destroys this monitor, so you
      may see messages in one replica set’s log about the members of another
      replica set. This is totally normal and should have no effect on
      your<a data-type="indexterm" data-startref="SAOnetconn17" id="idm45882340645288"/>
      application.</p></div></section><section data-type="sect2" data-pdf-bookmark="Limiting the Number of Connections"><div class="sect2" id="idm45882340644328"><h2>Limiting the Number of Connections</h2><p>When<a data-type="indexterm" data-primary="sharding, administration of" data-secondary="tracking network connections" data-tertiary="limiting number of connections" id="idm45882340642984"/> a client connects to a <em class="filename">mongos</em>, the <em class="filename">mongos</em> creates a connection to at least one
      shard to pass along the client’s request. Thus, every client connection
      into a <em class="filename">mongos</em> yields at least one
      outgoing connection from <em class="filename">mongos</em> to
      the shards.</p><p>If you have many <em class="filename">mongos</em>
      processes, they may create more connections than your shards can handle:
      by default a <em class="filename">mongos</em> will accept up
      to 65,536 connections (the same as <em class="filename">mongod</em>), so if you have 5 <em class="filename">mongos</em> processes with 10,000 client
      connections each, they may be attempting to create 50,000 connections to
      a shard!</p><p>To prevent this, you can use the <code class="option">--maxConns</code>
      option<a data-type="indexterm" data-primary="--maxConns option" data-primary-sortas="maxConns option" id="idm45882340634328"/> to your command-line configuration for <em class="filename">mongos</em> to limit the number of connections it
      can create. The following formula can be used to calculate the maximum
      number of connections a shard can handle from a single <em class="filename">mongos</em>:</p><ul class="simplelist"><li><em>maxConns</em> =
        <em>maxConnsPrimary</em> −
        (<em>numMembersPerReplicaSet</em> × 3) −</li><li>(<em>other</em> x 3) /
        <em>numMongosProcesses</em></li></ul><p>Breaking down the pieces of this formula:</p><dl><dt>maxConnsPrimary</dt><dd><p>The maximum number of connections on the Primary, typically
            set to 20,000 to avoid overwhelming the shard with connections
            from the <em class="filename">mongos</em>.</p></dd><dt>(numMembersPerReplicaSet × 3)</dt><dd><p>The primary creates a connection to each secondary and each
            secondary creates two connections to the primary, for a total of
            three connections.</p></dd><dt>(other x 3)</dt><dd><p>Other is the number of miscellaneous processes that may
            connect to your <em class="filename">mongod</em>s, such
            as monitoring or backup agents, direct shell connections (for
            administration), or connections to other shards for
            migrations.</p></dd><dt>numMongosProcesses</dt><dd><p>The total number of <em class="filename">mongos</em> in the sharded cluster.</p></dd></dl><p>Note that <code class="option">--maxConns</code> only prevents <em class="filename">mongos</em> from creating more than this many
      connections. It doesn’t do anything particularly helpful when this limit
      is reached: it will simply block requests, waiting for connections to be
      “freed.” Thus, you must prevent your application from using this many
      connections, especially as your number of <em class="filename">mongos</em> processes grows.</p><p>When a MongoDB instance exits cleanly it closes all connections
      before stopping. The members that were connected to it will immediately
      get socket errors on those connections and be able to refresh them.
      However, if a MongoDB instance suddenly goes offline due to a power
      loss, crash<a data-type="indexterm" data-primary="crashes, recovering from" id="idm45882340619304"/>, or network problems, it probably won’t cleanly close all
      of its sockets. In this case, other servers in the cluster may be under
      the impression that their connection is healthy until they try to
      perform an operation on it. At that point, they will get an error and
      refresh the connection (if the member is up again at that point).</p><p>This is a quick process when there are only a few connections.
      However, when there are thousands of connections that must be refreshed
      one by one you can get a lot of errors because each connection to the
      downed member must be tried, determined to be bad, and reestablished.
      There isn’t a particularly good way of preventing this, aside from
      restarting processes that get bogged down in a reconnection<a data-type="indexterm" data-startref="ASnetwork17" id="idm45882340617208"/> storm.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Server Administration"><div class="sect1" id="sharding-server-admin"><h1>Server Administration</h1><p>As<a data-type="indexterm" data-primary="administration, of sharding" data-secondary="adding servers" id="ASadd17"/><a data-type="indexterm" data-primary="server administration" data-secondary="in sharded clusters" id="Sadmin17"/><a data-type="indexterm" data-primary="sharding, administration of" data-secondary="server administration" data-tertiary="adding servers" id="idm45882340612408"/> your cluster grows, you’ll need to add capacity or change
    configurations. This section covers how to add and remove servers in your
    cluster.</p><section data-type="sect2" data-pdf-bookmark="Adding Servers"><div class="sect2" id="idm45882340610728"><h2>Adding Servers</h2><p>You can add new <em class="filename">mongos</em>
      processes at any time. Make sure their <code class="option">--configdb</code>
      option<a data-type="indexterm" data-primary="--configdb option" data-primary-sortas="configdb option" id="idm45882340608280"/> specifies the correct set of config servers and they
      should be immediately available for clients to connect to.</p><p>To add new shards, use the <code>addShard</code> command as shown in <a data-type="xref" href="ch15.xhtml#chapter-shard-config">Chapter 15</a>.</p></div></section><section data-type="sect2" data-pdf-bookmark="Changing Servers in a Shard"><div class="sect2" id="idm45882340605224"><h2>Changing Servers in a Shard</h2><p>As<a data-type="indexterm" data-primary="sharding, administration of" data-secondary="server administration" data-tertiary="changing servers in shards" id="idm45882340604232"/> you use your sharded cluster, you may want to change the
      servers in individual shards. To change a shard’s membership, connect
      directly to the shard’s primary (not through the <em class="filename">mongos</em>) and issue a replica set reconfig. The
      cluster configuration will pick up the change and update <em class="filename">config.shards</em> automatically. Do not modify
      <em class="filename">config.shards</em> by hand.</p><p>The only exception to this is if you started your cluster with
      standalone servers as shards, not replica sets.</p><section data-type="sect3" data-pdf-bookmark="Changing a shard from a standalone server to a replica&#10;        set"><div class="sect3" id="idm45882340599816"><h3>Changing a shard from a standalone server to a replica
        set</h3><p>The<a data-type="indexterm" data-primary="servers" data-secondary="standalone mode" id="idm45882340598872"/><a data-type="indexterm" data-primary="standalone mode" id="idm45882340597736"/> easiest way to do this is to add a new, empty replica
        set shard and then remove the standalone server shard (as discussed in
        the next section). Migrations will take care of moving your data to
        the new shard.</p></div></section></div></section><section data-type="sect2" data-pdf-bookmark="Removing a Shard"><div class="sect2" id="sect2-remove-shard"><h2>Removing a Shard</h2><p>In<a data-type="indexterm" data-primary="sharding, basics of" data-secondary="removing shards" id="SBOremove17"/><a data-type="indexterm" data-primary="sharding, administration of" data-secondary="server administration" data-tertiary="removing shards" id="SAOservremov17"/> general, shards should not be removed from a cluster. If
      you are regularly adding and removing shards, you are putting a lot more
      stress on the system than necessary. If you add too many shards it is
      better to let your system grow into them, not remove them and add them
      back later. However, if necessary, you can remove shards.</p><p>First make sure that the balancer is on. The balancer will be
      tasked with moving all the data on the shard you want to remove to other
      shards in a process called <em>draining</em>. To start
      draining, run the <code>removeShard</code>
      command<a data-type="indexterm" data-primary="removeShard command" id="idm45882340589896"/><a data-type="indexterm" data-primary="balancer" data-secondary="draining process" id="Bdrain17"/><a data-type="indexterm" data-primary="draining process" id="drain17"/>. <code>removeShard</code> takes the
      shard’s name and drains all the chunks on that shard to the other
      shards:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"removeShard"</code> <code class="o">:</code> <code class="s2">"shard03"</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"msg"</code> <code class="o">:</code> <code class="s2">"draining started successfully"</code><code class="p">,</code>
    <code class="s2">"state"</code> <code class="o">:</code> <code class="s2">"started"</code><code class="p">,</code>
    <code class="s2">"shard"</code> <code class="o">:</code> <code class="s2">"shard03"</code><code class="p">,</code>
    <code class="s2">"note"</code> <code class="o">:</code> <code class="s2">"you need to drop or movePrimary these databases"</code><code class="p">,</code>
    <code class="s2">"dbsToMove"</code> <code class="o">:</code> <code class="p">[</code> <code class="p">],</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450091</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code>
    <code class="s2">"$clusterTime"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"clusterTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450091</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code>
        <code class="s2">"signature"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hash"</code> <code class="o">:</code> <code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
            <code class="s2">"keyId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>Draining can take a long time if there are a lot of chunks or
      large chunks to move. If you have jumbo chunks (see <a data-type="xref" href="#sect2-jumbo">“Jumbo Chunks”</a>), you may have to temporarily increase the
      chunk size to allow draining to move them.</p><p>If you want to keep tabs on how much has been moved, run <code>removeShard</code> again to give you the current
      status:</p><pre id="I_programlisting10_d1e11982" data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"removeShard"</code> <code class="o">:</code> <code class="s2">"shard02"</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"msg"</code> <code class="o">:</code> <code class="s2">"draining ongoing"</code><code class="p">,</code>
    <code class="s2">"state"</code> <code class="o">:</code> <code class="s2">"ongoing"</code><code class="p">,</code>
    <code class="s2">"remaining"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"chunks"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">3</code><code class="p">),</code>
        <code class="s2">"dbs"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
    <code class="p">},</code>
    <code class="s2">"note"</code> <code class="o">:</code> <code class="s2">"you need to drop or movePrimary these databases"</code><code class="p">,</code>
    <code class="s2">"dbsToMove"</code> <code class="o">:</code> <code class="p">[</code> 
          <code class="s2">"video"</code>
       <code class="p">],</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450139</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
    <code class="s2">"$clusterTime"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"clusterTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450139</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
        <code class="s2">"signature"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hash"</code> <code class="o">:</code> <code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
            <code class="s2">"keyId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>You can run <code>removeShard</code> as many
      times as you want.</p><p>Chunks may have to be split to be moved, so you may see the number
      of chunks increase in the system during the drain. For example, suppose
      we have a five-shard cluster with the following chunk
      distributions:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">test</code><code class="o">-</code><code class="nx">rs0</code>    <code class="mi">10</code>
<code class="nx">test</code><code class="o">-</code><code class="nx">rs1</code>    <code class="mi">10</code>
<code class="nx">test</code><code class="o">-</code><code class="nx">rs2</code>    <code class="mi">10</code>
<code class="nx">test</code><code class="o">-</code><code class="nx">rs3</code>    <code class="mi">11</code>
<code class="nx">test</code><code class="o">-</code><code class="nx">rs4</code>    <code class="mi">11</code></pre><p>This cluster has a total of 52 chunks. If we remove <em class="filename">test-rs3</em>, we might end up with:</p><pre data-type="programlisting" data-code-language="javascript"><code class="nx">test</code><code class="o">-</code><code class="nx">rs0</code>    <code class="mi">15</code>
<code class="nx">test</code><code class="o">-</code><code class="nx">rs1</code>    <code class="mi">15</code>
<code class="nx">test</code><code class="o">-</code><code class="nx">rs2</code>    <code class="mi">15</code>
<code class="nx">test</code><code class="o">-</code><code class="nx">rs4</code>    <code class="mi">15</code></pre><p>The cluster now has 60 chunks, 18 of which came from shard
      <em class="filename">test-rs3</em> (11 were there to start
      and 7 were created from draining splits).</p><p>Once all the chunks have been moved, if there are still databases
      that have the removed shard as their primary, you’ll need to remove them
      before the shard can be removed. Each database in a sharded cluster has
      a primary shard. If the shard you want to remove is also the primary of
      one of the cluster’s databases, <code>removeShard</code> lists the database in the <code>"dbsToMove"</code> field. To finish removing the
      shard, you must either move the database to a new shard after migrating
      all data from the shard or drop the database, deleting the associated
      data files. The output of <code>removeShard</code>
      will be something like:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"removeShard"</code> <code class="o">:</code> <code class="s2">"shard02"</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"msg"</code> <code class="o">:</code> <code class="s2">"draining ongoing"</code><code class="p">,</code>
    <code class="s2">"state"</code> <code class="o">:</code> <code class="s2">"ongoing"</code><code class="p">,</code>
    <code class="s2">"remaining"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"chunks"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">3</code><code class="p">),</code>
        <code class="s2">"dbs"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
    <code class="p">},</code>
    <code class="s2">"note"</code> <code class="o">:</code> <code class="s2">"you need to drop or movePrimary these databases"</code><code class="p">,</code>
    <code class="s2">"dbsToMove"</code> <code class="o">:</code> <code class="p">[</code> 
          <code class="s2">"video"</code>
       <code class="p">],</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450139</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
    <code class="s2">"$clusterTime"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"clusterTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450139</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
        <code class="s2">"signature"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hash"</code> <code class="o">:</code> <code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
            <code class="s2">"keyId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>To finish the remove, move the listed databases with the <code>movePrimary</code> command:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"movePrimary"</code> <code class="o">:</code> <code class="s2">"video"</code><code class="p">,</code> <code class="s2">"to"</code> <code class="o">:</code> <code class="s2">"shard01"</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450554</code><code class="p">,</code> <code class="mi">12</code><code class="p">),</code>
    <code class="s2">"$clusterTime"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"clusterTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450554</code><code class="p">,</code> <code class="mi">12</code><code class="p">),</code>
        <code class="s2">"signature"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hash"</code> <code class="o">:</code> <code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
            <code class="s2">"keyId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>Once you have done this, run <code>removeShard</code> one more time:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"removeShard"</code> <code class="o">:</code> <code class="s2">"shard02"</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"msg"</code> <code class="o">:</code> <code class="s2">"removeshard completed successfully"</code><code class="p">,</code>
    <code class="s2">"state"</code> <code class="o">:</code> <code class="s2">"completed"</code><code class="p">,</code>
    <code class="s2">"shard"</code> <code class="o">:</code> <code class="s2">"shard03"</code><code class="p">,</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450619</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code>
    <code class="s2">"$clusterTime"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"clusterTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450619</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code>
        <code class="s2">"signature"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hash"</code> <code class="o">:</code> <code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
            <code class="s2">"keyId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>This is not strictly necessary, but it confirms that you have
      completed the process. If there are no databases that have this shard as
      their primary, you will get this response as soon as all chunks have
      been migrated off<a data-type="indexterm" data-startref="ASadd17" id="idm45882340103256"/><a data-type="indexterm" data-startref="Sadmin17" id="idm45882340102632"/><a data-type="indexterm" data-startref="SBOremove17" id="idm45882340064520"/><a data-type="indexterm" data-startref="SAOservremov17" id="idm45882340063688"/><a data-type="indexterm" data-startref="Bdrain17" id="idm45882340062856"/><a data-type="indexterm" data-startref="drain17" id="idm45882340062024"/> the shard.</p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>Once you have started a shard draining, there is no built-in way
        to stop it.</p></div></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Balancing Data"><div class="sect1" id="sect1-balancer"><h1>Balancing Data</h1><p>In<a data-type="indexterm" data-primary="administration, of sharding" data-secondary="balancing data" id="ASbalance17"/><a data-type="indexterm" data-primary="data" data-secondary="balancing" id="Dbalance17"/> general, MongoDB automatically takes care of balancing
    data. This section covers how to enable and disable this automatic
    balancing as well as how to intervene in the balancing process.</p><section data-type="sect2" data-pdf-bookmark="The Balancer"><div class="sect2" id="idm45882339853560"><h2>The Balancer</h2><p>Turning<a data-type="indexterm" data-primary="balancer" data-secondary="turning off" id="idm45882339852344"/><a data-type="indexterm" data-primary="sharding, administration of" data-secondary="balancing data" data-tertiary="turning balancer off" id="idm45882339851208"/> off the balancer is a prerequisite to nearly any
      administrative activity. There is a shell helper to make this
      easier:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">setBalancerState</code><code class="p">(</code><code class="kc">false</code><code class="p">)</code>
<code class="p">{</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450923</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code>
    <code class="s2">"$clusterTime"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"clusterTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541450923</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code>
        <code class="s2">"signature"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hash"</code> <code class="o">:</code> <code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
            <code class="s2">"keyId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>With the balancer off a new balancing round will not begin, but
      turning it off will not force an ongoing balancing round to stop
      immediately—migrations generally cannot stop on a dime. Thus, you should
      check the <em class="filename">config.locks</em> collection
      to see whether or not a balancing round is still in progress:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">locks</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"balancer"</code><code class="p">})[</code><code class="s2">"state"</code><code class="p">]</code>
<code class="mi">0</code></pre><p><code>0</code> means the balancer is
      off.</p><p>Balancing puts load on your system: the destination shard must
      query the source shard for all the documents in a chunk and insert them,
      and then the source shard must delete them. There are two circumstances
      in particular where migrations can cause performance problems:</p><ol><li><p>Using a<a data-type="indexterm" data-primary="hotspot shard keys" id="idm45882339722152"/><a data-type="indexterm" data-primary="shard keys, choosing" data-secondary="hotspot shard keys" id="idm45882339713432"/> hotspot shard key will force constant migrations (as
          all new chunks will be created on the hotspot). Your system must
          have the capacity to handle the flow of data coming off of your
          hotspot shard.</p></li><li><p>Adding a new shard will trigger a stream of migrations as the
          balancer attempts to populate it.</p></li></ol><p>If you find that migrations are affecting your application’s
      performance, you can schedule a window for balancing in the <em class="filename">config.settings</em> collection. Run the following
      update to only allow balancing between 1 p.m. and 4 p.m. First make sure
      the balancer is on, then schedule the window:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">setBalancerState</code><code class="p">(</code> <code class="kc">true</code> <code class="p">)</code>
<code class="p">{</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541451846</code><code class="p">,</code> <code class="mi">4</code><code class="p">),</code>
    <code class="s2">"$clusterTime"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"clusterTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541451846</code><code class="p">,</code> <code class="mi">4</code><code class="p">),</code>
        <code class="s2">"signature"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hash"</code> <code class="o">:</code> <code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
            <code class="s2">"keyId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">settings</code><code class="p">.</code><code class="nx">update</code><code class="p">(</code>
   <code class="p">{</code> <code class="nx">_id</code><code class="o">:</code> <code class="s2">"balancer"</code> <code class="p">},</code>
   <code class="p">{</code> <code class="nx">$set</code><code class="o">:</code> <code class="p">{</code> <code class="nx">activeWindow</code> <code class="o">:</code> <code class="p">{</code> <code class="nx">start</code> <code class="o">:</code> <code class="s2">"13:00"</code><code class="p">,</code> <code class="nx">stop</code> <code class="o">:</code> <code class="s2">"16:00"</code> <code class="p">}</code> <code class="p">}</code> <code class="p">},</code>
   <code class="p">{</code> <code class="nx">upsert</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}</code>
<code class="p">)</code>
<code class="nx">WriteResult</code><code class="p">({</code> <code class="s2">"nMatched"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"nUpserted"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"nModified"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">})</code></pre><p>If you set a balancing window, monitor it closely to ensure that
      <em class="filename">mongos</em> can actually keep your
      cluster balanced in the time that you have allotted it.</p><p>You must be careful if you plan to combine manual balancing with
      the automatic balancer, since the automatic balancer always determines
      what to move based on the current state of the set and does not take
      into account the set’s history. For example, suppose you have
      <em>shardA</em> and <em>shardB</em>, each
      holding 500 chunks. <em>shardA</em> is getting a lot of
      writes, so you turn off the balancer and move 30 of the most active
      chunks to <em>shardB</em>. If you turn the balancer back on
      at this point, it will immediately swoop in and move 30 chunks (possibly
      a different 30) back from <em>shardB</em> to
      <em>shardA</em> to balance the chunk counts.</p><p>To prevent this, move 30 quiescent chunks from
      <em>shardB</em> to <em>shardA</em> before
      starting the balancer. That way there will be no imbalance between the
      shards and the balancer will be happy to leave things as they are.
      Alternatively, you could perform 30 splits on
      <em>shardA</em>’s chunks to even out the chunk
      counts.</p><p>Note that the balancer only uses number of chunks as a metric, not
      size of data. Moving a chunk is called a
      <span class="firstterm">migration</span> and is how MongoDB balances data across
      your cluster. Thus, a shard with a few large chunks may end up as the
      target of a migration from a shard with many small chunks (but a smaller
      data size).</p></div></section><section data-type="sect2" data-pdf-bookmark="Changing Chunk Size"><div class="sect2" id="idm45882339853256"><h2>Changing Chunk Size</h2><p>There<a data-type="indexterm" data-primary="chunks" data-secondary="changing chunk size" id="idm45882339542952"/><a data-type="indexterm" data-primary="sharding, administration of" data-secondary="balancing data" data-tertiary="changing chunk size" id="idm45882339541816"/> can be anywhere from zero to millions of documents in a
      chunk. Generally, the larger a chunk is, the longer it takes to migrate
      to another shard. In <a data-type="xref" href="ch14.xhtml#chapter_d1e10482">Chapter 14</a>, we used a
      chunk size of 1 MB, so that we could see chunk movement easily and
      quickly. This is generally impractical in a live system; MongoDB would
      be doing a lot of unnecessary work to keep shards within a few megabytes
      of each other in size. By default chunks are 64 MB, which generally
      provides a good balance between ease of migration and migratory
      churn.</p><p>Sometimes you may find that migrations are taking too long with 64
      MB chunks. To speed them up, you can decrease your chunk size. To do
      this, connect to <em class="filename">mongos</em> through the
      shell and update the <em class="filename">config.settings</em> collection:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">settings</code><code class="p">.</code><code class="nx">findOne</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"chunksize"</code><code class="p">,</code> 
    <code class="s2">"value"</code> <code class="o">:</code> <code class="mi">64</code> 
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">settings</code><code class="p">.</code><code class="nx">save</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"chunksize"</code><code class="p">,</code> <code class="s2">"value"</code> <code class="o">:</code> <code class="mi">32</code><code class="p">})</code>
<code class="nx">WriteResult</code><code class="p">({</code> <code class="s2">"nMatched"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"nUpserted"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="s2">"nModified"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">})</code></pre><p>The previous update would change your chunk size to 32 MB.
      Existing chunks would not be changed immediately, however; automatic
      splitting only occurs on insert or update. Thus, if you lower the chunk
      size, it may take time for all chunks to split to the new size.</p><p>Splits cannot be undone. If you increase the chunk size, existing
      chunks grow only through insertion or updates until they reach the new
      size. The<a data-type="indexterm" data-primary="chunks" data-secondary="allowed size range" id="idm45882339399752"/> allowed range of the chunk size is between 1 and 1,024
      MB, inclusive.</p><p>Note that this is a cluster-wide setting: it affects all
      collections and databases. Thus, if you need a small chunk size for one
      collection and a large chunk size for another, you may have to
      compromise with a chunk size in between the two ideals (or put the
      collections in different clusters).</p><div data-type="tip"><h6>Tip</h6><p>If MongoDB is doing too many migrations or your documents are
        large, you may want to increase your chunk size.</p></div></div></section><section data-type="sect2" data-pdf-bookmark="Moving Chunks"><div class="sect2" id="idm45882339397304"><h2>Moving Chunks</h2><p>As<a data-type="indexterm" data-primary="sharding, administration of" data-secondary="balancing data" data-tertiary="moving chunks" id="idm45882339510696"/><a data-type="indexterm" data-primary="chunks" data-secondary="moving" id="idm45882339509320"/> mentioned earlier, all the data in a chunk lives on a
      certain shard. If that shard ends up with more chunks than the other
      shards, MongoDB will move some chunks off it.</p><p>You can manually move chunks using the <code>moveChunk<a data-type="indexterm" data-primary="moveChunk command" id="idm45882339507352"/></code> shell helper:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">moveChunk</code><code class="p">(</code><code class="s2">"video.movies"</code><code class="p">,</code> <code class="p">{</code><code class="nx">imdbId</code><code class="o">:</code> <code class="mi">500000</code><code class="p">},</code> <code class="s2">"shard02"</code><code class="p">)</code> 
<code class="p">{</code> <code class="s2">"millis"</code> <code class="o">:</code> <code class="mi">4079</code><code class="p">,</code> <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code></pre><p>This would move the chunk containing the document with an <code>"imdbId"</code> of <code>500000</code> to the shard named
      <em>shard02</em>. You must use the shard key (<code>"imdbId"</code>, in this case) to find which chunk to
      move. Generally, the easiest way to specify a chunk is by its lower
      bound, although any value in the chunk will work (the upper bound will
      not, as it is not actually in the chunk). This command will move the
      chunk before returning, so it may take a while to run. The logs are the
      best place to see what it is doing if it takes a long time.</p><p>If a chunk is larger than the max chunk size, <em class="filename">mongos</em> will refuse to move it:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">moveChunk</code><code class="p">(</code><code class="s2">"video.movies"</code><code class="p">,</code> <code class="p">{</code><code class="nx">imdbId</code><code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"8345072417171006784"</code><code class="p">)},</code> 
  <code class="s2">"shard02"</code><code class="p">)</code>
<code class="p">{</code>
    <code class="s2">"cause"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"chunkTooBig"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
        <code class="s2">"estimatedChunkSize"</code> <code class="o">:</code> <code class="mi">2214960</code><code class="p">,</code>
        <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
        <code class="s2">"errmsg"</code> <code class="o">:</code> <code class="s2">"chunk too big to move"</code>
    <code class="p">},</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"errmsg"</code> <code class="o">:</code> <code class="s2">"move failed"</code>
<code class="p">}</code></pre><p>In this case, you must manually split the chunk before moving it,
      using the <code>splitAt</code> command:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">chunks</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">ns</code><code class="o">:</code> <code class="s2">"video.movies"</code><code class="p">,</code> <code class="s2">"min.imdbId"</code><code class="o">:</code> 
  <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"6386258634539951337"</code><code class="p">)}).</code><code class="nx">pretty</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"video.movies-imdbId_6386258634539951337"</code><code class="p">,</code>
    <code class="s2">"ns"</code> <code class="o">:</code> <code class="s2">"video.movies"</code><code class="p">,</code>
    <code class="s2">"min"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"6386258634539951337"</code><code class="p">)</code>
    <code class="p">},</code>
    <code class="s2">"max"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"8345072417171006784"</code><code class="p">)</code>
    <code class="p">},</code>
    <code class="s2">"shard"</code> <code class="o">:</code> <code class="s2">"shard02"</code><code class="p">,</code>
    <code class="s2">"lastmod"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="mi">9</code><code class="p">),</code>
    <code class="s2">"lastmodEpoch"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5bdf72c021b6e3be02fabe0c"</code><code class="p">),</code>
    <code class="s2">"history"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
            <code class="s2">"validAfter"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541370559</code><code class="p">,</code> <code class="mi">4</code><code class="p">),</code>
            <code class="s2">"shard"</code> <code class="o">:</code> <code class="s2">"shard02"</code>
        <code class="p">}</code>
    <code class="p">]</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">splitAt</code><code class="p">(</code><code class="s2">"video.movies"</code><code class="p">,</code> <code class="p">{</code><code class="s2">"imdbId"</code><code class="o">:</code> 
  <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"7000000000000000000"</code><code class="p">)})</code>
<code class="p">{</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541453304</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
    <code class="s2">"$clusterTime"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"clusterTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541453306</code><code class="p">,</code> <code class="mi">5</code><code class="p">),</code>
        <code class="s2">"signature"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hash"</code> <code class="o">:</code> <code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
            <code class="s2">"keyId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">chunks</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="nx">ns</code><code class="o">:</code> <code class="s2">"video.movies"</code><code class="p">,</code> <code class="s2">"min.imdbId"</code><code class="o">:</code> 
  <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"6386258634539951337"</code><code class="p">)}).</code><code class="nx">pretty</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"video.movies-imdbId_6386258634539951337"</code><code class="p">,</code>
    <code class="s2">"lastmod"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">15</code><code class="p">,</code> <code class="mi">2</code><code class="p">),</code>
    <code class="s2">"lastmodEpoch"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"5bdf72c021b6e3be02fabe0c"</code><code class="p">),</code>
    <code class="s2">"ns"</code> <code class="o">:</code> <code class="s2">"video.movies"</code><code class="p">,</code>
    <code class="s2">"min"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"6386258634539951337"</code><code class="p">)</code>
    <code class="p">},</code>
    <code class="s2">"max"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"imdbId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="s2">"7000000000000000000"</code><code class="p">)</code>
    <code class="p">},</code>
    <code class="s2">"shard"</code> <code class="o">:</code> <code class="s2">"shard02"</code><code class="p">,</code>
    <code class="s2">"history"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
            <code class="s2">"validAfter"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541370559</code><code class="p">,</code> <code class="mi">4</code><code class="p">),</code>
            <code class="s2">"shard"</code> <code class="o">:</code> <code class="s2">"shard02"</code>
        <code class="p">}</code>
    <code class="p">]</code>
<code class="p">}</code></pre><p>Once the chunk has been split into smaller pieces, it should be
      movable. Alternatively, you can raise the max chunk size and then move
      it, but you should break up large chunks whenever possible. Sometimes,
      though, chunks cannot be broken up—we’ll look at this situation
      next.<sup><a data-type="noteref" id="idm45882339279480-marker" href="ch17.xhtml#idm45882339279480">1</a></sup></p></div></section><section data-type="sect2" data-pdf-bookmark="Jumbo Chunks"><div class="sect2" id="sect2-jumbo"><h2>Jumbo Chunks</h2><p>Suppose<a data-type="indexterm" data-primary="jumbo chunks" data-secondary="defined" id="idm45882339275496"/><a data-type="indexterm" data-primary="chunks" data-secondary="jumbo chunks" id="Cjumbo17"/><a data-type="indexterm" data-primary="sharding, administration of" data-secondary="balancing data" data-tertiary="jumbo chunks" id="SAObjumbo17"/> you choose the <code>"date"</code>
      field as your shard key. The <code>"date"</code>
      field in this collection is a string that looks like <code>"<em><code>year</code></em>/<em><code>month</code></em>/<em><code>day</code></em>"</code>,
      which means that <em class="filename">mongos</em> can create
      at most one chunk per day. This works fine for a while, until your
      application suddenly goes viral and gets a thousand times its typical
      traffic for one day.</p><p>This day’s chunk is going to be much larger than any other day’s,
      but it is also completely unsplittable because every document has the
      same value for the shard key.</p><p>Once a chunk is larger than the max chunk size set in <em class="filename">config.settings</em>, the balancer will not be
      allowed to move the chunk. These unsplittable, unmovable chunks are
      called <em>jumbo chunks</em> and they are inconvenient to
      deal with.</p><p>Let’s<a data-type="indexterm" data-primary="jumbo chunks" data-secondary="example of" id="idm45882338969864"/> take an example. Suppose you have three shards, <em class="filename">shard1</em>, <em class="filename">shard2</em>, and <em class="filename">shard3</em>. If you use the hotspot shard key
      pattern described in <a data-type="xref" href="ch16.xhtml#sect2-hotspot">“Ascending Shard Keys”</a>, all your writes
      will be going to one shard—say, <em class="filename">shard1</em>. The shard primary <em class="filename">mongod</em> will request that the <em class="filename">balancer </em> move each new top chunk evenly
      between the other shards, but the only chunks that the balancer can move
      are the nonjumbo chunks, so it will migrate all the small chunks off the
      hot shard.</p><p>Now all the shards will have roughly the same number of chunks,
      but all of <em class="filename">shard2</em> and <em class="filename">shard3</em>’s chunks will be less than 64 MB in
      size. And if jumbo chunks are being created, more and more of <em class="filename">shard1</em>’s chunks will be more than 64 MB in
      size. Thus, <em class="filename">shard1</em> will fill up a
      lot faster than the other two shards, even though the number of chunks
      is perfectly balanced between the three.</p><p>Thus, one of the indicators that you have jumbo chunk problems is
      that one shard’s size is growing much faster than the others. You can
      also look at the output of <code class="function">sh.status()</code> to see if you have jumbo
      chunks—they will be marked with the <code>jumbo</code> attribute:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">status</code><code class="p">()</code>
<code class="p">...</code>
    <code class="p">{</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">7</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> <code class="p">{</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">5</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">shard0001</code> 
    <code class="p">{</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">5</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> <code class="p">{</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">6</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">shard0001</code> <code class="nx">jumbo</code>
    <code class="p">{</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">6</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> <code class="p">{</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">7</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">shard0001</code> <code class="nx">jumbo</code>
    <code class="p">{</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">7</code> <code class="p">}</code> <code class="o">--&gt;&gt;</code> <code class="p">{</code> <code class="s2">"x"</code> <code class="o">:</code> <code class="mi">339</code> <code class="p">}</code> <code class="nx">on</code> <code class="o">:</code> <code class="nx">shard0001</code>
<code class="p">...</code></pre><p>You<a data-type="indexterm" data-primary="chunks" data-secondary="checking chunk size" id="idm45882338956568"/><a data-type="indexterm" data-primary="jumbo chunks" data-secondary="checking chunk size" id="idm45882338955704"/> can use the <code>dataSize</code>
      command<a data-type="indexterm" data-primary="dataSize command" id="idm45882338883288"/> to check chunk sizes. First, use the <em class="filename">config.chunks</em> collection to find the chunk
      ranges:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">use</code> <code class="nx">config</code>
<code class="o">&gt;</code> <code class="kd">var</code> <code class="nx">chunks</code> <code class="o">=</code> <code class="nx">db</code><code class="p">.</code><code class="nx">chunks</code><code class="p">.</code><code class="nx">find</code><code class="p">({</code><code class="s2">"ns"</code> <code class="o">:</code> <code class="s2">"acme.analytics"</code><code class="p">}).</code><code class="nx">toArray</code><code class="p">()</code></pre><p>Then<a data-type="indexterm" data-primary="jumbo chunks" data-secondary="finding" id="idm45882338866296"/> use these chunk ranges to find possible jumbo
      chunks:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">use</code> <code class="o">&lt;</code><code class="nx">dbName</code><code class="o">&gt;</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">runCommand</code><code class="p">({</code><code class="s2">"dataSize"</code> <code class="o">:</code> <code class="s2">"&lt;dbName.collName&gt;"</code><code class="p">,</code>
<code class="p">...</code> <code class="s2">"keyPattern"</code> <code class="o">:</code> <code class="p">{</code><code class="s2">"date"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">},</code> <code class="c1">// shard key</code>
<code class="p">...</code> <code class="s2">"min"</code> <code class="o">:</code> <code class="nx">chunks</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">min</code><code class="p">,</code> 
<code class="p">...</code> <code class="s2">"max"</code> <code class="o">:</code> <code class="nx">chunks</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">max</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"size"</code> <code class="o">:</code> <code class="mi">33567917</code><code class="p">,</code>
    <code class="s2">"numObjects"</code> <code class="o">:</code> <code class="mi">108942</code><code class="p">,</code>
    <code class="s2">"millis"</code> <code class="o">:</code> <code class="mi">634</code><code class="p">,</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541455552</code><code class="p">,</code> <code class="mi">10</code><code class="p">),</code>
    <code class="s2">"$clusterTime"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"clusterTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1541455552</code><code class="p">,</code> <code class="mi">10</code><code class="p">),</code>
        <code class="s2">"signature"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"hash"</code> <code class="o">:</code> <code class="nx">BinData</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</code><code class="p">),</code>
            <code class="s2">"keyId"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>Be careful, though—the <code>dataSize</code>
      command does have to scan the chunk’s data to figure out how big it is.
      If you can, narrow down your search by using your <span class="keep-together">knowledge</span> of your
      data: were jumbo chunks created on a certain date? For example, if July
      1 was a really busy day, look for chunks with that day in their shard
      key range.</p><div data-type="tip"><h6>Tip</h6><p>If you’re using GridFS and sharding by <code>"files_id"</code>, you can look at the <em class="filename">fs.files</em> collection to find a file’s
        size.</p></div><section data-type="sect3" data-pdf-bookmark="Distributing jumbo chunks"><div class="sect3" id="idm45882338624728"><h3>Distributing jumbo chunks</h3><p>To<a data-type="indexterm" data-primary="jumbo chunks" data-secondary="distributing" id="idm45882338623816"/> fix a cluster thrown off-balance by jumbo chunks, you
        must evenly distribute them among the shards.</p><p>This is a complex manual process, but should not cause any
        downtime (it may cause slowness, as you’ll be migrating a lot of
        data). In the following description, the shard with the jumbo chunks
        is referred to as the “from” shard. The shards that the jumbo chunks
        are migrated to are called the “to” shards. Note that you may have
        multiple “from” shards that you wish to move chunks off of. Repeat
        these steps for each:</p><ol><li><p>Turn off the balancer. You don’t want the balancer trying to
            “help” during this process:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">setBalancerState</code><code class="p">(</code><code class="kc">false</code><code class="p">)</code></pre></li><li><p>MongoDB will not allow you to move chunks larger than the
            max chunk size, so temporarily increase the chunk size. Make a
            note of what your original chunk size is and then change it to
            something large, like <code>10000</code>.
            Chunk size is specified in <span class="keep-together">megabytes</span>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">use</code> <code class="nx">config</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">settings</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"chunksize"</code><code class="p">})</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"chunksize"</code><code class="p">,</code> 
    <code class="s2">"value"</code> <code class="o">:</code> <code class="mi">64</code>
<code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">settings</code><code class="p">.</code><code class="nx">save</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"chunksize"</code><code class="p">,</code> <code class="s2">"value"</code> <code class="o">:</code> <code class="mi">10000</code><code class="p">})</code></pre></li><li><p>Use the <code>moveChunk</code> command
            to move jumbo chunks off the “from” shard.</p></li><li><p>Run <code>splitChunk</code> on the
            remaining chunks on the “from” shard until it has roughly the same
            number of chunks as the “to” shards.</p></li><li><p>Set the chunk size back to its original value:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">settings</code><code class="p">.</code><code class="nx">save</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"chunksize"</code><code class="p">,</code> <code class="s2">"value"</code> <code class="o">:</code> <code class="mi">64</code><code class="p">})</code></pre></li><li><p>Turn on the balancer:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">sh</code><code class="p">.</code><code class="nx">setBalancerState</code><code class="p">(</code><code class="kc">true</code><code class="p">)</code></pre></li></ol><p>When the balancer is turned on again, it will once again be
        unable to move the jumbo chunks; they are essentially held in place by
        their size.</p></div></section><section data-type="sect3" data-pdf-bookmark="Preventing jumbo chunks"><div class="sect3" id="idm45882338510296"><h3>Preventing jumbo chunks</h3><p>As<a data-type="indexterm" data-primary="jumbo chunks" data-secondary="preventing" id="idm45882338509416"/> the amount of data you are storing grows, the manual
        process described in the previous section becomes unsustainable. Thus,
        if you’re having problems with jumbo chunks, you should make it a
        priority to prevent them from forming.</p><p>To prevent jumbo chunks, modify your shard key to have more
        granularity. You want almost every document to have a unique value for
        the shard key, or at least to never have more than the chunk size’s
        worth of data with a single shard key value.</p><p>For example, if you were using the year/month/day key described
        earlier, it could quickly be made more fine-grained by adding hours,
        minutes, and seconds. Similarly, if you’re sharding on something
        coarse-grained like log level, you can add to your shard key a second
        field with a lot of granularity, such as an MD5 hash or UUID. Then you
        can always split a chunk, even if the first field is the same for
        many<a data-type="indexterm" data-startref="Cjumbo17" id="idm45882338505368"/><a data-type="indexterm" data-startref="SAObjumbo17" id="idm45882338504536"/> <span class="keep-together">documents</span>.</p></div></section></div></section><section data-type="sect2" data-pdf-bookmark="Refreshing Configurations"><div class="sect2" id="idm45882339276840"><h2>Refreshing Configurations</h2><p>As<a data-type="indexterm" data-primary="sharding, administration of" data-secondary="refreshing configurations" id="idm45882338437640"/> a final tip, sometimes <em class="filename">mongos</em> will not update its configuration
      correctly from the config servers. If you ever get a configuration that
      you don’t expect or a <em class="filename">mongos</em> seems
      to be out of date or cannot find data that you know is there, use the
      <code>flushRouterConfig</code> command<a data-type="indexterm" data-primary="flushRouterConfig command" id="idm45882338434376"/> to manually clear all caches:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"flushRouterConfig"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><p>If <code>flushRouterConfig</code> does not
      work, restarting all your <em class="filename">mongos</em> or
      <em class="filename">mongod</em> processes clears any
      cached<a data-type="indexterm" data-startref="ASbalance17" id="idm45882338414104"/><a data-type="indexterm" data-startref="Dbalance17" id="idm45882338413272"/> data.</p></div></section></div></section><div data-type="footnotes"><p data-type="footnote" id="idm45882339279480"><sup><a href="ch17.xhtml#idm45882339279480-marker">1</a></sup> MongoDB 4.4 is planning to add a new parameter
          (<code>forceJumbo</code>) in the <code>moveChunk</code>
          function, as well as a new balancer configuration setting
          <code>attemptToBalanceJumboChunks</code> to address jumbo
          chunks. The details are in <a href="https://jira.mongodb.org/browse/SERVER-42273">this JIRA ticket
          describing the work</a>.</p></div></div></section></div>



  </body></html>