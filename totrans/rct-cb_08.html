<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 8. Testing" class="calibre4"><div class="preface" id="chapter08">
<h1 class="calibre9"><span class="label">Chapter 8. </span>Testing</h1>


<p class="author1">In this chapter, we’ll look at various techniques for testing your React applications. <a data-type="indexterm" data-primary="testing" id="ix_tstng" class="calibre6"/>In general, we’ve found that it is a bad idea
to be too prescriptive about the precise mix of tests you should have. A good guiding principle is to follow these two rules:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">Never write code unless you have a failing test.</p>
</li>
<li class="calibre8">
<p class="author1">If a test passes the first time you run it, delete it.</p>
</li>
</ul>

<p class="author1">These two rules will help you build code that works while avoiding creating redundant tests that provide little value.</p>

<p class="author1">We have found that early in a project, it is easier to write more browser-based tests.<a data-type="indexterm" data-primary="browsers" data-secondary="tests, browser-based" id="idm46634398016568" class="calibre6"/> These tests tend to be higher-level and help
capture the principal business requirements for an application. Later, when the application’s architecture starts to emerge and
stabilize, it becomes easier to write more unit tests of individual components. They are faster to write and quicker to run, and once
you have a stable structure to your code, you will not need to update them continuously.</p>

<p class="author1">Sometimes it’s worth <a data-type="indexterm" data-primary="testing" data-secondary="loosening defiinition of test" id="idm46634398014664" class="calibre6"/>loosening the definition of what a test <em class="calibre7">is</em>. When you are working on layout code, whose primary value is
visual, you might consider a Storybook story to be a “test.” The assertion is done by your eye, looking at the component as you
create. Of course, this kind of test will not automatically pick up regression failures, but we present a technique in a recipe that
will allow you to turn these visual checks into actual automated tests.</p>

<p class="author1">If you write tests <em class="calibre7">before</em> you write code, you will find that tests are tools for design. They will become executable examples of
how you would like your application to work.</p>

<p class="author1">Instead, if you write tests <em class="calibre7">after</em> you write the code, they will be simply artifacts. Pieces of code that you must slavishly create
because they feel like the sorts of things a professional developer should write.</p>

<p class="author1">We focus on four tools in this chapter: the React Testing Library, Storybook, the Selenium library, and Cypress.</p>

<p class="author1">The React Testing Library is an excellent way of creating very detailed unit tests.</p>

<p class="author1">Storybook is a gallery tool that we have looked at previously. We include it in this chapter because a gallery is a set of code
examples, which is also what tests are.<a data-type="indexterm" data-primary="Storybook" id="idm46634397992760" class="calibre6"/> You will find ways of using Storybook as part of your testing/development process.</p>

<p class="author1">Selenium is one of the most established libraries for testing your application in a real browser.<a data-type="indexterm" data-primary="Selenium library" id="idm46634397991464" class="calibre6"/></p>

<p class="author1">Finally, what is quickly becoming our favorite tool for testing: Cypress. Cypress is similar to Selenium in that it runs inside a
browser.<a data-type="indexterm" data-primary="Cypress" id="idm46634397990216" class="calibre6"/> But it includes a whole host of additional features, such as test replays, generated videos of test runnings, and a
significantly simpler programming model. If you use only one tool from this chapter, let it be Cypress.</p>






<section data-type="sect1" data-pdf-bookmark="Use the React Testing Library" class="calibre4"><div class="preface" id="ch08-01">
<h1 class="calibre17">Use the React Testing Library</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634397987592">
<h2 class="calibre27">Problem</h2>

<p class="author1">There are many ways that you can test a React application.<a data-type="indexterm" data-primary="testing" data-secondary="using React Testing library" id="ix_tstngReTst" class="calibre6"/><a data-type="indexterm" data-primary="React Testing library" id="ix_ReTst" class="calibre6"/> Early on in a project, when you are still defining an application’s
essential purpose and function, you might choose to create tests in some very high-level form, such as <a href="https://cucumber.io" class="calibre6">Cucumber tests</a>. <a data-type="indexterm" data-primary="Cucumber tests" id="idm46634397982952" class="calibre6"/>If you are looking at some isolated piece of the system (such as creating and maintaining a data item), you might want to
create functional tests using a tool like Cypress.</p>

<p class="author1">But if you are deep into the detail of creating a single component, then you will probably want to create unit tests.<a data-type="indexterm" data-primary="unit tests" id="ix_unitt" class="calibre6"/> <em class="calibre7">Unit tests</em>
are so-called because they attempt to test a single piece of code as an isolated unit. While it’s debatable whether <em class="calibre7">unit test</em> is
the correct term for testing components (which often contain subcomponents and so are not isolated), it’s the name usually applied
to tests of components that you can test outside of a browser.</p>

<p class="author1">But how do you unit test React components? There have historically been several approaches.<a data-type="indexterm" data-primary="unit tests" data-secondary="early approaches" id="idm46634397978584" class="calibre6"/> Early unit tests relied on rendering the
component into an HTML string, which required minimal testing infrastructure, but there were multiple downsides:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">Handling re-renders when the component state changed.</p>
</li>
<li class="calibre8">
<p class="author1">Making assertions on HTML elements that the test must parse from the string.</p>
</li>
<li class="calibre8">
<p class="author1">To test UI interactions, you need to mock the event model.</p>
</li>
</ul>

<p class="author1">It was not long before developers created libraries to take care of the details of each of these problems.</p>

<p class="author1">However, tests created in this way lacked the reality of tests created in browsers. <a data-type="indexterm" data-primary="virtual DOM" data-secondary="interaction between browser DOM and" id="idm46634397973272" class="calibre6"/>The subtleties of the interaction between the
virtual <em class="calibre7">Document Object Model</em> (DOM) and the browser DOM were lost.<a data-type="indexterm" data-primary="DOM" data-secondary="interaction between virtual DOM and browser DOM" id="idm46634397971704" class="calibre6"/> Often subcomponents were not rendered to reduce the complexity
of the tests.<a data-type="indexterm" data-primary="Document Object Model" data-see="DOM" id="idm46634397970504" class="calibre6"/></p>

<p class="author1">The result was that React applications often had few unit tests. Developers would refactor their code to move complex logic
into easily testable JavaScript functions. Developers would have to test anything more complex with a real browser, leading to
slower tests. Because they were slow, developers would be discouraged from testing too many scenarios.</p>

<p class="author1">So how can you unit test React components realistically without the overhead of launching the entire app and running the tests in a
real browser?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634397968104">
<h2 class="calibre27">Solution</h2>

<p class="author1">The Testing Library by Kent C. Dodds attempts to avoid the issues with previous unit testing libraries by providing a standalone
implementation of the DOM.<a data-type="indexterm" data-primary="HTML elements" data-secondary="finding using Testing library" id="ix_HTMLelfnd" class="calibre6"/><a data-type="indexterm" data-primary="DOM" data-secondary="standalone implementation for unit tests in React Testing library" id="idm46634397964040" class="calibre6"/> As a result, tests can render a React component to a virtual DOM, which can then be
synchronized with the Testing Library’s DOM and create a tree of HTML elements that behave like they would in a real browser.</p>

<p class="author1">You can inspect the elements in the same way that you would within a browser. They have the same attributes and properties. You can
even pass keystrokes to <code class="calibre21">input</code> fields and have them behave the same way as fields in the browser.</p>

<p class="author1">If you created your application with <code class="calibre21">create-react-app</code>, you should already have the Testing Library installed.<a data-type="indexterm" data-primary="Jest testing library" id="idm46634397960792" class="calibre6"/> If not, you can
install it from the command line:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install --save-dev "@testing-library/react"</code>
<code class="go">$ npm install --save-dev "@testing-library/jest-dom"</code>
<code class="go">$ npm install --save-dev "@testing-library/user-event"</code></pre>

<p class="author1">These three libraries will allow us to unit test components.</p>

<p class="author1">The Testing Library allows us to render components using the DOM implementation in <code class="calibre21">@testing-library/jest-dom</code>. <a data-type="indexterm" data-primary="User Event library" id="idm46634397941384" class="calibre6"/>The User Event
library (<code class="calibre21">@testing-library/user-event</code>) simplifies interacting with the generated DOM elements. This User Event library allows us to
click the buttons and type into the fields of our components.</p>

<p class="author1">To show how to unit test components, we will need an application to test. We’ll be using the same application through much of this
chapter. When the application opens, it asks the user to perform a simple calculation. The application will say if the user’s answer
is right or wrong (see <a data-type="xref" href="ch08_split_000.xhtml#ch08_image_1" class="calibre6">Figure 8-1</a>).</p>

<figure class="calibre29"><div id="ch08_image_1" class="figure">
<img src="Images/recb_0801.png" alt="" class="calibre133"/>
<h6 class="calibre30"><span class="firstname">Figure 8-1. </span>The application under test</h6>
</div></figure>

<p class="author1">The main component of the application is called <code class="calibre21">App</code>. We can create a unit test for this component by writing a new file called
<em class="calibre7">App.test.js</em>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'App'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell you when you win'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given we've rendered the app</code>
    <code class="c">// When we enter the correct answer</code>
    <code class="c">// Then we are told that we've won</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">The preceding code is a Jest test, with a single scenario that tests that the <code class="calibre21">App</code> component will tell us we’ve won if we enter the
correct answer. We’ve put placeholder comments for the structure of the test.</p>

<p class="author1">We will begin by rendering the <code class="calibre21">App</code> component. We can do this by importing the component and passing it to the Testing Library’s
<code class="calibre21">render</code> function:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">render</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@testing-library/react'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'./App'</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'App'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell you when you win'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given we've rendered the app</code>
    <code class="nx">render</code><code class="go">(&lt;</code><code class="nt">App</code> <code class="go">/&gt;)</code>

    <code class="c">// When we enter the correct answer</code>
    <code class="c">// Then we are told that we've won</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">Notice that we pass actual <em class="calibre7">JSX</em> to the <code class="calibre21">render</code> function, which means that we could, if we wanted, test the component’s behavior
when passed different sets of properties.<a data-type="indexterm" data-primary="JSX" data-secondary="passed to render function" id="idm46634397844216" class="calibre6"/><a data-type="indexterm" data-primary="render function" data-secondary="JSX passed to" id="idm46634397843240" class="calibre6"/></p>

<p class="author1">For the next part of the test, we’ll need to enter the correct answer. To do that, we must first know what the correct answer is.
The puzzle is always a randomly generated multiplication, so we can capture the numbers from the page and then type the product into
the <code class="calibre21">Guess</code> field.<sup class="calibre34"><a data-type="noteref" id="idm46634397841208-marker" href="ch08_split_001.xhtml#idm46634397841208" class="calibre35">1</a></sup></p>

<p class="author1">We will need to look at the elements generated by the <code class="calibre21">App</code> component. The <code class="calibre21">render</code> function returns an object that contains the
elements and a set of functions for filtering them. Instead of using this returned value, we’ll instead use the Testing Library’s
<code class="calibre21">screen</code> object.<a data-type="indexterm" data-primary="screen object" id="idm46634397838552" class="calibre6"/></p>

<p class="author1">You can think of the <code class="calibre21">screen</code> object as the contents of the browser window. It allows us to find elements within the page so that we
can interact with them. For example, if we want to find the input field labeled <code class="calibre21">Guess</code>, we can do it like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByLabelText</code><code class="go">(</code><code class="sr">/guess:/i</code><code class="go">)</code></pre>

<p class="author1">The filter methods <a data-type="indexterm" data-primary="screen object" data-secondary="filter methods" id="idm46634397775432" class="calibre6"/><a data-type="indexterm" data-primary="filter methods, screen object" id="idm46634397774584" class="calibre6"/>in the <code class="calibre21">screen</code> object typically begin with:</p>
<dl class="calibre18">
<dt class="calibre19"><code class="calibre21">getBy...</code></dt>
<dd class="calibre20">
<p class="author1">If you know that the DOM contains a single instance of the matching element</p>
</dd>
<dt class="calibre19"><code class="calibre21">queryBy...</code></dt>
<dd class="calibre20">
<p class="author1">If you know there are zero or one elements that match</p>
</dd>
<dt class="calibre19"><code class="calibre21">getAllBy...</code></dt>
<dd class="calibre20">
<p class="author1">If you know there are one or more matching elements (returns an array)</p>
</dd>
<dt class="calibre19"><code class="calibre21">queryAllBy...</code></dt>
<dd class="calibre20">
<p class="author1">To find zero or more elements (returns an array)</p>
</dd>
</dl>

<p class="author1">These methods will throw an exception if they find more or fewer elements than they were expecting. There are also <code class="calibre21">findBy...</code> and
<code class="calibre21">findAllBy...</code> methods that are asynchronous versions of <code class="calibre21">getBy...</code> and <code class="calibre21">getAllBy...</code> that return promises.</p>

<p class="author1">For each of these filter method types, you can search the following:</p>
<table class="calibre10">

<thead class="calibre11">
<tr class="calibre12">
<th class="calibre13">Function name ends</th>
<th class="calibre13">Description</th>
</tr>
</thead>
<tbody class="calibre14">
<tr class="calibre12">
<td class="calibre15"><p class="author1"><code class="calibre47">...ByLabelText</code></p></td>
<td class="calibre15"><p class="author1">Finds field by label</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1"><code class="calibre47">...ByPlaceHolderText</code></p></td>
<td class="calibre15"><p class="author1">Finds field with placeholder text</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1"><code class="calibre47">...ByText</code></p></td>
<td class="calibre15"><p class="author1">With matching text content</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1"><code class="calibre47">...ByDisplayValue</code></p></td>
<td class="calibre15"><p class="author1">Finds by value</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1"><code class="calibre47">...ByAltText</code></p></td>
<td class="calibre15"><p class="author1">Matching the alt attribute</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1"><code class="calibre47">...ByTitle</code></p></td>
<td class="calibre15"><p class="author1">Matching the title attribute</p></td>
</tr>
<tr class="calibre12">
<td class="calibre15"><p class="author1"><code class="calibre47">...ByRole</code></p></td>
<td class="calibre15"><p class="author1">Finds by aria role</p></td>
</tr>
<tr class="calibre16">
<td class="calibre15"><p class="author1"><code class="calibre47">...ByTestId</code></p></td>
<td class="calibre15"><p class="author1">Finds by data-testid attribute</p></td>
</tr>
</tbody>
</table>

<p class="author1">There are nearly 50 ways to find elements within the page. However, you might have noticed that <em class="calibre7">none</em> of them use a CSS selector to
track an element down, which is deliberate. The Testing Library restricts the number of ways that you can find elements within the
DOM. It doesn’t allow you to, for example, find elements by class name to reduce the fragility of the test. Class names are
frequently used for cosmetic styling and are subject to frequent change.</p>

<p class="author1">It is still possible to track down elements with selectors, by using the <code class="calibre21">container</code> returned by the render method:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="go">{</code> <code class="nx">container</code> <code class="go">}</code> <code class="o">=</code> <code class="nx">render</code><code class="go">(&lt;</code><code class="nt">App</code> <code class="go">/&gt;)</code>
<code class="kr">const</code> <code class="nx">theInput</code> <code class="o">=</code> <code class="nx">container</code><code class="go">.</code><code class="nx">querySelector</code><code class="go">(</code><code class="s">'#guess'</code><code class="go">)</code></pre>

<p class="author1">But this approach is considered poor practice. If you use the Testing Library, it’s probably best to follow the standard approach
and find elements based upon their content or role.</p>

<p class="author1">There is one small concession to this approach made by the filter functions: the <code class="calibre21">...ByTestId</code> functions. If you have no practical
way of finding an element by its content, you can always add a <code class="calibre21">data-testid</code> attribute to the relevant tag. That is useful for the
test we are currently writing because we need to find two numbers displayed on the page. And these numbers are randomly generated,
so we don’t know their content (<a data-type="xref" href="ch08_split_000.xhtml#ch08_image_2" class="calibre6">Figure 8-2</a>).</p>

<figure class="calibre29"><div id="ch08_image_2" class="figure">
<img src="Images/recb_0802.png" alt="" class="calibre134"/>
<h6 class="calibre30"><span class="firstname">Figure 8-2. </span>We cannot find the numbers by content because we won’t know what they are</h6>
</div></figure>

<p class="author1">So, we make a small amendment to the code and add test IDs:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Question-detail"</code><code class="go">&gt;</code>
  <code class="go">&lt;</code><code class="nt">div</code> <code class="na">data</code><code class="err">-</code><code class="na">testid</code><code class="o">=</code><code class="s">"number1"</code> <code class="na">className</code><code class="o">=</code><code class="s">"number1"</code><code class="go">&gt;</code>
    <code class="go">{</code><code class="nx">pair</code> <code class="o">&amp;&amp;</code> <code class="nx">pair</code><code class="go">[</code><code class="mi">0</code><code class="go">]}</code>
  <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="o">&amp;</code><code class="nx">times</code><code class="go">;</code>
  <code class="go">&lt;</code><code class="nt">div</code> <code class="na">data</code><code class="err">-</code><code class="na">testid</code><code class="o">=</code><code class="s">"number2"</code> <code class="na">className</code><code class="o">=</code><code class="s">"number2"</code><code class="go">&gt;</code>
    <code class="go">{</code><code class="nx">pair</code> <code class="o">&amp;&amp;</code> <code class="nx">pair</code><code class="go">[</code><code class="mi">1</code><code class="go">]}</code>
  <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="o">?</code>
<code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code></pre>

<p class="author1">This means we can start to implement the next part of our test:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">render</code><code class="go">,</code> <code class="nx">screen</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@testing-library/react'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'./App'</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'App'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell you when you win'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given we've rendered the app</code>
    <code class="nx">render</code><code class="go">(&lt;</code><code class="nt">App</code> <code class="go">/&gt;)</code>

    <code class="c">// When we enter the correct answer</code>
    <code class="kr">const</code> <code class="nx">number1</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByTestId</code><code class="go">(</code><code class="s">'number1'</code><code class="go">).</code><code class="nx">textContent</code>
    <code class="kr">const</code> <code class="nx">number2</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByTestId</code><code class="go">(</code><code class="s">'number2'</code><code class="go">).</code><code class="nx">textContent</code>
    <code class="kr">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByLabelText</code><code class="go">(</code><code class="sr">/guess:/i</code><code class="go">)</code>
    <code class="kr">const</code> <code class="nx">submitButton</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByText</code><code class="go">(</code><code class="s">'Submit'</code><code class="go">)</code>
    <code class="c">// Err...</code>

    <code class="c">// Then we are told that we've won</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">We have the text for each of the numbers, and we have the <code class="calibre21">input</code> element. We now need to type the correct number into the field and
then submit the answer. We’ll do this with the <code class="calibre21">@testing-library/user-event</code> library. <a data-type="indexterm" data-primary="User Event library" data-secondary="simplifying generation of JavaScript events for HTML elements" id="idm46634397520008" class="calibre6"/>The User Event library 
<span class="firstname">simplifies</span> the process
of generating JavaScript events for HTML elements. You will often see the User Event library imported with the alias <code class="calibre21">user</code>, which
is because you can think of the calls to the User Event library as the actions a user is making:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">render</code><code class="go">,</code> <code class="nx">screen</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@testing-library/react'</code>
<code class="kr">import</code> <code class="nx">user</code> <code class="nx">from</code> <code class="s">'@testing-library/user-event'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'./App'</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'App'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell you when you win'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given we've rendered the app</code>
    <code class="nx">render</code><code class="go">(&lt;</code><code class="nt">App</code> <code class="go">/&gt;)</code>

    <code class="c">// When we enter the correct answer</code>
    <code class="kr">const</code> <code class="nx">number1</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByTestId</code><code class="go">(</code><code class="s">'number1'</code><code class="go">).</code><code class="nx">textContent</code>
    <code class="kr">const</code> <code class="nx">number2</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByTestId</code><code class="go">(</code><code class="s">'number2'</code><code class="go">).</code><code class="nx">textContent</code>
    <code class="kr">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByLabelText</code><code class="go">(</code><code class="sr">/guess:/i</code><code class="go">)</code>
    <code class="kr">const</code> <code class="nx">submitButton</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByText</code><code class="go">(</code><code class="s">'Submit'</code><code class="go">)</code>
    <code class="nx">user</code><code class="go">.</code><code class="nx">type</code><code class="go">(</code><code class="nx">input</code><code class="go">,</code> <code class="s">''</code> <code class="o">+</code> <code class="nb">parseFloat</code><code class="go">(</code><code class="nx">number1</code><code class="go">)</code> <code class="o">*</code> <code class="nb">parseFloat</code><code class="go">(</code><code class="nx">number2</code><code class="go">))</code>
    <code class="nx">user</code><code class="go">.</code><code class="nx">click</code><code class="go">(</code><code class="nx">submitButton</code><code class="go">)</code>

    <code class="c">// Then we are told that we've won</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">Finally, we need to assert that we have won. We can write this simply by looking for some element containing the word
<em class="calibre7">won</em>:<sup class="calibre34"><a data-type="noteref" id="idm46634397514504-marker" href="ch08_split_001.xhtml#idm46634397514504" class="calibre35">2</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="c">// Then we are told that we've won</code>
<code class="nx">screen</code><code class="go">.</code><code class="nx">getByText</code><code class="go">(</code><code class="sr">/won/i</code><code class="go">)</code></pre>

<p class="author1">This assertion will work because <code class="calibre21">getByText</code> throws an exception if it does not find precisely one matching element.</p>
<div data-type="tip" class="calibre25">
<p class="author1">If you are unsure about the current HTML state at some point in a test, try adding <code class="calibre21">screen.getByTestId('NONEXISTENT')</code> into the
code. The exception that’s thrown will show you the current HTML.</p>
</div>

<p class="author1">However, the test is liable to break if your application is running slowly. This is because the <code class="calibre21">get...</code> and <code class="calibre21">query...</code> functions look
at the existing state of the DOM. If the result takes a couple of seconds to appear, the assertion will fail. For this reason, it’s
a good idea to make some assertions asynchronous. It makes the code a little more complex, but the test will be more stable when
running against slow-moving code.</p>

<p class="author1">The <code class="calibre21">find...</code> methods are asynchronous versions of the <code class="calibre21">get...</code> methods, and the Testing Library’s <code class="calibre21">waitFor</code> will allow you to
rerun code for a period of time. By combining the two functions, we can create the final part of our test:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">render</code><code class="go">,</code> <code class="nx">screen</code><code class="go">,</code> <code class="nx">waitFor</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@testing-library/react'</code>
<code class="kr">import</code> <code class="nx">user</code> <code class="nx">from</code> <code class="s">'@testing-library/user-event'</code>
<code class="kr">import</code> <code class="nx">App</code> <code class="nx">from</code> <code class="s">'./App'</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'App'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell you when you win'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given we've rendered the app</code>
    <code class="nx">render</code><code class="go">(&lt;</code><code class="nt">App</code> <code class="go">/&gt;)</code>

    <code class="c">// When we enter the correct answer</code>
    <code class="kr">const</code> <code class="nx">number1</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByTestId</code><code class="go">(</code><code class="s">'number1'</code><code class="go">).</code><code class="nx">textContent</code>
    <code class="kr">const</code> <code class="nx">number2</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByTestId</code><code class="go">(</code><code class="s">'number2'</code><code class="go">).</code><code class="nx">textContent</code>
    <code class="kr">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByLabelText</code><code class="go">(</code><code class="sr">/guess:/i</code><code class="go">)</code>
    <code class="kr">const</code> <code class="nx">submitButton</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByText</code><code class="go">(</code><code class="s">'Submit'</code><code class="go">)</code>
    <code class="nx">user</code><code class="go">.</code><code class="nx">type</code><code class="go">(</code><code class="nx">input</code><code class="go">,</code> <code class="s">''</code> <code class="o">+</code> <code class="nb">parseFloat</code><code class="go">(</code><code class="nx">number1</code><code class="go">)</code> <code class="o">*</code> <code class="nb">parseFloat</code><code class="go">(</code><code class="nx">number2</code><code class="go">))</code>
    <code class="nx">user</code><code class="go">.</code><code class="nx">click</code><code class="go">(</code><code class="nx">submitButton</code><code class="go">)</code>

    <code class="c">// Then we are told that we've won</code>
    <code class="nx">await</code> <code class="nx">waitFor</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">findByText</code><code class="go">(</code><code class="sr">/won/i</code><code class="go">),</code> <code class="go">{</code> <code class="nx">timeout</code><code class="o">:</code> <code class="mi">4000</code> <code class="go">})</code>
  <code class="go">})</code>
<code class="go">})</code></pre>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">Unit tests should run quickly, but if for some reason your test takes longer than five seconds, you will need to pass a second
<code class="calibre21">timeout</code> value in milliseconds to the <code class="calibre21">it</code> function.<a data-type="indexterm" data-primary="HTML elements" data-secondary="finding using Testing library" data-startref="ix_HTMLelfnd" id="idm46634397376392" class="calibre6"/></p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634397966552">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Working with different teams, we found that early on in a project, the developers would write unit tests for each component. But
over time, they would write fewer and fewer unit tests. Eventually, they might even delete unit tests if they required too much
maintenance.</p>

<p class="author1">This happens partly because unit tests are more abstract than browser tests. They are doing the same kinds of things as browser
tests, but they do them invisibly. When they are interacting with components, you don’t <em class="calibre7">see</em> them.</p>

<p class="author1">A second reason is that teams often see tests as deliverable artifacts within a project. The team might even have builds that fail
if unit tests don’t cover a certain percentage of the code.</p>

<p class="author1">These issues generally disappear if developers write tests <em class="calibre7">before</em> they write code. If you write the tests first, a line at a time,
you will have a much better grasp of the current state of HTML. If you stop seeing tests as development artifacts and start to look
at them as tools for designing your code, they stop becoming a time-consuming burden and become tools that make your work easier.</p>

<p class="author1">The important thing when writing code is that you begin with a failing test. In the early days of a project, that might be a failing
browser test. As the project matures and the architecture stabilizes, you should create more and more unit tests.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/P1Tqj" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="unit tests" data-startref="ix_unitt" id="idm46634397171128" class="calibre6"/><a data-type="indexterm" data-primary="testing" data-secondary="using React Testing library" data-startref="ix_tstngReTst" id="idm46634397170120" class="calibre6"/><a data-type="indexterm" data-primary="React Testing library" data-startref="ix_ReTst" id="idm46634397168888" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Use Storybook for Render Tests" class="calibre4"><div class="preface" id="ch08-02">
<div class="calibre43" id="calibre_pb_0"/>
</div></section>













</div></section></div>

<div id="sbo-rt-content" class="calibre1">
<section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 8. Testing" class="calibre4">
<div class="preface" id="chapter08">
<section data-type="sect1" data-pdf-bookmark="Use Storybook for Render Tests" class="calibre4">
<div class="preface" id="ch08-02">
<h1 class="calibre17">Use Storybook for Render Tests</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634397166392">
<h2 class="calibre27">Problem</h2>

<p class="author1">Tests are simply examples that you can execute. Consequently, tests have a lot in common with component gallery systems like
Storybook.<a data-type="indexterm" data-primary="Storybook" data-secondary="similarities and differences between galleries and tests" id="idm46634397164920" class="calibre6"/> Both tests and galleries are examples of components running in particular circumstances. Whereas a test will make
assertions with code, a developer will make an <em class="calibre7">assertion</em> of a library example by looking at it and checking that it appears as
expected. In both galleries and tests, exceptions will be easily visible.</p>

<p class="author1">There are differences. Tests can automatically interact with components; gallery components require a person to press buttons and
type text. Developers can run tests with a single command; galleries have to be manually viewed, one example at a time. Gallery
components are visual and easy to understand; tests are abstract and less fun to create.</p>

<p class="author1">Is there some way to combine galleries like Storybook with automated tests to get the best of both worlds?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634397161544">
<h2 class="calibre27">Solution</h2>

<p class="author1">We’re going to look at how you can reuse your Storybook stories inside tests. You can install <a data-type="indexterm" data-primary="Storybook" data-secondary="reusing stories inside tests" id="ix_Stryretst" class="calibre6"/>Storybook into your application with
this command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npx sb init</code></pre>

<p class="author1">The example application in this chapter is a simple mathematical game in which the user needs to calculate the answer to a
multiplication problem (see <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_3" class="calibre6">Figure 8-3</a>).</p>

<figure class="calibre29"><div id="ch08_image_3" class="figure">
<img src="Images/recb_0802.png" alt="" class="calibre134"/>
<h6 class="calibre30"><span class="firstname">Figure 8-3. </span>The example application</h6>
</div></figure>

<p class="author1">One of the components in the game is called <code class="calibre21">Question</code>, and it displays a randomly generated multiplication question (<a data-type="xref" href="ch08_split_001.xhtml#ch08_image_4" class="calibre6">Figure 8-4</a>).</p>

<figure class="calibre29"><div id="ch08_image_4" class="figure">
<img src="Images/recb_0804.png" alt="" class="calibre135"/>
<h6 class="calibre30"><span class="firstname">Figure 8-4. </span>The Question component</h6>
</div></figure>

<p class="author1">Let’s say we don’t worry too much about tests for this component. Let’s just build it by creating some Storybook stories. We’ll
write a new <em class="calibre7">Question.stories.js</em> file:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">Question</code> <code class="nx">from</code> <code class="s">'./Question'</code>

<code class="kr">const</code> <code class="nx">Info</code> <code class="o">=</code> <code class="go">{</code>
  <code class="nx">title</code><code class="o">:</code> <code class="s">'Question'</code><code class="go">,</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Info</code>

<code class="kr">export</code> <code class="kr">const</code> <code class="nx">Basic</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">&lt;</code><code class="nt">Question</code> <code class="go">/&gt;</code></pre>

<p class="author1">And then we’ll create an initial version of the component that we can look at in Storybook and be happy with:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="s">'./Question.css'</code>

<code class="kr">const</code> <code class="nx">RANGE</code> <code class="o">=</code> <code class="mi">10</code>

<code class="kr">function</code> <code class="nx">rand</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">return</code> <code class="nb">Math</code><code class="go">.</code><code class="nx">floor</code><code class="go">(</code><code class="nb">Math</code><code class="go">.</code><code class="nx">random</code><code class="go">()</code> <code class="o">*</code> <code class="nx">RANGE</code> <code class="o">+</code> <code class="mi">1</code><code class="go">)</code>
<code class="go">}</code>

<code class="kr">const</code> <code class="nx">Question</code> <code class="o">=</code> <code class="go">({</code> <code class="nx">refreshTime</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">pair</code><code class="go">,</code> <code class="nx">setPair</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="kr">const</code> <code class="nx">refresh</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">setPair</code><code class="go">((</code><code class="nx">pair</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">return</code> <code class="go">[</code><code class="nx">rand</code><code class="go">(),</code> <code class="nx">rand</code><code class="go">()]</code>
    <code class="go">})</code>
  <code class="go">}</code>

  <code class="nx">useEffect</code><code class="go">(</code><code class="nx">refresh</code><code class="go">,</code> <code class="go">[</code><code class="nx">refreshTime</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Question"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Question-detail"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">data</code><code class="err">-</code><code class="na">testid</code><code class="o">=</code><code class="s">"number1"</code> <code class="na">className</code><code class="o">=</code><code class="s">"number1"</code><code class="go">&gt;</code>
          <code class="go">{</code><code class="nx">pair</code> <code class="o">&amp;&amp;</code> <code class="nx">pair</code><code class="go">[</code><code class="mi">0</code><code class="go">]}</code>
        <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="o">&amp;</code><code class="nx">times</code><code class="go">;</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">data</code><code class="err">-</code><code class="na">testid</code><code class="o">=</code><code class="s">"number2"</code> <code class="na">className</code><code class="o">=</code><code class="s">"number2"</code><code class="go">&gt;</code>
          <code class="go">{</code><code class="nx">pair</code> <code class="o">&amp;&amp;</code> <code class="nx">pair</code><code class="go">[</code><code class="mi">1</code><code class="go">]}</code>
        <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="o">?</code>
      <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{</code><code class="nx">refresh</code><code class="go">}&gt;</code><code class="nx">Refresh</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Question</code></pre>

<p class="author1">This component displays a randomly generated question if the user clicks the Refresh button or if a parent component passes in a new
<code class="calibre21">refreshTime</code> value.</p>

<p class="author1">We display the component in Storybook, and it looks like it works fine. We can click the Refresh button, and it refreshes. So at
that point, we start to use the component in the main application. After a while, we add a few extra features, but none of them are
visual changes, so we don’t look at the Storybook stories for it again. After all, it will still look the same. Right?</p>

<p class="author1">This is a modified version of the component, after we’ve wired it into the rest of the application:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="s">'./Question.css'</code>

<code class="kr">const</code> <code class="nx">RANGE</code> <code class="o">=</code> <code class="mi">10</code>

<code class="kr">function</code> <code class="nx">rand</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">return</code> <code class="nb">Math</code><code class="go">.</code><code class="nx">floor</code><code class="go">(</code><code class="nb">Math</code><code class="go">.</code><code class="nx">random</code><code class="go">()</code> <code class="o">*</code> <code class="nx">RANGE</code> <code class="o">+</code> <code class="mi">1</code><code class="go">)</code>
<code class="go">}</code>

<code class="kr">const</code> <code class="nx">Question</code> <code class="o">=</code> <code class="go">({</code> <code class="nx">onAnswer</code><code class="go">,</code> <code class="nx">refreshTime</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">pair</code><code class="go">,</code> <code class="nx">setPair</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
  <code class="kr">const</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">pair</code> <code class="o">&amp;&amp;</code> <code class="nx">pair</code><code class="go">[</code><code class="mi">0</code><code class="go">]</code> <code class="o">*</code> <code class="nx">pair</code><code class="go">[</code><code class="mi">1</code><code class="go">]</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">onAnswer</code><code class="go">(</code><code class="nx">result</code><code class="go">)</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">onAnswer</code><code class="go">,</code> <code class="nx">result</code><code class="go">])</code>

  <code class="kr">const</code> <code class="nx">refresh</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">setPair</code><code class="go">((</code><code class="nx">pair</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">return</code> <code class="go">[</code><code class="nx">rand</code><code class="go">(),</code> <code class="nx">rand</code><code class="go">()]</code>
    <code class="go">})</code>
  <code class="go">}</code>

  <code class="nx">useEffect</code><code class="go">(</code><code class="nx">refresh</code><code class="go">,</code> <code class="go">[</code><code class="nx">refreshTime</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Question"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"Question-detail"</code><code class="go">&gt;</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">data</code><code class="err">-</code><code class="na">testid</code><code class="o">=</code><code class="s">"number1"</code> <code class="na">className</code><code class="o">=</code><code class="s">"number1"</code><code class="go">&gt;</code>
          <code class="go">{</code><code class="nx">pair</code> <code class="o">&amp;&amp;</code> <code class="nx">pair</code><code class="go">[</code><code class="mi">0</code><code class="go">]}</code>
        <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="o">&amp;</code><code class="nx">times</code><code class="go">;</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">data</code><code class="err">-</code><code class="na">testid</code><code class="o">=</code><code class="s">"number2"</code> <code class="na">className</code><code class="o">=</code><code class="s">"number2"</code><code class="go">&gt;</code>
          <code class="go">{</code><code class="nx">pair</code> <code class="o">&amp;&amp;</code> <code class="nx">pair</code><code class="go">[</code><code class="mi">1</code><code class="go">]}</code>
        <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="o">?</code>
      <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{</code><code class="nx">refresh</code><code class="go">}&gt;</code><code class="nx">Refresh</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Question</code></pre>

<p class="author1">This version is only <em class="calibre7">slightly</em> longer than before. We’ve added an <code class="calibre21">onAnswer</code> callback function that will return the correct answer
to the parent component each time the application generates a new question.</p>

<p class="author1">The new component appears to work well in the application, but then an odd thing occurs. The next time someone looks at Storybook,
they notice an error, as shown in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_5" class="calibre6">Figure 8-5</a>.</p>

<figure class="calibre29"><div id="ch08_image_5" class="figure">
<img src="Images/recb_0805.png" alt="" class="calibre136"/>
<h6 class="calibre30"><span class="firstname">Figure 8-5. </span>An error occurs when we look at the new version of the component</h6>
</div></figure>

<p class="author1">What happened? We’ve added an implicit assumption into the code that the parent component will always pass an <code class="calibre21">onAnswer</code> callback
into the component. Because the Storybook stories rendered <code class="calibre21">Basic</code> story without an <code class="calibre21">onAnswer</code>, we got the error:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">&lt;</code><code class="nt">Question</code><code class="go">/&gt;</code></pre>

<p class="author1">Does this matter?<a data-type="indexterm" data-primary="errors" data-secondary="failures to cope with missisng properties or data" id="idm46634396558440" class="calibre6"/> Not for a simple component like this. After all, the application itself still worked. But failure to cope with
missing properties, such as the missing callback here or, more frequently, missing data, is one of the most typical causes of errors
in React.</p>

<p class="author1">Applications frequently generate React properties using data from the network, and that means the initial properties you pass
to components will often be null or undefined. It’s generally a good idea to either use a type-safe language, like TypeScript, to
avoid these issues or write tests that check that your components can cope with missing properties.</p>

<p class="author1">We created this component without any tests, but we did create it with a Storybook story—and that story <em class="calibre7">did</em> catch the issue. So is
there some way to write a test that will automatically check that Storybook can render all the stories?</p>

<p class="author1">We’re going to create a test for this component in a file called <em class="calibre7">Question.test.js</em>.</p>
<div data-type="tip" class="calibre25">
<p class="author1">Consider creating a folder for each component. Instead of simply having a file called <em class="calibre7">Question.js</em> in the <em class="calibre7">src</em> directory,
create a folder called <em class="calibre7">src/Question</em>, and inside there you can place <em class="calibre7">Question.js</em>, <em class="calibre7">Question.stories.js</em>, and <em class="calibre7">Question.test.js</em>.
If you then add an <em class="calibre7">src/Question/index.js</em> file, which does a default export of the <code class="calibre21">Question</code> component, the rest of your code will
be unaffected, and you will reduce the number of files other developers have to deal with.<sup class="calibre41"><a data-type="noteref" id="idm46634396575256-marker" href="ch08_split_001.xhtml#idm46634396575256" class="calibre35">3</a></sup></p>
</div>

<p class="author1">In the <a data-type="indexterm" data-primary="Jest testing library" data-secondary="test loading stories and passing them to Testing Library's render function" id="idm46634396573624" class="calibre6"/><a data-type="indexterm" data-primary="render function" data-secondary="passing Storybook stories to" id="idm46634396572648" class="calibre6"/>test file, we can then create a Jest test that loads each of the stories and then passes them to the Testing Library’s <code class="calibre21">render</code>
function:<sup class="calibre34"><a data-type="noteref" id="idm46634396570056-marker" href="ch08_split_001.xhtml#idm46634396570056" class="calibre35">4</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">render</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@testing-library/react'</code>
<code class="kr">import</code> <code class="nx">Question</code> <code class="nx">from</code> <code class="s">'./Question'</code>

<code class="kr">const</code> <code class="nx">stories</code> <code class="o">=</code> <code class="nx">require</code><code class="go">(</code><code class="s">'./Question.stories'</code><code class="go">)</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'Question'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should render all storybook stories without error'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">story</code> <code class="kr">in</code> <code class="nx">stories</code><code class="go">)</code> <code class="go">{</code>
      <code class="kr">if</code> <code class="go">(</code><code class="nx">story</code> <code class="o">!==</code> <code class="s">'default'</code><code class="go">)</code> <code class="go">{</code>
        <code class="kr">let</code> <code class="nx">C</code> <code class="o">=</code> <code class="nx">stories</code><code class="go">[</code><code class="nx">story</code><code class="go">]</code>
        <code class="nx">render</code><code class="go">(&lt;</code><code class="nt">C</code> <code class="go">/&gt;)</code>
      <code class="go">}</code>
    <code class="go">}</code>
  <code class="go">})</code>
<code class="go">})</code></pre>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">If your <a data-type="indexterm" data-primary="decorators, stories using" id="idm46634396566248" class="calibre6"/>stories are using <em class="calibre7">decorators</em> to provide such things as routers or styling, this technique will not pick them up
automatically. You should add them into the <code class="calibre21">render</code> method within the test.</p>
</div>

<p class="author1">When you run this test, you will get a failure:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">onAnswer is not a function</code>
<code class="go">TypeError: onAnswer is not a function</code></pre>

<p class="author1">We can fix the error by checking if there is a callback before calling it:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="c">// We need to check to avoid an error</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">onAnswer</code> <code class="o">&amp;&amp;</code> <code class="nx">result</code><code class="go">)</code> <code class="go">{</code>
    <code class="nx">onAnswer</code><code class="go">(</code><code class="nx">result</code><code class="go">)</code>
  <code class="go">}</code>
<code class="go">},</code> <code class="go">[</code><code class="nx">onAnswer</code><code class="go">,</code> <code class="nx">result</code><code class="go">])</code></pre>

<p class="author1">This technique allows you to create some elementary tests for a component with minimal effort. It’s worth creating a story for the
component, which includes no properties whatsoever. Then, before you add a new property, create a story that uses it and think about
how you will expect the component to behave.</p>

<p class="author1">Even though the test will perform only a simple render of each story, there is no reason why you can’t import a single story and
create a test using that story:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">render</code><code class="go">,</code> <code class="nx">screen</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@testing-library/react'</code>
<code class="kr">import</code> <code class="nx">user</code> <code class="nx">from</code> <code class="s">'@testing-library/user-event'</code>
<code class="kr">import</code> <code class="nx">Question</code> <code class="nx">from</code> <code class="s">'./Question'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">Basic</code><code class="go">,</code> <code class="nx">WithDisabled</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'./Question.stories'</code>
<code class="go">...</code>
<code class="nx">it</code><code class="go">(</code><code class="s">'should disable the button when asked'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">render</code><code class="go">(&lt;</code><code class="nt">WithDisabled</code> <code class="go">/&gt;)</code>
  <code class="kr">const</code> <code class="nx">refreshButton</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByRole</code><code class="go">(</code><code class="s">'button'</code><code class="go">)</code>
  <code class="nx">expect</code><code class="go">(</code><code class="nx">refreshButton</code><code class="go">.</code><code class="nx">disabled</code><code class="go">).</code><code class="nx">toEqual</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
<code class="go">})</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634397160600">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Storybook render tests introduce rudimentary unit testing into your application, and it can find a surprising number of
regression bugs. It also helps you think of tests as examples, which are there to help you design your code rather than coding
artifacts that you must create to keep the team lead happy. Creating render tests for stories is also helpful if you have a team
that is new to unit testing. By creating visual examples, it avoids the problems that can arise from nonvisual tests feeling
abstract. It can also get developers into the habit of having a test file for each component in the system. When you need to make a
minor change to the component, it will then be much easier to add a small unit test function before adding the change.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/P1Tqj" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="Storybook" data-secondary="reusing stories inside tests" data-startref="ix_Stryretst" id="idm46634396224504" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Test Without a Server Using Cypress" class="calibre4"><div class="preface" id="ch08-03">
<h1 class="calibre17">Test Without a Server Using Cypress</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634396222152">
<h2 class="calibre27">Problem</h2>

<p class="author1">One of the principal features of high-quality code is the way it responds to errors.<a data-type="indexterm" data-primary="Cypress" data-secondary="testing without a server" id="ix_Cyprtst" class="calibre6"/><a data-type="indexterm" data-primary="testing" data-secondary="network failures without server using Cypress" id="ix_tstntfail" class="calibre6"/> The first of Peter Deutsch’s
<a href="https://oreil.ly/eDtKG" class="calibre6">Eight Fallacies of Distributed Computing</a> is: <em class="calibre7">the network is reliable</em>. <a data-type="indexterm" data-primary="networks" data-secondary="failures of" id="idm46634396216872" class="calibre6"/>Not only is
the network <em class="calibre7">not</em> reliable, but neither are the servers or databases that connect to it. At some point, your application is going to
have to deal with some network failure. It might be that the phone loses its connection, or the server goes down, or the database
crashes, or someone else has deleted the data you are trying to update. Whatever the causes, you will need to decide what your
application will do when terrible things happen.</p>

<p class="author1">Network issues can be challenging to simulate in testing environments. If you write code that puts the server into some error state,
that is likely to cause problems for other tests or users who connect to the server.</p>

<p class="author1">How can you create automated tests for network failure cases?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634396213720">
<h2 class="calibre27">Solution</h2>

<p class="author1">For this recipe, we are<a data-type="indexterm" data-primary="networks" data-secondary="failures of" data-tertiary="creating automated tests for failure cases" id="ix_ntfailtst" class="calibre6"/> going to use Cypress. We mentioned the Cypress testing system in <a data-type="xref" href="ch01_split_000.xhtml#chapter01" class="calibre6">Chapter 1</a>. It’s a genuinely remarkable
testing system that is rapidly becoming our go-to tool in many development projects.</p>

<p class="author1">To install Cypress into your project, type the following:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install --save-dev cypress</code></pre>

<p class="author1">Cypress works by automating a web browser. In that sense, it is similar to other systems like Selenium. Still, the difference is
that Cypress does not require you to install a separate driver, and it can both control the browser remotely and inject itself into
the browser’s JavaScript engine.</p>

<p class="author1">Cypress can therefore actively replace core parts of the JavaScript infrastructure with faked versions that it can control. For example, Cypress can replace the JavaScript <code class="calibre21">fetch</code> function used to make network calls to the server.<sup class="calibre34"><a data-type="noteref" id="idm46634396204872-marker" href="ch08_split_001.xhtml#idm46634396204872" class="calibre35">5</a></sup> Cypress tests can therefore spoof the behavior of a network server and allow a client-side developer to artificially craft responses from the server.</p>

<p class="author1">We will use the example game application that we use for other recipes in this chapter. We will add a network call to store the
result each time a user answers a question. We can do this without creating the actual server code by faking the responses in
Cypress.</p>

<p class="author1">To show how this works, we will first create a test that simulates the server responding correctly. Then we will create a test to
simulate a server failure.</p>

<p class="author1">Once Cypress is installed, create a file in <em class="calibre7">cypress/integration/</em> called <em class="calibre7">0001-basic-game-functions.js</em>:<sup class="calibre34"><a data-type="noteref" id="idm46634396201256-marker" href="ch08_split_001.xhtml#idm46634396201256" class="calibre35">6</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should notify the server if I lose'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I started the application</code>
    <code class="c">// When I enter an incorrect answer</code>
    <code class="c">// Then the server will be told that I have lost</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">We’ve put placeholder comments for each of the steps we will need to write.</p>

<p class="author1">Each command and assertion in Cypress begins with <code class="calibre21">cy</code>. If we want to open the browser at location <em class="calibre7">http://localhost:3000</em>, we can do
it with the following:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should notify the server if I lose'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I started the application</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>

    <code class="c">// When I enter an incorrect answer</code>
    <code class="c">// Then the server will be told that I have lost</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">To run <a data-type="indexterm" data-primary="npx command" data-secondary="opening and running Cypress" id="idm46634396120744" class="calibre6"/>the test, we can type:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npx cypress run</code></pre>

<p class="author1">That command will run all tests without showing the browser.<sup class="calibre34"><a data-type="noteref" id="idm46634396063368-marker" href="ch08_split_001.xhtml#idm46634396063368" class="calibre35">7</a></sup> We can also type the following:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npx cypress open</code></pre>

<p class="author1">This command will open the Cypress application window (as you can see in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_6" class="calibre6">Figure 8-6</a>). If we double-click the test file, the test
will open in a browser (as you can see in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_7" class="calibre6">Figure 8-7</a>).</p>

<figure class="calibre29"><div id="ch08_image_6" class="figure">
<img src="Images/recb_0806.png" alt="" class="calibre137"/>
<h6 class="calibre30"><span class="firstname">Figure 8-6. </span>The test will appear in the Cypress window when you type <code class="calibre21"><strong class="calibre138">npx cypress open</strong></code></h6>
</div></figure>

<figure class="calibre29"><div id="ch08_image_7" class="figure">
<img src="Images/recb_0807.png" alt="" class="calibre139"/>
<h6 class="calibre30"><span class="firstname">Figure 8-7. </span>A Cypress test running in a browser</h6>
</div></figure>

<p class="author1">The example application asks the user to multiply two random numbers (see <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_8" class="calibre6">Figure 8-8</a>). The numbers will be in the range 1–10, so if
we enter the value <strong class="calibre22"><code class="calibre23">101</code></strong>, we can be sure that the answer will be incorrect.</p>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">Cypress does not allow you to capture textual content from the screen directly. So we cannot simply read the values of the two
numbers and store them in variables because the commands in Cypress don’t immediately perform the actions in the browser.<a data-type="indexterm" data-primary="chainable nature of Cypress" id="idm46634396016584" class="calibre6"/> Instead,
when you run a command, Cypress adds it to a <em class="calibre7">chain</em> of instructions, which it performs at the end of the test. This approach might
seem a little odd, but these <em class="calibre7">chainable</em> instructions allow Cypress to cope with most of the problems caused by asynchronous
interfaces.<sup class="calibre41"><a data-type="noteref" id="idm46634396079192-marker" href="ch08_split_001.xhtml#idm46634396079192" class="calibre35">8</a></sup> The downside is that no command can return the page’s contents as the page will not exist when the command runs.</p>
</div>

<p class="author1">We will see elsewhere in this chapter how we can remove randomness in test scenarios and make this test deterministic, which will
remove the need to capture data from the page.</p>

<figure class="calibre29"><div id="ch08_image_8" class="figure">
<img src="Images/recb_0802.png" alt="" class="calibre134"/>
<h6 class="calibre30"><span class="firstname">Figure 8-8. </span>The application asks the user to calculate the product of two random 
<span class="firstname">numbers</span></h6>
</div></figure>

<p class="author1">We can use the <code class="calibre21">cy.get</code> command to find the input field by a CSS selector. We can also use the <code class="calibre21">cy.contains</code> command to find the
Submit button:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should notify the server if I lose'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I started the application</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>

    <code class="c">// When I enter an incorrect answer</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'input'</code><code class="go">).</code><code class="nx">type</code><code class="go">(</code><code class="s">'101'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'Submit'</code><code class="go">).</code><code class="nx">click</code><code class="go">()</code>

    <code class="c">// Then the server will be told that I have lost</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">Now we just need to test that the application contacts the server with the result of the game.</p>

<p class="author1">We will use the <code class="calibre21">cy.intercept()</code> command to do this.<a data-type="indexterm" data-primary="cy.intercept command" id="idm46634395959912" class="calibre6"/> The <code class="calibre21">cy.intercept()</code> command will change the behavior of network requests in
the application so that we can fake responses for a given request. If the result is going to be POSTed to the endpoint
<em class="calibre7">/api/result</em>, we generate a faked response like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">cy</code><code class="go">.</code><code class="nx">intercept</code><code class="go">(</code><code class="s">'POST'</code><code class="go">,</code> <code class="s">'/api/result'</code><code class="go">,</code> <code class="go">{</code>
  <code class="nx">statusCode</code><code class="o">:</code> <code class="mi">200</code><code class="go">,</code>
  <code class="nx">body</code><code class="o">:</code> <code class="s">''</code><code class="go">,</code>
<code class="go">})</code></pre>

<p class="author1">Once this command takes effect, network requests to <em class="calibre7">/api/result</em> will receive the faked response. That means we need to run the
command <em class="calibre7">before</em> the network request is made. We will do it at the start of the test:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should notify the server if I lose'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I started the application</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">intercept</code><code class="go">(</code><code class="s">'POST'</code><code class="go">,</code> <code class="s">'/api/result'</code><code class="go">,</code> <code class="go">{</code>
      <code class="nx">statusCode</code><code class="o">:</code> <code class="mi">200</code><code class="go">,</code>
      <code class="nx">body</code><code class="o">:</code> <code class="s">''</code><code class="go">,</code>
    <code class="go">})</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>

    <code class="c">// When I enter an incorrect answer</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'input'</code><code class="go">).</code><code class="nx">type</code><code class="go">(</code><code class="s">'101'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'Submit'</code><code class="go">).</code><code class="nx">click</code><code class="go">()</code>

    <code class="c">// Then the server will be told that I have lost</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">We’ve now specified the network response. But how do we assert that the application has made the network call, and how do we know
that it has sent the correct data to the <em class="calibre7">/api/result</em> endpoint?</p>

<p class="author1">We will need to give the network request an <em class="calibre7">alias</em>. This will allow us to refer to the request later in the test:<sup class="calibre34"><a data-type="noteref" id="idm46634395808488-marker" href="ch08_split_001.xhtml#idm46634395808488" class="calibre35">9</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">cy</code><code class="go">.</code><code class="nx">intercept</code><code class="go">(</code><code class="s">'POST'</code><code class="go">,</code> <code class="s">'/api/result'</code><code class="go">,</code> <code class="go">{</code>
  <code class="nx">statusCode</code><code class="o">:</code> <code class="mi">200</code><code class="go">,</code>
  <code class="nx">body</code><code class="o">:</code> <code class="s">''</code><code class="go">,</code>
<code class="go">}).</code><code class="nx">as</code><code class="go">(</code><code class="s">'postResult'</code><code class="go">)</code></pre>

<p class="author1">We can then make an assertion at the end of the test, which will wait for the network call to be made and will check the contents
of the data sent in the request body:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should notify the server if I lose'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I started the application</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">intercept</code><code class="go">(</code><code class="s">'POST'</code><code class="go">,</code> <code class="s">'/api/result'</code><code class="go">,</code> <code class="go">{</code>
      <code class="nx">statusCode</code><code class="o">:</code> <code class="mi">200</code><code class="go">,</code>
      <code class="nx">body</code><code class="o">:</code> <code class="s">''</code><code class="go">,</code>
    <code class="go">}).</code><code class="nx">as</code><code class="go">(</code><code class="s">'postResult'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>

    <code class="c">// When I enter an incorrect answer</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'input'</code><code class="go">).</code><code class="nx">type</code><code class="go">(</code><code class="s">'101'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'Submit'</code><code class="go">).</code><code class="nx">click</code><code class="go">()</code>

    <code class="c">// Then the server will be told that I have lost</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">wait</code><code class="go">(</code><code class="s">'@postResult'</code><code class="go">).</code><code class="nx">then</code><code class="go">((</code><code class="nx">xhr</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">expect</code><code class="go">(</code><code class="nx">xhr</code><code class="go">.</code><code class="nx">request</code><code class="go">.</code><code class="nx">body</code><code class="go">.</code><code class="nx">guess</code><code class="go">).</code><code class="nx">equal</code><code class="go">(</code><code class="mi">101</code><code class="go">)</code>
      <code class="nx">expect</code><code class="go">(</code><code class="nx">xhr</code><code class="go">.</code><code class="nx">request</code><code class="go">.</code><code class="nx">body</code><code class="go">.</code><code class="nx">result</code><code class="go">).</code><code class="nx">equal</code><code class="go">(</code><code class="s">'LOSE'</code><code class="go">)</code>
    <code class="go">})</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">This assertion is checking two of the attributes of the request body for the expected values.</p>

<p class="author1">If we run the test now, it will pass (as you can see in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_9" class="calibre6">Figure 8-9</a>).</p>

<figure class="calibre29"><div id="ch08_image_9" class="figure">
<img src="Images/recb_0809.png" alt="" class="calibre140"/>
<h6 class="calibre30"><span class="firstname">Figure 8-9. </span>The completed test passes</h6>
</div></figure>

<p class="author1">Now that we’ve created a test for the successful case, we can write a test for the failure case. The application should display
a message on-screen if the network call fails.<a data-type="indexterm" data-primary="errors" data-secondary="network call failures, testing in Cypress" id="idm46634395603624" class="calibre6"/> We don’t actually care what details are sent to the server in this test, but we still
need to wait for the network request to complete before checking for the existence of the error message:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">it</code><code class="go">(</code><code class="s">'should display a message if I cannot post the result'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="c">// Given I started the application</code>
  <code class="nx">cy</code><code class="go">.</code><code class="nx">intercept</code><code class="go">(</code><code class="s">'POST'</code><code class="go">,</code> <code class="s">'/api/result'</code><code class="go">,</code> <code class="go">{</code>
    <code class="nx">statusCode</code><code class="o">:</code> <code class="mi">500</code><code class="go">,</code>
    <code class="nx">body</code><code class="o">:</code> <code class="go">{</code> <code class="nx">message</code><code class="o">:</code> <code class="s">'Bad thing happened!'</code> <code class="go">},</code>
  <code class="go">}).</code><code class="nx">as</code><code class="go">(</code><code class="s">'postResult'</code><code class="go">)</code>
  <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>

  <code class="c">// When I enter an answer</code>
  <code class="nx">cy</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'input'</code><code class="go">).</code><code class="nx">type</code><code class="go">(</code><code class="s">'16'</code><code class="go">)</code>
  <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'We are unable to save the result'</code><code class="go">).</code><code class="nx">should</code><code class="go">(</code><code class="s">'not.exist'</code><code class="go">)</code>
  <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'Submit'</code><code class="go">).</code><code class="nx">click</code><code class="go">()</code>

  <code class="c">// Then I will see an error message</code>
  <code class="nx">cy</code><code class="go">.</code><code class="nx">wait</code><code class="go">(</code><code class="s">'@postResult'</code><code class="go">)</code>
  <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'We are unable to save the result'</code><code class="go">)</code>
<code class="go">})</code></pre>

<p class="author1">Notice that we check for the error message <em class="calibre7">not</em> existing before we make the network call to ensure that the network call <em class="calibre7">causes</em>
the error.</p>

<p class="author1">In addition to generating stubbed responses and status codes, <code class="calibre21">cy.intercept</code> can perform other tricks, such as slowing response
times, throttling network speed, or generating responses from test functions. For further details, see the
<a href="https://oreil.ly/tcZR8" class="calibre6"><code class="calibre21">cy.intercept</code> 
<span class="firstname">documentation</span></a>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634396212136">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Cypress testing can transform how a development team works, specifically in its ability to mock network calls. Teams frequently
develop APIs at a different cadence than frontend code. Also, some teams have developers who specialize in frontend or server code.
Cypress can help in these situations because it allows frontend developers to write code against endpoints that don’t currently
exist. Cypress can also simulate all of the pathological failure cases.</p>

<p class="author1">Network performance can introduce intermittent bugs. Development environments use local servers with little or no data, which means
that API performance is far better at development time than in a production environment. <a data-type="indexterm" data-primary="APIs" data-secondary="testing calls with slow response using Cypress" id="idm46634395539480" class="calibre6"/>It is straightforward to write code that
assumes that data is immediately available, but this code will break in a production environment where the data may take a second or
so to arrive.</p>

<p class="author1">It is therefore worth having at least one test for each API call where the response is slowed by a second or so:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">cy</code><code class="go">.</code><code class="nx">intercept</code><code class="go">(</code><code class="s">'GET'</code><code class="go">,</code> <code class="s">'/api/widgets'</code><code class="go">,</code> <code class="go">{</code>
  <code class="nx">statusCode</code><code class="o">:</code> <code class="mi">200</code><code class="go">,</code>
  <code class="nx">body</code><code class="o">:</code> <code class="go">[{</code> <code class="nx">id</code><code class="o">:</code> <code class="mi">1</code><code class="go">,</code> <code class="nx">name</code><code class="o">:</code> <code class="s">'Flange'</code> <code class="go">}],</code>
  <code class="nx">delay</code><code class="o">:</code> <code class="mi">1000</code><code class="go">,</code>
<code class="go">}).</code><code class="nx">as</code><code class="go">(</code><code class="s">'getWidgets'</code><code class="go">)</code></pre>

<p class="author1">Simulating slow network responses will often flush out a whole plethora of asynchronous bugs that might otherwise creep into your
code.</p>

<p class="author1">Almost as importantly, creating artificially slow network responses will give you a sense of the overall impact of each API call on
performance.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/P1Tqj" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="testing" data-secondary="network failures without server, using Cypress" data-startref="ix_tstntfail" id="idm46634395461736" class="calibre6"/><a data-type="indexterm" data-primary="networks" data-secondary="failures of" data-tertiary="creating automated tests for failure cases" data-startref="ix_ntfailtst" id="idm46634395460392" class="calibre6"/><a data-type="indexterm" data-primary="Cypress" data-secondary="testing without a server" data-startref="ix_Cyprtst" id="idm46634395458872" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Use Cypress for Offline Testing" class="calibre4"><div class="preface" id="ch08-04">
<h1 class="calibre17">Use Cypress for Offline Testing</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634395456136">
<h2 class="calibre27">Problem</h2>

<p class="author1">This recipe<a data-type="indexterm" data-primary="testing" data-secondary="offline, using Cypress" id="ix_tstoffln" class="calibre6"/><a data-type="indexterm" data-primary="offline testing, using Cypress" id="ix_offlntst" class="calibre6"/><a data-type="indexterm" data-primary="Cypress" data-secondary="using for offline testing" id="ix_Cyproffl" class="calibre6"/> uses a custom Cypress command invented by <a href="https://oreil.ly/oOMHP" class="calibre6">Etienne Bruines</a>.</p>

<p class="author1">Applications need to cope with being disconnected from the network. We’ve seen elsewhere how to create a hook to detect if we are currently offline.<sup class="calibre34"><a data-type="noteref" id="idm46634395450040-marker" href="ch08_split_001.xhtml#idm46634395450040" class="calibre35">10</a></sup> But how are we test for offline behavior?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634395448168">
<h2 class="calibre27">Solution</h2>

<p class="author1">We can simulate offline working using Cypress. Cypress tests can inject code that modifies the internal behavior of the browser
under test.<a data-type="indexterm" data-primary="browsers" data-secondary="simulating offline working using Cypress" id="ix_brwsoffl" class="calibre6"/> We should therefore be able to modify the network code to simulate offline conditions.</p>

<p class="author1">For this recipe, you will need to install Cypress in your application. If you don’t already have Cypress, you can install it by
running this command in your application directory:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install --save-dev cypress</code></pre>

<p class="author1">You can then add a <em class="calibre7">0002-offline-working.js</em> file to the <em class="calibre7">cypress/integration</em> directory:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Offline working'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code>
    <code class="s">'should tell us when we are offline'</code><code class="go">,</code>
    <code class="go">{</code> <code class="nx">browser</code><code class="o">:</code> <code class="s">'!firefox'</code> <code class="go">},</code>
    <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="c">// Given we have started the application</code>
      <code class="c">// When the application is offline</code>
      <code class="c">// Then we will see a warning</code>
      <code class="c">// When the application is back online</code>
      <code class="c">// Then we will not see a warning</code>
    <code class="go">}</code>
  <code class="go">)</code>
<code class="go">})</code></pre>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">We will ignore this test on Firefox. The offline simulation code relies upon the Chrome DevTools remote debugging protocol,
which is not currently available in the Firefox browser.<a data-type="indexterm" data-primary="Chrome DevTools remote debugging protocol" id="idm46634395326248" class="calibre6"/></p>
</div>

<p class="author1">We have marked out the structure of the test as a series of comments. Cypress commands all begin with <code class="calibre21">cy</code>, so we can open the
application like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Offline working'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code>
    <code class="s">'should tell us when we are offline'</code><code class="go">,</code>
    <code class="go">{</code> <code class="nx">browser</code><code class="o">:</code> <code class="s">'!firefox'</code> <code class="go">},</code>
    <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="c">// Given we have started the application</code>
      <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>

      <code class="c">// When the application is offline</code>
      <code class="c">// Then we will see a warning</code>
      <code class="c">// When the application is back online</code>
      <code class="c">// Then we will not see a warning</code>
    <code class="go">}</code>
  <code class="go">)</code>
<code class="go">})</code></pre>

<p class="author1">The question is, how do we force the browser to simulate offline working?</p>

<p class="author1">We can do it because Cypress is designed to be extensible. We can add a custom Cypress command that will allow us to go offline and
back online:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">cy</code><code class="go">.</code><code class="nx">network</code><code class="go">({</code> <code class="nx">offline</code><code class="o">:</code> <code class="kr">true</code> <code class="go">})</code>
<code class="nx">cy</code><code class="go">.</code><code class="nx">network</code><code class="go">({</code> <code class="nx">offline</code><code class="o">:</code> <code class="kr">false</code> <code class="go">})</code></pre>

<p class="author1">To add a custom command, open the <em class="calibre7">cypress/support/commands.js</em> file, and add the following code:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">Cypress</code><code class="go">.</code><code class="nx">Commands</code><code class="go">.</code><code class="nx">add</code><code class="go">(</code><code class="s">'network'</code><code class="go">,</code> <code class="go">(</code><code class="nx">options</code> <code class="o">=</code> <code class="go">{})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">Cypress</code><code class="go">.</code><code class="nx">automation</code><code class="go">(</code><code class="s">'remote:debugger:protocol'</code><code class="go">,</code> <code class="go">{</code>
    <code class="nx">command</code><code class="o">:</code> <code class="s">'Network.enable'</code><code class="go">,</code>
  <code class="go">})</code>

  <code class="nx">Cypress</code><code class="go">.</code><code class="nx">automation</code><code class="go">(</code><code class="s">'remote:debugger:protocol'</code><code class="go">,</code> <code class="go">{</code>
    <code class="nx">command</code><code class="o">:</code> <code class="s">'Network.emulateNetworkConditions'</code><code class="go">,</code>
    <code class="nx">params</code><code class="o">:</code> <code class="go">{</code>
      <code class="nx">offline</code><code class="o">:</code> <code class="nx">options</code><code class="go">.</code><code class="nx">offline</code><code class="go">,</code>
      <code class="nx">latency</code><code class="o">:</code> <code class="mi">0</code><code class="go">,</code>
      <code class="nx">downloadThroughput</code><code class="o">:</code> <code class="mi">0</code><code class="go">,</code>
      <code class="nx">uploadThroughput</code><code class="o">:</code> <code class="mi">0</code><code class="go">,</code>
      <code class="nx">connectionType</code><code class="o">:</code> <code class="s">'none'</code><code class="go">,</code>
    <code class="go">},</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">This command uses the remote debugging protocol in DevTools to emulate offline network conditions.<a data-type="indexterm" data-primary="networks" data-secondary="emulating offline working using Chrome DevTools" id="idm46634395238184" class="calibre6"/> Once you have saved this file,
you can then implement the rest of the test:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Offline working'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code>
    <code class="s">'should tell us when we are offline'</code><code class="go">,</code>
    <code class="go">{</code> <code class="nx">browser</code><code class="o">:</code> <code class="s">'!firefox'</code> <code class="go">},</code>
    <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="c">// Given we have started the application</code>
      <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>
      <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="sr">/you are currently offline/i</code><code class="go">).</code><code class="nx">should</code><code class="go">(</code><code class="s">'not.exist'</code><code class="go">)</code>

      <code class="c">// When the application is offline</code>
      <code class="nx">cy</code><code class="go">.</code><code class="nx">network</code><code class="go">({</code> <code class="nx">offline</code><code class="o">:</code> <code class="kr">true</code> <code class="go">})</code>

      <code class="c">// Then we will see a warning</code>
      <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="sr">/you are currently offline/i</code><code class="go">).</code><code class="nx">should</code><code class="go">(</code><code class="s">'be.visible'</code><code class="go">)</code>

      <code class="c">// When the application is back online</code>
      <code class="nx">cy</code><code class="go">.</code><code class="nx">network</code><code class="go">({</code> <code class="nx">offline</code><code class="o">:</code> <code class="kr">false</code> <code class="go">})</code>

      <code class="c">// Then we will not see a warning</code>
      <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="sr">/you are currently offline/i</code><code class="go">).</code><code class="nx">should</code><code class="go">(</code><code class="s">'not.exist'</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">)</code>
<code class="go">})</code></pre>

<p class="author1">If you run the test now, in Electron, it will pass (see <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_10" class="calibre6">Figure 8-10</a>).</p>

<figure class="calibre29"><div id="ch08_image_10" class="figure">
<img src="Images/recb_0810.png" alt="" class="calibre141"/>
<h6 class="calibre30"><span class="firstname">Figure 8-10. </span>You can view each stage of the online/offline test by clicking on the left panel</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634395447576">
<h2 class="calibre27">Discussion</h2>

<p class="author1">It should be possible to create similar commands that simulate various network conditions and speeds.</p>

<p class="author1">For more information on how the network command works, see <a href="https://oreil.ly/PB4zO" class="calibre6">this blog post from Cypress.io</a>.<a data-type="indexterm" data-primary="browsers" data-secondary="simulating offline working using Cypress" data-startref="ix_brwsoffl" id="idm46634394991784" class="calibre6"/></p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/P1Tqj" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="testing" data-secondary="offline, using Cypress" data-startref="ix_tstoffln" id="idm46634394989368" class="calibre6"/><a data-type="indexterm" data-primary="Cypress" data-secondary="using for offline testing" data-startref="ix_Cyproffl" id="idm46634394988088" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Test in a Browser with Selenium" class="calibre4"><div class="preface" id="ch08-05">
<h1 class="calibre17">Test in a Browser with Selenium</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634394985176">
<h2 class="calibre27">Problem</h2>

<p class="author1">Nothing beats running your code inside a real browser, and the most common way of writing automated browser-based tests is by using
a <em class="calibre7">web driver</em>.<a data-type="indexterm" data-primary="testing" data-secondary="in a browser, using Selenium" data-secondary-sortas="browser" id="ix_tstbrwsSel" class="calibre6"/><a data-type="indexterm" data-primary="Selenium library" data-secondary="testing in browsers with" id="ix_Seletst" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="testing in, using Selenium" id="ix_brwststSel" class="calibre6"/> You can control most browsers by sending a command to a network port. Different browsers have different commands,
and a web driver is a command-line tool that simplifies controlling the browser.</p>

<p class="author1">But how can we write a test for a React application that uses a web driver?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634394978280">
<h2 class="calibre27">Solution</h2>

<p class="author1">We are going to use the Selenium library. Selenium is a framework that provides a consistent API for a whole<a data-type="indexterm" data-primary="web driver tests" id="ix_webdr" class="calibre6"/> set of different web
drivers, which means that you can write a test for Firefox and the same code should work in the same way for Chrome, Safari, and
Edge.<sup class="calibre34"><a data-type="noteref" id="idm46634394974248-marker" href="ch08_split_001.xhtml#idm46634394974248" class="calibre35">11</a></sup></p>

<p class="author1">We will use the same example application that we are using for all recipes in this chapter. It’s a game that asks the user for the
answer to a simple multiplication problem.</p>

<p class="author1">The Selenium library is available for a whole set of different languages, such as Python, Java, and C#.<a data-type="indexterm" data-primary="JavaScript" data-secondary="Selenium WebDriver" id="idm46634394972488" class="calibre6"/> We will be using the
JavaScript version: Selenium WebDriver.</p>

<p class="author1">We’ll begin by installing Selenium:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install --save-dev selenium-webdriver</code></pre>

<p class="author1">We will also need to install at least one web driver. You can install web drivers globally, but it is more manageable to install
them in your application. We could install a driver like <code class="calibre21">geckodriver</code> for Firefox, but for now, we will install <code class="calibre21">chromedriver</code> for
Chrome:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install --save-dev chromedriver</code></pre>

<p class="author1">We can now start to create a test. It’s useful to include Selenium tests inside the <em class="calibre7">src</em> folder of the application, because it will
make it easier to use an IDE to run the tests manually. So we’ll create a folder called <em class="calibre7">src/selenium</em> and then add a file
inside it called <em class="calibre7">0001-basic-game-functions.spec.js</em>:<sup class="calibre34"><a data-type="noteref" id="idm46634394947128-marker" href="ch08_split_001.xhtml#idm46634394947128" class="calibre35">12</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell me if I won'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I have started the application</code>
    <code class="c">// When I enter the correct answer</code>
    <code class="c">// Then I will be told that I have won</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">We have outlined the test in the comments.</p>
<div data-type="tip" class="calibre25">
<p class="author1">While it’s convenient to include Selenium tests in the <em class="calibre7">src</em> tree, it can mean that <a data-type="indexterm" data-primary="Jest testing library" data-secondary="running Selenium tests in src tree like unit tests" id="idm46634394920664" class="calibre6"/>a tool like Jest will run it as if it were
a unit test, which is a problem if you run unit tests continually in the background. For example, if you created your application
with <code class="calibre21">create-react-app</code> and leave an <code class="calibre21">npm run test</code> command running, you will find that a browser will suddenly appear on your screen
each time you save the Selenium test. To avoid this, adopt some naming convention to distinguish between Selenium and unit tests. If
you name all your Selenium tests <em class="calibre7">*.spec.js</em>, you can modify your test script to avoid them by setting it to <em class="calibre7">react-scripts test
‘.*.test.js’</em>.</p>
</div>

<p class="author1">Selenium uses a web driver to automate the web browser. We can create an instance of the driver at the start of each test:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">Builder</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'selenium-webdriver'</code>
<code class="kr">let</code> <code class="nx">driver</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">beforeEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">driver</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Builder</code><code class="go">().</code><code class="nx">forBrowser</code><code class="go">(</code><code class="s">'chrome'</code><code class="go">).</code><code class="nx">build</code><code class="go">()</code>
  <code class="go">})</code>

  <code class="nx">afterEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">driver</code><code class="go">.</code><code class="nx">quit</code><code class="go">()</code>
  <code class="go">})</code>

  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell me if I won'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I have started the application</code>
    <code class="c">// When I enter the correct answer</code>
    <code class="c">// Then I will be told that I have won</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">In this example, we are creating a Chrome driver.</p>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">By creating a driver for each test, we will also create a fresh instance of the browser for each test, ensuring that no
browser state is carried between tests. If we carry no state between tests, it will allow us to run the tests in any order. We have
no such guarantee on shared server state. If your tests are reliant upon, for example, database data, you should ensure that each
test initializes the server correctly when it starts.</p>
</div>

<p class="author1">For Selenium to create an instance of the driver, we should also explicitly <em class="calibre7">require</em> the driver:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">Builder</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'selenium-webdriver'</code>
<code class="nx">require</code><code class="go">(</code><code class="s">'chromedriver'</code><code class="go">)</code>

<code class="kr">let</code> <code class="nx">driver</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">beforeEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">driver</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Builder</code><code class="go">().</code><code class="nx">forBrowser</code><code class="go">(</code><code class="s">'chrome'</code><code class="go">).</code><code class="nx">build</code><code class="go">()</code>
  <code class="go">})</code>

  <code class="nx">afterEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">driver</code><code class="go">.</code><code class="nx">quit</code><code class="go">()</code>
  <code class="go">})</code>

  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell me if I won'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I have started the application</code>
    <code class="c">// When I enter the correct answer</code>
    <code class="c">// Then I will be told that I have won</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">We can now start to fill out the test. The JavaScript version of Selenium is highly asynchronous. Virtually all commands return
promises, which means that it is very efficient, but it is also far too easy to introduce testing bugs.</p>

<p class="author1">Let’s begin our test by opening the application:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">Builder</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'selenium-webdriver'</code>
<code class="nx">require</code><code class="go">(</code><code class="s">'chromedriver'</code><code class="go">)</code>

<code class="kr">let</code> <code class="nx">driver</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">beforeEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">driver</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Builder</code><code class="go">().</code><code class="nx">forBrowser</code><code class="go">(</code><code class="s">'chrome'</code><code class="go">).</code><code class="nx">build</code><code class="go">()</code>
  <code class="go">})</code>

  <code class="nx">afterEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">driver</code><code class="go">.</code><code class="nx">quit</code><code class="go">()</code>
  <code class="go">})</code>

  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell me if I won'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I have started the application</code>
    <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>
    <code class="c">// When I enter the correct answer</code>
    <code class="c">// Then I will be told that I have won</code>
  <code class="go">},</code> <code class="mi">60000</code><code class="go">)</code>
<code class="go">})</code></pre>

<p class="author1">The <code class="calibre21">driver.get</code> command tells the browser to open the given URL. For this to work, we’ve also had to make two other changes. First,
we’ve had to mark the test function with <code class="calibre21">async</code>, which will allow us to <code class="calibre21">await</code> the promise returned by <code class="calibre21">driver.get</code>.</p>

<p class="author1">Second, we’ve added a timeout value of 60,000 milliseconds to the test, overriding the implicit five-second limit of Jest tests. If
you don’t increase the default timeout, you will find your test fails before the browser starts. We’ve set it to 60,000 milliseconds
here to ensure the test works on any machine. You should adjust this value to match your expected hardware.</p>

<p class="author1">To enter the correct value into the game, we will need to read the two numbers that appear in the question (as shown in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_11" class="calibre6">Figure 8-11</a>).</p>

<figure class="calibre29"><div id="ch08_image_11" class="figure">
<img src="Images/recb_0802.png" alt="" class="calibre134"/>
<h6 class="calibre30"><span class="firstname">Figure 8-11. </span>The game asks the user to calculate a random product</h6>
</div></figure>

<p class="author1">We can find the two numbers on the page and the <code class="calibre21">input</code> and <code class="calibre21">submit</code> buttons using a command called <code class="calibre21">findElement</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">number1</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.number1'</code><code class="go">)).</code><code class="nx">getText</code><code class="go">()</code>
<code class="kr">const</code> <code class="nx">number2</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.number2'</code><code class="go">)).</code><code class="nx">getText</code><code class="go">()</code>
<code class="kr">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'input'</code><code class="go">))</code>
<code class="kr">const</code> <code class="nx">submit</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code>
  <code class="nx">By</code><code class="go">.</code><code class="nx">xpath</code><code class="go">(</code><code class="s">"//button[text()='Submit']"</code><code class="go">)</code>
<code class="go">)</code></pre>

<p class="author1">If you are ever reading a set of elements from the page and don’t care about resolving them in a strict order, you can use the
<code class="calibre21">Promise.all</code> function to combine them into a single promise that you can then await:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="go">[</code><code class="nx">number1</code><code class="go">,</code> <code class="nx">number2</code><code class="go">,</code> <code class="nx">input</code><code class="go">,</code> <code class="nx">submit</code><code class="go">]</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">Promise</code><code class="go">.</code><code class="nx">all</code><code class="go">([</code>
  <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.number1'</code><code class="go">)).</code><code class="nx">getText</code><code class="go">(),</code>
  <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.number2'</code><code class="go">)).</code><code class="nx">getText</code><code class="go">(),</code>
  <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'input'</code><code class="go">)),</code>
  <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">xpath</code><code class="go">(</code><code class="s">"//button[text()='Submit']"</code><code class="go">)),</code>
<code class="go">])</code></pre>

<p class="author1">In the example application, this optimization will save virtually no time, but if you have a page that renders different components
in uncertain orders, combining the promises can improve test performance.</p>

<p class="author1">This means we can now complete the next part of our test:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">Builder</code><code class="go">,</code> <code class="nx">By</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'selenium-webdriver'</code>
<code class="nx">require</code><code class="go">(</code><code class="s">'chromedriver'</code><code class="go">)</code>

<code class="kr">let</code> <code class="nx">driver</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">beforeEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">driver</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Builder</code><code class="go">().</code><code class="nx">forBrowser</code><code class="go">(</code><code class="s">'chrome'</code><code class="go">).</code><code class="nx">build</code><code class="go">()</code>
  <code class="go">})</code>

  <code class="nx">afterEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">driver</code><code class="go">.</code><code class="nx">quit</code><code class="go">()</code>
  <code class="go">})</code>

  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell me if I won'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I have started the application</code>
    <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>
    <code class="c">// When I enter the correct answer</code>
    <code class="kr">const</code> <code class="go">[</code><code class="nx">number1</code><code class="go">,</code> <code class="nx">number2</code><code class="go">,</code> <code class="nx">input</code><code class="go">,</code> <code class="nx">submit</code><code class="go">]</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">Promise</code><code class="go">.</code><code class="nx">all</code><code class="go">([</code>
      <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.number1'</code><code class="go">)).</code><code class="nx">getText</code><code class="go">(),</code>
      <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.number2'</code><code class="go">)).</code><code class="nx">getText</code><code class="go">(),</code>
      <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'input'</code><code class="go">)),</code>
      <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">xpath</code><code class="go">(</code><code class="s">"//button[text()='Submit']"</code><code class="go">)),</code>
    <code class="go">])</code>
    <code class="nx">await</code> <code class="nx">input</code><code class="go">.</code><code class="nx">sendKeys</code><code class="go">(</code><code class="s">''</code> <code class="o">+</code> <code class="nx">number1</code> <code class="o">*</code> <code class="nx">number2</code><code class="go">)</code>
    <code class="nx">await</code> <code class="nx">submit</code><code class="go">.</code><code class="nx">click</code><code class="go">()</code>
    <code class="c">// Then I will be told that I have won</code>
  <code class="go">},</code> <code class="mi">60000</code><code class="go">)</code>
<code class="go">})</code></pre>

<p class="author1">Notice that we are not combining the promises returned by <code class="calibre21">sendKeys</code> and <code class="calibre21">click</code> because we care that the test enters the answer
into the input field <em class="calibre7">before</em> we submit it.</p>

<p class="author1">Finally, we want to assert that a <em class="calibre7">You have won!</em> message appears on the screen (see <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_12" class="calibre6">Figure 8-12</a>).</p>

<figure class="calibre29"><div id="ch08_image_12" class="figure">
<img src="Images/recb_0801.png" alt="" class="calibre133"/>
<h6 class="calibre30"><span class="firstname">Figure 8-12. </span>The app tells the user they got the correct answer</h6>
</div></figure>

<p class="author1">Now we could write our assertion like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">resultText</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">driver</code>
  <code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.Result'</code><code class="go">))</code>
  <code class="go">.</code><code class="nx">getText</code><code class="go">()</code>
<code class="nx">expect</code><code class="go">(</code><code class="nx">resultText</code><code class="go">).</code><code class="nx">toMatch</code><code class="go">(</code><code class="sr">/won/i</code><code class="go">)</code></pre>

<p class="author1">This code will almost certainly work because the result is displayed quickly after the user submits an answer. React
applications will often display dynamic results slowly, particularly if they rely upon data from the network. If we modify the
application code to simulate a two-second delay before the result appears,<sup class="calibre34"><a data-type="noteref" id="idm46634394193224-marker" href="ch08_split_001.xhtml#idm46634394193224" class="calibre35">13</a></sup> our test will produce the following error:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">no such element: Unable to locate element: {"method":"css selector",</code>
<code class="go">    "selector":".Result"}</code>
<code class="go">  (Session info: chrome=88.0.4324.192)</code>
<code class="go">NoSuchElementError: no such element: Unable to locate element: {</code>
<code class="go">    "method":"css selector","selector":".Result"}</code>
<code class="go">  (Session info: chrome=88.0.4324.192)</code></pre>

<p class="author1">We can avoid this problem by waiting until the element appears on the screen and then waiting until the text matches the expected
result. We can do both of those things with the <code class="calibre21">driver.wait</code> function:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">wait</code><code class="go">(</code><code class="nx">until</code><code class="go">.</code><code class="nx">elementLocated</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.Result'</code><code class="go">)))</code>
<code class="kr">const</code> <code class="nx">resultElement</code> <code class="o">=</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.Result'</code><code class="go">))</code>
<code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">wait</code><code class="go">(</code><code class="nx">until</code><code class="go">.</code><code class="nx">elementTextMatches</code><code class="go">(</code><code class="nx">resultElement</code><code class="go">,</code> <code class="sr">/won/i</code><code class="go">))</code></pre>

<p class="author1">This gives us the final version of our test:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">Builder</code><code class="go">,</code> <code class="nx">By</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'selenium-webdriver'</code>
<code class="nx">require</code><code class="go">(</code><code class="s">'chromedriver'</code><code class="go">)</code>

<code class="kr">let</code> <code class="nx">driver</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">beforeEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">driver</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Builder</code><code class="go">().</code><code class="nx">forBrowser</code><code class="go">(</code><code class="s">'chrome'</code><code class="go">).</code><code class="nx">build</code><code class="go">()</code>
  <code class="go">})</code>

  <code class="nx">afterEach</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">driver</code><code class="go">.</code><code class="nx">quit</code><code class="go">()</code>
  <code class="go">})</code>

  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell me if I won'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I have started the application</code>
    <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>
    <code class="c">// When I enter the correct answer</code>
    <code class="kr">const</code> <code class="go">[</code><code class="nx">number1</code><code class="go">,</code> <code class="nx">number2</code><code class="go">,</code> <code class="nx">input</code><code class="go">,</code> <code class="nx">submit</code><code class="go">]</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">Promise</code><code class="go">.</code><code class="nx">all</code><code class="go">([</code>
      <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.number1'</code><code class="go">)).</code><code class="nx">getText</code><code class="go">(),</code>
      <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.number2'</code><code class="go">)).</code><code class="nx">getText</code><code class="go">(),</code>
      <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'input'</code><code class="go">)),</code>
      <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">xpath</code><code class="go">(</code><code class="s">"//button[text()='Submit']"</code><code class="go">)),</code>
    <code class="go">])</code>
    <code class="nx">await</code> <code class="nx">input</code><code class="go">.</code><code class="nx">sendKeys</code><code class="go">(</code><code class="s">''</code> <code class="o">+</code> <code class="nx">number1</code> <code class="o">*</code> <code class="nx">number2</code><code class="go">)</code>
    <code class="nx">await</code> <code class="nx">submit</code><code class="go">.</code><code class="nx">click</code><code class="go">()</code>
    <code class="c">// Then I will be told that I have won</code>
    <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">wait</code><code class="go">(</code><code class="nx">until</code><code class="go">.</code><code class="nx">elementLocated</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.Result'</code><code class="go">)))</code>
    <code class="kr">const</code> <code class="nx">resultElement</code> <code class="o">=</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.Result'</code><code class="go">))</code>
    <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">wait</code><code class="go">(</code><code class="nx">until</code><code class="go">.</code><code class="nx">elementTextMatches</code><code class="go">(</code><code class="nx">resultElement</code><code class="go">,</code> <code class="sr">/won/i</code><code class="go">))</code>
  <code class="go">},</code> <code class="mi">60000</code><code class="go">)</code>
<code class="go">})</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634394976696">
<h2 class="calibre27">Discussion</h2>

<p class="author1">In our experience, web driver tests are the most popular form of automated tests for web applications—<em class="calibre7">popular</em> that is, in the
sense of <em class="calibre7">frequently used</em>. They are inevitably dependent upon matching versions of browsers and web drivers, and they do have a
reputation for failing intermittently. Timing issues usually cause these failures, and those timing issues occur more in Single-Page
Applications, which can update their contents asynchronously.</p>

<p class="author1">Although it is possible to avoid these problems by carefully adding timing delays and retries into the code, this can make your
tests sensitive to environmental changes, such as running your application on a different testing server. Another option, if you
experience a lot of intermittent failures, is to move more of your tests to a system like Cypress, which is generally more
<a href="https://oreil.ly/IZJ2T" class="calibre6">tolerant</a> of timing failures.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/P1Tqj" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="testing" data-secondary="in a browser, using Selenium" data-secondary-sortas="browser" data-startref="ix_tstbrwsSel" id="idm46634393762680" class="calibre6"/><a data-type="indexterm" data-primary="web driver tests" data-startref="ix_webdr" id="idm46634393761064" class="calibre6"/><a data-type="indexterm" data-primary="Selenium library" data-secondary="testing in browsers with" data-startref="ix_Seletst" id="idm46634393760120" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="testing in, using Selenium" data-startref="ix_brwststSel" id="idm46634393758888" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Test Cross-Browser Visuals with ImageMagick" class="calibre4"><div class="preface" id="ch08-06">
<h1 class="calibre17">Test Cross-Browser Visuals with ImageMagick</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634393755976">
<h2 class="calibre27">Problem</h2>

<p class="author1">Applications <a data-type="indexterm" data-primary="testing" data-secondary="cross-browser visuals, testing using ImageMagick" id="ix_tstcrsbrws" class="calibre6"/><a data-type="indexterm" data-primary="ImageMagick, cross-testing browser visuals" id="ix_ImgMag" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="cross-testing visuals using ImageMagick" id="ix_brwscrstst" class="calibre6"/>can look very different when viewed on different browsers. Applications can even look different if viewed on the same
browser but on a different operating system. One example of this would be Chrome, which tends to hide scrollbars when viewed on a
Mac but display them on Windows. Thankfully, old browsers like Internet Explorer are finally disappearing, but even modern browsers
can apply CSS in subtly different ways, radically changing the appearance of a page.<a data-type="indexterm" data-primary="CSS" data-secondary="browsers applying in different ways" id="idm46634393750504" class="calibre6"/></p>

<p class="author1">It can be time-consuming to constantly check an application manually across a range of browsers and platforms.</p>

<p class="author1">What can we do to automate this compatibility process?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634393748360">
<h2 class="calibre27">Solution</h2>

<p class="author1">In this recipe, we’re going to combine three tools to check for visual consistency across different browsers and platforms:</p>
<dl class="calibre18">
<dt class="calibre19">Storybook</dt>
<dd class="calibre20">
<p class="author1">This will give us a basic gallery of all of the components, in all relevant configurations, that we need to check.<a data-type="indexterm" data-primary="Storybook" data-secondary="using in cross-testing browser visuals" id="idm46634393743752" class="calibre6"/></p>
</dd>
<dt class="calibre19">Selenium</dt>
<dd class="calibre20">
<p class="author1">This will allow us to capture the visual appearance of all of the components in Storybook. <a data-type="indexterm" data-primary="Selenium library" data-secondary="using in cross-testing browser visuals" id="idm46634393741416" class="calibre6"/>The Selenium Grid will also
allow us to remotely connect to browsers on different operating systems to make comparisons between operating systems.</p>
</dd>
<dt class="calibre19">ImageMagick</dt>
<dd class="calibre20">
<p class="author1">Specifically, we’ll use ImageMagick’s <code class="calibre21">compare</code> tool to generate visual differences between two screenshots and
provide a numerical measure of how far apart the two images are.</p>
</dd>
</dl>

<p class="author1">We’ll begin by installing Storybook. You can do this in your application with this command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npx sb init</code></pre>

<p class="author1">You will then need to create <em class="calibre7">stories</em> for each of the components and configurations you are interested in tracking. You can find
out how to do this from other recipes in this book or the <a href="https://oreil.ly/ak7VW" class="calibre6">Storybook tutorials</a>.</p>

<p class="author1">Next, we will need Selenium to automate the capture of screenshots. You can install Selenium with this command:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install --save-dev selenium-webdriver</code></pre>

<p class="author1">You will also need to install the relevant web drivers.<a data-type="indexterm" data-primary="web drivers, installing for cross-browser testing" id="idm46634393722072" class="calibre6"/> For example, to automate Firefox and Chrome, you will need the following:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install --save-dev geckodriver</code>
<code class="go">$ npm install --save-dev chromedriver</code></pre>

<p class="author1">Finally, you will need to install ImageMagick, a set of command-line image manipulation tools. For details on how to install
ImageMagick, see the <a href="https://oreil.ly/NIQ0A" class="calibre6">ImageMagick download page</a>.</p>

<p class="author1">We are going to use the same example game application that we’ve used previously in this chapter. You can see the components from
the application displayed in Storybook in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_13" class="calibre6">Figure 8-13</a>.</p>

<figure class="calibre29"><div id="ch08_image_13" class="figure">
<img src="Images/recb_0813.png" alt="" class="calibre142"/>
<h6 class="calibre30"><span class="firstname">Figure 8-13. </span>Components from the application displayed in Storybook</h6>
</div></figure>

<p class="author1">You can run the Storybook server on your application by typing:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm run storybook</code></pre>

<p class="author1">Next, we will create a test that will just be a script for capturing screenshots of each of the components inside Storybook.<a data-type="indexterm" data-primary="Selenium library" data-secondary="using in cross-testing browser visuals" data-tertiary="script for screenshot captures" id="idm46634393646920" class="calibre6"/> In a
folder called <em class="calibre7">src/selenium</em>, create a script called <em class="calibre7">shots.spec.js</em>:<sup class="calibre34"><a data-type="noteref" id="idm46634393644856-marker" href="ch08_split_001.xhtml#idm46634393644856" class="calibre35">14</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">Builder</code><code class="go">,</code> <code class="nx">By</code><code class="go">,</code> <code class="nx">until</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'selenium-webdriver'</code>

<code class="nx">require</code><code class="go">(</code><code class="s">'chromedriver'</code><code class="go">)</code>
<code class="kr">let</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="go">(</code><code class="s">'fs'</code><code class="go">)</code>

<code class="nx">describe</code><code class="go">(</code><code class="s">'shots'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should take screenshots of storybook components'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">const</code> <code class="nx">browserEnv</code> <code class="o">=</code> <code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">SELENIUM_BROWSER</code> <code class="o">||</code> <code class="s">'chrome'</code>
    <code class="kr">const</code> <code class="nx">url</code> <code class="o">=</code> <code class="nx">process</code><code class="go">.</code><code class="nx">env</code><code class="go">.</code><code class="nx">START_URL</code> <code class="o">||</code> <code class="s">'http://localhost:6006'</code>
    <code class="kr">const</code> <code class="nx">driver</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Builder</code><code class="go">().</code><code class="nx">forBrowser</code><code class="go">(</code><code class="s">'chrome'</code><code class="go">).</code><code class="nx">build</code><code class="go">()</code>
    <code class="nx">driver</code><code class="go">.</code><code class="nx">manage</code><code class="go">().</code><code class="nb">window</code><code class="go">().</code><code class="nx">setRect</code><code class="go">({</code>
      <code class="nx">width</code><code class="o">:</code> <code class="mi">1200</code><code class="go">,</code>
      <code class="nx">height</code><code class="o">:</code> <code class="mi">900</code><code class="go">,</code>
      <code class="nx">x</code><code class="o">:</code> <code class="mi">0</code><code class="go">,</code>
      <code class="nx">y</code><code class="o">:</code> <code class="mi">0</code><code class="go">,</code>
    <code class="go">})</code>

    <code class="kr">const</code> <code class="nx">outputDir</code> <code class="o">=</code> <code class="s">'./screenshots/'</code> <code class="o">+</code> <code class="nx">browserEnv</code>
    <code class="nx">fs</code><code class="go">.</code><code class="nx">mkdirSync</code><code class="go">(</code><code class="nx">outputDir</code><code class="go">,</code> <code class="go">{</code> <code class="nx">recursive</code><code class="o">:</code> <code class="kr">true</code> <code class="go">})</code>

    <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="nx">url</code><code class="go">)</code>

    <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">wait</code><code class="go">(</code>
      <code class="nx">until</code><code class="go">.</code><code class="nx">elementLocated</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">className</code><code class="go">(</code><code class="s">'sidebar-item'</code><code class="go">)),</code>
      <code class="mi">60000</code>
    <code class="go">)</code>
    <code class="kr">let</code> <code class="nx">elements</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">findElements</code><code class="go">(</code>
      <code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'button.sidebar-item'</code><code class="go">)</code>
    <code class="go">)</code>
    <code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">e</code> <code class="nx">of</code> <code class="nx">elements</code><code class="go">)</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">expanded</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">e</code><code class="go">.</code><code class="nx">getAttribute</code><code class="go">(</code><code class="s">'aria-expanded'</code><code class="go">)</code>
      <code class="kr">if</code> <code class="go">(</code><code class="nx">expanded</code> <code class="o">!==</code> <code class="s">'true'</code><code class="go">)</code> <code class="go">{</code>
        <code class="nx">await</code> <code class="nx">e</code><code class="go">.</code><code class="nx">click</code><code class="go">()</code>
      <code class="go">}</code>
    <code class="go">}</code>
    <code class="kr">let</code> <code class="nx">links</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">driver</code><code class="go">.</code><code class="nx">findElements</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'a.sidebar-item'</code><code class="go">))</code>
    <code class="kr">for</code> <code class="go">(</code><code class="kr">let</code> <code class="nx">link</code> <code class="nx">of</code> <code class="nx">links</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">await</code> <code class="nx">link</code><code class="go">.</code><code class="nx">click</code><code class="go">()</code>
      <code class="kr">const</code> <code class="nx">s</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">link</code><code class="go">.</code><code class="nx">getAttribute</code><code class="go">(</code><code class="s">'id'</code><code class="go">)</code>
      <code class="kr">let</code> <code class="nx">encodedString</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">driver</code>
        <code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'#storybook-preview-wrapper'</code><code class="go">))</code>
        <code class="go">.</code><code class="nx">takeScreenshot</code><code class="go">()</code>
      <code class="nx">await</code> <code class="nx">fs</code><code class="go">.</code><code class="nx">writeFileSync</code><code class="go">(</code>
        <code class="err">`</code><code class="nx">$</code><code class="go">{</code><code class="nx">outputDir</code><code class="go">}</code><code class="o">/</code><code class="nx">$</code><code class="go">{</code><code class="nx">s</code><code class="go">}.</code><code class="nx">png</code><code class="err">`</code><code class="go">,</code>
        <code class="nx">encodedString</code><code class="go">,</code>
        <code class="s">'base64'</code>
      <code class="go">)</code>
    <code class="go">}</code>

    <code class="nx">driver</code><code class="go">.</code><code class="nx">quit</code><code class="go">()</code>
  <code class="go">},</code> <code class="mi">60000</code><code class="go">)</code>
<code class="go">})</code></pre>

<p class="author1">This script opens a browser to the Storybook server, opens each of the components, and takes a screenshot of each story, which it
stores in a subdirectory within 
<span class="firstname"><em class="calibre7">screenshots</em></span>.</p>

<p class="author1">We could use a different testing system to take screenshots of each component, such as Cypress. The advantage of using Selenium is
that we can remotely open a browser session on a remote machine.</p>

<p class="author1">By default, the <em class="calibre7">shots.spec.js</em> test will take screenshots of Storybook at address <em class="calibre7">http://localhost:6006</em> using the Chrome browser.
Let’s say we are running the <em class="calibre7">shots</em> test on a Mac. If we have a Windows machine on the same network, we can install a Selenium Grid
server, which is a <a href="https://oreil.ly/gYLds" class="calibre6">proxy server</a> that allows remote
machines to start a web driver session.<a data-type="indexterm" data-primary="proxies" data-secondary="Selenium Grid server" id="idm46634393690216" class="calibre6"/></p>

<p class="author1">If the Windows machine has address <code class="calibre21">192.168.1.16</code>, we can set this environment variable on the command line before running the
<em class="calibre7">shots.spec.js</em> test:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ export SELENIUM_REMOTE_URL=http://192.168.1.16:4444/wd/hub</code></pre>

<p class="author1">Because the Windows machine will be accessing the Storybook server back on the Mac, for example, with an IP address of
<code class="calibre21">192.168.1.14</code>, we will also need to set an environment variable for that on the command line:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ export START_URL=http://192.168.1.14:6006</code></pre>

<p class="author1">We can also choose which browser we want the Windows machine to use:<sup class="calibre34"><a data-type="noteref" id="idm46634393280696-marker" href="ch08_split_001.xhtml#idm46634393280696" class="calibre35">15</a></sup></p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ export SELENIUM_BROWSER=firefox</code></pre>

<p class="author1">If we create a script to run <em class="calibre7">shots.spec.js</em> in <em class="calibre7">package.json</em>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"> <code class="s">"scripts"</code><code class="o">:</code> <code class="go">{</code>
  <code class="go">...</code>
  <code class="s">"testShots"</code><code class="o">:</code> <code class="s">"CI=true react-scripts test --detectOpenHandles \</code>
<code class="s">                  'selenium/shots.spec.js'"</code>
  <code class="go">}</code></pre>

<p class="author1">we can run the test and capture the screenshots of each component:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm run testShots</code></pre>

<p class="author1">The test will use the environment variables we created to contact the Selenium Grid server on the remote machine. It will ask
Selenium Grid to open a Firefox browser to our local Storybook server. It will then send a screenshot of each of the components over
the network, where the test will store them in a folder called <em class="calibre7">screenshots/firefox</em>.</p>

<p class="author1">Once we’ve run it for Firefox, we can then run it for Chrome:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ export SELENIUM_BROWSER=chrome</code>
<code class="go">$ npm run testShots</code></pre>

<p class="author1">The test will write the Chrome screenshots to <em class="calibre7">screenshots/chrome</em>.</p>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">A fuller implementation of this technique would also record the operating system and type of client (e.g., screen size) used.</p>
</div>

<p class="author1">We now need to check for visual differences between the screenshots from Chrome and the screenshots from Firefox, and this is where
ImageMagick is useful.<a data-type="indexterm" data-primary="compare command (ImageMagick)" id="idm46634393163016" class="calibre6"/> The 
<span class="firstname"><code class="calibre21">compare</code></span> command in ImageMagick can generate an image that highlights the visual differences between two
other images. For example, consider the two screenshots from Firefox and Chrome in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_14" class="calibre6">Figure 8-14</a>.</p>

<figure class="calibre29"><div id="ch08_image_14" class="figure">
<img src="Images/recb_0814.png" alt="" class="calibre143"/>
<h6 class="calibre30"><span class="firstname">Figure 8-14. </span>The same component in Chrome and Firefox</h6>
</div></figure>

<p class="author1">These two images appear to be identical. If we type in this command from the application directory:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ compare -fuzz 15% screenshots/firefox/question--basic.png \</code>
<code class="go">  screenshots/chrome/question--basic.png difference.png</code></pre>

<p class="author1">we will generate a new image that shows the differences between the two screenshots, which you can see in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_15" class="calibre6">Figure 8-15</a>.</p>

<figure class="calibre29"><div id="ch08_image_15" class="figure">
<img src="Images/recb_0815.png" alt="" class="calibre144"/>
<h6 class="calibre30"><span class="firstname">Figure 8-15. </span>The generated image showing the differences between two screen captures</h6>
</div></figure>

<p class="author1">The generated image shows pixels that are more than 15% visually different between the two images. And you can see that the
screenshots are virtually identical.</p>

<p class="author1">That’s good, but it still requires a human being to look at the images and assess whether the differences are significant. What else
can we do?</p>

<p class="author1">The <code class="calibre21">compare</code> command also has the ability to display a numerical measure of the difference between two images:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ compare -metric AE -fuzz 15% screenshots/firefox/question--basic.png</code>
<code class="go">  screenshots/chrome/question--basic.png difference.png</code>
<code class="go">6774</code></pre>

<p class="author1">The value <code class="calibre21">6774</code> is a numerical measure (based on the absolute error count, or <em class="calibre7">AE</em>) of the visual difference between the two
images. For another example, consider the two screenshots in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_16" class="calibre6">Figure 8-16</a>, which show the <code class="calibre21">Answer</code> component when given a

<span class="firstname"><code class="calibre21">disabled</code></span> property.</p>

<figure class="calibre29"><div id="ch08_image_16" class="figure">
<img src="Images/recb_0816.png" alt="" class="calibre145"/>
<h6 class="calibre30"><span class="firstname">Figure 8-16. </span>Disabled form rendered by Chrome and Firefox</h6>
</div></figure>

<p class="author1">Comparing these two images returns a much larger number:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ compare -metric AE -fuzz 15% screenshots/firefox/answer--with-disabled.png</code>
<code class="go">  screenshots/chrome/answer--with-disabled.png difference3.png</code>
<code class="go">28713</code></pre>

<p class="author1">Indeed, the generated image (see <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_17" class="calibre6">Figure 8-17</a>) shows precisely where the difference lies: the disabled input field.</p>

<figure class="calibre29"><div id="ch08_image_17" class="figure">
<img src="Images/recb_0817.png" alt="" class="calibre146"/>
<h6 class="calibre30"><span class="firstname">Figure 8-17. </span>The visual difference between the Chrome and Firefox forms</h6>
</div></figure>

<p class="author1"><a data-type="xref" href="ch08_split_001.xhtml#ch08_image_18" class="calibre6">Figure 8-18</a> shows a similarly significant difference (21,131) for a component that displays different font styling between the
browsers, resulting from some Mozilla-specific CSS attributes.</p>

<figure class="calibre29"><div id="ch08_image_18" class="figure">
<img src="Images/recb_0818.png" alt="" class="calibre147"/>
<h6 class="calibre30"><span class="firstname">Figure 8-18. </span>A component with different text styling in Chrome and Firefox</h6>
</div></figure>

<p class="author1">In fact, it’s possible to write a shell script to run through each of the images and generate a small web report showing the visual
differences alongside their metrics:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">#!/bin/bash</code>
<code class="go">mkdir -p screenshots/diff</code>
<code class="go">export HTML=screenshots/compare.html</code>
<code class="go">echo '&lt;body&gt;&lt;ul&gt;' &gt; $HTML</code>
<code class="go">for file in screenshots/chrome/*.png</code>
<code class="go">do</code>
<code class="go">    FROM=$file</code>
<code class="go">    TO=$(echo $file | sed 's/chrome/firefox/')</code>
<code class="go">    DIFF=$(echo $file | sed 's/chrome/diff/')</code>
<code class="go">    echo "FROM $FROM TO $TO"</code>
<code class="go">    ls -l $FROM</code>
<code class="go">    ls -l $TO</code>
<code class="go">    METRIC=$(compare -metric AE -fuzz 15% $FROM $TO $DIFF 2&gt;&amp;1)</code>
<code class="go">    echo "&lt;li&gt;$FROM $METRIC&lt;br/&gt;&lt;img src=../$DIFF/&gt;&lt;/li&gt;" &gt;&gt; $HTML</code>
<code class="go">done</code>
<code class="go">echo "&lt;/li&gt;&lt;/body&gt;" &gt;&gt; $HTML</code></pre>

<p class="author1">This script creates the <em class="calibre7">screenshots/compare.html</em> report you can see in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_19" class="calibre6">Figure 8-19</a>.</p>

<figure class="calibre29"><div id="ch08_image_19" class="figure">
<img src="Images/recb_0819.png" alt="" class="calibre148"/>
<h6 class="calibre30"><span class="firstname">Figure 8-19. </span>An example of the generated comparison report</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634393086216">
<h2 class="calibre27">Discussion</h2>

<p class="author1">To save space, we have shown only a simplistic implementation of this technique. It would be possible to create a ranked report
that showed visual differences from largest to smallest. Such a report would highlight the most significant visual differences
between platforms.</p>

<p class="author1">You can also use automated visual tests to prevent regressions. You need to avoid false positives caused by minor variations, such
as anti-aliasing. A continuous integration job could set some visual threshold between images and fail if any components vary by
more than that threshold.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/P1Tqj" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="testing" data-secondary="cross-browser visuals, testing using ImageMagick" data-startref="ix_tstcrsbrws" id="idm46634392974856" class="calibre6"/><a data-type="indexterm" data-primary="ImageMagick, cross-testing browser visuals" data-startref="ix_ImgMag" id="idm46634392973480" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="cross-testing visuals using ImageMagick" data-startref="ix_brwscrstst" id="idm46634392972504" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Add a Console to Mobile Browsers" class="calibre4"><div class="preface" id="ch08-07">
<h1 class="calibre17">Add a Console to Mobile Browsers</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634392969544">
<h2 class="calibre27">Problem</h2>

<p class="author1">This recipe is slightly different from the others in this chapter because instead of being about automated testing, it’s about
manual testing—specifically manually testing code on mobile devices.<a data-type="indexterm" data-primary="testing" data-secondary="adding console to mobile browsers" id="ix_tstcnslmob" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="mobile" data-tertiary="adding console to" id="ix_brwsmobcnsl" class="calibre6"/><a data-type="indexterm" data-primary="mobile devices" data-secondary="adding console to mobile browsers" id="ix_mobdevcnsl" class="calibre6"/></p>

<p class="author1">If you are testing an application on a mobile, you might stumble across a bug that doesn’t appear in the desktop environment.
Generally, if a bug appears, you’re able to add debug messages into the JavaScript console. But mobile browsers tend not to have a
visible JavaScript console. It’s true that if you are using Mobile Chrome, you can try debugging it remotely with a desktop version
of Chrome. But what if you discover the problem in another browser? Or if you simply don’t want to go through the work of setting up
a remote debug session?</p>

<p class="author1">Is there some way to access the JavaScript console, and other development tools, from within a mobile browser?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634392962264">
<h2 class="calibre27">Solution</h2>

<p class="author1">We are going to use a piece of software called <a href="https://oreil.ly/jCFSn" class="calibre6">Eruda</a>.</p>

<p class="author1">Eruda <a data-type="indexterm" data-primary="Eruda" id="ix_Eruda" class="calibre6"/>is a lightweight implementation of a development tools panel, which will allow you to view the JavaScript console, the
structure of the page, and a whole heap of other <a href="https://oreil.ly/ZUQHw" class="calibre6">plugins and extensions</a>.</p>

<p class="author1">To enable Eruda, you will need to install a small amount of reasonably rudimentary JavaScript in the <code class="calibre21">head</code> section of your application. You can download Eruda from a content distribution network. Still, because it can be pretty large, you should enable it only if the person using the browser has indicated that they want to access it.</p>

<p class="author1">One way of doing this is by enabling Eruda only if <em class="calibre7">eruda=true</em> appears in the URL. Here’s an example script that you can insert into
your page container:<sup class="calibre34"><a data-type="noteref" id="idm46634392955256-marker" href="ch08_split_001.xhtml#idm46634392955256" class="calibre35">16</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">&lt;</code><code class="nt">script</code><code class="go">&gt;</code>
    <code class="go">(</code><code class="kr">function</code> <code class="go">()</code> <code class="go">{</code>
        <code class="kr">var</code> <code class="nx">src</code> <code class="o">=</code> <code class="s">'//cdn.jsdelivr.net/npm/eruda'</code><code class="go">;</code>
        <code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="sr">/eruda=true/</code><code class="go">.</code><code class="nx">test</code><code class="go">(</code><code class="nb">window</code><code class="go">.</code><code class="nx">location</code><code class="go">)</code>
            <code class="o">&amp;&amp;</code> <code class="nx">localStorage</code><code class="go">.</code><code class="nx">getItem</code><code class="go">(</code><code class="s">'active-eruda'</code><code class="go">)</code> <code class="o">!=</code> <code class="s">'true'</code><code class="go">)</code> <code class="kr">return</code><code class="go">;</code>
        <code class="nb">document</code><code class="go">.</code><code class="nx">write</code><code class="go">(</code><code class="s">'&lt;scr'</code> <code class="o">+</code> <code class="s">'ipt src="'</code> <code class="o">+</code> <code class="nx">src</code>
            <code class="o">+</code> <code class="s">'"&gt;&lt;/scr'</code> <code class="o">+</code> <code class="s">'ipt&gt;'</code><code class="go">);</code>
        <code class="nb">document</code><code class="go">.</code><code class="nx">write</code><code class="go">(</code><code class="s">'&lt;scr'</code> <code class="o">+</code> <code class="s">'ipt&gt;'</code><code class="go">);</code>
        <code class="nb">document</code><code class="go">.</code><code class="nx">write</code><code class="go">(</code><code class="s">'window.addEventListener('</code> <code class="o">+</code>
            <code class="s">'"load", '</code> <code class="o">+</code>
            <code class="s">'function () {'</code> <code class="o">+</code>
            <code class="s">'  var container=document.createElement("div"); '</code> <code class="o">+</code>
            <code class="s">'  document.body.appendChild(container);'</code> <code class="o">+</code>
            <code class="s">'  eruda.init({'</code> <code class="o">+</code>
            <code class="s">'    container: container,'</code> <code class="o">+</code>
            <code class="s">'    tool: ["console", "elements"]'</code> <code class="o">+</code>
            <code class="s">'  });'</code> <code class="o">+</code>
            <code class="s">'})'</code><code class="go">);</code>
        <code class="nb">document</code><code class="go">.</code><code class="nx">write</code><code class="go">(</code><code class="s">'&lt;/scr'</code> <code class="o">+</code> <code class="s">'ipt&gt;'</code><code class="go">);</code>
    <code class="go">})();</code>
<code class="go">&lt;/</code><code class="nt">script</code><code class="go">&gt;</code></pre>

<p class="author1">If you now open your application as <em class="calibre7">http://ipaddress/?eruda=true</em> or <em class="calibre7">http://ipaddress/#eruda=true</em>, you will notice that an additional
button has appeared in the interface, as shown in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_20" class="calibre6">Figure 8-20</a>.</p>

<figure class="calibre29"><div id="ch08_image_20" class="figure">
<img src="Images/recb_0820.png" alt="" class="calibre149"/>
<h6 class="calibre30"><span class="firstname">Figure 8-20. </span>If you add <span class="firstname">?eruda=true</span> to the URL, a button will appear on the right of the page</h6>
</div></figure>

<p class="author1">If you are using the example application for this chapter, then try entering a few answers into the game.<sup class="calibre34"><a data-type="noteref" id="idm46634392840120-marker" href="ch08_split_001.xhtml#idm46634392840120" class="calibre35">17</a></sup> Then, click the Eruda button. The console will appear as shown in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_21" class="calibre6">Figure 8-21</a>.</p>

<figure class="calibre29"><div id="ch08_image_21" class="figure">
<img src="Images/recb_0821.png" alt="" class="calibre150"/>
<h6 class="calibre30"><span class="firstname">Figure 8-21. </span>Clicking the button opens the Eruda tools</h6>
</div></figure>

<p class="author1">Because the endpoint the example application calls is missing, you should find some errors and other logs recorded in the console.
The console even supports the much underused <code class="calibre21">console.table</code> function, which is a helpful way of displaying an array of objects in
tabular format.<a data-type="indexterm" data-primary="DOM" data-secondary="viewing in Eruda Elements tab" id="idm46634392834504" class="calibre6"/></p>

<p class="author1">The Elements tab provides a fairly rudimentary view of the DOM (see <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_22" class="calibre6">Figure 8-22</a>).</p>

<figure class="calibre29"><div id="ch08_image_22" class="figure">
<img src="Images/recb_0822.png" alt="" class="calibre150"/>
<h6 class="calibre30"><span class="firstname">Figure 8-22. </span>The Eruda elements view</h6>
</div></figure>

<p class="author1">Meanwhile, the Settings tab has an extensive set of JavaScript features that you can enable and disable while interacting with the
web page (see <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_23" class="calibre6">Figure 8-23</a>).</p>

<figure class="calibre29"><div id="ch08_image_23" class="figure">
<img src="Images/recb_0823.png" alt="" class="calibre150"/>
<h6 class="calibre30"><span class="firstname">Figure 8-23. </span>The Eruda settings view</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634392961640">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Eruda is a delightful tool that delivers a whole bucket of functionality, with very little work required by the developer. In
addition to the basic features, it also has plugins that allow you to track performance, set the screen refresh rate, generate fake

<span class="firstname">geolocations</span>, and even write and run JavaScript from inside the browser. Once you start to use it, you probably find that it quickly
becomes a standard part of your manual testing process.<a data-type="indexterm" data-primary="Eruda" data-startref="ix_Eruda" id="idm46634392824024" class="calibre6"/></p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/P1Tqj" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="testing" data-secondary="adding console to mobile browsers" data-startref="ix_tstcnslmob" id="idm46634392821976" class="calibre6"/><a data-type="indexterm" data-primary="browsers" data-secondary="mobile" data-tertiary="adding console to" data-startref="ix_brwsmobcnsl" id="idm46634392820728" class="calibre6"/><a data-type="indexterm" data-primary="mobile devices" data-secondary="adding console to mobile browsers" data-startref="ix_mobdevcnsl" id="idm46634392819240" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Remove Randomness from Tests" class="calibre4"><div class="preface" id="ch08-08">
<h1 class="calibre17">Remove Randomness from Tests</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634392816328">
<h2 class="calibre27">Problem</h2>

<p class="author1">In a perfect world, tests would always have a completely artificial environment.<a data-type="indexterm" data-primary="randomness, removing from tests" id="ix_rndm" class="calibre6"/> Tests are examples of how you would like your
application to work under explicitly defined conditions. But tests often have to cope with uncertainties. For example, they might
run at different times of day. The example application that we have used throughout this chapter has to deal with <em class="calibre7">randomness</em>.</p>

<p class="author1">Our example application is a game that presents the user with a randomly generated question that they must answer (see <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_24" class="calibre6">Figure 8-24</a>).</p>

<figure class="calibre29"><div id="ch08_image_24" class="figure">
<img src="Images/recb_0802.png" alt="" class="calibre134"/>
<h6 class="calibre30"><span class="firstname">Figure 8-24. </span>The game asks the user to calculate a random multiplication problem</h6>
</div></figure>

<p class="author1">Randomness might also appear in the generation of identifiers within the code or random data sets. If you ask for a new username,
your application might suggest a randomly generated string.</p>

<p class="author1">But randomness creates a problem for tests. This is an example test that we implemented earlier in this chapter:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should notify the server if I lose'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I started the application</code>
    <code class="c">// When I enter an incorrect answer</code>
    <code class="c">// Then the server will be told that I have lost</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">There was actually a good reason why that test looked at the case where the user entered an <em class="calibre7">incorrect</em> answer. The question
asked is always to calculate the product of two numbers between 1 and 10. It’s therefore easy to think of an incorrect answer: 101.
It will <em class="calibre7">always</em> be wrong. But if we want to write a test to show what happens when the user enters the <em class="calibre7">correct</em> answer, we have a
problem. The correct answer depends upon data that is randomly generated. We could write some code that finds the two numbers that
appear on the screen, as in this example from the first Selenium recipe in this chapter:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="go">[</code><code class="nx">number1</code><code class="go">,</code> <code class="nx">number2</code><code class="go">,</code> <code class="nx">input</code><code class="go">,</code> <code class="nx">submit</code><code class="go">]</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">Promise</code><code class="go">.</code><code class="nx">all</code><code class="go">([</code>
  <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.number1'</code><code class="go">)).</code><code class="nx">getText</code><code class="go">(),</code>
  <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'.number2'</code><code class="go">)).</code><code class="nx">getText</code><code class="go">(),</code>
  <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">css</code><code class="go">(</code><code class="s">'input'</code><code class="go">)),</code>
  <code class="nx">driver</code><code class="go">.</code><code class="nx">findElement</code><code class="go">(</code><code class="nx">By</code><code class="go">.</code><code class="nx">xpath</code><code class="go">(</code><code class="s">"//button[text()='Submit']"</code><code class="go">)),</code>
<code class="go">])</code>
<code class="nx">await</code> <code class="nx">input</code><code class="go">.</code><code class="nx">sendKeys</code><code class="go">(</code><code class="s">''</code> <code class="o">+</code> <code class="nx">number1</code> <code class="o">*</code> <code class="nx">number2</code><code class="go">)</code>
<code class="nx">await</code> <code class="nx">submit</code><code class="go">.</code><code class="nx">click</code><code class="go">()</code></pre>

<p class="author1">Sometimes this approach is not even possible. For example, Cypress does not allow you to capture data from the page. If we wanted to
write a Cypress test to enter the correct answer to the multiplication problem, we would have great difficulty. That’s because Cypress does
not allow you to capture values from the page and pass them to other steps in the test.</p>

<p class="author1">It would be much better if we could turn off the randomness during a test.</p>

<p class="author1">But can we?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634392815704">
<h2 class="calibre27">Solution</h2>

<p class="author1">We will look at how we can use the Sinon library to temporarily replace the <code class="calibre21">Math.random</code> function with a faked one of our own
making.<a data-type="indexterm" data-primary="Sinon library" id="idm46634392612920" class="calibre6"/><a data-type="indexterm" data-primary="Math.random function, fixing return value of" id="ix_Mathrndm" class="calibre6"/></p>

<p class="author1">Let’s first consider how we can do this inside a unit test. We’ll create a new test for the top-level <code class="calibre21">App</code> component, which will
check that entering the correct value results in a message saying that we won.</p>

<p class="author1">We’ll create a function that will fix the return value of <code class="calibre21">Math.random</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">sinon</code> <code class="o">=</code> <code class="nx">require</code><code class="go">(</code><code class="s">'sinon'</code><code class="go">)</code>

<code class="kr">function</code> <code class="nx">makeRandomAlways</code><code class="go">(</code><code class="nx">result</code><code class="go">)</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nb">Math</code><code class="go">.</code><code class="nx">random</code><code class="go">.</code><code class="nx">restore</code><code class="go">)</code> <code class="go">{</code>
    <code class="nb">Math</code><code class="go">.</code><code class="nx">random</code><code class="go">.</code><code class="nx">restore</code><code class="go">()</code>
  <code class="go">}</code>
  <code class="nx">sinon</code><code class="go">.</code><code class="nx">stub</code><code class="go">(</code><code class="nb">Math</code><code class="go">,</code> <code class="s">'random'</code><code class="go">).</code><code class="nx">returns</code><code class="go">(</code><code class="nx">result</code><code class="go">)</code>
<code class="go">}</code></pre>

<p class="author1">This function works by replacing the <code class="calibre21">random</code> method of the <code class="calibre21">Math</code> object with a stubbed method that always returns the same
value. We can now use this in a test. The <code class="calibre21">Question</code> that appears on the page always generates random numbers between 1 and 10,
based upon the value of:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nb">Math</code><code class="go">.</code><code class="nx">random</code><code class="go">()</code> <code class="o">*</code> <code class="mi">10</code> <code class="o">+</code> <code class="mi">1</code></pre>

<p class="author1">If we fix <code class="calibre21">Math.random</code> so that it always produced the value 0.5, then the “random” number will always be 6. That means we can
write a unit test like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">it</code><code class="go">(</code><code class="s">'should tell you that you entered the right answer'</code><code class="go">,</code> <code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="c">// Given we've rendered the app</code>
  <code class="nx">makeRandomAlways</code><code class="go">(</code><code class="mi">0.5</code><code class="go">)</code>
  <code class="nx">render</code><code class="go">(&lt;</code><code class="nt">App</code> <code class="go">/&gt;)</code>

  <code class="c">// When we enter the correct answer</code>
  <code class="kr">const</code> <code class="nx">input</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByLabelText</code><code class="go">(</code><code class="sr">/guess:/i</code><code class="go">)</code>
  <code class="kr">const</code> <code class="nx">submitButton</code> <code class="o">=</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">getByText</code><code class="go">(</code><code class="s">'Submit'</code><code class="go">)</code>
  <code class="nx">user</code><code class="go">.</code><code class="nx">type</code><code class="go">(</code><code class="nx">input</code><code class="go">,</code> <code class="s">'36'</code><code class="go">)</code>
  <code class="nx">user</code><code class="go">.</code><code class="nx">click</code><code class="go">(</code><code class="nx">submitButton</code><code class="go">)</code>

  <code class="c">// Then we are told that we've won</code>
  <code class="nx">await</code> <code class="nx">waitFor</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="nx">screen</code><code class="go">.</code><code class="nx">findByText</code><code class="go">(</code><code class="sr">/won/i</code><code class="go">),</code> <code class="go">{</code> <code class="nx">timeout</code><code class="o">:</code> <code class="mi">4000</code> <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">And this test will always pass because the application will always ask the question, “What is 6 × 6?”</p>

<p class="author1">The real value of fixing <code class="calibre21">Math.random</code> is when we use a testing framework that explicitly <em class="calibre7">prevents</em> us from capturing a randomly
generated value such as Cypress, as we saw earlier.<a data-type="indexterm" data-primary="Cypress" data-secondary="creating new command cy.random" id="idm46634392394728" class="calibre6"/></p>

<p class="author1">Cypress allows us to add custom commands by adding them to the <em class="calibre7">cypress/support/commands.js</em> script. If you edit that file
and add this code:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">Cypress</code><code class="go">.</code><code class="nx">Commands</code><code class="go">.</code><code class="nx">add</code><code class="go">(</code><code class="s">'random'</code><code class="go">,</code> <code class="go">(</code><code class="nx">result</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">cy</code><code class="go">.</code><code class="nx">reload</code><code class="go">().</code><code class="nx">then</code><code class="go">((</code><code class="nx">win</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">win</code><code class="go">.</code><code class="nb">Math</code><code class="go">.</code><code class="nx">random</code><code class="go">.</code><code class="nx">restore</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">win</code><code class="go">.</code><code class="nb">Math</code><code class="go">.</code><code class="nx">random</code><code class="go">.</code><code class="nx">restore</code><code class="go">()</code>
    <code class="go">}</code>
    <code class="nx">sinon</code><code class="go">.</code><code class="nx">stub</code><code class="go">(</code><code class="nx">win</code><code class="go">.</code><code class="nb">Math</code><code class="go">,</code> <code class="s">'random'</code><code class="go">).</code><code class="nx">returns</code><code class="go">(</code><code class="nx">result</code><code class="go">)</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">you will create a new command called <code class="calibre21">cy.random</code>. We can use this command to create a test for the <em class="calibre7">winning</em> case that we
discussed in the introduction:<sup class="calibre34"><a data-type="noteref" id="idm46634392341560-marker" href="ch08_split_001.xhtml#idm46634392341560" class="calibre35">18</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should notify the server if I win'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I started the application</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">intercept</code><code class="go">(</code><code class="s">'POST'</code><code class="go">,</code> <code class="s">'/api/result'</code><code class="go">,</code> <code class="go">{</code>
      <code class="nx">statusCode</code><code class="o">:</code> <code class="mi">200</code><code class="go">,</code>
      <code class="nx">body</code><code class="o">:</code> <code class="s">''</code><code class="go">,</code>
    <code class="go">}).</code><code class="nx">as</code><code class="go">(</code><code class="s">'postResult'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">random</code><code class="go">(</code><code class="mi">0.5</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'Refresh'</code><code class="go">).</code><code class="nx">click</code><code class="go">()</code>

    <code class="c">// When I enter the correct answer</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'input'</code><code class="go">).</code><code class="nx">type</code><code class="go">(</code><code class="s">'36'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'Submit'</code><code class="go">).</code><code class="nx">click</code><code class="go">()</code>

    <code class="c">// Then the server will be told that I have won</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">wait</code><code class="go">(</code><code class="s">'@postResult'</code><code class="go">).</code><code class="nx">then</code><code class="go">((</code><code class="nx">xhr</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">assert</code><code class="go">.</code><code class="nx">deepEqual</code><code class="go">(</code><code class="nx">xhr</code><code class="go">.</code><code class="nx">request</code><code class="go">.</code><code class="nx">body</code><code class="go">,</code> <code class="go">{</code>
        <code class="nx">guess</code><code class="o">:</code> <code class="mi">36</code><code class="go">,</code>
        <code class="nx">answer</code><code class="o">:</code> <code class="mi">36</code><code class="go">,</code>
        <code class="nx">result</code><code class="o">:</code> <code class="s">'WIN'</code><code class="go">,</code>
      <code class="go">})</code>
    <code class="go">})</code>
  <code class="go">})</code>
<code class="go">})</code></pre>
<div data-type="note" epub:type="note" class="calibre25">
<p class="author1">After calling the <code class="calibre21">cy.random</code> command, we need to click the Refresh button in case the application generated the random
numbers before the <code class="calibre21">Math.random</code> function was replaced.</p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634392613992">
<h2 class="calibre27">Discussion</h2>

<p class="author1">You can never remove all randomness from a test. For example, the machine’s performance can significantly affect when and how often
your components are re-rendered. But removing uncertainty as much as we can is generally a good thing in a test. The more we can do
to remove external dependencies from our tests, the better.</p>

<p class="author1">We will also look at removing external dependencies in the following recipe.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/P1Tqj" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="Math.random function, fixing return value of" data-startref="ix_Mathrndm" id="idm46634392166184" class="calibre6"/><a data-type="indexterm" data-primary="randomness, removing from tests" data-startref="ix_rndm" id="idm46634392165080" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Time Travel" class="calibre4"><div class="preface" id="ch08-09">
<h1 class="calibre17">Time Travel</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634392162488">
<h2 class="calibre27">Problem</h2>

<p class="author1">Time can be the source of a tremendous number of bugs.<a data-type="indexterm" data-primary="testing" data-secondary="time-dependent code" id="ix_tsttime" class="calibre6"/><a data-type="indexterm" data-primary="dates and time" data-secondary="fixing time within a test" id="ix_datmfixtm" class="calibre6"/><a data-type="indexterm" data-primary="time" data-seealso="dates and time" id="idm46634392158696" class="calibre6"/> If time were simply a scientific measurement, it would be relatively
straightforward.<a data-type="indexterm" data-primary="browsers" data-secondary="time-based tests in" id="ix_brwstime" class="calibre6"/> But it isn’t. The representation of time is affected by national boundaries and by local laws. Some countries have
their own time zone. Others have multiple time zones. One reassuring factor is that all countries have a time zone offset in whole
hours, except for places like India, where time is offset by +05:30 from UTC.</p>

<p class="author1">That’s why it is helpful to try to fix the time within a test. But how do we do that?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634392155304">
<h2 class="calibre27">Solution</h2>

<p class="author1">We will look at how you can fix the time when testing your React application. There are some issues that you need to consider when
testing time-dependent code. First, you should probably avoid changing the time on your server. In most cases, it’s best
to set your server to UTC and leave it that way.<a data-type="indexterm" data-primary="Coordinated Universal Time (UTC)" id="idm46634392153064" class="calibre6"/><a data-type="indexterm" data-primary="UTC (Coordinated Universal Time)" id="idm46634392152392" class="calibre6"/></p>

<p class="author1">That does mean that if you want to fake date and time in your browser, you will have problems as soon as the browser makes contact
with the server.<a data-type="indexterm" data-primary="effective date" id="idm46634392151160" class="calibre6"/> That means you will either have to modify the server APIs to accept an <em class="calibre7">effective date</em> or test time-dependent browser code in isolation from the server.<sup class="calibre34"><a data-type="noteref" id="idm46634392149944-marker" href="ch08_split_001.xhtml#idm46634392149944" class="calibre35">19</a></sup></p>

<p class="author1">We will adopt the latter approach for this recipe: using the Cypress testing system to fake any connections with the server.</p>

<p class="author1">We will use the same application we use for other recipes in this chapter. It’s a simple game that asks the user to calculate the
product of two numbers. We’re going to test a feature of the game that gives the user 30 seconds to provide an answer. After 30
seconds, they will see a message telling them they’ve run out of time (see <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_25" class="calibre6">Figure 8-25</a>).</p>

<figure class="calibre29"><div id="ch08_image_25" class="figure">
<img src="Images/recb_0825.png" alt="" class="calibre151"/>
<h6 class="calibre30"><span class="firstname">Figure 8-25. </span>The player will lose if they don’t answer within 30 seconds</h6>
</div></figure>

<p class="author1">We could try writing a test that somehow pauses for 30 seconds, but that has two problems. First, it will slow your test down. You
don’t need many 30-second pauses before your tests will become unbearable to run. Second, adding a pause is not a very precise way
to test a feature. If you try to pause for 30 seconds, you might pause for 30.5 seconds before looking for the message.</p>

<p class="author1">To get precision, we need to take control of time within the browser. As you saw in the previous recipe, Cypress can inject code
into the browser, replacing critical pieces of code with stubbed functions, which we can control. <a data-type="indexterm" data-primary="Cypress" data-secondary="specifying current time with cy.clock command" id="idm46634392143272" class="calibre6"/>Cypress has a built-in command
called <code class="calibre21">cy.clock</code>, which allows us to specify the current time.</p>

<p class="author1">Let’s see how to use <code class="calibre21">cy.clock</code> by creating a test for the timeout feature. This will be the structure of our test:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should say if I timed out'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I have started a new game</code>
    <code class="c">// When 29 seconds have passed</code>
    <code class="c">// Then I will not see the time-out message</code>
    <code class="c">// When another second has passed</code>
    <code class="c">// Then I will see the time-out message</code>
    <code class="c">// And the game will be over</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">We can start by opening the application and clicking the Refresh button:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should say if I timed out'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I have started a new game</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'Refresh'</code><code class="go">).</code><code class="nx">click</code><code class="go">()</code>

    <code class="c">// When 29 seconds have passed</code>
    <code class="c">// Then I will not see the time-out message</code>
    <code class="c">// When another second has passed</code>
    <code class="c">// Then I will see the time-out message</code>
    <code class="c">// And the game will be over</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">Now we need to simulate 29 seconds of time passing. <a data-type="indexterm" data-primary="Cypress" data-secondary="simulating time passing with cy.clock and cy.tick" id="idm46634392119688" class="calibre6"/>We can do this with the <code class="calibre21">cy.clock</code> and <code class="calibre21">cy.tick</code> commands. The <code class="calibre21">cy.clock</code>
command allows you to either specify a new date and time; or, if you call <code class="calibre21">cy.clock</code> without parameters, it will set the time and date back to 1970. The <code class="calibre21">cy.tick()</code> command allows you to add a set number of milliseconds to the current date and time:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should say if I timed out'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I have started a new game</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">clock</code><code class="go">()</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'Refresh'</code><code class="go">).</code><code class="nx">click</code><code class="go">()</code>

    <code class="c">// When 29 seconds have passed</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">tick</code><code class="go">(</code><code class="mi">29000</code><code class="go">)</code>

    <code class="c">// Then I will not see the time-out message</code>
    <code class="c">// When another second has passed</code>
    <code class="c">// Then I will see the time-out message</code>
    <code class="c">// And the game will be over</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">We can now complete the other steps in the test. For details on the other Cypress commands we’re using, see the
<a href="https://oreil.ly/vahMA" class="calibre6">Cypress documentation</a>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Basic game functions'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should say if I timed out'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="c">// Given I have started a new game</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">clock</code><code class="go">()</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'Refresh'</code><code class="go">).</code><code class="nx">click</code><code class="go">()</code>

    <code class="c">// When 29 seconds have passed</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">tick</code><code class="go">(</code><code class="mi">29000</code><code class="go">)</code>

    <code class="c">// Then I will not see the time-out message</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="sr">/out of time/i</code><code class="go">).</code><code class="nx">should</code><code class="go">(</code><code class="s">'not.exist'</code><code class="go">)</code>

    <code class="c">// When another second has passed</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">tick</code><code class="go">(</code><code class="mi">1000</code><code class="go">)</code>

    <code class="c">// Then I will see the time-out message</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="sr">/out of time/i</code><code class="go">).</code><code class="nx">should</code><code class="go">(</code><code class="s">'be.visible'</code><code class="go">)</code>

    <code class="c">// And the game will be over</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'input'</code><code class="go">).</code><code class="nx">should</code><code class="go">(</code><code class="s">'be.disabled'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'Submit'</code><code class="go">).</code><code class="nx">should</code><code class="go">(</code><code class="s">'be.disabled'</code><code class="go">)</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">If we run the test in Cypress, it passes (as you can see in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_26" class="calibre6">Figure 8-26</a>).</p>

<figure class="calibre29"><div id="ch08_image_26" class="figure">
<img src="Images/recb_0825.png" alt="" class="calibre151"/>
<h6 class="calibre30"><span class="firstname">Figure 8-26. </span>By controlling time, we can force a timeout in the test</h6>
</div></figure>

<p class="author1">That’s a relatively simple time-based test. But what if we wanted to test something much more complex, like daylight saving time (DST)?<a data-type="indexterm" data-primary="DST (daylight saving time), testing" id="idm46634391790552" class="calibre6"/><a data-type="indexterm" data-primary="daylight saving time (DST), testing" id="idm46634391789832" class="calibre6"/></p>

<p class="author1">DST bugs are the bane of most development teams. They sit in your codebase silently for months and then suddenly appear in the spring and fall, in the early hours of the morning.</p>

<p class="author1">When DST occurs depends upon your time zone.<a data-type="indexterm" data-primary="time zones, DST and" id="idm46634391788088" class="calibre6"/><a data-type="indexterm" data-primary="JavaScript" data-secondary="dates not working with time zones" id="idm46634391787384" class="calibre6"/> And that’s a particularly awful thing to deal with in client code because JavaScript dates don’t work with time zones. They can certainly handle offsets; for example, you can create a <code class="calibre21">Date</code> object in a browser like Chrome that is set to five hours before Greenwich Mean Time:<sup class="calibre34"><a data-type="noteref" id="idm46634391785704-marker" href="ch08_split_001.xhtml#idm46634391785704" class="calibre35">20</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">new</code> <code class="nb">Date</code><code class="go">(</code><code class="s">'2021-03-14 01:59:30 GMT-0500'</code><code class="go">)</code></pre>

<p class="author1">But JavaScript dates are all implicitly in the time zone of the browser. When you create a date with a time zone name in it, the
JavaScript engine will simply shift it into the browser’s time zone.</p>

<p class="author1">The browser’s time zone is fixed at the time that the browser opens. There’s no way to say <em class="calibre7">Let’s pretend we’re in New York from now
on</em>.</p>

<p class="author1">If developers create tests for DST, the tests might work only in the developer’s time zone. The tests might fail if run on an integration server set to UTC.</p>

<p class="author1">There is, however, a way around this problem. On Linux and Mac computers (but not Windows), you can specify the time zone when you
launch a browser by setting an environment variable called <code class="calibre21">TZ</code>. If we start the Cypress with the <code class="calibre21">TZ</code> variable set, any browser
that Cypress launches will inherit it, which means that while we can’t set the time zone for a single test, we can set it for an
entire test run.</p>

<p class="author1">First, let’s launch Cypress with the time zone set to New York:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ TZ='America/New_York' npx cypress open</code></pre>

<p class="author1">The example application has a button that allows you to see the current time (see <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_27" class="calibre6">Figure 8-27</a>).</p>

<figure class="calibre29"><div id="ch08_image_27" class="figure">
<img src="Images/recb_0827.png" alt="" class="calibre152"/>
<h6 class="calibre30"><span class="firstname">Figure 8-27. </span>The current time is shown on the screen</h6>
</div></figure>

<p class="author1">We can create a test that checks that the time on the page correctly handles the change to DST.<a data-type="indexterm" data-primary="Cypress" data-secondary="testing daylight saving time (DST)" id="idm46634391758968" class="calibre6"/> This is the test we’ll create:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">describe</code><code class="go">(</code><code class="s">'Timing'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">it</code><code class="go">(</code><code class="s">'should tell us the current time'</code><code class="go">,</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">clock</code><code class="go">(</code><code class="kr">new</code> <code class="nb">Date</code><code class="go">(</code><code class="s">'2021-03-14 01:59:30'</code><code class="go">).</code><code class="nx">getTime</code><code class="go">())</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">visit</code><code class="go">(</code><code class="s">'http://localhost:3000'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'Show time'</code><code class="go">).</code><code class="nx">click</code><code class="go">()</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'2021-03-14T01:59:30.000'</code><code class="go">).</code><code class="nx">should</code><code class="go">(</code><code class="s">'be.visible'</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">tick</code><code class="go">(</code><code class="mi">30000</code><code class="go">)</code>
    <code class="nx">cy</code><code class="go">.</code><code class="nx">contains</code><code class="go">(</code><code class="s">'2021-03-14T03:00:00.000'</code><code class="go">).</code><code class="nx">should</code><code class="go">(</code><code class="s">'be.visible'</code><code class="go">)</code>
  <code class="go">})</code>
<code class="go">})</code></pre>

<p class="author1">In this test, we are passing an explicit date to <code class="calibre21">cy.clock</code>. We need to convert this to milliseconds by calling <code class="calibre21">getTime</code> as
<code class="calibre21">cy.clock</code> accepts only numeric times. We then check the initial time, and 30 seconds later, we check the time rolls over to 3 a.m.,
instead of 2 a.m. (as shown in <a data-type="xref" href="ch08_split_001.xhtml#ch08_image_28" class="calibre6">Figure 8-28</a>).</p>

<figure class="calibre29"><div id="ch08_image_28" class="figure">
<img src="Images/recb_0828.png" alt="" class="calibre153"/>
<h6 class="calibre30"><span class="firstname">Figure 8-28. </span>After 30 seconds, the time correctly changes from 01:59 to 03:00</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634392154360">
<h2 class="calibre27">Discussion</h2>

<p class="author1">If you need to create tests that depend on the current time zone, consider placing them into a subfolder so you can run them
separately. If you want to format dates into various time zones, you can use the <code class="calibre21">toLocaleString</code> date method:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">new</code> <code class="nb">Date</code><code class="go">().</code><code class="nx">toLocaleString</code><code class="go">(</code><code class="s">'en-US'</code><code class="go">,</code> <code class="go">{</code> <code class="nx">timeZone</code><code class="o">:</code> <code class="s">'Asia/Tokyo'</code> <code class="go">})</code></pre>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/P1Tqj" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="browsers" data-secondary="time-based tests in" data-startref="ix_brwstime" id="idm46634391589848" class="calibre6"/><a data-type="indexterm" data-primary="testing" data-secondary="time-dependent code" data-startref="ix_tsttime" id="idm46634391588664" class="calibre6"/><a data-type="indexterm" data-primary="dates and time" data-secondary="fixing time within a test" data-startref="ix_datmfixtm" id="idm46634391587448" class="calibre6"/><a data-type="indexterm" data-primary="testing" data-startref="ix_tstng" id="idm46634391586264" class="calibre6"/></p>
</div></section>





</div></section>







<div data-type="footnotes" class="calibre49"><p data-type="footnote" id="idm46634397841208" class="calibre50"><sup class="calibre51"><a href="ch08_split_000.xhtml#idm46634397841208-marker" class="calibre35">1</a></sup> You will see in other recipes in this chapter that it’s possible to dynamically remove the randomness from a test and fix the correct answer without capturing the question from the page.</p><p data-type="footnote" id="idm46634397514504" class="calibre50"><sup class="calibre51"><a href="ch08_split_000.xhtml#idm46634397514504-marker" class="calibre35">2</a></sup> Notice that many tests make text comparisons using regular expressions, which allows, as in this example, for case-insensitive matches of substrings. Regular expressions can prevent tests from breaking frequently.</p><p data-type="footnote" id="idm46634396575256" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634396575256-marker" class="calibre35">3</a></sup> See the source code in the <a href="https://oreil.ly/P1Tqj" class="calibre6">GitHub repository</a> to see how we’ve structured the code in the example application.</p><p data-type="footnote" id="idm46634396570056" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634396570056-marker" class="calibre35">4</a></sup> If you don’t have the Testing Library installed, see <a data-type="xref" href="ch08_split_000.xhtml#ch08-01" class="calibre6">“Use the React Testing Library”</a>.</p><p data-type="footnote" id="idm46634396204872" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634396204872-marker" class="calibre35">5</a></sup> Either directly or indirectly via libraries such as Axios.</p><p data-type="footnote" id="idm46634396201256" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634396201256-marker" class="calibre35">6</a></sup> It doesn’t matter what you call the file, but we follow the convention of prefixing high-level tests such as this with story numbers. Doing so reduces the likelihood of test merge conflicts and makes it much easier to track the intent of individual changes.</p><p data-type="footnote" id="idm46634396063368" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634396063368-marker" class="calibre35">7</a></sup> This will run the tests more quickly and record a video for each one, which is helpful if your tests run on an integration server.</p><p data-type="footnote" id="idm46634396079192" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634396079192-marker" class="calibre35">8</a></sup> Cypress commands are similar in many ways to promises, although they are not promises. You can think of each one as a “prom-ish.”</p><p data-type="footnote" id="idm46634395808488" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634395808488-marker" class="calibre35">9</a></sup> The <code class="calibre21">cy.intercept</code> command cannot simply return a reference to the faked network request because of the chainable nature of Cypress commands.</p><p data-type="footnote" id="idm46634395450040" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634395450040-marker" class="calibre35">10</a></sup> See <a data-type="xref" href="ch03.xhtml#ch03-05" class="calibre6">“Monitor Online Status”</a>.</p><p data-type="footnote" id="idm46634394974248" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634394974248-marker" class="calibre35">11</a></sup> This doesn’t mean that the tests will work against every browser, just that they will all run across every browser.</p><p data-type="footnote" id="idm46634394947128" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634394947128-marker" class="calibre35">12</a></sup> We are following a convention where we prefix the test with its associated story number. Selenium does not require this.</p><p data-type="footnote" id="idm46634394193224" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634394193224-marker" class="calibre35">13</a></sup> You will find the code to do this in the downloadable source for this chapter from <a href="https://oreil.ly/P1Tqj" class="calibre6">GitHub</a>.</p><p data-type="footnote" id="idm46634393644856" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634393644856-marker" class="calibre35">14</a></sup> You could put this script anywhere, but this is the location we used in the example code on the GitHub site.</p><p data-type="footnote" id="idm46634393280696" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634393280696-marker" class="calibre35">15</a></sup> The remote machine must have the appropriate browser and web driver installed for this to work.</p><p data-type="footnote" id="idm46634392955256" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634392955256-marker" class="calibre35">16</a></sup> For <code class="calibre21">create-react-app</code> applications, this should be added to <em class="calibre7">public/index.html</em>.</p><p data-type="footnote" id="idm46634392840120" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634392840120-marker" class="calibre35">17</a></sup> The code is available in the <a href="https://oreil.ly/P1Tqj" class="calibre6">source code repository</a> for this book.</p><p data-type="footnote" id="idm46634392341560" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634392341560-marker" class="calibre35">18</a></sup> You can find out more about this test in <a data-type="xref" href="ch08_split_001.xhtml#ch08-03" class="calibre6">“Test Without a Server Using Cypress”</a>.</p><p data-type="footnote" id="idm46634392149944" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634392149944-marker" class="calibre35">19</a></sup> That is, allow the browser to say to the server <em class="calibre7">Let’s pretend it’s Thursday, April 14</em>.</p><p data-type="footnote" id="idm46634391785704" class="calibre50"><sup class="calibre51"><a href="ch08_split_001.xhtml#idm46634391785704-marker" class="calibre35">20</a></sup> Firefox will not generally accept this format.</p></div></div></section></div></body></html>