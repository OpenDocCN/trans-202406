<html><head></head><body><section data-pdf-bookmark="Chapter 2. Protocols" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_protocols">&#13;
<h1><span class="label">Chapter 2. </span>Protocols</h1>&#13;
&#13;
&#13;
<p>There are various methods a process can use to communicate with other processes. As an example of this, consider communication by reading and writing to the filesystem or by <a data-primary="IPC (Inter-Process Communication)" data-type="indexterm" id="idm46291205681832"/>using Inter-Process Communication (IPC). But with these approaches, it’s only possible for a process to communicate with other processes on the same machine.</p>&#13;
&#13;
<p>Instead, processes are typically built to communicate directly with the network. This still allows for communication between processes on the same machine, but more importantly, it allows processes to communicate across a network. There are limited resources available to any given machine and far more resources available across &#13;
<span class="keep-together">multiple</span> &#13;
<span class="keep-together">machines.</span></p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Jeff Bezos mandated <a data-primary="Bezos, Jeff" data-type="indexterm" id="idm46291205655800"/><a data-primary="AWS (Amazon Web Services)" data-type="indexterm" id="idm46291205655064"/><a data-primary="API (application programming interface)" data-secondary="AWS (Amazon Web Services) and" data-type="indexterm" id="idm46291205654424"/>in the early 2000s that Amazon services must expose APIs over the network. This is credited as transforming Amazon from a simple bookstore to the cloud behemoth that is AWS. This pattern is now embraced by tech companies everywhere, allowing teams to access data and innovate at an unprecedented rate.</p>&#13;
</div>&#13;
&#13;
<p>A <em>protocol</em> is a <a data-primary="protocols" data-type="indexterm" id="idm46291205652136"/>standardized format for communicating between two parties. When communication happens without protocols involved, it’s inevitable that messages either won’t be interpreted correctly or won’t be understood at all. It’s almost always better to adhere to an industry standard than to create a protocol from scratch. It’s also better to embrace a smaller number of inter-service protocols <a data-primary="API (application programming interface)" data-secondary="protocols, inter-service" data-type="indexterm" id="idm46291205650856"/><a data-primary="protocols" data-secondary="inter-service protocols" data-type="indexterm" id="idm46291205649880"/><a data-primary="inter-service protocols" data-type="indexterm" id="idm46291205648936"/>within an organization to reduce the amount of implementation effort and API documentation.</p>&#13;
&#13;
<p>The <em>Open Systems Interconnection</em> (OSI) model <a data-primary="OSI (Open Systems Interconnection) model" data-type="indexterm" id="idm46291205647192"/>is a concept for describing the relationship between different layers of network protocols. Officially there are seven &#13;
<span class="keep-together">layers,</span> though as you’ll see in this chapter, it’s often the case that more layers are needed to describe modern applications. By first examining this model in <a data-type="xref" href="#table_osi_layers">Table 2-1</a>, you will better understand some of the concepts covered later. This book mostly discusses Layer 4, Layer 7, and the hypothetical Layer 8.</p>&#13;
<table id="table_osi_layers">&#13;
<caption><span class="label">Table 2-1. </span>The OSI layers</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Layer</th>&#13;
<th>Name</th>&#13;
<th>Example</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><em>8</em></p></td>&#13;
<td><p><em>User</em></p></td>&#13;
<td><p><em>JSON, gRPC</em></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>7</p></td>&#13;
<td><p>Application</p></td>&#13;
<td><p>HTTP, WebSocket</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>6</p></td>&#13;
<td><p>Presentation</p></td>&#13;
<td><p>MIME, ASCII, TLS</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>5</p></td>&#13;
<td><p>Session</p></td>&#13;
<td><p>Sockets</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>4</p></td>&#13;
<td><p>Transport</p></td>&#13;
<td><p>TCP, UDP</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>3</p></td>&#13;
<td><p>Network</p></td>&#13;
<td><p>IP, ICMP</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>2</p></td>&#13;
<td><p>Data Link</p></td>&#13;
<td><p>MAC, LLC</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>1</p></td>&#13;
<td><p>Physical</p></td>&#13;
<td><p>Ethernet, IEEE 802.11</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>This chapter looks at a few protocols that are often used for inter-service communication. The ubiquitous HTTP protocol is the first one discussed, as well as JSON, which it is frequently paired with. Various permutations of this protocol are also examined, such as securing it with TLS and enabling compression. Next, the GraphQL protocol is covered, which comes with a schema syntax and the ability to shape the JSON responses. Finally, the <em>Remote Procedure Call</em> (RPC) pattern <a data-primary="RPC (Remote Procedure Call)" data-type="indexterm" id="idm46291205538776"/><a data-primary="gRPC" data-type="indexterm" id="idm46291205537976"/><a data-primary="consumers" data-secondary="gRPC" data-type="indexterm" id="idm46291205537304"/>is also looked at by using an implementation called gRPC.</p>&#13;
&#13;
<p>The forms of communication <a data-primary="synchronous communication" data-type="indexterm" id="idm46291205535624"/><a data-primary="communication" data-secondary="synchronous" data-type="indexterm" id="idm46291205534904"/>covered in this chapter are examples of <em>synchronous communication</em>. With this approach, one service sends a request to another service and waits for the other service to reply. An alternative <a data-primary="communication" data-secondary="asynchronous" data-type="indexterm" id="idm46291205533304"/><a data-primary="asynchronous communication" data-type="indexterm" id="idm46291205532360"/>approach, <em>asynchronous communication</em>, is when a service doesn’t wait for a response to a message, like pushing a message into a queue.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Request and Response with HTTP" data-type="sect1"><div class="sect1" id="ch_protocols_sec_http">&#13;
<h1>Request and Response with HTTP</h1>&#13;
&#13;
<p>At its core, HTTP (Layer 7) is <a data-primary="OSI (Open Systems Interconnection) model" data-secondary="HTTP (Layer 7)" data-type="indexterm" id="idm46291205529144"/><a data-primary="OSI (Open Systems Interconnection) model" data-secondary="TCP (Layer 4)" data-type="indexterm" id="idm46291205528136"/><a data-primary="HTTP (Layer 7), OSI model" data-type="indexterm" id="idm46291205527160"/><a data-primary="TCP (Layer 4), OSI model" data-type="indexterm" id="idm46291205526424"/><a data-primary="protocols" data-secondary="HTTP" data-type="indexterm" id="pro_http"/>a text-based protocol that sits atop TCP (Layer 4), the go-to protocol chosen when delivery guarantees are required. The protocol is based on requests, generated by a client to initiate an HTTP conversation, as well as responses, which are returned from a server to the client. It was designed for browsers to consume content from websites. Over the years it has received many enhancements. It comes with semantics for dealing with compression, caching, errors, and even retries. Although it wasn’t exactly designed for API use, it’s certainly the most popular go-to protocol for communicating between networked services and one of the most popular protocols on which to build other protocols.</p>&#13;
&#13;
<p>That last point comes up a few <a data-primary="hypermedia, HTTP layer and" data-type="indexterm" id="idm46291205523288"/><a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="hypermedia and" data-type="indexterm" id="idm46291205522520"/>times in this chapter. HTTP is a protocol for transferring <em>hypermedia</em>, content such as images and HTML documents. This includes content discovered and navigated by a person, not necessarily application code. This “shortcoming” is considered throughout the next few sections.</p>&#13;
&#13;
<p>There are many reasons why HTTP <a data-primary="API (application programming interface)" data-secondary="HTTP and" data-type="indexterm" id="idm46291205520408"/>is the default protocol used for public-facing APIs. Most companies already have a website, so the HTTP-speaking infrastructure already exists. Browsers often need to consume such APIs, and there are only a few protocols that browsers can use. Testing an API endpoint can sometimes be done by visiting a URL with a browser—a tool that every developer already has installed.</p>&#13;
&#13;
<p>The following section mostly examines the HTTP 1.1 protocol, which is arguably the most popular version used <a data-primary="protocols" data-secondary="HTTP" data-startref="pro_http" data-type="indexterm" id="pro"/>today.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="HTTP Payloads" data-type="sect2"><div class="sect2" id="idm46291205516568">&#13;
<h2>HTTP Payloads</h2>&#13;
&#13;
<p>HTTP, being a text-based protocol, <a data-primary="protocols" data-secondary="HTTP" data-tertiary="payloads" data-type="indexterm" id="pro_http_pay"/>allows communication using any platform or language that can communicate over TCP. This also allows me to embed the raw content of HTTP messages within the pages of this book. To generate a request, you might write code that looks like <a data-type="xref" href="#ex_node_request">Example 2-1</a>.</p>&#13;
<div data-type="example" id="ex_node_request">&#13;
<h5><span class="label">Example 2-1. </span>Node.js request code</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c-Hashbang">#!/usr/bin/env node</code>&#13;
&#13;
<code class="c1">// npm install node-fetch@2.6</code>&#13;
<code class="kr">const</code> <code class="nx">fetch</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'node-fetch'</code><code class="p">);</code>&#13;
&#13;
<code class="p">(</code><code class="nx">async</code><code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">req</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="s1">'http://localhost:3002/data'</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">method</code><code class="o">:</code> <code class="s1">'POST'</code><code class="p">,</code>&#13;
    <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>&#13;
      <code class="s1">'Content-Type'</code><code class="o">:</code> <code class="s1">'application/json'</code><code class="p">,</code>&#13;
      <code class="s1">'User-Agent'</code><code class="o">:</code> <code class="sb">`nodejs/</code><code class="si">${</code><code class="nx">process</code><code class="p">.</code><code class="nx">version</code><code class="si">}</code><code class="sb">`</code><code class="p">,</code>&#13;
      <code class="s1">'Accept'</code><code class="o">:</code> <code class="s1">'application/json'</code>&#13;
    <code class="p">},</code>&#13;
    <code class="nx">body</code><code class="o">:</code> <code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">({</code>&#13;
      <code class="nx">foo</code><code class="o">:</code> <code class="s1">'bar'</code>&#13;
    <code class="p">})</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="kr">const</code> <code class="nx">payload</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">req</code><code class="p">.</code><code class="nx">json</code><code class="p">();</code>&#13;
&#13;
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">payload</code><code class="p">);</code>&#13;
<code class="p">})();</code></pre></div>&#13;
&#13;
<p>Writing HTTP requests <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="requests, writing manually" data-type="indexterm" id="idm46291205508712"/>manually can be a bit of a chore. Luckily, most libraries handle serializing and deserializing the tough parts—namely, parsing headers and the request/status lines. <a data-type="xref" href="#ex_http_request">Example 2-2</a> shows the correlating HTTP request that was generated by the previous node application.</p>&#13;
<div data-type="example" id="ex_http_request">&#13;
<h5><span class="label">Example 2-2. </span>HTTP request</h5>&#13;
&#13;
<pre data-code-language="http" data-type="programlisting"><code class="err">P</code><code class="err">O</code><code class="err">S</code><code class="err">T</code><code class="err"> </code><code class="err">/</code><code class="err">d</code><code class="err">a</code><code class="err">t</code><code class="err">a</code><code class="err"> </code><code class="err">H</code><code class="err">T</code><code class="err">T</code><code class="err">P</code><code class="err">/</code><code class="err">1</code><code class="err">.</code><code class="err">1</code><code class="err"> </code><a class="co" href="#callout_protocols_CO1-1" id="co_protocols_CO1-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="err">C</code><code class="err">o</code><code class="err">n</code><code class="err">t</code><code class="err">e</code><code class="err">n</code><code class="err">t</code><code class="err">-</code><code class="err">T</code><code class="err">y</code><code class="err">p</code><code class="err">e</code><code class="err">:</code><code class="err"> </code><code class="err">a</code><code class="err">p</code><code class="err">p</code><code class="err">l</code><code class="err">i</code><code class="err">c</code><code class="err">a</code><code class="err">t</code><code class="err">i</code><code class="err">o</code><code class="err">n</code><code class="err">/</code><code class="err">j</code><code class="err">s</code><code class="err">o</code><code class="err">n</code><code class="err"> </code><a class="co" href="#callout_protocols_CO1-2" id="co_protocols_CO1-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="err">U</code><code class="err">s</code><code class="err">e</code><code class="err">r</code><code class="err">-</code><code class="err">A</code><code class="err">g</code><code class="err">e</code><code class="err">n</code><code class="err">t</code><code class="err">:</code><code class="err"> </code><code class="err">n</code><code class="err">o</code><code class="err">d</code><code class="err">e</code><code class="err">j</code><code class="err">s</code><code class="err">/</code><code class="err">v</code><code class="err">1</code><code class="err">4</code><code class="err">.</code><code class="err">8</code><code class="err">.</code><code class="err">0</code><code>&#13;
</code><code class="err">A</code><code class="err">c</code><code class="err">c</code><code class="err">e</code><code class="err">p</code><code class="err">t</code><code class="err">:</code><code class="err"> </code><code class="err">a</code><code class="err">p</code><code class="err">p</code><code class="err">l</code><code class="err">i</code><code class="err">c</code><code class="err">a</code><code class="err">t</code><code class="err">i</code><code class="err">o</code><code class="err">n</code><code class="err">/</code><code class="err">j</code><code class="err">s</code><code class="err">o</code><code class="err">n</code><code>&#13;
</code><code class="err">C</code><code class="err">o</code><code class="err">n</code><code class="err">t</code><code class="err">e</code><code class="err">n</code><code class="err">t</code><code class="err">-</code><code class="err">L</code><code class="err">e</code><code class="err">n</code><code class="err">g</code><code class="err">t</code><code class="err">h</code><code class="err">:</code><code class="err"> </code><code class="err">1</code><code class="err">3</code><code>&#13;
</code><code class="err">A</code><code class="err">c</code><code class="err">c</code><code class="err">e</code><code class="err">p</code><code class="err">t</code><code class="err">-</code><code class="err">E</code><code class="err">n</code><code class="err">c</code><code class="err">o</code><code class="err">d</code><code class="err">i</code><code class="err">n</code><code class="err">g</code><code class="err">:</code><code class="err"> </code><code class="err">g</code><code class="err">z</code><code class="err">i</code><code class="err">p</code><code class="err">,</code><code class="err">d</code><code class="err">e</code><code class="err">f</code><code class="err">l</code><code class="err">a</code><code class="err">t</code><code class="err">e</code><code>&#13;
</code><code class="err">C</code><code class="err">o</code><code class="err">n</code><code class="err">n</code><code class="err">e</code><code class="err">c</code><code class="err">t</code><code class="err">i</code><code class="err">o</code><code class="err">n</code><code class="err">:</code><code class="err"> </code><code class="err">c</code><code class="err">l</code><code class="err">o</code><code class="err">s</code><code class="err">e</code><code>&#13;
</code><code class="err">H</code><code class="err">o</code><code class="err">s</code><code class="err">t</code><code class="err">:</code><code class="err"> </code><code class="err">l</code><code class="err">o</code><code class="err">c</code><code class="err">a</code><code class="err">l</code><code class="err">h</code><code class="err">o</code><code class="err">s</code><code class="err">t</code><code class="err">:</code><code class="err">3</code><code class="err">0</code><code class="err">0</code><code class="err">2</code><code>&#13;
</code><code>&#13;
</code><code class="err">{</code><code class="err">"</code><code class="err">f</code><code class="err">o</code><code class="err">o</code><code class="err">"</code><code class="err">:</code><code class="err">"</code><code class="err">b</code><code class="err">a</code><code class="err">r</code><code class="err">"</code><code class="err">}</code><code class="err"> </code><a class="co" href="#callout_protocols_CO1-3" id="co_protocols_CO1-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_protocols_CO1-1" id="callout_protocols_CO1-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The first line is the request line.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO1-2" id="callout_protocols_CO1-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Header/value pairs, separated by colons.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO1-3" id="callout_protocols_CO1-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Two new lines then the (optional) request body.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This is the raw version of an HTTP request. It’s much simpler than a typical request you’ll see in a browser, lacking items such as cookies and the myriad default headers inserted by modern browsers. Each newline is represented as a combination carriage return character and line feed character (<code>\r\n</code>).&#13;
Responses look fairly <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="responses" data-type="indexterm" id="idm46291205419096"/>similar to requests. <a data-type="xref" href="#ex_http_response">Example 2-3</a> shows a response that could correlate to the previous request.</p>&#13;
<div data-type="example" id="ex_http_response">&#13;
<h5><span class="label">Example 2-3. </span>HTTP response</h5>&#13;
&#13;
<pre data-code-language="http" data-type="programlisting"><code class="kr">HTTP</code><code class="o">/</code><code class="m">1.1</code><code> </code><code class="m">403</code><code> </code><code class="ne">Forbidden </code><a class="co" href="#callout_protocols_CO2-1" id="co_protocols_CO2-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="na">Server</code><code class="o">:</code><code> </code><code class="l">nginx/1.16.0 </code><a class="co" href="#callout_protocols_CO2-2" id="co_protocols_CO2-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
</code><code class="na">Date</code><code class="o">:</code><code> </code><code class="l">Tue, 29 Oct 2019 15:29:31 GMT</code><code>&#13;
</code><code class="na">Content-Type</code><code class="o">:</code><code> </code><code class="l">application/json; charset=utf-8</code><code>&#13;
</code><code class="na">Content-Length</code><code class="o">:</code><code> </code><code class="l">33</code><code>&#13;
</code><code class="na">Connection</code><code class="o">:</code><code> </code><code class="l">keep-alive</code><code>&#13;
</code><code class="na">Cache-Control</code><code class="o">:</code><code> </code><code class="l">no-cache</code><code>&#13;
</code><code class="na">Vary</code><code class="o">:</code><code> </code><code class="l">accept-encoding</code><code>&#13;
</code><code>&#13;
</code><code class="p">{</code><code class="nt">"error"</code><code class="p">:</code><code class="s2">"must_be_authenticated"</code><code class="p">}</code><code> </code><a class="co" href="#callout_protocols_CO2-3" id="co_protocols_CO2-3"><img alt="3" src="assets/3.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_protocols_CO2-1" id="callout_protocols_CO2-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The first line is the response line.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO2-2" id="callout_protocols_CO2-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>Header/value pairs, separated by colons.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO2-3" id="callout_protocols_CO2-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Two new lines, then the response <a data-primary="protocols" data-secondary="HTTP" data-startref="pro_http_pay" data-tertiary="payloads" data-type="indexterm" id="idm46291204957128"/>body (also optional).</p></dd>&#13;
</dl></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="HTTP Semantics" data-type="sect2"><div class="sect2" id="idm46291204955352">&#13;
<h2>HTTP Semantics</h2>&#13;
&#13;
<p>HTTP has several <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="semantics" data-type="indexterm" id="http_semantics"/><a data-primary="protocols" data-secondary="HTTP" data-tertiary="sem" data-type="indexterm" id="pro_http_sem"/>important semantics built in. It is these semantics that, given enough time, any hand-rolled protocol ultimately ends up rebuilding. Ultimately it is because of these semantics and their universal understanding that many other protocols end up being built on top of HTTP.</p>&#13;
<dl>&#13;
<dt>HTTP methods</dt>&#13;
<dd>&#13;
<p>This value is the first <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="methods" data-type="indexterm" id="idm46291204932568"/><a data-primary="methods" data-secondary="HTTP" data-type="indexterm" id="idm46291204931240"/>word in the request line. In <a data-type="xref" href="#ex_http_request">Example 2-2</a>, the method is <code>POST</code>. There are several <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="methods" data-tertiary="POST" data-type="indexterm" id="idm46291204928952"/><a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="methods" data-tertiary="GET" data-type="indexterm" id="idm46291204927704"/><a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="methods" data-tertiary="PATCH" data-type="indexterm" id="idm46291204926520"/><a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="methods" data-tertiary="DELETE" data-type="indexterm" id="idm46291204925288"/><a data-primary="methods" data-secondary="HTTP" data-tertiary="GET" data-type="indexterm" id="idm46291204924056"/><a data-primary="methods" data-secondary="HTTP" data-tertiary="PATCH" data-type="indexterm" id="idm46291204922840"/><a data-primary="methods" data-secondary="HTTP" data-tertiary="POST" data-type="indexterm" id="idm46291204921624"/><a data-primary="methods" data-secondary="HTTP" data-tertiary="DELETE" data-type="indexterm" id="idm46291204920408"/>HTTP methods, and the other popular ones include <code>GET</code>, <code>PATCH</code>, and <code>DELETE</code>. These methods <a data-primary="CRUD (Create, Read, Update, Delete)" data-type="indexterm" id="idm46291204917784"/>map to the basic CRUD operations (Create, Read, Update, and Delete), generic concepts that can be applied to almost &#13;
<span class="keep-together">all stateful</span> data stores. By having applications adhere to the intentions of the &#13;
<span class="keep-together">HTTP methods,</span> it’s possible for an outside observer to infer what the intent of a &#13;
<span class="keep-together">particular</span> request is.</p>&#13;
</dd>&#13;
<dt>Idempotency</dt>&#13;
<dd>&#13;
<p>This is a fancy word <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="idempotency" data-type="indexterm" id="idm46291204913656"/><a data-primary="idempotency" data-type="indexterm" id="idm46291204912632"/>meaning that an operation can be executed multiple times without risk of side effects. The HTTP methods <code>GET</code>, <code>PATCH</code>, and <code>DELETE</code> are each considered idempotent operations. If the result of an operation using one of those methods is unknown, for example, a network failure prevents the response from being received, then it is considered safe for a client to retry the same request.</p>&#13;
</dd>&#13;
<dt>Status codes</dt>&#13;
<dd>&#13;
<p>Another important <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="status codes" data-type="indexterm" id="idm46291204908840"/><a data-primary="status codes, HTTP" data-type="indexterm" id="idm46291204907816"/>concept is that of status codes, and in particular, status code ranges. A status code is the three digit number present in the response line. In <a data-type="xref" href="#ex_http_response">Example 2-3</a>, the status code is 403. An overview of these status code ranges is available in <a data-type="xref" href="#table_status_codes">Table 2-2</a>.</p>&#13;
</dd>&#13;
</dl>&#13;
<table id="table_status_codes">&#13;
<caption><span class="label">Table 2-2. </span>HTTP status code ranges</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Range</th>&#13;
<th>Type</th>&#13;
<th>Examples</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p>100–199</p></td>&#13;
<td><p>Information</p></td>&#13;
<td><p>101 Switching Protocols</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>200–299</p></td>&#13;
<td><p>Success</p></td>&#13;
<td><p>200 OK, 201 Created</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>300–399</p></td>&#13;
<td><p>Redirect</p></td>&#13;
<td><p>301 Moved Permanently</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>400–499</p></td>&#13;
<td><p>Client error</p></td>&#13;
<td><p>401 Unauthorized, 404 Not Found</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p>500–599</p></td>&#13;
<td><p>Server error</p></td>&#13;
<td><p>500 Internal Server Error, 502 Bad Gateway</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The text that follows a status <a data-primary="status codes, HTTP" data-secondary="Reason Phrase" data-type="indexterm" id="idm46291204889352"/>code is called the Reason Phrase. Any popular Node.js HTTP framework will infer which text to use based on the numeric status code your application specifies. The value is unused by modern software, and HTTP/2, the successor to HTTP 1.1, doesn’t provide such a value.</p>&#13;
</div>&#13;
<dl>&#13;
<dt>Client versus server errors</dt>&#13;
<dd>&#13;
<p>The status code provides <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="client errors" data-type="indexterm" id="idm46291204885944"/><a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="server errors" data-type="indexterm" id="idm46291204884904"/><a data-primary="client errors, HTTP" data-type="indexterm" id="idm46291204883944"/><a data-primary="server errors, HTTP" data-type="indexterm" id="idm46291204883272"/><a data-primary="errors" data-secondary="client versus server" data-type="indexterm" id="idm46291204882600"/>some very useful information. For example, the status range 400–499 dictates that the client made a mistake, while the status range 500–599 blames the server. This informs the client that if an operation is attempted, and the server decides the client made a mistake, that the client shouldn’t attempt to send the request again. This can happen if the client were to violate the protocol in some manner. However, when a server error happens, the client should feel free to try idempotent requests again. This could be due to a temporary error with the server, such as it being overwhelmed with requests or losing a database connection. In <a data-type="xref" href="ch08.html#ch_resilience_sec_messaging">“Idempotency and Messaging Resilience”</a> you will implement custom logic for retrying HTTP requests based on these &#13;
<span class="keep-together">status</span> codes.</p>&#13;
</dd>&#13;
<dt>Response caching</dt>&#13;
<dd>&#13;
<p>HTTP also hints at how <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="response caching" data-type="indexterm" id="idm46291204878184"/><a data-primary="errors" data-secondary="response caching" data-type="indexterm" id="idm46291204877208"/><a data-primary="response caching" data-type="indexterm" id="idm46291204876264"/><a data-primary="caches" data-secondary="response caching" data-type="indexterm" id="idm46291204875592"/>responses can be cached. Typically, the only responses that get cached, especially by intermediary services, are those associated with a <code>GET</code> request. If there’s an error code associated with a response, then it probably shouldn’t be cached. HTTP goes even further and conveys how long a response should be cached. The <code>Expires</code> header tells the client a particular date and time by which to discard the cached value. This system isn’t entirely perfect, though. Additional semantics could be applied to caching. For example, if user #123 requests a document with information specific to their bank account, it can be difficult to know that the cached result shouldn’t also be supplied to user #456.</p>&#13;
</dd>&#13;
<dt>Statelessness</dt>&#13;
<dd>&#13;
<p>HTTP is inherently a <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="statelessness" data-type="indexterm" id="idm46291204871672"/>stateless protocol. This means that by sending one message, the meaning of a future message won’t change. It’s not like, say, a terminal session where you might list the files in the current directory with <code>ls</code>, change directory with <code>cd</code>, and then issue the same exact <code>ls</code> command but get different output. Instead, every request contains all the information it needs to set the desired state.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>There <em>are</em> conventions for <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="state, simulating" data-type="indexterm" id="idm46291204867896"/>simulating state over HTTP. For example, by making use of a header like <code>Cookie</code> and setting a unique session identifier, state about the connection can be maintained in a database. Other than basic authentication information, it’s usually not appropriate to require clients that provide such stateful session tokens <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="semantics" data-startref="http_semantics" data-type="indexterm" id="idm46291204866104"/><a data-primary="protocols" data-secondary="HTTP" data-startref="pro_http_sem" data-tertiary="semantics" data-type="indexterm" id="idm46291204864840"/>when using an API.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="HTTP Compression" data-type="sect2"><div class="sect2" id="idm46291204863096">&#13;
<h2>HTTP Compression</h2>&#13;
&#13;
<p>It is possible to <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="compression" data-type="indexterm" id="http_compress"/><a data-primary="compression" data-secondary="HTTP" data-type="indexterm" id="httpcompress"/><a data-primary="protocols" data-secondary="HTTP" data-tertiary="compression" data-type="indexterm" id="pro_http_comp"/>compress the HTTP response body in order to reduce the amount of data sent over the network. This is another built-in feature of HTTP. When a client supports compression, it can choose to supply the <code>Accept-Encoding</code> header. The server, upon encountering the header, can then choose to compress the response body using whichever compression algorithm was supplied in the request. The gzip compression algorithm is the ubiquitous form of HTTP compression, though other algorithms such as brotli may offer higher compression values. The response contains a header specifying which algorithm the server used, such as <code>Content-Encoding: br</code> for brotli.</p>&#13;
&#13;
<p>Compression is a trade-off between network payload size and CPU usage. Typically, it’s in your best interest to support HTTP compression at some point between the Node.js server and whatever client is consuming the data, especially if this is traffic being consumed by a third party over the internet. However, Node.js is <a data-primary="Node.js" data-secondary="compression and" data-type="indexterm" id="idm46291204854984"/>not the most efficient tool for performing compression. This is a CPU-heavy operation and should be handled outside of the Node.js process whenever possible. <a data-type="xref" href="ch03.html#ch_scaling_sec_rp">“Reverse Proxies with HAProxy”</a> looks at using a tool called a <em>reverse proxy</em> to <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="compression" data-tertiary="reverse proxy" data-type="indexterm" id="idm46291204852520"/><a data-primary="compression" data-secondary="HTTP" data-type="indexterm" id="idm46291204851224"/><a data-primary="reverse proxy" data-secondary="HTTP compression" data-type="indexterm" id="idm46291204850280"/>automatically handle HTTP compression. <a data-type="xref" href="ch03.html#ch_scaling_sec_bm">“SLA and Load Testing”</a> looks at some benchmarks to prove this performance claim.</p>&#13;
&#13;
<p><a data-type="xref" href="#ex_node_gzip">Example 2-4</a><sup><a data-type="noteref" href="ch02.html#idm46291204847576" id="idm46291204847576-marker">1</a></sup> provides a demonstration of how to create such a server that performs gzip compression in-process. It only uses built-in Node.js modules and doesn’t require a package install. Any popular HTTP framework has its own idiomatic approach for implementing compression, usually just a <code>require</code> and a function call away, but under the hood they’re all essentially doing the same thing.</p>&#13;
<div data-type="example" id="ex_node_gzip">&#13;
<h5><span class="label">Example 2-4. </span><em>server-gzip.js</em></h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c-Hashbang">#!/usr/bin/env node</code>&#13;
&#13;
<code class="c1">// Adapted from https://nodejs.org/api/zlib.html</code>&#13;
<code class="c1">// Warning: Not as efficient as using a Reverse Proxy</code>&#13;
<code class="kr">const</code> <code class="nx">zlib</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'zlib'</code><code class="p">);</code>&#13;
<code class="kr">const</code> <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">);</code>&#13;
<code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>&#13;
&#13;
<code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">((</code><code class="nx">request</code><code class="p">,</code> <code class="nx">response</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">raw</code> <code class="o">=</code> <code class="nx">fs</code><code class="p">.</code><code class="nx">createReadStream</code><code class="p">(</code><code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/index.html'</code><code class="p">);</code>&#13;
  <code class="kr">const</code> <code class="nx">acceptEncoding</code> <code class="o">=</code> <code class="nx">request</code><code class="p">.</code><code class="nx">headers</code><code class="p">[</code><code class="s1">'accept-encoding'</code><code class="p">]</code> <code class="o">||</code> <code class="s1">''</code><code class="p">;</code>&#13;
  <code class="nx">response</code><code class="p">.</code><code class="nx">setHeader</code><code class="p">(</code><code class="s1">'Content-Type'</code><code class="p">,</code> <code class="s1">'text/plain'</code><code class="p">);</code>&#13;
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">acceptEncoding</code><code class="p">);</code>&#13;
&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">acceptEncoding</code><code class="p">.</code><code class="nx">includes</code><code class="p">(</code><code class="s1">'gzip'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'encoding with gzip'</code><code class="p">);</code>&#13;
    <code class="nx">response</code><code class="p">.</code><code class="nx">setHeader</code><code class="p">(</code><code class="s1">'Content-Encoding'</code><code class="p">,</code> <code class="s1">'gzip'</code><code class="p">);</code>&#13;
    <code class="nx">raw</code><code class="p">.</code><code class="nx">pipe</code><code class="p">(</code><code class="nx">zlib</code><code class="p">.</code><code class="nx">createGzip</code><code class="p">()).</code><code class="nx">pipe</code><code class="p">(</code><code class="nx">response</code><code class="p">);</code>&#13;
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'no encoding'</code><code class="p">);</code>&#13;
    <code class="nx">raw</code><code class="p">.</code><code class="nx">pipe</code><code class="p">(</code><code class="nx">response</code><code class="p">);</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}).</code><code class="nx">listen</code><code class="p">(</code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">1337</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>Now you’re ready to test <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="server" data-tertiary="testing" data-type="indexterm" id="idm46291204841448"/>this server. First create an <em>index.html</em> file to serve and then start the server:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code><code class="nb">echo</code> <code class="s2">"&lt;html&gt;&lt;title&gt;Hello World&lt;/title&gt;&lt;/html&gt;"</code> &gt;&gt; index.html&#13;
<code class="nv">$ </code>node server-gzip.js</pre>&#13;
&#13;
<p>Next, run the following commands in a separate terminal window to view the output from the server:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="c"># Request uncompressed content</code>&#13;
<code class="nv">$ </code>curl http://localhost:1337/&#13;
<code class="c"># Request compressed content and view binary representation</code>&#13;
<code class="nv">$ </code>curl -H <code class="s1">'Accept-Encoding: gzip'</code> http://localhost:1337/ <code class="p">|</code> xxd&#13;
<code class="c"># Request compressed content and decompress</code>&#13;
<code class="nv">$ </code>curl -H <code class="s1">'Accept-Encoding: gzip'</code> http://localhost:1337/ <code class="p">|</code> gunzip</pre>&#13;
&#13;
<p>These <code>curl</code> commands act as a client communicating with the service over the network. The service prints whether or not a request used compression to help explain what’s happening. In this particular example, the compressed version of the file is actually larger than the uncompressed version! You can see this happening by running the two commands in <a data-type="xref" href="#ex_request_wc">Example 2-5</a>.</p>&#13;
<div data-type="example" id="ex_request_wc">&#13;
<h5><span class="label">Example 2-5. </span>Comparing compressed versus uncompressed requests</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>curl http://localhost:1337/ <code class="p">|</code> wc -c&#13;
<code class="nv">$ </code>curl -H <code class="s1">'Accept-Encoding: gzip'</code> http://localhost:1337/ <code class="p">|</code> wc -c</pre></div>&#13;
&#13;
<p>In this case, the uncompressed version of the document is 40 bytes, and the compressed version is 53 bytes.</p>&#13;
&#13;
<p>With larger documents, this won’t be an issue. To prove this, run the previous <code>echo</code> command <a data-primary="echo command" data-type="indexterm" id="idm46291204692040"/><a data-primary="commands" data-secondary="echo" data-type="indexterm" id="idm46291204691432"/>three more times to increase the <em>index.html</em> file size. Then, run the same commands in <a data-type="xref" href="#ex_request_wc">Example 2-5</a> again. This time the uncompressed version is 160 bytes and the compressed version is 56 bytes. This is because gzip operates by removing redundancies in the response bodies, and the example contains the same text repeated four times. This redundancy removal is particularly useful if a response body contains redundant text, like a JSON document with repeating attribute names. Most gzip compression tools can be configured to be bypassed if a document is smaller than a certain size.</p>&#13;
&#13;
<p>HTTP compression only compresses the body of the request. It does not affect the HTTP headers (short of changing the value in the <code>Content-Length</code> header). In the world of service-to-service APIs with a finite set of intentional HTTP headers, this isn’t that big of a deal. However, when it comes to web browsers, it isn’t uncommon to end up with HTTP requests containing several kilobytes of headers (just think of all those tracking cookies). HTTP/2 was invented to address situations like that <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="compression" data-startref="http_compress" data-type="indexterm" id="idm46291204660888"/><a data-primary="compression" data-secondary="HTTP" data-startref="httpcompress" data-type="indexterm" id="idm46291204670472"/><a data-primary="protocols" data-secondary="HTTP" data-startref="pay_http_comp" data-tertiary="compression" data-type="indexterm" id="idm46291204669256"/>and uses HPACK to compress headers.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="HTTPS / TLS" data-type="sect2"><div class="sect2" id="ch_protocols_sec_http_subsec_tls">&#13;
<h2>HTTPS / TLS</h2>&#13;
&#13;
<p>Another form of encoding is <a data-primary="TLS (Transport Layer Security)" data-type="indexterm" id="idm46291204665080"/><a data-primary="protocols" data-secondary="HTTPS" data-type="indexterm" id="pro_https_tls"/>encryption. Transport Layer Security (TLS) is the protocol used for encrypting HTTP traffic. It’s what <a data-primary="HTTPS (Hypertext Transfer Protocol Secure)" data-type="indexterm" id="idm46291204632488"/>puts the <em>S</em> (secure) in <em>HTTPS</em>. Unlike gzip compression, TLS does encapsulate the HTTP headers as well. Much like gzip, TLS is a CPU-intensive operation and should also be performed by an external process such as a Reverse Proxy. TLS supplants the obsolete Secure Sockets Layer (SSL) <a data-primary="SSL (Secure Sockets Layer)" data-type="indexterm" id="idm46291204630584"/>protocol.</p>&#13;
&#13;
<p>TLS works by using certificates. There are two types of certificates: one containing a public key, which can safely be given to anyone in the world, and one containing a private key, which should remain a secret. These two keys are inherently paired. Anyone can take a message and encrypt it using the public key, but only someone with the private key can then decrypt the message. With HTTP, this means a server will provide its public key, and a client will encrypt requests using the public key. When the client first communicates with the server, it also generates a large random number, essentially a password for the session, which is encrypted with the public key and sent to the server. This temporary password is used to encrypt the TLS session.</p>&#13;
&#13;
<p>Generating certificates and enabling them with a server can take some effort to implement. Traditionally, it was even an expensive feature that had to be paid for. Nowadays there is a service called <a class="orm:hideurl" href="https://oreil.ly/OXEmD">Let’s Encrypt</a> that not only automates the process but also makes it free. A caveat of this service is that the tool requires a server to be publicly exposed to the internet to verify DNS ownership of the domain. This makes it difficult to encrypt internal services, even though it is the clear winner for public services.</p>&#13;
&#13;
<p>Now it’s time to do some hands-on work with TLS. The easiest way to get an HTTPS server running locally is to generate a self-signed certificate, have your server read that certificate, and have a client make a request to the server without performing certificate validation. To generate your own <a data-primary="TLS (Transport Layer Security)" data-secondary="certificates" data-type="indexterm" id="tls_certs"/><a data-primary="certificates" data-secondary="TLS" data-type="indexterm" id="tls_certs1"/>certificate, run the command in <a data-type="xref" href="#ex_generate_cert">Example 2-6</a>. Feel free to use any values you like, but use <code>localhost</code> when prompted for a <em>common name</em>.</p>&#13;
<div data-type="example" id="ex_generate_cert">&#13;
<h5><span class="label">Example 2-6. </span>Generating a self-signed certificate</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>mkdir -p ./<code class="o">{</code>recipe-api,shared<code class="o">}</code>/tls&#13;
<code class="nv">$ </code>openssl req -nodes -new -x509 <code class="se">\</code>&#13;
  -keyout recipe-api/tls/basic-private-key.key <code class="se">\</code>&#13;
  -out shared/tls/basic-certificate.cert</pre></div>&#13;
&#13;
<p>This command creates two files, <a data-primary="basic-private-key.key" data-type="indexterm" id="idm46291204602120"/><a data-primary="basic-certificate.cert" data-type="indexterm" id="idm46291204601512"/>namely <em>basic-private-key.key</em> (the private key) and <em>basic-certificate.cert</em> (the public key).</p>&#13;
&#13;
<p>Next, copy the <em>recipe-api/producer-http-basic.js</em> service that you made in <a data-type="xref" href="ch01.html#ex_producer">Example 1-6</a> to a new file named <em>recipe-api/producer-https-basic.js</em> to resemble <a data-type="xref" href="#ex_node_server_https">Example 2-7</a>. This is an HTTPS server built entirely with Node.js.</p>&#13;
<div data-type="example" id="ex_node_server_https">&#13;
<h5><span class="label">Example 2-7. </span><em>recipe-api/producer-https-basic.js</em></h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c-Hashbang">#!/usr/bin/env node&#13;
</code><code>&#13;
</code><code class="c1">// npm install fastify@3.2&#13;
</code><code class="c1">// Warning: Not as efficient as using a Reverse Proxy&#13;
</code><code class="kr">const</code><code> </code><code class="nx">fs</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">server</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'fastify'</code><code class="p">)</code><code class="p">(</code><code class="p">{</code><code>&#13;
  </code><code class="nx">https</code><code class="o">:</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_protocols_CO3-1" id="co_protocols_CO3-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
    </code><code class="nx">key</code><code class="o">:</code><code> </code><code class="nx">fs</code><code class="p">.</code><code class="nx">readFileSync</code><code class="p">(</code><code class="nx">__dirname</code><code class="o">+</code><code class="s1">'/tls/basic-private-key.key'</code><code class="p">)</code><code class="p">,</code><code>&#13;
    </code><code class="nx">cert</code><code class="o">:</code><code> </code><code class="nx">fs</code><code class="p">.</code><code class="nx">readFileSync</code><code class="p">(</code><code class="nx">__dirname</code><code class="o">+</code><code class="s1">'/../shared/tls/basic-certificate.cert'</code><code class="p">)</code><code class="p">,</code><code>&#13;
  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">HOST</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">HOST</code><code> </code><code class="o">||</code><code> </code><code class="s1">'127.0.0.1'</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">PORT</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code><code> </code><code class="o">||</code><code> </code><code class="mi">4000</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="nx">server</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/recipes/:id'</code><code class="p">,</code><code> </code><code class="nx">async</code><code> </code><code class="p">(</code><code class="nx">req</code><code class="p">,</code><code> </code><code class="nx">reply</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
  </code><code class="kr">const</code><code> </code><code class="nx">id</code><code> </code><code class="o">=</code><code> </code><code class="nb">Number</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">)</code><code class="p">;</code><code>&#13;
  </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">id</code><code> </code><code class="o">!==</code><code> </code><code class="mi">42</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="nx">reply</code><code class="p">.</code><code class="nx">statusCode</code><code> </code><code class="o">=</code><code> </code><code class="mi">404</code><code class="p">;</code><code>&#13;
    </code><code class="k">return</code><code> </code><code class="p">{</code><code> </code><code class="nx">error</code><code class="o">:</code><code> </code><code class="s1">'not_found'</code><code> </code><code class="p">}</code><code class="p">;</code><code>&#13;
  </code><code class="p">}</code><code>&#13;
  </code><code class="k">return</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="nx">producer_pid</code><code class="o">:</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">pid</code><code class="p">,</code><code>&#13;
    </code><code class="nx">recipe</code><code class="o">:</code><code> </code><code class="p">{</code><code>&#13;
      </code><code class="nx">id</code><code class="p">,</code><code> </code><code class="nx">name</code><code class="o">:</code><code> </code><code class="s2">"Chicken Tikka Masala"</code><code class="p">,</code><code>&#13;
      </code><code class="nx">steps</code><code class="o">:</code><code> </code><code class="s2">"Throw it in a pot..."</code><code class="p">,</code><code>&#13;
      </code><code class="nx">ingredients</code><code class="o">:</code><code> </code><code class="p">[</code><code>&#13;
        </code><code class="p">{</code><code> </code><code class="nx">id</code><code class="o">:</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="nx">name</code><code class="o">:</code><code> </code><code class="s2">"Chicken"</code><code class="p">,</code><code> </code><code class="nx">quantity</code><code class="o">:</code><code> </code><code class="s2">"1 lb"</code><code class="p">,</code><code> </code><code class="p">}</code><code class="p">,</code><code>&#13;
        </code><code class="p">{</code><code> </code><code class="nx">id</code><code class="o">:</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="nx">name</code><code class="o">:</code><code> </code><code class="s2">"Sauce"</code><code class="p">,</code><code> </code><code class="nx">quantity</code><code class="o">:</code><code> </code><code class="s2">"2 cups"</code><code class="p">,</code><code> </code><code class="p">}</code><code>&#13;
      </code><code class="p">]</code><code>&#13;
    </code><code class="p">}</code><code>&#13;
  </code><code class="p">}</code><code class="p">;</code><code>&#13;
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="nx">server</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">PORT</code><code class="p">,</code><code> </code><code class="nx">HOST</code><code class="p">,</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`</code><code class="sb">Producer running at https://</code><code class="si">${</code><code class="nx">HOST</code><code class="si">}</code><code class="sb">:</code><code class="si">${</code><code class="nx">PORT</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_protocols_CO3-1" id="callout_protocols_CO3-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The web server is now configured to enable HTTPS and read the certificate files.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Once you’ve created the server file, run the server and then make a request to it. You can do this by running the following commands:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">$ </code>node recipe-api/producer-https-basic.js           <code class="c"># terminal 1</code>&#13;
<code class="nv">$ </code>curl --insecure https://localhost:4000/recipes/42 <code class="c"># terminal 2</code></pre>&#13;
&#13;
<p>That <code>--insecure</code> flag probably caught your attention. In fact, if you were to open the URL directly in a web browser, you would get a warning that there is a problem with the certificate. This is what happens when a certificate is self-signed.</p>&#13;
&#13;
<p>If you were to make a request to this service using a Node.js application, the request would also fail. The inner Node.js <code>http</code> and <code>https</code> modules <a data-primary="http module" data-type="indexterm" id="idm46291204398536"/><a data-primary="https module" data-type="indexterm" id="idm46291204397800"/><a data-primary="modules" data-secondary="http" data-type="indexterm" id="idm46291204397128"/><a data-primary="modules" data-secondary="https" data-type="indexterm" id="idm46291204396184"/>accept an options &#13;
<span class="keep-together">argument,</span> and most higher-level HTTP libraries in npm accept those same options in some manner. One such way to avoid these errors is to provide the &#13;
<span class="keep-together"><code>rejectUnauthorized: false</code></span> flag. Unfortunately, this isn’t much more secure than using plain HTTP and should be avoided.</p>&#13;
&#13;
<p>The reason all this matters is that it’s not necessarily safe to trust just any old certificate encountered on the internet. Instead, it’s important to know that a certificate is valid. This is usually done by having one certificate “sign” another certificate. This is a way of saying that one certificate is vouching for the other. As an example of this, the certificate for <em>thomashunter.name</em> has been signed for by another certificate called <em>Let’s Encrypt Authority X3</em>. That <a data-primary="TLS (Transport Layer Security)" data-secondary="certificates" data-tertiary="chain of trust" data-type="indexterm" id="idm46291204477544"/><a data-primary="certificates" data-secondary="TLS" data-tertiary="chain of trust" data-type="indexterm" id="idm46291204214984"/>certificate has been signed by another one called <em>IdenTrust DST Root CA X3</em>. The three certificates form a <em>chain of trust</em> (see <a data-type="xref" href="#fig_certificate_chain">Figure 2-1</a> for a visualization of this).</p>&#13;
&#13;
<figure><div class="figure" id="fig_certificate_chain">&#13;
<img alt="Visualization of the certificate chain of trust" src="assets/dsnj_0201.png"/>&#13;
<h6><span class="label">Figure 2-1. </span>The certificate chain of trust</h6>&#13;
</div></figure>&#13;
&#13;
<p>The highest point in the chain <a data-primary="root certificate" data-type="indexterm" id="idm46291204435208"/><a data-primary="certificates" data-secondary="root certificate" data-type="indexterm" id="idm46291204434504"/>is called the root certificate. This certificate is trusted by much of the world; in fact, its public key is included in modern browsers and operating systems.</p>&#13;
&#13;
<p>A better approach to working with self-signed <a data-primary="TLS (Transport Layer Security)" data-secondary="certificates" data-startref="tls_certs" data-type="indexterm" id="idm46291204432648"/><a data-primary="certificates" data-secondary="TLS" data-startref="tls_certs1" data-type="indexterm" id="idm46291204431432"/>certificates is to actually give the client a copy of the trusted self-signed certificate, in this case the <em>basic-certificate.cert</em> &#13;
<span class="keep-together">file generated</span> previously. This certificate can then be passed along by using the &#13;
<span class="keep-together"><code>ca: certContent</code></span> options flag. An example of this can be seen in <a data-type="xref" href="#ex_node_client_https">Example 2-8</a>.</p>&#13;
<div data-type="example" id="ex_node_client_https">&#13;
<h5><span class="label">Example 2-8. </span><em>web-api/consumer-https-basic.js</em></h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c-Hashbang">#!/usr/bin/env node&#13;
</code><code>&#13;
</code><code class="c1">// npm install fastify@3.2 node-fetch@2.6&#13;
</code><code class="c1">// Warning: Not as efficient as using a Reverse Proxy&#13;
</code><code class="kr">const</code><code> </code><code class="nx">server</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'fastify'</code><code class="p">)</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">fetch</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'node-fetch'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">https</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'https'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">fs</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">HOST</code><code> </code><code class="o">=</code><code> </code><code class="s1">'127.0.0.1'</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">PORT</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code><code> </code><code class="o">||</code><code> </code><code class="mi">3000</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">TARGET</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">TARGET</code><code> </code><code class="o">||</code><code> </code><code class="s1">'localhost:4000'</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="kr">const</code><code> </code><code class="nx">options</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code>&#13;
  </code><code class="nx">agent</code><code class="o">:</code><code> </code><code class="k">new</code><code> </code><code class="nx">https</code><code class="p">.</code><code class="nx">Agent</code><code class="p">(</code><code class="p">{</code><code> </code><a class="co" href="#callout_protocols_CO4-1" id="co_protocols_CO4-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
    </code><code class="nx">ca</code><code class="o">:</code><code> </code><code class="nx">fs</code><code class="p">.</code><code class="nx">readFileSync</code><code class="p">(</code><code class="nx">__dirname</code><code class="o">+</code><code class="s1">'/../shared/tls/basic-certificate.cert'</code><code class="p">)</code><code class="p">,</code><code>&#13;
  </code><code class="p">}</code><code class="p">)</code><code>&#13;
</code><code class="p">}</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="nx">server</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code><code> </code><code class="nx">async</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
  </code><code class="kr">const</code><code> </code><code class="nx">req</code><code> </code><code class="o">=</code><code> </code><code class="nx">await</code><code> </code><code class="nx">fetch</code><code class="p">(</code><code class="sb">`</code><code class="sb">https://</code><code class="si">${</code><code class="nx">TARGET</code><code class="si">}</code><code class="sb">/recipes/42</code><code class="sb">`</code><code class="p">,</code><code>&#13;
    </code><code class="nx">options</code><code class="p">)</code><code class="p">;</code><code>&#13;
  </code><code class="kr">const</code><code> </code><code class="nx">payload</code><code> </code><code class="o">=</code><code> </code><code class="nx">await</code><code> </code><code class="nx">req</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>&#13;
&#13;
  </code><code class="k">return</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="nx">consumer_pid</code><code class="o">:</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">pid</code><code class="p">,</code><code>&#13;
    </code><code class="nx">producer_data</code><code class="o">:</code><code> </code><code class="nx">payload</code><code>&#13;
  </code><code class="p">}</code><code class="p">;</code><code>&#13;
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="nx">server</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">PORT</code><code class="p">,</code><code> </code><code class="nx">HOST</code><code class="p">,</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`</code><code class="sb">Consumer running at http://</code><code class="si">${</code><code class="nx">HOST</code><code class="si">}</code><code class="sb">:</code><code class="si">${</code><code class="nx">PORT</code><code class="si">}</code><code class="sb">/</code><code class="sb">`</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_protocols_CO4-1" id="callout_protocols_CO4-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The client is now trusting the exact public key used by the server.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Now run the <em>web-api</em> service and <a data-primary="web-api service" data-secondary="HTTP request" data-type="indexterm" id="idm46291204247896"/>make an HTTP request to it by running the following commands:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>node web-api/consumer-https-basic.js <code class="c"># terminal 1</code>&#13;
<code class="nv">$ </code>curl http://localhost:3000/          <code class="c"># terminal 2</code></pre>&#13;
&#13;
<p>The <code>curl</code> command <a data-primary="recipe-api" data-secondary="curl command and" data-type="indexterm" id="idm46291204379736"/><a data-primary="web-api service" data-secondary="curl command and" data-type="indexterm" id="idm46291195272424"/>talks to <em>web-api</em> using HTTP, and <em>web-api</em> then talks <a data-primary="recipe-api" data-secondary="HTTPS and" data-type="indexterm" id="idm46291195270488"/>to <em>recipe-api</em> using HTTPS.</p>&#13;
&#13;
<p>Recall from <a data-type="xref" href="#ex_node_server_https">Example 2-7</a> that <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="server" data-tertiary="private key" data-type="indexterm" id="idm46291195259528"/><a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="server" data-tertiary="public key" data-type="indexterm" id="idm46291204220280"/><a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="key management" data-type="indexterm" id="keyman"/>each HTTPS server needs access to both the public and private key in order to receive requests. Also recall that a private key should never fall into the hands of an adversary. So, having a single pair of public and private keys for all services within a company is dangerous. If just one of the projects leaks its private key, then all projects are affected!</p>&#13;
&#13;
<p>One approach is to generate a new key for every single running service. Unfortunately, a copy of every server’s public key would need to be distributed to every client that might want to communicate with it, like in <a data-type="xref" href="#ex_node_client_https">Example 2-8</a>. This would be quite a maintenance nightmare! Instead, the approach used by non-self-signed certificates can be emulated: generate a single internal root certificate, keep the private key for that secure, but use it to sign each service’s set of keys.</p>&#13;
&#13;
<p>Run the commands in <a data-type="xref" href="#ex_private_ca">Example 2-9</a> to do exactly this. These commands represent a condensed version of what you might do within an organization. The steps noted with <em>CSR</em> would be run on a very private machine, one that is just used for certificate generation purposes. The steps noted with <em>APP</em> would be performed on behalf of the new application.</p>&#13;
<div data-type="example" id="ex_private_ca">&#13;
<h5><span class="label">Example 2-9. </span>How to be your own Certificate Authority</h5>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="c"># Happens once for the CA&#13;
</code><code class="nv">$ </code><code>openssl</code><code> </code><code>genrsa</code><code> </code><code>-des3</code><code> </code><code>-out</code><code> </code><code>ca-private-key.key</code><code> </code><code class="m">2048</code><code> </code><a class="co" href="#callout_protocols_CO5-1" id="co_protocols_CO5-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nv">$ </code><code>openssl</code><code> </code><code>req</code><code> </code><code>-x509</code><code> </code><code>-new</code><code> </code><code>-nodes</code><code> </code><code>-key</code><code> </code><code>ca-private-key.key</code><code> </code><code class="se">\&#13;
</code><code>  </code><code>-sha256</code><code> </code><code>-days</code><code> </code><code class="m">365</code><code> </code><code>-out</code><code> </code><code>shared/tls/ca-certificate.cert</code><code> </code><a class="co" href="#callout_protocols_CO5-2" id="co_protocols_CO5-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
&#13;
</code><code class="c"># Happens for each new certificate&#13;
</code><code class="nv">$ </code><code>openssl</code><code> </code><code>genrsa</code><code> </code><code>-out</code><code> </code><code>recipe-api/tls/producer-private-key.key</code><code> </code><code class="m">2048</code><code> </code><a class="co" href="#callout_protocols_CO5-3" id="co_protocols_CO5-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="nv">$ </code><code>openssl</code><code> </code><code>req</code><code> </code><code>-new</code><code> </code><code>-key</code><code> </code><code>recipe-api/tls/producer-private-key.key</code><code> </code><code class="se">\&#13;
</code><code>  </code><code>-out</code><code> </code><code>recipe-api/tls/producer.csr</code><code> </code><a class="co" href="#callout_protocols_CO5-4" id="co_protocols_CO5-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
</code><code class="nv">$ </code><code>openssl</code><code> </code><code>x509</code><code> </code><code>-req</code><code> </code><code>-in</code><code> </code><code>recipe-api/tls/producer.csr</code><code> </code><code class="se">\&#13;
</code><code>  </code><code>-CA</code><code> </code><code>shared/tls/ca-certificate.cert</code><code> </code><code class="se">\&#13;
</code><code>  </code><code>-CAkey</code><code> </code><code>ca-private-key.key</code><code> </code><code>-CAcreateserial</code><code> </code><code class="se">\&#13;
</code><code>  </code><code>-out</code><code> </code><code>shared/tls/producer-certificate.cert</code><code> </code><code>-days</code><code> </code><code class="m">365</code><code> </code><code>-sha256</code><code> </code><a class="co" href="#callout_protocols_CO5-5" id="co_protocols_CO5-5"><img alt="5" src="assets/5.png"/></a></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_protocols_CO5-1" id="callout_protocols_CO5-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p><em>CSR</em>: Generate a private key <em>ca-private-key.key</em> for the Certificate Authority. You’ll be prompted for a password.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO5-2" id="callout_protocols_CO5-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p><em>CSR</em>: Generate a root cert <em>shared/tls/ca-certificate.cert</em> (this will be provided to clients). You’ll get asked a lot of questions, but they don’t matter for this example.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO5-3" id="callout_protocols_CO5-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p><em>APP</em>: Generate a private key <em>producer-private-key.key</em> for a particular service.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO5-4" id="callout_protocols_CO5-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p><em>APP</em>: Create a CSR <em>producer.csr</em> for that same service. Be sure to answer <code>localhost</code> for the <em>Common Name</em> question, but other questions don’t matter as much.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO5-5" id="callout_protocols_CO5-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p><em>CSR</em>: Generate a service certificate <em>producer-certificate.cert</em> signed by the CA.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>Now modify the code in <em>web-api/consumer-https-basic.js</em> to load the <em>ca-certificate.cert</em> file. Also modify <em>recipe-api/producer-https-basic.js</em> to load both the <em>producer-private-key.key</em> and <em>producer-certificate.cert</em> files.&#13;
Restart both servers and run the following command again:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>curl http://localhost:3000/</pre>&#13;
&#13;
<p>You should get a successful response, even though <em>web-api</em> wasn’t aware of the <em>recipe-api</em> service’s exact certificate; it gains its trust from the root <em>ca-certificate.cert</em> certificate instead.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46291195030168">&#13;
<h5>Alternatives to Manual Key Management</h5>&#13;
<p>This process ended up being quite a bit of work, but there are tools out there that can make it easier. <a class="orm:hideurl" href="https://vaultproject.io">HashiCorp Vault</a> has a feature it calls the PKI Secrets Engine. This &#13;
<span class="keep-together">service</span> provides an HTTP API that, among other things, handles the creation of certificates as well as their revocations (marking a particular <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="key management" data-startref="keyman" data-type="indexterm" id="idm46291195026792"/><a data-primary="protocols" data-secondary="HTTPS" data-startref="pro_http_tls" data-type="indexterm" id="idm46291195025576"/>certificate as no longer being trusted in case it has been compromised).</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="JSON over HTTP" data-type="sect2"><div class="sect2" id="idm46291204666824">&#13;
<h2>JSON over HTTP</h2>&#13;
&#13;
<p>Up to this point, the <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="JSON over" data-type="indexterm" id="json_over"/><a data-primary="JSON" data-secondary="over HTTP" data-type="indexterm" id="jsonover"/><a data-primary="protocols" data-secondary="JSON over HTTP" data-type="indexterm" id="idm46291195020616"/><a data-primary="consumers" data-secondary="JSON over HTTP" data-type="indexterm" id="consumejson"/>body of HTTP requests and responses hasn’t really been examined. This is because the HTTP standard doesn’t dictate quite as much what goes in the body of an HTTP message. As I mentioned earlier, HTTP is a protocol that many other protocols end up being built on top of. This is where the mystical Layer 8 of the OSI model comes into play.</p>&#13;
&#13;
<p>The most popular APIs <a data-primary="API (application programming interface)" data-secondary="JSON over HTTP" data-type="indexterm" id="idm46291195015192"/><a data-primary="REST (Representational State Transfer)" data-type="indexterm" id="idm46291195014168"/>written today are <em>JSON over HTTP</em>, a pattern that is often—usually mistakenly—referred to as <em>REST</em> (Representational State Transfer). The small JSON payloads you’ve been sending back and forth in the example applications are an example of JSON over HTTP.</p>&#13;
&#13;
<p>Simply communicating by JSON over HTTP leaves a lot to be desired. For example, how are errors represented? Certainly the HTTP error status codes should be leveraged and general semantics should be followed, but what payload should actually be used for the body? What is the correct way to represent a particular internal object in JSON? What about meta information that doesn’t map cleanly to HTTP headers, such as pagination data? The problem with JSON over HTTP, as well as many APIs touting the REST label, is that the entirety of the contract between producer and consumer exists in documentation. A human must read the docs and manually write code to interact with these payloads.</p>&#13;
&#13;
<p>Another issue is that every JSON over HTTP service is going to implement things differently. Short of having a <code>Content-Type: application/json</code> header, anything can happen between that first and last curly brace. This usually requires that each new service consumed by a particular client must have new code written.</p>&#13;
&#13;
<p>For a more concrete <a data-primary="JSON" data-secondary="over HTTP" data-tertiary="pagination" data-type="indexterm" id="idm46291195009464"/>example, consider pagination. The loose concept of “JSON over HTTP” doesn’t have a built-in way to handle this. The Stripe API uses the query parameters <code>?limit=10&amp;starting_after=20</code>. Meta information is provided in the response body, such as the <code>has_more</code> boolean property that lets the client know that there is more data to paginate. The GitHub API, on the other hand, uses the query parameters <code>?per_page=10&amp;page=3</code>. Meta information about pagination is provided in the <code>Link</code> response header.</p>&#13;
&#13;
<p>It’s because of these reasons that different standards for representing request and response bodies in HTTP have been invented. <a class="orm:hideurl" href="https://jsonapi.org/format/">JSON:API</a>, <a class="orm:hideurl" href="http://json-schema.org/specification.html">JSON Schema</a>, and <a class="orm:hideurl" href="https://swagger.io/specification/">OpenAPI (Swagger)</a> are specifications that fully embrace JSON over HTTP and attempt to bring order to chaos. They deal with concepts like describing request and response bodies and, to a varying extent, how to interact with an HTTP API server. The next two sections deal with GraphQL and gRPC, which are more extreme protocol changes.</p>&#13;
&#13;
<p><a data-type="xref" href="ch03.html#ch_scaling_sec_bm_subsec_protocol_json">“JSON over HTTP benchmarks”</a> contains benchmarks on communicating between two servers using JSON <a data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="JSON over" data-startref="json_over" data-type="indexterm" id="idm46291194984824"/><a data-primary="JSON" data-secondary="over HTTP" data-startref="jsonover" data-type="indexterm" id="idm46291194983592"/><a data-primary="consumers" data-secondary="JSON over HTTP" data-startref="consumejson" data-type="indexterm" id="idm46291194982376"/>over HTTP.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Dangers of Serializing POJOs" data-type="sect2"><div class="sect2" id="idm46291194980904">&#13;
<h2>The Dangers of Serializing POJOs</h2>&#13;
&#13;
<p>JavaScript makes <a data-primary="POJO (Plain Ol' JavaScript Object)" data-type="indexterm" id="pojo"/><a data-primary="serialization" data-secondary="POJO" data-type="indexterm" id="idm46291194978184"/>it dangerously easy to serialize an in-memory representation of a domain object. By simply calling <code>JSON.stringify(obj)</code>—which is what most HTTP frameworks automatically do for you—any refactoring of your project’s internal properties can leak out and result in API breaking changes. It can also result in leaking secrets.</p>&#13;
&#13;
<p>A much better approach is to add a safety net to objects for manually controlling how they’re to be <a data-primary="objects" data-secondary="marshalling" data-type="indexterm" id="idm46291194975640"/><a data-primary="marshalling" data-type="indexterm" id="idm46291194974664"/><a data-primary="JSON" data-secondary="marshalling" data-type="indexterm" id="idm46291194973992"/><a data-primary="toJSON() method" data-type="indexterm" id="idm46291194973048"/><a data-primary="methods" data-secondary="toJSON()" data-type="indexterm" id="idm46291194972376"/><a data-primary="JSON" data-secondary="toJSON() method" data-type="indexterm" id="idm46291194971432"/>represented in JSON—a pattern called <em>marshalling</em>. This can be achieved by representing serializable data as a class with a <code>toJSON()</code> method, instead of storing data as a POJO (Plain Ol’ JavaScript Object).</p>&#13;
&#13;
<p>As an example of this, here are two ways to represent a <code>User</code> object within your codebase. The first one is a POJO, and the second is a class with a <code>toJSON()</code> method:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">user1</code> <code class="o">=</code> <code class="p">{</code>&#13;
  <code class="nx">username</code><code class="o">:</code> <code class="s1">'pojo'</code><code class="p">,</code>&#13;
  <code class="nx">email</code><code class="o">:</code> <code class="s1">'pojo@example.org'</code>&#13;
<code class="p">};</code>&#13;
<code class="kr">class</code> <code class="nx">User</code> <code class="p">{</code>&#13;
  <code class="nx">constructor</code><code class="p">(</code><code class="nx">username</code><code class="p">,</code> <code class="nx">email</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">this</code><code class="p">.</code><code class="nx">username</code> <code class="o">=</code> <code class="nx">username</code><code class="p">;</code>&#13;
    <code class="k">this</code><code class="p">.</code><code class="nx">email</code> <code class="o">=</code> <code class="nx">email</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
  <code class="nx">toJSON</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">{</code>&#13;
      <code class="nx">username</code><code class="o">:</code> <code class="k">this</code><code class="p">.</code><code class="nx">username</code><code class="p">,</code>&#13;
      <code class="nx">email</code><code class="o">:</code> <code class="k">this</code><code class="p">.</code><code class="nx">email</code><code class="p">,</code>&#13;
    <code class="p">};</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
<code class="kr">const</code> <code class="nx">user2</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">User</code><code class="p">(</code><code class="s1">'class'</code><code class="p">,</code> <code class="s1">'class@example.org'</code><code class="p">);</code>&#13;
<code class="c1">// ...</code>&#13;
<code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">user1</code><code class="p">);</code> <code class="c1">// POJO</code>&#13;
<code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">user2</code><code class="p">);</code> <code class="c1">// Class Instance</code></pre>&#13;
&#13;
<p>In both of these situations, when the response is sent, a consumer of the service will receive a JSON string representing an object with the same properties:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="nt">"username"</code><code class="p">:</code><code class="s2">"pojo"</code><code class="p">,</code><code class="nt">"email"</code><code class="p">:</code><code class="s2">"pojo@example.org"</code><code class="p">}</code>&#13;
<code class="p">{</code><code class="nt">"username"</code><code class="p">:</code><code class="s2">"class"</code><code class="p">,</code><code class="nt">"email"</code><code class="p">:</code><code class="s2">"class@example.org"</code><code class="p">}</code></pre>&#13;
&#13;
<p>Perhaps at some point the application is modified to start tracking the user’s password as well. This might be done by adding a new <code>password</code> attribute to instances of the user object, perhaps by modifying the code where a user instance is created, setting the password at creation time. Or perhaps some dark corner of the codebase is setting the password by calling <code>user.password = value</code>. Such a change can be represented like so:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">user1</code><code class="p">.</code><code class="nx">password</code> <code class="o">=</code> <code class="nx">user2</code><code class="p">.</code><code class="nx">password</code> <code class="o">=</code> <code class="s1">'hunter2'</code><code class="p">;</code>&#13;
<code class="c1">// ...</code>&#13;
<code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">user1</code><code class="p">);</code>&#13;
<code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">user2</code><code class="p">);</code></pre>&#13;
&#13;
<p>When this happens, the POJO is now leaking private information to consumers. The class with explicit marshalling logic is not leaking such details:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="nt">"username"</code><code class="p">:</code><code class="s2">"pojo"</code><code class="p">,</code><code class="nt">"email"</code><code class="p">:</code><code class="s2">"pojo@example.org"</code><code class="p">,</code><code class="nt">"password"</code><code class="p">:</code><code class="s2">"hunter2"</code><code class="p">}</code>&#13;
<code class="p">{</code><code class="nt">"username"</code><code class="p">:</code><code class="s2">"class"</code><code class="p">,</code><code class="nt">"email"</code><code class="p">:</code><code class="s2">"class@example.org"</code><code class="p">}</code></pre>&#13;
&#13;
<p>Even if there are tests that check the HTTP response <a data-primary="POJO (Plain Ol' JavaScript Object)" data-startref="pojo" data-type="indexterm" id="idm46291194593496"/>messages for the presence of &#13;
<span class="keep-together">values</span> like <code>username</code> and <code>email</code>, they probably won’t fail when a new attribute like &#13;
<span class="keep-together"><code>password</code></span> has been added.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="API Facade with GraphQL" data-type="sect1"><div class="sect1" id="ch_protocols_sec_graphql">&#13;
<h1>API Facade with GraphQL</h1>&#13;
&#13;
<p>GraphQL is a protocol <a data-primary="GraphQL" data-type="indexterm" id="idm46291194463960"/><a data-primary="protocols" data-secondary="GraphQL" data-type="indexterm" id="prot_grql"/>for querying APIs, designed by Facebook. It’s very useful for building <em>facade services</em>—which <a data-primary="facade services" data-type="indexterm" id="idm46291194461496"/>is one service that sits in front of multiple other services and data sources. GraphQL attempts to solve several issues present with traditional ad hoc implementations of JSON over HTTP APIs. GraphQL is particularly good at returning the smallest amount of data needed by a client. It’s also good at &#13;
<span class="keep-together">hydrating</span> a response payload with data from multiple sources so that a client can get everything it needs while making a single request.</p>&#13;
&#13;
<p>GraphQL doesn’t dictate that a particular underlying protocol be used. Most implementations, and the implementation used in this section, do use GraphQL over HTTP, but it’s just as happy being consumed over another protocol like TCP. An entire GraphQL query is described using a single string, much like with an SQL query. When implementations are built on top of HTTP they often use a single endpoint, with clients sending queries via the <code>POST</code> method.</p>&#13;
&#13;
<p>GraphQL responses are usually <a data-primary="JSON" data-secondary="GraphQL responses" data-type="indexterm" id="idm46291194457768"/>provided using JSON, but again, a different response type could be used as long as it’s able to represent a hierarchy of data. These examples use JSON as well.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>As of today, it’s more common to expose JSON over HTTP APIs to the public. GraphQL APIs are more likely to be consumed by clients maintained by the same organization—such as internal usage or mobile first-party apps. This is beginning to change, however, and more companies are beginning to expose public GraphQL APIs.</p>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="GraphQL Schema" data-type="sect2"><div class="sect2" id="ch_protocols_sec_graphql_sec_schema">&#13;
<h2>GraphQL Schema</h2>&#13;
&#13;
<p>A GraphQL schema is a <a data-primary="GraphQL" data-secondary="schema" data-type="indexterm" id="idm46291194452888"/><a data-primary="schema, GraphQL" data-type="indexterm" id="idm46291194451880"/>string that describes all the interactions a particular GraphQL server is able to make. It also describes all the objects a server can represent, as well as the types of those objects (such as <code>String</code> and <code>Int</code>). There are essentially two classifications of these types; a type is either a primitive or it is a named object. Every named object will need an entry in the schema; no objects can be used that aren’t named and described. Create a new file name <em>schema.gql</em> and enter the contents of <a data-type="xref" href="#ex_graphql_schema">Example 2-10</a> into this file.</p>&#13;
<div data-type="example" id="ex_graphql_schema">&#13;
<h5><span class="label">Example 2-10. </span><em>shared/graphql-schema.gql</em></h5>&#13;
&#13;
<pre data-type="programlisting">type Query { <a class="co" href="#callout_protocols_CO6-1" id="co_protocols_CO6-1"><img alt="1" src="assets/1.png"/></a>&#13;
  recipe(id: ID): Recipe&#13;
  pid: Int&#13;
}&#13;
type Recipe { <a class="co" href="#callout_protocols_CO6-2" id="co_protocols_CO6-2"><img alt="2" src="assets/2.png"/></a>&#13;
  id: ID!&#13;
  name: String!&#13;
  steps: String&#13;
  ingredients: [Ingredient]! <a class="co" href="#callout_protocols_CO6-3" id="co_protocols_CO6-3"><img alt="3" src="assets/3.png"/></a>&#13;
}&#13;
type Ingredient {&#13;
  id: ID!&#13;
  name: String!&#13;
  quantity: String&#13;
}</pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_protocols_CO6-1" id="callout_protocols_CO6-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Top-level query representation.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO6-2" id="callout_protocols_CO6-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The <code>Recipe</code> type.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO6-3" id="callout_protocols_CO6-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>A <code>Recipe</code> has <code>Ingredient</code> children in an array called <code>ingredients</code>.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>The first entry, <code>Query</code>, represents the root of the query provided by the consumer. In this case the consumer can essentially ask for two different sets of information. The <code>pid</code> entry returns an integer. The other entry, <code>recipe</code>, returns a <code>Recipe</code> type, which was defined in the schema document. This call accepts an argument when it is being queried. In this case the schema is stating that by calling the <code>recipe</code> method with an argument named <code>id</code>, an object following the <code>Recipe</code> schema is returned. <a data-type="xref" href="#table_graphql_scalars">Table 2-3</a> contains a list of scalar types used by GraphQL.</p>&#13;
<table id="table_graphql_scalars">&#13;
<caption><span class="label">Table 2-3. </span>GraphQL scalars</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Name</th>&#13;
<th>Examples</th>&#13;
<th>JSON equivalent</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>Int</code></p></td>&#13;
<td><p>10, 0, -1</p></td>&#13;
<td><p>Number</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>Float</code></p></td>&#13;
<td><p>1, -1.0</p></td>&#13;
<td><p>Number</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>String</code></p></td>&#13;
<td><p>“Hello, friend!\n”</p></td>&#13;
<td><p>String</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>Boolean</code></p></td>&#13;
<td><p>true, false</p></td>&#13;
<td><p>Boolean</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>ID</code></p></td>&#13;
<td><p>“42”, “975dbe93”</p></td>&#13;
<td><p>String</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>The <code>Recipe</code> object is then described in further detail in the next block. This block contains an <code>id</code> property, which is an <code>ID</code>. By default the fields are nullable—if the client asks for the value and the server doesn’t provide the value, then it will be coerced to null. The <code>!</code> character states that the server must provide the field. <code>Recipe</code> also has <code>name</code> and <code>steps</code> properties that are strings (<code>String</code>). Finally, it has a property named <code>ingredients</code>, which contains an array of <code>Ingredient</code> entries. The next block describes the <code>Ingredient</code> object and contains its own properties. This schema resembles the response used so far in the example applications.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Queries and Responses" data-type="sect2"><div class="sect2" id="idm46291194394744">&#13;
<h2>Queries and Responses</h2>&#13;
&#13;
<p>Next, you’ll look at what a <a data-primary="GraphQL" data-secondary="queries" data-type="indexterm" id="grqlqry"/><a data-primary="GraphQL" data-secondary="responses" data-type="indexterm" id="grqlres"/><a data-primary="queries, GraphQL" data-type="indexterm" id="grqlqry1"/><a data-primary="responses to queries, GraphQL" data-type="indexterm" id="grqlres1"/>query for interacting with this data might look like, as well as the response payloads. Queries in GraphQL have a very useful feature in that the consumer gets to specify exactly what properties it is looking for. Another convenient feature is that there is never any surprise in the format of the response data; the nested query hierarchy ends up being in the same shape as the resulting data.</p>&#13;
&#13;
<p>First, consider a very basic example where only the <code>pid</code> value should be retrieved from the server.&#13;
The query to do so looks like this:</p>&#13;
&#13;
<pre data-type="programlisting">{&#13;
  pid&#13;
}</pre>&#13;
&#13;
<p>An example response payload that matches the previous query would then resemble the following:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"data"</code><code class="p">:</code> <code class="p">{</code>&#13;
    <code class="nt">"pid"</code><code class="p">:</code> <code class="mi">9372</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The outermost “envelope” object, the one that contains <code>data</code>, is there to help disambiguate meta information about the response from the response itself. Remember that GraphQL isn’t tied to HTTP, which provides concepts such as errors, so the response payloads must be able to differentiate a successful response from an error (if this query had an error, there would be no <code>data</code> property in the root, but there would be an <code>errors</code> array).</p>&#13;
&#13;
<p>Also, notice that the recipe data isn’t displayed at all, even though it was defined in the root <code>Query</code> type in the GraphQL schema. Again, this is because queries specify exactly which fields should be returned.</p>&#13;
&#13;
<p>Up next is a more complicated query. This query will get a specific recipe based on its ID. It will also get information about the ingredients that belong to that recipe. The query would then look like this:</p>&#13;
&#13;
<pre data-type="programlisting">{&#13;
  recipe(id: 42) {&#13;
    name&#13;
    ingredients {&#13;
      name&#13;
      quantity&#13;
    }&#13;
  }&#13;
}</pre>&#13;
&#13;
<p>This query states that it wants an instance of the recipe having an <code>id</code> of 42. It also wants the <code>name</code> of that recipe, but not the <code>id</code> or the <code>steps</code> properties, and wants access to the ingredients, specifically their <code>name</code> and <code>quantity</code> values.</p>&#13;
&#13;
<p>The response payload for this query would then look something like this:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"data"</code><code class="p">:</code> <code class="p">{</code>&#13;
    <code class="nt">"recipe"</code><code class="p">:</code> <code class="p">{</code>&#13;
      <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Chicken Tikka Masala"</code><code class="p">,</code>&#13;
      <code class="nt">"ingredients"</code><code class="p">:</code> <code class="p">[</code>&#13;
        <code class="p">{</code> <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Chicken"</code><code class="p">,</code> <code class="nt">"quantity"</code><code class="p">:</code> <code class="s2">"1 lb"</code> <code class="p">},</code>&#13;
        <code class="p">{</code> <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Sauce"</code><code class="p">,</code> <code class="nt">"quantity"</code><code class="p">:</code> <code class="s2">"2 cups"</code> <code class="p">}</code>&#13;
      <code class="p">]</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Again, notice how the nested <a data-primary="JSON" data-secondary="nested responses" data-type="indexterm" id="idm46291194313048"/>request query follows the same shape as the nested JSON response. Assuming the developer who is writing the query is aware of the schema, that developer can safely write any query and know if it will be valid or not, know the shape of the response, and even know the types of every property in the response.</p>&#13;
&#13;
<p>In fact, the <code>graphql</code> npm package provides a web REPL specifically for writing and testing queries. The name of this interface is <em>GraphiQL</em>, a play on “GraphQL” and “graphical.”</p>&#13;
&#13;
<p>The <code>graphql</code> package is the official package for building GraphQL services in Node.js. It’s also the official reference implementation for GraphQL as a whole, as GraphQL isn’t tied to a specific language or platform. The following code samples make use of the <code>fastify-gql</code> package. This package lets GraphQL work with Fastify in a convenient manner, but it is <a data-primary="fastify-gql package" data-type="indexterm" id="idm46291194294984"/><a data-primary="packages" data-secondary="fastify-gql" data-type="indexterm" id="idm46291194294280"/><a data-primary="GraphQL" data-secondary="queries" data-startref="grqlqry" data-type="indexterm" id="idm46291194293336"/><a data-primary="GraphQL" data-secondary="responses" data-startref="grqlres" data-type="indexterm" id="idm46291194292120"/><a data-primary="queries, GraphQL" data-startref="grqlqry1" data-type="indexterm" id="idm46291194290904"/><a data-primary="responses to queries, GraphQL" data-startref="grqlres1" data-type="indexterm" id="idm46291194289960"/>essentially a wrapper around the official <code>graphql</code> package.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="GraphQL Producer" data-type="sect2"><div class="sect2" id="idm46291194389672">&#13;
<h2>GraphQL Producer</h2>&#13;
&#13;
<p>Now that you’ve seen <a data-primary="GraphQL" data-secondary="producers" data-type="indexterm" id="grqlprod"/>some sample queries and their responses, you’re ready to write some code. First, create a new <em>recipe-api</em> <a data-primary="recipe-api" data-secondary="GraphQL" data-type="indexterm" id="idm46291194284968"/><a data-primary="GraphQL" data-secondary="recipe-api service file" data-type="indexterm" id="idm46291194283960"/>service file based on the content in <a data-type="xref" href="#ex_graphql_producer">Example 2-11</a>.</p>&#13;
<div data-type="example" id="ex_graphql_producer">&#13;
<h5><span class="label">Example 2-11. </span><em>recipe-api/producer-graphql.js</em></h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c-Hashbang">#!/usr/bin/env node&#13;
</code><code class="c1">// npm install fastify@3.2 fastify-gql@5.3&#13;
</code><code class="kr">const</code><code> </code><code class="nx">server</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'fastify'</code><code class="p">)</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">graphql</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'fastify-gql'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">fs</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">schema</code><code> </code><code class="o">=</code><code> </code><code class="nx">fs</code><code class="p">.</code><code class="nx">readFileSync</code><code class="p">(</code><code class="nx">__dirname</code><code> </code><code class="o">+</code><code>&#13;
  </code><code class="s1">'/../shared/graphql-schema.gql'</code><code class="p">)</code><code class="p">.</code><code class="nx">toString</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_protocols_CO7-1" id="co_protocols_CO7-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">HOST</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">HOST</code><code> </code><code class="o">||</code><code> </code><code class="s1">'127.0.0.1'</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">PORT</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code><code> </code><code class="o">||</code><code> </code><code class="mi">4000</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="kr">const</code><code> </code><code class="nx">resolvers</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_protocols_CO7-2" id="co_protocols_CO7-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="nx">Query</code><code class="o">:</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_protocols_CO7-3" id="co_protocols_CO7-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
    </code><code class="nx">pid</code><code class="o">:</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">pid</code><code class="p">,</code><code>&#13;
    </code><code class="nx">recipe</code><code class="o">:</code><code> </code><code class="nx">async</code><code> </code><code class="p">(</code><code class="nx">_obj</code><code class="p">,</code><code> </code><code class="p">{</code><code class="nx">id</code><code class="p">}</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
      </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">id</code><code> </code><code class="o">!=</code><code> </code><code class="mi">42</code><code class="p">)</code><code> </code><code class="k">throw</code><code> </code><code class="k">new</code><code> </code><code class="nb">Error</code><code class="p">(</code><code class="sb">`</code><code class="sb">recipe </code><code class="si">${</code><code class="nx">id</code><code class="si">}</code><code class="sb"> not found</code><code class="sb">`</code><code class="p">)</code><code class="p">;</code><code>&#13;
      </code><code class="k">return</code><code> </code><code class="p">{</code><code>&#13;
        </code><code class="nx">id</code><code class="p">,</code><code> </code><code class="nx">name</code><code class="o">:</code><code> </code><code class="s2">"Chicken Tikka Masala"</code><code class="p">,</code><code>&#13;
        </code><code class="nx">steps</code><code class="o">:</code><code> </code><code class="s2">"Throw it in a pot..."</code><code class="p">,</code><code>&#13;
      </code><code class="p">}</code><code>&#13;
    </code><code class="p">}</code><code>&#13;
  </code><code class="p">}</code><code class="p">,</code><code>&#13;
  </code><code class="nx">Recipe</code><code class="o">:</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_protocols_CO7-4" id="co_protocols_CO7-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
    </code><code class="nx">ingredients</code><code class="o">:</code><code> </code><code class="nx">async</code><code> </code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
      </code><code class="k">return</code><code> </code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">id</code><code> </code><code class="o">!=</code><code> </code><code class="mi">42</code><code class="p">)</code><code> </code><code class="o">?</code><code> </code><code class="p">[</code><code class="p">]</code><code> </code><code class="o">:</code><code> </code><code class="p">[</code><code>&#13;
        </code><code class="p">{</code><code> </code><code class="nx">id</code><code class="o">:</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="nx">name</code><code class="o">:</code><code> </code><code class="s2">"Chicken"</code><code class="p">,</code><code> </code><code class="nx">quantity</code><code class="o">:</code><code> </code><code class="s2">"1 lb"</code><code class="p">,</code><code> </code><code class="p">}</code><code class="p">,</code><code>&#13;
        </code><code class="p">{</code><code> </code><code class="nx">id</code><code class="o">:</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="nx">name</code><code class="o">:</code><code> </code><code class="s2">"Sauce"</code><code class="p">,</code><code> </code><code class="nx">quantity</code><code class="o">:</code><code> </code><code class="s2">"2 cups"</code><code class="p">,</code><code> </code><code class="p">}</code><code>&#13;
      </code><code class="p">]</code><code>&#13;
    </code><code class="p">}</code><code>&#13;
  </code><code class="p">}</code><code>&#13;
</code><code class="p">}</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="nx">server</code><code>&#13;
  </code><code class="p">.</code><code class="nx">register</code><code class="p">(</code><code class="nx">graphql</code><code class="p">,</code><code> </code><code class="p">{</code><code> </code><code class="nx">schema</code><code class="p">,</code><code> </code><code class="nx">resolvers</code><code class="p">,</code><code> </code><code class="nx">graphiql</code><code class="o">:</code><code> </code><code class="kc">true</code><code> </code><code class="p">}</code><code class="p">)</code><code> </code><a class="co" href="#callout_protocols_CO7-5" id="co_protocols_CO7-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
  </code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">PORT</code><code class="p">,</code><code> </code><code class="nx">HOST</code><code class="p">,</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`</code><code class="sb">Producer running at http://</code><code class="si">${</code><code class="nx">HOST</code><code class="si">}</code><code class="sb">:</code><code class="si">${</code><code class="nx">PORT</code><code class="si">}</code><code class="sb">/graphql</code><code class="sb">`</code><code class="p">)</code><code class="p">;</code><code>&#13;
  </code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_protocols_CO7-1" id="callout_protocols_CO7-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The schema file is provided to the <code>graphql</code> package.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO7-2" id="callout_protocols_CO7-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The <code>resolvers</code> object tells <code>graphql</code> how to build responses.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO7-3" id="callout_protocols_CO7-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>The <code>Query</code> entry represents the top-level query.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO7-4" id="callout_protocols_CO7-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The <code>Recipe</code> resolver is run when a <code>Recipe</code> is retrieved.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO7-5" id="callout_protocols_CO7-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>Fastify uses <code>server.register()</code> with the <code>fastify-gql</code> package; other frameworks have their own conventions.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>The GraphQL code gets <a data-primary="fastify-gql package" data-type="indexterm" id="idm46291193992488"/><a data-primary="packages" data-secondary="fastify-gql" data-type="indexterm" id="idm46291194153512"/><a data-primary="GraphQL" data-secondary="Fastify server" data-type="indexterm" id="idm46291194152568"/><a data-primary="Fastify server" data-secondary="GraphQL" data-type="indexterm" id="idm46291194151624"/>registered with the Fastify server on the <code>server.register</code> line. This ends up creating a route that listens at <code>/graphql</code> for incoming requests. It is this endpoint that the consumer will later send queries to. The following object configures GraphQL with the content of the <em>shared/graphql-schemal.gql</em> file, a reference to the <code>resolvers</code> object (covered shortly), and a final <code>graphiql</code> flag. This flag, if true, enables the GraphiQL console mentioned earlier. With the service running, that console can be visited at <em>http://localhost:4000/graphiql</em>. Ideally, you’d never set that value to true for a service running in production.</p>&#13;
&#13;
<p>Now it’s time to consider the <code>resolvers</code> object. This <a data-primary="GraphQL" data-secondary="resolvers object" data-type="indexterm" id="idm46291194055816"/>object has properties at the root that correlate to the different types described in the GraphQL schema. The <code>Query</code> property describes the top-level queries, whereas the <code>Recipe</code> describes the Recipe objects. Each property of those two objects is an <a data-primary="methods" data-secondary="asynchronous" data-type="indexterm" id="idm46291194126520"/>asynchronous method (methods that are awaited somewhere else in the code). That means these methods can return a promise, they can be an <code>async</code> function, or they can just return a simple value. There’s no databases involved in this example, so each method runs synchronously and returns a simple value.</p>&#13;
&#13;
<p>When these methods are called, GraphQL provides arguments about the context in which they’re being called. Consider the <code>resolvers.Query.recipe</code> method, for example. The first argument in this case is an empty object since it’s called at the root of the query. However, the second argument is an object representing the arguments being made to this function. In the schema file, a <code>recipe()</code> is defined as accepting an argument named <code>id</code> that accepts an ID and as returning a <code>Recipe</code> type. So, within this method, the <code>id</code> is provided as an argument. It’s also expected to return an object adhering to the <code>Recipe</code> shape.</p>&#13;
&#13;
<p>In the schema, you’ve defined the <code>Recipe</code> as having <code>id</code>, <code>name</code>, <code>steps</code>, and <code>ingredients</code> properties. So, in the object you’re returning, each of the scalar values have been specified. However, the <code>ingredients</code> property hasn’t been defined. That will be picked up by <code>resolvers.Recipe</code> automatically when the GraphQL code runs.</p>&#13;
&#13;
<p>GraphQL enforces that <a data-primary="GraphQL" data-secondary="JSON response" data-type="indexterm" id="idm46291193881064"/>the JSON response from the request matches the incoming query shape. If the response object in the <code>recipe()</code> method were modified to have an additional property called <code>serves</code>, GraphQL would automatically strip out that unknown value before the response is sent to the client. Additionally, if the client didn’t request either of the known <code>id</code> or <code>name</code> values, they would also be stripped from the response.</p>&#13;
&#13;
<p>Once the GraphQL code has run the <code>resolvers</code> and has recieved the top-level recipe it expects from the <code>recipe()</code> method call, and assuming the client has requested the <code>ingredients</code>, it’s now ready to call the code to hydrate those ingredient values. This is performed by calling the <code>resolvers.Recipe.ingredients</code> method. In this case, the first argument now contains information about the parent object, here the top-level <code>Recipe</code> instance. The object provided contains all of the information that was returned from the <code>recipe()</code> method call (in this example, the <code>id</code>, <code>name</code>, and <code>steps</code> values). The <code>id</code> is typically the most useful value. If this application were backed by a database, then the <code>id</code> could be used to make a database query and get the related <code>Ingredient</code> entries. However, this simple example just uses hard-coded <a data-primary="GraphQL" data-secondary="producers" data-startref="grqlprod" data-type="indexterm" id="idm46291193871768"/>values.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Each of the methods described within the <code>resolvers</code> object can be called asynchronously. GraphQL is smart enough to call them all essentially in parallel, allowing your application to make multiple outbound asynchronous calls to get data from other sources. Once the slowest request is finished, then the overall query can complete and a response can be sent to the consumer.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="GraphQL Consumer" data-type="sect2"><div class="sect2" id="idm46291194288008">&#13;
<h2>GraphQL Consumer</h2>&#13;
&#13;
<p>Now that you’re familiar <a data-primary="GraphQL" data-secondary="consumer" data-type="indexterm" id="grql_consume"/><a data-primary="consumers" data-secondary="GraphQL" data-type="indexterm" id="consume_grql"/>with building a producer that provides a GraphQL interface, it’s time to look at what it takes to build a consumer.</p>&#13;
&#13;
<p>Building a consumer is a bit simpler. There are npm packages to help with the query generation, but interacting with a GraphQL service is simple enough that you can simply rebuild it using basic tools.</p>&#13;
&#13;
<p><a data-type="xref" href="#ex_graphql_consumer">Example 2-12</a> creates a new <em>web-api</em> consumer. The <a data-primary="consumers" data-secondary="web-api service" data-type="indexterm" id="idm46291193862008"/><a data-primary="GraphQL" data-secondary="query variables" data-type="indexterm" id="idm46291193861000"/><a data-primary="queries, GraphQL" data-secondary="variables" data-type="indexterm" id="idm46291193860056"/><a data-primary="variables" data-secondary="query variables" data-type="indexterm" id="idm46291193859112"/>most important part of this example is the query that will be sent. It’s also going to make use of <em>query variables</em>, which are a GraphQL equivalent to <em>query parameters</em> in SQL. Variables are useful because, much like SQL, it’s dangerous to manually concatenate strings together to combine dynamic data, like user-supplied values, with static data, such as query code.</p>&#13;
<div data-type="example" id="ex_graphql_consumer">&#13;
<h5><span class="label">Example 2-12. </span><em>web-api/consumer-graphql.js</em></h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c-Hashbang">#!/usr/bin/env node&#13;
</code><code class="c1">// npm install fastify@3.2 node-fetch@2.6&#13;
</code><code class="kr">const</code><code> </code><code class="nx">server</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'fastify'</code><code class="p">)</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">fetch</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'node-fetch'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">HOST</code><code> </code><code class="o">=</code><code> </code><code class="s1">'127.0.0.1'</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">PORT</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code><code> </code><code class="o">||</code><code> </code><code class="mi">3000</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">TARGET</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">TARGET</code><code> </code><code class="o">||</code><code> </code><code class="s1">'localhost:4000'</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">complex_query</code><code> </code><code class="o">=</code><code> </code><code class="sb">`</code><code class="sb">query kitchenSink (</code><code class="sb">$</code><code class="sb">id:ID) { </code><a class="co" href="#callout_protocols_CO8-1" id="co_protocols_CO8-1"><img alt="1" src="assets/1.png"/></a><code class="sb">&#13;
  recipe(id: </code><code class="sb">$</code><code class="sb">id) {&#13;
    id name&#13;
    ingredients {&#13;
      name quantity&#13;
    }&#13;
  }&#13;
  pid&#13;
}</code><code class="sb">`</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="nx">server</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code><code> </code><code class="nx">async</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
  </code><code class="kr">const</code><code> </code><code class="nx">req</code><code> </code><code class="o">=</code><code> </code><code class="nx">await</code><code> </code><code class="nx">fetch</code><code class="p">(</code><code class="sb">`</code><code class="sb">http://</code><code class="si">${</code><code class="nx">TARGET</code><code class="si">}</code><code class="sb">/graphql</code><code class="sb">`</code><code class="p">,</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="nx">method</code><code class="o">:</code><code> </code><code class="s1">'POST'</code><code class="p">,</code><code>&#13;
    </code><code class="nx">headers</code><code class="o">:</code><code> </code><code class="p">{</code><code> </code><code class="s1">'Content-Type'</code><code class="o">:</code><code> </code><code class="s1">'application/json'</code><code> </code><code class="p">}</code><code class="p">,</code><code>&#13;
    </code><code class="nx">body</code><code class="o">:</code><code> </code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="p">{</code><code> </code><a class="co" href="#callout_protocols_CO8-2" id="co_protocols_CO8-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
      </code><code class="nx">query</code><code class="o">:</code><code> </code><code class="nx">complex_query</code><code class="p">,</code><code>&#13;
      </code><code class="nx">variables</code><code class="o">:</code><code> </code><code class="p">{</code><code> </code><code class="nx">id</code><code class="o">:</code><code> </code><code class="s2">"42"</code><code> </code><code class="p">}</code><code>&#13;
    </code><code class="p">}</code><code class="p">)</code><code class="p">,</code><code>&#13;
  </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>&#13;
  </code><code class="k">return</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="nx">consumer_pid</code><code class="o">:</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">pid</code><code class="p">,</code><code>&#13;
    </code><code class="nx">producer_data</code><code class="o">:</code><code> </code><code class="nx">await</code><code> </code><code class="nx">req</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="p">)</code><code>&#13;
  </code><code class="p">}</code><code class="p">;</code><code>&#13;
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="nx">server</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">PORT</code><code class="p">,</code><code> </code><code class="nx">HOST</code><code class="p">,</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`</code><code class="sb">Consumer running at http://</code><code class="si">${</code><code class="nx">HOST</code><code class="si">}</code><code class="sb">:</code><code class="si">${</code><code class="nx">PORT</code><code class="si">}</code><code class="sb">/</code><code class="sb">`</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_protocols_CO8-1" id="callout_protocols_CO8-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Here’s a more complex query that accepts arguments.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO8-2" id="callout_protocols_CO8-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The request body is JSON encapsulating the GraphQL query.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This example makes a <code>POST</code> request and sends a JSON payload to the server. This payload contains both the query and the variables. The <code>query</code> property is the GraphQL query string, and the <code>variables</code> property contains a mapping of variable names with their values.</p>&#13;
&#13;
<p>The <code>complex_query</code> being sent is asking for almost every piece of data the server supports. It’s also using a more complex syntax for specifying which variables will be used in the query. In this case it names the query <code>kitchenSink</code>, which can be useful for debugging. The arguments for the query are defined after the name, in this case it’s declared that there’s a variable named <code>$id</code> that is of type ID. That variable is then passed into the <code>recipe()</code> method. The <code>variables</code> property of the request body contains a single variable. In this section the variable doesn’t need to be prefixed with a <code>$</code>.</p>&#13;
&#13;
<p>Once you’ve modified the two files, run both of the services and then make a request to the consumer service by running the following commands:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>node recipe-api/producer-graphql.js <code class="c"># terminal 1</code>&#13;
<code class="nv">$ </code>node web-api/consumer-graphql.js    <code class="c"># terminal 2</code>&#13;
<code class="nv">$ </code>curl http://localhost:3000          <code class="c"># terminal 3</code></pre>&#13;
&#13;
<p>You’ll then receive a reply that looks like this:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"consumer_pid"</code><code class="p">:</code> <code class="mi">20827</code><code class="p">,</code>&#13;
  <code class="nt">"producer_data"</code><code class="p">:</code> <code class="p">{</code>&#13;
    <code class="nt">"data"</code><code class="p">:</code> <code class="p">{</code>&#13;
      <code class="nt">"recipe"</code><code class="p">:</code> <code class="p">{</code>&#13;
        <code class="nt">"id"</code><code class="p">:</code> <code class="s2">"42"</code><code class="p">,</code>&#13;
        <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Chicken Tikka Masala"</code><code class="p">,</code>&#13;
        <code class="nt">"ingredients"</code><code class="p">:</code> <code class="p">[</code>&#13;
          <code class="p">{</code> <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Chicken"</code><code class="p">,</code> <code class="nt">"quantity"</code><code class="p">:</code> <code class="s2">"1 lb"</code> <code class="p">},</code>&#13;
          <code class="p">{</code> <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Sauce"</code><code class="p">,</code> <code class="nt">"quantity"</code><code class="p">:</code> <code class="s2">"2 cups"</code> <code class="p">}</code>&#13;
        <code class="p">]</code>&#13;
      <code class="p">},</code>&#13;
      <code class="nt">"pid"</code><code class="p">:</code> <code class="mi">20842</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>GraphQL offers many more features than those listed in this section. For example, it includes a <a data-primary="GraphQL" data-secondary="mutations" data-type="indexterm" id="idm46291193548952"/><a data-primary="GraphQL" data-secondary="subscription" data-type="indexterm" id="idm46291193476472"/>feature called <em>mutations</em>, which allows a client to modify documents. It also has a feature called <em>subscription</em>, which allows a client to subscribe to and receive a stream of <a data-primary="GraphQL" data-secondary="consumer" data-startref="grql_consume" data-type="indexterm" id="idm46291193474600"/><a data-primary="consumers" data-secondary="GraphQL" data-startref="consume_grql" data-type="indexterm" id="idm46291193473352"/><a data-primary="protocols" data-secondary="GraphQL" data-startref="prot_grql" data-type="indexterm" id="idm46291193472136"/>messages.</p>&#13;
&#13;
<p><a data-type="xref" href="ch03.html#ch_scaling_sec_bm_subsec_protocol_graphql">“GraphQL benchmarks”</a> contains benchmarks on communicating between two servers using GraphQL.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="RPC with gRPC" data-type="sect1"><div class="sect1" id="ch_protocols_sec_grpc">&#13;
<h1>RPC with gRPC</h1>&#13;
&#13;
<p>Patterns like REST—and <a data-primary="RPC (Remote Procedure Call)" data-secondary="gRPC and" data-type="indexterm" id="grpc"/><a data-primary="protocols" data-secondary="RPC with gRPC" data-type="indexterm" id="prot_rpcgrpc"/>to an extent GraphQL—attempt to abstract away the underlying functionality provided by a producer and essentially expose an API driven by data and CRUD operations. Despite all the complexity within the service, the consumer is left with an interface with a lot of nouns and very few verbs.</p>&#13;
&#13;
<p>For example, an API with a RESTful interface might allow a consumer to create an invoice. Such an operation might be performed by using the <code>POST</code> method in combination with a route named <code>/invoice</code>. But how does the producer allow the consumer to send an email to the user when the invoice is created? Should there be a separate endpoint for invoice emails? Should there be a property on an invoice record called <code>email</code> that, when set to true during create time, triggers the email? There often isn’t a perfect way to represent application functionality using the methods provided by HTTP. This is when it might make sense to reach for a new pattern.</p>&#13;
&#13;
<p><em>Remote Procedure Call (RPC)</em> is such a pattern. Unlike HTTP, which offers a very finite list of verbs, RPC is essentially free to support whatever verb the developer desires. If you think about the heart of the application, the aforementioned &#13;
<span class="keep-together"><code>POST /invoice</code></span> route ends up calling some code deeper within the application. There very well could be a correlating method called <code>create_invoice()</code> within the code. With RPC, instead of going through the work to create a different interface, you can expose that method, almost in its raw form, to the network.</p>&#13;
&#13;
<p>In general, RPC works by choosing which functions in the application to expose, and creating a mapping between these functions to some sort of network interface. Of course, it’s not as straightforward as simply exposing the functions to the network. Such methods need to be very rigorous about what type of data they accept and who they accept it from (just like an HTTP endpoint should).</p>&#13;
&#13;
<p>One of the most popular standards for providing networked RPC endpoints between services is Google’s <a class="orm:hideurl" href="https://grpc.io">gRPC</a>. gRPC is typically served over HTTP/2. Unlike GraphQL, which uses a single HTTP endpoint, gRPC uses the endpoint to determine what method to call.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Protocol Buffers" data-type="sect2"><div class="sect2" id="idm46291193457720">&#13;
<h2>Protocol Buffers</h2>&#13;
&#13;
<p>Unlike JSON over HTTP <a data-primary="Protocol Buffers (Protobufs)" data-type="indexterm" id="probuff"/>and GraphQL, gRPC typically doesn’t deliver messages over plain text. Instead, it transfers the data using Protocol Buffers (aka Protobufs), a binary format for representing serialized objects. Such a representation leads to smaller message payloads and increased network performance. Not only does it create more compact messages, but it also reduces the amount of redundant information sent with each message. Regarding the OSI model, Protobufs can be thought of as running on Layer 8, while HTTP/2 runs on Layer 7.</p>&#13;
&#13;
<p>Protobufs have their own language for describing the messages that can be represented in a gRPC server. These files end in <code>.proto</code> and are reminiscent of a GraphQL schema. <a data-type="xref" href="#ex_grpc_proto">Example 2-13</a> demonstrates how a similar operation can be defined for a gRPC service.</p>&#13;
<div data-type="example" id="ex_grpc_proto">&#13;
<h5><span class="label">Example 2-13. </span><em>shared/grpc-recipe.proto</em></h5>&#13;
&#13;
<pre data-type="programlisting">syntax = "proto3";&#13;
package recipe;&#13;
service RecipeService { <a class="co" href="#callout_protocols_CO9-1" id="co_protocols_CO9-1"><img alt="1" src="assets/1.png"/></a>&#13;
  rpc GetRecipe(RecipeRequest) returns (Recipe) {}&#13;
  rpc GetMetaData(Empty) returns (Meta) {}&#13;
}&#13;
message Recipe {&#13;
  int32 id = 1; <a class="co" href="#callout_protocols_CO9-3" id="co_protocols_CO9-2"><img alt="3" src="assets/3.png"/></a>&#13;
  string name = 2;&#13;
  string steps = 3;&#13;
  repeated Ingredient ingredients = 4; <a class="co" href="#callout_protocols_CO9-4" id="co_protocols_CO9-3"><img alt="4" src="assets/4.png"/></a>&#13;
}&#13;
message Ingredient {&#13;
  int32 id = 1;&#13;
  string name = 2;&#13;
  string quantity = 3;&#13;
}&#13;
message RecipeRequest {&#13;
  int32 id = 1;&#13;
}&#13;
message Meta { <a class="co" href="#callout_protocols_CO9-2" id="co_protocols_CO9-4"><img alt="2" src="assets/2.png"/></a>&#13;
  int32 pid = 2;&#13;
}&#13;
message Empty {}</pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_protocols_CO9-1" id="callout_protocols_CO9-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>A definition for a service named <code>RecipeService</code>.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO9-4" id="callout_protocols_CO9-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>A message of type <code>Meta</code>.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO9-2" id="callout_protocols_CO9-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>A field named <code>id</code> that can be a 32-bit integer.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO9-3" id="callout_protocols_CO9-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>An array of <code>Recipe</code> messages in a field named <code>ingredients</code>, the fourth entry for this message.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This <em>recipe.proto</em> file is shared by both clients and servers. This allows both ends to communicate with each other and be able to decode and encode the messages being sent. gRPC defines RPC methods, which can accept a message of a particular type and return a message of another type, as well as services, which are ways to group related method calls.</p>&#13;
&#13;
<p>Notice the granularity of the message types. GraphQL, which was built with JSON and HTTP in mind, specifies numeric types using the value <code>Int</code>, simply an integer. gRPC, with lower-level roots in C, describes an integer more specifically using its size, in this case an <code>int32</code>. There usually isn’t a reason to limit an integer’s size if it’s going to be used in JSON. <a data-type="xref" href="#table_grpc_scalars">Table 2-4</a> has a more detailed list of common gRPC data types.</p>&#13;
<table id="table_grpc_scalars">&#13;
<caption><span class="label">Table 2-4. </span>Common gRPC scalars</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Name</th>&#13;
<th>Examples</th>&#13;
<th>Node/JS equivalent</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>double</code></p></td>&#13;
<td><p>1.1</p></td>&#13;
<td><p><code>Number</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>float</code></p></td>&#13;
<td><p>1.1</p></td>&#13;
<td><p><code>Number</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>int32</code></p></td>&#13;
<td><p>-2_147_483_648</p></td>&#13;
<td><p><code>Number</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>int64</code></p></td>&#13;
<td><p>9_223_372_036_854_775_808</p></td>&#13;
<td><p><code>Number</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>bool</code></p></td>&#13;
<td><p>true, false</p></td>&#13;
<td><p><code>Boolean</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>string</code></p></td>&#13;
<td><p>“Hello, friend!\n”</p></td>&#13;
<td><p><code>String</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>bytes</code></p></td>&#13;
<td><p><em>binary data</em></p></td>&#13;
<td><p><code>Buffer</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>The <code>repeated</code> keyword means <a data-primary="repeated keyword" data-type="indexterm" id="idm46291193393960"/><a data-primary="gRPC" data-secondary="repeated keywords" data-type="indexterm" id="idm46291193393352"/>that a field can contain multiple values. In those situations the values can be represented as an array of that value’s type.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>There are some other number formats that can be represented in gRPC as well. These include <code>uint32</code> and <code>uint64</code>, <code>sint32</code> and <code>sint64</code>, <code>fixed32</code> and <code>fixed64</code>, and finally, <code>sfixed32</code> and <code>sfixed64</code>. Each has different restrictions on the range of the number represented, accuracy, and how the number is represented in transit. The <code>@grpc/proto-loader</code> package can be configured to represent different values using a <code>String</code> in cases where a <code>Number</code> is insufficient.</p>&#13;
</div>&#13;
&#13;
<p>Another interesting part about these message types is the numeric value associated with each field. These values represent the order in which the field follows within the messages. The <code>Ingredient</code> message, for example, has <code>id</code> as the first property and <code>quantity</code> as the third property. It seems weird to list these numbers at first, but the order is very important. Unlike JSON, which doesn’t technically have an order to properties, the order of properties in a Protocol Buffer message is very important for two reasons.</p>&#13;
&#13;
<p>The first reason is that the field names aren’t transmitted with the messages themselves. Since schemas are shared between client and server, the names of the fields would be redundant. As a quick visualization of this, imagine how two integers transmitted using JSON and again using binary might look. The two messages might look like the following:</p>&#13;
&#13;
<pre data-type="programlisting">{"id":123,"code":456}&#13;
01230456</pre>&#13;
&#13;
<p>If two numbers are always sent, and it’s common knowledge that the first is called <code>id</code> and the second is called <code>code</code>, then representing the message like in the second row removes unnecessary redundancies. This is similar to how CSV works: having column names in the first row and data in subsequent rows.</p>&#13;
&#13;
<p>The second <a data-primary="messaging" data-secondary="Protobufs" data-type="indexterm" id="idm46291193381336"/>reason that field order matters is that messages represented using Protobufs, and gRPC itself, are designed to be backwards compatible. As an example, if v1 of the Protobufs <code>Ingredient</code> message contains an <code>id</code>, a <code>name</code>, and a <code>quantity</code> field, and one day a new v2 is created with a fourth <code>substitute</code> field, then any nodes on the network still using v1 can safely ignore the additional fields and still communicate with the other nodes. This is beneficial in situations where a new version of the application is slowly released as the old version is phased out.</p>&#13;
&#13;
<p>gRPC supports four styles <a data-primary="gRPC" data-secondary="messaging" data-type="indexterm" id="idm46291193377496"/><a data-primary="messaging" data-secondary="gRPC" data-type="indexterm" id="idm46291193376648"/><a data-primary="consumers" data-secondary="gRPC" data-type="indexterm" id="messgrpc"/>of messaging, though these examples only look at the most basic style. Message requests and responses can either be streaming or a single message. The basic style used in these examples involves a nonstreaming request and response. However, one can use <em>server-side streaming RPC</em>, where the server streams a response; <em>client-side streaming RPC</em>, where the client streams a request; or <em>bidirectional streaming RPC</em>, where the client and the server stream a request and a response. When working with a stream, an instance of an <code>EventEmitter</code> is provided, but when working with singular messages, code will instead deal <a data-primary="Protocol Buffers (Protobufs)" data-startref="probuff" data-type="indexterm" id="idm46291193372648"/><a data-primary="EventEmitter class" data-type="indexterm" id="idm46291193371800"/>with callbacks.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="gRPC Producer" data-type="sect2"><div class="sect2" id="idm46291193457096">&#13;
<h2>gRPC Producer</h2>&#13;
&#13;
<p>Now that you’ve looked at <a data-primary="gRPC" data-secondary="server, implementing" data-type="indexterm" id="grpc_serv"/><a data-primary="protocols" data-secondary="RPC with gRPC" data-tertiary="gRPC  producer" data-type="indexterm" id="prot_grpc_prod"/>some Protobuf message and service definitions, it’s time to implement a gRPC server using Node.js. Again, you’ll begin by creating a new <em>recipe-api/</em> service. Create a file to resemble <a data-type="xref" href="#ex_grpc_producer">Example 2-14</a>, and be sure to install the necessary dependencies. Dependencies beginning with an <code>@</code> symbol represent scoped packages within the npm registry.</p>&#13;
<div data-type="example" id="ex_grpc_producer">&#13;
<h5><span class="label">Example 2-14. </span><em>recipe-api/producer-grpc.js</em></h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c-Hashbang">#!/usr/bin/env node&#13;
</code><code>&#13;
</code><code class="c1">// npm install @grpc/grpc-js@1.1 @grpc/proto-loader@0.5&#13;
</code><code class="kr">const</code><code> </code><code class="nx">grpc</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'@grpc/grpc-js'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">loader</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'@grpc/proto-loader'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">pkg_def</code><code> </code><code class="o">=</code><code> </code><code class="nx">loader</code><code class="p">.</code><code class="nx">loadSync</code><code class="p">(</code><code class="nx">__dirname</code><code> </code><code class="o">+</code><code>&#13;
  </code><code class="s1">'/../shared/grpc-recipe.proto'</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_protocols_CO10-1" id="co_protocols_CO10-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">recipe</code><code> </code><code class="o">=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">loadPackageDefinition</code><code class="p">(</code><code class="nx">pkg_def</code><code class="p">)</code><code class="p">.</code><code class="nx">recipe</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">HOST</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">HOST</code><code> </code><code class="o">||</code><code> </code><code class="s1">'127.0.0.1'</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">PORT</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code><code> </code><code class="o">||</code><code> </code><code class="mi">4000</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">server</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">Server</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="nx">server</code><code class="p">.</code><code class="nx">addService</code><code class="p">(</code><code class="nx">recipe</code><code class="p">.</code><code class="nx">RecipeService</code><code class="p">.</code><code class="nx">service</code><code class="p">,</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_protocols_CO10-2" id="co_protocols_CO10-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="nx">getMetaData</code><code class="o">:</code><code> </code><code class="p">(</code><code class="nx">_call</code><code class="p">,</code><code> </code><code class="nx">cb</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_protocols_CO10-3" id="co_protocols_CO10-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
    </code><code class="nx">cb</code><code class="p">(</code><code class="kc">null</code><code class="p">,</code><code> </code><code class="p">{</code><code>&#13;
      </code><code class="nx">pid</code><code class="o">:</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">pid</code><code class="p">,</code><code>&#13;
    </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>&#13;
  </code><code class="p">}</code><code class="p">,</code><code>&#13;
  </code><code class="nx">getRecipe</code><code class="o">:</code><code> </code><code class="p">(</code><code class="nx">call</code><code class="p">,</code><code> </code><code class="nx">cb</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code> </code><a class="co" href="#callout_protocols_CO10-4" id="co_protocols_CO10-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
    </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">call</code><code class="p">.</code><code class="nx">request</code><code class="p">.</code><code class="nx">id</code><code> </code><code class="o">!==</code><code> </code><code class="mi">42</code><code class="p">)</code><code> </code><code class="p">{</code><code>&#13;
      </code><code class="k">return</code><code> </code><code class="nx">cb</code><code class="p">(</code><code class="k">new</code><code> </code><code class="nb">Error</code><code class="p">(</code><code class="sb">`</code><code class="sb">unknown recipe </code><code class="si">${</code><code class="nx">call</code><code class="p">.</code><code class="nx">request</code><code class="p">.</code><code class="nx">id</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>&#13;
    </code><code class="p">}</code><code>&#13;
    </code><code class="nx">cb</code><code class="p">(</code><code class="kc">null</code><code class="p">,</code><code> </code><code class="p">{</code><code>&#13;
      </code><code class="nx">id</code><code class="o">:</code><code> </code><code class="mi">42</code><code class="p">,</code><code> </code><code class="nx">name</code><code class="o">:</code><code> </code><code class="s2">"Chicken Tikka Masala"</code><code class="p">,</code><code>&#13;
      </code><code class="nx">steps</code><code class="o">:</code><code> </code><code class="s2">"Throw it in a pot..."</code><code class="p">,</code><code>&#13;
      </code><code class="nx">ingredients</code><code class="o">:</code><code> </code><code class="p">[</code><code>&#13;
        </code><code class="p">{</code><code> </code><code class="nx">id</code><code class="o">:</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="nx">name</code><code class="o">:</code><code> </code><code class="s2">"Chicken"</code><code class="p">,</code><code> </code><code class="nx">quantity</code><code class="o">:</code><code> </code><code class="s2">"1 lb"</code><code class="p">,</code><code> </code><code class="p">}</code><code class="p">,</code><code>&#13;
        </code><code class="p">{</code><code> </code><code class="nx">id</code><code class="o">:</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="nx">name</code><code class="o">:</code><code> </code><code class="s2">"Sauce"</code><code class="p">,</code><code> </code><code class="nx">quantity</code><code class="o">:</code><code> </code><code class="s2">"2 cups"</code><code class="p">,</code><code> </code><code class="p">}</code><code>&#13;
      </code><code class="p">]</code><code>&#13;
    </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>&#13;
  </code><code class="p">}</code><code class="p">,</code><code>&#13;
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="nx">server</code><code class="p">.</code><code class="nx">bindAsync</code><code class="p">(</code><code class="sb">`</code><code class="si">${</code><code class="nx">HOST</code><code class="si">}</code><code class="sb">:</code><code class="si">${</code><code class="nx">PORT</code><code class="si">}</code><code class="sb">`</code><code class="p">,</code><code>&#13;
  </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">ServerCredentials</code><code class="p">.</code><code class="nx">createInsecure</code><code class="p">(</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_protocols_CO10-5" id="co_protocols_CO10-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
  </code><code class="p">(</code><code class="nx">err</code><code class="p">,</code><code> </code><code class="nx">port</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code> </code><code class="k">throw</code><code> </code><code class="nx">err</code><code class="p">;</code><code>&#13;
    </code><code class="nx">server</code><code class="p">.</code><code class="nx">start</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>&#13;
    </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`</code><code class="sb">Producer running at http://</code><code class="si">${</code><code class="nx">HOST</code><code class="si">}</code><code class="sb">:</code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">/</code><code class="sb">`</code><code class="p">)</code><code class="p">;</code><code>&#13;
  </code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_protocols_CO10-1" id="callout_protocols_CO10-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>The producer needs access to the <em>.proto</em> file. In this case it’s loaded and processed when started, incurring a small startup cost.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO10-2" id="callout_protocols_CO10-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>When a service is defined, an object is provided with properties reflecting the methods defined in the <em>.proto</em> file.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO10-3" id="callout_protocols_CO10-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>This method correlates with the <code>GetMetaData(Empty)</code> method in the <em>.proto</em> &#13;
<span class="keep-together">definition.</span></p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO10-4" id="callout_protocols_CO10-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The <code>getRecipe()</code> method makes use of an object passed in during the request. This object is provided as <code>call.request</code>.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO10-5" id="callout_protocols_CO10-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>gRPC can use TLS and authentication, but for this example it’s disabled.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This server listens for incoming HTTP/2 requests sent to localhost via port 4000. The HTTP routes associated with the two methods are based on the name of the service and the name of the methods. This <a data-primary="getMetaData() method" data-type="indexterm" id="idm46291193302424"/><a data-primary="methods" data-secondary="getMetaData()" data-type="indexterm" id="idm46291193301752"/>means the <code>getMetaData()</code> method technically lives at the following URL:</p>&#13;
&#13;
<pre data-type="programlisting">http://localhost:4000/recipe.RecipeService/GetMetaData</pre>&#13;
&#13;
<p>The gRPC package abstracts the underlying HTTP/2 layer, so you typically don’t need to think of a gRPC service <a data-primary="gRPC" data-secondary="server, implementing" data-startref="grpc_serv" data-type="indexterm" id="idm46291193299032"/><a data-primary="protocols" data-secondary="RPC with gRPC" data-startref="prot_grpc_prod" data-tertiary="gRPC  producer" data-type="indexterm" id="idm46291193153752"/>as being over HTTP/2, nor do you have to think about the paths.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="gRPC Consumer" data-type="sect2"><div class="sect2" id="idm46291193152008">&#13;
<h2>gRPC Consumer</h2>&#13;
&#13;
<p>Now it’s time to <a data-primary="gRPC" data-secondary="consumer, implementing" data-type="indexterm" id="grpc_consum"/><a data-primary="protocols" data-secondary="RPC with gRPC" data-tertiary="gRPC consumer" data-type="indexterm" id="prot_grpc__con"/>implement the consumer. <a data-type="xref" href="#ex_grpc_consumer">Example 2-15</a> is a reworked version of the <em>web-api</em> service. At the time of writing, the official <code>@grpc/grpc-js</code> npm package works by exposing methods that use callbacks. This code example uses <code>util.promisify()</code> so that you can call the methods using async functions.</p>&#13;
<div data-type="example" id="ex_grpc_consumer">&#13;
<h5><span class="label">Example 2-15. </span><em>web-api/consumer-grpc.js</em></h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c-Hashbang">#!/usr/bin/env node&#13;
</code><code>&#13;
</code><code class="c1">// npm install @grpc/grpc-js@1.1 @grpc/proto-loader@0.5 fastify@3.2&#13;
</code><code class="kr">const</code><code> </code><code class="nx">util</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'util'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">grpc</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'@grpc/grpc-js'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">server</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'fastify'</code><code class="p">)</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">loader</code><code> </code><code class="o">=</code><code> </code><code class="nx">require</code><code class="p">(</code><code class="s1">'@grpc/proto-loader'</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">pkg_def</code><code> </code><code class="o">=</code><code> </code><code class="nx">loader</code><code class="p">.</code><code class="nx">loadSync</code><code class="p">(</code><code class="nx">__dirname</code><code> </code><code class="o">+</code><code>&#13;
  </code><code class="s1">'/../shared/grpc-recipe.proto'</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" href="#callout_protocols_CO11-1" id="co_protocols_CO11-1"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">recipe</code><code> </code><code class="o">=</code><code> </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">loadPackageDefinition</code><code class="p">(</code><code class="nx">pkg_def</code><code class="p">)</code><code class="p">.</code><code class="nx">recipe</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">HOST</code><code> </code><code class="o">=</code><code> </code><code class="s1">'127.0.0.1'</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">PORT</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code><code> </code><code class="o">||</code><code> </code><code class="mi">3000</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">TARGET</code><code> </code><code class="o">=</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">TARGET</code><code> </code><code class="o">||</code><code> </code><code class="s1">'localhost:4000'</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="kr">const</code><code> </code><code class="nx">client</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">recipe</code><code class="p">.</code><code class="nx">RecipeService</code><code class="p">(</code><code> </code><a class="co" href="#callout_protocols_CO11-2" id="co_protocols_CO11-2"><img alt="2" src="assets/2.png"/></a><code>&#13;
  </code><code class="nx">TARGET</code><code class="p">,</code><code>&#13;
  </code><code class="nx">grpc</code><code class="p">.</code><code class="nx">credentials</code><code class="p">.</code><code class="nx">createInsecure</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" href="#callout_protocols_CO11-3" id="co_protocols_CO11-3"><img alt="3" src="assets/3.png"/></a><code>&#13;
</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">getMetaData</code><code> </code><code class="o">=</code><code> </code><code class="nx">util</code><code class="p">.</code><code class="nx">promisify</code><code class="p">(</code><code class="nx">client</code><code class="p">.</code><code class="nx">getMetaData</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="nx">client</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="kr">const</code><code> </code><code class="nx">getRecipe</code><code> </code><code class="o">=</code><code> </code><code class="nx">util</code><code class="p">.</code><code class="nx">promisify</code><code class="p">(</code><code class="nx">client</code><code class="p">.</code><code class="nx">getRecipe</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="nx">client</code><code class="p">)</code><code class="p">)</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="nx">server</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code><code> </code><code class="nx">async</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
  </code><code class="kr">const</code><code> </code><code class="p">[</code><code class="nx">meta</code><code class="p">,</code><code> </code><code class="nx">recipe</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="nx">await</code><code> </code><code class="nb">Promise</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="p">[</code><code>&#13;
    </code><code class="nx">getMetaData</code><code class="p">(</code><code class="p">{</code><code class="p">}</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_protocols_CO11-4" id="co_protocols_CO11-4"><img alt="4" src="assets/4.png"/></a><code>&#13;
    </code><code class="nx">getRecipe</code><code class="p">(</code><code class="p">{</code><code class="nx">id</code><code class="o">:</code><code> </code><code class="mi">42</code><code class="p">}</code><code class="p">)</code><code class="p">,</code><code> </code><a class="co" href="#callout_protocols_CO11-5" id="co_protocols_CO11-5"><img alt="5" src="assets/5.png"/></a><code>&#13;
  </code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code>&#13;
&#13;
  </code><code class="k">return</code><code> </code><code class="p">{</code><code>&#13;
    </code><code class="nx">consumer_pid</code><code class="o">:</code><code> </code><code class="nx">process</code><code class="p">.</code><code class="nx">pid</code><code class="p">,</code><code>&#13;
    </code><code class="nx">producer_data</code><code class="o">:</code><code> </code><code class="nx">meta</code><code class="p">,</code><code>&#13;
    </code><code class="nx">recipe</code><code>&#13;
  </code><code class="p">}</code><code class="p">;</code><code>&#13;
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code>&#13;
&#13;
</code><code class="nx">server</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">PORT</code><code class="p">,</code><code> </code><code class="nx">HOST</code><code class="p">,</code><code> </code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">=&gt;</code><code> </code><code class="p">{</code><code>&#13;
  </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`</code><code class="sb">Consumer running at http://</code><code class="si">${</code><code class="nx">HOST</code><code class="si">}</code><code class="sb">:</code><code class="si">${</code><code class="nx">PORT</code><code class="si">}</code><code class="sb">/</code><code class="sb">`</code><code class="p">)</code><code class="p">;</code><code>&#13;
</code><code class="p">}</code><code class="p">)</code><code class="p">;</code></pre>&#13;
<dl class="calloutlist">&#13;
<dt><a class="co" href="#co_protocols_CO11-1" id="callout_protocols_CO11-1"><img alt="1" src="assets/1.png"/></a></dt>&#13;
<dd><p>Just like with the producer service, this one loads the <em>.proto</em> definitions at startup.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO11-2" id="callout_protocols_CO11-2"><img alt="2" src="assets/2.png"/></a></dt>&#13;
<dd><p>The gRPC client is aware that it is connecting to a <code>recipe.RecipeService</code> &#13;
<span class="keep-together">service.</span></p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO11-3" id="callout_protocols_CO11-3"><img alt="3" src="assets/3.png"/></a></dt>&#13;
<dd><p>Also like the producer, security has been disabled.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO11-4" id="callout_protocols_CO11-4"><img alt="4" src="assets/4.png"/></a></dt>&#13;
<dd><p>The <code>GetMetaData()</code> call makes use of an <code>Empty</code> message, which contains no properties.</p></dd>&#13;
<dt><a class="co" href="#co_protocols_CO11-5" id="callout_protocols_CO11-5"><img alt="5" src="assets/5.png"/></a></dt>&#13;
<dd><p>The <code>GetRecipe()</code> call, however, expects a <code>RecipeRequest</code> message. Here, an object adhering to the same shape is passed in.</p></dd>&#13;
</dl></div>&#13;
&#13;
<p>This example sends two requests between the <em>web-api</em> and <em>recipe-api</em> services, whereas the previous GraphQL and JSON over HTTP examples made a single request. All the required information could have been retrieved in a single request, but I feel this example helps convey the heart of the RPC pattern where individual methods are called on a remote server.</p>&#13;
&#13;
<p>Note that the <code>@grpc/grpc-js</code> package was able to look at your <code>.proto</code> file and give you an object with methods on it correlating to methods in the service. In this case the client has a method called <code>getMetaData()</code>. This drives the feeling that RPC intends to convey, that code on one service is remotely calling methods on another service, as if the methods existed locally.</p>&#13;
&#13;
<p>Now that you’ve got the two services defined, go ahead and run both of them and make a request by running the following commands:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="nv">$ </code>node recipe-api/producer-grpc.js <code class="c"># terminal 1</code>&#13;
<code class="nv">$ </code>node web-api/consumer-grpc.js    <code class="c"># terminal 2</code>&#13;
<code class="nv">$ </code>curl http://localhost:3000/      <code class="c"># terminal 3</code></pre>&#13;
&#13;
<p>The response to this request should resemble the following JSON payload:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nt">"consumer_pid"</code><code class="p">:</code> <code class="mi">23786</code><code class="p">,</code>&#13;
  <code class="nt">"producer_data"</code><code class="p">:</code> <code class="p">{</code> <code class="nt">"pid"</code><code class="p">:</code> <code class="mi">23766</code> <code class="p">},</code>&#13;
  <code class="nt">"recipe"</code><code class="p">:</code> <code class="p">{</code>&#13;
    <code class="nt">"id"</code><code class="p">:</code> <code class="mi">42</code><code class="p">,</code> <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Chicken Tikka Masala"</code><code class="p">,</code>&#13;
    <code class="nt">"steps"</code><code class="p">:</code> <code class="s2">"Throw it in a pot..."</code><code class="p">,</code>&#13;
    <code class="nt">"ingredients"</code><code class="p">:</code> <code class="p">[</code>&#13;
      <code class="p">{</code> <code class="nt">"id"</code><code class="p">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Chicken"</code><code class="p">,</code> <code class="nt">"quantity"</code><code class="p">:</code> <code class="s2">"1 lb"</code> <code class="p">},</code>&#13;
      <code class="p">{</code> <code class="nt">"id"</code><code class="p">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nt">"name"</code><code class="p">:</code> <code class="s2">"Sauce"</code><code class="p">,</code> <code class="nt">"quantity"</code><code class="p">:</code> <code class="s2">"2 cups"</code> <code class="p">}</code>&#13;
    <code class="p">]</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The consumer service has combined the result of the two gRPC methods together, but they’re still visible in the resulting document. The <code>recipe</code> property correlates to the <code>Recipe</code> message definition in the <em>.proto</em> file. Notice how it contains a property called <code>ingredients</code>, which is an array of <code>Recipe</code> <a data-primary="gRPC" data-secondary="consumer, implementing" data-startref="grpc_consum" data-type="indexterm" id="idm46291192469864"/><a data-primary="consumers" data-secondary="gRPC" data-startref="messgrpc" data-type="indexterm" id="idm46291192468584"/>instances.</p>&#13;
&#13;
<p><a data-type="xref" href="ch03.html#ch_scaling_sec_bm_subsec_protocol_grpc">“gRPC benchmarks”</a> contains benchmarks on communicating between two servers using gRPC.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46291192466152">&#13;
<h5>Alternatives to Protobufs and gRPC</h5>&#13;
<p>This section technically examined two pieces of technology. The first one is Protocol Buffers, which is a binary serialization format for objects, and the second is gRPC, a platform-agnostic implementation of the RPC pattern.</p>&#13;
&#13;
<p>There are a couple of notable alternatives to Protobufs. One of them is a format called <a class="orm:hideurl" href="https://msgpack.org">MessagePack</a>. MessagePack is a binary representation of hierarchical object data and is technically more of an alternative to JSON since it also includes field names in its message payloads—MessagePack doesn’t have a separate file to describe a schema like Protobufs do. If an API already uses JSON, adopting MessagePack would be easier than adopting gRPC since no schemas need to be shared ahead of time.</p>&#13;
&#13;
<p>A closer alternative to gRPC and Protobufs is <a class="orm:hideurl" href="https://thrift.apache.org/">Apache Thrift</a>. Thrift is also a binary representation of messages and uses a separate file to define schemas and RPC-style method calls. It’s worth mentioning that gRPC is a bit more popular than Thrift.</p>&#13;
&#13;
<p><a class="orm:hideurl" href="https://jsonrpc.org">JSON RPC</a> is another platform-agnostic RPC implementation. As the name implies, it doesn’t use a binary encoding. Instead, payloads and method calls are entirely represented using JSON. It provides mechanisms for associating request and response messages when sent asynchronously over protocols like TCP, where the concept of a paired request <a data-primary="protocols" data-secondary="RPC with gRPC" data-startref="prot_grpc_con" data-tertiary="gRPC consumer" data-type="indexterm" id="idm46291192459352"/>and response is difficult to maintain.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm46291204847576"><sup><a href="ch02.html#idm46291204847576-marker">1</a></sup> These code examples take many shortcuts to remain terse. For example, always favor <code>path.join()</code> over manual string concatenation when generating paths.</p></div></div></section></body></html>