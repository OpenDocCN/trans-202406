<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. JavaScript Design Patterns"><div class="chapter" id="javascript-design-patterns">
<h1><span class="label">Chapter 7. </span>JavaScript Design Patterns</h1>


<p>The previous chapter provided examples of the three different categories of design patterns. Some of these design patterns are relevant or required in the web development context. I have identified a few timeless patterns that can be helpful when applied in JavaScript. This chapter explores JavaScript implementations of different classic and modern design patterns. Every section is dedicated to one of the three 
<span class="keep-together">categories—creational,</span> structural, and behavioral. Let us begin with creational 
<span class="keep-together">patterns.</span></p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45017716417712">
<h1>Choosing a Pattern</h1>
<p>Developers commonly wonder whether<a data-type="indexterm" data-primary="patterns" data-secondary="choosing a pattern" id="idm45017716416336"/><a data-type="indexterm" data-primary="design patterns" data-secondary="choosing a pattern" id="idm45017716415360"/> there is an ideal pattern or set of patterns they should use in their workflow. There isn’t a single correct answer to this question; each script and web application we work on will likely have distinct individual needs. We must consider whether a pattern can offer real value to an implementation.</p>

<p>For example, some projects may benefit from the decoupling benefits offered by the Observer pattern (which reduces how dependent parts of an application are on one another). At the same time, others may be too small for decoupling to be a concern.</p>

<p>That said, once we have a firm grasp of design patterns and the specific problems they are best suited to, it becomes much easier to integrate them into our application architectures.</p>
</div></aside>






<section data-type="sect1" data-pdf-bookmark="Creational Patterns"><div class="sect1" id="javascript-design-patterns-creational">
<h1>Creational Patterns</h1>

<p>Creational patterns provide mechanisms to create objects. We will cover the following <a data-type="indexterm" data-primary="categories of design patterns" data-secondary="creational design patterns" data-tertiary="about" id="idm45017716411568"/><a data-type="indexterm" data-primary="creational design patterns" data-secondary="about" id="idm45017716410288"/>patterns:</p>

<ul class="less_space pagebreak-before">
<li>
<p><a data-type="xref" href="#the-constructor-pattern">“The Constructor Pattern”</a></p>
</li>
<li>
<p><a data-type="xref" href="#the-module-pattern">“The Module Pattern”</a></p>
</li>
<li>
<p><a data-type="xref" href="#the-revealing-module-pattern">“The Revealing Module Pattern”</a></p>
</li>
<li>
<p><a data-type="xref" href="#the-singleton-pattern">“The Singleton Pattern”</a></p>
</li>
<li>
<p><a data-type="xref" href="#the-prototype-pattern">“The Prototype Pattern”</a></p>
</li>
<li>
<p><a data-type="xref" href="#the-factory-pattern">“The Factory Pattern”</a></p>
</li>
</ul>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Constructor Pattern"><div class="sect1" id="the-constructor-pattern">
<h1>The Constructor Pattern</h1>

<p>A constructor is a special method<a data-type="indexterm" data-primary="Constructor pattern" data-secondary="about constructors" id="idm45017716397712"/><a data-type="indexterm" data-primary="Constructor pattern" data-secondary="about" id="idm45017716396736"/><a data-type="indexterm" data-primary="creational design patterns" data-secondary="Constructor pattern" id="ch07-cons"/><a data-type="indexterm" data-primary="Constructor pattern" id="ch07-cons2"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="creational design patterns" data-tertiary="Constructor pattern" id="ch07-cons3"/><a data-type="indexterm" data-primary="classes" data-secondary="Constructor pattern" id="ch07-cons4"/><a data-type="indexterm" data-primary="objects" data-secondary="Constructor pattern" id="ch07-cons5"/> used to initialize a newly created object once the memory has been allocated for it. With ES2015+, the syntax for creating <a href="https://oreil.ly/TjEI1">classes</a> with constructors was introduced to JavaScript. This enables the creation of objects as an instance of a class using the default <a href="https://oreil.ly/zNmUI">constructor</a>.</p>

<p>In JavaScript, almost everything is an object, and classes are syntactic sugar for JavaScript’s prototypal approach to inheritance. With classic JavaScript, we were most often interested in object constructors. <a data-type="xref" href="#constructor_pattern">Figure 7-1</a> illustrates the pattern.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Object constructors are used<a data-type="indexterm" data-primary="objects" data-secondary="Constructor pattern" data-tertiary="about object constructors" id="idm45017717593344"/> to create specific types of objects—both preparing the object for use and accepting arguments to set the values of member properties and methods when the object is first created.</p>
</div>

<figure><div id="constructor_pattern" class="figure">
<img src="Images/ljd2_0701.png" alt="ljd2 0701" width="737" height="263"/>
<h6><span class="label">Figure 7-1. </span>Constructor pattern</h6>
</div></figure>








<section data-type="sect2" data-pdf-bookmark="Object Creation"><div class="sect2" id="object-creation">
<h2>Object Creation</h2>

<p>The three common ways to create new objects in JavaScript are as follows:<a data-type="indexterm" data-primary="objects" data-secondary="Constructor pattern" data-tertiary="object creation" id="ch07-obco"/><a data-type="indexterm" data-primary="Constructor pattern" data-secondary="object creation" id="ch07-obco2"/><a data-type="indexterm" data-primary="Object constructor" id="ch07-obco3"/><a data-type="indexterm" data-primary="Object constructor" data-secondary="const newObject" id="idm45017717584160"/><a data-type="indexterm" data-primary="new keyword" data-secondary="object creation" id="idm45017717583216"/><a data-type="indexterm" data-primary="Object constructor" data-secondary="Object.create" data-tertiary="prototypal inheritance requiring" id="idm45017717582272"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Each of the following options will create a new empty object</code>
<code class="kr">const</code> <code class="nx">newObject</code> <code class="o">=</code> <code class="p">{};</code>

<code class="c1">// or</code>
<code class="kr">const</code> <code class="nx">newObject</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nb">Object</code><code class="p">.</code><code class="nx">prototype</code><code class="p">);</code>

<code class="c1">// or</code>
<code class="kr">const</code> <code class="nx">newObject</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">Object</code><code class="p">();</code></pre>

<p>Here, we have declared each object as a constant, which creates a read-only block-scoped variable.
In the final example, the <code>Object</code> constructor creates an object wrapper for a specific value, or where no value is passed, it creates an empty object and returns it.</p>

<p>You can now assign keys and values to an object in the following ways:<a data-type="indexterm" data-primary="Object constructor" data-secondary="assigning keys and values" id="idm45017717530176"/><a data-type="indexterm" data-primary="Object constructor" data-secondary="Object.defineProperty" id="idm45017717529328"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// ECMAScript 3 compatible approaches</code>

<code class="c1">// 1. Dot syntax</code>

<code class="c1">// Set properties</code>
<code class="nx">newObject</code><code class="p">.</code><code class="nx">someKey</code> <code class="o">=</code> <code class="s2">"Hello World"</code><code class="p">;</code>

<code class="c1">// Get properties</code>
<code class="kd">var</code> <code class="nx">key</code> <code class="o">=</code> <code class="nx">newObject</code><code class="p">.</code><code class="nx">someKey</code><code class="p">;</code>



<code class="c1">// 2. Square bracket syntax</code>

<code class="c1">// Set properties</code>
<code class="nx">newObject</code><code class="p">[</code><code class="s2">"someKey"</code><code class="p">]</code> <code class="o">=</code> <code class="s2">"Hello World"</code><code class="p">;</code>

<code class="c1">// Get properties</code>
<code class="kd">var</code> <code class="nx">key</code> <code class="o">=</code> <code class="nx">newObject</code><code class="p">[</code><code class="s2">"someKey"</code><code class="p">];</code>



<code class="c1">// ECMAScript 5 only compatible approaches</code>
<code class="c1">// For more information see: http://kangax.github.com/es5-compat-table/</code>

<code class="c1">// 3. Object.defineProperty</code>

<code class="c1">// Set properties</code>
<code class="nb">Object</code><code class="p">.</code><code class="nx">defineProperty</code><code class="p">(</code> <code class="nx">newObject</code><code class="p">,</code> <code class="s2">"someKey"</code><code class="p">,</code> <code class="p">{</code>
    <code class="nx">value</code><code class="o">:</code> <code class="s2">"for more control of the property's behavior"</code><code class="p">,</code>
    <code class="nx">writable</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="nx">enumerable</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="nx">configurable</code><code class="o">:</code> <code class="kc">true</code>
<code class="p">});</code>

<code class="c1">// 4. If this feels a little difficult to read, a short-hand could</code>
<code class="c1">// be written as follows:</code>

<code class="kd">var</code> <code class="nx">defineProp</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code> <code class="nx">obj</code><code class="p">,</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">value</code> <code class="p">){</code>
  <code class="nx">config</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="nx">value</code><code class="p">;</code>
  <code class="nb">Object</code><code class="p">.</code><code class="nx">defineProperty</code><code class="p">(</code> <code class="nx">obj</code><code class="p">,</code> <code class="nx">key</code><code class="p">,</code> <code class="nx">config</code> <code class="p">);</code>
<code class="p">};</code>

<code class="c1">// To use, we then create a new empty "person" object</code>
<code class="kd">var</code> <code class="nx">person</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code> <code class="kc">null</code> <code class="p">);</code>

<code class="c1">// Populate the object with properties</code>
<code class="nx">defineProp</code><code class="p">(</code> <code class="nx">person</code><code class="p">,</code> <code class="s2">"car"</code><code class="p">,</code>  <code class="s2">"Delorean"</code> <code class="p">);</code>
<code class="nx">defineProp</code><code class="p">(</code> <code class="nx">person</code><code class="p">,</code> <code class="s2">"dateOfBirth"</code><code class="p">,</code> <code class="s2">"1981"</code> <code class="p">);</code>
<code class="nx">defineProp</code><code class="p">(</code> <code class="nx">person</code><code class="p">,</code> <code class="s2">"hasBeard"</code><code class="p">,</code> <code class="kc">false</code> <code class="p">);</code>


<code class="c1">// 5. Object.defineProperties</code>

<code class="c1">// Set properties</code>
<code class="nb">Object</code><code class="p">.</code><code class="nx">defineProperties</code><code class="p">(</code> <code class="nx">newObject</code><code class="p">,</code> <code class="p">{</code>

  <code class="s2">"someKey"</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">value</code><code class="o">:</code> <code class="s2">"Hello World"</code><code class="p">,</code>
    <code class="nx">writable</code><code class="o">:</code> <code class="kc">true</code>
  <code class="p">},</code>

  <code class="s2">"anotherKey"</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">value</code><code class="o">:</code> <code class="s2">"Foo bar"</code><code class="p">,</code>
    <code class="nx">writable</code><code class="o">:</code> <code class="kc">false</code>
  <code class="p">}</code>

<code class="p">});</code>

<code class="c1">// Getting properties for 3. and 4. can be done using any of the</code>
<code class="c1">// options in 1. and 2.</code></pre>

<p>You can even use these methods for inheritance  as follows:<a data-type="indexterm" data-startref="ch07-obco" id="idm45017716653984"/><a data-type="indexterm" data-startref="ch07-obco2" id="idm45017716653376"/><a data-type="indexterm" data-startref="ch07-obco3" id="idm45017716652768"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// ES2015+ keywords/syntax used: const</code>
<code class="c1">// Usage:</code>

<code class="c1">// Create a race car driver that inherits from the person object</code>
<code class="kr">const</code> <code class="nx">driver</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">person</code><code class="p">);</code>

<code class="c1">// Set some properties for the driver</code>
<code class="nx">defineProp</code><code class="p">(</code><code class="nx">driver</code><code class="p">,</code> <code class="s1">'topSpeed'</code><code class="p">,</code> <code class="s1">'100mph'</code><code class="p">);</code>

<code class="c1">// Get an inherited property (1981)</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">driver</code><code class="p">.</code><code class="nx">dateOfBirth</code><code class="p">);</code>

<code class="c1">// Get the property we set (100mph)</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">driver</code><code class="p">.</code><code class="nx">topSpeed</code><code class="p">);</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Basic Constructors"><div class="sect2" id="basic-constructors">
<h2>Basic Constructors</h2>

<p>As discussed earlier in <a data-type="xref" href="ch05.xhtml#modern-javascript-syntax">Chapter 5</a>, <a data-type="indexterm" data-primary="Constructor pattern" data-secondary="class constructors" data-tertiary="basic constructors" id="idm45017716597520"/><a data-type="indexterm" data-primary="classes" data-secondary="Constructor pattern" data-tertiary="basic class constructors" id="idm45017716596272"/><a data-type="indexterm" data-primary="classes" data-secondary="about" data-tertiary="encapsulation and inheritance via" id="idm45017716595088"/><a data-type="indexterm" data-primary="constructor() method" data-secondary="basic constructors" id="idm45017716593904"/><a data-type="indexterm" data-primary="class keyword" data-secondary="basic constructors" id="idm45017716592960"/><a data-type="indexterm" data-primary="objects" data-secondary="Constructor pattern" data-tertiary="basic class constructors" id="idm45017716592016"/><a data-type="indexterm" data-primary="inheritance" data-secondary="classes for" id="idm45017716590832"/>JavaScript classes were introduced in ES2015, allowing us to define templates for JavaScript objects and implement encapsulation and <a href="https://oreil.ly/VjSbn">inheritance</a> using JavaScript.</p>

<p class="less_space pagebreak-before">To recap, classes must include and<a data-type="indexterm" data-primary="constructor() method" data-secondary="defining a class" id="idm45017716588304"/><a data-type="indexterm" data-primary="this keyword" data-secondary="inside a basic constructor" id="idm45017715545824"/><a data-type="indexterm" data-primary="new keyword" data-secondary="defining a class" data-tertiary="basic constructors" id="idm45017715544816"/> declare a method named <code>constructor()</code>, which will be used to instantiate a new object. The keyword <code>new</code> allows us to call the constructor. The keyword <code>this</code> inside a constructor references the new object created. The following example shows a basic constructor:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">Car</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">model</code><code class="p">,</code> <code class="nx">year</code><code class="p">,</code> <code class="nx">miles</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">model</code> <code class="o">=</code> <code class="nx">model</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">year</code> <code class="o">=</code> <code class="nx">year</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">miles</code> <code class="o">=</code> <code class="nx">miles</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">toString</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="sb">`</code><code class="si">${</code><code class="k">this</code><code class="p">.</code><code class="nx">model</code><code class="si">}</code><code class="sb"> has done </code><code class="si">${</code><code class="k">this</code><code class="p">.</code><code class="nx">miles</code><code class="si">}</code><code class="sb"> miles`</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Usage:</code>

<code class="c1">// We can create new instances of the car</code>
<code class="kd">let</code> <code class="nx">civic</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Car</code><code class="p">(</code><code class="s1">'Honda Civic'</code><code class="p">,</code> <code class="mi">2009</code><code class="p">,</code> <code class="mi">20000</code><code class="p">);</code>
<code class="kd">let</code> <code class="nx">mondeo</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Car</code><code class="p">(</code><code class="s1">'Ford Mondeo'</code><code class="p">,</code> <code class="mi">2010</code><code class="p">,</code> <code class="mi">5000</code><code class="p">);</code>

<code class="c1">// and then open our browser console to view the output of</code>
<code class="c1">// the toString() method being called on these objects</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">civic</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">mondeo</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code></pre>

<p>This is a simple version of the Constructor pattern but it suffers from some problems. One is that it makes inheritance difficult, and the other is that functions such as <code>toString()</code> are redefined for each new object created using the <code>Car</code> constructor. This isn’t optimal because all of the instances of the <code>Car</code> type should ideally share the same function.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Constructors with Prototypes"><div class="sect2" id="constructors-with-prototypes">
<h2>Constructors with Prototypes</h2>

<p>Prototypes in JavaScript allow you to easily<a data-type="indexterm" data-primary="prototypes in constructors" id="idm45017715484400"/><a data-type="indexterm" data-primary="constructor() method" data-secondary="constructors with prototypes" id="idm45017715483728"/><a data-type="indexterm" data-primary="Constructor pattern" data-secondary="class constructors" data-tertiary="constructors with prototypes" id="idm45017715482816"/><a data-type="indexterm" data-primary="this keyword" data-secondary="inside a constructor with prototypes" id="idm45017715481632"/><a data-type="indexterm" data-primary="class keyword" data-secondary="constructors with prototypes" id="idm45017715480720"/><a data-type="indexterm" data-primary="classes" data-secondary="Constructor pattern" data-tertiary="constructors with prototypes" id="idm45017715479808"/><a data-type="indexterm" data-primary="objects" data-secondary="Constructor pattern" data-tertiary="constructors with prototypes" id="idm45017715478624"/> define methods for all instances of a particular object, be it a function or a class. When we call a JavaScript constructor to create an object, all the properties of the constructor’s prototype are then made available to the new object. In this fashion, you can have multiple <code>Car</code> objects that access the same prototype. We can thus extend the original example as follows:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">Car</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">model</code><code class="p">,</code> <code class="nx">year</code><code class="p">,</code> <code class="nx">miles</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">model</code> <code class="o">=</code> <code class="nx">model</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">year</code> <code class="o">=</code> <code class="nx">year</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">miles</code> <code class="o">=</code> <code class="nx">miles</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Note here that we are using Object.prototype.newMethod rather than</code>
<code class="c1">// Object.prototype to avoid redefining the prototype object</code>
<code class="c1">// We still could use Object.prototype for adding new methods,</code>
<code class="c1">// because internally we use the same structure</code>

<code class="nx">Car</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">toString</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="sb">`</code><code class="si">${</code><code class="k">this</code><code class="p">.</code><code class="nx">model</code><code class="si">}</code><code class="sb"> has done </code><code class="si">${</code><code class="k">this</code><code class="p">.</code><code class="nx">miles</code><code class="si">}</code><code class="sb"> miles`</code><code class="p">;</code>
<code class="p">};</code>

<code class="c1">// Usage:</code>
<code class="kd">let</code> <code class="nx">civic</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Car</code><code class="p">(</code><code class="s1">'Honda Civic'</code><code class="p">,</code> <code class="mi">2009</code><code class="p">,</code> <code class="mi">20000</code><code class="p">);</code>
<code class="kd">let</code> <code class="nx">mondeo</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Car</code><code class="p">(</code><code class="s1">'Ford Mondeo'</code><code class="p">,</code> <code class="mi">2010</code><code class="p">,</code> <code class="mi">5000</code><code class="p">);</code>

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">civic</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">mondeo</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code></pre>

<p>All <code>Car</code> objects will now share a single instance of the <code>toString()</code> method.<a data-type="indexterm" data-startref="ch07-cons" id="idm45017718052800"/><a data-type="indexterm" data-startref="ch07-cons2" id="idm45017718014000"/><a data-type="indexterm" data-startref="ch07-cons3" id="idm45017718013328"/><a data-type="indexterm" data-startref="ch07-cons4" id="idm45017718012656"/><a data-type="indexterm" data-startref="ch07-cons5" id="idm45017718011984"/></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Module Pattern"><div class="sect1" id="the-module-pattern">
<h1>The Module Pattern</h1>

<p>Modules are an integral piece<a data-type="indexterm" data-primary="creational design patterns" data-secondary="Module pattern" id="ch07-mod"/><a data-type="indexterm" data-primary="Module pattern" id="ch07-mod2"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="creational design patterns" data-tertiary="Module pattern" id="ch07-mod3"/><a data-type="indexterm" data-primary="classes" data-secondary="Module pattern" id="ch07-mod4"/><a data-type="indexterm" data-primary="Module pattern" data-secondary="about" id="idm45017718004416"/><a data-type="indexterm" data-primary="modules" data-secondary="advantages of using" id="idm45017718003472"/> of any robust application’s architecture and typically help keep the units of code for a project cleanly separated and organized.</p>

<p>Classic JavaScript had several options for implementing modules, such as:</p>

<ul>
<li>
<p>Object literal notation</p>
</li>
<li>
<p>The Module pattern</p>
</li>
<li>
<p>AMD modules</p>
</li>
<li>
<p>CommonJS modules</p>
</li>
</ul>

<p>We have already discussed modern JavaScript modules (also known as “ES modules” or “ECMAScript modules”) in <a data-type="xref" href="ch05.xhtml#modern-javascript-syntax">Chapter 5</a>. We will primarily use ES modules for the examples in this section.</p>

<p>Before ES2015, CommonJS modules or AMD modules were popular alternatives because they allowed you to export the contents of a module. We will be exploring AMD, CommonJS, and UMD modules later in the book in <a data-type="xref" href="ch10.xhtml#modern-modular-javascript-design-patterns">Chapter 10</a>. First, let us understand the Module pattern and its origins.</p>

<p>The Module pattern is based partly on object literals, so it makes sense to refresh our knowledge of them first.</p>








<section data-type="sect2" data-pdf-bookmark="Object Literals"><div class="sect2" id="idm45017714555104">
<h2>Object Literals</h2>

<p>In object literal notation, an object<a data-type="indexterm" data-primary="Module pattern" data-secondary="object literals" id="ch-7-oblit"/><a data-type="indexterm" data-primary="object literal notation module pattern" id="ch-7-oblit2"/><a data-type="indexterm" data-primary="objects" data-secondary="object literals" id="ch-7-oblit3"/><a data-type="indexterm" data-primary="{ } (curly braces) in object literal notation" id="idm45017714550160"/><a data-type="indexterm" data-primary="curly braces ({ }) in object literal notation" id="idm45017714549520"/> is described as a set of comma-separated name/value pairs enclosed in curly braces (<code>{}</code>). Names inside the object may be either strings or identifiers followed by a colon. It would be best if you did not use a comma after the final name/value pair in the object, as this may result in errors:<a data-type="indexterm" data-primary="object literal notation module pattern" data-secondary="const myObjectLiteral" id="idm45017714548368"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">myObjectLiteral</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">variableKey</code><code class="o">:</code> <code class="nx">variableValue</code><code class="p">,</code>
    <code class="nx">functionKey</code><code class="p">()</code> <code class="p">{</code>
        <code class="c1">// ...</code>
    <code class="p">}</code>
<code class="p">};</code></pre>

<p>Object literals don’t require instantiation using the <code>new</code> operator but shouldn’t be used at the start of a statement because the opening <code>{</code> may be interpreted as the beginning of a new block. Outside of an object, new members may be added to it using the assignment as follows <code>myModule.property = "someValue";</code>.</p>

<p>Here is a complete example of a module defined using object literal 
<span class="keep-together">notation:</span></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">myModule</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">myProperty</code><code class="o">:</code> <code class="s1">'someValue'</code><code class="p">,</code>
    <code class="c1">// object literals can contain properties and methods.</code>
    <code class="c1">// e.g., we can define a further object for module configuration:</code>
    <code class="nx">myConfig</code><code class="o">:</code> <code class="p">{</code>
        <code class="nx">useCaching</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
        <code class="nx">language</code><code class="o">:</code> <code class="s1">'en'</code><code class="p">,</code>
    <code class="p">},</code>
    <code class="c1">// a very basic method</code>
    <code class="nx">saySomething</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Where is Paul Irish debugging today?'</code><code class="p">);</code>
    <code class="p">},</code>
    <code class="c1">// output a value based on the current configuration</code>
    <code class="nx">reportMyConfig</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code>
            <code class="sb">`Caching is: </code><code class="si">${</code><code class="k">this</code><code class="p">.</code><code class="nx">myConfig</code><code class="p">.</code><code class="nx">useCaching</code> <code class="o">?</code> <code class="s1">'enabled'</code> <code class="o">:</code> <code class="s1">'disabled'</code><code class="si">}</code><code class="sb">`</code>
        <code class="p">);</code>
    <code class="p">},</code>
    <code class="c1">// override the current configuration</code>
    <code class="nx">updateMyConfig</code><code class="p">(</code><code class="nx">newConfig</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">newConfig</code> <code class="o">===</code> <code class="s1">'object'</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">this</code><code class="p">.</code><code class="nx">myConfig</code> <code class="o">=</code> <code class="nx">newConfig</code><code class="p">;</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">myConfig</code><code class="p">.</code><code class="nx">language</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">},</code>
<code class="p">};</code>

<code class="c1">// Outputs: What is Paul Irish debugging today?</code>
<code class="nx">myModule</code><code class="p">.</code><code class="nx">saySomething</code><code class="p">();</code>

<code class="c1">// Outputs: Caching is: enabled</code>
<code class="nx">myModule</code><code class="p">.</code><code class="nx">reportMyConfig</code><code class="p">();</code>

<code class="c1">// Outputs: fr</code>
<code class="nx">myModule</code><code class="p">.</code><code class="nx">updateMyConfig</code><code class="p">({</code>
    <code class="nx">language</code><code class="o">:</code> <code class="s1">'fr'</code><code class="p">,</code>
    <code class="nx">useCaching</code><code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
<code class="p">});</code>

<code class="c1">// Outputs: Caching is: disabled</code>
<code class="nx">myModule</code><code class="p">.</code><code class="nx">reportMyConfig</code><code class="p">();</code></pre>

<p>Using object literals provided a way to encapsulate and organize code. <a data-type="indexterm" data-primary="Murphey, Rebecca" id="idm45017715299904"/>Rebecca Murphey has written about this topic in <a href="https://oreil.ly/rAYcw">depth</a> should you wish to read into object literals further.<a data-type="indexterm" data-startref="ch-7-oblit" id="idm45017715298544"/><a data-type="indexterm" data-startref="ch-7-oblit2" id="idm45017715297872"/><a data-type="indexterm" data-startref="ch-7-oblit3" id="idm45017715352064"/></p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="The Module Pattern"><div class="sect2" id="idm45017715351264">
<h2>The Module Pattern</h2>

<p>The Module pattern was initially defined<a data-type="indexterm" data-primary="Module pattern" data-secondary="description of Module pattern" id="ch-7-moddesc"/> to provide private and public encapsulation for classes in conventional software engineering.</p>
<p class="fix_tracking">At one point, organizing a JavaScript application of any reasonable size was a challenge. Developers would rely on separate scripts to split and manage reusable chunks of logic, and it wasn’t surprising to find 10 to 20 scripts being imported manually in an HTML file to keep things tidy. Using objects, the Module pattern was just one way to encapsulate logic in a file with both public and “private” methods. Over time, several custom module systems came about to make this smoother. Now, developers can use JavaScript modules to organize objects, functions, classes, or variables such that they can be easily exported or imported into other files. This helps prevent conflicts between classes or function names included in different modules. <a data-type="xref" href="#module">Figure 7-2</a> illustrates the Module pattern.</p>

<figure><div id="module" class="figure">
<img src="Images/ljd2_0702.png" alt="ljd2 0702" width="828" height="337"/>
<h6><span class="label">Figure 7-2. </span>Module pattern</h6>
</div></figure>










<section data-type="sect3" data-pdf-bookmark="Privacy"><div class="sect3" id="idm45017715344560">
<h3>Privacy</h3>

<p>The Module pattern encapsulates<a data-type="indexterm" data-primary="Module pattern" data-secondary="description of Module pattern" data-tertiary="privacy" id="idm45017715342960"/><a data-type="indexterm" data-primary="privacy" data-secondary="Module pattern variables or methods" id="idm45017715341744"/><a data-type="indexterm" data-primary="scope" data-secondary="Module pattern privacy" id="idm45017715340832"/><a data-type="indexterm" data-primary="objects" data-secondary="privacy via Module pattern" id="idm45017715339888"/><a data-type="indexterm" data-primary="namespacing patterns" data-secondary="modules providing namespacing" id="idm45017715338928"/> the “privacy” state and organization using closures. It provides a way of wrapping a mix of public and private methods and variables, protecting pieces from leaking into the global scope and accidentally colliding with another developer’s interface. With this pattern, you expose only the public API, keeping everything else within the closure private.</p>

<p>This gives us a clean solution where the shielding logic does the heavy lifting while we expose only an interface we wish other parts of our application to use. <a data-type="indexterm" data-primary="immediately invoked function expressions (IIFEs)" data-secondary="Module pattern" id="idm45017715337456"/>The pattern uses an <a href="https://oreil.ly/5gef1">immediately invoked function expression (IIFE)</a> where an object is returned. See <a data-type="xref" href="ch11.xhtml#namespacing-patterns">Chapter 11</a> for more on IIFEs.</p>

<p>Note that there isn’t an explicitly<a data-type="indexterm" data-primary="JavaScript" data-secondary="privacy via function scope" id="idm45017715334432"/><a data-type="indexterm" data-primary="privacy" data-secondary="JavaScript using function scope for" id="idm45017715692944"/> true sense of “privacy” inside JavaScript because it doesn’t have access modifiers, unlike some traditional languages. You can’t technically declare variables as public or private, so we use function scope to simulate this concept. Within the Module pattern, variables or methods declared are available only inside the module itself, thanks to closure. However, variables or methods defined within the returning object are available to everyone.</p>

<p>A workaround to implement privacy of variables<a data-type="indexterm" data-primary="privacy" data-secondary="WeakMap() returning object variables" id="idm45017715691408"/><a data-type="indexterm" data-primary="WeakMap()" data-secondary="privacy of returned object variables" id="idm45017715690416"/> in returned objects uses <a href="https://oreil.ly/SmKvK"><code>WeakMap()</code></a> discussed later in this chapter in <a data-type="xref" href="#ModernModulePattern_WeakMap">“Modern Module Pattern with WeakMap”</a>. <code>WeakMap()</code> takes only objects as keys and cannot be iterated. Thus, the only way to access the object inside a module is through its reference. Outside the module, you can access it only through a public method defined within it. Thus, it ensures privacy for the object.</p>
</div></section>










<section data-type="sect3" data-pdf-bookmark="History"><div class="sect3" id="idm45017715686928">
<h3>History</h3>

<p>From a historical perspective,<a data-type="indexterm" data-primary="Module pattern" data-secondary="history" id="idm45017715685600"/><a data-type="indexterm" data-primary="history" data-secondary="Module pattern" id="idm45017715684624"/><a data-type="indexterm" data-primary="Cornford, Richard" id="idm45017715683680"/><a data-type="indexterm" data-primary="Crockford, Douglas" id="idm45017715683008"/> the Module pattern was originally developed in 2003 by several people, including <a href="https://oreil.ly/YTZeM">Richard Cornford</a>. Douglas Crockford later popularized it in his lectures. <a data-type="indexterm" data-primary="YUI library (Yahoo)" data-secondary="Module pattern influence" id="idm45017715681552"/>Another piece of trivia is that some of its features may appear quite familiar if you’ve ever played with Yahoo’s YUI library. The reason for this is that the Module pattern was a strong influence on YUI when its components were created.</p>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Examples"><div class="sect3" id="idm45017715680128">
<h3>Examples</h3>

<p>Let’s begin looking at implementing the Module pattern by creating a self-contained module.<a data-type="indexterm" data-primary="Module pattern" data-secondary="examples" id="ch07-modex"/><a data-type="indexterm" data-primary="import declarations for modules" data-secondary="module objects" data-tertiary="example" id="ch07-modex2"/><a data-type="indexterm" data-primary="object literal notation module pattern" data-secondary="const myObjectLiteral" data-tertiary="example" id="ch07-modex4"/>
 We use the <code>import</code> and <code>export</code> keywords in our implementation. To recap our previous discussion, <code>export</code> allows you to provide access to module features outside the module. At the same time, <code>import</code> enables us to import bindings exported by a module to our script:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">let</code> <code class="nx">counter</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">testModule</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">incrementCounter</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">counter</code><code class="o">++</code><code class="p">;</code>
  <code class="p">},</code>
  <code class="nx">resetCounter</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`counter value prior to reset: </code><code class="si">${</code><code class="nx">counter</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
    <code class="nx">counter</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="p">},</code>
<code class="p">};</code>

<code class="c1">// Default export module, without name</code>
<code class="kr">export</code> <code class="k">default</code> <code class="nx">testModule</code><code class="p">;</code>

<code class="c1">// Usage:</code>

<code class="c1">// Import module from path</code>
<code class="kr">import</code> <code class="nx">testModule</code> <code class="nx">from</code> <code class="s1">'./testModule'</code><code class="p">;</code>

<code class="c1">// Increment our counter</code>
<code class="nx">testModule</code><code class="p">.</code><code class="nx">incrementCounter</code><code class="p">();</code>

<code class="c1">// Check the counter value and reset</code>
<code class="c1">// Outputs: counter value prior to reset: 1</code>
<code class="nx">testModule</code><code class="p">.</code><code class="nx">resetCounter</code><code class="p">();</code></pre>

<p>Here, the other parts of the code cannot<a data-type="indexterm" data-primary="Module pattern" data-secondary="description of Module pattern" data-tertiary="privacy examples" id="idm45017715613344"/><a data-type="indexterm" data-primary="privacy" data-secondary="Module pattern variables or methods" data-tertiary="examples" id="idm45017715640848"/><a data-type="indexterm" data-primary="scope" data-secondary="Module pattern privacy" data-tertiary="examples" id="idm45017715639696"/><a data-type="indexterm" data-primary="Module pattern" data-secondary="examples" data-tertiary="privacy" id="idm45017715638480"/><a data-type="indexterm" data-primary="namespacing patterns" data-secondary="modules providing namespacing" data-tertiary="examples" id="idm45017715637264"/><a data-type="indexterm" data-primary="objects" data-secondary="privacy via Module pattern" data-tertiary="examples" id="idm45017715636080"/> directly read the value of our 
<span class="keep-together"><code>incrementCounter()</code></span> or <code>resetCounter()</code>. The <code>counter</code> variable is entirely shielded from our global scope, so it acts just like a private variable would—its existence is limited to within the module’s closure so that the two functions are the only code able to access its scope. Our methods are effectively namespaced, so in the test section of our code, we need to prefix any calls with the module’s name (e.g., <code>testModule</code>).</p>

<p>When working with the Module pattern,<a data-type="indexterm" data-primary="Module pattern" data-secondary="examples" data-tertiary="template" id="idm45017715632304"/> we may find it helpful to define a simple template we can use to get started with it. Here’s one that covers namespacing, public, and private variables:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// A private counter variable</code>
<code class="kd">let</code> <code class="nx">myPrivateVar</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

<code class="c1">// A private function that logs any arguments</code>
<code class="kr">const</code> <code class="nx">myPrivateMethod</code> <code class="o">=</code> <code class="nx">foo</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">foo</code><code class="p">);</code>
<code class="p">};</code>

<code class="kr">const</code> <code class="nx">myNamespace</code> <code class="o">=</code> <code class="p">{</code>
  <code class="c1">// A public variable</code>
  <code class="nx">myPublicVar</code><code class="o">:</code> <code class="s1">'foo'</code><code class="p">,</code>

  <code class="c1">// A public function utilizing privates</code>
  <code class="nx">myPublicFunction</code><code class="p">(</code><code class="nx">bar</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Increment our private counter</code>
    <code class="nx">myPrivateVar</code><code class="o">++</code><code class="p">;</code>

    <code class="c1">// Call our private method using bar</code>
    <code class="nx">myPrivateMethod</code><code class="p">(</code><code class="nx">bar</code><code class="p">);</code>
  <code class="p">},</code>
<code class="p">};</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">myNamespace</code><code class="p">;</code></pre>

<p>What follows is another example, where we can see a shopping basket implemented using this pattern. The module itself is completely self-contained in a global variable called <code>basketModule</code>. The <code>basket</code> array in the module is kept private, so other parts of our application cannot directly read it. It exists only within the module’s closure, and so the only methods able to access it are those with access to its scope (i.e., 
<span class="keep-together"><code>addItem()</code>,</span> <code>getItem()</code>, etc.):</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// privates</code>

<code class="kr">const</code> <code class="nx">basket</code> <code class="o">=</code> <code class="p">[];</code>

<code class="kr">const</code> <code class="nx">doSomethingPrivate</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">//...</code>
<code class="p">};</code>

<code class="kr">const</code> <code class="nx">doSomethingElsePrivate</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">//...</code>
<code class="p">};</code>

<code class="c1">// Create an object exposed to the public</code>
<code class="kr">const</code> <code class="nx">basketModule</code> <code class="o">=</code> <code class="p">{</code>
  <code class="c1">// Add items to our basket</code>
  <code class="nx">addItem</code><code class="p">(</code><code class="nx">values</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">basket</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">values</code><code class="p">);</code>
  <code class="p">},</code>

  <code class="c1">// Get the count of items in the basket</code>
  <code class="nx">getItemCount</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">basket</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>
  <code class="p">},</code>

  <code class="c1">// Public alias to a private function</code>
  <code class="nx">doSomething</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">doSomethingPrivate</code><code class="p">();</code>
  <code class="p">},</code>

  <code class="c1">// Get the total value of items in the basket</code>
  <code class="c1">// The reduce() method applies a function against an accumulator and each</code>
  <code class="c1">// element in the array (from left to right) to reduce it to a single value.</code>
  <code class="nx">getTotal</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">basket</code><code class="p">.</code><code class="nx">reduce</code><code class="p">((</code><code class="nx">currentSum</code><code class="p">,</code> <code class="nx">item</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">item</code><code class="p">.</code><code class="nx">price</code> <code class="o">+</code> <code class="nx">currentSum</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
  <code class="p">},</code>
<code class="p">};</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">basketModule</code><code class="p">;</code></pre>

<p>Inside the module, you may have noticed that we return an <code>object</code>. This gets automatically assigned to <code>basketModule</code> so that we can interact with it as follows:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Import module from path</code>
<code class="kr">import</code> <code class="nx">basketModule</code> <code class="nx">from</code> <code class="s1">'./basketModule'</code><code class="p">;</code>

<code class="c1">// basketModule returns an object with a public API we can use</code>

<code class="nx">basketModule</code><code class="p">.</code><code class="nx">addItem</code><code class="p">({</code>
  <code class="nx">item</code><code class="o">:</code> <code class="s1">'bread'</code><code class="p">,</code>
  <code class="nx">price</code><code class="o">:</code> <code class="mf">0.5</code><code class="p">,</code>
<code class="p">});</code>

<code class="nx">basketModule</code><code class="p">.</code><code class="nx">addItem</code><code class="p">({</code>
  <code class="nx">item</code><code class="o">:</code> <code class="s1">'butter'</code><code class="p">,</code>
  <code class="nx">price</code><code class="o">:</code> <code class="mf">0.3</code><code class="p">,</code>
<code class="p">});</code>

<code class="c1">// Outputs: 2</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">basketModule</code><code class="p">.</code><code class="nx">getItemCount</code><code class="p">());</code>

<code class="c1">// Outputs: 0.8</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">basketModule</code><code class="p">.</code><code class="nx">getTotal</code><code class="p">());</code>

<code class="c1">// However, the following will not work:</code>

<code class="c1">// Outputs: undefined</code>
<code class="c1">// This is because the basket itself is not exposed as a part of our</code>
<code class="c1">// public API</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">basketModule</code><code class="p">.</code><code class="nx">basket</code><code class="p">);</code>

<code class="c1">// This also won't work as it exists only within the scope of our</code>
<code class="c1">// basketModule closure, not in the returned public object</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">basket</code><code class="p">);</code></pre>

<p>These methods are effectively namespaced inside <code>basketModule</code>. All our functions are wrapped in this module, giving us several advantages, such as:</p>

<ul>
<li>
<p>The freedom to have private functions that can be consumed only by our module. They aren’t exposed to the rest of the page (only our exported API is), so they’re considered truly private.</p>
</li>
<li>
<p>Given that functions are usually declared and named,<a data-type="indexterm" data-primary="debugging via call stack" id="idm45017717752224"/> it can be easier to show call stacks in a debugger when we’re attempting to discover what function(s) threw an exception.<a data-type="indexterm" data-startref="ch-7-moddesc" id="idm45017717751424"/><a data-type="indexterm" data-startref="ch07-modex" id="idm45017717750752"/><a data-type="indexterm" data-startref="ch07-modex2" id="idm45017717750080"/><a data-type="indexterm" data-startref="ch07-modex4" id="idm45017717749408"/></p>
</li>
</ul>
</div></section>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Module Pattern Variations"><div class="sect2" id="idm45017715679536">
<h2>Module Pattern Variations</h2>

<p>Over time, designers have introduced different variations of the Module pattern suited to their needs.</p>










<section data-type="sect3" data-pdf-bookmark="Import Mixins"><div class="sect3" id="idm45017717746736">
<h3>Import Mixins</h3>

<p>This pattern variation demonstrates<a data-type="indexterm" data-primary="Module pattern" data-secondary="variations" data-tertiary="globals passed as arguments" id="idm45017717745408"/><a data-type="indexterm" data-primary="Mixin pattern" data-secondary="import Mixins" id="idm45017717744192"/> how you can pass globals (e.g., utility functions or external libraries) as arguments to a higher-order function in a module. This effectively allows us to import and locally alias them as we wish:</p>

<pre data-type="programlisting" data-code-language="javascript" class="less_space pagebreak-before"><code class="c1">// utils.js</code>
<code class="kr">export</code> <code class="kr">const</code> <code class="nx">min</code> <code class="o">=</code> <code class="p">(</code><code class="nx">arr</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">min</code><code class="p">(...</code><code class="nx">arr</code><code class="p">);</code>

<code class="c1">// privateMethods.js</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">min</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"./utils"</code><code class="p">;</code>

<code class="kr">export</code> <code class="kr">const</code> <code class="nx">privateMethod</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">min</code><code class="p">([</code><code class="mi">10</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">100</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">1000</code><code class="p">]));</code>
<code class="p">};</code>

<code class="c1">// myModule.js</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">privateMethod</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"./privateMethods"</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">myModule</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">({</code>
  <code class="nx">publicMethod</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">privateMethod</code><code class="p">();</code>
  <code class="p">},</code>
<code class="p">});</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">myModule</code><code class="p">;</code>

<code class="c1">// main.js</code>
<code class="kr">import</code> <code class="nx">myModule</code> <code class="nx">from</code> <code class="s2">"./myModule"</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">moduleInstance</code> <code class="o">=</code> <code class="nx">myModule</code><code class="p">();</code>
<code class="nx">moduleInstance</code><code class="p">.</code><code class="nx">publicMethod</code><code class="p">();</code></pre>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Exports"><div class="sect3" id="idm45017715936944">
<h3>Exports</h3>

<p>This next variation allows us to declare globals<a data-type="indexterm" data-primary="Module pattern" data-secondary="variations" data-tertiary="declaring globals without consuming" id="idm45017715882416"/> without consuming them and could similarly support the concept of global imports seen in the last example:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// module.js</code>
<code class="kr">const</code> <code class="nx">privateVariable</code> <code class="o">=</code> <code class="s2">"Hello World"</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">privateMethod</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// ...</code>
<code class="p">};</code>

<code class="kr">const</code> <code class="nx">module</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">publicProperty</code><code class="o">:</code> <code class="s2">"Foobar"</code><code class="p">,</code>
  <code class="nx">publicMethod</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">privateVariable</code><code class="p">);</code>
  <code class="p">},</code>
<code class="p">};</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">module</code><code class="p">;</code></pre>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Advantages"><div class="sect3" id="idm45017715774064">
<h3>Advantages</h3>

<p>We’ve seen why the Constructor pattern<a data-type="indexterm" data-primary="Module pattern" data-secondary="advantages and disadvantages" id="idm45017715763824"/> can be useful, but why is the Module pattern a good choice? For starters, it’s a lot cleaner for developers coming from an object-oriented background than the idea of true encapsulation, at least from a JavaScript perspective. With import Mixins, developers can manage dependencies between modules and pass globals as needed, making the code more maintainable and 
<span class="keep-together">modular.</span></p>

<p>Secondly, it supports private data—so, in the Module pattern, we have access to only the values that we explicitly exported using the <code>export</code> keyword. Values we didn’t expressly export are private and available only within the module. This reduces the risk of accidentally polluting the global scope. You don’t have to fear that you will accidentally overwrite values created by developers using your module that may have had the same name as your private value: it prevents naming collisions and global scope pollution.</p>

<p>With the Module pattern, we can encapsulate parts of our code that should not be publicly exposed. They make working with multiple dependencies and namespaces less risky. Note that a transpiler such as Babel is needed to use ES2015 modules in all JavaScript runtimes.</p>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Disadvantages"><div class="sect3" id="idm45017715760752">
<h3>Disadvantages</h3>

<p>The disadvantages of the Module pattern are that we access both public and private members differently. When we wish to change the visibility, we must make changes to each place we use the member.</p>

<p>We also can’t access private members in methods we added to the object later. That said, in many cases, the Module pattern is still quite helpful and, when used correctly, certainly has the potential to improve the structure of our application.</p>

<p>Other disadvantages include the inability to create automated unit tests for private members and additional complexity when bugs require hot fixes. It’s simply not possible to patch privates. Instead, one must override all public methods interacting with the buggy privates. Developers can’t easily extend privates either, so it’s worth remembering that privates are not as flexible as they may initially appear.</p>

<p>For further reading on the Module pattern,<a data-type="indexterm" data-primary="Module pattern" data-secondary="further reading" id="idm45017715757936"/><a data-type="indexterm" data-primary="Cherry, Ben" id="idm45017715756960"/> see Ben Cherry’s excellent in-depth 
<span class="keep-together"><a href="https://oreil.ly/wfX1y">article</a>.</span></p>
</div></section>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Modern Module Pattern with WeakMap"><div class="sect2" id="ModernModulePattern_WeakMap">
<h2>Modern Module Pattern with WeakMap</h2>

<p>Introduced to JavaScript in ES6, the <a href="https://oreil.ly/SmKvK"><code>WeakMap</code></a> object<a data-type="indexterm" data-primary="Module pattern" data-secondary="WeakMap object" id="idm45017715074800"/><a data-type="indexterm" data-primary="WeakMap()" data-secondary="Module pattern with" id="idm45017715073824"/><a data-type="indexterm" data-primary="WeakMap()" id="idm45017715072880"/><a data-type="indexterm" data-primary="garbage collection (GC) and WeakMap keys" id="idm45017715072208"/> is a collection of key-value pairs in which the keys are weakly referenced. The keys must be objects, and the values can be arbitrary. The object is essentially a map where keys are held weakly. This means that keys will be a target for garbage collection (GC) if there is no active reference to the object. Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#basic_module_definition">7-1</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="#namespaces_publicprivate_variables">7-2</a>, and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#shopping_basket_implementation">7-3</a> look at an implementation of the Module pattern that uses the <code>WeakMap</code> object.<a data-type="indexterm" data-primary="constructor() method" data-secondary="Modules" id="idm45017715067360"/></p>
<div id="basic_module_definition" data-type="example">
<h5><span class="label">Example 7-1. </span>Basic module definition</h5>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">let</code> <code class="nx">_counter</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>

<code class="kr">class</code> <code class="nx">Module</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">_counter</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="nx">incrementCounter</code><code class="p">()</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">counter</code> <code class="o">=</code> <code class="nx">_counter</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
        <code class="nx">counter</code><code class="o">++</code><code class="p">;</code>
        <code class="nx">_counter</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">counter</code><code class="p">);</code>

        <code class="k">return</code> <code class="nx">_counter</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="nx">resetCounter</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`counter value prior to reset: </code><code class="si">${</code><code class="nx">_counter</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">)</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="nx">_counter</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">testModule</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Module</code><code class="p">();</code>

<code class="c1">// Usage:</code>

<code class="c1">// Increment our counter</code>
<code class="nx">testModule</code><code class="p">.</code><code class="nx">incrementCounter</code><code class="p">();</code>
<code class="c1">// Check the counter value and reset</code>
<code class="c1">// Outputs: counter value prior to reset: 1</code>
<code class="nx">testModule</code><code class="p">.</code><code class="nx">resetCounter</code><code class="p">();</code></pre></div>
<div id="namespaces_publicprivate_variables" data-type="example">
<h5><span class="label">Example 7-2. </span>Namespaces with public/private variables</h5>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">myPrivateVar</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">myPrivateMethod</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>

<code class="kr">class</code> <code class="nx">MyNamespace</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="c1">// A private counter variable</code>
        <code class="nx">myPrivateVar</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
        <code class="c1">// A private function that logs any arguments</code>
        <code class="nx">myPrivateMethod</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">foo</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">foo</code><code class="p">));</code>
        <code class="c1">// A public variable</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">myPublicVar</code> <code class="o">=</code> <code class="s1">'foo'</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="c1">// A public function utilizing privates</code>
    <code class="nx">myPublicFunction</code><code class="p">(</code><code class="nx">bar</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">privateVar</code> <code class="o">=</code> <code class="nx">myPrivateVar</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">privateMethod</code> <code class="o">=</code> <code class="nx">myPrivateMethod</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
        <code class="c1">// Increment our private counter</code>
        <code class="nx">privateVar</code><code class="o">++</code><code class="p">;</code>
        <code class="nx">myPrivateVar</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">privateVar</code><code class="p">);</code>
        <code class="c1">// Call our private method using bar</code>
        <code class="nx">privateMethod</code><code class="p">(</code><code class="nx">bar</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<div id="shopping_basket_implementation" data-type="example">
<h5><span class="label">Example 7-3. </span>Shopping basket implementation</h5>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">basket</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">doSomethingPrivate</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">doSomethingElsePrivate</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">WeakMap</code><code class="p">();</code>

<code class="kr">class</code> <code class="nx">BasketModule</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="c1">// privates</code>
        <code class="nx">basket</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="p">[]);</code>
        <code class="nx">doSomethingPrivate</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="c1">//...</code>
        <code class="p">});</code>
        <code class="nx">doSomethingElsePrivate</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="c1">//...</code>
        <code class="p">});</code>
    <code class="p">}</code>
    <code class="c1">// Public aliases to a private function</code>
    <code class="nx">doSomething</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">doSomethingPrivate</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">)();</code>
    <code class="p">}</code>
    <code class="nx">doSomethingElse</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">doSomethingElsePrivate</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">)();</code>
    <code class="p">}</code>
    <code class="c1">// Add items to our basket</code>
    <code class="nx">addItem</code><code class="p">(</code><code class="nx">values</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">const</code> <code class="nx">basketData</code> <code class="o">=</code> <code class="nx">basket</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
        <code class="nx">basketData</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">values</code><code class="p">);</code>
        <code class="nx">basket</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">basketData</code><code class="p">);</code>
    <code class="p">}</code>
    <code class="c1">// Get the count of items in the basket</code>
    <code class="nx">getItemCount</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">basket</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">length</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="c1">// Get the total value of items in the basket</code>
    <code class="nx">getTotal</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">basket</code>
            <code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">reduce</code><code class="p">((</code><code class="nx">currentSum</code><code class="p">,</code> <code class="nx">item</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">item</code><code class="p">.</code><code class="nx">price</code> <code class="o">+</code> <code class="nx">currentSum</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Modules with Modern Libraries"><div class="sect2" id="idm45017714313952">
<h2>Modules with Modern Libraries</h2>

<p>You can use the Module pattern when building<a data-type="indexterm" data-primary="Module pattern" data-secondary="React and other modern libraries" id="idm45017714312816"/> applications with JavaScript libraries such as React. Let’s say you have a large number of custom components created by your team. In that case, you can separate each component in its own file, essentially creating a module for every component. Here is an example of a button component customized from the <a href="https://oreil.ly/77tjD"><em>material-ui</em></a> button component and exported as a module:<a data-type="indexterm" data-startref="ch07-mod" id="idm45017714196352"/><a data-type="indexterm" data-startref="ch07-mod2" id="idm45017714195680"/><a data-type="indexterm" data-startref="ch07-mod3" id="idm45017714195008"/><a data-type="indexterm" data-startref="ch07-mod4" id="idm45017714194336"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s2">"react"</code><code class="p">;</code>
<code class="kr">import</code> <code class="nx">Button</code> <code class="nx">from</code> <code class="s2">"@material-ui/core/Button"</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">style</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">root</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">borderRadius</code><code class="o">:</code> <code class="mi">3</code><code class="p">,</code>
    <code class="nx">border</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="nx">color</code><code class="o">:</code> <code class="s2">"white"</code><code class="p">,</code>
    <code class="nx">margin</code><code class="o">:</code> <code class="s2">"0 20px"</code>
  <code class="p">},</code>
  <code class="nx">primary</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">background</code><code class="o">:</code> <code class="s2">"linear-gradient(45deg, #FE6B8B 30%, #FF8E53 90%)"</code>
  <code class="p">},</code>
  <code class="nx">secondary</code><code class="o">:</code> <code class="p">{</code>
    <code class="nx">background</code><code class="o">:</code> <code class="s2">"linear-gradient(45deg, #2196f3 30%, #21cbf3 90%)"</code>
  <code class="p">}</code>
<code class="p">};</code>

<code class="kr">export</code> <code class="k">default</code> <code class="kd">function</code> <code class="nx">CustomButton</code><code class="p">(</code><code class="nx">props</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">return</code> <code class="p">(</code>
    <code class="o">&lt;</code><code class="nx">Button</code> <code class="p">{...</code><code class="nx">props</code><code class="p">}</code> <code class="nx">style</code><code class="o">=</code><code class="p">{{</code> <code class="p">...</code><code class="nx">style</code><code class="p">.</code><code class="nx">root</code><code class="p">,</code> <code class="p">...</code><code class="nx">style</code><code class="p">[</code><code class="nx">props</code><code class="p">.</code><code class="nx">color</code><code class="p">]</code> <code class="p">}}</code><code class="o">&gt;</code>
      <code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">children</code><code class="p">}</code>
    <code class="o">&lt;</code><code class="err">/Button&gt;</code>
  <code class="p">);</code>
<code class="p">}</code></pre>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Revealing Module Pattern"><div class="sect1" id="the-revealing-module-pattern">
<h1>The Revealing Module Pattern</h1>

<p>Now that we are a little more familiar<a data-type="indexterm" data-primary="Revealing Module pattern" id="ch07-revmo"/><a data-type="indexterm" data-primary="creational design patterns" data-secondary="Revealing Module pattern" id="ch07-revmo2"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="creational design patterns" data-tertiary="Revealing Module pattern" id="ch07-revmo3"/><a data-type="indexterm" data-primary="Heilmann, Christian" id="idm45017709182544"/> with the Module pattern, let’s look at a slightly improved version: Christian Heilmann’s Revealing Module pattern.</p>

<p>The Revealing Module pattern came about as <a data-type="indexterm" data-primary="scope" data-secondary="Revealing Module pattern" id="idm45017709159024"/>Heilmann was frustrated that he had to repeat the name of the main object when he wanted to call one public method from another or access public variables. He also disliked switching to object literal notation for the things he wished to make public.</p>

<p>His efforts resulted in an updated pattern where we can simply define all functions and variables in the private scope and return an anonymous object with pointers to the private functionality we wished to reveal as public.</p>

<p>With the modern way of implementing <a href="https://oreil.ly/eMYvs">modules</a> in ES2015+, the scope of functions and variables defined in the module is already private. Also, we use <code>export</code> and <code>import</code> to reveal whatever needs to be revealed.</p>

<p>An example of the use of the Revealing Module pattern with ES2015+ is as follows:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">let</code> <code class="nx">privateVar</code> <code class="o">=</code> <code class="s1">'Rob Dodson'</code><code class="p">;</code>
<code class="kr">const</code> <code class="nx">publicVar</code> <code class="o">=</code> <code class="s1">'Hey there!'</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">privateFunction</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Name:</code><code class="si">${</code><code class="nx">privateVar</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
<code class="p">};</code>

<code class="kr">const</code> <code class="nx">publicSetName</code> <code class="o">=</code> <code class="nx">strName</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">privateVar</code> <code class="o">=</code> <code class="nx">strName</code><code class="p">;</code>
<code class="p">};</code>

<code class="kr">const</code> <code class="nx">publicGetName</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">privateFunction</code><code class="p">();</code>
<code class="p">};</code>

<code class="c1">// Reveal public pointers to</code>
<code class="c1">// private functions and properties</code>
<code class="kr">const</code> <code class="nx">myRevealingModule</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">setName</code><code class="o">:</code> <code class="nx">publicSetName</code><code class="p">,</code>
  <code class="nx">greeting</code><code class="o">:</code> <code class="nx">publicVar</code><code class="p">,</code>
  <code class="nx">getName</code><code class="o">:</code> <code class="nx">publicGetName</code><code class="p">,</code>
<code class="p">};</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">myRevealingModule</code><code class="p">;</code>

<code class="c1">// Usage:</code>
<code class="kr">import</code> <code class="nx">myRevealingModule</code> <code class="nx">from</code> <code class="s1">'./myRevealingModule'</code><code class="p">;</code>

<code class="nx">myRevealingModule</code><code class="p">.</code><code class="nx">setName</code><code class="p">(</code><code class="s1">'Matt Gaunt'</code><code class="p">);</code></pre>

<p>In this example, we reveal the private variable <code>privateVar</code> through its public get and set methods, <code>publicSetName</code> and <code>publicGetName</code>.</p>

<p>You can also use the pattern to reveal private functions and properties with a more specific naming scheme:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">let</code> <code class="nx">privateCounter</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">privateFunction</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">privateCounter</code><code class="o">++</code><code class="p">;</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">publicFunction</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">publicIncrement</code><code class="p">();</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">publicIncrement</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">privateFunction</code><code class="p">();</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">publicGetCount</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">privateCounter</code><code class="p">;</code>

<code class="c1">// Reveal public pointers to</code>
<code class="c1">// private functions and properties</code>
<code class="kr">const</code> <code class="nx">myRevealingModule</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">start</code><code class="o">:</code> <code class="nx">publicFunction</code><code class="p">,</code>
    <code class="nx">increment</code><code class="o">:</code> <code class="nx">publicIncrement</code><code class="p">,</code>
    <code class="nx">count</code><code class="o">:</code> <code class="nx">publicGetCount</code>
<code class="p">};</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">myRevealingModule</code><code class="p">;</code>

<code class="c1">// Usage:</code>
<code class="kr">import</code> <code class="nx">myRevealingModule</code> <code class="nx">from</code> <code class="s1">'./myRevealingModule'</code><code class="p">;</code>

<code class="nx">myRevealingModule</code><code class="p">.</code><code class="nx">start</code><code class="p">();</code></pre>








<section data-type="sect2" data-pdf-bookmark="Advantages"><div class="sect2" id="idm45017709017184">
<h2>Advantages</h2>

<p>This pattern allows the syntax of our scripts<a data-type="indexterm" data-primary="Revealing Module pattern" data-secondary="advantages and disadvantages" id="idm45017709016048"/> to be more consistent. It also makes it easier to understand at the end of the module which of our functions and variables may be accessed publicly, which eases readability.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Disadvantages"><div class="sect2" id="idm45017708921344">
<h2>Disadvantages</h2>

<p>A disadvantage of this pattern is that if a private function refers to a public function, that public function can’t be overridden if a patch is necessary. This is because the private function will continue to refer to the private implementation, and the pattern doesn’t apply to public members, only to functions.</p>

<p>Public object members, which refer to private variables, are also subject to the no-patch rule.</p>

<p>As a result, modules created with the Revealing Module pattern may be more fragile than those created with the original Module pattern, and you should take care when using it.<a data-type="indexterm" data-startref="ch07-revmo" id="idm45017708919104"/><a data-type="indexterm" data-startref="ch07-revmo2" id="idm45017708918400"/><a data-type="indexterm" data-startref="ch07-revmo3" id="idm45017708897168"/></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Singleton Pattern"><div class="sect1" id="the-singleton-pattern">
<h1>The Singleton Pattern</h1>

<p>The Singleton pattern is a design pattern<a data-type="indexterm" data-primary="Singleton pattern" id="ch07-sing"/><a data-type="indexterm" data-primary="creational design patterns" data-secondary="Singleton pattern" id="ch07-sing2"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="creational design patterns" data-tertiary="Singleton pattern" id="ch07-sing3"/><a data-type="indexterm" data-primary="classes" data-secondary="Singleton pattern" id="ch07-sing4"/><a data-type="indexterm" data-primary="objects" data-secondary="Singleton pattern" id="ch07-sing5"/><a data-type="indexterm" data-primary="Singleton pattern" data-secondary="about" id="idm45017708888016"/> that restricts the instantiation of a class to one object. This is useful when exactly one object is needed to coordinate actions across the system. Classically, you can implement the Singleton pattern by creating a class with a method that creates a new instance of the class only if one doesn’t already exist. If an instance already exists, it simply returns a reference to that object.</p>

<p>Singletons differ from static classes (or objects) in that we can delay their initialization because they require certain information that may not be available during initialization time. Any code that is unaware of a previous reference to the Singleton class cannot easily retrieve it. This is because it is neither the object nor “class” that a 
<span class="keep-together">Singleton</span> returns; it’s a structure. Think of how closured variables aren’t actually 
<span class="keep-together">closures—the</span> function scope that provides the closure is the closure.</p>

<p>ES2015+ allows us to implement the Singleton pattern to create a global instance of a JavaScript class that is instantiated once. You can expose the Singleton instance through a module export. This makes access to it more explicit and controlled and differentiates it from other global variables. You cannot create a new class instance but can read/modify the instance using public get and set methods defined in the class.</p>

<p>We can implement a Singleton as follows:<a data-type="indexterm" data-primary="Singleton pattern" data-secondary="implementation" id="ch07-singimp"/><a data-type="indexterm" data-primary="constructor() method" data-secondary="Singletons" id="ch07-singimp2"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Instance stores a reference to the Singleton</code>
<code class="kd">let</code> <code class="nx">instance</code><code class="p">;</code>

<code class="c1">// Private methods and variables</code>
<code class="kr">const</code> <code class="nx">privateMethod</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'I am private'</code><code class="p">);</code>
  <code class="p">};</code>
<code class="kr">const</code> <code class="nx">privateVariable</code> <code class="o">=</code> <code class="s1">'Im also private'</code><code class="p">;</code>
<code class="kr">const</code> <code class="nx">randomNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">();</code>

<code class="c1">// Singleton</code>
<code class="kr">class</code> <code class="nx">MySingleton</code> <code class="p">{</code>
  <code class="c1">// Get the Singleton instance if one exists</code>
  <code class="c1">// or create one if it doesn't</code>
  <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">instance</code><code class="p">)</code> <code class="p">{</code>
      <code class="c1">// Public property</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">publicProperty</code> <code class="o">=</code> <code class="s1">'I am also public'</code><code class="p">;</code>
      <code class="nx">instance</code> <code class="o">=</code> <code class="k">this</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="nx">instance</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="c1">// Public methods</code>
  <code class="nx">publicMethod</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'The public can see me!'</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="nx">getRandomNumber</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">randomNumber</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code>
<code class="c1">// [ES2015+] Default export module, without name</code>
<code class="kr">export</code> <code class="k">default</code> <code class="nx">MySingleton</code><code class="p">;</code>


<code class="c1">// Instance stores a reference to the Singleton</code>
<code class="kd">let</code> <code class="nx">instance</code><code class="p">;</code>

<code class="c1">// Singleton</code>
<code class="kr">class</code> <code class="nx">MyBadSingleton</code> <code class="p">{</code>
    <code class="c1">// Always create a new Singleton instance</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">randomNumber</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">();</code>
        <code class="nx">instance</code> <code class="o">=</code> <code class="k">this</code><code class="p">;</code>

        <code class="k">return</code> <code class="nx">instance</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">getRandomNumber</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">randomNumber</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">MyBadSingleton</code><code class="p">;</code>


<code class="c1">// Usage:</code>
<code class="kr">import</code> <code class="nx">MySingleton</code> <code class="nx">from</code> <code class="s1">'./MySingleton'</code><code class="p">;</code>
<code class="kr">import</code> <code class="nx">MyBadSingleton</code> <code class="nx">from</code> <code class="s1">'./MyBadSingleton'</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">singleA</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MySingleton</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">singleB</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MySingleton</code><code class="p">();</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">singleA</code><code class="p">.</code><code class="nx">getRandomNumber</code><code class="p">()</code> <code class="o">===</code> <code class="nx">singleB</code><code class="p">.</code><code class="nx">getRandomNumber</code><code class="p">());</code>
<code class="c1">// true</code>

<code class="kr">const</code> <code class="nx">badSingleA</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyBadSingleton</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">badSingleB</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyBadSingleton</code><code class="p">();</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">badSingleA</code><code class="p">.</code><code class="nx">getRandomNumber</code><code class="p">()</code> <code class="o">!==</code> <code class="nx">badSingleB</code><code class="p">.</code><code class="nx">getRandomNumber</code><code class="p">());</code>
<code class="c1">// true</code>

<code class="c1">// Note: as we are working with random numbers, there is a mathematical</code>
<code class="c1">// possibility both numbers will be the same, however unlikely.</code>
<code class="c1">// The preceding example should otherwise still be valid.</code></pre>

<p>What makes the Singleton is the global access to the instance.
The GoF book describes the <em>applicability</em> of the Singleton pattern as follows:<a data-type="indexterm" data-primary="Design Patterns: Elements of Reusable Object-Oriented Software (Gamma, Helm, Johnson, and Vlissides)" data-secondary="Singleton pattern applicability" id="idm45017708725184"/><a data-type="indexterm" data-primary="Gamma, Erich" id="idm45017708724224"/><a data-type="indexterm" data-primary="Helm, Richard" id="idm45017708723616"/><a data-type="indexterm" data-primary="Johnson, Ralph" id="idm45017708617264"/><a data-type="indexterm" data-primary="Vlissides, John" id="idm45017708616592"/><a data-type="indexterm" data-primary="Singleton pattern" data-secondary="about" id="idm45017708615920"/><a data-type="indexterm" data-primary="subclasses" data-secondary="subclassing" data-tertiary="Singleton instance extensible by" id="idm45017708614976"/></p>

<ul>
<li>
<p>There must be exactly one instance of a class, and it must be accessible to clients from a well-known access point.</p>
</li>
<li>
<p>The sole instance should be extensible by subclassing, and clients should be able to use an extended instance without modifying their code.</p>
</li>
</ul>

<p>The second of these points refers to a case where we might need code, such as:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">_instance</code> <code class="o">==</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">isFoo</code><code class="p">())</code> <code class="p">{</code>
            <code class="k">this</code><code class="p">.</code><code class="nx">_instance</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">FooSingleton</code><code class="p">();</code>
        <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
            <code class="k">this</code><code class="p">.</code><code class="nx">_instance</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">BasicSingleton</code><code class="p">();</code>
        <code class="p">}</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">_instance</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Here, the <code>constructor</code> becomes a little like a Factory method, and we don’t need to update each point in our code accessing it. <code>FooSingleton</code> (in this example) would be a subclass of <code>BasicSingleton</code> and implement the same interface.</p>

<p>Why is deferring execution considered<a data-type="indexterm" data-primary="Singleton pattern" data-secondary="deferring execution significance" id="idm45017708522288"/> significant for a Singleton? In C++, it serves as isolation from the unpredictability of the dynamic initialization order, returning control to the programmer.</p>

<p>It is essential to note the difference between<a data-type="indexterm" data-primary="Singleton pattern" data-secondary="static instance of class/object versus a Singleton" id="idm45017708520832"/><a data-type="indexterm" data-primary="static keyword for classes" data-secondary="Singleton versus static instance" id="idm45017708519888"/><a data-type="indexterm" data-primary="classes" data-secondary="Singleton pattern" data-tertiary="static instance of class versus" id="idm45017708519008"/><a data-type="indexterm" data-primary="objects" data-secondary="Singleton pattern" data-tertiary="static instance of object versus" id="idm45017708517824"/> a static instance of a class (object) and a Singleton. While you can implement a Singleton as a static instance, it can also be constructed lazily, without the need for resources or memory until it is needed.</p>

<p>Suppose we have a static object that we can initialize directly. In that case, we need to ensure the code is always executed in the same order (e.g., in case <code>objCar</code> needs <code>objWheel</code> during its initialization), and this doesn’t scale when you have a large number of source files.</p>

<p>Both Singletons and static objects are useful but shouldn’t be overused—the same way we shouldn’t overuse other patterns.</p>

<p>In practice, it helps to use the Singleton pattern when exactly one object is needed to coordinate others across a system. The following is one example that uses the pattern in this context:<a data-type="indexterm" data-primary="Singleton pattern" data-secondary="example" id="idm45017708504576"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// options: an object containing configuration options for the Singleton</code>
<code class="c1">// e.g., const options = { name: "test", pointX: 5};</code>
<code class="kr">class</code> <code class="nx">Singleton</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">options</code> <code class="o">=</code> <code class="p">{})</code> <code class="p">{</code>
      <code class="c1">// set some properties for our Singleton</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">name</code> <code class="o">=</code> <code class="s1">'SingletonTester'</code><code class="p">;</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">pointX</code> <code class="o">=</code> <code class="nx">options</code><code class="p">.</code><code class="nx">pointX</code> <code class="o">||</code> <code class="mi">6</code><code class="p">;</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">pointY</code> <code class="o">=</code> <code class="nx">options</code><code class="p">.</code><code class="nx">pointY</code> <code class="o">||</code> <code class="mi">10</code><code class="p">;</code>
    <code class="p">}</code>
  <code class="p">}</code>

  <code class="c1">// our instance holder</code>
  <code class="kd">let</code> <code class="nx">instance</code><code class="p">;</code>

  <code class="c1">// an emulation of static variables and methods</code>
  <code class="kr">const</code> <code class="nx">SingletonTester</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s1">'SingletonTester'</code><code class="p">,</code>
    <code class="c1">// Method for getting an instance. It returns</code>
    <code class="c1">// a Singleton instance of a Singleton object</code>
    <code class="nx">getInstance</code><code class="p">(</code><code class="nx">options</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">instance</code> <code class="o">===</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">instance</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Singleton</code><code class="p">(</code><code class="nx">options</code><code class="p">);</code>
      <code class="p">}</code>

      <code class="k">return</code> <code class="nx">instance</code><code class="p">;</code>
    <code class="p">},</code>
  <code class="p">};</code>

  <code class="kr">const</code> <code class="nx">singletonTest</code> <code class="o">=</code> <code class="nx">SingletonTester</code><code class="p">.</code><code class="nx">getInstance</code><code class="p">({</code>
    <code class="nx">pointX</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
  <code class="p">});</code>

  <code class="c1">// Log the output of pointX just to verify it is correct</code>
  <code class="c1">// Outputs: 5</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">singletonTest</code><code class="p">.</code><code class="nx">pointX</code><code class="p">);</code></pre>

<p>While the Singleton has valid uses, often, when we find ourselves needing it in JavaScript, it’s a sign that we may need to reevaluate our design. <a data-type="indexterm" data-primary="JavaScript" data-secondary="objects created directly" id="idm45017708500448"/><a data-type="indexterm" data-primary="objects" data-secondary="created directly in JavaScript" id="idm45017708499600"/>Unlike C++ or Java, where you have to define a class to create an object, JavaScript allows you to create objects directly. Thus, you can create one such object directly instead of defining a Singleton class. <a data-type="indexterm" data-primary="Singleton pattern" data-secondary="disadvantages" id="idm45017708498624"/>In contrast, using Singleton classes in JavaScript has <a data-type="indexterm" data-startref="ch07-singimp" id="idm45017708362736"/><a data-type="indexterm" data-startref="ch07-singimp2" id="idm45017708362064"/>some 
<span class="keep-together">disadvantages:</span></p>
<dl>
<dt>Identifying Singletons can be difficult.</dt>
<dd>
<p>If you’re importing a large module, you will be unable to recognize that a particular class is a Singleton. As a result, you may accidentally use it as a regular class to instantiate multiple objects and incorrectly update it instead.</p>
</dd>
<dt>Challenging to test.</dt>
<dd>
<p>Singletons can be more difficult to test<a data-type="indexterm" data-primary="dependencies" data-secondary="Singleton hidden dependencies" id="idm45017708338000"/><a data-type="indexterm" data-primary="testing" data-secondary="Singletons and hidden dependencies" id="idm45017708337056"/> due to issues ranging from hidden dependencies, difficulty creating multiple instances, difficulty in stubbing dependencies, and so on.</p>
</dd>
<dt>Need for careful orchestration.</dt>
<dd>
<p>An everyday use case for Singletons would be to store data that will be required across the global scope, such as user credentials or cookie data that can be set once and consumed by multiple components. Implementing the correct execution order becomes essential so that data is always consumed after it becomes available and not the other way around. This may become challenging as the application grows in size and complexity.</p>
</dd>
</dl>








<section data-type="sect2" data-pdf-bookmark="State Management in React"><div class="sect2" id="idm45017708334512">
<h2>State Management in React</h2>

<p>Developers using React for web development<a data-type="indexterm" data-primary="React (React.js)" data-secondary="state management" id="idm45017708333152"/><a data-type="indexterm" data-primary="global state in React state management" id="idm45017708332176"/><a data-type="indexterm" data-primary="Singleton pattern" data-secondary="Redux or React Context for global state management" id="idm45017708331536"/><a data-type="indexterm" data-primary="Redux" data-secondary="global state management" id="idm45017708330496"/><a data-type="indexterm" data-primary="React Context for global state management" id="idm45017708329552"/><a data-type="indexterm" data-primary="state management" data-secondary="Redux or React Context for" id="idm45017708328848"/> can rely on the global state through state management tools such as Redux or React Context instead of Singletons. Unlike Singletons, these tools provide a read-only state rather than the mutable state.</p>

<p>Although the downsides to having a global state don’t magically disappear by using these tools, we can at least ensure that the global state is mutated the way we intend it to because components cannot update it directly.<a data-type="indexterm" data-startref="ch07-sing" id="idm45017708327424"/><a data-type="indexterm" data-startref="ch07-sing2" id="idm45017708326720"/><a data-type="indexterm" data-startref="ch07-sing3" id="idm45017708326048"/><a data-type="indexterm" data-startref="ch07-sing4" id="idm45017708325376"/><a data-type="indexterm" data-startref="ch07-sing5" id="idm45017708324704"/></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Prototype Pattern"><div class="sect1" id="the-prototype-pattern">
<h1>The Prototype Pattern</h1>

<p>The GoF refers to the Prototype pattern as one that creates objects based on a template of an existing object through cloning.<a data-type="indexterm" data-primary="Design Patterns: Elements of Reusable Object-Oriented Software (Gamma, Helm, Johnson, and Vlissides)" data-secondary="Prototype pattern" id="idm45017708321952"/><a data-type="indexterm" data-primary="Gamma, Erich" id="idm45017708320960"/><a data-type="indexterm" data-primary="Helm, Richard" id="idm45017708320288"/><a data-type="indexterm" data-primary="Johnson, Ralph" id="idm45017708319616"/><a data-type="indexterm" data-primary="Vlissides, John" id="idm45017708318944"/><a data-type="indexterm" data-primary="Prototype pattern" id="ch07-prot"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="creational design patterns" data-tertiary="Prototype pattern" id="ch07-prot2"/><a data-type="indexterm" data-primary="creational design patterns" data-secondary="Prototype pattern" id="ch07-prot3"/><a data-type="indexterm" data-primary="Prototype pattern" data-secondary="about" id="idm45017708314624"/></p>

<p>We can think of the Prototype pattern as being based on prototypal inheritance, where we create objects that act as prototypes for other objects. The <code>prototype</code> object is effectively used as a blueprint for each object the constructor creates. For example, if the prototype of the constructor function used contains a property called <code>name</code> (as per the code sample that follows), then each object created by that constructor will also have this same property. Refer to <a data-type="xref" href="#prototype">Figure 7-3</a> for an illustration.</p>

<figure><div id="prototype" class="figure">
<img src="Images/ljd2_0703.png" alt="ljd2 0703" width="859" height="513"/>
<h6><span class="label">Figure 7-3. </span>Prototype pattern</h6>
</div></figure>

<p>Reviewing the definitions for this pattern in existing (non-JavaScript) literature, we <em>may</em> find references to classes once again. <a data-type="indexterm" data-primary="classes" data-secondary="Prototype pattern inheritance versus" id="idm45017708308800"/><a data-type="indexterm" data-primary="inheritance" data-secondary="prototypes for" id="idm45017708307808"/><a data-type="indexterm" data-primary="Prototype pattern" data-secondary="inheritance without classes" id="idm45017708306864"/>The reality is that prototypal inheritance avoids using classes altogether. There isn’t a “definition” object nor a core object in theory; we’re simply creating copies of existing functional objects.</p>

<p>One of the benefits of using the Prototype pattern is that we’re working with the prototypal strengths JavaScript has to offer natively rather than attempting to imitate features of other languages. With other design patterns, this isn’t always the case.</p>

<p>Not only is the pattern an easy way to implement inheritance, but it can also come with a performance boost. When defining functions in an object, they’re all created by reference (so all child objects point to the same functions), instead of creating individual copies.</p>

<p>With ES2015+, we can use classes and constructors to create objects. While this ensures that our code looks cleaner and follows object-oriented analysis and design (OOAD) principles, the classes and constructors get compiled down to functions and prototypes internally. This ensures that we are still working with the prototypal strengths of JavaScript and the accompanying performance boost.</p>

<p>For those interested, real prototypal inheritance,<a data-type="indexterm" data-primary="Prototype pattern" data-secondary="Object.create for real prototypal inheritance" id="idm45017708303920"/><a data-type="indexterm" data-primary="inheritance" data-secondary="prototypes for" data-tertiary="Object.create required" id="idm45017708302848"/><a data-type="indexterm" data-primary="Object constructor" data-secondary="Object.create" data-tertiary="prototypal inheritance requiring" id="idm45017708301632"/><a data-type="indexterm" data-primary="objects" data-secondary="inheritance" data-see="inheritance" id="idm45017708300448"/> as defined in the ECMAScript 5 standard, requires the use of <code>Object.create</code> (which we looked at earlier in this 
<span class="keep-together">section).</span> To review, <code>Object.create</code> creates an object with a specified prototype 
<span class="keep-together">and optionally</span> contains specified properties (e.g., <code>Object.create( prototype, 
<span class="keep-together">optionalDescriptorObjects )</span></code>).</p>

<p>We can see this demonstrated in the following example:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">myCar</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s1">'Ford Escort'</code><code class="p">,</code>

    <code class="nx">drive</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"Weeee. I'm driving!"</code><code class="p">);</code>
    <code class="p">},</code>

    <code class="nx">panic</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Wait. How do you stop this thing?'</code><code class="p">);</code>
    <code class="p">},</code>
<code class="p">};</code>

<code class="c1">// Use Object.create to instantiate a new car</code>
<code class="kr">const</code> <code class="nx">yourCar</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">myCar</code><code class="p">);</code>

<code class="c1">// Now we can see that one is a prototype of the other</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">yourCar</code><code class="p">.</code><code class="nx">name</code><code class="p">);</code></pre>

<p><code>Object.create</code> also allows us to easily implement<a data-type="indexterm" data-primary="inheritance" data-secondary="differential inheritance" id="idm45017708240928"/><a data-type="indexterm" data-primary="Object constructor" data-secondary="Object.create" data-tertiary="differential inheritance" id="idm45017708251664"/><a data-type="indexterm" data-primary="differential inheritance" id="idm45017708250512"/> advanced concepts such as differential inheritance, where objects are able to directly inherit from other objects. We saw earlier that <code>Object.create</code> allows us to initialize object properties using the second supplied argument. For example:<a data-type="indexterm" data-primary="Object constructor" data-secondary="assigning keys and values" id="idm45017708249248"/><a data-type="indexterm" data-primary="Object constructor" data-secondary="Object.create" data-tertiary="initializing properties" id="idm45017708248304"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">vehicle</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">getModel</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`The model of this vehicle is...</code><code class="si">${</code><code class="k">this</code><code class="p">.</code><code class="nx">model</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
    <code class="p">},</code>
<code class="p">};</code>

<code class="kr">const</code> <code class="nx">car</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">vehicle</code><code class="p">,</code> <code class="p">{</code>
    <code class="nx">id</code><code class="o">:</code> <code class="p">{</code>
        <code class="nx">value</code><code class="o">:</code> <code class="nx">MY_GLOBAL</code><code class="p">.</code><code class="nx">nextId</code><code class="p">(),</code>
        <code class="c1">// writable:false, configurable:false by default</code>
        <code class="nx">enumerable</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="p">},</code>

    <code class="nx">model</code><code class="o">:</code> <code class="p">{</code>
        <code class="nx">value</code><code class="o">:</code> <code class="s1">'Ford'</code><code class="p">,</code>
        <code class="nx">enumerable</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="p">},</code>
<code class="p">});</code></pre>

<p>Here, you can initialize the properties on the second argument of <code>Object.create</code> using an object literal with a syntax similar to that used by the 
<span class="keep-together"><code>Object.defineProperties</code></span> and <code>Object.defineProperty</code> methods that we looked at previously.</p>

<p>It is worth noting that prototypal relationships can cause trouble when enumerating properties of objects and (as Crockford recommends) wrapping the contents of the loop in a <code>hasOwnProperty()</code> check.</p>

<p>If we wish to implement the Prototype pattern<a data-type="indexterm" data-primary="Prototype pattern" data-secondary="Object.create not directly used" id="idm45017708152208"/><a data-type="indexterm" data-primary="extends keyword for class inheritance" data-secondary="Prototype pattern" id="idm45017708151264"/><a data-type="indexterm" data-primary="inheritance" data-secondary="extends keyword" data-tertiary="Prototype pattern" id="idm45017708150352"/><a data-type="indexterm" data-primary="inheritance" data-secondary="prototypes for" data-tertiary="Object.create not directly used" id="idm45017708102640"/><a data-type="indexterm" data-primary="constructor() method" data-secondary="Prototype pattern" id="idm45017708101552"/> without directly using <code>Object.create</code>, we can simulate the pattern as per the previous example as follows:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">VehiclePrototype</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">(</code><code class="nx">model</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">model</code> <code class="o">=</code> <code class="nx">model</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">getModel</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`The model of this vehicle is... </code><code class="si">${</code><code class="k">this</code><code class="p">.</code><code class="nx">model</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="nx">clone</code><code class="p">()</code> <code class="p">{}</code>
<code class="p">}</code>

<code class="kr">class</code> <code class="nx">Vehicle</code> <code class="kr">extends</code> <code class="nx">VehiclePrototype</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">(</code><code class="nx">model</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">super</code><code class="p">(</code><code class="nx">model</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="nx">clone</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Vehicle</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">model</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">car</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Vehicle</code><code class="p">(</code><code class="s1">'Ford Escort'</code><code class="p">);</code>
<code class="kr">const</code> <code class="nx">car2</code> <code class="o">=</code> <code class="nx">car</code><code class="p">.</code><code class="nx">clone</code><code class="p">();</code>
<code class="nx">car2</code><code class="p">.</code><code class="nx">getModel</code><code class="p">();</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>This alternative does not allow the user to define read-only properties in the same manner (as the <code>vehiclePrototype</code> may be altered if not careful).</p>
</div>

<p>A final alternative implementation of the Prototype pattern could be the following:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">beget</code> <code class="o">=</code> <code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="kr">class</code> <code class="nx">F</code> <code class="p">{</code>
        <code class="nx">constructor</code><code class="p">()</code> <code class="p">{}</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="nx">proto</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="nx">F</code><code class="p">.</code><code class="nx">prototype</code> <code class="o">=</code> <code class="nx">proto</code><code class="p">;</code>
        <code class="k">return</code> <code class="k">new</code> <code class="nx">F</code><code class="p">();</code>
    <code class="p">};</code>
<code class="p">})();</code></pre>

<p>One could reference this method from the <code>vehicle</code> function. However, note that 
<span class="keep-together"><code>vehicle</code></span> here emulates a constructor since the Prototype pattern does not include any notion of initialization beyond linking an object to a prototype.<a data-type="indexterm" data-startref="ch07-prot" id="idm45017707942064"/><a data-type="indexterm" data-startref="ch07-prot2" id="idm45017707941424"/><a data-type="indexterm" data-startref="ch07-prot3" id="idm45017707940752"/></p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Factory Pattern"><div class="sect1" id="the-factory-pattern">
<h1>The Factory Pattern</h1>

<p>The Factory pattern is another creational pattern<a data-type="indexterm" data-primary="Factory pattern" id="ch07-fact"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="creational design patterns" data-tertiary="Factory pattern" id="ch07-fact2"/><a data-type="indexterm" data-primary="creational design patterns" data-secondary="Factory pattern" id="ch07-fact3"/><a data-type="indexterm" data-primary="Factory pattern" data-secondary="about" id="ch07-facta"/> for creating objects. It differs from the other patterns in its category because it doesn’t explicitly require us to use a constructor. Instead, a Factory can provide a generic interface for creating objects, where we can specify the type of Factory object we want to create (<a data-type="xref" href="#factory">Figure 7-4</a>).</p>

<figure><div id="factory" class="figure">
<img src="Images/ljd2_0704.png" alt="ljd2 0704" width="685" height="465"/>
<h6><span class="label">Figure 7-4. </span>Factory pattern</h6>
</div></figure>

<p>Imagine a UI factory where we want to create<a data-type="indexterm" data-primary="constructor() method" data-secondary="Factory pattern" id="ch07-factcon"/> a type of UI component. Rather than creating this component directly using the <code>new</code> operator or another creational constructor, we ask a Factory object for a new component instead. We inform the Factory what type of object is required (e.g., “Button”, “Panel”), and it instantiates it and returns it to us for use.</p>

<p>This is particularly useful if the object creation process is relatively complex, e.g., if it strongly depends on dynamic factors or application configuration.</p>

<p>The following example builds upon our previous snippets using the Constructor pattern logic to define cars. It demonstrates how a <code>VehicleFactory</code> may be implemented using the Factory pattern:</p>

<pre data-type="programlisting" data-code-language="javascript" class="less_space pagebreak-before"><code class="c1">// Types.js - Classes used behind the scenes</code>
<code class="c1">// A class for defining new cars</code>
<code class="kr">class</code> <code class="nx">Car</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">({</code> <code class="nx">doors</code> <code class="o">=</code> <code class="mi">4</code><code class="p">,</code> <code class="nx">state</code> <code class="o">=</code> <code class="s1">'brand new'</code><code class="p">,</code> <code class="nx">color</code> <code class="o">=</code> <code class="s1">'silver'</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{})</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">doors</code> <code class="o">=</code> <code class="nx">doors</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">state</code> <code class="o">=</code> <code class="nx">state</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// A class for defining new trucks</code>
<code class="kr">class</code> <code class="nx">Truck</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">({</code> <code class="nx">state</code> <code class="o">=</code> <code class="s1">'used'</code><code class="p">,</code> <code class="nx">wheelSize</code> <code class="o">=</code> <code class="s1">'large'</code><code class="p">,</code> <code class="nx">color</code> <code class="o">=</code> <code class="s1">'blue'</code> <code class="p">}</code> <code class="o">=</code> <code class="p">{})</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">state</code> <code class="o">=</code> <code class="nx">state</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">wheelSize</code> <code class="o">=</code> <code class="nx">wheelSize</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// FactoryExample.js</code>
<code class="c1">// Define a vehicle factory</code>
<code class="kr">class</code> <code class="nx">VehicleFactory</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">vehicleClass</code> <code class="o">=</code> <code class="nx">Car</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="c1">// Our Factory method for creating new Vehicle instances</code>
  <code class="nx">createVehicle</code><code class="p">(</code><code class="nx">options</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="p">{</code> <code class="nx">vehicleType</code><code class="p">,</code> <code class="p">...</code><code class="nx">rest</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">options</code><code class="p">;</code>

    <code class="k">switch</code> <code class="p">(</code><code class="nx">vehicleType</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">case</code> <code class="s1">'car'</code><code class="o">:</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">vehicleClass</code> <code class="o">=</code> <code class="nx">Car</code><code class="p">;</code>
        <code class="k">break</code><code class="p">;</code>
      <code class="k">case</code> <code class="s1">'truck'</code><code class="o">:</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">vehicleClass</code> <code class="o">=</code> <code class="nx">Truck</code><code class="p">;</code>
        <code class="k">break</code><code class="p">;</code>
      <code class="c1">// defaults to VehicleFactory.prototype.vehicleClass (Car)</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="k">new</code> <code class="k">this</code><code class="p">.</code><code class="nx">vehicleClass</code><code class="p">(</code><code class="nx">rest</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Create an instance of our factory that makes cars</code>
<code class="kr">const</code> <code class="nx">carFactory</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">VehicleFactory</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">car</code> <code class="o">=</code> <code class="nx">carFactory</code><code class="p">.</code><code class="nx">createVehicle</code><code class="p">({</code>
  <code class="nx">vehicleType</code><code class="o">:</code> <code class="s1">'car'</code><code class="p">,</code>
  <code class="nx">color</code><code class="o">:</code> <code class="s1">'yellow'</code><code class="p">,</code>
  <code class="nx">doors</code><code class="o">:</code> <code class="mi">6</code><code class="p">,</code>
<code class="p">});</code>

<code class="c1">// Test to confirm our car was created using the vehicleClass/prototype Car</code>
<code class="c1">// Outputs: true</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">car</code> <code class="k">instanceof</code> <code class="nx">Car</code><code class="p">);</code>
<code class="c1">// Outputs: Car object of color "yellow", doors: 6 in a "brand new" state</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">car</code><code class="p">);</code></pre>

<p>We have defined the car and truck classes with constructors that set properties relevant to the respective vehicle. The <code>VehicleFactory</code> can create a new vehicle object, <code>Car</code>, or <code>Truck</code> based on the <code>vehicleType</code> passed.</p>

<p>There are two possible approaches to building trucks using the <code>VehicleFactory</code> class.</p>

<p>In Approach 1, we modify a <code>VehicleFactory</code> instance to use the <code>Truck</code> class:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">movingTruck</code> <code class="o">=</code> <code class="nx">carFactory</code><code class="p">.</code><code class="nx">createVehicle</code><code class="p">({</code>
    <code class="nx">vehicleType</code><code class="o">:</code> <code class="s1">'truck'</code><code class="p">,</code>
    <code class="nx">state</code><code class="o">:</code> <code class="s1">'like new'</code><code class="p">,</code>
    <code class="nx">color</code><code class="o">:</code> <code class="s1">'red'</code><code class="p">,</code>
    <code class="nx">wheelSize</code><code class="o">:</code> <code class="s1">'small'</code><code class="p">,</code>
<code class="p">});</code>

<code class="c1">// Test to confirm our truck was created with the vehicleClass/prototype Truck</code>

<code class="c1">// Outputs: true</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">movingTruck</code> <code class="k">instanceof</code> <code class="nx">Truck</code><code class="p">);</code>

<code class="c1">// Outputs: Truck object of color "red", a "like new" state</code>
<code class="c1">// and a "small" wheelSize</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">movingTruck</code><code class="p">);</code></pre>

<p>In Approach 2, we subclass <code>VehicleFactory</code> to create a factory class that builds <code>Trucks</code>:<a data-type="indexterm" data-startref="ch07-facta" id="idm45017707579104"/><a data-type="indexterm" data-startref="ch07-factcon" id="idm45017707578464"/><a data-type="indexterm" data-primary="extends keyword for class inheritance" data-secondary="Factory pattern" id="idm45017707577792"/><a data-type="indexterm" data-primary="inheritance" data-secondary="extends keyword" data-tertiary="Factory pattern" id="idm45017707576880"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">TruckFactory</code> <code class="kr">extends</code> <code class="nx">VehicleFactory</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">();</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">vehicleClass</code> <code class="o">=</code> <code class="nx">Truck</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="kr">const</code> <code class="nx">truckFactory</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">TruckFactory</code><code class="p">();</code>
<code class="kr">const</code> <code class="nx">myBigTruck</code> <code class="o">=</code> <code class="nx">truckFactory</code><code class="p">.</code><code class="nx">createVehicle</code><code class="p">({</code>
    <code class="nx">state</code><code class="o">:</code> <code class="s1">'omg...so bad.'</code><code class="p">,</code>
    <code class="nx">color</code><code class="o">:</code> <code class="s1">'pink'</code><code class="p">,</code>
    <code class="nx">wheelSize</code><code class="o">:</code> <code class="s1">'so big'</code><code class="p">,</code>
<code class="p">});</code>

<code class="c1">// Confirms that myBigTruck was created with the prototype Truck</code>
<code class="c1">// Outputs: true</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">myBigTruck</code> <code class="k">instanceof</code> <code class="nx">Truck</code><code class="p">);</code>

<code class="c1">// Outputs: Truck object with the color "pink", wheelSize "so big"</code>
<code class="c1">// and state "omg. so bad"</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">myBigTruck</code><code class="p">);</code></pre>








<section data-type="sect2" data-pdf-bookmark="When to Use the Factory Pattern"><div class="sect2" id="when-to-use-the-factory-pattern">
<h2>When to Use the Factory Pattern</h2>

<p>The Factory pattern can be beneficial when applied to the following situations:<a data-type="indexterm" data-primary="Factory pattern" data-secondary="when to use" id="idm45017707478224"/></p>

<ul>
<li>
<p>When our object or component setup involves a high level of complexity.</p>
</li>
<li>
<p>When we need a convenient way to generate different instances of objects depending on the environment we are in.</p>
</li>
<li>
<p>When we’re working with many small objects or components that share the same properties.</p>
</li>
<li>
<p>When composing objects with instances of other objects that need only satisfy an API contract (aka, duck typing) to work. This is useful for decoupling.</p>
</li>
</ul>
</div></section>








<section data-type="sect2" data-pdf-bookmark="When Not to Use the Factory Pattern"><div class="sect2" id="when-not-to-use-the-factory-pattern">
<h2>When Not to Use the Factory Pattern</h2>

<p>When applied to the wrong type of problem,<a data-type="indexterm" data-primary="Factory pattern" data-secondary="when not to use" id="idm45017707471376"/> this pattern can introduce a large amount of unnecessary complexity to an application. Unless providing an interface for object creation is a design goal for the library or framework we are writing, I would suggest sticking to explicit constructors to avoid undue overhead.</p>

<p>Since the process of object creation<a data-type="indexterm" data-primary="testing" data-secondary="Factory pattern abstracted object creation" id="idm45017707413504"/> is effectively abstracted behind an interface, this can also introduce problems with unit testing, depending on just how complex this process might be.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Abstract Factories"><div class="sect2" id="abstract-factories">
<h2>Abstract Factories</h2>

<p>It’s also worthwhile to be aware of the<a data-type="indexterm" data-primary="Factory pattern" data-secondary="Abstract Factory pattern" id="idm45017707410384"/><a data-type="indexterm" data-primary="Abstract Factory pattern" id="idm45017707409440"/><a data-type="indexterm" data-primary="constructor() method" data-secondary="Factory pattern" data-tertiary="Abstract Factory pattern" id="idm45017707408752"/> Abstract Factory pattern, which aims to encapsulate a group of individual factories with a common goal. It separates the details of implementing a set of objects from their general usage.</p>

<p>You can use an Abstract Factory when a system must be independent of how the objects it creates are generated, or it needs to work with multiple types of objects.</p>

<p>An example that is both simple and easier to understand is a vehicle factory, 
<span class="keep-together">which defines</span> ways to get or register vehicle types. The Abstract Factory can be named <code>AbstractVehicleFactory</code>. The Abstract Factory will allow the definition of types of vehicles like  <code>car</code> or <code>truck</code>, and concrete factories will implement only 
<span class="keep-together">classes that fulfill</span> the vehicle contract (e.g., <code>Vehicle.prototype.drive</code> <a data-type="indexterm" data-startref="ch07-fact" id="idm45017707403104"/><a data-type="indexterm" data-startref="ch07-fact2" id="idm45017707402368"/><a data-type="indexterm" data-startref="ch07-fact3" id="idm45017707401696"/>and 
<span class="keep-together"><code>Vehicle.prototype.breakDown</code>):</span></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">AbstractVehicleFactory</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
    <code class="c1">// Storage for our vehicle types</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">types</code> <code class="o">=</code> <code class="p">{};</code>
  <code class="p">}</code>

  <code class="nx">getVehicle</code><code class="p">(</code><code class="nx">type</code><code class="p">,</code> <code class="nx">customizations</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">Vehicle</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">types</code><code class="p">[</code><code class="nx">type</code><code class="p">];</code>
    <code class="k">return</code> <code class="nx">Vehicle</code> <code class="o">?</code> <code class="k">new</code> <code class="nx">Vehicle</code><code class="p">(</code><code class="nx">customizations</code><code class="p">)</code> <code class="o">:</code> <code class="kc">null</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">registerVehicle</code><code class="p">(</code><code class="nx">type</code><code class="p">,</code> <code class="nx">Vehicle</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">proto</code> <code class="o">=</code> <code class="nx">Vehicle</code><code class="p">.</code><code class="nx">prototype</code><code class="p">;</code>
    <code class="c1">// only register classes that fulfill the vehicle contract</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">proto</code><code class="p">.</code><code class="nx">drive</code> <code class="o">&amp;&amp;</code> <code class="nx">proto</code><code class="p">.</code><code class="nx">breakDown</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">types</code><code class="p">[</code><code class="nx">type</code><code class="p">]</code> <code class="o">=</code> <code class="nx">Vehicle</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Usage:</code>
<code class="kr">const</code> <code class="nx">abstractVehicleFactory</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">AbstractVehicleFactory</code><code class="p">();</code>
<code class="nx">abstractVehicleFactory</code><code class="p">.</code><code class="nx">registerVehicle</code><code class="p">(</code><code class="s1">'car'</code><code class="p">,</code> <code class="nx">Car</code><code class="p">);</code>
<code class="nx">abstractVehicleFactory</code><code class="p">.</code><code class="nx">registerVehicle</code><code class="p">(</code><code class="s1">'truck'</code><code class="p">,</code> <code class="nx">Truck</code><code class="p">);</code>

<code class="c1">// Instantiate a new car based on the abstract vehicle type</code>
<code class="kr">const</code> <code class="nx">car</code> <code class="o">=</code> <code class="nx">abstractVehicleFactory</code><code class="p">.</code><code class="nx">getVehicle</code><code class="p">(</code><code class="s1">'car'</code><code class="p">,</code> <code class="p">{</code>
  <code class="nx">color</code><code class="o">:</code> <code class="s1">'lime green'</code><code class="p">,</code>
  <code class="nx">state</code><code class="o">:</code> <code class="s1">'like new'</code><code class="p">,</code>
<code class="p">});</code>

<code class="c1">// Instantiate a new truck in a similar manner</code>
<code class="kr">const</code> <code class="nx">truck</code> <code class="o">=</code> <code class="nx">abstractVehicleFactory</code><code class="p">.</code><code class="nx">getVehicle</code><code class="p">(</code><code class="s1">'truck'</code><code class="p">,</code> <code class="p">{</code>
  <code class="nx">wheelSize</code><code class="o">:</code> <code class="s1">'medium'</code><code class="p">,</code>
  <code class="nx">color</code><code class="o">:</code> <code class="s1">'neon yellow'</code><code class="p">,</code>
<code class="p">});</code></pre>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Structural Patterns"><div class="sect1" id="javascript-design-patterns-structural">
<h1>Structural Patterns</h1>

<p>Structural patterns deal with class<a data-type="indexterm" data-primary="structural design patterns" data-secondary="about" id="idm45017707394768"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="structural design patterns" data-tertiary="about" id="idm45017707393824"/> and object composition. For example,  the concept of inheritance allows us to compose interfaces and objects so that they can obtain new functionality. Structural patterns provide the best methods and practices to organize classes and objects.</p>

<p>Following are the JavaScript structural patterns that we will discuss in this 
<span class="keep-together">section:</span></p>

<ul>
<li>
<p><a data-type="xref" href="#the-facade-pattern">“The Facade Pattern”</a></p>
</li>
<li>
<p><a data-type="xref" href="#the-mixin-pattern">“The Mixin Pattern”</a></p>
</li>
<li>
<p><a data-type="xref" href="#the-decorator-pattern">“The Decorator Pattern”</a></p>
</li>
<li>
<p><a data-type="xref" href="#flyweight">“Flyweight”</a></p>
</li>
</ul>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Facade Pattern"><div class="sect1" id="the-facade-pattern">
<h1>The Facade Pattern</h1>

<p>When we put up a facade, we present<a data-type="indexterm" data-primary="categories of design patterns" data-secondary="structural design patterns" data-tertiary="Facade pattern" id="ch07-facd"/><a data-type="indexterm" data-primary="Facade pattern" id="ch07-facd2"/><a data-type="indexterm" data-primary="structural design patterns" data-secondary="Facade pattern" id="ch07-facd3"/><a data-type="indexterm" data-primary="APIs" data-secondary="Facade pattern" id="ch07-facd4"/><a data-type="indexterm" data-primary="Facade pattern" data-secondary="about" id="idm45017707169712"/> an outward appearance to the world, which may conceal a very different reality. This inspired the name for the next pattern we’ll review—the Facade pattern. This pattern provides a convenient higher-level interface to a larger body of code, hiding its true underlying complexity. Think of it as simplifying the API being presented to other developers, a quality that almost always improves usability (see <a data-type="xref" href="#facade">Figure 7-5</a>).</p>

<figure><div id="facade" class="figure">
<img src="Images/ljd2_0705.png" alt="ljd2 0705" width="922" height="761"/>
<h6><span class="label">Figure 7-5. </span>Facade pattern</h6>
</div></figure>

<p>Facades are a structural pattern<a data-type="indexterm" data-primary="jQuery" data-secondary="Facades and" id="idm45017707165424"/><a data-type="indexterm" data-primary="Facade pattern" data-secondary="jQuery and Facades" id="idm45017707164448"/> that can often be seen in JavaScript libraries such as jQuery where, although an implementation may support methods with a wide range of behaviors, only a “facade,” or limited abstraction of these methods, is presented to the public for use.</p>

<p>This allows us to interact with the Facade directly rather than the subsystem behind the scenes. Whenever we use jQuery’s <code>$(el).css()</code> or <code>$(el).animate()</code> methods, we’re using a Facade: the simpler public interface that lets us avoid manually calling the many internal methods in jQuery core required to get some behavior working. This also circumvents the need to interact manually with DOM APIs and maintain state variables.</p>

<p>The jQuery core methods should be considered intermediate abstractions. The more immediate burden to developers is that the DOM API and Facades make the jQuery library so easy to use.</p>

<p>To build on what we’ve learned, <a data-type="indexterm" data-primary="decoupling" data-secondary="class from code via Facade pattern" id="idm45017707161248"/><a data-type="indexterm" data-primary="classes" data-secondary="Facade pattern decoupling from code" id="idm45017707160208"/>the Facade pattern simplifies a class’s interface and decouples the class from the code that uses it. This allows us to interact indirectly with subsystems in a way that can sometimes be less error-prone than accessing the subsystem directly. <a data-type="indexterm" data-primary="Facade pattern" data-secondary="advantages" id="idm45017707159120"/>A Facade’s advantages include ease of use and often a small-sized footprint in implementing the pattern.</p>

<p>Let’s take a look at the pattern in action.<a data-type="indexterm" data-primary="Facade pattern" data-secondary="examples" id="ch07-facex"/><a data-type="indexterm" data-primary="browsers" data-secondary="Facade listening to events across browsers" id="idm45017707156288"/><a data-type="indexterm" data-primary="events" data-secondary="Facade listening to events across browsers" id="idm45017707155376"/> This is an unoptimized code example, but here we’re using a Facade to simplify an interface for listening to events across browsers. We do this by creating a common method  that does the task of checking for the existence of features so that it can provide a safe and cross-browser-compatible 
<span class="keep-together">solution:</span></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">addMyEvent</code> <code class="o">=</code> <code class="p">(</code><code class="nx">el</code><code class="p">,</code> <code class="nx">ev</code><code class="p">,</code> <code class="nx">fn</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">el</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">el</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="nx">ev</code><code class="p">,</code> <code class="nx">fn</code><code class="p">,</code> <code class="kc">false</code><code class="p">);</code>
    <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">el</code><code class="p">.</code><code class="nx">attachEvent</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">el</code><code class="p">.</code><code class="nx">attachEvent</code><code class="p">(</code><code class="sb">`on</code><code class="si">${</code><code class="nx">ev</code><code class="si">}</code><code class="sb">`</code><code class="p">,</code> <code class="nx">fn</code><code class="p">);</code>
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
      <code class="nx">el</code><code class="p">[</code><code class="sb">`on</code><code class="si">${</code><code class="nx">ev</code><code class="si">}</code><code class="sb">`</code><code class="p">]</code> <code class="o">=</code> <code class="nx">fn</code><code class="p">;</code>
    <code class="p">}</code>
  <code class="p">};</code></pre>

<p>In a similar manner, we’re all familiar with jQuery’s <code>$(document).ready(…​)</code>. Internally, this is powered by a method called <code>bindReady()</code>, which is doing this:<a data-type="indexterm" data-primary="jQuery" data-secondary="Facades and" data-tertiary="$(document).ready(…​)" data-tertiary-sortas="document.ready" id="idm45017707130608"/><a data-type="indexterm" data-primary="Facade pattern" data-secondary="jQuery and Facades" data-tertiary="$(document).ready(…​)" data-tertiary-sortas="document.ready" id="idm45017707101184"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kd">function</code> <code class="nx">bindReady</code><code class="p">()</code> <code class="p">{</code>
  <code class="c1">// Use the handy event callback</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'DOMContentLoaded'</code><code class="p">,</code> <code class="nx">DOMContentLoaded</code><code class="p">,</code> <code class="kc">false</code><code class="p">);</code>
  <code class="c1">// A fallback to window.onload, that will always work</code>
  <code class="nb">window</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'load'</code><code class="p">,</code> <code class="nx">jQuery</code><code class="p">.</code><code class="nx">ready</code><code class="p">,</code> <code class="kc">false</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>This is another example of a Facade where the rest of the world uses the limited interface exposed by <code>$(document).ready(…​)</code>, and the more complex implementation powering it is kept hidden from sight.</p>

<p>Facades don’t just have to be used<a data-type="indexterm" data-primary="Facade pattern" data-secondary="Module pattern with" id="idm45017707016656"/><a data-type="indexterm" data-primary="Module pattern" data-secondary="Facade pattern with" id="idm45017707015808"/> on their own, however. You can also integrate them with other patterns, such as the Module pattern. As we can see next, our instance of the Module pattern contains a number of methods that have been privately defined. A Facade is then used to supply a much simpler API for accessing these methods:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// privateMethods.js</code>
<code class="kr">const</code> <code class="nx">_private</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">i</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code>
  <code class="nx">get</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`current value: </code><code class="si">${</code><code class="k">this</code><code class="p">.</code><code class="nx">i</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
  <code class="p">},</code>
  <code class="nx">set</code><code class="p">(</code><code class="nx">val</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">i</code> <code class="o">=</code> <code class="nx">val</code><code class="p">;</code>
  <code class="p">},</code>
  <code class="nx">run</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'running'</code><code class="p">);</code>
  <code class="p">},</code>
  <code class="nx">jump</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'jumping'</code><code class="p">);</code>
  <code class="p">},</code>
<code class="p">};</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">_private</code><code class="p">;</code>

<code class="c1">// module.js</code>
<code class="kr">import</code> <code class="nx">_private</code> <code class="nx">from</code> <code class="s1">'./privateMethods.js'</code><code class="p">;</code>

<code class="kr">const</code> <code class="nx">module</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">facade</code><code class="p">({</code> <code class="nx">val</code><code class="p">,</code> <code class="nx">run</code> <code class="p">})</code> <code class="p">{</code>
    <code class="nx">_private</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="nx">val</code><code class="p">);</code>
    <code class="nx">_private</code><code class="p">.</code><code class="nx">get</code><code class="p">();</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">run</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">_private</code><code class="p">.</code><code class="nx">run</code><code class="p">();</code>
    <code class="p">}</code>
  <code class="p">},</code>
<code class="p">};</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">module</code><code class="p">;</code>

<code class="c1">// index.js</code>
<code class="kr">import</code> <code class="nx">module</code> <code class="nx">from</code> <code class="s1">'./module.js'</code><code class="p">;</code>

<code class="c1">// Outputs: "current value: 10" and "running"</code>
<code class="nx">module</code><code class="p">.</code><code class="nx">facade</code><code class="p">({</code>
  <code class="nx">run</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
  <code class="nx">val</code><code class="o">:</code> <code class="mi">10</code><code class="p">,</code>
<code class="p">});</code></pre>

<p>In this example, calling <code>module.facade()</code> will trigger a set of private behavior within the module, but the users aren’t concerned with this. We’ve made it much easier for them to consume a feature without worrying about implementation-level details.<a data-type="indexterm" data-startref="ch07-facd" id="idm45017707011504"/><a data-type="indexterm" data-startref="ch07-facd2" id="idm45017707010896"/><a data-type="indexterm" data-startref="ch07-facd3" id="idm45017707010256"/><a data-type="indexterm" data-startref="ch07-facd4" id="idm45017706895424"/><a data-type="indexterm" data-startref="ch07-facex" id="idm45017706894752"/></p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Mixin Pattern"><div class="sect1" id="the-mixin-pattern">
<h1>The Mixin Pattern</h1>

<p>In traditional programming languages<a data-type="indexterm" data-primary="Mixin pattern" id="ch07-mix"/><a data-type="indexterm" data-primary="structural design patterns" data-secondary="Mixin pattern" id="ch07-mix2"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="structural design patterns" data-tertiary="Mixin pattern" id="ch07-mix3"/><a data-type="indexterm" data-primary="Mixin pattern" data-secondary="about Mixins" id="idm45017706888928"/> such as C++ and Lisp, Mixins are classes that offer functionality that a subclass or group of subclasses can easily inherit for function reuse.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Subclassing"><div class="sect1" id="sub-classing">
<h1>Subclassing</h1>

<p>We have already introduced the ES2015+ features<a data-type="indexterm" data-primary="Mixin pattern" data-secondary="subclassing" id="idm45017706786656"/><a data-type="indexterm" data-primary="subclasses" data-secondary="subclassing" id="idm45017706785808"/><a data-type="indexterm" data-primary="classes" data-secondary="subclasses" data-tertiary="subclassing" id="idm45017706784896"/><a data-type="indexterm" data-primary="classes" data-secondary="subclasses" id="idm45017706783680"/><a data-type="indexterm" data-primary="subclasses" data-secondary="about" id="idm45017706782736"/><a data-type="indexterm" data-primary="classes" data-secondary="superclasses" id="idm45017706781792"/><a data-type="indexterm" data-primary="superclasses" id="idm45017706780848"/><a data-type="indexterm" data-primary="extends keyword for class inheritance" data-secondary="subclassing" id="idm45017706780176"/><a data-type="indexterm" data-primary="inheritance" data-secondary="extends keyword" data-tertiary="subclassing" id="idm45017706779264"/> that allow us to extend a base or superclass and call the methods in the superclass. The child class that extends the superclass is known as a subclass.</p>

<p>Subclassing refers to inheriting<a data-type="indexterm" data-primary="inheritance" data-secondary="subclassing" id="idm45017706777312"/> properties for a new object from a base or superclass object. A subclass can still define its methods, including those that override methods initially defined in the superclass. <a data-type="indexterm" data-primary="method chaining" id="idm45017706776208"/><a data-type="indexterm" data-primary="superclasses" data-secondary="method chaining" id="idm45017706775536"/><a data-type="indexterm" data-primary="subclasses" data-secondary="method chaining" id="idm45017706774592"/><a data-type="indexterm" data-primary="classes" data-secondary="method chaining" id="idm45017706773648"/><a data-type="indexterm" data-primary="superclasses" data-secondary="constructor chaining" id="idm45017706772704"/><a data-type="indexterm" data-primary="subclasses" data-secondary="constructor chaining" id="idm45017706771760"/><a data-type="indexterm" data-primary="constructor chaining" id="idm45017706770816"/>The method in the subclass can invoke an overridden method in the superclass, known as method chaining. Similarly, it can invoke the superclass’s constructor, which is known as constructor chaining.</p>

<p>To demonstrate subclassing,<a data-type="indexterm" data-primary="constructor() method" data-secondary="defining a class" data-tertiary="subclassing" id="idm45017706769760"/> we first need a base class that can have new instances of itself created. Let’s model this around the concept of a person:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">Person</code><code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">firstName</code><code class="p">,</code> <code class="nx">lastName</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">firstName</code> <code class="o">=</code> <code class="nx">firstName</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">lastName</code> <code class="o">=</code> <code class="nx">lastName</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">gender</code> <code class="o">=</code> <code class="s2">"male"</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="c1">// a new instance of Person can then easily be created as follows:</code>
<code class="kr">const</code> <code class="nx">clark</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Person</code><code class="p">(</code> <code class="s1">'Clark'</code><code class="p">,</code> <code class="s1">'Kent'</code> <code class="p">);</code></pre>

<p>Next, we’ll want to specify a new class that’s a subclass of the existing <code>Person</code> class. Let us imagine we want to add distinct properties to distinguish a <code>Person</code> from a 
<span class="keep-together"><code>Superhero</code></span> while inheriting the properties of the <code>Person</code> superclass. As superheroes share many common traits with ordinary people (e.g., name, gender), this should ideally adequately illustrate how subclassing works:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">Superhero</code> <code class="kr">extends</code> <code class="nx">Person</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">firstName</code><code class="p">,</code> <code class="nx">lastName</code><code class="p">,</code> <code class="nx">powers</code><code class="p">)</code> <code class="p">{</code>
        <code class="c1">// Invoke the superclass constructor</code>
        <code class="kr">super</code><code class="p">(</code><code class="nx">firstName</code><code class="p">,</code> <code class="nx">lastName</code><code class="p">);</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">powers</code> <code class="o">=</code> <code class="nx">powers</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// A new instance of Superhero can be created as follows</code>

<code class="kr">const</code> <code class="nx">SuperMan</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Superhero</code><code class="p">(</code><code class="s1">'Clark'</code><code class="p">,</code><code class="s1">'Kent'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'flight'</code><code class="p">,</code><code class="s1">'heat-vision'</code><code class="p">]);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">SuperMan</code><code class="p">);</code>

<code class="c1">// Outputs Person attributes as well as power</code></pre>

<p>The <code>Superhero</code> constructor creates an instance of the <code>Superhero</code> class, which is an extension of the <code>Person</code> class. Objects of this type have attributes of the classes above it in the chain. If we had set default values in the <code>Person</code> class, <code>Superhero</code> could override any inherited values with values specific to its class.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Mixins"><div class="sect1" id="mixins">
<h1>Mixins</h1>

<p>In JavaScript, we can look at inheriting<a data-type="indexterm" data-primary="Mixin pattern" data-secondary="Mixins" id="ch07-mixn"/><a data-type="indexterm" data-primary="inheritance" data-secondary="Mixins" id="idm45017706636112"/> from Mixins to collect functionality through extension. Each new class we define can have a superclass from which it can inherit methods and properties. Classes can also define their own properties and methods. We can leverage this fact to promote function reuse, as shown in <a data-type="xref" href="#mixins_pattern">Figure 7-6</a>.</p>

<figure><div id="mixins_pattern" class="figure">
<img src="Images/ljd2_0706.png" alt="ljd2 0706" width="685" height="448"/>
<h6><span class="label">Figure 7-6. </span>Mixins</h6>
</div></figure>

<p>Mixins allow objects to borrow (or inherit) functionality from them with minimal complexity. <a data-type="indexterm" data-primary="classes" data-secondary="Mixins extending" id="idm45017706592720"/><a data-type="indexterm" data-primary="classes" data-secondary="subclasses" data-tertiary="Mixins instead" id="idm45017706591872"/><a data-type="indexterm" data-primary="subclasses" data-secondary="Mixins instead" id="idm45017706590720"/>Thus, Mixins are classes with attributes and methods that can be easily shared across several other classes.</p>

<p>While JavaScript classes cannot inherit from multiple superclasses, we can still mix functionality from various classes. A class in JavaScript can be used as an expression as well as a statement. As an expression, it returns a new class each time it’s evaluated. <a data-type="indexterm" data-primary="extends keyword for class inheritance" data-secondary="Mixins" id="idm45017706589136"/><a data-type="indexterm" data-primary="classes" data-secondary="superclasses" data-tertiary="Mixins extending" id="idm45017706588192"/><a data-type="indexterm" data-primary="superclasses" data-secondary="Mixins extending" id="idm45017706586976"/><a data-type="indexterm" data-primary="inheritance" data-secondary="extends keyword" data-tertiary="Mixins" id="idm45017706586032"/>The extends clause can also accept arbitrary expressions that return classes or constructors. These features enable us to define a Mixin as a function that accepts a superclass and creates a new subclass from it.</p>

<p>Imagine that we define a Mixin containing utility functions in a standard JavaScript class as follows:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">MyMixins</code> <code class="o">=</code> <code class="nx">superclass</code> <code class="o">=&gt;</code>
    <code class="kr">class</code> <code class="kr">extends</code> <code class="nx">superclass</code> <code class="p">{</code>
        <code class="nx">moveUp</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'move up'</code><code class="p">);</code>
        <code class="p">}</code>
        <code class="nx">moveDown</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'move down'</code><code class="p">);</code>
        <code class="p">}</code>
        <code class="nx">stop</code><code class="p">()</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'stop! in the name of love!'</code><code class="p">);</code>
        <code class="p">}</code>
    <code class="p">};</code></pre>

<p>Here, we created a <code>MyMixins</code> function that can extend a dynamic superclass. We will now create two classes, <code>CarAnimator</code> and <code>PersonAnimator</code>, from which <code>MyMixins</code> can extend and return a subclass with methods defined in <code>MyMixins</code> and those in the class being extended:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// A skeleton carAnimator constructor</code>
<code class="kr">class</code> <code class="nx">CarAnimator</code> <code class="p">{</code>
    <code class="nx">moveLeft</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'move left'</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code>
<code class="c1">// A skeleton personAnimator constructor</code>
<code class="kr">class</code> <code class="nx">PersonAnimator</code> <code class="p">{</code>
    <code class="nx">moveRandomly</code><code class="p">()</code> <code class="p">{</code>
        <code class="cm">/*...*/</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Extend MyMixins using CarAnimator</code>
<code class="kr">class</code> <code class="nx">MyAnimator</code> <code class="kr">extends</code> <code class="nx">MyMixins</code><code class="p">(</code><code class="nx">CarAnimator</code><code class="p">)</code> <code class="p">{}</code>

<code class="c1">// Create a new instance of carAnimator</code>
<code class="kr">const</code> <code class="nx">myAnimator</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyAnimator</code><code class="p">();</code>
<code class="nx">myAnimator</code><code class="p">.</code><code class="nx">moveLeft</code><code class="p">();</code>
<code class="nx">myAnimator</code><code class="p">.</code><code class="nx">moveDown</code><code class="p">();</code>
<code class="nx">myAnimator</code><code class="p">.</code><code class="nx">stop</code><code class="p">();</code>

<code class="c1">// Outputs:</code>
<code class="c1">// move left</code>
<code class="c1">// move down</code>
<code class="c1">// stop! in the name of love!</code></pre>

<p>As we can see, this makes mixing similar behavior into classes reasonably trivial.</p>

<p>The following example has two classes: a <code>Car</code> and a <code>Mixin</code>. What we’re going to do is augment (another way of saying extend) the <code>Car</code> so that it can inherit specific methods defined in the <code>Mixin</code>, namely <code>driveForward()</code> and <code>driveBackward()</code>.</p>

<p>This example will demonstrate how to augment a constructor to include functionality without the need to duplicate this process for every constructor function we may have:<a data-type="indexterm" data-startref="ch07-mixn" id="idm45017706454368"/><a data-type="indexterm" data-primary="constructor() method" data-secondary="Mixins" id="idm45017706409632"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Car.js</code>
<code class="kr">class</code> <code class="nx">Car</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">({</code> <code class="nx">model</code> <code class="o">=</code> <code class="s1">'no model provided'</code><code class="p">,</code> <code class="nx">color</code> <code class="o">=</code> <code class="s1">'no color provided'</code> <code class="p">})</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">model</code> <code class="o">=</code> <code class="nx">model</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="kr">export</code> <code class="k">default</code> <code class="nx">Car</code><code class="p">;</code>

<code class="c1">// Mixin.js and index.js remain unchanged</code>

<code class="c1">// index.js</code>
<code class="kr">import</code> <code class="nx">Car</code> <code class="nx">from</code> <code class="s1">'./Car.js'</code><code class="p">;</code>
<code class="kr">import</code> <code class="nx">Mixin</code> <code class="nx">from</code> <code class="s1">'./Mixin.js'</code><code class="p">;</code>

<code class="kr">class</code> <code class="nx">MyCar</code> <code class="kr">extends</code> <code class="nx">Mixin</code><code class="p">(</code><code class="nx">Car</code><code class="p">)</code> <code class="p">{}</code>

<code class="c1">// Create a new Car</code>
<code class="kr">const</code> <code class="nx">myCar</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyCar</code><code class="p">({});</code>

<code class="c1">// Test to make sure we now have access to the methods</code>
<code class="nx">myCar</code><code class="p">.</code><code class="nx">driveForward</code><code class="p">();</code>
<code class="nx">myCar</code><code class="p">.</code><code class="nx">driveBackward</code><code class="p">();</code>

<code class="c1">// Outputs:</code>
<code class="c1">// drive forward</code>
<code class="c1">// drive backward</code>

<code class="kr">const</code> <code class="nx">mySportsCar</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MyCar</code><code class="p">({</code>
  <code class="nx">model</code><code class="o">:</code> <code class="s1">'Porsche'</code><code class="p">,</code>
  <code class="nx">color</code><code class="o">:</code> <code class="s1">'red'</code><code class="p">,</code>
<code class="p">});</code>

<code class="nx">mySportsCar</code><code class="p">.</code><code class="nx">driveSideways</code><code class="p">();</code>

<code class="c1">// Outputs:</code>
<code class="c1">// drive sideways</code></pre>








<section data-type="sect2" data-pdf-bookmark="Advantages and Disadvantages"><div class="sect2" id="idm45017706393104">
<h2>Advantages and Disadvantages</h2>

<p>Mixins assist in decreasing functional<a data-type="indexterm" data-primary="Mixin pattern" data-secondary="advantages" id="idm45017706349488"/> repetition and increasing function reuse in a system. Where an application is likely to require shared behavior across object instances, we can easily avoid duplication by maintaining this shared functionality in a Mixin and thus focusing on implementing only the functionality in our system, which is truly distinct.</p>

<p>That said, the downsides to Mixins are a little more<a data-type="indexterm" data-primary="Mixin pattern" data-secondary="disadvantages" id="idm45017706348032"/> debatable. Some developers feel that injecting functionality into a class or an object prototype is a bad idea as it leads to both prototype pollution and a level of uncertainty regarding the origin of our functions. In large systems, this may well be the case.</p>

<p>Even with React, Mixins were often used to add functionality to components before the introduction of ES6 classes. <a data-type="indexterm" data-primary="Mixin pattern" data-secondary="disadvantages" data-tertiary="React team discouraging Mixins" id="idm45017706346416"/><a data-type="indexterm" data-primary="React Hooks (Hooks)" data-secondary="Mixins alternative" id="idm45017706345200"/><a data-type="indexterm" data-primary="Hooks (React Hooks)" data-secondary="Mixins alternative" id="idm45017706255488"/>The React team <a href="https://oreil.ly/RCMzS">discourages Mixins</a> because it adds unnecessary complexity to a component, making it hard to maintain and reuse. The React team <a href="https://oreil.ly/f1216">encouraged using higher-order components and Hooks instead</a>.</p>

<p>I would argue that solid documentation can assist in minimizing the amount of confusion regarding the source of mixed-in functions. Still, as with every pattern, we should be okay if we take care during implementation.<a data-type="indexterm" data-startref="ch07-mix" id="idm45017706252752"/><a data-type="indexterm" data-startref="ch07-mix2" id="idm45017706252144"/><a data-type="indexterm" data-startref="ch07-mix3" id="idm45017706251536"/></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Decorator Pattern"><div class="sect1" id="the-decorator-pattern">
<h1>The Decorator Pattern</h1>

<p>Decorators are a structural design pattern<a data-type="indexterm" data-primary="Decorator pattern" id="ch07-decpat"/><a data-type="indexterm" data-primary="structural design patterns" data-secondary="Decorator pattern" id="ch07-decpat2"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="structural design patterns" data-tertiary="Decorator pattern" id="ch07-decpat3"/><a data-type="indexterm" data-primary="Decorator pattern" data-secondary="about" id="idm45017706245216"/><a data-type="indexterm" data-primary="reuse of code and Decorator pattern" id="idm45017706244272"/><a data-type="indexterm" data-primary="code reuse promoted by Decorator pattern" id="idm45017706243632"/><a data-type="indexterm" data-primary="classes" data-secondary="subclasses" data-tertiary="decorators instead" id="idm45017706242864"/><a data-type="indexterm" data-primary="subclasses" data-secondary="decorators instead" id="idm45017706241648"/> that aims to promote code reuse. Like Mixins, you can think of them as another viable alternative to object subclassing.</p>

<p>Classically, decorators offered the ability to add behavior to existing classes  in a system dynamically. The idea was that the <em>decoration</em> itself wasn’t essential to the base functionality of the class. Otherwise, we could bake it into the <em>superclass</em> itself.</p>

<p>We can use them to modify existing systems where we wish to add additional features to objects without heavily changing the underlying code that uses them. A common reason developers use them is that their applications may contain features requiring many distinct types of objects. <a data-type="indexterm" data-primary="constructors for classes" data-secondary="Decorating with new functionality" id="ch07-dec"/>Imagine defining hundreds of different object constructors for, say, a JavaScript game (see <a data-type="xref" href="#decorator">Figure 7-7</a>).</p>

<figure><div id="decorator" class="figure">
<img src="Images/ljd2_0707.png" alt="ljd2 0707" width="1109" height="742"/>
<h6><span class="label">Figure 7-7. </span>Decorator pattern</h6>
</div></figure>

<p>The object constructors could represent distinct player types, each with differing capabilities. A <em>Lord of the Rings</em> game could require constructors for <code>Hobbit</code>, <code>Elf</code>, 
<span class="keep-together"><code>Orc</code>, <code>Wizard</code>,</span> <code>Mountain Giant</code>, <code>Stone Giant</code>, and so on, but there could easily be hundreds of these. If we then factored in capabilities, imagine having to create subclasses for each combination of capability types, e.g., <code>HobbitWithRing</code>, <code>HobbitWithSword</code>, 
<span class="keep-together"><code>HobbitWithRingAndSword</code>,</span> and so on. This isn’t practical and certainly isn’t 
<span class="keep-together">manageable</span> when we factor in an increasing number of different abilities.</p>

<p>The Decorator pattern isn’t heavily tied to how objects are created but instead focuses on the problem of extending their functionality. <a data-type="indexterm" data-primary="inheritance" data-secondary="Decorator capabilities instead" id="idm45017706227280"/><a data-type="indexterm" data-primary="decorator pattern" data-secondary="Decorating constructors with new functionality" id="ch07-deccon"/>Rather than just relying on prototypal inheritance, we work with a single base class and progressively add decorator objects that provide additional capabilities. The idea is that rather than subclassing, we add (decorate) properties or methods to a base object, so it’s a little more 
<span class="keep-together">streamlined.</span></p>

<p>We can use JavaScript classes to create the base classes that can be decorated. Adding new attributes or methods to object instances of the class in JavaScript is a straightforward process. With this in mind, we can implement a simplistic decorator, as shown in Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#decorating_constructors_functionality">7-4</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#decorating_objects_multiple">7-5</a>.<a data-type="indexterm" data-primary="constructor() method" data-secondary="Decorating" id="ch07-deccon2"/></p>
<div id="decorating_constructors_functionality" data-type="example">
<h5><span class="label">Example 7-4. </span>Decorating constructors with new functionality</h5>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// A vehicle constructor</code>
<code class="kr">class</code> <code class="nx">Vehicle</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">vehicleType</code><code class="p">)</code> <code class="p">{</code>
        <code class="c1">// some sane defaults</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">vehicleType</code> <code class="o">=</code> <code class="nx">vehicleType</code> <code class="o">||</code> <code class="s1">'car'</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">model</code> <code class="o">=</code> <code class="s1">'default'</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">license</code> <code class="o">=</code> <code class="s1">'00000-000'</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Test instance for a basic vehicle</code>
<code class="kr">const</code> <code class="nx">testInstance</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Vehicle</code><code class="p">(</code><code class="s1">'car'</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">testInstance</code><code class="p">);</code>

<code class="c1">// Outputs:</code>
<code class="c1">// vehicle: car, model:default, license: 00000-000</code>

<code class="c1">// Let's create a new instance of vehicle, to be decorated</code>
<code class="kr">const</code> <code class="nx">truck</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Vehicle</code><code class="p">(</code><code class="s1">'truck'</code><code class="p">);</code>

<code class="c1">// New functionality we're decorating vehicle with</code>
<code class="nx">truck</code><code class="p">.</code><code class="nx">setModel</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">modelName</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">model</code> <code class="o">=</code> <code class="nx">modelName</code><code class="p">;</code>
<code class="p">};</code>

<code class="nx">truck</code><code class="p">.</code><code class="nx">setColor</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">color</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">color</code> <code class="o">=</code> <code class="nx">color</code><code class="p">;</code>
<code class="p">};</code>

<code class="c1">// Test the value setters and value assignment works correctly</code>
<code class="nx">truck</code><code class="p">.</code><code class="nx">setModel</code><code class="p">(</code><code class="s1">'CAT'</code><code class="p">);</code>
<code class="nx">truck</code><code class="p">.</code><code class="nx">setColor</code><code class="p">(</code><code class="s1">'blue'</code><code class="p">);</code>

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">truck</code><code class="p">);</code>

<code class="c1">// Outputs:</code>
<code class="c1">// vehicle:truck, model:CAT, color: blue</code>

<code class="c1">// Demonstrate "vehicle" is still unaltered</code>
<code class="kr">const</code> <code class="nx">secondInstance</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Vehicle</code><code class="p">(</code><code class="s1">'car'</code><code class="p">);</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">secondInstance</code><code class="p">);</code>

<code class="c1">// Outputs:</code>
<code class="c1">// vehicle: car, model:default, license: 00000-000</code></pre>

<p>Here, <code>truck</code> is an instance of the class <code>Vehicle</code>, and we also decorate it with additional methods <code>setColor</code> and <code>setModel</code>.</p>

<p>This type of simplistic implementation is functional, but it doesn’t demonstrate all the strengths that decorators offer. For this, we’re going to go through my variation of the Coffee example from an excellent <a data-type="indexterm" data-primary="MacBook example" data-secondary="decorators" id="idm45017706212864"/><a data-type="indexterm" data-primary="Decorator pattern" data-secondary="MacBook example" data-tertiary="decorators" id="idm45017706141472"/><a data-type="indexterm" data-primary="Head First Design Patterns (Freeman et al.)" id="idm45017706140256"/><a data-type="indexterm" data-primary="Freeman, Eric" id="idm45017706139488"/>book called <a class="orm:hideurl" href="https://learning.oreilly.com/library/view/head-first-design/0596007124/"><i>Head First Design Patterns</i></a> by Freeman et al., which is modeled around a MacBook purchase.</p></div>
<div id="decorating_objects_multiple" data-type="example">
<h5><span class="label">Example 7-5. </span>Decorating objects with multiple decorators</h5>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// The constructor to decorate</code>
<code class="kr">class</code> <code class="nx">MacBook</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">cost</code> <code class="o">=</code> <code class="mi">997</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">screenSize</code> <code class="o">=</code> <code class="mf">11.6</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">getCost</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">cost</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="nx">getScreenSize</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">screenSize</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Decorator 1</code>
<code class="kr">class</code> <code class="nx">Memory</code> <code class="kr">extends</code> <code class="nx">MacBook</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">macBook</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">();</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">macBook</code> <code class="o">=</code> <code class="nx">macBook</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">getCost</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">macBook</code><code class="p">.</code><code class="nx">getCost</code><code class="p">()</code> <code class="o">+</code> <code class="mi">75</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Decorator 2</code>
<code class="kr">class</code> <code class="nx">Engraving</code> <code class="kr">extends</code> <code class="nx">MacBook</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">macBook</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">();</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">macBook</code> <code class="o">=</code> <code class="nx">macBook</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">getCost</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">macBook</code><code class="p">.</code><code class="nx">getCost</code><code class="p">()</code> <code class="o">+</code> <code class="mi">200</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Decorator 3</code>
<code class="kr">class</code> <code class="nx">Insurance</code> <code class="kr">extends</code> <code class="nx">MacBook</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">macBook</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">();</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">macBook</code> <code class="o">=</code> <code class="nx">macBook</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">getCost</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">macBook</code><code class="p">.</code><code class="nx">getCost</code><code class="p">()</code> <code class="o">+</code> <code class="mi">250</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// init main object</code>
<code class="kd">let</code> <code class="nx">mb</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MacBook</code><code class="p">();</code>

<code class="c1">// init decorators</code>
<code class="nx">mb</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Memory</code><code class="p">(</code><code class="nx">mb</code><code class="p">);</code>
<code class="nx">mb</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Engraving</code><code class="p">(</code><code class="nx">mb</code><code class="p">);</code>
<code class="nx">mb</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Insurance</code><code class="p">(</code><code class="nx">mb</code><code class="p">);</code>

<code class="c1">// Outputs: 1522</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">mb</code><code class="p">.</code><code class="nx">getCost</code><code class="p">());</code>

<code class="c1">// Outputs: 11.6</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">mb</code><code class="p">.</code><code class="nx">getScreenSize</code><code class="p">());</code></pre></div>

<p>In this example, our decorators are overriding the <code>MacBook</code> superclass object’s <code>.cost()</code> function to return the current price of the MacBook plus the cost of the upgrade.</p>

<p>It’s considered decoration because the original <code>MacBook</code> objects constructor methods that are not overridden (e.g., <code>screenSize()</code>), as well as any other properties we may define as a part of the <code>MacBook</code>, remain unchanged and intact.</p>

<p>There isn’t a defined interface in the previous example. We’re shifting away from the responsibility of ensuring an object meets an interface when moving from the creator to the receiver.<a data-type="indexterm" data-startref="ch07-dec" id="idm45017705828528"/><a data-type="indexterm" data-startref="ch07-deccon" id="idm45017705827936"/><a data-type="indexterm" data-startref="ch07-deccon2" id="idm45017705827264"/></p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Pseudoclassical Decorators"><div class="sect1" id="pseudo-classical-decorators">
<h1>Pseudoclassical Decorators</h1>

<p>We’re now going to examine a variation of the Decorator first presented in a JavaScript form in <em>Pro JavaScript Design Patterns</em> (PJDP) by Dustin Diaz and Ross Harmes.<a data-type="indexterm" data-primary="Decorator pattern" data-secondary="pseudoclassical decorators" id="idm45017705824320"/><a data-type="indexterm" data-primary="structural design patterns" data-secondary="Decorator pattern" data-tertiary="pseudoclassical decorators" id="idm45017705823360"/><a data-type="indexterm" data-primary="Diaz, Dustin" id="idm45017705733584"/><a data-type="indexterm" data-primary="Harmes, Ross" id="idm45017705732976"/><a data-type="indexterm" data-primary="Pro JavaScript Design Patterns (PJDP; Diaz and Harmes)" id="idm45017705732368"/></p>

<p>Unlike some of the previous examples, Diaz and Harmes stick more closely to how decorators are implemented in other programming languages (such as Java or C++) using the concept of an “interface,” which we will define in more detail shortly.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>This particular variation of the Decorator pattern is provided for reference purposes. If you find it overly complex, I recommend opting for one of the straightforward implementations covered 
<span class="keep-together">earlier.</span></p>
</div>








<section data-type="sect2" data-pdf-bookmark="Interfaces"><div class="sect2" id="interfaces">
<h2>Interfaces</h2>

<p>PJDP describes the Decorator pattern<a data-type="indexterm" data-primary="interfaces" data-secondary="Decorator pattern" id="idm45017705727968"/><a data-type="indexterm" data-primary="Decorator pattern" data-secondary="pseudoclassical decorators" data-tertiary="interfaces" id="idm45017705726992"/> as one that is used to transparently wrap objects inside other objects of the same interface. <a data-type="indexterm" data-primary="interfaces" data-secondary="about" id="idm45017705725520"/>An interface is a way of defining the methods an object <em>should</em> have. However, it doesn’t directly specify how you should implement those methods. Interfaces can also optionally indicate what parameters the methods take.</p>

<p>So, why would we use an<a data-type="indexterm" data-primary="JavaScript" data-secondary="interfaces" id="idm45017705723648"/><a data-type="indexterm" data-primary="interfaces" data-secondary="JavaScript" id="idm45017705722640"/> interface in JavaScript? The idea is that they’re self-documenting and promote reusability. In theory, interfaces make code more stable by ensuring any change to the interface must also be propagated to the objects implementing them.</p>

<p>What follows is an example of an<a data-type="indexterm" data-primary="duck-typing an interface" id="idm45017705721184"/><a data-type="indexterm" data-primary="interfaces" data-secondary="JavaScript" data-tertiary="duck-typing for implementation" id="idm45017705720416"/> implementation of interfaces in JavaScript using duck-typing. This approach helps determine whether an object is an instance of a constructor/object based on the methods it implements:<a data-type="indexterm" data-primary="constructor() method" data-secondary="interface implementation in JavaScript" id="idm45017705719056"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Create interfaces using a predefined Interface</code>
<code class="c1">// constructor that accepts an interface name and</code>
<code class="c1">// skeleton methods to expose.</code>

<code class="c1">// In our reminder example summary() and placeOrder()</code>
<code class="c1">// represent functionality the interface should</code>
<code class="c1">// support</code>
<code class="kr">const</code> <code class="nx">reminder</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Interface</code><code class="p">(</code><code class="s1">'List'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'summary'</code><code class="p">,</code> <code class="s1">'placeOrder'</code><code class="p">]);</code>

<code class="kr">const</code> <code class="nx">properties</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s1">'Remember to buy the milk'</code><code class="p">,</code>
    <code class="nx">date</code><code class="o">:</code> <code class="s1">'05/06/2040'</code><code class="p">,</code>
    <code class="nx">actions</code><code class="o">:</code> <code class="p">{</code>
        <code class="nx">summary</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="s1">'Remember to buy the milk, we are almost out!'</code><code class="p">;</code>
        <code class="p">},</code>
        <code class="nx">placeOrder</code><code class="p">()</code> <code class="p">{</code>
            <code class="k">return</code> <code class="s1">'Ordering milk from your local grocery store'</code><code class="p">;</code>
        <code class="p">},</code>
    <code class="p">},</code>
<code class="p">};</code>

<code class="c1">// Now create a constructor implementing these properties</code>
<code class="c1">// and methods</code>

<code class="kr">class</code> <code class="nx">Todo</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">({</code> <code class="nx">actions</code><code class="p">,</code> <code class="nx">name</code> <code class="p">})</code> <code class="p">{</code>
        <code class="c1">// State the methods we expect to be supported</code>
        <code class="c1">// as well as the Interface instance being checked</code>
        <code class="c1">// against</code>

        <code class="nx">Interface</code><code class="p">.</code><code class="nx">ensureImplements</code><code class="p">(</code><code class="nx">actions</code><code class="p">,</code> <code class="nx">reminder</code><code class="p">);</code>

        <code class="k">this</code><code class="p">.</code><code class="nx">name</code> <code class="o">=</code> <code class="nx">name</code><code class="p">;</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">methods</code> <code class="o">=</code> <code class="nx">actions</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Create a new instance of our Todo constructor</code>

<code class="kr">const</code> <code class="nx">todoItem</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Todo</code><code class="p">(</code><code class="nx">properties</code><code class="p">);</code>

<code class="c1">// Finally test to make sure these function correctly</code>

<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">todoItem</code><code class="p">.</code><code class="nx">methods</code><code class="p">.</code><code class="nx">summary</code><code class="p">());</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">todoItem</code><code class="p">.</code><code class="nx">methods</code><code class="p">.</code><code class="nx">placeOrder</code><code class="p">());</code>

<code class="c1">// Outputs:</code>
<code class="c1">// Remember to buy the milk, we are almost out!</code>
<code class="c1">// Ordering milk from your local grocery store</code></pre>

<p>Both classic JavaScript and ES2015+ <a data-type="indexterm" data-primary="JavaScript" data-secondary="interfaces" id="idm45017705713904"/><a data-type="indexterm" data-primary="interfaces" data-secondary="JavaScript" id="idm45017705713056"/>do not support interfaces. However, we can create our Interface class. In the previous example, 
<span class="keep-together"><code>Interface.ensureImplements</code></span> provides strict functionality checking, and you can <a href="https://oreil.ly/JbbLL">find code for both this and the <code>Interface</code> constructor</a>.</p>

<p>The main concern with interfaces is that JavaScript does not have built-in support for them, which may lead to attempts at emulating features from other languages that might not be an ideal fit. However, you can utilize TypeScript if you really need interfaces, as it provides built-in support for them. Lightweight interfaces can be used without a significant performance cost in JavaScript, and we will explore <em>abstract</em> decorators using this same concept in the following section.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Abstract Decorators"><div class="sect2" id="abstract-decorators">
<h2>Abstract Decorators</h2>
<p class="fix_tracking">
To demonstrate the structure of this version of the Decorator pattern, we’re going to imagine we have a superclass that models a <code>MacBook</code> once again and a store that allows us to “decorate” our MacBook with a number of enhancements for an additional fee.</p>

<p>Enhancements<a data-type="indexterm" data-primary="Decorator pattern" data-secondary="Abstract Decorator class" id="ch07-abdec"/><a data-type="indexterm" data-primary="Abstract Decorator class" id="ch07-abdec2"/><a data-type="indexterm" data-primary="MacBook example" data-secondary="Abstract Decorators" id="ch07-abdec3"/><a data-type="indexterm" data-primary="Abstract Decorator class" data-secondary="MacBook example" id="ch07-abdec4"/><a data-type="indexterm" data-primary="Decorator pattern" data-secondary="MacBook example" data-tertiary="Abstract Decorators" id="ch07-abdec5"/> can include upgrades to 4 GB or 8 GB of RAM (this can be much higher now, of course!), engraving, Parallels, or a case. Now, if we were to model this using an individual subclass for each combination of enhancement options, it might look something like this:</p>

<pre data-type="programlisting" data-code-language="javascript" class="less_space pagebreak-before"><code class="kr">const</code> <code class="nx">MacBook</code> <code class="o">=</code> <code class="kr">class</code> <code class="p">{</code>
    <code class="c1">//...</code>
<code class="p">};</code>

<code class="kr">const</code> <code class="nx">MacBookWith4GBRam</code> <code class="o">=</code> <code class="kr">class</code> <code class="p">{};</code>
<code class="kr">const</code> <code class="nx">MacBookWith8GBRam</code> <code class="o">=</code> <code class="kr">class</code> <code class="p">{};</code>
<code class="kr">const</code> <code class="nx">MacBookWith4GBRamAndEngraving</code> <code class="o">=</code> <code class="kr">class</code> <code class="p">{};</code>
<code class="kr">const</code> <code class="nx">MacBookWith8GBRamAndEngraving</code> <code class="o">=</code> <code class="kr">class</code> <code class="p">{};</code>
<code class="kr">const</code> <code class="nx">MacBookWith8GBRamAndParallels</code> <code class="o">=</code> <code class="kr">class</code> <code class="p">{};</code>
<code class="kr">const</code> <code class="nx">MacBookWith4GBRamAndParallels</code> <code class="o">=</code> <code class="kr">class</code> <code class="p">{};</code>
<code class="kr">const</code> <code class="nx">MacBookWith8GBRamAndParallelsAndCase</code> <code class="o">=</code> <code class="kr">class</code> <code class="p">{};</code>
<code class="kr">const</code> <code class="nx">MacBookWith4GBRamAndParallelsAndCase</code> <code class="o">=</code> <code class="kr">class</code> <code class="p">{};</code>
<code class="kr">const</code> <code class="nx">MacBookWith8GBRamAndParallelsAndCaseAndInsurance</code> <code class="o">=</code> <code class="kr">class</code> <code class="p">{};</code>
<code class="kr">const</code> <code class="nx">MacBookWith4GBRamAndParallelsAndCaseAndInsurance</code> <code class="o">=</code> <code class="kr">class</code> <code class="p">{};</code></pre>

<p>…and so on.</p>

<p>This solution would be impractical because a new subclass would be required for every possible combination of enhancements that are available. As we would prefer to keep things simple, without maintaining a large set of subclasses, let’s look at how we can use decorators to solve this problem better.</p>

<p>Rather than requiring all of the combinations we saw earlier, we will create only five new decorator classes. Methods called on these enhancement classes would be passed on to our <code>MacBook</code> class.</p>

<p>In the following example, decorators transparently wrap around their components and can be interchanged as they use the same interface.
Here’s the interface we’re going to define for the MacBook:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">MacBook</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Interface</code><code class="p">(</code><code class="s1">'MacBook'</code><code class="p">,</code> <code class="p">[</code>
    <code class="s1">'addEngraving'</code><code class="p">,</code>
    <code class="s1">'addParallels'</code><code class="p">,</code>
    <code class="s1">'add4GBRam'</code><code class="p">,</code>
    <code class="s1">'add8GBRam'</code><code class="p">,</code>
    <code class="s1">'addCase'</code><code class="p">,</code>
<code class="p">]);</code>

<code class="c1">// A MacBook Pro might thus be represented as follows:</code>
<code class="kr">class</code> <code class="nx">MacBookPro</code> <code class="p">{</code>
    <code class="c1">// implements MacBook</code>
<code class="p">}</code>

<code class="c1">// ES2015+: We still could use Object.prototype for adding new methods,</code>
<code class="c1">// because internally we use the same structure</code>

<code class="nx">MacBookPro</code><code class="p">.</code><code class="nx">prototype</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">addEngraving</code><code class="p">()</code> <code class="p">{},</code>
    <code class="nx">addParallels</code><code class="p">()</code> <code class="p">{},</code>
    <code class="nx">add4GBRam</code><code class="p">()</code> <code class="p">{},</code>
    <code class="nx">add8GBRam</code><code class="p">()</code> <code class="p">{},</code>
    <code class="nx">addCase</code><code class="p">()</code> <code class="p">{},</code>
    <code class="nx">getPrice</code><code class="p">()</code> <code class="p">{</code>
        <code class="c1">// Base price</code>
        <code class="k">return</code> <code class="mf">900.0</code><code class="p">;</code>
    <code class="p">},</code>
<code class="p">};</code></pre>

<p>To make it easier for us to add many more options as needed later on, an abstract decorator class is defined with default methods required to implement the <code>MacBook</code> interface, which the rest of the options will subclass. Abstract Decorators ensure that we can decorate a base class independently with as many decorators as needed in different combinations (remember the example earlier?) without needing to derive a class for every possible combination:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// MacBook decorator abstract decorator class</code>

<code class="kr">class</code> <code class="nx">MacBookDecorator</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">macbook</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">Interface</code><code class="p">.</code><code class="nx">ensureImplements</code><code class="p">(</code><code class="nx">macbook</code><code class="p">,</code> <code class="nx">MacBook</code><code class="p">);</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">macbook</code> <code class="o">=</code> <code class="nx">macbook</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">addEngraving</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">macbook</code><code class="p">.</code><code class="nx">addEngraving</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="nx">addParallels</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">macbook</code><code class="p">.</code><code class="nx">addParallels</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="nx">add4GBRam</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">macbook</code><code class="p">.</code><code class="nx">add4GBRam</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="nx">add8GBRam</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">macbook</code><code class="p">.</code><code class="nx">add8GBRam</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="nx">addCase</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">macbook</code><code class="p">.</code><code class="nx">addCase</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="nx">getPrice</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">macbook</code><code class="p">.</code><code class="nx">getPrice</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>In this sample, the <code>MacBook</code> Decorator accepts an object (a <code>MacBook</code>) to use as our base component. It uses the <code>MacBook</code> interface we defined earlier, and each method is just calling the same method on the component. We can now create our option classes for what can be added by using the <code>MacBook</code> Decorator:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Let's now extend (decorate) the CaseDecorator</code>
<code class="c1">// with a MacBookDecorator</code>

<code class="kr">class</code> <code class="nx">CaseDecorator</code> <code class="kr">extends</code> <code class="nx">MacBookDecorator</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">macbook</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">super</code><code class="p">(</code><code class="nx">macbook</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="nx">addCase</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="sb">`</code><code class="si">${</code><code class="k">this</code><code class="p">.</code><code class="nx">macbook</code><code class="p">.</code><code class="nx">addCase</code><code class="p">()</code><code class="si">}</code><code class="sb">Adding case to macbook`</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">getPrice</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">macbook</code><code class="p">.</code><code class="nx">getPrice</code><code class="p">()</code> <code class="o">+</code> <code class="mf">45.0</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>We are overriding the <code>addCase()</code> and <code>getPrice()</code> methods that we want to decorate, and we’re achieving this by first calling these methods on the original <code>MacBook</code> and then simply appending a string or numeric value (e.g., <code>45.00</code>) to them accordingly.</p>

<p>As there’s been quite a lot of information presented in this section so far, let’s try to bring it all together in a single example that will hopefully highlight what we have learned:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Instantiation of the macbook</code>
<code class="kr">const</code> <code class="nx">myMacBookPro</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">MacBookPro</code><code class="p">();</code>

<code class="c1">// Outputs: 900.00</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">myMacBookPro</code><code class="p">.</code><code class="nx">getPrice</code><code class="p">());</code>

<code class="c1">// Decorate the macbook</code>
<code class="kr">const</code> <code class="nx">decoratedMacBookPro</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">CaseDecorator</code><code class="p">(</code><code class="nx">myMacBookPro</code><code class="p">);</code>

<code class="c1">// This will return 945.00</code>
<code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">decoratedMacBookPro</code><code class="p">.</code><code class="nx">getPrice</code><code class="p">());</code></pre>

<p>As decorators can modify objects dynamically, they’re a perfect pattern for changing existing systems. Occasionally, it’s just simpler to create decorators around an object instead of maintaining individual subclasses for each object type. This makes maintaining applications that may require many subclassed objects significantly more straightforward.</p>

<p>You can find a functional version of this example on <a href="https://oreil.ly/wNgs6">JSBin</a>.<a data-type="indexterm" data-startref="ch07-abdec" id="idm45017705068928"/><a data-type="indexterm" data-startref="ch07-abdec2" id="idm45017705068256"/><a data-type="indexterm" data-startref="ch07-abdec3" id="idm45017705067584"/><a data-type="indexterm" data-startref="ch07-abdec4" id="idm45017705066912"/><a data-type="indexterm" data-startref="ch07-abdec5" id="idm45017705066240"/></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Advantages and Disadvantages"><div class="sect1" id="advantages-disadvantages-2">
<h1>Advantages and Disadvantages</h1>

<p>Developers enjoy using this pattern<a data-type="indexterm" data-primary="Decorator pattern" data-secondary="advantages" id="idm45017705063312"/> as it can be used transparently and is somewhat flexible. As we’ve seen, objects can be wrapped or “decorated” with new behavior and continue to be used without worrying about the base object being modified. In a broader context, this pattern also avoids us needing to rely on large numbers of subclasses to get the same benefits.</p>

<p>There are, however, drawbacks<a data-type="indexterm" data-primary="Decorator pattern" data-secondary="disadvantages" id="idm45017705061824"/> that we should be aware of when implementing the pattern. It can significantly complicate our application architecture if poorly managed, as it introduces many small but similar objects into our namespace.  The concern is that other developers unfamiliar with the pattern may have difficulty grasping why it’s being used, making it hard to manage.</p>

<p>Sufficient commenting or pattern research should assist with the latter. However, as long as we handle how widely we use the Decorator in our applications, we should be fine on both counts.<a data-type="indexterm" data-startref="ch07-decpat" id="idm45017705060336"/><a data-type="indexterm" data-startref="ch07-decpat2" id="idm45017705059632"/><a data-type="indexterm" data-startref="ch07-decpat3" id="idm45017705058960"/></p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Flyweight"><div class="sect1" id="flyweight">
<h1>Flyweight</h1>

<p>The Flyweight pattern is a classical structural<a data-type="indexterm" data-primary="Flyweight pattern" id="ch07-fly"/><a data-type="indexterm" data-primary="structural design patterns" data-secondary="Flyweight pattern" id="ch07-fly2"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="structural design patterns" data-tertiary="Flyweight pattern" id="ch07-fly3"/><a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="about" id="idm45017705052560"/> solution for optimizing code that is repetitive, slow, and inefficiently shares data. It aims to minimize the use of memory in an application by sharing as much data as possible with related objects (e.g., application configuration, state, and so on—see <a data-type="xref" href="#flyweight_pattern">Figure 7-8</a>).</p>

<figure><div id="flyweight_pattern" class="figure">
<img src="Images/ljd2_0708.png" alt="ljd2 0708" width="1334" height="563"/>
<h6><span class="label">Figure 7-8. </span>Flyweight pattern</h6>
</div></figure>

<p>Paul Calder and Mark Linton first conceived<a data-type="indexterm" data-primary="Calder, Paul" id="idm45017705048272"/><a data-type="indexterm" data-primary="Linton, Mark" id="idm45017705047568"/> the pattern in 1990 and named it after the boxing weight class that includes fighters weighing less than 112 lb. The name Flyweight is derived from this weight classification because it refers to the small weight (memory footprint) the pattern aims to help us achieve.</p>

<p>In practice, Flyweight data sharing can involve taking several similar objects or data constructs used by many objects and placing this data into a single external object. We can pass this object to those depending on this data rather than storing identical data across each one.</p>








<section data-type="sect2" data-pdf-bookmark="Using Flyweights"><div class="sect2" id="using-flyweights">
<h2>Using Flyweights</h2>

<p>There are two ways in which you can apply<a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="using" id="idm45017705005552"/> the Flyweight pattern. The first is at the data layer, where we deal with the concept of sharing data between large quantities of similar objects stored in memory.</p>

<p>You can also apply the Flyweight at the DOM layer as a central event manager to avoid attaching event handlers to every child element in a parent container with similar behavior.</p>

<p>Traditionally, the Flyweight pattern has been used most at the data layer, so we’ll take a look at this first.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Flyweights and Sharing Data"><div class="sect2" id="flyweights-and-sharing-data">
<h2>Flyweights and Sharing Data</h2>

<p>For this application, we need to be aware<a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="sharing data and" id="idm45017705001744"/><a data-type="indexterm" data-primary="data" data-secondary="shared data" data-tertiary="Flyweights and" id="idm45017705000768"/><a data-type="indexterm" data-primary="shared data" data-secondary="Flyweights and" id="idm45017704999552"/><a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="intrinsic and extrinsic states" id="idm45017704998608"/><a data-type="indexterm" data-primary="state management" data-secondary="intrinsic and extrinsic states of Flyweight pattern" id="idm45017704997648"/> of a few more concepts around the classical Flyweight pattern. In the Flyweight pattern, there’s a concept of two states: intrinsic and extrinsic. Intrinsic information may be required by internal methods in our objects, without which they absolutely cannot function. Extrinsic information can, however, be removed and stored externally.</p>

<p>You can replace objects with the same intrinsic data with a single shared object created by a factory method. This allows us to reduce the overall quantity of implicit data being stored quite significantly.</p>

<p>The benefit is that we can keep an eye on objects that have already been instantiated so that new copies are only ever created if the intrinsic state differs from the object we already have.</p>

<p>We use a manager to handle the extrinsic states. You can implement this in various ways, but one approach is to have the manager object contain a central database of the extrinsic states and the flyweight objects to which they belong.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Implementing Classical Flyweights"><div class="sect2" id="implementing-classical-flyweights">
<h2>Implementing Classical Flyweights</h2>

<p>The Flyweight pattern hasn’t been<a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="implementing classical Flyweights" id="ch07-flyimp"/><a data-type="indexterm" data-primary="JavaScript" data-secondary="Flyweights" id="idm45017704992064"/> heavily used in JavaScript recently, so many of the implementations we might use for inspiration come from the Java and C++ worlds.</p>

<p>Our first look at flyweights in code is my JavaScript implementation of the Java sample of the Flyweight pattern from <a href="https://oreil.ly/6rtiJ">Wikipedia</a>.</p>

<p>This implementation makes use of three types of flyweight components:</p>
<dl>
<dt>Flyweight</dt>
<dd>
<p>Corresponds to an interface through which flyweights are able to receive and act on extrinsic states.</p>
</dd>
<dt>Concrete flyweight</dt>
<dd>
<p>Actually implements the flyweight interface and stores the intrinsic states. Concrete flyweights need to be sharable and capable of manipulating the extrinsic state.</p>
</dd>
<dt>Flyweight factory</dt>
<dd>
<p>Manages flyweight objects and<a data-type="indexterm" data-primary="Factory pattern" data-secondary="Flyweight factory" id="idm45017704984880"/><a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="Flyweight factory" id="idm45017704983904"/> creates them too. It ensures that our flyweights are shared and manages them as a group of objects that can be queried if we require individual instances. If an object has already been created in the group, it returns it. Otherwise, it adds a new object to the pool and returns it.</p>
</dd>
</dl>

<p>These correspond to the following definitions in our implementation:</p>

<ul>
<li>
<p><code>CoffeeOrder</code>: Flyweight</p>
</li>
<li>
<p><code>CoffeeFlavor</code>: Concrete flyweight</p>
</li>
<li>
<p><code>CoffeeOrderContext</code>: Helper</p>
</li>
<li>
<p><code>CoffeeFlavorFactory</code>: Flyweight factory</p>
</li>
<li>
<p><code>testFlyweight</code>: Utilization of our Flyweights</p>
</li>
</ul>










<section data-type="sect3" data-pdf-bookmark="Duck punching “implements”"><div class="sect3" id="duck-punching-implements">
<h3>Duck punching “implements”</h3>

<p>Duck punching allows us to extend<a data-type="indexterm" data-primary="duck punching" data-secondary="Flyweight implementation" id="idm45017704973872"/><a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="duck punching for implementation" id="idm45017704972832"/><a data-type="indexterm" data-primary="duck punching" id="idm45017704971872"/><a data-type="indexterm" data-primary="implements (Java keyword) via duck punching" id="idm45017704971200"/><a data-type="indexterm" data-primary="Java implements keyword via duck punching" id="idm45017704970496"/><a data-type="indexterm" data-primary="JavaScript" data-secondary="duck punching Java keywords" id="idm45017704969792"/> the capabilities of a language or solution without necessarily needing to modify the runtime source. As this next solution requires a Java keyword (<code>implements</code>) for implementing interfaces and isn’t found in JavaScript natively, let’s first duck-punch it.</p>

<p><code>Function.prototype.implementsFor</code> works on an object constructor and will accept a parent class (function) or object and either inherit from this using normal inheritance (for functions) or virtual inheritance (for objects):</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Utility to simulate implementation of an interface</code>
<code class="kr">class</code> <code class="nx">InterfaceImplementation</code> <code class="p">{</code>
  <code class="kr">static</code> <code class="nx">implementsFor</code><code class="p">(</code><code class="nx">superclassOrInterface</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">superclassOrInterface</code> <code class="k">instanceof</code> <code class="nb">Function</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">prototype</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">superclassOrInterface</code><code class="p">.</code><code class="nx">prototype</code><code class="p">);</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">constructor</code> <code class="o">=</code> <code class="k">this</code><code class="p">;</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">parent</code> <code class="o">=</code> <code class="nx">superclassOrInterface</code><code class="p">.</code><code class="nx">prototype</code><code class="p">;</code>
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">prototype</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">superclassOrInterface</code><code class="p">);</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">constructor</code> <code class="o">=</code> <code class="k">this</code><code class="p">;</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">parent</code> <code class="o">=</code> <code class="nx">superclassOrInterface</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>We can use this to patch the lack<a data-type="indexterm" data-primary="interfaces" data-secondary="Java keyword via duck punching" id="idm45017704927072"/><a data-type="indexterm" data-primary="duck punching" data-secondary="interfaces in JavaScript" id="idm45017704867328"/> of an <code>implements</code> keyword by explicitly having a function inherit an interface. Next, <code>CoffeeFlavor</code> implements the <code>CoffeeOrder</code> interface and must contain its interface methods for us to assign the functionality powering these implementations to an object:<a data-type="indexterm" data-startref="ch07-flyimp" id="idm45017704865072"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// CoffeeOrder interface</code>
<code class="kr">const</code> <code class="nx">CoffeeOrder</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">serveCoffee</code><code class="p">(</code><code class="nx">context</code><code class="p">)</code> <code class="p">{},</code>
  <code class="nx">getFlavor</code><code class="p">()</code> <code class="p">{},</code>
<code class="p">};</code>

<code class="kr">class</code> <code class="nx">CoffeeFlavor</code> <code class="kr">extends</code> <code class="nx">InterfaceImplementation</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">(</code><code class="nx">newFlavor</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">super</code><code class="p">();</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">flavor</code> <code class="o">=</code> <code class="nx">newFlavor</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">getFlavor</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">flavor</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">serveCoffee</code><code class="p">(</code><code class="nx">context</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Serving Coffee flavor </code><code class="si">${</code><code class="k">this</code><code class="p">.</code><code class="nx">flavor</code><code class="si">}</code><code class="sb"> to</code>
<code class="sb">       table </code><code class="si">${</code><code class="nx">context</code><code class="p">.</code><code class="nx">getTable</code><code class="p">()</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Implement interface for CoffeeOrder</code>
<code class="nx">CoffeeFlavor</code><code class="p">.</code><code class="nx">implementsFor</code><code class="p">(</code><code class="nx">CoffeeOrder</code><code class="p">);</code>

<code class="kr">const</code> <code class="nx">CoffeeOrderContext</code> <code class="o">=</code> <code class="p">(</code><code class="nx">tableNumber</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">({</code>
  <code class="nx">getTable</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">tableNumber</code><code class="p">;</code>
  <code class="p">},</code>
<code class="p">});</code>

<code class="kr">class</code> <code class="nx">CoffeeFlavorFactory</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">flavors</code> <code class="o">=</code> <code class="p">{};</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">length</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">getCoffeeFlavor</code><code class="p">(</code><code class="nx">flavorName</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">let</code> <code class="nx">flavor</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">flavors</code><code class="p">[</code><code class="nx">flavorName</code><code class="p">];</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">flavor</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">flavor</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">CoffeeFlavor</code><code class="p">(</code><code class="nx">flavorName</code><code class="p">);</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">flavors</code><code class="p">[</code><code class="nx">flavorName</code><code class="p">]</code> <code class="o">=</code> <code class="nx">flavor</code><code class="p">;</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">length</code><code class="o">++</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="k">return</code> <code class="nx">flavor</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">getTotalCoffeeFlavorsMade</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Sample usage:</code>
<code class="kr">const</code> <code class="nx">testFlyweight</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">flavors</code> <code class="o">=</code> <code class="p">[];</code>
  <code class="kr">const</code> <code class="nx">tables</code> <code class="o">=</code> <code class="p">[];</code>
  <code class="kd">let</code> <code class="nx">ordersMade</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="kr">const</code> <code class="nx">flavorFactory</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">CoffeeFlavorFactory</code><code class="p">();</code>

  <code class="kd">function</code> <code class="nx">takeOrders</code><code class="p">(</code><code class="nx">flavorIn</code><code class="p">,</code> <code class="nx">table</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">flavors</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">flavorFactory</code><code class="p">.</code><code class="nx">getCoffeeFlavor</code><code class="p">(</code><code class="nx">flavorIn</code><code class="p">));</code>
    <code class="nx">tables</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">CoffeeOrderContext</code><code class="p">(</code><code class="nx">table</code><code class="p">));</code>
    <code class="nx">ordersMade</code><code class="o">++</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="c1">// Place orders</code>
  <code class="nx">takeOrders</code><code class="p">(</code><code class="s1">'Cappuccino'</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>
  <code class="c1">// ...</code>

  <code class="c1">// Serve orders</code>
  <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">ordersMade</code><code class="p">;</code> <code class="o">++</code><code class="nx">i</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">flavors</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">serveCoffee</code><code class="p">(</code><code class="nx">tables</code><code class="p">[</code><code class="nx">i</code><code class="p">]);</code>
  <code class="p">}</code>

  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">' '</code><code class="p">);</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`total CoffeeFlavor objects made:</code>
<code class="sb">    </code><code class="si">${</code><code class="nx">flavorFactory</code><code class="p">.</code><code class="nx">getTotalCoffeeFlavorsMade</code><code class="p">()</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
<code class="p">};</code>

<code class="nx">testFlyweight</code><code class="p">();</code></pre>
</div></section>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Converting Code to Use the Flyweight Pattern"><div class="sect2" id="converting-code-to-use-the-flyweight-pattern">
<h2>Converting Code to Use the Flyweight Pattern</h2>

<p>Next, let’s continue our look<a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="converting code to use" id="ch07-conv"/><a data-type="indexterm" data-primary="books in a library example" id="ch07-conv2"/><a data-type="indexterm" data-primary="library books example" id="ch07-conv3"/><a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="books in a library example" id="ch07-conv4"/> at Flyweights by implementing a system to manage all books in a library. You could list the essential metadata for each book as follows:</p>

<ul>
<li>
<p>ID</p>
</li>
<li>
<p>Title</p>
</li>
<li>
<p>Author</p>
</li>
<li>
<p>Genre</p>
</li>
<li>
<p>Page count</p>
</li>
<li>
<p>Publisher ID</p>
</li>
<li>
<p>ISBN</p>
</li>
</ul>

<p>We’ll also require the following properties to track which member has checked out a particular book, the date they’ve checked it out, and the expected return date:</p>

<ul>
<li>
<p><code>checkoutDate</code></p>
</li>
<li>
<p><code>checkoutMember</code></p>
</li>
<li>
<p><code>dueReturnDate</code></p>
</li>
<li>
<p><code>availability</code></p>
</li>
</ul>

<p>We create a <code>Book</code> class to represent each book as follows before any optimization using the Flyweight pattern. The constructor takes in all the properties related directly to the book and those required for tracking it:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">Book</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">(</code>
    <code class="nx">id</code><code class="p">,</code>
    <code class="nx">title</code><code class="p">,</code>
    <code class="nx">author</code><code class="p">,</code>
    <code class="nx">genre</code><code class="p">,</code>
    <code class="nx">pageCount</code><code class="p">,</code>
    <code class="nx">publisherID</code><code class="p">,</code>
    <code class="nx">ISBN</code><code class="p">,</code>
    <code class="nx">checkoutDate</code><code class="p">,</code>
    <code class="nx">checkoutMember</code><code class="p">,</code>
    <code class="nx">dueReturnDate</code><code class="p">,</code>
    <code class="nx">availability</code>
  <code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">id</code> <code class="o">=</code> <code class="nx">id</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">title</code> <code class="o">=</code> <code class="nx">title</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">author</code> <code class="o">=</code> <code class="nx">author</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">genre</code> <code class="o">=</code> <code class="nx">genre</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">pageCount</code> <code class="o">=</code> <code class="nx">pageCount</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">publisherID</code> <code class="o">=</code> <code class="nx">publisherID</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">ISBN</code> <code class="o">=</code> <code class="nx">ISBN</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">checkoutDate</code> <code class="o">=</code> <code class="nx">checkoutDate</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">checkoutMember</code> <code class="o">=</code> <code class="nx">checkoutMember</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">dueReturnDate</code> <code class="o">=</code> <code class="nx">dueReturnDate</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">availability</code> <code class="o">=</code> <code class="nx">availability</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">getTitle</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">title</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">getAuthor</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">author</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">getISBN</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">ISBN</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="c1">// For brevity, other getters are not shown</code>
  <code class="nx">updateCheckoutStatus</code><code class="p">(</code>
    <code class="nx">bookID</code><code class="p">,</code>
    <code class="nx">newStatus</code><code class="p">,</code>
    <code class="nx">checkoutDate</code><code class="p">,</code>
    <code class="nx">checkoutMember</code><code class="p">,</code>
    <code class="nx">newReturnDate</code>
  <code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">id</code> <code class="o">=</code> <code class="nx">bookID</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">availability</code> <code class="o">=</code> <code class="nx">newStatus</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">checkoutDate</code> <code class="o">=</code> <code class="nx">checkoutDate</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">checkoutMember</code> <code class="o">=</code> <code class="nx">checkoutMember</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">dueReturnDate</code> <code class="o">=</code> <code class="nx">newReturnDate</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">extendCheckoutPeriod</code><code class="p">(</code><code class="nx">bookID</code><code class="p">,</code> <code class="nx">newReturnDate</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">id</code> <code class="o">=</code> <code class="nx">bookID</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">dueReturnDate</code> <code class="o">=</code> <code class="nx">newReturnDate</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">isPastDue</code><code class="p">(</code><code class="nx">bookID</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">currentDate</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">();</code>
    <code class="k">return</code> <code class="nx">currentDate</code><code class="p">.</code><code class="nx">getTime</code><code class="p">()</code> <code class="o">&gt;</code> <code class="nb">Date</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">dueReturnDate</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>This probably works fine initially for small collections of books. However, as the library expands to include a more extensive inventory with multiple versions and copies of each book, we may find the management system running more slowly. Using thousands of book objects may overwhelm the available memory, but we can optimize our system using the Flyweight pattern to improve this.</p>

<p>We can now separate our data into intrinsic and extrinsic states: data relevant to 
<span class="keep-together">the book</span> object (<code>title</code>, <code>author</code>, etc.) is intrinsic, while the checkout data 
<span class="keep-together">(<code>checkoutMember</code>,</span> <code>dueReturnDate</code>, etc.) is considered extrinsic. Effectively, this means that only one <code>Book</code> object is required for each combination of book properties. It’s still a considerable number of objects, but significantly fewer than we had 
<span class="keep-together">previously.</span></p>

<p>An instance of the following book metadata combination will be created for all required copies of the book object with a particular title/ISBN:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Flyweight optimized version</code>
<code class="kr">class</code> <code class="nx">Book</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">({</code> <code class="nx">title</code><code class="p">,</code> <code class="nx">author</code><code class="p">,</code> <code class="nx">genre</code><code class="p">,</code> <code class="nx">pageCount</code><code class="p">,</code> <code class="nx">publisherID</code><code class="p">,</code> <code class="nx">ISBN</code> <code class="p">})</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">title</code> <code class="o">=</code> <code class="nx">title</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">author</code> <code class="o">=</code> <code class="nx">author</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">genre</code> <code class="o">=</code> <code class="nx">genre</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">pageCount</code> <code class="o">=</code> <code class="nx">pageCount</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">publisherID</code> <code class="o">=</code> <code class="nx">publisherID</code><code class="p">;</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">ISBN</code> <code class="o">=</code> <code class="nx">ISBN</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>As we can see, the extrinsic states have been removed. Everything to do with library checkouts will be moved to a manager, and as the object data is now segmented, we can use a factory for instantiation.<a data-type="indexterm" data-startref="ch07-conv" id="idm45017704091392"/><a data-type="indexterm" data-startref="ch07-conv2" id="idm45017704090784"/><a data-type="indexterm" data-startref="ch07-conv3" id="idm45017704049712"/><a data-type="indexterm" data-startref="ch07-conv4" id="idm45017704049040"/></p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="A Basic Factory"><div class="sect2" id="a-basic-factory">
<h2>A Basic Factory</h2>

<p>Let’s now define a very basic factory.<a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="Flyweight factory" id="idm45017704046800"/><a data-type="indexterm" data-primary="Factory pattern" data-secondary="Flyweight factory" id="idm45017704045824"/><a data-type="indexterm" data-primary="books in a library example" data-secondary="basic factory" id="idm45017704044880"/><a data-type="indexterm" data-primary="library books example" data-secondary="basic factory" id="idm45017704043968"/><a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="books in a library example" data-tertiary="basic factory" id="idm45017704043024"/> We will have it check if a book with a particular title has been previously created inside the system—if it has, we’ll return it; if not, a new book will be created and stored so that it can be accessed later. This ensures that we create only a single copy of each unique intrinsic piece of data:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Book Factory Singleton</code>
<code class="kr">const</code> <code class="nx">existingBooks</code> <code class="o">=</code> <code class="p">{};</code>

<code class="kr">class</code> <code class="nx">BookFactory</code> <code class="p">{</code>
  <code class="nx">createBook</code><code class="p">({</code> <code class="nx">title</code><code class="p">,</code> <code class="nx">author</code><code class="p">,</code> <code class="nx">genre</code><code class="p">,</code> <code class="nx">pageCount</code><code class="p">,</code> <code class="nx">publisherID</code><code class="p">,</code> <code class="nx">ISBN</code> <code class="p">})</code> <code class="p">{</code>
    <code class="c1">// Find if a particular book + metadata combination already exists</code>
    <code class="c1">// !! or (bang bang) forces a boolean to be returned</code>
    <code class="kr">const</code> <code class="nx">existingBook</code> <code class="o">=</code> <code class="nx">existingBooks</code><code class="p">[</code><code class="nx">ISBN</code><code class="p">];</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!!</code><code class="nx">existingBook</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="nx">existingBook</code><code class="p">;</code>
    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
      <code class="c1">// if not, let's create a new instance of the book and store it</code>
      <code class="kr">const</code> <code class="nx">book</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Book</code><code class="p">({</code> <code class="nx">title</code><code class="p">,</code> <code class="nx">author</code><code class="p">,</code> <code class="nx">genre</code><code class="p">,</code> <code class="nx">pageCount</code><code class="p">,</code> <code class="nx">publisherID</code><code class="p">,</code>
         <code class="nx">ISBN</code> <code class="p">});</code>
      <code class="nx">existingBooks</code><code class="p">[</code><code class="nx">ISBN</code><code class="p">]</code> <code class="o">=</code> <code class="nx">book</code><code class="p">;</code>
      <code class="k">return</code> <code class="nx">book</code><code class="p">;</code>
    <code class="p">}</code>
  <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Managing the Extrinsic States"><div class="sect2" id="managing-the-extrinsic-states">
<h2>Managing the Extrinsic States</h2>

<p>Next, we need to store the states<a data-type="indexterm" data-primary="books in a library example" data-secondary="managing extrinsic states" id="idm45017703913040"/><a data-type="indexterm" data-primary="library books example" data-secondary="managing extrinsic states" id="idm45017703912160"/><a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="intrinsic and extrinsic states" data-tertiary="managing extrinsic states" id="idm45017703911248"/><a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="books in a library example" data-tertiary="managing extrinsic states" id="idm45017703910048"/><a data-type="indexterm" data-primary="Singleton pattern" data-secondary="example" data-tertiary="managing extrinsic states" id="idm45017703908800"/><a data-type="indexterm" data-primary="constructor() method" data-secondary="Singletons" id="idm45017703884960"/><a data-type="indexterm" data-primary="state management" data-secondary="intrinsic and extrinsic states of Flyweight pattern" data-tertiary="managing extrinsic states" id="idm45017703884112"/> that were removed from the <code>Book</code> objects 
<span class="keep-together">somewhere—luckily,</span> a manager (which we’ll be defining as a Singleton) can be used to encapsulate them. Combinations of a <code>Book</code> object and the library member who’s checked it out will be called <code>Book</code> record. Our manager will be storing both and will include checkout-related logic we stripped out during our Flyweight optimization of the <code>Book</code> class:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// BookRecordManager Singleton</code>
<code class="kr">const</code> <code class="nx">bookRecordDatabase</code> <code class="o">=</code> <code class="p">{};</code>

<code class="kr">class</code> <code class="nx">BookRecordManager</code> <code class="p">{</code>
  <code class="c1">// add a new book into the library system</code>
  <code class="nx">addBookRecord</code><code class="p">({</code> <code class="nx">id</code><code class="p">,</code> <code class="nx">title</code><code class="p">,</code> <code class="nx">author</code><code class="p">,</code> <code class="nx">genre</code><code class="p">,</code> <code class="nx">pageCount</code><code class="p">,</code> <code class="nx">publisherID</code><code class="p">,</code> <code class="nx">ISBN</code><code class="p">,</code>
       <code class="nx">checkoutDate</code><code class="p">,</code> <code class="nx">checkoutMember</code><code class="p">,</code> <code class="nx">dueReturnDate</code><code class="p">,</code> <code class="nx">availability</code> <code class="p">})</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">bookFactory</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">BookFactory</code><code class="p">();</code>
    <code class="kr">const</code> <code class="nx">book</code> <code class="o">=</code> <code class="nx">bookFactory</code><code class="p">.</code><code class="nx">createBook</code><code class="p">({</code> <code class="nx">title</code><code class="p">,</code> <code class="nx">author</code><code class="p">,</code> <code class="nx">genre</code><code class="p">,</code> <code class="nx">pageCount</code><code class="p">,</code>
       <code class="nx">publisherID</code><code class="p">,</code> <code class="nx">ISBN</code> <code class="p">});</code>
    <code class="nx">bookRecordDatabase</code><code class="p">[</code><code class="nx">id</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code>
      <code class="nx">checkoutMember</code><code class="p">,</code>
      <code class="nx">checkoutDate</code><code class="p">,</code>
      <code class="nx">dueReturnDate</code><code class="p">,</code>
      <code class="nx">availability</code><code class="p">,</code>
      <code class="nx">book</code><code class="p">,</code>
    <code class="p">};</code>
  <code class="p">}</code>

  <code class="nx">updateCheckoutStatus</code><code class="p">({</code> <code class="nx">bookID</code><code class="p">,</code> <code class="nx">newStatus</code><code class="p">,</code> <code class="nx">checkoutDate</code><code class="p">,</code> <code class="nx">checkoutMember</code><code class="p">,</code>
     <code class="nx">newReturnDate</code> <code class="p">})</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">record</code> <code class="o">=</code> <code class="nx">bookRecordDatabase</code><code class="p">[</code><code class="nx">bookID</code><code class="p">];</code>
    <code class="nx">record</code><code class="p">.</code><code class="nx">availability</code> <code class="o">=</code> <code class="nx">newStatus</code><code class="p">;</code>
    <code class="nx">record</code><code class="p">.</code><code class="nx">checkoutDate</code> <code class="o">=</code> <code class="nx">checkoutDate</code><code class="p">;</code>
    <code class="nx">record</code><code class="p">.</code><code class="nx">checkoutMember</code> <code class="o">=</code> <code class="nx">checkoutMember</code><code class="p">;</code>
    <code class="nx">record</code><code class="p">.</code><code class="nx">dueReturnDate</code> <code class="o">=</code> <code class="nx">newReturnDate</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">extendCheckoutPeriod</code><code class="p">(</code><code class="nx">bookID</code><code class="p">,</code> <code class="nx">newReturnDate</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">bookRecordDatabase</code><code class="p">[</code><code class="nx">bookID</code><code class="p">].</code><code class="nx">dueReturnDate</code> <code class="o">=</code> <code class="nx">newReturnDate</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">isPastDue</code><code class="p">(</code><code class="nx">bookID</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">currentDate</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">();</code>
    <code class="k">return</code> <code class="nx">currentDate</code><code class="p">.</code><code class="nx">getTime</code><code class="p">()</code> <code class="o">&gt;</code>
       <code class="nb">Date</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">bookRecordDatabase</code><code class="p">[</code><code class="nx">bookID</code><code class="p">].</code><code class="nx">dueReturnDate</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>The result of these changes is that all of the data extracted from the <code>Book</code> <em>class</em> is now being stored in an attribute of the <code>BookManager</code> Singleton (<code>BookDatabase</code>)—something considerably more efficient than the large number of objects we were previously using. Methods related to book checkouts are also now based here as they deal with extrinsic rather than intrinsic data.</p>

<p>This process does add a little complexity to our final solution. However, it’s a minor concern compared to the performance issues that we have tackled. Data-wise, if we have 30 copies of the same book, we are now storing it only once. Also, every function takes up memory. With the Flyweight pattern, these functions exist in one place (on the manager) and not on every object, thus saving on memory use. For the unoptimized version of Flyweight mentioned previously, we store just a link to the function object as we used the <code>Book</code> constructor’s prototype. Still, if we implemented it another way, functions would be created for every book instance.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="The Flyweight Pattern and the DOM"><div class="sect2" id="the-flyweight-pattern-and-the-dom">
<h2>The Flyweight Pattern and the DOM</h2>

<p>The DOM supports two approaches<a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="DOM and" id="ch07-flydom"/><a data-type="indexterm" data-primary="DOM" data-secondary="Flyweight pattern and" id="ch07-flydom2"/><a data-type="indexterm" data-primary="events" data-secondary="Flyweight pattern and the DOM" id="ch07-flydom3"/><a data-type="indexterm" data-primary="DOM" data-secondary="Flyweight pattern and" data-tertiary="about object event detection" id="idm45017703725552"/><a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="DOM and" data-tertiary="about object event detection in DOM" id="idm45017703724368"/><a data-type="indexterm" data-primary="objects" data-secondary="event detection in DOM" id="idm45017703723184"/><a data-type="indexterm" data-primary="events" data-secondary="event capture" id="idm45017703722240"/><a data-type="indexterm" data-primary="events" data-secondary="event bubbling" id="idm45017703626080"/><a data-type="indexterm" data-primary="bubbling versus capture in event detection" id="idm45017703625232"/><a data-type="indexterm" data-primary="capture versus bubbling in event detection" id="idm45017703624592"/><a data-type="indexterm" data-primary="click handling" id="idm45017703623952"/> that allow objects to detect events—either top-down (event capture) or bottom-up (event bubbling).</p>

<p>In event capture, the event is first captured by the outer-most element and propagated to the inner-most element. In event bubbling, the event is captured and given to the inner-most element and then propagated to the outer elements.</p>

<p>Gary Chisholm wrote one of the <a data-type="indexterm" data-primary="Chisholm, Gary" id="idm45017703622400"/>best metaphors for describing Flyweights in this context, and it goes a little like this:</p>
<blockquote>
<p>Try to think of the flyweight in terms of a pond. A fish opens its mouth (the event), bubbles rise to the surface (the bubbling), a fly sitting on the top flies away when the bubble reaches the surface (the action). In this example we can easily transpose the fish opening its mouth to a button being clicked, the bubbles as the bubbling effect, and the fly flying away to some function being run.</p></blockquote>

<p>Bubbling was introduced to handle situations in which a single event (e.g., a <code>click</code>) may be handled by multiple event handlers defined at different levels of the DOM hierarchy. Where this happens, event bubbling executes event handlers defined for specific elements at the lowest level possible. From there on, the event bubbles up to containing elements before going to those even higher up.</p>

<p>Flyweights can be used to further tweak the event-bubbling process, as we will see in <a data-type="xref" data-xrefstyle="select:nopage" href="#example_centralized_event_handling">“Example: Centralized Event Handling”</a>.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Example: Centralized Event Handling"><div class="sect2" id="example_centralized_event_handling">
<h2>Example: Centralized Event Handling</h2>

<p>For our first practical example, imagine<a data-type="indexterm" data-primary="events" data-secondary="Flyweight pattern and the DOM" data-tertiary="centralized event handling" id="idm45017703616464"/><a data-type="indexterm" data-primary="Flyweight pattern" data-secondary="DOM and" data-tertiary="centralized event handling" id="idm45017703615136"/><a data-type="indexterm" data-primary="DOM" data-secondary="Flyweight pattern and" data-tertiary="centralized event handling" id="idm45017703613904"/><a data-type="indexterm" data-primary="click handling" data-secondary="centralized event handling" id="idm45017703612672"/><a data-type="indexterm" data-primary="jQuery" data-secondary="Flyweight centralized event handling" id="idm45017703611712"/> we have several similar elements in a document with similar behavior executed when a user action (e.g., click, mouse-over) is performed against them.</p>

<p>Usually, when constructing our accordion component, menu, or other list-based widgets, we bind a <code>click</code> event to each link element in the parent container (e.g., <code>
<span class="keep-together">$('ul</span> li a').on(…​)</code>). Instead of binding the click to multiple elements, we can easily attach a Flyweight to the top of our container, which can listen for events coming from below. These can then be handled using logic as simple or complex as required.</p>

<p>As the types of components mentioned often have the same repeating markup for each section (e.g., each section of an accordion), there’s a good chance the behavior of each element clicked will be pretty similar and relative to similar classes nearby. We’ll use this information to construct a basic accordion using the Flyweight in <a data-type="xref" href="#centralized_event_handling">Example 7-6</a>.</p>

<p>A <code>stateManager</code> namespace is used<a data-type="indexterm" data-primary="namespacing patterns" data-secondary="stateManager for Flyweight logic" id="idm45017703606448"/> here to encapsulate our Flyweight logic, while jQuery is used to bind the initial click to a container <code>div</code>. An <code>unbind</code> event is first applied to ensure that no other logic on the page attaches similar handles to the 
<span class="keep-together">container.</span></p>

<p>To establish exactly what child element in the container is clicked, we use a <code>target</code> check, which provides a reference to the element that was clicked, regardless of its parent. We then use this information to handle the <code>click</code> event without actually needing to bind the event to specific children when our page loads.</p>
<div id="centralized_event_handling" data-type="example">
<h5><span class="label">Example 7-6. </span>Centralized event handling</h5>

<pre data-type="programlisting" data-code-language="html"><code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"container"</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"toggle"</code><code class="p">&gt;</code>More Info (Address)
      <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"info"</code><code class="p">&gt;</code>
        This is more information
      <code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"toggle"</code><code class="p">&gt;</code>Even More Info (Map)
      <code class="p">&lt;</code><code class="nt">span</code> <code class="na">class</code><code class="o">=</code><code class="s">"info"</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">iframe</code> <code class="na">src</code><code class="o">=</code><code class="s">"MAPS_URL"</code><code class="p">&gt;&lt;/</code><code class="nt">iframe</code><code class="p">&gt;</code>
      <code class="p">&lt;/</code><code class="nt">span</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
  <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code></pre>

<pre data-type="programlisting" data-code-language="javascript">  <code class="o">&lt;</code><code class="nx">script</code><code class="o">&gt;</code>
    <code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
      <code class="kr">const</code> <code class="nx">stateManager</code> <code class="o">=</code> <code class="p">{</code>
        <code class="nx">fly</code><code class="p">()</code> <code class="p">{</code>
          <code class="kr">const</code> <code class="nx">self</code> <code class="o">=</code> <code class="k">this</code><code class="p">;</code>
          <code class="nx">$</code><code class="p">(</code><code class="s1">'#container'</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">off</code><code class="p">()</code>
            <code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="s1">'div.toggle'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
              <code class="nx">self</code><code class="p">.</code><code class="nx">handleClick</code><code class="p">(</code><code class="k">this</code><code class="p">);</code>
            <code class="p">});</code>
        <code class="p">},</code>
        <code class="nx">handleClick</code><code class="p">(</code><code class="nx">elem</code><code class="p">)</code> <code class="p">{</code>
          <code class="nx">$</code><code class="p">(</code><code class="nx">elem</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="s1">'span'</code><code class="p">)</code>
            <code class="p">.</code><code class="nx">toggle</code><code class="p">(</code><code class="s1">'slow'</code><code class="p">);</code>
        <code class="p">},</code>
      <code class="p">};</code>

      <code class="c1">// Initialize event listeners</code>
      <code class="nx">stateManager</code><code class="p">.</code><code class="nx">fly</code><code class="p">();</code>
    <code class="p">})();</code>
  <code class="o">&lt;</code><code class="err">/script&gt;</code></pre></div>

<p>The benefit here is that we’re converting many independent actions into shared ones (potentially saving on memory).<a data-type="indexterm" data-startref="ch07-fly" id="idm45017703443360"/><a data-type="indexterm" data-startref="ch07-fly2" id="idm45017703442752"/><a data-type="indexterm" data-startref="ch07-fly3" id="idm45017703457472"/><a data-type="indexterm" data-startref="ch07-flydom" id="idm45017703456832"/><a data-type="indexterm" data-startref="ch07-flydom2" id="idm45017703456160"/><a data-type="indexterm" data-startref="ch07-flydom3" id="idm45017703455488"/></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Behavioral Patterns"><div class="sect1" id="javascript-design-patterns-behavioral">
<h1>Behavioral Patterns</h1>

<p>Behavioral patterns help define<a data-type="indexterm" data-primary="behavioral design patterns" data-secondary="about" id="idm45017703453104"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="behavioral design patterns" data-tertiary="about" id="idm45017703452160"/> the communication between objects. They help to improve or streamline the communication between disparate objects in a system.</p>

<p>Following are the JavaScript behavioral patterns that we will discuss in this section:</p>

<ul>
<li>
<p><a data-type="xref" href="#the-observer-pattern">“The Observer Pattern”</a></p>
</li>
<li>
<p><a data-type="xref" href="#the-mediator-pattern">“The Mediator Pattern”</a></p>
</li>
<li>
<p><a data-type="xref" href="#the-command-pattern">“The Command Pattern”</a></p>
</li>
</ul>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Observer Pattern"><div class="sect1" id="the-observer-pattern">
<h1>The Observer Pattern</h1>

<p>The Observer pattern allows you to notify<a data-type="indexterm" data-primary="behavioral design patterns" data-secondary="Observer pattern" id="ch07-obs"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="behavioral design patterns" data-tertiary="Observer pattern" id="ch07-obs2"/><a data-type="indexterm" data-primary="Observer pattern" id="ch07-obs3"/><a data-type="indexterm" data-primary="Observer pattern" data-secondary="about" id="idm45017703379168"/><a data-type="indexterm" data-primary="state management" data-secondary="state change notification via Observer pattern" id="idm45017703378224"/> one object when another object changes without requiring the object to know about its dependents. Often this is a pattern where an object (known as a subject) maintains a list of objects depending on it (observers), automatically notifying them of any changes to its state. In modern frameworks, the Observer pattern is used to inform components of state changes. <a data-type="xref" href="#observer">Figure 7-9</a> illustrates this.</p>

<figure><div id="observer" class="figure">
<img src="Images/ljd2_0709.png" alt="ljd2 0709" width="1148" height="656"/>
<h6><span class="label">Figure 7-9. </span>Observer pattern</h6>
</div></figure>

<p>When a subject needs to notify observers about something interesting happening, it broadcasts a notification to the observers (which can include specific data related to the topic). When an observer no longer wishes to be notified of changes by the subject, they can be removed from the list of observers.</p>

<p class="less_space pagebreak-before">It’s helpful to refer back to published definitions of design patterns that are language agnostic to get a broader sense of their usage and advantages over time. <a data-type="indexterm" data-primary="Design Patterns: Elements of Reusable Object-Oriented Software (Gamma, Helm, Johnson, and Vlissides)" data-secondary="Observer pattern definition" id="idm45017703373104"/><a data-type="indexterm" data-primary="Gamma, Erich" id="idm45017703372080"/><a data-type="indexterm" data-primary="Helm, Richard" id="idm45017703371408"/><a data-type="indexterm" data-primary="Johnson, Ralph" id="idm45017703370736"/><a data-type="indexterm" data-primary="Vlissides, John" id="idm45017703370064"/><a data-type="indexterm" data-primary="Observer pattern" data-secondary="about" data-tertiary="definition by GoF" id="idm45017703369392"/>The definition of the Observer pattern provided in the GoF book, <em>Design Patterns: Elements of Reusable Object-Oriented Software</em>, is:</p>
<blockquote>
<p>One or more observers are interested in the state of a subject and register their interest with the subject by attaching themselves. When something changes in our subject that the observer may be interested in, a notify message is sent which calls the update method in each observer. When the observer is no longer interested in the subject’s state, they can simply detach themselves.</p></blockquote>

<p>We can now expand on what we’ve learned to implement the Observer pattern with the following components:<a data-type="indexterm" data-primary="Observer pattern" data-secondary="implementation example" id="ch07-obsex"/></p>
<dl>
<dt>Subject</dt>
<dd>
<p>Maintains a list of observers, facilitates adding or removing observers</p>
</dd>
<dt>Observer</dt>
<dd>
<p>Provides an <code>update</code> interface for objects that need to be notified of a Subject’s changes in state</p>
</dd>
<dt><code>ConcreteSubject</code></dt>
<dd>
<p>Broadcasts notifications to observers on changes of state, stores the state of 
<span class="keep-together"><code>ConcreteObservers</code></span></p>
</dd>
<dt><code>ConcreteObserver</code></dt>
<dd>
<p>Stores a reference to the <code>ConcreteSubject</code>, implements an <code>update</code> interface for the observer to ensure the state is consistent with the Subject’s</p>
</dd>
</dl>

<p>ES2015+ allows us to implement the Observer pattern using JavaScript classes for observers and subjects with methods for <code>notify</code> and <code>update</code>.</p>

<p>First, let’s model the list of dependent observers a subject may have using the 
<span class="keep-together"><code>ObserverList</code></span> class:<a data-type="indexterm" data-primary="constructor() method" data-secondary="Observer pattern" id="ch07-obscon"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">ObserverList</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">observerList</code> <code class="o">=</code> <code class="p">[];</code>
    <code class="p">}</code>

    <code class="nx">add</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">observerList</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="nx">count</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">observerList</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">get</code><code class="p">(</code><code class="nx">index</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="nx">index</code> <code class="o">&gt;</code> <code class="o">-</code><code class="mi">1</code> <code class="o">&amp;&amp;</code> <code class="nx">index</code> <code class="o">&lt;</code> <code class="k">this</code><code class="p">.</code><code class="nx">observerList</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">observerList</code><code class="p">[</code><code class="nx">index</code><code class="p">];</code>
        <code class="p">}</code>
    <code class="p">}</code>

    <code class="nx">indexOf</code><code class="p">(</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">startIndex</code><code class="p">)</code> <code class="p">{</code>
        <code class="kd">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="nx">startIndex</code><code class="p">;</code>

        <code class="k">while</code> <code class="p">(</code><code class="nx">i</code> <code class="o">&lt;</code> <code class="k">this</code><code class="p">.</code><code class="nx">observerList</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">observerList</code><code class="p">[</code><code class="nx">i</code><code class="p">]</code> <code class="o">===</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">return</code> <code class="nx">i</code><code class="p">;</code>
            <code class="p">}</code>
            <code class="nx">i</code><code class="o">++</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">removeAt</code><code class="p">(</code><code class="nx">index</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">observerList</code><code class="p">.</code><code class="nx">splice</code><code class="p">(</code><code class="nx">index</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>Next, let’s model the <code>Subject</code> class that can add, remove, or notify observers on the observer list:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">Subject</code> <code class="p">{</code>
  <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">observers</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ObserverList</code><code class="p">();</code>
  <code class="p">}</code>

  <code class="nx">addObserver</code><code class="p">(</code><code class="nx">observer</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">observers</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="nx">observer</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="nx">removeObserver</code><code class="p">(</code><code class="nx">observer</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">observers</code><code class="p">.</code><code class="nx">removeAt</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">observers</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">observer</code><code class="p">,</code> <code class="mi">0</code><code class="p">));</code>
  <code class="p">}</code>

  <code class="nx">notify</code><code class="p">(</code><code class="nx">context</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">observerCount</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">observers</code><code class="p">.</code><code class="nx">count</code><code class="p">();</code>
    <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">observerCount</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">observers</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">i</code><code class="p">).</code><code class="nx">update</code><code class="p">(</code><code class="nx">context</code><code class="p">);</code>
    <code class="p">}</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>We then define a skeleton for creating new observers. We will overwrite the <code>Update</code> functionality here later with custom behavior:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// The Observer</code>
<code class="kr">class</code> <code class="nx">Observer</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{}</code>
    <code class="nx">update</code><code class="p">()</code> <code class="p">{</code>
        <code class="c1">// ...</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>In our sample application using the previous observer components, we now define:<a data-type="indexterm" data-primary="checkboxes that are observable" id="ch07-chek"/><a data-type="indexterm" data-primary="DOM" data-secondary="Observer pattern script" data-tertiary="checkboxes that are observable" id="ch07-chek2"/></p>

<ul>
<li>
<p>A button for adding new observable checkboxes to the page.</p>
</li>
<li>
<p>A control checkbox will act as a subject, notifying other checkboxes that they should update to the checked state.</p>
</li>
<li>
<p>A container for the new checkboxes added.</p>
</li>
</ul>

<p>We then define <code>ConcreteSubject</code> and <code>ConcreteObserver</code> handlers to add new observers to the page and implement the updating interface. For this, we use inheritance to extend our subject and observer classes. The <code>ConcreteSubject</code> class encapsulates a checkbox and generates a notification when the main checkbox is clicked. <code>ConcreteObserver</code> encapsulates each of the observing checkboxes and implements the <code>Update</code> interface by changing the checked value of the checkboxes. What follows are the inline comments on how these work together in the context of our example.</p>

<p>Here is the HTML code:</p>

<pre data-type="programlisting" data-code-language="html"><code class="p">&lt;</code><code class="nt">button</code> <code class="na">id</code><code class="o">=</code><code class="s">"addNewObserver"</code><code class="p">&gt;</code>Add New Observer checkbox<code class="p">&lt;/</code><code class="nt">button</code><code class="p">&gt;</code>
<code class="p">&lt;</code><code class="nt">input</code> <code class="na">id</code><code class="o">=</code><code class="s">"mainCheckbox"</code> <code class="na">type</code><code class="o">=</code><code class="s">"checkbox"</code><code class="p">/&gt;</code>
<code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"observersContainer"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code></pre>

<p>Here is an example:<a data-type="indexterm" data-primary="DOM" data-secondary="Observer pattern script" id="idm45017702947056"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// References to our DOM elements</code>

<code class="c1">// Concrete Subject</code>
<code class="kr">class</code> <code class="nx">ConcreteSubject</code> <code class="kr">extends</code> <code class="nx">Subject</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">element</code><code class="p">)</code> <code class="p">{</code>
      <code class="c1">// Call the constructor of the super class.</code>
      <code class="kr">super</code><code class="p">();</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">element</code> <code class="o">=</code> <code class="nx">element</code><code class="p">;</code>

      <code class="c1">// Clicking the checkbox will trigger notifications to its observers</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">element</code><code class="p">.</code><code class="nx">onclick</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">notify</code><code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">element</code><code class="p">.</code><code class="nx">checked</code><code class="p">);</code>
      <code class="p">};</code>
    <code class="p">}</code>
  <code class="p">}</code>

  <code class="c1">// Concrete Observer</code>

  <code class="kr">class</code> <code class="nx">ConcreteObserver</code> <code class="kr">extends</code> <code class="nx">Observer</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">(</code><code class="nx">element</code><code class="p">)</code> <code class="p">{</code>
      <code class="kr">super</code><code class="p">();</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">element</code> <code class="o">=</code> <code class="nx">element</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="c1">// Override with custom update behavior</code>
    <code class="nx">update</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">element</code><code class="p">.</code><code class="nx">checked</code> <code class="o">=</code> <code class="nx">value</code><code class="p">;</code>
    <code class="p">}</code>
  <code class="p">}</code>

  <code class="c1">// References to our DOM elements</code>
  <code class="kr">const</code> <code class="nx">addBtn</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'addNewObserver'</code><code class="p">);</code>
  <code class="kr">const</code> <code class="nx">container</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'observersContainer'</code><code class="p">);</code>
  <code class="kr">const</code> <code class="nx">controlCheckbox</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ConcreteSubject</code><code class="p">(</code>
    <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'mainCheckbox'</code><code class="p">)</code>
  <code class="p">);</code>

  <code class="kr">const</code> <code class="nx">addNewObserver</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// Create a new checkbox to be added</code>
    <code class="kr">const</code> <code class="nx">check</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'input'</code><code class="p">);</code>
    <code class="nx">check</code><code class="p">.</code><code class="nx">type</code> <code class="o">=</code> <code class="s1">'checkbox'</code><code class="p">;</code>
    <code class="kr">const</code> <code class="nx">checkObserver</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ConcreteObserver</code><code class="p">(</code><code class="nx">check</code><code class="p">);</code>

    <code class="c1">// Add the new observer to our list of observers</code>
    <code class="c1">// for our main subject</code>
    <code class="nx">controlCheckbox</code><code class="p">.</code><code class="nx">addObserver</code><code class="p">(</code><code class="nx">checkObserver</code><code class="p">);</code>

    <code class="c1">// Append the item to the container</code>
    <code class="nx">container</code><code class="p">.</code><code class="nx">appendChild</code><code class="p">(</code><code class="nx">check</code><code class="p">);</code>
  <code class="p">};</code>

  <code class="nx">addBtn</code><code class="p">.</code><code class="nx">onclick</code> <code class="o">=</code> <code class="nx">addNewObserver</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>In this example, we looked at how to implement and utilize the Observer pattern, covering the concepts of a Subject, <a data-type="indexterm" data-startref="ch07-obsex" id="idm45017702782224"/><a data-type="indexterm" data-startref="ch07-obscon" id="idm45017702781616"/><a data-type="indexterm" data-startref="ch07-chek" id="idm45017702781008"/><a data-type="indexterm" data-startref="ch07-chek2" id="idm45017702780336"/>Observer, <code>ConcreteSubject</code>, and 
<span class="keep-together"><code>ConcreteObserver</code>.</span></p>








<section data-type="sect2" data-pdf-bookmark="Differences Between the Observer and Publish/Subscribe Pattern"><div class="sect2" id="differences-between-the-observer-and-publishsubscribe-pattern">
<h2>Differences Between the Observer and Publish/Subscribe Pattern</h2>

<p>While it’s helpful to be aware of the<a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="Observer pattern versus" data-seealso="Observer pattern" id="idm45017702818176"/><a data-type="indexterm" data-primary="Observer pattern" data-secondary="Publish/Subscribe pattern versus" data-seealso="Publish/Subscribe pattern" id="idm45017702816960"/><a data-type="indexterm" data-primary="events" data-secondary="Observer versus Publish/Subscribe" id="idm45017702815760"/> Observer pattern, quite often in the JavaScript world, we’ll find it commonly implemented using a variation known as the Publish/Subscribe pattern. Although the two patterns are pretty similar, there are differences worth noting.</p>

<p>The Observer pattern requires that the observer (or object) wishing to receive topic notifications must subscribe this interest to the object firing the event (the subject), as seen in <a data-type="xref" href="#pubsub">Figure 7-10</a>.</p>

<figure><div id="pubsub" class="figure">
<img src="Images/ljd2_0710.png" alt="ljd2 0710" width="948" height="563"/>
<h6><span class="label">Figure 7-10. </span>Publish/Subscribe</h6>
</div></figure>

<p>The Publish/Subscribe pattern, however, uses a topic/event channel that sits between the objects wishing to receive notifications (subscribers) and the object firing the event (the publisher). This event system allows code to define application-specific events, which can pass custom arguments containing values needed by the subscriber. The idea here is to avoid dependencies  between the subscriber and publisher.</p>

<p>This differs from the Observer pattern because it allows any subscriber implementing an appropriate event handler to register for and receive topic notifications broadcast by the publisher.</p>

<p>Here is an example of how one might use<a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="example mail handler implementation" id="idm45017702668672"/> the Publish/Subscribe pattern if 
<span class="keep-together">provided with a</span> functional implementation powering <code>publish()</code>, <code>subscribe()</code>, and 
<span class="keep-together"><code>unsubscribe()</code></span> behind the scenes:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="c">&lt;!--</code> <code class="nx">Add</code> <code class="k">this</code> <code class="nx">HTML</code> <code class="nx">to</code> <code class="nx">your</code> <code class="nx">page</code> <code class="o">--&gt;</code>
<code class="o">&lt;</code><code class="nx">div</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"messageSender"</code><code class="o">&gt;&lt;</code><code class="err">/div&gt;</code>
<code class="o">&lt;</code><code class="nx">div</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"messagePreview"</code><code class="o">&gt;&lt;</code><code class="err">/div&gt;</code>
<code class="o">&lt;</code><code class="nx">div</code> <code class="kr">class</code><code class="o">=</code><code class="s2">"newMessageCounter"</code><code class="o">&gt;&lt;</code><code class="err">/div&gt;</code>
<code class="c1">// A simple Publish/Subscribe implementation</code>
<code class="kr">const</code> <code class="nx">events</code> <code class="o">=</code> <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">topics</code> <code class="o">=</code> <code class="p">{};</code>
  <code class="kr">const</code> <code class="nx">hOP</code> <code class="o">=</code> <code class="nx">topics</code><code class="p">.</code><code class="nx">hasOwnProperty</code><code class="p">;</code>

  <code class="k">return</code> <code class="p">{</code>
    <code class="nx">subscribe</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">topic</code><code class="p">,</code> <code class="nx">listener</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">hOP</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">topics</code><code class="p">,</code> <code class="nx">topic</code><code class="p">))</code> <code class="nx">topics</code><code class="p">[</code><code class="nx">topic</code><code class="p">]</code> <code class="o">=</code> <code class="p">[];</code>
      <code class="kr">const</code> <code class="nx">index</code> <code class="o">=</code> <code class="nx">topics</code><code class="p">[</code><code class="nx">topic</code><code class="p">].</code><code class="nx">push</code><code class="p">(</code><code class="nx">listener</code><code class="p">)</code> <code class="o">-</code> <code class="mi">1</code><code class="p">;</code>

      <code class="k">return</code> <code class="p">{</code>
        <code class="nx">remove</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
          <code class="k">delete</code> <code class="nx">topics</code><code class="p">[</code><code class="nx">topic</code><code class="p">][</code><code class="nx">index</code><code class="p">];</code>
        <code class="p">},</code>
      <code class="p">};</code>
    <code class="p">},</code>
    <code class="nx">publish</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">topic</code><code class="p">,</code> <code class="nx">info</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">hOP</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">topics</code><code class="p">,</code> <code class="nx">topic</code><code class="p">))</code> <code class="k">return</code><code class="p">;</code>
      <code class="nx">topics</code><code class="p">[</code><code class="nx">topic</code><code class="p">].</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">item</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">item</code><code class="p">(</code><code class="nx">info</code> <code class="o">!==</code> <code class="kc">undefined</code> <code class="o">?</code> <code class="nx">info</code> <code class="o">:</code> <code class="p">{});</code>
      <code class="p">});</code>
    <code class="p">},</code>
  <code class="p">};</code>
<code class="p">})();</code>

<code class="c1">// A very simple new mail handler</code>
<code class="c1">// A count of the number of messages received</code>
<code class="kd">let</code> <code class="nx">mailCounter</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

<code class="c1">// Initialize subscribers that will listen out for a topic</code>
<code class="c1">// with the name "inbox/newMessage".</code>
<code class="c1">// Render a preview of new messages</code>
<code class="kr">const</code> <code class="nx">subscriber1</code> <code class="o">=</code> <code class="nx">events</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'inbox/newMessage'</code><code class="p">,</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="c1">// Log the topic for debugging purposes</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'A new message was received:'</code><code class="p">,</code> <code class="nx">data</code><code class="p">);</code>

  <code class="c1">// Use the data that was passed from our subject</code>
  <code class="c1">// to display a message preview to the user</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'.messageSender'</code><code class="p">).</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">sender</code><code class="p">;</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'.messagePreview'</code><code class="p">).</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">body</code><code class="p">;</code>
<code class="p">});</code>

<code class="c1">// Here's another subscriber using the same data to perform</code>
<code class="c1">// a different task.</code>
<code class="c1">// Update the counter displaying the number of new</code>
<code class="c1">// messages received via the publisher</code>
<code class="kr">const</code> <code class="nx">subscriber2</code> <code class="o">=</code> <code class="nx">events</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'inbox/newMessage'</code><code class="p">,</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">querySelector</code><code class="p">(</code><code class="s1">'.newMessageCounter'</code><code class="p">).</code><code class="nx">innerHTML</code> <code class="o">=</code> <code class="o">++</code><code class="nx">mailCounter</code><code class="p">;</code>
<code class="p">});</code>

<code class="nx">events</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'inbox/newMessage'</code><code class="p">,</code> <code class="p">{</code>
  <code class="nx">sender</code><code class="o">:</code> <code class="s1">'hello@google.com'</code><code class="p">,</code>
  <code class="nx">body</code><code class="o">:</code> <code class="s1">'Hey there! How are you doing today?'</code><code class="p">,</code>
<code class="p">});</code>

<code class="c1">// We could then at a later point unsubscribe our subscribers</code>
<code class="c1">// from receiving any new topic notifications as follows:</code>
<code class="c1">// subscriber1.remove();</code>
<code class="c1">// subscriber2.remove();</code></pre>

<p>The general idea here is the promotion<a data-type="indexterm" data-primary="coupling" data-secondary="loose coupling of Publish/Subscribe" id="idm45017702548928"/><a data-type="indexterm" data-primary="loose coupling" data-secondary="Publish/Subscribe example" id="idm45017702547984"/> of loose coupling. Rather than single objects calling on the methods of other objects directly, they instead subscribe to a specific task or activity of another object and are notified when it occurs.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Advantages"><div class="sect2" id="advantages-1">
<h2>Advantages</h2>

<p>The Observer and Publish/Subscribe patterns<a data-type="indexterm" data-primary="Observer pattern" data-secondary="advantages" id="idm45017702545120"/><a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="advantages" id="idm45017702368256"/><a data-type="indexterm" data-primary="coupling" data-secondary="loose coupling of Publish/Subscribe" data-tertiary="advantage of Observer and Publish/Subscribe" id="idm45017702367296"/><a data-type="indexterm" data-primary="loose coupling" data-secondary="Publish/Subscribe example" data-tertiary="advantage of Observer and Publish/Subscribe" id="idm45017702366032"/><a data-type="indexterm" data-primary="decoupling" data-secondary="Observer pattern" id="idm45017702364768"/><a data-type="indexterm" data-primary="decoupling" data-secondary="Publish/Subscribe pattern" id="idm45017702363824"/> encourage us to think hard about the relationships between different application parts. They also help us identify layers containing direct relationships that could be replaced with sets of subjects and observers. This effectively could be used to break down an application into smaller, more loosely coupled blocks to improve code management and potential for reuse.</p>

<p>Further motivation for using the Observer pattern is in situations where we need to maintain consistency between related objects without making classes tightly coupled. For example, when an object needs to be able to notify other objects without making assumptions regarding those objects.</p>

<p>Dynamic relationships can exist between observers and subjects when using either pattern. This provides excellent flexibility that may not be as easy to implement when disparate parts of our application are tightly coupled.</p>

<p>While it may not always be the best solution to every problem, these patterns remain one of the best tools for designing decoupled systems and should be considered an essential tool in any JavaScript developer’s utility belt.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Disadvantages"><div class="sect2" id="disadvantages-1">
<h2>Disadvantages</h2>

<p>Consequently, some of the issues with<a data-type="indexterm" data-primary="Observer pattern" data-secondary="disadvantages" id="idm45017702359616"/><a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="disadvantages" id="idm45017702358640"/> these patterns actually stem from their main benefits. In Publish/Subscribe, by decoupling publishers from subscribers, it can sometimes become difficult to obtain guarantees that particular parts of our applications are functioning as we may expect.</p>

<p>For example, publishers may assume that one or more subscribers are listening to them. Say that we’re using such an assumption to log or output errors regarding some application process. If the subscriber performing the logging crashes (or for some reason fails to function), the publisher won’t have a way of seeing this due to the decoupled nature of the system.</p>

<p>Another drawback of the pattern is that subscribers are entirely ignorant of the existence of each other and are blind to the cost of switching publishers. Due to the dynamic relationship between subscribers and publishers, it can be difficult to track an update dependency.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Publish/Subscribe Implementations"><div class="sect2" id="publishsubscribe-implementations">
<h2>Publish/Subscribe Implementations</h2>

<p>Publish/Subscribe fits in very well<a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="implementations" id="ch07-psimp"/><a data-type="indexterm" data-primary="JavaScript" data-secondary="ECMAScript" data-tertiary="implementations event driven" id="idm45017702277488"/><a data-type="indexterm" data-primary="ECMAScript" data-secondary="implementations event driven" id="idm45017702276400"/><a data-type="indexterm" data-primary="events" data-secondary="ECMAScript implementations event driven" id="idm45017702275472"/><a data-type="indexterm" data-primary="DOM" data-secondary="events as main interaction" id="idm45017702274512"/> in JavaScript ecosystems, primarily because, at the core, ECMAScript implementations are event-driven. This is particularly true in browser environments, as the DOM uses events as its main interaction API for scripting.</p>

<p>That said, neither ECMAScript nor DOM provides core objects or methods for creating custom event systems in implementation code (except for perhaps the DOM3 
<span class="keep-together"><code>CustomEvent</code>,</span> which is bound to the DOM and is thus not generically applicable).</p>










<section data-type="sect3" data-pdf-bookmark="An example Publish/Subscribe implementation"><div class="sect3" id="a-publishsubscribe-implementation">
<h3>An example Publish/Subscribe implementation</h3>

<p>To better appreciate how many of the<a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="example PubSub implementation" id="ch07-pubsubex"/><a data-type="indexterm" data-primary="constructor() method" data-secondary="Publish/Subscribe implementation" id="idm45017702268672"/><a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="example PubSub implementation" data-tertiary="minimalist implementation" id="idm45017702267712"/><a data-type="indexterm" data-primary="pubsubz project" id="idm45017702266448"/> ordinary JavaScript implementations of the Observer pattern might work, let’s take a walkthrough of a minimalist version of Publish/Subscribe I released on GitHub under a project called <a href="https://oreil.ly/yPPfE">“pubsubz”</a>. This demonstrates the core concepts of subscribe and publish, and the idea of unsubscribing.</p>

<p>I’ve opted to base our examples on this code as it sticks closely to the method signatures and implementation approach I expect to see in a JavaScript version of the classic Observer pattern:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">class</code> <code class="nx">PubSub</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="c1">// Storage for topics that can be broadcast</code>
        <code class="c1">// or listened to</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">topics</code> <code class="o">=</code> <code class="p">{};</code>

        <code class="c1">// A topic identifier</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">subUid</code> <code class="o">=</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">publish</code><code class="p">(</code><code class="nx">topic</code><code class="p">,</code> <code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="k">this</code><code class="p">.</code><code class="nx">topics</code><code class="p">[</code><code class="nx">topic</code><code class="p">])</code> <code class="p">{</code>
            <code class="k">return</code> <code class="kc">false</code><code class="p">;</code>
        <code class="p">}</code>

        <code class="kr">const</code> <code class="nx">subscribers</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">topics</code><code class="p">[</code><code class="nx">topic</code><code class="p">];</code>
        <code class="kd">let</code> <code class="nx">len</code> <code class="o">=</code> <code class="nx">subscribers</code> <code class="o">?</code> <code class="nx">subscribers</code><code class="p">.</code><code class="nx">length</code> <code class="o">:</code> <code class="mi">0</code><code class="p">;</code>

        <code class="k">while</code> <code class="p">(</code><code class="nx">len</code><code class="o">--</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">subscribers</code><code class="p">[</code><code class="nx">len</code><code class="p">].</code><code class="nx">func</code><code class="p">(</code><code class="nx">topic</code><code class="p">,</code> <code class="nx">args</code><code class="p">);</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">subscribe</code><code class="p">(</code><code class="nx">topic</code><code class="p">,</code> <code class="nx">func</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="k">this</code><code class="p">.</code><code class="nx">topics</code><code class="p">[</code><code class="nx">topic</code><code class="p">])</code> <code class="p">{</code>
            <code class="k">this</code><code class="p">.</code><code class="nx">topics</code><code class="p">[</code><code class="nx">topic</code><code class="p">]</code> <code class="o">=</code> <code class="p">[];</code>
        <code class="p">}</code>

        <code class="kr">const</code> <code class="nx">token</code> <code class="o">=</code> <code class="p">(</code><code class="o">++</code><code class="k">this</code><code class="p">.</code><code class="nx">subUid</code><code class="p">).</code><code class="nx">toString</code><code class="p">();</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">topics</code><code class="p">[</code><code class="nx">topic</code><code class="p">].</code><code class="nx">push</code><code class="p">({</code>
            <code class="nx">token</code><code class="p">,</code>
            <code class="nx">func</code><code class="p">,</code>
        <code class="p">});</code>
        <code class="k">return</code> <code class="nx">token</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">unsubscribe</code><code class="p">(</code><code class="nx">token</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">for</code> <code class="p">(</code><code class="kr">const</code> <code class="nx">m</code> <code class="k">in</code> <code class="k">this</code><code class="p">.</code><code class="nx">topics</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">topics</code><code class="p">[</code><code class="nx">m</code><code class="p">])</code> <code class="p">{</code>
                <code class="k">for</code> <code class="p">(</code><code class="kd">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">j</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">topics</code><code class="p">[</code><code class="nx">m</code><code class="p">].</code><code class="nx">length</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">j</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
                    <code class="k">if</code> <code class="p">(</code><code class="k">this</code><code class="p">.</code><code class="nx">topics</code><code class="p">[</code><code class="nx">m</code><code class="p">][</code><code class="nx">i</code><code class="p">].</code><code class="nx">token</code> <code class="o">===</code> <code class="nx">token</code><code class="p">)</code> <code class="p">{</code>
                        <code class="k">this</code><code class="p">.</code><code class="nx">topics</code><code class="p">[</code><code class="nx">m</code><code class="p">].</code><code class="nx">splice</code><code class="p">(</code><code class="nx">i</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>

                        <code class="k">return</code> <code class="nx">token</code><code class="p">;</code>
                    <code class="p">}</code>
                <code class="p">}</code>
            <code class="p">}</code>
        <code class="p">}</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="kr">const</code> <code class="nx">pubsub</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">PubSub</code><code class="p">();</code>

<code class="nx">pubsub</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'/addFavorite'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'test'</code><code class="p">]);</code>
<code class="nx">pubsub</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'/addFavorite'</code><code class="p">,</code> <code class="p">(</code><code class="nx">topic</code><code class="p">,</code> <code class="nx">args</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'test'</code><code class="p">,</code> <code class="nx">topic</code><code class="p">,</code> <code class="nx">args</code><code class="p">);</code>
<code class="p">});</code></pre>

<p>Here we have defined a basic <code>PubSub</code> class that contains:</p>

<ul>
<li>
<p>A list of topics with subscribers who have subscribed to it.</p>
</li>
<li>
<p>The <code>Subscribe</code> method creates a new subscriber to a topic using the function to be called when publishing a topic and a unique token.</p>
</li>
<li>
<p>The <code>Unsubscribe</code> method removes a subscriber from the list based on the <code>token</code> value passed. The <code>Publish</code> method publishes content on a given topic to all its subscribers by calling the <code>registered</code> function.</p>
</li>
</ul>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Using our implementation"><div class="sect3" id="example-using-our-implementation">
<h3>Using our implementation</h3>

<p>We can now use the implementation to publish and subscribe to events of interest, as shown in <a data-type="xref" href="#using-our-implementation">Example 7-7</a>.<a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="example PubSub implementation" data-tertiary="using implementation" id="idm45017701939456"/></p>
<div id="using-our-implementation" data-type="example">
<h5><span class="label">Example 7-7. </span>Using our implementation</h5>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Another simple message handler</code>

<code class="c1">// A simple message logger that logs any topics and data received through our</code>
<code class="c1">// subscriber</code>
<code class="kr">const</code> <code class="nx">messageLogger</code> <code class="o">=</code> <code class="p">(</code><code class="nx">topics</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Logging: </code><code class="si">${</code><code class="nx">topics</code><code class="si">}</code><code class="sb">: </code><code class="si">${</code><code class="nx">data</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
<code class="p">};</code>

<code class="c1">// Subscribers listen for topics they have subscribed to and</code>
<code class="c1">// invoke a callback function (e.g., messageLogger) once a new</code>
<code class="c1">// notification is broadcast on that topic</code>
<code class="kr">const</code> <code class="nx">subscription</code> <code class="o">=</code> <code class="nx">pubsub</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'inbox/newMessage'</code><code class="p">,</code> <code class="nx">messageLogger</code><code class="p">);</code>

<code class="c1">// Publishers are in charge of publishing topics or notifications of</code>
<code class="c1">// interest to the application. e.g.:</code>

<code class="nx">pubsub</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'inbox/newMessage'</code><code class="p">,</code> <code class="s1">'hello world!'</code><code class="p">);</code>

<code class="c1">// or</code>
<code class="nx">pubsub</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'inbox/newMessage'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'test'</code><code class="p">,</code> <code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">]);</code>

<code class="c1">// or</code>
<code class="nx">pubsub</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'inbox/newMessage'</code><code class="p">,</code> <code class="p">{</code>
    <code class="nx">sender</code><code class="o">:</code> <code class="s1">'hello@google.com'</code><code class="p">,</code>
    <code class="nx">body</code><code class="o">:</code> <code class="s1">'Hey again!'</code><code class="p">,</code>
<code class="p">});</code>

<code class="c1">// We can also unsubscribe if we no longer wish for our subscribers</code>
<code class="c1">// to be notified</code>
<code class="nx">pubsub</code><code class="p">.</code><code class="nx">unsubscribe</code><code class="p">(</code><code class="nx">subscription</code><code class="p">);</code>

<code class="c1">// Once unsubscribed, this for example won't result in our</code>
<code class="c1">// messageLogger being executed as the subscriber is</code>
<code class="c1">// no longer listening</code>
<code class="nx">pubsub</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'inbox/newMessage'</code><code class="p">,</code> <code class="s1">'Hello! are you still there?'</code><code class="p">);</code></pre></div>
</div></section>










<section data-type="sect3" data-pdf-bookmark="UI notifications"><div class="sect3" id="example-user-interface-notifications">
<h3>UI notifications</h3>

<p>Next, let’s imagine we have a web application responsible for displaying real-time stock information.<a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="example PubSub implementation" data-tertiary="UI notifications" id="idm45017701754080"/><a data-type="indexterm" data-primary="UI notifications in PubSub implementation" id="idm45017701752928"/><a data-type="indexterm" data-primary="real-time display of information" id="idm45017701752288"/></p>

<p>The application might have a grid displaying the stock stats and a counter indicating the last update point. The application must update the grid and counter when the data model changes. In this scenario, our subject (which will be publishing topics/notifications) is the data model, and our subscribers are the grid and counter.</p>

<p>When our subscribers are notified that the model has changed, they can update themselves accordingly.</p>

<p>In our implementation, our subscriber will listen to the topic <code>newDataAvailable</code> to find out if new stock information is available. If a new notification is published to this topic, it will trigger <code>gridUpdate</code> to add a new row to our grid containing this information. It will also update the <em>last updated</em> counter to log the last time that data was added
(<a data-type="xref" href="#user-interface-notifications">Example 7-8</a>).<a data-type="indexterm" data-primary="get current time" id="idm45017701747872"/><a data-type="indexterm" data-primary="current time" id="idm45017701747168"/><a data-type="indexterm" data-primary="time stamp" id="idm45017701746496"/></p>
<div id="user-interface-notifications" data-type="example">
<h5><span class="label">Example 7-8. </span>UI notifications</h5>

<pre data-type="programlisting" data-code-language="javascript"><code class="c1">// Return the current local time to be used in our UI later</code>
<code class="nx">getCurrentTime</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">date</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">();</code>
    <code class="kr">const</code> <code class="nx">m</code> <code class="o">=</code> <code class="nx">date</code><code class="p">.</code><code class="nx">getMonth</code><code class="p">()</code> <code class="o">+</code> <code class="mi">1</code><code class="p">;</code>
    <code class="kr">const</code> <code class="nx">d</code> <code class="o">=</code> <code class="nx">date</code><code class="p">.</code><code class="nx">getDate</code><code class="p">();</code>
    <code class="kr">const</code> <code class="nx">y</code> <code class="o">=</code> <code class="nx">date</code><code class="p">.</code><code class="nx">getFullYear</code><code class="p">();</code>
    <code class="kr">const</code> <code class="nx">t</code> <code class="o">=</code> <code class="nx">date</code><code class="p">.</code><code class="nx">toLocaleTimeString</code><code class="p">().</code><code class="nx">toLowerCase</code><code class="p">();</code>

    <code class="k">return</code> <code class="sb">`</code><code class="si">${</code><code class="nx">m</code><code class="si">}</code><code class="sb">/</code><code class="si">${</code><code class="nx">d</code><code class="si">}</code><code class="sb">/</code><code class="si">${</code><code class="nx">y</code><code class="si">}</code><code class="sb"> </code><code class="si">${</code><code class="nx">t</code><code class="si">}</code><code class="sb">`</code><code class="p">;</code>
  <code class="p">};</code>

  <code class="c1">// Add a new row of data to our fictional grid component</code>
  <code class="kr">const</code> <code class="nx">addGridRow</code> <code class="o">=</code> <code class="nx">data</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// ui.grid.addRow( data );</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`updated grid component with:</code><code class="si">${</code><code class="nx">data</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
  <code class="p">};</code>

  <code class="c1">// Update our fictional grid to show the time it was last</code>
  <code class="c1">// updated</code>
  <code class="kr">const</code> <code class="nx">updateCounter</code> <code class="o">=</code> <code class="nx">data</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// ui.grid.updateLastChanged( getCurrentTime() );</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`data last updated at: </code><code class="si">${</code><code class="nx">getCurrentTime</code><code class="p">()</code><code class="si">}</code><code class="sb"> with </code><code class="si">${</code><code class="nx">data</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
  <code class="p">};</code>

  <code class="c1">// Update the grid using the data passed to our subscribers</code>
  <code class="kr">const</code> <code class="nx">gridUpdate</code> <code class="o">=</code> <code class="p">(</code><code class="nx">topic</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">data</code> <code class="o">!==</code> <code class="kc">undefined</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">addGridRow</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
      <code class="nx">updateCounter</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
    <code class="p">}</code>
  <code class="p">};</code>


<code class="c1">// Create a subscription to the newDataAvailable topic</code>
<code class="kr">const</code> <code class="nx">subscriber</code> <code class="o">=</code> <code class="nx">pubsub</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'newDataAvailable'</code><code class="p">,</code> <code class="nx">gridUpdate</code><code class="p">);</code>

<code class="c1">// The following represents updates to our data layer. This could be</code>
<code class="c1">// powered by ajax requests that broadcast that new data is available</code>
<code class="c1">// to the rest of the application.</code>

<code class="c1">// Publish changes to the gridUpdated topic representing new entries</code>
<code class="nx">pubsub</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'newDataAvailable'</code><code class="p">,</code> <code class="p">{</code>
  <code class="nx">summary</code><code class="o">:</code> <code class="s1">'Apple made $5 billion'</code><code class="p">,</code>
  <code class="nx">identifier</code><code class="o">:</code> <code class="s1">'APPL'</code><code class="p">,</code>
  <code class="nx">stockPrice</code><code class="o">:</code> <code class="mf">570.91</code><code class="p">,</code>
<code class="p">});</code>

<code class="nx">pubsub</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'newDataAvailable'</code><code class="p">,</code> <code class="p">{</code>
  <code class="nx">summary</code><code class="o">:</code> <code class="s1">'Microsoft made $20 million'</code><code class="p">,</code>
  <code class="nx">identifier</code><code class="o">:</code> <code class="s1">'MSFT'</code><code class="p">,</code>
  <code class="nx">stockPrice</code><code class="o">:</code> <code class="mf">30.85</code><code class="p">,</code>
<code class="p">});</code></pre></div>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Decoupling applications using Ben Alman’s Pub/Sub implementation"><div class="sect3" id="example-decoupling-applications-using-ben-almans-pubsub-implementation">
<h3>Decoupling applications using Ben Alman’s Pub/Sub implementation</h3>

<p>In the following movie rating example,<a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="example PubSub implementation" data-tertiary="decoupled UI" id="idm45017701708528"/><a data-type="indexterm" data-primary="UI notifications in PubSub implementation" data-secondary="decoupled UI" id="idm45017701537504"/><a data-type="indexterm" data-primary="real-time display of information" data-secondary="decoupled UI in Publish/Subscribe" id="idm45017701536592"/><a data-type="indexterm" data-primary="decoupling" data-secondary="Publish/Subscribe pattern" data-tertiary="UI decoupled" id="idm45017701535664"/><a data-type="indexterm" data-primary="decoupling" data-secondary="UIs" data-tertiary="Publish/Subscribe pattern" id="idm45017701534432"/><a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="example jQuery implementation with decoupled UI" id="idm45017701533200"/><a data-type="indexterm" data-primary="Alman, Ben" id="idm45017701532272"/><a data-type="indexterm" data-primary="jQuery" data-secondary="Publish/Subscribe" data-tertiary="decoupled UI" id="idm45017701531600"/> we’ll use <a href="https://oreil.ly/w9ECl">Ben Alman’s jQuery implementation of Publish/Subscribe</a> to demonstrate how we can decouple a UI. Notice how 
<span class="keep-together">submitting</span> a rating only has the effect of publishing the fact that new user and rating data is available.</p>

<p>It’s left up to the subscribers to those topics to delegate what happens with that data. In our case, we’re pushing that new data into existing arrays and then rendering them using the Lodash library’s <code>.template()</code> method for templating.<a data-type="indexterm" data-primary="Lodash library" data-secondary="templating" id="idm45017701528096"/><a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="example jQuery implementation with decoupled UI" data-tertiary="templating with Lodash" id="idm45017701527088"/><a data-type="indexterm" data-primary="templating" data-secondary="Lodash library example code" id="idm45017701425104"/><a data-type="indexterm" data-primary="JavaScript" data-secondary="templating" data-tertiary="Lodash library" id="idm45017701424208"/><a data-type="indexterm" data-primary="views" data-secondary="templating" data-tertiary="Lodash library" id="idm45017701422992"/></p>

<p><a data-type="xref" href="#html-templates-code">Example 7-9</a> has the HTML/Templates code.</p>
<div id="html-templates-code" data-type="example">
<h5><span class="label">Example 7-9. </span>HTML/Templates code for Pub/Sub</h5>

<pre data-type="programlisting" data-code-language="html"><code class="p">&lt;</code><code class="nt">script</code> <code class="na">id</code><code class="o">=</code><code class="s">"userTemplate"</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/html"</code><code class="p">&gt;</code><code class="w"/>
<code class="w">   </code><code class="o">&lt;</code><code class="nx">li</code><code class="o">&gt;&lt;%-</code><code class="w"> </code><code class="nx">name</code><code class="w"> </code><code class="o">%&gt;&lt;</code><code class="err">/li&gt;</code><code class="w"/>
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>


<code class="p">&lt;</code><code class="nt">script</code> <code class="na">id</code><code class="o">=</code><code class="s">"ratingsTemplate"</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/html"</code><code class="p">&gt;</code><code class="w"/>
<code class="w">   </code><code class="o">&lt;</code><code class="nx">li</code><code class="o">&gt;&lt;</code><code class="nx">strong</code><code class="o">&gt;&lt;%-</code><code class="w"> </code><code class="nx">title</code><code class="w"> </code><code class="o">%&gt;&lt;</code><code class="err">/strong&gt; was rated &lt;%- rating %&gt;/5&lt;/li&gt;</code><code class="w"/>
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>


<code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"container"</code><code class="p">&gt;</code>

   <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"sampleForm"</code><code class="p">&gt;</code>
       <code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
           <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"twitter_handle"</code><code class="p">&gt;</code>Twitter handle:<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
           <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">id</code><code class="o">=</code><code class="s">"twitter_handle"</code> <code class="p">/&gt;</code>
       <code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
       <code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>
           <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"movie_seen"</code><code class="p">&gt;</code>Name a movie you've seen this year:<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
           <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">id</code><code class="o">=</code><code class="s">"movie_seen"</code> <code class="p">/&gt;</code>
       <code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
       <code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>

           <code class="p">&lt;</code><code class="nt">label</code> <code class="na">for</code><code class="o">=</code><code class="s">"movie_rating"</code><code class="p">&gt;</code>Rate the movie you saw:<code class="p">&lt;/</code><code class="nt">label</code><code class="p">&gt;</code>
           <code class="p">&lt;</code><code class="nt">select</code> <code class="na">id</code><code class="o">=</code><code class="s">"movie_rating"</code><code class="p">&gt;</code>
                 <code class="p">&lt;</code><code class="nt">option</code> <code class="na">value</code><code class="o">=</code><code class="s">"1"</code><code class="p">&gt;</code>1<code class="p">&lt;/</code><code class="nt">option</code><code class="p">&gt;</code>
                  <code class="p">&lt;</code><code class="nt">option</code> <code class="na">value</code><code class="o">=</code><code class="s">"2"</code><code class="p">&gt;</code>2<code class="p">&lt;/</code><code class="nt">option</code><code class="p">&gt;</code>
                  <code class="p">&lt;</code><code class="nt">option</code> <code class="na">value</code><code class="o">=</code><code class="s">"3"</code><code class="p">&gt;</code>3<code class="p">&lt;/</code><code class="nt">option</code><code class="p">&gt;</code>
                  <code class="p">&lt;</code><code class="nt">option</code> <code class="na">value</code><code class="o">=</code><code class="s">"4"</code><code class="p">&gt;</code>4<code class="p">&lt;/</code><code class="nt">option</code><code class="p">&gt;</code>
                  <code class="p">&lt;</code><code class="nt">option</code> <code class="na">value</code><code class="o">=</code><code class="s">"5"</code> <code class="na">selected</code><code class="p">&gt;</code>5<code class="p">&lt;/</code><code class="nt">option</code><code class="p">&gt;</code>

          <code class="p">&lt;/</code><code class="nt">select</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>

            <code class="p">&lt;</code><code class="nt">button</code> <code class="na">id</code><code class="o">=</code><code class="s">"add"</code><code class="p">&gt;</code>Submit rating<code class="p">&lt;/</code><code class="nt">button</code><code class="p">&gt;</code>
        <code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>



    <code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"summaryTable"</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"users"</code><code class="p">&gt;&lt;</code><code class="nt">h3</code><code class="p">&gt;</code>Recent users<code class="p">&lt;/</code><code class="nt">h3</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
        <code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"ratings"</code><code class="p">&gt;&lt;</code><code class="nt">h3</code><code class="p">&gt;</code>Recent movies rated<code class="p">&lt;/</code><code class="nt">h3</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>
    <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>

 <code class="p">&lt;/</code><code class="nt">div</code><code class="p">&gt;</code></pre></div>

<p>The JavaScript code is in <a data-type="xref" href="#the-javascript-code">Example 7-10</a>.<a data-type="indexterm" data-startref="ch07-pubsubex" id="idm45017701414576"/></p>
<div id="the-javascript-code" data-type="example">
<h5><span class="label">Example 7-10. </span>JavaScript code for Pub/Sub</h5>

<pre data-type="programlisting" data-code-language="javascript"><code class="p">;(</code><code class="nx">$</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// Pre-compile templates and "cache" them using closure</code>
    <code class="kr">const</code> <code class="nx">userTemplate</code> <code class="o">=</code> <code class="nx">_</code><code class="p">.</code><code class="nx">template</code><code class="p">(</code><code class="nx">$</code><code class="p">(</code><code class="s1">'#userTemplate'</code><code class="p">).</code><code class="nx">html</code><code class="p">());</code>

    <code class="kr">const</code> <code class="nx">ratingsTemplate</code> <code class="o">=</code> <code class="nx">_</code><code class="p">.</code><code class="nx">template</code><code class="p">(</code><code class="nx">$</code><code class="p">(</code><code class="s1">'#ratingsTemplate'</code><code class="p">).</code><code class="nx">html</code><code class="p">());</code>

    <code class="c1">// Subscribe to the new user topic, which adds a user</code>
    <code class="c1">// to a list of users who have submitted reviews</code>
    <code class="nx">$</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'/new/user'</code><code class="p">,</code> <code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">$</code><code class="p">(</code><code class="s1">'#users'</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="nx">userTemplate</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
      <code class="p">}</code>
    <code class="p">});</code>

    <code class="c1">// Subscribe to the new rating topic. This is composed of a title and</code>
    <code class="c1">// rating. New ratings are appended to a running list of added user</code>
    <code class="c1">// ratings.</code>
    <code class="nx">$</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'/new/rating'</code><code class="p">,</code> <code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">$</code><code class="p">(</code><code class="s1">'#ratings'</code><code class="p">).</code><code class="nx">append</code><code class="p">(</code><code class="nx">ratingsTemplate</code><code class="p">(</code><code class="nx">data</code><code class="p">));</code>
      <code class="p">}</code>
    <code class="p">});</code>

    <code class="c1">// Handler for adding a new user</code>
    <code class="nx">$</code><code class="p">(</code><code class="s1">'#add'</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="nx">e</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="nx">e</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>

      <code class="kr">const</code> <code class="nx">strUser</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="s1">'#twitter_handle'</code><code class="p">).</code><code class="nx">val</code><code class="p">();</code>
      <code class="kr">const</code> <code class="nx">strMovie</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="s1">'#movie_seen'</code><code class="p">).</code><code class="nx">val</code><code class="p">();</code>
      <code class="kr">const</code> <code class="nx">strRating</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="s1">'#movie_rating'</code><code class="p">).</code><code class="nx">val</code><code class="p">();</code>

      <code class="c1">// Inform the application a new user is available</code>
      <code class="nx">$</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'/new/user'</code><code class="p">,</code> <code class="p">{</code>
        <code class="nx">name</code><code class="o">:</code> <code class="nx">strUser</code><code class="p">,</code>
      <code class="p">});</code>

      <code class="c1">// Inform the app a new rating is available</code>
      <code class="nx">$</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'/new/rating'</code><code class="p">,</code> <code class="p">{</code>
        <code class="nx">title</code><code class="o">:</code> <code class="nx">strMovie</code><code class="p">,</code>
        <code class="nx">rating</code><code class="o">:</code> <code class="nx">strRating</code><code class="p">,</code>
      <code class="p">});</code>
    <code class="p">});</code>
  <code class="p">})(</code><code class="nx">jQuery</code><code class="p">);</code></pre></div>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Decoupling an Ajax-based jQuery application"><div class="sect3" id="example-decoupling-an-ajax-based-jquery-application">
<h3>Decoupling an Ajax-based jQuery application</h3>

<p>In our final example, we’ll take a practical<a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="example Ajax-based jQuery application decoupled" id="idm45017700891264"/><a data-type="indexterm" data-primary="jQuery" data-secondary="Publish/Subscribe" data-tertiary="Ajax-based decoupled" id="idm45017700933648"/><a data-type="indexterm" data-primary="Ajax-based jQuery application decoupled" id="idm45017700932432"/><a data-type="indexterm" data-primary="decoupling" data-secondary="Publish/Subscribe pattern" data-tertiary="Ajax-based application decoupled" id="idm45017700931792"/> look at how decoupling our code using Pub/Sub early in the development process can save us some potentially painful refactoring later.</p>

<p>Often in Ajax-heavy applications, we want to achieve more than just one unique action once we’ve received a response to a request. We could add all of the post-request logic into a success callback, but there are drawbacks to this approach.</p>

<p>Highly coupled applications sometimes<a data-type="indexterm" data-primary="coupling" data-secondary="highly coupled application reuse effort" id="idm45017700929712"/> increase the effort required to reuse functionality due to the increased interfunction/code dependency. Keeping our post-request logic hardcoded in a callback might be okay if we just try to grab a result set once. However, it’s not as appropriate when we want to make further Ajax calls to the same data source (and different end behavior) without rewriting parts of the code multiple times. Rather than going back through each layer that calls the same data source and generalizing them later on, we can use Pub/Sub from the start and save time.</p>

<p>Using observers, we can also easily<a data-type="indexterm" data-primary="Observer pattern" data-secondary="about" data-tertiary="notification granularity" id="idm45017700928256"/> separate application-wide notifications regarding different events down to whatever level of granularity we’re comfortable with—something that can be less elegantly done using other patterns.</p>

<p>Notice how in our upcoming sample, one topic notification is made when a user indicates that he wants to make a search query. Another is made when the request returns and actual data is available for consumption. It’s left up to the subscribers to then decide how to use knowledge of these events (or the data returned). The benefits of this are that, if we wanted, we could have 10 different subscribers using the data returned in different ways, but as far as the Ajax layer is concerned, it doesn’t care. Its sole duty is to request and return data and then pass it on to whoever wants to use it. This separation of concerns can make the overall design of our code a little cleaner.</p>

<p>The HTML/Templates code is shown in <a data-type="xref" href="#html-templates-ajax">Example 7-11</a>.</p>
<div id="html-templates-ajax" data-type="example">
<h5><span class="label">Example 7-11. </span>HTML/Templates code for Ajax</h5>

<pre data-type="programlisting" data-code-language="html"><code class="p">&lt;</code><code class="nt">form</code> <code class="na">id</code><code class="o">=</code><code class="s">"flickrSearch"</code><code class="p">&gt;</code>

   <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"tag"</code> <code class="na">id</code><code class="o">=</code><code class="s">"query"</code><code class="p">/&gt;</code>

   <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code> <code class="na">name</code><code class="o">=</code><code class="s">"submit"</code> <code class="na">value</code><code class="o">=</code><code class="s">"submit"</code><code class="p">/&gt;</code>

<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code>



<code class="p">&lt;</code><code class="nt">div</code> <code class="na">id</code><code class="o">=</code><code class="s">"lastQuery"</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>

<code class="p">&lt;</code><code class="nt">ol</code> <code class="na">id</code><code class="o">=</code><code class="s">"searchResults"</code><code class="p">&gt;&lt;/</code><code class="nt">ol</code><code class="p">&gt;</code>



<code class="p">&lt;</code><code class="nt">script</code> <code class="na">id</code><code class="o">=</code><code class="s">"resultTemplate"</code> <code class="na">type</code><code class="o">=</code><code class="s">"text/html"</code><code class="p">&gt;</code><code class="w"/>
<code class="w">    </code><code class="o">&lt;%</code><code class="w"> </code><code class="nx">_</code><code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="nx">items</code><code class="p">,</code><code class="w"> </code><code class="kd">function</code><code class="p">(</code><code class="w"> </code><code class="nx">item</code><code class="w"> </code><code class="p">){</code><code class="w"> </code><code class="o">%&gt;</code><code class="w"/>
<code class="w">        </code><code class="o">&lt;</code><code class="nx">li</code><code class="o">&gt;&lt;</code><code class="nx">img</code><code class="w"> </code><code class="nx">src</code><code class="o">=</code><code class="s2">"&lt;%= item.media.m %&gt;"</code><code class="o">/&gt;&lt;</code><code class="err">/li&gt;</code><code class="w"/>
<code class="w">    </code><code class="o">&lt;%</code><code class="w"> </code><code class="p">});</code><code class="o">%&gt;</code><code class="w"/>
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code></pre></div>

<p><a data-type="xref" href="#javascript-code-ajax">Example 7-12</a> shows the JavaScript code.</p>
<div id="javascript-code-ajax" data-type="example">
<h5><span class="label">Example 7-12. </span>JavaScript code for Ajax</h5>

<pre data-type="programlisting" data-code-language="javascript"><code class="p">(</code><code class="nx">$</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="c1">// Pre-compile template and "cache" it using closure</code>
    <code class="kr">const</code> <code class="nx">resultTemplate</code> <code class="o">=</code> <code class="nx">_</code><code class="p">.</code><code class="nx">template</code><code class="p">(</code><code class="nx">$</code><code class="p">(</code><code class="s1">'#resultTemplate'</code><code class="p">).</code><code class="nx">html</code><code class="p">());</code>

    <code class="c1">// Subscribe to the new search tags topic</code>
    <code class="nx">$</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'/search/tags'</code><code class="p">,</code> <code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">tags</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="nx">$</code><code class="p">(</code><code class="s1">'#lastQuery'</code><code class="p">).</code><code class="nx">html</code><code class="p">(</code><code class="sb">`Searched for: </code><code class="si">${</code><code class="nx">tags</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
    <code class="p">});</code>

    <code class="c1">// Subscribe to the new results topic</code>
    <code class="nx">$</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'/search/resultSet'</code><code class="p">,</code> <code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">results</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="nx">$</code><code class="p">(</code><code class="s1">'#searchResults'</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">empty</code><code class="p">()</code>
        <code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="nx">resultTemplate</code><code class="p">(</code><code class="nx">results</code><code class="p">));</code>
    <code class="p">});</code>

    <code class="c1">// Submit a search query and publish tags on the /search/tags topic</code>
    <code class="nx">$</code><code class="p">(</code><code class="s1">'#flickrSearch'</code><code class="p">).</code><code class="nx">submit</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">e</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>
      <code class="kr">const</code> <code class="nx">tags</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="k">this</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="s1">'#query'</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">val</code><code class="p">();</code>

      <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">tags</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">return</code><code class="p">;</code>
      <code class="p">}</code>

      <code class="nx">$</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'/search/tags'</code><code class="p">,</code> <code class="p">[</code><code class="nx">$</code><code class="p">.</code><code class="nx">trim</code><code class="p">(</code><code class="nx">tags</code><code class="p">)]);</code>
    <code class="p">});</code>

    <code class="c1">// Subscribe to new tags being published and perform a search query</code>
    <code class="c1">// using them. Once data has returned publish this data for the rest</code>
    <code class="c1">// of the application to consume. We used the destructuring assignment</code>
    <code class="c1">// syntax that makes it possible to unpack values from data structures</code>
    <code class="c1">// into distinct variables.</code>

    <code class="nx">$</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'/search/tags'</code><code class="p">,</code> <code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="nx">tags</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="nx">$</code><code class="p">.</code><code class="nx">getJSON</code><code class="p">(</code>
        <code class="s1">'http://api.flickr.com/services/feeds/photos_public.gne?jsoncallback=?'</code><code class="p">,</code>
        <code class="p">{</code>
          <code class="nx">tags</code><code class="p">,</code>
          <code class="nx">tagmode</code><code class="o">:</code> <code class="s1">'any'</code><code class="p">,</code>
          <code class="nx">format</code><code class="o">:</code> <code class="s1">'json'</code><code class="p">,</code>
        <code class="p">},</code>
        <code class="c1">// The destructuring assignment as function parameter</code>
        <code class="p">({</code> <code class="nx">items</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">items</code><code class="p">.</code><code class="nx">length</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code><code class="p">;</code>
          <code class="p">}</code>
          <code class="c1">//shorthand property names in object creation,</code>
          <code class="c1">// if variable name equal to object key</code>
          <code class="nx">$</code><code class="p">.</code><code class="nx">publish</code><code class="p">(</code><code class="s1">'/search/resultSet'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">items</code> <code class="p">});</code>
        <code class="p">}</code>
      <code class="p">);</code>
    <code class="p">});</code>
  <code class="p">})(</code><code class="nx">jQuery</code><code class="p">);</code></pre></div>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Observer pattern in the React ecosystem"><div class="sect3" id="idm45017700892672">
<h3>Observer pattern in the React ecosystem</h3>

<p>A popular library that uses the observable pattern is RxJS. The RxJS <a href="https://oreil.ly/JH3lY">documentation</a> states that:<a data-type="indexterm" data-primary="Observer pattern" data-secondary="React ecosystem" id="idm45017700495760"/><a data-type="indexterm" data-primary="React (React.js)" data-secondary="Observer pattern and" id="idm45017700526336"/><a data-type="indexterm" data-primary="RxJS and Observer pattern" id="idm45017700525392"/><a data-type="indexterm" data-primary="RxJS and Observer pattern" data-secondary="documentation for RxJS" id="idm45017700524752"/><a data-type="indexterm" data-primary="resources online" data-secondary="RxJS documentation" id="idm45017700523840"/></p>
<blockquote>
<p>ReactiveX combines the Observer pattern with the Iterator pattern and functional programming with collections to fill the need for an ideal way of managing sequences of events.</p></blockquote>

<p>With RxJS, we can create observers and subscribe to certain events! Let’s look at an example from their documentation, which logs whether a user was dragging in the document:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">import</code> <code class="nx">ReactDOM</code> <code class="nx">from</code> <code class="s2">"react-dom"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">fromEvent</code><code class="p">,</code> <code class="nx">merge</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"rxjs"</code><code class="p">;</code>
<code class="kr">import</code> <code class="p">{</code> <code class="nx">sample</code><code class="p">,</code> <code class="nx">mapTo</code> <code class="p">}</code> <code class="nx">from</code> <code class="s2">"rxjs/operators"</code><code class="p">;</code>

<code class="kr">import</code> <code class="s2">"./styles.css"</code><code class="p">;</code>

<code class="nx">merge</code><code class="p">(</code>
  <code class="nx">fromEvent</code><code class="p">(</code><code class="nb">document</code><code class="p">,</code> <code class="s2">"mousedown"</code><code class="p">).</code><code class="nx">pipe</code><code class="p">(</code><code class="nx">mapTo</code><code class="p">(</code><code class="kc">false</code><code class="p">)),</code>
  <code class="nx">fromEvent</code><code class="p">(</code><code class="nb">document</code><code class="p">,</code> <code class="s2">"mousemove"</code><code class="p">).</code><code class="nx">pipe</code><code class="p">(</code><code class="nx">mapTo</code><code class="p">(</code><code class="kc">true</code><code class="p">))</code>
<code class="p">)</code>
  <code class="p">.</code><code class="nx">pipe</code><code class="p">(</code><code class="nx">sample</code><code class="p">(</code><code class="nx">fromEvent</code><code class="p">(</code><code class="nb">document</code><code class="p">,</code> <code class="s2">"mouseup"</code><code class="p">)))</code>
  <code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="nx">isDragging</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"Were you dragging?"</code><code class="p">,</code> <code class="nx">isDragging</code><code class="p">);</code>
  <code class="p">});</code>

<code class="nx">ReactDOM</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code>
  <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">className</code><code class="o">=</code><code class="s2">"App"</code><code class="o">&gt;</code><code class="nx">Click</code> <code class="nx">or</code> <code class="nx">drag</code> <code class="nx">anywhere</code> <code class="nx">and</code> <code class="nx">check</code> <code class="nx">the</code> <code class="nx">console</code><code class="o">!&lt;</code><code class="err">/div&gt;,</code>
  <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s2">"root"</code><code class="p">)</code>
<code class="p">);</code></pre>

<p>The Observer pattern helps decouple several different scenarios in application design. If you haven’t been using it, I recommend picking up one of the prewritten implementations mentioned here and giving it a try. It’s one of the easier design patterns to get started with but also one of the most powerful.<a data-type="indexterm" data-startref="ch07-obs" id="idm45017700360496"/><a data-type="indexterm" data-startref="ch07-obs2" id="idm45017700359888"/><a data-type="indexterm" data-startref="ch07-obs3" id="idm45017700268096"/><a data-type="indexterm" data-startref="ch07-psimp" id="idm45017700267424"/></p>
</div></section>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Mediator Pattern"><div class="sect1" id="the-mediator-pattern">
<h1>The Mediator Pattern</h1>

<p>The Mediator pattern is a design pattern<a data-type="indexterm" data-primary="Mediator pattern" id="ch07med"/><a data-type="indexterm" data-primary="behavioral design patterns" data-secondary="Mediator pattern" id="ch07med2"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="behavioral design patterns" data-tertiary="Mediator pattern" id="ch07med3"/><a data-type="indexterm" data-primary="Mediator pattern" data-secondary="about" id="idm45017700261312"/><a data-type="indexterm" data-primary="events" data-secondary="Mediator notifying of events in other objects" id="idm45017700228368"/> that allows one object to notify a set of other objects when an event occurs. <a data-type="indexterm" data-primary="Mediator pattern" data-secondary="Observer pattern versus" id="idm45017700227392"/><a data-type="indexterm" data-primary="Observer pattern" data-secondary="Mediator pattern versus" id="idm45017700226544"/><a data-type="indexterm" data-primary="events" data-secondary="Observer versus Mediator" id="idm45017700225696"/>The difference between the Mediator and Observer patterns is that the Mediator pattern allows one object to be notified of events that occur in other objects. In contrast, the Observer pattern allows one object to subscribe to multiple events that occur in other objects.</p>

<p>In the section on the Observer pattern,<a data-type="indexterm" data-primary="events" data-secondary="Publish/Subscribe as Event Aggregation" id="idm45017700224464"/><a data-type="indexterm" data-primary="Observer pattern" data-secondary="Event Aggregation" data-seealso="Publish/Subscribe pattern" id="idm45017700223616"/><a data-type="indexterm" data-primary="Event Aggregator pattern" data-seealso="Publish/Subscribe pattern" id="idm45017700222528"/> we discussed a way of channeling multiple event sources through a single object. This is also known as Publish/Subscribe or Event Aggregation. It’s common for developers to think of mediators when faced with this problem, so let’s explore how they differ.</p>

<p>The dictionary refers to a<a data-type="indexterm" data-primary="Mediator pattern" data-secondary="about" data-tertiary="about mediators" id="idm45017700221168"/> mediator as a neutral party that assists in negotiations and conflict resolution.<sup><a data-type="noteref" id="idm45017700219792-marker" href="ch07.xhtml#idm45017700219792">1</a></sup> In our world, a mediator is a behavioral design pattern that allows us to expose a unified interface through which the different parts of a system may communicate.</p>

<p>If it appears that a system has too many direct relationships between components, it may be time to have a central point of control that components communicate through instead. <a data-type="indexterm" data-primary="loose coupling" data-secondary="mediator promoting" id="idm45017700217504"/><a data-type="indexterm" data-primary="coupling" data-secondary="mediator promoting loose coupling" id="idm45017700216592"/>The mediator promotes loose coupling by ensuring that interactions between components are managed centrally instead of having components refer to each other explicitly. This can help us decouple systems and improve the potential for component reusability.</p>

<p>A real-world analogy could be a typical airport traffic control system. A tower (mediator) handles what planes can take off and land because all communications (notifications being listened out for or broadcast) take place from the aircraft to the control tower rather than from plane to plane. A centralized controller is key to the success of this system, and that’s the role a mediator plays in software design (<a data-type="xref" href="#mediator">Figure 7-11</a>).</p>

<figure><div id="mediator" class="figure">
<img src="Images/ljd2_0711.png" alt="ljd2 0711" width="1004" height="567"/>
<h6><span class="label">Figure 7-11. </span>Mediator pattern</h6>
</div></figure>

<p>Another analogy would be DOM<a data-type="indexterm" data-primary="DOM" data-secondary="Mediator explained by analogy" id="idm45017700211920"/><a data-type="indexterm" data-primary="events" data-secondary="Mediator notifying of events in other objects" data-tertiary="analogy explaining Mediator" id="idm45017700210928"/> event bubbling and event delegation.  If all subscriptions in a system are made against the document rather than individual nodes, the document effectively serves as a Mediator. Instead of binding to the events of the individual nodes, a higher-level object is given the responsibility of notifying subscribers about interaction events.</p>

<p>When it comes to the Mediator and<a data-type="indexterm" data-primary="Mediator pattern" data-secondary="Publish/Subscribe (Event Aggregator) versus" id="idm45017700209152"/><a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="Mediator pattern versus" id="idm45017700208144"/><a data-type="indexterm" data-primary="events" data-secondary="Mediator notifying of events in other objects" data-tertiary="event aggregator versus" id="idm45017700207136"/> Event Aggregator patterns, sometimes it may look like the patterns are interchangeable due to implementation similarities. However, the semantics and intent of these patterns are very different.</p>

<p>And even if the implementations both use some of the same core constructs, I believe there is a distinct difference between them. They should not be interchanged or confused in communication because of their differences.</p>








<section data-type="sect2" data-pdf-bookmark="A Simple Mediator"><div class="sect2" id="simple-mediator">
<h2>A Simple Mediator</h2>

<p>A mediator is an object that coordinates<a data-type="indexterm" data-primary="Mediator pattern" data-secondary="simple mediator" id="idm45017700203296"/><a data-type="indexterm" data-primary="Mediator pattern" data-secondary="about" data-tertiary="about mediators" id="idm45017700202320"/><a data-type="indexterm" data-primary="events" data-secondary="Mediator notifying of events in other objects" data-tertiary="simple mediator" id="idm45017700201104"/> interactions (logic and behavior) between multiple objects. It decides when to call which objects based on the actions (or inaction) of other objects and input.</p>

<p>You can write a mediator using a single line of code:<a data-type="indexterm" data-primary="object literal notation module pattern" data-secondary="mediator as" id="idm45017700199280"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">mediator</code> <code class="o">=</code> <code class="p">{};</code></pre>

<p>Yes, of course, this is just an object literal in JavaScript. Once again, we’re talking about semantics here. The mediator’s purpose is to control the workflow between objects; we really don’t need anything more than an object literal to do this.</p>

<p>The following example shows a basic implementation of a <code>mediator</code> object with some utility methods that can trigger and subscribe to events. The <code>orgChart</code> object here is a mediator that assigns actions to be taken on the occurrence of a particular event. Here, a manager is assigned to the employee on completing the details of a new employee, and the employee record is saved:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">orgChart</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">addNewEmployee</code><code class="p">()</code> <code class="p">{</code>
        <code class="c1">// getEmployeeDetail provides a view that users interact with</code>
        <code class="kr">const</code> <code class="nx">employeeDetail</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">getEmployeeDetail</code><code class="p">();</code>

        <code class="c1">// when the employee detail is complete, the mediator (the 'orgchart'</code>
        <code class="c1">// object) decides what should happen next</code>
        <code class="nx">employeeDetail</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'complete'</code><code class="p">,</code> <code class="nx">employee</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="c1">// set up additional objects that have additional events, which are</code>
            <code class="c1">// used by the mediator to do additional things</code>
            <code class="kr">const</code> <code class="nx">managerSelector</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">selectManager</code><code class="p">(</code><code class="nx">employee</code><code class="p">);</code>
            <code class="nx">managerSelector</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'save'</code><code class="p">,</code> <code class="nx">employee</code> <code class="o">=&gt;</code> <code class="p">{</code>
                <code class="nx">employee</code><code class="p">.</code><code class="nx">save</code><code class="p">();</code>
            <code class="p">});</code>
        <code class="p">});</code>
    <code class="p">},</code>

    <code class="c1">// ...</code>
<code class="p">};</code></pre>

<p>I’ve often referred to this type<a data-type="indexterm" data-primary="workflow objects" data-seealso="Mediator pattern" id="idm45017700074912"/><a data-type="indexterm" data-primary="objects" data-secondary="workflow objects" data-seealso="Mediator pattern" id="idm45017700074064"/> of object as a “workflow” object in the past, but the truth is that it is a mediator. It is an object that handles the workflow between many other objects, aggregating the responsibility of that workflow knowledge into a single object. The result is a workflow that is easier to understand and maintain.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Similarities and Differences"><div class="sect2" id="idm45017700118896">
<h2>Similarities and Differences</h2>

<p>There are, without a doubt, similarities<a data-type="indexterm" data-primary="events" data-secondary="Mediator notifying of events in other objects" data-tertiary="event aggregator versus" id="ch07-medps"/><a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="Mediator pattern versus" id="ch07-medps2"/><a data-type="indexterm" data-primary="Mediator pattern" data-secondary="Publish/Subscribe (Event Aggregator) versus" id="ch07-medps3"/> between the event aggregator and mediator examples that I’ve shown here. The similarities boil down to two primary items: events and third-party objects. These differences are superficial at best, though. When we dig into the pattern’s intent and see that the implementations can be dramatically different, the nature of the patterns becomes more apparent.</p>










<section data-type="sect3" data-pdf-bookmark="Events"><div class="sect3" id="idm45017700113280">
<h3>Events</h3>

<p>Both the event aggregator and mediator use events in the examples shown. An event aggregator obviously deals with events—it’s in the name, after all. The mediator only uses events because it makes life easy when dealing with modern JavaScript web app frameworks. There is nothing that says a mediator must be built with events. You can build a mediator with callback methods by handing the mediator reference to the child object or using several other means.</p>

<p>The difference, then, is why these two patterns are both using events. The event aggregator, as a pattern, is designed to deal with events. The mediator, though, uses them only because it’s convenient.</p>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Third-party objects"><div class="sect3" id="idm45017700064960">
<h3>Third-party objects</h3>

<p>By design, the event aggregator and mediator employ a third-party object to streamline interactions. The event aggregator itself is a third party to the event publisher and the event subscriber. It acts as a central hub for events to pass through. The mediator is also a third party to other objects, though. So where is the difference? Why don’t we call an event aggregator a mediator? The answer primarily depends on where the application logic and workflow are coded.</p>

<p>In the case of an event aggregator, the third-party object is there only to facilitate the pass-through of events from an unknown number of sources to an unknown number of handlers. All workflow and business logic that needs to be kicked off is put directly into the object that triggers the events and the objects that handle the events.</p>

<p>In the mediator’s case, the business logic and workflow are aggregated into the mediator itself. The mediator decides when an object should have its methods called and attributes updated based on factors the mediator knows about. It encapsulates the workflow and process, coordinating multiple objects to produce the desired system behavior. The individual objects involved in this workflow know how to perform their task. But the mediator tells the objects when to perform the tasks by making decisions at a higher level than the individual objects.</p>

<p>An event aggregator facilitates a “fire and forget” model of communication. The object triggering the event doesn’t care if there are any subscribers. It just fires the event and moves on. A mediator might use events to make decisions, but it is definitely not “fire and forget.” A mediator pays attention to a known set of inputs or activities so that it can facilitate and coordinate other behavior with a known set of actors (objects).</p>
</div></section>










<section data-type="sect3" data-pdf-bookmark="Relationships: When to use which"><div class="sect3" id="idm45017700062176">
<h3>Relationships: When to use which</h3>

<p>Understanding the similarities and differences between an event aggregator and a mediator is essential for semantic reasons. It’s equally important to know when to use which pattern. The basic semantics and intent of the patterns inform the question of when, but experience in using the patterns will help you understand the more subtle points and nuanced decisions that must be made.<a data-type="indexterm" data-startref="ch07-medps" id="idm45017700060880"/><a data-type="indexterm" data-startref="ch07-medps2" id="idm45017700060176"/><a data-type="indexterm" data-startref="ch07-medps3" id="idm45017700059504"/></p>
</div></section>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Event Aggregator Use"><div class="sect2" id="idm45017700058576">
<h2>Event Aggregator Use</h2>

<p>In general, an event aggregator is used when you either have too many objects to listen to directly or have entirely unrelated objects.<a data-type="indexterm" data-primary="Mediator pattern" data-secondary="Publish/Subscribe (Event Aggregator) versus" data-tertiary="event aggregator use" id="idm45017700057136"/><a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="Mediator pattern versus" data-tertiary="use of event aggregator" id="idm45017700055920"/><a data-type="indexterm" data-primary="events" data-secondary="Mediator notifying of events in other objects" data-tertiary="event aggregator used instead" id="idm45017700054736"/></p>

<p>When two objects already have a direct relationship—for example, a parent view and a child view—there may be a benefit in using an event aggregator. Have the child view trigger an event, and the parent view can handle the event. This is most commonly seen in Backbone’s Collection and Model in JavaScript framework terms, where all Model events are bubbled up to and through its parent Collection. A Collection often uses model events to modify the state of itself or other models. Handling “selected” items in a collection is an excellent example.</p>

<p>jQuery’s <code>on()</code> method<a data-type="indexterm" data-primary="jQuery" data-secondary="on() method as event aggregator" id="idm45017700051760"/> as an event aggregator is a great example of too many objects to listen to. If you have 10, 20, or 200 DOM elements that can trigger a “click” event, it might be a bad idea to set up a listener on all of them individually. This could quickly deteriorate the performance of the application and user experience. Instead, using jQuery’s <code>on()</code> method allows us to aggregate all events and reduce the overhead of 10, 20, or 200 event handlers down to 1.</p>

<p>Indirect relationships are also a great time to use event aggregators. In modern applications, it is ubiquitous to have multiple view objects that need to communicate but have no direct relationship. For example, a menu system might have a view that handles the menu item clicks. But we don’t want the menu to be directly tied to the content views showing all the details and information when a menu item is clicked—having the content and menu coupled together would make the code difficult to maintain in the long run. Instead, we can use an event aggregator to trigger <code>menu:click:foo</code> events and have a “foo” object handle the <code>click</code> event to show its content on the screen.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Mediator Use"><div class="sect2" id="idm45017700048768">
<h2>Mediator Use</h2>

<p>A mediator is best applied when two or more objects<a data-type="indexterm" data-primary="events" data-secondary="Mediator notifying of events in other objects" data-tertiary="mediator used instead of event aggregator" id="idm45017700047376"/><a data-type="indexterm" data-primary="Mediator pattern" data-secondary="Publish/Subscribe (Event Aggregator) versus" data-tertiary="mediator used instead of event aggregator" id="idm45017700046000"/><a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="Mediator pattern versus" data-tertiary="mediator instead of event aggregator" id="idm45017700044720"/> have an indirect working relationship, and business logic or workflow needs to dictate the interactions and coordination of these objects.
A wizard interface is an excellent example of this, as shown in the <code>orgChart</code> example. Multiple views facilitate the entire workflow of the wizard. Rather than tightly coupling the view together by having them reference each other directly, we can decouple them and more explicitly model the workflow between them by introducing a mediator.</p>

<p>The mediator extracts the workflow from the implementation details and creates a more natural abstraction at a higher level, showing us at a much faster glance what that workflow is. We no longer have to dig into the details of each view in the workflow to see what the workflow is.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Event Aggregator (Pub/Sub) and Mediator Together"><div class="sect2" id="idm45017700042384">
<h2>Event Aggregator (Pub/Sub) and Mediator Together</h2>

<p>The crux of the difference between<a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="Mediator pattern versus" id="idm45017700040912"/><a data-type="indexterm" data-primary="Mediator pattern" data-secondary="Publish/Subscribe (Event Aggregator) versus" id="idm45017700039920"/><a data-type="indexterm" data-primary="events" data-secondary="Mediator notifying of events in other objects" data-tertiary="event aggregator versus" id="idm45017700038880"/><a data-type="indexterm" data-primary="events" data-secondary="Mediator notifying of events in other objects" data-tertiary="event aggregator used with" id="idm45017700037632"/><a data-type="indexterm" data-primary="Mediator pattern" data-secondary="Publish/Subscribe (Event Aggregator) versus" data-tertiary="event aggregator used with" id="idm45017700036368"/><a data-type="indexterm" data-primary="Publish/Subscribe pattern" data-secondary="Mediator pattern versus" data-tertiary="event aggregator used with mediator" id="idm45017700035104"/> an event aggregator and a mediator, and why these pattern names should not be interchanged, is best illustrated by showing how they can be used together. The menu example for an event aggregator is the perfect place to introduce a mediator.</p>

<p>Clicking a menu item may trigger a series of changes throughout an application. Some of these changes will be independent of others, and using an event aggregator makes sense. Some of these changes may be internally related, though, and may use a mediator to enact those changes.</p>

<p>A mediator could then be set up to listen to the event aggregator. It could run its logic and process to facilitate and coordinate many objects related to each other but unrelated to the original event source:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">MenuItem</code> <code class="o">=</code> <code class="nx">MyFrameworkView</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
    <code class="nx">events</code><code class="o">:</code> <code class="p">{</code>
        <code class="s1">'click .thatThing'</code><code class="o">:</code> <code class="s1">'clickedIt'</code><code class="p">,</code>
    <code class="p">},</code>

    <code class="nx">clickedIt</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">e</code><code class="p">.</code><code class="nx">preventDefault</code><code class="p">();</code>

        <code class="c1">// assume this triggers "menu:click:foo"</code>
        <code class="nx">MyFramework</code><code class="p">.</code><code class="nx">trigger</code><code class="p">(</code><code class="sb">`menu:click:</code><code class="si">${</code><code class="k">this</code><code class="p">.</code><code class="nx">model</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'name'</code><code class="p">)</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
    <code class="p">},</code>
<code class="p">});</code>

<code class="c1">// ... somewhere else in the app</code>

<code class="kr">class</code> <code class="nx">MyWorkflow</code> <code class="p">{</code>
    <code class="nx">constructor</code><code class="p">()</code> <code class="p">{</code>
        <code class="nx">MyFramework</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'menu:click:foo'</code><code class="p">,</code> <code class="k">this</code><code class="p">.</code><code class="nx">doStuff</code><code class="p">,</code> <code class="k">this</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="kr">static</code> <code class="nx">doStuff</code><code class="p">()</code> <code class="p">{</code>
        <code class="c1">// instantiate multiple objects here.</code>
        <code class="c1">// set up event handlers for those objects.</code>
        <code class="c1">// coordinate all of the objects into a meaningful workflow.</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>In this example, when the <code>MenuItem</code> with the right model is clicked, the <code>menu:click:foo</code> event will be triggered. An instance of the <code>MyWorkflow</code> class will handle this specific event and coordinate all of the objects it knows about to create the desired user experience and workflow.</p>

<p>We have thus combined an event aggregator and a mediator to create a meaningful experience in both code and application. We now have a clean separation between the menu and the workflow through an event aggregator, and we are still keeping the workflow clean and maintainable through a mediator.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Mediator/Middleware in Modern JavaScript"><div class="sect2" id="idm45017699937040">
<h2>Mediator/Middleware in Modern JavaScript</h2>

<p><a href="https://oreil.ly/JFzNB">Express.js</a> is a <a data-type="indexterm" data-primary="Mediator pattern" data-secondary="mediator/middleware" id="idm45017699934976"/><a data-type="indexterm" data-primary="Express.js" id="idm45017699933968"/><a data-type="indexterm" data-primary="middleware callback mediator" id="idm45017699933296"/>popular web application server framework. We can add callbacks to certain routes that the user can access.</p>

<p>Say we want to add a header to the request if the user hits the root (/). We can add this header in a middleware callback:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s2">"express"</code><code class="p">)();</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="s2">"/"</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">req</code><code class="p">.</code><code class="nx">headers</code><code class="p">[</code><code class="s2">"test-header"</code><code class="p">]</code> <code class="o">=</code> <code class="mi">1234</code><code class="p">;</code>
  <code class="nx">next</code><code class="p">();</code>
<code class="p">});</code></pre>

<p>The <code>next()</code> method calls the next callback in the request-response cycle. We’d create a chain of middleware functions that sit between the request and the response or vice versa. We can track and modify the request object all the way to the response through one or multiple middleware functions.</p>

<p>The middleware callbacks will be invoked whenever the user hits a root endpoint (/):</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s2">"express"</code><code class="p">)();</code>
<code class="kr">const</code> <code class="nx">html</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s2">"./data"</code><code class="p">);</code>

  <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code>
    <code class="s2">"/"</code><code class="p">,</code>
    <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="nx">req</code><code class="p">.</code><code class="nx">headers</code><code class="p">[</code><code class="s2">"test-header"</code><code class="p">]</code> <code class="o">=</code> <code class="mi">1234</code><code class="p">;</code>
      <code class="nx">next</code><code class="p">();</code>
    <code class="p">},</code>
    <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Request has test header: </code><code class="si">${</code><code class="o">!!</code><code class="nx">req</code><code class="p">.</code><code class="nx">headers</code><code class="p">[</code><code class="s2">"test-header"</code><code class="p">]</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
      <code class="nx">next</code><code class="p">();</code>
    <code class="p">}</code>
  <code class="p">);</code>

  <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s2">"/"</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">res</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s2">"Content-Type"</code><code class="p">,</code> <code class="s2">"text/html"</code><code class="p">);</code>
    <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="nx">Buffer</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">html</code><code class="p">));</code>
  <code class="p">});</code>

  <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="mi">8080</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"Server is running on 8080"</code><code class="p">);</code>
  <code class="p">});</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Mediator Versus Facade"><div class="sect2" id="idm45017699785808">
<h2>Mediator Versus Facade</h2>

<p>We will be covering the Facade pattern shortly,<a data-type="indexterm" data-primary="Mediator pattern" data-secondary="Facade pattern versus" id="idm45017699784672"/><a data-type="indexterm" data-primary="Facade pattern" data-secondary="Mediator pattern versus" id="idm45017699692928"/> but for reference purposes, some developers may also wonder whether there are similarities between the Mediator and Facade patterns. They both abstract the functionality of existing modules, but there are some subtle differences.</p>

<p>The Mediator centralizes communication between modules where these modules explicitly reference it.  In a sense, this is multidirectional. The Facade, however, defines a more straightforward interface to a module or system but doesn’t add any additional functionality. Other modules in the system aren’t directly aware of the concept of a facade and could be considered unidirectional.<a data-type="indexterm" data-startref="ch07med" id="idm45017699691472"/><a data-type="indexterm" data-startref="ch07med2" id="idm45017699690768"/><a data-type="indexterm" data-startref="ch07med3" id="idm45017699690096"/></p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="The Command Pattern"><div class="sect1" id="the-command-pattern">
<h1>The Command Pattern</h1>

<p>The Command pattern aims to encapsulate<a data-type="indexterm" data-primary="behavioral design patterns" data-secondary="Command pattern" id="ch07-cmd"/><a data-type="indexterm" data-primary="Command pattern" id="ch07-cmd2"/><a data-type="indexterm" data-primary="categories of design patterns" data-secondary="behavioral design patterns" data-tertiary="Command pattern" id="ch07-cmd3"/><a data-type="indexterm" data-primary="Command pattern" data-secondary="about" id="idm45017699660080"/> method invocation, requests, or operations into a single object and allows us to both parameterize and pass method calls that can be executed at our discretion. <a data-type="indexterm" data-primary="decoupling" data-secondary="invocation from action in Command pattern" id="idm45017699659104"/>In addition, it enables us to decouple objects invoking the action from the objects that implement them, giving us greater flexibility in swapping out concrete <em>classes</em> (objects).</p>

<p><em>Concrete</em> classes are best explained<a data-type="indexterm" data-primary="classes" data-secondary="concrete classes" id="idm45017699656592"/><a data-type="indexterm" data-primary="concrete classes" id="idm45017699655616"/> in terms of class-based programming languages and are related to the idea of abstract classes. <a data-type="indexterm" data-primary="classes" data-secondary="abstract classes" id="idm45017699654704"/><a data-type="indexterm" data-primary="abstract classes" id="idm45017699653760"/><a data-type="indexterm" data-primary="extends keyword for class inheritance" data-secondary="concrete classes" id="idm45017699653088"/>An <em>abstract</em> class defines an interface but doesn’t necessarily provide implementations for all its member functions. It acts as a base class from which others are derived. A derived class that implements the missing functionality is called a <em>concrete</em> class (see <a data-type="xref" href="#command">Figure 7-12</a>). Base and concrete classes can be implemented in JavaScript (ES2015+) using the <code>extends</code> keyword applicable to the JavaScript classes.</p>

<figure><div id="command" class="figure">
<img src="Images/ljd2_0712.png" alt="ljd2 0712" width="831" height="609"/>
<h6><span class="label">Figure 7-12. </span>Command pattern</h6>
</div></figure>

<p>The general idea behind the Command pattern is that it provides a means to separate the responsibilities of issuing commands from anything executing commands, delegating this responsibility to different objects instead.</p>

<p>Implementation-wise, simple command<a data-type="indexterm" data-primary="Command pattern" data-secondary="about" data-tertiary="execution operation" id="idm45017699647136"/> objects bind the action and the object wishing to invoke the action. They consistently include an execution operation (such as <code>run()</code> or <code>execute()</code>). All command objects with the same interface can easily be swapped as needed, which is one of the vital benefits of the pattern.</p>

<p>To demonstrate the Command pattern, we will create a simple car purchasing<a data-type="indexterm" data-primary="Command pattern" data-secondary="example" id="idm45017699644512"/> 
<span class="keep-together">service:</span></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">CarManager</code> <code class="o">=</code> <code class="p">{</code>
        <code class="c1">// request information</code>
        <code class="nx">requestInfo</code><code class="p">(</code><code class="nx">model</code><code class="p">,</code> <code class="nx">id</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="sb">`The information for </code><code class="si">${</code><code class="nx">model</code><code class="si">}</code><code class="sb"> with ID </code><code class="si">${</code><code class="nx">id</code><code class="si">}</code><code class="sb"> is foobar`</code><code class="p">;</code>
        <code class="p">},</code>

        <code class="c1">// purchase the car</code>
        <code class="nx">buyVehicle</code><code class="p">(</code><code class="nx">model</code><code class="p">,</code> <code class="nx">id</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="sb">`You have successfully purchased Item </code><code class="si">${</code><code class="nx">id</code><code class="si">}</code><code class="sb">, a </code><code class="si">${</code><code class="nx">model</code><code class="si">}</code><code class="sb">`</code><code class="p">;</code>
        <code class="p">},</code>

        <code class="c1">// arrange a viewing</code>
        <code class="nx">arrangeViewing</code><code class="p">(</code><code class="nx">model</code><code class="p">,</code> <code class="nx">id</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="sb">`You have booked a viewing of </code><code class="si">${</code><code class="nx">model</code><code class="si">}</code><code class="sb"> ( </code><code class="si">${</code><code class="nx">id</code><code class="si">}</code><code class="sb"> ) `</code><code class="p">;</code>
        <code class="p">},</code>
    <code class="p">};</code></pre>

<p>The <code>CarManager</code> object is our command object responsible for issuing commands to request information about a car, buy a car, and arrange a viewing. It would be trivial to invoke our <code>CarManager</code> methods by directly accessing the object. It would be forgivable to assume nothing is wrong with this—technically, it’s completely valid JavaScript. There are, however, scenarios where this may be disadvantageous.</p>

<p>For example, imagine if the core API behind the <code>CarManager</code> changed. This would require all objects directly accessing these methods within our application to be modified. It is a type of coupling that effectively goes against the OOP methodology of loosely coupling objects as much as possible. Instead, we could solve this problem by abstracting the API away further.</p>

<p>Let’s now expand the <code>CarManager</code> so that our Command pattern application results in the following: accept any named methods that can be performed on the 
<span class="keep-together"><code>CarManager</code></span> object, passing along any data that might be used, such as the car model and ID.</p>

<p>Here is what we would like to be able to achieve:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">CarManager</code><code class="p">.</code><code class="nx">execute</code><code class="p">(</code><code class="s1">'buyVehicle'</code><code class="p">,</code> <code class="s1">'Ford Escort'</code><code class="p">,</code> <code class="s1">'453543'</code><code class="p">);</code></pre>

<p>As per this structure, we should now add a definition for the <code>carManager.execute</code> method as follows:</p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">carManager</code><code class="p">.</code><code class="nx">execute</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">name</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="p">(</code>
        <code class="nx">carManager</code><code class="p">[</code><code class="nx">name</code><code class="p">]</code> <code class="o">&amp;&amp;</code>
        <code class="nx">carManager</code><code class="p">[</code><code class="nx">name</code><code class="p">].</code><code class="nx">apply</code><code class="p">(</code><code class="nx">carManager</code><code class="p">,</code> <code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">,</code> <code class="mi">1</code><code class="p">))</code>
    <code class="p">);</code>
<code class="p">};</code></pre>

<p>Our final sample calls would thus look as follows:<a data-type="indexterm" data-startref="ch07-cmd" id="idm45017699473200"/><a data-type="indexterm" data-startref="ch07-cmd2" id="idm45017699458496"/><a data-type="indexterm" data-startref="ch07-cmd3" id="idm45017699457888"/></p>

<pre data-type="programlisting" data-code-language="javascript"><code class="nx">carManager</code><code class="p">.</code><code class="nx">execute</code><code class="p">(</code><code class="s1">'arrangeViewing'</code><code class="p">,</code> <code class="s1">'Ferrari'</code><code class="p">,</code> <code class="s1">'14523'</code><code class="p">);</code>
<code class="nx">carManager</code><code class="p">.</code><code class="nx">execute</code><code class="p">(</code><code class="s1">'requestInfo'</code><code class="p">,</code> <code class="s1">'Ford Mondeo'</code><code class="p">,</code> <code class="s1">'54323'</code><code class="p">);</code>
<code class="nx">carManager</code><code class="p">.</code><code class="nx">execute</code><code class="p">(</code><code class="s1">'requestInfo'</code><code class="p">,</code> <code class="s1">'Ford Escort'</code><code class="p">,</code> <code class="s1">'34232'</code><code class="p">);</code>
<code class="nx">carManager</code><code class="p">.</code><code class="nx">execute</code><code class="p">(</code><code class="s1">'buyVehicle'</code><code class="p">,</code> <code class="s1">'Ford Escort'</code><code class="p">,</code> <code class="s1">'34232'</code><code class="p">);</code></pre>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Summary"><div class="sect1" id="idm45017699688704">
<h1>Summary</h1>

<p>With that, we can conclude our discussion of traditional design patterns you can use when designing classes, objects, and modules. I have tried incorporating an ideal mix of creational, structural, and behavioral patterns. We have also studied patterns created for classic OOP languages such as Java and C++ and adapted them for 
<span class="keep-together">JavaScript.</span></p>

<p>These patterns will help us design many domain-specific objects (e.g., shopping cart, vehicle, or book) that make up our applications’ business model. In the next chapter, we will look at the larger picture of how we can structure applications so that this model delivers to the other application layers, such as the view or the presenter.</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45017700219792"><sup><a href="ch07.xhtml#idm45017700219792-marker">1</a></sup> <a href="https://oreil.ly/OUcDc">Wikipedia</a>; <a href="https://oreil.ly/uM9-f">Dictionary.com</a>.</p></div></div></section></div></body></html>