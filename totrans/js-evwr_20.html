<html><head></head><body><section data-pdf-bookmark="Chapter 19. Integrating an Existing Web Application with Electron" data-type="chapter" epub:type="chapter"><div class="chapter" id="desktop-web">&#13;
<h1><span class="label">Chapter 19. </span>Integrating an Existing <span class="keep-together">Web Application with</span> Electron</h1>&#13;
&#13;
&#13;
<p><a data-primary="Electron" data-secondary="integrating an existing web application with" data-type="indexterm" id="ix_ch19-asciidoc0"/>I tend to accumulate web browser tabs like a child at the beach collects shells. I don’t necessarily set out to collect them, but by the end of the day, I have dozens of tabs open across a few browser windows. I’m not proud of this, but I suspect that I’m not alone. As a result, I use desktop versions of some of my most commonly used web applications. Often, these applications offer no advantage over the web, but the convenience of an independent app makes them easy to access, find, and switch to throughout the day.</p>&#13;
&#13;
<p>In this chapter, we’ll look at how we can take an existing web application and wrap it in an Electron shell. Before proceeding, you will need a local copy of our example API and web applications. If you haven’t been following along through the whole book, visit Appendixes <a data-type="xref" data-xrefstyle="select:labelnumber" href="app01.html#appendix-api">A</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="app02.html#appendix-web">B</a> to run these.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Integrating Our Web Application" data-type="sect1"><div class="sect1" id="idm45339486478664">&#13;
<h1>Integrating Our Web Application</h1>&#13;
&#13;
<p><a data-primary="Electron" data-secondary="integrating web application" data-type="indexterm" id="ix_ch19-asciidoc1"/>In the previous chapter, we set up our Electron application to load an <em>index.html</em> file. Alternately, we can load a specific URL. In our case, we’ll begin by loading the URL of our locally running web application. First, be sure that your web application and API are running locally. Then we can update our <em>src/index.js</em> file, first by updating the <code>nodeIntegration</code> setting in the <code>BrowserWindow</code> to <code>false</code>. This will avoid the security risks of a locally running node application accessing an external site.</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">webPreferences</code><code class="o">:</code> <code class="p">{</code>&#13;
  <code class="nx">nodeIntegration</code><code class="o">:</code> <code class="kc">false</code>&#13;
<code class="p">},</code></pre>&#13;
&#13;
<p class="pagebreak-before">Now, replace the <code>window.loadFile('index.html');</code> line with the following:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nb">window</code><code class="p">.</code><code class="nx">loadURL</code><code class="p">(</code><code class="s1">'http://localhost:1234'</code><code class="p">);</code></pre>&#13;
<div data-type="note" epub:type="note"><h1>Running the Web Application</h1>&#13;
<p>A local instance of your web application will need to be running on the <code>1234</code> port. If you’ve been following along with the book, run <strong><code>npm start</code></strong> from the root of your web application’s directory to start the development server.</p>&#13;
</div>&#13;
&#13;
<p>This will instruct Electron to load a URL, rather than a file. Now if you run the app with <code>npm start</code>, you’ll see it loaded in an Electron window, with some caveats.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Warnings and Errors" data-type="sect2"><div class="sect2" id="idm45339486452568">&#13;
<h2>Warnings and Errors</h2>&#13;
&#13;
<p><a data-primary="Electron" data-secondary="warnings and errors" data-type="indexterm" id="ix_ch19-asciidoc2"/><a data-primary="errors" data-type="indexterm" id="ix_ch19-asciidoc3"/><a data-primary="warnings and errors" data-type="indexterm" id="ix_ch19-asciidoc4"/>The Electron browser developer tools and our terminal currently display a large number of warnings and errors. Let’s look at each of these (see <a data-type="xref" href="#desktop_errors">Figure 19-1</a>).</p>&#13;
&#13;
<figure><div class="figure" id="desktop_errors">&#13;
<img alt="A screenshot of our application and the errors printed to the developer console" src="assets/jsev_1901.png"/>&#13;
<h6><span class="label">Figure 19-1. </span>Our application is running, but displays a large number of errors and <span class="keep-together">warnings</span></h6>&#13;
</div></figure>&#13;
&#13;
<p class="pagebreak-before">First, our terminal displays a large number of <a data-primary="SyntaxError" data-type="indexterm" id="idm45339486423960"/><code>SyntaxError: Unexpected Token</code> errors. Additionally, our developer tools show several corresponding warnings stating <code>DevTools failed to parse SourceMap</code>. These two errors are related to the way in which Parcel generates source maps and Electron reads them. Unfortunately, with the combination of technologies that we are using, there does not seem to be a reasonable fix for this issue. Our best option is to disable JavaScript source maps. In the application window’s developer tools, click “Settings” and then uncheck “Enable JavaScript source maps” (see <a data-type="xref" href="#desktop_sourcemaps">Figure 19-2</a>).</p>&#13;
&#13;
<figure><div class="figure" id="desktop_sourcemaps">&#13;
<img alt="A screenshot of the developer tools settings" src="assets/jsev_1902.png"/>&#13;
<h6><span class="label">Figure 19-2. </span>Disabling source maps will reduce the number of errors and warnings</h6>&#13;
</div></figure>&#13;
&#13;
<p>Now, if you quit and restart the application you’ll no longer see the source map–related issues. This does come with the tradeoff that debugging our client-side JavaScript within Electron may be more difficult, but thankfully we can still access this feature and our application in our web browser.</p>&#13;
&#13;
<p>The final two warnings are related to Electron’s security. We will address these before bundling our application for production, but it’s worth exploring now what these warnings are.</p>&#13;
<dl>&#13;
<dt><code>Electron Security Warning (Insecure Resources)</code></dt>&#13;
<dd>&#13;
<p><a data-primary="Electron Security Warning (Insecure Resources)" data-type="indexterm" id="idm45339486416488"/>This warning notifies us that we are loading web resources over an <em>http</em> connection. In production, we should always load resources over <em>https</em> to ensure privacy and security. In development, loading our localhost over <em>http</em> is not a problem, as we will be referencing our hosted website, which uses <em>https</em> in the bundled <span class="keep-together">application.</span></p>&#13;
</dd>&#13;
<dt><code>Electron Security Warning (Insecure Content-Security-Policy)</code></dt>&#13;
<dd>&#13;
<p>This <a data-primary="Electron Security Warning (Insecure Content-Security-Policy)" data-type="indexterm" id="idm45339486394104"/>warning informs us that we have not yet set a Content Security Policy (CSP). A CSP allows us to specify which domains our application is permitted to load resources from, greatly reducing the risk of a cross-site scripting (XSS) attack. Again, this is not a concern during local development, but it’s important in production. We’ll be implementing a CSP later in the chapter.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>With our errors addressed, we’re ready to set up our application’s configuration file.<a data-startref="ix_ch19-asciidoc4" data-type="indexterm" id="idm45339486392008"/><a data-startref="ix_ch19-asciidoc3" data-type="indexterm" id="idm45339486391304"/><a data-startref="ix_ch19-asciidoc2" data-type="indexterm" id="idm45339486390632"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Configuration" data-type="sect1"><div class="sect1" id="idm45339486389832">&#13;
<h1>Configuration</h1>&#13;
&#13;
<p><a data-primary="Electron" data-secondary="configuration" data-type="indexterm" id="idm45339486388328"/>When developing locally, we want to be able to run the local version of our web application, but when bundling the app to be used by others, we want it to reference the publicly available URL. We can set up a simple configuration file to handle this.</p>&#13;
&#13;
<p>In our <em>./src</em> directory, we will add a <em>config.js</em> file where we can store application-specific properties. I’ve included a <em>config.example.js</em> file, which you can easily copy from the terminal:</p>&#13;
&#13;
<pre data-type="programlisting">cp src/config.example.js src/config.js</pre>&#13;
&#13;
<p>Now we can fill in the properties of our application:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">config</code> <code class="o">=</code> <code class="p">{</code>&#13;
  <code class="nx">LOCAL_WEB_URL</code><code class="o">:</code> <code class="s1">'http://localhost:1234/'</code><code class="p">,</code>&#13;
  <code class="nx">PRODUCTION_WEB_URL</code><code class="o">:</code> <code class="s1">'https://YOUR_DEPLOYED_WEB_APP_URL'</code><code class="p">,</code>&#13;
  <code class="nx">PRODUCTION_API_URL</code><code class="o">:</code> <code class="s1">'https://YOUR_DEPLOYED_API_URL'</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">config</code><code class="p">;</code></pre>&#13;
<div data-type="tip"><h1>Why Not .env?</h1>&#13;
<p>In our previous environments, we’ve used <em>.env</em> files to manage environment-specific settings. In this instance, we’re using a JavaScript configuration file because of the way that Electron apps bundle their dependencies.</p>&#13;
</div>&#13;
&#13;
<p>Now in our Electron application’s main process, we can use the configuration file to specify which URL we would like to load in development and production. In <em>src/index.js</em>, first import the <em>config.js</em> file:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">config</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./config'</code><code class="p">);</code></pre>&#13;
&#13;
<p>Now, we can update the <code>loadURL</code> functionality to load different URLs for each <span class="keep-together">environment:</span></p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// load the URL</code>&#13;
 <code class="k">if</code> <code class="p">(</code><code class="nx">is</code><code class="p">.</code><code class="nx">development</code><code class="p">)</code> <code class="p">{</code>&#13;
   <code class="nb">window</code><code class="p">.</code><code class="nx">loadURL</code><code class="p">(</code><code class="nx">config</code><code class="p">.</code><code class="nx">LOCAL_WEB_URL</code><code class="p">);</code>&#13;
 <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
   <code class="nb">window</code><code class="p">.</code><code class="nx">loadURL</code><code class="p">(</code><code class="nx">config</code><code class="p">.</code><code class="nx">PRODUCTION_WEB_URL</code><code class="p">);</code>&#13;
 <code class="p">}</code></pre>&#13;
&#13;
<p>By using a configuration file, we can easily provide Electron with environment-specific settings.<a data-startref="ix_ch19-asciidoc1" data-type="indexterm" id="idm45339486266040"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Content Security Policy" data-type="sect1"><div class="sect1" id="idm45339486389240">&#13;
<h1>Content Security Policy</h1>&#13;
&#13;
<p><a data-primary="content security policy (CSP)" data-type="indexterm" id="idm45339486263896"/><a data-primary="CSP (content security policy)" data-type="indexterm" id="idm45339486263224"/><a data-primary="Electron" data-secondary="content security policy" data-type="indexterm" id="idm45339486262584"/>As stated earlier in the chapter, a CSP allows us to limit the domains that our application has permission to load resources from. This helps to limit potential XSS and data injection attacks. In Electron, we can specify our CSP settings to help improve the security of the application. To learn more about CSP for both your Electron and web applications, I recommend the <a href="https://oreil.ly/VZS1H">MDN article</a> on the subject.</p>&#13;
&#13;
<p>Electron provides a built-in API for CSP, but the <code>electron-util</code> library offers a simpler and cleaner syntax. At the top of our <em>src/index.js</em> file, update the <code>electron-util</code> import statement to include <code>setContentSecurityPolicy</code>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="p">{</code> <code class="nx">is</code><code class="p">,</code> <code class="nx">setContentSecurityPolicy</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'electron-util'</code><code class="p">);</code></pre>&#13;
&#13;
<p>Now we can set our CSP for the production version of the application:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// set the CSP in production mode</code>&#13;
 <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">is</code><code class="p">.</code><code class="nx">development</code><code class="p">)</code> <code class="p">{</code>&#13;
   <code class="nx">setContentSecurityPolicy</code><code class="p">(</code><code class="sb">`</code>&#13;
<code class="sb">   default-src 'none';</code>&#13;
<code class="sb">   script-src 'self';</code>&#13;
<code class="sb">   img-src 'self' https://www.gravatar.com;</code>&#13;
<code class="sb">   style-src 'self' 'unsafe-inline';</code>&#13;
<code class="sb">   font-src 'self';</code>&#13;
<code class="sb">   connect-src 'self' </code><code class="si">${</code><code class="nx">config</code><code class="p">.</code><code class="nx">PRODUCTION_API_URL</code><code class="si">}</code><code class="sb">;</code>&#13;
<code class="sb">   base-uri 'none';</code>&#13;
<code class="sb">   form-action 'none';</code>&#13;
<code class="sb">   frame-ancestors 'none';</code>&#13;
<code class="sb"> `</code><code class="p">);</code>&#13;
 <code class="p">}</code></pre>&#13;
&#13;
<p>With our CSP written, we can check for errors using the <a href="https://oreil.ly/1xNK1">CSP Evaluator</a> tool. If we are intentionally accessing resources at additional URLs, we could add them to our CSP rule set.</p>&#13;
&#13;
<p>Our final <em>src/index.js</em> file will read as follows:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="p">{</code> <code class="nx">app</code><code class="p">,</code> <code class="nx">BrowserWindow</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'electron'</code><code class="p">);</code>&#13;
<code class="kr">const</code> <code class="p">{</code> <code class="nx">is</code><code class="p">,</code> <code class="nx">setContentSecurityPolicy</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'electron-util'</code><code class="p">);</code>&#13;
<code class="kr">const</code> <code class="nx">config</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./config'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// to avoid garbage collection, declare the window as a variable</code>&#13;
<code class="kd">let</code> <code class="nb">window</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// specify the details of the browser window</code>&#13;
<code class="kd">function</code> <code class="nx">createWindow</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="nb">window</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">BrowserWindow</code><code class="p">({</code>&#13;
    <code class="nx">width</code><code class="o">:</code> <code class="mi">800</code><code class="p">,</code>&#13;
    <code class="nx">height</code><code class="o">:</code> <code class="mi">600</code><code class="p">,</code>&#13;
    <code class="nx">webPreferences</code><code class="o">:</code> <code class="p">{</code>&#13;
      <code class="nx">nodeIntegration</code><code class="o">:</code> <code class="kc">false</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// load the URL</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">is</code><code class="p">.</code><code class="nx">development</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nb">window</code><code class="p">.</code><code class="nx">loadURL</code><code class="p">(</code><code class="nx">config</code><code class="p">.</code><code class="nx">LOCAL_WEB_URL</code><code class="p">);</code>&#13;
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
    <code class="nb">window</code><code class="p">.</code><code class="nx">loadURL</code><code class="p">(</code><code class="nx">config</code><code class="p">.</code><code class="nx">PRODUCTION_WEB_URL</code><code class="p">);</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="c1">// if in development mode, open the browser dev tools</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">is</code><code class="p">.</code><code class="nx">development</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nb">window</code><code class="p">.</code><code class="nx">webContents</code><code class="p">.</code><code class="nx">openDevTools</code><code class="p">();</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="c1">// set the CSP in production mode</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">is</code><code class="p">.</code><code class="nx">development</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">setContentSecurityPolicy</code><code class="p">(</code><code class="sb">`</code>&#13;
<code class="sb">    default-src 'none';</code>&#13;
<code class="sb">    script-src 'self';</code>&#13;
<code class="sb">    img-src 'self' https://www.gravatar.com;</code>&#13;
<code class="sb">    style-src 'self' 'unsafe-inline';</code>&#13;
<code class="sb">    font-src 'self';</code>&#13;
<code class="sb">    connect-src 'self' </code><code class="si">${</code><code class="nx">config</code><code class="p">.</code><code class="nx">PRODUCTION_API_URL</code><code class="si">}</code><code class="sb">;</code>&#13;
<code class="sb">    base-uri 'none';</code>&#13;
<code class="sb">    form-action 'none';</code>&#13;
<code class="sb">    frame-ancestors 'none';</code>&#13;
<code class="sb">  `</code><code class="p">);</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="c1">// when the window is closed, dereference the window object</code>&#13;
  <code class="nb">window</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'closed'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nb">window</code> <code class="o">=</code> <code class="kc">null</code><code class="p">;</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// when electron is ready, create the application window</code>&#13;
<code class="nx">app</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'ready'</code><code class="p">,</code> <code class="nx">createWindow</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// quit when all windows are closed.</code>&#13;
<code class="nx">app</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'window-all-closed'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// On macOS only quit when a user explicitly quits the application</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">process</code><code class="p">.</code><code class="nx">platform</code> <code class="o">!==</code> <code class="s1">'darwin'</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">app</code><code class="p">.</code><code class="nx">quit</code><code class="p">();</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">app</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'activate'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// on macOS, re-create the window when the icon is clicked in the dock</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nb">window</code> <code class="o">===</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">createWindow</code><code class="p">();</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>With this, we have a working implementation of our web application running within an Electron shell (shown in <a data-type="xref" href="#final_desktop">Figure 19-3</a>).</p>&#13;
&#13;
<figure><div class="figure" id="final_desktop">&#13;
<img alt="A screenshot of our final desktop application" src="assets/jsev_1903.png"/>&#13;
<h6><span class="label">Figure 19-3. </span>Our web application running within an Electron application shell</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conclusion" data-type="sect1"><div class="sect1" id="idm45339486264840">&#13;
<h1>Conclusion</h1>&#13;
&#13;
<p>In this chapter we integrated an existing web app into an Electron desktop application, which enables us to get a desktop application to market quickly. It’s worth noting that there are tradeoffs to this approach, however, as it offers limited desktop-specific benefits and requires an internet connection to access the full features of the application. For those of us looking to get a desktop application to market soon, these downsides may be worthwhile. In the next chapter, we’ll look at how we can build and distribute an Electron app.<a data-startref="ix_ch19-asciidoc0" data-type="indexterm" id="idm45339485889752"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>