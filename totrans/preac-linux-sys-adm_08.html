<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 8. Maintaining System Health" data-type="chapter" epub:type="chapter"><div class="chapter" id="maintaining_system_health">
<h1><span class="label">Chapter 8. </span>Maintaining System Health</h1>
<p>Maintaining system health is a broad topic that includes preventative maintenance, housekeeping, patching, security tasks, user maintenance, and monitoring and mitigating various types of sprawl. <a contenteditable="false" data-primary="health maintenance" data-type="indexterm" id="ix_hlth"/>Maintaining the health of your systems is an active task, not a passive one.</p>
<p>Monitoring can help. Automating periodic cleanup of certain areas can help. Automating updates can help, but you must actively watch logs, check space and sprawl, and take care of user maintenance tasks. Many of these tasks require eyes on screens and hands on keyboards. Far fewer system administrators would be required if you could automate every aspect of system health maintenance.</p>
<p>This chapter covers both automated and manual system health maintenance tasks.</p>
<section data-pdf-bookmark="Keeping Your System Clutter-Free" data-type="sect1"><div class="sect1" id="keeping_your_system_clutter_free">
<h1>Keeping Your System Clutter-Free</h1>
<p>Housekeeping is something that no one loves to do. It’s tedious, time-consuming, and can anger users to the point of reporting your behavior to management, which is never a good thing.<a contenteditable="false" data-primary="health maintenance" data-secondary="keeping the system clutter-free" data-type="indexterm" id="ix_hlthcltr"/> As long as you comply with corporate policy and don’t apply any of your own, you’ll have material to refer your angry users to. The rules for decluttering a system are the same for any maintenance you do: have a good backup available if you remove a critical file or directory by accident. The following sections detail how to keep your systems clutter-free.</p>
<section data-pdf-bookmark="Cleaning the /tmp Directory" data-type="sect2"><div class="sect2" id="cleaning_the_solidustmp_directory">
<h2>Cleaning the /tmp Directory</h2>
<p>The <em>/tmp</em> directory is a shared directory. <a contenteditable="false" data-primary="/tmp directory, cleaning" data-primary-sortas="tmp" data-type="indexterm" id="idm45657874712928"/><a contenteditable="false" data-primary="health maintenance" data-secondary="keeping the system clutter-free" data-tertiary="cleaning /tmp directory" data-type="indexterm" id="ix_hlthtmp"/>It’s shared with all users, applications, and system processes. Anyone may write to this directory, which is bad for administrators because having unlimited access to a system directory can have fatal consequences. If the original administrator didn’t create the <em>/tmp</em> directory as a separate filesystem with access to limited space, users or applications can potentially fill up all of the space.<a contenteditable="false" data-primary="/ directory" data-see="root directory" data-type="indexterm" id="idm45657874709888"/><a contenteditable="false" data-primary="root directory (/)" data-secondary="keeping /tmp directory out of same partition" data-type="indexterm" id="idm45657873741120"/> The <em>/tmp</em> directory should never be a part of the same partition as <em>/</em> for this reason.<br/>
 </p>
<p>The <em>/tmp</em> directory is tricky from a housekeeping perspective for sysadmins because there are no restrictions on users, applications, or the system. Because any user may write to it, they might expect that it’s extra, available free space where they can store downloads and other files. To make this directory a less desirable location to store files, you should create a <code>cron</code> job to run every night, after backups, to remove any nonsystem files.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>In many enterprises, automated scripts remove user-created files from the <em>/tmp</em> directory every night, and most exclude <em>/tmp</em> directories from backups.</p>
</div>
<p>The solution to the <em>/tmp</em> dilemma if you don’t want to create a separate filesystem and mount it on <em>/tmp</em> is to enable <em>tmp.mount</em>. <a contenteditable="false" data-primary="mounting and mount points" data-secondary="enabling tmp.mount" data-type="indexterm" id="idm45657873641616"/><a contenteditable="false" data-primary="tmp.mount" data-type="indexterm" id="idm45657873640400"/>This service creates a temporary filesystem (tmpfs) and mounts it as <em>/tmp</em>. One of the features is that it’s volatile storage (RAM) and filling it up won’t cause stability issues on your system.</p>
<p>To enable <em>tmp.mount</em> on your system, complete the following steps.</p>
<p>First, check your <em>/tmp</em> directory mount point to see if you need to configure <em>tmp.mount</em>:</p>
<pre data-type="programlisting">
$ df -h /tmp
Filesystem           Size  Used Avail Use% Mounted on
/dev/mapper/cl-root  6.2G  3.3G  3.0G  53% /</pre>
<p>As you can see, my <em>/tmp</em> has the flaw of being a subdirectory of the <em>/</em> filesystem. Enable <em>tmp.mount</em> and then start it:</p>
<pre data-type="programlisting">
$ sudo systemctl enable tmp.mount
Created symlink /etc/systemd/system/local-fs.target.wants/tmp.mount 
→ \ /usr/lib/systemd/system/tmp.mount.

$ sudo systemctl start tmp.mount

$ df -h /tmp
Filesystem      Size  Used Avail Use% Mounted on
tmpfs           405M     0  405M   0% /tmp</pre>
<p>Now, the <em>/tmp</em> directory is no longer a subdirectory of <em>/</em>. Enabling <em>tmp.mount</em> makes this configuration persistent, which means it is a permanent change and will be automatically created each time the system is booted.</p>
<p>The next section deals with keeping the <em>/home</em> directory usable for everyone.<a contenteditable="false" data-primary="health maintenance" data-secondary="keeping the system clutter-free" data-startref="ix_hlthtmp" data-tertiary="cleaning /tmp directory" data-type="indexterm" id="idm45657873632432"/></p>
</div></section>
<section data-pdf-bookmark="Making /home a Livable Space for Everyone" data-type="sect2"><div class="sect2" id="making_solidushome_a_livable_space_for">
<h2>Making /home a Livable Space for Everyone</h2>
<p>The <em>/home</em> directory is a shared directory because it contains all users’ home directories, except for the root user. <a contenteditable="false" data-primary="health maintenance" data-secondary="keeping the system clutter-free" data-tertiary="making /home livable space for everyone" data-type="indexterm" id="ix_hlthcltrhome"/><a contenteditable="false" data-primary="home directory (/home)" data-secondary="making it livable space for everyone" data-type="indexterm" id="ix_homehlth"/>For example, suppose you have users <code>tux</code>, <code>penguin</code>, and <code>gentoo</code> on your system. Their home directories will look like the following:</p>
<pre data-type="programlisting">
/home/tux
/home/penguin
/home/gentoo</pre>
<p>On systems where the <em>/home</em> directory is on the same filesystem as the <em>/</em> directory, there is a potential that users can fill up <em>/</em> and cause system problems, much the same as filling up <em>/tmp</em>, as discussed in the previous section. <a contenteditable="false" data-primary="root directory (/)" data-secondary="keeping  /home directory out of same filesystem" data-type="indexterm" id="idm45657873617584"/>Because of the nature of files contained in <em>/home</em>, you can’t create and mount a volatile filesystem for it. The <em>/home</em> directory must be a permanently mounted filesystem, preferably not part of <em>/</em>. If it is part of <em>/</em>, there are two approaches to correct it. The first entails the following:</p>
<ul>
<li>
<p>Shrinking an existing LVM filesystem</p>
</li>
<li>
<p>Creating a partition and filesystem</p>
</li>
<li>
<p>Mounting that filesystem as <em>/home</em></p>
</li>
</ul>
<p>The second approach involves the following:</p>
<ul>
<li>
<p>Installing a new disk</p>
</li>
<li>
<p>Creating a new partition</p>
</li>
<li>
<p>Mounting that new partition as <em>/home</em></p>
</li>
</ul>
<p>For the demonstration in this chapter, I’ll use <a contenteditable="false" data-primary="disks" data-secondary="installing new disk for /home" data-type="indexterm" id="idm45657873605232"/>the second approach of installing a new disk for <em>/home</em>.</p>
<p>The steps to complete this are as follows:</p>
<ol>
<li>
<p>Create or install a new disk.</p>
</li>
<li>
<p>Create a new partition on the disk.</p>
</li>
<li>
<p>Make the filesystem on the new partition.</p>
</li>
<li>
<p>Mount the new partition on <em>/mnt</em>.</p>
</li>
<li>
<p>Copy or move all files from <em>/home</em> to <em>/mnt</em>.</p>
</li>
<li>
<p>Remove all files from <em>/home</em>.</p>
</li>
<li>
<p>Unmount the new partition from <em>/mnt</em>.</p>
</li>
<li>
<p>Mount the new partition on <em>/home</em>.</p>
</li>
<li>
<p>Add an entry for <em>/home</em> in <em>/etc/fstab</em>.</p>
</li>
</ol>
<p>I added a 1 GB disk to my VM to demonstrate these steps. The following sections explain how to complete each step in this process.</p>
<section data-pdf-bookmark="Create a new partition on the disk" data-type="sect3"><div class="sect3" id="create_a_new_partition_on_the_disk">
<h3>Create a new partition on the disk</h3>
<p>Identify the new disk by listing all disk block <a contenteditable="false" data-primary="disks" data-secondary="installing new disk for /home" data-tertiary="creating new partition on the disk" data-type="indexterm" id="idm45657873587840"/>devices <a contenteditable="false" data-primary="partitions" data-secondary="creating partition on new disk for /home" data-type="indexterm" id="idm45657873600256"/>on the system:</p>
<pre data-type="programlisting">
$ lsblk | grep disk
sda                   8:0    0    8G  0 disk
sdb                   8:16   0  1.5G  0 disk
sdc                   8:32   0    1G  0 disk</pre>
<p>The <code>sdc</code> (<em>/dev/sdc</em>) device is the new disk. It is the 1 GB disk I added to the virtual machine. <a contenteditable="false" data-primary="fdisk utility" data-type="indexterm" id="idm45657873581904"/>To create a new partition on the disk, use the <code>fdisk</code> utility:</p>
<pre data-type="programlisting">
$ sudo fdisk /dev/sdc

Welcome to fdisk (util-linux 2.32.1).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0x3c239df6.

Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1):
First sector (2048-2097151, default 2048):
Last sector, +sectors or +size{K,M,G,T,P} (2048-2097151, default 2097151):

Created a new partition 1 of type 'Linux' and of size 1023 MiB.

Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.</pre>
<p>List the <code>sdc</code> block device<a contenteditable="false" data-primary="block devices" data-secondary="listing sdc block device to verify partition exists" data-type="indexterm" id="idm45657873579536"/> to verify that the partition <em>/dev/sdc1</em> exists:</p>
<pre data-type="programlisting">
$ lsblk | grep sdc
sdc                   8:32   0    1G  0 disk
└─sdc1                8:33   0 1023M  0 part</pre>
<p>The <em>/dev/sdc1</em> partition exists and is ready to have a filesystem created on it.</p>
</div></section>
<section class="pagebreak-before" data-pdf-bookmark="Create the filesystem" data-type="sect3"><div class="sect3" id="create_the_filesystem">
<h3 class="less_space">Create the filesystem</h3>
<p>For the <em>/home</em> directory, format it <a contenteditable="false" data-primary="disks" data-secondary="installing new disk for /home" data-tertiary="creating the filesystem" data-type="indexterm" id="idm45657873572544"/>as <a contenteditable="false" data-primary="ext4" data-secondary="creating filesystem for /home" data-type="indexterm" id="idm45657873570768"/>the <code>ext4</code> filesystem<a contenteditable="false" data-primary="filesystems" data-secondary="creating ext4 filesystem for new disk" data-type="indexterm" id="idm45657873568816"/> type:</p>
<pre data-type="programlisting">
$ sudo mkfs.ext4 /dev/sdc1

mke2fs 1.45.6 (20-Mar-2020)
Creating filesystem with 261888 4k blocks and 65536 inodes
Filesystem UUID: bcd18fcc-3774-4b94-be0a-e2abf8aa4d31
Superblock backups stored on blocks:
    32768, 98304, 163840, 229376

Allocating group tables: done                           
Writing inode tables: done                           
Creating journal (4096 blocks): done
Writing superblocks and filesystem accounting information: done</pre>
<p>Verify that you correctly created the <code>ext4</code> filesystem on <em>/dev/sdc1</em>:</p>
<pre data-type="programlisting">
$ lsblk -o NAME,FSTYPE,SIZE | grep sdc
sdc                                1G
└─sdc1              ext4        1023M</pre>
</div></section>
<section data-pdf-bookmark="Mount the new partition" data-type="sect3"><div class="sect3" id="mount_the_new_partition">
<h3>Mount the new partition</h3>
<p>To use <a contenteditable="false" data-primary="disks" data-secondary="installing new disk for /home" data-tertiary="mounting the new partition on /mnt temporary mount point" data-type="indexterm" id="idm45657873562912"/>the new partition, you must mount it.<a contenteditable="false" data-primary="partitions" data-secondary="mounting new partition for /home" data-type="indexterm" id="idm45657873560032"/> I use <em>/mnt</em> as the <a contenteditable="false" data-primary="mounting and mount points" data-secondary="mounting new partition for /home" data-type="indexterm" id="idm45657873558464"/>temporary mount point to copy files from <em>/home</em> to the new partition I will eventually mount as <span class="keep-together"><em>/home</em></span>. If I mount <em>/dev/sdc1</em> onto <em>/home</em> now, I can’t copy the files because mounting on <span class="keep-together"><em>/home</em></span> hides its files from view. <a contenteditable="false" data-primary="/mnt temporary mount point" data-primary-sortas="mnt" data-type="indexterm" id="idm45657873553072"/>Mounting a device onto a nonempty directory hides its contents and makes its files inaccessible:</p>
<pre data-type="programlisting">
$ sudo mount /dev/sdc1 /mnt

$ mount | grep sdc
/dev/sdc1 on /mnt type ext4 (rw,relatime,seclabel)</pre>
</div></section>
<section data-pdf-bookmark="Copy files from /home to /mnt" data-type="sect3"><div class="sect3" id="copy_files_from_solidushome_to_solidusm">
<h3>Copy files from /home to /mnt</h3>
<p>Copy all<a contenteditable="false" data-primary="/mnt temporary mount point" data-primary-sortas="mnt" data-secondary="copying files from /home to /mnt" data-type="indexterm" id="idm45657873549264"/> files from the <em>/home</em> directory<a contenteditable="false" data-primary="disks" data-secondary="installing new disk for /home" data-tertiary="copying files from /home to /mnt" data-type="indexterm" id="idm45657873547312"/> to <a contenteditable="false" data-primary="cp -a command" data-type="indexterm" id="idm45657873545568"/>preserve all (<code>-a</code>) permissions, links, and timestamps:</p>
<pre class="widows7" data-type="programlisting">
$ sudo cp -a /home/* /mnt

$ ls -la /home
total 0
drwxr-xr-x.  4 root  root   32 Nov  3  2020 .
dr-xr-xr-x. 19 root  root  258 Dec 10 08:37 ..
drwx------.  2  1001  1001  62 Nov 13  2020 diane
drwx------.  7 khess khess 273 Dec 14 21:03 khess

$ ls -la /mnt
total 28
drwxr-xr-x.  5 root  root   4096 Dec 15 08:33 .
dr-xr-xr-x. 19 root  root    258 Dec 10 08:37 ..
drwx------.  2  1001  1001  4096 Nov 13  2020 diane
drwx------.  7 khess khess  4096 Dec 14 21:03 khess
drwx------.  2 root  root  16384 Dec 15 08:17 lost+found</pre>
</div></section>
<section data-pdf-bookmark="Remove all files from /home" data-type="sect3"><div class="sect3" id="remove_all_files_from_solidushome">
<h3>Remove all files from /home</h3>
<p>The <a contenteditable="false" data-primary="disks" data-secondary="installing new disk for /home" data-tertiary="removing all files from /home" data-type="indexterm" id="idm45657873540992"/>reason that I remove all files from the original <em>/home</em> directory is that it releases disk space back to the <em>/</em> filesystem, which is one of the reasons why we’re going through this exercise. The following command removes all directories under <em>/home</em> without removing the <em>/home</em> directory. There’s no need to remove <em>/home</em>:</p>
<pre data-type="programlisting">
$ sudo rm -rf /home/*</pre>
</div></section>
<section data-pdf-bookmark="Unmount /dev/sdc1 from /mnt" data-type="sect3"><div class="sect3" id="unmount_solidusdevsolidussdcone_from_so">
<h3>Unmount /dev/sdc1 from /mnt</h3>
<p>Unmount<a contenteditable="false" data-primary="mounting and mount points" data-secondary="unmounting /dev/sdc1 from /mnt" data-type="indexterm" id="idm45657873533888"/> <em>/dev/sdc1</em> from <em>/mnt</em>:</p>
<pre data-type="programlisting">
$ sudo umount /mnt</pre>
</div></section>
<section data-pdf-bookmark="Mount the new partition on /home" data-type="sect3"><div class="sect3" id="mount_the_new_partition_on_solidushome">
<h3>Mount the new partition on /home</h3>
<p>Mount <a contenteditable="false" data-primary="disks" data-secondary="installing new disk for /home" data-tertiary="mounting new partition on /home" data-type="indexterm" id="idm45657873528384"/>the new partition onto the <em>/home</em> directory:</p>
<pre data-type="programlisting">
$ sudo mount /dev/sdc1 /home</pre>
<p>The true test of this exercise is to log in as a user and check if everything works as expected.</p>
</div></section>
<section data-pdf-bookmark="Create the /etc/fstab entry" data-type="sect3"><div class="sect3" id="create_the_solidusetcsolidusfstab_entry">
<h3>Create the /etc/fstab entry</h3>
<p>The <em>/home</em> directory<a contenteditable="false" data-primary="disks" data-secondary="installing new disk for /home" data-tertiary="creating /etc/fstab entry for /home on new partition" data-type="indexterm" id="idm45657873521760"/> won’t <a contenteditable="false" data-primary="/etc/fstab file" data-primary-sortas="etc" data-secondary="entry for /home to mount from new partition on reboot" data-type="indexterm" id="idm45657873520608"/>mount automatically after a system reboot because <em>/home</em> is on a different partition that is not listed in <em>/etc/fstab</em>. <a contenteditable="false" data-primary="mounting and mount points" data-secondary="creating /etc/fstab entry to make new /home mount persistent" data-type="indexterm" id="idm45657873518640"/>You must create an <em>/etc/fstab</em> entry for it.</p>
<p>My <em>/etc/fstab</em> entry for <em>/dev/sdc1</em> is as follows:</p>
<pre data-type="programlisting">
/dev/sdc1    /home                ext4    defaults    0 0</pre>
<p>This <em>/etc/fstab</em> entry makes the mount persistent.</p>
<p class="pagebreak-after">The next section deals with archiving and removing “stale” and duplicated files from shared directories.<a contenteditable="false" data-primary="health maintenance" data-secondary="keeping the system clutter-free" data-startref="ix_hlthcltrhome" data-tertiary="making /home livable space for everyone" data-type="indexterm" id="idm45657873511104"/><a contenteditable="false" data-primary="home directory (/home)" data-secondary="making it livable space for everyone" data-startref="ix_homehlth" data-type="indexterm" id="idm45657873511360"/><a contenteditable="false" data-primary="health maintenance" data-secondary="keeping the system clutter-free" data-startref="ix_hlthcltr" data-type="indexterm" id="idm45657873511232"/></p>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="Decluttering Shared Directories" data-type="sect1"><div class="sect1" id="decluttering_shared_directories">
<h1 class="less_space">Decluttering Shared Directories</h1>
<p>Keeping shared directories free of clutter is difficult. <a contenteditable="false" data-primary="health maintenance" data-secondary="decluttering shared directories" data-type="indexterm" id="ix_hlthdecsh"/>It might be impossible, but there are some things you can do to confront the issue using system tools and some planning. This section explores some utilities that can simplify decluttering and housekeeping.</p>
<section data-pdf-bookmark="Deduplicating Files with fdupes" data-type="sect2"><div class="sect2" id="deduplicating_files_with_fdupes">
<h2>Deduplicating Files with fdupes</h2>
<p><code>fdupes</code> is a popular deduplication utility. <code>fdupes</code> finds duplicate files in a given set of directories. <a contenteditable="false" data-primary="health maintenance" data-secondary="decluttering shared directories" data-tertiary="deduplicating files with fdupes" data-type="indexterm" id="idm45657873499648"/><a contenteditable="false" data-primary="deduplicating files with fdupes" data-type="indexterm" id="idm45657873497936"/><a contenteditable="false" data-primary="fdupes utility, deduplicating files with" data-type="indexterm" id="idm45657873496864"/>The <a href="https://oreil.ly/XERaf"><code>fdupes</code> man page</a> describes the command’s function as follows:</p>
<blockquote>
<p>Searches the given path for duplicate files. Such files are found by comparing file sizes and MD5 signatures, followed by a byte-by-byte comparison.</p>
</blockquote>
<p>You can install <code>fdupes</code> from your distribution’s repositories, but it’s better to grab the patched version from a GitHub repository using <a contenteditable="false" data-primary="GitHub repository, installing fdupes from" data-type="indexterm" id="idm45657873491872"/>the following steps:</p>
<pre data-type="programlisting">
$ git clone https://github.com/tobiasschulz/fdupes
$ cd fdupes
$ make fdupes
$ sudo make install</pre>
<p>This patched version has more options such as the one you’re most likely to use as a system administrator in a production environment. When you use <code>fdupes</code> on a directory, you can just look at the duplicates, delete the duplicates (not recommended), or remove the duplicates but provide soft links to one of the files (recommended). This solution presents a problem only if the original file no longer exists. But providing a soft link to one of the files is far less invasive than removing the duplicates, which may result in tickets, phone calls, and reprimands. Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#list_duplicate_files_and_their_sizes">8-1</a> through <a data-type="xref" data-xrefstyle="select:labelnumber" href="#provide_links_to_one_of_the_files">8-3</a> illustrate how to use <code>fdupe</code><code>s</code> to find duplicates, generate a report, and then only provide <a contenteditable="false" data-primary="fdupes utility, deduplicating files with" data-secondary="listing duplicate files and their sizes" data-type="indexterm" id="idm45657873484656"/>links to one of the files.</p>
<div data-type="example" id="list_duplicate_files_and_their_sizes">
<h5><span class="label">Example 8-1. </span>List duplicate files and their sizes</h5>
<pre class="widows4" data-type="programlisting">
$ fdupes -rS /opt/shared
29 bytes each:                         
/opt/shared/docs/building/test.rtf
/opt/shared/docs/building/test.txt
/opt/shared/a/b/list.txt
/opt/shared/a/b/c/stuff.doc
/opt/shared/a/todo.list
/opt/shared/one/foo.lst
/opt/shared/x/y/listed.here

20 bytes each:
/opt/shared/docs/hr/list.txt
/opt/shared/x/got.txt
/opt/shared/a/b/none.doc</pre>
</div>
<p>The <code>-r</code> option is recursive, which means <a contenteditable="false" data-primary="fdupes utility, deduplicating files with" data-secondary="-r and -S options" data-type="indexterm" id="idm45657873480848"/>check the specified directory and all its subdirectories. The <code>-S</code> option means to report the file sizes.</p>
<p>In <a data-type="xref" href="#generate_a_duplicate_file_report_using">Example 8-2</a>, the <code>-m</code> option tells <code>fdupes</code> to print a report of any duplicates found.</p>
<div data-type="example" id="generate_a_duplicate_file_report_using">
<h5><span class="label">Example 8-2. </span>Generate a duplicate file report using the <code>-m</code> option</h5>
<pre data-type="programlisting">
$ fdupes -mr /opt/shared
8 duplicate files (in 2 sets), occupying 214 bytes.</pre>
</div>
<p>In <a data-type="xref" href="#provide_links_to_one_of_the_files">Example 8-3</a>, <code>fdupes</code> replaces <a contenteditable="false" data-primary="fdupes utility, deduplicating files with" data-secondary="generating duplicate file report using -m option" data-type="indexterm" id="idm45657873471968"/>duplicate files with hard links using the <code>-L</code> option. Only the first found file in each group of duplicates remains intact.<a contenteditable="false" data-primary="fdupes utility, deduplicating files with" data-secondary="replacing duplicate files with hard links using -L option" data-type="indexterm" id="idm45657873468400"/></p>
<div data-type="example" id="provide_links_to_one_of_the_files">
<h5><span class="label">Example 8-3. </span>Provide links to one of the files</h5>
<pre data-type="programlisting">
$ fdupes -rL /opt/shared
[+] /opt/shared/docs/building/test.rtf
[h] /opt/shared/docs/building/test.txt
[h] /opt/shared/a/b/list.txt
[h] /opt/shared/a/b/c/stuff.doc
[h] /opt/shared/a/todo.list
[h] /opt/shared/one/foo.lst
[h] /opt/shared/x/y/listed.here

[+] /opt/shared/docs/hr/list.txt
[h] /opt/shared/x/got.txt
[h] /opt/shared/a/b/none.doc</pre>
</div>
<p>Using the selective delete option, <code>-d</code>, you’re prompted for which file(s) you want to keep. <a contenteditable="false" data-primary="fdupes utility, deduplicating files with" data-secondary="using selective delete option -d" data-type="indexterm" id="idm45657873464048"/>Again, deleting files is highly discouraged. Proceed at your own risk:</p>
<pre data-type="programlisting">
$ fdupes -rd /opt/shared
[1] /opt/shared/a/b/goo.txt            
[2] /opt/shared/a/false.doc
[3] /opt/shared/one/two/three/three
[4] /opt/shared/docs/building/test.rtf
[5] /opt/shared/x/y/new.txt
[6] /opt/shared/docs/building/test.txt
[7] /opt/shared/a/b/list.txt
[8] /opt/shared/a/b/c/stuff.doc
[9] /opt/shared/a/todo.list
[10] /opt/shared/one/foo.lst
[11] /opt/shared/x/y/listed.here

Set 1 of 2, preserve files [1 - 11, all]:</pre>
<p>This option removes files except for the one(s) you preserve and does not create links. Check the online help and man pages for <code>fdupes</code> for other options.</p>
</div></section>
<section data-pdf-bookmark="Tackling /home File Sprawl with Quotas" data-type="sect2"><div class="sect2" id="tackling_solidushome_file_sprawl_with_q">
<h2>Tackling /home File Sprawl with Quotas</h2>
<p>Some system administrators and users find that using quotas is a harsh solution to dealing with file sprawl. <a contenteditable="false" data-primary="quotas on /home files" data-type="indexterm" id="ix_quota"/><a contenteditable="false" data-primary="health maintenance" data-secondary="decluttering shared directories" data-tertiary="tackling /home file sprawl with quotas" data-type="indexterm" id="ix_hlthdecshhme"/><a contenteditable="false" data-primary="home directory (/home)" data-secondary="tackling /home file sprawl with quotas" data-type="indexterm" id="ix_homequota"/>I find it a good solution that works well in various situations to help deal with users who chronically use up more than their fair share of disk space. You can implement quotas on any directory, but you certainly want to consider it for shared directories and <em>/home</em>.</p>
<p>The first task is to install <code>quota</code>, if your system<a contenteditable="false" data-primary="quotas on /home files" data-secondary="installing quota utility" data-type="indexterm" id="idm45657875871232"/> doesn’t have it:</p>
<pre data-type="programlisting">
$ sudo yum install quota
$ sudo apt install quota</pre>
<p>To use the <code>quota</code> system, you’ll need to have an <code>xfs</code> filesystem handy and mounted. <a contenteditable="false" data-primary="XFS" data-secondary="using filesystem with quota system" data-type="indexterm" id="idm45657873448752"/>Mine, for example, is <em>/home</em>. Create an entry in <em>/etc/fstab</em> for the <code>xfs</code> filesystem. Here is the <em>/etc/fstab</em> entry for <em>/home</em> where I want to enforce quotas:</p>
<pre data-type="programlisting">
/dev/sdc1    /home                xfs    defaults,usrquota,grpquota    0 0</pre>
<p>Next, create two new empty files on <em>/home</em>: <em>quota.group</em> and <em>quota.user</em>. These two files must exist in any directory<a contenteditable="false" data-primary="quotas on /home files" data-secondary="creating quota.group and quota.user files" data-type="indexterm" id="idm45657873441856"/> that’s configured for quotas, which are used by the <code>quota</code> system:</p>
<pre data-type="programlisting">
$ sudo touch /home/quota.group /home/quota.user</pre>
<p>Then, enable quotas  <a contenteditable="false" data-primary="quotas on /home files" data-secondary="enabling quotas with quotaon" data-type="indexterm" id="idm45657873439392"/>with the <code>quotaon</code> command:</p>
<pre data-type="programlisting">
$ sudo quotaon /home
quotaon /home
quotaon: Enforcing group quota already on /dev/sdc1
quotaon: Enforcing user quota already on /dev/sdc1
quotaon: Enable XFS project quota accounting during mount</pre>
<p>The system is now ready to apply quotas to users’ accounts. The following command sets a very low <code>quota</code> value for demonstration purposes.<a contenteditable="false" data-primary="quotas on /home files" data-secondary="setting soft and hard limits" data-type="indexterm" id="idm45657873436000"/> The soft limit is 50 MB, and the hard limit is 80 MB. You receive a warning when you exceed the soft limit, but the <code>quota</code> system prevents you from exceeding the hard limit. You can also limit the number of inodes (file metadata structures) that a user may consume. <a contenteditable="false" data-primary="inodes" data-type="indexterm" id="idm45657873432416"/>The inode limit is a bit harsher because a user might generate thousands of tiny text files that only amount to a few megabytes, but it limits the number of files users can create. There are hard and soft limits for inodes as well.</p>
<pre data-type="programlisting">
[root@server1 home1]# sudo xfs_quota -x -c \
'limit -u bsoft=50m bhard=80m isoft=60 \ ihard=80 djones' /home</pre>
<p>The following is an example of what the user sees when they exceed a quota. <a contenteditable="false" data-primary="quotas on /home files" data-secondary="example of user exceeding quota" data-type="indexterm" id="idm45657873429408"/><a contenteditable="false" data-primary="head command" data-type="indexterm" id="idm45657873427968"/> The <code>head</code> command creates a 51 MB file to illustrate how quotas truncate files that exceed a set quota limit:</p>
<pre data-type="programlisting">
$ su - djones
Password:
Last login: Mon Jan 10 20:16:49 CST 2022 on pts/0
[djones@server1 ~]$ head -c 51MB /dev/urandom &gt; fillit.txt
[djones@server1 ~]$ head -c 51MB /dev/urandom &gt; fillit1.txt
head: error writing 'standard output': Disk quota exceeded
$ ls -l
total 81892
-rw-rw-r--. 1 djones djones 32854016 Jan 10 20:21 fillit1.txt
-rw-rw-r--. 1 djones djones 51000000 Jan 10 20:21 fillit.txt</pre>
<p>You can see that when the user reached their hard limit, the system truncated the files they attempted to create (<em>fillit1.txt</em>). If no quota had been placed on the user, they would have had two 51 MB files.</p>
<p>Quotas prevent users from consuming more than a given amount of space on a filesystem or directory. Still, they should only be enforced on users who violate company policy or egregiously store personal files on company systems.<a contenteditable="false" data-primary="quotas on /home files" data-secondary="removing quota limits from user account" data-type="indexterm" id="idm45657873423040"/> You can easily remove a quota limit from a user’s account by setting all limits to <code>0</code>:</p>
<pre data-type="programlisting">
$ sudo xfs_quota -x -c 'limit -u bsoft=0 bhard=0 isoft=0 ihard=0 djones' /home
[sudo] password for khess:
[khess@server1 home]$ su - djones
Password:
Last login: Mon Jan 10 20:20:41 CST 2022 on pts/0
[djones@server1 ~]$ head -c 51MB /dev/urandom &gt; fillit2.txt
[djones@server1 ~]$ ls -l
total 131700
-rw-rw-r--. 1 djones djones        0 Jan 10 20:21 blah.txt
-rw-rw-r--. 1 djones djones 32854016 Jan 10 20:21 fillit1.txt
-rw-rw-r--. 1 djones djones 51000000 Jan 10 22:37 fillit2.txt
-rw-rw-r--. 1 djones djones 51000000 Jan 10 20:21 fillit.txt</pre>
<p>Now there are no warnings (or truncations) about exceeding limits. The <code>djones</code> account no longer has quota limits imposed on it.</p>
<p>That’s a good introduction to quotas, what they can do for you as an administrator, and how they can keep your users in check with their space usage. The next topic to explore is patching, an essential task for any administrator wanting to keep their system running smoothly.<a contenteditable="false" data-primary="quotas on /home files" data-startref="ix_quota" data-type="indexterm" id="idm45657873430240"/><a contenteditable="false" data-primary="health maintenance" data-secondary="decluttering shared directories" data-startref="ix_hlthdecshhme" data-tertiary="tackling /home file sprawl with quotas" data-type="indexterm" id="idm45657873470352"/><a contenteditable="false" data-primary="home directory (/home)" data-secondary="tackling /home file sprawl with quotas" data-startref="ix_homequota" data-type="indexterm" id="idm45657873652000"/><a contenteditable="false" data-primary="health maintenance" data-secondary="decluttering shared directories" data-startref="ix_hlthdecsh" data-type="indexterm" id="idm45657873414272"/></p>
</div></section>
</div></section>
<section class="pagebreak-before" data-pdf-bookmark="Patching Your Way to a Healthy System" data-type="sect1"><div class="sect1" id="patching_your_way_to_a_healthy_system">
<h1 class="less_space">Patching Your Way to a Healthy System</h1>
<p>Patching, to the new system administrator, might sound like you’re putting duct tape on a system to hold it together temporarily while you locate the real fix for a problem. <a contenteditable="false" data-primary="health maintenance" data-secondary="patching your way to a healthy system" data-type="indexterm" id="ix_hlthptch"/><a contenteditable="false" data-primary="patching" data-secondary="using to improve system health" data-type="indexterm" id="ix_ptch"/>Patching is an essential task and perhaps is a misnomer for what it is: updating system utilities, daemons, and applications with fixes supplied by developers. <a contenteditable="false" data-primary="security" data-secondary="patching and" data-type="indexterm" id="idm45657873637792"/>A software patch fixes a specific problem. A good example is applying a patch to the SSH daemon to resolve new vulnerabilities that can render a system susceptible to attack and compromise.</p>
<p>Patching isn’t always security-focused. Often, patches fix a stability problem, plug a memory leak, or repair a broken feature. <a contenteditable="false" data-primary="rebooting the system" data-secondary="patching not requiring reboot" data-type="indexterm" id="idm45657873777168"/>Remember that patching a Linux system rarely means that you’ll have to initiate a reboot, but if you update a service, you’ll want to restart that service unless the patching process takes care of that for you. If the patching process restarts a service, a message will appear on the screen informing you of the restart. To be safe, I often reboot after a major patch event to ensure that the system and its services receive a restart. A <em>major</em> patch event includes multiple fixes and often a kernel update. If you are inside your maintenance window and have updated several services, the kernel, or other critical system software, I suggest you reboot the system.</p>
<p>Some system administrators automate their patching by setting up a <code>cron</code> job to periodically check for and install patches. <a contenteditable="false" data-primary="cron jobs" data-secondary="using for patching" data-type="indexterm" id="idm45657873421456"/>That scenario works, but you should have a test system or two that you manually update to see what’s to be updated, how the system reacts to those updates, and how the system responds after a reboot. You don’t want or need any surprises from a bad patch session.</p>
<p>Now, let’s look at how to patch two types of Linux systems—a Red Hat–based system and a Debian-based system.</p>
<section data-pdf-bookmark="Patching a Red Hat Enterprise Linux–Based System" data-type="sect2"><div class="sect2" id="patching_a_red_hat_enterprise_linuxen_d">
<h2>Patching a Red Hat Enterprise Linux–Based System</h2>
<p>To initiate patches on a <a contenteditable="false" data-primary="Red Hat Enterprise Linux" data-secondary="patching the system" data-type="indexterm" id="idm45657873422096"/>Red Hat<a contenteditable="false" data-primary="patching" data-secondary="using to improve system health" data-tertiary="patching Red Hat Enterprise Linux–based system" data-type="indexterm" id="idm45657873393264"/> Enterprise <a contenteditable="false" data-primary="health maintenance" data-secondary="patching your way to a healthy system" data-tertiary="patching Red Hat Enterprise Linux–based system" data-type="indexterm" id="idm45657873391680"/>Linux–based system, use <code>yum</code> or <code>dnf</code>. <a contenteditable="false" data-primary="YUM/DNF utility" data-secondary="using yum to patch Red Hat Enterprise Linux–based system" data-type="indexterm" id="idm45657873388880"/>For this demonstration, I use <code>yum</code>, but <code>dnf</code> is the preferred command for versions 8 and above of Red Hat Enterprise Linux:</p>
<pre class="widows30" data-type="programlisting">
$ sudo yum update
Last metadata expiration check: 0:23:24 ago on Sun 30 Jan 2022 08:27:15 AM CST.
Dependencies resolved.
========================================================================
 Package             Arch        Version            Repo          Size
========================================================================
Installing:
 kernel              x86_64      4.18.0-348...      baseos        7.0 M
 kernel-core         x86_64      4.18.0-348...      baseos        38 M
 kernel-modules      x86_64      4.18.0-348...      baseos        30 M
Upgrading:
 NetworkManager      x86_64      1:1.32.10-...      baseos        2.6 M

...

 openssh             x86_64      8.0p1-10.el8       baseos        522 k
 openssh-clients     x86_64      8.0p1-10.el8       baseos        668 k
 openssh-server      x86_64      8.0p1-10.el8       baseos        485 k
 openssl             x86_64      1:1.1.1k-5...      baseos        709 k
 openssl-libs        x86_64      1:1.1.1k-5...      baseos        1.5 M

...

 yum                 noarch      4.7.0-4.el8        baseos        205 k
 yum-utils           noarch      4.0.21-3.el8       baseos        73 k
Installing dependencies:
 libbpf              x86_64      0.4.0-1.el8        baseos        110 k
Removing:
 kernel              x86_64      4.18.0-240...      @BaseOS       0 
 kernel-core         x86_64      4.18.0-240...      @BaseOS       62 M
 kernel-modules      x86_64      4.18.0-240...      @BaseOS       21 M

Transaction Summary
========================================================================
Install    4 Packages
Upgrade  287 Packages
Remove     3 Packages

Total download size: 558 M
Is this ok [y/N]:</pre>
<p>As you can see from the truncated listing above, it’s been a while since I last updated this system (287 packages require upgrading). <a contenteditable="false" data-primary="kernels" data-secondary="kernel update for Red Hat Enterprise Linux–based system" data-type="indexterm" id="idm45657873443792"/>I included the parts I want you to see, such as a new kernel update and the new OpenSSH server (SSHD), to demonstrate that I will reboot this system after the updates.<a contenteditable="false" data-primary="OpenSSH server (SSHD)" data-type="indexterm" id="idm45657873381456"/> I prefer to install manually by not providing the <code>-y</code> option so that I can view everything that needs an upgrade before I proceed.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The default behavior for YUM/DNF updates is not installing them. <a contenteditable="false" data-primary="YUM/DNF utility" data-secondary="default behavior for updates" data-type="indexterm" id="idm45657873376864"/>You receive the following prompt:</p>
<pre data-type="programlisting">
Is this ok [y/N]:</pre>
<p>The updates will not install if you press the Enter key because the <code>N</code> is the default response. You must explicitly approve the installation by answering with a <code>y</code> here.</p>
</div>
<p class="pagebreak-before">It’s generally OK to proceed with updates on production systems if you’ve installed and verified them on test systems first. Installing patches not verified on test systems might cause stability problems or application/library conflicts, especially if you run older versions of some programs.</p>
</div></section>
<section data-pdf-bookmark="Patching a Debian-Based Linux System" data-type="sect2"><div class="sect2" id="patching_a_debian_based_linux_system">
<h2>Patching a Debian-Based Linux System</h2>
<p>Patching a Debian-based system is similar to patching a Red Hat Enterprise Linux–based system with a couple of subtle differences. <a contenteditable="false" data-primary="health maintenance" data-secondary="patching your way to a healthy system" data-tertiary="patching Debian-based Linux system" data-type="indexterm" id="idm45657873961488"/><a contenteditable="false" data-primary="patching" data-secondary="using to improve system health" data-tertiary="patching Debian-based Linux system" data-type="indexterm" id="idm45657873371648"/><a contenteditable="false" data-primary="Debian" data-secondary="patching a Debian-based Linux system" data-type="indexterm" id="idm45657873370192"/>The first difference is that you use the <code>apt</code> command <a contenteditable="false" data-primary="apt utility" data-secondary="using to install updates to Debian-based Linux system" data-type="indexterm" id="idm45657873368336"/>to install updates to the system:</p>
<pre data-type="programlisting">
$ sudo apt update
Hit:1 http://us.archive.ubuntu.com/ubuntu focal InRelease
Get:2 http://us.archive.ubuntu.com/ubuntu focal-updates InRelease [114 kB]
Get:3 http://us.archive.ubuntu.com/ubuntu focal-backports InRelease [108 kB]
Get:4 http://us.archive.ubuntu.com/ubuntu focal-security InRelease [114 kB]
Fetched 336 kB in 1s (407 kB/s)  
Reading package lists... Done
Building dependency tree      
Reading state information... Done
20 packages can be upgraded. Run 'apt list --upgradable' to see them.
khess@server2:~$ sudo apt upgrade
Reading package lists... Done
Building dependency tree      
Reading state information... Done
Calculating upgrade... Done
The following packages will be upgraded:
  cloud-init command-not-found libasound2 libasound2-data libnetplan0 libssl1.1
linux-firmware netplan.io openssh-client openssh-server openssh-sftp-server ...
python3-commandnotfound python3-software-properties rsync software-propertie... 
ubuntu-advantage-tools ufw update-notifier-common wget
20 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
Need to get 120 MB of archives.
After this operation, 20.3 MB of additional disk space will be used.
Do you want to continue? [Y/n]</pre>
<p>The other difference is in the approval procedure. Notice the <code>Do you want to <span class="keep-together">continue?</span> [Y/n]</code> prompt. <a contenteditable="false" data-primary="apt utility" data-secondary="using to install updates to Debian-based Linux system" data-tertiary="approval procedure" data-type="indexterm" id="idm45657873364320"/>The <code>Y</code> is capitalized, which means that if you press the Enter key, the updates will install in your system. Remember that when updating a Red Hat Enterprise Linux–based system, if you press the Enter key, the updates don’t install. But also note that <code>apt</code> doesn’t have an automatic approval option (<code>-y</code>) like <code>yum</code> or <code>dnf</code>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><code>unattended-upgrades</code> is a package you can install that will allow you to update your Debian-based system automatically.<a contenteditable="false" data-primary="unattended-upgrades package" data-type="indexterm" id="idm45657873355520"/></p>
</div>
<p>As stated earlier, you should always install updates and upgrades on test systems first.<a contenteditable="false" data-primary="updates and upgrades, installing on systems" data-type="indexterm" id="idm45657873353760"/> If you set up automated updates, this is more difficult to do unless you create a clever schedule for updating your systems similar to the following:</p>
<dl>
<dt>Test systems</dt>
<dd>Manual updates every Tuesday</dd>
<dt>Development systems</dt>
<dd>Manual updates every other Thursday</dd>
<dt>Production systems</dt>
<dd>Monthly updates last Sunday of the month</dd>
</dl>
<p>This schedule, or similar, allows you to check automated updates before installing them to your production systems.<a contenteditable="false" data-primary="automation" data-secondary="automated systems for updates and upgrades" data-type="indexterm" id="idm45657873348768"/> If you have an automation or enterprise management tool that allows you to suspend <code>cron</code> jobs in case of a problem, you can better control your automated patching. If you don’t have such a tool and have more than a handful of systems to manage, I suggest you explore an automation tool such as Ansible to deliver new configuration files, scripts, and so on to your systems.<a contenteditable="false" data-primary="Ansible" data-type="indexterm" id="idm45657873385856"/></p>
<p>An automation system also helps when applying zero-day or other emergency patches to your systems. Patching, like backups, needs your close attention. Keeping your systems running smoothly and securely by regularly applying the latest patches is vital to your system administrator duties.<a contenteditable="false" data-primary="patching" data-secondary="using to improve system health" data-startref="ix_ptch" data-type="indexterm" id="idm45657873349488"/><a contenteditable="false" data-primary="health maintenance" data-secondary="patching your way to a healthy system" data-startref="ix_hlthptch" data-type="indexterm" id="idm45657873703104"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Securing Your Systems" data-type="sect1"><div class="sect1" id="securing_your_systems">
<h1>Securing Your Systems</h1>
<p>While regular patching should be part of an overall security plan, there are some basic security settings unrelated to the topic of patching that I will cover in this section. <a contenteditable="false" data-primary="health maintenance" data-secondary="securing your systems" data-type="indexterm" id="idm45657873346288"/><a contenteditable="false" data-primary="security" data-secondary="securing your systems" data-type="indexterm" id="idm45657873409376"/>Again, an <a contenteditable="false" data-primary="automation" data-secondary="automated system to maintain system security" data-type="indexterm" id="idm45657873343152"/>automated system such as Ansible can help greatly in saving time and effort in maintaining the security of dozens, hundreds, or thousands of systems.</p>
<p>Not all systems can be treated equally when applying security measures. For example, your DMZ (internet-facing) systems, database systems, web servers, application servers, and file storage systems each (as a group) need different security settings. You can rarely apply a single security policy covering every type of system. A few general security measures apply to every system regardless of function, but to state that you’re going to set up a single, generic security plan is unrealistic. You must apply security configurations to each system type to focus on specific vulnerabilities.</p>
<p class="widows3">For example, can you think of particular security settings that apply to web servers but not file servers? In the case of a web server, you’ll need to implement certificates to secure your web communications. You should concentrate on securing shared directories and user accounts on a file server. Are you going to allow Samba shares on your file servers? Are you going to allow uploads onto your web servers? How you and your users interact with a system dictates its security concerns, not the fact that it’s a generic Linux system.<a contenteditable="false" data-primary="service security guidelines" data-type="indexterm" id="idm45657873335952"/></p>
<p><a data-type="xref" href="#linux_service_security_guidelines">Table 8-1</a> shows some example security guidelines for your Linux systems with specific purposes and workloads.</p>
<table class="border" id="linux_service_security_guidelines">
<caption><span class="label">Table 8-1. </span>Linux service security guidelines</caption>
<thead>
<tr>
<th>Purpose/workload</th>
<th>Examples</th>
<th>Security measure</th>
</tr>
</thead>
<tbody>
<tr>
<td>All servers</td>
<td>Miscellaneous services</td>
<td>SSH, <em>/etc/hosts.allow</em> and <em>/etc/hosts.deny</em> restrictions, firewall, SELinux</td>
</tr>
<tr>
<td>Web server</td>
<td>Apache, NGINX, IHS, others</td>
<td>TLS, certificates, HTTPS</td>
</tr>
<tr>
<td>Database server</td>
<td>MySQL, PostgreSQL, others</td>
<td>Tunnel over SSH, restrict connections to localhost</td>
</tr>
<tr>
<td>File server</td>
<td>Samba shares, NFS shares, SSH</td>
<td>Active Directory integration for Samba, two-factor authentication</td>
</tr>
<tr>
<td>Application server</td>
<td>Tomcat, WebSphere, others</td>
<td>HTTPS, TLS, certificates</td>
</tr>
<tr>
<td>Mail server</td>
<td>SMTP, IMAP, POP-3 protocols</td>
<td>Use secured protocols and mail services</td>
</tr>
</tbody>
</table>
<p>As you can see in <a data-type="xref" href="#linux_service_security_guidelines">Table 8-1</a>, there are certain security features that you should implement on every system regardless of purpose unless there’s some vendor-related reason that you shouldn’t. You should lock down every system and be as restrictive as possible while maintaining functionality and accessibility for your users.</p>
</div></section>
<section data-pdf-bookmark="Maintaining User and Group Accounts" data-type="sect1"><div class="sect1" id="maintaining_user_and_group_accounts">
<h1>Maintaining User and Group Accounts</h1>
<p>User account maintenance goes beyond adding and removing accounts. <a contenteditable="false" data-primary="groups" data-secondary="maintaining group accounts" data-type="indexterm" id="ix_grpacct"/><a contenteditable="false" data-primary="users" data-secondary="maintaining user accounts" data-type="indexterm" id="ix_usracct"/><a contenteditable="false" data-primary="health maintenance" data-secondary="maintaining user and group accounts" data-type="indexterm" id="ix_hlthusrgrp"/>It also includes developing an account naming convention, creating policies that set standards for how long to disable accounts before they’re removed, how long to retain a user’s home directory after they’ve left the group or the company, retiring of group accounts, and the retiring or reusing of user and group IDs. All of these activities prevent user account sprawl. Here are some examples of account sprawl:</p>
<ul>
<li>
<p>Disabled accounts left on systems past policy limits</p>
</li>
<li>
<p>Home directories left on systems past policy limits</p>
</li>
<li>
<p>Active, terminated user accounts left on systems</p>
</li>
<li>
<p>Group accounts with no members</p>
</li>
<li>
<p>Disabled or removed accounts that remain in <em>/etc/sudoers</em></p>
</li>
<li>
<p>Active temporary accounts left on systems</p>
</li>
<li>
<p>Active service accounts with shells or passwords</p>
</li>
</ul>
<section data-pdf-bookmark="Setting Up a Naming Convention" data-type="sect2"><div class="sect2" id="setting_up_a_naming_convention">
<h2>Setting Up a Naming Convention</h2>
<p>One of the easiest methods of circumventing account sprawl is to create a user account naming convention. <a contenteditable="false" data-primary="health maintenance" data-secondary="maintaining user and group accounts" data-tertiary="setting up account naming convention" data-type="indexterm" id="ix_hlthusrgrpnm"/><a contenteditable="false" data-primary="users" data-secondary="maintaining user accounts" data-tertiary="setting up a naming convention" data-type="indexterm" id="ix_usracctnm"/>A naming convention prevents sprawl by setting a standard by which you and your team create user accounts. For example, you now have a working system if you set your naming convention as the first initial and the first seven characters of the last name. The exception is when two or more people have the same first and last names. In these cases, you’d opt for using the first initial of the first name, a middle initial, and the first six characters of the last name.</p>
<p><a data-type="xref" href="#standard_account_naming_convention">Table 8-2</a> shows examples of the standard naming convention.</p>
<table class="border" id="standard_account_naming_convention">
<caption><span class="label">Table 8-2. </span>Standard account naming convention</caption>
<thead>
<tr>
<th>First name</th>
<th>Last name</th>
<th>Username</th>
</tr>
</thead>
<tbody>
<tr>
<td>José</td>
<td>Alvarez</td>
<td><code>jalvarez</code></td>
</tr>
<tr>
<td>Paula</td>
<td>Anderson</td>
<td><code>panderso</code></td>
</tr>
<tr>
<td>Vivek</td>
<td>Kundra</td>
<td><code>vkundra</code></td>
</tr>
<tr>
<td>Sylvia</td>
<td>Goldstein</td>
<td><code>sgoldste</code></td>
</tr>
</tbody>
</table>
<p><a data-type="xref" href="#repeated_name_exceptions">Table 8-3</a> shows examples of repeated name exceptions.</p>
<table class="border" id="repeated_name_exceptions">
<caption><span class="label">Table 8-3. </span>Repeated name exceptions</caption>
<thead>
<tr>
<th>First name</th>
<th>Last name</th>
<th>Username</th>
</tr>
</thead>
<tbody>
<tr>
<td>José</td>
<td>Alvarez</td>
<td><code>jalvarez</code></td>
</tr>
<tr>
<td>José</td>
<td>Alvarez</td>
<td><code>jqalvare</code></td>
</tr>
<tr>
<td>Paula</td>
<td>Anderson</td>
<td><code>panderso</code></td>
</tr>
<tr>
<td>Paula</td>
<td>Anderson</td>
<td><code>pmanders</code></td>
</tr>
</tbody>
</table>
<p>If your users have no middle names, then you can work backward from the end of the alphabet, as shown in <a data-type="xref" href="#account_name_workarounds_for_users_with">Table 8-4</a>.</p>
<table class="border" id="account_name_workarounds_for_users_with">
<caption><span class="label">Table 8-4. </span>Account name workarounds for users without middle names</caption>
<thead>
<tr>
<th>First name</th>
<th>Last name</th>
<th>Username</th>
</tr>
</thead>
<tbody>
<tr>
<td>Paula</td>
<td>Anderson</td>
<td><code>panderso</code></td>
</tr>
<tr>
<td>Paula</td>
<td>Anderson</td>
<td><code>pzanders</code></td>
</tr>
<tr>
<td>Paula</td>
<td>Anderson</td>
<td><code>pyanders</code></td>
</tr>
<tr>
<td>Paula</td>
<td>Anderson</td>
<td><code>pxanders</code></td>
</tr>
</tbody>
</table>
<p class="pagebreak-before">You can certainly develop your own naming convention, but I’ve seen this one work at other enterprises, so it’s worth a mention here. I’ve also seen other companies use a number system to avoid duplicate usernames. For example, if you have two users named Vivek Kundra, the first one created on a system is created as <code>vkundra</code> and the second Vivek Kundra is <code>vkundra2</code>.</p>
<p>The whole point of a naming convention is to develop a system and then stick to it. Having a naming convention prevents administrators from creating random user accounts that could duplicate other accounts.</p>
<p>For example, suppose you create a user account for Sylvia Goldstein as <code>sgoldste</code> and another system administrator creates an account as <code>sylviag</code>. You now have a security problem because you have a single user with two accounts on the same system, plus the problem of user account sprawl.</p>
<p>User account sprawl is not a minor issue. Suppose Sylvia logs in and uses both accounts to create files, install software, and possibly create dependencies for groups she’s a member of. Now the problem is far more complex than simply moving files from one account to another, changing user and group ownership, and removing the lesser-used account from the system.</p>
<p>If the system administrators had a naming convention, the second administrator might not have created the second account. Next, I discuss creating an account retention policy, another method to prevent account sprawl.<a contenteditable="false" data-primary="health maintenance" data-secondary="maintaining user and group accounts" data-startref="ix_hlthusrgrpnm" data-tertiary="setting up account naming convention" data-type="indexterm" id="idm45657873340480"/><a contenteditable="false" data-primary="users" data-secondary="maintaining user accounts" data-startref="ix_usracctnm" data-tertiary="setting up a naming convention" data-type="indexterm" id="idm45657873401488"/></p>
</div></section>
<section data-pdf-bookmark="Creating Account Retention Policies" data-type="sect2"><div class="sect2" id="creating_account_retention_policies">
<h2>Creating Account Retention Policies</h2>
<p>An account retention policy is a good security practice and<a contenteditable="false" data-primary="health maintenance" data-secondary="maintaining user and group accounts" data-tertiary="creating account retention policies" data-type="indexterm" id="ix_hlthusrgrprtn"/> housekeeping<a contenteditable="false" data-primary="users" data-secondary="maintaining user accounts" data-tertiary="creating account retention policies" data-type="indexterm" id="ix_usracctreten"/> practice. <a contenteditable="false" data-primary="inactive user accounts" data-type="indexterm" id="idm45657873232784"/>Nothing flags security scans like active accounts that no one has accessed in more than 90 days.<a contenteditable="false" data-primary="security" data-secondary="user accounts" data-type="indexterm" id="idm45657873229616"/><a contenteditable="false" data-primary="retention policies for user accounts" data-type="indexterm" id="ix_retn"/> Some highly secure environments will force a password change every 45 days, disable accounts after 90 days of inactivity, and remove accounts that remain inactive for six months. <a contenteditable="false" data-primary="passwords" data-secondary="forcing password expiration" data-type="indexterm" id="idm45657873227792"/>This type of aggressive account retention policy won’t fit every environment, but it certainly protects and challenges users of sensitive systems to maintain their accounts or let them go.</p>
<p>I’m not suggesting that you adopt a policy as strict as this one. Still, you should have some type of retention policy in place that you provide to your users as part of an overall security and employment education program.</p>
<p class="pagebreak-after">Your account retention policy should be a written policy as well as a system-level policy. A system-level policy means that you must configure system-wide settings for inactive account lockout and removal.</p>
<section data-pdf-bookmark="Changing inactive account status" data-type="sect3"><div class="sect3" id="changing_inactive_account_status">
<h3 class="less_space">Changing inactive account status</h3>
<p>To work toward a system solution, audit the default<a contenteditable="false" data-primary="retention policies for user accounts" data-secondary="changing inactive account status" data-type="indexterm" id="idm45657874564416"/> value <a contenteditable="false" data-primary="inactive user accounts" data-secondary="changing inactive account status" data-type="indexterm" id="idm45657873258768"/>for the number of days after a password <a contenteditable="false" data-primary="INACTIVE variable" data-type="indexterm" id="idm45657873333680"/>expires that the system disables the account, also known as the <code>INACTIVE</code> variable:</p>
<pre data-type="programlisting">
$ sudo useradd -D | grep INACTIVE
INACTIVE=-1</pre>
<p>The <code>-1</code> means there’s no default inactive value set.</p>
<p>Set the inactive value according to your company’s security policy. If you have no security policy addressing this value, set it to <code>15</code> days. Some sysadmins set this value to <code>30</code>. The purpose of this setting is to disable inactive accounts and protect system security:</p>
<pre data-type="programlisting">
$ sudo useradd -D -f 15</pre>
<p>This sets the system-wide default inactive value to <code>15</code> days. If users receive the message that they need to update their password, they have 15 days before the system disables the account:</p>
<pre data-type="programlisting">
$ sudo useradd -D | grep INACTIVE
INACTIVE=15</pre>
<p>If a user attempts to log into a system and fails, you can check their account status:</p>
<pre data-type="programlisting">
$ sudo passwd -S <em>username</em>
$ sudo passwd -S ndavis
ndavis PS 2022-02-13 0 99999 7 15 (Password set, SHA512 crypt.)</pre>
<p>This user is in good standing. Perhaps they attempted to log into a host other than the one they intended or typed in an incorrect password. However, another user, <code>asmith</code>, contacted you complaining that they couldn’t log into the same system:</p>
<pre data-type="programlisting">
$ sudo passwd -S asmith
asmith LK 2022-02-12 0 99999 7 15 (Password locked.)</pre>
<p>User <code>asmith</code> is locked out of the system. You will have to unlock their account before they can log in again:</p>
<pre data-type="programlisting">
$ sudo passwd -u asmith
passwd: Success</pre>
<p>The user may log in again. Next, I will demonstrate how to take account protection further with the <code>chage</code> command.</p>
</div></section>
<section data-pdf-bookmark="Protecting user accounts" data-type="sect3"><div class="sect3" id="protecting_user_accounts">
<h3>Protecting user accounts</h3>
<p>The <code>chage</code> command has several options<a contenteditable="false" data-primary="retention policies for user accounts" data-secondary="chage command options to protect user accounts" data-type="indexterm" id="idm45657873211600"/> for further protecting <a contenteditable="false" data-primary="chage command" data-secondary="options to protect user accounts" data-type="indexterm" id="idm45657873210272"/>your user accounts by forcing regular password changes, setting a minimum password change duration, and so on. This section shows how to alter those settings to protect your users and systems.</p>
<p>There are three parameters that <a contenteditable="false" data-primary="passwords" data-secondary="setting expiration for user accounts" data-type="indexterm" id="idm45657873344976"/>I change for all users on the systems that I manage: <code>Inactive days</code>, <code>Minimum number of days between password changes</code>, and <code>Maximum number of days between password changes</code>. I change them according to company policy, if one exists. Otherwise, I change them to my “defaults”:</p>
<pre data-type="programlisting">
Inactive days:                                      15
Minimum number of days between password changes:    1
Maximum number of days between password changes:    90

$ sudo chage -m 1 -M 90 --inactive 15 asmith

$ sudo chage --list asmith
Last password change                                : Feb 13, 2022
Password expires                                    : May 14, 2022
Password inactive                                   : May 29, 2022
Account expires                                     : never
Minimum number of days between password change      : 1
Maximum number of days between password change      : 90
Number of days of warning before password expires   : 7</pre>
<p>This sets the user’s password to expire every 90 days. If they don’t change it, their account will be disabled 15 days after the change password date. If they change their password when prompted, they won’t be able to change it again until one day later.</p>
<p>You can only change one user at a time using the <code>chage</code> command. This can become cumbersome if you have more than a few users on a few servers. A scripted version that covers all users is far more efficient. I’ve provided my script as follows:</p>
<pre data-type="programlisting">
#!/bin/bash
egrep ^[^:]+:[^\!*] /etc/shadow | cut -d: -f1 | grep -v root &gt; user-list.txt
for user in `more user-list.txt`
do
chage -m 1 -M 90 -I 15 $user
done</pre>
</div></section>
</div></section>
<section data-pdf-bookmark="Retiring Group Accounts" data-type="sect2"><div class="sect2" id="retiring_group_accounts">
<h2>Retiring Group Accounts</h2>
<p>Group accounts that <a contenteditable="false" data-primary="retention policies for user accounts" data-startref="ix_retn" data-type="indexterm" id="idm45657874143776"/><a contenteditable="false" data-primary="health maintenance" data-secondary="maintaining user and group accounts" data-startref="ix_hlthusrgrprtn" data-tertiary="creating account retention policies" data-type="indexterm" id="idm45657874141952"/><a contenteditable="false" data-primary="users" data-secondary="maintaining user accounts" data-startref="ix_usracctreten" data-tertiary="creating account retention policies" data-type="indexterm" id="idm45657873201904"/>remain on the system once they’re empty and inactive are a common source of account sprawl but easily remedied.<a contenteditable="false" data-primary="retiring group accounts" data-type="indexterm" id="idm45657873199024"/><a contenteditable="false" data-primary="groupmems command" data-type="indexterm" id="idm45657873198384"/><a contenteditable="false" data-primary="groups" data-secondary="maintaining group accounts" data-tertiary="retiring group accounts" data-type="indexterm" id="idm45657873199536"/><a contenteditable="false" data-primary="health maintenance" data-secondary="maintaining user and group accounts" data-tertiary="retiring group accounts" data-type="indexterm" id="idm45657873196096"/> The <code>groupmems</code> command can save you a lot of time and frustration by answering who, if anyone, is a member of a specific group:</p>
<pre data-type="programlisting">
$ sudo groupmems -g operations -l
ajones bhaas

$ sudo groupmems -g hr -l
asmith</pre>
<p>The <code>groupmems</code> command options used in the example are <code>-g</code> for the group name and <code>-l</code> for list.</p>
<p>If there are no group members, the command displays no output:</p>
<pre data-type="programlisting">
$ sudo groupmems -g engineering -l
$</pre>
<p>On this system, the engineering group should be retired (removed from the system because it’s empty). But before removing the group, you must find out if the engineering group left any files they own:</p>
<pre data-type="programlisting">
$ sudo find / -group engineering
find: '/proc/3368/task/3368/fd/7': No such file or directory
find: '/proc/3368/task/3368/fdinfo/7': No such file or directory
find: '/proc/3368/fd/6': No such file or directory
find: '/proc/3368/fdinfo/6': No such file or directory
/shared/engineering
/shared/engineering/one
/shared/engineering/two
/shared/engineering/three
/shared/engineering/four
/shared/engineering/five
/shared/engineering/six
/shared/engineering/seven
/shared/engineering/eight
/shared/engineering/nine
/shared/engineering/ten</pre>
<p>You should transfer the files to another user or change ownership to root to secure them and then <a contenteditable="false" data-primary="groupdel command" data-type="indexterm" id="idm45657873950048"/>remove the empty group account:</p>
<pre data-type="programlisting">
$ sudo groupdel engineering</pre>
<p>You have successfully removed the engineering account. You can re-create it in the future if you need to.</p>
<p>Now that I’ve covered sprawl, I will discuss monitoring your system’s health.<a contenteditable="false" data-primary="groups" data-secondary="maintaining group accounts" data-startref="ix_grpacct" data-type="indexterm" id="idm45657873188192"/><a contenteditable="false" data-primary="users" data-secondary="maintaining user accounts" data-startref="ix_usracct" data-type="indexterm" id="idm45657873186560"/><a contenteditable="false" data-primary="health maintenance" data-secondary="maintaining user and group accounts" data-startref="ix_hlthusrgrp" data-type="indexterm" id="idm45657873184944"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Monitoring System Health" data-type="sect1"><div class="sect1" id="monitoring_system_health">
<h1>Monitoring System Health</h1>
<p>System monitoring doesn’t explicitly fall under the sprawl umbrella but is part of maintaining system health. <a contenteditable="false" data-primary="health maintenance" data-secondary="monitoring system health" data-type="indexterm" id="ix_hlthmon"/><a contenteditable="false" data-primary="monitoring system health" data-type="indexterm" id="ix_monsyshlth"/>There are dozens of commercial monitoring tools that you can purchase, but <code>sysstat</code> is a free one native to Linux.<a contenteditable="false" data-primary="sysstat package" data-type="indexterm" id="idm45657873188976"/> It’s easy to install, and on Red Hat–based systems, it self-configures and begins collecting data immediately. On Debian-based systems, you must enable <code>sysstat</code> to collect data manually.<a contenteditable="false" data-primary="system activity reports" data-see="monitoring system health" data-type="indexterm" id="idm45657873217344"/></p>
<p class="pagebreak-after">To enable <code>sysstat</code>’s System Activity Report (<code>sar</code>) utility to begin collecting data, edit the <em>/etc/default/sysstat</em> file and change the <a contenteditable="false" data-primary="sysstat package" data-secondary="enabling System Activity Report" data-type="indexterm" id="idm45657873173008"/>line <a contenteditable="false" data-primary="sar utility (sysstat)" data-type="indexterm" id="idm45657873171568"/>that reads <code>ENABLED="false"</code> to <code>ENABLED="true"</code>.</p>
<p>Then restart the <code>sysstat</code> service:</p>
<pre data-type="programlisting">
$ sudo service sysstat restart</pre>
<p>Give the system some time to begin generating activity reports. You’ll learn how to generate activity reports later in this chapter.</p>
<p>The <code>sysstat</code> package contains new binaries for checking performance and formatting system statistics information. <a data-type="xref" href="#binaries_in_the_sysstat_package">Table 8-5</a> lists the binaries and their functions. I copied the descriptions of each binary from their respective man pages.<a contenteditable="false" data-primary="sysstat package" data-secondary="binaries in" data-type="indexterm" id="idm45657873163840"/></p>
<table class="border" id="binaries_in_the_sysstat_package">
<caption><span class="label">Table 8-5. </span>Binaries in the <code>sysstat</code> package</caption>
<thead>
<tr>
<th>Binary</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="keep-together"><code>cifsiostat</code></span></td>
<td>CIFS statistics</td>
<td>The <code>cifsiostat</code> command displays statistics about read and write operations on CIFS filesystems.</td>
</tr>
<tr>
<td><code>iostat</code></td>
<td>CPU and device I/O statistics</td>
<td>The <code>iostat</code> command is used for monitoring system input/output device loading by observing the time the devices are active in relation to their average transfer rates.</td>
</tr>
<tr>
<td><code>mpstat</code></td>
<td>Processor-related statistics</td>
<td>The <code>mpstat</code> command writes to standard output activities for each available processor, processor 0 being the first one.</td>
</tr>
<tr>
<td><code>pidstat</code></td>
<td>Task statistics</td>
<td>The <code>pidstat</code> command monitors individual tasks currently managed by the Linux kernel.</td>
</tr>
<tr>
<td><code>sadf</code></td>
<td><code>sar</code> data formatting</td>
<td>The <code>sadf</code> command is used for displaying the contents of data files created by the <code>sar</code> command. But unlike <code>sar</code>, <code>sadf</code> can write its data in many different formats (CSV, XML, etc.).</td>
</tr>
<tr>
<td><code>sar</code></td>
<td>System activity reporter</td>
<td>The <code>sar</code> command writes to standard output the contents of selected cumulative activity counters in the operating system.</td>
</tr>
<tr>
<td><code>tapestat</code></td>
<td>Tape statistics</td>
<td>The <code>tapestat</code> command is used for monitoring the activity of tape drives connected to a system.</td>
</tr>
</tbody>
</table>
<p>If you’re familiar with the <code>vmstat</code> command, which isn’t part of <code>sysstat</code>, you know how the other “stat” commands work. <a contenteditable="false" data-primary="vmstat command" data-type="indexterm" id="idm45657873138064"/>For example, <code>vmstat</code>, on every Linux system, requires that you provide a time delay interval between snapshots in seconds and a specific number (count) of snapshots, with <code>5</code> being the typical value used:</p>
<pre data-type="programlisting">
vmstat [<code><em>options</em></code>] [delay [<code><em>count</em></code>]]</pre>
<p>The first run of the <code>vmstat</code> command gives averages since the last reboot:</p>
<pre data-type="programlisting">
$ vmstat 5 5
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id  wa st
 3  0  44616 343888    244 334676    0    0     1     1    1   24  0  0 100  0  0
 0  0  44616 343768    244 334676    0    0     0     0   48   91  0  0 100  0  0
 0  0  44616 343768    244 334676    0    0     0     2   53  104  0  0 100  0  0
 1  0  44616 343768    244 334676    0    0     0     4   78  141  0  0 100  0  0
 0  0  44616 343768    244 334676    0    0     0     0   75  141  0  0 100  0  0</pre>
<p>This <code>vmstat</code> command ran every five seconds with five snapshots. The other “stat” commands work the same way. You provide a delay and a count.<a contenteditable="false" data-primary="iostat command" data-type="indexterm" id="idm45657873131360"/> The following is an <code>iostat</code> command example with two snapshots and a five-second delay:</p>
<pre data-type="programlisting">
$ iostat 5 2
Linux 4.18.0-348.7.1.el8_5.x86_64 (server1)   02/13/2022   _x86_64_  (1 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.01    0.00    0.24    0.01    0.00   99.74

Device             tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               0.16         0.98         1.34    1592993    2187576
scd0              0.00         0.00         0.00          1          0
sdc               0.00         0.01         0.00       8975       2786
sdb               0.00         0.00         0.00       2921       2048
dm-0              0.17         0.94         1.33    1529818    2170543
dm-1              0.02         0.02         0.06      38232      94228
loop0             0.00         0.00         0.00       1192          0
loop1             0.00         0.00         0.00        253          0
loop2             0.00         0.00         0.00       1202          0
dm-2              0.00         0.00         0.00       1223       2048

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00    0.50    0.00    0.00   99.50

Device             tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               0.00         0.00         0.00          0          0
scd0              0.00         0.00         0.00          0          0
sdc               0.00         0.00         0.00          0          0
sdb               0.00         0.00         0.00          0          0
dm-0              0.00         0.00         0.00          0          0
dm-1              0.00         0.00         0.00          0          0
loop0             0.00         0.00         0.00          0          0
loop1             0.00         0.00         0.00          0          0
loop2             0.00         0.00         0.00          0          0
dm-2              0.00         0.00         0.00          0          0</pre>
<section data-pdf-bookmark="Gathering System Activity Reports" data-type="sect2"><div class="sect2" id="gathering_system_activity_reports">
<h2>Gathering System Activity Reports</h2>
<p class="pagebreak-after">The <code>sar</code> command is comprehensive and versatile in its collection, reporting, and saving of system activity information. <a contenteditable="false" data-primary="sysstat package" data-secondary="sar command, gathering system activity reports" data-type="indexterm" id="idm45657873122816"/><a contenteditable="false" data-primary="monitoring system health" data-secondary="gathering system activity reports" data-type="indexterm" id="idm45657873122048"/><a contenteditable="false" data-primary="health maintenance" data-secondary="monitoring system health" data-tertiary="gathering system activity reports" data-type="indexterm" id="idm45657873123584"/><a contenteditable="false" data-primary="sar utility (sysstat)" data-secondary="gathering system activity reports" data-type="indexterm" id="idm45657873119328"/>You can use it like the “stat” commands by supplying an interval and a count, issuing an option such as <code>-b</code> to display I/O statistics, or combining the two to display your selected performance counter at a specific interval.</p>
<p>I’ll begin with an example of using <code>sar</code> with a switch. <a contenteditable="false" data-primary="I/O" data-secondary="statistical data, gathering with sar" data-type="indexterm" id="idm45657873115424"/>Staying with the <code>-b</code> example, here is a partial report of I/O statistics:</p>
<pre data-type="programlisting">
$ sar -b
Linux 4.18.0-348.7.1.el8_5.x86_64 (server1)   02/13/2022   _x86_64_  (1 CPU)

12:00:15 AM       tps      rtps      wtps   bread/s   bwrtn/s
12:10:15 AM      0.22      0.03      0.19      2.32      4.30
12:20:15 AM      0.10      0.00      0.10      0.00      0.79
12:30:15 AM      0.16      0.00      0.16      0.00      1.76
12:40:15 AM      0.08      0.00      0.08      0.00      0.5
...
12:20:15 PM      0.08      0.00      0.08      0.00      0.73
12:30:15 PM      0.10      0.00      0.10      0.00      0.87
12:40:15 PM      0.08      0.00      0.08      0.00      0.78
12:50:15 PM      0.11      0.00      0.11      0.00      0.90
Average:         0.25      0.11      0.14      6.29      2.35</pre>
<p>As you can see from the report, data display begins at midnight, which is why I had to truncate it. The following is an example of I/O statistical data using <code>-b</code> with a count of five and a time delay of five seconds:</p>
<pre data-type="programlisting">
$ sar -b 5 5
Linux 4.18.0-348.7.1.el8_5.x86_64 (server1)   02/13/2022   _x86_64_  (1 CPU)

12:57:13 PM       tps      rtps      wtps   bread/s   bwrtn/s
12:57:18 PM      0.00      0.00      0.00      0.00      0.00
12:57:23 PM      0.00      0.00      0.00      0.00      0.00
12:57:28 PM      0.00      0.00      0.00      0.00      0.00
12:57:33 PM      0.00      0.00      0.00      0.00      0.00
12:57:38 PM      0.00      0.00      0.00      0.00      0.00
Average:         0.00      0.00      0.00      0.00      0.00</pre>
<p>Finally, you can issue <code>sar</code> with a count and an interval:</p>
<pre data-type="programlisting">
$ sar 5 5
Linux 4.18.0-348.7.1.el8_5.x86_64 (server1)   02/13/2022   _x86_64_  (1 CPU)

01:02:11 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
01:02:16 PM     all      0.00      0.00      0.20      0.00      0.00     99.80
01:02:21 PM     all      0.00      0.00      0.40      0.00      0.00     99.60
01:02:26 PM     all      0.00      0.00      0.20      0.00      0.00     99.80
01:02:31 PM     all      0.00      0.00      0.20      0.00      0.00     99.80
01:02:36 PM     all      0.00      0.00      0.20      0.00      0.00     99.80
Average:        all      0.00      0.00      0.24      0.00      0.00     99.76</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The default output from the <code>sar</code> command is CPU statistics.<a contenteditable="false" data-primary="CPUs" data-secondary="statistics from sar command" data-type="indexterm" id="idm45657873107792"/> To display other statistics, you must use a switch, such as <code>-b</code> for I/O data.</p>
</div>
<p>The next section demonstrates how to run system activity reports and save <code>sar</code> data into files.</p>
</div></section>
<section data-pdf-bookmark="Formatting System Activity Reports" data-type="sect2"><div class="sect2" id="formatting_system_activity_reports">
<h2>Formatting System Activity Reports</h2>
<p>Displaying <code>sar</code> data enables you to see snapshots and performance from the last 24 hours, but what if you want to capture that data to a file (the system activity report) in a specific format such as CSV or XML? <a contenteditable="false" data-primary="monitoring system health" data-secondary="formatting system activity reports" data-type="indexterm" id="idm45657873102288"/><a contenteditable="false" data-primary="health maintenance" data-secondary="monitoring system health" data-tertiary="formatting system activity reports" data-type="indexterm" id="idm45657873359088"/><a contenteditable="false" data-primary="sar utility (sysstat)" data-secondary="formatting of system activity reports" data-type="indexterm" id="idm45657873098992"/><a contenteditable="false" data-primary="sadf command" data-type="indexterm" id="idm45657873097744"/>The <code>sadf</code> command is available to you for this purpose.</p>
<p>To help distinguish between the <code>sadf</code> and <code>sar</code> options, remember that <code>sadf</code> options are first in the command, and then <code>sar</code> options follow the double hyphen. Refer to the man pages for all available options for both commands.</p>
<p>My favorite <code>sadf</code> command uses the <code>-d</code> switch to create a comma-separated file that’s perfect for ingesting into a database:</p>
<pre data-type="programlisting">
$ sadf -d
# hostname;interval;timestamp;CPU;%user;%nice;%system;%iowait;%steal;%idle
server1;600;2022-02-13 06:10:15 UTC;-1;0.01;0.00;0.24;0.01;0.00;99.74
server1;600;2022-02-13 06:20:15 UTC;-1;0.00;0.00;0.21;0.01;0.00;99.78
server1;600;2022-02-13 06:30:15 UTC;-1;0.01;0.02;0.23;0.01;0.00;99.74
server1;600;2022-02-13 06:40:15 UTC;-1;0.00;0.00;0.22;0.01;0.00;99.77</pre>
<p>The system activity logs reside in <em>/var/log/sa</em> and have filenames of “sa” immediately followed by a number representing the day of the month. <a contenteditable="false" data-primary="system activity logs" data-type="indexterm" id="idm45657873088432"/>For a system activity log for the tenth of the month, the datafile is <em>sa10</em>. You can specify an activity log datafile from another date:</p>
<pre data-type="programlisting">
$ sadf -d /var/log/sa/sa10 -- -d
# hostname;interval;timestamp;DEV;tps;rkB/s;wkB/s;areq-sz;aqu-sz;await;...
server1;600;2022-02-10 06:10:15 UTC;dev8-0;0.35;8.46;2.17;30.81;0.00;0.62;...
server1;600;2022-02-10 06:10:15 UTC;dev11-0;0.00;0.00;0.00;0.00;0.00;0.00;...
server1;600;2022-02-10 06:10:15 UTC;dev8-32;0.00;0.00;0.00;0.00;0.00;0.00;...
server1;600;2022-02-10 06:10:15 UTC;dev8-16;0.00;0.00;0.00;0.00;0.00;0.00;...
server1;600;2022-02-10 06:10:15 UTC;dev253-0;0.30;8.35;2.27;35.42;0.00;0.90;...
server1;600;2022-02-10 06:10:15 UTC;dev253-1;0.03;0.11;0.00;4.00;0.00;1.00;...
server1;600;2022-02-10 06:10:15 UTC;dev7-0;0.00;0.00;0.00;0.00;0.00;0.00;...
server1;600;2022-02-10 06:10:15 UTC;dev7-1;0.00;0.00;0.00;0.00;0.00;0.00;...
server1;600;2022-02-10 06:10:15 UTC;dev7-2;0.00;0.00;0.00;0.00;0.00;0.00;...
server1;600;2022-02-10 06:10:15 UTC;dev253-2;0.00;0.00;0.00;0.00;0.00;0.00;...</pre>
<div class="pagebreak-after" data-type="note" epub:type="note"><h6>Note</h6>
<p><code>sysstat</code> logs reside in <em>/var/log/sa</em> on some Linux distributions, but on others those logs reside in <em>/var/log/sysstat</em>.</p>
</div>
<p>The <code>--</code> option tells the <code>sadf</code> command that the options that follow it are <code>sar</code> command options and not <code>sadf</code> options. In the command <code>sadf -d /var/log/sa/sa10 -- -d</code>, the <code>-d</code> option following the <code>--</code> will display <code>sar</code> device information. Perhaps a less confusing example is to display network information from the <code>sar</code> command:</p>
<pre data-type="programlisting">
$ sadf -d /var/log/sa03 -- -n DEV
# hostname;interval;timestamp;IFACE;rxpck/s;txpck/s;rxkB/s;txkB/s;rxcmp/s;...
server1;600;2022-02-10 06:10:15 UTC;lo;0.00;0.00;0.00;0.00;0.00;...
server1;600;2022-02-10 06:10:15 UTC;enp0s3;0.50;0.01;0.12;0.00;0.00;...
server1;600;2022-02-10 06:20:15 UTC;lo;0.00;0.00;0.00;0.00;0.00;...
server1;600;2022-02-10 06:20:15 UTC;enp0s3;0.42;0.00;0.10;0.00;0.00;...
server1;600;2022-02-10 06:30:15 UTC;lo;0.00;0.00;0.00;0.00;0.00;...
server1;600;2022-02-10 06:30:15 UTC;enp0s3;0.47;0.00;0.10;0.00;0.00;...</pre>
<p>The <code>-n</code> is the <code>sar</code> option for network activity. <code>DEV</code> means the network device, such as <code>lo</code> (loopback), <code>eth0</code>, <code>enp0s3</code>, and so on.<a contenteditable="false" data-primary="monitoring system health" data-startref="ix_monsyshlth" data-type="indexterm" id="idm45657873075536"/><a contenteditable="false" data-primary="health maintenance" data-secondary="monitoring system health" data-startref="ix_hlthmon" data-type="indexterm" id="idm45657873074608"/></p>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="summary-id00008">
<h1>Summary</h1>
<p>I’ve only scratched the surface of system health, and this chapter could be an entire book. Health monitoring is extremely vital in maintaining SLAs for your customers. Keeping track of system health is an essential system administrator task that affects capacity and performance, security, and standard system housekeeping. It’s so important that some large enterprises dedicate entire teams to it.<a contenteditable="false" data-primary="health maintenance" data-startref="ix_hlth" data-type="indexterm" id="idm45657873070432"/></p>
<p>In <a data-type="xref" href="ch09.xhtml#monitoring_your_system">Chapter 9</a>, I cover nonhealth system monitoring and network inventory systems.</p>
</div></section>
</div></section></div></body></html>