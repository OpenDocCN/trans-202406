<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 12. Jobs" data-type="chapter" epub:type="chapter"><div class="chapter" id="jobs">
<h1><span class="label">Chapter 12. </span>Jobs</h1>
<p>So far we have focused on long-running processes, such as databases and web applications. <a data-primary="jobs" data-type="indexterm" id="ix_jobz"/>These types of workloads run until they are either upgraded or the service is no longer needed. While long-running processes make up the large majority of workloads that run on a Kubernetes cluster, there is often a need to run short-lived, one-off tasks. The Job object is made for handling these types of tasks.</p>
<p>A Job creates Pods that run until successful termination (for instance, exit with 0). In contrast, a regular Pod will continually restart regardless of its exit code. Jobs are useful for things you only want to do once, such as database migrations or batch jobs. If run as a regular Pod, your database migration task would run in a loop, continually repopulating the database after every exit.</p>
<p>In this chapter, we’ll explore the most common job patterns Kubernetes affords. We will also show you how to leverage these patterns in real-life scenarios.</p>
<section data-pdf-bookmark="The Job Object" data-type="sect1"><div class="sect1" id="idm45664076142480">
<h1>The Job Object</h1>
<p>The Job object is responsible for creating and managing Pods defined in a template in the job specification.<a data-primary="jobs" data-secondary="Job object" data-type="indexterm" id="idm45664076141024"/> These Pods generally run until successful completion.  The Job object coordinates running a number of Pods in parallel.</p>
<p>If the Pod fails before a successful termination, the job controller
will create a new Pod based on the Pod template in the job specification. Given that Pods have to be scheduled, there is a chance that your job will not execute if the scheduler does not find the required resources.  Also, due to the nature of distributed systems, there is a small chance that duplicate Pods will be created for a specific task during certain failure scenarios.</p>
</div></section>
<section data-pdf-bookmark="Job Patterns" data-type="sect1"><div class="sect1" id="idm45664076139280">
<h1>Job Patterns</h1>
<p>Jobs are designed to manage batch-like workloads where work items are processed by one or more Pods.<a data-primary="jobs" data-secondary="patterns" data-type="indexterm" id="ix_jobzpatt"/> By default, each job runs a single Pod once until successful termination. This job pattern is defined by two primary attributes of a job: the number of job completions and the number of Pods to run in parallel.<a data-primary="completions parameter (jobs)" data-type="indexterm" id="idm45664076135888"/><a data-primary="parallelism parameter (jobs)" data-type="indexterm" id="idm45664076135248"/> In the case of the “run once until completion” pattern, the <code>completions</code> and <code>parallelism</code> parameters are set to <code>1</code>. <a data-type="xref" href="#Job-pattern-table">Table 12-1</a> highlights job patterns based on the combination of <code>completions</code> and <span class="keep-together"><code>parallelism</code></span> for a job configuration.</p>
<table id="Job-pattern-table">
<caption><span class="label">Table 12-1. </span>Job patterns</caption>
<thead>
<tr>
<th>Type</th>
<th>Use case</th>
<th>Behavior</th>
<th><code>completions</code></th>
<th><code>parallelism</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><p>One shot</p></td>
<td><p>Database migrations</p></td>
<td><p>A single Pod running once until successful termination</p></td>
<td><p>1</p></td>
<td><p>1</p></td>
</tr>
<tr>
<td><p>Parallel fixed completions</p></td>
<td><p>Multiple Pods processing a set of work in parallel</p></td>
<td><p>One or more Pods running one or more times until reaching a fixed completion count</p></td>
<td><p>1+</p></td>
<td><p>1+</p></td>
</tr>
<tr>
<td><p>Work queue: parallel jobs</p></td>
<td><p>Multiple Pods processing from a centralized work queue</p></td>
<td><p>One or more Pods running once until successful termination</p></td>
<td><p>1</p></td>
<td><p>2+</p></td>
</tr>
</tbody>
</table>
<section data-pdf-bookmark="One Shot" data-type="sect2"><div class="sect2" id="idm45664076115648">
<h2>One Shot</h2>
<p>One-shot jobs provide a way to run a single Pod once until successful termination.<a data-primary="jobs" data-secondary="patterns" data-tertiary="one shot" data-type="indexterm" id="idm45664076113664"/><a data-primary="one-shot jobs" data-type="indexterm" id="idm45664076112416"/> While this may sound like an easy task, there is some work involved in pulling this off. First, a Pod must be created and submitted to the Kubernetes API. This is done using a Pod template defined in the job configuration. Once a job is up and running, the Pod backing the job must be monitored for successful termination. A job can fail for any number of reasons, including an application error, an uncaught exception during runtime, or a node failure before the job has a chance to complete. In all cases, the job controller is responsible for re-creating the Pod until a successful termination occurs.</p>
<p>There are multiple ways to create a one-shot job in Kubernetes.<a data-primary="kubectl tool" data-secondary="commands" data-tertiary="run" data-type="indexterm" id="idm45664076111232"/> The easiest is to use the <code>kubectl</code> command-line tool:</p>
<pre data-type="programlisting">$ <strong>kubectl run -i oneshot \
  --image=gcr.io/kuar-demo/kuard-amd64:blue \
  --restart=OnFailure \
  --command /kuard \
  -- --keygen-enable \
     --keygen-exit-on-complete \
     --keygen-num-to-gen 10</strong>

...
(ID 0) Workload starting
(ID 0 1/10) Item done: SHA256:nAsUsG54XoKRkJwyN+OShkUPKew3mwq7OCc
(ID 0 2/10) Item done: SHA256:HVKX1ANns6SgF/er1lyo+ZCdnB8geFGt0/8
(ID 0 3/10) Item done: SHA256:irjCLRov3mTT0P0JfsvUyhKRQ1TdGR8H1jg
(ID 0 4/10) Item done: SHA256:nbQAIVY/yrhmEGk3Ui2sAHuxb/o6mYO0qRk
(ID 0 5/10) Item done: SHA256:CCpBoXNlXOMQvR2v38yqimXGAa/w2Tym+aI
(ID 0 6/10) Item done: SHA256:wEY2TTIDz4ATjcr1iimxavCzZzNjRmbOQp8
(ID 0 7/10) Item done: SHA256:t3JSrCt7sQweBgqG5CrbMoBulwk4lfDWiTI
(ID 0 8/10) Item done: SHA256:E84/Vze7KKyjCh9OZh02MkXJGoty9PhaCec
(ID 0 9/10) Item done: SHA256:UOmYex79qqbI1MhcIfG4hDnGKonlsij2k3s
(ID 0 10/10) Item done: SHA256:WCR8wIGOFag84Bsa8f/9QHuKqF+0mEnCADY
(ID 0) Workload exiting</pre>
<p>There are some things to note here:</p>
<ul>
<li>
<p>The <code>-i</code> option to <code>kubectl</code> indicates that this is an interactive command. <code>kubectl</code> will wait until the job is running and then show the log output from the first (and in this case only) Pod in the job.<a data-primary="interactive commands (kubectl)" data-type="indexterm" id="idm45664076105264"/></p>
</li>
<li>
<p><code>--restart=OnFailure</code> is the option that tells <code>kubectl</code> to create a Job object.</p>
</li>
<li>
<p>All of the options after <code>--</code> are command-line arguments to the container image.  These instruct our test server (<code>kuard</code>) to generate ten 4,096-bit SSH keys and then exit.</p>
</li>
<li>
<p>Your output may not match this exactly. <code>kubectl</code> often misses the first couple of lines of output with the <code>-i</code> option.</p>
</li>
</ul>
<p>After the job has completed, the Job object and related Pod are retained so that you can inspect the log output. Note that this job won’t show up in <code>kubectl get jobs</code> unless you pass the <code>-a</code> flag.  Without this flag, <code>kubectl</code> hides completed jobs.  <a data-primary="kubectl tool" data-secondary="commands" data-tertiary="get jobs -a" data-type="indexterm" id="idm45664076097264"/><a data-primary="kubectl tool" data-secondary="commands" data-tertiary="delete pods" data-type="indexterm" id="idm45664076096016"/>Delete the job before continuing:</p>
<pre data-type="programlisting">$ <strong>kubectl delete pods oneshot</strong></pre>
<p>The other option for creating a one-shot job is using a configuration file, as shown in <a data-type="xref" href="#oneshot-yaml-ex">Example 12-1</a>.</p>
<div data-type="example" id="oneshot-yaml-ex">
<h5><span class="label">Example 12-1. </span>job-oneshot.yaml</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">batch/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Job</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">oneshot</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kuard</code><code class="w"/>
<code class="w">        </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gcr.io/kuar-demo/kuard-amd64:blue</code><code class="w"/>
<code class="w">        </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Always</code><code class="w"/>
<code class="w">        </code><code class="nt">command</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"/kuard"</code><code class="w"/>
<code class="w">        </code><code class="nt">args</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-enable"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-exit-on-complete"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-num-to-gen=10"</code><code class="w"/>
<code class="w">      </code><code class="nt">restartPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">OnFailure</code><code class="w"/></pre></div>
<p>Submit the job using the <code>kubectl apply</code> command:</p>
<pre data-type="programlisting">$ <strong>kubectl apply -f job-oneshot.yaml</strong>
job.batch/oneshot created</pre>
<p>Then <code>describe</code> the <code>oneshot</code> job<a data-primary="kubectl tool" data-secondary="commands" data-tertiary="describe jobs oneshot" data-type="indexterm" id="idm45664076003376"/>:</p>
<pre data-type="programlisting">$ <strong>kubectl describe jobs oneshot</strong>

Name:           oneshot
Namespace:      default
Selector:       controller-uid=a2ed65c4-cfda-43c8-bb4a-707c4ed29143
Labels:         controller-uid=a2ed65c4-cfda-43c8-bb4a-707c4ed29143
                job-name=oneshot
Annotations:    &lt;none&gt;
Parallelism:    1
Completions:    1
Start Time:     Wed, 02 Jun 2021 21:23:23 -0700
Completed At:   Wed, 02 Jun 2021 21:23:51 -0700
Duration:       28s
Pods Statuses:  0 Running / 1 Succeeded / 0 Failed
Pod Template:
  Labels:  controller-uid=a2ed65c4-cfda-43c8-bb4a-707c4ed29143
           job-name=oneshot
Events:
  ... Reason             Message
  ... ------             -------
  ... SuccessfulCreate   Created pod: oneshot-4kfdt</pre>
<p>You can view the results of <a data-primary="kubectl tool" data-secondary="commands" data-tertiary="logs" data-type="indexterm" id="idm45664076000400"/><a data-primary="logs" data-secondary="viewing for one-shot job" data-type="indexterm" id="idm45664075999152"/>the job by looking at the logs of the Pod that was created:</p>
<pre data-type="programlisting">$ <strong>kubectl logs oneshot-4kfdt</strong>

...
Serving on :8080
(ID 0) Workload starting
(ID 0 1/10) Item done: SHA256:+r6b4W81DbEjxMcD3LHjU+EIGnLEzbpxITKn8IqhkPI
(ID 0 2/10) Item done: SHA256:mzHewajaY1KA8VluSLOnNMk9fDE5zdn7vvBS5Ne8AxM
(ID 0 3/10) Item done: SHA256:TRtEQHfflJmwkqnNyGgQm/IvXNykSBIg8c03h0g3onE
(ID 0 4/10) Item done: SHA256:tSwPYH/J347il/mgqTxRRdeZcOazEtgZlA8A3/HWbro
(ID 0 5/10) Item done: SHA256:IP8XtguJ6GbWwLHqjKecVfdS96B17nnO21I/TNc1j9k
(ID 0 6/10) Item done: SHA256:ZfNxdQvuST/6ZzEVkyxdRG98p73c/5TM99SEbPeRWfc
(ID 0 7/10) Item done: SHA256:tH+CNl/IUl/HUuKdMsq2XEmDQ8oAvmhMO6Iwj8ZEOj0
(ID 0 8/10) Item done: SHA256:3GfsUaALVEHQcGNLBOu4Qd1zqqqJ8j738i5r+I5XwVI
(ID 0 9/10) Item done: SHA256:5wV4L/xEiHSJXwLUT2fHf0SCKM2g3XH3sVtNbgskCXw
(ID 0 10/10) Item done: SHA256:bPqqOonwSbjzLqe9ZuVRmZkz+DBjaNTZ9HwmQhbdWLI
(ID 0) Workload exiting</pre>
<p>Congratulations, your job has run successfully!</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Notice that we didn’t specify any labels when creating the Job object.  <a data-primary="labels" data-secondary="Job objects and" data-type="indexterm" id="idm45664075995520"/>Like with other controllers (such as DaemonSets, ReplicaSets, and Deployments) that use labels to identify a set of Pods, unexpected behaviors can occur if a Pod is reused across objects.</p>
<p>Because jobs have a finite beginning and ending, users often create many of them.  This makes picking unique labels more difficult and more critical. For this reason, the Job object will automatically pick a unique label and use it to identify the Pods it creates.  In advanced scenarios (such as swapping out a running job without killing the Pods it is managing), users can choose to turn off this automatic behavior and manually specify labels and <span class="keep-together">selectors</span>.</p>
</div>
<p>We just saw how a job can complete successfully.  But what happens if something fails?  Let’s try that out and see what happens. Modify the arguments to <code>kuard</code> in our configuration file to cause it to fail with a nonzero exit code after generating three keys, as shown in <a data-type="xref" href="#oneshot-failure-ex">Example 12-2</a>.</p>
<div data-type="example" id="oneshot-failure-ex">
<h5><span class="label">Example 12-2. </span>job-oneshot-failure1.yaml</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="p">...</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p">...</code><code class="w"/>
<code class="w">        </code><code class="nt">args</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-enable"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-exit-on-complete"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-exit-code=1"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-num-to-gen=3"</code><code class="w"/>
<code class="p">...</code><code class="w"/></pre></div>
<p>Now launch this <a data-primary="kubectl tool" data-secondary="commands" data-tertiary="apply -f" data-type="indexterm" id="idm45664075874096"/>with <code>kubectl apply -f job-oneshot-failure1.yaml</code>.  Let it run for a bit and then look at the Pod status:</p>
<pre data-type="programlisting">$ <strong>kubectl get pod -l job-name=oneshot</strong>

NAME            READY     STATUS             RESTARTS   AGE
oneshot-3ddk0   0/1       CrashLoopBackOff   4          3m</pre>
<p>Here we see that the same Pod has restarted four times.  Kubernetes is in <code>CrashLoopBackOff</code> for this Pod.<a data-primary="CrashLoopBackOff" data-type="indexterm" id="idm45664075923136"/>  It is not uncommon to have a bug someplace that causes a program to crash as soon as it starts.<a data-primary="Pods" data-secondary="CrashLoopBackOff" data-type="indexterm" id="idm45664075922160"/>  In that case, Kubernetes will wait a bit before restarting the Pod to avoid a crash loop that would eat resources on the node.  This is all handled local to the node by the <code>kubelet</code> without the job being involved at all.<a data-primary="kubelet" data-type="indexterm" id="idm45664075920512"/><a data-primary="kubectl tool" data-secondary="commands" data-tertiary="delete jobs oneshot" data-type="indexterm" id="idm45664075919808"/></p>
<p>Kill the job (<code>kubectl delete jobs oneshot</code>), and let’s try something else. Modify the config file again and change the <code>restartPolicy</code> from <code>OnFailure</code> to <code>Never</code>.  Launch this with <code>kubectl apply -f jobs-oneshot-failure2.yaml</code>.</p>
<p>If we let this run for a bit and then look at related Pods, we’ll find something <span class="keep-together">interesting</span>:</p>
<pre data-type="programlisting">$ <strong>kubectl get pod -l job-name=oneshot -a</strong>

NAME            READY     STATUS    RESTARTS   AGE
oneshot-0wm49   0/1       Error     0          1m
oneshot-6h9s2   0/1       Error     0          39s
oneshot-hkzw0   1/1       Running   0          6s
oneshot-k5swz   0/1       Error     0          28s
oneshot-m1rdw   0/1       Error     0          19s
oneshot-x157b   0/1       Error     0          57s</pre>
<p>What we see is that we have multiple Pods here that have errored out.  By setting <code>restartPolicy: Never</code>, we are telling the <code>kubelet</code> not to restart the Pod on failure, but rather just declare the Pod as failed.<a data-primary="restartPolicy: Never" data-type="indexterm" id="idm45664075861552"/>  The Job object then notices and creates a replacement Pod.  If you aren’t careful, this’ll create a lot of “junk” in your cluster.  For this reason, we suggest you use <code>restartPolicy: OnFailure</code> so failed Pods are rerun in place. Clean this up with <code>kubectl delete jobs oneshot</code>.</p>
<p>So far we’ve seen a program fail by exiting with a nonzero exit code.  But workers can fail in other ways.  Specifically, they can get stuck and not make any forward progress.  To help cover this case, you can use liveness probes with jobs.  If the liveness probe policy determines that a Pod is dead, it’ll be
restarted or replaced for you.</p>
</div></section>
<section data-pdf-bookmark="Parallelism" data-type="sect2"><div class="sect2" id="idm45664076114736">
<h2>Parallelism</h2>
<p>Generating keys can be slow.  Let’s start a bunch of workers together to make key generation faster.<a data-primary="jobs" data-secondary="patterns" data-tertiary="parallelism" data-type="indexterm" id="idm45664075858256"/><a data-primary="parallelism parameter (jobs)" data-type="indexterm" id="idm45664075857008"/>  We’re going to use a combination of the <code>completions</code> and <code class="keep-together">parallelism</code> parameters.  Our goal is to generate 100 keys by having 10 runs of <code>kuard</code>, with each run generating 10 keys.  But we don’t want to swamp our cluster, so we’ll limit ourselves to only five Pods at a time.</p>
<p>This translates to setting <code>completions</code> to <code>10</code> and <code>parallelism</code> to <code>5</code>.  The config is shown in <a data-type="xref" href="#job-para-yaml">Example 12-3</a>.</p>
<div data-type="example" id="job-para-yaml">
<h5><span class="label">Example 12-3. </span>job-parallel.yaml</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">batch/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Job</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">parallel</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">chapter</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">jobs</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">parallelism</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">5</code><code class="w"/>
<code class="w">  </code><code class="nt">completions</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">10</code><code class="w"/>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">chapter</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">jobs</code><code class="w"/>
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kuard</code><code class="w"/>
<code class="w">        </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gcr.io/kuar-demo/kuard-amd64:blue</code><code class="w"/>
<code class="w">        </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Always</code><code class="w"/>
<code class="w">        </code><code class="nt">command</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"/kuard"</code><code class="w"/>
<code class="w">        </code><code class="nt">args</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-enable"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-exit-on-complete"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-num-to-gen=10"</code><code class="w"/>
<code class="w">      </code><code class="nt">restartPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">OnFailure</code><code class="w"/></pre></div>
<p>Start it up:</p>
<pre data-type="programlisting">$ <strong>kubectl apply -f job-parallel.yaml</strong>
job.batch/parallel created</pre>
<p>Now watch as the Pods come up, do their thing, and exit.  New Pods are created until 10 have completed altogether.<a data-primary="kubectl tool" data-secondary="commands" data-tertiary="get pods" data-type="indexterm" id="idm45664075728080"/> Here we use the <code>--watch</code> flag to have <code>kubectl</code> stay around and list changes as they happen:</p>
<pre data-type="programlisting">$ <strong>kubectl get pods -w</strong>
NAME             READY     STATUS              RESTARTS  AGE
parallel-55tlv   1/1       Running             0         5s
parallel-5s7s9   1/1       Running             0         5s
parallel-jp7bj   1/1       Running             0         5s
parallel-lssmn   1/1       Running             0         5s
parallel-qxcxp   1/1       Running             0         5s
NAME             READY     STATUS              RESTARTS  AGE
parallel-jp7bj   0/1       Completed           0         26s
parallel-tzp9n   0/1       Pending             0         0s
parallel-tzp9n   0/1       Pending             0         0s
parallel-tzp9n   0/1       ContainerCreating   0         1s
parallel-tzp9n   1/1       Running             0         1s
parallel-tzp9n   0/1       Completed           0         48s
parallel-x1kmr   0/1       Pending             0         0s
...</pre>
<p>Feel free to study the completed jobs and check out their logs to see the fingerprints of the keys they generated.  <a data-primary="kubectl tool" data-secondary="commands" data-tertiary="delete job parallel" data-type="indexterm" id="idm45664075723360"/>Clean up by deleting the finished Job object with <code>kubectl delete job parallel</code>.</p>
</div></section>
<section data-pdf-bookmark="Work Queues" data-type="sect2"><div class="sect2" id="idm45664075721472">
<h2>Work Queues</h2>
<p>A common use case for jobs is to process work from a work queue.<a data-primary="jobs" data-secondary="patterns" data-tertiary="work queues" data-type="indexterm" id="ix_jobzpattwkqu"/><a data-primary="work queues" data-type="indexterm" id="ix_wkqu"/><a data-primary="parallel job work queue" data-type="indexterm" id="idm45664075717440"/> In this
scenario, some task creates a number of work items and publishes them to a work queue. A worker job can be run to process each work item until the work queue is empty (<a data-type="xref" href="#fig1001">Figure 12-1</a>).</p>
<figure><div class="figure" id="fig1001">
<img alt="kur3 1201" height="194" src="assets/kur3_1201.png" width="672"/>
<h6><span class="label">Figure 12-1. </span>Parallel jobs</h6>
</div></figure>
<section data-pdf-bookmark="Starting a work queue" data-type="sect3"><div class="sect3" id="idm45664075713552">
<h3>Starting a work queue</h3>
<p>We start by launching a centralized work queue service. <code>kuard</code> has a simple memory-based work queue system built in. <a data-primary="work queues" data-secondary="starting" data-type="indexterm" id="idm45664075711104"/>We will start an instance of <code>kuard</code> to act as a coordinator for all the work.</p>
<p>Next, we create a simple ReplicaSet to manage a singleton work queue daemon.<a data-primary="ReplicaSets" data-secondary="creating to manage singleton work queue daemon" data-type="indexterm" id="idm45664075709200"/> We are using a ReplicaSet to ensure that a new Pod will get created in the face of machine failure, as shown in <a data-type="xref" href="#rs.queue.yaml-ex">Example 12-4</a>.</p>
<div data-type="example" id="rs.queue.yaml-ex">
<h5><span class="label">Example 12-4. </span>rs-queue.yaml</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ReplicaSet</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">work-queue</code><code class="w"/>
<code class="w">    </code><code class="nt">component</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">queue</code><code class="w"/>
<code class="w">    </code><code class="nt">chapter</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">jobs</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">queue</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">replicas</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">work-queue</code><code class="w"/>
<code class="w">      </code><code class="nt">component</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">queue</code><code class="w"/>
<code class="w">      </code><code class="nt">chapter</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">jobs</code><code class="w"/>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">work-queue</code><code class="w"/>
<code class="w">        </code><code class="nt">component</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">queue</code><code class="w"/>
<code class="w">        </code><code class="nt">chapter</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">jobs</code><code class="w"/>
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">queue</code><code class="w"/>
<code class="w">        </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="s">"gcr.io/kuar-demo/kuard-amd64:blue"</code><code class="w"/>
<code class="w">        </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Always</code><code class="w"/></pre></div>
<p>Run the work queue with <a data-primary="kubectl tool" data-secondary="commands" data-tertiary="apply -f" data-type="indexterm" id="idm45664075550864"/>the following command:</p>
<pre data-type="programlisting">$ <strong>kubectl apply -f rs-queue.yaml</strong>
replicaset.apps/queue created</pre>
<p>At this point, the work queue daemon should be up and running. Let’s use port-forwarding to connect to it. <a data-primary="kubectl tool" data-secondary="commands" data-tertiary="kubectl port-forward rs" data-type="indexterm" id="idm45664075498320"/>Leave this command running in a terminal window:</p>
<pre data-type="programlisting">$ <strong>kubectl port-forward rs/queue 8080:8080</strong>
Forwarding from 127.0.0.1:8080 -&gt; 8080
Forwarding from [::1]:8080 -&gt; 8080</pre>
<p>You can open your browser to <em>http://localhost:8080</em> and see the <code>kuard</code>
interface. Switch to the “MemQ Server” tab to keep an eye on what is going on.</p>
<p>With the work queue server in place, the next step is to expose it using a service. This will make it easy for producers and consumers to locate the work queue via DNS, as <a data-type="xref" href="#serviceyaml_EX">Example 12-5</a> shows.</p>
<div data-type="example" id="serviceyaml_EX">
<h5><span class="label">Example 12-5. </span>service-queue.yaml</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Service</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">work-queue</code><code class="w"/>
<code class="w">    </code><code class="nt">component</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">queue</code><code class="w"/>
<code class="w">    </code><code class="nt">chapter</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">jobs</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">queue</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w"/>
<code class="w">    </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code><code class="w"/>
<code class="w">    </code><code class="nt">targetPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8080</code><code class="w"/>
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">work-queue</code><code class="w"/>
<code class="w">    </code><code class="nt">component</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">queue</code><code class="w"/></pre></div>
<p>Create the queue service with <code>kubectl</code>:</p>
<pre data-type="programlisting">$ <strong>kubectl apply -f service-queue.yaml</strong>
service/queue created</pre>
</div></section>
<section data-pdf-bookmark="Loading up the queue" data-type="sect3"><div class="sect3" id="idm45664075712896">
<h3>Loading up the queue</h3>
<p>We are now ready to put a bunch of work items in the queue.<a data-primary="work queues" data-secondary="loading up the queue" data-type="indexterm" id="idm45664075367920"/>  For the sake of simplicity, we’ll just use <code>curl</code> to drive the API for the work queue server and insert a bunch of work items.  <code>curl</code> will communicate to the work queue through the <code>kubectl port-forward</code> we set up earlier, as shown in <a data-type="xref" href="#load_ex">Example 12-6</a>.</p>
<div data-type="example" id="load_ex">
<h5><span class="label">Example 12-6. </span>load-queue.sh</h5>
<pre data-type="programlisting"># Create a work queue called 'keygen'
curl -X PUT localhost:8080/memq/server/queues/keygen

# Create 100 work items and load up the queue.
for i in work-item-{0..99}; do
  curl -X POST localhost:8080/memq/server/queues/keygen/enqueue \
    -d "$i"
done</pre></div>
<p>Run these commands, and you should see 100 JSON objects output to your terminal with a unique message identifier for each work item. You can confirm the status of the queue by looking at the “MemQ Server” tab in the UI, or you can ask the work queue API directly:</p>
<pre data-type="programlisting">$ <strong>curl 127.0.0.1:8080/memq/server/stats</strong>
{
    "kind": "stats",
    "queues": [
        {
            "depth": 100,
            "dequeued": 0,
            "drained": 0,
            "enqueued": 100,
            "name": "keygen"
        }
    ]
}</pre>
<p>Now we are ready to kick off a job to consume the work queue until it’s empty.</p>
</div></section>
<section data-pdf-bookmark="Creating the consumer job" data-type="sect3"><div class="sect3" id="idm45664075360352">
<h3>Creating the consumer job</h3>
<p>This is where things get interesting! <code>kuard</code> can also act in consumer mode.<a data-primary="work queues" data-secondary="creating a consumer job" data-type="indexterm" id="idm45664075358560"/><a data-primary="consumer job, creating" data-type="indexterm" id="idm45664075336752"/>  We can set it up to draw work items from the work queue, create a key, and then exit once the queue is empty, as shown in <a data-type="xref" href="#job-con-ex">Example 12-7</a>.</p>
<div data-type="example" id="job-con-ex">
<h5><span class="label">Example 12-7. </span>job-consumers.yaml</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">batch/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Job</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">message-queue</code><code class="w"/>
<code class="w">    </code><code class="nt">component</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">consumer</code><code class="w"/>
<code class="w">    </code><code class="nt">chapter</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">jobs</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">consumers</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">parallelism</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">5</code><code class="w"/>
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">message-queue</code><code class="w"/>
<code class="w">        </code><code class="nt">component</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">consumer</code><code class="w"/>
<code class="w">        </code><code class="nt">chapter</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">jobs</code><code class="w"/>
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">worker</code><code class="w"/>
<code class="w">        </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="s">"gcr.io/kuar-demo/kuard-amd64:blue"</code><code class="w"/>
<code class="w">        </code><code class="nt">imagePullPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Always</code><code class="w"/>
<code class="w">        </code><code class="nt">command</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"/kuard"</code><code class="w"/>
<code class="w">        </code><code class="nt">args</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-enable"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-exit-on-complete"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-memq-server=http://queue:8080/memq/server"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"--keygen-memq-queue=keygen"</code><code class="w"/>
<code class="w">      </code><code class="nt">restartPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">OnFailure</code><code class="w"/></pre></div>
<p>Here, we are telling the job to start up five Pods in parallel. <a data-primary="completions parameter (jobs)" data-type="indexterm" id="idm45664075128416"/>As the <code>completions</code> parameter is unset, we put the job into worker-pool mode.  Once the first Pod exits with a zero exit code, the job will start winding down and will not start any new Pods.  This means that none of the workers should exit until the work is done and they are all in the process of finishing up.</p>
<p>Now, create the <code>consumers</code> job:</p>
<pre data-type="programlisting">$ <strong>kubectl apply -f job-consumers.yaml</strong>
job.batch/consumers created</pre>
<p>Then you can view the Pods backing the job:</p>
<pre data-type="programlisting">$ <strong>kubectl get pods</strong>
NAME              READY     STATUS    RESTARTS   AGE
queue-43s87       1/1       Running   0          5m
consumers-6wjxc   1/1       Running   0          2m
consumers-7l5mh   1/1       Running   0          2m
consumers-hvz42   1/1       Running   0          2m
consumers-pc8hr   1/1       Running   0          2m
consumers-w20cc   1/1       Running   0          2m</pre>
<p>Note there are five Pods running in parallel. These Pods will continue to run until the work queue is empty.  You can watch as it happens in the UI on the work queue server.  As the queue empties, the consumer Pods will exit cleanly and the <code>consumers</code> job will be considered complete.</p>
</div></section>
<section data-pdf-bookmark="Cleanup" data-type="sect3"><div class="sect3" id="idm45664075182416">
<h3>Cleanup</h3>
<p>Using labels, we can clean up all of the stuff <a data-primary="work queues" data-secondary="cleaning up" data-type="indexterm" id="idm45664075181088"/><a data-primary="kubectl tool" data-secondary="commands" data-tertiary="delete" data-type="indexterm" id="idm45664075180112"/>we created in this section:</p>
<pre data-type="programlisting">$ <strong>kubectl delete rs,svc,job -l chapter=jobs</strong></pre>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="CronJobs" data-type="sect1"><div class="sect1" id="idm45664075177536">
<h1>CronJobs</h1>
<p>Sometimes you want to schedule a job to be run at a certain interval.<a data-primary="work queues" data-startref="ix_wkqu" data-type="indexterm" id="idm45664075176000"/><a data-primary="jobs" data-secondary="patterns" data-startref="ix_jobzpattwkqu" data-tertiary="work queues" data-type="indexterm" id="idm45664075175024"/><a data-primary="jobs" data-secondary="patterns" data-startref="ix_jobzpatt" data-type="indexterm" id="idm45664075173536"/><a data-primary="CronJobs" data-type="indexterm" id="idm45664075172320"/><a data-primary="jobs" data-secondary="CronJobs" data-type="indexterm" id="idm45664075171648"/> To achieve this, you
can declare a CronJob in Kubernetes, which is responsible for creating a new Job
object at a particular interval. <a data-type="xref" href="#job-cronjob-ex">Example 12-8</a> is an example CronJob declaration:</p>
<div data-type="example" id="job-cronjob-ex">
<h5><span class="label">Example 12-8. </span>job-cronjob.yaml</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">batch/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CronJob</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">example-cron</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="c1"># Run every fifth hour</code><code class="w"/>
<code class="w">  </code><code class="nt">schedule</code><code class="p">:</code><code class="w"> </code><code class="s">"0</code><code class="nv"> </code><code class="s">*/5</code><code class="nv"> </code><code class="s">*</code><code class="nv"> </code><code class="s">*</code><code class="nv"> </code><code class="s">*"</code><code class="w"/>
<code class="w">  </code><code class="nt">jobTemplate</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">batch-job</code><code class="w"/>
<code class="w">            </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">my-batch-image</code><code class="w"/>
<code class="w">          </code><code class="nt">restartPolicy</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">OnFailure</code><code class="w"/></pre></div>
<p>Note the <code>spec.schedule</code> field, which contains the interval for the
CronJob in standard <code>cron</code> format.</p>
<p>You can save this file as <em>job-cronjob.yaml</em>, and create the CronJob with
<code>kubectl create -f cron-job.yaml</code>. If you are interested in the current state of
a CronJob, you can use <code>kubectl describe <em>&lt;cron-job&gt;</em></code> to get the details.</p>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45664075075008">
<h1>Summary</h1>
<p>On a single cluster, Kubernetes can handle both long-running workloads such as web applications and short-lived workloads such as batch jobs. The job abstraction allows you to model batch job patterns ranging from simple, one-time tasks to parallel jobs that process many items until the work has been exhausted.</p>
<p>Jobs are a low-level primitive and can be used directly for simple workloads. However, Kubernetes is built from the ground up to be extensible by higher-level objects. Jobs are no exception; higher-level orchestration systems can easily use them to take on more complex tasks.<a data-primary="jobs" data-startref="ix_jobz" data-type="indexterm" id="idm45664075073264"/></p>
</div></section>
</div></section></div></body></html>