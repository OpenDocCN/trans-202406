<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. Setting Up a Replica Set"><div class="chapter" id="chapter_d1e9405"><h1><span class="label">Chapter 10. </span>Setting Up a Replica Set</h1><p>This chapter introduces MongoDB’s high-availability system: replica
  sets. It covers:</p><ul><li><p>What replica sets are</p></li><li><p>How to set up a replica set</p></li><li><p>What configuration options are available for replica set
      members</p></li></ul><section data-type="sect1" data-pdf-bookmark="Introduction to Replication"><div class="sect1" id="idm45882356836536"><h1>Introduction to Replication</h1><p>Since the first chapter, we’ve been using a
    <span class="firstterm">standalone</span> server, a single <em class="filename">mongod</em> server. It’s an easy way to get started
    but a dangerous way to run in production. What if your server crashes or
    becomes unavailable? Your database will be unavailable for at least a
    little while. If there are problems with the hardware, you might have to
    move your data to another machine. In the worst case, disk or network
    issues could leave you with corrupt or inaccessible data.</p><p><span class="firstterm">Replication</span><a data-type="indexterm" data-primary="replication" data-secondary="purpose of" id="idm45882356833096"/> is a way of keeping identical copies of your data on
    multiple servers and is recommended for all production deployments.
    Replication keeps your application running and your data safe, even if
    something happens to one or more of your servers.</p><p>With MongoDB, you set up replication by creating a <em>replica
    set</em>. A replica set<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="benefits of replica sets" id="idm45882356806584"/> is a group of servers with one
    <em>primary</em>, the server taking writes, and multiple
    <em>secondaries</em>, servers that keep copies of the
    primary’s data. If the primary crashes, the secondaries can elect a new
    primary from amongst themselves.</p><p>If you are using replication and a server goes down, you can still
    access your data from the other servers in the set. If the data on a
    server is damaged or inaccessible, you can make a new copy of the data
    from one of the other members of the set.</p><p>This chapter introduces replica sets and covers how to set up
    replication on your system. If you are less interested in replication
    mechanics and simply want to create a replica set for testing/development
    or production, use<a data-type="indexterm" data-primary="MongoDB Atlas" id="idm45882356803416"/> MongoDB’s cloud solution, <a href="https://atlas.mongodb.com">MongoDB Atlas</a>. It’s easy to use
    and provides a free-tier option for experimentation. Alternatively, to
    manage MongoDB clusters in your own infrastructure, you can<a data-type="indexterm" data-primary="Ops Manager" id="idm45882356801528"/> use <a href="https://oreil.ly/-X6yp">Ops
    Manager</a>.</p></div></section><section data-type="sect1" data-pdf-bookmark="Setting Up a Replica Set, Part 1"><div class="sect1" id="idm45882356799848"><h1>Setting Up a Replica Set, Part 1</h1><p>In this chapter, we’ll show you how to set up a three-node replica
    set on a single machine so you can start experimenting with replica set
    mechanics. This is the type of setup that you might script just to get a
    replica set up and running and then poke at it with administrative
    commands in the <em>mongo</em> shell or simulate network
    partitions or server failures to better understand how MongoDB handles
    high availability and disaster recovery. In<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="best practices" id="idm45882356797816"/> production, you should always use a replica set and
    allocate a dedicated host to each member to avoid resource contention and
    provide isolation against server failure. To provide further resilience,
    you should also use the <a href="https://oreil.ly/cCORE">DNS
    Seedlist Connection format</a><a data-type="indexterm" data-primary="DNS Seedlist Connection format" id="idm45882356795704"/> to specify how your applications connect to your replica
    set. The advantage to using DNS is that servers hosting your MongoDB
    replica set members can be changed in rotation without needing to
    reconfigure the clients (specifically, their connection strings).</p><p>Given<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="test replica sets" id="idm45882356794168"/> the variety of virtualization and cloud options available,
    it is nearly as easy to bring up a test replica set with each member on a
    dedicated host. We’ve provided a Vagrant script to allow you to experiment
    with this option.<sup><a data-type="noteref" id="idm45882356792632-marker" href="ch10.xhtml#idm45882356792632">1</a></sup></p><p>To get started with our test replica set, let’s first create
    separate data directories for each node. On Linux or macOS, run the
    following command in the terminal to create the three
    directories:</p><pre data-type="programlisting">$ mkdir -p ~/data/rs{1,2,3}</pre><p>This will create the directories <em>~/data/rs1</em>,
    <em>~/data/rs2</em>, and <em>~/data/rs3</em>
    (<code>~</code> identifies your home directory).</p><p>On Windows, to create these directories, run the following in the
    Command Prompt (cmd) or PowerShell:</p><pre data-type="programlisting">&gt; md c:\data\rs1 c:\data\rs2 c:\data\rs3</pre><p>Then, on Linux or macOS, run each of the following commands in a
    separate <span class="keep-together">terminal</span>:</p><pre data-type="programlisting">$ mongod --replSet mdbDefGuide --dbpath ~/data/rs1 --port 27017 \
    --smallfiles --oplogSize 200
$ mongod --replSet mdbDefGuide --dbpath ~/data/rs2 --port 27018 \
    --smallfiles --oplogSize 200
$ mongod --replSet mdbDefGuide --dbpath ~/data/rs3 --port 27019 \
    --smallfiles --oplogSize 200</pre><p>On Windows, run each of the following commands in its own Command
    Prompt or PowerShell window:</p><pre data-type="programlisting">&gt; mongod --replSet mdbDefGuide --dbpath c:\data\rs1 --port 27017 \
    --smallfiles --oplogSize 200
&gt; mongod --replSet mdbDefGuide --dbpath c:\data\rs2 --port 27018 \
    --smallfiles --oplogSize 200
&gt; mongod --replSet mdbDefGuide --dbpath c:\data\rs3 --port 27019 \
    --smallfiles --oplogSize 200</pre><p>Once you’ve started them, you should have three separate <em class="filename">mongod</em> processes running.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>In general, the principles we will walk through in the rest of
      this chapter apply to replica sets used in production deployments where
      each <em>mongod</em> has a dedicated host. However, there
      are additional details pertaining to securing replica sets that we
      address in <a data-type="xref" href="ch19.xhtml#chapter-data-admin">Chapter 19</a>; we’ll touch on those
      just briefly here as a preview.</p></div></div></section><section data-type="sect1" data-pdf-bookmark="Networking Considerations"><div class="sect1" id="idm45882356799544"><h1>Networking Considerations</h1><p>Every<a data-type="indexterm" data-primary="networking" data-secondary="for replica sets" id="idm45882356779672"/><a data-type="indexterm" data-primary="mongod" data-secondary="replica set networking considerations" id="idm45882356778536"/><a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="networking considerations" id="idm45882356777368"/> member of a set must be able to make connections to every
    other member of the set (including itself). If you get errors about
    members not being able to reach other members that you know are running,
    you may have to change your network configuration to allow connections
    between them.</p><p>The processes you’ve launched can just as easily be running on
    separate servers. However, with the release of MongoDB 3.6, <em class="filename">mongod</em> binds to <em>localhost</em>
    (127.0.0.1) only by default. In order for each member of replica set to
    communicate with the others, you must also bind to an IP address that is
    reachable by other members. If we were running a
    <em>mongod</em> instance on a server with a network interface
    having an IP address of 198.51.100.1 and we wanted to run it as a member
    of replica set with each member on different servers, we could specify the
    command-line parameter <code>--bind_ip</code> or use
    <code>bind_ip</code> in the configuration file for
    this instance: </p><pre data-type="programlisting">$ mongod --bind_ip localhost,192.51.100.1 --replSet mdbDefGuide \
    --dbpath ~/data/rs1 --port 27017 --smallfiles --oplogSize 200</pre><p>We would make similar modifications to launch the other
    <em>mongod</em>s as well in this case, regardless of whether
    we’re running on Linux, macOS, or Windows.</p></div></section><section data-type="sect1" data-pdf-bookmark="Security Considerations"><div class="sect1" id="idm45882356770840"><h1>Security Considerations</h1><p>Before<a data-type="indexterm" data-primary="security considerations" data-secondary="replica sets set up" id="idm45882356769896"/><a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="security considerations" id="idm45882356768760"/> you bind to IP addresses other than <em class="filename">localhost</em>, when configuring a replica set, you
    should enable authorization controls and specify an authentication
    mechanism. In addition, it is a good idea to encrypt data on disk and
    communication among replica set members and between the set and clients.
    We’ll go into more detail on securing replica sets in <a data-type="xref" href="ch19.xhtml#chapter-data-admin">Chapter 19</a>.</p></div></section><section data-type="sect1" data-pdf-bookmark="Setting Up a Replica Set, Part 2"><div class="sect1" id="idm45882356765576"><h1>Setting Up a Replica Set, Part 2</h1><p>Returning<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="listing and sending members" id="idm45882356764408"/> to our example, with the work we’ve done so far, each
    <em class="filename">mongod</em> does not yet know that the
    others exist. To tell them about one another, we need to create a
    configuration that lists each of the members and send this configuration
    to one of our <em class="filename">mongod</em> processes. It
    will take care of propagating the configuration to the other
    members.</p><p>In a fourth terminal, Windows Command Prompt, or PowerShell window,
    launch<a data-type="indexterm" data-primary="mongo shell" data-secondary="launching" id="idm45882356761032"/> a <em>mongo</em> shell that connects to one of
    the running <em>mongod</em> instances. You can do this by
    typing the following command. With this command, we’ll connect to the
    <em>mongod</em> running on port 27017:</p><pre data-type="programlisting">$ mongo --port 27017</pre><p>Then, in the <em>mongo</em> shell, create a
    configuration document and pass this to the <code>rs.initiate()<a data-type="indexterm" data-primary="rs.initiate()" id="idm45882356756664"/></code> helper to initiate a replica set. This will initiate
    a replica set containing three members and propagate the configuration to
    the rest of the <em class="filename">mongod</em>s so that a
    replica set is formed:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rsconf</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">_id</code><code class="o">:</code> <code class="s2">"mdbDefGuide"</code><code class="p">,</code>
    <code class="nx">members</code><code class="o">:</code> <code class="p">[</code>
      <code class="p">{</code><code class="nx">_id</code><code class="o">:</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">host</code><code class="o">:</code> <code class="s2">"localhost:27017"</code><code class="p">},</code>
      <code class="p">{</code><code class="nx">_id</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="nx">host</code><code class="o">:</code> <code class="s2">"localhost:27018"</code><code class="p">},</code>
      <code class="p">{</code><code class="nx">_id</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code> <code class="nx">host</code><code class="o">:</code> <code class="s2">"localhost:27019"</code><code class="p">}</code> 
    <code class="p">]</code>
  <code class="p">}</code>
<code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">initiate</code><code class="p">(</code><code class="nx">rsconf</code><code class="p">)</code>
<code class="p">{</code> <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501186502</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code> <code class="p">}</code></pre><p>There<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="configuration document" id="idm45882356752712"/> are several important parts of a replica set configuration
    document. The config’s <code class="varname">"_id"</code> is the name of the replica
    set that you passed in on the command line (in this example,
    <code class="varname">"mdbDefGuide"</code>). Make sure that this name matches
    exactly.</p><p>The next part of the document is an array of members of the set.
    Each of these needs two fields: an <code class="varname">"_id"</code> that is an
    integer and unique among the replica set members, and a hostname.</p><p>Note<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="localhost versus non-localhost servers" id="idm45882356688904"/> that we are using <em class="filename">localhost</em> as a hostname for the members in this
    set. This is for example purposes only. In later chapters where we discuss
    securing replica sets, we’ll look at configurations that are more
    appropriate for production deployments. MongoDB allows all-<em class="filename">localhost</em> replica sets for testing locally but
    will protest if you try to mix <em class="filename">localhost</em> and non-<em class="filename">localhost</em> servers in a config.</p><p>This config document is your replica set configuration. The member
    running on <em class="filename">localhost:27017</em> will parse
    the configuration and send messages to the other members, alerting them of
    the new configuration. Once they have all loaded the configuration, they
    will elect a primary and start handling reads and writes.</p><div data-type="tip"><h6>Tip</h6><p>Unfortunately, you cannot<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="standalone server conversion" id="idm45882356682872"/> convert a standalone server to a replica set without some
      downtime for restarting it and initializing the set. Thus, even if you
      only have one server to start out with, you may want to configure it as
      a one-member replica set. That way, if you want to add more members
      later, you can do so without downtime.</p></div><p>If you are starting a brand-new set, you can send the configuration
    to any member in the set. If you are starting with data on one of the
    members, you must send the configuration to the member with data. You
    cannot initiate a replica set with data on more than one member.</p><p>Once initiated, you should have a fully functional replica set. The
    replica set should elect a primary. You<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="viewing status of" id="idm45882356680136"/> can view the status of a replica set using
    <code>rs.status()<a data-type="indexterm" data-primary="rs.status()" id="idm45882356678680"/></code>. The output from <code>rs.status()</code> tells you
    quite a bit about the replica set, including a number of things we’ve not
    yet covered, but don’t worry, we’ll get there! For now, take a look at the
    <code>members</code> array. Note that all three of our
    <em>mongod</em> instances are listed in this array and that
    one of them, in this case the <em>mongod</em> running on port
    27017, has been elected primary. The other two are secondaries. If you try
    this for yourself you will certainly have different values for <code>"date"</code> and the several <code>Timestamp</code> values in this output, but you might
    also find that a different <em>mongod</em> was elected primary
    (that’s totally fine):</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">status</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"set"</code> <code class="o">:</code> <code class="s2">"mdbDefGuide"</code><code class="p">,</code>
    <code class="s2">"date"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T20:23:31.457Z"</code><code class="p">),</code>
    <code class="s2">"myState"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"term"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">),</code>
    <code class="s2">"heartbeatIntervalMillis"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">2000</code><code class="p">),</code>
    <code class="s2">"optimes"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"lastCommittedOpTime"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501187006</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
        <code class="p">},</code>
        <code class="s2">"appliedOpTime"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501187006</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
        <code class="p">},</code>
        <code class="s2">"durableOpTime"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501187006</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
        <code class="p">}</code>
    <code class="p">},</code>
    <code class="s2">"members"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"localhost:27017"</code><code class="p">,</code>
            <code class="s2">"health"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"stateStr"</code> <code class="o">:</code> <code class="s2">"PRIMARY"</code><code class="p">,</code>
            <code class="s2">"uptime"</code> <code class="o">:</code> <code class="mi">688</code><code class="p">,</code>
            <code class="s2">"optime"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501187006</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
                <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"optimeDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T20:23:26Z"</code><code class="p">),</code>
            <code class="s2">"electionTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501186514</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"electionDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T20:15:14Z"</code><code class="p">),</code>
            <code class="s2">"configVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"self"</code> <code class="o">:</code> <code class="kc">true</code>
        <code class="p">},</code>
        <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"localhost:27018"</code><code class="p">,</code>
            <code class="s2">"health"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"stateStr"</code> <code class="o">:</code> <code class="s2">"SECONDARY"</code><code class="p">,</code>
            <code class="s2">"uptime"</code> <code class="o">:</code> <code class="mi">508</code><code class="p">,</code>
            <code class="s2">"optime"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501187006</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
                <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"optimeDurable"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501187006</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
                <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"optimeDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T20:23:26Z"</code><code class="p">),</code>
            <code class="s2">"optimeDurableDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T20:23:26Z"</code><code class="p">),</code>
            <code class="s2">"lastHeartbeat"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T20:23:30.818Z"</code><code class="p">),</code>
            <code class="s2">"lastHeartbeatRecv"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T20:23:30.113Z"</code><code class="p">),</code>
            <code class="s2">"pingMs"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code>
            <code class="s2">"syncingTo"</code> <code class="o">:</code> <code class="s2">"localhost:27017"</code><code class="p">,</code>
            <code class="s2">"configVersion"</code> <code class="o">:</code> <code class="mi">1</code>
        <code class="p">},</code>
        <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"name"</code> <code class="o">:</code> <code class="s2">"localhost:27019"</code><code class="p">,</code>
            <code class="s2">"health"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"state"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"stateStr"</code> <code class="o">:</code> <code class="s2">"SECONDARY"</code><code class="p">,</code>
            <code class="s2">"uptime"</code> <code class="o">:</code> <code class="mi">508</code><code class="p">,</code>
            <code class="s2">"optime"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501187006</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
                <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"optimeDurable"</code> <code class="o">:</code> <code class="p">{</code>
                <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501187006</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
                <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
            <code class="p">},</code>
            <code class="s2">"optimeDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T20:23:26Z"</code><code class="p">),</code>
            <code class="s2">"optimeDurableDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T20:23:26Z"</code><code class="p">),</code>
            <code class="s2">"lastHeartbeat"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T20:23:30.818Z"</code><code class="p">),</code>
            <code class="s2">"lastHeartbeatRecv"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T20:23:30.113Z"</code><code class="p">),</code>
            <code class="s2">"pingMs"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code>
            <code class="s2">"syncingTo"</code> <code class="o">:</code> <code class="s2">"localhost:27017"</code><code class="p">,</code>
            <code class="s2">"configVersion"</code> <code class="o">:</code> <code class="mi">1</code>
        <code class="p">}</code>
    <code class="p">],</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501187006</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
<code class="p">}</code></pre><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45882356680440"><h5>rs Helper Functions</h5><p><code class="varname">rs</code> is<a data-type="indexterm" data-primary="db.adminCommand()" id="idm45882356664040"/><a data-type="indexterm" data-primary="rs helper functions" id="idm45882356663208"/><a data-type="indexterm" data-primary="rs global variable" id="idm45882356662376"/> a global variable that contains replication helper
      functions (run <code>rs.help()<a data-type="indexterm" data-primary="rs.help()" id="idm45882356661128"/></code> to see the helpers it exposes). These <span class="keep-together">functions</span> are almost always just wrappers
      around database commands. For example, the following database command is
      equivalent to <code>rs.initiate(config<a data-type="indexterm" data-primary="rs.initiate(config)" id="idm45882356253976"/>)</code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"replSetInitiate"</code> <code class="o">:</code> <code class="nx">config</code><code class="p">})</code></pre><p>It is good to have familiarity with both the helpers and the
      underlying commands, because it might be easier to use the command form
      instead of the helper.</p></div></aside></div></section><section data-type="sect1" data-pdf-bookmark="Observing Replication"><div class="sect1" id="idm45882356765272"><h1>Observing Replication</h1><p>If<a data-type="indexterm" data-primary="replication" data-secondary="observing" id="Robserv10"/><a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="observing replication" id="RSSUobserv10"/> your replica set elected the <em>mongod</em> on
    port 27017 as primary, then the <em>mongo</em> shell used to
    initiate the replica set is currently connected to the primary. You should
    see the prompt change to something like the following:</p><pre data-type="programlisting">mdbDefGuide:PRIMARY&gt;</pre><p>This indicates that we are connected to the primary of the replica
    set having the <code>"_id"</code> <code>"mdbDefGuide"</code>. To simplify
    and for the sake of clarity, we’ll abbreviate the
    <em>mongo</em> shell prompt to just <code>&gt;</code>
    throughout the replication examples.</p><p>If your replica set elected a different node primary, quit the shell
    and connect to the primary by specifying the correct port number in the
    command line, as we did when launching the <em class="filename">mongo</em> shell earlier. For example, if your set’s
    primary is on port 27018, connect using the following
    command:</p><pre data-type="programlisting">$ mongo --port 27018</pre><p>Now that you’re connected to the primary, try doing some writes and
    see what happens. First, insert 1,000 documents:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">use</code> <code class="nx">test</code>
<code class="o">&gt;</code> <code class="k">for</code> <code class="p">(</code><code class="nx">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="nx">i</code><code class="o">&lt;</code><code class="mi">1000</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code><code class="nx">db</code><code class="p">.</code><code class="nx">coll</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="nx">count</code><code class="o">:</code> <code class="nx">i</code><code class="p">})}</code>
<code class="o">&gt;</code>
<code class="o">&gt;</code> <code class="c1">// make sure the docs are there</code>
<code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">coll</code><code class="p">.</code><code class="nx">count</code><code class="p">()</code>
<code class="mi">1000</code></pre><p>Now check one of the secondaries and verify that it has a copy of
    all of these documents. You could do this by quitting the shell and
    connecting using the port number of one of the secondaries, but it’s easy
    to acquire a connection to one of the secondaries by instantiating a
    connection object using the <code>Mongo</code> constructor within the
    shell you’re already running.</p><p>First, use your connection to the <em>test</em> database
    on the primary to run the <code>isMaster</code>
    command. This will show you the status of the replica set, in a much more
    concise form than <code>rs.status()</code>. It is also a convenient means
    of determining which member is primary when writing application code or
    scripting:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">isMaster</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"hosts"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="s2">"localhost:27017"</code><code class="p">,</code>
        <code class="s2">"localhost:27018"</code><code class="p">,</code>
        <code class="s2">"localhost:27019"</code>
    <code class="p">],</code>
    <code class="s2">"setName"</code> <code class="o">:</code> <code class="s2">"mdbDefGuide"</code><code class="p">,</code>
    <code class="s2">"setVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"primary"</code> <code class="o">:</code> <code class="s2">"localhost:27017"</code><code class="p">,</code>
    <code class="s2">"me"</code> <code class="o">:</code> <code class="s2">"localhost:27017"</code><code class="p">,</code>
    <code class="s2">"electionId"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"7fffffff0000000000000004"</code><code class="p">),</code>
    <code class="s2">"lastWrite"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"opTime"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501198208</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">4</code><code class="p">)</code>
        <code class="p">},</code>
        <code class="s2">"lastWriteDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T23:30:08Z"</code><code class="p">)</code>
    <code class="p">},</code>
    <code class="s2">"maxBsonObjectSize"</code> <code class="o">:</code> <code class="mi">16777216</code><code class="p">,</code>
    <code class="s2">"maxMessageSizeBytes"</code> <code class="o">:</code> <code class="mi">48000000</code><code class="p">,</code>
    <code class="s2">"maxWriteBatchSize"</code> <code class="o">:</code> <code class="mi">1000</code><code class="p">,</code>
    <code class="s2">"localTime"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-27T23:30:08.722Z"</code><code class="p">),</code>
    <code class="s2">"maxWireVersion"</code> <code class="o">:</code> <code class="mi">6</code><code class="p">,</code>
    <code class="s2">"minWireVersion"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"readOnly"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"compression"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="s2">"snappy"</code>
    <code class="p">],</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501198208</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
<code class="p">}</code></pre><p>If at any point an election is called and the
    <em>mongod</em> you’re connected to becomes a secondary, you
    can use the <code>isMaster</code> command to
    determine which member has become primary. The output here tells us that
    <em class="filename">localhost:27018</em> and <em class="filename">localhost:27019</em> are both secondaries, so we can
    use either for our purposes. Let’s instantiate a connection to <em class="filename">localhost:27019</em>:</p><pre data-type="programlisting">&gt; secondaryConn = new Mongo("localhost:27019")
connection to localhost:27019
&gt;
&gt; secondaryDB = secondaryConn.getDB("test")
test</pre><p>Now, if we attempt to do a read on the collection that has been
    replicated to the secondary, we’ll get an error. Let’s attempt to do a
    <code class="function">find</code> on this collection and then
    review the error and why we get it:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">secondaryDB</code><code class="p">.</code><code class="nx">coll</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="nb">Error</code><code class="o">:</code> <code class="nx">error</code><code class="o">:</code> <code class="p">{</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501200089</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"errmsg"</code> <code class="o">:</code> <code class="s2">"not master and slaveOk=false"</code><code class="p">,</code>
    <code class="s2">"code"</code> <code class="o">:</code> <code class="mi">13435</code><code class="p">,</code>
    <code class="s2">"codeName"</code> <code class="o">:</code> <code class="s2">"NotMasterNoSlaveOk"</code>
<code class="p">}</code></pre><p>Secondaries may fall behind the primary (or
    <em>lag</em>) and not have the most current writes, so
    secondaries will refuse read requests by default to prevent applications
    from accidentally reading stale data. Thus, if you attempt to query a
    secondary, you’ll get an error stating that it’s not the primary. This is
    to protect your application from accidentally connecting to a secondary
    and reading stale data. To allow queries on the secondary, we can set an
    “I’m okay with reading from secondaries” flag, like so:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">secondaryConn</code><code class="p">.</code><code class="nx">setSlaveOk</code><code class="p">()</code></pre><p>Note that <code class="option">slaveOk</code> is set on the
    <em>connection</em> (<code>secondaryConn</code>), not the database (<span class="keep-together"><code>secondaryDB</code>)</span>.</p><p>Now you’re all set to read from this member. Query it
    normally:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">secondaryDB</code><code class="p">.</code><code class="nx">coll</code><code class="p">.</code><code class="nx">find</code><code class="p">()</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85db"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">0</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85dc"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">1</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85dd"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">2</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85de"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">3</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85df"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">4</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85e0"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">5</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85e1"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">6</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85e2"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">7</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85e3"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">8</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85e4"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">9</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85e5"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">10</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85e6"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">11</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85e7"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">12</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85e8"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">13</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85e9"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">14</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85ea"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">15</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85eb"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">16</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85ec"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">17</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85ed"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">18</code> <code class="p">}</code>
<code class="p">{</code> <code class="s2">"_id"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a750696fd35621b4b85ee"</code><code class="p">),</code> <code class="s2">"count"</code> <code class="o">:</code> <code class="mi">19</code> <code class="p">}</code>
<code class="nx">Type</code> <code class="s2">"it"</code> <code class="k">for</code> <code class="nx">more</code></pre><p>You can see that all of our documents are there.</p><p>Now, try to write to a secondary:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">secondaryDB</code><code class="p">.</code><code class="nx">coll</code><code class="p">.</code><code class="nx">insert</code><code class="p">({</code><code class="s2">"count"</code> <code class="o">:</code> <code class="mi">1001</code><code class="p">})</code>
<code class="nx">WriteResult</code><code class="p">({</code> <code class="s2">"writeError"</code> <code class="o">:</code> <code class="p">{</code> <code class="s2">"code"</code> <code class="o">:</code> <code class="mi">10107</code><code class="p">,</code> <code class="s2">"errmsg"</code> <code class="o">:</code> <code class="s2">"not master"</code> <code class="p">}</code> <code class="p">})</code>
<code class="o">&gt;</code> <code class="nx">secondaryDB</code><code class="p">.</code><code class="nx">coll</code><code class="p">.</code><code class="nx">count</code><code class="p">()</code>
<code class="mi">1000</code></pre><p>You can see that the secondary does not accept the write. A
    secondary will only perform writes that it gets through replication, not
    from clients.</p><p>There is one other interesting feature that you should try out:
    automatic failover<a data-type="indexterm" data-primary="automatic failover" id="idm45882355372088"/>. If the primary goes down, one of the secondaries will
    automatically be elected primary. To test this, stop the primary:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">db</code><code class="p">.</code><code class="nx">adminCommand</code><code class="p">({</code><code class="s2">"shutdown"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">})</code></pre><p>You’ll see some error messages generated when you run this command
    because the <em class="filename">mongod</em> running on port
    27017 (the member we’re connected to) will terminate and the shell we’re
    using will lose its connection:</p><pre data-type="programlisting">2017-07-27T20:10:50.612-0400 E QUERY    [thread1] Error: error doing query: 
 failed: network error while attempting to run command 'shutdown' on host 
 '127.0.0.1:27017'  :
DB.prototype.runCommand@src/mongo/shell/db.js:163:1
DB.prototype.adminCommand@src/mongo/shell/db.js:179:16
@(shell):1:1
2017-07-27T20:10:50.614-0400 I NETWORK  [thread1] trying reconnect to 
 127.0.0.1:27017 (127.0.0.1) failed
2017-07-27T20:10:50.615-0400 I NETWORK  [thread1] reconnect 
 127.0.0.1:27017 (127.0.0.1) ok
MongoDB Enterprise mdbDefGuide:SECONDARY&gt; 
2017-07-27T20:10:56.051-0400 I NETWORK  [thread1] trying reconnect to 
 127.0.0.1:27017 (127.0.0.1) failed
2017-07-27T20:10:56.051-0400 W NETWORK  [thread1] Failed to connect to 
 127.0.0.1:27017, in(checking socket for error after poll), reason: 
 Connection refused
2017-07-27T20:10:56.051-0400 I NETWORK  [thread1] reconnect 
 127.0.0.1:27017 (127.0.0.1) failed failed 
MongoDB Enterprise &gt; 
MongoDB Enterprise &gt; secondaryConn.isMaster()
2017-07-27T20:11:15.422-0400 E QUERY    [thread1] TypeError: 
 secondaryConn.isMaster is not a function :
@(shell):1:1</pre><p>This isn’t a problem. It won’t cause the shell to crash. Go ahead
    and run <code class="function">isMaster</code><a data-type="indexterm" data-primary="isMaster command" id="idm45882355361544"/> on the secondary to see who has become the new
    primary:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">secondaryDB</code><code class="p">.</code><code class="nx">isMaster</code><code class="p">()</code></pre><p>The output from <code>isMaster</code> should
    look something like this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
    <code class="s2">"hosts"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="s2">"localhost:27017"</code><code class="p">,</code>
        <code class="s2">"localhost:27018"</code><code class="p">,</code>
        <code class="s2">"localhost:27019"</code>
    <code class="p">],</code>
    <code class="s2">"setName"</code> <code class="o">:</code> <code class="s2">"mdbDefGuide"</code><code class="p">,</code>
    <code class="s2">"setVersion"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"ismaster"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="s2">"secondary"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"primary"</code> <code class="o">:</code> <code class="s2">"localhost:27018"</code><code class="p">,</code>
    <code class="s2">"me"</code> <code class="o">:</code> <code class="s2">"localhost:27019"</code><code class="p">,</code>
    <code class="s2">"electionId"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"7fffffff0000000000000005"</code><code class="p">),</code>
    <code class="s2">"lastWrite"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"opTime"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"ts"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501200681</code><code class="p">,</code> <code class="mi">1</code><code class="p">),</code>
            <code class="s2">"t"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code>
        <code class="p">},</code>
        <code class="s2">"lastWriteDate"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-28T00:11:21Z"</code><code class="p">)</code>
    <code class="p">},</code>
    <code class="s2">"maxBsonObjectSize"</code> <code class="o">:</code> <code class="mi">16777216</code><code class="p">,</code>
    <code class="s2">"maxMessageSizeBytes"</code> <code class="o">:</code> <code class="mi">48000000</code><code class="p">,</code>
    <code class="s2">"maxWriteBatchSize"</code> <code class="o">:</code> <code class="mi">1000</code><code class="p">,</code>
    <code class="s2">"localTime"</code> <code class="o">:</code> <code class="nx">ISODate</code><code class="p">(</code><code class="s2">"2017-07-28T00:11:28.115Z"</code><code class="p">),</code>
    <code class="s2">"maxWireVersion"</code> <code class="o">:</code> <code class="mi">6</code><code class="p">,</code>
    <code class="s2">"minWireVersion"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
    <code class="s2">"readOnly"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s2">"compression"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="s2">"snappy"</code>
    <code class="p">],</code>
    <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501200681</code><code class="p">,</code> <code class="mi">1</code><code class="p">)</code>
<code class="p">}</code></pre><p>Note that the primary has switched to 27018. Your primary may be the
    other server; whichever secondary noticed that the primary was down first
    will be elected. Now you can send writes to the new primary.</p><div data-type="tip"><h6>Tip</h6><p><code>isMaster</code> is a very old command,
      predating replica sets to when MongoDB only supported master/slave
      replication<a data-type="indexterm" data-primary="replication" data-secondary="master/slave" id="idm45882355284312"/><a data-type="indexterm" data-primary="master/slave replication" id="idm45882355283304"/>. Thus, it does not use the replica set terminology
      consistently: it still calls the primary a “master.” You can generally
      think of “master” as equivalent to “primary” and “slave” as equivalent
      to “secondary.”</p></div><p>Go ahead and bring back up the server we had running at <em class="filename">localhost:27017</em>. You simply need to find the
    command-line interface from which you launched it. You’ll see some
    messages indicating that it terminated. Just run it again using the same
    command you used to launch it originally.</p><p>Congratulations! You just set up, used, and even poked a little at a
    replica set to force a shutdown and an election for a new primary.</p><p>There<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="key concepts" id="idm45882355075992"/> are a few key concepts to remember:</p><ul><li><p>Clients can send a primary all the same operations they could
        send a standalone server (reads, writes, commands, index builds,
        etc.).</p></li><li><p>Clients cannot write to secondaries.</p></li><li><p>Clients, by default, cannot read from secondaries. You can
        enable this by explicitly setting an “I know I’m reading from a
        secondary” setting on the<a data-type="indexterm" data-startref="RSSUobserv10" id="idm45882355073064"/><a data-type="indexterm" data-startref="Robserv10" id="idm45882355072232"/> connection.</p></li></ul></div></section><section data-type="sect1" data-pdf-bookmark="Changing Your Replica Set Configuration"><div class="sect1" id="idm45882356244680"><h1>Changing Your Replica Set Configuration</h1><p>Replica<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="changing configuration" id="RSSUconfig10"/><a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="adding new members" id="idm45882355068984"/> set configurations can be changed at any time: members can
    be added, removed, or modified. There are shell helpers for some common
    operations. For example, to add a new member to the set, you can use
    <code class="function">rs.add<a data-type="indexterm" data-primary="rs.add command" id="idm45882355066952"/></code>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">add</code><code class="p">(</code><code class="s2">"localhost:27020"</code><code class="p">)</code></pre><p>Similarly, you can<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="removing members" id="idm45882355062568"/> remove members:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">remove</code><code class="p">(</code><code class="s2">"localhost:27017"</code><code class="p">)</code>
<code class="p">{</code> <code class="s2">"ok"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code> <code class="s2">"operationTime"</code> <code class="o">:</code> <code class="nx">Timestamp</code><code class="p">(</code><code class="mi">1501202441</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code> <code class="p">}</code></pre><p>You<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="checking for reconfiguration success" id="idm45882355018648"/> can check that a reconfiguration succeeded by running
    <code class="function">rs.config()<a data-type="indexterm" data-primary="rs.config()" id="idm45882355013768"/></code> in the shell. It will print the current
    configuration:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">config</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"mdbDefGuide"</code><code class="p">,</code>
    <code class="s2">"version"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code>
    <code class="s2">"protocolVersion"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">1</code><code class="p">),</code>
    <code class="s2">"members"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"localhost:27018"</code><code class="p">,</code>
            <code class="s2">"arbiterOnly"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"buildIndexes"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
            <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"priority"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"tags"</code> <code class="o">:</code> <code class="p">{</code>
                
            <code class="p">},</code>
            <code class="s2">"slaveDelay"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code>
            <code class="s2">"votes"</code> <code class="o">:</code> <code class="mi">1</code>
        <code class="p">},</code>
        <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"localhost:27019"</code><code class="p">,</code>
            <code class="s2">"arbiterOnly"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"buildIndexes"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
            <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"priority"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"tags"</code> <code class="o">:</code> <code class="p">{</code>
                
            <code class="p">},</code>
            <code class="s2">"slaveDelay"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code>
            <code class="s2">"votes"</code> <code class="o">:</code> <code class="mi">1</code>
        <code class="p">},</code>
        <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">3</code><code class="p">,</code>
            <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"localhost:27020"</code><code class="p">,</code>
            <code class="s2">"arbiterOnly"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"buildIndexes"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
            <code class="s2">"hidden"</code> <code class="o">:</code> <code class="kc">false</code><code class="p">,</code>
            <code class="s2">"priority"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"tags"</code> <code class="o">:</code> <code class="p">{</code>
                
            <code class="p">},</code>
            <code class="s2">"slaveDelay"</code> <code class="o">:</code> <code class="nx">NumberLong</code><code class="p">(</code><code class="mi">0</code><code class="p">),</code>
            <code class="s2">"votes"</code> <code class="o">:</code> <code class="mi">1</code>
        <code class="p">}</code>
    <code class="p">],</code>
    <code class="s2">"settings"</code> <code class="o">:</code> <code class="p">{</code>
        <code class="s2">"chainingAllowed"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
        <code class="s2">"heartbeatIntervalMillis"</code> <code class="o">:</code> <code class="mi">2000</code><code class="p">,</code>
        <code class="s2">"heartbeatTimeoutSecs"</code> <code class="o">:</code> <code class="mi">10</code><code class="p">,</code>
        <code class="s2">"electionTimeoutMillis"</code> <code class="o">:</code> <code class="mi">10000</code><code class="p">,</code>
        <code class="s2">"catchUpTimeoutMillis"</code> <code class="o">:</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code>
        <code class="s2">"getLastErrorModes"</code> <code class="o">:</code> <code class="p">{</code>
            
        <code class="p">},</code>
        <code class="s2">"getLastErrorDefaults"</code> <code class="o">:</code> <code class="p">{</code>
            <code class="s2">"w"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"wtimeout"</code> <code class="o">:</code> <code class="mi">0</code>
        <code class="p">},</code>
        <code class="s2">"replicaSetId"</code> <code class="o">:</code> <code class="nx">ObjectId</code><code class="p">(</code><code class="s2">"597a49c67e297327b1e5b116"</code><code class="p">)</code>
    <code class="p">}</code>
<code class="p">}</code></pre><p>Each time you change the configuration, the <code>"version"</code> field will increase. It starts at
    version 1.</p><p>You<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="modifying existing members" id="idm45882354894680"/> can also modify existing members, not just add and remove
    them. To make modifications, create the configuration document that you
    want in the shell and call <code class="function">rs.reconfig()<a data-type="indexterm" data-primary="rs.reconfig()" id="idm45882354892760"/></code>. For example, suppose we have a configuration
    such as the one shown here:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">config</code><code class="p">()</code>
<code class="p">{</code>
    <code class="s2">"_id"</code> <code class="o">:</code> <code class="s2">"testReplSet"</code><code class="p">,</code>
    <code class="s2">"version"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
    <code class="s2">"members"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>
            <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"198.51.100.1:27017"</code>
        <code class="p">},</code>
        <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">1</code><code class="p">,</code>
            <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"localhost:27018"</code>
        <code class="p">},</code>
        <code class="p">{</code>
            <code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">2</code><code class="p">,</code>
            <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"localhost:27019"</code>
        <code class="p">}</code>
    <code class="p">]</code>
<code class="p">}</code></pre><p>Someone accidentally added member 0 by IP address, instead of its
    hostname. To change that, first we load the current configuration in the
    shell and then we change the relevant fields:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="kd">var</code> <code class="nx">config</code> <code class="o">=</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">config</code><code class="p">()</code>
<code class="o">&gt;</code> <code class="nx">config</code><code class="p">.</code><code class="nx">members</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">host</code> <code class="o">=</code> <code class="s2">"localhost:27017"</code></pre><p>Now that the config document is correct, we need to send it to the
    database using the <code class="function">rs.reconfig()</code>
    helper:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">reconfig</code><code class="p">(</code><code class="nx">config</code><code class="p">)</code></pre><p><code class="function">rs.reconfig()</code> is often more
    useful than <code class="function">rs.add()</code> and <code class="function">rs.remove()</code> for complex operations, such as
    modifying members’ configurations or adding/removing multiple members at
    once. You can use it to make any legal configuration change you need:
    simply create the config document that represents your desired
    configuration and pass<a data-type="indexterm" data-startref="RSSUconfig10" id="idm45882354632200"/> it to <code class="function">rs.reconfig()</code>.</p></div></section><section data-type="sect1" data-pdf-bookmark="How to Design a Set"><div class="sect1" id="repl-setup-section4"><h1>How to Design a Set</h1><p>To<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="designing sets" id="RSSUdesign10"/> plan out your set, there are certain concepts that you must
    be familiar with. The next chapter goes into more detail about these, but
    the most important is that replica sets are all about majorities: you need
    a majority of members to elect a primary, a primary can only stay primary
    as long as it can reach a majority, and a write is safe when it’s been
    replicated to a<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="majority of the set" id="idm45882354627240"/> majority. This <span class="firstterm">majority</span> is defined
    to be “more than half of all members in the set,” as shown in <a data-type="xref" href="#table9-1">Table 10-1</a>.</p><table id="table9-1"><caption><span class="label">Table 10-1. </span>What is a majority?</caption><thead><tr><th>Number of members in the set</th><th>Majority of the set</th></tr></thead><tbody><tr><td>1</td><td>1</td></tr><tr><td>2</td><td>2</td></tr><tr><td>3</td><td>2</td></tr><tr><td>4</td><td>3</td></tr><tr><td>5</td><td>3</td></tr><tr><td>6</td><td>4</td></tr><tr><td>7</td><td>4</td></tr></tbody></table><p>Note that it doesn’t matter how many members are down or
    unavailable; majority is based on the set’s configuration.</p><p>For example, suppose that we have a five-member set and three
    members go down, as shown in <a data-type="xref" href="#repl141">Figure 10-1</a>. There are still
    two members up. These two members cannot reach a majority of the set (at
    least three members), so they cannot elect a primary. If one of them were
    primary, it would step down as soon as it noticed that it could not reach
    a majority. After a few seconds, your set would consist of two secondaries
    and three unreachable members.</p><figure style="float: 0"><div id="repl141" class="figure"><img src="Images/mdb3_1001.png" width="530" height="362"/><h6><span class="label">Figure 10-1. </span>With a minority of the set available, all members will be
      secondaries</h6></div></figure><p>Many<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="minority of the set" id="idm45882354657064"/> users find this frustrating: why can’t the two remaining
    members elect a primary? The problem is that it’s possible that the other
    three members didn’t actually go down, and that it was instead the network
    that went down, as shown in <a data-type="xref" href="#repl142">Figure 10-2</a>. In this case, the
    three members on the left will elect a primary, since they can reach a
    majority of the set (three members out of five). In the case of a network
    partition, we do not want both sides of the partition to elect a primary,
    because then the set would have two primaries. Both primaries would be
    writing to the database, and the datasets would diverge. Requiring a
    majority to elect or stay a primary is a neat way of avoiding ending up
    with more than one primary.</p><figure style="float: 0"><div id="repl142" class="figure"><img src="Images/mdb3_1002.png" width="619" height="387"/><h6><span class="label">Figure 10-2. </span>For the members, a network partition looks identical to servers
      on the other side of the partition going down</h6></div></figure><p>It is important to configure your set in such a way that you’ll
    usually be able to have one primary. For example, in the five-member set
    described here, if members 1, 2, and 3 are in one data center and members
    4 and 5 are in another, there should almost always be a majority available
    in the first data center (it’s more likely to have a network break between
    data centers than within them).</p><p>There<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="common configurations" id="idm45882354505352"/> are a couple of common configurations that are
    recommended:</p><ul><li><p>A majority of the set in one data center, as in <a data-type="xref" href="#repl142">Figure 10-2</a>. This is a good design if you have a primary data
        center where you always want your replica set’s primary to be located.
        So long as your primary data center is healthy, you will have a
        <span class="keep-together">primary</span>. However, if that data center becomes unavailable, your
        secondary data center will not be able to elect a new primary.</p></li><li><p>An equal number of servers in each data center, plus a
        tie-breaking server in a third location. This is a good design if your
        data centers are “equal” in preference, since generally servers from
        either data center will be able to see a majority of the set. However,
        it involves having three separate locations for servers.</p></li></ul><p>More complex requirements might require different configurations,
    but you should keep in mind how your set will acquire a majority under
    adverse conditions.</p><p>All<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="number of primaries" id="idm45882354500440"/> of these complexities would disappear if MongoDB supported
    having more than one primary. However, this would bring its own host of
    complexities. With two primaries, you would have to handle conflicting
    writes (e.g., if someone updates a document on one primary and someone
    deletes it on another primary). There are two popular ways of handling
    conflicts in systems that support multiple writers: manual reconciliation
    or having the system arbitrarily pick a “winner.” Neither of these options
    is a very easy model for developers to code against, seeing as you can’t
    be sure that the data you’ve written won’t change out from under you.
    Thus, MongoDB chose to only support having a single primary. This makes
    development easier but can result in periods when the replica<a data-type="indexterm" data-startref="RSSUdesign10" id="idm45882354498456"/> set is
    read-only.</p><section data-type="sect2" data-pdf-bookmark="How Elections Work"><div class="sect2" id="idm45882354497496"><h2>How Elections Work</h2><p>When<a data-type="indexterm" data-primary="elections" data-secondary="how they work" id="idm45882354496488"/><a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="how elections work" id="idm45882354495352"/> a secondary cannot reach a primary, it will contact all
      the other members and request that it be elected primary. These other
      members do several sanity checks<a data-type="indexterm" data-primary="sanity checks" id="idm45882354493912"/>: Can they reach a primary that the member seeking
      election cannot? Is the member seeking election up to date with
      replication? Is there any member with a higher priority available that
      should be elected instead?</p><p>In version 3.2, MongoDB introduced version 1 of the<a data-type="indexterm" data-primary="replication" data-secondary="replication protocol" id="idm45882354492392"/> replication protocol. Protocol version 1 is based on the
      RAFT consensus protocol<a data-type="indexterm" data-primary="RAFT consensus protocol" id="idm45882354491160"/> developed by Diego Ongaro and John Ousterhout at Stanford
      University. It is best described as RAFT-like and is tailored to include
      a number of replication concepts that are specific to MongoDB, such as
      arbiters, priority, nonvoting members, write concern, etc. Protocol
      version 1 provided the foundation for new features such as a shorter
      failover time and greatly reduces the time to detect false primary
      situations. It also prevents double voting through the use of term
      IDs.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>RAFT is a consensus algorithm that is broken into relatively
        independent subproblems. Consensus is the process through which
        multiple servers or processes agree on values. RAFT ensures consensus
        such that the same series of commands produces the same series of
        results and arrives at the same series of states across the members of
        a deployment.</p></div><p>Replica set members send heartbeats (pings) to each other every
      two seconds. If a heartbeat does not return from a member within 10
      seconds, the other members mark the delinquent member as inaccessible.
      The election algorithm will make a “best-effort” attempt to have the
      secondary with the highest priority available call an election. Member
      priority affects both the timing and the outcome of elections;
      secondaries with higher priority call elections relatively sooner than
      secondaries with lower priority, and are also more likely to win.
      However, a lower-priority instance can be elected as primary for brief
      periods, even if a higher-priority secondary is available. Replica set
      members continue to call elections until the highest-priority member
      available becomes primary.</p><p>To be elected primary, a member must be up to date with
      replication, as far as the members it can reach know. All replicated
      operations are strictly ordered by an ascending identifier, so the
      candidate must have operations later than or equal to those of any
      member it can reach.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="Member Configuration Options"><div class="sect1" id="idm45882354630344"><h1>Member Configuration Options</h1><p>The<a data-type="indexterm" data-primary="members" data-secondary="configuration options" id="Mconfig10"/><a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="member configuration options" data-tertiary="specifying" id="idm45882354484744"/> replica sets we have set up so far have been fairly uniform
    in that every member has the same configuration as every other member.
    However, there are many situations when you don’t want members to be
    identical: you might want one member to preferentially be primary or make
    a member invisible to clients so that no read requests can be routed to
    it. These and many other configuration options can be specified in the
    member subdocuments of the replica set configuration. This section
    outlines the member options that you can set.</p><section data-type="sect2" data-pdf-bookmark="Priority"><div class="sect2" id="sect2-priority"><h2>Priority</h2><p>Priority<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="member configuration options" data-tertiary="priority" id="idm45882354481160"/> is an indication of how strongly this member “wants” to
      become primary. Its value can range from <code>0</code> to <code>100</code>,
      and the default is <code>1</code>. Setting
      <code>"priority"</code> to <code>0</code> has a special meaning: members with a
      priority of <code>0</code> can never become
      primary. These are called <em>passive</em> members<a data-type="indexterm" data-primary="passive members" id="idm45882354476392"/>.</p><p>The highest-priority member will always be elected primary (so
      long as it can reach a majority of the set and has the most up-to-date
      data). For example, suppose you add a member with a priority of <code>1.5</code> to the set, like so:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">add</code><code class="p">({</code><code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"server-4:27017"</code><code class="p">,</code> <code class="s2">"priority"</code> <code class="o">:</code> <code class="mf">1.5</code><code class="p">})</code></pre><p>Assuming the other members of the set have priority <code>1</code>, once <em class="filename">server-4</em> caught up with the rest of the set,
      the current primary would automatically step down and <em class="filename">server-4</em> would elect itself. If <em class="filename">server-4</em> was, for some reason, unable to
      catch up, the current primary would stay primary. Setting priorities
      will never cause your set to go primary-less. It will also never cause a
      member that is behind to become primary (until it has caught up).</p><p>The absolute value of <code>"priority"</code> only matters in relation to whether
      it is greater or less than the other priorities in the set: members with
      priorities of <code>100</code>, <code>1</code>, and <code>1</code>
      will behave the same way as members of another set with priorities
      <code>2</code>, <code>1</code>, and <code>1</code>.</p></div></section><section data-type="sect2" data-pdf-bookmark="Hidden Members"><div class="sect2" id="idm45882354463896"><h2>Hidden Members</h2><p>Clients<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="member configuration options" data-tertiary="hidden members" id="idm45882354448584"/> do not route requests to hidden members<a data-type="indexterm" data-primary="hidden members" id="idm45882354447048"/>, and hidden members are not preferred as replication
      sources (although they will be used if more desirable sources are not
      available). Thus, many people will hide less powerful or backup
      servers.</p><p>For example, suppose you had a set that looked like this:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">isMaster</code><code class="p">()</code>
<code class="p">{</code>
    <code class="p">...</code>
    <code class="s2">"hosts"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="s2">"server-1:27107"</code><code class="p">,</code>
        <code class="s2">"server-2:27017"</code><code class="p">,</code>
        <code class="s2">"server-3:27017"</code>
    <code class="p">],</code>
    <code class="p">...</code>
<code class="p">}</code></pre><p>To hide <em class="filename">server-3</em>, you could
      add the <code class="option">hidden: true</code> field to its configuration. A
      member must have a priority of <code>0</code> to
      be hidden (you can’t have a hidden primary):</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="kd">var</code> <code class="nx">config</code> <code class="o">=</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">config</code><code class="p">()</code>
<code class="o">&gt;</code> <code class="nx">config</code><code class="p">.</code><code class="nx">members</code><code class="p">[</code><code class="mi">2</code><code class="p">].</code><code class="nx">hidden</code> <code class="o">=</code> <code class="kc">true</code>
<code class="mi">0</code>
<code class="o">&gt;</code> <code class="nx">config</code><code class="p">.</code><code class="nx">members</code><code class="p">[</code><code class="mi">2</code><code class="p">].</code><code class="nx">priority</code> <code class="o">=</code> <code class="mi">0</code>
<code class="mi">0</code>
<code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">reconfig</code><code class="p">(</code><code class="nx">config</code><code class="p">)</code></pre><p>Now running <code class="function">isMaster</code> will
      show:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">isMaster</code><code class="p">()</code>
<code class="p">{</code>
    <code class="p">...</code>
    <code class="s2">"hosts"</code> <code class="o">:</code> <code class="p">[</code>
        <code class="s2">"server-1:27107"</code><code class="p">,</code>
        <code class="s2">"server-2:27017"</code>
    <code class="p">],</code>
    <code class="p">...</code>
<code class="p">}</code></pre><p><code class="function">rs.status()</code> and <code class="function">rs.config()</code> will<a data-type="indexterm" data-primary="rs.config()" id="idm45882354333944"/><a data-type="indexterm" data-primary="rs.status()" id="idm45882354333112"/> still show the member; it only disappears from <code class="function">isMaster</code>. When clients connect to a replica
      set, they call <code class="function">isMaster</code> to
      determine the members of the set. Thus, hidden members will never be
      used for read requests.</p><p>To unhide a member, change the <code class="option">hidden</code> option to
      <code>false</code> or remove the option
      entirely.</p></div></section><section data-type="sect2" data-pdf-bookmark="Election Arbiters"><div class="sect2" id="electionArbiters"><h2>Election Arbiters</h2><p>A<a data-type="indexterm" data-primary="arbiters" id="idm45882354271512"/><a data-type="indexterm" data-primary="elections" data-secondary="election arbiters" id="idm45882354270648"/><a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="member configuration options" data-tertiary="election arbiters" id="idm45882354269544"/> two-member set has clear disadvantages for majority
      requirements. However, many people with small deployments do not want to
      keep three copies of their data, feeling that two is enough and that
      keeping a third copy is not worth the administrative, operational, and
      financial costs.</p><p>For these deployments, MongoDB supports a special type of member
      called an <em>arbiter</em>, whose only purpose is to
      participate in elections. Arbiters hold no data and aren’t used by
      clients: they just provide a majority for two-member sets. In general,
      deployments without arbiters are preferable.</p><p>As arbiters don’t have any of the traditional responsibilities of
      a <em class="filename">mongod</em> server, you can run an
      arbiter as a lightweight process on a wimpier server than you’d
      generally use for MongoDB. It’s often a good idea, if possible, to run
      an arbiter in a separate failure domain from the other members, so that
      it has an “outside perspective” on the set, as described in the
      deployment recommendations in <a data-type="xref" href="#repl-setup-section4">“How to Design a Set”</a>.</p><p>You start up an arbiter in the same way that you start a normal
      <em class="filename">mongod</em>, using the <span class="keep-together"><code class="option">--replSet
      <em><code>name</code></em></code> option</span> and an empty
      data directory. You can add it to the set using the <code class="function">rs.addArb()</code> helper:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">addArb</code><code class="p">(</code><code class="s2">"server-5:27017"</code><code class="p">)</code></pre><p>Equivalently, you can specify the <code class="option">"arbiterOnly"</code>
      option in the member <span class="keep-together">configuration</span>:</p><pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="nx">rs</code><code class="p">.</code><code class="nx">add</code><code class="p">({</code><code class="s2">"_id"</code> <code class="o">:</code> <code class="mi">4</code><code class="p">,</code> <code class="s2">"host"</code> <code class="o">:</code> <code class="s2">"server-5:27017"</code><code class="p">,</code> <code class="s2">"arbiterOnly"</code> <code class="o">:</code> <code class="kc">true</code><code class="p">})</code></pre><p>An arbiter, once added to the set, is an arbiter forever: you
      cannot reconfigure an arbiter to become a nonarbiter, or vice
      versa.</p><p>One other thing that arbiters are good for is breaking ties in
      larger clusters. If you have an even number of nodes, you may have half
      the nodes vote for one member and half for another. An arbiter can cast
      the deciding vote. There are a few things to keep in mind when using
      arbiters, though; we’ll look at these next.</p><section data-type="sect3" data-pdf-bookmark="Use at most one arbiter"><div class="sect3" id="idm45882354233896"><h3>Use at most one arbiter</h3><p>Note that, in both of the use cases just described, you need
        <em>at most</em> one arbiter. You do not need an arbiter
        if you have an odd number of nodes. A common misconception seems to be
        that you should add extra arbiters “just in case.” However, it doesn’t
        help elections go any faster or provide any additional data safety to
        add extra arbiters.</p><p>Suppose you have a three-member set. Two members are required to
        elect a primary. If you add an arbiter, you’ll have a four-member set,
        so three members will be required to choose a primary. Thus, your set
        is potentially less stable: instead of requiring 67% of your set to be
        up, you’re now requiring 75%.</p><p>Having extra members can also make elections take longer. If you
        have an even number of nodes because you added an arbiter, your
        arbiters can cause ties, not prevent them.</p></div></section><section data-type="sect3" data-pdf-bookmark="The downside to using an arbiter"><div class="sect3" id="idm45882354231240"><h3>The downside to using an arbiter</h3><p>If you have a choice between a data node and an arbiter, choose
        a data node. Using an arbiter instead of a data node in a small set
        can make some operational tasks more difficult. For example, suppose
        you are running a replica set with two “normal” members and one
        arbiter, and one of the data-holding members goes down. If that member
        is well and truly dead (the data is unrecoverable), you will have to
        get a copy of the data from the current primary to the new server
        you’ll be using as a secondary. Copying data can put a lot of stress
        on a server, and thus slow down your application. (Generally, copying
        a few gigabytes to a new server is trivial but more than a hundred
        starts becoming impractical.)</p><p>Conversely, if you have three data-holding members, there’s more
        “breathing room” if a server completely dies. You can use the
        remaining secondary to bootstrap a new server instead of depending on
        your primary.</p><p>In the two-member-plus-arbiter scenario<a data-type="indexterm" data-primary="two-member-plus-arbiter scenario" id="idm45882354206200"/>, the primary is the last remaining good copy of your
        data <em>and</em> the one trying to handle load from your
        application while you’re trying to get another copy of your data
        online.</p><p>Thus, if possible, use an odd number of “normal” members instead
        of an arbiter.</p><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>In three-member replica sets with a primary-secondary-arbiter
          (PSA) architecture<a data-type="indexterm" data-primary="primary-secondary-arbiter (PSA) architecture" id="idm45882354203576"/> or sharded clusters with a three-member PSA shard,
          there is a known issue with cache pressure increasing if either of
          the two data-bearing nodes are down and the <code>"majority"</code> read concern is enabled.
          Ideally, you should replace the arbiter with a data-bearing member
          for these deployments. Alternatively, to prevent storage cache
          pressure the <a href="https://oreil.ly/p6nUm"><code>"majority"</code> read
          concern can be disabled</a> on each of the <em>mongod</em>
          instances in the deployment or shards.</p></div></div></section></div></section><section data-type="sect2" data-pdf-bookmark="Building Indexes"><div class="sect2" id="idm45882354272664"><h2>Building Indexes</h2><p>Sometimes<a data-type="indexterm" data-primary="replica sets, setting up" data-secondary="member configuration options" data-tertiary="building indexes" id="idm45882354199560"/> a secondary does not need to have the same (or any)
      indexes that exist on the primary. If you are using a secondary only for
      backup data or offline batch jobs, you might want to specify
      <code class="option">"buildIndexes" : false</code> in the member’s configuration.
      This option prevents the secondary from building any indexes.</p><p>This is a permanent setting: members that have
      <code class="option">"buildIndexes" : false</code> specified can never be
      reconfigured to be “normal” index-building members again. If you want to
      change a non-index-building member to an index-building one, you must
      remove it from the set, delete all of its data, add it to the set again,
      and allow it to resync from scratch.</p><p>As with hidden members, this option requires the
      member’s<a data-type="indexterm" data-startref="Mconfig10" id="idm45882354195480"/>
      priority to be <code>0</code>.</p></div></section></div></section><div data-type="footnotes"><p data-type="footnote" id="idm45882356792632"><sup><a href="ch10.xhtml#idm45882356792632-marker">1</a></sup> See <a href="https://github.com/mongodb-the-definitive-guide-3e/mongodb-the-definitive-guide-3e"><em class="hyperlink">https://github.com/mongodb-the-definitive-guide-3e/mongodb-the-definitive-guide-3e</em></a>.</p></div></div></section></div>



  </body></html>