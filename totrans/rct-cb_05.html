<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 5. Connecting to Services" class="calibre4"><div class="preface" id="chapter05">
<h1 class="calibre9"><span class="label">Chapter 5. </span>Connecting to Services</h1>


<p class="author1">React, unlike frameworks such as Angular, does not include everything you might need for an application. <a data-type="indexterm" data-primary="network services, connecting to" id="ix_ntserv" class="calibre6"/>In particular, it does not
provide a standard way to get data from network services into your application. That freedom is excellent because it means that
React applications can use the latest technology. The downside is that developers just starting with React are left to struggle on
their own.</p>

<p class="author1">In this chapter, we will look at a few ways to attach network services to your application. We will see some common themes through
each of these recipes, and we’ll try to keep the network code separate from the components that use it. That way, when a new web
service technology comes along, we can switch to it without changing a lot of code.<a data-type="indexterm" data-primary="connecting to services" data-see="network services, connecting to" id="idm46634414421560" class="calibre6"/></p>






<section data-type="sect1" data-pdf-bookmark="Convert Network Calls to Hooks" class="calibre4"><div class="preface" id="ch05-01">
<h1 class="calibre17">Convert Network Calls to Hooks</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634414419016">
<h2 class="calibre27">Problem</h2>

<p class="author1">One of the advantages of component-based development <a data-type="indexterm" data-primary="hooks" data-secondary="converting network calls to" id="ix_hooknt" class="calibre6"/><a data-type="indexterm" data-primary="network services, connecting to" data-secondary="converting network calls to hooks" id="ix_ntservhk" class="calibre6"/>is that it breaks the code down into small manageable chunks, each of which
performs a distinct, identifiable action. In some ways, the best kind of component is one that you can see on a large screen without
scrolling. One of the great features of React is that it has, in many ways, gotten simpler over time. React hooks and the move away
from class-based components have removed boilerplate and reduced the amount of code.</p>

<p class="author1">However, one way to inflate the size of a component is by filling it with networking code. If you aim to create simple code, you
should try to strip out networking code from your components. The components will become smaller, and the network code will be more
reusable.</p>

<p class="author1">But how should we split out the networking code?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634414413144">
<h2 class="calibre27">Solution</h2>

<p class="author1">In this recipe, we will look at a way of moving your network requests into React hooks to track whether a network request is still
underway or if there has been some error that prevented it from succeeding.</p>

<p class="author1">Before we look at the details, we need to think about what is important to us when making an asynchronous network request.<a data-type="indexterm" data-primary="asynchronous code" data-secondary="making asynchronous network requests" id="idm46634414410568" class="calibre6"/> There are
three things that we need to track:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">The data returned by the request</p>
</li>
<li class="calibre8">
<p class="author1">Whether the request is still loading the data from the server</p>
</li>
<li class="calibre8">
<p class="author1">Any errors that might have occurred when running the request</p>
</li>
</ul>

<p class="author1">You will see these three things appearing in each of the recipes in this chapter. It doesn’t matter whether we are making the
requests with <code class="calibre21">fetch</code> or <code class="calibre21">axios</code> commands, via Redux middleware, or through an API query layer like <em class="calibre7">GraphQL</em>; our component will
always care about data, loading state, and errors.<a data-type="indexterm" data-primary="errors" id="idm46634414404696" class="calibre6"/></p>

<p class="author1">As an example, let’s build a simple message board that contains several forums. The messages on each forum contain an <code class="calibre21">author</code> field and a
<code class="calibre21">text</code> field. <a data-type="xref" href="#ch05_image_1" class="calibre6">Figure 5-1</a> shows a screenshot of the example application, which you can download from the GitHub site.</p>

<figure class="calibre29"><div id="ch05_image_1" class="figure">
<img src="Images/recb_0501.png" alt="" class="calibre91"/>
<h6 class="calibre30"><span class="firstname">Figure 5-1. </span>The buttons select the <em class="calibre7">NASA</em> or <em class="calibre7">Not NASA</em> forums</h6>
</div></figure>

<p class="author1">The buttons at the top of the page select the “NASA” or “Not NASA” forums. A small <a data-type="indexterm" data-primary="Node" data-secondary="backend server for example Rect application" id="idm46634414398136" class="calibre6"/>Node server provides the backend for our example
application, which has pre-populated some messages into the NASA forum. Once you have downloaded the source code, you can run the
backend server by running the <em class="calibre7">server.js</em> script in the application’s main directory:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ node ./server.js</code></pre>

<p class="author1">The backend server runs at <em class="calibre7">http://localhost:5000</em>. We can start the React application itself in the usual way:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm run start</code></pre>

<p class="author1">The React application will run on port 3000.</p>
<div data-type="tip" class="calibre25">
<p class="author1">When in development mode, we proxy all backend requests through the React server.<a data-type="indexterm" data-primary="JSON" data-secondary="proxy property in package.json file" id="idm46634414393480" class="calibre6"/> If you’re using <code class="calibre21">create-react-app</code>, you can
do this by adding a <code class="calibre21">proxy</code> property to <em class="calibre7">package.json</em> and setting it to <em class="calibre7">http://localhost:5000</em>. The React server will pass
API calls to our <em class="calibre7">server.js</em> backend. For example, <em class="calibre7">http://localhost:3000/messages/nasa</em> (which returns an array of messages for the
NASA forum) will be proxied to <em class="calibre7">http://localhost:5000/messages/nasa</em>.</p>
</div>

<p class="author1">We’ll make the<a data-type="indexterm" data-primary="fetch command" id="idm46634414387432" class="calibre6"/> network request to read the messages using a simple <code class="calibre21">fetch</code> command:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="go">(</code><code class="err">`</code><code class="o">/</code><code class="nx">messages</code><code class="o">/</code><code class="nx">$</code><code class="go">{</code><code class="nx">forum</code><code class="go">}</code><code class="err">`</code><code class="go">)</code>
<code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="nx">response</code><code class="go">.</code><code class="nx">ok</code><code class="go">)</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="nx">text</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">response</code><code class="go">.</code><code class="nx">text</code><code class="go">()</code>
  <code class="kr">throw</code> <code class="kr">new</code> <code class="nb">Error</code><code class="go">(</code><code class="err">`</code><code class="nx">Unable</code> <code class="nx">to</code> <code class="nx">read</code> <code class="nx">messages</code> <code class="kr">for</code> <code class="nx">$</code><code class="go">{</code><code class="nx">forum</code><code class="go">}</code><code class="o">:</code> <code class="nx">$</code><code class="go">{</code><code class="nx">text</code><code class="go">}</code><code class="err">`</code><code class="go">)</code>
<code class="go">}</code>
<code class="kr">const</code> <code class="nx">body</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">response</code><code class="go">.</code><code class="nx">json</code><code class="go">()</code></pre>

<p class="author1">Here, the <code class="calibre21">forum</code> value will contain the string ID of the forum. The <code class="calibre21">fetch</code> command is asynchronous and returns a promise, so we
will <code class="calibre21">await</code> it.<a data-type="indexterm" data-primary="promises" id="idm46634414281816" class="calibre6"/><a data-type="indexterm" data-primary="await function" id="idm46634414281080" class="calibre6"/> Then we can check whether the call failed with any bad HTTP status, and if so, we will throw an error. <a data-type="indexterm" data-primary="JSON" id="idm46634414280152" class="calibre6"/>We will
extract the JSON object out of the response and store it in the <code class="calibre21">body</code> variable. If the response body is not a correctly formatted
JSON object, we will also throw an error.</p>

<p class="author1">We need to keep track of three things in this call: the data, the loading state, and any errors. <a data-type="indexterm" data-primary="state" data-secondary="data, loading, and error" id="idm46634414278456" class="calibre6"/>We’re going to bundle this whole
thing up inside a custom hook, so let’s have three states called <code class="calibre21">data</code>, <code class="calibre21">loading</code>, and <code class="calibre21">error</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">useMessages</code> <code class="o">=</code> <code class="go">(</code><code class="nx">forum</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">data</code><code class="go">,</code> <code class="nx">setData</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">([])</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loading</code><code class="go">,</code> <code class="nx">setLoading</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">error</code><code class="go">,</code> <code class="nx">setError</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
  <code class="go">....</code>
  <code class="kr">return</code> <code class="go">{</code> <code class="nx">data</code><code class="go">,</code> <code class="nx">loading</code><code class="go">,</code> <code class="nx">error</code> <code class="go">}</code>
<code class="go">}</code></pre>

<p class="author1">We’ll pass in the forum name as a parameter to the <code class="calibre21">useMessages</code> hook, which will return an object containing the <code class="calibre21">data</code>, <code class="calibre21">loading</code>,
and <code class="calibre21">error</code> states.<a data-type="indexterm" data-primary="loading state" id="idm46634414104808" class="calibre6"/><a data-type="indexterm" data-primary="data state" id="idm46634414104296" class="calibre6"/><a data-type="indexterm" data-primary="errors" data-secondary="error state" id="idm46634414103624" class="calibre6"/><a data-type="indexterm" data-primary="useMessages hook" id="idm46634414102680" class="calibre6"/> We can use object destructuring to extract and rename the values in any component that uses the hook, like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="go">{</code>
  <code class="nx">data</code><code class="o">:</code> <code class="nx">messages</code><code class="go">,</code>
  <code class="nx">loading</code><code class="o">:</code> <code class="nx">messagesLoading</code><code class="go">,</code>
  <code class="nx">error</code><code class="o">:</code> <code class="nx">messagesError</code><code class="go">,</code>
<code class="go">}</code> <code class="o">=</code> <code class="nx">useMessages</code><code class="go">(</code><code class="s">'nasa'</code><code class="go">)</code></pre>
<div data-type="tip" class="calibre25">
<p class="author1">Renaming the variables in a spread operator helps avoid naming conflicts. For example, if you want to read messages from more
than one forum, you could make a second call to the <code class="calibre21">useMessages</code> hook and choose a variable other than <code class="calibre21">messages</code> for the second
hook response.</p>
</div>

<p class="author1">Let’s get back to the <code class="calibre21">useMessages</code> hook. The network request depends upon the <code class="calibre21">forum</code> value that we pass in, so we need<a data-type="indexterm" data-primary="useEffect hook" data-secondary="fetch request inside of" id="idm46634414181768" class="calibre6"/> to make
sure that we run the <code class="calibre21">fetch</code> request inside a <code class="calibre21">useEffect</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">setError</code><code class="go">(</code><code class="kr">null</code><code class="go">)</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">forum</code><code class="go">)</code> <code class="go">{</code>
    <code class="go">....</code>
  <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
    <code class="nx">setData</code><code class="go">([])</code>
    <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="go">}</code>
<code class="go">},</code> <code class="go">[</code><code class="nx">forum</code><code class="go">])</code></pre>

<p class="author1">We’re omitting for the moment the code that makes the actual request. The code inside the <code class="calibre21">useEffect</code> will run the first time the hook
is called. If the client component is re-rendered and passes in the same value for <code class="calibre21">forum</code>, the <code class="calibre21">useEffect</code> will not run because the
<code class="calibre21">[forum]</code> dependency will not have changed. It will run again only if the <code class="calibre21">forum</code> value changes.<a data-type="indexterm" data-primary="fetch request, dropping into useMessages hook" id="idm46634414017608" class="calibre6"/></p>

<p class="author1">Now let’s look at how we can drop in the <code class="calibre21">fetch</code> request to this hook:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>

<code class="kr">const</code> <code class="nx">useMessages</code> <code class="o">=</code> <code class="go">(</code><code class="nx">forum</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">data</code><code class="go">,</code> <code class="nx">setData</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">([])</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loading</code><code class="go">,</code> <code class="nx">setLoading</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">error</code><code class="go">,</code> <code class="nx">setError</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">let</code> <code class="nx">didCancel</code> <code class="o">=</code> <code class="kr">false</code>
    <code class="nx">setError</code><code class="go">(</code><code class="kr">null</code><code class="go">)</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">forum</code><code class="go">)</code> <code class="go">{</code>
      <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
        <code class="kr">try</code> <code class="go">{</code>
          <code class="nx">setLoading</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
          <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="go">(</code><code class="err">`</code><code class="o">/</code><code class="nx">messages</code><code class="o">/</code><code class="nx">$</code><code class="go">{</code><code class="nx">forum</code><code class="go">}</code><code class="err">`</code><code class="go">)</code>
          <code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="nx">response</code><code class="go">.</code><code class="nx">ok</code><code class="go">)</code> <code class="go">{</code>
            <code class="kr">const</code> <code class="nx">text</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">response</code><code class="go">.</code><code class="nx">text</code><code class="go">()</code>
            <code class="kr">throw</code> <code class="kr">new</code> <code class="nb">Error</code><code class="go">(</code>
              <code class="err">`</code><code class="nx">Unable</code> <code class="nx">to</code> <code class="nx">read</code> <code class="nx">messages</code> <code class="kr">for</code> <code class="nx">$</code><code class="go">{</code><code class="nx">forum</code><code class="go">}</code><code class="o">:</code> <code class="nx">$</code><code class="go">{</code><code class="nx">text</code><code class="go">}</code><code class="err">`</code>
            <code class="go">)</code>
          <code class="go">}</code>
          <code class="kr">const</code> <code class="nx">body</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">response</code><code class="go">.</code><code class="nx">json</code><code class="go">()</code>
          <code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="nx">didCancel</code><code class="go">)</code> <code class="go">{</code>
            <code class="nx">setData</code><code class="go">(</code><code class="nx">body</code><code class="go">)</code>
          <code class="go">}</code>
        <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">setError</code><code class="go">(</code><code class="nx">err</code><code class="go">)</code>
        <code class="go">}</code> <code class="kr">finally</code> <code class="go">{</code>
          <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
        <code class="go">}</code>
      <code class="go">})()</code>
    <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
      <code class="nx">setData</code><code class="go">([])</code>
      <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
    <code class="go">}</code>
    <code class="kr">return</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">didCancel</code> <code class="o">=</code> <code class="kr">true</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">forum</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">{</code> <code class="nx">data</code><code class="go">,</code> <code class="nx">loading</code><code class="go">,</code> <code class="nx">error</code> <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">useMessages</code></pre>

<p class="author1">Because we’re using <code class="calibre21">await</code> to handle the promises correctly, we need to wrap the code in a rather ugly <code class="calibre21">(async () =&gt; {...})</code>
call.<a data-type="indexterm" data-primary="promises" data-secondary="handling correctly with await" id="idm46634414008104" class="calibre6"/><a data-type="indexterm" data-primary="await function" id="idm46634414007128" class="calibre6"/><a data-type="indexterm" data-primary="asynchronous code" data-secondary="using await to handle promises" id="idm46634413731688" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="data, loading, and error" data-tertiary="in custom hook" id="idm46634413730776" class="calibre6"/> Inside there, we’re able to set values for <code class="calibre21">data</code>, <code class="calibre21">loading</code>, and <code class="calibre21">error</code> as the request runs, finishes, and (possibly) fails.
All of this will happen asynchronously after the call to the hook has been completed. When the <code class="calibre21">data</code>, <code class="calibre21">loading</code>, and <code class="calibre21">error</code> states
change, the hook will cause the component to be re-rendered with the new values.</p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">A consequence of having asynchronous code inside a hook is that the hook will return before the network response has been
received.<a data-type="indexterm" data-primary="asynchronous code" data-secondary="used inside a hook, network response coming after" id="idm46634413725784" class="calibre6"/> This means there’s a chance that the hook might be called again, before the previous network response has been received.
To avoid the network responses being resolved in the wrong order, the example code tracks if the current request was overridden by a
later request using the <code class="calibre21">didCancel</code> variable. This variable will control whether the hook returns the data from the hook. It won’t
cancel the network request itself. To do that, see <a data-type="xref" href="#ch05-03" class="calibre6">“Cancel Network Requests with Tokens”</a>.</p>
</div>

<p class="author1">Let’s take a look at <em class="calibre7">App.js</em> in the example application to see what it looks like to use this hook:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="s">'./App.css'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">useMessages</code> <code class="nx">from</code> <code class="s">'./useMessages'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">forum</code><code class="go">,</code> <code class="nx">setForum</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="s">'nasa'</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">{</code>
    <code class="nx">data</code><code class="o">:</code> <code class="nx">messages</code><code class="go">,</code>
    <code class="nx">loading</code><code class="o">:</code> <code class="nx">messagesLoading</code><code class="go">,</code>
    <code class="nx">error</code><code class="o">:</code> <code class="nx">messagesError</code><code class="go">,</code>
  <code class="go">}</code> <code class="o">=</code> <code class="nx">useMessages</code><code class="go">(</code><code class="nx">forum</code><code class="go">)</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">setForum</code><code class="go">(</code><code class="s">'nasa'</code><code class="go">)}&gt;</code><code class="nx">NASA</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">setForum</code><code class="go">(</code><code class="s">'notNasa'</code><code class="go">)}&gt;</code><code class="nx">Not</code> <code class="nx">NASA</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">messagesError</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"error"</code><code class="go">&gt;</code>
          <code class="nx">Something</code> <code class="nx">went</code> <code class="nx">wrong</code><code class="o">:</code>
          <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"error-contents"</code><code class="go">&gt;</code>
            <code class="go">{</code><code class="nx">messagesError</code><code class="go">.</code><code class="nx">message</code><code class="go">}</code>
          <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="nx">messagesLoading</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"loading"</code><code class="go">&gt;</code><code class="nx">Loading</code><code class="go">...&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="nx">messages</code> <code class="o">&amp;&amp;</code> <code class="nx">messages</code><code class="go">.</code><code class="nx">length</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">dl</code><code class="go">&gt;</code>
          <code class="go">{</code><code class="nx">messages</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">m</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code>
            <code class="go">&lt;&gt;</code>
              <code class="go">&lt;</code><code class="nt">dt</code><code class="go">&gt;{</code><code class="nx">m</code><code class="go">.</code><code class="nx">author</code><code class="go">}&lt;/</code><code class="nt">dt</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">dd</code><code class="go">&gt;{</code><code class="nx">m</code><code class="go">.</code><code class="nx">text</code><code class="go">}&lt;/</code><code class="nt">dd</code><code class="go">&gt;</code>
            <code class="go">&lt;/&gt;</code>
          <code class="go">))}</code>
        <code class="go">&lt;/</code><code class="nt">dl</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="go">(</code>
        <code class="s">'No messages'</code>
      <code class="go">)}</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">Our example application changes which forum is loaded when you click either the NASA or Not NASA button. <a data-type="indexterm" data-primary="errors" data-secondary="network request converted to hook" id="idm46634413719320" class="calibre6"/>The example server returns a 404-status for the “Not NASA” forum, which causes an error to appear on-screen. In <a data-type="xref" href="#ch05_image_2" class="calibre6">Figure 5-2</a>, we can see the example application showing the loading state, the messages from the NASA forum, and an error when we try to load data from the missing “Not NASA” forum.</p>

<figure class="calibre29"><div id="ch05_image_2" class="figure">
<img src="Images/recb_0502.png" alt="" class="calibre92"/>
<h6 class="calibre30"><span class="firstname">Figure 5-2. </span>The application showing loading, messages, and errors</h6>
</div></figure>

<p class="author1">The <code class="calibre21">useMessages</code> hook will also cope if the server throws an error, as shown in <a data-type="xref" href="#ch05_image_3" class="calibre6">Figure 5-3</a>.</p>

<figure class="calibre29"><div id="ch05_image_3" class="figure">
<img src="Images/recb_0503.png" alt="" class="calibre93"/>
<h6 class="calibre30"><span class="firstname">Figure 5-3. </span>The component can display errors from the server</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634414412200">
<h2 class="calibre27">Discussion</h2>

<p class="author1">When you’re creating an application, it’s tempting to spend your time building features that assume everything works. But it is
worth investing the time to handle errors and make an effort to show when data is still loading. Your application will be pleasant
to use, and you will have an easier time tracking down slow services and errors.</p>

<p class="author1">You might also consider combining this recipe with <a data-type="xref" href="ch04.xhtml#ch04-01" class="calibre6">“Build a Centralized Error Handler”</a>, which will make it easier for users to
describe what happened.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/T6M6q" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="hooks" data-secondary="converting network calls to" data-startref="ix_hooknt" id="idm46634413470984" class="calibre6"/><a data-type="indexterm" data-primary="network services, connecting to" data-secondary="converting network calls to hooks" data-startref="ix_ntservhk" id="idm46634413469736" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Refresh Automatically with State Counters" class="calibre4"><div class="preface" id="ch05-02">
<h1 class="calibre17">Refresh Automatically with State Counters</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634413466840">
<h2 class="calibre27">Problem</h2>

<p class="author1">Network services often need to interact with each other.<a data-type="indexterm" data-primary="refreshes, automatic, using state counter" id="ix_refrauto" class="calibre6"/><a data-type="indexterm" data-primary="network services, connecting to" data-secondary="refreshing automatically with state counters" id="ix_ntservref" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="refreshing automatically with state counters" id="ix_staref" class="calibre6"/> Take, for example, the forum application we used in the previous recipe. If we add a form to post a new message, we want the message list to update automatically every time a person posts 
<span class="firstname">something</span>.</p>

<p class="author1">In the previous version of this application, we created a custom hook called 
<span class="firstname"><code class="calibre21">useMessages</code></span>, which contained all of the code needed
to read a forum’s messages.<a data-type="indexterm" data-primary="forms" data-secondary="adding form to post messages to forum" id="idm46634413459512" class="calibre6"/><a data-type="indexterm" data-primary="useMessages hook" data-secondary="adding form to post messages to forum server" id="idm46634413458552" class="calibre6"/></p>

<p class="author1">We’ll add a form to the application to post new messages to the server:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="go">{</code>
  <code class="nx">data</code><code class="o">:</code> <code class="nx">messages</code><code class="go">,</code>
  <code class="nx">loading</code><code class="o">:</code> <code class="nx">messagesLoading</code><code class="go">,</code>
  <code class="nx">error</code><code class="o">:</code> <code class="nx">messagesError</code><code class="go">,</code>
<code class="go">}</code> <code class="o">=</code> <code class="nx">useMessages</code><code class="go">(</code><code class="s">'nasa'</code><code class="go">)</code>
<code class="kr">const</code> <code class="go">[</code><code class="nx">text</code><code class="go">,</code> <code class="nx">setText</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
<code class="kr">const</code> <code class="go">[</code><code class="nx">author</code><code class="go">,</code> <code class="nx">setAuthor</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
<code class="kr">const</code> <code class="go">[</code><code class="nx">createMessageError</code><code class="go">,</code> <code class="nx">setCreateMessageError</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
<code class="c">// Other code here...</code>
<code class="go">&lt;</code><code class="nt">input</code>
  <code class="na">type</code><code class="o">=</code><code class="s">"text"</code>
  <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">author</code><code class="go">}</code>
  <code class="na">placeholder</code><code class="o">=</code><code class="s">"Author"</code>
  <code class="na">onChange</code><code class="o">=</code><code class="go">{(</code><code class="nx">evt</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">setAuthor</code><code class="go">(</code><code class="nx">evt</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">)}</code>
<code class="go">/&gt;</code>
<code class="go">&lt;</code><code class="nt">textarea</code>
  <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">text</code><code class="go">}</code>
  <code class="na">placeholder</code><code class="o">=</code><code class="s">"Message"</code>
  <code class="na">onChange</code><code class="o">=</code><code class="go">{(</code><code class="nx">evt</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">setText</code><code class="go">(</code><code class="nx">evt</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">)}</code>
<code class="go">/&gt;</code>
<code class="go">&lt;</code><code class="nt">button</code>
  <code class="na">onClick</code><code class="o">=</code><code class="go">{</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">try</code> <code class="go">{</code>
      <code class="nx">await</code> <code class="go">[</code><code class="nx">code</code> <code class="nx">to</code> <code class="nx">post</code> <code class="nx">message</code> <code class="nx">here</code><code class="go">]</code>
      <code class="nx">setText</code><code class="go">(</code><code class="s">''</code><code class="go">)</code>
      <code class="nx">setAuthor</code><code class="go">(</code><code class="s">''</code><code class="go">)</code>
    <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">setCreateMessageError</code><code class="go">(</code><code class="nx">err</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">}}</code>
<code class="go">&gt;</code>
  <code class="nx">Post</code>
<code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code></pre>

<p class="author1">Here’s the problem: when you post a new message, it doesn’t appear on the list unless you refresh the page manually (see <a data-type="xref" href="#ch05_image_4" class="calibre6">Figure 5-4</a>).</p>

<figure class="calibre29"><div id="ch05_image_4" class="figure">
<img src="Images/recb_0504.png" alt="" class="calibre94"/>
<h6 class="calibre30"><span class="firstname">Figure 5-4. </span>Posting a message does not refresh the message list</h6>
</div></figure>

<p class="author1">How do we automatically reload the messages from the server each time we post a new one?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634413213224">
<h2 class="calibre27">Solution</h2>

<p class="author1">We’re going to trigger data refreshes by using a thing called a <em class="calibre7">state counter</em>. A state counter is just an increasing number. It
doesn’t matter what the counter’s current value is; it just matters that we change it every time we want to reload the data:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="go">[</code><code class="nx">stateVersion</code><code class="go">,</code> <code class="nx">setStateVersion</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="mi">0</code><code class="go">)</code></pre>

<p class="author1">You can think of a state counter as representing our perceived version of the data on the server. When we do something that we
suspect will change the server state, we update the state counter to reflect the change:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="c">// code to post a new message here</code>
<code class="nx">setStateVersion</code><code class="go">((</code><code class="nx">v</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">v</code> <code class="o">+</code> <code class="mi">1</code><code class="go">)</code></pre>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">Notice that we’re increasing the <code class="calibre21">stateVersion</code> value using a function, rather than saying
<code class="calibre21">setStateVersion(stateVersion + 1)</code>. You should always use a function to update a state value if the new value depends upon the old
value. That’s because React sets states asynchronously. If we ran <code class="calibre21">setStateVersion(stateVersion + 1)</code> twice in rapid succession, the
value of <code class="calibre21">stateVersion</code> might not change in between the two calls, and we would miss an increment.</p>
</div>

<p class="author1">The code that reads the current set of messages is wrapped inside a <code class="calibre21">useEffect</code>, which we can force to rerun by making it dependent
upon the <code class="calibre21">stateVersion</code> value:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">setError</code><code class="go">(</code><code class="kr">null</code><code class="go">)</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">forum</code><code class="go">)</code> <code class="go">{</code>
    <code class="c">// Code to read /messages/:forum</code>
  <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
    <code class="nx">setData</code><code class="go">([])</code>
    <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="go">}</code>
<code class="go">},</code> <code class="go">[</code><code class="nx">forum</code><code class="go">,</code> <code class="nx">stateVersion</code><code class="go">])</code></pre>

<p class="author1">If the value of the <code class="calibre21">forum</code> variable changes or if the <code class="calibre21">stateVersion</code> changes, it will automatically reload the messages (see
<a data-type="xref" href="#ch05_image_5" class="calibre6">Figure 5-5</a>).</p>

<figure class="calibre29"><div id="ch05_image_5" class="figure">
<img src="Images/recb_0505.png" alt="" class="calibre95"/>
<h6 class="calibre30"><span class="firstname">Figure 5-5. </span>Posting a new message causes the message list to reload</h6>
</div></figure>

<p class="author1">So that’s our approach. Now we need to look at where we’re going to put the code. Here is the previous version of the component,
which is only reading messages:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="s">'./App.css'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">useMessages</code> <code class="nx">from</code> <code class="s">'./useMessages'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">forum</code><code class="go">,</code> <code class="nx">setForum</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="s">'nasa'</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">{</code>
    <code class="nx">data</code><code class="o">:</code> <code class="nx">messages</code><code class="go">,</code>
    <code class="nx">loading</code><code class="o">:</code> <code class="nx">messagesLoading</code><code class="go">,</code>
    <code class="nx">error</code><code class="o">:</code> <code class="nx">messagesError</code><code class="go">,</code>
  <code class="go">}</code> <code class="o">=</code> <code class="nx">useMessages</code><code class="go">(</code><code class="nx">forum</code><code class="go">)</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">setForum</code><code class="go">(</code><code class="s">'nasa'</code><code class="go">)}&gt;</code><code class="nx">NASA</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code> <code class="na">onClick</code><code class="o">=</code><code class="go">{()</code> <code class="o">=&gt;</code> <code class="nx">setForum</code><code class="go">(</code><code class="s">'notNasa'</code><code class="go">)}&gt;</code><code class="nx">Not</code> <code class="nx">NASA</code><code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">messagesError</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"error"</code><code class="go">&gt;</code>
          <code class="nx">Something</code> <code class="nx">went</code> <code class="nx">wrong</code><code class="o">:</code>
          <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"error-contents"</code><code class="go">&gt;</code>
            <code class="go">{</code><code class="nx">messagesError</code><code class="go">.</code><code class="nx">message</code><code class="go">}</code>
          <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="nx">messagesLoading</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"loading"</code><code class="go">&gt;</code><code class="nx">Loading</code><code class="go">...&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="nx">messages</code> <code class="o">&amp;&amp;</code> <code class="nx">messages</code><code class="go">.</code><code class="nx">length</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">dl</code><code class="go">&gt;</code>
          <code class="go">{</code><code class="nx">messages</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">m</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code>
            <code class="go">&lt;&gt;</code>
              <code class="go">&lt;</code><code class="nt">dt</code><code class="go">&gt;{</code><code class="nx">m</code><code class="go">.</code><code class="nx">author</code><code class="go">}&lt;/</code><code class="nt">dt</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">dd</code><code class="go">&gt;{</code><code class="nx">m</code><code class="go">.</code><code class="nx">text</code><code class="go">}&lt;/</code><code class="nt">dd</code><code class="go">&gt;</code>
            <code class="go">&lt;/&gt;</code>
          <code class="go">))}</code>
        <code class="go">&lt;/</code><code class="nt">dl</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="go">(</code>
        <code class="s">'No messages'</code>
      <code class="go">)}</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">We’re going to add the new form to this component. We could also include the networking code and the state counter code right here,
inside the component. However, that would put the posting code in the component and the reading code in the 
<span class="firstname"><code class="calibre21">useMessages</code></span> hook.<a data-type="indexterm" data-primary="hooks" data-secondary="converting network calls to" data-tertiary="useForum hook" id="ix_hookntUF" class="calibre6"/> It’s
better to keep all the networking code together in the hook. Not only will the component be cleaner, but the networking code will be
more 
<span class="firstname">reusable</span>.</p>

<p class="author1">This is<a data-type="indexterm" data-primary="useForum hook" id="ix_useFor" class="calibre6"/> code we’ll use for a new version of the <code class="calibre21">useMessages</code> hook, which we will rename <code class="calibre21">useForum</code>:<sup class="calibre34"><a data-type="noteref" id="idm46634412810120-marker" href="ch05.xhtml#idm46634412810120" class="calibre35">1</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useCallback</code><code class="go">,</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>

<code class="kr">const</code> <code class="nx">useForum</code> <code class="o">=</code> <code class="go">(</code><code class="nx">forum</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">data</code><code class="go">,</code> <code class="nx">setData</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">([])</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loading</code><code class="go">,</code> <code class="nx">setLoading</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">error</code><code class="go">,</code> <code class="nx">setError</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">creating</code><code class="go">,</code> <code class="nx">setCreating</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">stateVersion</code><code class="go">,</code> <code class="nx">setStateVersion</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="mi">0</code><code class="go">)</code>

  <code class="kr">const</code> <code class="nx">create</code> <code class="o">=</code> <code class="nx">useCallback</code><code class="go">(</code>
    <code class="nx">async</code> <code class="go">(</code><code class="nx">message</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">try</code> <code class="go">{</code>
        <code class="nx">setCreating</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
        <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="go">(</code><code class="err">`</code><code class="o">/</code><code class="nx">messages</code><code class="o">/</code><code class="nx">$</code><code class="go">{</code><code class="nx">forum</code><code class="go">}</code><code class="err">`</code><code class="go">,</code> <code class="go">{</code>
          <code class="nx">method</code><code class="o">:</code> <code class="s">'POST'</code><code class="go">,</code>
          <code class="nx">body</code><code class="o">:</code> <code class="nx">JSON</code><code class="go">.</code><code class="nx">stringify</code><code class="go">(</code><code class="nx">message</code><code class="go">),</code>
          <code class="nx">headers</code><code class="o">:</code> <code class="go">{</code>
            <code class="s">'Content-type'</code><code class="o">:</code> <code class="s">'application/json; charset=UTF-8'</code><code class="go">,</code>
          <code class="go">},</code>
        <code class="go">})</code>
        <code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="nx">response</code><code class="go">.</code><code class="nx">ok</code><code class="go">)</code> <code class="go">{</code>
          <code class="kr">const</code> <code class="nx">text</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">response</code><code class="go">.</code><code class="nx">text</code><code class="go">()</code>
          <code class="kr">throw</code> <code class="kr">new</code> <code class="nb">Error</code><code class="go">(</code>
            <code class="err">`</code><code class="nx">Unable</code> <code class="nx">to</code> <code class="nx">create</code> <code class="nx">a</code> <code class="nx">$</code><code class="go">{</code><code class="nx">forum</code><code class="go">}</code> <code class="nx">message</code><code class="o">:</code> <code class="nx">$</code><code class="go">{</code><code class="nx">text</code><code class="go">}</code><code class="err">`</code>
          <code class="go">)</code>
        <code class="go">}</code>
        <code class="nx">setStateVersion</code><code class="go">((</code><code class="nx">v</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">v</code> <code class="o">+</code> <code class="mi">1</code><code class="go">)</code>
      <code class="go">}</code> <code class="kr">finally</code> <code class="go">{</code>
        <code class="nx">setCreating</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
      <code class="go">}</code>
    <code class="go">},</code>
    <code class="go">[</code><code class="nx">forum</code><code class="go">]</code>
  <code class="go">)</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">let</code> <code class="nx">didCancel</code> <code class="o">=</code> <code class="kr">false</code>
    <code class="nx">setError</code><code class="go">(</code><code class="kr">null</code><code class="go">)</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">forum</code><code class="go">)</code> <code class="go">{</code>
      <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
        <code class="kr">try</code> <code class="go">{</code>
          <code class="nx">setLoading</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
          <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="go">(</code><code class="err">`</code><code class="o">/</code><code class="nx">messages</code><code class="o">/</code><code class="nx">$</code><code class="go">{</code><code class="nx">forum</code><code class="go">}</code><code class="err">`</code><code class="go">)</code>
          <code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="nx">response</code><code class="go">.</code><code class="nx">ok</code><code class="go">)</code> <code class="go">{</code>
            <code class="kr">const</code> <code class="nx">text</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">response</code><code class="go">.</code><code class="nx">text</code><code class="go">()</code>
            <code class="kr">throw</code> <code class="kr">new</code> <code class="nb">Error</code><code class="go">(</code>
              <code class="err">`</code><code class="nx">Unable</code> <code class="nx">to</code> <code class="nx">read</code> <code class="nx">messages</code> <code class="kr">for</code> <code class="nx">$</code><code class="go">{</code><code class="nx">forum</code><code class="go">}</code><code class="o">:</code> <code class="nx">$</code><code class="go">{</code><code class="nx">text</code><code class="go">}</code><code class="err">`</code>
            <code class="go">)</code>
          <code class="go">}</code>
          <code class="kr">const</code> <code class="nx">body</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">response</code><code class="go">.</code><code class="nx">json</code><code class="go">()</code>
          <code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="nx">didCancel</code><code class="go">)</code> <code class="go">{</code>
            <code class="nx">setData</code><code class="go">(</code><code class="nx">body</code><code class="go">)</code>
          <code class="go">}</code>
        <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">setError</code><code class="go">(</code><code class="nx">err</code><code class="go">)</code>
        <code class="go">}</code> <code class="kr">finally</code> <code class="go">{</code>
          <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
        <code class="go">}</code>
      <code class="go">})()</code>
    <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
      <code class="nx">setData</code><code class="go">([])</code>
      <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
    <code class="go">}</code>
    <code class="kr">return</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">didCancel</code> <code class="o">=</code> <code class="kr">true</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">forum</code><code class="go">,</code> <code class="nx">stateVersion</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">{</code> <code class="nx">data</code><code class="go">,</code> <code class="nx">loading</code><code class="go">,</code> <code class="nx">error</code><code class="go">,</code> <code class="nx">create</code><code class="go">,</code> <code class="nx">creating</code> <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">useForum</code></pre>

<p class="author1">We now construct a <code class="calibre21">create</code> function inside the <code class="calibre21">useForum</code> hook and then return it with various other pieces of state to the
component. Notice that we are wrapping the <code class="calibre21">create</code> function inside a <code class="calibre21">useCallback</code>, which means that we won’t create a new version
of the function unless we need to do it to create data for a different <code class="calibre21">forum</code> value.</p>
<div data-type="warning" epub:type="warning" class="calibre26">
<p class="author1">Be careful when creating functions inside hooks and components. React will often trigger a re-render if a new function
object is created, even if that function does the same thing as the previous 
<span class="firstname">version</span>.</p>
</div>

<p class="author1">When we call the <code class="calibre21">create</code> function, it posts a new message to the forum and then updates the <code class="calibre21">stateVersion</code> value, which will
automatically cause the hook to re-read the messages from the server. Notice that we also have a <code class="calibre21">creating</code> value, which is <code class="calibre21">true</code>
when the network code is sending the message to the server. We can use the <code class="calibre21">creating</code> value to disable the POST button.</p>

<p class="author1">However, we don’t track any errors inside the <code class="calibre21">create</code>. Why don’t we? After all, we do when we’re <em class="calibre7">reading</em> data from the server.<a data-type="indexterm" data-primary="errors" data-secondary="not tracking in create function of useForum" id="idm46634412402120" class="calibre6"/>
It’s because you often want more control over exception handling when changing data on the server than you do when you are simply
reading it. In the example application, we clear out the message form when sending a message to the server. If there’s an error, we
want to leave the text in the message form.</p>

<p class="author1">Now let’s look at the code that calls the hook:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="s">'./App.css'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">useForum</code> <code class="nx">from</code> <code class="s">'./useForum'</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">{</code>
    <code class="nx">data</code><code class="o">:</code> <code class="nx">messages</code><code class="go">,</code>
    <code class="nx">loading</code><code class="o">:</code> <code class="nx">messagesLoading</code><code class="go">,</code>
    <code class="nx">error</code><code class="o">:</code> <code class="nx">messagesError</code><code class="go">,</code>
    <code class="nx">create</code><code class="o">:</code> <code class="nx">createMessage</code><code class="go">,</code>
    <code class="nx">creating</code><code class="o">:</code> <code class="nx">creatingMessage</code><code class="go">,</code>
  <code class="go">}</code> <code class="o">=</code> <code class="nx">useForum</code><code class="go">(</code><code class="s">'nasa'</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">text</code><code class="go">,</code> <code class="nx">setText</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">author</code><code class="go">,</code> <code class="nx">setAuthor</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">createMessageError</code><code class="go">,</code> <code class="nx">setCreateMessageError</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">input</code>
        <code class="na">type</code><code class="o">=</code><code class="s">"text"</code>
        <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">author</code><code class="go">}</code>
        <code class="na">placeholder</code><code class="o">=</code><code class="s">"Author"</code>
        <code class="na">onChange</code><code class="o">=</code><code class="go">{(</code><code class="nx">evt</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">setAuthor</code><code class="go">(</code><code class="nx">evt</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">)}</code>
      <code class="go">/&gt;</code>
      <code class="go">&lt;</code><code class="nt">textarea</code>
        <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">text</code><code class="go">}</code>
        <code class="na">placeholder</code><code class="o">=</code><code class="s">"Message"</code>
        <code class="na">onChange</code><code class="o">=</code><code class="go">{(</code><code class="nx">evt</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">setText</code><code class="go">(</code><code class="nx">evt</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">)}</code>
      <code class="go">/&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code>
        <code class="na">onClick</code><code class="o">=</code><code class="go">{</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="kr">try</code> <code class="go">{</code>
            <code class="nx">await</code> <code class="nx">createMessage</code><code class="go">({</code> <code class="nx">author</code><code class="go">,</code> <code class="nx">text</code> <code class="go">})</code>
            <code class="nx">setText</code><code class="go">(</code><code class="s">''</code><code class="go">)</code>
            <code class="nx">setAuthor</code><code class="go">(</code><code class="s">''</code><code class="go">)</code>
          <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
            <code class="nx">setCreateMessageError</code><code class="go">(</code><code class="nx">err</code><code class="go">)</code>
          <code class="go">}</code>
        <code class="go">}}</code>
        <code class="na">disabled</code><code class="o">=</code><code class="go">{</code><code class="nx">creatingMessage</code><code class="go">}</code>
      <code class="go">&gt;</code>
        <code class="nx">Post</code>
      <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">createMessageError</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"error"</code><code class="go">&gt;</code>
          <code class="nx">Unable</code> <code class="nx">to</code> <code class="nx">create</code> <code class="nx">message</code>
          <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"error-contents"</code><code class="go">&gt;</code>
            <code class="go">{</code><code class="nx">createMessageError</code><code class="go">.</code><code class="nx">message</code><code class="go">}</code>
          <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="kr">null</code><code class="go">}</code>
      <code class="go">{</code><code class="nx">messagesError</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"error"</code><code class="go">&gt;</code>
          <code class="nx">Something</code> <code class="nx">went</code> <code class="nx">wrong</code><code class="o">:</code>
          <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"error-contents"</code><code class="go">&gt;</code>
            <code class="go">{</code><code class="nx">messagesError</code><code class="go">.</code><code class="nx">message</code><code class="go">}</code>
          <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="nx">messagesLoading</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"loading"</code><code class="go">&gt;</code><code class="nx">Loading</code><code class="go">...&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="nx">messages</code> <code class="o">&amp;&amp;</code> <code class="nx">messages</code><code class="go">.</code><code class="nx">length</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">dl</code><code class="go">&gt;</code>
          <code class="go">{</code><code class="nx">messages</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">m</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code>
            <code class="go">&lt;&gt;</code>
              <code class="go">&lt;</code><code class="nt">dt</code><code class="go">&gt;{</code><code class="nx">m</code><code class="go">.</code><code class="nx">author</code><code class="go">}&lt;/</code><code class="nt">dt</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">dd</code><code class="go">&gt;{</code><code class="nx">m</code><code class="go">.</code><code class="nx">text</code><code class="go">}&lt;/</code><code class="nt">dd</code><code class="go">&gt;</code>
            <code class="go">&lt;/&gt;</code>
          <code class="go">))}</code>
        <code class="go">&lt;/</code><code class="nt">dl</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="go">(</code>
        <code class="s">'No messages'</code>
      <code class="go">)}</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">The details of how we read and write messages are hidden inside the <code class="calibre21">useForum</code> hook. <a data-type="indexterm" data-primary="object destructuring" id="idm46634412391832" class="calibre6"/>We use object destructuring to assign the
<code class="calibre21">create</code> function to the <code class="calibre21">createMessage</code> variable. If we call <code class="calibre21">createMessage</code>, it will not only post the message but also
automatically re-read the new messages from the forum and update the screen (see <a data-type="xref" href="#ch05_image_6" class="calibre6">Figure 5-6</a>).</p>

<figure class="calibre29"><div id="ch05_image_6" class="figure">
<img src="Images/recb_0505.png" alt="" class="calibre95"/>
<h6 class="calibre30"><span class="firstname">Figure 5-6. </span>Posting a new message and automatically reloading</h6>
</div></figure>

<p class="author1">Our hook is no longer just a way to read data from the server. It’s becoming a <em class="calibre7">service</em> for managing the forum itself.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634413212280">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Be careful using this approach if you intend to post data to the server in one component and then read data in a <em class="calibre7">different</em>
component. Separate hook instances will have separate state counters, and posting data from one component will not automatically
re-read the data in another component. If you want to split code to post and read across separate components, call the custom hook
in some common parent component, pass the data, and post functions to the child components that need them.<a data-type="indexterm" data-primary="hooks" data-secondary="converting network calls to" data-tertiary="useForum hook" data-startref="ix_hookntUF" id="idm46634411902312" class="calibre6"/><a data-type="indexterm" data-primary="useForum hook" data-startref="ix_useFor" id="idm46634411900824" class="calibre6"/></p>

<p class="author1">If you want to make your code poll a network service at a regular interval, then consider creating a clock and making your network code depend upon the current clock value, much as the preceding code depends upon the state counter.<sup class="calibre34"><a data-type="noteref" id="idm46634411899256-marker" href="ch05.xhtml#idm46634411899256" class="calibre35">2</a></sup></p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/knyC5" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="refreshes, automatic, using state counter" data-startref="ix_refrauto" id="idm46634411896696" class="calibre6"/><a data-type="indexterm" data-primary="network services, connecting to" data-secondary="refreshing automatically with state counters" data-startref="ix_ntservref" id="idm46634411895592" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="refreshing automatically with state counters" data-startref="ix_staref" id="idm46634411894376" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Cancel Network Requests with Tokens" class="calibre4"><div class="preface" id="ch05-03">
<h1 class="calibre17">Cancel Network Requests with Tokens</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634411891448">
<h2 class="calibre27">Problem</h2>

<p class="author1">Let’s consider a buggy application that can search for cities.<a data-type="indexterm" data-primary="network services, connecting to" data-secondary="canceling network requests with tokens" id="ix_ntservcncl" class="calibre6"/><a data-type="indexterm" data-primary="tokens" data-secondary="canceling network requests with" id="ix_tkncncl" class="calibre6"/> When a user starts to type a name in the search field, a list of
matching cities appears. As the user types “C… H… I… G…” the matching cities appear in the table of results. But then, after a
moment, a longer list of cities appears, which includes erroneous results, such as Wichita Falls (see <a data-type="xref" href="#ch05_image_7" class="calibre6">Figure 5-7</a>).</p>

<figure class="calibre29"><div id="ch05_image_7" class="figure">
<img src="Images/recb_0507.png" alt="" class="calibre96"/>
<h6 class="calibre30"><span class="firstname">Figure 5-7. </span>The search works initially; then the wrong cities appear</h6>
</div></figure>

<p class="author1">The problem is that the application is sending a new network request each time the user types a character. But not all network
requests take the same amount of time. In the example you can see here, the network request searching for “CHI” took a couple of
seconds longer than the search for “CHIG.” That meant that the “CHI” results returned after the results for “CHIG.”</p>

<p class="author1">How can you prevent a series of asynchronous network calls from returning out of sequence?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634411882760">
<h2 class="calibre27">Solution</h2>

<p class="author1">If you are making multiple GET calls to a network server, you can cancel old calls before sending new ones, which means that you
will never get results back out of order because you will have only one network request calling the service at a time.</p>

<p class="author1">For this recipe, we are going to use the Axios network library.<a data-type="indexterm" data-primary="Axios library" id="idm46634411880648" class="calibre6"/> That means that we have to install it:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install axios</code></pre>

<p class="author1">The Axios library is a wrapper for the native <code class="calibre21">fetch</code> function and allows you to cancel network requests using tokens.<a data-type="indexterm" data-primary="fetch function" id="idm46634411855752" class="calibre6"/> The Axios
implementation is based on the <a href="https://oreil.ly/jd4LF" class="calibre6">cancelable promises proposal</a> from ECMA.<a data-type="indexterm" data-primary="promises" data-secondary="cancelable promises proposal from ECMA" id="idm46634411854392" class="calibre6"/></p>

<p class="author1">Let’s begin by looking at our problem code.<a data-type="indexterm" data-primary="useSearch custom hook" id="idm46634411877960" class="calibre6"/> The network code is wrapped in a custom hook:<sup class="calibre34"><a data-type="noteref" id="idm46634411877064-marker" href="ch05.xhtml#idm46634411877064" class="calibre35">3</a></sup></p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>

<code class="kr">const</code> <code class="nx">useSearch</code> <code class="o">=</code> <code class="go">(</code><code class="nx">terms</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">data</code><code class="go">,</code> <code class="nx">setData</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">([])</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loading</code><code class="go">,</code> <code class="nx">setLoading</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">error</code><code class="go">,</code> <code class="nx">setError</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">setError</code><code class="go">(</code><code class="kr">null</code><code class="go">)</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">terms</code><code class="go">)</code> <code class="go">{</code>
      <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
        <code class="kr">try</code> <code class="go">{</code>
          <code class="nx">setLoading</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
          <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'/search'</code><code class="go">,</code> <code class="go">{</code>
            <code class="nx">params</code><code class="o">:</code> <code class="go">{</code> <code class="nx">terms</code> <code class="go">},</code>
          <code class="go">})</code>
          <code class="nx">setData</code><code class="go">(</code><code class="nx">response</code><code class="go">.</code><code class="nx">data</code><code class="go">)</code>
        <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">setError</code><code class="go">(</code><code class="nx">err</code><code class="go">)</code>
        <code class="go">}</code> <code class="kr">finally</code> <code class="go">{</code>
          <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
        <code class="go">}</code>
      <code class="go">})()</code>
    <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
      <code class="nx">setData</code><code class="go">([])</code>
      <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">terms</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">{</code> <code class="nx">data</code><code class="go">,</code> <code class="nx">loading</code><code class="go">,</code> <code class="nx">error</code> <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">useSearch</code></pre>

<p class="author1">The <code class="calibre21">terms</code> parameter contains the search string. The problem occurred because the code made a network request to <em class="calibre7">/search</em> for
the string <code class="calibre21">"CHI"</code>.</p>

<p class="author1">While that was in progress, we made another call with the string <code class="calibre21">"CHIG"</code>. The earlier request took longer, which caused the bug.</p>

<p class="author1">We’re going to avoid this problem by using an Axios cancel token. If we attach a token to a request, we can then later use the
token to cancel the request. The browser will terminate the request, and we’ll never hear back from it.</p>

<p class="author1">To use the token, we need to first<a data-type="indexterm" data-primary="tokens" data-secondary="canceling network requests with" data-tertiary="creating source for token" id="idm46634411782024" class="calibre6"/> create a source for it:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">source</code> <code class="o">=</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">CancelToken</code><code class="go">.</code><code class="nx">source</code><code class="go">()</code></pre>

<p class="author1">The <code class="calibre21">source</code> is like a remote control for the network request. Once a network request is connected to a source, we can tell the
source to cancel it. We associate a source with a request using <code class="calibre21">source.token</code>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'/search'</code><code class="go">,</code> <code class="go">{</code>
  <code class="nx">params</code><code class="o">:</code> <code class="go">{</code> <code class="nx">terms</code> <code class="go">},</code>
  <code class="nx">cancelToken</code><code class="o">:</code> <code class="nx">source</code><code class="go">.</code><code class="nx">token</code><code class="go">,</code>
<code class="go">})</code></pre>

<p class="author1">Axios will remember which token is attached to which network request. If we want to cancel the request, we can call this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">source</code><code class="go">.</code><code class="nx">cancel</code><code class="go">(</code><code class="s">'axios request canceled'</code><code class="go">)</code></pre>

<p class="author1">We need to make sure that we cancel a request only when we make a new request. Fortunately, our network call is inside a
<code class="calibre21">useEffect</code>, which has a handy feature.<a data-type="indexterm" data-primary="useCancelableSearch custom hook" id="idm46634411672280" class="calibre6"/><a data-type="indexterm" data-primary="useEffect hook" data-secondary="network call in" id="idm46634411671672" class="calibre6"/> If we return a function that cancels the current request, this function will be run <em class="calibre7">just
before</em> the <code class="calibre21">useEffect</code> runs again. So if we return a function that cancels the current network request, we will automatically
cancel the old network request each time we run a new one.<sup class="calibre34"><a data-type="noteref" id="idm46634411658232-marker" href="ch05.xhtml#idm46634411658232" class="calibre35">4</a></sup> Here is the updated version of the custom hook:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>

<code class="kr">const</code> <code class="nx">useCancelableSearch</code> <code class="o">=</code> <code class="go">(</code><code class="nx">terms</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">data</code><code class="go">,</code> <code class="nx">setData</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">([])</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loading</code><code class="go">,</code> <code class="nx">setLoading</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">error</code><code class="go">,</code> <code class="nx">setError</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">setError</code><code class="go">(</code><code class="kr">null</code><code class="go">)</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">terms</code><code class="go">)</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">source</code> <code class="o">=</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">CancelToken</code><code class="go">.</code><code class="nx">source</code><code class="go">()</code>
      <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
        <code class="kr">try</code> <code class="go">{</code>
          <code class="nx">setLoading</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
          <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'/search'</code><code class="go">,</code> <code class="go">{</code>
            <code class="nx">params</code><code class="o">:</code> <code class="go">{</code> <code class="nx">terms</code> <code class="go">},</code>
            <code class="nx">cancelToken</code><code class="o">:</code> <code class="nx">source</code><code class="go">.</code><code class="nx">token</code><code class="go">,</code>
          <code class="go">})</code>
          <code class="nx">setData</code><code class="go">(</code><code class="nx">response</code><code class="go">.</code><code class="nx">data</code><code class="go">)</code>
        <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">setError</code><code class="go">(</code><code class="nx">err</code><code class="go">)</code>
        <code class="go">}</code> <code class="kr">finally</code> <code class="go">{</code>
          <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
        <code class="go">}</code>
      <code class="go">})()</code>

      <code class="kr">return</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
        <code class="nx">source</code><code class="go">.</code><code class="nx">cancel</code><code class="go">(</code><code class="s">'axios request cancelled'</code><code class="go">)</code>
      <code class="go">}</code>
    <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
      <code class="nx">setData</code><code class="go">([])</code>
      <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">terms</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">{</code> <code class="nx">data</code><code class="go">,</code> <code class="nx">loading</code><code class="go">,</code> <code class="nx">error</code> <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">useCancelableSearch</code></pre>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634411882136">
<h2 class="calibre27">Discussion</h2>

<p class="author1">You should use this approach only if you are accessing idempotent services. In practice, this means that you should use it for <code class="calibre21">GET</code>
requests where you are interested only in the latest results.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/aQj5g" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="tokens" data-secondary="canceling network requests with" data-startref="ix_tkncncl" id="idm46634411258120" class="calibre6"/><a data-type="indexterm" data-primary="network services, connecting to" data-secondary="canceling network requests with tokens" data-startref="ix_ntservcncl" id="idm46634411256872" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Make Network Calls with Redux Middleware" class="calibre4"><div class="preface" id="ch05-04">
<h1 class="calibre17">Make Network Calls with Redux Middleware</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634411254040">
<h2 class="calibre27">Problem</h2>

<p class="author1">Redux is a <a data-type="indexterm" data-primary="network services, connecting to" data-secondary="using Redux middleware for network calls" id="ix_ntservRedu" class="calibre6"/><a data-type="indexterm" data-primary="Redux library" data-secondary="making network calls with middleware" id="ix_Reduntcall" class="calibre6"/>library that allows you to manage application state centrally.<sup class="calibre34"><a data-type="noteref" id="idm46634411249656-marker" href="ch05.xhtml#idm46634411249656" class="calibre35">5</a></sup> When you want to change the application state, you do <a data-type="indexterm" data-primary="actions" id="idm46634411248168" class="calibre6"/>it by dispatching commands (called
<em class="calibre7">actions</em>) that are captured and processed by JavaScript functions called <em class="calibre7">reducers</em>. <a data-type="indexterm" data-primary="reducers" id="idm46634411246600" class="calibre6"/>Redux is popular with React developers because
it provides a way to separate 
<span class="firstname">state-management</span> logic from component code. Redux performs actions 
<span class="firstname">asynchronously</span> but in strict order.
So, you can create large, complex applications in Redux that are both efficient and stable.</p>

<p class="author1">It would be great if we could leverage the power of Redux to orchestrate all of our network requests. We could dispatch actions that
say things like “Go and read the latest search results,” and Redux could make the network request and then update the central state.</p>

<p class="author1">However, to ensure that<a data-type="indexterm" data-primary="reducers" data-secondary="ensuring Redux code is stable, criteria for" id="idm46634411243208" class="calibre6"/> Redux code is stable, reducer functions have to meet several quite strict criteria: and one of them is that
<em class="calibre7">no reducer function can have side effects</em>. <a data-type="indexterm" data-primary="side effects" data-secondary="reducer functions and" id="idm46634411241464" class="calibre6"/>That means that you should never make network requests inside a reducer.</p>

<p class="author1">But if we cannot make network requests inside reducer functions, how can we configure Redux to talk to the network for us?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634411239704">
<h2 class="calibre27">Solution</h2>

<p class="author1">In a React Redux application, components publish (<em class="calibre7">dispatch</em>) actions, and reducers respond to actions <a data-type="indexterm" data-primary="actions" data-secondary="dispatching and responding to in React Redux apps" id="idm46634411237176" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="updating central state in React Redux apps" id="idm46634411236104" class="calibre6"/><a data-type="indexterm" data-primary="reducers" data-secondary="Redux reducers updating central state" id="idm46634411235128" class="calibre6"/>by updating the central state
(see <a data-type="xref" href="#ch05_image_8" class="calibre6">Figure 5-8</a>).</p>

<figure class="calibre29"><div id="ch05_image_8" class="figure">
<img src="Images/recb_0508.png" alt="" class="calibre97"/>
<h6 class="calibre30"><span class="firstname">Figure 5-8. </span>Using Redux reducers to update central state</h6>
</div></figure>

<p class="author1">If we want to create actions with side effects, we will have to use Redux <em class="calibre7">middleware</em>. <a data-type="indexterm" data-primary="actions" data-secondary="with side effects, creating using Redux middleware" data-secondary-sortas="side" id="idm46634411230408" class="calibre6"/><a data-type="indexterm" data-primary="side effects" data-secondary="Redux middleware code" id="idm46634411229032" class="calibre6"/><a data-type="indexterm" data-primary="middleware (Redux), making network calls" id="ix_middRedu" class="calibre6"/>Middleware receives actions before Redux
sends them to the reducers, and middleware can transform actions, cancel them, or create new actions. Most importantly, Redux
middleware code is allowed to have side effects. That means that if a component dispatches an action that says “Go and search for
this string,” we can write middleware that receives that action, generates a network call, and then converts the response into a new
“Store these search results” action. You can see how Redux middleware works in <a data-type="xref" href="#ch05_image_9" class="calibre6">Figure 5-9</a>.</p>

<figure class="calibre29"><div id="ch05_image_9" class="figure">
<img src="Images/recb_0509.png" alt="" class="calibre98"/>
<h6 class="calibre30"><span class="firstname">Figure 5-9. </span>Middleware can make network calls</h6>
</div></figure>

<p class="author1">Let’s create some middleware that intercepts an action of type <code class="calibre21">"SEARCH"</code> and uses it to generate a network service.</p>

<p class="author1">When we get the results back from the network, we will then create a new action of type <code class="calibre21">"SEARCH_RESULTS"</code>, which we can then use to
store the search results in the central Redux state. Our action object will look something like this:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">{</code>
  <code class="s">"type"</code><code class="o">:</code> <code class="s">"SEARCH"</code><code class="go">,</code>
  <code class="s">"payload"</code><code class="o">:</code> <code class="s">"Some search text"</code>
<code class="go">}</code></pre>

<p class="author1">This is the <em class="calibre7">axiosMiddleware.js</em> code that we’ll <a data-type="indexterm" data-primary="Axios library" data-secondary="axiosMiddleware.js code to intercept SEARCH actions" id="idm46634411217544" class="calibre6"/>use to intercept <code class="calibre21">SEARCH</code> actions:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>

<code class="kr">const</code> <code class="nx">axiosMiddleware</code> <code class="o">=</code> <code class="go">(</code><code class="nx">store</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code><code class="nx">next</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code><code class="nx">action</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">action</code><code class="go">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s">'SEARCH'</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">const</code> <code class="nx">terms</code> <code class="o">=</code> <code class="nx">action</code><code class="go">.</code><code class="nx">payload</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">terms</code><code class="go">)</code> <code class="go">{</code>
      <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
        <code class="kr">try</code> <code class="go">{</code>
          <code class="nx">store</code><code class="go">.</code><code class="nx">dispatch</code><code class="go">({</code>
            <code class="nx">type</code><code class="o">:</code> <code class="s">'SEARCH_RESULTS'</code><code class="go">,</code>
            <code class="nx">payload</code><code class="o">:</code> <code class="go">{</code>
              <code class="nx">loading</code><code class="o">:</code> <code class="kr">true</code><code class="go">,</code>
              <code class="nx">data</code><code class="o">:</code> <code class="kr">null</code><code class="go">,</code>
              <code class="nx">error</code><code class="o">:</code> <code class="kr">null</code><code class="go">,</code>
            <code class="go">},</code>
          <code class="go">})</code>
          <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'/search'</code><code class="go">,</code> <code class="go">{</code>
            <code class="nx">params</code><code class="o">:</code> <code class="go">{</code> <code class="nx">terms</code> <code class="go">},</code>
          <code class="go">})</code>
          <code class="nx">store</code><code class="go">.</code><code class="nx">dispatch</code><code class="go">({</code>
            <code class="nx">type</code><code class="o">:</code> <code class="s">'SEARCH_RESULTS'</code><code class="go">,</code>
            <code class="nx">payload</code><code class="o">:</code> <code class="go">{</code>
              <code class="nx">loading</code><code class="o">:</code> <code class="kr">false</code><code class="go">,</code>
              <code class="nx">error</code><code class="o">:</code> <code class="kr">null</code><code class="go">,</code>
              <code class="nx">data</code><code class="o">:</code> <code class="nx">response</code><code class="go">.</code><code class="nx">data</code><code class="go">,</code>
            <code class="go">},</code>
          <code class="go">})</code>
        <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">store</code><code class="go">.</code><code class="nx">dispatch</code><code class="go">({</code>
            <code class="nx">type</code><code class="o">:</code> <code class="s">'SEARCH_RESULTS'</code><code class="go">,</code>
            <code class="nx">payload</code><code class="o">:</code> <code class="go">{</code>
              <code class="nx">loading</code><code class="o">:</code> <code class="kr">false</code><code class="go">,</code>
              <code class="nx">error</code><code class="o">:</code> <code class="nx">err</code><code class="go">,</code>
              <code class="nx">data</code><code class="o">:</code> <code class="kr">null</code><code class="go">,</code>
            <code class="go">},</code>
          <code class="go">})</code>
        <code class="go">}</code>
      <code class="go">})()</code>
    <code class="go">}</code>
  <code class="go">}</code>
  <code class="kr">return</code> <code class="nx">next</code><code class="go">(</code><code class="nx">action</code><code class="go">)</code>
<code class="go">}</code>
<code class="kr">export</code> <code class="kr">default</code> <code class="nx">axiosMiddleware</code></pre>

<p class="author1">The function signature for Redux middleware can be confusing.<a data-type="indexterm" data-primary="Redux library" data-secondary="making network calls with middleware" data-tertiary="function signature for Redux middleware" id="idm46634411212584" class="calibre6"/> You can think of it as a function that receives a store, an action,
and another function called <code class="calibre21">next</code> that can forward actions on to the rest of Redux.</p>

<p class="author1">In the preceding code, we check to see if the action is of type <code class="calibre21">SEARCH</code>. If it is, we will make a network call. If it isn’t, we run
<code class="calibre21">next(action)</code>, which will pass it on to any other code interested in it.</p>

<p class="author1">When we start the network call, receive data, or capture any errors, then we can generate a new <code class="calibre21">SEARCH_RESULTS</code> action:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">store</code><code class="go">.</code><code class="nx">dispatch</code><code class="go">({</code>
  <code class="nx">type</code><code class="o">:</code> <code class="s">'SEARCH_RESULTS'</code><code class="go">,</code>
  <code class="nx">payload</code><code class="o">:</code> <code class="go">{</code>
    <code class="nx">loading</code><code class="o">:</code> <code class="go">...,</code>
    <code class="nx">error</code><code class="o">:</code> <code class="go">...,</code>
    <code class="nx">data</code><code class="o">:</code> <code class="go">...</code>
  <code class="go">},</code>
<code class="go">})</code></pre>

<p class="author1">The payload for our new action has the following:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">A Boolean flag called <code class="calibre21">loading</code>, which is <code class="calibre21">true</code> while the network request is 
<span class="firstname">running</span><a data-type="indexterm" data-primary="loading flag from SEARCH_RESULTS action" id="idm46634410959176" class="calibre6"/></p>
</li>
<li class="calibre8">
<p class="author1">A <code class="calibre21">data</code> object that contains the response from the server</p>
</li>
<li class="calibre8">
<p class="author1">An <code class="calibre21">error</code> object <a data-type="indexterm" data-primary="errors" data-secondary="error object from SEARCH_RESULTS action" id="idm46634410955912" class="calibre6"/>containing the details of any error that has occurred<sup class="calibre34"><a data-type="noteref" id="idm46634410954808-marker" href="ch05.xhtml#idm46634410954808" class="calibre35">6</a></sup></p>
</li>
</ul>

<p class="author1">We can then create a<a data-type="indexterm" data-primary="reducers" data-secondary="Redux middleware, storing SEARCH_RESULTS in central state" id="idm46634410953480" class="calibre6"/><a data-type="indexterm" data-primary="state" data-secondary="Redux reducer storing SEARCH_RESULTS in central state" id="idm46634410952504" class="calibre6"/> reducer that will store <code class="calibre21">SEARCH_RESULTS</code> in the central state:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">reducer</code> <code class="o">=</code> <code class="go">(</code><code class="nx">state</code><code class="go">,</code> <code class="nx">action</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">if</code> <code class="go">(</code><code class="nx">action</code><code class="go">.</code><code class="nx">type</code> <code class="o">===</code> <code class="s">'SEARCH_RESULTS'</code><code class="go">)</code> <code class="go">{</code>
    <code class="kr">return</code> <code class="go">{</code>
      <code class="go">...</code><code class="nx">state</code><code class="go">,</code>
      <code class="nx">searchResults</code><code class="o">:</code> <code class="go">{</code> <code class="go">...</code><code class="nx">action</code><code class="go">.</code><code class="nx">payload</code> <code class="go">},</code>
    <code class="go">}</code>
  <code class="go">}</code>
  <code class="kr">return</code> <code class="go">{</code> <code class="go">...</code><code class="nx">state</code> <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">reducer</code></pre>

<p class="author1">We also need to <a data-type="indexterm" data-primary="Redux library" data-secondary="making network calls with middleware" data-tertiary="registering middleware" id="idm46634410899576" class="calibre6"/>register our middleware using the Redux <code class="calibre21">applyMiddleware</code> function when we create the Redux store.<a data-type="indexterm" data-primary="applyMiddleware function (Redux)" id="idm46634410768984" class="calibre6"/> In the example
code, we do this in the <em class="calibre7">App.js</em> file:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">Provider</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-redux'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">createStore</code><code class="go">,</code> <code class="nx">applyMiddleware</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'redux'</code>
<code class="kr">import</code> <code class="s">'./App.css'</code>

<code class="kr">import</code> <code class="nx">reducer</code> <code class="nx">from</code> <code class="s">'./reducer'</code>
<code class="kr">import</code> <code class="nx">Search</code> <code class="nx">from</code> <code class="s">'./Search'</code>
<code class="kr">import</code> <code class="nx">axiosMiddleware</code> <code class="nx">from</code> <code class="s">'./axiosMiddleware'</code>

<code class="kr">const</code> <code class="nx">store</code> <code class="o">=</code> <code class="nx">createStore</code><code class="go">(</code><code class="nx">reducer</code><code class="go">,</code> <code class="nx">applyMiddleware</code><code class="go">(</code><code class="nx">axiosMiddleware</code><code class="go">))</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">Provider</code> <code class="na">store</code><code class="o">=</code><code class="go">{</code><code class="nx">store</code><code class="go">}&gt;</code>
        <code class="go">&lt;</code><code class="nt">Search</code> <code class="go">/&gt;</code>
      <code class="go">&lt;/</code><code class="nt">Provider</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">Finally, we can wire everything up in a <code class="calibre21">Search</code> component, which will dispatch a search request, and then read<a data-type="indexterm" data-primary="Redux library" data-secondary="making network calls with middleware" data-tertiary="Search component" id="idm46634410877128" class="calibre6"/><a data-type="indexterm" data-primary="selectors" data-secondary="Redux" id="idm46634410698264" class="calibre6"/> the results through
a Redux selector:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="s">'./App.css'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">useDispatch</code><code class="go">,</code> <code class="nx">useSelector</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react-redux'</code>

<code class="kr">const</code> <code class="nx">Search</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">terms</code><code class="go">,</code> <code class="nx">setTerms</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
  <code class="kr">const</code> <code class="go">{</code>
    <code class="nx">data</code><code class="o">:</code> <code class="nx">results</code><code class="go">,</code>
    <code class="nx">error</code><code class="go">,</code>
    <code class="nx">loading</code><code class="go">,</code>
  <code class="go">}</code> <code class="o">=</code> <code class="nx">useSelector</code><code class="go">((</code><code class="nx">state</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">state</code><code class="go">.</code><code class="nx">searchResults</code> <code class="o">||</code> <code class="go">{})</code>
  <code class="kr">const</code> <code class="nx">dispatch</code> <code class="o">=</code> <code class="nx">useDispatch</code><code class="go">()</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">input</code>
        <code class="na">placeholder</code><code class="o">=</code><code class="s">"Search..."</code>
        <code class="na">type</code><code class="o">=</code><code class="s">"text"</code>
        <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">terms</code><code class="go">}</code>
        <code class="na">onChange</code><code class="o">=</code><code class="go">{(</code><code class="nx">e</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="nx">setTerms</code><code class="go">(</code><code class="nx">e</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">)</code>
          <code class="nx">dispatch</code><code class="go">({</code>
            <code class="nx">type</code><code class="o">:</code> <code class="s">'SEARCH'</code><code class="go">,</code>
            <code class="nx">payload</code><code class="o">:</code> <code class="nx">e</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">,</code>
          <code class="go">})</code>
        <code class="go">}}</code>
      <code class="go">/&gt;</code>
      <code class="go">{</code><code class="nx">error</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code><code class="nb">Error</code><code class="o">:</code> <code class="go">{</code><code class="nx">error</code><code class="go">.</code><code class="nx">message</code><code class="go">}&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="nx">loading</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code><code class="nx">Loading</code><code class="go">...&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="nx">results</code> <code class="o">&amp;&amp;</code> <code class="nx">results</code><code class="go">.</code><code class="nx">length</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">table</code><code class="go">&gt;</code>
          <code class="go">&lt;</code><code class="nt">thead</code><code class="go">&gt;</code>
            <code class="go">&lt;</code><code class="nt">tr</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">th</code><code class="go">&gt;</code><code class="nx">City</code><code class="go">&lt;/</code><code class="nt">th</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">th</code><code class="go">&gt;</code><code class="nx">State</code><code class="go">&lt;/</code><code class="nt">th</code><code class="go">&gt;</code>
            <code class="go">&lt;/</code><code class="nt">tr</code><code class="go">&gt;</code>
          <code class="go">&lt;/</code><code class="nt">thead</code><code class="go">&gt;</code>
          <code class="go">{</code><code class="nx">results</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">r</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code>
            <code class="go">&lt;</code><code class="nt">tr</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">td</code><code class="go">&gt;{</code><code class="nx">r</code><code class="go">.</code><code class="nx">name</code><code class="go">}&lt;/</code><code class="nt">td</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">td</code><code class="go">&gt;{</code><code class="nx">r</code><code class="go">.</code><code class="nx">state</code><code class="go">}&lt;/</code><code class="nt">td</code><code class="go">&gt;</code>
            <code class="go">&lt;/</code><code class="nt">tr</code><code class="go">&gt;</code>
          <code class="go">))}</code>
        <code class="go">&lt;/</code><code class="nt">table</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">p</code><code class="go">&gt;</code><code class="nx">No</code> <code class="nx">results</code><code class="go">&lt;/</code><code class="nt">p</code><code class="go">&gt;</code>
      <code class="go">)}</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>
<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Search</code></pre>

<p class="author1">You can see the demo application running in <a data-type="xref" href="#ch05_image_10" class="calibre6">Figure 5-10</a>.</p>

<figure class="calibre29"><div id="ch05_image_10" class="figure">
<img src="Images/recb_0510.png" alt="" class="calibre99"/>
<h6 class="calibre30"><span class="firstname">Figure 5-10. </span>The application when data is loading, loaded, or errored</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634411238760">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Redux reducers always process actions in strict dispatch order. The same is not true for network requests generated by middleware.
If you are making many network requests in quick succession, you might find that responses return in a different order.<a data-type="indexterm" data-primary="tokens" data-secondary="canceling network requests with" id="idm46634410686216" class="calibre6"/> If this is
likely to lead to bugs, then consider using cancellation tokens.<sup class="calibre34"><a data-type="noteref" id="idm46634410368616-marker" href="ch05.xhtml#idm46634410368616" class="calibre35">7</a></sup></p>

<p class="author1">You might also consider moving all Redux <code class="calibre21">useDispatch()/useSelector()</code> code out of components and into custom hooks, which will give
you a more flexible architecture by separating your service layer from your component code.<a data-type="indexterm" data-primary="hooks" data-secondary="moving Redux useDispatch/useSelector code into" id="idm46634410366184" class="calibre6"/></p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/YlqEF" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="middleware (Redux), making network calls" data-startref="ix_middRedu" id="idm46634410364072" class="calibre6"/><a data-type="indexterm" data-primary="network services, connecting to" data-secondary="using Redux middleware for network calls" data-startref="ix_ntservRedu" id="idm46634410362968" class="calibre6"/><a data-type="indexterm" data-primary="Redux library" data-secondary="making network calls with middleware" data-startref="ix_Reduntcall" id="idm46634410361752" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Connect to GraphQL" class="calibre4"><div class="preface" id="ch05-05">
<h1 class="calibre17">Connect to GraphQL</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634410358888">
<h2 class="calibre27">Problem</h2>

<p class="author1">GraphQL is an excellent way of creating APIs.<a data-type="indexterm" data-primary="GraphQL,  connecting to" id="ix_GrpQL" class="calibre6"/> If you’ve used REST services for a while, then some features of GraphQL will seem odd
(or even heretical), but having worked on a few GraphQL projects, we would certainly recommend that you consider it for your next
development project.</p>

<p class="author1">When people refer to GraphQL, they can mean several things. They might be referring to the GraphQL language, which is managed and
maintained by the GraphQL Foundation.<a data-type="indexterm" data-primary="APIs" data-secondary="GraphQL" id="idm46634410355608" class="calibre6"/> GraphQL allows you to specify APIs and to create queries to access and mutate the data stored
behind those APIs. They might be referring to a GraphQL server, which stitches together multiple low-level data access methods into
a rich web service.<a data-type="indexterm" data-primary="clients and servers" data-secondary="GraphQL" id="idm46634410354248" class="calibre6"/> Or they might be talking about a GraphQL client, which allows you to rapidly create new client requests with
very little code and transfer just the data you need across the network.</p>

<p class="author1">But how do you integrate GraphQL with your React application?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634410352344">
<h2 class="calibre27">Solution</h2>

<p class="author1">Before we look at how to use GraphQL from React, we will begin by creating a small GraphQL server.<a data-type="indexterm" data-primary="GraphQL,  connecting to" data-secondary="creating GraphQL server" id="idm46634410350312" class="calibre6"/><a data-type="indexterm" data-primary="clients and servers" data-secondary="GraphQL" data-tertiary="creating a server" id="idm46634410349336" class="calibre6"/> The first thing we need is a
GraphQL <em class="calibre7">schema</em>. <a data-type="indexterm" data-primary="schemas (GraphQL)" id="idm46634410347608" class="calibre6"/>The schema is a formal definition of the data and services that our GraphQL server will provide.</p>

<p class="author1">Here is the <em class="calibre7">schema.graphql</em> schema we’ll use. It’s a GraphQL specification of the forum message example we’ve used previously in
this chapter:</p>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="nx">type</code> <code class="nx">Query</code> <code class="go">{</code>
    <code class="nx">messages</code><code class="o">:</code> <code class="go">[</code><code class="nx">Message</code><code class="go">]</code>
<code class="go">}</code>

<code class="nx">type</code> <code class="nx">Message</code> <code class="go">{</code>
    <code class="nx">id</code><code class="o">:</code> <code class="nx">ID</code><code class="o">!</code>
    <code class="nx">author</code><code class="o">:</code> <code class="nb">String</code><code class="o">!</code>
    <code class="nx">text</code><code class="o">:</code> <code class="nb">String</code><code class="o">!</code>
<code class="go">}</code>

<code class="nx">type</code> <code class="nx">Mutation</code> <code class="go">{</code>
    <code class="nx">addMessage</code><code class="go">(</code>
        <code class="nx">author</code><code class="o">:</code> <code class="nb">String</code><code class="o">!</code>
        <code class="nx">text</code><code class="o">:</code> <code class="nb">String</code><code class="o">!</code>
    <code class="go">)</code><code class="o">:</code> <code class="nx">Message</code>
<code class="go">}</code></pre>

<p class="author1">This schema defines a single <em class="calibre7">query</em> (method for reading data) called <code class="calibre21">messages</code>, which returns an array of <code class="calibre21">Message</code> objects. Each
<code class="calibre21">Message</code> has an <code class="calibre21">id</code>, a non-null string called <code class="calibre21">author</code>, and a non-null string called <code class="calibre21">text</code>. <a data-type="indexterm" data-primary="query (GraphQL)" id="idm46634410283752" class="calibre6"/><a data-type="indexterm" data-primary="mutation (GraphQL)" id="idm46634410283128" class="calibre6"/>We also have a single <em class="calibre7">mutation</em>
(method for changing data) called <code class="calibre21">addMessage</code>, which will store a message based on an <code class="calibre21">author</code> string and a <code class="calibre21">text</code> string.</p>

<p class="author1">Before we create our sample server, we’ll install a few libraries:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install apollo-server</code>
<code class="go">$ npm install graphql</code>
<code class="go">$ npm install require-text</code></pre>

<p class="author1">The <code class="calibre21">apollo-server</code> is a framework for creating GraphQL servers.<a data-type="indexterm" data-primary="apollo-server framework" id="idm46634410277224" class="calibre6"/><a data-type="indexterm" data-primary="require-text library" id="idm46634410276808" class="calibre6"/> The <code class="calibre21">require-text</code> library will allows us to read the
<code class="calibre21">schema.graphql</code> file. This is <em class="calibre7">server.js</em>, our example server:</p>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code> <code class="go">{</code> <code class="nx">ApolloServer</code> <code class="go">}</code> <code class="o">=</code> <code class="nx">require</code><code class="go">(</code><code class="s">'apollo-server'</code><code class="go">)</code>
<code class="kr">const</code> <code class="nx">requireText</code> <code class="o">=</code> <code class="nx">require</code><code class="go">(</code><code class="s">'require-text'</code><code class="go">)</code>

<code class="kr">const</code> <code class="nx">typeDefs</code> <code class="o">=</code> <code class="nx">requireText</code><code class="go">(</code><code class="s">'./schema.graphql'</code><code class="go">,</code> <code class="nx">require</code><code class="go">)</code>

<code class="kr">const</code> <code class="nx">messages</code> <code class="o">=</code> <code class="go">[</code>
  <code class="go">{</code>
    <code class="nx">id</code><code class="o">:</code> <code class="mi">0</code><code class="go">,</code>
    <code class="nx">author</code><code class="o">:</code> <code class="s">'SC'</code><code class="go">,</code>
    <code class="nx">text</code><code class="o">:</code> <code class="s">'Rolls complete and a pitch is program. One BRAVO.'</code><code class="go">,</code>
  <code class="go">},</code>
  <code class="go">{</code>
    <code class="nx">id</code><code class="o">:</code> <code class="mi">1</code><code class="go">,</code>
    <code class="nx">author</code><code class="o">:</code> <code class="s">'PAO'</code><code class="go">,</code>
    <code class="nx">text</code><code class="o">:</code> <code class="s">'One BRAVO is an abort control model. Altitude is 2 miles.'</code><code class="go">,</code>
  <code class="go">},</code>
  <code class="go">{</code>
    <code class="nx">id</code><code class="o">:</code> <code class="mi">2</code><code class="go">,</code>
    <code class="nx">author</code><code class="o">:</code> <code class="s">'CAPCOM'</code><code class="go">,</code>
    <code class="nx">text</code><code class="o">:</code> <code class="s">'All is well at Houston. You are good at 1 minute.'</code><code class="go">,</code>
  <code class="go">},</code>
<code class="go">]</code>

<code class="kr">const</code> <code class="nx">resolvers</code> <code class="o">=</code> <code class="go">{</code>
  <code class="nx">Query</code><code class="o">:</code> <code class="go">{</code>
    <code class="nx">messages</code><code class="o">:</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="nx">messages</code><code class="go">,</code>
  <code class="go">},</code>
  <code class="nx">Mutation</code><code class="o">:</code> <code class="go">{</code>
    <code class="nx">addMessage</code><code class="o">:</code> <code class="go">(</code><code class="nx">parent</code><code class="go">,</code> <code class="nx">message</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">item</code> <code class="o">=</code> <code class="go">{</code> <code class="nx">id</code><code class="o">:</code> <code class="nx">messages</code><code class="go">.</code><code class="nx">length</code> <code class="o">+</code> <code class="mi">1</code><code class="go">,</code> <code class="go">...</code><code class="nx">message</code> <code class="go">}</code>
      <code class="nx">messages</code><code class="go">.</code><code class="nx">push</code><code class="go">(</code><code class="nx">item</code><code class="go">)</code>
      <code class="kr">return</code> <code class="nx">item</code>
    <code class="go">},</code>
  <code class="go">},</code>
<code class="go">}</code>

<code class="kr">const</code> <code class="nx">server</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">ApolloServer</code><code class="go">({</code>
  <code class="nx">typeDefs</code><code class="go">,</code>
  <code class="nx">resolvers</code><code class="go">,</code>
<code class="go">})</code>

<code class="nx">server</code><code class="go">.</code><code class="nx">listen</code><code class="go">({</code> <code class="nx">port</code><code class="o">:</code> <code class="mi">5000</code> <code class="go">}).</code><code class="nx">then</code><code class="go">(({</code> <code class="nx">url</code> <code class="go">})</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="nx">console</code><code class="go">.</code><code class="nx">log</code><code class="go">(</code><code class="nx">Launched</code> <code class="nx">at</code> <code class="nx">$</code><code class="go">{</code><code class="nx">url</code><code class="go">}</code><code class="o">!</code><code class="go">)</code>
<code class="go">})</code></pre>

<p class="author1">The server stores messages in an array, which is prepopulated with a few messages. You can start the server with:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ node ./server.js</code></pre>

<p class="author1">This command will start the server on port 5000. If you open a browser to <em class="calibre7">http://localhost:5000</em>, you will see the GraphQL Playground
client. <a data-type="indexterm" data-primary="clients and servers" data-secondary="GraphQL Playground client" id="idm46634409953048" class="calibre6"/><a data-type="indexterm" data-primary="Playground client (GraphQL)" id="idm46634409952312" class="calibre6"/><a data-type="indexterm" data-primary="GraphQL,  connecting to" data-secondary="React client code" id="idm46634409951704" class="calibre6"/>The Playground client is a tool that allows you to try out queries and mutations interactively before adding them to your
code (see <a data-type="xref" href="#ch05_image_11" class="calibre6">Figure 5-11</a>).</p>

<figure class="calibre29"><div id="ch05_image_11" class="figure">
<img src="Images/recb_0511.png" alt="" class="calibre100"/>
<h6 class="calibre30"><span class="firstname">Figure 5-11. </span>The GraphQL Playground should be running at <span class="firstname">http://localhost:5000</span></h6>
</div></figure>

<p class="author1">Now we can start to look at the React client code.<a data-type="indexterm" data-primary="Apollo GraphQL client" data-secondary="installing" id="idm46634409969528" class="calibre6"/> We’ll install the Apollo client:</p>

<pre data-type="programlisting" data-code-language="shell-session" class="calibre28"><code class="go">$ npm install @apollo/client</code></pre>

<p class="author1">GraphQL supports both <code class="calibre21">GET</code> and <code class="calibre21">POST</code> requests, but the Apollo client sends queries and mutations to the GraphQL server as <code class="calibre21">POST</code>
requests, which avoids any cross-domain issues and means you can connect to a third-party GraphQL server without having to proxy.<a data-type="indexterm" data-primary="clients and servers" data-secondary="GraphQL" data-tertiary="connecting to third-party server without proxy" id="idm46634409924008" class="calibre6"/> As
a consequence, it means that a GraphQL client has to handle its own caching, so we will need to provide a cache and the address of
the server when we configure the client in <em class="calibre7">App.js</em>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="s">'./App.css'</code>
<code class="kr">import</code> <code class="go">{</code>
  <code class="nx">ApolloClient</code><code class="go">,</code>
  <code class="nx">ApolloProvider</code><code class="go">,</code>
  <code class="nx">InMemoryCache</code><code class="go">,</code>
<code class="go">}</code> <code class="nx">from</code> <code class="s">'@apollo/client'</code>
<code class="kr">import</code> <code class="nx">Forum</code> <code class="nx">from</code> <code class="s">'./Forum'</code>

<code class="kr">const</code> <code class="nx">client</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">ApolloClient</code><code class="go">({</code>
  <code class="nx">uri</code><code class="o">:</code> <code class="s">'http://localhost:5000'</code><code class="go">,</code>
  <code class="nx">cache</code><code class="o">:</code> <code class="kr">new</code> <code class="nx">InMemoryCache</code><code class="go">(),</code>
<code class="go">})</code>

<code class="kr">function</code> <code class="nx">App</code><code class="go">()</code> <code class="go">{</code>
  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">ApolloProvider</code> <code class="na">client</code><code class="o">=</code><code class="go">{</code><code class="nx">client</code><code class="go">}&gt;</code>
        <code class="go">&lt;</code><code class="nt">Forum</code> <code class="go">/&gt;</code>
      <code class="go">&lt;/</code><code class="nt">ApolloProvider</code><code class="go">&gt;</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">App</code></pre>

<p class="author1">The <code class="calibre21">ApolloProvider</code> makes the client available to any child component.<a data-type="indexterm" data-primary="ApolloProvider" id="idm46634409964760" class="calibre6"/> If you forget to add the <code class="calibre21">ApolloProvider</code>, you will find
that all of your GraphQL client code will fail.</p>

<p class="author1">We’re going<a data-type="indexterm" data-primary="GraphQL,  connecting to" data-secondary="making query and mutation calls from Forum component" id="idm46634409857384" class="calibre6"/> to make the calls to GraphQL from inside the <code class="calibre21">Forum</code> component.<a data-type="indexterm" data-primary="query (GraphQL)" data-secondary="Messages query" id="idm46634409855880" class="calibre6"/><a data-type="indexterm" data-primary="mutation (GraphQL)" data-secondary="AddMessage mutation" id="idm46634409854872" class="calibre6"/> We’ll be performing two actions:</p>

<ul class="stafflist">
<li class="calibre8">
<p class="author1">A <em class="calibre7">query</em> called <code class="calibre21">Messages</code> that reads all of the messages</p>
</li>
<li class="calibre8">
<p class="author1">A <em class="calibre7">mutation</em> called <code class="calibre21">AddMessage</code> that will post a new message</p>
</li>
</ul>

<p class="author1">The query and the mutation are written in the GraphQL language. Here’s the 
<span class="firstname"><code class="calibre21">Messages</code></span> query:</p>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="nx">query</code> <code class="nx">Messages</code> <code class="go">{</code>
  <code class="nx">messages</code> <code class="go">{</code>
    <code class="nx">author</code> <code class="nx">text</code>
  <code class="go">}</code>
<code class="go">}</code></pre>

<p class="author1">This query means that we want to read all of the messages, but we only want to return the <code class="calibre21">author</code> and <code class="calibre21">text</code> strings. Because we’re
not asking for the message <code class="calibre21">id</code>, the GraphQL server won’t return it. This is part of the flexibility of GraphQL: you specify what
you want at query time rather than by crafting a particular API call for each 
<span class="firstname">variation</span>.</p>

<p class="author1">The <code class="calibre21">AddMessage</code> mutation is a little more complex, because it needs to be parameterized so that we can specify the <code class="calibre21">author</code> and
<code class="calibre21">text</code> values each time we call it:</p>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="nx">mutation</code> <code class="nx">AddMessage</code><code class="go">(</code>
  <code class="nx">$author</code><code class="o">:</code> <code class="nb">String</code><code class="o">!</code>
  <code class="nx">$text</code><code class="o">:</code> <code class="nb">String</code><code class="o">!</code>
<code class="go">)</code> <code class="go">{</code>
  <code class="nx">addMessage</code><code class="go">(</code>
    <code class="nx">author</code><code class="o">:</code> <code class="nx">$author</code>
    <code class="nx">text</code><code class="o">:</code> <code class="nx">$text</code>
  <code class="go">)</code> <code class="go">{</code>
    <code class="nx">author</code>
    <code class="nx">text</code>
  <code class="go">}</code>
<code class="go">}</code></pre>

<p class="author1">We’re going to use the <code class="calibre21">useQuery</code> and <code class="calibre21">useMutation</code> hooks provided by the Apollo GraphQL client.<a data-type="indexterm" data-primary="Apollo GraphQL client" data-secondary="useQuery and useMutation hooks" id="idm46634409708920" class="calibre6"/><a data-type="indexterm" data-primary="useQuery hook" id="idm46634409708120" class="calibre6"/><a data-type="indexterm" data-primary="useMutation hook" id="idm46634409707448" class="calibre6"/> The <code class="calibre21">useQuery</code> hook returns an
object with <code class="calibre21">data</code>, <code class="calibre21">loading</code>, and <code class="calibre21">error</code> attributes.<sup class="calibre34"><a data-type="noteref" id="idm46634409704920-marker" href="ch05.xhtml#idm46634409704920" class="calibre35">8</a></sup> The <code class="calibre21">useMutation</code> hook returns an array with two values: a function and an object
representing the result.</p>

<p class="author1">In <a data-type="xref" href="#ch05-02" class="calibre6">“Refresh Automatically with State Counters”</a>, we looked at how to automatically reload data after some mutation has changed it on the server.
Thankfully, the Apollo client has a ready-made solution. When you call a mutation, you can specify an array of other queries that
should be rerun if the mutation is successful:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="nx">await</code> <code class="nx">addMessage</code><code class="go">({</code>
  <code class="nx">variables</code><code class="o">:</code> <code class="go">{</code> <code class="nx">author</code><code class="go">,</code> <code class="nx">text</code> <code class="go">},</code>
  <code class="nx">refetchQueries</code><code class="o">:</code> <code class="go">[</code><code class="s">'Messages'</code><code class="go">],</code>
<code class="go">})</code></pre>

<p class="author1">The <code class="calibre21">'Messages'</code> string refers to the name of the GraphQL query, which means we can be running multiple queries against the GraphQL
service and specify which of them are likely to need refreshing after a change.<a data-type="indexterm" data-primary="GraphQL,  connecting to" data-secondary="React Forum component code" id="idm46634409648376" class="calibre6"/></p>

<p class="author1">Finally, here is the complete <code class="calibre21">Forum</code> component:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">gql</code><code class="go">,</code> <code class="nx">useMutation</code><code class="go">,</code> <code class="nx">useQuery</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'@apollo/client'</code>
<code class="kr">import</code> <code class="go">{</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>

<code class="kr">const</code> <code class="nx">MESSAGES</code> <code class="o">=</code> <code class="nx">gql</code><code class="err">`</code>
  <code class="nx">query</code> <code class="nx">Messages</code> <code class="go">{</code>
    <code class="nx">messages</code> <code class="go">{</code>
      <code class="nx">author</code>
      <code class="nx">text</code>
    <code class="go">}</code>
  <code class="go">}</code>
<code class="err">`</code>

<code class="kr">const</code> <code class="nx">ADD_MESSAGE</code> <code class="o">=</code> <code class="nx">gql</code><code class="err">`</code>
  <code class="nx">mutation</code> <code class="nx">AddMessage</code><code class="go">(</code><code class="nx">$author</code><code class="o">:</code> <code class="nb">String</code><code class="o">!</code><code class="go">,</code> <code class="nx">$text</code><code class="o">:</code> <code class="nb">String</code><code class="o">!</code><code class="go">)</code> <code class="go">{</code>
    <code class="nx">addMessage</code><code class="go">(</code><code class="nx">author</code><code class="o">:</code> <code class="nx">$author</code><code class="go">,</code> <code class="nx">text</code><code class="o">:</code> <code class="nx">$text</code><code class="go">)</code> <code class="go">{</code>
      <code class="nx">author</code>
      <code class="nx">text</code>
    <code class="go">}</code>
  <code class="go">}</code>
<code class="err">`</code>

<code class="kr">const</code> <code class="nx">Forum</code> <code class="o">=</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">{</code>
    <code class="nx">loading</code><code class="o">:</code> <code class="nx">messagesLoading</code><code class="go">,</code>
    <code class="nx">error</code><code class="o">:</code> <code class="nx">messagesError</code><code class="go">,</code>
    <code class="nx">data</code><code class="go">,</code>
  <code class="go">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="go">(</code><code class="nx">MESSAGES</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">addMessage</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useMutation</code><code class="go">(</code><code class="nx">ADD_MESSAGE</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">text</code><code class="go">,</code> <code class="nx">setText</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">author</code><code class="go">,</code> <code class="nx">setAuthor</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="kr">const</code> <code class="nx">messages</code> <code class="o">=</code> <code class="nx">data</code> <code class="o">&amp;&amp;</code> <code class="nx">data</code><code class="go">.</code><code class="nx">messages</code>

  <code class="kr">return</code> <code class="go">(</code>
    <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"App"</code><code class="go">&gt;</code>
      <code class="go">&lt;</code><code class="nt">input</code>
        <code class="na">type</code><code class="o">=</code><code class="s">"text"</code>
        <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">author</code><code class="go">}</code>
        <code class="na">placeholder</code><code class="o">=</code><code class="s">"Author"</code>
        <code class="na">onChange</code><code class="o">=</code><code class="go">{(</code><code class="nx">evt</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">setAuthor</code><code class="go">(</code><code class="nx">evt</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">)}</code>
      <code class="go">/&gt;</code>
      <code class="go">&lt;</code><code class="nt">textarea</code>
        <code class="na">value</code><code class="o">=</code><code class="go">{</code><code class="nx">text</code><code class="go">}</code>
        <code class="na">placeholder</code><code class="o">=</code><code class="s">"Message"</code>
        <code class="na">onChange</code><code class="o">=</code><code class="go">{(</code><code class="nx">evt</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="nx">setText</code><code class="go">(</code><code class="nx">evt</code><code class="go">.</code><code class="nx">target</code><code class="go">.</code><code class="nx">value</code><code class="go">)}</code>
      <code class="go">/&gt;</code>
      <code class="go">&lt;</code><code class="nt">button</code>
        <code class="na">onClick</code><code class="o">=</code><code class="go">{</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="kr">try</code> <code class="go">{</code>
            <code class="nx">await</code> <code class="nx">addMessage</code><code class="go">({</code>
              <code class="nx">variables</code><code class="o">:</code> <code class="go">{</code> <code class="nx">author</code><code class="go">,</code> <code class="nx">text</code> <code class="go">},</code>
              <code class="nx">refetchQueries</code><code class="o">:</code> <code class="go">[</code><code class="s">'Messages'</code><code class="go">],</code>
            <code class="go">})</code>
            <code class="nx">setText</code><code class="go">(</code><code class="s">''</code><code class="go">)</code>
            <code class="nx">setAuthor</code><code class="go">(</code><code class="s">''</code><code class="go">)</code>
          <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{}</code>
        <code class="go">}}</code>
      <code class="go">&gt;</code>
        <code class="nx">Post</code>
      <code class="go">&lt;/</code><code class="nt">button</code><code class="go">&gt;</code>
      <code class="go">{</code><code class="nx">messagesError</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"error"</code><code class="go">&gt;</code>
          <code class="nx">Something</code> <code class="nx">went</code> <code class="nx">wrong</code><code class="o">:</code>
          <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"error-contents"</code><code class="go">&gt;</code>
            <code class="go">{</code><code class="nx">messagesError</code><code class="go">.</code><code class="nx">message</code><code class="go">}</code>
          <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
        <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="nx">messagesLoading</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">div</code> <code class="na">className</code><code class="o">=</code><code class="s">"loading"</code><code class="go">&gt;</code><code class="nx">Loading</code><code class="go">...&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="nx">messages</code> <code class="o">&amp;&amp;</code> <code class="nx">messages</code><code class="go">.</code><code class="nx">length</code> <code class="o">?</code> <code class="go">(</code>
        <code class="go">&lt;</code><code class="nt">dl</code><code class="go">&gt;</code>
          <code class="go">{</code><code class="nx">messages</code><code class="go">.</code><code class="nx">map</code><code class="go">((</code><code class="nx">m</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">(</code>
            <code class="go">&lt;&gt;</code>
              <code class="go">&lt;</code><code class="nt">dt</code><code class="go">&gt;{</code><code class="nx">m</code><code class="go">.</code><code class="nx">author</code><code class="go">}&lt;/</code><code class="nt">dt</code><code class="go">&gt;</code>
              <code class="go">&lt;</code><code class="nt">dd</code><code class="go">&gt;{</code><code class="nx">m</code><code class="go">.</code><code class="nx">text</code><code class="go">}&lt;/</code><code class="nt">dd</code><code class="go">&gt;</code>
            <code class="go">&lt;/&gt;</code>
          <code class="go">))}</code>
        <code class="go">&lt;/</code><code class="nt">dl</code><code class="go">&gt;</code>
      <code class="go">)</code> <code class="o">:</code> <code class="go">(</code>
        <code class="s">'No messages'</code>
      <code class="go">)}</code>
    <code class="go">&lt;/</code><code class="nt">div</code><code class="go">&gt;</code>
  <code class="go">)</code>
<code class="go">}</code>
<code class="kr">export</code> <code class="kr">default</code> <code class="nx">Forum</code></pre>

<p class="author1">When you run the application and post a new message, the messages list automatically updates with the new message added to the end,
as shown in <a data-type="xref" href="#ch05_image_12" class="calibre6">Figure 5-12</a>.</p>

<figure class="calibre29"><div id="ch05_image_12" class="figure">
<img src="Images/recb_0512.png" alt="" class="calibre101"/>
<h6 class="calibre30"><span class="firstname">Figure 5-12. </span>After we post a message, it appears on the list</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634410351400">
<h2 class="calibre27">Discussion</h2>

<p class="author1">GraphQL is particularly useful if you have a team split between frontend and backend developers. <a data-type="indexterm" data-primary="APIs" data-secondary="GraphQL" id="idm46634409634968" class="calibre6"/>Unlike REST, a GraphQL system does
not require the backend developers to handcraft every API call made by the client. Instead, the backend team can provide a solid
and consistent API structure and leave it to the frontend team to decide precisely <em class="calibre7">how</em> they will use it.</p>

<p class="author1">If you are creating a<a data-type="indexterm" data-primary="hooks" data-secondary="GraphQL useQuery and useMutation calls in custom hooks" id="idm46634409301432" class="calibre6"/> React application using GraphQL, you might consider extracting all of the <code class="calibre21">useQuery</code> and <code class="calibre21">useMutation</code> calls
into a custom hooks.<sup class="calibre34"><a data-type="noteref" id="idm46634409299480-marker" href="ch05.xhtml#idm46634409299480" class="calibre35">9</a></sup> In this way, you will create a
more flexible architecture in which the components are less bound to the details of the service layer.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/xTcAK" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="GraphQL,  connecting to" data-startref="ix_GrpQL" id="idm46634409296680" class="calibre6"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Reduce Network Load with Debounced Requests" class="calibre4"><div class="preface" id="ch05-06">
<h1 class="calibre17">Reduce Network Load with Debounced Requests</h1>








<section data-type="sect2" data-pdf-bookmark="Problem" class="calibre4"><div class="preface" id="idm46634409293928">
<h2 class="calibre27">Problem</h2>

<p class="author1">It is easy to forget about performance when you’re working in a development system.<a data-type="indexterm" data-primary="network services, connecting to" data-secondary="reducing network load with debounced requests" id="ix_ntservredld" class="calibre6"/><a data-type="indexterm" data-primary="debounced requests, reducing network load with" id="ix_debreq" class="calibre6"/> That’s probably a good thing because it’s more
important that code does the right thing rather than do the wrong thing quickly.</p>

<p class="author1">But when your application gets deployed to its first realistic environment—such as one used for user acceptance testing—then
performance will become more important. The kind of dynamic interfaces associated with React often make a lot of network calls, and
the cost of these calls will be noticeable only once the server has to cope with lots of concurrent clients.</p>

<p class="author1">We’ve used an example search application a few times in this chapter. In the search app, a user can look for a city by name or
state. The search happens immediately—while they are typing. If you open the developer tools and look at the network requests (see
<a data-type="xref" href="#ch05_image_13" class="calibre6">Figure 5-13</a>), you will see that it generates network requests for each character typed.</p>

<figure class="calibre29"><div id="ch05_image_13" class="figure">
<img src="Images/recb_0513.png" alt="" class="calibre102"/>
<h6 class="calibre30"><span class="firstname">Figure 5-13. </span>The demo search application runs a network request for each character</h6>
</div></figure>

<p class="author1">Most of these network requests will provide almost no value. The average typist will probably hit a key every half-second, and if
they are looking at their keyboard, they probably won’t even see the results for each of those searches. Of the seven requests they
send to the server, they will likely read the results from only one of them: the last. That means the server is doing seven times
more work than was needed.</p>

<p class="author1">What can we do to avoid sending so many wasted requests?</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Solution" class="calibre4"><div class="preface" id="idm46634409284280">
<h2 class="calibre27">Solution</h2>

<p class="author1">We’re going to <em class="calibre7">debounce</em> the network requests for the search calls. Debouncing means that we will delay sending a network request
for a very short period, say a half-second. If another request comes in while we’re waiting, we’ll forget about the first request
and then create another delayed request. In this way, we defer sending any request until we receive no new requests for half a
second.</p>

<p class="author1">To see how to do this, look at our example search hook, <em class="calibre7">useSearch.js</em>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>

<code class="kr">const</code> <code class="nx">useSearch</code> <code class="o">=</code> <code class="go">(</code><code class="nx">terms</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">data</code><code class="go">,</code> <code class="nx">setData</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">([])</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loading</code><code class="go">,</code> <code class="nx">setLoading</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">error</code><code class="go">,</code> <code class="nx">setError</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="kr">let</code> <code class="nx">didCancel</code> <code class="o">=</code> <code class="kr">false</code>
    <code class="nx">setError</code><code class="go">(</code><code class="kr">null</code><code class="go">)</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">terms</code><code class="go">)</code> <code class="go">{</code>
      <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
        <code class="kr">try</code> <code class="go">{</code>
          <code class="nx">setLoading</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
          <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'/search'</code><code class="go">,</code> <code class="go">{</code>
            <code class="nx">params</code><code class="o">:</code> <code class="go">{</code> <code class="nx">terms</code> <code class="go">},</code>
          <code class="go">})</code>
          <code class="kr">if</code> <code class="go">(</code><code class="o">!</code><code class="nx">didCancel</code><code class="go">)</code> <code class="go">{</code>
            <code class="nx">setData</code><code class="go">(</code><code class="nx">response</code><code class="go">.</code><code class="nx">data</code><code class="go">)</code>
          <code class="go">}</code>
        <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
          <code class="nx">setError</code><code class="go">(</code><code class="nx">err</code><code class="go">)</code>
        <code class="go">}</code> <code class="kr">finally</code> <code class="go">{</code>
          <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
        <code class="go">}</code>
      <code class="go">})()</code>
    <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
      <code class="nx">setData</code><code class="go">([])</code>
      <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
    <code class="go">}</code>
    <code class="kr">return</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
      <code class="nx">didCancel</code> <code class="o">=</code> <code class="kr">true</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">terms</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">{</code> <code class="nx">data</code><code class="go">,</code> <code class="nx">loading</code><code class="go">,</code> <code class="nx">error</code> <code class="go">}</code>
<code class="go">}</code>
<code class="kr">export</code> <code class="kr">default</code> <code class="nx">useSearch</code></pre>

<p class="author1">The code that sends the network request is inside the <code class="calibre21">(async ()....)()</code> block of code. We need to delay this code until we get a
half-second to spare.</p>

<p class="author1">The JavaScript function <code class="calibre21">setTimeout</code> will run the code after a delay.<a data-type="indexterm" data-primary="timeouts" id="idm46634409276472" class="calibre6"/><a data-type="indexterm" data-primary="setTimeout function" id="idm46634409275832" class="calibre6"/> This will be key to how we implement the debounce feature:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">const</code> <code class="nx">newTimer</code> <code class="o">=</code> <code class="nx">setTimeout</code><code class="go">(</code><code class="nx">SOMEFUNCTION</code><code class="go">,</code> <code class="mi">500</code><code class="go">)</code></pre>

<p class="author1">We can use the <code class="calibre21">newTimer</code> value to clear the timeout, which might mean that our function never gets called if we do it quickly
enough.<a data-type="indexterm" data-primary="useDebouncedSearch custom hook" id="idm46634409195656" class="calibre6"/> To see how we can use this to debounce the network requests, look at <em class="calibre7">useDebouncedSearch.js</em>, a debounced version of
<em class="calibre7">useSearch.js</em>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="kr">import</code> <code class="go">{</code> <code class="nx">useEffect</code><code class="go">,</code> <code class="nx">useState</code> <code class="go">}</code> <code class="nx">from</code> <code class="s">'react'</code>
<code class="kr">import</code> <code class="nx">axios</code> <code class="nx">from</code> <code class="s">'axios'</code>

<code class="kr">const</code> <code class="nx">useDebouncedSearch</code> <code class="o">=</code> <code class="go">(</code><code class="nx">terms</code><code class="go">)</code> <code class="o">=&gt;</code> <code class="go">{</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">data</code><code class="go">,</code> <code class="nx">setData</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">([])</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">loading</code><code class="go">,</code> <code class="nx">setLoading</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
  <code class="kr">const</code> <code class="go">[</code><code class="nx">error</code><code class="go">,</code> <code class="nx">setError</code><code class="go">]</code> <code class="o">=</code> <code class="nx">useState</code><code class="go">()</code>

  <code class="nx">useEffect</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
    <code class="nx">setError</code><code class="go">(</code><code class="kr">null</code><code class="go">)</code>
    <code class="kr">if</code> <code class="go">(</code><code class="nx">terms</code><code class="go">)</code> <code class="go">{</code>
      <code class="kr">const</code> <code class="nx">newTimer</code> <code class="o">=</code> <code class="nx">setTimeout</code><code class="go">(()</code> <code class="o">=&gt;</code> <code class="go">{</code>
        <code class="go">;(</code><code class="nx">async</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="go">{</code>
          <code class="kr">try</code> <code class="go">{</code>
            <code class="nx">setLoading</code><code class="go">(</code><code class="kr">true</code><code class="go">)</code>
            <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">axios</code><code class="go">.</code><code class="nx">get</code><code class="go">(</code><code class="s">'/search'</code><code class="go">,</code> <code class="go">{</code>
              <code class="nx">params</code><code class="o">:</code> <code class="go">{</code> <code class="nx">terms</code> <code class="go">},</code>
            <code class="go">})</code>
            <code class="nx">setData</code><code class="go">(</code><code class="nx">response</code><code class="go">.</code><code class="nx">data</code><code class="go">)</code>
          <code class="go">}</code> <code class="kr">catch</code> <code class="go">(</code><code class="nx">err</code><code class="go">)</code> <code class="go">{</code>
            <code class="nx">setError</code><code class="go">(</code><code class="nx">err</code><code class="go">)</code>
          <code class="go">}</code> <code class="kr">finally</code> <code class="go">{</code>
            <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
          <code class="go">}</code>
        <code class="go">})()</code>
      <code class="go">},</code> <code class="mi">500</code><code class="go">)</code>
      <code class="kr">return</code> <code class="go">()</code> <code class="o">=&gt;</code> <code class="nx">clearTimeout</code><code class="go">(</code><code class="nx">newTimer</code><code class="go">)</code>
    <code class="go">}</code> <code class="kr">else</code> <code class="go">{</code>
      <code class="nx">setData</code><code class="go">([])</code>
      <code class="nx">setLoading</code><code class="go">(</code><code class="kr">false</code><code class="go">)</code>
    <code class="go">}</code>
  <code class="go">},</code> <code class="go">[</code><code class="nx">terms</code><code class="go">])</code>

  <code class="kr">return</code> <code class="go">{</code> <code class="nx">data</code><code class="go">,</code> <code class="nx">loading</code><code class="go">,</code> <code class="nx">error</code> <code class="go">}</code>
<code class="go">}</code>

<code class="kr">export</code> <code class="kr">default</code> <code class="nx">useDebouncedSearch</code></pre>

<p class="author1">We pass the network code into the <code class="calibre21">setTimeout</code> function and then return the 
<span class="firstname">following</span>:</p>

<pre data-type="programlisting" data-code-language="jsx" class="calibre28"><code class="go">()</code> <code class="o">=&gt;</code> <code class="nx">clearTimeout</code><code class="go">(</code><code class="nx">newTimer</code><code class="go">)</code></pre>

<p class="author1">If you return a function from <code class="calibre21">useEffect</code>, this code is called just before the next time <code class="calibre21">useEffect</code> triggers, which means if the
user keeps typing quickly, we will keep deferring the network request.<a data-type="indexterm" data-primary="useEffect hook" id="idm46634408724136" class="calibre6"/> Only when the user stops typing for half a second will the
code submit a network request.</p>

<p class="author1">The original version of the <code class="calibre21">useSearch</code> hook ran a network request for every single character. With the debounced version of the
hook, typing at an average speed will result in just a single network request (see <a data-type="xref" href="#ch05_image_14" class="calibre6">Figure 5-14</a>).</p>

<figure class="calibre29"><div id="ch05_image_14" class="figure">
<img src="Images/recb_0514.png" alt="" class="calibre103"/>
<h6 class="calibre30"><span class="firstname">Figure 5-14. </span>The debounced search hook will send fewer requests</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Discussion" class="calibre4"><div class="preface" id="idm46634409283656">
<h2 class="calibre27">Discussion</h2>

<p class="author1">Debouncing requests will reduce your network traffic and the load on the server. It’s important to remember that debouncing reduces
the number of unnecessary network requests. It does <em class="calibre7">not</em> avoid the problem of network responses returning in a different order. For
more details on how to avoid the response order problem, see <a data-type="xref" href="#ch05-03" class="calibre6">“Cancel Network Requests with Tokens”</a>.</p>

<p class="author1">You can download the source for this recipe from the <a href="https://oreil.ly/5nciD" class="calibre6">GitHub site</a>.<a data-type="indexterm" data-primary="network services, connecting to" data-secondary="reducing network load with debounced requests" data-startref="ix_ntservredld" id="idm46634408712360" class="calibre6"/><a data-type="indexterm" data-primary="debounced requests, reducing network load with" data-startref="ix_debreq" id="idm46634408711016" class="calibre6"/><a data-type="indexterm" data-primary="network services, connecting to" data-startref="ix_ntserv" id="idm46634408710040" class="calibre6"/></p>
</div></section>





</div></section>







<div data-type="footnotes" class="calibre49"><p data-type="footnote" id="idm46634412810120" class="calibre50"><sup class="calibre51"><a href="ch05.xhtml#idm46634412810120-marker" class="calibre35">1</a></sup> We’re renaming it because it is no longer just a way to read a list of messages but the forum as a whole. We could eventually add functions to delete, edit, or flag messages.</p><p data-type="footnote" id="idm46634411899256" class="calibre50"><sup class="calibre51"><a href="ch05.xhtml#idm46634411899256-marker" class="calibre35">2</a></sup> See <a data-type="xref" href="ch03.xhtml#ch03-04" class="calibre6">“Measure Time with a Clock”</a>.</p><p data-type="footnote" id="idm46634411877064" class="calibre50"><sup class="calibre51"><a href="ch05.xhtml#idm46634411877064-marker" class="calibre35">3</a></sup> Compare this code with <a data-type="xref" href="#ch05-01" class="calibre6">“Convert Network Calls to Hooks”</a>, which uses <code class="calibre21">fetch</code>.</p><p data-type="footnote" id="idm46634411658232" class="calibre50"><sup class="calibre51"><a href="ch05.xhtml#idm46634411658232-marker" class="calibre35">4</a></sup> If the previous network request has completed, canceling it will have no effect.</p><p data-type="footnote" id="idm46634411249656" class="calibre50"><sup class="calibre51"><a href="ch05.xhtml#idm46634411249656-marker" class="calibre35">5</a></sup> It can also be quite confusing when you first use it. See <a data-type="xref" href="ch03.xhtml#chapter03" class="calibre6">Chapter 3</a> for more Redux recipes.</p><p data-type="footnote" id="idm46634410954808" class="calibre50"><sup class="calibre51"><a href="ch05.xhtml#idm46634410954808-marker" class="calibre35">6</a></sup> To simplify things, we are simply storing the entire object. In reality, you would want to ensure that the error contained only serializable text.</p><p data-type="footnote" id="idm46634410368616" class="calibre50"><sup class="calibre51"><a href="ch05.xhtml#idm46634410368616-marker" class="calibre35">7</a></sup> See <a data-type="xref" href="#ch05-03" class="calibre6">“Cancel Network Requests with Tokens”</a>.</p><p data-type="footnote" id="idm46634409704920" class="calibre50"><sup class="calibre51"><a href="ch05.xhtml#idm46634409704920-marker" class="calibre35">8</a></sup> This is a standard set of values for an asynchronous service. We’ve used them in other recipes in this chapter.</p><p data-type="footnote" id="idm46634409299480" class="calibre50"><sup class="calibre51"><a href="ch05.xhtml#idm46634409299480-marker" class="calibre35">9</a></sup> Much as we do with HTTP network calls in <a data-type="xref" href="#ch05-02" class="calibre6">“Refresh Automatically with State Counters”</a>.</p></div></div></section></div></body></html>