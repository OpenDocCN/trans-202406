<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 17. Make a Connection: Networking and Threads"><div class="chapter" id="make_a_connection_networking_and_threads">
<h1><span class="label">Chapter 17. </span>Make a Connection: Networking and Threads</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0587-01.png" alt="image" width="446" height="574"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="channels, client and server networking" id="idm46038387850800"/><a data-type="indexterm" data-primary="I/O" data-secondary="networking" data-see="networking" id="idm46038387849904"/><a data-type="indexterm" data-primary="networking" id="idm46038387848688"/><a data-type="indexterm" data-primary="networking" data-secondary="channels" data-see="channels" id="idm46038387847952"/><strong>Connect with the outside world.</strong> Your Java program can talk to a program on another machine. It’s easy. All the low-level networking details are taken care of by the built-in Java libraries. One of Java’s big benefits is that sending and receiving data over a network can be just I/O with a slightly different connection at the end of the I/O chain. In this chapter we’ll connect to the outside world with <em>channels</em>. We’ll make <em>client</em> channels. We’ll make <em>server</em> channels. We’ll make <em>clients</em> and <em>servers</em>, and we’ll make them talk to each other. And we’ll also have to learn how to do more than one thing at once. Before the chapter’s done, you’ll have a fully functional, multithreaded chat client. Did we just say <em>multithreaded</em>? Yes, now you <em>will</em> learn the secret of how to talk to Bob while simultaneously listening to Suzy.</p>
<section data-type="sect1" data-pdf-bookmark="Real-time BeatBox chat"><div class="sect1" id="real-time_beatbox_chat">
<h1>Real-time BeatBox chat</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0588-01.png" alt="image" width="1017" height="635"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img src="Images/f0588-02.png" alt="image" width="579" height="561"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="BeatBox app" data-secondary="Chat client and server" id="idm46038387834992"/><a data-type="indexterm" data-primary="Chat client app" id="idm46038387833824"/><a data-type="indexterm" data-primary="Chat server app" id="idm46038387832992"/><a data-type="indexterm" data-primary="client application, networking" id="idm46038387832160"/>You’re working on a computer game. You and your team are doing the sound design for each part of the game. Using a “chat” version of the BeatBox, your team can collaborate—you can send a beat pattern along with your chat message, and everybody in the BeatBox Chat gets it. So you don’t just get to <em>read</em> the other participants’ messages; you get to load and <em>play</em> a beat pattern simply by clicking the message in the incoming messages area.</p>
<p>In this chapter we’re going to learn what it takes to make a chat client like this. We’re even going to learn a little about making a chat <em>server</em>. We’ll save the full BeatBox Chat for the Code Kitchen, but in this chapter you <em>will</em> write a Ludicrously Simple Chat Client and Very Simple Chat Server that send and receive text messages.</p>
<p><a data-type="indexterm" data-primary="client-server relationship" id="idm46038387822976"/><a data-type="indexterm" data-primary="networking" data-secondary="client-server relationship" id="idm46038387822464"/><a data-type="indexterm" data-primary="server-client relationship" id="idm46038387823872"/><strong>Chat program overview</strong></p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#646466;">Each Client has to know about the Server.</span></p>
<p><span style="color:#646466;">The Server has to know about ALL the Clients.</span></p>
</div>
<figure class="informal"><div class="figure">
<img src="Images/f0589-01.png" alt="image" width="541" height="463"/>
<h6/>
</div></figure>
<p><strong>How it works:</strong></p>
<ul style="list-style-type:none">
<li><p><span class="inlineimage"><img src="Images/1circle.png" alt="Images" width="20" height="20"/></span> Client connects to the server</p>
<figure class="informal"><div class="figure">
<img src="Images/f0589-02.png" alt="image" width="539" height="120"/>
<h6/>
</div></figure></li>
<li><p><span class="inlineimage"><img src="Images/2circle.png" alt="Images" width="23" height="23"/></span> The server makes a connection and adds the client to the list of participants</p>
<figure class="informal"><div class="figure">
<img src="Images/f0589-03.png" alt="image" width="536" height="118"/>
<h6/>
</div></figure></li>
<li><p><span class="inlineimage"><img src="Images/3circle.png" alt="Images" width="23" height="23"/></span> Another client connects</p>
<figure class="informal"><div class="figure">
<img src="Images/f0589-04.png" alt="image" width="537" height="122"/>
<h6/>
</div></figure></li>
<li><p><span class="inlineimage"><img src="Images/4circle.png" alt="Images" width="20" height="19"/></span> Client A sends a message to the chat service</p>
<figure class="informal"><div class="figure">
<img src="Images/f0589-05.png" alt="image" width="541" height="119"/>
<h6/>
</div></figure></li>
<li><p><span class="inlineimage"><img src="Images/5circle.png" alt="Images" width="20" height="19"/></span> The server distributes the message to ALL participants (including the original sender)</p>
<figure class="informal"><div class="figure">
<img src="Images/f0589-06.png" alt="image" width="539" height="150"/>
<h6/>
</div></figure></li>
</ul>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Connecting, sending, and receiving"><div class="sect1" id="connectingcomma_sendingcomma_and_receivi">
<h1>Connecting, sending, and receiving</h1>
<p>The three things we have to learn to get the client working are:</p>
<ol>
<li><p>How to establish the initial <strong>connection</strong> between the client and server</p></li>
<li><p>How to <strong>receive</strong> messages <em>from</em> the server</p></li>
<li><p>How to <strong>send</strong> messages <em>to</em> the server</p></li>
</ol>
<p>There’s a lot of low-level stuff that has to happen for these things to work. But we’re lucky, because the Java APIs make it a piece of cake for programmers. You’ll see a lot more GUI code than networking and I/O code in this chapter.</p>
<p>And that’s not all.</p>
<p>Lurking within the simple chat client is a problem we haven’t faced so far in this book: doing two things at the same time. Establishing a connection is a one-time operation (that either works or fails). But after that, a chat participant wants to <em>send outgoing messages</em> and <strong>simultaneously</strong> <em>receive incoming messages</em> from the other participants (via the server). Hmm...that one’s going to take a little thought, but we’ll get there in just a few pages.</p>
<ul style="list-style-type:none">
<li><p><span class="inlineimage"><img src="Images/1circle.png" alt="Images" width="20" height="20"/></span> <strong>Connect</strong></p>
<p>Client <strong>connects</strong> to the server</p>
<figure class="informal"><div class="figure">
<img src="Images/f0590-01.png" alt="image" width="528" height="121"/>
<h6/>
</div></figure></li>
<li><p><span class="inlineimage"><img src="Images/2circle.png" alt="Images" width="23" height="23"/></span> <strong>Receive</strong></p>
<p>Client <strong>reads</strong> a message from the server</p>
<figure class="informal"><div class="figure">
<img src="Images/f0590-02.png" alt="image" width="533" height="121"/>
<h6/>
</div></figure></li>
<li><p><span class="inlineimage"><img src="Images/3circle.png" alt="Images" width="23" height="23"/></span> <strong>Send</strong></p>
<p>Client <strong>writes</strong> a message to the server</p>
<figure class="informal"><div class="figure">
<img src="Images/f0590-03.png" alt="image" width="532" height="121"/>
<h6/>
</div></figure></li>
</ul>
</div></section>
<section data-type="sect1" data-pdf-bookmark="1. Connect"><div class="sect1" id="dot_connect">
<h1>1. Connect</h1>
<p><a data-type="indexterm" data-primary="channels, client and server networking" data-secondary="SocketChannel" id="idm46038387771600"/><a data-type="indexterm" data-primary="connection, client-server" id="idm46038387770400"/><a data-type="indexterm" data-primary="InetSocketAddress" id="idm46038387769600"/><a data-type="indexterm" data-primary="SocketChannel" id="idm46038387768768"/>To talk to another machine, we need an object that represents a network connection between two machines. We can open a java.nio.channels.SocketChannel to give us this connection object.</p>
<p>What’s a connection? A <em>relationship</em> between two machines, where <strong>two pieces of software know about each other</strong>. Most importantly, those two pieces of software know how to <em>communicate</em> with each other. In other words, how to send <em>bits</em> to each other.</p>
<p>We don’t care about the low-level details, thankfully, because they’re handled at a much lower place in the “networking stack.” If you don’t know what the “networking stack” is, don’t worry about it. It’s just a way of looking at the layers that information (bits) must travel through to get from a Java program running in a JVM on some OS, to physical hardware (Ethernet cables, for example), and back again on some other machine.</p>
<p>The part that you have to worry about is high-level. You just have to create an object for the server’s address and then open a channel to that server. Ready?</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#646466;">To make a connection, you need to know <u>two</u> things about the server: where it is and which port it’s running on.</span></p>
<p><span style="color:#646466;">In other words,</span></p>
</div>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong>IP address and TCP port number.</strong></p>
</div>
<figure class="informal"><div class="figure">
<img src="Images/f0591-01.png" alt="image" width="1021" height="563"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#646466;">A connection means the two machines have information about each other, including network location (IP address) and TCP port.</span></p>
</div>
<blockquote><strong>A TCP port is just a number... a 16-bit number that identifies a specific program on the server</strong></blockquote>
<p>Your internet web (HTTP) server runs on port 80. That’s a standard. If you’ve got a Telnet server, its running on port 23. FTP? 20. POP3 mail server? 110. SMTP? 25. The Time server sits at 37. Think of port numbers as unique identifiers. They represent a logical connection to a particular piece of software running on the server. That’s it. You can’t spin your hardware box around and find a TCP port. For one thing, you have 65,536 of them on a server (0–65535). So they obviously don’t represent a place to plug in physical devices. They’re just a number representing an application.</p>
<p>Well-known TCP port numbers for common server applications:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0592-01.png" alt="image" width="293" height="339"/>
<h6/>
</div></figure>
<p>Without port numbers, the server would have no way of knowing which application a client wanted to connect to. And since each application might have its own unique protocol, think of the trouble you’d have without these identifiers. What if your web browser, for example, landed at the POP3 mail server instead of the HTTP server? The mail server won’t know how to parse an HTTP request! And even if it did, the POP3 server doesn’t know anything about servicing the HTTP request.</p>
<p>When you write a server program, you’ll include code that tells the program which port number you want it to run on (you’ll see how to do this in Java a little later in this chapter). In the Chat program we’re writing in this chapter, we picked 5000. Just because we wanted to. And because it met the criteria that it be a number between 1024 and 65535. Why 1024? Because 0 through 1023 are reserved for the well-known services like the ones we just talked about.</p>
<p>And if you’re writing services (server programs) to run on a company network, you should check with the sysadmins to find out which ports are already taken. Your sysadmins might tell you, for example, that you can’t use any port number below, say, 3000. In any case, if you value your limbs, you won’t assign port numbers with abandon. Unless it’s your <em>home</em> network. In which case you just have to check with your <em>kids</em>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#646466;">The TCP port numbers from 0 to 1023 are reserved for well-known services. Don’t use them for your own server programs!*</span></p>
<p><span style="color:#646466;">The chat server we’re writing uses port 5000. We just picked a number between 1024 and 65535.</span></p>
</div>
<p>*Well, you <em>might</em> be able to use one of these, but the sysadmin where you work will write you a strongly worded message and CC your boss.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-id00046">
<h5>there are no Dumb Questions</h5>
<p><a data-type="indexterm" data-primary="BindException" id="idm46038387703632"/><a data-type="indexterm" data-primary="exceptions" id="idm46038387703120"/><a data-type="indexterm" data-primary="exceptions" data-secondary="BindException" id="idm46038387702608"/><strong>Q: How do you know the port number of the server program you want to talk to?</strong></p>
<p><strong>A:</strong> That depends on whether the program is one of the well-known services. If you’re trying to connect to a well-known service, like the ones on the opposite page (HTTP, SMTP, FTP, etc.), you can look these up on the internet (Google “Well-Known TCP Port”). Or ask your friendly neighborhood sysadmin.</p>
<p>But if the program isn’t one of the well-known services, you need to find out from whoever is deploying the service. Ask them. Typically, if someone writes a network service and wants others to write clients for it, they’ll publish the IP address, port number, and protocol for the service. For example, if you want to write a client for a GO game server, you can visit one of the GO server sites and find information about how to write a client for that particular server.</p>
<p><strong>Q: Can there ever be more than one program running on a single port? In other words, can two applications on the same server have the same port number?</strong></p>
<p><strong>A:</strong> No! If you try to bind a program to a port that is already in use, you’ll get a BindException. To <em>bind</em> a program to a port just means starting up a server application and telling it to run on a particular port. Again, you’ll learn more about this when we get to the server part of this chapter.</p>
</div></aside>
<figure class="informal"><div class="figure">
<img src="Images/f0593-01.png" alt="image" width="620" height="514"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="brain_barbell-id00007">
<h5>Brain Barbell</h5>
<figure class="informal"><div class="figure">
<img src="Images/barbell.png" alt="image" width="163" height="95"/>
<h6/>
</div></figure>
<p>OK, you got a connection. The client and the server know the IP address and TCP port number for each other. Now what? How do you communicate over that connection? In other words, how do you move bits from one to the other? Imagine the kinds of messages your chat client needs to send and receive.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0593-03.png" alt="image" width="478" height="144"/>
<h6/>
</div></figure>
</div></aside>
</div></section>
<section data-type="sect1" data-pdf-bookmark="2. Receive"><div class="sect1" id="dot_receive">
<h1>2. Receive</h1>
<p><a data-type="indexterm" data-primary="BufferedReader" id="idm46038387733136"/><a data-type="indexterm" data-primary="channels, client and server networking" data-secondary="reading/receiving with" id="idm46038387732288"/><a data-type="indexterm" data-primary="channels, client and server networking" data-secondary="SocketChannel" id="idm46038387689872"/><a data-type="indexterm" data-primary="Reader" id="idm46038387689008"/><a data-type="indexterm" data-primary="SocketAddress" id="idm46038387688272"/><a data-type="indexterm" data-primary="SocketChannel" id="idm46038387687536"/><a data-type="indexterm" data-primary="streams (I/O)" data-secondary="receiving messages" id="idm46038387686800"/>To communicate over a remote connection, you can use regular old I/O streams, just like we used in the previous chapter. One of the coolest features in Java is that most of your I/O work won’t care what your high-level chain stream is actually connected to. In other words, you can use a <strong>BufferedReader</strong> just like you did when you were reading from a file; the difference is that the underlying connection stream is connected to a <em>Channel</em> rather than a <em>File</em>!</p>
<figure class="informal"><div class="figure">
<img src="Images/f0594-01.png" alt="image" width="327" height="197"/>
<h6/>
</div></figure>
<section data-type="sect2" data-pdf-bookmark="Reading from the network with BufferedReader"><div class="sect2" id="reading_from_the_network_with_bufferedre">
<h2>Reading from the network with BufferedReader</h2>
<figure class="informal"><div class="figure">
<img src="Images/f0594-02.png" alt="image" width="1470" height="1075"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img src="Images/f0594-03.png" alt="image" width="1493" height="278"/>
<h6/>
</div></figure>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="3. Send"><div class="sect1" id="dot_send">
<h1>3. Send</h1>
<p><a data-type="indexterm" data-primary="channels, client and server networking" data-secondary="SocketChannel" id="idm46038387678768"/><a data-type="indexterm" data-primary="print()" id="idm46038387677792"/><a data-type="indexterm" data-primary="println()" id="idm46038387677056"/><a data-type="indexterm" data-primary="PrintWriter" id="idm46038387676288"/><a data-type="indexterm" data-primary="SocketAddress" id="idm46038387675456"/><a data-type="indexterm" data-primary="SocketChannel" id="idm46038387674624"/><a data-type="indexterm" data-primary="Writer" id="idm46038387673792"/>In the previous chapter, we used BufferedWriter. We have a choice here, but when you’re writing one String at a time, <strong>PrintWriter</strong> is a standard choice. And you’ll recognize the two key methods in PrintWriter, print() and println()! Just like good ol’ System.out.</p>
<section data-type="sect2" data-pdf-bookmark="Writing to the network with PrintWriter"><div class="sect2" id="writing_to_the_network_with_printwriter">
<h2>Writing to the network with PrintWriter</h2>
<figure class="informal"><div class="figure">
<img src="Images/f0595-01.png" alt="image" width="1200" height="1122"/>
<h6/>
</div></figure>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="There’s more than one way to make a connection"><div class="sect1" id="thereapostrophes_more_than_one_way_to_ma">
<h1>There’s more than one way to make a connection</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0596-01.png" alt="image" width="497" height="428"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="channels, client and server networking" data-secondary="SocketChannel" id="idm46038387665184"/><a data-type="indexterm" data-primary="InputStreamReader" id="idm46038387663824"/><a data-type="indexterm" data-primary="OutputStream" id="idm46038387662992"/><a data-type="indexterm" data-primary="PrintWriter" id="idm46038387662160"/><a data-type="indexterm" data-primary="Socket" id="idm46038387661328"/><a data-type="indexterm" data-primary="streams (I/O)" data-secondary="socket connections" id="idm46038387660496"/>If you look at real life code that talks to a remote machine, you’ll probably see a number of different ways to make connections and to read from and write to a remote computer.</p>
<p>Which approach you use depends on a number of things, including (but not limited to) the version of Java you’re using and the needs of the application (for example, how many clients connect at once, the size of messages sent, frequency or message, etc). One of the simplest approaches is to use a <strong>java.net.Socket</strong> instead of a Channel.</p>
<section data-type="sect2" data-pdf-bookmark="Using a Socket"><div class="sect2" id="using_a_socket">
<h2>Using a Socket</h2>
<p>You can get an <em>InputStream</em> or <em>OutputStream</em> from a Socket, and read and write from it in a very similar way to what we’ve already seen.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0596-02.png" alt="image" width="948" height="477"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#646466;">The java.net.Socket class is available in all versions of Java.</span></p>
<p><span style="color:#646466;">It supports simple network I/O via the I/O streams we’ve already used for file I/O.</span></p>
</div>
<figure class="informal"><div class="figure">
<img src="Images/f0597-01.png" alt="image" width="530" height="522"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="Friesen, Jeff" id="idm46038387656832"/><a data-type="indexterm" data-primary="Friesen, Jeff" data-secondary="Java I/O, NIO and NIO.2" id="idm46038387656064"/><a data-type="indexterm" data-primary="Hitchens, Ron" id="idm46038387654960"/><a data-type="indexterm" data-primary="Hitchens, Ron" data-secondary="Java NIO" id="idm46038387654128"/><a data-type="indexterm" data-primary="Java I/O, NIO and NIO.2 (Friesen)" id="idm46038387653024"/><a data-type="indexterm" data-primary="java.nio.channels package" id="idm46038387652224"/><a data-type="indexterm" data-primary="Java NIO (Hitchens)" id="idm46038387651424"/><a data-type="indexterm" data-primary="NIO.2" id="idm46038387650592"/><strong>As we’ve become an increasingly connected world, Java has evolved to offer more ways to work with remote machines.</strong></p>
<p>Remember that Channels are in the java.<strong>nio</strong>.channels package? The java.nio package (NIO) was introduced in Java 1.4, and there were more changes and additions made (sometimes called NIO.2) in Java 7.</p>
<p>There are ways to use Channels and NIO to get better performance when you’re working with lots of network connections, or lots of data coming over those connections.</p>
<p><strong>In this chapter, we’re using Channels to provide the same very basic connection functionality we could get from Sockets</strong>. However, if our application needed to work well with a very busy network connection (or lots of them!), we could configure our Channels differently and use them to their full potential, and our program would cope better with a high network I/O load.</p>
<p>We’ve chosen to teach you the <strong>simplest way to get started</strong> with network I/O using <em>Channels</em> so that if you need to “level up” to working with more advanced features, it shouldn’t be such a big step.</p>
<p>If you do want to learn more about NIO, read <em>Java NIO</em> by Ron Hitchens and <em>Java I/O, NIO and NIO.2</em> by Jeff Friesen.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id00000050">
<h5>Relax</h5>
<figure class="informal"><div class="figure">
<img src="Images/cup.png" alt="image" width="70" height="106"/>
<h6/>
</div></figure>
<p><strong>Channels support advanced networking features that you don’t need for these exercises.</strong></p>
<p>Channels can support nonblocking I/O, reading and writing via ByteBuffers, and asynchronous I/O. We’re not going to show you any of this! But at least now you have some keywords to put into your search engine when you want to know more.</p>
</div></aside>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="The DailyAdviceClient"><div class="sect1" id="the_dailyadviceclient">
<h1>The DailyAdviceClient</h1>
<p><a data-type="indexterm" data-primary="Advice Guy" id="idm46038387790112"/>Before we start building the Chat app, let’s start with something a little smaller. The Advice Guy is a server program that offers up practical, inspirational tips to get you through those long days of coding.</p>
<p>We’re building a client for The Advice Guy program, which pulls a message from the server each time it connects.</p>
<p>What are you waiting for? Who <em>knows</em> what opportunities you’ve missed without this app.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0598-01.png" alt="image" width="596" height="538"/>
<h6><span class="label">Figure 17-1. </span><span style="color:#646466;">The Advice Guy</span></h6>
</div></figure>
<ul style="list-style-type:none">
<li><p><span class="inlineimage"><img src="Images/1circle.png" alt="Images" width="20" height="20"/></span> <strong>Connect</strong></p>
<p>Client connects to the server</p>
<figure class="informal"><div class="figure">
<img src="Images/f0598-02.png" alt="image" width="635" height="144"/>
<h6/>
</div></figure></li>
<li><p><span class="inlineimage"><img src="Images/2circle.png" alt="Images" width="23" height="23"/></span> <strong>Read</strong></p>
<p>Client gets a Reader for the Channel, and reads a message from the server</p>
<figure class="informal"><div class="figure">
<img src="Images/f0598-03.png" alt="image" width="609" height="144"/>
<h6/>
</div></figure></li>
</ul>
</div></section>
<section data-type="sect1" data-pdf-bookmark="DailyAdviceClient code"><div class="sect1" id="dailyadviceclient_code">
<h1>DailyAdviceClient code</h1>
<p>This program makes a SocketChannel, makes a BufferedReader (with the help of the channel’s Reader), and reads a single line from the server application (whatever is running at port 5000).</p>
<figure class="informal"><div class="figure">
<img src="Images/f0599-01.png" alt="image" width="994" height="906"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sharpen_your_pencil-id00043">
<h5>Sharpen your pencil</h5>
<figure class="informal"><div class="figure">
<img src="Images/pencil.png" alt="image" width="122" height="80"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="exercises" data-secondary="Sharpen Your Pencil" id="idm46038387624912"/><span class="inlineimage"><img src="Images/arr.png" alt="Images" width="60" height="12"/></span> <strong>Yours to solve.</strong></p>
<p>Test your memory of the classes for reading and writing from a SocketChannel. Try not to look at the opposite page!</p>
<p>To <strong><em>read</em></strong> text from a SocketChannel:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0600-01.png" alt="image" width="997" height="165"/>
<h6/>
</div></figure>
<p>To <strong><em>send</em></strong> text to a SocketChannel:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0600-02.png" alt="image" width="995" height="168"/>
<h6/>
</div></figure>
</div></aside>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="sharpen_your_pencil-id00044">
<h5>Sharpen your pencil</h5>
<figure class="informal"><div class="figure">
<img src="Images/pencil.png" alt="image" width="122" height="80"/>
<h6/>
</div></figure>
<p><span class="inlineimage"><img src="Images/arr.png" alt="Images" width="60" height="12"/></span> <strong>Yours to solve.</strong></p>
<p><strong>Fill in the blanks:</strong></p>
<p>What two pieces of information does the client need in order to make a connection with a server?</p>
<p>_________________________________      _________________________________</p>
<p>Which TCP port numbers are reserved for “well-known services” like HTTP and FTP? ______________________</p>
<p>TRUE or FALSE: The range of valid TCP port numbers can be represented by a short primitive. ___________________________</p>
</div></aside>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Writing a simple server application"><div class="sect1" id="writing_a_simple_server_application">
<h1>Writing a simple server application</h1>
<p><a data-type="indexterm" data-primary="accept()" id="idm46038387606032"/><a data-type="indexterm" data-primary="server application, networking" id="idm46038387605136"/><a data-type="indexterm" data-primary="server, socket" id="idm46038387604624"/><a data-type="indexterm" data-primary="ServerSocketChannel" id="idm46038387603904"/><a data-type="indexterm" data-primary="SocketChannel" id="idm46038387603072"/>So what’s it take to write a server application? Just a couple of Channels. Yes, a couple as in two. A ServerSocketChannel, which waits for client requests (when a client connects) and a SocketChannel to use for communication with the client. If there’s more than one client, we’ll need more than one channel, but we’ll get to that later.</p>
<p><strong>How it works:</strong></p>
<ul style="list-style-type:none">
<li><p><span class="inlineimage"><img src="Images/1circle.png" alt="Images" width="20" height="20"/></span> Server application makes a ServerSocketChannel and binds it to a specific port</p>
<pre data-type="programlisting"><strong>ServerSocketChannel serverChannel = ServerSocketChannel.open();</strong>
<strong>serverChannel.bind(new InetSocketAddress(5000));</strong></pre>
<p>This starts the server application listening for client requests coming in for port 5000.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0601-01.png" alt="image" width="434" height="181"/>
<h6/>
</div></figure></li>
<li><p><span class="inlineimage"><img src="Images/2circle.png" alt="Images" width="23" height="23"/></span> Client makes a SocketChannel connected to the server application</p>
<p><code><strong>SocketChannel svr = SocketChannel.open(new InetSocketAddress("190.165.1.103", 5000));</strong></code></p>
<p>Client knows the IP address and port number (published or given to them by whomever configures the server app to be on that port).</p>
<figure class="informal"><div class="figure">
<img src="Images/f0601-02.png" alt="image" width="435" height="170"/>
<h6/>
</div></figure></li>
<li><p><span class="inlineimage"><img src="Images/3circle.png" alt="Images" width="23" height="23"/></span> Server makes a new SocketChannel to communicate with this client</p>
<p><code><strong>SocketChannel clientChannel = serverChannel.accept();</strong></code></p>
<p>The accept() method blocks (just sits there) while it’s waiting for a client connection. When a client finally connects, the method returns a SocketChannel that knows how to communicate with this client.</p>
<p>The ServerSocketChannel can go back to waiting for other clients. The server has just one ServerSocketChannel, and a SocketChannel <u>per client</u>.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0601-03.png" alt="image" width="434" height="208"/>
<h6/>
</div></figure></li>
</ul>
</div></section>
<section data-type="sect1" data-pdf-bookmark="DailyAdviceServer code"><div class="sect1" id="dailyadviceserver_code">
<h1>DailyAdviceServer code</h1>
<p><a data-type="indexterm" data-primary="DailyAdviceServer" id="idm46038389605824"/><a data-type="indexterm" data-primary="PrintWriter" id="idm46038387584928"/>This program makes a ServerSocketChannel and waits for client requests. When it gets a client request (i.e., client created a new SocketChannel to this server), the server makes a new SocketChannel to that client. The server makes a PrintWriter (using a Writer created from the SocketChannel) and sends a message to the client.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0602-01.png" alt="image" width="994" height="1027"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="brain_barbell-id00008">
<h5>Brain Barbell</h5>
<figure class="informal"><div class="figure">
<img src="Images/barbell.png" alt="image" width="163" height="95"/>
<h6/>
</div></figure>
<p>How does the server know how to communicate with the client?</p>
<p>Think about how/when/where the server gets knowledge about the client.</p>
</div></aside>
<p/>
<figure class="informal"><div class="figure"><img src="Images/f0603-01.png" alt="image" width="462" height="636"/>
<h6/>
</div></figure>
<p>Yes, that’s right, <strong>the server can’t accept a request from a client until it has finished with the current client.</strong> At which point, it starts the next iteration of the infinite loop, sitting, waiting, at the accept() call until a new request comes in, at which point it makes a SocketChannel to send data to the new client and starts the process over again.</p>
<p>To get this to work with multiple clients <em>at the same time</em>, we need to use separate threads.</p>
<p>We’d give each new client’s SocketChannel to a new thread, and each thread can work independently.</p>
<p>We’re just about to learn how to do that!</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="bullet_points-id00017">
<h5>Bullet Points</h5>
<ul style="list-style-type:none">
<li><p>Client and server applications communicate using Channels.</p></li>
<li><p>A Channel represents a connection between two applications that may (or may not) be running on two different physical machines.</p></li>
<li><p>A client must know the IP address (or host name) and TCP port number of the server application.</p></li>
<li><p>A TCP port is a 16-bit unsigned number assigned to a specific server application. TCP port numbers allow different server applications to run on the same machine; clients connect to a specific application using its port number.</p></li>
<li><p>The port numbers from 0 through 1023 are reserved for “well-known services” including HTTP, FTP, SMTP, etc.</p></li>
<li><p>A client connects to a server by opening a SocketChannel:</p>
<pre data-type="programlisting"><strong>SocketChannel.open</strong>
 <strong>(new InetSocketAddress("127.0.0.1", 4200))</strong></pre></li>
<li><p>Once connected, a client can create readers (to read data from the server) and writers (to send data to the server) for the channel:</p>
<pre data-type="programlisting"><strong>Reader reader = Channels.newReader(sockCh,</strong>
 <strong>StandardCharsets.UTF_8);</strong>
<strong>Writer writer = Channels.newWriter(sockCh,</strong>
 <strong>StandardCharsets.UTF_8);</strong></pre></li>
<li><p>To read text data from the server, create a BufferedReader, chained to the Reader. The Reader is a “bridge” that takes in bytes and converts them to text (character) data. It’s used primarily to act as the middle chain between the high-level BufferedReader and the low-level connection.</p></li>
<li><p>To write text data to the server, create a PrintWriter chained to the Writer. Call the print() or println() methods to send Strings to the server.</p></li>
<li><p>Servers use a ServerSocketChannel that waits for client requests on a particular port number.</p></li>
<li><p>When a ServerSocketChannel gets a request, it “accepts” the request by making a SocketChannel for the client.</p></li>
</ul>
</div></aside>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Writing a Chat Client"><div class="sect1" id="writing_a_chat_client">
<h1>Writing a Chat Client</h1>
<p><a data-type="indexterm" data-primary="Chat client app" id="idm46038388043056"/><a data-type="indexterm" data-primary="client application, networking" id="idm46038387558816"/><a data-type="indexterm" data-primary="networking" data-secondary="simple Chat client app" id="idm46038387549504"/>We’ll write the Chat Client application in two stages. First we’ll make a send-only version that sends messages to the server but doesn’t get to read any of the messages from other participants (an exciting and mysterious twist to the whole chat room concept).</p>
<p>Then we’ll go for the full chat monty and make one that both sends <em>and</em> receives chat messages.</p>
<p><strong>Version One: send-only</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0604-01.png" alt="image" width="855" height="247"/>
<h6/>
</div></figure>
<p><strong>Code outline</strong></p>
<p>Here’s an outline of the main functionality the chat client needs to provide. The full code is on the next page.</p>
<pre data-type="programlisting">public class <strong>SimpleChatClientA</strong> {
  private JTextField outgoing;
  private PrintWriter writer;

  public void <strong>go()</strong> {
     // call the setUpNetworking() method     
     // make gui and register a listener with the send button
  }

  private void <strong>setUpNetworking()</strong> {
    // open a SocketChannel to the server
    // make a PrintWriter and assign to writer instance variable
  } 

  private void sendMessage() {
    // get the text from the text field and
    // send it to the server using the writer (a PrintWriter)
  }
}</pre>
<p/>
<figure class="informal"><div class="figure"><img src="Images/f0605-01.png" alt="image" width="998" height="1181"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id00000051">
<p><strong>If you want to try this now, type in the Ready-bake chat server code listed on the next page.</strong></p>
<p><strong>First, start the server in one terminal. Next, use another terminal to start this client.</strong></p>
</div></aside>
</div></section>
<section data-type="sect1" data-pdf-bookmark="The really, really simple Chat Server"><div class="sect1" id="the_reallycomma_really_simple_chat_serve">
<h1>The really, really simple Chat Server</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0606-01.png" alt="image" width="258" height="106"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="Chat server app" id="idm46038387533008"/><a data-type="indexterm" data-primary="networking" data-secondary="simple Chat server app" id="idm46038387532208"/><a data-type="indexterm" data-primary="Ready-Bake Code" data-secondary="simple Chat server" id="idm46038387531104"/>You can use this server code for all versions of the Chat Client. Every possible disclaimer ever disclaimed is in effect here. To keep the code stripped down to the bare essentials, we took out a lot of parts that you’d need to make this a real server. In other words, it works, but there are at least a hundred ways to break it. If you want to really sharpen your skills after you’ve finished this book, come back and make this server code more robust.</p>
<p>After you finish this chapter, you should be able to annotate this code yourself. You’ll understand it much better if <em>you</em> work out what’s happening than if we explained it to you. Then again, this is Ready-Bake Code, so you really don’t have to understand it at all. It’s here just to support the two versions of the Chat Client.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id00000052">
<p><strong>To run the Chat Client, you need two terminals. First, launch this server from one terminal, and then launch the client from another terminal.</strong></p>
</div></aside>
<pre data-type="programlisting">import java.io.*;
import java.net.InetSocketAddress;
import java.nio.channels.*;
import java.util.*;
import java.util.concurrent.*;

import static java.nio.charset.StandardCharsets.UTF_8;

public class SimpleChatServer {
  private final List&lt;PrintWriter&gt; clientWriters = new ArrayList&lt;&gt;();

  public static void main(String[] args) {
    new SimpleChatServer().go();
  }

  public void go() {
    ExecutorService threadPool = Executors.newCachedThreadPool();
    try {
      ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
      serverSocketChannel.bind(new InetSocketAddress(5000));

      while (serverSocketChannel.isOpen()) {
        SocketChannel clientSocket = serverSocketChannel.accept();
        PrintWriter writer = new PrintWriter(Channels.newWriter(clientSocket, UTF_8));
        clientWriters.add(writer);
        threadPool.submit(new ClientHandler(clientSocket));
        System.out.println("got a connection");
      }
    } catch (IOException ex) {
      ex.printStackTrace();
    }
  }

  private void tellEveryone(String message) {
    for (PrintWriter writer : clientWriters) {
      writer.println(message);
      writer.flush();
    }
  }

  public class ClientHandler implements Runnable {
    BufferedReader reader;
    SocketChannel socket;

    public ClientHandler(SocketChannel clientSocket) {
      socket = clientSocket;
      reader = new BufferedReader(Channels.newReader(socket, UTF_8));
    }

    public void run() {
      String message;
      try {
        while ((message = reader.readLine()) != null) {
          System.out.println("read " + message);
          tellEveryone(message);
      }
    } catch (IOException ex) {
      ex.printStackTrace();
    }
  }
 }
}</pre>
<figure class="informal"><div class="figure">
<img src="Images/f0607-01.png" alt="image" width="1031" height="458"/>
<h6/>
</div></figure>
<p><strong>Version Two: send and receive</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0608-01.png" alt="image" width="893" height="496"/>
<h6/>
</div></figure>
<p><strong>Big Question: <em>HOW</em> do you get messages from the server?</strong></p>
<p>Should be easy; when you set up the networking, make a Reader as well. Then read messages using <code><strong>readLine</strong></code>.</p>
<p><strong>Bigger Question: <em>WHEN</em> do you get messages from the server?</strong></p>
<p>Think about that. What are the options?</p>
<ul style="list-style-type:none">
<li><p><span class="inlineimage"><img src="Images/1.png" alt="Images" width="20" height="21"/></span> <strong>Option One: Read something in from the server each time the user sends a message.</strong></p>
<p><strong>Pros:</strong> Doable, very easy.</p>
<p><strong>Cons:</strong> Stupid. Why choose such an arbitrary time to check for messages? What if a user is a lurker and doesn’t send anything?</p></li>
<li><p><span class="inlineimage"><img src="Images/2.png" alt="Images" width="20" height="21"/></span> <strong>Option Two: Poll the server every 20 seconds.</strong></p>
<p><strong>Pros:</strong> It’s doable, and it fixes the lurker problem.</p>
<p><strong>Cons:</strong> How does the server know what you’ve seen and what you haven’t? The server would have to store the messages, rather than just doing a distribute-and-forget each time it gets one. And why 20 seconds? A delay like this affects usability, but as you reduce the delay, you risk hitting your server needlessly. Inefficient.</p></li>
<li><p><span class="inlineimage"><img src="Images/3.png" alt="Images" width="20" height="21"/></span> <strong>Option Three: Read messages as soon as they’re sent from the server.</strong></p>
<p><strong>Pros:</strong> Most efficient, best usability.</p>
<p><strong>Cons:</strong> How do you do two things at the same time? Where would you put this code? You’d need a loop somewhere that was always waiting to read from the server. But where would that go? Once you launch the GUI, nothing happens until an event is fired by a GUI component.</p></li>
</ul>
<figure class="informal"><div class="figure">
<img src="Images/f0609-01.png" alt="image" width="345" height="428"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="classes" data-secondary="Thread" id="idm46038387497552"/><a data-type="indexterm" data-primary="multithreading" data-seealso="concurrency" id="idm46038387496576"/><a data-type="indexterm" data-primary="Thread class" id="idm46038387495600"/><a data-type="indexterm" data-primary="thread of execution" id="idm46038387494768"/><a data-type="indexterm" data-primary="threads" data-see="multithreading" id="idm46038387493936"/><span style="color:#646466;">In Java you really CAN walk and chew gum at the same time.</span></p>
</div>
<p><strong>You know by now that we’re going with option three</strong></p>
<p>We want something to run continuously, checking for messages from the server, but <em>without interrupting the user’s ability to interact with the GUI!</em> So while the user is happily typing new messages or scrolling through the incoming messages, we want something <em>behind the scenes</em> to keep reading in new input from the server.</p>
<p>That means we finally need a new thread. A new, separate stack.</p>
<p>We want everything we did in the Send-Only version (version one) to work the same way, while a new <em>process</em> runs alongside that reads information from the server and displays it in the incoming text area.</p>
<p>Well, not quite. Each new Java thread is not actually a separate process running on the OS. But it almost <em>feels</em> as though it is.</p>
<p>We’re going to take a break from the chat application for a bit while we explore how this works. Then we’ll come back and add it to our chat client at the end of the chapter.</p>
<p><strong>Multithreading in Java</strong></p>
<p>Java has support for multiple threads built right into the fabric of the language. And it’s a snap to make a new thread of execution:</p>
<pre data-type="programlisting"><strong>Thread t = new Thread();</strong>
<strong>t.start();</strong></pre>
<p>That’s it. By creating a new Thread <em>object</em>, you’ve launched a separate <em>thread of execution</em>, with its very own call stack.</p>
<p><strong><em>Except for one problem.</em></strong></p>
<p>That thread doesn’t actually <em>do</em> anything, so the thread “dies” virtually the instant it’s born. When a thread dies, its new stack disappears again. End of story.</p>
<p>So we’re missing one key component—the thread’s <em>job</em>. In other words, we need the code that you want to have run by a separate thread.</p>
<p>Multiple threading in Java means we have to look at both the <em>thread</em> and the <em>job</em> that’s <em>run</em> by the thread. In fact, <strong>there’s more than one way to run multiple jobs in Java</strong>, not just with the Thread <em>class</em> in the java.lang package. (Remember, java.lang is the package you get imported for free, implicitly, and it’s where the classes most fundamental to the language live, including String and System.)</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Java has multiple threads but only one Thread class"><div class="sect1" id="java_has_multiple_threads_but_only_one_t">
<h1>Java has multiple threads but only one Thread class</h1>
<p><a data-type="indexterm" data-primary="multithreading" data-secondary="stack" id="idm46038387505536"/><a data-type="indexterm" data-primary="stack" data-secondary="threads" id="idm46038388033664"/>We can talk about <em>thread</em> with a lowercase “t” and <strong>Thread</strong> with a capital “T.” When you see <em>thread</em>, we’re talking about a separate thread of execution. In other words, a separate call stack. When you see <strong>Thread</strong>, think of the Java naming convention. What, in Java, starts with a capital letter? Classes and interfaces. In this case, <strong>Thread</strong> is a class in the java.lang package. A <strong>Thread</strong> object represents a <em>thread of execution</em>. In older versions of Java, you always had to create an instance of class <strong>Thread</strong> each time you wanted to start up a new <em>thread</em> of execution. Java has evolved over time, and now using the <strong>Thread</strong> class directly is not the only way. We’ll see this in more detail as we go through the rest of the chapter.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong>A thread is a separate “thread of execution,” a separate call stack.</strong></p>
<p><strong>A Thread is a Java class that represents a thread.</strong></p>
<p><strong>Using the Thread class is not the only way to do multithreading in Java.</strong></p>
</div>
<table class="border">
<tbody>
<tr>
<td><strong><u>t</u>hread</strong></td>
<td><strong><u>T</u>hread</strong></td>
</tr>
<tr>
<td><figure class="informal"><div class="figure">
<img src="Images/f0610-01.png" alt="image" width="497" height="243"/>
<h6/>
</div></figure></td>
<td><figure class="informal"><div class="figure">
<img src="Images/f0610-02.png" alt="image" width="207" height="241"/>
<h6/>
</div></figure></td>
</tr>
<tr>
<td>A <em>thread</em> (lowercase “t”) is a separate thread of execution. That means a separate call stack. Every Java application starts up a main thread—the thread that puts the main() method on the bottom of the stack. The JVM is responsible for starting the main thread (and other threads, as it chooses, including the garbage collection thread). As a programmer, you can write code to start other threads of your own.</td>
<td><code><strong>Thread</strong></code> (capital “T”) is a class that represents a thread of execution. It has methods for starting a thread, joining one thread with another, putting a thread to sleep, and more.</td>
</tr>
</tbody>
</table>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What does it mean to have more than one call stack?"><div class="sect1" id="what_does_it_mean_to_have_more_than_one">
<h1>What does it mean to have more than one call stack?</h1>
<p><a data-type="indexterm" data-primary="main()" data-secondary="multithreading" id="idm46038388666976"/>With more than one call stack, you can have multiple things happen at the same time. If you’re running on a multiprocessor system (like most modern computers and phones), you can actually do more than one thing at a time. With Java threads, even if you’re not running on a multiprocessor system or if you’re running more processes than available cores, it can <em>appear</em> that you’re doing all these things simultaneously. In other words, execution can move back and forth between stacks so rapidly that you feel as though all stacks are executing at the same time. Remember, Java is just a process running on your underlying OS. So first, Java <em>itself</em> has to be “the currently executing process” on the OS. But once Java gets its turn to execute, exactly <em>what</em> does the JVM <em>run</em>? Which bytecodes execute? Whatever is on the top of the currently running stack! And in 100 milliseconds, the currently executing code might switch to a <em>different</em> method on a <em>different</em> stack.</p>
<p>One of the things a thread must do is keep track of which statement (of which method) is currently executing on the thread’s stack.</p>
<p>It might look something like this:</p>
<figure class="informal"><div class="figure">
<img src="Images/f0611-01.png" alt="image" width="1000" height="637"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="To create a new call stack you need a job to run"><div class="sect1" id="to_create_a_new_call_stack_you_need_a_jo">
<h1>To create a new call stack you need a job to run</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0612-01.png" alt="image" width="414" height="544"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="lambda expressions" data-secondary="threads" id="idm46038387446832"/><a data-type="indexterm" data-primary="multithreading" data-secondary="Runnable interface" id="idm46038387445616"/><a data-type="indexterm" data-primary="run()" id="idm46038387444512"/><a data-type="indexterm" data-primary="Runnable interface" id="idm46038387443904"/><strong><span style="color:#646466;">Runnable is to a thread what a job is to a worker. A Runnable is the job a thread is supposed to run.</span></strong></p>
<p><strong><span style="color:#646466;">A Runna ble holds t he method t hat goes on the bottom of the new call stack: run().</span></strong></p>
</div>
<p>To start a new call stack the thread needs a job—a job the thread will run when it’s started. That job is actually the first method that goes on the new thread’s stack, and it must always be a method that looks like this:</p>
<pre data-type="programlisting"><strong>public void run() {</strong>
  <strong>// code that will be run by the new thread</strong>
<strong>}</strong></pre>
<p>How does the thread know which method to put at the bottom of the stack? Because Runnable defines a contract. Because Runnable is an interface. A thread’s job can be defined in any class that implements the Runnable interface, or a lambda expression that is the right shape for the run method.</p>
<p>Once you have a Runnable class or lambda expression, you can tell the JVM to run this code in a separate thread; you’re giving the thread its job.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#646466;">The Runnable interface defines only one method, public void run(). Since it has only a single method, it’s a SAM type, a Functional Interface, and you can use a <u>lambda</u> instead of creating a whole class that implements Runnable if you want.</span></p>
</div>
</div></section>
<section data-type="sect1" data-pdf-bookmark="To make a job for your thread, implement the Runnable interface"><div class="sect1" id="to_make_a_job_for_your_threadcomma_imple">
<h1>To make a job for your thread, implement the Runnable interface</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0613-01.png" alt="image" width="974" height="577"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="How NOT to run the Runnable"><div class="sect1" id="how_not_to_run_the_runnable">
<h1>How NOT to run the Runnable</h1>
<p><a data-type="indexterm" data-primary="main()" data-secondary="multithreading" id="idm46038387439824"/><a data-type="indexterm" data-primary="run()" id="idm46038387435280"/>It may be tempting to create a new instance of the Runnable and call the run method, but that’s <strong>not enough to create a new call stack</strong>.</p>
<pre data-type="programlisting">class RunTester {
  public static void main(String[] args) {
    <strong>MyRunnable runnable = new MyRunnable();</strong>
    <strong>runnable.run();</strong>
    <strong>System.out.println(Thread.currentThread().getName() +</strong>
                       <strong>": back in main");</strong>
    <strong>Thread.dumpStack();</strong>
  }
}</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#646466;">This will <u>NOT</u> do what we want!</span></p>
</div>
<p><strong>The run() method was called directly from inside the main() method, so it’s part of the call stack of the main thread.</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0613-02.png" alt="image" width="209" height="203"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="How we used to launch a new thread"><div class="sect1" id="how_we_used_to_launch_a_new_thread">
<h1>How we used to launch a new thread</h1>
<p><a data-type="indexterm" data-primary="Thread constructor" id="idm46038387424432"/>The simplest way to launch a new thread is with the Thread class that we mentioned earlier. This method has been around in Java since the very beginning, but <strong>it is no longer the recommended approach to use</strong>. We’re showing it here because a) it’s simple, and b) you’ll see it in the Real World. We will talk later about why it might not be the best approach.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0614-01.png" alt="image" width="1018" height="992"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="A better alternative: don’t manage the Threads at all"><div class="sect1" id="a_better_alternative_donapostrophet_mana">
<h1>A better alternative: don’t manage the Threads at all</h1>
<p><a data-type="indexterm" data-primary="classes" data-secondary="Executors" id="idm46038387418960"/><a data-type="indexterm" data-primary="Executors class" id="idm46038387417408"/><a data-type="indexterm" data-primary="ExecutorService" id="idm46038387416576"/><a data-type="indexterm" data-primary="ExecutorService.shutdown()" id="idm46038387415744"/><a data-type="indexterm" data-primary="factory methods" id="idm46038387414944"/>Creating and starting a new Thread gives you a lot of control over that Thread, but the downside is you <em>have</em> to control it. You have to keep track of all the Threads and make sure they’re shut down at the end. Wouldn’t it be better to have something else that starts, stops, and even reuses the Threads so you don’t have to?</p>
<p>Allow us to introduce an interface in java.util.concurrent, <strong><code>ExecutorService</code></strong>. Implementations of this interface will <em>execute</em> jobs (Runnables). Behind the scenes the ExecutorService will create, reuse, and kill threads in order to run these jobs.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><span style="color:#646466;">Static <u>factory methods</u> can be used instead of constructors.</span></p>
<p><span style="color:#646466;">Factory methods return exactly the implementation of an interface that we need. We don’t need to know the concrete classes or how to create them.</span></p>
</div>
<p>The <strong><code>java.util.concurrent.Executors</code></strong> class has <em>factory methods</em> to create the ExecutorService instances we’ll need.</p>
<p>Executors have been around since Java 5 and so should be available to you even if you’re working with quite an old version of Java. There’s no real need to use Thread directly at all these days.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Running one job"><div class="sect1" id="running_one_job">
<h1>Running one job</h1>
<p>For the simple cases we’re going to get started with, we’ll want to run only one job in addition to our main class. There’s a <em>single thread executor</em> that we can use to do this.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0615-01.png" alt="image" width="925" height="469"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id00000053">
<p>We’ll come back to the Executors factory methods later, and we’ll see why it might be better to use ExecutorServices rather than managing the Thread itself.</p>
</div></aside>
<section data-type="sect2" data-pdf-bookmark="The three states of a new thread"><div class="sect2" id="the_three_states_of">
<h2>The three states of a new thread</h2>
<p><a data-type="indexterm" data-primary="multithreading" data-secondary="thread states" id="idm46038387399280"/><a data-type="indexterm" data-primary="runnable thread state" id="idm46038387398112"/>Whether you create a new Thread and pass it the Runnable, or use an Executor to execute the Runnable, the job will still be running on a Thread. A Thread will move through a number of different states during its life, and understanding these states, and the transitions between them, helps us to better understand multithreaded programming.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0616-01.png" alt="image" width="991" height="860"/>
<h6/>
</div></figure>
<blockquote><strong>But there’s more. Once the thread becomes runnable, it can move back and forth between runnable, running, and an additional state: <em>temporarily not runnable</em>.</strong></blockquote>
<p><a data-type="indexterm" data-primary="multithreading" data-secondary="scheduling" id="idm46038387404416"/><a data-type="indexterm" data-primary="temporarily not-runnable, thread as" id="idm46038387392192"/><a data-type="indexterm" data-primary="thread scheduler" id="idm46038387391392"/><strong>Typical runnable/running loop</strong></p>
<p>Typically, a thread moves back and forth between runnable and running, as the JVM thread scheduler selects a thread to run and then kicks it back out so another thread gets a chance.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0617-01.png" alt="image" width="600" height="403"/>
<h6/>
</div></figure>
<p><strong>A thread can be made temporarily not-runnable</strong></p>
<p>The thread scheduler can move a running thread into a blocked state, for a variety of reasons. For example, the thread might be executing code to read from an input stream, but there isn’t any data to read. The scheduler will move the thread out of the running state until something becomes available. Or the executing code might have told the thread to put itself to sleep (sleep()). Or the thread might be waiting because it tried to call a method on an object, and that object was “locked.” In that case, the thread can’t continue until the object’s lock is freed by the thread that has it.</p>
<p>All of those conditions (and more) cause a thread to become temporarily not-runnable.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0617-02.png" alt="image" width="463" height="476"/>
<h6/>
</div></figure>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="The thread scheduler"><div class="sect1" id="the_thread_scheduler">
<h1>The thread scheduler</h1>
<p>The thread scheduler makes all the decisions about who moves from runnable to running, and about when (and under what circumstances) a thread leaves the running state. The scheduler decides who runs, for how long, and where the threads go when it decides to kick them out of the currently running state.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0618-01.png" alt="image" width="488" height="929"/>
<h6/>
</div></figure>
<p>You can’t control the scheduler. There is no API for calling methods on the scheduler. Most importantly, there are no guarantees about scheduling! (There are a few <em>almost</em>-guarantees, but even those are a little fuzzy.)</p>
<p>The bottom line is this: <strong><em>do not base your program’s correctness on the scheduler working in a particular way!</em></strong> The scheduler implementations are different for different JVMs, and even running the same program on the same machine can give you different results. One of the worst mistakes new Java programmers make is to test their multithreaded program on a single machine, and assume the thread scheduler will always work that way, regardless of where the program runs.</p>
<p>So what does this mean for write-once-run-anywhere? It means that to write platform-independent Java code, your multithreaded program must work no matter <em>how</em> the thread scheduler behaves. That means you can’t be dependent on, for example, the scheduler making sure all the threads take nice, perfectly fair, and equal turns at the running state. Although highly unlikely today, your program might end up running on a JVM with a scheduler that says, “OK, thread five, you’re up, and as far as I’m concerned, you can stay here until you’re done, when your run() method completes.”</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong><span style="color:#646466;">The thread scheduler makes all the decisions about who runs and who doesn’t. It usually makes the threads take turns, nicely. But there’s no guarantee about that. It might let one thread run to its heart’s content while the other threads “starve.”</span></strong></p>
</div>
<p><strong>An example of how unpredictable the scheduler can be...</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0619-01.png" alt="image" width="1485" height="1398"/>
<h6/>
</div></figure>
<section data-type="sect2" data-pdf-bookmark="How did we end up with different results?"><div class="sect2" id="how_did_we_end_up_with_different_results">
<h2>How did we end up with different results?</h2>
<p>Multithreaded programs are <em>not deterministic</em>; they don’t run the same way every time. The thread scheduler can schedule each thread differently each time the program runs.</p>
<p><strong>Sometimes it runs like this:</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0620-01.png" alt="image" width="705" height="338"/>
<h6/>
</div></figure>
<p><strong>And sometimes it runs like this:</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0620-02.png" alt="image" width="1013" height="335"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong><span style="color:#646466;">Even if the new thread is tiny, if it has only one line of code to run like our lambda expression, it can still be interrupted by the thread scheduler.</span></strong></p>
</div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="there_are_no_dumb_questions-id00047">
<h5>there are no Dumb Questions</h5>
<p><a data-type="indexterm" data-primary="lambda expressions" data-secondary="threads" id="idm46038387345184"/><strong>Q: Should I use a lambda expression for my Runnable or create a new class that implements Runnable?</strong></p>
<p><strong>A:</strong> It depends upon how complicated your job is, and also on whether you think it’s easier to understand as a lambda expression or a class. Lambda expressions are great for when the job is really tiny, like our single-line “print” example. Lambda expressions (or method references) may also work if you have a few lines of code in another method that you want to turn into a job:</p>
<pre data-type="programlisting">executor.execute(() -&gt; printMsg());</pre>
<p>You’ll most likely want to use a full Runnable class if your job needs to store things in fields and/or if your job is made up of a number of methods. This is more likely when your jobs are more complex.</p>
<p><strong>Q: What’s the advantage of using an ExecutorService? So far, it works the same as creating a Thread and starting it.</strong></p>
<p><strong>A:</strong> It’s true that for these simple examples, where we’re starting just one thread, letting it run, and then stopping our application, the two approaches seem similar. ExecutorServices become really helpful when we’re starting lots of independent jobs. We don’t necessarily want to create a new Thread for each of these jobs, and we don’t want to keep track of all these Threads. There are different ExecutorService implementations depending upon how many threads we’ll want to start (or especially if we don’t know how many Threads we’ll need), including ExecutorServices that create Thread pools. Thread pools let us reuse Thread instances, so we don’t have to pay the cost of starting up new Threads for every job. We’ll explore this in more detail later.</p>
</div></aside>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="bullet_points-id00018">
<h5>Bullet Points</h5>
<ul style="list-style-type:none">
<li><p>A thread with a lowercase “t” is a separate thread of execution in Java.</p></li>
<li><p>Every thread in Java has its own call stack.</p></li>
<li><p>A Thread with a capital “T” is the java.lang.Thread class. A Thread object represents a thread of execution.</p></li>
<li><p>A thread needs a job to do. The job can be an instance of something that implements the Runnable interface.</p></li>
<li><p>The Runnable interface has just a single method, run(). This is the method that goes on the bottom of the new call stack. In other words, it is the first method to run in the new thread.</p></li>
<li><p>Because the Runnable interface has just a single method, you can use lambda expressions where a Runnable is expected.</p></li>
<li><p>Using the Thread class to run separate jobs is no longer the preferred way to create multithreaded applications in Java. Instead, use an Executor or an ExecutorService.</p></li>
<li><p>The Executors class has helper methods that can create standard ExecutorServices to use to start new jobs.</p></li>
<li><p>A thread is in the NEW state when it has not yet started.</p></li>
<li><p>When a thread has been started, a new stack is created, with the Runnable’s run() method on the bottom of the stack. The thread is now in the RUNNABLE state, waiting to be chosen to run.</p></li>
<li><p>A thread is said to be RUNNING when the JVM’s thread scheduler has selected it to be the currently running thread. On a single-processor machine, there can be only one currently running thread.</p></li>
<li><p>Sometimes a thread can be moved from the RUNNING state to a temporarily NON-RUNNABLE state. A thread might be blocked because it’s waiting for data from a stream, because it has gone to sleep, or because it is waiting for an object’s lock. We’ll see locks in the next chapter.</p></li>
<li><p>Thread scheduling is not guaranteed to work in any particular way, so you cannot be certain that threads will take turns nicely.</p></li>
</ul>
</div></aside>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Putting a thread to sleep"><div class="sect1" id="putting_a_thread_to_sleep">
<h1>Putting a thread to sleep</h1>
<figure class="informal"><div class="figure">
<img src="Images/f0622-01.png" alt="image" width="184" height="456"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="multithreading" data-secondary="coordinating threads" id="idm46038389241168"/><a data-type="indexterm" data-primary="multithreading" data-secondary="sleep()" id="idm46038387353360"/><a data-type="indexterm" data-primary="sleep()" id="idm46038387377696"/>One way to help your threads take turns is to put them to sleep periodically. All you need to do is call the static sleep() method, passing it the amount of time you want the thread to sleep for, in milliseconds.</p>
<p>For example:</p>
<pre data-type="programlisting"><strong>Thread.sleep(2000);</strong></pre>
<p>will knock a thread out of the running state and keep it out of the runnable state for two seconds. The thread <em>can’t</em> become the running thread again until after at least two seconds have passed.</p>
<p>A bit unfortunately, the sleep method throws an InterruptedException, a checked exception, so all calls to sleep must be wrapped in a try/catch (or declared). So a sleep call really looks like this:</p>
<pre data-type="programlisting"><strong>try {</strong>
  <strong>Thread.sleep(2000);</strong>
<strong>} catch(InterruptedException ex) {</strong>
    <strong>ex.printStackTrace();</strong>
<strong>}</strong></pre>
<p>Now you know that your thread won’t wake up <em>before</em> the specified duration, but is it possible that it will wake up some time <em>after</em> the “timer” has expired? Effectively, yes. The thread won’t automatically wake up at the designated time and become the currently running thread. When a thread wakes up, the thread is once again at the mercy of the thread scheduler; therefore, there are no guarantees about how long the thread will be out of action.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong><span style="color:#646466;">Putting a thread to sleep gives the other threads a chance to run.</span></strong></p>
<p><strong><span style="color:#646466;">When the thread wakes up, it always goes back to the runnable state and waits for the thread scheduler to choose it to run again.</span></strong></p>
</div>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id00000054">
<p>It can be hard to understand how much time a number of milliseconds represents. There’s a convenience method on java.util.concurrent.TimeUnit that we can use to make a more readable sleep time:</p>
<pre data-type="programlisting"><strong>TimeUnit.MINUTES.sleep(2);</strong></pre>
<p>which may be easier to understand than:</p>
<pre data-type="programlisting"><strong>Thread.sleep(120000);</strong></pre>
<p>(You still need to wrap both in a try-catch, though.)</p>
</div></aside>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Using sleep to make our program more predictable"><div class="sect1" id="using_sleep_to_make_our_program_more_pre">
<h1>Using sleep to make our program more predictable</h1>
<p>Remember our earlier example that kept giving us different results each time we ran it? Look back and study the code and the sample output. Sometimes main had to wait until the new thread finished (and printed “top o’ the stack”), while other times the new thread would be sent back to runnable before it was finished, allowing the main thread to come back in and print out “back in main.” How can we fix that? Stop for a moment and answer this question: “Where can you put a sleep() call, to make sure that “back in main” always prints before “top o’ the stack”?</p>
<figure class="informal"><div class="figure">
<img src="Images/f0623-01.png" alt="image" width="391" height="604"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img src="Images/f0623-02.png" alt="image" width="982" height="557"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="brain_barbell-id00009">
<h5>Brain Barbell</h5>
<figure class="informal"><div class="figure">
<img src="Images/barbell.png" alt="image" width="163" height="95"/>
<h6/>
</div></figure>
<p>Can you think of any problems with forcing your threads to sleep for a set amount of time? How long will it take to run this code 10 times?</p>
</div></aside>
</div></section>
<section data-type="sect1" data-pdf-bookmark="There are downsides to forcing the thread to sleep"><div class="sect1" id="there_are_downsides_to_forcing_the_threa">
<h1>There are downsides to forcing the thread to sleep</h1>
<ul style="list-style-type:none">
<li><p><span class="inlineimage"><img src="Images/1.png" alt="Images" width="20" height="21"/></span> <strong>The program has to wait for at least that amount of time.</strong></p>
<p>If we put the thread to sleep for two seconds, the thread will be non-runnable for that time. When it wakes up, it won’t automatically become the currently running thread. When a thread wakes up, the thread is once again at the mercy of the thread scheduler. Our application is going to be hanging around for at least those two seconds, probably more. This might not sound like a big deal, but imagine a bigger program full of these pauses <em>intentionally</em> slowing down the application.</p></li>
<li><p><span class="inlineimage"><img src="Images/2.png" alt="Images" width="20" height="21"/></span> <strong>How do you know the other job will finish in that time?</strong></p>
<p>We put the new thread to sleep for two seconds, assuming that the main thread would be the running thread, and complete its work in that time. But what if the main thread took longer to finish than that? What if another thread, running a longer job, was scheduled instead? One of the ways people deal with this is to set sleep times that are much longer than they’d expect a job to take, but then our first problem becomes even more of a problem.</p></li>
</ul>
<figure class="informal"><div class="figure">
<img src="Images/f0624-01.png" alt="image" width="647" height="333"/>
<h6/>
</div></figure>
<p><strong>A better alternative: wait for the perfect time.</strong></p>
<p>What we really wanted in our example was to wait until a specific thing had happened in our main thread before carrying on with our new thread. Java supports a number of different mechanisms to do this, like Future, CyclicBarrier, Semaphore, and CountDownLatch.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong><span style="color:#646466;">To coordinate events happening on multiple threads, one thread may need to <u>wait</u> for a specific signal from another thread before it can continue.</span></strong></p>
</div>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Counting down until ready"><div class="sect1" id="counting_down_until_ready">
<h1>Counting down until ready</h1>
<p><a data-type="indexterm" data-primary="CountDownLatch" id="idm46038387263440"/><a data-type="indexterm" data-primary="latch.countDown" id="idm46038387261120"/>You can make threads <em>count down</em> when significant events have happened. A thread (or threads) can wait for all these events to complete before continuing. You might be counting down until a minimum number of clients have connected, or a number of services have been started.</p>
<p>This is what <code><strong>java.util.concurrent.CountDownLatch</strong></code> is for. You set a number to count down from. Then any thread can tell the latch to count down when a relevant event has happened.</p>
<p>In our example, we have only one thing we want to count—our new thread should wait until the main thread has printed “back in main” before it can continue.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong>CountDownLatch is a barrier synchronizer. Barriers are mechanisms to allow threads to coordinate with each other.</strong></p>
<p><strong>Other examples are CyclicBarrier and Phaser.</strong></p>
</div>
<figure class="informal"><div class="figure">
<img src="Images/f0625-01.png" alt="image" width="982" height="537"/>
<h6/>
</div></figure>
<p>The code is really similar to the code that performs a sleep; the main difference is the latch.countDown in the main method. The performance difference is significant, though. Instead of having to wait <em>at least</em> two seconds to make sure main has printed its message, the new thread waits only until the main method has printed its “back in main” message.</p>
<p>To get an idea of the performance difference this might make on a real system, when this latch code was run on a MacBook 100 times, it took around 50 milliseconds to finish <em>all</em> one hundred runs, and the output was in the correct order <em>every time</em>. If running the sleep() version just one time takes over 2 seconds (2000 milliseconds), imagine how long it took to run 100 times*....</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Making and starting two threads (or more!)"><div class="sect1" id="making_and_starting_two_threads_left_par">
<h1>Making and starting two threads (or more!)</h1>
<p><a data-type="indexterm" data-primary="Executors" id="idm46038387249808"/><a data-type="indexterm" data-primary="ExecutorService" id="idm46038387248848"/><a data-type="indexterm" data-primary="multithreading" data-secondary="thread pools" id="idm46038387248016"/><a data-type="indexterm" data-primary="thread pools" id="idm46038387246912"/>What happens if we want to start more than one job in addition to our main thread? Clearly, we can’t use Executors.newSingleThreadExecutor() if we want to run more than one thread. What else is available?</p>
<figure class="informal"><div class="figure">
<img src="Images/f0626-01.png" alt="image" width="957" height="707"/>
<h6/>
</div></figure>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><strong><span style="color:#646466;">These ExecutorServices use some form of Thread Pool. This is a collection of Thread instances that can be used (and reused) to perform jobs.</span></strong></p>
<p><strong><span style="color:#646466;">How many threads are in the pool, and what to do if there are more jobs to run than threads available, depends on the ExecutorService implementation.</span></strong></p>
</div>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Pooling Threads"><div class="sect1" id="pooling_threads">
<h1>Pooling Threads</h1>
<p>Using a pool of resources, especially ones that are expensive to create like Threads or database connections, is a common pattern in application code.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0627-01.png" alt="image" width="741" height="382"/>
<h6/>
</div></figure>
<p>When you create a new ExecutorService, its pool may be started with some threads to begin with, or the pool may be empty.</p>
<p>You can create an ExecutorService with a thread pool using one of the helper methods from the Executors class.</p>
<pre data-type="programlisting">ExecutorService threadPool =
    Executors.newCachedThreadPool();</pre>
<hr/>
<figure class="informal"><div class="figure">
<img src="Images/f0627-02.png" alt="image" width="527" height="234"/>
<h6/>
</div></figure>
<p>You can use the pool’s threads to run your job by giving the job to the ExecutorService. The ExecutorService can then figure out if there’s a free Thread to run the job.</p>
<pre data-type="programlisting">threadPool.execute(() -&gt; run("Job 1"));</pre>
<p>This means an ExecutorService can <strong>reuse</strong> threads; it doesn’t just create and destroy them.</p>
<hr/>
<figure class="informal"><div class="figure">
<img src="Images/f0627-03.png" alt="image" width="561" height="311"/>
<h6/>
</div></figure>
<p>As you give the ExecutorService more jobs to run, it <em>may</em> create and start new Threads to handle the jobs. It <em>may</em> store the jobs in a queue if there are more jobs than Threads.</p>
<p>How an ExecutorService deals with additional jobs depends on how it is set up.</p>
<pre data-type="programlisting">threadPool.execute(() -&gt; run("Job 324"));</pre>
<p>The ExecutorService may also <strong>terminate</strong> Threads that have been idle for some period of time. This can help to minimize the amount of hardware resources (CPU, memory) your application needs.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Running multiple threads"><div class="sect1" id="running_multiple_threads">
<h1>Running multiple threads</h1>
<p>The following example runs two jobs, and uses a fixed-sized thread pool to create two threads to run the jobs. Each thread has the same job: run in a loop, printing the currently running thread’s name with each iteration.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0628-01.png" alt="image" width="923" height="435"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What will happen?"><div class="sect1" id="what_will_happenquestion_mark">
<h1>What will happen?</h1>
<p>Will the threads take turns? Will you see the thread names alternating? How often will they switch? With each iteration? After five iterations?</p>
<figure class="informal"><div class="figure">
<img src="Images/f0628-02.png" alt="image" width="769" height="541"/>
<h6/>
</div></figure>
<p>You already know the answer: <em>we don’t know!</em> It’s up to the scheduler. And on your OS, with your particular JVM, on your CPU, you might get very different results.</p>
<p>Running this on a modern multicore system, the two jobs will likely run in parallel, but there’s no guarantee that this means they will complete in the same amount of time or output values at the same rate.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Closing time at the thread pool"><div class="sect1" id="closing_time_at_the_thread_pool">
<h1>Closing time at the thread pool</h1>
<p><a data-type="indexterm" data-primary="awaitTermination" id="idm46038387244848"/><a data-type="indexterm" data-primary="ExecutorService.shutdown()" id="idm46038387214464"/><a data-type="indexterm" data-primary="ExecutorService.shutdownNow()" id="idm46038387213664"/><a data-type="indexterm" data-primary="shutdown()" id="idm46038387212864"/>You may have noticed that our examples have a <code><strong>threadPool.shutdown</strong>()</code> at the end of the main methods. Although the thread pools will take care of our individual Threads, we do need to be responsible adults and close the pool when we’re finished with it. That way, the pool can empty its job queue and shut down all of its threads to free up system resources.</p>
<p>ExecutorService has two shutdown methods. You can use either, but to be safe we’d use both:</p>
<ul style="list-style-type:none">
<li><p><span class="inlineimage"><img src="Images/1.png" alt="Images" width="20" height="21"/></span> <strong>ExecutorService.shutdown()</strong></p>
<p>Calling shutdown() asks the ExecutorService nicely if it wouldn’t mind awfully wrapping things up so everyone can go home.</p>
<p>All of the Threads that are currently running jobs are allowed to finish those jobs, and any jobs waiting in the queue will also be finished off. The ExecutorService will reject any new jobs too.</p>
<p>If you need your code to wait until all of those things are finished, you can use <code><strong>awaitTermination</strong></code> to sit and wait until it’s finished. You give awaitTermination a maximum amount of time to wait for everything to end, so awaitTermination will hang around until either the ExecutorService has finished everything or the timeout has been reached, whichever is earlier.</p></li>
<li><p><span class="inlineimage"><img src="Images/2.png" alt="Images" width="20" height="21"/></span> <strong>ExecutorService.shutdownNow()</strong></p>
<p>Everybody out! When this is called, the ExecutorService will try to stop any Threads that are running, will not run any waiting jobs, and definitely won’t let anyone else into the pool.</p>
<p>Use this if you need to put a stop to everything. This is sometimes used after first calling shutdown() to give the jobs a chance to finish before pulling the plug entirely.</p></li>
</ul>
<figure class="informal"><div class="figure">
<img src="Images/f0629-01.png" alt="image" width="1032" height="474"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="concurrency" data-secondary="multithreading" id="idm46038387233072"/><a data-type="indexterm" data-primary="race conditions" id="idm46038387290608"/></p>
<figure class="informal"><div class="figure"><img src="Images/f0630-01.png" alt="image" width="516" height="596"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Um, yes. There IS a dark side. Multithreading can lead to concurrency “issues.”"><div class="sect1" id="umcomma_yesdot_there_is_a_dark_sidedot_m">
<h1>Um, yes. There IS a dark side. Multithreading can lead to concurrency “issues.”</h1>
<p>Concurrency issues lead to race conditions. Race conditions lead to data corruption. Data corruption leads to fear...you know the rest.</p>
<p>It all comes down to one potentially deadly scenario: two or more threads have access to a single object’s <em>data</em>. In other words, methods executing on two different stacks are both calling, say, getters or setters on a single object on the heap.</p>
<p>It’s a whole “left-hand-doesn’t-know-what-the-right-hand-is-doing” thing. Two threads, without a care in the world, humming along executing their methods, each thread thinking that he is the One True Thread. The only one that matters. After all, when a thread is not running, and in runnable (or blocked) it’s essentially knocked unconscious. When it becomes the currently running thread again, it doesn’t know that it ever stopped.</p>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="bullet_points-id00019">
<h5>Bullet Points</h5>
<ul style="list-style-type:none">
<li><p>The static Thread.sleep() method forces a thread to leave the running state for <em>at least</em> the duration passed to the sleep method. Thread.sleep(200) puts a thread to sleep for 200 milliseconds.</p></li>
<li><p>You can also use the sleep method on java.util.concurrent.TimeUnit, for example TimeUnit.SECONDS.sleep(2).</p></li>
<li><p>The sleep() method throws a checked exception (InterruptedException), so all calls to sleep() must be wrapped in a try/catch, or declared.</p></li>
<li><p>There are different mechanisms to give threads a chance to wait for each other. You can use sleep(), but you can also use CountDownLatch to wait for the right number of events to have happened before continuing.</p></li>
<li><p>Managing threads directly can be a lot of work. Use the factory methods in Executors to create an ExecutorService, and use this service to run Runnable jobs.</p></li>
<li><p>Thread pools can manage creation, reuse, and destruction of threads so you don’t have to.</p></li>
<li><p>ExecutorServices should be shut down correctly so the jobs are finished and threads terminated. Use shutdown() for graceful shutdown, and shutdownNow() to kill everything.</p></li>
</ul>
</div></aside>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="itapostrophes_a_cliff-hangerexclamation">
<h5>It’s a cliff-hanger!</h5>
<figure class="informal"><div class="figure">
<img src="Images/f0630-02.png" alt="image" width="211" height="229"/>
<h6/>
</div></figure>
<p>A dark side? Race conditions?? Data corruption?! But what can we DO about those things? Don’t leave us hanging!</p>
<p>Stay tuned for the next chapter, where we address these issues and more...</p>
</div></aside>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Exercise"><div class="sect1" id="exercise-id000027">
<h1>Exercise</h1>
<figure class="informal"><div class="figure">
<img src="Images/exercise.png" alt="image" width="150" height="126"/>
<h6/>
</div></figure>
<section data-type="sect2" data-pdf-bookmark="Who Am I?"><div class="sect2" id="who_am_iquestion_mark-id000200">
<h2>Who Am I?</h2>
<p>(from <a data-type="xref" href="#exercise-id000027">“Exercise”</a>)</p>
<figure class="informal"><div class="figure">
<img src="Images/eye1.png" alt="image" width="251" height="199"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="exercises" data-secondary="Who Am I?" id="idm46038387174784"/>A bunch of Java and network terms, in full costume, are playing a party game, “Who am I?” They’ll give you a clue—you try to guess who they are based on what they say. Assume they always tell the truth about themselves. If they happen to say something that could be true for more than one attendee, then write down all for whom that sentence applies. Fill in the blanks next to the sentence with the names of one or more attendees.</p>
<p><strong>Tonight’s attendees:</strong></p>
<p><strong>InetSocketAddress, SocketChannel, IP address, host name, port, Socket, ServerSocketChannel, Thread, thread pool, Executors, ExecutorService, CountDownLatch, Runnable, InterruptedException, Thread.sleep()</strong></p>
<table class="border">
<tbody>
<tr>
<td><strong>I need to be shut down or I might live forever</strong></td>
<td>______________________________________________</td>
</tr>
<tr>
<td><strong>I let you talk to a remote machine</strong></td>
<td>______________________________________________</td>
</tr>
<tr>
<td><strong>I might be thrown by sleep() and await()</strong></td>
<td>______________________________________________</td>
</tr>
<tr>
<td><strong>If you want to reuse Threads, you should use me</strong></td>
<td>______________________________________________</td>
</tr>
<tr>
<td><strong>You need to know me if you want to connect to another machine</strong></td>
<td>______________________________________________</td>
</tr>
<tr>
<td><strong>I’m like a separate process running on the machine</strong></td>
<td>______________________________________________</td>
</tr>
<tr>
<td><strong>I can give you the ExecutorService you need</strong></td>
<td>______________________________________________</td>
</tr>
<tr>
<td><strong>You need one of me if you want clients to connect to me</strong></td>
<td>______________________________________________</td>
</tr>
<tr>
<td><strong>I can help you make your multithreaded code more predictable</strong></td>
<td>______________________________________________</td>
</tr>
<tr>
<td><strong>I represent a job to run</strong></td>
<td>______________________________________________</td>
</tr>
<tr>
<td><strong>I store the IP address and port of the server</strong></td>
<td>______________________________________________</td>
</tr>
</tbody>
</table>
<p><span class="inlineimage"><img src="Images/arr.png" alt="Images" width="60" height="12"/></span> <strong>Answers in <a data-type="xref" href="#who_am_iquestion_mark_left_par">“Who Am I?”</a>.</strong></p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="New and improved SimpleChatClient"><div class="sect1" id="new_and_improved_simplechatclient">
<h1>New and improved SimpleChatClient</h1>
<p><a data-type="indexterm" data-primary="Chat client app" id="idm46038387143440"/><a data-type="indexterm" data-primary="client application, networking" id="idm46038387142624"/><a data-type="indexterm" data-primary="multithreading" data-secondary="SimpleChatClient complete" id="idm46038387141824"/>Way back near the beginning of the chapter, we built the SimpleChatClient that could <em>send</em> outgoing messages to the server but couldn’t receive anything. Remember? That’s how we got onto this whole thread topic in the first place, because we needed a way to do two things at once: send messages <em>to</em> the server (interacting with the GUI) while simultaneously reading incoming messages <em>from</em> the server, displaying them in the scrolling text area.</p>
<p>This is the New Improved chat client that can both send and receive messages, thanks to the power of multithreading! Remember, you need to run the chat server first to run this code.</p>
<figure class="informal"><div class="figure">
<img src="Images/f0632-01.png" alt="image" width="1005" height="891"/>
<h6/>
</div></figure>
<p/>
<figure class="informal"><div class="figure"><img src="Images/f0633-01.png" alt="image" width="993" height="1116"/>
<h6/>
</div></figure>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id00000052a">
<p><strong>Remember, the Chat Server code was the Ready-Bake Code from <a data-type="xref" href="#the_reallycomma_really_simple_chat_serve">“The really, really simple Chat Server”</a>.</strong></p>
</div></aside>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Exercise"><div class="sect1" id="exercise-id000027a">
<h1>Exercise</h1>
<figure class="informal"><div class="figure">
<img src="Images/exercise.png" alt="image" width="150" height="126"/>
<h6/>
</div></figure>
<section data-type="sect2" data-pdf-bookmark="Code Magnets"><div class="sect2" id="code_magnets-id000007">
<h2>Code Magnets</h2>
<figure class="informal"><div class="figure">
<img src="Images/common-1.png" alt="image" width="169" height="248"/>
<h6/>
</div></figure>
<p><a data-type="indexterm" data-primary="exercises" data-secondary="Code Magnets" id="idm46038387125568"/>A working Java program is scrambled up on the fridge (see the next page). Can you reconstruct the code snippets on the next page to make a working Java program that produces the output listed below?</p>
<p>To get it to work, you will need to be running the <code><strong>SimpleChatServer</strong></code> from <a data-type="xref" href="#the_reallycomma_really_simple_chat_serve">“The really, really simple Chat Server”</a>.</p>
<figure class="informal"><div id="pg635a" class="figure">
<img src="Images/f0634-02.png" alt="image" width="252" height="358"/>
<h6/>
</div></figure>
<figure class="informal"><div class="figure">
<img src="Images/f0634-01.png" alt="image" width="308" height="319"/>
<h6/>
</div></figure>
<p><span class="inlineimage"><img src="Images/arr.png" alt="Images" width="60" height="12"/></span> <strong>Answers in <a data-type="xref" href="#code_magnets_left_parenthesisfrom_p-idd">“Code Magnets”</a>.</strong></p>
<figure class="informal"><div class="figure">
<img src="Images/f0635-01.png" alt="image" width="997" height="1168"/>
<h6/>
</div></figure>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Exercise Solutions"><div class="sect1" id="exercise_solutions-id000200">
<h1>Exercise Solutions</h1>
<figure class="informal"><div class="figure">
<img src="Images/exercise.png" alt="image" width="150" height="126"/>
<h6/>
</div></figure>
<section data-type="sect2" data-pdf-bookmark="Who Am I?"><div class="sect2" id="who_am_iquestion_mark_left_par">
<h2>Who Am I?</h2>
<table class="border">
<tbody>
<tr>
<td>I need to be shut down or I might live forever</td>
<td><em>ExecutorService</em></td>
</tr>
<tr>
<td>I let you talk to a remote machine</td>
<td><em>SocketChannel, Socket</em></td>
</tr>
<tr>
<td>I might be thrown by sleep() and await()</td>
<td><em>InterruptedException</em></td>
</tr>
<tr>
<td>If you want to reuse Threads, you should use me</td>
<td><em>Thread pool, ExecutorService</em></td>
</tr>
<tr>
<td>You need to know me if you want to connect to another machine</td>
<td><em>IP Address, Host name, port</em></td>
</tr>
<tr>
<td>I’m like a separate process running on the machine</td>
<td><em>Thread</em></td>
</tr>
<tr>
<td>I can give you the ExecutorService you need</td>
<td><em>Executors</em></td>
</tr>
<tr>
<td>You need one of me if you want clients to connect to me</td>
<td><em>ServerSocketChannel</em></td>
</tr>
<tr>
<td>I can help you make your multithreaded code more predictable</td>
<td><em>Thread.sleep(), CountDownLatch</em></td>
</tr>
<tr>
<td>I represent a job to run</td>
<td><em>Runnable</em></td>
</tr>
<tr>
<td>I store the IP address and port of the server</td>
<td><em>InetSocketAddress</em></td>
</tr>
</tbody>
</table>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Code Magnets"><div class="sect2" id="code_magnets_left_parenthesisfrom_p-idd">
<h2>Code Magnets</h2>
<p>(from <a data-type="xref" href="#code_magnets-id000007">“Code Magnets”</a>)</p>
<figure class="informal"><div class="figure">
<img src="Images/f0636-01.png" alt="image" width="990" height="706"/>
<h6/>
</div></figure>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Code Kitchen"><div class="sect2" id="code_kitchen-id00002">
<h2>Code Kitchen</h2>
<figure class="informal"><div class="figure">
<img src="Images/f0637-01.png" alt="image" width="1027" height="865"/>
<h6/>
</div></figure>
<blockquote><strong>Now you’ve seen how to build a chat client, we have the last version of the BeatBox!</strong></blockquote>
<blockquote><strong>It connects to a simple MusicServer so that you can send and receive beat patterns with other clients.</strong></blockquote>
<blockquote><strong>The code is really long, so the complete listing is actually in <a data-type="xref" href="app01.xhtml#appendix_a_final_code_kitchen">Appendix A</a>.</strong></blockquote>
</div></section>
</div></section>
</div></section></div></body></html>