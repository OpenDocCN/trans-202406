<html><head></head><body><section data-pdf-bookmark="Chapter 10. Containers at Scale" data-type="chapter" epub:type="chapter"><div class="chapter" id="containers_scale">&#13;
<h1><span class="label">Chapter 10. </span>Containers at Scale</h1>&#13;
&#13;
&#13;
<p>A major strength of containers<a data-primary="Linux containers" data-secondary="about" data-tertiary="abstracting underlying hardware and OS" data-type="indexterm" id="idm46803137084416"/><a data-primary="scaling" data-secondary="container abstraction facilitating" data-type="indexterm" id="idm46803137083152"/><a data-primary="cloud deployments" data-secondary="container abstraction aiding scaling" data-type="indexterm" id="idm46803137082192"/><a data-primary="deployment" data-secondary="cloud deployments" data-tertiary="container abstraction aiding scaling" data-type="indexterm" id="idm46803137081232"/><a data-primary="production" data-secondary="scaling facilitated by containers" data-seealso="scaling" data-type="indexterm" id="idm46803137080000"/><a data-primary="Swarm mode" data-see="Docker Swarm mode" data-type="indexterm" id="idm46803137078768"/> is their ability to abstract away the underlying hardware and operating system so that your application is not constrained to any particular host or environment. It facilitates scaling a stateless application not just horizontally within your data center but also across cloud providers without many of the traditional barriers you would encounter. True to the shipping container metaphor, a container on one cloud looks like a container on another.</p>&#13;
&#13;
<p>Many organizations find turnkey cloud deployments of Linux containers appealing because they can gain many of the immediate benefits of a scalable container-based platform without needing to completely build something in-house. Even though this is true, the barrier is actually pretty low for building your own platform in the cloud or in your own data center, and we’ll cover some options for doing that shortly.</p>&#13;
&#13;
<p>The major public cloud providers<a data-primary="cloud deployments" data-secondary="public cloud providers supporting Linux containers" data-type="indexterm" id="idm46803137076896"/> have all worked to support Linux containers natively in their offerings. Some of the largest efforts to support Linux containers in the public cloud include the following:<a data-primary="Amazon ECS (Elastic Container Service)" data-secondary="Linux container support" data-type="indexterm" id="idm46803137075504"/><a data-primary="Google Cloud Run" data-type="indexterm" id="idm46803137074496"/><a data-primary="Azure Container Apps" data-type="indexterm" id="idm46803137073824"/><a data-primary="scaling" data-secondary="public cloud providers" data-tertiary="Linux container support" data-type="indexterm" id="idm46803137073152"/></p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://aws.amazon.com/ecs">Amazon Elastic Container Service</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://cloud.google.com/run">Google Cloud Run</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://azure.microsoft.com/en-us/services/container-apps">Azure Container Apps</a></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Many of the same companies also have robust hosted Kubernetes offerings like these:<a data-primary="Amazon EKS (Elastic Kubernetes Service)" data-secondary="hosted Kubernetes offerings" data-type="indexterm" id="idm46803137067104"/><a data-primary="Google Kubernetes Engine" data-type="indexterm" id="idm46803137066096"/><a data-primary="Azure Kubernetes Service" data-type="indexterm" id="idm46803137065408"/><a data-primary="Kubernetes" data-secondary="public cloud provider offerings" data-type="indexterm" id="idm46803137064720"/><a data-primary="scaling" data-secondary="public cloud providers" data-tertiary="Kubernetes offerings" data-type="indexterm" id="idm46803137063760"/></p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://aws.amazon.com/eks">Amazon Elastic Kubernetes Service</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://cloud.google.com/kubernetes-engine">Google Kubernetes Engine</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://azure.microsoft.com/en-us/services/kubernetes-service">Azure Kubernetes Service</a></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>It’s trivial to install Docker on a Linux<a data-primary="scaling" data-secondary="public cloud providers" data-tertiary="running your own versus" data-type="indexterm" id="idm46803137057712"/> instance in one of the public clouds. But getting Docker onto the server is usually just one step in creating a full production environment. You could do this completely on your own, or you could use the many tools available from the major cloud providers, Docker, Inc., and the broader container community. Much of the tooling will work equally well in either a public cloud or your own data center.</p>&#13;
&#13;
<p>In the realm of schedulers and more complex tooling systems, we have plenty of choices for systems that replicate much of the functionality you would get from a public cloud provider. Even if you run in a public cloud, there are some compelling reasons why you might choose to run your own Linux container environment rather than use one of the off-the-shelf offerings.</p>&#13;
&#13;
<p>In this chapter, we’ll cover some options for running Linux containers at scale, first going through the much simpler Docker Swarm mode and then diving into some more advanced tools like Kubernetes and some of the larger cloud offerings. All of these examples should give you a view of how you can leverage Docker to provide an incredibly flexible platform for your application workloads.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Docker Swarm Mode" data-type="sect1"><div class="sect1" id="docker_swarm">&#13;
<h1>Docker Swarm Mode</h1>&#13;
&#13;
<p>After building the container runtime<a data-primary="scaling" data-secondary="Docker Swarm mode" data-type="indexterm" id="ch10-scal"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="scaling" data-type="indexterm" id="ch10-scal2"/><a data-primary="deployment" data-secondary="cloud deployments" data-tertiary="Docker Swarm mode" data-type="indexterm" id="ch10-scal3"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="about" data-type="indexterm" id="idm46803137046960"/><a data-primary="Docker Swarm (classic)" data-primary-sortas="docker-a" data-type="indexterm" id="idm46803137045744"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="about" data-type="indexterm" id="idm46803137044800"/> in the form of the Docker engine, the engineers at Docker turned to the problems of orchestrating a fleet of individual Docker hosts and effectively packing those hosts full of containers. The first tool that evolved from this work was called Docker Swarm. As we explained early on, and rather confusingly, there are now two things called “Swarm,” both of which come from Docker, Inc.</p>&#13;
&#13;
<p>The original standalone Docker Swarm is now commonly referred to as <a href="https://github.com/docker-archive/classicswarm">Docker Swarm (classic)</a>, but there is a second “Swarm” implementation that is more specifically called <a href="https://docs.docker.com/engine/swarm">Swarm mode</a>. <a data-primary="Docker client" data-primary-sortas="docker-a" data-secondary="Swarm mode built in" data-type="indexterm" id="idm46803137041536"/>Instead of being a separate product, this is built into the Docker client. The built-in Swarm mode is a lot more capable than the original Docker Swarm and is intended to replace it entirely. Swarm mode has the major advantage of not requiring you to install anything separately. You already have this clustering capability on any of your systems that are running Docker! This is the Docker Swarm implementation that we’ll focus on here. Hopefully, now that you know that there have been two different Docker Swarm implementations, you won’t get confused by contradictory information on the internet.</p>&#13;
&#13;
<p>The idea behind Docker Swarm mode<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="about" data-tertiary="managing clustered computing resources" data-type="indexterm" id="idm46803137039744"/> is to present a single interface to the <code>docker</code> client tool but have that interface be backed by a whole cluster rather than a single Docker daemon. Swarm is primarily aimed at managing clustered computing resources via the Docker tools. It has grown a lot since its first release and now contains several scheduler plug-ins with different strategies for assigning containers to hosts, and it comes with some basic service discovery built in. But it remains only one building block of a more complex solution.</p>&#13;
&#13;
<p>Swarm clusters can contain one or more<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="Swarm cluster managers" data-tertiary="about" data-type="indexterm" id="idm46803137037232"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="Swarm cluster managers" data-type="indexterm" id="idm46803137035712"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="Swarm cluster managers" data-tertiary="odd number of" data-type="indexterm" id="idm46803137034496"/> managers that act as the central management hub for your Docker cluster. It is best to set up an odd number of managers. Only one manager will act as the cluster leader at a time. As you add more nodes to Swarm, you are merging them into a single, cohesive cluster that can be easily controlled with the Docker tooling.</p>&#13;
&#13;
<p>Let’s get a Swarm cluster up and running.<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="Swarm cluster up and running" data-type="indexterm" id="ch10-upr"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="Swarm cluster up and running" data-type="indexterm" id="ch10-upr2"/> To start, you will need three or more Linux servers that can talk to each other over the network. Each of these servers should be running recent releases of Docker Community Edition from the official Docker software repositories.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Refer to <a data-type="xref" href="ch03.html#installing_docker">Chapter 3</a> for details on installing the <code>docker-ce</code> packages on Linux.</p>&#13;
</div>&#13;
&#13;
<p>For this example, we will use three Ubuntu servers running <code>docker-ce</code>. The very first thing you’ll need to do is <code>ssh</code> to the server that you want to use as the Swarm manager, and then run the <code>swarm init</code> command using the IP address for your Swarm manager:<a data-primary="docker swarm" data-primary-sortas="docker-z" data-secondary="init" data-type="indexterm" id="idm46803137024816"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="Swarm cluster managers" data-tertiary="docker swarm init creating" data-type="indexterm" id="idm46803137023568"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="adding worker" data-type="indexterm" id="idm46803137022064"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="adding working" data-type="indexterm" id="idm46803137020848"/><a data-primary="docker swarm" data-primary-sortas="docker-z" data-secondary="join" data-tertiary="adding a worker" data-type="indexterm" id="idm46803137019632"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="Swarm cluster managers" data-tertiary="manager added" data-type="indexterm" id="idm46803137018144"/><a data-primary="docker swarm" data-primary-sortas="docker-z" data-secondary="join-token" data-tertiary="manager added" data-type="indexterm" id="idm46803137016656"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="Swarm cluster manager added" data-type="indexterm" id="idm46803137015168"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>ssh<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"/>&#13;
<code class="go">…</code>&#13;
&#13;
<code class="gp">ubuntu@172.17.4.1:$ </code>sudo<code class="w"> </code>docker<code class="w"> </code>swarm<code class="w"> </code>init<code class="w"> </code>--advertise-addr<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"/>&#13;
&#13;
<code class="go">Swarm initialized: current node (hypysglii5syybd2zew6ovuwq) is now a manager.</code>&#13;
&#13;
<code class="go">To add a worker to this swarm, run the following command:</code>&#13;
&#13;
<code class="go">    docker swarm join --token SWMTKN-1-14……a4o55z01zq 172.17.4.1:2377</code>&#13;
&#13;
<code class="go">To add a manager to this swarm, run 'docker swarm join-token manager'</code>&#13;
<code class="go">and follow the instructions.</code></pre>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>There are steps that you must take to secure a Docker Swarm mode cluster, which we are not covering here. Before you run Docker Swarm mode on any long-lived systems, make sure that you understand the options and have taken proper steps to secure the environment.</p>&#13;
</div>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>In many of this chapter’s examples, you must use the correct IP addresses for your manager and worker nodes.</p>&#13;
</div>&#13;
&#13;
<p>This step will initialize the Swarm manager<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="Swarm cluster managers" data-tertiary="manager initialized" data-type="indexterm" id="idm46803136993408"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="manager initialized" data-type="indexterm" id="idm46803136991888"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="token required for nodes joining cluster" data-type="indexterm" id="idm46803136990672"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="token required for nodes joining cluster" data-tertiary="lost token recovery" data-type="indexterm" id="idm46803136989488"/><a data-primary="docker swarm" data-primary-sortas="docker-z" data-secondary="join-token" data-tertiary="token recovery" data-type="indexterm" id="idm46803136988032"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="Swarm cluster manager initialized" data-type="indexterm" id="idm46803136986544"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="token required for nodes joining cluster" data-type="indexterm" id="idm46803136985360"/> and give you the token that is required for nodes that want to join the cluster. Make note of this token somewhere safe, like a password manager. Don’t worry too much if you lose this token; you can always get it again by running the following command on the manager:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="go">sudo docker swarm join-token --quiet worker</code></pre>&#13;
&#13;
<p>You can inspect your progress so far by running your local <code>docker</code> client pointed at the new manager node’s IP address:<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="inspecting via Docker client" data-type="indexterm" id="idm46803136935392"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="inspecting via Docker client" data-type="indexterm" id="idm46803136934528"/><a data-primary="docker system" data-primary-sortas="docker-z" data-secondary="info" data-tertiary="Docker Swarm mode status" data-type="indexterm" id="idm46803136933440"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>system<code class="w"> </code>info<code class="w"/></pre>&#13;
&#13;
<pre class="nomargin" data-code-language="yaml" data-type="programlisting"><code class="l-Scalar-Plain">…</code><code class="w"/>&#13;
<code class="l-Scalar-Plain">Swarm</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">active</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">NodeID</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">l9gfcj7xwii5deveu3raf4782</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">Is Manager</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">ClusterID</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">mvdaf2xsqwjwrb94kgtn2mzsm</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">Managers</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">Nodes</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">Default Address Pool</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">10.0.0.0/8</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">SubnetSize</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">24</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">Data Path Port</code><code class="p-Indicator">:</code><code class="w"> </code><code class="l-Scalar-Plain">4789</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">Orchestration</code><code class="p-Indicator">:</code><code class="w"/>&#13;
<code class="w">   </code><code class="nt">Task History Retention Limit</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">5</code><code class="w"/>&#13;
<code class="w-Error">  </code><code class="nt">Raft</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">   </code><code class="nt">Snapshot Interval</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">10000</code><code class="w"/>&#13;
<code class="w">   </code><code class="nt">Number of Old Snapshots to Retain</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0</code><code class="w"/>&#13;
<code class="w">   </code><code class="nt">Heartbeat Tick</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1</code><code class="w"/>&#13;
<code class="w">   </code><code class="nt">Election Tick</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">10</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">Dispatcher</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">   </code><code class="nt">Heartbeat Period</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">5 seconds</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">CA Configuration</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">   </code><code class="nt">Expiry Duration</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">3 months</code><code class="w"/>&#13;
<code class="w">   </code><code class="nt">Force Rotate</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">Autolock Managers</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">false</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">Root Rotation In Progress</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">false</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">Node Address</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">172.17.4.1</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">Manager Addresses</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">   </code><code class="l-Scalar-Plain">172.17.4.1:2377</code><code class="w"/>&#13;
<code class="l-Scalar-Plain">…</code><code class="w"/></pre>&#13;
&#13;
<p class="pagebreak-before">You can also list all of the nodes that are currently in the cluster with the following command:<a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="listing nodes via Docker client" data-type="indexterm" id="idm46803136908016"/><a data-primary="docker node" data-primary-sortas="docker-z" data-secondary="ls" data-type="indexterm" id="idm46803136906928"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="listing nodes via Docker client" data-type="indexterm" id="idm46803136720768"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>node<code class="w"> </code>ls<code class="w"/>&#13;
&#13;
<code class="go">ID      HOSTNAME      STATUS AVAILABILITY MANAGER STATUS ENGINE VERSION</code>&#13;
<code class="go">l9…82 * ip-172-17-4-1 Ready  Active       Leader         20.10.7</code></pre>&#13;
&#13;
<p>At this point, you can add the two additional servers as workers to the Swarm cluster. This is what you’d do in production if you were going to scale up, and Swarm makes this pretty easy:<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="adding servers as workers" data-type="indexterm" id="idm46803136716032"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="adding servers as workers" data-type="indexterm" id="idm46803136714944"/><a data-primary="docker swarm" data-primary-sortas="docker-z" data-secondary="join" data-tertiary="adding servers as workers" data-type="indexterm" id="idm46803136713792"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="adding node as worker" data-type="indexterm" id="idm46803136712336"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="adding node as worker" data-type="indexterm" id="idm46803136705696"/><a data-primary="docker swarm" data-primary-sortas="docker-z" data-secondary="join" data-tertiary="adding node as worker" data-type="indexterm" id="idm46803136704480"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>ssh<code class="w"> </code><code class="m">172</code>.17.4.2<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code><code class="s2">"sudo docker swarm join --token SWMTKN-1-14……a4o55z01zq 172.17.4.1:2377"</code><code class="w"/>&#13;
&#13;
<code class="go">This node joined a swarm as a worker.</code>&#13;
&#13;
<code class="gp">$ </code>ssh<code class="w"> </code><code class="m">172</code>.17.4.3<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code><code class="s2">"sudo docker swarm join --token SWMTKN-1-14……a4o55z01zq 172.17.4.1:2377"</code><code class="w"/>&#13;
&#13;
<code class="go">This node joined a swarm as a worker.</code></pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Adding additional managers is important<a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="Swarm cluster manager added" data-type="indexterm" id="idm46803136602960"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="Swarm cluster managers" data-tertiary="manager added" data-type="indexterm" id="idm46803136601808"/> and can be done as easily as adding the workers. You just need to pass in the manager join token instead of the worker join token. You can get this token by running <code>docker swarm join-token manager</code> on any of the active nodes.</p>&#13;
</div>&#13;
&#13;
<p>If you rerun <code>docker node ls</code>, you should now see that you have a total of three nodes in your cluster, and only one of them is marked as the <code>Leader</code>:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>node<code class="w"> </code>ls<code class="w"/>&#13;
&#13;
<code class="go">ID      HOSTNAME      STATUS AVAILABILITY MANAGER STATUS ENGINE VERSION</code>&#13;
<code class="go">l9…82 * ip-172-17-4-1 Ready  Active       Leader         20.10.7</code>&#13;
<code class="go">3d…7b   ip-172-17-4-2 Ready  Active                      20.10.7</code>&#13;
<code class="go">ip…qe   ip-172-17-4-3 Ready  Active                      20.10.7</code></pre>&#13;
&#13;
<p>This is all that’s required to get a Swarm cluster up and running in Swarm mode (<a data-type="xref" href="#figure10-1">Figure 10-1</a>)!<a data-startref="ch10-upr" data-type="indexterm" id="idm46803136592544"/><a data-startref="ch10-upr2" data-type="indexterm" id="idm46803136591904"/></p>&#13;
&#13;
<figure><div class="figure" id="figure10-1">&#13;
<img alt="Simple Docker Swarm Cluster" src="assets/dur3_1001.png"/>&#13;
<h6><span class="label">Figure 10-1. </span>Simple Docker Swarm mode cluster</h6>&#13;
</div></figure>&#13;
&#13;
<p>The next thing you should do is create a network for your services to use. There is a default network called <code>ingress</code> in Swarm, but it is very easy to create additional ones for better isolation:<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="networking" data-type="indexterm" id="idm46803136588368"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="networking" data-type="indexterm" id="idm46803136587120"/><a data-primary="docker network" data-primary-sortas="docker-z" data-secondary="create" data-tertiary="Docker Swarm mode networking" data-type="indexterm" id="idm46803136585904"/><a data-primary="docker network" data-primary-sortas="docker-z" data-secondary="ls" data-type="indexterm" id="idm46803136584448"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>network<code class="w"> </code>create<code class="w"> </code>--driver<code class="o">=</code>overlay<code class="w"> </code>default-net<code class="w"/>&#13;
&#13;
<code class="go">ckwh5ph4ksthvx6843ytrl5ik</code>&#13;
&#13;
<code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>network<code class="w"> </code>ls<code class="w"/>&#13;
&#13;
<code class="go">NETWORK ID     NAME              DRIVER    SCOPE</code>&#13;
<code class="go">494e1a1bf8f3   bridge            bridge    local</code>&#13;
<code class="go">xqgshg0nurzu   default-net       overlay   swarm</code>&#13;
<code class="go">2e7d2d7aaf0f   docker_gwbridge   bridge    local</code>&#13;
<code class="go">df0376841891   host              host      local</code>&#13;
<code class="go">n8kjd6oa44fr   ingress           overlay   swarm</code>&#13;
<code class="go">b4720ea133d6   none              null      local</code></pre>&#13;
&#13;
<p>Up to this point, we’ve just been getting the underlying pieces running, and so far we haven’t deployed any real business logic. So let’s launch your first service into the cluster. You can do that with a command like this:<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="launching first service" data-type="indexterm" id="idm46803136541760"/><a data-primary="services" data-secondary="Docker Swarm mode" data-tertiary="launching first service" data-type="indexterm" id="idm46803136507248"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="launching first service" data-type="indexterm" id="idm46803136506064"/><a data-primary="docker service" data-primary-sortas="docker-z" data-secondary="create" data-type="indexterm" id="idm46803136504848"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>create<code class="w"> </code>--detach<code class="o">=</code><code class="nb">true</code><code class="w"> </code>--name<code class="w"> </code>quantum<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--replicas<code class="w"> </code><code class="m">2</code><code class="w"> </code>--publish<code class="w"> </code><code class="nv">published</code><code class="o">=</code><code class="m">80</code>,target<code class="o">=</code><code class="m">8080</code><code class="w"> </code>--network<code class="w"> </code>default-net<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>spkane/quantum-game:latest<code class="w"/>&#13;
&#13;
<code class="go">tiwtsbf270mh83032kuhwv07c</code></pre>&#13;
&#13;
<p>The service we’re launching with starts<a data-primary="Quantum web game in Docker Swarm mode" data-type="indexterm" id="idm46803136478976"/> containers that host the <a href="https://github.com/stared/quantum-game"><em>Quantum game</em></a>. This is a browser-based puzzle game that uses real quantum mechanics. We hope that this is a more interesting example than another Hello World!</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>Although we’re using the <code>latest</code> tag in many<a data-primary="production" data-secondary="latest tag not used" data-type="indexterm" id="idm46803136440400"/><a data-primary="latest tag" data-secondary="not in production" data-type="indexterm" id="idm46803136439392"/><a data-primary="image tags" data-secondary="latest tag" data-tertiary="not in production" data-type="indexterm" id="idm46803136438448"/> of these examples, you shouldn’t ever use this tag in production. It is convenient for this book since we can easily push out updates to the code, but this tag floats and cannot be pinned to a specific release over a long period. That means if you use <code>latest</code>, then your deployments are not repeatable! It can also easily lead to a situation where you don’t have the same version of an application running on all the servers.</p>&#13;
</div>&#13;
&#13;
<p>Let’s see where those containers ended up by running <code>docker service ps</code> against the service name you created:<a data-primary="docker service" data-primary-sortas="docker-z" data-secondary="ps" data-type="indexterm" id="idm46803136435760"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>ps<code class="w"> </code>quantum<code class="w"/>&#13;
&#13;
<code class="go">ID    NAME      IMAGE       NODE          DESIRED… CURRENT… ERROR PORTS</code>&#13;
<code class="go">rk…13 quantum.1 spkane/qua… ip-172-17-4-1 Running  Running…</code>&#13;
<code class="go">lz…t3 quantum.2 spkane/qua… ip-172-17-4-2 Running  Running…</code></pre>&#13;
&#13;
<p>Swarm mode uses a routing mesh<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="routing mesh between nodes" data-type="indexterm" id="idm46803136428240"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="routing mesh between nodes" data-type="indexterm" id="idm46803136418544"/> between the nodes to automatically route traffic to a container that can serve the request. When you specify a published port in the <code>docker service create</code> command, the mesh makes it possible to hit this port on any of your three nodes and will route you to the web application. Notice that we said any of the <em>three</em> nodes even though you only have two instances running. Traditionally, you would have also had to set up a separate reverse proxy layer to accomplish this, but its batteries are included with Swarm mode.</p>&#13;
&#13;
<p>To prove it, you can test the service now by pointing a web browser to the IP address of any of your nodes:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">http://172.17.4.1/</pre>&#13;
&#13;
<p>If everything is working as expected, you should see the first puzzle board for <a href="https://quantumgame.io">the <em>Quantum Game</em></a>:<a data-primary="docker service" data-primary-sortas="docker-z" data-secondary="ls" data-type="indexterm" id="idm46803136413824"/></p>&#13;
<pre>To get a list of all the services, we can use +service ls+:</pre>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>ls<code class="w"/>&#13;
&#13;
<code class="go">ID    NAME    MODE       REPLICAS IMAGE                      PORTS</code>&#13;
<code class="go">iu…9f quantum replicated 2/2      spkane/quantum-game:latest *:80-&gt;8080/tcp</code></pre>&#13;
&#13;
<p>This gives us a summary view of the most commonly needed information, but sometimes that’s not enough. <a data-primary="metadata about services" data-type="indexterm" id="idm46803136383120"/><a data-primary="services" data-secondary="metadata about services" data-type="indexterm" id="idm46803136382512"/>Docker maintains a lot of other metadata about services, just like it does for containers. We can get detailed information about a service with <code>service inspect</code>:<a data-primary="docker service" data-primary-sortas="docker-z" data-secondary="inspect --pretty" data-type="indexterm" id="idm46803136381120"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>inspect<code class="w"> </code>--pretty<code class="w"> </code>quantum<code class="w"/></pre>&#13;
&#13;
<pre class="nomargin" data-code-language="yaml" data-type="programlisting"><code class="nt">ID</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">iuoh6oxrec9fk67ybwuikutqa</code><code class="w"/>&#13;
<code class="nt">Name</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">quantum</code><code class="w"/>&#13;
<code class="nt">Service Mode</code><code class="p">:</code><code class="w">  </code><code class="l-Scalar-Plain">Replicated</code><code class="w"/>&#13;
<code class="w"> </code><code class="l-Scalar-Plain">Replicas</code><code class="p-Indicator">:</code><code class="w">  </code><code class="l-Scalar-Plain">2</code><code class="w"/>&#13;
<code class="nt">Placement</code><code class="p">:</code><code class="w"/>&#13;
<code class="nt">UpdateConfig</code><code class="p">:</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Parallelism</code><code class="p">:</code><code class="w">  </code><code class="l-Scalar-Plain">1</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">On failure</code><code class="p">:</code><code class="w">  </code><code class="l-Scalar-Plain">pause</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Monitoring Period</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">5s</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Max failure ratio</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Update order</code><code class="p">:</code><code class="w">      </code><code class="l-Scalar-Plain">stop-first</code><code class="w"/>&#13;
<code class="nt">RollbackConfig</code><code class="p">:</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Parallelism</code><code class="p">:</code><code class="w">  </code><code class="l-Scalar-Plain">1</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">On failure</code><code class="p">:</code><code class="w">  </code><code class="l-Scalar-Plain">pause</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Monitoring Period</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">5s</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Max failure ratio</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Rollback order</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">stop-first</code><code class="w"/>&#13;
<code class="nt">ContainerSpec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Image</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">spkane/quantum-game:latest@sha256:1f57…4a8c</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Init</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">false</code><code class="w"/>&#13;
<code class="nt">Resources</code><code class="p">:</code><code class="w"/>&#13;
<code class="nt">Networks</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">default-net</code><code class="w"/>&#13;
<code class="nt">Endpoint Mode</code><code class="p">:</code><code class="w">  </code><code class="l-Scalar-Plain">vip</code><code class="w"/>&#13;
<code class="nt">Ports</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">PublishedPort = 80</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">Protocol = tcp</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">TargetPort = 8080</code><code class="w"/>&#13;
<code class="w">  </code><code class="l-Scalar-Plain">PublishMode = ingress</code><code class="w"/></pre>&#13;
&#13;
<p>There is a lot of info here, so let’s point out some of the more important things. First, we can see that this is a replicated service with two replicas, just like we saw in the <code>service ls</code> command. We can also see that Docker is health-checking the service at 5-second intervals. Running an update to the service will use the <code>stop-first</code> method, which means it will take our service first to <em>N</em>−1 and then spin up a new instance to take us back to <em>N</em>. You might want to always run in <em>N</em>+1 mode so that you are never down a node during updates in production. You can change that with the <code>--update-order=start-first</code> option to the <code>service update</code> command. It will exhibit the same behavior in a rollback scenario, and we can likewise change that with <code>--rollback-order=start-first</code>.</p>&#13;
&#13;
<p>In a real-world scenario, we not only need<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="launching first service" data-tertiary="scaling up or down" data-type="indexterm" id="idm46803136147440"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="scaling service up or down" data-type="indexterm" id="idm46803136145920"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="scaling" data-tertiary="scaling service up or down" data-type="indexterm" id="idm46803136144736"/><a data-primary="services" data-secondary="Docker Swarm mode" data-tertiary="scaling service up or down" data-type="indexterm" id="idm46803136143280"/> to be able to launch our service, but we also need to be able to scale it up and down. It would be a shame if we had to redeploy it to do that, not to mention it could introduce any number of additional issues. Luckily, Swarm mode makes it easy to scale our services with a single command. To double the number of instances you have running from two to four, you can simply run this:<a data-primary="docker service" data-primary-sortas="docker-z" data-secondary="scale" data-type="indexterm" id="idm46803136141968"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>scale<code class="w"> </code>--detach<code class="o">=</code><code class="nb">false</code><code class="w"> </code><code class="nv">quantum</code><code class="o">=</code><code class="m">4</code><code class="w"/>&#13;
&#13;
<code class="go">quantum scaled to 4</code>&#13;
<code class="go">overall progress: 4 out of 4 tasks</code>&#13;
<code class="go">1/4: running   [==================================================&gt;]</code>&#13;
<code class="go">2/4: running   [==================================================&gt;]</code>&#13;
<code class="go">3/4: running   [==================================================&gt;]</code>&#13;
<code class="go">4/4: running   [==================================================&gt;]</code>&#13;
<code class="go">verify: Service converged</code></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>We used <code>--detach=false</code> in the previous command so that it was easier to see what was happening.<a data-primary="docker service" data-primary-sortas="docker-z" data-secondary="scale" data-tertiary="--detach=false" data-tertiary-sortas="detach=false" data-type="indexterm" id="idm46803136085424"/></p>&#13;
</div>&#13;
&#13;
<p>We can now use <code>service ps</code> to show us that Swarm did what we asked. This is the same command we ran earlier, but now we should have more copies running! But wait, didn’t we ask for more copies than we have nodes?<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="more services than nodes" data-type="indexterm" id="idm46803136082672"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="more services than nodes" data-type="indexterm" id="idm46803136081456"/><a data-primary="services" data-secondary="Docker Swarm mode" data-tertiary="more services than nodes" data-type="indexterm" id="idm46803136080272"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>ps<code class="w"> </code>quantum<code class="w"/>&#13;
&#13;
<code class="go">ID    NAME      IMAGE        NODE          DESIRED… CURRENT… ERROR PORTS</code>&#13;
<code class="go">rk…13 quantum.1 spkane/quan… ip-172-17-4-1 Running  Running…</code>&#13;
<code class="go">lz…t3 quantum.2 spkane/quan… ip-172-17-4-2 Running  Running…</code>&#13;
<code class="go">mh…g8 quantum.3 spkane/quan… ip-172-17-4-3 Running  Running…</code>&#13;
<code class="go">cn…xb quantum.4 spkane/quan… ip-172-17-4-1 Running  Running…</code></pre>&#13;
&#13;
<p>You’ll notice that you have two services running on the same host. Did you expect that? This may not be ideal for host resiliency, but by default Swarm will prioritize ensuring that you have the number of instances that you requested over spreading individual containers across hosts when possible. If you don’t have enough nodes, you will get multiple copies on each node. In a real-world scenario, you need to think carefully about placement and scaling. You might not be able to get away with running multiple copies on the same host when you lose a whole node. Would your application still serve users at that reduced scale?</p>&#13;
&#13;
<p>When you need to deploy a new release<a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="updating software" data-type="indexterm" id="idm46803136103328"/><a data-primary="updating software in Swarm mode" data-type="indexterm" id="idm46803136102208"/> of your software, you will want to use the <code>docker service update</code> command. There are a lot of options for this command, but here’s one example:<a data-primary="docker service" data-primary-sortas="docker-z" data-secondary="update" data-type="indexterm" id="idm46803136047312"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>update<code class="w"> </code>--update-delay<code class="w"> </code>10s<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--update-failure-action<code class="w"> </code>rollback<code class="w"> </code>--update-monitor<code class="w"> </code>5s<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--update-order<code class="w"> </code>start-first<code class="w"> </code>--update-parallelism<code class="w"> </code><code class="m">1</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--detach<code class="o">=</code><code class="nb">false</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--image<code class="w"> </code>spkane/quantum-game:latest-plus<code class="w"> </code>quantum<code class="w"/>&#13;
&#13;
<code class="go">quantum</code>&#13;
<code class="go">overall progress: 4 out of 4 tasks</code>&#13;
<code class="go">1/4: running   [==================================================&gt;]</code>&#13;
<code class="go">2/4: running   [==================================================&gt;]</code>&#13;
<code class="go">3/4: running   [==================================================&gt;]</code>&#13;
<code class="go">4/4: running   [==================================================&gt;]</code>&#13;
<code class="go">verify: Service converged</code></pre>&#13;
&#13;
<p class="pagebreak-before">Running this command will cause Swarm to update your service one container at a time, pausing in between each update. Once this is done, you should be able to open up the service’s URL in a new private or incognito browsing session (to sidestep the browser’s local cache) and see that the game background is now green instead of blue.</p>&#13;
&#13;
<p>Great, you have now successfully <a data-primary="updating software in Swarm mode" data-secondary="rollback" data-type="indexterm" id="idm46803135974080"/><a data-primary="rollbacks" data-secondary="software update" data-type="indexterm" id="idm46803135973232"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="updating software" data-tertiary="rollbacks" data-type="indexterm" id="idm46803135972288"/><a data-primary="debugging" data-secondary="updates with rollbacks" data-type="indexterm" id="idm46803135970800"/><a data-primary="docker service" data-primary-sortas="docker-z" data-secondary="rollback" data-type="indexterm" id="idm46803135969856"/>applied an update, but what if something were to go wrong? We might need to deploy a previous release to get back to working order. You could now roll back to the previous version, with the correct blue background, by using the <code>service rollback</code> command, which we discussed in passing a little bit earlier:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>rollback<code class="w"> </code>quantum<code class="w"/>&#13;
&#13;
<code class="go">quantum</code>&#13;
<code class="go">rollback: manually requested rollback</code>&#13;
<code class="go">overall progress: rolling back update: 4 out of 4 tasks</code>&#13;
<code class="go">1/4: running   [&gt;                                                  ]</code>&#13;
<code class="go">2/4: running   [&gt;                                                  ]</code>&#13;
<code class="go">3/4: running   [&gt;                                                  ]</code>&#13;
<code class="go">4/4: running   [&gt;                                                  ]</code>&#13;
<code class="go">verify: Service converged</code></pre>&#13;
&#13;
<p>That’s about as nice a rollback mechanism as you could ask for a stateless service. You don’t have to keep track of the previous version; Docker does that for you. All you need to do is tell it to roll back and it pulls the previous metadata out of its internal storage and performs the rollback. Just like during deployment, Docker can health-check your containers to make sure the rollback is working correctly.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>This rollback mechanism will always go back to the last deployed version, so if you run it multiple times in a row, it will just flip between two versions.</p>&#13;
</div>&#13;
&#13;
<p>Building on <code>docker service</code> is a command called <code>docker stack</code>, which<a data-primary="docker stack" data-primary-sortas="docker-z" data-type="indexterm" id="ch10-stack"/><a data-primary="Docker Swarm mode" data-primary-sortas="docker-a" data-secondary="docker stack" data-type="indexterm" id="ch10-stack2"/><a data-primary="cloud deployments" data-secondary="Docker Swarm mode" data-tertiary="docker stack" data-type="indexterm" id="ch10-stack3"/> enables you to deploy a specially designed <em>docker-compose.yaml</em> file to a Docker Swarm mode or Kubernetes cluster. If you go back and check out the Git repo that we used in <a data-type="xref" href="ch08.html#docker_compose">Chapter 8</a>, we can deploy a modified version of that container stack into our current Swarm mode cluster:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>git<code class="w"> </code>clone<code class="w"> </code>https://github.com/spkane/rocketchat-hubot-demo.git<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--config<code class="w"> </code>core.autocrlf<code class="o">=</code>input<code class="w"/></pre>&#13;
&#13;
<p>Inside that repository is a directory called <em>stack</em> that contains a modified version of the <em>docker-compose.yaml</em> file that we used earlier:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code><code class="nb">cd</code><code class="w"> </code>rocketchat-hubot-demo/stack<code class="w"/></pre>&#13;
&#13;
<p>If you wanted to spin up this setup in the Swarm mode cluster, you could run the following command:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>stack<code class="w"> </code>deploy<code class="w"> </code>--compose-file<code class="w"> </code>docker-compose-stack.yaml<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>rocketchat<code class="w"/>&#13;
&#13;
<code class="go">Creating network rocketchat_default</code>&#13;
<code class="go">Creating service rocketchat_hubot</code>&#13;
<code class="go">Creating service rocketchat_mongo</code>&#13;
<code class="go">Creating service rocketchat_rocketchat</code>&#13;
<code class="go">Creating service rocketchat_zmachine</code></pre>&#13;
&#13;
<p>Now you can list what stacks are in the cluster and see what services were added by the stack:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>stack<code class="w"> </code>ls<code class="w"/>&#13;
&#13;
<code class="go">NAME         SERVICES   ORCHESTRATOR</code>&#13;
<code class="go">rocketchat   4          Swarm</code>&#13;
&#13;
<code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>ls<code class="w"/>&#13;
&#13;
<code class="go">ID    NAME         …  …  IMAGE                              PORTS</code>&#13;
<code class="go">iu…9f quantum      … 2/2 spkane/quantum-game:latest         *:80-&gt;8080/tcp</code>&#13;
<code class="go">nh…jd …_hubot      … 1/1 rocketchat/hubot-rocketchat:latest *:3001-&gt;8080/tcp</code>&#13;
<code class="go">gw…qv …_mongo      … 1/1 spkane/mongo:4.4</code>&#13;
<code class="go">m3…vd …_rocketchat … 1/1 rocketchat/rocket.chat:5.0.4       *:3000-&gt;3000/tcp</code>&#13;
<code class="go">lb…91 …_zmachine   … 1/1 spkane/zmachine-api:latest</code></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>This stack is for basic demonstration purposes and has not been well tested for this use case; however, it should give you an idea of how you could assemble something similar.</p>&#13;
&#13;
<p>You may notice that it takes a while for all the containers to come up and that Hubot will continue to restart. This is expected since Rocket.Chat has not been configured yet. The Rocket.Chat setup is covered in <a data-type="xref" href="ch08.html#docker_compose">Chapter 8</a>.</p>&#13;
</div>&#13;
&#13;
<p>At this point, you could point your web browser at port 3000 on one of the Swarm nodes (e.g., <em>http://172.17.4.1:3000/</em> in these examples), and you should see the initial setup page for Rocket.Chat.</p>&#13;
&#13;
<p>You can see all the containers that are managed by the stack, with <code>docker stack ps</code>:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>stack<code class="w"> </code>ps<code class="w"> </code>-f<code class="w"> </code><code class="s2">"desired-state=running"</code><code class="w"> </code>rocketchat<code class="w"/>&#13;
&#13;
<code class="go">ID    NAME           IMAGE                    NODE … CURRENT STATE           …</code>&#13;
<code class="go">b5…1h …_hubot.1      rocketchat/hubot-rocket… …-1  … Running 14 seconds ago</code>&#13;
<code class="go">eq…88 …_mongo.1      spkane/mongo:4.4         …-2  … Running 11 minutes ago</code>&#13;
<code class="go">5x…8u …_rocketchat.1 rocketchat/rocket.chat:… …-3  … Running 11 minutes ago</code>&#13;
<code class="go">r5…x4 …_zmachine.1   spkane/zmachine-api:lat… …-4  … Running 12 minutes ago</code></pre>&#13;
&#13;
<p>When you are done, you can go ahead and tear down the stack like this:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>stack<code class="w"> </code>rm<code class="w"> </code>rocketchat<code class="w"/>&#13;
&#13;
<code class="go">Removing service rocketchat_hubot</code>&#13;
<code class="go">Removing service rocketchat_mongo</code>&#13;
<code class="go">Removing service rocketchat_rocketchat</code>&#13;
<code class="go">Removing service rocketchat_zmachine</code>&#13;
<code class="go">Removing network rocketchat_default</code></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>If you try to immediately spin everything back up, you might get some unexpected errors. Just waiting a few moments should fix things while the cluster finishes tearing down the old network for the stack, etc.<a data-startref="ch10-stack" data-type="indexterm" id="idm46803135673632"/><a data-startref="ch10-stack2" data-type="indexterm" id="idm46803135672992"/><a data-startref="ch10-stack3" data-type="indexterm" id="idm46803135672320"/></p>&#13;
</div>&#13;
&#13;
<p>So, what happens if one of your servers<a data-primary="docker node" data-primary-sortas="docker-z" data-secondary="update" data-tertiary="--availability drain" data-tertiary-sortas="availability drain" data-type="indexterm" id="idm46803135671136"/><a data-primary="docker node" data-primary-sortas="docker-z" data-secondary="drain" data-type="indexterm" id="idm46803135669344"/><a data-primary="services" data-secondary="draining off a single node" data-type="indexterm" id="idm46803135668128"/> is experiencing an issue and you need to take it offline? In this case, you can easily drain all the services off of a single node by using the <code>--availability</code> option to the <code>docker node update</code> command.</p>&#13;
&#13;
<p>Let’s take a look at the nodes that you have in the cluster again:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="go"> docker -H 172.17.4.1 node ls</code>&#13;
&#13;
<code class="go">ID      HOSTNAME      STATUS AVAILABILITY MANAGER STATUS ENGINE VERSION</code>&#13;
<code class="go">l9…82 * ip-172-17-4-1 Ready  Active       Leader         20.10.7</code>&#13;
<code class="go">3d…7b   ip-172-17-4-2 Ready  Active                      20.10.7</code>&#13;
<code class="go">ip…qe   ip-172-17-4-3 Ready  Active                      20.10.7</code></pre>&#13;
&#13;
<p>Let’s also check where our containers are currently running:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>ps<code class="w"> </code>-f<code class="w"> </code><code class="s2">"desired-state=running"</code><code class="w"> </code>quantum<code class="w"/>&#13;
&#13;
<code class="go">ID    NAME        IMAGE       NODE          DESIRED… CURRENT… ERROR   PORTS</code>&#13;
<code class="go">sc…1h quantum.1   spkane/qua… ip-172-17-4-1 Running  Running…</code>&#13;
<code class="go">ax…om quantum.2   spkane/qua… ip-172-17-4-2 Running  Running…</code>&#13;
<code class="go">p4…8h quantum.3   spkane/qua… ip-172-17-4-3 Running  Running…</code>&#13;
<code class="go">g8…tw quantum.4   spkane/qua… ip-172-17-4-1 Running  Running…</code></pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>In the previous command, we used a filter so that the output showed only the currently running processes. By default, Docker will also show you the previous containers that were running in a tree format so that you can see things like updates and rollbacks in the output.</p>&#13;
</div>&#13;
&#13;
<p class="pagebreak-before">If you have determined that the server at 172.17.4.3 needs downtime, you could drain the tasks of that node and move them to another host by modifying the <code>availability</code> state to <code>drain</code> in Swarm:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>node<code class="w"> </code>update<code class="w"> </code>--availability<code class="w"> </code>drain<code class="w"> </code>ip-172-17-4-3<code class="w"/>&#13;
&#13;
<code class="go">ip-172-17-4-3</code></pre>&#13;
&#13;
<p>If we inspect the node, we can see that the availability is now set to <code>drain</code>:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>node<code class="w"> </code>inspect<code class="w"> </code>--pretty<code class="w"> </code>ip-172-17-4-3<code class="w"/></pre>&#13;
&#13;
<pre class="nomargin" data-code-language="yaml" data-type="programlisting"><code class="nt">ID</code><code class="p">:</code><code class="w">      </code><code class="l-Scalar-Plain">ipohyw73hvf70td9licnls9qe</code><code class="w"/>&#13;
<code class="nt">Hostname</code><code class="p">:</code><code class="w">                </code><code class="l-Scalar-Plain">ip-172-17-4-3</code><code class="w"/>&#13;
<code class="nt">Joined at</code><code class="p">:</code><code class="w">               </code><code class="l-Scalar-Plain">2022-09-04 16:59:52.922451346 +0000 utc</code><code class="w"/>&#13;
<code class="nt">Status</code><code class="p">:</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">State</code><code class="p">:</code><code class="w">      </code><code class="l-Scalar-Plain">Ready</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Availability</code><code class="p">:</code><code class="w">           </code><code class="l-Scalar-Plain">Drain</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Address</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">172.17.4.3</code><code class="w"/>&#13;
<code class="nt">Platform</code><code class="p">:</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Operating System</code><code class="p">:</code><code class="w">  </code><code class="l-Scalar-Plain">linux</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Architecture</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">x86_64</code><code class="w"/>&#13;
<code class="nt">Resources</code><code class="p">:</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">CPUs</code><code class="p">:</code><code class="w">      </code><code class="l-Scalar-Plain">2</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Memory</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">7.795GiB</code><code class="w"/>&#13;
<code class="nt">Plugins</code><code class="p">:</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Log</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">awslogs, fluentd, gcplogs, gelf, journald, json-file, local,</code><code class="w"/>&#13;
<code class="w">         </code><code class="l-Scalar-Plain">logentries, splunk, syslog</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Network</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">bridge, host, ipvlan, macvlan, null, overlay</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">Volume</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">local</code><code class="w"/>&#13;
<code class="nt">Engine Version</code><code class="p">:</code><code class="w">    </code><code class="l-Scalar-Plain">20.10.7</code><code class="w"/>&#13;
<code class="nt">TLS Info</code><code class="p">:</code><code class="w"/>&#13;
<code class="w"> </code><code class="nt">TrustRoot</code><code class="p">:</code><code class="w"/>&#13;
<code class="l-Scalar-Plain">…</code><code class="w"/>&#13;
&#13;
<code class="w"> </code><code class="l-Scalar-Plain">Issuer Subject</code><code class="p-Indicator">:</code><code class="w">  </code><code class="l-Scalar-Plain">…</code><code class="w"/>&#13;
<code class="w"> </code><code class="l-Scalar-Plain">Issuer Public Key</code><code class="p-Indicator">:</code><code class="w">  </code><code class="l-Scalar-Plain">…</code><code class="w"/></pre>&#13;
&#13;
<p>You might be wondering what effect that has on the service. We told one of the nodes to stop running copies of the service, and they either have to go away or migrate somewhere else. What did it do? We can look at the details of our service again and see that all the running containers on that host have been moved to a different node:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>ps<code class="w"> </code>-f<code class="w"> </code><code class="s2">"desired-state=running"</code><code class="w"> </code>quantum<code class="w"/>&#13;
&#13;
<code class="go">ID    NAME        IMAGE       NODE          DESIRED… CURRENT… ERROR   PORTS</code>&#13;
<code class="go">sc…1h quantum.1   spkane/qua… ip-172-17-4-1 Running  Running…</code>&#13;
<code class="go">ax…om quantum.2   spkane/qua… ip-172-17-4-2 Running  Running…</code>&#13;
<code class="go">p4…8h quantum.3   spkane/qua… ip-172-17-4-2 Running  Running…</code>&#13;
<code class="go">g8…tw quantum.4   spkane/qua… ip-172-17-4-1 Running  Running…</code></pre>&#13;
&#13;
<p>At this point, it is safe to bring down the node and do whatever work is required to make it healthy again. When you are ready to add the node back into the Swarm cluster, you can do so by running the following:<a data-primary="docker node" data-primary-sortas="docker-z" data-secondary="update" data-tertiary="--availability active" data-tertiary-sortas="availability active" data-type="indexterm" id="idm46803135440480"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>node<code class="w"> </code>update<code class="w"> </code>--availability<code class="w"> </code>active<code class="w"> </code>ip-172-17-4-3<code class="w"/>&#13;
&#13;
<code class="go">ip-172-17-4-3</code></pre>&#13;
&#13;
<p>We’ll spare you from reinspecting the node at the moment, but you can always rerun the <code>node inspect</code> command if you want to see what this looks like.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>When you add a node back to the cluster, containers will not automatically balance! However, a new deployment or update should result in the containers being evenly spread across the nodes.</p>&#13;
</div>&#13;
&#13;
<p>Once you are done, you can remove your service and network with the following commands:<a data-primary="services" data-secondary="removing" data-type="indexterm" id="idm46803135435936"/><a data-primary="docker service" data-primary-sortas="docker-z" data-secondary="rm" data-type="indexterm" id="idm46803135434960"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>rm<code class="w"> </code>quantum<code class="w"/>&#13;
&#13;
<code class="go">quantum</code>&#13;
&#13;
<code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>network<code class="w"> </code>rm<code class="w"> </code>default-net<code class="w"/>&#13;
&#13;
<code class="go">default-net</code></pre>&#13;
&#13;
<p>And then verify that they are both indeed completely gone:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>service<code class="w"> </code>ps<code class="w"> </code>quantum<code class="w"/>&#13;
&#13;
<code class="go">no such service: quantum</code>&#13;
&#13;
<code class="gp">$ </code>docker<code class="w"> </code>-H<code class="w"> </code><code class="m">172</code>.17.4.1<code class="w"> </code>network<code class="w"> </code>ls<code class="w"/>&#13;
&#13;
<code class="go">NETWORK ID     NAME              DRIVER    SCOPE</code>&#13;
<code class="go">494e1a1bf8f3   bridge            bridge    local</code>&#13;
<code class="go">2e7d2d7aaf0f   docker_gwbridge   bridge    local</code>&#13;
<code class="go">df0376841891   host              host      local</code>&#13;
<code class="go">n8kjd6oa44fr   ingress           overlay   swarm</code>&#13;
<code class="go">b4720ea133d6   none              null      local</code></pre>&#13;
&#13;
<p>That’s all for now! At this point, you can safely tear down all of the servers that were a part of your Swarm cluster if you no longer need them.</p>&#13;
&#13;
<p>That was kind of a whirlwind tour, but it covers the basics of using Swarm mode in Docker Engine and should help get you started building your own Docker clusters wherever you might decide to use them.<a data-startref="ch10-scal" data-type="indexterm" id="idm46803135199088"/><a data-startref="ch10-scal2" data-type="indexterm" id="idm46803135198480"/><a data-startref="ch10-scal3" data-type="indexterm" id="idm46803135197840"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubernetes" data-type="sect1"><div class="sect1" id="idm46803137052544">&#13;
<h1>Kubernetes</h1>&#13;
&#13;
<p>Now let’s take some time to look at Kubernetes.<a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="about" data-type="indexterm" id="idm46803137051008"/><a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="about" data-type="indexterm" id="idm46803135178528"/> Since its release to the public during <a href="https://events.docker.com/events/dockercon">DockerCon</a> 2014, Kubernetes has grown rapidly and is now probably the most widely adopted of the container platforms. It is not the oldest or most mature product today—that distinction goes to Mesos, which first launched in 2009 before containers were in widespread use—but Kubernetes was purpose-built for containerized workloads, has a great mix of functionality that is ever evolving, and also enjoys a very strong community that includes many early Docker and Linux container adopters. This mix has helped significantly increase its popularity over the years. At DockerCon EU 2017, Docker, Inc., announced that Kubernetes support will be coming to the Docker Engine tooling itself. Docker Desktop is capable of spinning up a single-node Kubernetes cluster, and the client can deploy container stacks for development purposes. This provides a nice bridge for developers who use Docker locally but deploy to Kubernetes.</p>&#13;
&#13;
<p>Like Linux itself, Kubernetes is available in several distributions, both free and commercial. There is a wide variety of distributions that are available and supported to varying degrees. Kubernetes widespread adoption means that it now has some pretty nice tooling for local development installations.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>The Kubernetes coverage in this book is intended to provide some basic guidance on how you can integrate your Linux container workflow with Kubernetes, but we do not go into a lot of detail about the Kubernetes ecosystem here. <a data-primary="Kubernetes: Up and Running (Burns et al.)" data-type="indexterm" id="idm46803135175168"/><a data-primary="Burns, Brandan" data-type="indexterm" id="idm46803135174432"/>We highly recommend reading <a href="https://www.oreilly.com/library/view/kubernetes-up-and/9781098110192"><em>Kubernetes: Up &amp; Running</em>, by Brendan Burns et al. (O’Reilly)</a>, or any of the other great materials out there to familiarize yourself with all the relevant concepts and terminology.</p>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Minikube" data-type="sect2"><div class="sect2" id="idm46803135172336">&#13;
<h2>Minikube</h2>&#13;
&#13;
<p>Minikube was one of the original<a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="Minikube" data-type="indexterm" id="ch10-scalmin"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="Minikube" data-type="indexterm" id="ch10-scalmin2"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-type="indexterm" id="ch10-scalmin3"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="about" data-type="indexterm" id="idm46803135166512"/> tools for managing a local Kubernetes installation and is the first one that we will be focusing on here. Most of the concepts that you’ll learn while working with Minikube can be applied to any Kubernetes implementation, including the options that we’ll discuss after Minikube, so it’s a great place &#13;
<span class="keep-together">to start.</span></p>&#13;
<div class="less_space pagebreak-before" data-type="tip"><h6>Tip</h6>&#13;
<p>There are many other options for running a local Kubernetes cluster. We are starting with <code>minikube</code> because the container or VM that it spins up is a pretty standard single-node Kubernetes install. In addition to the tools that we will be discussing in this section, <a data-primary="k3s" data-type="indexterm" id="idm46803135162640"/><a data-primary="k3d" data-type="indexterm" id="idm46803135161936"/><a data-primary="k0s" data-type="indexterm" id="idm46803135161264"/><a data-primary="microk8s" data-type="indexterm" id="idm46803135160592"/><a data-primary="k8s" data-see="Kubernetes" data-type="indexterm" id="idm46803135159920"/>we highly recommend exploring <a href="https://k3s.io">k3s</a>, <a href="https://k3d.io">k3d</a>, <a href="https://k0sproject.io">k0s</a>, and <a href="https://microk8s.io">microk8s</a> as well.</p>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What Is Minikube?" data-type="sect3"><div class="sect3" id="idm46803135155904">&#13;
<h3>What Is Minikube?</h3>&#13;
&#13;
<p>Minikube is a whole distribution<a data-primary="Minikube" data-secondary="description of" data-type="indexterm" id="idm46803135154576"/> of Kubernetes for a single instance. It manages a container or VM on your computer that presents a working Kubernetes installation and allows you to use all the same tooling that you would use in a production system. In scope, it’s a little bit like Docker Compose: it will let you stand up a whole stack locally. It goes one step further than Compose, though, in that it has all the production APIs. As a result, if you run Kubernetes in production, you can have an environment on your desktop that is reasonably close in function, if not in scale, to what you are running in production.</p>&#13;
&#13;
<p>Minikube is fairly unique in that all of the distribution is controlled from a single binary you download and run locally. It will automatically detect which containerization or VM manager you have locally and will set up and run a container or VM with all of the necessary Kubernetes services in it. That means getting started with it is pretty simple.</p>&#13;
&#13;
<p>So let’s install it!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Installing Minikube" data-type="sect3"><div class="sect3" id="idm46803135152384">&#13;
<h3>Installing Minikube</h3>&#13;
&#13;
<p>Most of the installation is the same<a data-primary="Minikube" data-secondary="installing" data-tertiary="about" data-type="indexterm" id="idm46803135150848"/> across all platforms because once you have the tools installed, they will be your gateway to the VM running your Kubernetes installation. To get started, just skip to the section that applies to your operating system. Once you have the tool up and running, you can follow the shared documentation.</p>&#13;
&#13;
<p>We need two tools to use Minikube effectively:<a data-primary="kubectl command" data-secondary="about" data-type="indexterm" id="idm46803135149088"/> <code>minikube</code> and <code>kubectl</code>. For our simple installation, we’re going to leverage the fact that both of these commands are static binaries with no outside dependencies, which makes them easy to install.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>There are several other ways to install Minikube. We’re going to show you what we think is the simplest path on each platform. If you have strong preferences about how to install these applications, feel free to use your preferred approach. On Windows, for example, you might prefer to use the <a href="https://chocolatey.org">Chocolatey package manager</a>, or the <a href="https://snapcraft.io">Snap package system</a> on Linux.</p>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="macOS" data-type="sect4"><div class="sect4" id="idm46803135144432">&#13;
<h4>macOS</h4>&#13;
&#13;
<p>Just as in <a data-type="xref" href="ch03.html#installing_docker">Chapter 3</a>, you will need<a data-primary="Minikube" data-secondary="installing" data-tertiary="macOS" data-type="indexterm" id="idm46803135141680"/><a data-primary="kubectl command" data-secondary="installing with Minikube" data-tertiary="macOS" data-type="indexterm" id="idm46803135140400"/><a data-primary="macOS running Docker" data-secondary="Minikube installation" data-type="indexterm" id="idm46803135139168"/> to have Homebrew installed on your system. If you don’t, go back to <a data-type="xref" href="ch03.html#installing_docker">Chapter 3</a> and make sure you have it set up. Once you do, it’s trivial to install the <code>minikube</code> client:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>brew<code class="w"> </code>install<code class="w"> </code>minikube<code class="w"/></pre>&#13;
&#13;
<p>This will cause Homebrew to download and install Minikube. It will look something like this depending, on your configuration:</p>&#13;
<pre data-code-language="text" data-type="programlisting">&#13;
<code>==&gt; Downloading https://ghcr.io/v2/homebrew/core/kubernetes-cli/…/1.25.0&#13;
Already downloaded: …/Homebrew/downloads/…kubernetes-cli…manifest.json&#13;
==&gt; Downloading https://ghcr.io/v2/homebrew/core/kubernetes-cli/blobs/sha256…&#13;
Already downloaded: …/Homebrew/downloads/…kubernetes-cli--1.25…bottle.tar.gz&#13;
==&gt; Downloading https://ghcr.io/v2/homebrew/core/minikube/manifests/1.26.1&#13;
Already downloaded: …/Homebrew/downloads/…minikube-1.26.1.…_manifest.json&#13;
==&gt; Downloading https://ghcr.io/v2/homebrew/core/minikube/blobs/sha256:…&#13;
Already downloaded: …/Homebrew/downloads/…minikube--1.26.1…bottle.tar.gz&#13;
==&gt; Installing dependencies for minikube: kubernetes-cli&#13;
==&gt; Installing minikube dependency: kubernetes-cli&#13;
==&gt; Pouring kubernetes-cli--1.25.0.arm64_monterey.bottle.tar.gz&#13;
</code><img src="assets/beer-mug_1f37a.png"/><code>  /opt/homebrew/Cellar/kubernetes-cli/1.25.0: 228 files, 52.8MB&#13;
==&gt; Installing minikube&#13;
==&gt; Pouring minikube--1.26.1.arm64_monterey.bottle.tar.gz&#13;
==&gt; Caveats&#13;
Bash completion has been installed to:&#13;
  /opt/homebrew/etc/bash_completion.d&#13;
==&gt; Summary&#13;
</code><img src="assets/beer-mug_1f37a.png"/><code>  /opt/homebrew/Cellar/minikube/1.26.1: 9 files, 70.6MB&#13;
==&gt; Running `brew cleanup minikube`…&#13;
Disable this behavior by setting HOMEBREW_NO_INSTALL_CLEANUP.&#13;
Hide these hints with HOMEBREW_NO_ENV_HINTS (see `man brew`).&#13;
==&gt; Caveats&#13;
==&gt; minikube&#13;
Bash completion has been installed to:&#13;
  /opt/homebrew/etc/bash_completion.d</code></pre>&#13;
&#13;
<p>That’s it! Let’s test to make sure it’s in your path:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>which<code class="w"> </code>minikube<code class="w"/>&#13;
<code class="go">/opt/homebrew/bin/minikube</code></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Homebrew on <em>arm64</em> systems install into <em>/opt/homebrew/bin</em> instead of <em>/usr/local/bin</em>.</p>&#13;
</div>&#13;
&#13;
<p>If you don’t get a response, you will need to make sure you have <em>/usr/local/bin</em> and <em>/opt/homebrew/bin</em> in your <code>PATH</code> environment variable. Assuming that passes, you now have the <code>minikube</code> tool installed.<a data-primary="environment variables" data-secondary="PATH" data-type="indexterm" id="idm46803135072688"/></p>&#13;
&#13;
<p><code>kubectl</code> should have been automatically installed since it is a dependency of <code>minikube</code>, but you can also do it explicitly with <code>brew</code> as well. Generally, the version of <code>kubectl</code> in Homebrew will match the current release of <code>minikube</code>, so using <code>brew install</code> should help prevent mismatches:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>brew<code class="w"> </code>install<code class="w"> </code>kubernetes-cli<code class="w"/></pre>&#13;
&#13;
<p>We’ll test that the same way we tested <code>minikube</code>:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>which<code class="w"> </code>kubectl<code class="w"/>&#13;
<code class="go">/opt/homebrew/bin/kubectl</code></pre>&#13;
&#13;
<p>We’re good to go!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Windows" data-type="sect4"><div class="sect4" id="idm46803135041632">&#13;
<h4>Windows</h4>&#13;
&#13;
<p>As with installing Docker Desktop on Windows,<a data-primary="Minikube" data-secondary="installing" data-tertiary="Windows" data-type="indexterm" id="idm46803135040096"/><a data-primary="Windows running Docker" data-secondary="Minikube installation" data-type="indexterm" id="idm46803135038848"/><a data-primary="kubectl command" data-secondary="installing with Minikube" data-tertiary="Windows" data-type="indexterm" id="idm46803135037904"/><a data-primary="environment variables" data-secondary="PATH" data-type="indexterm" id="idm46803135014576"/> you may want to install Hyper-V or another supported virtualization platform to run a Kubernetes VM. To install <code>minikube</code>, you simply download the binary and put it in a place you have in your <code>PATH</code> so that you can execute it on the command line. You can download the <a href="https://github.com/kubernetes/minikube/releases/latest">most recent release of <code>minikube</code> from GitHub</a>. You’ll want to rename the Windows executable that you download to <em>minikube.exe</em>; otherwise, you’ll be doing a lot more typing than you probably want!</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>You can find more details about the Windows install process and that binary executable from the <a href="https://minikube.sigs.k8s.io/docs/start">Minikube install documentaton</a>.</p>&#13;
</div>&#13;
&#13;
<p>You then need to get the latest Kubernetes CLI tool, <code>kubectl</code>, to interact with your distribution. Unfortunately, there is not a <em>/latest</em> path for downloading that. So, to make sure you have the latest version, you need to <a href="https://storage.googleapis.com/kubernetes-release/release/stable.txt">get the latest version</a> from the website and then plug it into a URL, like this:</p>&#13;
&#13;
<p><em>https://storage.googleapis.com/kubernetes-release/release/&lt;VERSION&gt;/bin/windows/amd64/kubectl.exe</em>.</p>&#13;
&#13;
<p>Once you’ve downloaded that, you again need to make sure it’s accessible from your <code>PATH</code> to make the rest of our exploration easier.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Linux" data-type="sect4"><div class="sect4" id="idm46803134989248">&#13;
<h4>Linux</h4>&#13;
&#13;
<p>On Linux, you will want to have Docker<a data-primary="Linux" data-secondary="Minikube installation" data-type="indexterm" id="idm46803134987648"/><a data-primary="Minikube" data-secondary="installing" data-tertiary="Linux" data-type="indexterm" id="idm46803134986800"/><a data-primary="kubectl command" data-secondary="installing with Minikube" data-tertiary="Linux" data-type="indexterm" id="idm46803134985712"/> installed and should consider installing either KVM (Linux’s Kernel-based Virtual Machine) or VirtualBox so that <code>minikube</code> can create and manage a Kubernetes VM for you. Because <code>minikube</code> is just a single binary, once you have it installed, there is no need to install any additional packages. And, because <code>minikube</code> is a statically linked binary, it should pretty much work on any distribution you want to run it on. Although we could do all the installation in a one-liner, we are going to break it up into a few steps to make it easier to understand and troubleshoot. Note that at the time of this writing, the binary is hosted on <em>googleapis</em>, which usually maintains very stable URLs. So, here we go:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp"># </code>Download<code class="w"> </code>the<code class="w"> </code>file,<code class="w"> </code>save<code class="w"> </code>as<code class="w"> </code><code class="s1">'minikube'</code><code class="w"/>&#13;
<code class="gp">$ </code>curl<code class="w"> </code>-Lo<code class="w"> </code>minikube<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64<code class="w"/>&#13;
&#13;
<code class="gp"># </code>Make<code class="w"> </code>it<code class="w"> </code>executable<code class="w"/>&#13;
<code class="gp">$ </code>chmod<code class="w"> </code>+x<code class="w"> </code>minikube<code class="w"/>&#13;
&#13;
<code class="gp"># </code>Move<code class="w"> </code>it<code class="w"> </code>to<code class="w"> </code>/usr/local/bin<code class="w"/>&#13;
<code class="gp">$ </code>sudo<code class="w"> </code>mv<code class="w"> </code>minikube<code class="w"> </code>/usr/local/bin/<code class="w"/></pre>&#13;
&#13;
<p>You’ll need to make sure that <em>/usr/local/bin</em> is in your path. Now that we have <code>minikube</code>, we also need to fetch <code>kubectl</code>, which we can do like this:<a data-primary="environment variables" data-secondary="KUBE_VERSION" data-type="indexterm" id="idm46803134927600"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp"># </code>Get<code class="w"> </code>the<code class="w"> </code>latest<code class="w"> </code>version<code class="w"> </code>number<code class="w"/>&#13;
<code class="gp">$ </code><code class="nv">KUBE_VERSION</code><code class="o">=</code><code class="k">$(</code>curl<code class="w"> </code>-s<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>https://storage.googleapis.com/kubernetes-release/release/stable.txt<code class="k">)</code><code class="w"/>&#13;
&#13;
<code class="gp"># </code>Fetch<code class="w"> </code>the<code class="w"> </code>executable<code class="w"/>&#13;
<code class="gp">$ </code>curl<code class="w"> </code>-LO<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>https://storage.googleapis.com/kubernetes-release/<code class="se">\</code>&#13;
release/<code class="k">$(</code>KUBE_VERSION<code class="k">)</code>/bin/linux/amd64/kubectl<code class="w"/>&#13;
&#13;
<code class="gp"># </code>Make<code class="w"> </code>it<code class="w"> </code>executable<code class="w"/>&#13;
<code class="gp">$ </code>chmod<code class="w"> </code>+x<code class="w"> </code>kubectl<code class="w"/>&#13;
&#13;
<code class="gp"># </code>Move<code class="w"> </code>it<code class="w"> </code>to<code class="w"> </code>/usr/local/bin<code class="w"/>&#13;
<code class="gp">$ </code>sudo<code class="w"> </code>mv<code class="w"> </code>kubectl<code class="w"> </code>/usr/local/bin/<code class="w"/></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>One of the URLs in the example has been continued on the following line so that it fits in the margins. You may find that you need to reassemble the URL and remove the backslashes for the command to work properly in your environment.</p>&#13;
</div>&#13;
&#13;
<p>That’s it for installation—we’re ready to go.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running Kubernetes" data-type="sect3"><div class="sect3" id="idm46803134865584">&#13;
<h3>Running Kubernetes</h3>&#13;
&#13;
<p>Now that we have the <code>minikube</code> tool,<a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="running Kubernetes" data-type="indexterm" id="idm46803134862976"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="running Kubernetes" data-type="indexterm" id="idm46803134861696"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="running Kubernetes" data-type="indexterm" id="idm46803134860480"/> we can use it to bootstrap our Kubernetes cluster. This is normally pretty straightforward. You usually don’t need to do any configuration beforehand. In this example, you will see that <code>minikube</code> decided to use the <em>docker driver</em>, although there are others that could be selected.</p>&#13;
&#13;
<p class="pagebreak-before">To start <code>minikube</code>, go ahead and run the following:<a data-primary="minikube command" data-secondary="start" data-type="indexterm" id="idm46803134821904"/></p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code>$</code><code class="w"> </code><code>minikube</code><code class="w"> </code><code>start</code><code class="w">&#13;
&#13;
</code><img src="assets/grinning-face_1f604.png"/><code class="w">  </code><code>minikube</code><code class="w"> </code><code>v1.26.1</code><code class="w"> </code><code>on</code><code class="w"> </code><code>Darwin</code><code class="w"> </code><code class="m">12</code><code>.5.1</code><code class="w"> </code><code class="o">(</code><code>arm64</code><code class="o">)</code><code class="w">&#13;
</code><img src="assets/sparkles_2728.png"/><code class="w">  </code><code>Automatically</code><code class="w"> </code><code>selected</code><code class="w"> </code><code>the</code><code class="w"> </code><code>docker</code><code class="w"> </code><code>driver.</code><code class="w"> </code><code>Other</code><code class="w"> </code><code>choices:</code><code class="w"> </code><code>parallels,</code><code class="w"> </code><code>ssh,</code><code class="w"> </code><code>…</code><code class="w">&#13;
</code><img src="assets/pushpin_1f4cc.png"/><code class="w">  </code><code>Using</code><code class="w"> </code><code>Docker</code><code class="w"> </code><code>Desktop</code><code class="w"> </code><code>driver</code><code class="w"> </code><code>with</code><code class="w"> </code><code>root</code><code class="w"> </code><code>privileges</code><code class="w">&#13;
</code><img src="assets/thumbs-up_1f44d.png"/><code class="w">  </code><code>Starting</code><code class="w"> </code><code>control</code><code class="w"> </code><code>plane</code><code class="w"> </code><code>node</code><code class="w"> </code><code>minikube</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code>cluster</code><code class="w"> </code><code>minikube</code><code class="w">&#13;
</code><img src="assets/tractor_1f69c.png"/><code class="w">  </code><code>Pulling</code><code class="w"> </code><code>base</code><code class="w"> </code><code>image</code><code class="w"> </code><code>…</code><code class="w">&#13;
</code><img src="assets/floppy-disk_1f4be.png"/><code class="w">  </code><code>Downloading</code><code class="w"> </code><code>Kubernetes</code><code class="w"> </code><code>v1.24.3</code><code class="w"> </code><code>preload</code><code class="w"> </code><code>…</code><code class="w">&#13;
    </code><code>&gt;</code><code class="w"> </code><code>preloaded-images-k8s-v18-v1…:</code><code class="w"> </code><code class="m">342</code><code>.82</code><code class="w"> </code><code>MiB</code><code class="w"> </code><code>/</code><code class="w"> </code><code class="m">342</code><code>.82</code><code class="w"> </code><code>MiB</code><code class="w">  </code><code class="m">100</code><code>.00%</code><code class="w"> </code><code class="m">28</code><code>.22</code><code class="w"> </code><code>M</code><code class="w">&#13;
    </code><code>&gt;</code><code class="w"> </code><code>gcr.io/k8s-minikube/kicbase:</code><code class="w"> </code><code class="m">348</code><code>.00</code><code class="w"> </code><code>MiB</code><code class="w"> </code><code>/</code><code class="w"> </code><code class="m">348</code><code>.00</code><code class="w"> </code><code>MiB</code><code class="w">  </code><code class="m">100</code><code>.00%</code><code class="w"> </code><code class="m">18</code><code>.13</code><code class="w"> </code><code>MiB</code><code class="w">&#13;
    </code><code>&gt;</code><code class="w"> </code><code>gcr.io/k8s-minikube/kicbase:</code><code class="w"> </code><code class="m">0</code><code class="w"> </code><code>B</code><code class="w"> </code><code class="o">[</code><code>________________________</code><code class="o">]</code><code class="w"> </code><code>?%</code><code class="w"> </code><code>?</code><code class="w"> </code><code>p/s</code><code class="w"> </code><code>16s</code><code class="w">&#13;
</code><img src="assets/fire_1f525.png"/><code class="w">  </code><code>Creating</code><code class="w"> </code><code>docker</code><code class="w"> </code><code>container</code><code class="w"> </code><code class="o">(</code><code class="nv">CPUs</code><code class="o">=</code><code class="m">2</code><code>,</code><code class="w"> </code><code class="nv">Memory</code><code class="o">=</code><code>4000MB</code><code class="o">)</code><code class="w"> </code><code>…</code><code class="w">&#13;
</code><img src="assets/spouting-whale_1f433.png"/><code class="w">  </code><code>Preparing</code><code class="w"> </code><code>Kubernetes</code><code class="w"> </code><code>v1.24.3</code><code class="w"> </code><code>on</code><code class="w"> </code><code>Docker</code><code class="w"> </code><code class="m">20</code><code>.10.17</code><code class="w"> </code><code>…</code><code class="w">&#13;
    </code><code>▪</code><code class="w"> </code><code>Generating</code><code class="w"> </code><code>certificates</code><code class="w"> </code><code>and</code><code class="w"> </code><code>keys</code><code class="w"> </code><code>…</code><code class="w">&#13;
    </code><code>▪</code><code class="w"> </code><code>Booting</code><code class="w"> </code><code>up</code><code class="w"> </code><code>control</code><code class="w"> </code><code>plane</code><code class="w"> </code><code>…</code><code class="w">&#13;
    </code><code>▪</code><code class="w"> </code><code>Configuring</code><code class="w"> </code><code>RBAC</code><code class="w"> </code><code>rules</code><code class="w"> </code><code>…</code><code class="w">&#13;
</code><img src="assets/magnifying-glass_1f50e.png"/><code class="w">  </code><code>Verifying</code><code class="w"> </code><code>Kubernetes</code><code class="w"> </code><code>components…</code><code class="w">&#13;
    </code><code>▪</code><code class="w"> </code><code>Using</code><code class="w"> </code><code>image</code><code class="w"> </code><code>gcr.io/k8s-minikube/storage-provisioner:v5</code><code class="w">&#13;
</code><img src="assets/glowing-star_1f31f.png"/><code class="w">  </code><code>Enabled</code><code class="w"> </code><code>addons:</code><code class="w"> </code><code>storage-provisioner,</code><code class="w"> </code><code>default-storageclass</code><code class="w">&#13;
</code><img src="assets/person-surfing_1f3c4.png"/><code class="w">  </code><code>Done!</code><code class="w"> </code><code>kubectl</code><code class="w"> </code><code>is</code><code class="w"> </code><code>now</code><code class="w"> </code><code>configured</code><code class="w"> </code><code>to</code><code class="w"> </code><code>use</code><code class="w"> </code><code class="s2">"minikube"</code><code class="w"> </code><code>cluster</code><code class="w"> </code><code>and</code><code class="w">&#13;
     </code><code class="s2">"default"</code><code class="w"> </code><code>namespace</code><code class="w"> </code><code>by</code><code class="w"> </code><code>default</code></pre>&#13;
&#13;
<p>So what did we just do? Minikube packs a lot into that one command. In this case, we launched a single Linux container that is providing us a functioning Kubernetes installation on our local system. If we had used one of the virtualization drivers with <code>minikube</code>, then we would have created a complete VM running Kubernetes instead on a single container.</p>&#13;
&#13;
<p>It then runs all of the necessary components of Kubernetes inside Linux containers on the host. You can easily explore the <code>minikube</code> container or VM to see what you got:<a data-primary="minikube command" data-secondary="ssh" data-type="indexterm" id="idm46803134580896"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>minikube<code class="w"> </code>ssh<code class="w"/>&#13;
&#13;
<code class="gp">docker@minikube:~$</code></pre>&#13;
&#13;
<p>On your Kubernetes cluster, you probably won’t be using SSH to get into the command line that often. But we want to see what’s installed and get a handle on the fact that when we run <code>minikube</code>, we’re controlling an environment that is running many processes. Let’s take a look at what is running on the Docker instance on our Kubernetes cluster:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">docker@minikube:~$ </code>docker<code class="w"> </code>container<code class="w"> </code>ls<code class="w"/>&#13;
&#13;
<code class="go">…ID   IMAGE       COMMAND               …  NAMES</code>&#13;
<code class="go">48…cf ba…57      "/storage-provisioner" … k8s_storage-provisioner_storage-…</code>&#13;
<code class="go">4e…8d ed…e8      "/coredns -conf /etc…" … k8s_coredns_coredns-6d4b75cb6d-…</code>&#13;
<code class="go">1d…3d …pause:3.6 "/pause"               … k8s_POD_coredns-6d4b75cb6d-…</code>&#13;
<code class="go">82…d3 7a…dc      "/usr/local/bin/kube…" … k8s_kube-proxy_kube-proxy-…</code>&#13;
<code class="go">27…10 …pause:3.6 "/pause"               … k8s_POD_kube-proxy-zb6w2_kube-…</code>&#13;
<code class="go">15…ce …pause:3.6 "/pause"               … k8s_POD_storage-provisioner_kube-…</code>&#13;
<code class="go">ff…3d f9…55      "kube-controller-man…" … k8s_kube-controller-manager_kube-…</code>&#13;
<code class="go">33…c5 …pause:3.6 "/pause"               … k8s_POD_kube-controller-manager-…</code>&#13;
<code class="go">30…97 a9…df      "etcd --advertise-cl…" … k8s_etcd_etcd-minikube_kube-…</code>&#13;
<code class="go">f5…41 53…a6      "kube-apiserver --ad…" … k8s_kube-apiserver_kube-apiserver-…</code>&#13;
<code class="go">5b…08 8f…73      "kube-scheduler --au…" … k8s_kube-scheduler_kube-scheduler-…</code>&#13;
<code class="go">87…cc …pause:3.6 "/pause"               … k8s_POD_kube-apiserver-…</code>&#13;
<code class="go">5a…14 …pause:3.6 "/pause"               … k8s_POD_etcd-minikube_kube-…</code>&#13;
<code class="go">6f…0c …pause:3.6 "/pause"               … k8s_POD_kube-scheduler-…</code></pre>&#13;
&#13;
<p>We won’t dive too much into what each component is, but by now you should hopefully see how the mechanism works. Also, it’s pretty easy to upgrade the components since they are just containers, are versioned, and can be pulled from an upstream container repository.</p>&#13;
&#13;
<p>Go ahead and exit the shell that you have on the Minikube system:<a data-primary="exit command for exiting minikube" data-type="indexterm" id="idm46803134527808"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">docker@minikube:~$ </code><code class="nb">exit</code><code class="w"/></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="minikube commands" data-type="sect4"><div class="sect4" id="idm46803134596448">&#13;
<h4>minikube commands</h4>&#13;
&#13;
<p>In the interest of space and time,<a data-primary="Minikube" data-secondary="commands" data-type="indexterm" id="idm46803134506112"/> we won’t go through all of the commands for <code>minikube</code>. We encourage you to run it without any options, take a look at the output, and play around with what’s available. That being said, let’s take a quick look at some of the most interesting commands. We’ll cover a few more later in the course of installing an application stack, but here’s a quick survey.</p>&#13;
&#13;
<p>To see what was going on inside the system,<a data-primary="minikube command" data-secondary="ssh" data-type="indexterm" id="idm46803134504368"/> earlier we used <code>minikube ssh</code>, which is great for debugging or inspecting the system directly. Without directly accessing the Minikube system, we can always check on the cluster status using another <code>minikube</code> command:<a data-primary="minikube command" data-secondary="status" data-type="indexterm" id="idm46803134492352"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>minikube<code class="w"> </code>status<code class="w"/>&#13;
&#13;
<code class="go">minikube</code>&#13;
<code class="go">type: Control Plane</code>&#13;
<code class="go">host: Running</code>&#13;
<code class="go">kubelet: Running</code>&#13;
<code class="go">apiserver: Running</code>&#13;
<code class="go">kubeconfig: Configured</code></pre>&#13;
&#13;
<p>This shows us that everything is looking good. <a data-primary="minikube command" data-secondary="ip" data-type="indexterm" id="idm46803134430864"/><a data-primary="IP addresses" data-secondary="minikube ip command" data-type="indexterm" id="idm46803134430016"/><a data-primary="minikube command" data-secondary="update-check" data-type="indexterm" id="idm46803134429104"/>Two other useful commands include:</p>&#13;
<table id="useful_commands_and_actions">&#13;
&#13;
<thead>&#13;
<tr>&#13;
<th>Command</th>&#13;
<th>Action</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>minikube ip</code></p></td>&#13;
<td><p>Retrieve the IP address of the Minikube VM.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>minikube update-check</code></p></td>&#13;
<td><p>Check your version of Minikube against the most recent release.</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>To apply an upgrade, you can simply use the same mechanism you used to install &#13;
<span class="keep-together">it originally.</span></p>&#13;
&#13;
<p>Critically, the <code>minikube status</code> command also shows us that the <code>kubeconfig</code> is properly configured. We will need this so that <code>kubectl</code> knows how to connect to our cluster.</p>&#13;
&#13;
<p>We started the Kubernetes cluster with <code>minikube start</code>. As you might expect, following the style of Docker CLI arguments, <code>minikube stop</code> will stop all the Kubernetes components and the Linux container or VM. To completely clean up your environment, you can also delete the cluster by running <code>minikube delete</code>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubernetes Dashboard" data-type="sect3"><div class="sect3" id="idm46803134399616">&#13;
<h3>Kubernetes Dashboard</h3>&#13;
&#13;
<p>Now that we have Minikube up and running,<a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="Kubernetes dashboard" data-type="indexterm" id="idm46803134398080"/><a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="dashboard" data-type="indexterm" id="idm46803134396832"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="dashboard" data-type="indexterm" id="idm46803134395616"/><a data-primary="minikube command" data-secondary="dashboard" data-type="indexterm" id="idm46803134394400"/> we don’t just have the command-line tools to interact with; we have a whole Kubernetes Dashboard installed that we can explore. We can reach it via the <code>minikube dashboard</code> command. Go ahead and run that—it should launch your web browser pointed to the correct IP address and port of the Kubernetes Dashboard! There is a lot of stuff on the dashboard, and we’re not able to cover it all, but feel free to click around and explore. Depending on your previous exposure to Kubernetes, some of the terms in the dashboard’s sidebar will be familiar to you, but many of them may be completely foreign. If you don’t have a computer in front of you, <a data-type="xref" href="#figure10-2">Figure 10-2</a> shows a screenshot of what an empty Minikube installation looks like from the Service link in the dashboard sideboard.</p>&#13;
&#13;
<figure><div class="figure" id="figure10-2">&#13;
<img alt="Kubernetes Dashboard" src="assets/dur3_1002.png"/>&#13;
<h6><span class="label">Figure 10-2. </span>Kubernetes Dashboard (example)</h6>&#13;
</div></figure>&#13;
&#13;
<p>If you explore the Nodes link under Cluster in the left sidebar, you should see a single node in the cluster, named <code>minikube</code>. This is the container or VM that we started, and the dashboard, like the other components, is hosted in one of the containers we saw when we connected to the Minikube system earlier. We’ll take another look at the dashboard when we’ve deployed something into our cluster.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Kubernetes exposes almost everything that you see on the dashboard with the <code>kubectl</code> command as well, which makes it very scriptable with shell scripts.</p>&#13;
&#13;
<p>For example, running <code>kubectl get services</code> or <code>kubectl get nodes</code> should show you the same information that you can see on the dashboard.</p>&#13;
</div>&#13;
&#13;
<p>While clicking around, you may notice that Kubernetes itself shows up as a component inside the system, just like your applications will.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>You will need to type Ctrl-C to exit the <code>minikube dashboard</code> process and return to your terminal prompt.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kubernetes containers and pods" data-type="sect3"><div class="sect3" id="idm46803134383872">&#13;
<h3>Kubernetes containers and pods</h3>&#13;
&#13;
<p>Now that we have a Kubernetes cluster<a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="containers and pods" data-type="indexterm" id="ch10-conpod"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="containers and pods" data-type="indexterm" id="ch10-conpod2"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="containers and pods" data-type="indexterm" id="ch10-conpod3"/><a data-primary="containers and pods of Kubernetes" data-type="indexterm" id="ch10-conpod4"/><a data-primary="pods and containers of Kubernetes" data-type="indexterm" id="ch10-conpod5"/> up and running, and you’ve seen how easy that is to do locally, we need to pause to talk about a concept that Kubernetes adds on top of the container abstraction. Kubernetes came out of the experiences that Google had running its massive platform. Google encountered most of the situations you might see in a production platform and had to work out concepts to make it easier to understand and solve the kinds of problems you run into when managing a large installation. In doing so, Google created a complex set of new abstractions. Kubernetes embraces many of these and thus has a whole vocabulary unto itself. We won’t try to get into all of these, but it’s important to understand the most central of these new abstractions—​a concept that sits a layer above the container and is known as a <em>pod</em>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The term <em>pod</em> came about because the Docker mascot is Moby, the whale, and a group of whales is called a <em>pod</em>.</p>&#13;
</div>&#13;
&#13;
<p>In Kubernetes parlance, a pod is one or more containers sharing the same cgroups and namespaces. You can also isolate the containers themselves from one another inside the same pod using cgroups and namespaces. A pod is intended to encapsulate all of the processes or applications that need to be deployed together to create a functioning unit, which the scheduler can then manage. All of the containers in the pod can talk to one another on <code>localhost</code>, which eliminates any need to discover one another. So why not just deploy a big container with all the applications inside it? The advantage of a pod over a massive container is that you can still resource-limit the individual application separately and leverage the large library of public Linux containers to construct your application.</p>&#13;
&#13;
<p>Additionally, Kubernetes administrators often leverage the pod abstraction to have a container run on pod startup to make sure things are configured properly for the others, to maintain a shared resource, or to announce the application to others, for example. This allows you to make finer-grained containers than you might if you have to group things into the same container. Another nice part of the pod abstraction is the ability to share mounted volumes.</p>&#13;
&#13;
<p>Pods have a life span much like a Linux container. They are essentially ephemeral and can be redeployed to new hosts according to the lifecycle of the application or the host it runs on. Containers in a pod even share the same IP address when facing the outside world, which means they look like a single entity from the network level. Just as you would run only one instance of an application per container, you generally run one instance of a given container inside a pod. The easiest way to think about pods is that they are a group of Linux containers that work together as if they were one container, for most purposes. If you need only one container, then you still get a pod deployed by Kubernetes, but that pod contains only one container. The nice thing about this is that there is only one abstraction as far as the Kubernetes scheduler is concerned: the pod. Containers are managed by some of the runtime pieces that construct the pod and also by the configuration that you use to define them.</p>&#13;
&#13;
<p>One critical difference between a pod and a container is that you don’t construct pods in a build step. They are a runtime abstraction that is defined in a JSON or YAML manifest and lives only inside Kubernetes. So you build your Linux containers and send them to a registry, then define and deploy your pods using Kubernetes. In reality, you don’t usually directly describe a pod either; the tools generate it for you through the concept of a deployment. But the pod is the unit of execution and scheduling in a Kubernetes cluster. There is a lot more to it, but that’s the basic concept, and it’s probably easiest to understand with a simple example. The pod abstraction is more complicated than thinking of your system in terms of individual containers, but it can be pretty powerful.<a data-startref="ch10-conpod" data-type="indexterm" id="idm46803134371264"/><a data-startref="ch10-conpod2" data-type="indexterm" id="idm46803134370560"/><a data-startref="ch10-conpod3" data-type="indexterm" id="idm46803134369888"/><a data-startref="ch10-conpod4" data-type="indexterm" id="idm46803134369216"/><a data-startref="ch10-conpod5" data-type="indexterm" id="idm46803134368544"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Let’s deploy something" data-type="sect3"><div class="sect3" id="idm46803134367744">&#13;
<h3>Let’s deploy something</h3>&#13;
&#13;
<p>When working with pods in Kubernetes,<a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="deployment" data-type="indexterm" id="ch10-dep"/><a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="deployment" data-type="indexterm" id="ch10-dep2"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="deployment" data-type="indexterm" id="ch10-dep3"/> we usually manage them through the abstraction of a <em>deployment</em>. A deployment is just a pod definition with some additional information, including health monitoring and replication configuration. It contains the definition of the pod and a little metadata about it. So let’s look at a basic deployment and get it running.</p>&#13;
&#13;
<p>The simplest thing we can deploy on Kubernetes is a pod that contains just one container. We are going to use the <a href="https://httpbin.org"><code>httpbin</code></a> application to explore the basics of deployment on Kubernetes, and we’ll call our deployment <code>hello-minikube</code>.</p>&#13;
&#13;
<p>We’ve used the <code>minikube</code> command, but to get things done on Kubernetes itself, we now need to leverage the <code>kubectl</code> command we installed earlier:<a data-primary="kubectl command" data-secondary="create" data-type="indexterm" id="idm46803134357568"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>create<code class="w"> </code>deployment<code class="w"> </code>hello-minikube<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--image<code class="o">=</code>kennethreitz/httpbin:latest<code class="w"> </code>--port<code class="o">=</code><code class="m">80</code><code class="w"/>&#13;
&#13;
<code class="go">deployment.apps/hello-minikube created</code></pre>&#13;
&#13;
<p>To see what that did for us, we can use the <code>kubectl get all</code> command to list the most important objects that are now in our cluster:<a data-primary="kubectl command" data-secondary="get" data-tertiary="all" data-type="indexterm" id="idm46803134340368"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>get<code class="w"> </code>all<code class="w"/>&#13;
&#13;
<code class="go">NAME                                 READY   STATUS    RESTARTS   AGE</code>&#13;
<code class="go">pod/hello-minikube-ff49df9b8-svl68   1/1     Running   0          2m39s</code>&#13;
&#13;
<code class="go">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</code>&#13;
<code class="go">service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   98m</code>&#13;
&#13;
<code class="go">NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</code>&#13;
<code class="go">deployment.apps/hello-minikube   1/1     1            1           2m39s</code>&#13;
&#13;
<code class="go">NAME                                       DESIRED   CURRENT   READY   AGE</code>&#13;
<code class="go">replicaset.apps/hello-minikube-ff49df9b8   1         1         1       2m39s</code></pre>&#13;
&#13;
<p>With that one command, Kubernetes created a deployment, a ReplicaSet to manage scaling, and a pod. We want to ensure that our pod shows a <code>STATUS</code> of <code>Running</code>. If yours isn’t, just wait and run the command a couple more times until you see the status change. The <code>service/kubernetes</code> entry is a running service that represents Kubernetes itself. But where is our service? We can’t get to it yet. It’s essentially in the same state a Linux container would be if you didn’t tell it to expose any ports. So we need to tell Kubernetes to do that for us:<a data-primary="kubectl command" data-secondary="expose" data-type="indexterm" id="idm46803134310992"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>expose<code class="w"> </code>deployment<code class="w"> </code>hello-minikube<code class="w"> </code>--type<code class="o">=</code>NodePort<code class="w"/>&#13;
<code class="go">service/hello-minikube exposed</code></pre>&#13;
&#13;
<p>This has now created a service we can reach and interact with. A <em>service</em> is a wrapper for one or more deployments of an application and can tell us how to contact the application. In this case, we get a <code>NodePort</code>, which exposes a port on every node in the cluster that will be routed to the underlying pods. Let’s get Kubernetes to tell us how to get to it:<a data-primary="kubectl command" data-secondary="get" data-tertiary="services" data-type="indexterm" id="idm46803134284112"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>get<code class="w"> </code>services<code class="w"/>&#13;
&#13;
<code class="go">NAME           TYPE      CLUSTER-IP     EXTERNAL-IP PORT(S)        AGE</code>&#13;
<code class="go">hello-minikube NodePort  10.105.184.177 &lt;none&gt;      80:32557/TCP   8s</code>&#13;
<code class="go">kubernetes     ClusterIP 10.96.0.1      &lt;none&gt;      443/TCP        107m</code></pre>&#13;
&#13;
<p>You might think you could now connect to <em>http://10.105.184.177:8080</em> to get to our service. But those addresses are not reachable from your host system because of the container or VM in which Minikube is running. So we need to get <code>minikube</code> to tell us where to find the service:<a data-primary="minikube command" data-secondary="service" data-type="indexterm" id="idm46803134233136"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>minikube<code class="w"> </code>service<code class="w"> </code>hello-minikube<code class="w"> </code>--url<code class="w"/>&#13;
<code class="go">http://192.168.99.100:30616</code></pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>In some configurations, you may see a message like this:</p>&#13;
<pre>&#13;
<img src="assets/exclamation-mark_2757.png"/> Because you are using a Docker driver on darwin,&#13;
   the terminal needs to be open to run it.&#13;
</pre>&#13;
&#13;
<p>This indicates that transparently wiring the networking from your host to the Kubernetes services is not possible at the moment, and you will need to leave the command running while you explore your application. You can use a local web browser or open up another terminal to run commands like <code>curl</code>.</p>&#13;
&#13;
<p>When you are done, you can type Ctrl-C in the original terminal session to kill the <code>minikube service</code> command.</p>&#13;
</div>&#13;
&#13;
<p>The nice thing about this command, like many of the other Kubernetes commands, is that it is scriptable and command-line friendly under normal circumstances. If we want to open it with <code>curl</code> on the command line, we can often just include the <code>minikube</code> command call in our request:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>curl<code class="w"> </code>-H<code class="w"> </code>foo:bar<code class="w"> </code><code class="k">$(</code>minikube<code class="w"> </code>service<code class="w"> </code>hello-minikube<code class="w"> </code>--url<code class="k">)</code>/get<code class="w"/></pre>&#13;
&#13;
<pre class="nomargin" data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"args"</code><code class="p">:</code><code class="w"> </code><code class="p">{},</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"headers"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"Accept"</code><code class="p">:</code><code class="w"> </code><code class="s2">"*/*"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"Foo"</code><code class="p">:</code><code class="w"> </code><code class="s2">"bar"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"Host"</code><code class="p">:</code><code class="w"> </code><code class="s2">"127.0.0.1:56695"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"User-Agent"</code><code class="p">:</code><code class="w"> </code><code class="s2">"curl/7.85.0"</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"origin"</code><code class="p">:</code><code class="w"> </code><code class="s2">"172.17.0.1"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"url"</code><code class="p">:</code><code class="w"> </code><code class="s2">"http://127.0.0.1:56695/get"</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p><code>httpbin</code> is a simple HTTP request and response API that can be used to test and confirm HTTP services. Not the world’s most exciting application, but you can see that we are able to contact our service and get a response back from it via <code>curl</code>.</p>&#13;
&#13;
<p>This is the simplest use case. We didn’t configure much and relied on Kubernetes to do the right thing using its defaults. In the next step, we’ll take a look at something more complicated. But first, let’s shut down our new service and deployment. It takes two commands to do that: one to remove the service and the other to delete it:<a data-startref="ch10-dep" data-type="indexterm" id="idm46803134088784"/><a data-startref="ch10-dep2" data-type="indexterm" id="idm46803134088112"/><a data-startref="ch10-dep3" data-type="indexterm" id="idm46803134087440"/><a data-primary="kubectl command" data-secondary="delete" data-tertiary="service" data-type="indexterm" id="idm46803134086768"/><a data-primary="kubectl command" data-secondary="delete" data-tertiary="deployment" data-type="indexterm" id="idm46803134085552"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>delete<code class="w"> </code>service<code class="w"> </code>hello-minikube<code class="w"/>&#13;
<code class="go">service "hello-minikube" deleted</code>&#13;
&#13;
<code class="gp">$ </code>kubectl<code class="w"> </code>delete<code class="w"> </code>deployment<code class="w"> </code>hello-minikube<code class="w"/>&#13;
<code class="go">deployment.apps "hello-minikube" deleted</code>&#13;
&#13;
<code class="gp">$ </code>kubectl<code class="w"> </code>get<code class="w"> </code>all<code class="w"/>&#13;
&#13;
<code class="go">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</code>&#13;
<code class="go">service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   138m</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deploying a realistic stack" data-type="sect3"><div class="sect3" id="idm46803134034384">&#13;
<h3>Deploying a realistic stack</h3>&#13;
&#13;
<p>Let’s now deploy something that looks<a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="deploying a production stack" data-type="indexterm" id="idm46803134028944"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="deploying a production stack" data-type="indexterm" id="idm46803134027200"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="deploying a production stack" data-type="indexterm" id="idm46803134026128"/> more like a production stack. We’ll deploy an application that can fetch PDF documents from an S3 bucket, cache them on disk locally, and rasterize individual pages to PNG images on request, using the cached document. To run this application, we’ll want to write our cache files somewhere other than inside the container. We want to have them go somewhere a little more permanent and stable. And this time we want to make things repeatable so that we’re not deploying our application through a series of CLI commands that we need to remember and hopefully get right each time. Kubernetes, much like Docker Compose, lets us define our stack in one or more YAML files that contain all of the definitions we care about in one place. This is what you want in a production environment and is similar to what you’ve seen for the other production tools.</p>&#13;
&#13;
<p>The service we’ll now create will be called <code>lazyraster</code> (as in “rasterize on demand”), and each time you see that in the YAML definition, you’ll know we’re referring to our application. Our persistent volume will be called <code>cache-data</code>. Again, Kubernetes has a huge vocabulary that we can’t entirely address here, but to make it clear what we’re looking at, we need to introduce two more concepts: <code>PersistentVolume</code> and <code>PersistentVolumeClaim</code>. A <code>PersistentVolume</code> is a physical resource that we provision inside the cluster. Kubernetes has support for many kinds of volumes, from local storage on a node to <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AmazonEBS.html">Amazon Elastic Block Store (Amazon EBS) volumes</a> on AWS and similar on other cloud providers. It also supports <a href="https://en.wikipedia.org/wiki/Network_File_System">Network File System (NFS)</a> and other more modern network filesystems. A <code>PersistentVolume</code> stores data with a lifecycle that is independent of our application or deployments. This lets us store data that persists between application deployments. For our cache, that’s what we’ll use. A <code>PersistentVolumeClaim</code> is a link between the physical resource of the <code>PersistentVolume</code> and the application that needs to consume it. We can set a policy on the claim that allows either a single read/write claim or many read claims. For our application we just want a single read/write claim to our <code>cache-data</code> <code>PersistentVolume</code>.</p>&#13;
<div class="less_space pagebreak-before" data-type="tip"><h6>Tip</h6>&#13;
<p>If you want more detail about some of the concepts we’ve talked about here, the Kubernetes project maintains a <a href="https://kubernetes.io/docs/reference/glossary/?fundamental=true">glossary</a> of all the terms involved in operating Kubernetes. This can be very helpful. Each entry in the glossary is also linked to much more in-depth detail on other pages.</p>&#13;
</div>&#13;
&#13;
<p>You can check out the file we will be using in this section by running the following:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>git<code class="w"> </code>clone<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>https://github.com/bluewhalebook/<code class="se">\</code>&#13;
docker-up-and-running-3rd-edition.git<code class="w"> </code>--config<code class="w"> </code>core.autocrlf<code class="o">=</code>input<code class="w"/>&#13;
&#13;
<code class="go">Cloning into 'docker-up-and-running-3rd-edition'…</code>&#13;
<code class="go">…</code>&#13;
&#13;
<code class="gp">$ </code><code class="nb">cd</code><code class="w"> </code>docker-up-and-running-3rd-edition/chapter_10/kubernetes<code class="w"/></pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The URL in the example has been continued on the following line so that it fits in the margins. You may find that you need to reassemble the URL and remove the backslashes for the command to work properly.</p>&#13;
</div>&#13;
&#13;
<p>We will start by looking at the manifest YAML file, called <em>lazyraster-service.yaml</em>. The full manifest contains multiple YAML documents separated by <code>---</code>. We will discuss each section individually here.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Service definition" data-type="sect3"><div class="sect3" id="idm46803133949328">&#13;
<h3>Service definition</h3>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Service</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lazyraster</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lazyraster</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">NodePort</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">port</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8000</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">targetPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8000</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">protocol</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TCP</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lazyraster</code><code class="w"/></pre>&#13;
&#13;
<p>The first section defines our <code>Service</code>. <a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="Service definition" data-type="indexterm" id="idm46803133866896"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="Service definition" data-type="indexterm" id="idm46803133865744"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="Service definition" data-type="indexterm" id="idm46803133864528"/>The second and third sections, which we’ll see in a moment, respectively define our <code>PersistentVolumeClaim</code> and then our actual <code>Deployment</code>. We’ve told Kubernetes that our service will be called <code>lazyraster</code> and that it will be exposed on port 8000, which maps to the actual 8000 in our container. We’ve exposed that with the <code>NodePort</code> mechanism, which simply makes sure that our application is exposed on the same port on each host, much like the <code>--publish</code> flag to <code>docker container run</code>. This is helpful with <code>minikube</code> since we’ll run only one instance, and the <code>NodePort</code> type makes it easy for us to access it from our computer just like we did earlier. As with many parts of Kubernetes, there are several options other than <code>NodePort</code>, and you can probably find a mechanism that’s ideal for your production environment. <code>NodePort</code> is good for <code>minikube</code>, but it might work well for more statically configured load balancers as well.</p>&#13;
&#13;
<p>So, back to our <code>Service</code> definition. The <code>Service</code> is going to be connected to the <code>Deployment</code> via the <code>selector</code>, which we apply in the <code>spec</code> section. Kubernetes widely uses labels as a way to reason about similar components and to help tie them all together. Labels are key/value pairs that are arbitrarily defined and that can then be queried to identify pieces of your system. Here the <code>selector</code> tells Kubernetes to look for <code>Deployments</code> with the label <code>app: lazyraster</code>. Notice that we also apply the same label to the <code>Service</code> itself. That’s helpful if we want to identify all the components together later, but it’s the <code>selector</code> section that ties the <code>Deployment</code> to our <code>Service</code>. So we now have a <code>Service</code>, but it doesn’t do anything yet. We need more definitions to make Kubernetes do what we want.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="PersistentVolumeClaim definition" data-type="sect3"><div class="sect3" id="idm46803133830480">&#13;
<h3>PersistentVolumeClaim definition</h3>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">PersistentVolumeClaim</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cache-data-claim</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lazyraster</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">accessModes</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">ReadWriteOnce</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">resources</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">requests</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">storage</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">100Mi</code><code class="w"/></pre>&#13;
&#13;
<p>The next section defines<a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="PersistentVolumeClaim definition" data-type="indexterm" id="idm46803133774800"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="PersistentVolumeClaim definition" data-type="indexterm" id="idm46803133803232"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="PersistentVolumeClaim definition" data-type="indexterm" id="idm46803133802080"/> our <code>PersistentVolumeClaim</code> and likewise the <code>PersistentVolume</code> that backs it. A <code>PersistentVolumeClaim</code> is a way to name a volume and claim that you have a token to access that particular volume in a particular way. Notice, though, that we didn’t define the <code>PersistentVolume</code> here. That’s because Kubernetes is doing that work for us using what it calls <em>Dynamic Volume Provisioning</em>. In our case, the use is pretty simple: we want a read/write claim to a volume, and we’ll let Kubernetes put that in a volume container for us. But you can imagine a scenario where an application is going to be deployed into a cloud provider and where dynamic provisioning would truly come into its own. In that scenario, we don’t want to have to make separate calls to have our volume created in the cloud for us. We want Kubernetes to handle that. That’s what Dynamic Volume Provisioning is all about. Here, it will just create a container for us to hold our persistent data, and mount it into our pod when we stake our claim. We don’t do a lot in this section except name it, ask for 100 MB of data, and tell Kubernetes it’s a read/write mount-once-only volume.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>There’s a large number of possible volume providers in Kubernetes. Which ones are available to you is in part determined by which provider or cloud service you are running on. You should take a look and see which ones make the most sense for you when you are preparing to head into production.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deployment definition" data-type="sect3"><div class="sect3" id="idm46803133797264">&#13;
<h3>Deployment definition</h3>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">apps/v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Deployment</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lazyraster</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lazyraster</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">selector</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">matchLabels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lazyraster</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">strategy</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">RollingUpdate</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">template</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">app</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lazyraster</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">relistan/lazyraster:demo</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lazyraster</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">env</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">RASTER_RING_TYPE</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">memberlist</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">RASTER_BASE_DIR</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/data</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">ports</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">containerPort</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">8000</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">lazyraster</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cache-data</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/data</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">volumes</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cache-data</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">persistentVolumeClaim</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">claimName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cache-data-claim</code><code class="w"/></pre>&#13;
&#13;
<p>The <code>Deployment</code> creates the pods<a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="Deployment definition" data-type="indexterm" id="idm46803133478816"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="Deployment definition" data-type="indexterm" id="idm46803133477632"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="Deployment definition" data-type="indexterm" id="idm46803133574112"/> for us and uses the Linux container for our application. We define some metadata about the application, including its name and one label, just like we did for the other definitions. We also apply another <code>selector</code> here to find the other resources we’re tied to. In the <code>strategy</code> section, we say we want to have a <code>RollingUpdate</code>, which is a strategy that causes our pods to be cycled through one by one during deployment. We could also pick <code>Recreate</code>, which would simply destroy all existing pods and then create new ones afterward.</p>&#13;
&#13;
<p>In the <code>template</code> section, we define how to stamp out copies of this deployment. The container definition includes the Docker image name, the ports to map, volumes to mount, and some environment variables that the <code>lazyraster</code> application needs. The very last part of the <code>spec</code> asks to have our <code>PersistentVolumeClaim</code> named <code>cache-data-claim</code>.</p>&#13;
&#13;
<p>And that’s it for the application definition. Now let’s stand it up!</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>There are many more options and a rich set of directives you can specify here to tell Kubernetes how to handle your application. We’ve walked through a couple of simple options, but we encourage you to explore the Kubernetes documentation to learn more.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deploying the application" data-type="sect3"><div class="sect3" id="idm46803133566736">&#13;
<h3>Deploying the application</h3>&#13;
&#13;
<p>Before we continue, let’s see what’s in our Kubernetes cluster by using the <code>kubectl</code> command:<a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="deploying the application" data-type="indexterm" id="ch10-depapp"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="deploying the application" data-type="indexterm" id="ch10-depapp2"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="deploying the application" data-type="indexterm" id="ch10-depapp3"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>get<code class="w"> </code>all<code class="w"/>&#13;
&#13;
<code class="go">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</code>&#13;
<code class="go">service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   160m</code></pre>&#13;
&#13;
<p>We have only one thing defined at the moment, a service called <code>service/kubernetes</code>. A naming convention used widely in Kubernetes is to preface the type of object with the object <code>Kind</code>, which is sometimes shortened to a two- or three-letter abbreviation. Sometimes you will see <code>service</code> represented as <code>svc</code>. If you are curious, you can see all of the resources and their short names by running the command <code>kubectl api-resources</code>. So let’s go ahead and get our service, deployment, and volume into the cluster!<a data-primary="kubectl command" data-secondary="apply" data-type="indexterm" id="idm46803133474784"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>apply<code class="w"> </code>-f<code class="w"> </code>./lazyraster-service.yaml<code class="w"/>&#13;
&#13;
<code class="go">service/lazyraster created</code>&#13;
<code class="go">persistentvolumeclaim/cache-data-claim created</code>&#13;
<code class="go">deployment.apps/lazyraster created</code></pre>&#13;
&#13;
<p>That output looks like what we expected: we have a service, a persistent volume claim, and a deployment. So let’s see what’s in the cluster now:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>get<code class="w"> </code>all<code class="w"/>&#13;
&#13;
<code class="go">NAME                              READY   STATUS    RESTARTS   AGE</code>&#13;
<code class="go">pod/lazyraster-644cb5c66c-zsjxd   1/1     Running   0          17s</code>&#13;
&#13;
<code class="go">NAME               TYPE      CLUSTER-IP     EXTERNAL-IP PORT(S)        AGE</code>&#13;
<code class="go">service/kubernetes ClusterIP 10.96.0.1      &lt;none&gt;      443/TCP        161m</code>&#13;
<code class="go">service/lazyraster NodePort  10.109.116.225 &lt;none&gt;      8000:32544/TCP 17s</code>&#13;
&#13;
<code class="go">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</code>&#13;
<code class="go">deployment.apps/lazyraster   1/1     1            1           17s</code>&#13;
&#13;
<code class="go">NAME                                    DESIRED   CURRENT   READY   AGE</code>&#13;
<code class="go">replicaset.apps/lazyraster-644cb5c66c   1         1         1       17s</code></pre>&#13;
&#13;
<p>You can see that a bunch more happened behind the scenes. And also, where is our volume or persistent volume claim? We have to ask for that separately:<a data-primary="kubectl command" data-secondary="get" data-tertiary="pvc" data-type="indexterm" id="idm46803133381136"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>get<code class="w"> </code>pvc<code class="w"/>&#13;
&#13;
<code class="go">NAME             STATUS VOLUME    CAPACITY ACCESS MODES STORAGECLASS AGE</code>&#13;
<code class="go">cache-data-claim Bound  pvc-1a…41 100Mi    RWO          standard     65s</code></pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p><code>kubectl get all</code> does nothing of the sort. It would be more aptly named <code>get all-of-the-most-common-resources</code>, but there are several other resources you can fetch. The Kubernetes project hosts a handy <a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet">cheat sheet</a> to make this more discoverable.</p>&#13;
</div>&#13;
&#13;
<p>So what about that <code>replicaset.apps</code> that appeared in the <code>get all</code> output? That is a ReplicaSet. A ReplicaSet is a piece of Kubernetes that is responsible for making sure that our application is running the right number of instances all the time and that they are healthy. We don’t normally have to worry about what happens inside the ReplicaSet because the deployment we created manages it for us. You can manage the ReplicaSet yourself if need be, but most of the time you won’t need to or want to.</p>&#13;
&#13;
<p>We didn’t tell <code>kubectl</code> any specific number of instances, so we got one. And we can see that both the desired and current states match. We’ll take a look at that in a moment. But first, let’s connect to our application and see what we’ve got:<a data-primary="minikube command" data-secondary="service" data-type="indexterm" id="idm46803133401808"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>minikube<code class="w"> </code>service<code class="w"> </code>--url<code class="w"> </code>lazyraster<code class="w"/>&#13;
<code class="go">http://192.168.99.100:32185</code></pre>&#13;
&#13;
<p>You will probably get a different IP address and port back. That’s fine! This is very dynamic stuff. And that’s why we use the <code>minikube</code> command to manage it for us.</p>&#13;
&#13;
<p>Also, remember that <code>minikube</code> will warn you if you need to keep the &#13;
<span class="keep-together"><code>service</code></span> command running while you explore the <code>lazyraster</code> service. So grab the address that came back, open your web browser, and paste it into the URL bar like this: <em>http://&lt;192.168.99.100:32185&gt;/documents/docker-up-and-running-public/sample.pdf?page=1</em>. You’ll need to substitute the IP and port into the URL to make it work for you.</p>&#13;
&#13;
<p>You’ll need to be connected to the internet because the <code>lazyraster</code> application is going to go out to the internet, fetch a PDF from a public S3 bucket, and then render the first page from the document as a PNG in a process called <em>rasterization</em>. If everything worked, you should see a copy of the front cover of an earlier edition of this book! This particular PDF has two pages, so feel free to try changing the argument to <code>?page=2</code>. If you do that, you may notice it renders <em>much</em> faster than the first page. That’s because the application is using our persistent volume to cache the data. You can also specify <code>width=2048</code> or ask for a JPEG instead of a PNG with <code>imageType=image/jpeg</code>. You could rasterize the front page as a very large JPEG, like this:</p>&#13;
&#13;
<p><em>http://&lt;192.168.99.100:32185&gt;/documents/docker-up-and-running-public/sample.pdf?page=1&amp;imageType=image/jpeg&amp;width=2048</em></p>&#13;
&#13;
<p>If you have a public S3 bucket with other PDFs in it, you can simply substitute the bucket name for <code>docker-up-and-running-public</code> in the URL to hit your bucket instead. If you want to play with the application some more, check out <a href="https://github.com/Nitro/lazyraster">the <em>Nitro</em>/<em>lazyraster</em> repo on GitHub</a>.<a data-startref="ch10-depapp" data-type="indexterm" id="idm46803133330464"/><a data-startref="ch10-depapp2" data-type="indexterm" id="idm46803133329728"/><a data-startref="ch10-depapp3" data-type="indexterm" id="idm46803133329056"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Scaling up" data-type="sect3"><div class="sect3" id="idm46803133566112">&#13;
<h3>Scaling up</h3>&#13;
&#13;
<p>In real life you don’t just deploy applications;<a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="scaling up" data-type="indexterm" id="ch10-scup"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="scaling up" data-type="indexterm" id="ch10-scup2"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="scaling up" data-type="indexterm" id="ch10-scup3"/> you operate them as well. One of the huge advantages of scheduled workloads is the ability to scale them up and down at will, within the resource constraints available to the system. In our case, we only have one Minikube node, but we can still scale up our service to better handle load and provide more reliability during deployments. Kubernetes, as you might imagine, allows scaling up and down quite easily. For our service, we will need only one command to do it. Then we’ll take another look at the <code>kubectl</code> output and also at the Kubernetes Dashboard we introduced earlier so we can prove that the service scaled.</p>&#13;
&#13;
<p>In Kubernetes, the thing we will scale is not the service; it’s the deployment. Here’s what that looks like:<a data-primary="kubectl command" data-secondary="scale" data-type="indexterm" id="idm46803133304032"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>scale<code class="w"> </code>--replicas<code class="o">=</code><code class="m">2</code><code class="w"> </code>deploy/lazyraster<code class="w"/>&#13;
<code class="go">deployment.apps/lazyraster scaled</code></pre>&#13;
&#13;
<p>Great, that did something! But what did we get?</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>get<code class="w"> </code>deployment/lazyraster<code class="w"/>&#13;
&#13;
<code class="go">NAME         READY   UP-TO-DATE   AVAILABLE   AGE</code>&#13;
<code class="go">lazyraster   2/2     2            2           16m</code></pre>&#13;
&#13;
<p class="pagebreak-before">We now have two instances of our application running. Let’s see what we got in the logs:<a data-primary="kubectl command" data-secondary="logs" data-type="indexterm" id="idm46803133288960"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>logs<code class="w"> </code>deployment/lazyraster<code class="w"/>&#13;
&#13;
<code class="go">Found 2 pods, using pod/lazyraster-644cb5c66c-zsjxd</code>&#13;
<code class="go">Trying to clear existing Lazyraster cached files (if any) in the background…</code>&#13;
<code class="go">Launching Lazyraster service…</code>&#13;
<code class="go">time="2022-09-10T21:14:16Z" level=info msg="Settings -----------------…</code>&#13;
<code class="go">time="2022-09-10T21:14:16Z" level=info msg="  * BaseDir: /data"</code>&#13;
<code class="go">time="2022-09-10T21:14:16Z" level=info msg="  * HttpPort: 8000"</code>&#13;
<code class="go">…</code>&#13;
<code class="go">time="2022-09-10T21:14:16Z" level=info msg="  * LoggingLevel: info"</code>&#13;
<code class="go">time="2022-09-10T21:14:16Z" level=info msg="--------------------------…</code>&#13;
<code class="go">…</code>&#13;
<code class="go">time="2022-09-10T21:14:16Z" level=info msg="Listening on tcp://:6379"</code>&#13;
<code class="go">…</code></pre>&#13;
&#13;
<p>We asked for logs for the deployment, but Kubernetes tells us two pods are running, so it simply picked one of them to show us the logs from. We can see the replica starting up. If we want to specify a particular instance to look at, we can ask for the logs for that pod with something like <code>kubectl logs pod/lazyraster-644cb5c66c-zsjxd</code>, using the output from <code>kubectl get pods</code> to find the pod in question.</p>&#13;
&#13;
<p>We now have a couple of copies of our application running. What does that look like on the Kubernetes Dashboard? Let’s navigate there with <code>minikube dashboard</code>. Once we’re there, we’ll select “Workloads - Deployments” from the left sidebar and then click on the <code>lazyraster</code> deployment, which should display a screen that looks like <a data-type="xref" href="#figure10-3">Figure 10-3</a>.</p>&#13;
&#13;
<figure><div class="figure" id="figure10-3">&#13;
<img alt="Lazyraster Service Dashboard" src="assets/dur3_1003.png"/>&#13;
<h6><span class="label">Figure 10-3. </span><code>lazyraster</code> service dashboard (example)</h6>&#13;
</div></figure>&#13;
&#13;
<p>We encourage you to click around some more in the Kubernetes Dashboard to see what else is presented. With the concepts you’ve picked up here, a lot should be clearer now, and you can probably figure out some more on your own. Likewise, <code>kubectl</code> has a lot of other options available as well, many of which you’ll need in a real production system. The <a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet">cheat sheet we discussed earlier</a> is a real lifesaver here!</p>&#13;
&#13;
<p>As always, you can type Ctrl-C at any time to exit the running <code>minikube dashboard</code> command.<a data-startref="ch10-scup" data-type="indexterm" id="idm46803133227776"/><a data-startref="ch10-scup2" data-type="indexterm" id="idm46803133227040"/><a data-startref="ch10-scup3" data-type="indexterm" id="idm46803133226368"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="kubectl API" data-type="sect3"><div class="sect3" id="idm46803133310400">&#13;
<h3>kubectl API</h3>&#13;
&#13;
<p>We haven’t shown you an API yet, and,<a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="kubectl API" data-type="indexterm" id="ch10-api"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="kubectl API" data-type="indexterm" id="ch10-api2"/><a data-primary="Minikube" data-secondary="scaling with Kubernetes" data-tertiary="kubectl API" data-type="indexterm" id="ch10-api3"/><a data-primary="APIs" data-secondary="kubectl API" data-type="indexterm" id="ch10-api4"/> as we’ve discussed with Docker, it can be really useful to have a simple API to interact with for scripting, programming, and other general operational needs. You can write programs to talk directly to the Kubernetes API, but for local development and other simple use cases, you can use <code>kubectl</code> as a nice proxy to Kubernetes, and it presents a clean API that is accessible with <code>curl</code> and JSON command-line tools. Here’s an example of what you can do:<a data-primary="kubectl command" data-secondary="proxy" data-type="indexterm" id="idm46803133204928"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>proxy<code class="w"/>&#13;
<code class="go">Starting to serve on 127.0.0.1:8001</code></pre>&#13;
&#13;
<p>We’ve now got <code>kubectl</code> itself serving up a web API on the local system! You’ll need to read more about what’s possible, but let’s get it to show us the individual instances of the <code>lazyraster</code> application. We can do that by opening the following URL in a browser or by using <code>curl</code> in another terminal window: <em>http://localhost:8001/api/v1/namespaces/default/endpoints/lazyraster</em>.</p>&#13;
&#13;
<p>There is a lot of output here, but the part we care about is the <code>subsets</code> section:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"subsets"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"addresses"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">"ip"</code><code class="p">:</code><code class="w"> </code><code class="s2">"172.17.0.5"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">"nodeName"</code><code class="p">:</code><code class="w"> </code><code class="s2">"minikube"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">"targetRef"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"kind"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Pod"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"namespace"</code><code class="p">:</code><code class="w"> </code><code class="s2">"default"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"lazyraster-644cb5c66c-zsjxd"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"uid"</code><code class="p">:</code><code class="w"> </code><code class="s2">"9631395d-7e68-47fa-bb9f-9641d724d8f7"</code><code class="w"/>&#13;
<code class="w">          </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">"ip"</code><code class="p">:</code><code class="w"> </code><code class="s2">"172.17.0.6"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">"nodeName"</code><code class="p">:</code><code class="w"> </code><code class="s2">"minikube"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">"targetRef"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"kind"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Pod"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"namespace"</code><code class="p">:</code><code class="w"> </code><code class="s2">"default"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"lazyraster-644cb5c66c-pvcmj"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"uid"</code><code class="p">:</code><code class="w"> </code><code class="s2">"e909d424-7a91-4a74-aed3-69562b74b422"</code><code class="w"/>&#13;
<code class="w">          </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"ports"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">"port"</code><code class="p">:</code><code class="w"> </code><code class="mi">8000</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">"protocol"</code><code class="p">:</code><code class="w"> </code><code class="s2">"TCP"</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">]</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">]</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>What’s interesting here is that we can see that both instances are running on the Minikube host and that they have different IP addresses. If we were building a cloud-native application that needed to know where the other instances of the application were running, this would be a good way to do that.</p>&#13;
&#13;
<p>You can type Ctrl-C at any time to exit the running <code>kubectl proxy</code> processes, and then you can remove the deployment and all of its components by running the following command. It may take Kubernetes a minute or so to delete everything and return you to the terminal prompt:<a data-primary="kubectl command" data-secondary="delete" data-type="indexterm" id="idm46803133100672"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>delete<code class="w"> </code>-f<code class="w"> </code>./lazyraster-service.yaml<code class="w"/>&#13;
&#13;
<code class="go">service "lazyraster" deleted</code>&#13;
<code class="go">persistentvolumeclaim "cache-data-claim" deleted</code>&#13;
<code class="go">deployment.apps "lazyraster" deleted</code></pre>&#13;
&#13;
<p>And then finally, you can go ahead and remove your Minikube cluster if you are done with everything in it for now:<a data-primary="minikube command" data-secondary="delete" data-type="indexterm" id="idm46803132949264"/></p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code>$</code><code class="w"> </code><code>minikube</code><code class="w"> </code><code>delete</code><code class="w">&#13;
&#13;
</code><img src="assets/fire_1f525.png"/><code class="w">  </code><code>Deleting</code><code class="w"> </code><code class="s2">"minikube"</code><code class="w"> </code><code class="k">in</code><code class="w"> </code><code>docker</code><code class="w"> </code><code>…</code><code class="w">&#13;
</code><img src="assets/fire_1f525.png"/><code class="w">  </code><code>Deleting</code><code class="w"> </code><code>container</code><code class="w"> </code><code class="s2">"minikube"</code><code class="w"> </code><code>…</code><code class="w">&#13;
</code><img src="assets/fire_1f525.png"/><code class="w">  </code><code>Removing</code><code class="w"> </code><code>/Users/spkane/.minikube/machines/minikube</code><code class="w"> </code><code>…</code><code class="w">&#13;
</code><img src="assets/skull_1f480.png"/><code class="w">  </code><code>Removed</code><code class="w"> </code><code>all</code><code class="w"> </code><code>traces</code><code class="w"> </code><code>of</code><code class="w"> </code><code>the</code><code class="w"> </code><code class="s2">"minikube"</code><code class="w"> </code><code>cluster.</code></pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Kubernetes is a really big system, with great community involvement. We’ve just shown you the tip of the iceberg with Minikube, but if you are interested, there are many other Kubernetes distributions and tools to explore.<a data-startref="ch10-scalmin" data-type="indexterm" id="idm46803132910288"/><a data-startref="ch10-scalmin2" data-type="indexterm" id="idm46803132920480"/><a data-startref="ch10-scalmin3" data-type="indexterm" id="idm46803132919808"/><a data-startref="ch10-api" data-type="indexterm" id="idm46803132919136"/><a data-startref="ch10-api2" data-type="indexterm" id="idm46803132918464"/><a data-startref="ch10-api3" data-type="indexterm" id="idm46803132917792"/><a data-startref="ch10-api4" data-type="indexterm" id="idm46803132917120"/></p>&#13;
</div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Docker Desktop-Integrated Kubernetes" data-type="sect2"><div class="sect2" id="idm46803135171872">&#13;
<h2>Docker Desktop-Integrated Kubernetes</h2>&#13;
&#13;
<p>Docker Desktop comes with support<a data-primary="Docker Desktop" data-primary-sortas="docker-a" data-secondary="Kubernetes" data-type="indexterm" id="idm46803132914528"/><a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="Docker Desktop" data-type="indexterm" id="idm46803132913280"/><a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="Docker Desktop" data-type="indexterm" id="idm46803132825680"/> for an integrated single-node Kubernetes cluster that can be run by simply enabling an option in the application preferences.</p>&#13;
&#13;
<p>The integrated Kubernetes cluster is not easily configurable, but it does provide a very accessible option for those who simply need to verify some basic functionality against a current Kubernetes installation.</p>&#13;
&#13;
<p>To enable Docker Desktop’s built-in Kubernetes functionality, launch Docker Desktop and then open up Preferences from the Docker whale icon in your task/menu bar. Then select the Kubernetes tab, click Enable Kubernetes, and finally click the “Apply &amp; Restart” button to make the required changes to the VM. The first time you do this, Docker will utilize the <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm"><code>kubeadm</code></a> command to set up the Kubernetes cluster.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>If you are interested in a bit more information about how the Docker Desktop-integrated Kubernetes is set up, Docker has a good <a href="https://www.docker.com/blog/how-kubernetes-works-under-the-hood-with-docker-desktop">blog post</a> that covers some of these details.</p>&#13;
</div>&#13;
&#13;
<p>This will create a new <code>kubectl</code> context called <code>docker-desktop</code> and should automatically switch you to this context.</p>&#13;
&#13;
<p>You can confirm which context you are currently set to by running the following:<a data-primary="kubectl command" data-secondary="config" data-tertiary="current-context" data-type="indexterm" id="idm46803132819520"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>config<code class="w"> </code>current-context<code class="w"/>&#13;
&#13;
<code class="go">docker-desktop</code></pre>&#13;
&#13;
<p>If you need to change the current context, you can do so like this:<a data-primary="kubectl command" data-secondary="config" data-tertiary="use-context" data-type="indexterm" id="idm46803132811968"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>config<code class="w"> </code>use-context<code class="w"> </code>docker-desktop<code class="w"> </code>--namespace<code class="o">=</code>default<code class="w"/>&#13;
&#13;
<code class="go">Switched to context "docker-desktop".</code></pre>&#13;
&#13;
<p>And finally, if you want to completely unset the current context, you can use this command:<a data-primary="kubectl command" data-secondary="config" data-tertiary="unset current-context" data-type="indexterm" id="idm46803132801440"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>config<code class="w"> </code><code class="nb">unset</code><code class="w"> </code>current-context<code class="w"/>&#13;
&#13;
<code class="go">Property "current-context" unset.</code></pre>&#13;
&#13;
<p>Once this cluster is running, you can interact with it just like any other Kubernetes cluster via the <code>kubectl</code> command. Whenever you shut down Docker Desktop, this will also shut down the Kubernetes cluster.</p>&#13;
&#13;
<p>If you want to completely disable this Kubernetes cluster, go back into the Preferences panel, select the Kubernetes tab, and un-check Enable Kubernetes.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Kind" data-type="sect2"><div class="sect2" id="k8s_kind">&#13;
<h2>Kind</h2>&#13;
&#13;
<p>The final option that we are going to discuss<a data-primary="scaling" data-secondary="Kubernetes" data-tertiary="kind" data-type="indexterm" id="ch10-kind"/><a data-primary="Kubernetes" data-secondary="scaling" data-tertiary="kind" data-type="indexterm" id="ch10-kind2"/><a data-primary="kind" data-type="indexterm" id="ch10-kind3"/> here is <code>kind</code>, a very simple but useful tool that allows you to manage a Kubernetes cluster made up of one or more Linux containers running in Docker. The tool name, <code>kind</code>, is an acronym that means “Kubernetes in Docker” but also refers to the fact that object types in Kubernetes are identified in the API by a field called <code>Kind</code>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>You will find that searching for this tool on the web can be a bit difficult, but you can always find the tool and documentation on its primary <a href="https://kind.sigs.k8s.io">website</a>.</p>&#13;
</div>&#13;
&#13;
<p><code>kind</code> provides a nice middle ground between the simplistic Kubernetes cluster that is embedded into the Docker VM and the <code>minikube</code> VM, which can be overly complex at times. <code>kind</code> is distributed as a single binary and can be installed with your favorite package manager or by simply navigating to the <a href="https://github.com/kubernetes-sigs/kind/releases"><code>kind</code> project releases page</a> and downloading the most recent release for your system. If you manually download the binary, make sure that you rename the binary to <code>kind</code>, copy it to a directory in your path, and then ensure that it has the correct permissions so that users can run it.</p>&#13;
&#13;
<p>Once <code>kind</code> is installed, you can try to create your first cluster with it by running the following:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code>$</code><code class="w"> </code><code>kind</code><code class="w"> </code><code>create</code><code class="w"> </code><code>cluster</code><code class="w"> </code><code>--name</code><code class="w"> </code><code class="nb">test</code><code class="w">&#13;
&#13;
</code><code>Creating</code><code class="w"> </code><code>cluster</code><code class="w"> </code><code class="s2">"test"</code><code class="w"> </code><code>…</code><code class="w">&#13;
 </code><code>✓</code><code class="w"> </code><code>Ensuring</code><code class="w"> </code><code>node</code><code class="w"> </code><code>image</code><code class="w"> </code><code class="o">(</code><code>kindest/node:v1.25.3</code><code class="o">)</code><code class="w"> </code><img src="assets/framed-picture_1f5bc.png"/><code class="w">&#13;
 </code><code>✓</code><code class="w"> </code><code>Preparing</code><code class="w"> </code><code>nodes</code><code class="w"> </code><img src="assets/package_1f4e6.png"/><code class="w">&#13;
 </code><code>✓</code><code class="w"> </code><code>Writing</code><code class="w"> </code><code>configuration</code><code class="w"> </code><img src="assets/scroll_1f4dc.png"/><code class="w">&#13;
 </code><code>✓</code><code class="w"> </code><code>Starting</code><code class="w"> </code><code>control-plane</code><code class="w"> </code><img src="assets/joystick_1f579.png"/><code class="w">&#13;
 </code><code>✓</code><code class="w"> </code><code>Installing</code><code class="w"> </code><code>CNI</code><code class="w"> </code><img src="assets/electric-plug_1f50c.png"/><code class="w">&#13;
 </code><code>✓</code><code class="w"> </code><code>Installing</code><code class="w"> </code><code>StorageClass</code><code class="w"> </code><img src="assets/floppy-disk_1f4be.png"/><code class="w">&#13;
</code><code>Set</code><code class="w"> </code><code>kubectl</code><code class="w"> </code><code>context</code><code class="w"> </code><code>to</code><code class="w"> </code><code class="s2">"kind-test"</code><code class="w">&#13;
</code><code>You</code><code class="w"> </code><code>can</code><code class="w"> </code><code>now</code><code class="w"> </code><code>use</code><code class="w"> </code><code>your</code><code class="w"> </code><code>cluster</code><code class="w"> </code><code>with:</code><code class="w">&#13;
&#13;
</code><code>kubectl</code><code class="w"> </code><code>cluster-info</code><code class="w"> </code><code>--context</code><code class="w"> </code><code>kind-test</code><code class="w">&#13;
&#13;
</code><code>Thanks</code><code class="w"> </code><code class="k">for</code><code class="w"> </code><code>using</code><code class="w"> </code><code>kind!</code><code class="w"> </code><img src="assets/smiling-face_1f60a.png"/><code class="w"> </code></pre>&#13;
&#13;
<p class="pagebreak-before">By default, this command will spin up a single Docker container that represents a one-node Kubernetes cluster, using the most current stable Kubernetes release that <code>kind</code> currently supports.</p>&#13;
&#13;
<p><code>kind</code> has already set the Kubernetes current context to point at the cluster, so we can start running <code>kubectl</code> commands immediately:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>cluster-info<code class="w"/>&#13;
&#13;
<code class="go">Kubernetes control plane is running at https://127.0.0.1:56499</code>&#13;
<code class="go">CoreDNS is running at</code>&#13;
<code class="go">https://127.0.0.1:56499/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</code>&#13;
&#13;
<code class="go">To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</code></pre>&#13;
&#13;
<p>You can see a redacted version of the information used by <code>kubectl</code> to connect to the Kubernetes server by running the following:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kubectl<code class="w"> </code>config<code class="w"> </code>view<code class="w"> </code>--minify<code class="w"/></pre>&#13;
&#13;
<pre class="nomargin" data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>&#13;
<code class="nt">clusters</code><code class="p">:</code><code class="w"/>&#13;
<code class="p-Indicator">-</code><code class="w"> </code><code class="nt">cluster</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">certificate-authority-data</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">DATA+OMITTED</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">server</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://127.0.0.1:56499</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kind-test</code><code class="w"/>&#13;
<code class="nt">contexts</code><code class="p">:</code><code class="w"/>&#13;
<code class="p-Indicator">-</code><code class="w"> </code><code class="nt">context</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">cluster</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kind-test</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">user</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kind-test</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kind-test</code><code class="w"/>&#13;
<code class="nt">current-context</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kind-test</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Config</code><code class="w"/>&#13;
<code class="nt">preferences</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/>&#13;
<code class="nt">users</code><code class="p">:</code><code class="w"/>&#13;
<code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kind-test</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">user</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">client-certificate-data</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">REDACTED</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">client-key-data</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">REDACTED</code><code class="w"/></pre>&#13;
&#13;
<p><code>kind</code> has some <a href="https://kind.sigs.k8s.io/docs/user/quick-start/#advanced">advanced features</a> that can generally be controlled by passing in a configuration file with the <code>--config</code> argument when spinning up the cluster.</p>&#13;
&#13;
<p>You may find some of the follwing features useful:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Changing the version of Kubernetes that is used</p>&#13;
</li>&#13;
<li>&#13;
<p>Spinning up multiple worker nodes</p>&#13;
</li>&#13;
<li>&#13;
<p>Spinning up multiple control plane nodes for HA testing</p>&#13;
</li>&#13;
<li>&#13;
<p>Mapping ports between Docker and the local host system</p>&#13;
</li>&#13;
<li>&#13;
<p>Enabling and disabling <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates">Kubernetes feature gates</a></p>&#13;
</li>&#13;
<li>&#13;
<p>Exporting control plane component logs with <code>kind export logs</code></p>&#13;
</li>&#13;
<li>&#13;
<p>And more</p>&#13;
</li>&#13;
</ul>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>One thing to remember when using <code>kind</code> is that Kubernetes is running inside one or more containers, which are potentially running inside a Linux VM when you are using something like Docker Desktop. This may mean that you need to set up some additional port forwarding when you spin up the cluster. This can be done using the <code>extraPortMappings</code> setting in the <code>kind</code> config.</p>&#13;
</div>&#13;
&#13;
<p>At this point, you can go ahead and delete the cluster by running the following command:<a data-startref="ch10-kind" data-type="indexterm" id="idm46803132448080"/><a data-startref="ch10-kind2" data-type="indexterm" id="idm46803132447376"/><a data-startref="ch10-kind3" data-type="indexterm" id="idm46803132446704"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>kind<code class="w"> </code>delete<code class="w"> </code>cluster<code class="w"> </code>--name<code class="w"> </code><code class="nb">test</code><code class="w"/>&#13;
&#13;
<code class="go">Deleting cluster "test" …</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Amazon ECS and Fargate" data-type="sect1"><div class="sect1" id="idm46803132775104">&#13;
<h1>Amazon ECS and Fargate</h1>&#13;
&#13;
<p>One of the most popular cloud providers<a data-primary="scaling" data-secondary="Amazon ECS and Fargate" data-tertiary="about" data-type="indexterm" id="idm46803132386576"/><a data-primary="Amazon ECS (Elastic Container Service)" data-secondary="about" data-type="indexterm" id="idm46803132385328"/> is Amazon via their AWS offerings. Support for running containers natively has existed in <a href="https://amzn.to/2wNa1rL">AWS Elastic Beanstalk</a> since mid-2014. But that service assigns only a single container to an Amazon instance, which means that it’s not ideal for short-lived or lightweight containers. Amazon Elastic Compute Cloud (Amazon EC2) itself is a great platform for hosting your own Docker environment, though, and because Docker is powerful, you don’t necessarily need much on top of your instances to make this a productive environment to work in. But Amazon has spent a lot of engineering time building a service that treats containers as first-class citizens: the Amazon Elastic Container Service (Amazon ECS). In the last few years, Amazon has built upon this support with products like the Elastic Kubernetes Services (EKS) and AWS Fargate.<a data-primary="Amazon ECS (Elastic Container Service)" data-secondary="Fargate" data-type="indexterm" id="idm46803132378272"/><a data-primary="Amazon Fargate" data-seealso="Amazon ECS (Elastic Container Service)" data-type="indexterm" id="idm46803132377328"/><a data-primary="Fargate" data-seealso="Amazon ECS (Elastic Container Service)" data-type="indexterm" id="idm46803132376416"/><a data-primary="Amazon EKS (Elastic Kubernetes Service)" data-secondary="Linux container use" data-type="indexterm" id="idm46803132375504"/></p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Fargate is simply a marketing label Amazon uses for the feature of ECS that makes it possible for AWS to automatically manage all the nodes in your container cluster so that you can focus on deploying your service.</p>&#13;
</div>&#13;
&#13;
<p>The ECS is a set of tools that coordinates several AWS components. With ECS, you have a choice of whether or not you will run the Fargate tooling on top. If you do, then you don’t need to handle as much of the work. If you don’t, then in addition to the cluster nodes to handle your workload, you will also need to add one or more EC2 instances to the cluster running Docker and Amazon’s special ECS agent. If you run Fargate, then the cluster is automatically managed for you. In either case, you spin up the cluster and then push your containers into it.</p>&#13;
&#13;
<p>The <a href="https://github.com/aws/amazon-ecs-agent">Amazon ECS agent</a> we just mentioned works with the ECS service to coordinate your cluster and schedule containers to your hosts. You will only be directly exposed to this when you manage a traditional non-Fargate ECS cluster.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Core AWS Setup" data-type="sect2"><div class="sect2" id="idm46803132371840">&#13;
<h2>Core AWS Setup</h2>&#13;
&#13;
<p>The rest of this section assumes<a data-primary="Amazon ECS (Elastic Container Service)" data-secondary="core AWS setup" data-type="indexterm" id="idm46803132370512"/><a data-primary="scaling" data-secondary="Amazon ECS and Fargate" data-tertiary="core AWS setup" data-type="indexterm" id="idm46803132348304"/> that you have access to an AWS account and some familiarity with the service. You can learn about pricing and create a new account at <a class="bare" href="https://aws.amazon.com/free"><em class="hyperlink">https://aws.amazon.com/free</em></a>. Amazon offers a free service tier, which may be enough for you to experiment with if you don’t already have a paid account. After you have your AWS account set up, you will need at least one administrative user, a key pair, an Amazon virtual private cloud (AWS VPC), and a default security group in your environment. If you do not already have these set up, follow the directions in the <a href="https://amzn.to/2FcPDSL">Amazon documentation</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="IAM Role Setup" data-type="sect2"><div class="sect2" id="idm46803132344976">&#13;
<h2>IAM Role Setup</h2>&#13;
&#13;
<p>Amazon’s Identity and Access Management<a data-primary="Amazon ECS (Elastic Container Service)" data-secondary="Identity and Access Management (IAM)" data-type="indexterm" id="idm46803132343376"/><a data-primary="Amazon Identity and Access Management (IAM)" data-type="indexterm" id="idm46803132342528"/><a data-primary="IAM (Amazon Identity and Access Management)" data-type="indexterm" id="idm46803132341920"/><a data-primary="scaling" data-secondary="Amazon ECS and Fargate" data-tertiary="Identity and Access Management" data-type="indexterm" id="idm46803132341312"/> (Amazon IAM) roles are used to control what actions a user can take within your cloud environment. We need to make sure we can grant access to the right actions before moving on with the ECS. To work with the ECS, you must create a role called <code>ecsInstanceRole</code> that has the <code>AmazonEC2ContainerServiceRole</code> managed role attached to it. The easiest way to do this is by logging in to the <a href="https://console.aws.amazon.com">AWS console</a> and navigating to <a href="https://console.aws.amazon.com/iam/home">Identity and Access Management</a>:</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Check to ensure that you don’t already have the proper role. If it already exists, then you should double-check that it is set up properly, as these directions have changed a bit over the years.</p>&#13;
</div>&#13;
<ol>&#13;
<li>&#13;
<p>In the left sidebar, click Roles.</p>&#13;
</li>&#13;
<li>&#13;
<p>Then, click the “Create role” button.</p>&#13;
</li>&#13;
<li>&#13;
<p>Under AWS Service, select Elastic Container Service.</p>&#13;
</li>&#13;
<li>&#13;
<p>Under “Select your use case,” select Elastic Container Service.</p>&#13;
</li>&#13;
<li>&#13;
<p>Click Next: Permissions.</p>&#13;
</li>&#13;
<li>&#13;
<p>Click Next: Review.</p>&#13;
</li>&#13;
<li>&#13;
<p>In Role Name, type <strong><code>ecsInstanceRole</code></strong>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Click “Create role.”</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>If you are interested in storing container configuration in an S3 object storage bucket, take a look at the Amazon ECS container agent configuration <a href="https://amzn.to/2PNapOL">documentation</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="AWS CLI Setup" data-type="sect2"><div class="sect2" id="idm46803132327264">&#13;
<h2>AWS CLI Setup</h2>&#13;
&#13;
<p>Amazon supplies command-line tools<a data-primary="Amazon ECS (Elastic Container Service)" data-secondary="AWS CLI setup" data-type="indexterm" id="idm46803132325936"/><a data-primary="scaling" data-secondary="Amazon ECS and Fargate" data-tertiary="AWS CLI setup" data-type="indexterm" id="idm46803132324896"/> that make it easy to work with their API-driven infrastructure. You will need to install a very recent version of the AWS CLI tools. Amazon has <a href="https://amzn.to/1PCpPNA">detailed documentation</a> that covers the installation of their tools, but the basic steps are as follows.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Installation" data-type="sect3"><div class="sect3" id="idm46803132322768">&#13;
<h3>Installation</h3>&#13;
&#13;
<p>Here we’ll cover the native installation on a few different OSes, but be aware that you can also run the <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-docker.html#cliv2-docker-install">AWS CLI via a Docker container</a>! You can feel free to skip to the one you care about. If you’re curious or just like installation instructions, by all means, read them all!<a data-primary="macOS running Docker" data-secondary="AWS CLI setup" data-type="indexterm" id="idm46803132320432"/><a data-primary="Windows running Docker" data-secondary="AWS CLI setup" data-type="indexterm" id="idm46803132319600"/></p>&#13;
<dl>&#13;
<dt>macOS</dt>&#13;
<dd>&#13;
<p>In <a data-type="xref" href="ch03.html#installing_docker">Chapter 3</a>, we discussed installing Homebrew. If you previously did this, you can install the AWS CLI using the following commands:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>brew<code class="w"> </code>update<code class="w"/>&#13;
<code class="gp">$ </code>brew<code class="w"> </code>install<code class="w"> </code>awscli<code class="w"/></pre>&#13;
</dd>&#13;
<dt>Windows</dt>&#13;
<dd>&#13;
<p>Amazon provides a standard MSI installer for Windows, which can be downloaded from Amazon S3 for your architecture:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://s3.amazonaws.com/aws-cli/AWSCLI32.msi">32-bit Windows</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://s3.amazonaws.com/aws-cli/AWSCLI64.msi">64-bit Windows</a></p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt>Other</dt>&#13;
<dd>&#13;
<p>The Amazon CLI tools are written in Python. So on most platforms, you can install the tools with the Python <code>pip</code> package manager by running the following from a shell:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>pip<code class="w"> </code>install<code class="w"> </code>awscli<code class="w"> </code>--upgrade<code class="w"> </code>--user<code class="w"/></pre>&#13;
&#13;
<p class="pagebreak-before">Some platforms won’t have <code>pip</code> installed by default. In that case, you can use the <code>easy_install</code> package manager, like this:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>easy_install<code class="w"> </code>awscli<code class="w"/></pre>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Configuration" data-type="sect3"><div class="sect3" id="idm46803132240000">&#13;
<h3>Configuration</h3>&#13;
&#13;
<p>Quickly verify that your AWS CLI version is at least 1.7.0 with the following &#13;
<span class="keep-together">command</span>:<a data-primary="aws" data-secondary="--version" data-secondary-sortas="version" data-type="indexterm" id="idm46803132264720"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>--version<code class="w"/>&#13;
&#13;
<code class="go">aws-cli/1.14.50 Python/3.6.4 Darwin/17.3.0 botocore/1.9.3</code></pre>&#13;
&#13;
<p>To configure the AWS CLI tool, ensure that you have access to your AWS access key ID and AWS secret access key, and then run the <code>configure</code> command. You will be prompted for your authentication information and some preferred defaults:<a data-primary="aws" data-secondary="configure" data-type="indexterm" id="idm46803132207168"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>configure<code class="w"/>&#13;
&#13;
<code class="go">AWS Access Key ID [None]: EXAMPLEEXAMPLEEXAMPLE</code>&#13;
<code class="go">AWS Secret Access Key [None]: ExaMPleKEy/7EXAMPL3/EXaMPLeEXAMPLEKEY</code>&#13;
<code class="go">Default region name [None]: us-east-1</code>&#13;
<code class="go">Default output format [None]: json</code></pre>&#13;
&#13;
<p>At this point, it’s a really good idea to test that the CLI tools are working correctly before proceeding. You can easily do that by running the following command to list the IAM users in your account:<a data-primary="aws" data-secondary="iam" data-tertiary="list-users" data-type="indexterm" id="idm46803132202448"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>iam<code class="w"> </code>list-users<code class="w"/></pre>&#13;
&#13;
<p>Assuming everything went according to plan and you chose JSON as your default output format, you should get something like this:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"Users"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"Path"</code><code class="p">:</code><code class="w"> </code><code class="s2">"/"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"UserName"</code><code class="p">:</code><code class="w"> </code><code class="s2">"administrator"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"UserId"</code><code class="p">:</code><code class="w"> </code><code class="s2">"ExmaPL3ExmaPL3ExmaPL3Ex"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"Arn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:iam::936262807352:user/myuser"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"CreateDate"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2021-04-08T17:22:23+00:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"PasswordLastUsed"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T15:56:21+00:00"</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">]</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Container Instances" data-type="sect2"><div class="sect2" id="idm46803132071856">&#13;
<h2>Container Instances</h2>&#13;
&#13;
<p>The first thing you need to do after<a data-primary="Amazon ECS (Elastic Container Service)" data-secondary="container instances" data-type="indexterm" id="idm46803132077568"/><a data-primary="scaling" data-secondary="Amazon ECS and Fargate" data-tertiary="container instances" data-type="indexterm" id="idm46803132076624"/> installing the required tools is to create at least a single cluster that your Docker hosts will register with when they are brought online.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The default cluster is imaginatively named <em>default</em>. If you keep this name, you do not need to specify <code>--cluster-name</code> in many of the commands that follow.</p>&#13;
</div>&#13;
&#13;
<p>The first thing you need to do is create a cluster in the container service. You will then launch your tasks in the cluster once it’s up and running. For these examples, you should start by creating a cluster called <code>fargate-testing</code>:<a data-primary="aws" data-secondary="ecs" data-tertiary="create-cluster" data-type="indexterm" id="idm46803132048768"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>create-cluster<code class="w"> </code>--cluster-name<code class="w"> </code>fargate-testing<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"cluster"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"clusterArn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:ecs:us-east-1:1…2:cluster/fargate-testing"</code><code class="p">,</code><code class="w"/>&#13;
<code class="nt">"clusterName"</code><code class="p">:</code><code class="w"> </code><code class="s2">"fargate-testing"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"status"</code><code class="p">:</code><code class="w"> </code><code class="s2">"ACTIVE"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"registeredContainerInstancesCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"runningTasksCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"pendingTasksCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"activeServicesCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"statistics"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"tags"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"settings"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"containerInsights"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"value"</code><code class="p">:</code><code class="w"> </code><code class="s2">"disabled"</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"capacityProviders"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"defaultCapacityProviderStrategy"</code><code class="p">:</code><code class="w"> </code><code class="p">[]</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>Before AWS Fargate was released, you were required to create AWS EC2 instances running <code>docker</code> and the <code>ecs-agent</code>, and add them to your cluster. You can still use this approach if you want (<code>EC2 launch type</code>), but Fargate makes it much easier to run a dynamic cluster that can scale fluidly with your workload.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Tasks" data-type="sect2"><div class="sect2" id="idm46803131935104">&#13;
<h2>Tasks</h2>&#13;
&#13;
<p>Now that our container cluster is set up,<a data-primary="Amazon ECS (Elastic Container Service)" data-secondary="tasks" data-type="indexterm" id="ch10-task"/><a data-primary="scaling" data-secondary="Amazon ECS and Fargate" data-tertiary="tasks" data-type="indexterm" id="ch10-task2"/> we need to start putting it to work. To do this, we need to create at least one task definition. The Amazon ECS defines the term <em>task definition</em> as a list of containers grouped together.</p>&#13;
&#13;
<p>To create your first task definition, open up your favorite editor, copy in the following JSON, and then save it as <em>webgame-task.json</em> in your current directory, as shown here:</p>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"containerDefinitions"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"web-game"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"image"</code><code class="p">:</code><code class="w"> </code><code class="s2">"spkane/quantum-game"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"cpu"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"portMappings"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">"containerPort"</code><code class="p">:</code><code class="w"> </code><code class="mi">8080</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">"hostPort"</code><code class="p">:</code><code class="w"> </code><code class="mi">8080</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">          </code><code class="nt">"protocol"</code><code class="p">:</code><code class="w"> </code><code class="s2">"tcp"</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">      </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"essential"</code><code class="p">:</code><code class="w"> </code><code class="kc">true</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"environment"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"mountPoints"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"volumesFrom"</code><code class="p">:</code><code class="w"> </code><code class="p">[]</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"family"</code><code class="p">:</code><code class="w"> </code><code class="s2">"fargate-game"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"networkMode"</code><code class="p">:</code><code class="w"> </code><code class="s2">"awsvpc"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"volumes"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"placementConstraints"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"requiresCompatibilities"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">    </code><code class="s2">"FARGATE"</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"cpu"</code><code class="p">:</code><code class="w"> </code><code class="s2">"256"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"memory"</code><code class="p">:</code><code class="w"> </code><code class="s2">"512"</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>You can also check out these files and a few others by running the following:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="go">git clone \</code>&#13;
<code class="go">  https://github.com/bluewhalebook/\</code>&#13;
<code class="go">docker-up-and-running-3rd-edition.git \</code>&#13;
<code class="go">  --config core.autocrlf=input</code></pre>&#13;
&#13;
<p>The URL has been continued on the following line so that it fits in the margins. You may find that you need to reassemble the URL and remove the backslashes for the command to work properly.</p>&#13;
</div>&#13;
&#13;
<p>In this task definition, we are saying that we want to create a task family called <code>fargate-game</code> running a single container called <code>web-game</code> that is based on the <a href="https://github.com/stared/quantum-game"><em>Quantum</em> web game</a>. As you may have seen in an earlier chapter, this Docker image launches a browser-based puzzle game that uses real quantum mechanics.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Fargate limits some of the options that you can set in this configuration, including <code>networkMode</code> and the <code>cpu</code> and <code>memory</code> settings. You can find out more about the options in the task definition from the official <a href="https://amzn.to/2PkliGR">AWS documentation</a>.</p>&#13;
</div>&#13;
&#13;
<p>In this task definition, we define some constraints on memory and CPU usage for the container, in addition to telling Amazon whether this container is essential to the task. The <code>essential</code> flag is useful when you have multiple containers defined in a task, and not all of them are required for the task to be successful. If <code>essential</code> is true and the container fails to start, then all the containers defined in the task will be killed and the task will be marked as failed. We can also use the task definition to define almost all of the typical variables and settings that would be included in a <em>Dockerfile</em> or on the <code>docker container run</code> command line.</p>&#13;
&#13;
<p>To upload this task definition to Amazon, you will need to run a command similar to what is shown here:<a data-primary="aws" data-secondary="ecs" data-tertiary="register-task-definition" data-type="indexterm" id="idm46803131678976"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>register-task-definition<code class="w"> </code>--cli-input-json<code class="w"> </code>file://./webgame-task.json<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"taskDefinition"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"taskDefinitionArn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:ecs:…:task-definition/fargate-game:1"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"containerDefinitions"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"web-game"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"image"</code><code class="p">:</code><code class="w"> </code><code class="s2">"spkane/quantum-game"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"cpu"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"portMappings"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">                    </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                        </code><code class="nt">"containerPort"</code><code class="p">:</code><code class="w"> </code><code class="mi">8080</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                        </code><code class="nt">"hostPort"</code><code class="p">:</code><code class="w"> </code><code class="mi">8080</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                        </code><code class="nt">"protocol"</code><code class="p">:</code><code class="w"> </code><code class="s2">"tcp"</code><code class="w"/>&#13;
<code class="w">                    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"essential"</code><code class="p">:</code><code class="w"> </code><code class="kc">true</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"environment"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"mountPoints"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"volumesFrom"</code><code class="p">:</code><code class="w"> </code><code class="p">[]</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"family"</code><code class="p">:</code><code class="w"> </code><code class="s2">"fargate-game"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"networkMode"</code><code class="p">:</code><code class="w"> </code><code class="s2">"awsvpc"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"revision"</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"volumes"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"status"</code><code class="p">:</code><code class="w"> </code><code class="s2">"ACTIVE"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"requiresAttributes"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"com.amazonaws.ecs.capability.docker-remote-api.1.18"</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"ecs.capability.task-eni"</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"placementConstraints"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"compatibilities"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">            </code><code class="s2">"EC2"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="s2">"FARGATE"</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"requiresCompatibilities"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">            </code><code class="s2">"FARGATE"</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"cpu"</code><code class="p">:</code><code class="w"> </code><code class="s2">"256"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"memory"</code><code class="p">:</code><code class="w"> </code><code class="s2">"512"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"registeredAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:10:18.184000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"registeredBy"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:iam::…:user/me"</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>We can then list all of our task definitions by running the following:<a data-primary="aws" data-secondary="ecs" data-tertiary="list-task-definitions" data-type="indexterm" id="idm46803131304512"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>list-task-definitions<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"taskDefinitionArns"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="s2">"arn:aws:ecs:us-east-1:…:task-definition/fargate-game:1"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">]</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>Now you are ready to create your first task in your cluster. You do so by running a command like the one shown next. The <code>count</code> argument in the command allows you to define how many copies of this task you want to be deployed into your cluster. For this job, one is enough.</p>&#13;
&#13;
<p>You will need to modify the following command to reference a valid subnet ID and security-group ID from your AWS VPC. You should be able to find these in the <a href="https://console.aws.amazon.com/vpc/home">AWS console</a> or by using the AWS CLI commands <code>aws ec2 describe-subnets</code> and <code>aws ec2 describe-security-groups</code>. You can also tell AWS to assign your tasks a public IP address by using a network configuration similar to this:</p>&#13;
&#13;
<pre data-type="programlisting">awsvpcConfiguration={subnets=[subnet-abcd1234],&#13;
                     securityGroups=[sg-abcd1234],&#13;
                     assignPublicIp=ENABLED}</pre>&#13;
&#13;
<p>Assigning a public IP address may be required if you are using public subnets:<a data-primary="aws" data-secondary="ecs" data-tertiary="create-service" data-type="indexterm" id="idm46803131449536"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>create-service<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"> </code>--service-name<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>fargate-game-service<code class="w"> </code>--task-definition<code class="w"> </code>fargate-game:1<code class="w"> </code>--desired-count<code class="w"> </code><code class="m">1</code><code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--launch-type<code class="w"> </code><code class="s2">"FARGATE"</code><code class="w"> </code>--network-configuration<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code><code class="s2">"awsvpcConfiguration={subnets=[subnet-abcd1234],\</code>&#13;
<code class="s2">    securityGroups=[sg-abcd1234]}"</code><code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"service"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"serviceArn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:ecs:…:service/fargate-game-service"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"serviceName"</code><code class="p">:</code><code class="w"> </code><code class="s2">"fargate-game-service"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"clusterArn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:ecs:…:cluster/fargate-testing"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"loadBalancers"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"serviceRegistries"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"status"</code><code class="p">:</code><code class="w"> </code><code class="s2">"ACTIVE"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"desiredCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"runningCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"pendingCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"launchType"</code><code class="p">:</code><code class="w"> </code><code class="s2">"FARGATE"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"platformVersion"</code><code class="p">:</code><code class="w"> </code><code class="s2">"LATEST"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"platformFamily"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Linux"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"taskDefinition"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:ecs:…:task-definition/fargate-game:1"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"deploymentConfiguration"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"deploymentCircuitBreaker"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"enable"</code><code class="p">:</code><code class="w"> </code><code class="kc">false</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"rollback"</code><code class="p">:</code><code class="w"> </code><code class="kc">false</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"maximumPercent"</code><code class="p">:</code><code class="w"> </code><code class="mi">200</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"minimumHealthyPercent"</code><code class="p">:</code><code class="w"> </code><code class="mi">100</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"deployments"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"id"</code><code class="p">:</code><code class="w"> </code><code class="s2">"ecs-svc/…"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"status"</code><code class="p">:</code><code class="w"> </code><code class="s2">"PRIMARY"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"taskDefinition"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:ecs:…definition/fargate-game:1"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"desiredCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"pendingCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"runningCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"failedTasks"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"createdAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:14:51.653000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"updatedAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:14:51.653000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"launchType"</code><code class="p">:</code><code class="w"> </code><code class="s2">"FARGATE"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"platformVersion"</code><code class="p">:</code><code class="w"> </code><code class="s2">"1.4.0"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"platformFamily"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Linux"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"networkConfiguration"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"rolloutState"</code><code class="p">:</code><code class="w"> </code><code class="s2">"IN_PROGRESS"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"rolloutStateReason"</code><code class="p">:</code><code class="w"> </code><code class="s2">"ECS deployment ecs-svc/… in progress."</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"roleArn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"…aws-service-role/ecs.amazonaws.com/AWSServiceRoleForECS"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"events"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"createdAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:14:51.653000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"placementConstraints"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"placementStrategy"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"networkConfiguration"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"schedulingStrategy"</code><code class="p">:</code><code class="w"> </code><code class="s2">"REPLICA"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"createdBy"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:iam::…:user/me"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"enableECSManagedTags"</code><code class="p">:</code><code class="w"> </code><code class="kc">false</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"propagateTags"</code><code class="p">:</code><code class="w"> </code><code class="s2">"NONE"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"enableExecuteCommand"</code><code class="p">:</code><code class="w"> </code><code class="kc">false</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Fargate and the <code>awsvpc</code> network require that you have a service-linked role for ECS. In the preceding output, you should see a line that ends like this:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">"role/aws-service-role/ecs.amazonaws.com/&#13;
AWSServiceRoleForECS"</pre>&#13;
&#13;
<p>Most of the time this will be autogenerated for you, but you can create it manually using the following command:<a data-primary="aws" data-secondary="iam" data-tertiary="create-service-linked-role" data-type="indexterm" id="idm46803130643728"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>iam<code class="w"> </code>create-service-linked-role<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--aws-service-name<code class="w"> </code>ecs.amazonaws.com<code class="w"/></pre>&#13;
</div>&#13;
&#13;
<p>You can now list all of the services in your cluster with the following command:<a data-primary="aws" data-secondary="ecs" data-tertiary="list-services" data-type="indexterm" id="idm46803131015440"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>list-services<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"serviceArns"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="s2">"arn:aws:ecs:us-west-2:…:service/fargate-testing/fargate-game-service"</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">]</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>To retrieve all the details about your service, run the following:<a data-primary="aws" data-secondary="ecs" data-tertiary="describe-services" data-type="indexterm" id="idm46803130926000"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>describe-services<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--services<code class="w"> </code>fargate-game-service<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"services"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"deployments"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"id"</code><code class="p">:</code><code class="w"> </code><code class="s2">"ecs-svc/…"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"status"</code><code class="p">:</code><code class="w"> </code><code class="s2">"PRIMARY"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"taskDefinition"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:…:task-definition/fargate-game:1"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"desiredCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"pendingCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"runningCount"</code><code class="p">:</code><code class="w"> </code><code class="mi">0</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"createdAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:14:51.653000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"updatedAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:14:51.653000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"launchType"</code><code class="p">:</code><code class="w"> </code><code class="s2">"FARGATE"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"platformVersion"</code><code class="p">:</code><code class="w"> </code><code class="s2">"1.4.0"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"platformFamily"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Linux"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"networkConfiguration"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">                    </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"rolloutState"</code><code class="p">:</code><code class="w"> </code><code class="s2">"IN_PROGRESS"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"rolloutStateReason"</code><code class="p">:</code><code class="w"> </code><code class="s2">"ECS deployment ecs-svc/…progress."</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"roleArn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"…role/ecs.amazonaws.com/AWSServiceRoleForECS"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"events"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"id"</code><code class="p">:</code><code class="w"> </code><code class="s2">"83bd5c2eed5d4866bb7ec8c3c938666c"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"createdAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:14:54.950000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"message"</code><code class="p">:</code><code class="w"> </code><code class="s2">"(…game-service) has started 1 tasks: (…)."</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">],</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"failures"</code><code class="p">:</code><code class="w"> </code><code class="p">[]</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>This output will tell you a lot about all the tasks in your service. In this case, we have a single task running at the moment.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The <code>task-definition</code> value is a name followed by a number (<code>fargate-game:1</code>). The number is the revision. If you edit your task and re-register it with the <code>aws ecs register-task-definition</code> command, you will get a new revision, which means that you will want to reference that new revision in various commands, like <code>aws ecs update-service</code>. If you don’t change that number, you will continue to launch containers using the older JSON. This versioning makes it very easy to roll back changes and test new revisions without impacting all future instances.</p>&#13;
</div>&#13;
&#13;
<p>If you want to see what individual tasks are running in your cluster, you can run the following:<a data-primary="aws" data-secondary="ecs" data-tertiary="list-tasks" data-type="indexterm" id="idm46803130327536"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>list-tasks<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"taskArns"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="s2">"arn:aws:ecs:…:task/fargate-testing/83bd5c2eed5d4866bb7ec8c3c938666c"</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">]</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>Since you only have a single task in your cluster at the moment, this list is very small.</p>&#13;
&#13;
<p>To get more details about the individual task, you can run the following command after substituting the task ID with the correct one from your cluster:<a data-primary="aws" data-secondary="ecs" data-tertiary="describe-tasks" data-type="indexterm" id="idm46803130316336"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>describe-tasks<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--task<code class="w"> </code>83bd5c2eed5d4866bb7ec8c3c938666c<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"tasks"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"attachments"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">{</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"details"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">                        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                            </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"networkInterfaceId"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                            </code><code class="nt">"value"</code><code class="p">:</code><code class="w"> </code><code class="s2">"eni-00a40225208c9411a"</code><code class="w"/>&#13;
<code class="w">                        </code><code class="p">},</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">                        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                            </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"privateIPv4Address"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                            </code><code class="nt">"value"</code><code class="p">:</code><code class="w"> </code><code class="s2">"172.31.42.184"</code><code class="w"/>&#13;
<code class="w">                        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">                    </code><code class="p">]</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"attributes"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"availabilityZone"</code><code class="p">:</code><code class="w"> </code><code class="s2">"us-west-2b"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"clusterArn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:ecs:us-west-2:…:cluster/fargate-testing"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"connectivity"</code><code class="p">:</code><code class="w"> </code><code class="s2">"CONNECTED"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"connectivityAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:23:46.929000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"containers"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"containerArn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:…:container/fargate-testing/…"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"taskArn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:…:task/fargate-testing/…"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"web-game"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"image"</code><code class="p">:</code><code class="w"> </code><code class="s2">"spkane/quantum-game"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"runtimeId"</code><code class="p">:</code><code class="w"> </code><code class="s2">"83bd…998"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"lastStatus"</code><code class="p">:</code><code class="w"> </code><code class="s2">"RUNNING"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"networkInterfaces"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">                        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                            </code><code class="nt">"attachmentId"</code><code class="p">:</code><code class="w"> </code><code class="s2">"ddab…373a"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                            </code><code class="nt">"privateIpv4Address"</code><code class="p">:</code><code class="w"> </code><code class="s2">"172.31.42.184"</code><code class="w"/>&#13;
<code class="w">                        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">                    </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"healthStatus"</code><code class="p">:</code><code class="w"> </code><code class="s2">"UNKNOWN"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"cpu"</code><code class="p">:</code><code class="w"> </code><code class="s2">"0"</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"cpu"</code><code class="p">:</code><code class="w"> </code><code class="s2">"256"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"createdAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:23:42.700000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"desiredStatus"</code><code class="p">:</code><code class="w"> </code><code class="s2">"RUNNING"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"enableExecuteCommand"</code><code class="p">:</code><code class="w"> </code><code class="kc">false</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"group"</code><code class="p">:</code><code class="w"> </code><code class="s2">"service:fargate-game-service"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"healthStatus"</code><code class="p">:</code><code class="w"> </code><code class="s2">"UNKNOWN"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"lastStatus"</code><code class="p">:</code><code class="w"> </code><code class="s2">"RUNNING"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"launchType"</code><code class="p">:</code><code class="w"> </code><code class="s2">"FARGATE"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"memory"</code><code class="p">:</code><code class="w"> </code><code class="s2">"512"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"overrides"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"containerOverrides"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">                    </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                        </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"web-game"</code><code class="w"/>&#13;
<code class="w">                    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"inferenceAcceleratorOverrides"</code><code class="p">:</code><code class="w"> </code><code class="p">[]</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"platformVersion"</code><code class="p">:</code><code class="w"> </code><code class="s2">"1.4.0"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"platformFamily"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Linux"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"pullStartedAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:59:36.554000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"pullStoppedAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:59:46.361000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"startedAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:59:48.546000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"startedBy"</code><code class="p">:</code><code class="w"> </code><code class="s2">"ecs-svc/…"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"tags"</code><code class="p">:</code><code class="w"> </code><code class="p">[],</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"taskArn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:…:task/fargate-testing/83bd…666c"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"taskDefinitionArn"</code><code class="p">:</code><code class="w"> </code><code class="s2">"arn:aws:…:task-definition/fargate-game:1"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"version"</code><code class="p">:</code><code class="w"> </code><code class="mi">4</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"ephemeralStorage"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                </code><code class="nt">"sizeInGiB"</code><code class="p">:</code><code class="w"> </code><code class="mi">20</code><code class="w"/>&#13;
<code class="w">            </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"failures"</code><code class="p">:</code><code class="w"> </code><code class="p">[]</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>If you notice that the <code>lastStatus</code> key is displaying a value of <code>PENDING</code>, this most likely means that your service is still starting up. You can describe the task again to ensure that it has completed transitioning into a <code>RUNNING</code> state. After verifying that the <code>lastStatus</code> key is set to <code>RUNNING</code>, you should be able to test your container.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>Depending on the network setup, your task may not be able to download the image. If you see an error like this:</p>&#13;
&#13;
<p><code>"stoppedReason": "CannotPullContainerError: inspect image has been retried 5 time(s): failed to resolve ref \"docker.io/spkane/quantum-game:latest\": failed to do request: Head <a class="bare" href="https://registry-1.docker.io/v2/spkane/quantum-game/manifests/latest"><em class="hyperlink">https://registry-1.docker.io/v2/spkane/quantum-game/manifests/latest</em></a>: dial tcp 54.83.42.45:443: i/o timeout"</code></p>&#13;
&#13;
<p>then you should read through this <a href="https://oreil.ly/FYo9Z">troubleshooting guide</a>.<sup><a data-type="noteref" href="ch10.html#idm46803129919408" id="idm46803129919408-marker">1</a></sup><a data-startref="ch10-task" data-type="indexterm" id="idm46803129917552"/><a data-startref="ch10-task2" data-type="indexterm" id="idm46803129916944"/></p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing the Task" data-type="sect2"><div class="sect2" id="idm46803131934192">&#13;
<h2>Testing the Task</h2>&#13;
&#13;
<p>You will need a modern web browser<a data-primary="Amazon ECS (Elastic Container Service)" data-secondary="testing the task" data-type="indexterm" id="idm46803129914736"/><a data-primary="scaling" data-secondary="Amazon ECS and Fargate" data-tertiary="testing the task" data-type="indexterm" id="idm46803129913696"/> installed on your system to connect to the container and test the web game.</p>&#13;
&#13;
<p>In the previous output, you’ll notice that the <code>privateIPv4Address</code> for the example task was listed as <code>172.31.42.184</code>. Yours will be different.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>If you need more information about the network setup for your task and the EC2 instance that it is running on, you can grab the <code>networkInterfaceId</code> from the <code>aws ecs describe-tasks</code> output and then append that to the <code>aws ec2 describe-network-interfaces --network-interface-ids</code> command to get everything you should need, including the <code>PublicIp</code> value if you configured your service for that.</p>&#13;
</div>&#13;
&#13;
<p>Ensure that you are connected to a network that can reach either the public or private IP address of your host, then launch your web browser and navigate to port 8080 on that IP address.</p>&#13;
&#13;
<p>In the example, this private URL would look like this:</p>&#13;
&#13;
<pre data-code-language="text" data-type="programlisting">http://172.31.42.184:8080/</pre>&#13;
&#13;
<p>If everything is working as expected, you should be greeted by the <em>Quantum Game</em> puzzle board.</p>&#13;
&#13;
<p>The official version of the game can be found at <a href="https://quantumgame.io"><em class="hyperlink">https://quantumgame.io</em></a>.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>We completely understand if you get distracted at this point and stop reading for a few hours to try to solve some puzzles and learn a little bit of quantum mechanics at the same time. The book won’t notice! Put it down, play the puzzles, and pick it back up later.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Stopping the Task" data-type="sect2"><div class="sect2" id="idm46803129915888">&#13;
<h2>Stopping the Task</h2>&#13;
&#13;
<p>Right, so we have a running task.<a data-primary="Amazon ECS (Elastic Container Service)" data-secondary="stopping the task" data-type="indexterm" id="ch10-stop"/><a data-primary="scaling" data-secondary="Amazon ECS and Fargate" data-tertiary="stopping the task" data-type="indexterm" id="ch10-stop2"/> Now let’s take a look at stopping it. To do that, you need to know the task ID. One way to obtain this is by relisting all the tasks running in your cluster:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>list-tasks<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"taskArns"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="s2">"arn:aws:ecs:…:task/fargate-testing/83bd5c2eed5d4866bb7ec8c3c938666c"</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">]</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>You can also obtain it from the service information:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>describe-services<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--services<code class="w"> </code>fargate-game-service<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"id"</code><code class="p">:</code><code class="w"> </code><code class="s2">"6b7f…0384"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"createdAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T09:59:23.917000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">                    </code><code class="nt">"message"</code><code class="p">:</code><code class="w"> </code><code class="s2">"…: (task 83bd5c2eed5d4866bb7ec8c3c938666c)."</code><code class="w"/>&#13;
<code class="w">                </code><code class="p">}</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>Finally, we can stop the task by running the following command with the correct task ID:<a data-primary="aws" data-secondary="ecs" data-tertiary="stop-task" data-type="indexterm" id="idm46803129542528"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>stop-task<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--task<code class="w"> </code>83bd5c2eed5d4866bb7ec8c3c938666c<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"desiredStatus"</code><code class="p">:</code><code class="w"> </code><code class="s2">"STOPPED"</code><code class="p">,</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"lastStatus"</code><code class="p">:</code><code class="w"> </code><code class="s2">"RUNNING"</code><code class="p">,</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"stopCode"</code><code class="p">:</code><code class="w"> </code><code class="s2">"UserInitiated"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"stoppedReason"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Task stopped by user"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"stoppingAt"</code><code class="p">:</code><code class="w"> </code><code class="s2">"2022-09-05T10:29:05.110000-07:00"</code><code class="p">,</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>If you describe the task again using the same task ID, you should now see that the <code>lastStatus</code> key is set to <code>STOPPED</code>:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>describe-tasks<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>--task<code class="w"> </code>83bd5c2eed5d4866bb7ec8c3c938666c<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"desiredStatus"</code><code class="p">:</code><code class="w"> </code><code class="s2">"STOPPED"</code><code class="p">,</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"lastStatus"</code><code class="p">:</code><code class="w"> </code><code class="s2">"STOPPED"</code><code class="p">,</code><code class="w"/>&#13;
<code class="err">…</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>Listing all the tasks in our cluster should return an empty set:</p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>list-tasks<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"/></pre>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"taskArns"</code><code class="p">:</code><code class="w"> </code><code class="p">[]</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<p>At this point, you could start creating more complicated tasks that tie multiple containers together and rely on the ECS and Fargate tooling to spin up hosts and deploy the tasks into your cluster as needed.</p>&#13;
&#13;
<p>If you want to tear down the rest of the ECS environment, you can run the following commands:<a data-startref="ch10-stop" data-type="indexterm" id="idm46803129351456"/><a data-startref="ch10-stop2" data-type="indexterm" id="idm46803129350848"/><a data-primary="aws" data-secondary="ecs" data-tertiary="delete-service" data-type="indexterm" id="idm46803129350208"/><a data-primary="aws" data-secondary="ecs" data-tertiary="delete-cluster" data-type="indexterm" id="idm46803129330096"/></p>&#13;
&#13;
<pre data-code-language="console" data-type="programlisting"><code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>delete-service<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">  </code>--service<code class="w"> </code>fargate-game-service<code class="w">  </code>--force<code class="w"/>&#13;
<code class="go">…</code>&#13;
&#13;
<code class="gp">$ </code>aws<code class="w"> </code>ecs<code class="w"> </code>delete-cluster<code class="w"> </code>--cluster<code class="w"> </code>fargate-testing<code class="w"/>&#13;
<code class="go">…</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Wrap-Up" data-type="sect1"><div class="sect1" id="idm46803134276064">&#13;
<h1>Wrap-Up</h1>&#13;
&#13;
<p>In this chapter, we’ve certainly presented you with a lot of options! It’s unlikely that you’ll ever need to use all of these, since many of them overlap. However, each one has a unique perspective on exactly what a production system should look like and what problems are the most important to solve. After exploring all of these tools, you should have a pretty good idea of the wide range of options you can choose from to build your production Linux container environment.</p>&#13;
&#13;
<p>Underlying all of these tools is Docker’s highly portable image format for Linux containers and its ability to abstract away so much of the underlying Linux system, which makes it easy to move your applications fluidly between your data center and as many cloud providers as you want. Now you just have to choose which approach will work best for you and your organization and then implement it.</p>&#13;
&#13;
<p>In the meantime, let’s jump into the next chapter and explore some of the most technical topics in the Docker ecosystem, including security, networking, and storage.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="idm46803129919408"><sup><a href="ch10.html#idm46803129919408-marker">1</a></sup> Full URL: <a class="bare" href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_cannot_pull_image.html"><em class="hyperlink">https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_cannot_pull_image.html</em></a></p></div></div></section></body></html>