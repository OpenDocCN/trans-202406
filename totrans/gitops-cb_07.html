<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 6. Cloud Native CI/CD" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_Cloud_Native_CICD">
<h1><span class="label">Chapter 6. </span>Cloud Native CI/CD</h1>
<p>In the previous chapter you learned about Helm, a popular templating system for Kubernetes. All the recipes from previous chapters represent a common tooling for creating and managing containers for Kubernetes, and now it’s time to think about the automation on Kubernetes using such tools.
Let’s move our focus to the cloud native continuous integration/continuous deployment (CI/CD).</p>
<p>Continuous integration<a data-primary="CI (continuous integration)" data-type="indexterm" id="idm45120836254720"/><a data-primary="continuous integration (CI)" data-see="CI (continuous integration)" data-type="indexterm" id="idm45120836254112"/> is an automated process that takes new code created by a developer and builds, tests, and runs that code. The <a data-primary="cloud native CI" data-type="indexterm" id="idm45120836253008"/>cloud native CI refers to the model where cloud computing and cloud services are involved in this process. The benefits from this model are many, such as portable and reproducible workloads across clouds for highly scalable and on-demand use cases. And it also represents the building blocks for GitOps workflows as it enables automation through actions performed via Git.</p>
<p><a href="https://tekton.dev">Tekton</a> is a popular <a data-primary="Tekton" data-type="indexterm" id="Tek"/>open source implementation of a cloud native CI/CD system on top of Kubernetes. In fact, Tekton installs and runs as an extension on a Kubernetes cluster and comprises a set of Kubernetes Custom Resources that define the building blocks you can create and reuse for your pipelines.<sup><a data-type="noteref" href="ch06.xhtml#idm45120836250416" id="idm45120836250416-marker">1</a></sup> (See <a data-type="xref" href="#recipe_6_1">Recipe 6.1</a>.)</p>
<p>The Tekton engine lives inside a Kubernetes cluster and through its API objects represents a declarative way to define the actions to perform. The core components such as <em>Tasks</em> and <em>Pipelines</em> can be used to create a pipeline to generate artifacts and/or containers from a Git repository (see Recipes <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_6_2">6.2</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_6_3">6.3</a>, and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_6_4">6.4</a>).</p>
<p>Tekton also supports a mechanism for automating the start of a Pipeline with <em>Triggers</em>. These allow you to detect and extract information from events from a variety of sources, such as a webhook, and to start Tasks or Pipelines accordingly (see <a data-type="xref" href="#recipe_6_8">Recipe 6.8</a>).</p>
<p>Working with private Git repositories is a common use case that Tekton supports nicely (see <a data-type="xref" href="#recipe_6_4">Recipe 6.4</a>), and building artifacts and creating containers can be done in many ways such as with Buildah (see <a data-type="xref" href="#recipe_6_5">Recipe 6.5</a>) or Shipwright, which we discussed in <a data-type="xref" href="ch03.xhtml#ch_Containers">Chapter 3</a>. It is also possible to integrate Kustomize (see <a data-type="xref" href="#rec_Kustomize">Recipe 6.9</a>) and Helm (see <a data-type="xref" href="#rec_Helm">Recipe 6.10</a>) in order to make the CI part dynamic and take benefit of the rich ecosystem of Kubernetes tools.</p>
<p>Tekton is Kubernetes-native solution, thus it’s universal; however, it’s not the only cloud native CI/CD citizen in the market. Other good examples for GitOps-ready workloads are Drone (<a data-type="xref" href="#rec_Drone">Recipe 6.11</a>) and GitHub <a data-primary="Tekton" data-startref="Tek" data-type="indexterm" id="idm45120836236272"/>Actions (<a data-type="xref" href="#rec_GitHub_Actions">Recipe 6.12</a>).</p>
<section data-pdf-bookmark="6.1 Install Tekton" data-type="sect1"><div class="sect1" id="recipe_6_1">
<h1>6.1 Install Tekton</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120836232752">
<h2>Problem</h2>
<p>You want to install Tekton <a data-primary="Tekton" data-secondary="installing" data-type="indexterm" id="Tek_install"/>in order to have cloud native CI/CD on your Kubernetes cluster.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120836229760">
<h2>Solution</h2>
<p><a href="https://tekton.dev">Tekton</a> is a Kubernetes-native CI/CD solution that can be installed on top of any Kubernetes cluster. The installation brings you a set of <a href="https://oreil.ly/mv0cl">Kubernetes Custom Resources (CRDs)</a> that <a data-primary="CRDs (Kubernetes Custom Resources)" data-type="indexterm" id="idm45120836225744"/><a data-primary="Tekton" data-secondary="CRDs (Kubernetes Custom Resources)" data-type="indexterm" id="idm45120836225072"/><a data-primary="Pipelines (Tekton)" data-type="indexterm" id="pipel_Tek"/><a data-primary="Tekton" data-secondary="Pipelines" data-type="indexterm" id="Tek_pipe"/>you can use to compose your Pipelines, as shown in <a data-type="xref" href="#fig6-1">Figure 6-1</a>:</p>
<dl>
<dt>Task</dt>
<dd>
<p>A reusable, loosely coupled number of steps that perform a specific function (e.g., building a container image). Tasks get executed as Kubernetes pods, while steps in a Task map onto containers.</p>
</dd>
<dt>Pipeline</dt>
<dd>
<p>A list Tasks needed to build and/or deploy your apps.</p>
</dd>
<dt>TaskRun</dt>
<dd>
<p>The execution and result of running an instance of a Task.</p>
</dd>
<dt>PipelineRun</dt>
<dd>
<p>The execution and result of running an instance of a Pipeline, which includes a number of TaskRuns.</p>
</dd>
<dt>Trigger</dt>
<dd>
<p>Detects an event and connects to other CRDs to specify what happens when such an event occurs.</p>
</dd>
</dl>
<figure><div class="figure" id="fig6-1">
<img alt="Tekton Pipelines" height="1255" src="assets/gocb_0601.png" width="1432"/>
<h6><span class="label">Figure 6-1. </span>Tekton Pipelines</h6>
</div></figure>
<p>To <a data-primary="Pipelines (Tekton)" data-startref="pipel_Tek" data-type="indexterm" id="idm45120836211424"/><a data-primary="Tekton" data-secondary="Pipelines" data-startref="Tek_pipe" data-type="indexterm" id="idm45120836210416"/>install Tekton, you just need <code>kubectl</code> CLI and a Kubernetes cluster<a data-primary="kubectl" data-secondary="Tekton, installing" data-type="indexterm" id="idm45120836208688"/> such as Minikube (see <a data-type="xref" href="ch02.xhtml#ch_Requirements">Chapter 2</a>).</p>
<p>Tekton has a modular structure. You can<a data-primary="Tekton" data-secondary="modules" data-type="indexterm" id="idm45120836206336"/> install all components separately or all at once (e.g., with an Operator):</p>
<dl>
<dt>Tekton Pipelines</dt>
<dd>
<p>Contains Tasks and Pipelines</p>
</dd>
<dt>Tekton Triggers</dt>
<dd>
<p>Contains Triggers and EventListeners</p>
</dd>
<dt>Tekton Dashboard</dt>
<dd>
<p>A convenient dashboard to visualize Pipelines and logs</p>
</dd>
<dt>Tekton CLI</dt>
<dd>
<p>A CLI to manage Tekton objects (start/stop Pipelines and Tasks, check logs)</p>
</dd>
</dl>
<div data-type="tip"><h6>Tip</h6>
<p>You can also use a <a data-primary="Kubernetes Operators" data-secondary="installing Tekton components" data-type="indexterm" id="idm45120836198400"/>Kubernetes Operator to install and manage Tekton components on your cluster. See more details on how from <a href="https://oreil.ly/6UoU3">OperatorHub</a>.</p>
</div>
<p>First you need to install the <a href="https://oreil.ly/o0L2V">Tekton Pipelines</a> component. At the<a data-primary="Tekton Pipelines component" data-type="indexterm" id="idm45120836195152"/> time of writing this book, we are using version 0.37.0:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply <code class="se">\</code>
-f https://storage.googleapis.com/tekton-releases/pipeline/previous/v0.37.0/release.yaml</pre>
<p>The installation will create a new Kubernetes namespace <a data-primary="namespaces" data-secondary="tekton-pipelines" data-type="indexterm" id="tekton_pipelines"/>called <code>tekton-pipelines</code> and you should see output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">namespace/tekton-pipelines created
podsecuritypolicy.policy/tekton-pipelines created
clusterrole.rbac.authorization.k8s.io/tekton-pipelines-controller-cluster-access created
clusterrole.rbac.authorization.k8s.io/tekton-pipelines-controller-tenant-access created
clusterrole.rbac.authorization.k8s.io/tekton-pipelines-webhook-cluster-access created
role.rbac.authorization.k8s.io/tekton-pipelines-controller created
role.rbac.authorization.k8s.io/tekton-pipelines-webhook created
role.rbac.authorization.k8s.io/tekton-pipelines-leader-election created
role.rbac.authorization.k8s.io/tekton-pipelines-info created
serviceaccount/tekton-pipelines-controller created
serviceaccount/tekton-pipelines-webhook created
clusterrolebinding.rbac.authorization.k8s.io/tekton-pipelines-controller-cluster-access created
clusterrolebinding.rbac.authorization.k8s.io/tekton-pipelines-controller-tenant-access created
clusterrolebinding.rbac.authorization.k8s.io/tekton-pipelines-webhook-cluster-access created
rolebinding.rbac.authorization.k8s.io/tekton-pipelines-controller created
rolebinding.rbac.authorization.k8s.io/tekton-pipelines-webhook created
rolebinding.rbac.authorization.k8s.io/tekton-pipelines-controller-leaderelection created
rolebinding.rbac.authorization.k8s.io/tekton-pipelines-webhook-leaderelection created
rolebinding.rbac.authorization.k8s.io/tekton-pipelines-info created
customresourcedefinition.apiextensions.k8s.io/clustertasks.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/pipelines.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/pipelineruns.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/resolutionrequests.resolution.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/pipelineresources.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/runs.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/tasks.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/taskruns.tekton.dev created
secret/webhook-certs created
validatingwebhookconfiguration.admissionregistration.k8s.io/validation.webhook.pipeline.tekton.dev created
mutatingwebhookconfiguration.admissionregistration.k8s.io/webhook.pipeline.tekton.dev created
validatingwebhookconfiguration.admissionregistration.k8s.io/config.webhook.pipeline.tekton.dev created
clusterrole.rbac.authorization.k8s.io/tekton-aggregate-edit created
clusterrole.rbac.authorization.k8s.io/tekton-aggregate-view created
configmap/config-artifact-bucket created
configmap/config-artifact-pvc created
configmap/config-defaults created
configmap/feature-flags created
configmap/pipelines-info created
configmap/config-leader-election created
configmap/config-logging created
configmap/config-observability created
configmap/config-registry-cert created
deployment.apps/tekton-pipelines-controller created
service/tekton-pipelines-controller created
horizontalpodautoscaler.autoscaling/tekton-pipelines-webhook created
deployment.apps/tekton-pipelines-webhook created
service/tekton-pipelines-webhook created</pre>
<p>You <a data-primary="namespaces" data-secondary="tekton-pipelines" data-startref="tekton_pipelines" data-type="indexterm" id="idm45120836158224"/>can monitor and verify the installation with the <a data-primary="Tekton" data-secondary="pods" data-type="indexterm" id="Tek_pods"/>following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods -w -n tekton-pipelines</pre>
<p>You should see output like this:</p>
<pre data-code-language="bash" data-type="programlisting">NAME                                           READY   STATUS    RESTARTS   AGE
tekton-pipelines-controller-5fd68749f5-tz8dv   <code class="m">1</code>/1     Running   <code class="m">0</code>          3m4s
tekton-pipelines-webhook-58dcdbfd9b-hswpk      <code class="m">1</code>/1     Running   <code class="m">0</code>          3m4s</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The preceding command goes in watch mode, thus it remains appended. Press Ctrl+C in order to stop it when you see the controller and webhook pods in Running status.</p>
</div>
<p>Then you can <a data-primary="Tekton Triggers component" data-secondary="installing" data-type="indexterm" id="tekTriggers_install"/>install <a href="https://oreil.ly/Vq32h">Tekton Triggers</a>. At the time of writing this book, we are using version 0.20.1:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply <code class="se">\</code>
-f https://storage.googleapis.com/tekton-releases/triggers/previous/v0.20.1/release.yaml</pre>
<p>You should see the following output:</p>
<pre data-code-language="bash" data-type="programlisting">podsecuritypolicy.policy/tekton-triggers created
clusterrole.rbac.authorization.k8s.io/tekton-triggers-admin created
clusterrole.rbac.authorization.k8s.io/tekton-triggers-core-interceptors created
clusterrole.rbac.authorization.k8s.io/tekton-triggers-core-interceptors-secrets created
clusterrole.rbac.authorization.k8s.io/tekton-triggers-eventlistener-roles created
clusterrole.rbac.authorization.k8s.io/tekton-triggers-eventlistener-clusterroles created
role.rbac.authorization.k8s.io/tekton-triggers-admin created
role.rbac.authorization.k8s.io/tekton-triggers-admin-webhook created
role.rbac.authorization.k8s.io/tekton-triggers-core-interceptors created
role.rbac.authorization.k8s.io/tekton-triggers-info created
serviceaccount/tekton-triggers-controller created
serviceaccount/tekton-triggers-webhook created
serviceaccount/tekton-triggers-core-interceptors created
clusterrolebinding.rbac.authorization.k8s.io/tekton-triggers-controller-admin created
clusterrolebinding.rbac.authorization.k8s.io/tekton-triggers-webhook-admin created
clusterrolebinding.rbac.authorization.k8s.io/tekton-triggers-core-interceptors created
clusterrolebinding.rbac.authorization.k8s.io/tekton-triggers-core-interceptors-secrets created
rolebinding.rbac.authorization.k8s.io/tekton-triggers-controller-admin created
rolebinding.rbac.authorization.k8s.io/tekton-triggers-webhook-admin created
rolebinding.rbac.authorization.k8s.io/tekton-triggers-core-interceptors created
rolebinding.rbac.authorization.k8s.io/tekton-triggers-info created
customresourcedefinition.apiextensions.k8s.io/clusterinterceptors.triggers.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/clustertriggerbindings.triggers.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/eventlisteners.triggers.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/triggers.triggers.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/triggerbindings.triggers.tekton.dev created
customresourcedefinition.apiextensions.k8s.io/triggertemplates.triggers.tekton.dev created
secret/triggers-webhook-certs created
validatingwebhookconfiguration.admissionregistration.k8s.io/validation.webhook.triggers.tekton.dev created
mutatingwebhookconfiguration.admissionregistration.k8s.io/webhook.triggers.tekton.dev created
validatingwebhookconfiguration.admissionregistration.k8s.io/config.webhook.triggers.tekton.dev created
clusterrole.rbac.authorization.k8s.io/tekton-triggers-aggregate-edit created
clusterrole.rbac.authorization.k8s.io/tekton-triggers-aggregate-view created
configmap/config-defaults-triggers created
configmap/feature-flags-triggers created
configmap/triggers-info created
configmap/config-logging-triggers created
configmap/config-observability-triggers created
service/tekton-triggers-controller created
deployment.apps/tekton-triggers-controller created
service/tekton-triggers-webhook created
deployment.apps/tekton-triggers-webhook created
deployment.apps/tekton-triggers-core-interceptors created
service/tekton-triggers-core-interceptors created
clusterinterceptor.triggers.tekton.dev/cel created
clusterinterceptor.triggers.tekton.dev/bitbucket created
clusterinterceptor.triggers.tekton.dev/github created
clusterinterceptor.triggers.tekton.dev/gitlab created
secret/tekton-triggers-core-interceptors-certs created</pre>
<p>You can monitor <a data-primary="Tekton Triggers component" data-secondary="installing" data-startref="tekTriggers_install" data-type="indexterm" id="idm45120836082080"/>and verify the installation with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods -w -n tekton-pipelines</pre>
<p>You should see three new pods created and running—<code>tekton-triggers-controller</code>, <code>tekton-triggers-core-interceptors</code>, and <code>tekton-triggers-webhook</code>:</p>
<pre data-code-language="bash" data-type="programlisting">NAME                                                 READY   STATUS    RESTARTS   AGE
tekton-pipelines-controller-5fd68749f5-tz8dv         <code class="m">1</code>/1     Running   <code class="m">0</code>          27m
tekton-pipelines-webhook-58dcdbfd9b-hswpk            <code class="m">1</code>/1     Running   <code class="m">0</code>          27m
tekton-triggers-controller-854d44fd5d-8jf9q          <code class="m">1</code>/1     Running   <code class="m">0</code>          105s
tekton-triggers-core-interceptors-5454f8785f-dhsrb   <code class="m">1</code>/1     Running   <code class="m">0</code>          104s
tekton-triggers-webhook-86d75f875-zmjf4              <code class="m">1</code>/1     Running   <code class="m">0</code>          105s</pre>
<p>After this you have <a data-primary="Tekton" data-secondary="pods" data-startref="Tek_pods" data-type="indexterm" id="idm45120836051680"/>a fully working Tekton installation on top of your Kubernetes cluster, supporting Pipelines and automation via event Triggers. In addition to that, <a data-primary="Tekton Dashboard component" data-secondary="installing" data-type="indexterm" id="TekDash_install"/>you could install the <a href="https://oreil.ly/Db56q">Tekton Dashboard</a> in order to visualize Tasks, Pipelines, and logs via a nice UI. At the time of writing this book, we are using version 0.28.0:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply <code class="se">\</code>
-f https://storage.googleapis.com/tekton-releases/dashboard/previous/v0.28.0/tekton-dashboard-release.yaml</pre>
<p>You should have output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">customresourcedefinition.apiextensions.k8s.io/extensions.dashboard.tekton.dev created
serviceaccount/tekton-dashboard created
role.rbac.authorization.k8s.io/tekton-dashboard-info created
clusterrole.rbac.authorization.k8s.io/tekton-dashboard-backend created
clusterrole.rbac.authorization.k8s.io/tekton-dashboard-tenant created
rolebinding.rbac.authorization.k8s.io/tekton-dashboard-info created
clusterrolebinding.rbac.authorization.k8s.io/tekton-dashboard-backend created
configmap/dashboard-info created
service/tekton-dashboard created
deployment.apps/tekton-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/tekton-dashboard-tenant created</pre>
<p>You can monitor and verify the<a data-primary="Tekton Dashboard component" data-secondary="installing" data-startref="TekDash_install" data-type="indexterm" id="idm45120836000208"/> installation with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods -w -n tekton-pipelines</pre>
<p>You should see a new pod created and running—<code>tekton-dashboard</code>:</p>
<pre data-code-language="bash" data-type="programlisting">NAME                                                READY STATUS   RESTARTS        AGE
tekton-dashboard-786b6b5579-sscgz                   <code class="m">1</code>/1   Running  <code class="m">0</code>               2m25s
tekton-pipelines-controller-5fd68749f5-tz8dv        <code class="m">1</code>/1   Running  <code class="m">1</code> <code class="o">(</code>7m16s ago<code class="o">)</code>   5d7h
tekton-pipelines-webhook-58dcdbfd9b-hswpk           <code class="m">1</code>/1   Running  <code class="m">1</code> <code class="o">(</code>7m6s ago<code class="o">)</code>    5d7h
tekton-triggers-controller-854d44fd5d-8jf9q         <code class="m">1</code>/1   Running  <code class="m">2</code> <code class="o">(</code>7m9s ago<code class="o">)</code>    5d7h
tekton-triggers-core-interceptors-5454f8785f-dhsrb  <code class="m">1</code>/1   Running  <code class="m">1</code> <code class="o">(</code>7m7s ago<code class="o">)</code>    5d7h
tekton-triggers-webhook-86d75f875-zmjf4             <code class="m">1</code>/1   Running  <code class="m">2</code> <code class="o">(</code>7m9s ago<code class="o">)</code>    5d7h</pre>
<p>By default, the <a data-primary="Tekton Dashboard component" data-secondary="accessing" data-type="indexterm" id="idm45120835925408"/>Dashboard is not exposed outside the Kubernetes cluster. You can access it by using the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl port-forward svc/tekton-dashboard <code class="m">9097</code>:9097 -n tekton-pipelines</pre>
<div data-type="tip"><h6>Tip</h6>
<p>There are several ways to expose internal services in Kubernetes; you could also create an <a href="https://oreil.ly/wwWcX">Ingress</a> for that as shown in the Tekton Dashboard <a href="https://oreil.ly/BeOlq">documentation</a>.</p>
</div>
<p>You can now browse to <em>http://localhost:9097</em> to access your Dashboard, as shown in <a data-type="xref" href="#fig6-2">Figure 6-2</a>.</p>
<p>You can download and install the <a href="https://oreil.ly/U7FSt">Tekton CLI</a> for your OS to start creating Tasks and Pipelines from the command line. At the time of writing this book, we are using version 0.25.0.</p>
<figure><div class="figure" id="fig6-2">
<img alt="Tekton Dashboard" height="909" src="assets/gocb_0602.png" width="1903"/>
<h6><span class="label">Figure 6-2. </span>Tekton Dashboard</h6>
</div></figure>
<p>Finally, verify <a data-primary="Tekton" data-secondary="configuration, verifying" data-type="indexterm" id="idm45120835862352"/>that <code>tkn</code> and Tekton are configured correctly:</p>
<pre data-code-language="bash" data-type="programlisting">tkn version</pre>
<p>You should get the following <a data-primary="Tekton" data-secondary="installing" data-startref="Tek_install" data-type="indexterm" id="idm45120835859120"/>output:</p>
<pre data-code-language="bash" data-type="programlisting">Client version: <code class="m">0</code>.25.0
Pipeline version: v0.37.0
Triggers version: v0.20.1
Dashboard version: v0.28.0</pre>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120835838592">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/7I7ev">Tekton Getting Started</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="6.2 Create a Hello World Task" data-type="sect1"><div class="sect1" id="recipe_6_2">
<h1>6.2 Create a Hello World Task</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120835832448">
<h2>Problem</h2>
<p>You want to start using Tekton <a data-primary="Tekton" data-secondary="Tasks" data-tertiary="creating" data-type="indexterm" id="Tek_Task_creat"/><a data-primary="Tasks (Tekton)" data-secondary="creating" data-type="indexterm" id="TekTask_creat"/>by exploring Tasks and creating a sample one.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120835807744">
<h2>Solution</h2>
<p>In Tekton, a Task defines a series of steps that run sequentially to perform logic that the Task requires. Every <a href="https://oreil.ly/5ldpn">Task</a> runs as a pod on your Kubernetes cluster, with each step running in its own container. While steps within a Task are sequential, Tasks can be executed inside a Pipeline in parallel. Therefore, Tasks <a data-primary="Pipelines (Tekton)" data-secondary="Tekton Tasks" data-type="indexterm" id="idm45120835805232"/>are the building blocks for running Pipelines with Tekton.</p>
<p>Let’s create a Hello World Task:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Task</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO1-1" id="co_cloud_native_ci_cd_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">hello</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO1-2" id="co_cloud_native_ci_cd_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">steps</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO1-3" id="co_cloud_native_ci_cd_CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">say-hello</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO1-4" id="co_cloud_native_ci_cd_CO1-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">registry.access.redhat.com/ubi8/ubi</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO1-5" id="co_cloud_native_ci_cd_CO1-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">command</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">/bin/bash</code><code class="w">
</code><code class="w">      </code><code class="nt">args</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="s">'</code><code class="s">-c</code><code class="s">'</code><code class="p-Indicator">,</code><code class="w"> </code><code class="s">'</code><code class="s">echo</code><code class="nv"> </code><code class="s">Hello</code><code class="nv"> </code><code class="s">GitOps</code><code class="nv"> </code><code class="s">Cookbook</code><code class="nv"> </code><code class="s">reader!</code><code class="s">'</code><code class="p-Indicator">]</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO1-1" id="callout_cloud_native_ci_cd_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>The API as an object of kind <code>Task</code></p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO1-2" id="callout_cloud_native_ci_cd_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>The name of the Task</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO1-3" id="callout_cloud_native_ci_cd_CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>The list of steps contained within this Task, in this case just one</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO1-4" id="callout_cloud_native_ci_cd_CO1-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>The name of the step</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO1-5" id="callout_cloud_native_ci_cd_CO1-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>The container image where the step starts</p></dd>
</dl>
<p>First you need to create this resource in Kubernetes:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f helloworld-task.yaml</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">task.tekton.dev/hello created</pre>
<p>You can verify that the object has been created in your current Kubernetes 
<span class="keep-together">namespace</span>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get tasks</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">NAME    AGE
hello   90s</pre>
<p>Now you can start your Tekton Task with <code>tkn</code> CLI:</p>
<pre data-code-language="bash" data-type="programlisting">tkn task start --showlog hello</pre>
<p>You should get output similar to the <a data-primary="Tekton" data-secondary="Tasks" data-startref="Tek_Task_creat" data-tertiary="creating" data-type="indexterm" id="idm45120835619792"/><a data-primary="Tasks (Tekton)" data-secondary="creating" data-startref="TekTask_creat" data-type="indexterm" id="idm45120835584208"/>following:</p>
<pre data-code-language="bash" data-type="programlisting">TaskRun started: hello-run-8bmzz
Waiting <code class="k">for</code> logs to be available...
<code class="o">[</code>say-hello<code class="o">]</code> Hello World</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>A TaskRun <a data-primary="TaskRun objects" data-type="indexterm" id="idm45120835651088"/>is the API representation of a running Task. See <a data-type="xref" href="#recipe_6_3">Recipe 6.3</a> for more details.</p>
</div>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120835807152">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/5ldpn">Tekton Task documentation</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="6.3 Create a Task to Compile and Package an App from Git" data-type="sect1"><div class="sect1" id="recipe_6_3">
<h1>6.3 Create a Task to Compile and Package an App from Git</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120835549520">
<h2>Problem</h2>
<p>You want to automate <a data-primary="Tekton" data-secondary="applications" data-tertiary="compiling" data-type="indexterm" id="Tek_app_compil"/><a data-primary="Tekton" data-secondary="applications" data-tertiary="packaging" data-type="indexterm" id="Tek_app_packag"/><a data-primary="applications" data-secondary="compiling" data-type="indexterm" id="app_compil"/><a data-primary="applications" data-secondary="packaging" data-type="indexterm" id="app_pack"/>compiling and packaging an app from Git on Kubernetes with Tekton.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120835542336">
<h2>Solution</h2>
<p>As seen in <a data-type="xref" href="#recipe_6_2">Recipe 6.2</a>, Tekton Tasks have a flexible mechanism to add a list of sequential steps to automate actions. The idea is to create a list of Tasks with a chain of input/output that can be used to compose Pipelines. Therefore a Task can contain a series of optional<a data-primary="Tekton" data-secondary="fields" data-type="indexterm" id="Tek_fields"/> fields for a better control over the resource:</p>
<dl>
<dt><code>inputs</code></dt>
<dd>
<p>The resources ingested by the Task.</p>
</dd>
<dt><code>outputs</code></dt>
<dd>
<p>The resources produced by the Task.</p>
</dd>
<dt><code>params</code></dt>
<dd>
<p>The parameters that will be used in the Task steps. Each parameter has:</p>
<dl>
<dt><code>name</code></dt>
<dd>
<p>The name of the parameter.</p>
</dd>
<dt><code>description</code></dt>
<dd>
<p>The description of the parameter.</p>
</dd>
<dt><code>default</code></dt>
<dd>
<p>The default value of the parameter.</p>
</dd>
<dt><code>results</code></dt>
<dd>
<p>The names under which Tasks write execution results.</p>
</dd>
<dt><code>workspaces</code></dt>
<dd>
<p>The paths to volumes needed by the Task.</p>
</dd>
<dt><code>volumes</code></dt>
<dd>
<p>The Task can also mount external volumes using the <code>volumes</code> attribute.</p>
</dd>
</dl>
</dd>
</dl>
<p>The following <a data-primary="Tekton" data-secondary="fields" data-startref="Tek_fields" data-type="indexterm" id="idm45120835507056"/>example, as illustrated in <a data-type="xref" href="#fig6-3">Figure 6-3</a>, shows a Task <a data-primary="Tasks (Tekton)" data-secondary="build-app" data-type="indexterm" id="Task_buildapp"/><a data-primary="Tekton" data-secondary="Tasks" data-tertiary="build-app" data-type="indexterm" id="Tek_Task_buildapp"/>named <code>build-app</code> that clones the sources using the <code>git</code> command and lists the source code in output.</p>
<figure><div class="figure" id="fig6-3">
<img alt="Build App Task" height="245" src="assets/gocb_0603.png" width="845"/>
<h6><span class="label">Figure 6-3. </span><code>build-app</code> Task</h6>
</div></figure>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Task</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-app</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">workspaces</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO2-1" id="co_cloud_native_ci_cd_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">source</code><code class="w">
</code><code class="w">      </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">The</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">git</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">repo</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">will</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">be</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">cloned</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">onto</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">volume</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">backing</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">this</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">workspace</code><code class="w">
</code><code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO2-2" id="co_cloud_native_ci_cd_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">contextDir</code><code class="w">
</code><code class="w">      </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">context</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">dir</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">within</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">source</code><code class="w">
</code><code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quarkus</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tlsVerify</code><code class="w">
</code><code class="w">      </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tls</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">verify</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">false</code><code class="s">"</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">url</code><code class="w">
</code><code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/tekton-tutorial-greeter.git</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">revision</code><code class="w">
</code><code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">master</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">subdirectory</code><code class="w">
</code><code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">"</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">sslVerify</code><code class="w">
</code><code class="w">      </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">defines</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">if</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">http.sslVerify</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">should</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">be</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">set</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">to</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">true</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">or</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">false</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">in</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">the</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">global</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">git</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">config</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">false</code><code class="s">"</code><code class="w">
</code><code class="w">  </code><code class="nt">steps</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:v0.21.0</code><code class="s">'</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">clone</code><code class="w">
</code><code class="w">      </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">      </code><code class="nt">script</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w">
</code><code class="w">        </code><code class="no">CHECKOUT_DIR="$(workspaces.source.path)/$(params.subdirectory)"</code><code class="w">
</code><code class="w">        </code><code class="no">cleandir() {</code><code class="w">
</code><code class="w">          </code><code class="no"># Delete any existing contents of the repo directory if it exists.</code><code class="w">
</code><code class="w">          </code><code class="no">#</code><code class="w">
</code><code class="w">          </code><code class="no"># We don't just "rm -rf $CHECKOUT_DIR" because $CHECKOUT_DIR might be "/"</code><code class="w">
</code><code class="w">          </code><code class="no"># or the root of a mounted volume.</code><code class="w">
</code><code class="w">          </code><code class="no">if [[ -d "$CHECKOUT_DIR" ]] ; then</code><code class="w">
</code><code class="w">            </code><code class="no"># Delete non-hidden files and directories</code><code class="w">
</code><code class="w">            </code><code class="no">rm -rf "$CHECKOUT_DIR"/*</code><code class="w">
</code><code class="w">            </code><code class="no"># Delete files and directories starting with . but excluding ..</code><code class="w">
</code><code class="w">            </code><code class="no">rm -rf "$CHECKOUT_DIR"/.[!.]*</code><code class="w">
</code><code class="w">            </code><code class="no"># Delete files and directories starting with .. plus any other character</code><code class="w">
</code><code class="w">            </code><code class="no">rm -rf "$CHECKOUT_DIR"/..?*</code><code class="w">
</code><code class="w">          </code><code class="no">fi</code><code class="w">
</code><code class="w">        </code><code class="no">}</code><code class="w">
</code><code class="w">        </code><code class="no">/ko-app/git-init \</code><code class="w">
</code><code class="w">          </code><code class="no">-url "$(params.url)" \</code><code class="w">
</code><code class="w">          </code><code class="no">-revision "$(params.revision)" \</code><code class="w">
</code><code class="w">          </code><code class="no">-path "$CHECKOUT_DIR" \</code><code class="w">
</code><code class="w">          </code><code class="no">-sslVerify="$(params.sslVerify)"</code><code class="w">
</code><code class="w">        </code><code class="no">cd "$CHECKOUT_DIR"</code><code class="w">
</code><code class="w">        </code><code class="no">RESULT_SHA="$(git rev-parse HEAD)"</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-sources</code><code class="w">
</code><code class="w">      </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gcr.io/cloud-builders/mvn</code><code class="w">
</code><code class="w">      </code><code class="nt">command</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">mvn</code><code class="w">
</code><code class="w">      </code><code class="nt">args</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">-DskipTests</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">clean</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">install</code><code class="w">
</code><code class="w">      </code><code class="nt">env</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">user.home</code><code class="w">
</code><code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/home/tekton</code><code class="w">
</code><code class="w">      </code><code class="nt">workingDir</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">/workspace/source/$(params.contextDir)</code><code class="s">"</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO2-1" id="callout_cloud_native_ci_cd_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>A Task step and Pipeline Task can share a common filesystem via a Tekton workspace. The workspace could be either backed by something like PersistentVolumeClaim (PVC) and a <code>ConfigMap</code>, or just ephemeral (<code>emptyDir</code>).</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO2-2" id="callout_cloud_native_ci_cd_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>A Task can have parameters; this feature makes<a data-primary="Tasks (Tekton)" data-secondary="build-app" data-startref="Task_buildapp" data-type="indexterm" id="idm45120835053392"/><a data-primary="Tekton" data-secondary="Tasks" data-startref="Tek_Task_buildapp" data-tertiary="build-app" data-type="indexterm" id="idm45120835052144"/> the execution dynamic.</p></dd>
</dl>
<p>Let’s<a data-primary="Tasks (Tekton)" data-secondary="build-app" data-tertiary="creating" data-type="indexterm" id="Task_buildapp_creat"/><a data-primary="Tekton" data-secondary="Tasks" data-tertiary="creating" data-type="indexterm" id="Tek_Tasks_creat"/> create the Task with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f build-app-task.yaml</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">task.tekton.dev/build-app created</pre>
<p>You can verify that the object has been created in your current Kubernetes 
<span class="keep-together">namespace</span>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get tasks</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">NAME        AGE
build-app   3s</pre>
<p>You can also list the Task with the <code>tkn</code> CLI:</p>
<pre data-code-language="bash" data-type="programlisting">tkn task ls</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">NAME        DESCRIPTION   AGE
build-app                 <code class="m">10</code> seconds ago</pre>
<p>When<a data-primary="Tasks (Tekton)" data-secondary="build-app" data-startref="Task_buildapp_creat" data-tertiary="creating" data-type="indexterm" id="idm45120834974432"/><a data-primary="Tekton" data-secondary="Tasks" data-startref="Tek_Tasks_creat" data-tertiary="creating" data-type="indexterm" id="idm45120834915104"/> you start a Task, a new <a href="https://oreil.ly/MZ5DY">TaskRun</a> object is<a data-primary="TaskRun objects" data-secondary="creating" data-type="indexterm" id="TaskR_creat"/> created. TaskRuns are the API representation of a running Task; thus you can create it with the <code>tkn</code> CLI using the following command:</p>
<pre data-code-language="bash" data-type="programlisting">tkn task start build-app <code class="se">\</code>
  --param <code class="nv">contextDir</code><code class="o">=</code><code class="s1">'quarkus'</code> <code class="se">\</code>
  --workspace <code class="nv">name</code><code class="o">=</code>source,emptyDir<code class="o">=</code><code class="s2">""</code> <code class="se">\</code>
  --showlog</pre>
<div data-type="tip"><h6>Tip</h6>
<p>When parameters are <a data-primary="Tasks (Tekton)" data-secondary="parameters" data-type="indexterm" id="idm45120835000592"/><a data-primary="Tekton" data-secondary="Tasks" data-tertiary="parameters" data-type="indexterm" id="idm45120834983488"/>used inside a Task or Pipeline, you will be prompted to add new values or confirm default ones, if any. In order to use the default values from the Task defintion without prompting for values, you can use the <code>--use-param-defaults</code> option.</p>
</div>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">? Value <code class="k">for</code> param <code class="sb">`</code>tlsVerify<code class="sb">`</code> of <code class="nb">type</code> <code class="sb">`</code>string<code class="sb">`</code>? <code class="o">(</code>Default is <code class="sb">`</code><code class="nb">false</code><code class="sb">`</code><code class="o">)</code> <code class="nb">false</code>
? Value <code class="k">for</code> param <code class="sb">`</code>url<code class="sb">`</code> of <code class="nb">type</code> <code class="sb">`</code>string<code class="sb">`</code>? <code class="o">(</code>Default is <code class="sb">`</code>https://github.com/gitops-cookbook/tekton-tutorial-greeter.git<code class="sb">`</code><code class="o">)</code> https://github.com/gitops-cookbook/tekton-tutorial-greeter.git
? Value <code class="k">for</code> param <code class="sb">`</code>revision<code class="sb">`</code> of <code class="nb">type</code> <code class="sb">`</code>string<code class="sb">`</code>? <code class="o">(</code>Default is <code class="sb">`</code>master<code class="sb">`</code><code class="o">)</code> master
? Value <code class="k">for</code> param <code class="sb">`</code>subdirectory<code class="sb">`</code> of <code class="nb">type</code> <code class="sb">`</code>string<code class="sb">`</code>? <code class="o">(</code>Default is <code class="sb">``</code><code class="o">)</code>
? Value <code class="k">for</code> param <code class="sb">`</code>sslVerify<code class="sb">`</code> of <code class="nb">type</code> <code class="sb">`</code>string<code class="sb">`</code>? <code class="o">(</code>Default is <code class="sb">`</code><code class="nb">false</code><code class="sb">`</code><code class="o">)</code> <code class="nb">false</code>
TaskRun started: build-app-run-rzcd8
Waiting <code class="k">for</code> logs to be available...
<code class="o">[</code>clone<code class="o">]</code> <code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1659278019.0018234,<code class="s2">"caller"</code>:<code class="s2">"git/git.go:169"</code>,<code class="s2">"msg"</code>:<code class="s2">"Successfully cloned https://github.com/gitops-cookbook/tekton-tutorial-greeter.git @ d9291c456db1ce29177b77ffeaa9b71ad80a50e6 (grafted, HEAD, origin/master) in path /workspace/source/"</code><code class="o">}</code>
<code class="o">[</code>clone<code class="o">]</code> <code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1659278019.0227938,<code class="s2">"caller"</code>:<code class="s2">"git/git.go:207"</code>,<code class="s2">"msg"</code>:<code class="s2">"Successfully initialized and updated submodules in path /workspace/source/"</code><code class="o">}</code>

<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Scanning <code class="k">for</code> projects...
<code class="o">[</code>build-sources<code class="o">]</code> Downloading from central: https://repo.maven.apache.org/maven2/io/quarkus/quarkus-universe-bom/1.6.1.Final/quarkus-universe-bom-1.6.1.Final.pom
Downloaded from central: https://repo.maven.apache.org/maven2/io/quarkus/quarkus-universe-bom/1.6.1.Final/quarkus-universe-bom-1.6.1.Final.pom <code class="o">(</code><code class="m">412</code> kB at <code class="m">118</code> kB/s<code class="o">)</code>
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code>
...
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Installing /workspace/source/quarkus/target/tekton-quarkus-greeter.jar to /root/.m2/repository/com/redhat/developers/tekton-quarkus-greeter/1.0.0-SNAPSHOT/tekton-quarkus-greeter-1.0.0-SNAPSHOT.jar
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Installing /workspace/source/quarkus/pom.xml to /root/.m2/repository/com/redhat/developers/tekton-quarkus-greeter/1.0.0-SNAPSHOT/tekton-quarkus-greeter-1.0.0-SNAPSHOT.pom
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> BUILD SUCCESS
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Total time:  <code class="m">04</code>:41 min
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Finished at: <code class="m">2022</code>-07-31T14:38:22Z
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------</pre>
<p>Or, you can create a <code>TaskRun</code> object manually like this:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TaskRun</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">generateName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-app-run-</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO3-1" id="co_cloud_native_ci_cd_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">app.kubernetes.io/managed-by</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-pipelines</code><code class="w">
</code><code class="w">    </code><code class="nt">tekton.dev/task</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-app</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">contextDir</code><code class="w">
</code><code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quarkus</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">revision</code><code class="w">
</code><code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">master</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">sslVerify</code><code class="w">
</code><code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">false</code><code class="s">"</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">subdirectory</code><code class="w">
</code><code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">"</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tlsVerify</code><code class="w">
</code><code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">false</code><code class="s">"</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">url</code><code class="w">
</code><code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/tekton-tutorial-greeter.git</code><code class="w">
</code><code class="w">  </code><code class="nt">taskRef</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO3-2" id="co_cloud_native_ci_cd_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Task</code><code class="w">
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-app</code><code class="w">
</code><code class="w">  </code><code class="nt">workspaces</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">emptyDir</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{</code><code class="p-Indicator">}</code><code class="w">
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">source</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO3-1" id="callout_cloud_native_ci_cd_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>If you don’t want to specify a name for each <code>TaskRun</code>, you can use the <code>generateName</code> attribute to let Tekton pick a random one from the string you defined.</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO3-2" id="callout_cloud_native_ci_cd_CO3-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Here you <a data-primary="TaskRun objects" data-secondary="creating" data-startref="TaskR_creat" data-type="indexterm" id="idm45120835189808"/>list the Task that the <code>TaskRun</code> is referring to.</p></dd>
</dl>
<p>And start it in this way:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f build-app-taskrun.yaml</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">taskrun.tekton.dev/build-app-run-65vmh created</pre>
<p>You can also verify it with the <code>tkn</code> CLI:</p>
<pre data-code-language="bash" data-type="programlisting">tkn taskrun ls</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">NAME                  STARTED          DURATION   STATUS
build-app-run-65vmh   <code class="m">1</code> minutes ago   2m37s      Succeeded
build-app-run-rzcd8   <code class="m">2</code> minutes ago   3m58s      Succeeded</pre>
<p>You can get the <a data-primary="TaskRun objects" data-secondary="logs" data-type="indexterm" id="TaskR_logs"/>logs from the <code>TaskRun</code> by specifying the name of<a data-primary="Tekton" data-secondary="applications" data-startref="Tek_app_compil" data-tertiary="compiling" data-type="indexterm" id="idm45120835184752"/><a data-primary="Tekton" data-secondary="applications" data-startref="Tek_app_packag" data-tertiary="packaging" data-type="indexterm" id="idm45120835183328"/><a data-primary="applications" data-secondary="compiling" data-startref="app_compil" data-type="indexterm" id="idm45120834414896"/><a data-primary="applications" data-secondary="packaging" data-startref="app_pack" data-type="indexterm" id="idm45120834413680"/> the <code>TaskRun</code>:</p>
<pre data-code-language="bash" data-type="programlisting">tkn taskrun logs build-app-run-65vmh -f</pre>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120834409008">
<h2>See Also</h2>
<p><a href="https://oreil.ly/PxRNG">Debugging a TaskRun</a></p>
</div></section>
</div></section>
<section data-pdf-bookmark="6.4 Create a Task to Compile and Package an App from Private Git" data-type="sect1"><div class="sect1" id="recipe_6_4">
<h1>6.4 Create a Task to Compile and Package an App from Private Git</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120834409968">
<h2>Problem</h2>
<p>You want to use a <a data-primary="Tekton" data-secondary="applications" data-tertiary="compiling from private repositories" data-type="indexterm" id="Tek_app_compilpriv"/><a data-primary="Tekton" data-secondary="applications" data-tertiary="packaging from private repositories" data-type="indexterm" id="Tek_app_packagpriv"/><a data-primary="repositories" data-secondary="private, compiling/packaging applications with Tekton" data-type="indexterm" id="repo_priv_appTek"/><a data-primary="applications" data-secondary="compiling" data-tertiary="from private repositories" data-tertiary-sortas="private repositories" data-type="indexterm" id="app_compil_privrepo"/><a data-primary="applications" data-secondary="packaging" data-tertiary="from private repositories" data-tertiary-sortas="private" data-type="indexterm" id="app_pack_privrepo"/>private Git repository to automate compiling and packaging of an app on Kubernetes with Tekton.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120834368256">
<h2>Solution</h2>
<p>In <a data-type="xref" href="#recipe_6_3">Recipe 6.3</a> you saw how to compile and package a sample Java application using a public Git repository, but most of the time people deal with private repos at work, so how do you integrate them? Tekton supports the following <a data-primary="Tekton" data-secondary="authentication schemes" data-type="indexterm" id="Tek_authschem"/><a data-primary="authentication" data-secondary="Tekton schemes" data-type="indexterm" id="auth_Tek"/>authentication schemes for use with Git:</p>
<ul>
<li>
<p>Basic-auth</p>
</li>
<li>
<p>SSH</p>
</li>
</ul>
<p>With both options you can use a <a data-primary="Kubernetes Secrets" data-secondary="Tekton" data-type="indexterm" id="idm45120834344224"/><a data-primary="Tekton" data-secondary="Kubernetes Secrets" data-type="indexterm" id="idm45120834343376"/>Kubernetes <a href="https://oreil.ly/Oxj6W">Secret</a> to store your credentials and attach them to the <a href="https://oreil.ly/6UC3O"><code>ServiceAccount</code></a> running your Tekton Tasks or Pipelines.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Tekton uses a <a data-primary="default service account, Tekton" data-type="indexterm" id="idm45120834340016"/><a data-primary="Tekton" data-secondary="default service account" data-type="indexterm" id="idm45120834339312"/>default service account, however you can override it following the documentation <a href="https://oreil.ly/ID6m0">here</a>.</p>
</div>
<p>Let’s start with a common example of basic authentication and a popular Git service such as GitHub.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>GitHub uses personal access tokens (PATs) as an alternative to using passwords for authentication. You can use a PAT instead of a clear-text password to enhance security.</p>
</div>
<p class="less_space pagebreak-before">First you need to create a <a data-primary="Tekton" data-secondary="Kubernetes Secrets" data-tertiary="creating" data-type="indexterm" id="K_sec_creat"/><a data-primary="Kubernetes Secrets" data-secondary="creating" data-type="indexterm" id="Tek_K_creatSec"/>Secret. You can do this by creating the following YAML file:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Secret</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">github-secret</code><code class="w">
</code><code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">tekton.dev/git-0</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO4-1" id="co_cloud_native_ci_cd_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kubernetes.io/basic-auth</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO4-2" id="co_cloud_native_ci_cd_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="nt">stringData</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">username</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">YOUR_USERNAME</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO4-3" id="co_cloud_native_ci_cd_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">password</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">YOUR_PASSWORD</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO4-4" id="co_cloud_native_ci_cd_CO4-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO4-1" id="callout_cloud_native_ci_cd_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Here you specify the URL for which Tekton will use this Secret, in this case GitHub</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO4-2" id="callout_cloud_native_ci_cd_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>This is the type of Secret, in this case a basic authentication one</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO4-3" id="callout_cloud_native_ci_cd_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Your Git user, in this case your GitHub user</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO4-4" id="callout_cloud_native_ci_cd_CO4-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>You Git password, in this case your GitHub personal access token</p></dd>
</dl>
<p>You can now create the Secret with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f git-secret.yaml</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">secret/git-secret created</pre>
<p>You can also avoid writing YAML and do everything with <code>kubectl</code> as follows:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create secret generic git-secret <code class="se">\</code>
    --type<code class="o">=</code>kubernetes.io/basic-auth <code class="se">\</code>
    --from-literal<code class="o">=</code><code class="nv">username</code><code class="o">=</code>YOUR_USERNAME <code class="se">\</code>
    --from-literal<code class="o">=</code><code class="nv">password</code><code class="o">=</code>YOUR_PASSWORD</pre>
<p>And then you just annotate the Secret as follows:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl annotate secret git-secret <code class="s2">"tekton.dev/git-0=https://github.com"</code></pre>
<p>Once <a data-primary="Tekton" data-secondary="Kubernetes Secrets" data-startref="K_sec_creat" data-tertiary="creating" data-type="indexterm" id="idm45120834175760"/><a data-primary="Kubernetes Secrets" data-secondary="creating" data-startref="Tek_K_creatSec" data-type="indexterm" id="idm45120834152032"/>you have created and annotated your Secret, you have to attach it to the <a data-primary="Tekton" data-secondary="ServiceAccounts" data-type="indexterm" id="Tek_ServAcct"/><a data-primary="ServiceAccounts" data-secondary="Tekton" data-type="indexterm" id="ServAcct_Tek"/><code>ServiceAccount</code> running your Tekton Tasks or Pipelines.</p>
<p>Let’s create a new <code>ServiceAccount</code> for this purpose:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ServiceAccount</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-bot-sa</code><code class="w">
</code><code class="nt">secrets</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-secret</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO5-1" id="co_cloud_native_ci_cd_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO5-1" id="callout_cloud_native_ci_cd_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>List of Secrets attached to this <code>ServiceAccount</code></p></dd>
</dl>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f tekton-bot-sa.yaml</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">serviceaccount/tekton-bot-sa created</pre>
<div data-type="tip"><h6>Tip</h6>
<p>You can create the <code>ServiceAccount</code> directly with <code>kubectl</code> as 
<span class="keep-together">follows</span>:</p>
<pre data-type="programlisting">kubectl create serviceaccount tekton-bot-sa</pre>
<p>and then patch it to add the secret reference:</p>
<pre data-type="programlisting">kubectl patch serviceaccount tekton-bot-sa -p '{"secrets": [{"name": "git-secret"}]}'</pre>
</div>
<p>Once credentials are set up and linked to the <code>ServiceAccount</code> running Tasks or Pipelines, you can just add the <code>--serviceaccount=&lt;NAME&gt;</code> option to your <code>tkn</code> command, using the <a data-type="xref" href="#recipe_6_3">Recipe 6.3</a> example:</p>
<pre data-code-language="bash" data-type="programlisting"><code>tkn</code><code> </code><code>task</code><code> </code><code>start</code><code> </code><code>build-app</code><code> </code><code class="se">\
</code><code>  </code><code>--serviceaccount</code><code class="o">=</code><code class="s1">'tekton-bot-sa'</code><code> </code><code class="se">\ </code><a class="co" href="#callout_cloud_native_ci_cd_CO6-1" id="co_cloud_native_ci_cd_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
  </code><code>--param</code><code> </code><code class="nv">url</code><code class="o">=</code><code class="s1">'https://github.com/gitops-cookbook/tekton-greeter-private.git'</code><code> </code><code class="se">\ </code><a class="co" href="#callout_cloud_native_ci_cd_CO6-2" id="co_cloud_native_ci_cd_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code>
  </code><code>--param</code><code> </code><code class="nv">contextDir</code><code class="o">=</code><code class="s1">'quarkus'</code><code> </code><code class="se">\
</code><code>  </code><code>--workspace</code><code> </code><code class="nv">name</code><code class="o">=</code><code>source,emptyDir</code><code class="o">=</code><code class="s2">""</code><code> </code><code class="se">\
</code><code>  </code><code>--showlog</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO6-1" id="callout_cloud_native_ci_cd_CO6-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Here you specify the <code>ServiceAccount</code> to use; this will override the default one at runtime.</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO6-2" id="callout_cloud_native_ci_cd_CO6-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Here you can override the default repository with one of your choice. In this example there’s a private repository that you cannot access, but you can create a private repository on your own and test it like this.</p></dd>
</dl>
<p>You should get output similar to the <a data-primary="Tekton" data-secondary="ServiceAccounts" data-startref="Tek_ServAcct" data-type="indexterm" id="idm45120833997664"/><a data-primary="ServiceAccounts" data-secondary="Tekton" data-startref="ServAcct_Tek" data-type="indexterm" id="idm45120833996416"/><a data-primary="Tekton" data-secondary="authentication schemes" data-startref="Tek_authschem" data-type="indexterm" id="idm45120833995200"/><a data-primary="authentication" data-secondary="Tekton schemes" data-startref="auth_Tek" data-type="indexterm" id="idm45120833964624"/><a data-primary="Tekton" data-secondary="applications" data-startref="Tek_app_compilpriv" data-tertiary="compiling from private repositories" data-type="indexterm" id="idm45120833963536"/><a data-primary="Tekton" data-secondary="applications" data-startref="Tek_app_packagpriv" data-tertiary="packaging from private repositories" data-type="indexterm" id="idm45120833962208"/><a data-primary="repositories" data-secondary="private, compiling/packaging applications with Tekton" data-startref="repo_priv_appTek" data-type="indexterm" id="idm45120833960880"/><a data-primary="applications" data-secondary="compiling" data-startref="app_compil_privrepo" data-tertiary="from private repositories" data-tertiary-sortas="private repositories" data-type="indexterm" id="idm45120833959792"/><a data-primary="applications" data-secondary="packaging" data-startref="app_pack_privrepo" data-tertiary="from private repositories" data-tertiary-sortas="private" data-type="indexterm" id="idm45120833958224"/>following:</p>
<pre data-code-language="bash" data-type="programlisting">...
<code class="o">[</code>clone<code class="o">]</code> <code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1659354692.1365478,<code class="s2">"caller"</code>:<code class="s2">"git/git.go:169"</code>,<code class="s2">"msg"</code>:<code class="s2">"Successfully cloned https://github.com/gitops-cookbook/tekton-greeter-private.git @ 5250e1fa185805373e620d1c04a0c48129efd2ee (grafted, HEAD, origin/master) in path /workspace/source/"</code><code class="o">}</code>
<code class="o">[</code>clone<code class="o">]</code> <code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1659354692.1546066,<code class="s2">"caller"</code>:<code class="s2">"git/git.go:207"</code>,<code class="s2">"msg"</code>:<code class="s2">"Successfully initialized and updated submodules in path /workspace/source/"</code><code class="o">}</code>
...
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> BUILD SUCCESS
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Total time:  <code class="m">04</code>:30 min
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Finished at: <code class="m">2022</code>-07-31T15:30:01Z
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------</pre>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120834367344">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/6W9xF">Tekton Authentication</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="6.5 Containerize an Application Using a Tekton Task &#10;and Buildah" data-type="sect1"><div class="sect1" id="recipe_6_5">
<h1>6.5 Containerize an Application Using a Tekton Task 
<span class="keep-together">and Buildah</span></h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120833865264">
<h2>Problem</h2>
<p>You want to compile, package, and <a data-primary="Tekton" data-secondary="Tasks" data-tertiary="containerizing applications" data-type="indexterm" id="Tek_Task_containerapp"/><a data-primary="Tasks (Tekton)" data-secondary="applications" data-tertiary="containerizing" data-type="indexterm" id="Task_Tek_containerapp"/><a data-primary="applications" data-secondary="containerizing using Tekton Tasks" data-type="indexterm" id="app_container_TekTask"/>containerize your app with a Tekton Task on Kubernetes.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120833858080">
<h2>Solution</h2>
<p>Automation is essential when adopting the cloud native approach, and if you decide to use Kubernetes for your CI/CD workloads, you need to provide a way to package and deploy your applications.</p>
<p>In fact, Kubernetes per se doesn’t have a built-in mechanism to build containers; it just relies on add-ons such as Tekton or external services for this purpose. That’s why in <a data-type="xref" href="ch03.xhtml#ch_Containers">Chapter 3</a> we did an overview on how to create containers for packaging applications with various open source tools. In <a data-type="xref" href="ch03.xhtml#recipe_3_3">Recipe 3.3</a> we used Buildah to create a container from a Dockerfile.</p>
<p>Thanks to Tekton’s extensible model, you can reuse the same Task defined in <a data-type="xref" href="#recipe_6_3">Recipe 6.3</a> to add a step to create a container using the outcomes from the previous steps, as shown in <a data-type="xref" href="#fig6-4">Figure 6-4</a>.</p>
<figure><div class="figure" id="fig6-4">
<img alt="Build Push app" height="279" src="assets/gocb_0604.png" width="1368"/>
<h6><span class="label">Figure 6-4. </span>Build Push app</h6>
</div></figure>
<p>The container can be pushed to a public container registry such as DockerHub or Quay.io, or to a private container registry. Similar to what we have seen in <a data-type="xref" href="#recipe_6_4">Recipe 6.4</a> for private Git repositories, pushing a container image to a container registry needs authentication. A Secret <a data-primary="Kubernetes Secrets" data-secondary="ServiceAccount, attaching" data-type="indexterm" id="idm45120833848576"/><a data-primary="ServiceAccounts" data-secondary="secrets, attaching" data-type="indexterm" id="idm45120833847664"/>needs to be attached to the <code>ServiceAccount</code> running the Task as follows. See <a data-type="xref" href="ch02.xhtml#ch_Requirements">Chapter 2</a> for how to register and use a public registry.</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create secret docker-registry container-registry-secret <code class="se">\</code>
  --docker-server<code class="o">=</code><code class="s1">'YOUR_REGISTRY_SERVER'</code> <code class="se">\</code>
  --docker-username<code class="o">=</code><code class="s1">'YOUR_REGISTRY_USER'</code> <code class="se">\</code>
  --docker-password<code class="o">=</code><code class="s1">'YOUR_REGISTRY_PASS'</code></pre>
<pre data-code-language="bash" data-type="programlisting">secret/container-registry-secret created</pre>
<p>Verify it is present and check that the Secret is of type <code>kubernetes.io/dockerconfigjson</code>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get secrets</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">NAME                        TYPE                             DATA   AGE
container-registry-secret   kubernetes.io/dockerconfigjson   <code class="m">1</code>      1s</pre>
<p>Let’s create a <code>ServiceAccount</code><a data-primary="Tasks (Tekton)" data-secondary="ServiceAccounts, creating" data-type="indexterm" id="idm45120833819664"/><a data-primary="ServiceAccounts" data-secondary="creating" data-type="indexterm" id="idm45120833819152"/> for this Task:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create serviceaccount tekton-registry-sa</pre>
<p>Then let’s add the previously generated Secret to this <code>ServiceAccount</code>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl patch serviceaccount tekton-registry-sa <code class="se">\</code>
  -p <code class="s1">'{"secrets": [{"name": "container-registry-secret"}]}'</code></pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">serviceaccount/tekton-registry-sa patched</pre>
<p>Let’s add a new step to <a data-primary="container images" data-secondary="creating" data-tertiary="pushing to registry" data-type="indexterm" id="contimg_creat_registry"/>create a container image and push it to a container registry. In the following example we use the book’s organization repos at Quay.io—<code>quay.io/gitops-cookbook/tekton-greeter:latest</code>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Task</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-push-app</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">workspaces</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">source</code><code class="w"/>
<code class="w">      </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">The git repo will be cloned onto the volume backing this workspace</code><code class="w"/>
<code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">contextDir</code><code class="w"/>
<code class="w">      </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">the context dir within source</code><code class="w"/>
<code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quarkus</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tlsVerify</code><code class="w"/>
<code class="w">      </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tls verify</code><code class="w"/>
<code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="s">"false"</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">url</code><code class="w"/>
<code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/tekton-tutorial-greeter.git</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">revision</code><code class="w"/>
<code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">master</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">subdirectory</code><code class="w"/>
<code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">sslVerify</code><code class="w"/>
<code class="w">      </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">defines if http.sslVerify should be set to true or false in the global git config</code><code class="w"/>
<code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="s">"false"</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">storageDriver</code><code class="w"/>
<code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">      </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Storage driver</code><code class="w"/>
<code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">vfs</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">destinationImage</code><code class="w"/>
<code class="w">      </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">the fully qualified image name</code><code class="w"/>
<code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="s">""</code><code class="w"/>
<code class="w">  </code><code class="nt">steps</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="s">'gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:v0.21.0'</code><code class="w"/>
<code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">clone</code><code class="w"/>
<code class="w">      </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/>
<code class="w">      </code><code class="nt">script</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w"/>
<code class="w">        </code><code class="no">CHECKOUT_DIR="$(workspaces.source.path)/$(params.subdirectory)"</code><code class="w"/>
<code class="w">        </code><code class="no">cleandir() {</code><code class="w"/>
<code class="w">          </code><code class="no"># Delete any existing contents of the repo directory if it exists.</code><code class="w"/>
<code class="w">          </code><code class="no">#</code><code class="w"/>
<code class="w">          </code><code class="no"># We don't just "rm -rf $CHECKOUT_DIR" because $CHECKOUT_DIR might be "/"</code><code class="w"/>
<code class="w">          </code><code class="no"># or the root of a mounted volume.</code><code class="w"/>
<code class="w">          </code><code class="no">if [[ -d "$CHECKOUT_DIR" ]] ; then</code><code class="w"/>
<code class="w">            </code><code class="no"># Delete non-hidden files and directories</code><code class="w"/>
<code class="w">            </code><code class="no">rm -rf "$CHECKOUT_DIR"/*</code><code class="w"/>
<code class="w">            </code><code class="no"># Delete files and directories starting with . but excluding ..</code><code class="w"/>
<code class="w">            </code><code class="no">rm -rf "$CHECKOUT_DIR"/.[!.]*</code><code class="w"/>
<code class="w">            </code><code class="no"># Delete files and directories starting with .. plus any other character</code><code class="w"/>
<code class="w">            </code><code class="no">rm -rf "$CHECKOUT_DIR"/..?*</code><code class="w"/>
<code class="w">          </code><code class="no">fi</code><code class="w"/>
<code class="w">        </code><code class="no">}</code><code class="w"/>
<code class="w">        </code><code class="no">/ko-app/git-init \</code><code class="w"/>
<code class="w">          </code><code class="no">-url "$(params.url)" \</code><code class="w"/>
<code class="w">          </code><code class="no">-revision "$(params.revision)" \</code><code class="w"/>
<code class="w">          </code><code class="no">-path "$CHECKOUT_DIR" \</code><code class="w"/>
<code class="w">          </code><code class="no">-sslVerify="$(params.sslVerify)"</code><code class="w"/>
<code class="w">        </code><code class="no">cd "$CHECKOUT_DIR"</code><code class="w"/>
<code class="w">        </code><code class="no">RESULT_SHA="$(git rev-parse HEAD)"</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-sources</code><code class="w"/>
<code class="w">      </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gcr.io/cloud-builders/mvn</code><code class="w"/>
<code class="w">      </code><code class="nt">command</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">mvn</code><code class="w"/>
<code class="w">      </code><code class="nt">args</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">-DskipTests</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">clean</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">install</code><code class="w"/>
<code class="w">      </code><code class="nt">env</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">user.home</code><code class="w"/>
<code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/home/tekton</code><code class="w"/>
<code class="w">      </code><code class="nt">workingDir</code><code class="p">:</code><code class="w"> </code><code class="s">"/workspace/source/$(params.contextDir)"</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-and-push-image</code><code class="w"/>
<code class="w">      </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/buildah/stable</code><code class="w"/>
<code class="w">      </code><code class="nt">script</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w"/>
<code class="w">        </code><code class="no">#!/usr/bin/env bash</code><code class="w"/>
<code class="w">        </code><code class="no">buildah --storage-driver=$STORAGE_DRIVER --tls-verify=$(params.tlsVerify) bud --layers -t $DESTINATION_IMAGE $CONTEXT_DIR</code><code class="w"/>
<code class="w">        </code><code class="no">buildah --storage-driver=$STORAGE_DRIVER --tls-verify=$(params.tlsVerify) push $DESTINATION_IMAGE docker://$DESTINATION_IMAGE</code><code class="w"/>
<code class="w">      </code><code class="nt">env</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">DESTINATION_IMAGE</code><code class="w"/>
<code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"$(params.destinationImage)"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CONTEXT_DIR</code><code class="w"/>
<code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"/workspace/source/$(params.contextDir)"</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">STORAGE_DRIVER</code><code class="w"/>
<code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"$(params.storageDriver)"</code><code class="w"/>
<code class="w">      </code><code class="nt">workingDir</code><code class="p">:</code><code class="w"> </code><code class="s">"/workspace/source/$(params.contextDir)"</code><code class="w"/>
<code class="w">      </code><code class="nt">volumeMounts</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">varlibc</code><code class="w"/>
<code class="w">          </code><code class="nt">mountPath</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">/var/lib/containers</code><code class="w"/>
<code class="w">  </code><code class="nt">volumes</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">varlibc</code><code class="w"/>
<code class="w">      </code><code class="nt">emptyDir</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/></pre>
<p>Let’s create this Task:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f build-push-app.yaml</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">task.tekton.dev/build-push-app created</pre>
<p>Now let’s start the Task with the Buildah step creating a container image and with a new parameter <code>destinationImage</code> to specify where to push the resulting container image:</p>
<pre data-code-language="bash" data-type="programlisting"><code>tkn</code><code> </code><code>task</code><code> </code><code>start</code><code> </code><code>build-push-app</code><code> </code><code class="se">\
</code><code>  </code><code>--serviceaccount</code><code class="o">=</code><code class="s1">'tekton-registry-sa'</code><code> </code><code class="se">\
</code><code>  </code><code>--param</code><code> </code><code class="nv">url</code><code class="o">=</code><code class="s1">'https://github.com/gitops-cookbook/tekton-tutorial-greeter.git'</code><code> </code><code class="se">\
</code><code>  </code><code>--param</code><code> </code><code class="nv">destinationImage</code><code class="o">=</code><code class="s1">'quay.io/gitops-cookbook/tekton-greeter:latest'</code><code> </code><code class="se">\ </code><a class="co" href="#callout_cloud_native_ci_cd_CO7-1" id="co_cloud_native_ci_cd_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code>
  </code><code>--param</code><code> </code><code class="nv">contextDir</code><code class="o">=</code><code class="s1">'quarkus'</code><code> </code><code class="se">\
</code><code>  </code><code>--workspace</code><code> </code><code class="nv">name</code><code class="o">=</code><code>source,emptyDir</code><code class="o">=</code><code class="s2">""</code><code> </code><code class="se">\
</code><code>  </code><code>--use-param-defaults</code><code> </code><code class="se">\
</code><code>  </code><code>--showlog</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO7-1" id="callout_cloud_native_ci_cd_CO7-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Here you can place your registry; in this example we are using the book’s organization repos at Quay.io.</p></dd>
</dl>
<p>You should get output similar to the <a data-primary="Tekton" data-secondary="Tasks" data-startref="Tek_Task_containerapp" data-tertiary="containerizing applications" data-type="indexterm" id="idm45120833292768"/><a data-primary="Tasks (Tekton)" data-secondary="applications" data-startref="Task_Tek_containerapp" data-tertiary="containerizing" data-type="indexterm" id="idm45120833291280"/><a data-primary="applications" data-secondary="containerizing using Tekton Tasks" data-startref="app_container_TekTask" data-type="indexterm" id="idm45120833289792"/><a data-primary="container images" data-secondary="creating" data-startref="contimg_creat_registry" data-tertiary="pushing to registry" data-type="indexterm" id="idm45120833288560"/>following:</p>
<pre data-code-language="bash" data-type="programlisting">...
Downloaded from central: https://repo.maven.apache.org/maven2/org/codehaus/plexus/plexus-utils/3.0.5/plexus-utils-3.0.5.jar <code class="o">(</code><code class="m">230</code> kB at <code class="m">301</code> kB/s<code class="o">)</code>
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Installing /workspace/source/quarkus/target/tekton-quarkus-greeter.jar to /root/.m2/repository/com/redhat/developers/tekton-quarkus-greeter/1.0.0-SNAPSHOT/tekton-quarkus-greeter-1.0.0-SNAPSHOT.jar
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Installing /workspace/source/quarkus/pom.xml to /root/.m2/repository/com/redhat/developers/tekton-quarkus-greeter/1.0.0-SNAPSHOT/tekton-quarkus-greeter-1.0.0-SNAPSHOT.pom
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> BUILD SUCCESS
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Total time:  <code class="m">02</code>:59 min
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Finished at: <code class="m">2022</code>-08-02T06:18:37Z
<code class="o">[</code>build-sources<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------
<code class="o">[</code>build-and-push-image<code class="o">]</code> STEP <code class="m">1</code>/2: FROM registry.access.redhat.com/ubi8/openjdk-11
<code class="o">[</code>build-and-push-image<code class="o">]</code> Trying to pull registry.access.redhat.com/ubi8/openjdk-11:latest...
<code class="o">[</code>build-and-push-image<code class="o">]</code> Getting image <code class="nb">source</code> signatures
<code class="o">[</code>build-and-push-image<code class="o">]</code> Checking <code class="k">if</code> image destination supports signatures
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying blob sha256:1e09a5ee0038fbe06a18e7f355188bbabc387467144abcd435f7544fef395aa1
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying blob sha256:0d725b91398ed3db11249808d89e688e62e511bbd4a2e875ed8493ce1febdb2c
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying blob sha256:1e09a5ee0038fbe06a18e7f355188bbabc387467144abcd435f7544fef395aa1
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying blob sha256:0d725b91398ed3db11249808d89e688e62e511bbd4a2e875ed8493ce1febdb2c
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying blob sha256:e441d34134fac91baa79be3e2bb8fb3dba71ba5c1ea012cb5daeb7180a054687
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying blob sha256:e441d34134fac91baa79be3e2bb8fb3dba71ba5c1ea012cb5daeb7180a054687
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying config sha256:0c308464b19eaa9a01c3fdd6b63a043c160d4eea85e461bbbb7d01d168f6d993
<code class="o">[</code>build-and-push-image<code class="o">]</code> Writing manifest to image destination
<code class="o">[</code>build-and-push-image<code class="o">]</code> Storing signatures
<code class="o">[</code>build-and-push-image<code class="o">]</code> STEP <code class="m">2</code>/2: COPY target/quarkus-app /deployments/
<code class="o">[</code>build-and-push-image<code class="o">]</code> COMMIT quay.io/gitops-cookbook/tekton-greeter:latest
<code class="o">[</code>build-and-push-image<code class="o">]</code> --&gt; 42fe38b4346
<code class="o">[</code>build-and-push-image<code class="o">]</code> Successfully tagged quay.io/gitops-cookbook/tekton-greeter:latest
<code class="o">[</code>build-and-push-image<code class="o">]</code> 42fe38b43468c3ca32262dbea6fd78919aba2bd35981cd4f71391e07786c9e21
<code class="o">[</code>build-and-push-image<code class="o">]</code> Getting image <code class="nb">source</code> signatures
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying blob sha256:647a854c512bad44709221b6b0973e884f29bcb5a380ee32e95bfb0189b620e6
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying blob sha256:f2ee6b2834726167d0de06f3bbe65962aef79855c5ede0d2ba93b4408558d9c9
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying blob sha256:8e0e04b5c700a86f4a112f41e7e767a9d7c539fe3391611313bf76edb07eeab1
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying blob sha256:69c55192bed92cbb669c88eb3c36449b64ac93ae466abfff2a575273ce05a39e
<code class="o">[</code>build-and-push-image<code class="o">]</code> Copying config sha256:42fe38b43468c3ca32262dbea6fd78919aba2bd35981cd4f71391e07786c9e21
<code class="o">[</code>build-and-push-image<code class="o">]</code> Writing manifest to image destination
<code class="o">[</code>build-and-push-image<code class="o">]</code> Storing signatures</pre>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120833857168">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://buildah.io">Buildah</a></p>
</li>
<li>
<p><a href="https://oreil.ly/QJlVW">Docker Authentication for Tekton</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="6.6 Deploy an Application to Kubernetes Using a &#10;Tekton Task" data-type="sect1"><div class="sect1" id="recipe_6_6">
<h1>6.6 Deploy an Application to Kubernetes Using a 
<span class="keep-together">Tekton Task</span></h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120832845504">
<h2>Problem</h2>
<p>You want to deploy <a data-primary="Tekton" data-secondary="applications" data-tertiary="deploying to Kubernetes" data-type="indexterm" id="Tek_app_K"/><a data-primary="Tasks (Tekton)" data-secondary="applications" data-tertiary="deploying to Kubernetes" data-type="indexterm" id="Task_app_K"/><a data-primary="applications" data-secondary="deployment" data-tertiary="to Kubernetes" data-tertiary-sortas="Kubernetes" data-type="indexterm" id="app_deploy_K"/><a data-primary="Kubernetes" data-secondary="applications" data-tertiary="deploying to" data-type="indexterm" id="K_app_deploy"/>an application from a container image to Kubernetes with a Tekton Task.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120832837504">
<h2>Solution</h2>
<p>While in Recipes <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_6_3">6.3</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_6_4">6.4</a>, and
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_6_5">6.5</a> we have listed a Tekton Task that is useful for continuous integration (CI), in this recipe we’ll start having a look at the Continous Deployment (CD) part by deploying<a data-primary="CD (continuous deployment)" data-secondary="Kubernetes, Tekton Tasks" data-type="indexterm" id="CD_K_TekTask"/> an existing container image to Kubernetes.</p>
<p>We can reuse the container image we created and pushed in <a data-type="xref" href="#recipe_6_5">Recipe 6.5</a>, available at <code>quay.io/gitops-cookbook/tekton-greeter:latest</code>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Task</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kubectl</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">SCRIPT</code><code class="w">
</code><code class="w">      </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">The</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">kubectl</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">CLI</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">arguments</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">to</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">run</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">      </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">kubectl</code><code class="nv"> </code><code class="s">help</code><code class="s">"</code><code class="w">
</code><code class="w">  </code><code class="nt">steps</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">oc</code><code class="w">
</code><code class="w">      </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/openshift/origin-cli:latest</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO8-1" id="co_cloud_native_ci_cd_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">script</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w">
</code><code class="w">        </code><code class="no">#!/usr/bin/env bash</code><code class="w">
</code><code class="w">
</code><code class="w">        </code><code class="no">$(params.SCRIPT)</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO8-1" id="callout_cloud_native_ci_cd_CO8-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>For this example we are using <code>kubectl</code> from this container image, which also contains OpenShift CLI and it has an smaller size compared to <code>gcr.io/cloud-builders/kubectl</code>.</p></dd>
</dl>
<p>Let’s create this Task:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f kubectl-task.yaml</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">task.tekton.dev/kubectl created</pre>
<p>As discussed in <a data-type="xref" href="#recipe_6_5">Recipe 6.5</a>, Tekton uses a default <a data-primary="ServiceAccounts" data-secondary="Tekton Tasks, creating" data-type="indexterm" id="idm45120832719088"/><a data-primary="Tasks (Tekton)" data-secondary="ServiceAccounts, creating" data-type="indexterm" id="idm45120832718352"/><code>ServiceAccount</code> for running Tasks and Pipelines, unless a specific one is defined at runtime or overridden at a global scope. The best practice is always to create a specific <code>ServiceAccount</code> for a particular action, so let’s create one named <code>tekton-deployer-sa</code> for this use case as follows:<a data-primary="Tekton" data-secondary="Tasks" data-tertiary="creating ServiceAccounts" data-type="indexterm" id="idm45120832668000"/></p>
<pre data-code-language="bash" data-type="programlisting">kubectl create serviceaccount tekton-deployer-sa</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">serviceaccount/tekton-deployer-sa created</pre>
<p>A <code>ServiceAccount</code> needs permission to deploy an application to Kubernetes. <a href="https://oreil.ly/6ov6J">Roles and RoleBindings</a> are API objects used to map a certain permission to a user or a <code>ServiceAccount</code>.</p>
<p>You first define a<a data-primary="Roles, ServiceAccounts" data-type="indexterm" id="idm45120832638736"/><a data-primary="ServiceAccounts" data-secondary="Roles" data-type="indexterm" id="idm45120832638352"/> Role named <code>pipeline-role</code> for the <code>ServiceAccount</code> running the Tekton Task with permissions to deploy apps:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">rbac.authorization.k8s.io/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Role</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">task-role</code><code class="w"/>
<code class="nt">rules</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">apiGroups</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">""</code><code class="w"/>
<code class="w">    </code><code class="nt">resources</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">pods</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">services</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">endpoints</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">configmaps</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">secrets</code><code class="w"/>
<code class="w">    </code><code class="nt">verbs</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"*"</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">apiGroups</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">apps</code><code class="w"/>
<code class="w">    </code><code class="nt">resources</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">deployments</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">replicasets</code><code class="w"/>
<code class="w">    </code><code class="nt">verbs</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">"*"</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">apiGroups</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="s">""</code><code class="w"/>
<code class="w">    </code><code class="nt">resources</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">pods</code><code class="w"/>
<code class="w">    </code><code class="nt">verbs</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">get</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">apiGroups</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">apps</code><code class="w"/>
<code class="w">    </code><code class="nt">resources</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">replicasets</code><code class="w"/>
<code class="w">    </code><code class="nt">verbs</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">get</code><code class="w"/></pre>
<p>Now you need to bind the Role to the <code>ServiceAccount</code>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">rbac.authorization.k8s.io/v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">RoleBinding</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">task-role-binding</code><code class="w"/>
<code class="nt">roleRef</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Role</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">task-role</code><code class="w"/>
<code class="w">  </code><code class="nt">apiGroup</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">rbac.authorization.k8s.io</code><code class="w"/>
<code class="nt">subjects</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ServiceAccount</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-deployer-sa</code><code class="w"/></pre>
<p>Now you can create the two resources as follows:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f task-role.yaml
kubectl create -f task-role-binding.yaml</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">role.rbac.authorization.k8s.io/task-role created
rolebinding.rbac.authorization.k8s.io/task-role-binding created</pre>
<p>Finally, you can define a TaskRun as follows:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TaskRun</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kubectl-taskrun</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">serviceAccountName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-deployer-sa</code><code class="w"/>
<code class="w">  </code><code class="nt">taskRef</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kubectl</code><code class="w"/>
<code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">SCRIPT</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w"/>
<code class="w">        </code><code class="no">kubectl create deploy tekton-greeter --image=quay.io/gitops-cookbook/tekton-greeter:latest</code><code class="w"/></pre>
<p>And run it in this way:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f kubectl-taskrun.yaml</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">taskrun.tekton.dev/kubectl-run created</pre>
<p>You can check the logs to see the results:</p>
<pre data-code-language="bash" data-type="programlisting">tkn taskrun logs kubectl-run -f</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">? Select taskrun: kubectl-run started <code class="m">9</code> seconds ago
<code class="o">[</code>oc<code class="o">]</code> deployment.apps/tekton-greeter created</pre>
<p>After a few seconds you should see the Deployment in Ready state:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get deploy

NAME             READY   UP-TO-DATE   AVAILABLE   AGE
tekton-greeter   <code class="m">1</code>/1     <code class="m">1</code>            <code class="m">0</code>           30s</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The first time might take a while due to the time it takes to pull the container image.</p>
</div>
<p>Check if the app is available, expose the Deployment, and forward Kubernetes traffic to your workstation to test it:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl expose deploy/tekton-greeter --port <code class="m">8080</code>
kubectl port-forward svc/tekton-greeter <code class="m">8080</code>:8080</pre>
<p>In another terminal, run this command:</p>
<pre data-code-language="bash" data-type="programlisting">curl localhost:8080</pre>
<p>You should see the following<a data-primary="Tekton" data-secondary="applications" data-startref="Tek_app_K" data-tertiary="deploying to Kubernetes" data-type="indexterm" id="idm45120832069712"/><a data-primary="Tasks (Tekton)" data-secondary="applications" data-startref="Task_app_K" data-tertiary="deploying to Kubernetes" data-type="indexterm" id="idm45120832044080"/><a data-primary="applications" data-secondary="deployment" data-startref="app_deploy_K" data-tertiary="to Kubernetes" data-tertiary-sortas="Kubernetes" data-type="indexterm" id="idm45120832042752"/><a data-primary="Kubernetes" data-secondary="applications" data-startref="K_app_deploy" data-tertiary="deploying to" data-type="indexterm" id="idm45120832049344"/><a data-primary="CD (continuous deployment)" data-secondary="Kubernetes, Tekton Tasks" data-startref="CD_K_TekTask" data-type="indexterm" id="idm45120832074048"/> output:</p>
<pre data-code-language="bash" data-type="programlisting">Meeow!! from Tekton ----</pre>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120832288160">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/YlIZI">Tekton Task</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="6.7 Create a Tekton Pipeline to Build and Deploy an App to Kubernetes" data-type="sect1"><div class="sect1" id="recipe_6_7">
<h1>6.7 Create a Tekton Pipeline to Build and Deploy an App to Kubernetes</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120832004960">
<h2>Problem</h2>
<p>You want to<a data-primary="Pipelines (Tekton)" data-secondary="applications, deploying to Kubernetes" data-type="indexterm" id="pip_app_deploy"/><a data-primary="Tekton" data-secondary="Pipelines" data-tertiary="deploying applications to Kubernetes" data-type="indexterm" id="Tek_pipe_K"/><a data-primary="Tasks (Tekton)" data-secondary="Pipelines" data-tertiary="deploying applications to Kubernetes" data-type="indexterm" id="Task_pipe_K"/><a data-primary="applications" data-secondary="deployment" data-tertiary="Tekton Pipelines" data-type="indexterm" id="pipe_deploy_K"/><a data-primary="Kubernetes" data-secondary="applications" data-tertiary="Tekton Pipelines" data-type="indexterm" id="K_pipe_deploy"/> create a Pipeline to compile, package, and deploy an app on Kubernetes with Tekton.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120831999984">
<h2>Solution</h2>
<p>In the previous recipes we have seen how to create Tasks to execute one or more steps sequentially to build apps. In this recipe we will discuss <a href="https://oreil.ly/aN8lv">Tekton Pipelines</a>, a collection of Tasks that you can define and compose in a specific order of execution, either sequentially or in parallel, as you can see<a data-primary="Tekton" data-secondary="Pipelines" data-tertiary="flow" data-type="indexterm" id="idm45120831996704"/><a data-primary="Pipelines (Tekton)" data-secondary="flow" data-type="indexterm" id="idm45120831995456"/> in <a data-type="xref" href="#fig6-5">Figure 6-5</a>.</p>
<figure><div class="figure" id="fig6-5">
<img alt="Tekton Pipelines flows" height="749" src="assets/gocb_0605.png" width="1320"/>
<h6><span class="label">Figure 6-5. </span>Tekton Pipelines flows</h6>
</div></figure>
<p>Tekton Pipelines supports parameters and a mechanism to exchange outcomes between different Tasks. For instance, using the examples shown in Recipes <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_6_5">6.5</a> and
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_6_6">6.6</a>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl patch serviceaccount tekton-deployer-sa <code class="se">\</code>
  -p <code class="s1">'{"secrets": [{"name": "container-registry-secret"}]}'</code></pre>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pipeline</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-pipeline</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO9-1" id="co_cloud_native_ci_cd_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REPO</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REF</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name </code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">DESTINATION_IMAGE</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name </code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">SCRIPT</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">  </code><code class="nt">tasks</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO9-2" id="co_cloud_native_ci_cd_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-push-app</code><code class="w">
</code><code class="w">      </code><code class="nt">taskRef</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO9-3" id="co_cloud_native_ci_cd_CO9-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-push-app</code><code class="w">
</code><code class="w">      </code><code class="nt">params</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">url</code><code class="w">
</code><code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">$(params.GIT_REPO)</code><code class="s">"</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">revision</code><code class="w">
</code><code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">$(params.GIT_REF)</code><code class="s">"</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">destinationImage</code><code class="w">
</code><code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">$(params.DESTINATION_IMAGE)</code><code class="s">"</code><code class="w">
</code><code class="w">      </code><code class="nt">workspaces</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">source</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">deploy-app</code><code class="w">
</code><code class="w">      </code><code class="nt">taskRef</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kubectl</code><code class="w">
</code><code class="w">      </code><code class="nt">params</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">SCRIPT</code><code class="w">
</code><code class="w">          </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">$(params.SCRIPT)</code><code class="s">"</code><code class="w">
</code><code class="w">      </code><code class="nt">workspaces</code><code class="p">:</code><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">source</code><code class="w">
</code><code class="w">      </code><code class="nt">runAfter</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO9-4" id="co_cloud_native_ci_cd_CO9-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">build-push-app</code><code class="w">
</code><code class="w">  </code><code class="nt">workspaces</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO9-5" id="co_cloud_native_ci_cd_CO9-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">source</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO9-1" id="callout_cloud_native_ci_cd_CO9-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Pipeline parameters</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO9-2" id="callout_cloud_native_ci_cd_CO9-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>A list of Tasks for the Pipeline</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO9-3" id="callout_cloud_native_ci_cd_CO9-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>The exact name of the Task to use</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO9-4" id="callout_cloud_native_ci_cd_CO9-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>You can decide the order with the <code>runAfter</code> field to indicate that a Task must execute after one or more other Tasks</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO9-5" id="callout_cloud_native_ci_cd_CO9-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>One or more common Workspaces used to share data between Tasks</p></dd>
</dl>
<p>Let’s create the<a data-primary="Pipelines (Tekton)" data-secondary="creating" data-type="indexterm" id="idm45120831731376"/><a data-primary="Tekton" data-secondary="Pipelines" data-tertiary="creating" data-type="indexterm" id="idm45120831730400"/> Pipeline as follows:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f tekton-greeter-pipeline.yaml</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">pipeline.tekton.dev/tekton-greeter-pipeline created</pre>
<p>Similarly to TaskRuns, you can run this Pipeline by creating a <a href="https://oreil.ly/N8K3a">PipelineRun</a> resource as follows:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">PipelineRun</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">generateName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-pipeline-run-</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REPO</code><code class="w"/>
<code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/tekton-tutorial-greeter.git</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REF</code><code class="w"/>
<code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"master"</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">DESTINATION_IMAGE</code><code class="w"/>
<code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"quay.io/gitops-cookbook/tekton-greeter:latest"</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">SCRIPT</code><code class="w"/>
<code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w"/>
<code class="w">        </code><code class="no">kubectl create deploy tekton-greeter --image=quay.io/gitops-cookbook/tekton-greeter:latest</code><code class="w"/>
<code class="w">  </code><code class="nt">pipelineRef</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-pipeline</code><code class="w"/>
<code class="w">  </code><code class="nt">workspaces</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">source</code><code class="w"/>
<code class="w">      </code><code class="nt">emptyDir</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/></pre>
<p>You can run the Pipeline by creating this <a data-primary="PipelineRun object" data-type="indexterm" id="idm45120831627888"/>PipelineRun object as follows:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f tekton-greeter-pipelinerun.yaml</pre>
<p>You can check the status:</p>
<pre data-code-language="bash" data-type="programlisting">tkn pipelinerun ls</pre>
<pre data-code-language="bash" data-type="programlisting">NAME                                STARTED         DURATION   STATUS
tekton-greeter-pipeline-run-ntl5r   <code class="m">7</code> seconds ago   ---        Running</pre>
<p>Now that you have seen how to reuse existing Tasks within a Pipeline, it’s a good time to introduce the <a href="https://hub.tekton.dev">Tekton Hub</a>, a <a data-primary="Tekton Hub" data-type="indexterm" id="idm45120831465408"/>web-based platform for developers to discover, share, and contribute Tasks and Pipelines for Tekton (see <a data-type="xref" href="#fig6-6">Figure 6-6</a>).</p>
<figure><div class="figure" id="fig6-6">
<img alt="Tekton Hub" height="940" src="assets/gocb_0606.png" width="1919"/>
<h6><span class="label">Figure 6-6. </span>Tekton Hub</h6>
</div></figure>
<p>You can implement the same Pipeline with <a data-primary="Tasks (Tekton)" data-secondary="Tekton Hub" data-type="indexterm" id="idm45120831463488"/>Tasks already available in the Hub. In our case, we have:</p>
<dl>
<dt><a href="https://oreil.ly/tVLAG"><code>git-clone</code></a></dt>
<dd>
<p>Task that clones a repo from the provided URL into the output Workspace.</p>
</dd>
<dt><a href="https://oreil.ly/nTUkZ"><code>buildah</code></a></dt>
<dd>
<p>Task that builds source into a container image and can push it to a container registry.</p>
</dd>
<dt><a href="https://oreil.ly/A3Hui"><code>kubernetes-actions</code></a></dt>
<dd>
<p>The generic <code>kubectl</code> CLI task, which can be used to run all kinds of k8s 
<span class="keep-together">commands</span>.</p>
</dd>
</dl>
<p>First let’s add them to our namespace as follows:</p>
<pre data-code-language="bash" data-type="programlisting">tkn hub install task git-clone
tkn hub install task maven
tkn hub install task buildah
tkn hub install task kubernetes-actions</pre>
<p>You should get output similar to the following to confirm they are installed properly in your namespace:</p>
<pre data-code-language="bash" data-type="programlisting">Task git-clone<code class="o">(</code><code class="m">0</code>.7<code class="o">)</code> installed <code class="k">in</code> default namespace
Task maven<code class="o">(</code><code class="m">0</code>.2<code class="o">)</code> installed <code class="k">in</code> default namespace
Task buildah<code class="o">(</code><code class="m">0</code>.4<code class="o">)</code> installed <code class="k">in</code> default namespace
Task kubernetes-actions<code class="o">(</code><code class="m">0</code>.2<code class="o">)</code> installed <code class="k">in</code> default namespace</pre>
<p>You can cross-check it with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get tasks</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">NAME                 AGE
...
buildah              50s
git-clone            52s
kubernetes-actions   49s
maven                51s
...</pre>
<div data-type="tip"><h6>Tip</h6>
<p>Some Tekton installations like the one made with the Operator for <a href="https://oreil.ly/dAKhL">OpenShift Pipelines</a> provide <a data-primary="OpenShift Pipelines" data-type="indexterm" id="idm45120831299296"/>a common list of useful Tasks such as those just listed, provided as ClusterTasks. <a data-primary="ClusterTasks" data-type="indexterm" id="idm45120831306768"/>ClusterTasks are Tasks available for all namespaces within the Kubernetes cluster. Check if your installation already provides some with this command: <code>kubectl get clustertasks</code>.</p>
</div>
<p>Now the Pipeline has four Tasks, as you can see in <a data-type="xref" href="#fig6-7">Figure 6-7</a>.</p>
<figure><div class="figure" id="fig6-7">
<img alt="Pipeline" height="246" src="assets/gocb_0607.png" width="1304"/>
<h6><span class="label">Figure 6-7. </span>Pipeline</h6>
</div></figure>
<p>In this example you’ll see a <a href="https://oreil.ly/Opio5">PersistentVolumeClaim</a> as a Workspace because here <a data-primary="workspaces, persisting" data-type="indexterm" id="idm45120831333872"/><a data-primary="Tasks (Tekton)" data-secondary="workspaces, persisting" data-type="indexterm" id="idm45120831333168"/>the data is shared among different Tasks so we need to persist it:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">PersistentVolumeClaim</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source-pvc</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">accessModes</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">ReadWriteOnce</code><code class="w"/>
<code class="w">  </code><code class="nt">resources</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">requests</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">storage</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1Gi</code><code class="w"/></pre>
<p>As usual, you can create the resource with <code>kubectl</code>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f app-source-pvc.yaml</pre>
<p>You should see the following output:</p>
<pre data-code-language="bash" data-type="programlisting">persistentvolumeclaim/app-source-pvc created</pre>
<pre data-code-language="bash" data-type="programlisting">kubectl get pvc

NAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
app-source-pvc   Bound    pvc-e85ade46-aaca-4f3f-b644-d8ff99fd9d5e   1Gi        RWO            standard       61s</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>In Minikube you<a data-primary="Kubernetes" data-secondary="dynamic storage support" data-type="indexterm" id="idm45120831241520"/><a data-primary="dynamic storage support, Kubernetes" data-type="indexterm" id="idm45120831240400"/> have a default <a href="https://oreil.ly/ZiPnA">StorageClass</a> that provides dynamic storage for the cluster. If you are using another Kubernetes cluster, please make sure you have a dynamic storage support.</p>
</div>
<p>The Pipeline definition now is:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pipeline</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-pipeline-hub</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/tekton-tutorial-greeter.git</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REPO</code><code class="w"/>
<code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">master</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REF</code><code class="w"/>
<code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/gitops-cookbook/tekton-greeter:latest</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">DESTINATION_IMAGE</code><code class="w"/>
<code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kubectl create deploy tekton-greeter --image=quay.io/gitops-cookbook/tekton-greeter:latest</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">SCRIPT</code><code class="w"/>
<code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">./Dockerfile</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CONTEXT_DIR</code><code class="w"/>
<code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">.</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">IMAGE_DOCKERFILE</code><code class="w"/>
<code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">.</code><code class="w"/>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">IMAGE_CONTEXT_DIR</code><code class="w"/>
<code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">  </code><code class="nt">tasks</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">fetch-repo</code><code class="w"/>
<code class="w">    </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">url</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.GIT_REPO)</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">revision</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.GIT_REF)</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">deleteExisting</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"true"</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">verbose</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"true"</code><code class="w"/>
<code class="w">    </code><code class="nt">taskRef</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Task</code><code class="w"/>
<code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-clone</code><code class="w"/>
<code class="w">    </code><code class="nt">workspaces</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">output</code><code class="w"/>
<code class="w">      </code><code class="nt">workspace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-app</code><code class="w"/>
<code class="w">    </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GOALS</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">-DskipTests</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">clean</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">package</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CONTEXT_DIR</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.CONTEXT_DIR)</code><code class="w"/>
<code class="w">    </code><code class="nt">runAfter</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">fetch-repo</code><code class="w"/>
<code class="w">    </code><code class="nt">taskRef</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Task</code><code class="w"/>
<code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven</code><code class="w"/>
<code class="w">    </code><code class="nt">workspaces</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven-settings</code><code class="w"/>
<code class="w">      </code><code class="nt">workspace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven-settings</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">source</code><code class="w"/>
<code class="w">      </code><code class="nt">workspace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-push-image</code><code class="w"/>
<code class="w">    </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">IMAGE</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.DESTINATION_IMAGE)</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">DOCKERFILE</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.IMAGE_DOCKERFILE)</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CONTEXT</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.IMAGE_CONTEXT_DIR)</code><code class="w"/>
<code class="w">    </code><code class="nt">runAfter</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">build-app</code><code class="w"/>
<code class="w">    </code><code class="nt">taskRef</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Task</code><code class="w"/>
<code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">buildah</code><code class="w"/>
<code class="w">    </code><code class="nt">workspaces</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">source</code><code class="w"/>
<code class="w">      </code><code class="nt">workspace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">deploy</code><code class="w"/>
<code class="w">    </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">script</code><code class="w"/>
<code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.SCRIPT)</code><code class="w"/>
<code class="w">    </code><code class="nt">runAfter</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">build-push-image</code><code class="w"/>
<code class="w">    </code><code class="nt">taskRef</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Task</code><code class="w"/>
<code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kubernetes-actions</code><code class="w"/>
<code class="w">  </code><code class="nt">workspaces</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven-settings</code><code class="w"/></pre>
<p>Let’s create the resource:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f tekton-greeter-pipeline-hub.yaml</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>We are using the same Secret and <code>ServiceAccount</code> defined in <a data-type="xref" href="#recipe_6_5">Recipe 6.5</a> to log in against Quay.io in order to push the container image.</p>
</div>
<p>You can now start the Pipeline as follows:</p>
<pre data-code-language="bash" data-type="programlisting">tkn pipeline start tekton-greeter-pipeline-hub <code class="se">\</code>
  --serviceaccount<code class="o">=</code><code class="s1">'tekton-deployer-sa'</code> <code class="se">\</code>
  --param <code class="nv">GIT_REPO</code><code class="o">=</code><code class="s1">'https://github.com/gitops-cookbook/tekton-tutorial-greeter.git'</code> <code class="se">\</code>
  --param <code class="nv">GIT_REF</code><code class="o">=</code><code class="s1">'master'</code> <code class="se">\</code>
  --param <code class="nv">CONTEXT_DIR</code><code class="o">=</code><code class="s1">'quarkus'</code> <code class="se">\</code>
  --param <code class="nv">DESTINATION_IMAGE</code><code class="o">=</code><code class="s1">'quay.io/gitops-cookbook/tekton-greeter:latest'</code> <code class="se">\</code>
  --param <code class="nv">IMAGE_DOCKERFILE</code><code class="o">=</code><code class="s1">'quarkus/Dockerfile'</code> <code class="se">\</code>
  --param <code class="nv">IMAGE_CONTEXT_DIR</code><code class="o">=</code><code class="s1">'quarkus'</code> <code class="se">\</code>
  --param <code class="nv">SCRIPT</code><code class="o">=</code><code class="s1">'kubectl create deploy tekton-greeter --image=quay.io/gitops-cookbook/tekton-greeter:latest'</code> <code class="se">\</code>
  --workspace <code class="nv">name</code><code class="o">=</code>app-source,claimName<code class="o">=</code>app-source-pvc <code class="se">\</code>
  --workspace <code class="nv">name</code><code class="o">=</code>maven-settings,emptyDir<code class="o">=</code><code class="s2">""</code> <code class="se">\</code>
  --use-param-defaults <code class="se">\</code>
  --showlog</pre>
<pre data-code-language="bash" data-type="programlisting"><code class="o">[</code>fetch-repo : clone<code class="o">]</code> + <code class="nv">CHECKOUT_DIR</code><code class="o">=</code>/workspace/output/
<code class="o">[</code>fetch-repo : clone<code class="o">]</code> + /ko-app/git-init <code class="s1">'-url=https://github.com/gitops-cookbook/tekton-tutorial-greeter.git'</code> <code class="s1">'-revision=master'</code> <code class="s1">'-refspec='</code> <code class="s1">'-path=/workspace/output/'</code> <code class="s1">'-sslVerify=true'</code> <code class="s1">'-submodules=true'</code> <code class="s1">'-depth=1'</code> <code class="s1">'-sparseCheckoutDirectories='</code>
<code class="o">[</code>fetch-repo : clone<code class="o">]</code> <code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1660819038.5526028,<code class="s2">"caller"</code>:<code class="s2">"git/git.go:170"</code>,<code class="s2">"msg"</code>:<code class="s2">"Successfully cloned https://github.com/gitops-cookbook/tekton-tutorial-greeter.git @ d9291c456db1ce29177b77ffeaa9b71ad80a50e6 (grafted, HEAD, origin/master) in path /workspace/output/"</code><code class="o">}</code>
<code class="o">[</code>fetch-repo : clone<code class="o">]</code> <code class="o">{</code><code class="s2">"level"</code>:<code class="s2">"info"</code>,<code class="s2">"ts"</code>:1660819038.5722632,<code class="s2">"caller"</code>:<code class="s2">"git/git.go:208"</code>,<code class="s2">"msg"</code>:<code class="s2">"Successfully initialized and updated submodules in path /workspace/output/"</code><code class="o">}</code>
<code class="o">[</code>fetch-repo : clone<code class="o">]</code> + <code class="nb">cd</code> /workspace/output/
<code class="o">[</code>fetch-repo : clone<code class="o">]</code> + git rev-parse HEAD
<code class="o">[</code>fetch-repo : clone<code class="o">]</code> + <code class="nv">RESULT_SHA</code><code class="o">=</code>d9291c456db1ce29177b77ffeaa9b71ad80a50e6
<code class="o">[</code>fetch-repo : clone<code class="o">]</code> + <code class="nv">EXIT_CODE</code><code class="o">=</code><code class="m">0</code>
<code class="o">[</code>fetch-repo : clone<code class="o">]</code> + <code class="s1">'['</code> <code class="m">0</code> <code class="s1">'!='</code> <code class="m">0</code> <code class="o">]</code>
<code class="o">[</code>fetch-repo : clone<code class="o">]</code> + <code class="nb">printf</code> <code class="s1">'%s'</code> d9291c456db1ce29177b77ffeaa9b71ad80a50e6
<code class="o">[</code>fetch-repo : clone<code class="o">]</code> + <code class="nb">printf</code> <code class="s1">'%s'</code> https://github.com/gitops-cookbook/tekton-tutorial-greeter.git
...
<code class="o">[</code>build-app : mvn-goals<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> <code class="o">[</code>org.jboss.threads<code class="o">]</code> JBoss Threads version <code class="m">3</code>.1.1.Final
<code class="o">[</code>build-app : mvn-goals<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> <code class="o">[</code>io.quarkus.deployment.QuarkusAugmentor<code class="o">]</code> Quarkus augmentation completed <code class="k">in</code> 1296ms
<code class="o">[</code>build-app : mvn-goals<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------
<code class="o">[</code>build-app : mvn-goals<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> BUILD SUCCESS
<code class="o">[</code>build-app : mvn-goals<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------
<code class="o">[</code>build-app : mvn-goals<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Total time:  <code class="m">03</code>:18 min
<code class="o">[</code>build-app : mvn-goals<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> Finished at: <code class="m">2022</code>-08-18T10:31:00Z
<code class="o">[</code>build-app : mvn-goals<code class="o">]</code> <code class="o">[</code>INFO<code class="o">]</code> ------------------------------------------------------------------------
<code class="o">[</code>build-push-image : build<code class="o">]</code> STEP <code class="m">1</code>/2: FROM registry.access.redhat.com/ubi8/openjdk-11
<code class="o">[</code>build-push-image : build<code class="o">]</code> Trying to pull registry.access.redhat.com/ubi8/openjdk-11:latest...
<code class="o">[</code>build-push-image : build<code class="o">]</code> Getting image <code class="nb">source</code> signatures
<code class="o">[</code>build-push-image : build<code class="o">]</code> Checking <code class="k">if</code> image destination supports signatures
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying blob sha256:e441d34134fac91baa79be3e2bb8fb3dba71ba5c1ea012cb5daeb7180a054687
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying blob sha256:1e09a5ee0038fbe06a18e7f355188bbabc387467144abcd435f7544fef395aa1
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying blob sha256:0d725b91398ed3db11249808d89e688e62e511bbd4a2e875ed8493ce1febdb2c
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying blob sha256:e441d34134fac91baa79be3e2bb8fb3dba71ba5c1ea012cb5daeb7180a054687
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying blob sha256:1e09a5ee0038fbe06a18e7f355188bbabc387467144abcd435f7544fef395aa1
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying blob sha256:0d725b91398ed3db11249808d89e688e62e511bbd4a2e875ed8493ce1febdb2c
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying config sha256:0c308464b19eaa9a01c3fdd6b63a043c160d4eea85e461bbbb7d01d168f6d993
<code class="o">[</code>build-push-image : build<code class="o">]</code> Writing manifest to image destination
<code class="o">[</code>build-push-image : build<code class="o">]</code> Storing signatures
<code class="o">[</code>build-push-image : build<code class="o">]</code> STEP <code class="m">2</code>/2: COPY target/quarkus-app /deployments/
<code class="o">[</code>build-push-image : build<code class="o">]</code> COMMIT quay.io/gitops-cookbook/tekton-greeter:latest
<code class="o">[</code>build-push-image : build<code class="o">]</code> --&gt; c07e36a8e61
<code class="o">[</code>build-push-image : build<code class="o">]</code> Successfully tagged quay.io/gitops-cookbook/tekton-greeter:latest
<code class="o">[</code>build-push-image : build<code class="o">]</code> c07e36a8e6104d2e5c7d79a6cd34cd7b44eb093c39ef6c1487a37d7bd2305b8a
<code class="o">[</code>build-push-image : build<code class="o">]</code> Getting image <code class="nb">source</code> signatures
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying blob sha256:7853a7797845542e3825d4f305e4784ea7bf492cd4364fc93b9afba3ac0c9553
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying blob sha256:8e0e04b5c700a86f4a112f41e7e767a9d7c539fe3391611313bf76edb07eeab1
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying blob sha256:647a854c512bad44709221b6b0973e884f29bcb5a380ee32e95bfb0189b620e6
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying blob sha256:69c55192bed92cbb669c88eb3c36449b64ac93ae466abfff2a575273ce05a39e
<code class="o">[</code>build-push-image : build<code class="o">]</code> Copying config sha256:c07e36a8e6104d2e5c7d79a6cd34cd7b44eb093c39ef6c1487a37d7bd2305b8a
<code class="o">[</code>build-push-image : build<code class="o">]</code> Writing manifest to image destination
<code class="o">[</code>build-push-image : build<code class="o">]</code> Storing signatures
<code class="o">[</code>build-push-image : build<code class="o">]</code> sha256:12dd3deb6305b9e125309b68418d0bb81f805e0fe7ac93942dc94764aee9f492quay.io/gitops-cookbook/tekton-greeter:latest
<code class="o">[</code>deploy : kubectl<code class="o">]</code> deployment.apps/tekton-greeter created</pre>
<div data-type="tip"><h6>Tip</h6>
<p>You can use the <a data-primary="Tekton Dashboard component" data-secondary="displaying running Tasks" data-type="indexterm" id="idm45120830162720"/><a data-primary="Tasks (Tekton)" data-secondary="displaying running" data-type="indexterm" id="idm45120830161744"/>Tekton Dashboard to create and visualize your running Tasks and Pipelines as shown <a data-primary="Pipelines (Tekton)" data-secondary="applications, deploying to Kubernetes" data-startref="pip_app_deploy" data-type="indexterm" id="idm45120830142912"/><a data-primary="Tekton" data-secondary="Pipelines" data-startref="Tek_pipe_K" data-tertiary="deploying applications to Kubernetes" data-type="indexterm" id="idm45120830141680"/><a data-primary="Tasks (Tekton)" data-secondary="Pipelines" data-startref="Task_pipe_K" data-tertiary="deploying applications to Kubernetes" data-type="indexterm" id="idm45120830140176"/><a data-primary="applications" data-secondary="deployment" data-startref="pipe_deploy_K" data-tertiary="Tekton Pipelines" data-type="indexterm" id="idm45120830138672"/><a data-primary="Kubernetes" data-secondary="applications" data-startref="K_pipe_deploy" data-tertiary="Tekton Pipelines" data-type="indexterm" id="idm45120830105104"/>in <a data-type="xref" href="#fig6-7a">Figure 6-8</a>.</p>
</div>
<figure><div class="figure" id="fig6-7a">
<img alt="Tekton Dashboard Pipelineruns" height="935" src="assets/gocb_0608.png" width="1904"/>
<h6><span class="label">Figure 6-8. </span>Tekton Dashboard TaskRuns</h6>
</div></figure>
</div></section>
<section class="less_space pagebreak-before" data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120831998432">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/bnUiR">Tekton Catalog</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="6.8 Using Tekton Triggers to Compile and Package an Application Automatically When a Change Occurs on Git" data-type="sect1"><div class="sect1" id="recipe_6_8">
<h1>6.8 Using Tekton Triggers to Compile and Package an Application Automatically When a Change Occurs on Git</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120830096704">
<h2>Problem</h2>
<p>You want to automate your CI/CD Pipelines when <a data-primary="Tekton Triggers component" data-secondary="applications" data-tertiary="compiling automatically" data-type="indexterm" id="TekTriggers_app_compauto"/><a data-primary="Tekton Triggers component" data-secondary="applications" data-tertiary="packaging automatically" data-type="indexterm" id="TekTriggers_app_packauto"/><a data-primary="applications" data-secondary="compiling" data-tertiary="Tekton Triggers" data-type="indexterm" id="app_comp_TekTrig"/><a data-primary="applications" data-secondary="packaging" data-tertiary="Tekton Triggers" data-type="indexterm" id="app_pack_TekTrig"/><a data-primary="Pipelines (Tekton)" data-secondary="automating" data-type="indexterm" id="pipe_auto"/>a change on Git occurs.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120830087760">
<h2>Solution</h2>
<p><a href="https://oreil.ly/zVcfe">Tekton Triggers</a> is the Tekton component that brings automation for Tasks and Pipelines with Tekton. It is an interesting feature for a GitOps strategy for cloud native CI/CD as it supports external events from a large set of sources such as Git events (Git push or pull requests).</p>
<p>Most Git repository servers support the concept of <a data-primary="webhooks" data-type="indexterm" id="idm45120830084064"/>webhooks, calling to an external source via HTTP(S) when a change in the code repository happens. Tekton provides an API endpoint that supports receiving hooks from remote systems in order to trigger builds. By pointing the code repository’s hook at the Tekton resources, automated code/build/deploy pipelines can be achieved.</p>
<p>The installation of Tekton Triggers, which we discussed in <a data-type="xref" href="#recipe_6_1">Recipe 6.1</a>, brings a set of CRDs <a data-primary="CRDs (Cluster Resource Definitions), event handling" data-type="indexterm" id="idm45120830082048"/><a data-primary="event handling, CRDs" data-type="indexterm" id="idm45120830081248"/><a data-primary="Cluster Resource Definitions (CRDs)" data-see="CRDs (Cluster Resource Definitions)" data-type="indexterm" id="idm45120830080576"/>to manage event handling for Tasks and Pipelines. In this recipe we will use the following, as illustrated also in <a data-type="xref" href="#fig6-8">Figure 6-9</a>:</p>
<figure><div class="figure" id="fig6-8">
<img alt="Tekton Triggers" height="234" src="assets/gocb_0609.png" width="1120"/>
<h6><span class="label">Figure 6-9. </span>Tekton Triggers</h6>
</div></figure>
<dl>
<dt><code>TriggerTemplate</code></dt>
<dd>
<p>A template<a data-primary="TriggerTemplate" data-type="indexterm" id="idm45120830074688"/> for newly created resources. It supports parameters to create specific <code>PipelineRuns</code>.</p>
</dd>
<dt><code>TriggerBinding</code></dt>
<dd>
<p>Validates <a data-primary="TriggerBinding" data-type="indexterm" id="idm45120830071968"/>events and extracts payload fields.</p>
</dd>
<dt><code>EventListener</code></dt>
<dd>
<p>Connects <code>TriggerBindings</code> and <code>TriggerTemplates</code> into <a data-primary="EventListener" data-type="indexterm" id="idm45120830068576"/>an addressable endpoint (the event sink). It uses the extracted event parameters from each <code>Trigger​Bind⁠ing</code> (and any supplied static parameters) to create the resources specified in the corresponding <code>TriggerTemplate</code>. It also optionally allows an external service to preprocess the event payload via the interceptor field.</p>
</dd>
</dl>
<p>Before creating these resources, you need to set up permissions to let Tekton Triggers create Pipelines and Tasks. You can use the setup available from <a href="https://oreil.ly/fPTzU">the book’s repository</a> with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl apply <code class="se">\</code>
-f https://raw.githubusercontent.com/gitops-cookbook/chapters/main/chapters/ch06/rbac.yaml</pre>
<p>This will create <a data-primary="Tekton Triggers component" data-secondary="ServiceAccounts" data-type="indexterm" id="idm45120830056384"/><a data-primary="ServiceAccounts" data-secondary="Tekton Triggers" data-type="indexterm" id="idm45120830062608"/>a new <code>ServiceAccount</code> named <code>tekton-triggers-sa</code> that has the permissions needed to interact with the Tekton Pipelines component. As confirmation, from the previous command you should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">serviceaccount/tekton-triggers-sa created
rolebinding.rbac.authorization.k8s.io/triggers-example-eventlistener-binding configured
clusterrolebinding.rbac.authorization.k8s.io/triggers-example-eventlistener-clusterbinding configured</pre>
<p>You can now add automation to your Pipelines like the one we defined in <a data-type="xref" href="#recipe_6_7">Recipe 6.7</a> creating these three resources:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">triggers.tekton.dev/v1alpha1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TriggerTemplate</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-triggertemplate</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-revision</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-commit-message</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-repo-url</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-repo-name</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">content-type</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pusher-name</code><code class="w"/>
<code class="w">  </code><code class="nt">resourcetemplates</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w"/>
<code class="w">      </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">PipelineRun</code><code class="w"/>
<code class="w">      </code><code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="nt">tekton.dev/pipeline</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-pipeline-hub</code><code class="w"/>
<code class="w">        </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-pipeline-webhook-$(uid)</code><code class="w"/>
<code class="w">      </code><code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REPO</code><code class="w"/>
<code class="w">            </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(tt.params.git-repo-url)</code><code class="w"/>
<code class="w">          </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REF</code><code class="w"/>
<code class="w">            </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(tt.params.git-revision)</code><code class="w"/>
<code class="w">        </code><code class="nt">serviceAccountName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-triggers-example-sa</code><code class="w"/>
<code class="w">        </code><code class="nt">pipelineRef</code><code class="p">:</code><code class="w"/>
<code class="w">          </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-pipeline-hub</code><code class="w"/>
<code class="w">        </code><code class="nt">workspaces</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source</code><code class="w"/>
<code class="w">          </code><code class="nt">persistentVolumeClaim</code><code class="p">:</code><code class="w"/>
<code class="w">            </code><code class="nt">claimName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source-pvc</code><code class="w"/>
<code class="w">        </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven-settings</code><code class="w"/>
<code class="w">          </code><code class="nt">emptyDir</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/></pre>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">triggers.tekton.dev/v1alpha1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TriggerBinding</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-triggerbinding</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-repo-url</code><code class="w"/>
<code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(body.repository.clone_url)</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-revision</code><code class="w"/>
<code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(body.after)</code><code class="w"/></pre>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">triggers.tekton.dev/v1alpha1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">EventListener</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-eventlistener</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">serviceAccountName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-triggers-example-sa</code><code class="w"/>
<code class="w">  </code><code class="nt">triggers</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">bindings</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">ref</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-triggerbinding</code><code class="w"/>
<code class="w">    </code><code class="nt">template</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">ref</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-greeter-triggertemplate</code><code class="w"/></pre>
<p>You can create the resources just listed as follows:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f tekton-greeter-triggertemplate.yaml
kubectl create -f tekton-greeter-triggerbinding.yaml
kubectl create -f tekton-greeter-eventlistener.yaml</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">triggertemplate.triggers.tekton.dev/tekton-greeter-triggertemplate created
triggerbinding.triggers.tekton.dev/tekton-greeter-triggerbinding created
eventlistener.triggers.tekton.dev/tekton-greeter-eventlistener created</pre>
<p>Contextually, a new pod is created <a data-primary="EventListener" data-type="indexterm" id="idm45120829638752"/>representing the <code>EventListener</code>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">NAME                                            READY  STATUS   RESTARTS AGE
el-tekton-greeter-eventlistener-5db7b9fcf9-6nrgx  <code class="m">1</code>/1  Running  <code class="m">0</code>        10s</pre>
<p>The <code>EventListener</code> pod listens for events at a specified port, and it is bound to a Kubernetes Service:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get svc</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">NAME                              TYPE        CLUSTER-IP      EXTERNAL-IP↳
   PORT<code class="o">(</code>S<code class="o">)</code>             AGE
el-tekton-greeter-eventlistener   ClusterIP   <code class="m">10</code>.100.36.199   &lt;none&gt;     ↳
   <code class="m">8080</code>/TCP,9000/TCP   10s
...</pre>
<p>If you are running your Git server outside the  cluster (e.g., GitHub or GitLab), you need to expose the Service, for example, with an <a href="https://oreil.ly/qAUhw">Ingress</a>. Afterwards you can configure  webhooks on your Git server using the <code>EventListener</code> URL associated to your Ingress.</p>
<div data-type="tip"><h6>Tip</h6>
<p>With Minikube you can add support for Ingresses with this command: <code>minikube addons enable ingress</code>. Then you need to map a hostname for the Ingress.</p>
</div>
<p>For the purpose of this book we can just simulate the webhook as it would come from the Git server.</p>
<p>First you can map the <code>EventListener</code> Service to your local networking with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl port-forward svc/el-tekton-greeter-eventlistener <code class="m">8080</code></pre>
<p>Then you can invoke the Trigger by making an HTTP request to <em>http://localhost:8080</em> using <code>curl</code>. The HTTP request must be a POST request containing a JSON payload and it should contain the fields referenced via a <code>TriggerBinding</code>. In our case we mapped <code>body.repository.clone_url</code> and <code>body.after</code>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Check the documentation of<a data-primary="webhooks" data-secondary="parameters" data-type="indexterm" id="idm45120829455168"/> your Git server to get the list of parameters that a webhook can generate. In this example we are using the <a href="https://oreil.ly/4AUlu">GitHub Webhooks reference</a>.</p>
</div>
<p>To test Triggers, run this command:</p>
<pre data-code-language="bash" data-type="programlisting">curl -X POST <code class="se">\</code>
  http://localhost:8080 <code class="se">\</code>
  -H <code class="s1">'Content-Type: application/json'</code> <code class="se">\</code>
  -d <code class="s1">'{ "after": "d9291c456db1ce29177b77ffeaa9b71ad80a50e6", "repository": { "clone_url" : "https://github.com/gitops-cookbook/tekton-tutorial-greeter.git" } }'</code></pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting"><code class="o">{</code><code class="s2">"eventListener"</code>:<code class="s2">"tekton-greeter-eventlistener"</code>,<code class="s2">"namespace"</code>:<code class="s2">"default"</code>,<code class="s2">"eventListenerUID"</code>:<code class="s2">"c00567eb-d798-4c4a-946d-f1732fdfc313"</code>,<code class="s2">"eventID"</code>:<code class="s2">"17dd25bb-a1fe-4f84-8422-c3abc5f10066"</code><code class="o">}</code></pre>
<p>A new Pipeline now is started and you can check it with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">tkn pipelinerun ls</pre>
<p>You should see it in <code>Running</code> status as<a data-primary="Tekton Triggers component" data-secondary="applications" data-startref="TekTriggers_app_compauto" data-tertiary="compiling automatically" data-type="indexterm" id="idm45120829383600"/><a data-primary="Tekton Triggers component" data-secondary="applications" data-startref="TekTriggers_app_packauto" data-tertiary="packaging automatically" data-type="indexterm" id="idm45120829381504"/><a data-primary="applications" data-secondary="compiling" data-startref="app_comp_TekTrig" data-tertiary="Tekton Triggers" data-type="indexterm" id="idm45120829380176"/><a data-primary="applications" data-secondary="packaging" data-startref="app_pack_TekTrig" data-tertiary="Tekton Triggers" data-type="indexterm" id="idm45120829378752"/><a data-primary="Pipelines (Tekton)" data-secondary="automating" data-startref="pipe_auto" data-type="indexterm" id="idm45120829353568"/> follows:</p>
<pre data-code-language="bash" data-type="programlisting">tekton-greeter-pipeline-3244b67f-31d3-4597-af1c-3c1aa6693719   <code class="m">4</code> seconds ago   ---        Running</pre>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120829346464">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/Xr0ne">Tekton Triggers examples</a></p>
</li>
<li>
<p><a href="https://oreil.ly/gqKyz">Getting Started with Tekton Triggers</a></p>
</li>
<li>
<p><a href="https://oreil.ly/iIbXc">Securing webhooks with event listeners</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="6.9 Update a Kubernetes Resource Using Kustomize and Push the Change to Git" data-type="sect1"><div class="sect1" id="rec_Kustomize">
<h1>6.9 Update a Kubernetes Resource Using Kustomize and Push the Change to Git</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120829326176">
<h2>Problem</h2>
<p>You want to use Kustomize in your Tekton Pipelines in order to automate Kubernetes manifests <a data-primary="Kustomize" data-secondary="Kubernetes manifests, automatic updates" data-type="indexterm" id="Kust_Kmanifest_autoup"/><a data-primary="Kubernetes" data-secondary="manifests" data-tertiary="automatic updates" data-type="indexterm" id="K_manifest_autoup"/><a data-primary="manifests" data-secondary="updating automatically" data-type="indexterm" id="mani_updat_auto"/><a data-primary="Pipelines (Tekton)" data-secondary="manifests, automatic updates" data-type="indexterm" id="pipe_mani_autoup"/><a data-primary="Tekton" data-secondary="Kubernetes manifests, automatic updates" data-type="indexterm" id="Tek_Kmani_autoup"/>updates.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120829301584">
<h2>Solution</h2>
<p>As we discussed in <a data-type="xref" href="ch04.xhtml#ch_Kustomize">Chapter 4</a>, Kustomize is a powerful tool to manage Kubernetes manifests. Kustomize can add, remove, or patch configuration options without forking. In <a data-type="xref" href="ch04.xhtml#recipe_4_2">Recipe 4.2</a> you saw how to update a <a data-primary="deployment" data-secondary="Kubernetes, updating with Tekton using Kustomize" data-type="indexterm" id="deploy_K_Tek_Kust"/>Kubernetes Deployment with a new container image hash using the <code>kustomize</code> CLI.</p>
<p>In this recipe, you’ll see how to let Tekton update it using Kustomize. This is very useful for GitOps as it allows an automated update on Git to the manifests describing an application running on Kubernetes, favoring the interconnection with a GitOps tool such as Argo CD in order to sync resources (see <a data-type="xref" href="ch07.xhtml#ch_Argo_CD">Chapter 7</a>).</p>
<p>When adopting the GitOps approach, it’s common to have one or more repositories for the Kubernetes manifests and then one or more repositories for the apps as well.</p>
<p>Thus let’s introduce a Task <a data-primary="Tasks (Tekton)" data-secondary="container image references, updating" data-type="indexterm" id="Task_contimg_updat"/><a data-primary="container images" data-secondary="references, updating" data-type="indexterm" id="contimg_ref_updat"/>that accepts the Kubernetes manifests repository as a parameter and can update the container image reference as seen in <a data-type="xref" href="ch04.xhtml#recipe_4_2">Recipe 4.2</a>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w"/>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Task</code><code class="w"/>
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">tekton.dev/pipelines.minVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.12.1</code><code class="w"/>
<code class="w">    </code><code class="nt">tekton.dev/tags</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git</code><code class="w"/>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-update-deployment</code><code class="w"/>
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="nt">app.kubernetes.io/version</code><code class="p">:</code><code class="w"> </code><code class="s">'0.2'</code><code class="w"/>
<code class="w">    </code><code class="nt">operator.tekton.dev/provider-type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">community</code><code class="w"/>
<code class="nt">spec</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">&gt;-</code><code class="w"/>
<code class="w">    </code><code class="no">This Task can be used to update image digest in a Git repo using kustomize.</code><code class="w"/>
<code class="w">    </code><code class="no">It requires a secret with credentials for accessing the git repo.</code><code class="w"/>
<code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REPOSITORY</code><code class="w"/>
<code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REF</code><code class="w"/>
<code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">NEW_IMAGE</code><code class="w"/>
<code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">NEW_DIGEST</code><code class="w"/>
<code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">KUSTOMIZATION_PATH</code><code class="w"/>
<code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w"/>
<code class="w">  </code><code class="nt">results</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">The commit SHA</code><code class="w"/>
<code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">commit</code><code class="w"/>
<code class="w">  </code><code class="nt">steps</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="s">'docker.io/alpine/git:v2.26.2'</code><code class="w"/>
<code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-clone</code><code class="w"/>
<code class="w">      </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/>
<code class="w">      </code><code class="nt">script</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">&gt;</code><code class="w"/>
<code class="w">        </code><code class="no">rm -rf git-update-digest-workdir</code><code class="w"/>

<code class="w">        </code><code class="no">git clone $(params.GIT_REPOSITORY) -b $(params.GIT_REF)</code><code class="w"/>
<code class="w">        </code><code class="no">git-update-digest-workdir</code><code class="w"/>
<code class="w">      </code><code class="nt">workingDir</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(workspaces.workspace.path)</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="s">'quay.io/wpernath/kustomize-ubi:latest'</code><code class="w"/>
<code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">update-digest</code><code class="w"/>
<code class="w">      </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/>
<code class="w">      </code><code class="nt">script</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">&gt;</code><code class="w"/>
<code class="w">        </code><code class="no">cd git-update-digest-workdir/$(params.KUSTOMIZATION_PATH)</code><code class="w"/>

<code class="w">        </code><code class="no">kustomize edit set image $(params.NEW_IMAGE)@$(params.NEW_DIGEST)</code><code class="w"/>


<code class="w">        </code><code class="no">echo "##########################"</code><code class="w"/>

<code class="w">        </code><code class="no">echo "### kustomization.yaml ###"</code><code class="w"/>

<code class="w">        </code><code class="no">echo "##########################"</code><code class="w"/>

<code class="w">        </code><code class="no">cat kustomization.yaml</code><code class="w"/>
<code class="w">      </code><code class="nt">workingDir</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(workspaces.workspace.path)</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="s">'docker.io/alpine/git:v2.26.2'</code><code class="w"/>
<code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-commit</code><code class="w"/>
<code class="w">      </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">{}</code><code class="w"/>
<code class="w">      </code><code class="nt">script</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w"/>
<code class="w">        </code><code class="no">cd git-update-digest-workdir</code><code class="w"/>

<code class="w">        </code><code class="no">git config user.email "tektonbot@redhat.com"</code><code class="w"/>
<code class="w">        </code><code class="no">git config user.name "My Tekton Bot"</code><code class="w"/>

<code class="w">        </code><code class="no">git status</code><code class="w"/>
<code class="w">        </code><code class="no">git add $(params.KUSTOMIZATION_PATH)/kustomization.yaml</code><code class="w"/>
<code class="w">        </code><code class="no">git commit -m "[ci] Image digest updated"</code><code class="w"/>

<code class="w">        </code><code class="no">git push</code><code class="w"/>

<code class="w">        </code><code class="no">RESULT_SHA="$(git rev-parse HEAD | tr -d '\n')"</code><code class="w"/>
<code class="w">        </code><code class="no">EXIT_CODE="$?"</code><code class="w"/>
<code class="w">        </code><code class="no">if [ "$EXIT_CODE" != 0 ]</code><code class="w"/>
<code class="w">        </code><code class="no">then</code><code class="w"/>
<code class="w">          </code><code class="no">exit $EXIT_CODE</code><code class="w"/>
<code class="w">        </code><code class="no">fi</code><code class="w"/>
<code class="w">        </code><code class="no"># Make sure we don't add a trailing newline to the result!</code><code class="w"/>
<code class="w">        </code><code class="no">echo -n "$RESULT_SHA" &gt; $(results.commit.path)</code><code class="w"/>
<code class="w">      </code><code class="nt">workingDir</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(workspaces.workspace.path)</code><code class="w"/>
<code class="w">  </code><code class="nt">workspaces</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">description</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">The workspace consisting of maven project.</code><code class="w"/>
<code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">workspace</code><code class="w"/></pre>
<p>This Task is composed of three steps:</p>
<dl>
<dt><code>git-clone</code></dt>
<dd>
<p>Clones the <a data-primary="git-clone" data-type="indexterm" id="idm45120829131584"/>Kubernetes manifests repository</p>
</dd>
<dt><code>update-digest</code></dt>
<dd>
<p>Runs <code>kustomize</code><a data-primary="update-digest" data-type="indexterm" id="idm45120829128992"/> to update the Kubernetes Deployment with a container image hash given as a parameter</p>
</dd>
<dt><code>git-commit</code></dt>
<dd>
<p>Updates the Kubernetes <a data-primary="git-commit" data-type="indexterm" id="idm45120829018688"/>manifest repo with the new <a data-primary="Tasks (Tekton)" data-secondary="container image references, updating" data-startref="Task_contimg_updat" data-type="indexterm" id="idm45120829017776"/><a data-primary="container images" data-secondary="references, updating" data-startref="contimg_ref_updat" data-type="indexterm" id="idm45120829016496"/>container image hash</p>
</dd>
</dl>
<p>You can create the Task with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f git-update-deployment-task.yaml</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">task.tekton.dev/git-update-deployment created</pre>
<p>You can now add this <a data-primary="Tasks (Tekton)" data-secondary="Pipelines" data-tertiary="adding to" data-type="indexterm" id="idm45120829011344"/><a data-primary="Pipelines (Tekton)" data-secondary="Tasks, adding" data-type="indexterm" id="idm45120829005296"/>Task to a Pipeline similar to the one you saw in <a data-type="xref" href="#recipe_6_7">Recipe 6.7</a> in order to automate the update of your manifests with Kustomize:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pipeline</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman-pipeline</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://github.com/gitops-cookbook/pacman-kikd.git</code><code class="w">
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REPO</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">master</code><code class="w">
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REVISION</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">quay.io/gitops-cookbook/pacman-kikd</code><code class="w">
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">DESTINATION_IMAGE</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">.</code><code class="w">
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CONTEXT_DIR</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">https://github.com/gitops-cookbook/pacman-kikd-manifests.git</code><code class="s">'</code><code class="w">
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CONFIG_GIT_REPO</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">default</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w">
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CONFIG_GIT_REVISION</code><code class="w">
</code><code class="w">    </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">string</code><code class="w">
</code><code class="w">  </code><code class="nt">tasks</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">fetch-repo</code><code class="w">
</code><code class="w">    </code><code class="nt">params</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">url</code><code class="w">
</code><code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.GIT_REPO)</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">revision</code><code class="w">
</code><code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.GIT_REVISION)</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">deleteExisting</code><code class="w">
</code><code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">true</code><code class="s">"</code><code class="w">
</code><code class="w">    </code><code class="nt">taskRef</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-clone</code><code class="w">
</code><code class="w">    </code><code class="nt">workspaces</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">output</code><code class="w">
</code><code class="w">      </code><code class="nt">workspace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-app</code><code class="w">
</code><code class="w">    </code><code class="nt">taskRef</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven</code><code class="w">
</code><code class="w">    </code><code class="nt">params</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GOALS</code><code class="w">
</code><code class="w">        </code><code class="nt">value</code><code class="p">:</code><code class="w">
</code><code class="w">          </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">-DskipTests</code><code class="w">
</code><code class="w">          </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">clean</code><code class="w">
</code><code class="w">          </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">package</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">CONTEXT_DIR</code><code class="w">
</code><code class="w">        </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">$(params.CONTEXT_DIR)</code><code class="s">"</code><code class="w">
</code><code class="w">    </code><code class="nt">workspaces</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven-settings</code><code class="w">
</code><code class="w">        </code><code class="nt">workspace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven-settings</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">source</code><code class="w">
</code><code class="w">        </code><code class="nt">workspace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source</code><code class="w">
</code><code class="w">    </code><code class="nt">runAfter</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">fetch-repo</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-push-image</code><code class="w">
</code><code class="w">    </code><code class="nt">taskRef</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">buildah</code><code class="w">
</code><code class="w">    </code><code class="nt">params</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">IMAGE</code><code class="w">
</code><code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="s">"</code><code class="s">$(params.DESTINATION_IMAGE)</code><code class="s">"</code><code class="w">
</code><code class="w">    </code><code class="nt">workspaces</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">source</code><code class="w">
</code><code class="w">        </code><code class="nt">workspace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source</code><code class="w">
</code><code class="w">    </code><code class="nt">runAfter</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">build-app</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-update-deployment</code><code class="w">
</code><code class="w">    </code><code class="nt">params</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REPOSITORY</code><code class="w">
</code><code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.CONFIG_GIT_REPO)</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">NEW_IMAGE</code><code class="w">
</code><code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.DESTINATION_IMAGE)</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">NEW_DIGEST</code><code class="w">
</code><code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(tasks.build-push-image.results.IMAGE_DIGEST)</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO10-1" id="co_cloud_native_ci_cd_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">KUSTOMIZATION_PATH</code><code class="w">
</code><code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">env/dev</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">GIT_REF</code><code class="w">
</code><code class="w">      </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">$(params.CONFIG_GIT_REVISION)</code><code class="w">
</code><code class="w">    </code><code class="nt">runAfter</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">build-push-image</code><code class="w">
</code><code class="w">    </code><code class="nt">taskRef</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Task</code><code class="w">
</code><code class="w">      </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">git-update-deployment</code><code class="w">
</code><code class="w">    </code><code class="nt">workspaces</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">workspace</code><code class="w">
</code><code class="w">      </code><code class="nt">workspace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source</code><code class="w">
</code><code class="w">  </code><code class="nt">workspaces</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">app-source</code><code class="w">
</code><code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven-settings</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO10-1" id="callout_cloud_native_ci_cd_CO10-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>As you can see from this example, you can take a <a data-primary="Tasks (Tekton)" data-secondary="results as input for succeeding Tasks" data-type="indexterm" id="idm45120827507920"/>result of a previous Task as an input for the following one. In this case the hash of the container image generated by the <code>build-push-image</code> Task is used to update the manifests with Kustomize.</p></dd>
</dl>
<p>You can create the Pipeline with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f pacman-pipeline.yaml</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">pipeline.tekton.dev/pacman-pipeline created</pre>
<p>The <code>git-commit</code> step requires authentication to your Git server in order to push the updates to the repo. Since this example is on GitHub, we are using a GitHub Personal Access Token (see <a data-type="xref" href="#recipe_6_4">Recipe 6.4</a>) attached to the <code>ServiceAccount</code> <code>tekton-bot-sa</code>.</p>
<p class="less_space pagebreak-before">Make sure to add the repo and registry’s Kubernetes Secrets as described in Recipes <a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_6_4">6.4</a> and
<a data-type="xref" data-xrefstyle="select:labelnumber" href="#recipe_6_5">6.5</a>:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl patch serviceaccount tekton-bot-sa -p <code class="s1">'{"secrets": [{"name": "git-secret"}]}'</code>
kubectl patch serviceaccount tekton-bot-sa <code class="se">\</code>
 -p <code class="s1">'{"secrets": [{"name": "containerregistry-</code>
<code class="s1">secret"}]}'</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Make sure you have created a PVC for the Pipeline as defined in <a data-type="xref" href="#recipe_6_7">Recipe 6.7</a>.</p>
</div>
<p>Now you can start the Pipeline as <a data-primary="Kustomize" data-secondary="Kubernetes manifests, automatic updates" data-startref="Kust_Kmanifest_autoup" data-type="indexterm" id="idm45120828103472"/><a data-primary="Kubernetes" data-secondary="manifests" data-startref="K_manifest_autoup" data-tertiary="automatic updates" data-type="indexterm" id="idm45120828102288"/><a data-primary="manifests" data-secondary="updating automatically" data-startref="mani_updat_auto" data-type="indexterm" id="idm45120828150272"/><a data-primary="Pipelines (Tekton)" data-secondary="manifests, automatic updates" data-startref="pipe_mani_autoup" data-type="indexterm" id="idm45120828149056"/><a data-primary="Tekton" data-secondary="Kubernetes manifests, automatic updates" data-startref="Tek_Kmani_autoup" data-type="indexterm" id="idm45120828147872"/><a data-primary="deployment" data-secondary="Kubernetes, updating with Tekton using Kustomize" data-startref="deploy_K_Tek_Kust" data-type="indexterm" id="idm45120828146688"/>follows:</p>
<pre data-code-language="bash" data-type="programlisting">tkn pipeline start pacman-pipeline <code class="se">\</code>
  --serviceaccount<code class="o">=</code><code class="s1">'tekton-bot-sa'</code> <code class="se">\</code>
  --param <code class="nv">GIT_REPO</code><code class="o">=</code><code class="s1">'https://github.com/gitops-cookbook/pacman-kikd.git'</code> <code class="se">\</code>
  --param <code class="nv">GIT_REVISION</code><code class="o">=</code><code class="s1">'main'</code> <code class="se">\</code>
  --param <code class="nv">DESTINATION_IMAGE</code><code class="o">=</code><code class="s1">'quay.io/gitops-cookbook/pacman-kikd:latest'</code> <code class="se">\</code>
  --param <code class="nv">CONFIG_GIT_REPO</code><code class="o">=</code><code class="s1">'https://github.com/gitops-cookbook/pacman-kikd-manifests.git'</code> <code class="se">\</code>
  --param <code class="nv">CONFIG_GIT_REVISION</code><code class="o">=</code><code class="s1">'main'</code> <code class="se">\</code>
  --workspace <code class="nv">name</code><code class="o">=</code>app-source,claimName<code class="o">=</code>app-source-pvc <code class="se">\</code>
  --workspace <code class="nv">name</code><code class="o">=</code>maven-settings,emptyDir<code class="o">=</code><code class="s2">""</code> <code class="se">\</code>
  --use-param-defaults <code class="se">\</code>
  --showlog</pre>
</div></section>
</div></section>
<section data-pdf-bookmark="6.10 Update a Kubernetes Resource Using Helm and Create a Pull Request" data-type="sect1"><div class="sect1" id="rec_Helm">
<h1>6.10 Update a Kubernetes Resource Using Helm and Create a Pull Request</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120828271760">
<h2>Problem</h2>
<p>You want to<a data-primary="Helm" data-secondary="applications, updating with Tekton Pipeline" data-type="indexterm" id="Helm_app_updatTekPipe"/><a data-primary="applications" data-secondary="Helm-packaged, updating with Tekton Pipeline" data-type="indexterm" id="app_Helm_updatTekPipe"/><a data-primary="Tekton" data-secondary="Pipelines" data-tertiary="updating Helm-packaged applications" data-type="indexterm" id="Tek_Pipe_updatHelmapp"/><a data-primary="Pipelines (Tekton)" data-secondary="Helm-packaged applications, updating" data-type="indexterm" id="Pipe_Helmapp_updat"/> automate the deployment of Helm-packaged apps with a Tekton 
<span class="keep-together">Pipeline</span>.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120828228528">
<h2>Solution</h2>
<p>In <a data-type="xref" href="ch05.xhtml#ch_Helm">Chapter 5</a> we discussed Helm and how it can be used to manage applications on Kubernetes in a convenient way. In this recipe you’ll see how to automate Helm-powered deployments through a Pipeline in order to install or update an application running on Kubernetes.</p>
<p>As shown in <a data-type="xref" href="#recipe_6_7">Recipe 6.7</a>, you can use <a data-primary="Tekton Hub" data-secondary="Tasks, Helm support" data-type="indexterm" id="idm45120828224336"/>Tekton Hub to find and install Tekton Tasks. In fact, you can use the <a href="https://oreil.ly/oR6GU"><code>helm-upgrade-from-repo</code></a> Task <a data-primary="helm-upgrade-from-repo Task" data-type="indexterm" id="idm45120828222416"/>to have Helm support for your Pipelines.</p>
<p>To install it, run this command:</p>
<pre data-code-language="bash" data-type="programlisting">tkn hub install task helm-upgrade-from-repo</pre>
<p>This Task can <a data-primary="Tasks (Tekton)" data-secondary="Helm Charts, installing from Helm repository" data-type="indexterm" id="idm45120828219904"/><a data-primary="Charts" data-secondary="Helm repositories, installing from" data-type="indexterm" id="idm45120828198208"/>install a Helm Chart from a Helm repository. For this example, we provide a Helm repository in <a href="https://oreil.ly/lroxo">this book’s repository</a> that you can add with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">helm repo add gitops-cookbook https://gitops-cookbook.github.io/helm-charts/</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting"><code class="s2">"gitops-cookbook"</code> has been added to your repositories</pre>
<p>You can install the Helm Chart with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">helm install pacman gitops-cookbook/pacman</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">NAME: pacman
LAST DEPLOYED: Mon Aug <code class="m">15</code> <code class="m">17</code>:02:21 <code class="m">2022</code>
NAMESPACE: default
STATUS: deployed
REVISION: <code class="m">1</code>
TEST SUITE: None
USER-SUPPLIED VALUES:
<code class="o">{}</code></pre>
<p>The app should be now deployed and running on Kubernetes:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl get pods -l<code class="o">=</code>app.kubernetes.io/name<code class="o">=</code>pacman</pre>
<p>You should get the following output:</p>
<pre data-code-language="bash" data-type="programlisting">NAME                      READY   STATUS    RESTARTS   AGE
pacman-6798d65d84-9mt8p   <code class="m">1</code>/1     Running   <code class="m">0</code>          30s</pre>
<p>Now let’s update<a data-primary="deployment" data-secondary="updating" data-tertiary="with Tekton TaskRun" data-tertiary-sortas="Tekton TaskRun" data-type="indexterm" id="idm45120827445232"/> the Deployment with a Tekton Task running a <code>helm upgrade</code> with the following <code>TaskRun</code>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton.dev/v1beta1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">TaskRun</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">generateName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">helm-pacman-run-</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">serviceAccountName</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">tekton-deployer-sa</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO11-1" id="co_cloud_native_ci_cd_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">taskRef</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">helm-upgrade-from-repo</code><code class="w">
</code><code class="w">  </code><code class="nt">params</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">helm_repo</code><code class="w">
</code><code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://gitops-cookbook.github.io/helm-charts/</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">chart_name</code><code class="w">
</code><code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">gitops-cookbook/pacman</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">release_version</code><code class="w">
</code><code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">0.1.0</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">release_name</code><code class="w">
</code><code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">overwrite_values</code><code class="w">
</code><code class="w">    </code><code class="nt">value</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">replicaCount=2</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO11-2" id="co_cloud_native_ci_cd_CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO11-1" id="callout_cloud_native_ci_cd_CO11-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>The <code>helm-upgrade-from-repo</code> Task needs permission to list objects in the working namespace, so you need a <code>ServiceAccount</code> with special permissions as seen in <a data-type="xref" href="#recipe_6_6">Recipe 6.6</a>.</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO11-2" id="callout_cloud_native_ci_cd_CO11-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>You can override values in the Chart’s <em>values.yaml</em> file by adding them in this param. Here we are setting up two replicas for the Pac-Man game.</p></dd>
</dl>
<p>Run the Task with the following command:</p>
<pre data-code-language="bash" data-type="programlisting">kubectl create -f helm-pacman-taskrun.yaml</pre>
<p>You should get output similar to the following:</p>
<pre data-code-language="bash" data-type="programlisting">taskrun.tekton.dev/helm-pacman-run-qghx8 created</pre>
<p>Check logs with <code>tkn</code> CLI and select the running Task:</p>
<pre data-code-language="bash" data-type="programlisting">tkn taskrun logs -f</pre>
<p>You should get output similar to the following, where you can see the Helm upgrade has been successfully<a data-primary="Helm" data-secondary="applications, updating with Tekton Pipeline" data-startref="Helm_app_updatTekPipe" data-type="indexterm" id="idm45120828013024"/><a data-primary="applications" data-secondary="Helm-packaged, updating with Tekton Pipeline" data-startref="app_Helm_updatTekPipe" data-type="indexterm" id="idm45120827995888"/><a data-primary="Tekton" data-secondary="Pipelines" data-startref="Tek_Pipe_updatHelmapp" data-tertiary="updating Helm-packaged applications" data-type="indexterm" id="idm45120827994800"/><a data-primary="Pipelines (Tekton)" data-secondary="Helm-packaged applications, updating" data-startref="Pipe_Helmapp_updat" data-type="indexterm" id="idm45120828024224"/> performed:</p>
<pre data-code-language="bash" data-type="programlisting"><code class="o">[</code>upgrade-from-repo<code class="o">]</code> current installed helm releases
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> NAME        NAMESPACE       REVISION        UPDATED                                         STATUS          CHART           APP VERSION
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> pacman      default         <code class="m">1</code>               <code class="m">2022</code>-08-15 <code class="m">17</code>:02:21.633934129 +0200 +0200       deployed        pacman-0.1.0    <code class="m">1</code>.0.0
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> parsing helms repo name...
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> adding helm repo...
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> <code class="s2">"gitops-cookbook"</code> has been added to your repositories
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> adding updating repo...
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> Hang tight <code class="k">while</code> we grab the latest from your chart repositories...
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> ...Successfully got an update from the <code class="s2">"gitops-cookbook"</code> chart repository
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> Update Complete. ⎈Happy Helming!⎈
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> installing helm chart...
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> history.go:56: <code class="o">[</code>debug<code class="o">]</code> getting <code class="nb">history</code> <code class="k">for</code> release pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> upgrade.go:123: <code class="o">[</code>debug<code class="o">]</code> preparing upgrade <code class="k">for</code> pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> upgrade.go:131: <code class="o">[</code>debug<code class="o">]</code> performing update <code class="k">for</code> pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> upgrade.go:303: <code class="o">[</code>debug<code class="o">]</code> creating upgraded release <code class="k">for</code> pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> client.go:203: <code class="o">[</code>debug<code class="o">]</code> checking <code class="m">2</code> resources <code class="k">for</code> changes
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> client.go:466: <code class="o">[</code>debug<code class="o">]</code> Looks like there are no changes <code class="k">for</code> Service <code class="s2">"pacman"</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> wait.go:47: <code class="o">[</code>debug<code class="o">]</code> beginning <code class="nb">wait</code> <code class="k">for</code> <code class="m">2</code> resources with timeout of 5m0s
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> ready.go:277: <code class="o">[</code>debug<code class="o">]</code> Deployment is not ready: default/pacman. <code class="m">1</code> out of <code class="m">2</code> expected pods are ready
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> ready.go:277: <code class="o">[</code>debug<code class="o">]</code> Deployment is not ready: default/pacman. <code class="m">1</code> out of <code class="m">2</code> expected pods are ready
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> ready.go:277: <code class="o">[</code>debug<code class="o">]</code> Deployment is not ready: default/pacman. <code class="m">1</code> out of <code class="m">2</code> expected pods are ready
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> upgrade.go:138: <code class="o">[</code>debug<code class="o">]</code> updating status <code class="k">for</code> upgraded release <code class="k">for</code> pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> Release <code class="s2">"pacman"</code> has been upgraded. Happy Helming!
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> NAME: pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> LAST DEPLOYED: Mon Aug <code class="m">15</code> <code class="m">15</code>:23:31 <code class="m">2022</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> NAMESPACE: default
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> STATUS: deployed
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> REVISION: <code class="m">2</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> TEST SUITE: None
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> USER-SUPPLIED VALUES:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> replicaCount: <code class="m">2</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> COMPUTED VALUES:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> image:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   containerPort: <code class="m">8080</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   pullPolicy: Always
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   repository: quay.io/gitops-cookbook/pacman-kikd
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   tag: <code class="m">1</code>.0.0
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> replicaCount: <code class="m">2</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> securityContext: <code class="o">{}</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> HOOKS:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> MANIFEST:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> ---
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> <code class="c1"># Source: pacman/templates/service.yaml</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> apiVersion: v1
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> kind: Service
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> metadata:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   labels:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>     app.kubernetes.io/name: pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   name: pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> spec:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   ports:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>     - name: http
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>       port: <code class="m">8080</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>       targetPort: <code class="m">8080</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   selector:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>     app.kubernetes.io/name: pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> ---
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> <code class="c1"># Source: pacman/templates/deployment.yaml</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> apiVersion: apps/v1
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> kind: Deployment
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> metadata:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   name: pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   labels:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>     app.kubernetes.io/name: pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>     app.kubernetes.io/version: <code class="s2">"1.0.0"</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code> spec:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   replicas: <code class="m">2</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   selector:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>     matchLabels:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>       app.kubernetes.io/name: pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>   template:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>     metadata:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>       labels:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>         app.kubernetes.io/name: pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>     spec:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>       containers:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>           - image: <code class="s2">"quay.io/gitops-cookbook/pacman-kikd:1.0.0"</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>             imagePullPolicy: Always
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>             securityContext:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>               <code class="o">{}</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>             name: pacman
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>             ports:
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>               - containerPort: <code class="m">8080</code>
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>                 name: http
<code class="o">[</code>upgrade-from-repo<code class="o">]</code>                 protocol: TCP
<code class="o">[</code>upgrade-from-repo<code class="o">]</code></pre>
<pre data-code-language="bash" data-type="programlisting">kubectl get deploy -l<code class="o">=</code>app.kubernetes.io/name<code class="o">=</code>pacman</pre>
<pre data-code-language="bash" data-type="programlisting">pacman              <code class="m">2</code>/2     <code class="m">2</code>            <code class="m">2</code>           9s</pre>
</div></section>
</div></section>
<section data-pdf-bookmark="6.11 Use Drone to Create a Pipeline for Kubernetes" data-type="sect1"><div class="sect1" id="rec_Drone">
<h1>6.11 Use Drone to Create a Pipeline for Kubernetes</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120828406656">
<h2>Problem</h2>
<p>You want to <a data-primary="pipeline, creating for Kubernetes with Drone" data-type="indexterm" id="pipe_K_Drone"/><a data-primary="Kubernetes" data-secondary="pipelines, creating with Drone" data-type="indexterm" id="K_pipe_Drone"/><a data-primary="Drone" data-secondary="Kubernetes pipelines, creating" data-type="indexterm" id="Drone_Kpip_creat"/>create a CI/CD pipeline for Kubernetes with Drone.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120828398880">
<h2>Solution</h2>
<p><a href="https://www.drone.io">Drone</a> is an open source project for cloud native <a data-primary="CI (continuous integration)" data-secondary="Drone" data-type="indexterm" id="idm45120828376832"/>continuous integration (CI). It uses YAML build files to define and execute build pipelines inside containers.</p>
<p>It has two main <a data-primary="Drone" data-secondary="components" data-type="indexterm" id="idm45120828375248"/><a data-primary="Server (Drone)" data-type="indexterm" id="idm45120828374240"/><a data-primary="Runner (Drone)" data-type="indexterm" id="idm45120828373568"/>components:</p>
<dl>
<dt>Server</dt>
<dd>
<p>Integrates with popular SCMs such as GitHub, GitLab, or Gitea</p>
</dd>
<dt>Runner</dt>
<dd>
<p>Acts as an agent running on a certain platform</p>
</dd>
</dl>
<p>You can install the Server of your choice following the <a href="https://oreil.ly/K1ZR2">documentation</a> and install the <a href="https://oreil.ly/3vydl">Kubernetes Runner</a>.</p>
<p>In this example you will create a Java Maven-based pipeline using the Pac-Man app. First, install the <a data-primary="Drone" data-secondary="installing" data-type="indexterm" id="idm45120828350848"/>Drone CLI for your OS; you can get it from the official website <a href="https://oreil.ly/cdI9Y">here</a>.</p>
<div data-type="tip"><h6>Tip</h6>
<p>On macOS, <code>drone</code> is available through <a href="https://brew.sh">Homebrew</a> as follows:</p>
<pre data-type="programlisting">brew tap drone/drone &amp;&amp; brew install drone</pre>
</div>
<p>Then configure <a data-primary="Drone" data-secondary="configuring" data-type="indexterm" id="idm45120828345616"/>Drone, copy the <code>DRONE_TOKEN</code> from your instance under the Drone Account settings page, then create/update the file called <em>.envrc.local</em> and add the variables to override:</p>
<pre data-code-language="bash" data-type="programlisting"><code class="nb">export</code> <code class="nv">DRONE_TOKEN</code><code class="o">=</code><code class="s2">"&lt;YOUR-TOKEN&gt;"</code></pre>
<p>Ensure the token is loaded:</p>
<pre data-code-language="bash" data-type="programlisting">drone info</pre>
<p>Now activate the <a data-primary="Drone" data-secondary="repositories, activating" data-type="indexterm" id="idm45120828328672"/><a data-primary="repositories" data-secondary="activating in Drone" data-type="indexterm" id="idm45120828302096"/>repo in Drone:</p>
<pre data-code-language="bash" data-type="programlisting">drone repo <code class="nb">enable</code> https://github.com/gitops-cookbook/pacman-kikd.git</pre>
<p>Similarly to Tekton, Drone’s pipeline will compile, test, and build the app. Then it will create and push the container image to a registry.</p>
<p>Add credentials to your container registry <a data-primary="container registry" data-secondary="credentials, adding" data-type="indexterm" id="idm45120828308800"/><a data-primary="credentials" data-secondary="container registries, adding" data-type="indexterm" id="idm45120828340864"/>as follows (here, we’re<a data-primary="secrets" data-secondary="Drone, adding to container registries" data-type="indexterm" id="idm45120828339888"/> using Quay.io):</p>
<pre data-code-language="bash" data-type="programlisting">drone secret add --name image_registry <code class="se">\</code>
--data quay.io https://github.com/gitops-cookbook/pacman-kikd.git

drone secret add --name image_registry_user <code class="se">\</code>
--data YOUR_REGISTRY_USER https://github.com/gitops-cookbook/pacman-kikd.git

drone secret add --name image_registry_password <code class="se">\</code>
--data YOUR_REGISTRY_PASS https://github.com/gitops-cookbook/pacman-kikd.git

drone secret add --name destination_image <code class="se">\</code>
--data quay.io/YOUR_REGISTRY_USER&gt;/pacman-kikd.git https://github.com/gitops-cookbook/pacman-kikd.git</pre>
<p>Create a file <a data-primary="drone.yaml, creating" data-type="indexterm" id="idm45120828712560"/>called <em>.drone.yaml</em> as follows:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pipeline</code><code class="w"/>
<code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">docker</code><code class="w"/>
<code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">java-pipeline</code><code class="w"/>
<code class="nt">platform</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">os</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">linux</code><code class="w"/>
<code class="w">  </code><code class="nt">arch</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">arm64</code><code class="w"/>
<code class="nt">trigger</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">branch</code><code class="p">:</code><code class="w"/>
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">main</code><code class="w"/>
<code class="nt">clone</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="nt">disable</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>
<code class="nt">steps</code><code class="p">:</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">clone sources</code><code class="w"/>
<code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">alpine/git</code><code class="w"/>
<code class="w">    </code><code class="nt">pull</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">if-not-exists</code><code class="w"/>
<code class="w">    </code><code class="nt">commands</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">git clone https://github.com/gitops-cookbook/pacman-kikd.git .</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">git checkout $DRONE_COMMIT</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven-build</code><code class="w"/>
<code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven:3-jdk-11</code><code class="w"/>
<code class="w">    </code><code class="nt">commands</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">mvn install -DskipTests=true -B</code><code class="w"/>
<code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">mvn test -B</code><code class="w"/>
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">publish</code><code class="w"/>
<code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">plugins/docker:20.13</code><code class="w"/>
<code class="w">    </code><code class="nt">pull</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">if-not-exists</code><code class="w"/>
<code class="w">    </code><code class="nt">settings</code><code class="p">:</code><code class="w"/>
<code class="w">      </code><code class="nt">tags</code><code class="p">:</code><code class="w"> </code><code class="s">"latest"</code><code class="w"/>
<code class="w">      </code><code class="nt">dockerfile</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Dockerfile</code><code class="w"/>
<code class="w">      </code><code class="nt">insecure</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">true</code><code class="w"/>
<code class="w">      </code><code class="nt">mtu</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1400</code><code class="w"/>
<code class="w">      </code><code class="nt">username</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">from_secret</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">image_registry_user</code><code class="w"/>
<code class="w">      </code><code class="nt">password</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">from_secret</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">image_registry_password</code><code class="w"/>
<code class="w">      </code><code class="nt">registry</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">from_secret</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">image_registry</code><code class="w"/>
<code class="w">      </code><code class="nt">repo</code><code class="p">:</code><code class="w"/>
<code class="w">        </code><code class="nt">from_secret</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">destination_image</code><code class="w"/></pre>
<p>Start the pipeline:</p>
<pre data-code-language="bash" data-type="programlisting">drone <code class="nb">exec</code> --pipeline<code class="o">=</code>java-pipeline</pre>
<div data-type="tip"><h6>Tip</h6>
<p>You can also trigger the pipeline to start by pushing to your<a data-primary="pipeline, creating for Kubernetes with Drone" data-startref="pipe_K_Drone" data-type="indexterm" id="idm45120828568720"/><a data-primary="Kubernetes" data-secondary="pipelines, creating with Drone" data-startref="K_pipe_Drone" data-type="indexterm" id="idm45120828567984"/><a data-primary="Drone" data-secondary="Kubernetes pipelines, creating" data-startref="Drone_Kpip_creat" data-type="indexterm" id="idm45120828554464"/> Git repo.</p>
</div>
</div></section>
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120828378496">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/YzWcx">Example Maven Pipeline from Drone docs</a></p>
</li>
<li>
<p><a href="https://oreil.ly/eVT1T">Complete Quarkus pipeline example in Drone</a></p>
</li>
</ul>
</div></section>
</div></section>
<section data-pdf-bookmark="6.12 Use GitHub Actions for CI" data-type="sect1"><div class="sect1" id="rec_GitHub_Actions">
<h1>6.12 Use GitHub Actions for CI</h1>
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="idm45120828571824">
<h2>Problem</h2>
<p>You want to use <a data-primary="applications" data-secondary="compiling" data-tertiary="GitHub Actions" data-type="indexterm" id="app_comp_GH"/><a data-primary="applications" data-secondary="packaging" data-tertiary="GitHub Actions" data-type="indexterm" id="app_pack_GH"/><a data-primary="CI/CD (continuous integration/continuous delivery)" data-secondary="GitHub Actions" data-tertiary="compiling applications" data-type="indexterm" id="CICD_GH_compapp"/><a data-primary="CI/CD (continuous integration/continuous delivery)" data-secondary="GitHub Actions" data-tertiary="packaging applications" data-type="indexterm" id="CICD_GH_packapp"/><a data-primary="GitHub Actions" data-secondary="applications" data-tertiary="compiling" data-type="indexterm" id="GHA_app_comp"/><a data-primary="GitHub Actions" data-secondary="applications" data-tertiary="packaging" data-type="indexterm" id="GHA_app_pack"/>GitHub Actions for CI in order to compile and package an app as a container image ready to be deployed in CD.</p>
</div></section>
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="idm45120826822896">
<h2>Solution</h2>
<p><a href="https://oreil.ly/hCOUp">GitHub Actions</a> are event-driven automation tasks available for any GitHub <a data-primary="repositories" data-secondary="GitHub Actions" data-type="indexterm" id="idm45120826820832"/>repository. An event automatically triggers the workflow, which contains a job. The job then uses steps to control the order in which actions are run. These actions are the commands that automate software building, testing, and deployment.</p>
<p>In this recipe, you will add a GitHub Action for building the Pac-Man game container image, and pushing it to the <a href="https://oreil.ly/Bzq7l">GitHub Container Registry</a>.</p>
<div data-type="tip"><h6>Tip</h6>
<p>As GitHub Actions are connected to repositories, you can fork the Pac-Man repository from this book’s code repositories to add your GitHub Actions. See the documentation about <a href="https://oreil.ly/O6HtM">forking repositories</a> for more info on this topic.</p>
</div>
<p>GitHub Actions workflows run into <a href="https://oreil.ly/uXOQ7">environments</a> and they can reference an environment to use the environment’s protection rules and secrets.</p>
<p>Workflows and jobs<a data-primary="GitHub Actions" data-secondary="workflow" data-type="indexterm" id="idm45120826815232"/> are defined with a YAML file containing all the needed steps. Inside your repository, you can create one with the path <code>.github/workflows/pacman-ci-action.yml</code>:</p>
<pre data-code-language="yaml" data-type="programlisting"><code class="c1"># This is a basic workflow to help you get started with Actions</code><code class="w">

</code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman-ci-action</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO12-1" id="co_cloud_native_ci_cd_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">

</code><code class="nt">env</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO12-2" id="co_cloud_native_ci_cd_CO12-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">IMAGE_REGISTRY</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ghcr.io/${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">github.repository_owner</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}</code><code class="w">
</code><code class="w">  </code><code class="nt">REGISTRY_USER</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">github.actor</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}</code><code class="w">
</code><code class="w">  </code><code class="nt">REGISTRY_PASSWORD</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">github.token</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}</code><code class="w">
</code><code class="w">  </code><code class="nt">APP_NAME</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">pacman</code><code class="w">
</code><code class="w">  </code><code class="nt">IMAGE_TAGS</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">1.0.0</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">github.sha</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}</code><code class="w">

</code><code class="c1"># Controls when the workflow will run</code><code class="w">
</code><code class="nt">on</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="c1"># Triggers the workflow on push or pull request events but only for the</code><code class="w">
</code><code class="w">  </code><code class="c1"># "main" branch</code><code class="w">
</code><code class="w">  </code><code class="nt">push</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO12-3" id="co_cloud_native_ci_cd_CO12-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">branches</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="w"> </code><code class="s">"</code><code class="s">main</code><code class="s">"</code><code class="w"> </code><code class="p-Indicator">]</code><code class="w">
</code><code class="w">  </code><code class="nt">pull_request</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">branches</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="w"> </code><code class="s">"</code><code class="s">main</code><code class="s">"</code><code class="w"> </code><code class="p-Indicator">]</code><code class="w">

</code><code class="w">  </code><code class="c1"># Allows you to run this workflow manually from the Actions tab</code><code class="w">
</code><code class="w">  </code><code class="nt">workflow_dispatch</code><code class="p">:</code><code class="w">

</code><code class="c1"># A workflow run is made up of one or more jobs that can run sequentially or in</code><code class="w">
</code><code class="c1"># parallel</code><code class="w">
</code><code class="nt">jobs</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="c1"># This workflow contains a single job called "build-and-push"</code><code class="w">
</code><code class="w">  </code><code class="nt">build-and-push</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO12-4" id="co_cloud_native_ci_cd_CO12-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="c1"># The type of runner that the job will run on</code><code class="w">
</code><code class="w">    </code><code class="nt">runs-on</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ubuntu-latest</code><code class="w">

</code><code class="w">    </code><code class="c1"># Steps represent a sequence of tasks that will be executed as part of the</code><code class="w">
</code><code class="w">    </code><code class="c1"># job</code><code class="w">
</code><code class="w">    </code><code class="nt">steps</code><code class="p">:</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO12-5" id="co_cloud_native_ci_cd_CO12-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="c1"># Checks-out your repository under $GITHUB_WORKSPACE, so your job can</code><code class="w">
</code><code class="w">      </code><code class="c1"># access it</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">uses</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">actions/checkout@v3</code><code class="w">

</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Set</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">up</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">JDK</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">11</code><code class="w">
</code><code class="w">        </code><code class="nt">uses</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">actions/setup-java@v3</code><code class="w">
</code><code class="w">        </code><code class="nt">with</code><code class="p">:</code><code class="w">
</code><code class="w">          </code><code class="nt">java-version</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">11</code><code class="s">'</code><code class="w">
</code><code class="w">          </code><code class="nt">distribution</code><code class="p">:</code><code class="w"> </code><code class="s">'</code><code class="s">adopt</code><code class="s">'</code><code class="w">
</code><code class="w">          </code><code class="nt">cache</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">maven</code><code class="w">

</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Build</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">with</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Maven</code><code class="w">
</code><code class="w">        </code><code class="nt">run</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">mvn</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">--batch-mode</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">package</code><code class="w">

</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Buildah</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Action</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO12-6" id="co_cloud_native_ci_cd_CO12-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a><code class="w">
</code><code class="w">        </code><code class="nt">id</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">build-image</code><code class="w">
</code><code class="w">        </code><code class="nt">uses</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">redhat-actions/buildah-build@v2</code><code class="w">
</code><code class="w">        </code><code class="nt">with</code><code class="p">:</code><code class="w">
</code><code class="w">          </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">env.IMAGE_REGISTRY</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}/${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">env.APP_NAME</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}</code><code class="w">
</code><code class="w">          </code><code class="nt">tags</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">env.IMAGE_TAGS</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}</code><code class="w">
</code><code class="w">          </code><code class="nt">containerfiles</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">|</code><code class="w">
</code><code class="w">            </code><code class="no">./Dockerfile</code><code class="w">
</code><code class="w">      </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Push</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">to</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">Registry</code><code class="w"> </code><a class="co" href="#callout_cloud_native_ci_cd_CO12-7" id="co_cloud_native_ci_cd_CO12-7"><img alt="7" height="12" src="assets/7.png" width="12"/></a><code class="w">
</code><code class="w">        </code><code class="nt">id</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">push-to-registry</code><code class="w">
</code><code class="w">        </code><code class="nt">uses</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">redhat-actions/push-to-registry@v2</code><code class="w">
</code><code class="w">        </code><code class="nt">with</code><code class="p">:</code><code class="w">
</code><code class="w">          </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">steps.build-image.outputs.image</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}</code><code class="w">
</code><code class="w">          </code><code class="nt">tags</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">steps.build-image.outputs.tags</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}</code><code class="w">
</code><code class="w">          </code><code class="nt">registry</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">env.IMAGE_REGISTRY</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}</code><code class="w">
</code><code class="w">          </code><code class="nt">username</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">env.REGISTRY_USER</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}</code><code class="w">
</code><code class="w">          </code><code class="nt">password</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">${{</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">env.REGISTRY_PASSWORD</code><code class="l-Scalar-Plain"> </code><code class="l-Scalar-Plain">}}</code></pre>
<dl class="calloutlist">
<dt><a class="co" href="#co_cloud_native_ci_cd_CO12-1" id="callout_cloud_native_ci_cd_CO12-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Name of the Action.</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO12-2" id="callout_cloud_native_ci_cd_CO12-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Environment variables to be used in the workflow. This includes <a href="https://oreil.ly/qNE6p">default environment variables</a> and the Secret you added to the 
<span class="keep-together">environment</span>.</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO12-3" id="callout_cloud_native_ci_cd_CO12-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Here’s where you define which type of trigger you want for this workflow. In this case, any change to the repository (Push) to the <code>master</code> branch will trigger the action to start. Check out the documentation for a <a href="https://oreil.ly/lGgAE">full list of triggers</a> that can be used.</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO12-4" id="callout_cloud_native_ci_cd_CO12-4"><img alt="4" height="12" src="assets/4.png" width="12"/></a></dt>
<dd><p>Name of this Job.</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO12-5" id="callout_cloud_native_ci_cd_CO12-5"><img alt="5" height="12" src="assets/5.png" width="12"/></a></dt>
<dd><p>List of steps; each step contains an action for the pipeline.</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO12-6" id="callout_cloud_native_ci_cd_CO12-6"><img alt="6" height="12" src="assets/6.png" width="12"/></a></dt>
<dd><p><a href="https://oreil.ly/IcyGC">Buildah Build</a>. This action builds container images using Buildah.</p></dd>
<dt><a class="co" href="#co_cloud_native_ci_cd_CO12-7" id="callout_cloud_native_ci_cd_CO12-7"><img alt="7" height="12" src="assets/7.png" width="12"/></a></dt>
<dd><p><a href="https://oreil.ly/HcSUl">Push to Registry</a>. This action is used to push to the GitHub Registry using built-in credentials available for GitHub repository owners.</p></dd>
</dl>
<p>After each Git push or pull request, a new run of the action is performed as shown in <a data-type="xref" href="#fig6-8a">Figure 6-10</a>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>GitHub offers <a data-primary="GitHub" data-secondary="container registry" data-type="indexterm" id="idm45120826445952"/><a data-primary="container registry" data-secondary="GitHub" data-type="indexterm" id="idm45120826444944"/>its own container registry available at ghcr.io, and container images are referenced as part of the <a href="https://oreil.ly/aPNi5">GitHub Packages</a>. By default the images are public. See this <a href="https://oreil.ly/EG1zx">book’s repository</a> as a <a data-primary="applications" data-secondary="compiling" data-startref="app_comp_GH" data-tertiary="GitHub Actions" data-type="indexterm" id="idm45120826442416"/><a data-primary="applications" data-secondary="packaging" data-startref="app_pack_GH" data-tertiary="GitHub Actions" data-type="indexterm" id="idm45120826440864"/><a data-primary="CI/CD (continuous integration/continuous delivery)" data-secondary="GitHub Actions" data-startref="CICD_GH_compapp" data-tertiary="compiling applications" data-type="indexterm" id="idm45120826345568"/><a data-primary="CI/CD (continuous integration/continuous delivery)" data-secondary="GitHub Actions" data-startref="CICD_GH_packapp" data-tertiary="packaging applications" data-type="indexterm" id="idm45120826344240"/><a data-primary="GitHub Actions" data-secondary="applications" data-startref="GHA_app_comp" data-tertiary="compiling" data-type="indexterm" id="idm45120826342912"/><a data-primary="GitHub Actions" data-secondary="applications" data-startref="GHA_app_pack" data-tertiary="packaging" data-type="indexterm" id="idm45120826341584"/>reference.</p>
</div>
<figure><div class="figure" id="fig6-8a">
<img alt="GitHub Actions Environments" height="866" src="assets/gocb_0610.png" width="1334"/>
<h6><span class="label">Figure 6-10. </span>GitHub Actions Jobs</h6>
</div></figure>
</div></section>
<section class="less_space pagebreak-before" data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="idm45120826822304">
<h2>See Also</h2>
<ul>
<li>
<p><a href="https://oreil.ly/44Qt8">GitHub Actions Jobs</a></p>
</li>
<li>
<p><a href="https://oreil.ly/hFcCd">Red Hat Actions</a></p>
</li>
<li>
<p><a href="https://oreil.ly/7PaeU">Deploy to Kubernetes cluster Action</a></p>
</li>
</ul>
</div></section>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45120836250416"><sup><a href="ch06.xhtml#idm45120836250416-marker">1</a></sup> See the <a href="https://oreil.ly/NxpqN">Tekton documentation</a>.</p></div></div></section></div></body></html>