<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 3. GitOps: Git as the Source of Truth&#10;      "><div class="chapter" id="gitops_git_as_the_source_of_truth">
      <h1><span class="label">Chapter 3. </span>GitOps: Git as the Source of Truth
      </h1>
      <p>In this chapter, we’ll focus on GitOps, a critical part of Azure Arc enabled Kubernetes. GitOps may be a new concept, so we’ll take time to define and unpack what it is, how it works, and how you use it with Azure Arc enabled Kubernetes. </p>
      <section data-type="sect1" data-pdf-bookmark="What Is GitOps?"><div class="sect1" id="what_is_gitops">
        <h1>What Is GitOps?</h1>
        <p>GitOps is a term coined by Weaveworks in an August 2017 <a href="https://oreil.ly/eYIzF">blog post</a>. It’s an operating model pattern for cloud-native applications storing application and declarative infrastructure code in Git as the source of truth. It’s used for automated continuous delivery. Weaveworks used the GitOps operating model pattern with their Kubernetes environments. </p>
        <p>Within Git, there is code that describes the state of your system, including apps, config, dashboards, monitoring, etc. Within GitOps, there is also software (an operator) that ensures that the state of your cloud-native live environments matches the desired state described in Git. At the time of this writing, the majority of operators, such as Flux and ArgoCD, are designed for use with Kubernetes; GitOps <span class="keep-together">is not</span> limited to Kubernetes, however. For example, there is a <span class="keep-together"><a href="https://oreil.ly/CzEP9">Terraform</a></span> GitOps framework called Kubestack. The Git repository you plan to use with a Flux or ArgoCD operator can contain Kubernetes manifests in YAML format. These manifests should describe valid Kubernetes objects, such as namespaces, <span class="keep-together">ConfigMaps</span>, Secrets, Deployments, Pods, Services, Ingress, <span class="keep-together">DaemonSets</span>, and so on. The Git repository can also contain Helm Charts for <span class="keep-together">applications</span>. </p>
        <p>The principles of GitOps include: </p>
        <dl>
          <dt>
            Declarative configuration
          </dt>
          <dd>
            <p>System state is described declaratively. </p>
          </dd>
          <dt>
            Version controlled, immutable storage
          </dt>
          <dd>
            <p>Git is the source of truth; the desired system state is versioned <span class="keep-together">in Git.</span> </p>
          </dd>
          <dt>
            Automated delivery
          </dt>
          <dd>
            <p>Git is the single place for operations (<code>create</code>, <code>change</code>, <code>delete</code>) performed by autonomous agents.</p>
          </dd>
          <dt>
            Autonomous agents
          </dt>
          <dd>
            <p>Software known as operators enforce the desired state and alert on drift.</p>
          </dd>
          <dt>
            Closed loop
          </dt>
          <dd>
            <p>Delivery of approved system state changes is automated.</p>
          </dd>
        </dl>
        <p>For a deeper dive into GitOps, I recommend starting with the <a href="https://oreil.ly/NR62h">“GitOps: Operations by Pull Request”</a> blog post. </p>
      </div></section>
      <section data-type="sect1" data-pdf-bookmark="How Azure Arc Utilizes GitOps"><div class="sect1" id="how_azure_arc_utilizes_gitops">
        <h1>How Azure Arc Utilizes GitOps</h1>
        <p>Azure Arc enabled Kubernetes utilizes GitOps to cover two things: first, configuration of Kubernetes, and second, deployment of applications to Kubernetes. Configuration can include objects such as namespaces, ConfigMaps, Secrets, Ingress Controllers, Ingress, and more. Applications can be things such as Deployments, Pods, Services, and Helm Charts. </p>
        <p>Azure Arc enabled Kubernetes leverages Flux, an open source GitOps operator. Flux was built by Weaveworks and is part of the CNCF Sandbox project. </p>
        <p>GitOps in Azure Arc enabled Kubernetes is a connection between a Kubernetes cluster and a Git repository through a Flux operator running on the Kubernetes cluster as a Pod. This Flux operator is used to sync Kubernetes cluster configuration and configuration with the desired state in the Git repository with the goal of matching the two through <code>create</code>, <code>change</code>, and <code>delete</code> operations. </p>
        <p>This sync is accomplished with the Flux operator via a pull-based approach where Flux will continuously poll the Git repository for anything new and enact any creation or updates to the Kubernetes cluster. The Flux operator also has the ability to continuously poll a container registry or Helm repository for additions or changes needed in the Kubernetes cluster. </p>
        <p>The Azure Arc enabled Kubernetes cluster and Git repository <span class="keep-together">connection</span> lives in ARM as an extension resource named <span class=""><em>Microsoft.KubernetesConfiguration/sourceControlConfigurations</em></span>. This is stored in an Azure Cosmos DB database encrypted at rest. We can either set up this configuration via the Azure portal or through Azure CLI. The <code>sourceControlConfiguration</code> properties consist of:</p>
        <ul>
          <li>
            <p>Configuration name</p>
          </li>
          <li>
            <p>Operator instance name </p>
          </li>
          <li>
            <p>Operator namespace </p>
          </li>
          <li>
            <p>Repository URL</p>
          </li>
          <li>
            <p>Operator scope (namespace/cluster)</p>
          </li>
          <li>
            <p>Operator type</p>
          </li>
          <li>
            <p>Operator params</p>
          </li>
          <li>
            <p>Helm (enabled/disabled)</p>
          </li>
        </ul>
        <p>For each Azure Arc enabled Kubernetes cluster, you can have multiple <code>sourceControlConfigurations</code>, which can be scoped to namespaces. This helps in multienvironment and multitenancy scenarios. </p>
        <p>GitOps can also be used with Azure Arc enabled Kubernetes to manage configuration of large amounts of Kubernetes clusters at scale. This is accomplished by using Azure Policy to apply required <code>sourceControlConfigurations</code> on projected Kubernetes clusters as soon as they’re onboarded into Azure Arc. You may use this if <span class="keep-together">you want</span> to apply the same configurations across multiple Kubernetes clusters, such as a Service Mesh, monitoring Agents, Ingress <span class="keep-together">Controllers</span>, etc. </p>
      </div></section>
    </div></section></div></body></html>