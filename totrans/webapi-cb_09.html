<html><head></head><body><section data-pdf-bookmark="Chapter 9. The Web Speech API" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_webSpeechAPI">&#13;
<h1><span class="label">Chapter 9. </span>The Web Speech API</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Introduction" data-type="sect1"><div class="sect1" id="id119">&#13;
<h1>Introduction</h1>&#13;
&#13;
<p><a data-primary="Web Speech API" data-type="indexterm" id="ix_09-web-speech-api-asciidoc0"/>In <a data-primary="Web Speech API" data-secondary="basics" data-type="indexterm" id="ix_09-web-speech-api-asciidoc1"/>the age of smart devices and assistants, your voice has become another commonly used input method. Whether you’re dictating a text message or asking for tomorrow’s weather forecast, speech recognition and synthesis are becoming useful tools in app development. With the Web Speech API, you can make your app speak or listen for a user’s voice input.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Speech Recognition" data-type="sect2"><div class="sect2" id="id120">&#13;
<h2>Speech Recognition</h2>&#13;
&#13;
<p><a data-primary="speech recognition" data-type="indexterm" id="id975"/><a data-primary="Web Speech API" data-secondary="speech recognition" data-type="indexterm" id="id976"/>The Web Speech API brings speech <em>recognition</em> to the browser. Once the user gives you permission to use the microphone, it listens for speech. When it recognizes a series of words, it triggers an event with the recognized content.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Speech recognition may not be supported by all browsers yet. See <a href="https://oreil.ly/SGLlc">CanIUse</a> for the latest compatibility data.</p>&#13;
</div>&#13;
&#13;
<p>You’ll need the user’s permission before you can start listening for speech. Due to privacy settings, the first time you attempt to listen, the user is prompted to grant your app permission to use the microphone (see <a data-type="xref" href="#microphonePermission">Figure 9-1</a>).</p>&#13;
&#13;
<figure class="width-45"><div class="figure" id="microphonePermission">&#13;
<img alt="A microphone permission request in Chrome" src="assets/wacb_0901.png"/>&#13;
<h6><span class="label">Figure 9-1. </span>A microphone permission request in Chrome</h6>&#13;
</div></figure>&#13;
&#13;
<p>Some browsers, such as Chrome, use an external server for analyzing the captured audio to recognize speech. This means speech recognition won’t work when you’re offline, and it might also raise privacy concerns.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id977">&#13;
<h1>Speech Recognition Versus Language Processing</h1>&#13;
<p><a data-primary="language processing, speech recognition versus" data-type="indexterm" id="id978"/><a data-primary="natural language processing (NLP), speech recognition versus" data-type="indexterm" id="id979"/><a data-primary="NLP (natural language processing), speech recognition versus" data-type="indexterm" id="id980"/><a data-primary="speech recognition" data-secondary="language processing versus" data-type="indexterm" id="id981"/><a data-primary="Web Speech API" data-secondary="speech recognition versus language processing" data-type="indexterm" id="id982"/>It’s important to distinguish between speech recognition (determining what words were spoken) and language processing (understanding what those words mean). The Web Speech API, on its own, does not give any meaning to the recognized words; it returns them to you as a string and it’s up to you to do any additional processing. You can integrate this data with third-party natural language processing (NLP) APIs such as Microsoft LUIS or IBM Watson NLP. These APIs and services are beyond the scope of this book.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Speech Synthesis" data-type="sect2"><div class="sect2" id="id121">&#13;
<h2>Speech Synthesis</h2>&#13;
&#13;
<p><a data-primary="speech synthesis" data-type="indexterm" id="id983"/><a data-primary="Web Speech API" data-secondary="synthesizing speech" data-type="indexterm" id="id984"/>The Web Speech API also provides speech <em>synthesis</em>. Given some text, it can create a synthesized voice that speaks the text. The browser has a set of built-in voices that it can use to speak your content. Once you have selected a voice appropriate for the target language, you can customize the voice’s pitch and speaking rate.</p>&#13;
&#13;
<p>You can combine speech recognition and synthesis to create conversational voice user interfaces. They can listen for a question or command and speak the output or &#13;
<span class="keep-together">feedback.</span></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Browser Support" data-type="sect2"><div class="sect2" id="id122">&#13;
<h2>Browser Support</h2>&#13;
&#13;
<p><a data-primary="Web Speech API" data-secondary="browser support" data-type="indexterm" id="id985"/>At the time of writing, support for the Web Speech API is somewhat limited.</p>&#13;
&#13;
<p>The specification for this API also adds a few other pieces that enhance speech recognition and synthesis once they are supported in browsers.</p>&#13;
&#13;
<p><a data-primary="custom grammar" data-type="indexterm" id="id986"/>The first of these is custom grammar, which lets you fine-tune speech recognition by specifying words and phrases that you want to recognize. For example, if you were designing a calculator with voice commands, your custom grammar would include digits (“one,” “two,” etc.) and calculator operations (“plus,” “minus,” etc.). Using a custom grammar helps guide the speech recognition engine to capture the words your application is looking for.</p>&#13;
&#13;
<p><a data-primary="Speech Synthesis Markup Language (SSML)" data-type="indexterm" id="id987"/>The SpeechSynthesis API supports Speech Synthesis Markup Language (SSML). SSML is an XML language that customizes speech synthesis. You can switch between male and female voices or specify that the browser should read something letter by letter. At the time of writing, SSML markup is parsed and understood—the engine won’t speak the markup tags—but browsers currently ignore most instructions<a data-startref="ix_09-web-speech-api-asciidoc1" data-type="indexterm" id="id988"/>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Adding Dictation to a Text Field" data-type="sect1"><div class="sect1" id="id506">&#13;
<h1>Adding Dictation to a Text Field</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id123">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="dictation, adding to text field" data-type="indexterm" id="ix_09-web-speech-api-asciidoc2"/><a data-primary="SpeechRecognition interface" data-type="indexterm" id="ix_09-web-speech-api-asciidoc3"/><a data-primary="text fields" data-secondary="adding dictation to" data-type="indexterm" id="ix_09-web-speech-api-asciidoc4"/><a data-primary="Web Speech API" data-secondary="adding dictation to a text field" data-type="indexterm" id="ix_09-web-speech-api-asciidoc5"/>You want to recognize spoken text and add it to a text field’s content, allowing the user to dictate the text field’s contents.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id507">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the <code>SpeechRecognition</code> interface to listen for speech. When speech is recognized, extract the recognized text and append it to the text field (see <a data-type="xref" href="#example9-1">Example 9-1</a>).</p>&#13;
<div data-type="example" id="example9-1">&#13;
<h5><span class="label">Example 9-1. </span>Adding basic dictation to a text field</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Starts listening for speech. When speech is recognized, it is appended</code>&#13;
<code class="cm"> * to the given text field's value.</code>&#13;
<code class="cm"> * Recognition continues until the returned recognition object is stopped.</code>&#13;
<code class="cm"> *</code>&#13;
<code class="cm"> * @param textField A text field to append to</code>&#13;
<code class="cm"> * @returns The recognition object</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">startDictation</code><code class="p">(</code><code class="nx">textField</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="c1">// Only proceed if this browser supports speech recognition.</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="s1">'webkitSpeechRecognition'</code> <code class="k">in</code> <code class="nb">window</code> <code class="o">||</code> <code class="s1">'SpeechRecognition'</code> <code class="k">in</code> <code class="nb">window</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">SpeechRecognition</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">SpeechRecognition</code>&#13;
    <code class="o">||</code> <code class="nb">window</code><code class="p">.</code><code class="nx">webkitSpeechRecognition</code><code class="p">;</code>&#13;
    <code class="kr">const</code> <code class="nx">recognition</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">SpeechRecognition</code><code class="p">();</code>&#13;
    <code class="nx">recognition</code><code class="p">.</code><code class="nx">continuous</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>&#13;
&#13;
    <code class="nx">recognition</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'result'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="kr">const</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">results</code><code class="p">[</code><code class="nx">event</code><code class="p">.</code><code class="nx">resultIndex</code><code class="p">];</code>&#13;
      <code class="nx">textField</code><code class="p">.</code><code class="nx">value</code> <code class="o">+=</code> <code class="nx">result</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">transcript</code><code class="p">;</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="nx">recognition</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="nx">event</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="nx">recognition</code><code class="p">.</code><code class="nx">start</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// Return the recognition object so recognition</code>&#13;
    <code class="c1">// can be stopped later (like when the user clicks a toggle button).</code>&#13;
    <code class="k">return</code> <code class="nx">recognition</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id124">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>At the time of writing, in the WebKit browsers that support it, the <code>SpeechRecognition</code> constructor is prefixed as <code>webkitSpeechRecognition</code>. In unsupported browsers, neither <code>SpeechRecognition</code> nor <code>webkitSpeechRecognition</code> are defined, so it’s important to check the browser support before continuing.</p>&#13;
&#13;
<p>To future-proof the code, the example checks for either the prefixed version (<code>webkitSpeechRecognition</code>) as well as the standard <code>SpeechRecognition</code> version. This way, you won’t have to change the code to accommodate browsers that implement the API in the future.</p>&#13;
&#13;
<p>Next, the <code>startDictation</code> function creates a <code>SpeechRecognition</code> object and sets its <code>continuous</code> flag to <code>true</code>. By default, no further recognition is performed once a result is recognized. Setting the <code>continuous</code> flag tells the speech recognition engine to continue listening and to deliver additional results.</p>&#13;
&#13;
<p>When the recognition engine recognizes some speech, it triggers a <code>result</code> event. This event has a <code>results</code> property that is an array-like object (actually a <code>SpeechRecognitionResultList</code> object) containing the results.</p>&#13;
&#13;
<p>When operating in continuous mode, as this example does, the <code>results</code> list contains all results that the recognition engine recognized. The first time the user speaks and some speech is recognized, this has a single result. When the user speaks again and the browser recognizes some more words, there are <em>two</em> results—the original result and the new one that was just recognized. If you set <code>continuous</code> to <code>false</code> (the default), the engine only recognizes one phrase, then no further <code>result</code> events are triggered.</p>&#13;
&#13;
<p>Helpfully, the event also has a <code>resultIndex</code> property that points to the index within the list of the new result that triggered this event.</p>&#13;
&#13;
<p>The result object is another array-like object (a <code>SpeechRecognitionAlternative</code> object). When you create a <code>SpeechRecognition</code> object, you can give it the property &#13;
<span class="keep-together"><code>maxAlternatives</code>.</span> The browser presents a list of possible matches for the recognized speech, each with a confidence value. However, the default <code>maxAlternatives</code> value is 1, so this dictation code only ever has one <code>SpeechRecognitionAlternative</code> object in the list.</p>&#13;
&#13;
<p>Finally, this object has a <code>transcript</code> property that is the actual phrase that the engine recognized. You can take this value and append it to the text field’s current value.</p>&#13;
&#13;
<p>Calling <code>start</code> on the recognition object begins listening for speech, emitting events when it hears something. The <code>startDictation</code> function then returns the recognition object, so that you can stop recognition once the user is finished dictating.</p>&#13;
&#13;
<p>Like with any API, it’s also important to handle any errors that occur. With speech recognition, some common errors you might face are:</p>&#13;
<dl>&#13;
<dt>Permission error</dt>&#13;
<dd>&#13;
<p>If the user did not grant permission to use the microphone. The event has an <code>error</code> property of <code>not-allowed</code>.</p>&#13;
</dd>&#13;
<dt>Network error</dt>&#13;
<dd>&#13;
<p>If the browser couldn’t reach the speech recognition service. This has an <code>error</code> of <code>network</code>.</p>&#13;
</dd>&#13;
<dt>Hardware error</dt>&#13;
<dd>&#13;
<p>If the browser was unable to access the microphone. This has an error code of &#13;
<span class="keep-together"><code>audio-capture</code>.</span><a data-startref="ix_09-web-speech-api-asciidoc5" data-type="indexterm" id="id989"/><a data-startref="ix_09-web-speech-api-asciidoc4" data-type="indexterm" id="id990"/><a data-startref="ix_09-web-speech-api-asciidoc3" data-type="indexterm" id="id991"/><a data-startref="ix_09-web-speech-api-asciidoc2" data-type="indexterm" id="id992"/></p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a Promise Helper for Speech Recognition" data-type="sect1"><div class="sect1" id="id508">&#13;
<h1>Creating a Promise Helper for Speech Recognition</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id290">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="Promises" data-secondary="creating a Promise helper for speech recognition" data-type="indexterm" id="ix_09-web-speech-api-asciidoc6"/><a data-primary="speech recognition" data-secondary="creating a Promise helper" data-type="indexterm" id="ix_09-web-speech-api-asciidoc7"/><a data-primary="Web Speech API" data-secondary="creating a Promise helper for speech recognition" data-type="indexterm" id="ix_09-web-speech-api-asciidoc8"/>You want to encapsulate speech recognition into a single function call.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id509">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Wrap the speech recognition call in a new <code>Promise</code> inside a helper function. Within the helper function, create a new <code>SpeechRecognition</code> object and listen for speech. You can resolve the <code>Promise</code> when the browser recognizes some speech (see <a data-type="xref" href="#code_promiseHelper">Example 9-2</a>).</p>&#13;
<div data-type="example" id="code_promiseHelper">&#13;
<h5><span class="label">Example 9-2. </span>A <code>Promise</code> helper for speech recognition</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="cm">/**</code>&#13;
<code class="cm"> * Listens for speech and performs speech recognition.</code>&#13;
<code class="cm"> * Assumes that speech recognition is available in the current browser.</code>&#13;
<code class="cm"> * @returns a Promise that is resolved with the recognized transcript when speech</code>&#13;
<code class="cm"> * is recognized, and rejects on an error.</code>&#13;
<code class="cm"> */</code>&#13;
<code class="kd">function</code> <code class="nx">captureSpeech</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">speechPromise</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">Promise</code><code class="p">((</code><code class="nx">resolve</code><code class="p">,</code> <code class="nx">reject</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="kr">const</code> <code class="nx">SpeechRecognition</code> <code class="o">=</code> <code class="nb">window</code><code class="p">.</code><code class="nx">SpeechRecognition</code> <code class="o">||</code>&#13;
      <code class="nb">window</code><code class="p">.</code><code class="nx">webkitSpeechRecognition</code><code class="p">;</code>&#13;
&#13;
    <code class="c1">// If this browser doesn't support speech recognition, reject the Promise.</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">SpeechRecognition</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="nx">reject</code><code class="p">(</code><code class="s1">'Speech recognition is not supported on this browser.'</code><code class="p">)</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="kr">const</code> <code class="nx">recognition</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">SpeechRecognition</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// Resolve the promise on successful speech recognition.</code>&#13;
    <code class="nx">recognition</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'result'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="kr">const</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">results</code><code class="p">[</code><code class="nx">event</code><code class="p">.</code><code class="nx">resultIndex</code><code class="p">];</code>&#13;
      <code class="nx">resolve</code><code class="p">(</code><code class="nx">result</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">transcript</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="nx">recognition</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'error'</code><code class="p">,</code> <code class="nx">event</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
      <code class="c1">// Reject the promise if there was a recognition error.</code>&#13;
      <code class="nx">reject</code><code class="p">(</code><code class="nx">event</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Start listening for speech.</code>&#13;
    <code class="nx">recognition</code><code class="p">.</code><code class="nx">start</code><code class="p">();</code>&#13;
  <code class="p">});</code>&#13;
&#13;
  <code class="c1">// Whether there was successful speech recognition or an error, make sure</code>&#13;
  <code class="c1">// the recognition engine has stopped listening.</code>&#13;
  <code class="k">return</code> <code class="nx">speechPromise</code><code class="p">.</code><code class="k">finally</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">recognition</code><code class="p">.</code><code class="nx">stop</code><code class="p">();</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id125">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The <code>captureSpeech</code> helper does not use <code>continuous</code> mode. This means you can only use it to listen for a single speech recognition event. If you want to capture additional speech after the returned <code>Promise</code> resolves, you need to call <code>captureSpeech</code> again and wait on the new <code>Promise</code>.</p>&#13;
&#13;
<p>You might notice that <a data-type="xref" href="#code_promiseHelper">Example 9-2</a> doesn’t return the <code>Promise</code> directly. Instead, it calls <code>finally</code> on that <code>Promise</code> to stop the speech recognition engine regardless of the outcome. The <code>captureSpeech</code> function lets you quickly recognize speech by just waiting on a <code>Promise</code> (see <a data-type="xref" href="#example9-3">Example 9-3</a>)<a data-startref="ix_09-web-speech-api-asciidoc8" data-type="indexterm" id="id993"/><a data-startref="ix_09-web-speech-api-asciidoc7" data-type="indexterm" id="id994"/><a data-startref="ix_09-web-speech-api-asciidoc6" data-type="indexterm" id="id995"/>.</p>&#13;
<div data-type="example" id="example9-3">&#13;
<h5><span class="label">Example 9-3. </span>Using the <code>captureSpeech</code> helper</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">spokenText</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">captureSpeech</code><code class="p">();</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Getting the Available Voices" data-type="sect1"><div class="sect1" id="recipe_getVoices">&#13;
<h1>Getting the Available Voices</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id291">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="speech synthesis" data-secondary="getting available voices" data-type="indexterm" id="id996"/><a data-primary="Web Speech API" data-secondary="getting the available voices" data-type="indexterm" id="id997"/>You want to determine what speech synthesis voices are available in the current browser.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id511">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Query the voice list by calling <code>speechSynthesis.getVoices</code>, and then listen for the <code>voiceschanged</code> event if necessary, as shown in <a data-type="xref" href="#code_getVoices">Example 9-4</a>.</p>&#13;
<div data-type="example" id="code_getVoices">&#13;
<h5><span class="label">Example 9-4. </span>Getting the list of available speech synthesis voices</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">showVoices</code><code class="p">()</code> <code class="p">{</code>&#13;
  <code class="nx">speechSynthesis</code><code class="p">.</code><code class="nx">getVoices</code><code class="p">().</code><code class="nx">forEach</code><code class="p">(</code><code class="nx">voice</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Voice:'</code><code class="p">,</code> <code class="nx">voice</code><code class="p">.</code><code class="nx">name</code><code class="p">);</code>&#13;
  <code class="p">});</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Some browsers load the voice list asynchronously. In these browsers,</code>&#13;
<code class="c1">// the voices are available when the voiceschanged event is triggered.</code>&#13;
<code class="nx">speechSynthesis</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'voiceschanged'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">showVoices</code><code class="p">());</code>&#13;
&#13;
<code class="c1">// Show the voices immediately in those browsers that support it.</code>&#13;
<code class="nx">showVoices</code><code class="p">();</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id512">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Some browsers, such as Chrome, load the list of voices asynchronously. If you call <code>getVoices</code> before the list is ready, you’ll get an empty array back. The <code>speech</code> &#13;
<span class="keep-together"><code>Synthesis</code></span> object triggers a <code>voiceschanged</code> event when the list is ready.</p>&#13;
&#13;
<p>Other browsers, including Firefox, have the voice list available right away. In these browsers, the <code>voiceschanged</code> event never fires. The code in <a data-type="xref" href="#code_getVoices">Example 9-4</a> handles both cases.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Each voice has a <code>lang</code> property that specifies the voice’s language. When speaking text, the voice uses the pronunciation rules for its language. Make sure you use a voice with the correct language for the text you’re synthesizing. Otherwise, the pronunciation won’t sound right.</p>&#13;
</div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Synthesizing Speech" data-type="sect1"><div class="sect1" id="id513">&#13;
<h1>Synthesizing Speech</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id126">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="speech synthesis" data-type="indexterm" id="id998"/><a data-primary="Web Speech API" data-secondary="synthesizing speech" data-type="indexterm" id="id999"/>You want your app to speak some text to the user.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id514">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Create a <code>SpeechSynthesisUtterance</code> and pass it to the <code>speechSynthesis.speak</code> method (see <a data-type="xref" href="#example9-5">Example 9-5</a>).</p>&#13;
<div data-type="example" id="example9-5">&#13;
<h5><span class="label">Example 9-5. </span>Speaking some text with the Web Speech API</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">function</code> <code class="nx">speakText</code><code class="p">(</code><code class="nx">text</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">utterance</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">SpeechSynthesisUtterance</code><code class="p">(</code><code class="nx">text</code><code class="p">);</code>&#13;
  <code class="nx">speechSynthesis</code><code class="p">.</code><code class="nx">speak</code><code class="p">(</code><code class="nx">utterance</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id515">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>An utterance is the set of words you want the browser to speak. It’s created with a <code>SpeechSynthesisUtterance</code> object.</p>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>Browsers will only permit speech synthesis once the user has interacted with the page in some way. This is to stop a page from speaking immediately upon loading. As such, the <code>speakText</code> helper function will not speak anything until there is some user activity on the page.</p>&#13;
</div>&#13;
&#13;
<p>This speaks the text with the default voice. If you want to use a different supported system voice, you can use the technique from <a data-type="xref" href="#recipe_getVoices">“Getting the Available Voices”</a> to get the array of available voices. You can set the utterance’s <code>voice</code> property to one of the voice objects from this array, as shown in <a data-type="xref" href="#example9-6">Example 9-6</a>.</p>&#13;
<div data-type="example" id="example9-6">&#13;
<h5><span class="label">Example 9-6. </span>Using another voice</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// Assuming the voices are available now</code>&#13;
<code class="kr">const</code> <code class="nx">aliceVoice</code> <code class="o">=</code> <code class="nx">speechSynthesis</code>&#13;
  <code class="p">.</code><code class="nx">getVoices</code><code class="p">()</code>&#13;
  <code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="nx">voice</code> <code class="o">=&gt;</code> <code class="nx">voice</code><code class="p">.</code><code class="nx">name</code> <code class="o">===</code> <code class="s1">'Alice'</code><code class="p">);</code>&#13;
&#13;
<code class="kd">function</code> <code class="nx">speakText</code><code class="p">(</code><code class="nx">text</code><code class="p">)</code> <code class="p">{</code>&#13;
  <code class="kr">const</code> <code class="nx">utterance</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">SpeechSynthesisUtterance</code><code class="p">(</code><code class="nx">text</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// Make sure the "Alice" voice was found.</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">aliceVoice</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">utterance</code><code class="p">.</code><code class="nx">voice</code> <code class="o">=</code> <code class="nx">aliceVoice</code><code class="p">;</code>&#13;
  <code class="p">}</code>&#13;
&#13;
  <code class="nx">speechSynthesis</code><code class="p">.</code><code class="nx">speak</code><code class="p">(</code><code class="nx">utterance</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Customizing Speech Synthesis Parameters" data-type="sect1"><div class="sect1" id="id516">&#13;
<h1>Customizing Speech Synthesis Parameters</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id292">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="speech synthesis" data-secondary="customizing parameters" data-type="indexterm" id="id1000"/><a data-primary="Web Speech API" data-secondary="customizing speech synthesis parameters" data-type="indexterm" id="id1001"/>You want to speed up, slow down, or adjust the pitch of the spoken text.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id517">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>When creating a <code>SpeechSynthesisUtterance</code>, use the <code>rate</code> and <code>pitch</code> properties to customize the speaking voice (see <a data-type="xref" href="#example9-7">Example 9-7</a>).</p>&#13;
<div data-type="example" id="example9-7">&#13;
<h5><span class="label">Example 9-7. </span>Customizing speech output</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kr">const</code> <code class="nx">utteranceLow</code> <code class="o">=</code>&#13;
<code class="k">new</code> <code class="nx">SpeechSynthesisUtterance</code><code class="p">(</code><code class="s1">'This is spoken slowly in a low tone'</code><code class="p">);</code>&#13;
<code class="nx">utterance</code><code class="p">.</code><code class="nx">pitch</code> <code class="o">=</code> <code class="mf">0.1</code><code class="p">;</code>&#13;
<code class="nx">utterance</code><code class="p">.</code><code class="nx">rate</code> <code class="o">=</code> <code class="mf">0.5</code><code class="p">;</code>&#13;
<code class="nx">speechSynthesis</code><code class="p">.</code><code class="nx">speak</code><code class="p">(</code><code class="nx">utterance</code><code class="p">);</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">utteranceHigh</code> <code class="o">=</code>&#13;
<code class="k">new</code> <code class="nx">SpeechSynthesisUtterance</code><code class="p">(</code><code class="s1">'This is spoken quickly in a high tone'</code><code class="p">);</code>&#13;
<code class="nx">utterance</code><code class="p">.</code><code class="nx">pitch</code> <code class="o">=</code> <code class="mi">2</code><code class="p">;</code>&#13;
<code class="nx">utterance</code><code class="p">.</code><code class="nx">rate</code> <code class="o">=</code> <code class="mi">2</code><code class="p">;</code>&#13;
<code class="nx">speechSynthesis</code><code class="p">.</code><code class="nx">speak</code><code class="p">(</code><code class="nx">utterance</code><code class="p">);</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id518">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The <code>pitch</code> option is a float number that can have a value between 0 and 2. Lower values result in a lower pitch, and higher values result in a higher pitch. Lowering the pitch does not affect the speaking rate. Depending on the browser or voice being used, the range of supported pitch values may be limited.</p>&#13;
&#13;
<p>To speed up or slow down the speaking rate, you can adjust the <code>rate</code> property. Each voice has a default speaking rate, which is represented by a <code>rate</code> of 1. The value of <code>rate</code> has a multiplier effect. If you set <code>rate</code> to 0.5, it is half of the default speaking rate. Similarly, if you set <code>rate</code> to 1.5, it is 50% faster than the default rate. The specification defines the valid range as 0.1 to 10, but browsers and voices typically limit this to a smaller range.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Automatically Pausing Speech" data-type="sect1"><div class="sect1" id="id519">&#13;
<h1>Automatically Pausing Speech</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id127">&#13;
<h2>Problem</h2>&#13;
&#13;
<p><a data-primary="pausing speech" data-type="indexterm" id="id1002"/><a data-primary="Web Speech API" data-secondary="automatically pausing speech" data-type="indexterm" id="id1003"/>When your app is speaking, you want to pause speech when you switch to another tab so that it doesn’t interfere with the usage of the other tab. You also want to stop speaking when leaving the page.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id128">&#13;
<h2>Solution</h2>&#13;
&#13;
<p><a data-primary="visibilitychange event" data-type="indexterm" id="id1004"/>Listen for the <code>visibilitychange</code> event and check the <code>document.visibilityState</code> property. When the page becomes hidden, pause speech synthesis. When it becomes visible again, resume speaking (see <a data-type="xref" href="#code_pauseSpeech">Example 9-8</a>).</p>&#13;
<div data-type="example" id="code_pauseSpeech">&#13;
<h5><span class="label">Example 9-8. </span>Pausing speech when the page becomes hidden</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nb">document</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'visibilitychange'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// speechSynthesis.speaking is true:</code>&#13;
  <code class="c1">// (1) when speech is currently being spoken</code>&#13;
  <code class="c1">// (2) when speech was being spoken, but is paused</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">speechSynthesis</code><code class="p">.</code><code class="nx">speaking</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nb">document</code><code class="p">.</code><code class="nx">visibilityState</code> <code class="o">===</code> <code class="s1">'hidden'</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="nx">speechSynthesis</code><code class="p">.</code><code class="nx">pause</code><code class="p">();</code>&#13;
    <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nb">document</code><code class="p">.</code><code class="nx">visibilityState</code> <code class="o">===</code> <code class="s1">'visible'</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="nx">speechSynthesis</code><code class="p">.</code><code class="nx">resume</code><code class="p">();</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id129">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>By default, if you switch to another tab while the Web Speech API is speaking some text, it continues speaking. This might be what you expect—after all, the same thing happens if you are streaming audio or video then change to another tab; you’ll continue to hear the audio from the other tab.</p>&#13;
&#13;
<p>When you switch tabs, the <code>visibilitychange</code> event fires. The event itself doesn’t have any information about the visibility state, but you can get that by checking the <code>document.visibilityState</code> property. <a data-type="xref" href="#code_pauseSpeech">Example 9-8</a> pauses the speech when you switch to another tab. When you switch back, it continues where it left off.</p>&#13;
&#13;
<p>Some browsers keep playing the speech even when you navigate away from the page or perform a full page refresh. Leaving or refreshing the page also triggers the &#13;
<span class="keep-together"><code>visibilitychange</code></span> event, so the code in <a data-type="xref" href="#code_pauseSpeech">Example 9-8</a> correctly stops the speech in these cases as well.<a data-startref="ix_09-web-speech-api-asciidoc0" data-type="indexterm" id="id1005"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section></body></html>