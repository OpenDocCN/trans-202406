<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 21. Query Performance"><div class="chapter" id="nch-queryperf"><h1><span class="label">Chapter 21. </span>Query Performance</h1><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45820324938688"><h5>A note for Early Release readers</h5><p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p></div></aside><section data-type="sect1" data-pdf-bookmark="21.0 Introduction"><div class="sect1" id="nch-queryperf-queryperf-intro"><h1>21.0 Introduction</h1><p>
    Indexes are utilized to find rows quickly if they are created and used as 
intended. Here are the main reasons to use indexes.
</p><ul><li><p>
Utilize <code>WHERE</code> clause in <code>SELECT</code> statement efficiently to find rows. 
</p></li><li><p>
Find the best query execution plan by the index’s uniqueness of values stored 
in a given column, known as cardinality, and the least number of rows returned. 
</p></li><li><p>
Enable the join operations between different tables. 
</p></li></ul><p>
</p><p>
    Indexes are vital to efficiently scanning and searching for values 
    in tables. Without them, MySQL would need to read all of the rows in a 
    given table when performing a query.  Due to 
    different table sizes, MySQL has to bring all the data read from the 
    table to memory, and it can only sort, filter, and return values of the 
    selected data. This operation may require additional resources to copy 
    data to a new temporary table to perform sort operations. Indexes are 
    crucial to query performance; hence non-indexed tables are a considerable
    overhead to a database unless they are small reference tables.
    </p><p>For a fast query performance, a primary key for each table representing one 
or more columns is required. While using the InnoDB storage engine, the table’s 
data is physically ordered to do fast lookups and sorts using primary key 
columns. The ideal table design uses a covering index where the query results are 
computed using index columns. Most of the indexes used by MySQL are stored in B-trees 
which allows fast data access due to reduced data access time. </p><p>If the table is big in data size and does not have any keys creating 
an extra field like <code>table_name_id</code> as a primary key can bring a considerable 
benefit in setting unique pointers doing join operations. InnoDB tables always
have a clustered index representing a primary key, if not already created by 
a user. A clustered index is a table where the data and the rows are stored 
in the table’s order on the key values in one direction.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>If no WHERE clause is used in a query, it’s a full table scan for MySQL 
optimizer.  For example: </p><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">customer</code><code class="p">;</code></pre><p> This does not change whether 
index exists or not for the <code>customer</code> table.</p></div><p>The following are some key terms you’ll need to know before getting started with index strategies:</p><dl><dt>Table Scan</dt><dd><p>
The table scan means reading all rows in the given table while performing a query. A developer should avoid full table scans as much as possible, 
including doing <code>COUNT(*)</code> operations. </p></dd><dt>Tree traversal </dt><dd><p>
The tree traversal is a method that indexes uses to access data in hops. Indexes goal is
to make minimum hops via traversal to fetch data. Fewer the number of 
leaf nodes faster the index traversal. 
</p></dd><dt>Leaf Nodes </dt><dd><p>
Leaf Nodes is part of the B-tree index structure. They maintain the changes 
in the index as data changes. They establish a doubly linked list to connect 
index leaf nodes. 
</p></dd><dt>B-tree Structure </dt><dd><p>
B-tree is a self-balancing tree data structure that keeps data sorted and 
allows searches, sequential access, insertions, and deletions in logarithmic 
time. The B-tree is a generalization of a binary search tree in that a node 
can have more than two children.
</p><p> 
While the B-tree index is commonly used among MySQL storage engines, 
different kinds of data structures are used for hash indexes. 
Hash indexes have different characteristics and have it’s own use cases.  
Consult <a href="https://dev.mysql.com/doc/refman/8.0/en/index-btree-hash.html">“Comparison of B-Tree and Hash Indexes”</a> in the MySQL User Reference Manual for further details.

    </p></dd></dl><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>While indexes help retrieve rows faster, over-creating or keeping 
unused indexes is a burden to the database’s I/O operation. 
Every index leaf page ( lowest level of the index where all of the keys for 
the index appear in sorted order) must be maintained for all 
<code>UPDATE</code>/<code>INSERT</code>/<code>DELETE</code> 
operations hence creating extra overhead. </p></div></div></section><section data-type="sect1" data-pdf-bookmark="21.1 Creating Indexes"><div class="sect1" id="nch-queryperf-queryperf-create-index"><h1>21.1 Creating Indexes</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820324972160"><h2>Problem</h2><p>Your query is very slow to respond.
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820324971088"><h2>Solution</h2><p>Create an index on your column to retrieve just the rows you 
      are seeking. 
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820324970032"><h2>Discussion</h2><p>Tables without indexes are just logbook 
      data written randomly with no reference to look up. As a result most 
      of the queries to such tables are slow. The exception only 
      applies to reference tables with a limited number of rows depending on 
      schema design. 
      </p><p>MySQL recommends giving each table a Primary Key column 
      with <code>NOT NULL</code> characteristic for each row. </p><p>We have a table called <code>top_names</code> from <code>Names_2010Census.csv</code> data. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="o">`</code><code class="n">top_names</code><code class="o">`</code><code> </code><code class="p">(</code><code>
  </code><code class="o">`</code><code class="n">top_name</code><code class="o">`</code><code> </code><code class="nb">varchar</code><code class="p">(</code><code class="mi">25</code><code class="p">)</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">NULL</code><code class="p">,</code><code>
  </code><code class="o">`</code><code class="n">name_rank</code><code class="o">`</code><code> </code><code class="nb">smallint</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">NULL</code><code class="p">,</code><code>
  </code><code class="o">`</code><code class="n">name_count</code><code class="o">`</code><code> </code><code class="nb">int</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">NULL</code><code class="p">,</code><code>
  </code><code class="o">`</code><code class="n">prop100k</code><code class="o">`</code><code> </code><code class="nb">decimal</code><code class="p">(</code><code class="mi">8</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">NULL</code><code class="p">,</code><code>
  </code><code class="o">`</code><code class="n">cum_prop100k</code><code class="o">`</code><code> </code><code class="nb">decimal</code><code class="p">(</code><code class="mi">8</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">NULL</code><code class="p">,</code><code>
  </code><code class="o">`</code><code class="n">pctwhite</code><code class="o">`</code><code> </code><code class="nb">decimal</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">NULL</code><code class="p">,</code><code>
  </code><code class="o">`</code><code class="n">pctblack</code><code class="o">`</code><code> </code><code class="nb">decimal</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">NULL</code><code class="p">,</code><code>
  </code><code class="o">`</code><code class="n">pctapi</code><code class="o">`</code><code> </code><code class="nb">decimal</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">NULL</code><code class="p">,</code><code>
  </code><code class="o">`</code><code class="n">pctaian</code><code class="o">`</code><code> </code><code class="nb">decimal</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">NULL</code><code class="p">,</code><code>
  </code><code class="o">`</code><code class="n">pct2prace</code><code class="o">`</code><code> </code><code class="nb">decimal</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">NULL</code><code class="p">,</code><code>
  </code><code class="o">`</code><code class="n">pcthispanic</code><code class="o">`</code><code> </code><code class="nb">decimal</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">NULL</code><code>
</code><code class="p">)</code><code> </code><code class="n">ENGINE</code><code class="o">=</code><code class="n">InnoDB</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="n">CHARSET</code><code class="o">=</code><code class="n">utf8mb4</code><code> </code><code class="k">COLLATE</code><code class="o">=</code><code class="n">utf8mb4_0900_ai_ci</code><code class="p">;</code></strong></pre><p>And you load the data:</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">LOAD</code><code> </code><code class="k">DATA</code><code> </code><code class="k">LOCAL</code><code> </code><code class="n">INFILE</code><code> </code><code class="s1">'Names_2010Census.csv'</code><code> </code><code class="k">into</code><code> </code><code class="k">table</code><code> </code><code class="n">top_names</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">FIELDS</code><code> </code><code class="n">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">','</code><code> </code><code class="n">ENCLOSED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">'"'</code><code> </code><code class="n">LINES</code><code> </code><code class="n">TERMINATED</code><code> </code><code class="k">BY</code><code> </code><code class="s1">'\n'</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">162255</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code class="p">,</code><code> </code><code class="mi">65535</code><code> </code><code class="n">warnings</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">93</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">162255</code><code>  </code><code class="n">Deleted</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Skipped</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">444813</code></pre><p>Now that we have created and loaded our table, we can proceed with 
	the following query. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">names_id</code><code class="p">,</code><code class="n">top_name</code><code class="p">,</code><code class="n">name_rank</code><code> 
	</code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">top_name</code><code> </code><code class="o">=</code><code> </code><code class="ss">"BROWN"</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----------+----------+-----------+
</code><code class="o">|</code><code> </code><code class="n">names_id</code><code> </code><code class="o">|</code><code> </code><code class="n">top_name</code><code> </code><code class="o">|</code><code> </code><code class="n">name_rank</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------+----------+-----------+
</code><code class="o">|</code><code>        </code><code class="mi">5</code><code> </code><code class="o">|</code><code> </code><code class="n">BROWN</code><code>    </code><code class="o">|</code><code>         </code><code class="mi">4</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------+----------+-----------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">04</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>As you can see below, MySQL has to do full table scan to find any rows in 
	this table outside of its <code>PRIMARY KEY</code>. </p><pre data-type="programlisting">mysql&gt; <strong><code>EXPLAIN SELECT names_id,top_name,name_rank 
	-&gt; FROM top_names WHERE top_name = "BROWN"\G</code></strong>
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: top_names
   partitions: NULL
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 161533
     filtered: 10.00
        Extra: Using where
1 row in set, 1 warning (0.01 sec)</pre><p>Our sample query seeks a string match on the <code>top_name</code> field; hence 
	having an index on this type of data will increase query performance. 
	First we create an index to meet <code>WHERE</code>
	clause of this query. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">idx_names</code><code> </code><code class="k">ON</code><code> </code><code class="n">top_names</code><code class="p">(</code><code class="n">top_name</code><code class="p">)</code><code class="p">;</code><code>
</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">28</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code></pre><p>We then check if the optimizer has chosen this new index for the same query. 
</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">names_id</code><code class="p">,</code><code class="n">top_name</code><code class="p">,</code><code class="n">name_rank</code><code> 
</code><code class="o">-</code><code class="o">&gt;</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">top_name</code><code> </code><code class="o">=</code><code> </code><code class="ss">"BROWN"</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">ref</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">idx_names</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">idx_names</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">103</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="n">const</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>Dropping indexes may be required for few reasons. After you make sure 
the index is no longer needed or needs to be recreated, you may drop them 
using the following syntax. </p><pre data-type="programlisting" data-code-language="sql"><code class="k">DROP</code> <code class="k">INDEX</code> <code class="n">index_name</code> <code class="k">ON</code> <code class="n">tbl_name</code><code class="p">;</code></pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="21.2 Creating Surrogate Primary Key"><div class="sect1" id="nch-queryperf-queryperf-create-index-innodbpk"><h1>21.2 Creating Surrogate Primary Key</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820324033232"><h2>Problem</h2><p>Table without Primary Key is not performant enough. 
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820324032352"><h2>Solution</h2><p>
      Add Primary Key to all InnoDB tables. 
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820324031472"><h2>Discussion</h2><p>
A primary key gives you a way to uniquely identify a row in the table. In 
case of InnoDB, a primary key is synonymous with a clustered index: a special 
index that stores row data. When an InnoDB table is created by a user without 
explicitly defining a primary key, InnoDB takes the first unique index that in
an index with B-Tree structure exists in the table and makes 
it the clustered index. A clustered index is also often referred as
physically order of the records on disk.  A clustered index is a table
stored in and if no unique index exists, InnoDB creates a surrogate key, 
called <code>GEN_CLUST_INDEX</code> 
on an automatically generated unique 6-bytes identifier.
</p><p>
When InnoDB creates secondary indexes, it is useful to resolve queries because 
it copies primary key columns to each secondary index row. If primary key is 
unnecessarily large all secondary indexes would be large as well. Therefore it 
is very important to choose suitable column for the primary key.
</p><p>
In our example on <a data-type="xref" href="#nch-queryperf-queryperf-create-index">Recipe 21.1</a>, natural 
primary key is <code>top_name</code> 
that takes 26 bytes. Defining <code>top_name</code> as a 
primary key will increase size of every row in the secondary index by 26 bytes. 
Therefore we show here a technique of creating 4-byte integer surrogate keys with 
property <code>AUTO_INCREMENT</code>, so it increases 
monotonically. It is also better than surrogate key that InnoDB creates 
explicitly, because it is smaller and we have full control over its values.
</p><p>
Our table is comparatively small but for large tables such difference could be 
critical. Besides space, larger indexes require more time to search through.
</p><p>This table is missing a field with a <code>PRIMARY KEY</code>. The best 
	 way to include one this table is to add an <code>id</code> field with properties <code>AUTO INCREMENT NOT NULL</code>. 
	 Ideally, you would create this in advance of loading any data to the table to order 
	 table in the tablespace physically.</p><pre data-type="programlisting">mysql&gt; <strong><code>ALTER TABLE `top_names` </code></strong>
    -&gt; <strong><code>ADD COLUMN `names_id` int unsigned NOT NULL 
    -&gt; AUTO_INCREMENT PRIMARY KEY FIRST;</code></strong>
Query OK, 0 rows affected (0.44 sec)
Records: 0  Duplicates: 0  Warnings: 0</pre><p>Although the following is a complete index scan, it will use the new 
	<code>PRIMARY KEY</code> field we have created to count the number of rows in 
	the table. </p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT COUNT(names_id) FROM top_names;</code></strong>
+-----------------+
| count(names_id) |
+-----------------+
|          162255 |
+-----------------+
1 row in set (0.04 sec)

mysql&gt; <strong><code>EXPLAIN SELECT COUNT(names_id) FROM top_names\G</code></strong>
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: top_names
   partitions: NULL
         type: index
possible_keys: NULL
          key: idx_name_rank_count
      key_len: 8
          ref: NULL
         rows: 161533
     filtered: 100.00
        Extra: Using index
1 row in set, 1 warning (0.00 sec)</pre></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820323953680"><h2>See Also</h2><p>For additional information about,
      see  MySQL documentation for further details 
on <a href="https://dev.mysql.com/doc/refman/8.0/en/primary-key-optimization.html">Primary Key Optimization.</a> .</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="21.3 Maintaining Indexes"><div class="sect1" id="nch-queryperf-queryperf-use-index"><h1>21.3 Maintaining Indexes</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820323951200"><h2>Problem</h2><p>You want to know if existing indexes are effective for your queries and drop those which are not.
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820323950192"><h2>Solution</h2><p>Learn basic index operations.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820323949312"><h2>Discussion</h2><p>To better control your data, use indexes efficiently by studying 
      data and access types of your schema. To continue our example from the previous recipe, 
      we will examine existing indexes for <code>top_names</code> 
      table. 
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SHOW</code><code> </code><code class="n">INDEXES</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
        </code><code class="k">Table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">Non_unique</code><code class="p">:</code><code> </code><code class="mi">0</code><code>
     </code><code class="n">Key_name</code><code class="p">:</code><code> </code><code class="k">PRIMARY</code><code>
 </code><code class="n">Seq_in_index</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="k">Column_name</code><code class="p">:</code><code> </code><code class="n">names_id</code><code>
    </code><code class="k">Collation</code><code class="p">:</code><code> </code><code class="n">A</code><code>
  </code><code class="k">Cardinality</code><code class="p">:</code><code> </code><code class="mi">161807</code><code>
     </code><code class="n">Sub_part</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
       </code><code class="n">Packed</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">Null</code><code class="p">:</code><code>
   </code><code class="n">Index_type</code><code class="p">:</code><code> </code><code class="n">BTREE</code><code>
      </code><code class="k">Comment</code><code class="p">:</code><code>
</code><code class="n">Index_comment</code><code class="p">:</code><code>
      </code><code class="n">Visible</code><code class="p">:</code><code> </code><code class="n">YES</code><code>
   </code><code class="n">Expression</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
        </code><code class="k">Table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">Non_unique</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
     </code><code class="n">Key_name</code><code class="p">:</code><code> </code><code class="n">idx_names</code><code>
 </code><code class="n">Seq_in_index</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="k">Column_name</code><code class="p">:</code><code> </code><code class="n">top_name</code><code>
    </code><code class="k">Collation</code><code class="p">:</code><code> </code><code class="n">A</code><code>
  </code><code class="k">Cardinality</code><code class="p">:</code><code> </code><code class="mi">161708</code><code>
     </code><code class="n">Sub_part</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
       </code><code class="n">Packed</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">Null</code><code class="p">:</code><code> </code><code class="n">YES</code><code>
   </code><code class="n">Index_type</code><code class="p">:</code><code> </code><code class="n">BTREE</code><code>
      </code><code class="k">Comment</code><code class="p">:</code><code>
</code><code class="n">Index_comment</code><code class="p">:</code><code>
      </code><code class="n">Visible</code><code class="p">:</code><code> </code><code class="n">YES</code><code>
   </code><code class="n">Expression</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="mi">2</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>Here, what matters most is the <code>cardinality</code> of the index. Indexes are 
	better utilized if the column has many different values. So, in short, 
	indexes are inefficient on boolean and redundant values. 
</p><p>
  In our case, cardinality of the index <code>idx_names</code> 
  is close to the cardinality of the primary key. This shows that the index 
  has good selectivity. Actually, this index could be also <code>unique</code> that we can 
  confirm by querying number of the distinct values in this column.
  </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="k">COUNT</code><code class="p">(</code><code class="k">DISTINCT</code><code> </code><code class="n">top_name</code><code class="p">)</code><code class="p">,</code><code> </code><code class="k">COUNT</code><code class="p">(</code><code class="o">*</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">--------------------------+----------+
</code><code class="o">|</code><code> </code><code class="k">count</code><code class="p">(</code><code class="k">distinct</code><code> </code><code class="n">top_name</code><code class="p">)</code><code> </code><code class="o">|</code><code> </code><code class="k">count</code><code class="p">(</code><code class="o">*</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">--------------------------+----------+
</code><code class="o">|</code><code>                   </code><code class="mi">162254</code><code> </code><code class="o">|</code><code>   </code><code class="mi">162254</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">--------------------------+----------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">18</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
</p><p>Since we’ve already created an index on the <code>top_name</code> column, we can 
    drop that index, then create a new, unique one. First to drop the index execute following command. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DROP</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">idx_names</code><code> </code><code class="k">ON</code><code> </code><code class="n">top_names</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">02</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code></pre><p>Alternatively, <code>ALTER TABLE</code> syntax can also be used. </p><pre data-type="programlisting" data-code-language="sql"><code class="k">ALTER</code> <code class="k">TABLE</code> <code class="n">tbl_name</code> <code class="k">DROP</code> <code class="k">INDEX</code> <code class="n">name</code><code class="p">;</code></pre><p>
	  To create a unique index specify keyword <code>UNIQUE</code> for the <code>CREATE INDEX</code> command:
	  </p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">UNIQUE</code> <code class="k">INDEX</code> <code class="n">idx_names</code> <code class="k">ON</code> <code class="n">top_names</code><code class="p">(</code><code class="n">top_name</code><code class="p">);</code></pre><p>
	</p><p>
You can rename an existing index created on the table. 
</p><pre data-type="programlisting">mysql&gt; <strong><code>ALTER TABLE top_names RENAME </code></strong>
    -&gt; <strong><code>INDEX idx_names to idx_top_name, ALGORITHM=INPLACE, LOCK=NONE;</code></strong></pre><div data-type="warning" epub:type="warning"><h6>Warning</h6><p>Not all <code>index</code> operations are In Place; some 
	index operations will cause table rebuild, which may negatively impact the 
	server’s performance for large data sizes. Care must be taken before 
	executing DDL operations. DDL (Data Definition Language) implies changing 
	the structure of table definition as known as the database schema.  
	For further details please consult <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-online-ddl-operations.html#online-ddl-index-operations">MySQL
          Documentation.</a> </p></div></div></section></div></section><section data-type="sect1" data-pdf-bookmark="21.4 Deciding When a Query Can Use an Index"><div class="sect1" id="nch-queryperf-queryperf-index-yesno"><h1>21.4 Deciding When a Query Can Use an Index</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820323716064"><h2>Problem</h2><p>Your table has an index, but queries are still slow.
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820323715120"><h2>Solution</h2><p>Check query plan using <code>EXPLAIN</code> to make sure right index is used.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820323882192"><h2>Discussion</h2><p>
      Indexes are part of query plans to access data faster by using the 
      shortest possible path. When MySQL optimizer makes a decision, it 
      considers indexes, cardinality, number of rows, and more. 
      Here’s an example of a query where index exists for a column but 
      MySQL can not utilize it. 
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">name_rank</code><code class="p">,</code><code class="n">top_name</code><code class="p">,</code><code class="n">name_count</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">name_rank</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">10</code><code> </code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">name_count</code><code class="err">\</code><code class="k">G</code></strong><code>
      </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">ALL</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">161604</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">33</code><code class="p">.</code><code class="mi">33</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code class="p">;</code><code> </code><code class="k">Using</code><code> </code><code class="n">filesort</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      </p><p>From the <code>Explain</code> plan output, We have no index that matches the key criteria of the query. 
There are indexes on this table and looks like we’ll need another index on <code>name_rank</code> field. 
	</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">idx_name_rank</code><code> </code><code class="k">ON</code><code> </code><code class="n">top_names</code><code class="p">(</code><code class="n">name_rank</code><code class="p">)</code><code class="p">;</code></strong><code>
	</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">16</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code></pre><p>
      </p><p>Check the query plan again after creating the new index:
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">name_rank</code><code class="p">,</code><code class="n">top_name</code><code class="p">,</code><code class="n">name_count</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">name_rank</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">10</code><code> </code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">name_count</code><code class="err">\</code><code class="k">G</code></strong><code>
      </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="n">range</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">idx_name_rank</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">idx_name_rank</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">3</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">11</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">index</code><code> </code><code class="n">condition</code><code class="p">;</code><code> </code><code class="k">Using</code><code> </code><code class="n">filesort</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      </p><p>Our query is seeking for a <code>name_rank</code> that is less than ten from the 
      <code>top_names</code> table. Without newly 
      created <code>idx_name_rank</code> on the <code>name_rank</code> 
      column, the optimizer has to evaluate all the 161604 rows in the table 
      to filter 11 rows in return. With the index in place it accesses just those 11 rows. </p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="21.5 Deciding Order for Multiple Column Indexes"><div class="sect1" id="nch-queryperf-queryperf-index-mulitple"><h1>21.5 Deciding Order for Multiple Column Indexes</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820323005424"><h2>Problem</h2><p>You want to speed up your multiple column query.  
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820323004544"><h2>Solution</h2><p>Use covering index with multiple columns. 
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820323028416"><h2>Discussion</h2><p>Best query performance can be achieved if query results are 
      computed entirely from the index pages without reading the actual 
      table data. A covering index is a solution for queries referencing 
      more than one column. This type of index contains the required data; 
      hence, it does not need to execute additional reads on the table.</p><p>In the following example, we have a query that requires having a filter on 
      one column (<code>name_rank</code>) and sort by another column (<code>name_count</code>).</p><p>
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">name_rank</code><code class="p">,</code><code class="n">top_name</code><code class="p">,</code><code class="n">name_count</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">name_rank</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">10</code><code> </code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">name_count</code><code class="err">\</code><code class="k">G</code></strong></pre><p>
      </p><p>We will create an index on the columns that we think are required for 
      the optimizer to choose the fstest path. </p><p> 
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">idx_name_rank_count</code><code> </code><code class="k">ON</code><code> </code><code class="n">top_names</code><code class="p">(</code><code class="n">name_count</code><code class="p">,</code><code class="n">name_rank</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">18</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code></pre><p>
      </p><p>In this case, MySQL cannot use the index against the following 
      query and it ends up needing to do a full table scan again. The reason is, 
      despite having both columns of the query in the filter the, index is ordered 
      reverse.  
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">name_rank</code><code class="p">,</code><code class="n">top_name</code><code class="p">,</code><code class="n">name_count</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">name_rank</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">10</code><code> </code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">name_count</code><code class="err">\</code><code class="k">G</code></strong><code>
      </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">ALL</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">161604</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">33</code><code class="p">.</code><code class="mi">33</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code class="p">;</code><code> </code><code class="k">Using</code><code> </code><code class="n">filesort</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
	</p><p>To demonstrate why the order of index columns matters, let’s look at the following example.</p><p>For the: <code>KEY `idx_name_rank_count` (`name_rank`,`name_count`)</code> first drop the previous index in reverse order and create a new one.</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DROP</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">idx_name_rank_count</code><code> </code><code class="k">ON</code><code> </code><code class="n">top_names</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code></pre><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">idx_name_rank_count</code><code> </code><code class="k">ON</code><code> </code><code class="n">top_names</code><code class="p">(</code><code class="n">name_rank</code><code class="p">,</code><code class="n">name_count</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">15</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code></pre><p>We have created a covering index for both columns our SELECT 
	statement proposes on name_rank and name_count filters. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">name_rank</code><code class="p">,</code><code class="n">top_name</code><code class="p">,</code><code class="n">name_count</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">name_rank</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">10</code><code> </code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">name_count</code><code class="err">\</code><code class="k">G</code></strong><code>
	</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="n">range</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">idx_name_rank_count</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">idx_name_rank_count</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">3</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">11</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">index</code><code> </code><code class="n">condition</code><code class="p">;</code><code> </code><code class="k">Using</code><code> </code><code class="n">filesort</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>As you can see from the <code>EXPLAIN</code> output, the optimizer 
	chooses <code>idx_name_rank_count</code> for this query with a new covering index. </p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="21.6 Using Ascending and Descending Indexes"><div class="sect1" id="nch-queryperf-queryperf-index-order"><h1>21.6 Using Ascending and Descending Indexes</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820322377360"><h2>Problem</h2><p>You want to scan your data in ascending or descending order 
      without a performance penalty.
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820322376352"><h2>Solution</h2><p>Use ascending and descending indexes. 
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820322375472"><h2>Discussion</h2><p>MySQL can scan indexes in reverse order with a performance 
      penalty due to index pages being physically ordered. In order to create 
      a matching index for the <code>ORDER BY</code> clause, use <code>DESC</code> for descending, <code>ASC</code> 
      for ascending index types. 
      </p><p>The ideal query performance comes from when you can avoid scanning an 
      index backward. It’s also a combination of sorting and filtering with the 
      <code>DESC</code> indexes. When MySQL optimizer chooses a query plan, it evaluates 
      if it can take advantage of these when the query needs descending order. </p><p>Remember descending indexes are supported for the InnoDB 
      storage engine, and there are some limitations to its use.</p><p> Also, descending indexes have the following properties:</p><ul><li><p>
       They are supported by all data types.
       </p></li><li><p>
       The <code>DISTINCT</code> clause can use any index with a matching column.
       </p></li><li><p>
       They can be used for <code>MIN()</code>/<code>MAX()</code> optimization when not used in 
       conjunction with the <code>GROUP BY</code> clause.
       </p></li><li><p>
       They are only limited to <code>BTREE</code> and <code>HASH</code> indexes.
       </p></li><li><p>
       They are not supported for <code>FULLTEXT</code> or 
       <code>SPATIAL</code> index types.
       </p></li></ul><p>The following example starts with creating covering index for our desired
     sorting for fields.</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">INDEX</code> <code class="n">idx_desc_01</code> <code class="k">ON</code> <code class="n">top_names</code><code class="p">(</code><code class="n">top_name</code><code class="p">,</code> <code class="n">prop100k</code> <code class="k">ASC</code><code class="p">,</code> <code class="n">cum_prop100K</code> <code class="k">DESC</code><code class="p">);</code></pre><p>
     </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">top_name</code><code class="p">,</code><code class="n">prop100k</code><code class="p">,</code><code class="n">cum_prop100k</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="o">`</code><code class="n">top_name</code><code class="o">`</code><code class="p">,</code><code class="o">`</code><code class="n">prop100k</code><code class="o">`</code><code class="p">,</code><code class="o">`</code><code class="n">cum_prop100k</code><code class="o">`</code><code> </code><code class="k">DESC</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">10</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----------+----------+--------------+
</code><code class="o">|</code><code> </code><code class="n">top_name</code><code> </code><code class="o">|</code><code> </code><code class="n">prop100k</code><code> </code><code class="o">|</code><code> </code><code class="n">cum_prop100k</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------+----------+--------------+
</code><code class="o">|</code><code> </code><code class="k">NULL</code><code>     </code><code class="o">|</code><code>     </code><code class="mi">2</code><code class="p">.</code><code class="mi">43</code><code> </code><code class="o">|</code><code>     </code><code class="mi">60231</code><code class="p">.</code><code class="mi">65</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">AAB</code><code>      </code><code class="o">|</code><code>     </code><code class="mi">0</code><code class="p">.</code><code class="mi">05</code><code> </code><code class="o">|</code><code>     </code><code class="mi">88770</code><code class="p">.</code><code class="mi">96</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">AABERG</code><code>   </code><code class="o">|</code><code>     </code><code class="mi">0</code><code class="p">.</code><code class="mi">16</code><code> </code><code class="o">|</code><code>     </code><code class="mi">82003</code><code class="p">.</code><code class="mi">18</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">AABY</code><code>     </code><code class="o">|</code><code>     </code><code class="mi">0</code><code class="p">.</code><code class="mi">07</code><code> </code><code class="o">|</code><code>     </code><code class="mi">86239</code><code class="p">.</code><code class="mi">41</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">AADLAND</code><code>  </code><code class="o">|</code><code>     </code><code class="mi">0</code><code class="p">.</code><code class="mi">13</code><code> </code><code class="o">|</code><code>     </code><code class="mi">83329</code><code class="p">.</code><code class="mi">35</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">AAFEDT</code><code>   </code><code class="o">|</code><code>     </code><code class="mi">0</code><code class="p">.</code><code class="mi">05</code><code> </code><code class="o">|</code><code>     </code><code class="mi">88567</code><code class="p">.</code><code class="mi">34</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">AAGAARD</code><code>  </code><code class="o">|</code><code>     </code><code class="mi">0</code><code class="p">.</code><code class="mi">10</code><code> </code><code class="o">|</code><code>     </code><code class="mi">84574</code><code class="p">.</code><code class="mi">52</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">AAGARD</code><code>   </code><code class="o">|</code><code>     </code><code class="mi">0</code><code class="p">.</code><code class="mi">12</code><code> </code><code class="o">|</code><code>     </code><code class="mi">83769</code><code class="p">.</code><code class="mi">42</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">AAGESEN</code><code>  </code><code class="o">|</code><code>     </code><code class="mi">0</code><code class="p">.</code><code class="mi">06</code><code> </code><code class="o">|</code><code>     </code><code class="mi">87383</code><code class="p">.</code><code class="mi">27</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="n">AAKER</code><code>    </code><code class="o">|</code><code>     </code><code class="mi">0</code><code class="p">.</code><code class="mi">12</code><code> </code><code class="o">|</code><code>     </code><code class="mi">83574</code><code class="p">.</code><code class="mi">66</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------+----------+--------------+
</code><code class="mi">10</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
After creating the covering index for all <code>ORDER BY</code> clauses, optimizer columns choose the <code>idx_desc_01</code>.
This is particularly good for index optimization and sorting. </p><pre data-type="programlisting">mysql&gt; <strong><code>EXPLAIN SELECT top_name,prop100k,cum_prop100k FROM top_names </code></strong>
    -&gt; <strong><code>ORDER BY `top_name`,`prop100k`,`cum_prop100k` DESC LIMIT 10\G</code></strong>
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: top_names
   partitions: NULL
         type: index
possible_keys: NULL
          key: idx_desc_01
      key_len: 113
          ref: NULL
         rows: 10
     filtered: 100.00
        Extra: Using index
1 row in set, 1 warning (0.00 sec)</pre><p>
When we do  <code>SELECT * FROM top_names</code>, instead of specifying columns order by <code>top_name</code> field, it uses previously created index, and by default, it is ascending order.
</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">top_name</code><code> </code><code class="k">ASC</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">10</code><code> </code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">index</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">idx_top_name</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">103</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">10</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
To demonstrate the use of descending indexes, we will create a new index and 
use <code>DESC</code> to apply that.
</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">idx_desc_02</code><code> </code><code class="k">ON</code><code> </code><code class="n">top_names</code><code class="p">(</code><code class="n">top_name</code><code> </code><code class="k">DESC</code><code class="p">,</code><code> </code><code class="n">prop100k</code><code class="p">,</code><code> </code><code class="n">cum_prop100K</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">38</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">top_name</code><code> </code><code class="k">DESC</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">10</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">index</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">idx_desc_02</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">113</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">10</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
Again using top_name with another column <code>prop100k</code> to illustrate the use of <code>DESC</code> index on the <code>top_name</code> column.
</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">top_name</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">top_name</code><code> </code><code class="k">DESC</code><code class="p">,</code><code class="n">prop100k</code><code> </code><code class="k">ASC</code><code> </code><code class="k">LIMIT</code><code> </code><code class="mi">10</code><code> </code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">index</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">idx_desc_02</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">113</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">10</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">index</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><div data-type="note" epub:type="note"><h6>Note</h6><p>Order matters as MySQL use the left-most order rule for the indexes
compared to <code>ORDER BY</code> clause. Changing the order of columns in the composite 
index will change the behavior of the query result. Also, be careful on using 
<code>SELECT * FROM</code> when sorting by multiple fields as <code>*</code> will use the 
column order from table definition, 
which may end up with different fields than the <code>ORDER BY</code> clause intends to. </p></div></div></section></div></section><section data-type="sect1" data-pdf-bookmark="21.7 Using Function-Based Indexes"><div class="sect1" id="nch-queryperf-queryperf-index-functional"><h1>21.7 Using Function-Based Indexes</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820321491376"><h2>Problem</h2><p>You need to search or sort by an expression but MySQL calculates result of the expression for each row, therefore cannot use indexes. Performance of the query is poor.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820321490496"><h2>Solution</h2><p>Use functional indexes.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820321514096"><h2>Discussion</h2><p>Some types of information are more easily analyzed using not the
      original values, but an expression computed from them. For example, column <code>size</code> in the table <code>mail</code> stores size in bytes that is hard to interpret on first glance. It would be much easier to work with if using kilobytes (<code>KB</code>) instead. However, you may not want to lose precision that storage in bytes provides.
      </p><p>
        You can have both precision and usability if you store data in bytes and use expressions to query the table. For example, to find messages that are larger than 100 KB, use the following query.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">SELECT</code><code> </code><code class="n">t</code><code class="p">,</code><code> </code><code class="n">srcuser</code><code class="p">,</code><code> </code><code class="n">srchost</code><code class="p">,</code><code> </code><code class="k">size</code><code class="p">,</code><code> </code><code class="n">ROUND</code><code class="p">(</code><code class="k">size</code><code class="o">/</code><code class="mi">1024</code><code class="p">)</code><code> </code><code class="k">AS</code><code> </code><code class="n">size_KB</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">FROM</code><code> </code><code class="n">mail</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">ROUND</code><code class="p">(</code><code class="k">size</code><code class="o">/</code><code class="mi">1024</code><code class="p">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">100</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">---------------------+---------+---------+---------+---------+
</code><code class="o">|</code><code> </code><code class="n">t</code><code>                   </code><code class="o">|</code><code> </code><code class="n">srcuser</code><code> </code><code class="o">|</code><code> </code><code class="n">srchost</code><code> </code><code class="o">|</code><code> </code><code class="k">size</code><code>    </code><code class="o">|</code><code> </code><code class="n">size_KB</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">---------------------+---------+---------+---------+---------+
</code><code class="o">|</code><code> </code><code class="mi">2014</code><code class="o">-</code><code class="mi">05</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">12</code><code class="p">:</code><code class="mi">48</code><code class="p">:</code><code class="mi">13</code><code> </code><code class="o">|</code><code> </code><code class="n">tricia</code><code>  </code><code class="o">|</code><code> </code><code class="n">mars</code><code>    </code><code class="o">|</code><code>  </code><code class="mi">194925</code><code> </code><code class="o">|</code><code>     </code><code class="mi">190</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">2014</code><code class="o">-</code><code class="mi">05</code><code class="o">-</code><code class="mi">14</code><code> </code><code class="mi">17</code><code class="p">:</code><code class="mi">03</code><code class="p">:</code><code class="mi">01</code><code> </code><code class="o">|</code><code> </code><code class="n">tricia</code><code>  </code><code class="o">|</code><code> </code><code class="n">saturn</code><code>  </code><code class="o">|</code><code> </code><code class="mi">2394482</code><code> </code><code class="o">|</code><code>    </code><code class="mi">2338</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code> </code><code class="mi">2014</code><code class="o">-</code><code class="mi">05</code><code class="o">-</code><code class="mi">15</code><code> </code><code class="mi">10</code><code class="p">:</code><code class="mi">25</code><code class="p">:</code><code class="mi">52</code><code> </code><code class="o">|</code><code> </code><code class="n">gene</code><code>    </code><code class="o">|</code><code> </code><code class="n">mars</code><code>    </code><code class="o">|</code><code>  </code><code class="mi">998532</code><code> </code><code class="o">|</code><code>     </code><code class="mi">975</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">---------------------+---------+---------+---------+---------+
</code><code class="mi">3</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      </p><p>
        However, MySQL would not be able to use index on the column <code>size</code> to resolve this query, because it calculates expression for each row. To resolve this issue use function-based indexes.
      </p><p>
        The syntax of the function-based index is:
        </p><pre data-type="programlisting" data-code-language="sql">CREATE INDEX <em><code>index_name</code></em> ON <em><code>table_name</code></em> ((<em><code>expression</code></em>));</pre><p>
        Mind double brackets: if you omit one pair, MySQL will think you are passing a column name instead of the expression and will return an error.
      </p><p>
        Let’s create an index on <code>ROUND(size/1024)</code> and check if MySQL will use it to resolve the query.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">size_KB</code><code> </code><code class="k">ON</code><code> </code><code class="n">mail</code><code> </code><code class="p">(</code><code class="p">(</code><code class="n">ROUND</code><code class="p">(</code><code class="k">size</code><code class="o">/</code><code class="mi">1024</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">02</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">t</code><code class="p">,</code><code> </code><code class="n">srcuser</code><code class="p">,</code><code> </code><code class="n">srchost</code><code class="p">,</code><code> </code><code class="k">size</code><code class="p">,</code><code> </code><code class="n">ROUND</code><code class="p">(</code><code class="k">size</code><code class="o">/</code><code class="mi">1024</code><code class="p">)</code><code> </code><code class="k">AS</code><code> </code><code class="n">size_KB</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">FROM</code><code> </code><code class="n">mail</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">ROUND</code><code class="p">(</code><code class="k">size</code><code class="o">/</code><code class="mi">1024</code><code class="p">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">100</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">mail</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">ALL</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">16</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      The index will not be used to resolve the query because function <code>ROUND</code> returns data in the <code>NEWDECIMAL</code> type for values that have floating point and <code>100</code> is <code>LONGLONG</code>. You can examine the result if start <span class="command"><em>mysql</em></span> client with the option <code>--column-type-info</code>:
    </p><pre data-type="programlisting" data-code-language="bash">$ <strong><code>unbuffer mysql --column-type-info -e "SELECT ROUND(10.5)" | grep Type</code></strong>
Type:       NEWDECIMAL
$ <strong><code>unbuffer mysql --column-type-info -e "SELECT 100" | grep Type</code></strong>
Type:       LONGLONG</pre><div data-type="tip"><h6>Tip</h6><p>
      We need to use command <span class="command"><em>unbuffer</em></span>, because <span class="command"><em>mysql</em></span> buffers <code>--column-type-info</code> result and it cannot be piped to <span class="command"><em>grep</em></span> otherwise.
    </p></div><p>
      To clarify,to force MySQL to use the index,you need to compare result of the expression with a floating point value.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">t</code><code class="p">,</code><code> </code><code class="n">srcuser</code><code class="p">,</code><code> </code><code class="n">srchost</code><code class="p">,</code><code> </code><code class="k">size</code><code class="p">,</code><code> </code><code class="n">ROUND</code><code class="p">(</code><code class="k">size</code><code class="o">/</code><code class="mi">1024</code><code class="p">)</code><code> </code><code class="k">AS</code><code> </code><code class="n">size_KB</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">FROM</code><code> </code><code class="n">mail</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">ROUND</code><code class="p">(</code><code class="k">size</code><code class="o">/</code><code class="mi">1024</code><code class="p">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">0</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">mail</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="n">range</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">size_KB</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">size_KB</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">10</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">3</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      Alternatively, cast the result of the function <code>ROUND</code> to the integer value when creating the index.
      And this also forces MySQL to use the index to resolve the query. 
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">DROP</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">size_KB</code><code> </code><code class="k">ON</code><code> </code><code class="n">mail</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><strong><code> </code><code class="k">CREATE</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">size_KB</code><code> </code><code class="k">ON</code><code> </code><code class="n">mail</code><code> </code><code class="p">(</code><code class="p">(</code><code class="k">CAST</code><code class="p">(</code><code class="n">ROUND</code><code class="p">(</code><code class="k">size</code><code class="o">/</code><code class="mi">1024</code><code class="p">)</code><code> </code><code class="k">AS</code><code> </code><code class="n">SIGNED</code><code class="p">)</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">02</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">t</code><code class="p">,</code><code> </code><code class="n">srcuser</code><code class="p">,</code><code> </code><code class="n">srchost</code><code class="p">,</code><code> </code><code class="k">size</code><code class="p">,</code><code> </code><code class="n">ROUND</code><code class="p">(</code><code class="k">size</code><code class="o">/</code><code class="mi">1024</code><code class="p">)</code><code> </code><code class="k">AS</code><code> </code><code class="n">size_KB</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">FROM</code><code> </code><code class="n">mail</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">ROUND</code><code class="p">(</code><code class="k">size</code><code class="o">/</code><code class="mi">1024</code><code class="p">)</code><code> </code><code class="o">&gt;</code><code> </code><code class="mi">100</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">mail</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="n">range</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">size_KB</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">size_KB</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">9</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">3</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
    </p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="21.8 Using Indexes on Generated Columns with JSON Data"><div class="sect1" id="nch-queryperf-queryperf-json"><h1>21.8 Using Indexes on Generated Columns with JSON Data</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820320526032"><h2>Problem</h2><p>
        You want to perform search inside JSON data but it is slow.
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820320525152"><h2>Solution</h2><p>
        Use a generated column, created from an expression that searches for a JSON value and an index on this column.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820320524208"><h2>Discussion</h2><p>
        In this recipe we will discuss a table <code>book_authors</code>.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="o">`</code><code class="n">book_authors</code><code class="o">`</code> <code class="p">(</code>
  <code class="o">`</code><code class="n">id</code><code class="o">`</code> <code class="nb">int</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="n">AUTO_INCREMENT</code><code class="p">,</code>
  <code class="o">`</code><code class="n">author</code><code class="o">`</code> <code class="n">json</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="o">`</code><code class="n">id</code><code class="o">`</code><code class="p">)</code>
<code class="p">);</code></pre><p>
        The table contains book records per author in the JSON column.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">book_authors</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
      </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">author</code><code class="p">:</code><code> </code><code class="err">{</code><code class="ss">"id"</code><code class="p">:</code><code> </code><code class="mi">1</code><code class="p">,</code><code> </code><code class="ss">"name"</code><code class="p">:</code><code> </code><code class="ss">"Paul"</code><code class="p">,</code><code> </code><code class="err">↩</code><code>
           </code><code class="ss">"books"</code><code class="p">:</code><code> </code><code class="p">[</code><code> </code><code class="err">↩</code><code>
             </code><code class="ss">"Software Portability with imake: Practical Software Engineering"</code><code class="p">,</code><code> </code><code class="err">↩</code><code>
             </code><code class="ss">"Mysql: The Definitive Guide to Using, Programming, ↩
             and Administering Mysql 4 (Developer's Library)"</code><code class="p">,</code><code> </code><code class="err">↩</code><code>
             </code><code class="ss">"MYSQL Certification Study Guide"</code><code class="p">,</code><code> </code><code class="err">↩</code><code>
             </code><code class="ss">"MySQL (OTHER NEW RIDERS)"</code><code class="p">,</code><code> </code><code class="err">↩</code><code>
             </code><code class="ss">"MySQL Cookbook"</code><code class="p">,</code><code> </code><code class="err">↩</code><code>
             </code><code class="ss">"MySQL 5.0 Certification Study Guide"</code><code class="p">,</code><code> </code><code class="err">↩</code><code>
             </code><code class="ss">"Using csh &amp; tcsh: Type Less, Accomplish More (Nutshell Handbooks)"</code><code class="p">,</code><code> </code><code class="err">↩</code><code>
             </code><code class="ss">"MySQL (Developer's Library)"</code><code class="p">]</code><code class="p">,</code><code> </code><code class="err">↩</code><code>
           </code><code class="ss">"lastname"</code><code class="p">:</code><code> </code><code class="ss">"DuBois"</code><code class="err">}</code><code>
</code><code class="n">lastname</code><code class="p">:</code><code> </code><code class="ss">"DuBois"</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
      </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">2</code><code>
  </code><code class="n">author</code><code class="p">:</code><code> </code><code class="err">{</code><code class="ss">"id"</code><code class="p">:</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="ss">"name"</code><code class="p">:</code><code> </code><code class="ss">"Alkin"</code><code class="p">,</code><code> </code><code class="ss">"books"</code><code class="p">:</code><code> </code><code class="p">[</code><code class="ss">"MySQL Cookbook"</code><code class="p">]</code><code class="p">,</code><code class="err">↩</code><code>
           </code><code class="ss">"lastname"</code><code class="p">:</code><code> </code><code class="ss">"Tezuysal"</code><code class="err">}</code><code>
</code><code class="n">lastname</code><code class="p">:</code><code> </code><code class="ss">"Tezuysal"</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">3</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
      </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">3</code><code>
  </code><code class="n">author</code><code class="p">:</code><code> </code><code class="err">{</code><code class="ss">"id"</code><code class="p">:</code><code> </code><code class="mi">3</code><code class="p">,</code><code> </code><code class="ss">"name"</code><code class="p">:</code><code> </code><code class="ss">"Sveta"</code><code class="p">,</code><code> </code><code class="err">↩</code><code>
           </code><code class="ss">"books"</code><code class="p">:</code><code> </code><code class="p">[</code><code class="ss">"MySQL Troubleshooting"</code><code class="p">,</code><code> </code><code class="ss">"MySQL Cookbook"</code><code class="p">]</code><code class="p">,</code><code> </code><code class="err">↩</code><code>
           </code><code class="ss">"lastname"</code><code class="p">:</code><code> </code><code class="ss">"Smirnova"</code><code class="err">}</code><code>
</code><code class="n">lastname</code><code class="p">:</code><code> </code><code class="ss">"Smirnova"</code><code>
</code><code class="mi">3</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
       If you want to search for a specific author you may consider searching by their name and lastname. 
     </p><p>
        <code>CREATE INDEX</code> command creates an index on a column in the table. JSON data stored in a single column, therefore any index, created with simple <code>CREATE INDEX</code> command would index whole JSON document while you may need to search only part of it.
      </p><p>
        More over, <code>CREATE INDEX</code> command will fail for the JSON column.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">author_name</code><code> </code><code class="k">ON</code><code> </code><code class="n">book_authors</code><code class="p">(</code><code class="n">author</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">ERROR</code><code> </code><code class="mi">3152</code><code> </code><code class="p">(</code><code class="mi">42000</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">JSON</code><code> </code><code class="k">column</code><code> </code><code class="s1">'author'</code><code> </code><code class="n">supports</code><code> </code><code class="n">indexing</code><code> </code><code class="k">only</code><code> </code><code class="err">↩</code><code>
</code><code class="n">via</code><code> </code><code class="k">generated</code><code> </code><code class="n">columns</code><code> </code><code class="k">on</code><code> </code><code class="n">a</code><code> </code><code class="n">specified</code><code> </code><code class="n">JSON</code><code> </code><code class="n">path</code><code class="p">.</code></pre><p>
        Solution for this issue would be use of a generated column and creating index on it. Values in generated columns are created using expression, defined at the column creation time. 
      </p><pre data-type="programlisting" data-code-language="sql"><code class="k">ALTER</code> <code class="k">TABLE</code> <code class="n">book_authors</code> <code class="k">ADD</code> <code class="k">COLUMN</code> <code class="n">lastname</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">255</code><code class="p">)</code> 
<code class="k">GENERATED</code> <code class="n">ALWAYS</code> <code class="k">AS</code><code class="p">(</code><code class="n">JSON_UNQUOTE</code><code class="p">(</code><code class="n">JSON_EXTRACT</code><code class="p">(</code><code class="n">author</code><code class="p">,</code> <code class="s1">'$.lastname'</code><code class="p">)));</code></pre><p>
        In this example we created a column, generated from the expression <code>JSON_EXTRACT(author, '$.lastname')</code>. We can also use operators <code>-&gt;</code> and <code>-&gt;&gt;</code> to extract JSON value:
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">ALTER</code> <code class="k">TABLE</code> <code class="n">book_authors</code> <code class="k">ADD</code> <code class="k">COLUMN</code> <code class="n">name</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">255</code><code class="p">)</code> 
<code class="k">GENERATED</code> <code class="n">ALWAYS</code> <code class="k">AS</code> <code class="p">(</code><code class="n">author</code><code class="o">-&gt;&gt;</code><code class="s1">'$.name'</code><code class="p">);</code></pre><p>
      </p><p>
        We used function <code>JSON_UNQUOTE</code> and operator <code>-&gt;&gt;</code> in our expressions to remove trailing quotes in author’s names if they exist.
      </p><p>
        Two new columns <code>name</code> and <code>lastname</code> do not take any space and generated each time when a query accesses the table.
      </p><div data-type="tip"><h6>Tip</h6><p>
        If you want to improve performance of your <code>SELECT</code> queries in price of additional storage and slowness at the write time define generated columns with keyworkd <code>STORED</code>. In this case expression would be executed only once: when values, used in the expression, are inserted or modified and then physically stored on the disk.
      </p></div><p>
        Now we can create an index on our new generated columns.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">INDEX</code> <code class="n">author_name</code> <code class="k">ON</code> <code class="n">book_authors</code><code class="p">(</code><code class="n">lastname</code><code class="p">,</code> <code class="n">name</code><code class="p">);</code></pre><p>
      </p><p>
        To access data using newly created index refer new columns as any other column.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">author</code><code class="o">-</code><code class="o">&gt;</code><code class="s1">'$.books'</code><code> </code><code class="k">FROM</code><code> </code><code class="n">book_authors</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Sveta'</code><code> </code><code class="k">AND</code><code> </code><code class="n">lastname</code><code class="o">=</code><code class="s1">'Smirnova'</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">---------------------------------------------+
</code><code class="o">|</code><code> </code><code class="n">author</code><code class="o">-</code><code class="o">&gt;</code><code class="s1">'$.books'</code><code>                           </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">---------------------------------------------+
</code><code class="o">|</code><code> </code><code class="p">[</code><code class="ss">"MySQL Troubleshooting"</code><code class="p">,</code><code> </code><code class="ss">"MySQL Cookbook"</code><code class="p">]</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">---------------------------------------------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      </p><p>
        <code>EXPLAIN</code> confirms that the new index is used.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">author</code><code class="o">-</code><code class="o">&gt;</code><code class="s1">'$.books'</code><code> </code><code class="k">FROM</code><code> </code><code class="n">book_authors</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">name</code><code> </code><code class="o">=</code><code> </code><code class="s1">'Sveta'</code><code> </code><code class="k">AND</code><code> </code><code class="n">lastname</code><code class="o">=</code><code class="s1">'Smirnova'</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">book_authors</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">ref</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">author_name</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">author_name</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">2046</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="n">const</code><code class="p">,</code><code class="n">const</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820320523840"><h2>See Also</h2><p>For additional information about using JSON in MySQL, see <a data-type="xref" href="ch19.xhtml#nch-json">Chapter 19</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="21.9 Using Full Text Indexes"><div class="sect1" id="nch-queryperf-queryperf-fulltext"><h1>21.9 Using Full Text Indexes</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820320236752"><h2>Problem</h2><p>
      You want to take advantage of keyword search, but queries on text 
      fields are slow.
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820320235616"><h2>Solution</h2><p>
       Use <code>FULLTEXT</code> indexes for full-text searches. 
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820320258800"><h2>Discussion</h2><p>
      MySQL supports <code>FULLTEXT</code> indexes for limited but on popular storage 
      engines such as InnoDB and MyISAM. Although neither of the storage
      engines are originally designed to index large text operations, they can 
      still use them to comb performance for specific queries. 
      </p><p><code>FULLTEXT</code> indexes have two other conditions.</p><ol><li><p>It can only be used it for <code>CHAR</code>, <code>VARCHAR</code>, or <code>TEXT</code> columns. </p></li><li><p>It can only use when <code>MATCH()</code> or <code>AGAINST()</code> clause in a <code>SELECT</code> statement. </p></li></ol><p>In MySQL, <code>MATCH()</code> function 
      performs a full-text search by accepting a comma-separated list of 
      columns where <code>AGAINST()</code> takes a 
      string to search.</p><div data-type="note" epub:type="note"><h6>Note</h6><p><code>FULLTEXT</code> index can be used with a combination of B-tree index on 
      the same column as their purpose is different. <code>FULLTEXT</code> is for finding 
      keywords versus matching values in the field.</p></div><p><code>FULLTEXT</code> text searches also have three different modes:</p><ul><li><p>
      Natural language mode (default) is the search mode for simple phrases.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="n">top_name</code><code class="p">,</code><code class="n">name_rank</code> <code class="k">FROM</code> <code class="n">top_names</code> <code class="k">WHERE</code> <code class="k">MATCH</code><code class="p">(</code><code class="n">top_name</code><code class="p">)</code> 
      <code class="n">AGAINST</code><code class="p">(</code><code class="ss">"ANDREW"</code> <code class="k">IN</code> <code class="k">NATURAL</code> <code class="k">LANGUAGE</code> <code class="k">MODE</code><code class="p">)</code> <code class="err">\</code><code class="k">G</code></pre><p>
      </p></li><li><p>
      <code>Boolean mode</code> is for using boolean operators in search mode. Recall that the 
      same strategy discussed in <a data-type="xref" href="ch07.xhtml#nch-strings-strings-full-text-boolean">Recipe 7.17</a> similarly use of operators here.   
      </p><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="n">top_name</code><code class="p">,</code><code class="n">name_rank</code> <code class="k">FROM</code> <code class="n">top_names</code> <code class="k">WHERE</code> <code class="k">MATCH</code><code class="p">(</code><code class="n">top_name</code><code class="p">)</code> 
      <code class="n">AGAINST</code><code class="p">(</code><code class="ss">"+ANDREW +ANDY -ANN"</code> <code class="k">IN</code> <code class="nb">BOOLEAN</code> <code class="k">MODE</code><code class="p">)</code> <code class="err">\</code><code class="k">G</code></pre></li><li><p>
      <code>Query expansion mode</code> is the search mode for similar or related values to a search expression. In short, 
      this mode will return relevant matches against a searched keyword. 
      </p><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="n">top_name</code><code class="p">,</code><code class="n">name_rank</code> <code class="k">FROM</code> <code class="n">top_names</code> <code class="k">WHERE</code> <code class="k">MATCH</code><code class="p">(</code><code class="n">top_name</code><code class="p">)</code> 
      <code class="n">AGAINST</code><code class="p">(</code><code class="ss">"ANDY"</code>  <code class="k">WITH</code> <code class="n">QUERY</code> <code class="n">EXPANSION</code><code class="p">)</code> <code class="err">\</code><code class="k">G</code></pre></li></ul><p>InnoDB storage engine can take advantage of the following 
    optimizations.
    </p><ul><li><p>
      Queries that only return the <code>ID</code> field of the search rank. 
      Search rank is defined as relevance rank as a measure to show how good is the match. 
      </p></li><li><p>
      Queries that sort the matching rows in descending order  
      </p></li></ul><p>The optimizer will choose the none fulltext index on the <code>top_name</code> column. This is due to
    the query being written to optimize InnoDB’s b-tree index with pattern matching instead of literal comparison. 
    For more information, see <a data-type="xref" href="ch07.xhtml#nch-strings-strings-pat-sql">Recipe 7.10</a>.
    This type of query is very efficient given the data type we have in this 
    example with indexed unique string values in this  <code>top_name</code> column. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">top_name</code><code class="p">,</code><code class="n">name_rank</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">top_name</code><code class="o">=</code><code class="ss">"ANDREW"</code><code> </code><code class="err">\</code><code class="k">G</code></strong><code>
    </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">ref</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">idx_top_name</code><code class="p">,</code><code class="n">idx_desc_01</code><code class="p">,</code><code class="n">idx_desc_02</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">idx_top_name</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">103</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="n">const</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="n">FULLTEXT</code><code> </code><code class="k">INDEX</code><code> </code><code class="n">idx_fulltext</code><code> </code><code class="k">ON</code><code> </code><code class="n">top_names</code><code class="p">(</code><code class="n">top_name</code><code class="p">)</code><code class="p">;</code></strong><code>
    </code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">1</code><code class="p">.</code><code class="mi">94</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
   </code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">1</code></pre><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">top_name</code><code class="p">,</code><code class="n">name_rank</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">top_name</code><code class="o">=</code><code class="ss">"ANDREW"</code><code> </code><code class="err">\</code><code class="k">G</code></strong><code>
    </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">ref</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">idx_top_name</code><code class="p">,</code><code class="n">idx_desc_01</code><code class="p">,</code><code class="n">idx_desc_02</code><code class="p">,</code><code class="n">idx_fulltext</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">idx_top_name</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">103</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="n">const</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>Now if we try a pattern match against the same column, we will be able to utilize full text index for the given column. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">top_name</code><code class="p">,</code><code class="n">name_rank</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">MATCH</code><code class="p">(</code><code class="n">top_name</code><code class="p">)</code><code> </code><code class="n">AGAINST</code><code class="p">(</code><code class="ss">"ANDREW"</code><code class="p">)</code><code> </code><code class="err">\</code><code class="k">G</code></strong><code>
    </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="n">fulltext</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">idx_fulltext</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">idx_fulltext</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">0</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="n">const</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code class="p">;</code><code> </code><code class="n">Ft_hints</code><code class="p">:</code><code> </code><code class="n">sorted</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>In this case, we can see MySQL chooses to use the <code>FULLTEXT</code> index. 
Although it’s useful to have <code>FULLTEXT</code> index availability in MySQL, it comes 
with many restrictions. Please refer to MySQL documentation for further details 
on <a href="https://dev.mysql.com/doc/refman/8.0/en/fulltext-restrictions.html">Full-Text Restrictions.</a> </p><div data-type="note" epub:type="note"><h6>Note</h6><p>Despite the availability of full-text indexes in the InnoDB storage engine, 
there may be better alternatives in the market to take this off of MySQL workload and 
put it on another optimized storage system. </p></div></div></section></div></section><section data-type="sect1" data-pdf-bookmark="21.10 Utilizing Spatial Indexes and Geographical Data"><div class="sect1" id="nch-queryperf-queryperf-spatial"><h1>21.10 Utilizing Spatial Indexes and Geographical Data</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820318827280"><h2>Problem</h2><p>
      You want to store and query geographic coordinates effectively.
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820318826400"><h2>Solution</h2><p>
      Use MySQL’s improved Spatial Reference System. 
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820318848176"><h2>Discussion</h2><p>
      MySQL 8 contains all SRS (Spatial Reference System) identifications 
      from EPSG (European Petroleum Survey Group) agency. These SRS identifications are 
      stored with a unique name and SRID in <code>information_schema</code>.</p><p>These systems represent different variations of geographic data references. 
      You can query details of these from <code>information_schema</code>. 
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">INFORMATION_SCHEMA</code><code class="p">.</code><code class="n">ST_SPATIAL_REFERENCE_SYSTEMS</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">WHERE</code><code> </code><code class="n">SRS_ID</code><code class="o">=</code><code class="mi">4326</code><code> </code><code class="k">OR</code><code> </code><code class="n">SRS_ID</code><code class="o">=</code><code class="mi">3857</code><code> </code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">SRS_ID</code><code> </code><code class="k">DESC</code><code class="err">\</code><code class="k">G</code></strong><code>
    </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
                </code><code class="n">SRS_NAME</code><code class="p">:</code><code> </code><code class="n">WGS</code><code> </code><code class="mi">84</code><code>
                  </code><code class="n">SRS_ID</code><code class="p">:</code><code> </code><code class="mi">4326</code><code>
            </code><code class="n">ORGANIZATION</code><code class="p">:</code><code> </code><code class="n">EPSG</code><code>
</code><code class="n">ORGANIZATION_COORDSYS_ID</code><code class="p">:</code><code> </code><code class="mi">4326</code><code>
              </code><code class="n">DEFINITION</code><code class="p">:</code><code> </code><code class="n">GEOGCS</code><code class="p">[</code><code class="ss">"WGS 84"</code><code class="p">,</code><code class="n">DATUM</code><code class="p">[</code><code class="ss">"World Geodetic System 1984"</code><code class="p">,</code><code>
              </code><code class="n">SPHEROID</code><code class="p">[</code><code class="ss">"WGS 84"</code><code class="p">,</code><code class="mi">6378137</code><code class="p">,</code><code class="mi">298</code><code class="p">.</code><code class="mi">257223563</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"7030"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code>
              </code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"6326"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code class="n">PRIMEM</code><code class="p">[</code><code class="ss">"Greenwich"</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"8901"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code>
              </code><code class="n">UNIT</code><code class="p">[</code><code class="ss">"degree"</code><code class="p">,</code><code class="mi">0</code><code class="p">.</code><code class="mi">017453292519943278</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"9122"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code>
              </code><code class="n">AXIS</code><code class="p">[</code><code class="ss">"Lat"</code><code class="p">,</code><code class="n">NORTH</code><code class="p">]</code><code class="p">,</code><code class="n">AXIS</code><code class="p">[</code><code class="ss">"Lon"</code><code class="p">,</code><code class="n">EAST</code><code class="p">]</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"4326"</code><code class="p">]</code><code class="p">]</code><code>
             </code><code class="n">DESCRIPTION</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
                </code><code class="n">SRS_NAME</code><code class="p">:</code><code> </code><code class="n">WGS</code><code> </code><code class="mi">84</code><code> </code><code class="o">/</code><code> </code><code class="n">Pseudo</code><code class="o">-</code><code class="n">Mercator</code><code>
                  </code><code class="n">SRS_ID</code><code class="p">:</code><code> </code><code class="mi">3857</code><code>
            </code><code class="n">ORGANIZATION</code><code class="p">:</code><code> </code><code class="n">EPSG</code><code>
</code><code class="n">ORGANIZATION_COORDSYS_ID</code><code class="p">:</code><code> </code><code class="mi">3857</code><code>
              </code><code class="n">DEFINITION</code><code class="p">:</code><code> </code><code class="n">PROJCS</code><code class="p">[</code><code class="ss">"WGS 84 / Pseudo-Mercator"</code><code class="p">,</code><code class="n">GEOGCS</code><code class="p">[</code><code class="ss">"WGS 84"</code><code class="p">,</code><code>
              </code><code class="n">DATUM</code><code class="p">[</code><code class="ss">"World Geodetic System 1984"</code><code class="p">,</code><code class="n">SPHEROID</code><code class="p">[</code><code class="ss">"WGS 84"</code><code class="p">,</code><code class="mi">6378137</code><code class="p">,</code><code>
              </code><code class="mi">298</code><code class="p">.</code><code class="mi">257223563</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"7030"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"6326"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code>
              </code><code class="n">PRIMEM</code><code class="p">[</code><code class="ss">"Greenwich"</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"8901"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code class="n">UNIT</code><code class="p">[</code><code class="ss">"degree"</code><code class="p">,</code><code>
              </code><code class="mi">0</code><code class="p">.</code><code class="mi">017453292519943278</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"9122"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code class="n">AXIS</code><code class="p">[</code><code class="ss">"Lat"</code><code class="p">,</code><code class="n">NORTH</code><code class="p">]</code><code>
              </code><code class="p">,</code><code class="n">AXIS</code><code class="p">[</code><code class="ss">"Lon"</code><code class="p">,</code><code class="n">EAST</code><code class="p">]</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"4326"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code class="n">PROJECTION</code><code class="p">[</code><code class="ss">"Popular 
              Visualisation Pseudo Mercator"</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"1024"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code>
              </code><code class="k">PARAMETER</code><code class="p">[</code><code class="ss">"Latitude of natural origin"</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"8801"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code>
              </code><code class="k">PARAMETER</code><code class="p">[</code><code class="ss">"Longitude of natural origin"</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"8802"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code>
              </code><code class="k">PARAMETER</code><code class="p">[</code><code class="ss">"False easting"</code><code class="p">,</code><code class="mi">0</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"8806"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code class="err">↩</code><code>
              </code><code class="k">PARAMETER</code><code class="p">[</code><code class="ss">"False northing"</code><code class="p">,</code><code>
              </code><code class="mi">0</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"8807"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code class="n">UNIT</code><code class="p">[</code><code class="ss">"metre"</code><code class="p">,</code><code class="mi">1</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"9001"</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code class="err">↩</code><code>
              </code><code class="n">AXIS</code><code class="p">[</code><code class="ss">"X"</code><code class="p">,</code><code class="n">EAST</code><code class="p">]</code><code class="p">,</code><code>
              </code><code class="n">AXIS</code><code class="p">[</code><code class="ss">"Y"</code><code class="p">,</code><code class="n">NORTH</code><code class="p">]</code><code class="p">,</code><code class="n">AUTHORITY</code><code class="p">[</code><code class="ss">"EPSG"</code><code class="p">,</code><code class="ss">"3857"</code><code class="p">]</code><code class="p">]</code><code>
             </code><code class="n">DESCRIPTION</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="mi">2</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>SRS_ID  4326 represents widespread web map projections used in 
	Google Maps, OpenStreetMaps, etc., whereas 4326 is GPS coordinates used 
	for tracking locations. </p><p>Let’s say we have point of interest data that we keep in our database. 
	We will create a table and load sample data to it using SRID 4326</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">poi</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code> </code><code class="n">poi_id</code><code>  </code><code class="nb">INT</code><code> </code><code class="n">UNSIGNED</code><code> </code><code class="n">AUTO_INCREMENT</code><code> </code><code class="k">NOT</code><code> </code><code class="k">NULL</code><code>  </code><code class="k">PRIMARY</code><code> </code><code class="k">KEY</code><code class="p">,</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">position</code><code> </code><code class="n">POINT</code><code> </code><code class="k">NOT</code><code> </code><code class="k">NULL</code><code> </code><code class="n">SRID</code><code> </code><code class="mi">4326</code><code class="p">,</code><code> </code><code class="n">name</code><code> </code><code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">200</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">02</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">poi</code><code> </code><code class="k">VALUES</code><code> </code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="n">ST_GeomFromText</code><code class="p">(</code><code class="s1">'POINT(41.0211 29.0041)'</code><code class="p">,</code><code> </code><code class="mi">4326</code><code class="p">)</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="s1">'Maiden\'</code><code class="n">s</code><code> </code><code class="n">Tower</code><code class="s1">');</code></strong><code class="s1">
Query OK, 1 row affected (0.00 sec)
msyql&gt; </code><strong><code class="s1">INSERT INTO poi VALUES (2, ST_GeomFromText('</code><code class="n">POINT</code><code class="p">(</code><code class="mi">41</code><code class="p">.</code><code class="mi">0256</code><code> </code><code class="mi">28</code><code class="p">.</code><code class="mi">9742</code><code class="p">)</code><code class="s1">', 4326),</code></strong><code class="s1">
    -&gt; </code><strong><code class="s1">'</code><code class="n">Galata</code><code> </code><code class="n">Tower</code><code class="err">'</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>Now create an index on the geometry column. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="n">SPATIAL</code><code> </code><code class="k">INDEX</code><code> </code><code class="k">position</code><code> </code><code class="k">ON</code><code> </code><code class="n">poi</code><code> </code><code class="p">(</code><code class="k">position</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code></pre><p>We will demonstrate how to measure the distance between these two points of interest. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">ST_AsText</code><code class="p">(</code><code class="k">position</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">poi</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">poi_id</code><code> </code><code class="o">=</code><code> </code><code class="mi">1</code><code> </code><code class="k">INTO</code><code> </code><code class="o">@</code><code class="n">tower1</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">ST_AsText</code><code class="p">(</code><code class="k">position</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">poi</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">poi_id</code><code> </code><code class="o">=</code><code> </code><code class="mi">2</code><code> </code><code class="k">INTO</code><code> </code><code class="o">@</code><code class="n">tower2</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">ST_Distance</code><code class="p">(</code><code class="n">ST_GeomFromText</code><code class="p">(</code><code class="o">@</code><code class="n">tower1</code><code class="p">,</code><code> </code><code class="mi">4326</code><code class="p">)</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">ST_GeomFromText</code><code class="p">(</code><code class="o">@</code><code class="n">tower2</code><code class="p">,</code><code> </code><code class="mi">4326</code><code class="p">)</code><code class="p">)</code><code> </code><code class="k">AS</code><code> </code><code class="n">distance</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">--------------------+
</code><code class="o">|</code><code> </code><code class="n">distance</code><code>           </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">--------------------+
</code><code class="o">|</code><code> </code><code class="mi">2563</code><code class="p">.</code><code class="mi">9276036976544</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">--------------------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>This is a representation of a straight line between these two 
	points of interest. Of course, this isn’t a car route planning example; 
	this is more like a bird’s flight from point A to B in meters.</p><p>Let’s check what MySQL used as query optimization.</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">ST_Distance</code><code class="p">(</code><code class="n">ST_GeomFromText</code><code class="p">(</code><code class="o">@</code><code class="n">tower1</code><code class="p">,</code><code> </code><code class="mi">4326</code><code class="p">)</code><code class="p">,</code><code> </code></strong><code>
</code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">ST_GeomFromText</code><code class="p">(</code><code class="o">@</code><code class="n">tower2</code><code class="p">,</code><code> </code><code class="mi">4326</code><code class="p">)</code><code class="p">)</code><code> </code><code class="k">AS</code><code> </code><code class="n">dist</code><code> </code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">No</code><code> </code><code class="n">tables</code><code> </code><code class="n">used</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>Since the <code>ST_Distance</code> function does not use a table to calculate 
	distance between these two locations, it does not use a table in the 
	query; hence there’s no index optimization allowed. </p><p>You can further improve on the distance calculation about Earth 
	spherical shape should be using <code>ST_Distance_Sphere</code>, which will result in 
	slightly different results.</p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">ST_Distance_Sphere</code><code class="p">(</code><code class="n">ST_GeomFromText</code><code class="p">(</code><code class="o">@</code><code class="n">tower1</code><code class="p">,</code><code> </code><code class="mi">4326</code><code class="p">)</code><code class="p">,</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">ST_GeomFromText</code><code class="p">(</code><code class="o">@</code><code class="n">tower2</code><code class="p">,</code><code> </code><code class="mi">4326</code><code class="p">)</code><code class="p">)</code><code> </code><code class="k">AS</code><code> </code><code class="n">dist</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">--------------------+
</code><code class="o">|</code><code> </code><code class="n">dist</code><code>               </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">--------------------+
</code><code class="o">|</code><code> </code><code class="mi">2557</code><code class="p">.</code><code class="mi">7412439442496</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">--------------------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>Let’s say we have a polygon around Istanbul for covering our target search area. 
	The required polygon coordinates can be generated via another application. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SET</code><code> </code><code class="o">@</code><code class="n">poly</code><code> </code><code class="p">:</code><code class="o">=</code><code> </code><code class="n">ST_GeomFromText</code><code> </code><code class="p">(</code><code> </code><code class="s1">'POLYGON(( 41.104897239651905 28.876082545638166, </code></strong><code class="s1">
    -&gt; </code><strong><code class="s1">41.05727989444261 29.183699733138166, </code></strong><code class="s1">
    -&gt; </code><strong><code class="s1">40.90384226781947 29.137007838606916, </code></strong><code class="s1">
    -&gt; </code><strong><code class="s1">40.94119778455447 28.865096217513166, </code></strong><code class="s1">
    -&gt; </code><strong><code class="s1">41.104897239651905 28.876082545638166))'</code><code class="p">,</code><code> </code><code class="mi">4326</code><code class="p">)</code><code class="p">;</code></strong></pre><p>This time we’ll search points of interest using <code>ST_Within</code> function from that polygon area.
	There are many functions built into MySQL’s Spatial Reference implementation. For details please refer to MySQL documentation <a href="https://dev.mysql.com/doc/refman/8.0/en/spatial-analysis-functions.html">Spatial Analysis Functions.</a>
Spatial functions can be grouped into few categories such:
</p><ul><li><p>Create geometries in various formats.</p></li><li><p>Convert geometries between formats.</p></li><li><p>Access qualitative and quantitative properties of geometry.</p></li><li><p>Describe relations between two geometries.</p></li><li><p>Create new geometries from existing ones.</p></li></ul><p>These functions allow developers to get faster access to the data and better utilize spatial analysis within MySQL. </p><p>In the following query, we are utilizing both <code>ST_AsText</code> and <code>ST_Within</code> functions at the same time. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code>  </code><code class="n">poi_id</code><code class="p">,</code><code> </code><code class="n">name</code><code class="p">,</code><code> </code><code class="n">ST_AsText</code><code class="p">(</code><code class="o">`</code><code class="k">position</code><code class="o">`</code><code class="p">)</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">AS</code><code> </code><code class="o">`</code><code class="n">towers</code><code class="o">`</code><code> </code><code class="k">FROM</code><code> </code><code class="n">poi</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">ST_Within</code><code class="p">(</code><code> </code><code class="o">`</code><code class="k">position</code><code class="o">`</code><code class="p">,</code><code> </code><code class="o">@</code><code class="n">poly</code><code class="p">)</code><code> </code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">--------+----------------+------------------------+
</code><code class="o">|</code><code> </code><code class="n">poi_id</code><code> </code><code class="o">|</code><code> </code><code class="n">name</code><code>           </code><code class="o">|</code><code> </code><code class="n">towers</code><code>                 </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">--------+----------------+------------------------+
</code><code class="o">|</code><code>      </code><code class="mi">1</code><code> </code><code class="o">|</code><code> </code><code class="n">Maiden</code><code class="err">'</code><code class="n">s</code><code> </code><code class="n">Tower</code><code> </code><code class="o">|</code><code> </code><code class="n">POINT</code><code class="p">(</code><code class="mi">41</code><code class="p">.</code><code class="mi">0211</code><code> </code><code class="mi">29</code><code class="p">.</code><code class="mi">0041</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>      </code><code class="mi">2</code><code> </code><code class="o">|</code><code> </code><code class="n">Galata</code><code> </code><code class="n">Tower</code><code>   </code><code class="o">|</code><code> </code><code class="n">POINT</code><code class="p">(</code><code class="mi">41</code><code class="p">.</code><code class="mi">0256</code><code> </code><code class="mi">28</code><code class="p">.</code><code class="mi">9742</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">--------+----------------+------------------------+
</code><code class="mi">2</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>Check whether the spatial index used or not? </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code>  </code><code class="k">SELECT</code><code>  </code><code class="n">poi_id</code><code class="p">,</code><code> </code><code class="n">name</code><code class="p">,</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">ST_AsText</code><code class="p">(</code><code class="o">`</code><code class="k">position</code><code class="o">`</code><code class="p">)</code><code> </code><code class="k">AS</code><code> </code><code class="o">`</code><code class="n">towers</code><code class="o">`</code><code> </code><code class="k">FROM</code><code> </code><code class="n">poi</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">ST_Within</code><code class="p">(</code><code> </code><code class="o">`</code><code class="k">position</code><code class="o">`</code><code class="p">,</code><code> </code><code class="o">@</code><code class="n">poly</code><code class="p">)</code><code> </code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">poi</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="n">range</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="k">position</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="k">position</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">34</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">2</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="21.11 Creating and Using Histograms"><div class="sect1" id="nch-queryperf-queryperf-histograms"><h1>21.11 Creating and Using Histograms</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820316996384"><h2>Problem</h2><p>You want to join two or more tables,but  MySQL’s optimizer does not choose the right query plan. 
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820316995376"><h2>Solution</h2><p>Use optimizer histograms to aid decision making.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820316994496"><h2>Discussion</h2><p>
        Indexes are helpful for resolving query plans but they could not always be used to create the best query execution plan. This applies to situations when the optimizer needs to identify order in which to join two or more tables.
      </p><p>
        Assume you have two tables. One stores product categories in a shop and another stores sales data. Number of categories is small while number of sold items is huge. You may have a dozen categories and millions of sold items. When you join two tables MySQL has to decide which table to query first. If it queries small table first it has to retrieve all items in the selected category, then filter them. If number of items in the selected category is huge and number of filtered items is small query would be not effective. On the other side, if you need items from the single category while range, selected from the larger table, returns many rows from all categories you will have to discard them all except single category.
      </p><p>
        One of solutions to this issue is to have a combined index that takes category id and condition in the larger table. But this solution may not work for complicated queries when such a combined index is not applicable to the combinarion of the <code>WHERE</code> condition and <code>JOIN</code> clause.
      </p><p>
        Another issue with indexes is that they operate by cardinality: number of unique values in the index. But when data distribution is not even optimizer can make false conclusions when uses cardinality only. Assume you have one million items with certain characteristic and 10 items with another one. If the optimizer decides to select data that satisfy first condition the query would take much more time if compare with one that first selects items that satisfy the second one. Unfortunately it is not possible to make correct conclusion using information about cardinality only.
      </p><p>
        To resolve this issue MySQL 8.0 introduces optimizer histograms. They are a lightweight data structure that store information about how many unique values exist in each data bucket.
      </p><p>
        To illustrate how optimizer histograms work let’s consider a table of six rows.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">CREATE</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">histograms</code><code class="p">(</code><code class="n">f1</code><code> </code><code class="nb">INT</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">03</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">histograms</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="p">,</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code class="p">,</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code class="p">,</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code><code class="p">,</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code><code class="p">,</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">6</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>
</code><code class="n">Records</code><code class="p">:</code><code> </code><code class="mi">6</code><code>  </code><code class="n">Duplicates</code><code class="p">:</code><code> </code><code class="mi">0</code><code>  </code><code class="n">Warnings</code><code class="p">:</code><code> </code><code class="mi">0</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="n">f1</code><code class="p">,</code><code> </code><code class="k">COUNT</code><code class="p">(</code><code class="n">f1</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">histograms</code><code> </code><code class="k">GROUP</code><code> </code><code class="k">BY</code><code> </code><code class="n">f1</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">------+-----------+
</code><code class="o">|</code><code> </code><code class="n">f1</code><code>   </code><code class="o">|</code><code> </code><code class="k">COUNT</code><code class="p">(</code><code class="n">f1</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">------+-----------+
</code><code class="o">|</code><code>    </code><code class="mi">1</code><code> </code><code class="o">|</code><code>         </code><code class="mi">1</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>    </code><code class="mi">2</code><code> </code><code class="o">|</code><code>         </code><code class="mi">2</code><code> </code><code class="o">|</code><code>
</code><code class="o">|</code><code>    </code><code class="mi">3</code><code> </code><code class="o">|</code><code>         </code><code class="mi">3</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">------+-----------+
</code><code class="mi">3</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      As you see the table contains one row with value 1, two rows with value 2 and three rows with value 3.
    </p><p>
      If we run <code>EXPLAIN</code> on queries, selecting different rows in this table we will notice that number of rows, filtered from the result is same no matter which value we are looking for.
    </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="err">\</code><code class="n">P</code><code> </code><code class="n">grep</code><code> </code><code class="n">filtered</code></strong><code>
</code><code class="n">PAGER</code><code> </code><code class="k">set</code><code> </code><code class="k">to</code><code> </code><code class="s1">'grep filtered'</code><code>
</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">histograms</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">f1</code><code class="o">=</code><code class="mi">1</code><code class="err">\</code><code class="k">G</code></strong><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">16</code><code class="p">.</code><code class="mi">67</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">histograms</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">f1</code><code class="o">=</code><code class="mi">2</code><code class="err">\</code><code class="k">G</code></strong><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">16</code><code class="p">.</code><code class="mi">67</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">histograms</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">f1</code><code class="o">=</code><code class="mi">3</code><code class="err">\</code><code class="k">G</code></strong><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">16</code><code class="p">.</code><code class="mi">67</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        Number of filtered rows shows how many rows would be filtered from the retrieved result. Since our table does not have indexes MySQL first retrieves all rows from the table then filters those which satisfy condition. Without any hint optimizer thinks that MySQL will leave only one row from the result no matter which condition we use.
      </p><p>
        Let’s create a histogram and check if it changes anything.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">ANALYZE</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">histograms</code><code> </code><code class="k">UPDATE</code><code> </code><code class="n">HISTOGRAM</code><code> </code><code class="k">ON</code><code> </code><code class="n">f1</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
   </code><code class="k">Table</code><code class="p">:</code><code> </code><code class="n">cookbook</code><code class="p">.</code><code class="n">histograms</code><code>
      </code><code class="n">Op</code><code class="p">:</code><code> </code><code class="n">histogram</code><code>
</code><code class="n">Msg_type</code><code class="p">:</code><code> </code><code class="n">status</code><code>
</code><code class="n">Msg_text</code><code class="p">:</code><code> </code><code class="n">Histogram</code><code> </code><code class="k">statistics</code><code> </code><code class="n">created</code><code> </code><code class="k">for</code><code> </code><code class="k">column</code><code> </code><code class="s1">'f1'</code><code class="p">.</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        Histograms are stored in the data dictionary table <code>column_statistics</code> and can be examined by querying table <code>COLUMN_STATISTICS</code> in Information Schema.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">information_schema</code><code class="p">.</code><code class="n">column_statistics</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="k">table_name</code><code class="o">=</code><code class="s1">'histograms'</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
</code><code class="k">SCHEMA_NAME</code><code class="p">:</code><code> </code><code class="n">cookbook</code><code>
 </code><code class="k">TABLE_NAME</code><code class="p">:</code><code> </code><code class="n">histograms</code><code>
</code><code class="k">COLUMN_NAME</code><code class="p">:</code><code> </code><code class="n">f1</code><code>
  </code><code class="n">HISTOGRAM</code><code class="p">:</code><code> </code><code class="err">{</code><code class="ss">"buckets"</code><code class="p">:</code><code> </code><code class="p">[</code><code class="p">[</code><code class="mi">1</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">.</code><code class="mi">16666666666666666</code><code class="p">]</code><code class="p">,</code><code> </code><code class="p">[</code><code class="mi">2</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">.</code><code class="mi">5</code><code class="p">]</code><code class="p">,</code><code> </code><code class="p">[</code><code class="mi">3</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">.</code><code class="mi">0</code><code class="p">]</code><code class="p">]</code><code class="p">,</code><code> 
              </code><code class="ss">"data-type"</code><code class="p">:</code><code> </code><code class="ss">"int"</code><code class="p">,</code><code> 
              </code><code class="ss">"null-values"</code><code class="p">:</code><code> </code><code class="mi">0</code><code class="p">.</code><code class="mi">0</code><code class="p">,</code><code> 
              </code><code class="ss">"collation-id"</code><code class="p">:</code><code> </code><code class="mi">8</code><code class="p">,</code><code> 
              </code><code class="ss">"last-updated"</code><code class="p">:</code><code> </code><code class="ss">"2021-05-23 17:29:46.595599"</code><code class="p">,</code><code> 
              </code><code class="ss">"sampling-rate"</code><code class="p">:</code><code> </code><code class="mi">1</code><code class="p">.</code><code class="mi">0</code><code class="p">,</code><code> 
              </code><code class="ss">"histogram-type"</code><code class="p">:</code><code> </code><code class="ss">"singleton"</code><code class="p">,</code><code> 
              </code><code class="ss">"number-of-buckets-specified"</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="err">}</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        Three buckets contain information about data ranges. Value 1 takes 1/6 of the table (one row out of six), values 1 and 2 both take a half (0.5) of the table and together with value 3 they fill the table. Number of items in each bucket stored as fraction of one. Field <code>number-of-buckets-specified</code> contains number of buckets, specified at the histogram creation time. Default value is 100 but you are free to specify any number between 1 and 1024. If number of unique elements in the column exceeds number of buckets <code>histogram-type</code> will change from <code>singleton</code> to <code>equi-height</code> and each bucket could contain a range of values instead of only one in case of <code>singleton</code>.
      </p><p>
        Histograms affect the value for the <code>filtered</code> field in the <code>EXPLAIN</code> output.
      </p><p>
        In the example below values for the filtered rows correct and reflect content of the table. In case if we search value 1, five of six table rows are predicted to be removed from the result set, which correct. For the value 2 only two rows (33.33%) would be left in the result, and in case of value 3 half of the table will be filtered.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="err">\</code><code class="n">P</code><code> </code><code class="n">grep</code><code> </code><code class="n">filtered</code></strong><code>
</code><code class="n">PAGER</code><code> </code><code class="k">set</code><code> </code><code class="k">to</code><code> </code><code class="s1">'grep filtered'</code><code>
</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">histograms</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">f1</code><code class="o">=</code><code class="mi">1</code><code class="err">\</code><code class="k">G</code></strong><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">16</code><code class="p">.</code><code class="mi">67</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">histograms</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">f1</code><code class="o">=</code><code class="mi">2</code><code class="err">\</code><code class="k">G</code></strong><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">33</code><code class="p">.</code><code class="mi">33</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">histograms</code><code> </code><code class="k">WHERE</code><code> </code><code class="n">f1</code><code class="o">=</code><code class="mi">3</code><code class="err">\</code><code class="k">G</code></strong><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">50</code><code class="p">.</code><code class="mi">00</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        Histograms do not help to access data: they are statistic only, not physical structure like indexes. They, instead, affect query execution plan and, particularly, order of tables joined. For example, if we decide to join <code>histograms</code> table with itself order will be different depending from the condition.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="err">\</code><code class="n">P</code><code> </code><code class="n">grep</code><code> </code><code class="o">-</code><code class="n">B</code><code> </code><code class="mi">3</code><code> </code><code class="k">table</code></strong><code>
</code><code class="n">PAGER</code><code> </code><code class="k">set</code><code> </code><code class="k">to</code><code> </code><code class="s1">'grep -B 3 table'</code><code>
</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">histograms</code><code> </code><code class="n">h1</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">histograms</code><code> </code><code class="n">h2</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">h1</code><code class="p">.</code><code class="n">f1</code><code class="o">=</code><code class="mi">1</code><code> </code><code class="k">and</code><code> </code><code class="n">h2</code><code class="p">.</code><code class="n">f1</code><code class="o">=</code><code class="mi">3</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">h1</code><code>
</code><code class="c1">--
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">h2</code><code>
</code><code class="mi">2</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">histograms</code><code> </code><code class="n">h1</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">histograms</code><code> </code><code class="n">h2</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">h1</code><code class="p">.</code><code class="n">f1</code><code class="o">=</code><code class="mi">3</code><code> </code><code class="k">and</code><code> </code><code class="n">h2</code><code class="p">.</code><code class="n">f1</code><code class="o">=</code><code class="mi">1</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">h2</code><code>
</code><code class="c1">--
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">h1</code><code>
</code><code class="mi">2</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        The true power of histograms are demonstrated on large tables. The companion GitHub repository has data for two tables: <code>goods_shops</code> and <code>goods_characteristics</code>. They are created without histograms by default while having indexes.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="o">`</code><code class="n">goods_shops</code><code class="o">`</code> <code class="p">(</code>
  <code class="o">`</code><code class="n">id</code><code class="o">`</code> <code class="nb">int</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="n">AUTO_INCREMENT</code><code class="p">,</code>
  <code class="o">`</code><code class="n">good_id</code><code class="o">`</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code> <code class="k">DEFAULT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="o">`</code><code class="n">location</code><code class="o">`</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code> <code class="k">DEFAULT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="o">`</code><code class="n">delivery_options</code><code class="o">`</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code> <code class="k">DEFAULT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="o">`</code><code class="n">id</code><code class="o">`</code><code class="p">),</code>
  <code class="k">KEY</code> <code class="o">`</code><code class="n">good_id</code><code class="o">`</code> <code class="p">(</code><code class="o">`</code><code class="n">good_id</code><code class="o">`</code><code class="p">,</code><code class="o">`</code><code class="n">location</code><code class="o">`</code><code class="p">,</code><code class="o">`</code><code class="n">delivery_options</code><code class="o">`</code><code class="p">),</code>
  <code class="k">KEY</code> <code class="o">`</code><code class="n">location</code><code class="o">`</code> <code class="p">(</code><code class="o">`</code><code class="n">location</code><code class="o">`</code><code class="p">,</code><code class="o">`</code><code class="n">delivery_options</code><code class="o">`</code><code class="p">)</code>
<code class="p">);</code>

<code class="k">CREATE</code> <code class="k">TABLE</code> <code class="o">`</code><code class="n">goods_characteristics</code><code class="o">`</code> <code class="p">(</code>
  <code class="o">`</code><code class="n">id</code><code class="o">`</code> <code class="nb">int</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="n">AUTO_INCREMENT</code><code class="p">,</code>
  <code class="o">`</code><code class="n">good_id</code><code class="o">`</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code> <code class="k">DEFAULT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="o">`</code><code class="k">size</code><code class="o">`</code> <code class="nb">int</code> <code class="k">DEFAULT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="o">`</code><code class="n">manufacturer</code><code class="o">`</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code> <code class="k">DEFAULT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="o">`</code><code class="n">id</code><code class="o">`</code><code class="p">),</code>
  <code class="k">KEY</code> <code class="o">`</code><code class="n">good_id</code><code class="o">`</code> <code class="p">(</code><code class="o">`</code><code class="n">good_id</code><code class="o">`</code><code class="p">,</code><code class="o">`</code><code class="k">size</code><code class="o">`</code><code class="p">,</code><code class="o">`</code><code class="n">manufacturer</code><code class="o">`</code><code class="p">),</code>
  <code class="k">KEY</code> <code class="o">`</code><code class="k">size</code><code class="o">`</code> <code class="p">(</code><code class="o">`</code><code class="k">size</code><code class="o">`</code><code class="p">,</code><code class="o">`</code><code class="n">manufacturer</code><code class="o">`</code><code class="p">)</code>
<code class="p">);</code></pre><p>
        If we want to find number of laptops with screen size that is less than 13 inches and the manufacturer one of Lenovo, Dell, Toshiba, Samsung or Acer, available by Premium or Urgent delivery in Moscow or Kiev we may use a following query.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="k">COUNT</code><code class="p">(</code><code class="o">*</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">goods_shops</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">JOIN</code><code> </code><code class="n">goods_characteristics</code><code> </code><code class="k">USING</code><code> </code><code class="p">(</code><code class="n">good_id</code><code class="p">)</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="k">size</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">13</code><code> </code><code class="k">AND</code><code> </code><code class="n">manufacturer</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Lenovo'</code><code class="p">,</code><code> </code><code class="s1">'Dell'</code><code class="p">,</code><code> </code><code class="s1">'Toshiba'</code><code class="p">,</code><code> </code><code class="s1">'Samsung'</code><code class="p">,</code><code> </code><code class="s1">'Acer'</code><code class="p">)</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">AND</code><code> </code><code class="p">(</code><code class="n">location</code><code> </code><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Moscow'</code><code class="p">,</code><code> </code><code class="s1">'Kiev'</code><code class="p">)</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">OR</code><code> </code><code class="n">delivery_options</code><code> </code><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Premium'</code><code class="p">,</code><code> </code><code class="s1">'Urgent'</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----------+
</code><code class="o">|</code><code> </code><code class="k">count</code><code class="p">(</code><code class="o">*</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------+
</code><code class="o">|</code><code>   </code><code class="mi">816640</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">6</code><code> </code><code class="k">min</code><code> </code><code class="mi">31</code><code class="p">,</code><code class="mi">75</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        The query took over 6 minutes, which is quite long for two tables of less than half-million rows. Reason for this is that table <code>goods_shops</code> contains just few rows that satisfy condition for the shop location and delivery options while table <code>goods_characteristics</code> has much more rows that satisfy laptop size and manufacturer condition. In such a situation it would be better to select data from the table <code>goods_shops</code> first while optimizers decides opposite.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="k">COUNT</code><code class="p">(</code><code class="o">*</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">goods_shops</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">goods_characteristics</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">USING</code><code class="p">(</code><code class="n">good_id</code><code class="p">)</code><code> </code><code class="k">WHERE</code><code> </code><code class="k">size</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">13</code><code> </code><code class="k">AND</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">manufacturer</code><code> </code><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Lenovo'</code><code class="p">,</code><code> </code><code class="s1">'Dell'</code><code class="p">,</code><code> </code><code class="s1">'Toshiba'</code><code class="p">,</code><code> </code><code class="s1">'Samsung'</code><code class="p">,</code><code> </code><code class="s1">'Acer'</code><code class="p">)</code><code> </code><code class="k">AND</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="n">location</code><code> </code><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Moscow'</code><code class="p">,</code><code> </code><code class="s1">'Kiev'</code><code class="p">)</code><code> </code><code class="k">OR</code><code> </code><code class="n">delivery_options</code><code> </code><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Premium'</code><code class="p">,</code><code> </code><code class="s1">'Urgent'</code><code class="p">)</code><code class="p">)</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">goods_characteristics</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">index</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">good_id</code><code class="p">,</code><code class="k">size</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">good_id</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">251</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">137026</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">25</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code class="p">;</code><code> </code><code class="k">Using</code><code> </code><code class="k">index</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">goods_shops</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">ref</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">good_id</code><code class="p">,</code><code class="n">location</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">good_id</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">123</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="n">cookbook</code><code class="p">.</code><code class="n">goods_characteristics</code><code class="p">.</code><code class="n">good_id</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">66422</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">36</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code class="p">;</code><code> </code><code class="k">Using</code><code> </code><code class="k">index</code><code>
</code><code class="mi">2</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        Indexes would not help here, because they use cardinality that is same for the any value in the indexed column. Here is when histograms can show their power.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">ANALYZE</code><code> </code><code class="k">TABLE</code><code> </code><code class="n">goods_shops</code><code> </code><code class="k">UPDATE</code><code> </code><code class="n">HISTOGRAM</code><code> </code><code class="k">ON</code><code> </code><code class="n">location</code><code class="p">,</code><code> </code><code class="n">delivery_options</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
   </code><code class="k">Table</code><code class="p">:</code><code> </code><code class="n">cookbook</code><code class="p">.</code><code class="n">goods_shops</code><code>
      </code><code class="n">Op</code><code class="p">:</code><code> </code><code class="n">histogram</code><code>
</code><code class="n">Msg_type</code><code class="p">:</code><code> </code><code class="n">status</code><code>
</code><code class="n">Msg_text</code><code class="p">:</code><code> </code><code class="n">Histogram</code><code> </code><code class="k">statistics</code><code> </code><code class="n">created</code><code> </code><code class="k">for</code><code> </code><code class="k">column</code><code> </code><code class="s1">'delivery_options'</code><code class="p">.</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
   </code><code class="k">Table</code><code class="p">:</code><code> </code><code class="n">cookbook</code><code class="p">.</code><code class="n">goods_shops</code><code>
      </code><code class="n">Op</code><code class="p">:</code><code> </code><code class="n">histogram</code><code>
</code><code class="n">Msg_type</code><code class="p">:</code><code> </code><code class="n">status</code><code>
</code><code class="n">Msg_text</code><code class="p">:</code><code> </code><code class="n">Histogram</code><code> </code><code class="k">statistics</code><code> </code><code class="n">created</code><code> </code><code class="k">for</code><code> </code><code class="k">column</code><code> </code><code class="s1">'location'</code><code class="p">.</code><code>
</code><code class="mi">2</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">24</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="k">COUNT</code><code class="p">(</code><code class="o">*</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">goods_shops</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">goods_characteristics</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">USING</code><code class="p">(</code><code class="n">good_id</code><code class="p">)</code><code> </code><code class="k">WHERE</code><code> </code><code class="k">size</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">13</code><code> </code><code class="k">AND</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">manufacturer</code><code> </code><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Lenovo'</code><code class="p">,</code><code> </code><code class="s1">'Dell'</code><code class="p">,</code><code> </code><code class="s1">'Toshiba'</code><code class="p">,</code><code> </code><code class="s1">'Samsung'</code><code class="p">,</code><code> </code><code class="s1">'Acer'</code><code class="p">)</code><code> </code><code class="k">AND</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="n">location</code><code> </code><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Moscow'</code><code class="p">,</code><code> </code><code class="s1">'Kiev'</code><code class="p">)</code><code> </code><code class="k">OR</code><code> </code><code class="n">delivery_options</code><code> </code><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Premium'</code><code class="p">,</code><code> </code><code class="s1">'Urgent'</code><code class="p">)</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----------+
</code><code class="o">|</code><code> </code><code class="k">COUNT</code><code class="p">(</code><code class="o">*</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------+
</code><code class="o">|</code><code>   </code><code class="mi">816640</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">1</code><code class="p">,</code><code class="mi">42</code><code> </code><code class="n">sec</code><code class="p">)</code><code>

</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="k">COUNT</code><code class="p">(</code><code class="o">*</code><code class="p">)</code><code> </code><code class="k">FROM</code><code> </code><code class="n">goods_shops</code><code> </code><code class="k">JOIN</code><code> </code><code class="n">goods_characteristics</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">USING</code><code class="p">(</code><code class="n">good_id</code><code class="p">)</code><code> </code><code class="k">WHERE</code><code> </code><code class="k">size</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">13</code><code> </code><code class="k">AND</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="n">manufacturer</code><code> </code><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Lenovo'</code><code class="p">,</code><code> </code><code class="s1">'Dell'</code><code class="p">,</code><code> </code><code class="s1">'Toshiba'</code><code class="p">,</code><code> </code><code class="s1">'Samsung'</code><code class="p">,</code><code> </code><code class="s1">'Acer'</code><code class="p">)</code><code> </code><code class="k">AND</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="p">(</code><code class="n">location</code><code> </code><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Moscow'</code><code class="p">,</code><code> </code><code class="s1">'Kiev'</code><code class="p">)</code><code> </code><code class="k">OR</code><code> </code><code class="n">delivery_options</code><code> </code><code class="k">IN</code><code> </code><code class="p">(</code><code class="s1">'Premium'</code><code class="p">,</code><code> </code><code class="s1">'Urgent'</code><code class="p">)</code><code class="p">)</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">goods_shops</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">index</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">good_id</code><code class="p">,</code><code class="n">location</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">good_id</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">369</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">66422</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">0</code><code class="p">.</code><code class="mi">09</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code class="p">;</code><code> </code><code class="k">Using</code><code> </code><code class="k">index</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">goods_characteristics</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="k">ref</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">good_id</code><code class="p">,</code><code class="k">size</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">good_id</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">123</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="n">cookbook</code><code class="p">.</code><code class="n">goods_shops</code><code class="p">.</code><code class="n">good_id</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">137026</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">25</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code class="p">;</code><code> </code><code class="k">Using</code><code> </code><code class="k">index</code><code>
</code><code class="mi">2</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        Once a histogram is created, the optimizer joins tables in the effective order and query takes slightly more than one second instead of six minutes in the previous run.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820316994128"><h2>See Also</h2><p>For additional information about using histograms in MySQL, see <a href="https://www.percona.com/resources/webinars/billion-goods-few-categories-how-histograms-save-life">Billion Goods in Few Categories: How Histograms Save a Life?</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="21.12 Writing Performant Queries"><div class="sect1" id="nch-queryperf-queryperf-writing"><h1>21.12 Writing Performant Queries</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820314552880"><h2>Problem</h2><p>You want to write efficient queries.
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820314551936"><h2>Solution</h2><p>Study how MySQL accesses data and adjust your queries to help MySQL perform its job faster.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820314550880"><h2>Discussion</h2><p>As we’ve seen in this chapter, there are many iterations of index 
      implementation in MySQL. While, we take advantage of these 
      index types, we also need to know how MySQL accesses data. The optimizer 
      is a very advanced part of MySQL but still does not always make correct 
      decisions. When it doesn’t choose the right path, we’ll end up with poor 
      query performance, which may lead to degraded service or outage in our 
      applications at production. The best way to writing performant queries is 
      to know how MySQL accesses data. 
      </p><p>The other point here is being at scale is different than using 
      the application in a monolith environment. As the concurrency increases 
      with data size, the decision optimizer will choose the fastest data 
      route that will be more complex to handle.</p><p>MySQL uses a cost-based model to estimate the cost of various operations during query execution in the following order.</p><ol><li><p>Find the optimal method.</p></li><li><p>Check if the access method useful.</p></li><li><p>Estimate the cost of using the access method.</p></li><li><p>Select the lowest cost access method possible. </p></li></ol><p>Here’s the order of Query Execution that MySQL chooses:</p><ol><li><p>Table Scan</p></li><li><p>Index Scan</p></li><li><p>Index Lookup</p></li><li><p>Range Scan </p></li><li><p>Index Merge </p></li><li><p>Loose Index Scan </p></li></ol><p>
The following are some known reasons for slow index lookups for those still using an 
index with poor performance outcomes.
</p><dl><dt>Low cardinality</dt><dd><p>
When data is not diverse enough to identify a  
fast traversal, MySQL will end up doing a full table scan. 
</p></dd><dt>Large data sets</dt><dd><p>Returning large data sets often causes problems. Even if they
are correctly filtered they may be useless as your application can’t process them fast
enough. Only target data that are needed in your query and filter the rest 
out. 
</p></dd><dt>Multiple index traversal</dt><dd><p>If you have a query hitting multiple indexes, the extra 
I/O  operation hopping through pages will lead to slow query performance. 
</p></dd><dt>Non-leading column lookup</dt><dd><p>If you do not use the leading column for a covering index, a covering index cannot be used. 
</p></dd><dt>Data type mismatch</dt><dd><p>Indexes can not help if data types don’t match when 
querying columns. 
</p></dd><dt> Character Set / Collation mismatch</dt><dd><p>Data access should be unified around 
the character set and collation of the query. 
</p></dd><dt>Suffix lookup</dt><dd><p>Looking for a suffix will degrade performance significantly. 
</p></dd><dt>Index as argument</dt><dd><p>Using an indexed column as an argument will not 
efficiently use the index. 
</p></dd><dt>Stale Statistics</dt><dd><p>MySQL updates statistics based on the index cardinality. 
This helps the optimizer to make decisions for the fastest path possible. 
</p></dd><dt>MySQL Bug</dt><dd><p>It’s rare, but a possible. MySQL bug can cause slow index lookups. 
</p></dd></dl><section data-type="sect3" data-pdf-bookmark="Query types"><div class="sect3" id="idm45820314545344"><h3>Query types</h3><p>
  When designing the application it is useful to recognize common query patterns, when they can be applied and when not.
</p><dl><dt>Point Select</dt><dd><p>
One of the fastest methods to access your data is to do a point select 
targeting indexed column directly. In this case, the optimizer already knows 
the page that your data sits on if the index exists in that column. 
</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT names_id,top_name,name_rank FROM top_names </code></strong>
    -&gt; <strong><code>WHERE names_id=699 \G</code></strong>
*************************** 1. row ***************************
 names_id: 699
 top_name: KOCH
name_rank: 698
1 row in set (0.00 sec)</pre><p>in this case,<code>names_id</code> column, is the Primary
     Key column of the table, so the access is straight to that page’s path 
     by the optimizer. 
     </p></dd><dt>Range Select</dt><dd><p>                    
This type of <code>SELECT</code> is when you need a range of rows from your data set. 
MySQL can still use an index to access the data directly using the index on 
the same column as in <code>WHERE</code> clause of the query. 
This type of access method uses a single index or subset of values from an index or indexes. 
The range index is also known as using single or multi-part index utilization. In the following example,
the optimizer uses comparison on <code>name_rank</code> field with <code>&lt;</code> and <code>&gt;</code> operators. Also, for all index types, 
<code>AND</code> or <code>OR</code> combinations will be a range condition. 
For MySQL fastest lookup is Primary Key. Remember this is also the physical order of the table. </p><pre data-type="programlisting">mysql&gt; <strong><code>EXPLAIN SELECT names_id,top_name,name_rank FROM top_names </code></strong>
    -&gt; <strong><code>WHERE names_id&gt;800 AND names_id &lt; 900 \G</code></strong>
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: top_names
   partitions: NULL
         type: range
possible_keys: PRIMARY
          key: PRIMARY
      key_len: 4
          ref: NULL
         rows: 99
     filtered: 100.00
        Extra: Using where
1 row in set, 1 warning (0.00 sec)</pre></dd><dt>Covering Indexes</dt><dd><p>
Covering indexes are indexes that could be used to resolve the query without accessing rows data.


To make sure other supporting indexes cover your query, we should use 
secondary indexes at times.  An index should be leftmost first and each 
additional field in a composite key. Query should not access columns that do not exist in the index (see <a data-type="xref" href="#nch-queryperf-queryperf-index-mulitple">Recipe 21.5</a>).</p><p>
  The following example, index used to resolve query condition without accessing table data but in the end table data is accessed, because we asked for the <code>top_name</code> column that does not exist in the index. Statement <code>Using index condition</code> in the <code>Extra</code> field of the <code>EXPLAIN</code> output confirms that.
</p><pre data-type="programlisting">mysql&gt; <strong><code>EXPLAIN SELECT name_rank,top_name,name_count</code></strong>
 -&gt; <strong><code>FROM top_names WHERE name_rank &lt; 10 ORDER BY name_count\G</code></strong>
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: top_names
   partitions: NULL
         type: range
possible_keys: idx_name_rank_count
          key: idx_name_rank_count
      key_len: 3
          ref: NULL
         rows: 10
     filtered: 100.00
        Extra: Using index condition; Using filesort
1 row in set, 1 warning (0.00 sec)</pre><p>
  This query uses covering index. Statement <code>Using index</code> confirms that. A primary key is already part of the covering index; hence no need
   to include <code>names_id</code> into the covering index. </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">EXPLAIN</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">names_id</code><code class="p">,</code><code> </code><code class="n">name_rank</code><code class="p">,</code><code> </code><code class="n">name_count</code><code> </code><code class="k">FROM</code><code> </code><code class="n">top_names</code><code> </code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code class="k">WHERE</code><code> </code><code class="n">name_rank</code><code> </code><code class="o">&lt;</code><code> </code><code class="mi">10</code><code> </code><code class="k">ORDER</code><code> </code><code class="k">BY</code><code> </code><code class="n">name_count</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
           </code><code class="n">id</code><code class="p">:</code><code> </code><code class="mi">1</code><code>
  </code><code class="n">select_type</code><code class="p">:</code><code> </code><code class="k">SIMPLE</code><code>
        </code><code class="k">table</code><code class="p">:</code><code> </code><code class="n">top_names</code><code>
   </code><code class="n">partitions</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">type</code><code class="p">:</code><code> </code><code class="n">range</code><code>
</code><code class="n">possible_keys</code><code class="p">:</code><code> </code><code class="n">idx_name_rank_count</code><code>
          </code><code class="k">key</code><code class="p">:</code><code> </code><code class="n">idx_name_rank_count</code><code>
      </code><code class="n">key_len</code><code class="p">:</code><code> </code><code class="mi">3</code><code>
          </code><code class="k">ref</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
         </code><code class="k">rows</code><code class="p">:</code><code> </code><code class="mi">10</code><code>
     </code><code class="n">filtered</code><code class="p">:</code><code> </code><code class="mi">100</code><code class="p">.</code><code class="mi">00</code><code>
        </code><code class="n">Extra</code><code class="p">:</code><code> </code><code class="k">Using</code><code> </code><code class="k">where</code><code class="p">;</code><code> </code><code class="k">Using</code><code> </code><code class="k">index</code><code class="p">;</code><code> </code><code class="k">Using</code><code> </code><code class="n">filesort</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code class="p">,</code><code> </code><code class="mi">1</code><code> </code><code class="n">warning</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">,</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre></dd><dt>Data type matching</dt><dd><p>
Data types are another crucial fact to use indexes efficiently. 
Using numeric for numeric comparison is essential for the optimizer. The 
following query is a bad example of how MySQL does not like this data type 
conversion when it comes down to <code>names_id</code> an <code>INTEGER</code> field with string. 
Below please see the warning message we get. </p><pre data-type="programlisting">mysql&gt; <strong><code>EXPLAIN SELECT names_id,top_name,name_rank FROM </code></strong>
    -&gt; <strong><code>top_names WHERE names_id= '123 names' \G</code></strong>
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: top_names
   partitions: NULL
         type: const
possible_keys: PRIMARY
          key: PRIMARY
      key_len: 4
          ref: const
         rows: 1
     filtered: 100.00
        Extra: NULL
1 row in set, 1 warning (0,00 sec)

mysql&gt; <strong><code>SHOW WARNINGS\G</code></strong>
*************************** 1. row ***************************
  Level: Warning
   Code: 1292
Message: Truncated incorrect DOUBLE value: '123 names'
*************************** 2. row ***************************
  Level: Note
   Code: 1003
Message: /* select#1 */ select '123' AS `names_id`,'WALLACE' AS `top_name`, ↩
         '123' AS `name_rank` from `cookbook`.`top_names` where true
2 rows in set (0,00 sec)</pre><p>
  While the query may return results MySQL has to perform job to convert string into number and loose precision.
</p></dd><dt>Negative conditions</dt><dd><p>Often times most efficient indexes can not be used for these types of 
queries. This is because MySQL has to select all rows from the table or index, then filter those which are not in the list.  </p><p>Avoid negative clauses if possible as they are inefficient:</p><ul><li><p>
<code>IS NOT</code> 
</p></li><li><p>
<code>IS NOT NULL</code>
</p></li><li><p>
<code>NOT IN</code> 
</p></li><li><p>
<code>NOT LIKE</code>
</p></li></ul><pre data-type="programlisting">mysql&gt; <strong><code>EXPLAIN SELECT names_id,name_rank, top_name FROM </code></strong>
    -&gt; <strong><code>top_names WHERE top_name NOT IN ("LARA","ILAYDA","ASLIHAN") \G</code></strong>
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: top_names
   partitions: NULL
         type: ALL
possible_keys: idx_top_name,idx_desc_01,idx_desc_02,idx_fulltext
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 161533
     filtered: 100.00
        Extra: Using where
1 row in set, 1 warning (0.00 sec)</pre></dd><dt>ORDER BY operations</dt><dd><p>Sorting operations can be expensive as the data set grows, especially if the query cannot use index to resolve <code>ORDER BY</code>.</p><pre data-type="programlisting">mysql&gt; <strong><code>EXPLAIN SELECT names_id,name_rank, top_name FROM </code></strong>
    -&gt; <strong><code>top_names WHERE name_rank &gt; 15000 ORDER BY top_name \G</code></strong>
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: top_names
   partitions: NULL
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 161533
     filtered: 33.33
        Extra: Using where; Using filesort
1 row in set, 1 warning (0.00 sec)</pre><p>The same applies to the <code>LIMIT</code> operations. These type of queries 
usually return a small set of data with high cost. </p><pre data-type="programlisting">mysql&gt; <strong><code>EXPLAIN SELECT names_id,name_rank, top_name FROM top_names WHERE </code></strong>
    -&gt; <strong><code>name_rank &gt; 15000 ORDER BY name_rank LIMIT 10\G</code></strong>
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: top_names
   partitions: NULL
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 161533
     filtered: 33.33
        Extra: Using where; Using filesort
1 row in set, 1 warning (0.00 sec)</pre><p>
  Query above selects large number of rows and then discards most of them.
</p></dd><dt>JOINs</dt><dd><p>
Join operations are an original way of combining or referencing data from 
two or more tables. While SQL joins serve a particular purpose, they can 
create a cartesian product on query results if not used properly. Using 
<code>INNER</code> joins to filter only the intersection of tables in <code>SELECT</code> statement 
is highly advised versus <code>LEFT JOIN</code>s. Although using 
<code>INNER JOIN</code> is not always possible to comply with the required business logic. 
In those cases, still targeting indexed fields will benefit query execution time. </p><pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="n">a</code><code class="p">.</code><code class="n">col_a</code><code class="p">,</code> <code class="n">a</code><code class="p">.</code><code class="n">col_b</code><code class="p">,</code> <code class="n">b</code><code class="p">.</code><code class="n">col_a</code> <code class="k">FROM</code> <code class="n">table_a</code> <code class="n">a</code>
<code class="k">INNER</code> <code class="k">JOIN</code> <code class="n">table_b</code> <code class="n">b</code>
<code class="k">ON</code> <code class="n">a</code><code class="p">.</code><code class="k">key</code> <code class="o">=</code> <code class="n">b</code><code class="p">.</code><code class="k">key</code><code class="p">;</code></pre><div data-type="tip"><h6>Tip</h6><p>
    In MySQL <code>JOIN</code> is a synonymous of <code>INNER JOIN</code>.
  </p></div></dd></dl><p>To help the optimizer to choose the best possible path to 
access your data by creating correct indexes and writing efficient queries. 
This type of approach will improve your throughput overall. 
Add only indexes you need and don’t over-index tables. Avoiding duplicate 
indexes another best practice to achieve performant queries. Identify if 
the same indexes in your table may cause a slow down on both reads and writes. 
</p></div></section></div></section></div></section></div></section></div></body></html>