<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 4. Access Control"><div class="chapter" id="access-control">
<h1><span class="label">Chapter 4. </span>Access Control</h1>


<p><a data-type="indexterm" data-primary="access control" id="ix_ch04-asciidoc0"/>After the wide scope in the previous chapter on all things shell and
scripting, we now focus on one specific and crucial security aspect in Linux.
In this chapter, we discuss the topic of users and controlling access to
resources in general and files in particular.</p>

<p>One question that immediately comes to mind in such a multiuser setup is ownership.
A user may own, for example, a file. They are allowed to read from the file,
write to the file, and also, say, delete it. Given that there are other users
on the system as well, what are those users allowed to do, and how is this defined and
enforced? There are also activities that you might not necessarily associate
with files in the first place. For example, a user may (or may not) be allowed to change
networking-related 
<span class="keep-together">settings.</span></p>

<p>To get a handle on this topic, we’ll first take a look at the fundamental
relationship between users, processes, and files, from an access perspective.
We’ll also review sandboxing and access control types.
Next, we’ll focus on the definition of a Linux user, what users can do,
and how to manage users either locally or alternatively from a central place.</p>

<p>Then, we’ll move on to the topic of permissions, where
we’ll look at how to control access to files and how processes are impacted
by such restrictions.</p>

<p>We’ll wrap up this chapter covering a range of advanced
Linux features in the access control space, including capabilities, seccomp profiles,
and ACLs. To round things off, we’ll provide some security good practices around
permissions and access 
<span class="keep-together">control.</span></p>

<p>With that, let’s jump right into the topic of users and resource ownership,
laying the basis for the rest of the chapter.</p>






<section data-type="sect1" data-pdf-bookmark="Basics"><div class="sect1" id="access-basics">
<h1>Basics</h1>

<p><a data-type="indexterm" data-primary="access control" data-secondary="basics" id="ix_ch04-asciidoc1"/>Before we get into access control mechanisms, let’s step back a little and
take a bird’s-eye view on the topic. This will help us to establish
some terminology and clarify relationships between the main concepts.</p>








<section data-type="sect2" data-pdf-bookmark="Resources and Ownership"><div class="sect2" id="resources-ownership">
<h2>Resources and Ownership</h2>

<p><a data-type="indexterm" data-primary="access control" data-secondary="resources and ownership" id="idm45805436965264"/><a data-type="indexterm" data-primary="ownership, access control and" id="idm45805436964064"/><a data-type="indexterm" data-primary="resources, access control and" id="idm45805436963424"/>Linux is a multiuser operating system and as such has inherited the concept of
a user (see <a data-type="xref" href="#users">“Users”</a>) from UNIX.
<a data-type="indexterm" data-primary="user account" id="idm45805436961744"/>Each user account is associated with a user ID that can be given access to
executables, files, devices, and other Linux assets. A human user can log in
with a user account, and a process can run as a user account.
Then, there are resources (which we will simply refer to as <em>files</em>), which are
any hardware or software components available to the user. In the general case,
we will refer to resources as files, unless we explicitly talk about access to
other kinds of resources, such as with syscalls. In <a data-type="xref" href="#fig-users-processes-files">Figure 4-1</a>
and the passage that follows, you see the high-level relationships between users, processes, and files in Linux.</p>

<figure><div id="fig-users-processes-files" class="figure">
<img src="Images/lmlx_0401.png" alt="lmlx 0401" width="600" height="287"/>
<h6><span class="label">Figure 4-1. </span>Users, processes, and files in Linux</h6>
</div></figure>
<dl>
<dt>Users</dt>
<dd>
<p>Launch processes and own files. A <em>process</em> is a program (executable file)
 that the kernel has loaded into main memory and runs.</p>
</dd>
<dt>Files</dt>
<dd>
<p>Have owners; by default, the user who creates the file owns it.</p>
</dd>
<dt>Processes</dt>
<dd>
<p>Use files for communication and persistency. Of course, users
  indirectly also use files, but they need to do so via processes.</p>
</dd>
</dl>

<p>This depiction of the relationships between users, processes, and files is of
course a very simplistic view, but it allows us to understand the
actors and their relationships and will come in handy later on when we discuss
the interaction between these different players in greater detail.</p>

<p>Let’s first look at the execution context of a process, addressing the question
of how restricted the process is. A term that we often come across when talking
about access to resources is <em>sandboxing</em>.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Sandboxing"><div class="sect2" id="sandboxing">
<h2>Sandboxing</h2>

<p><a data-type="indexterm" data-primary="access control" data-secondary="sandboxing" id="idm45805436949328"/><a data-type="indexterm" data-primary="sandboxing" id="idm45805436948352"/><em>Sandboxing</em> is a vaguely defined term and can refer to a range of different methods,
from jails to containers to virtual machines, which can be managed either in the
kernel or in user land. Usually there is something that runs in the
sandbox—typically some application—and the supervising mechanism
enforces a certain degree of isolation between the sandboxed process and the
hosting environment. If all of that sounds rather theoretical, I ask you for a
little bit of patience. We will see sandboxing in action later in this
chapter, in <a data-type="xref" href="#seccomp">“seccomp Profiles”</a>, and then again in <a data-type="xref" href="ch09.xhtml#advanced">Chapter 9</a> when we talk about VMs and
containers.</p>

<p>With a basic understanding of resources, ownership, and access to said
resources in your mind, let’s talk briefly about some conceptual ways
to go about access control.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Types of Access Control"><div class="sect2" id="types-of-access-control">
<h2>Types of Access Control</h2>

<p><a data-type="indexterm" data-primary="access control" data-secondary="types of" id="idm45805436943152"/>One aspect of access control is the nature of the access itself. Does a user or
process directly access a resource, maybe in an unrestricted manner? Or maybe there
is a clear set of rules about what kind of resources (files or syscalls) a process can access,
under what circumstances. Or maybe the access itself is even recorded.</p>

<p>Conceptually, there are different access control types. The two
most important and relevant to our discussion in the context of Linux are
<em>discretionary</em> and <em>mandatory</em> access control:</p>
<dl>
<dt>Discretionary access control</dt>
<dd>
<p><a data-type="indexterm" data-primary="DAC (Discretionary Access Control)" id="idm45805436939264"/><a data-type="indexterm" data-primary="Discretionary Access Control (DAC)" id="idm45805436938592"/>With discretionary access control (DAC), the idea is to restrict access to resources based on the identity of
the user. It’s discretionary in the sense that a user with certain permissions
can pass them on to other users.</p>
</dd>
<dt>Mandatory access control</dt>
<dd>
<p><a data-type="indexterm" data-primary="mandatory access control" id="idm45805436936464"/>Mandatory access control is based on a hierarchical model representing security levels. Users are assigned a
clearance level, and resources are assigned a security label.
Users can only access resources corresponding to a clearance level equal to
(or lower than) their own. In a mandatory access control model, an admin strictly and exclusively
controls access, setting all permissions. In other words, users cannot set
permissions themselves, even when they own the resource.</p>
</dd>
</dl>

<p>In addition, Linux traditionally has an all-or-nothing attitude—that is,
you are either a superuser who has the power to change everything or you are a normal user
with limited access. Initially, there was no easy and flexible way to assign a
user or process certain privileges. For example, in the general case, to enable
that “process X is allowed to change networking settings,” you
had to give it <code>root</code> access. This, naturally, has a concrete impact on a system
that is breached: an attacker can misuse these wide privileges easily.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>To qualify the “all-or-nothing attitude” in Linux a bit: the defaults in most
Linux systems allow read access to almost every file and executable by “others”—that is, all users on the system. <a data-type="indexterm" data-primary="SELinux" id="idm45805436933184"/>For example, with SELinux
enabled, mandatory access control restricts access to only those assets that are explicitly given
permission. So, for example, a web server can only use ports 80 and 443,
only share files and scripts from specific directories, only write logs to
specific places, and so on.</p>
</div>

<p>We’ll revisit this topic in <a data-type="xref" href="#advanced-permissions">“Advanced Permission Management”</a> and
see how modern Linux features can help overcome this binary worldview, allowing
for more fine-grained management of privileges.</p>

<p>Probably the best-known implementation of mandatory access control for Linux is
<a href="https://oreil.ly/HAOBS">SELinux</a>. It was developed to meet
the high security requirements of government agencies and is usually
used in these environments since the usability suffers from the strict
rules. Another option for mandatory access control, included in the Linux kernel since version 2.6.36
and rather popular in the Ubuntu family of Linux distributions, is
<a href="https://oreil.ly/rp4Fq">AppArmor</a>.<a data-type="indexterm" data-startref="ix_ch04-asciidoc1" id="idm45805436928784"/></p>

<p>Let’s now move on to the topic of users and how to manage them in Linux.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Users"><div class="sect1" id="users">
<h1>Users</h1>

<p><a data-type="indexterm" data-primary="access control" data-secondary="users" id="ix_ch04-asciidoc2"/><a data-type="indexterm" data-primary="users" data-secondary="access control" id="ix_ch04-asciidoc3"/>In Linux we often distinguish between two types of user accounts,
from a purpose or intended usage point of view:</p>
<dl>
<dt>So-called system users, or system accounts</dt>
<dd>
<p>Typically, programs (sometimes
  called <em>daemons</em>)  use these types of accounts to run background
  processes. The services provided by these programs can be part of the
  operating system, such as networking (<code>sshd</code>, for example), or on the application
  layer (for example, <code>mysql</code>, in the case of a popular relational database).</p>
</dd>
<dt>Regular users</dt>
<dd>
<p>For example, a human user that interactively uses Linux via the
  shell.</p>
</dd>
</dl>

<p>The distinction between system and regular users is less of a technical one and
more an organizational construct. To understand that, we first have to
introduce the concept of a user ID (UID), a 32-bit numerical value managed by Linux.</p>

<p><a data-type="indexterm" data-primary="user ID (UID)" id="idm45805436917424"/>Linux identifies users via a UID, with a user belonging to one or more groups
identified via a group ID (GID). <a data-type="indexterm" data-primary="root" id="idm45805436916464"/>There is a special kind of user with the UID 0,
usually called <code>root</code>. This “superuser” is allowed to do anything,
that is, no restriction apply. Usually, you want to avoid working as the
<code>root</code> user, because it’s just too much power to have. You can easily destroy
a system if you’re not careful (believe me, I’ve done this). We’ll get back to this
later in the chapter.</p>

<p>Different Linux distributions have their own ways to decide how to manage the
UID range. For example, <code>systemd</code>-powered distributions (see <a data-type="xref" href="ch06.xhtml#systemd">“systemd”</a>),
have the following <a href="https://oreil.ly/c0DuO">convention</a>
(simplified here):</p>
<dl>
<dt>UID 0</dt>
<dd>
<p>Is <code>root</code></p>
</dd>
<dt>UID 1 to 999</dt>
<dd>
<p>Are reserved for system users</p>
</dd>
<dt>UID 65534</dt>
<dd>
<p>Is user <code>nobody</code>—used, for example, for mapping remote users to some
  well-known ID, as is the case with <a data-type="xref" href="ch07.xhtml#nfs">“Network File System”</a></p>
</dd>
<dt>UID 1000 to 65533 and 65536 to 4294967294</dt>
<dd>
<p>Are regular users</p>
</dd>
</dl>

<p>To figure out your own UIDs, you can use the (surprise!) <code>id</code> command like so:</p>

<pre data-type="programlisting" data-code-language="shell">$ id -u
<code class="m">2016796723</code></pre>

<p>Now that you know the basics about Linux users, let’s see how you can manage
users.</p>








<section data-type="sect2" data-pdf-bookmark="Managing Users Locally"><div class="sect2" id="idm45805436882160">
<h2>Managing Users Locally</h2>

<p><a data-type="indexterm" data-primary="access control" data-secondary="managing users locally" id="ix_ch04-asciidoc4"/><a data-type="indexterm" data-primary="passwords" id="ix_ch04-asciidoc5"/><a data-type="indexterm" data-primary="users" data-secondary="managing locally" id="ix_ch04-asciidoc6"/>The first option, and traditionally the only one available, is managing
users locally. That is, only information local to the machine is used, and
user-related information is not shared across a network of machines.</p>

<p>For local user management, Linux uses a simple file-based interface with a
somewhat confusing naming scheme that is a historic artifact we have to
live with, unfortunately. <a data-type="xref" href="#table-local-user-ref">Table 4-1</a> lists the four files
that, together, implement user management.</p>
<table id="table-local-user-ref">
<caption><span class="label">Table 4-1. </span>Reference of local user management files</caption>
<thead>
<tr>
<th>Purpose</th>
<th>File</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>User database</p></td>
<td><p><em>/etc/passwd</em></p></td>
</tr>
<tr>
<td><p>Group database</p></td>
<td><p><em>/etc/group</em></p></td>
</tr>
<tr>
<td><p>User passwords</p></td>
<td><p><em>/etc/shadow</em></p></td>
</tr>
<tr>
<td><p>Group passwords</p></td>
<td><p><em>/etc/gshadow</em></p></td>
</tr>
</tbody>
</table>

<p>Think of <em>/etc/passwd</em> as a kind of mini user database keeping track of
user names, UIDs, group membership, and other data, such as home directory
and login shell used, for regular users. Let’s have a look at a concrete example:</p>

<pre data-type="programlisting" data-code-language="shell"><code>$</code><code> </code><code>cat</code><code> </code><code>/etc/passwd</code><code>
</code><code>root:x:0:0:root:/root:/bin/bash</code><code> </code><a class="co" id="co_access_control_CO1-1" href="#callout_access_control_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</code><code> </code><a class="co" id="co_access_control_CO1-2" href="#callout_access_control_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>bin:x:2:2:bin:/bin:/usr/sbin/nologin</code><code>
</code><code>sys:x:3:3:sys:/dev:/usr/sbin/nologin</code><code>
</code><code>nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</code><code>
</code><code>syslog:x:104:110::/home/syslog:/usr/sbin/nologin</code><code>
</code><code>mh9:x:1000:1001::/home/mh9:/usr/bin/fish</code><code> </code><a class="co" id="co_access_control_CO1-3" href="#callout_access_control_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_access_control_CO1-1" href="#co_access_control_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The root user has UID 0.</p></dd>
<dt><a class="co" id="callout_access_control_CO1-2" href="#co_access_control_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>A system account (the <code>nologin</code> gives it away; see more below).</p></dd>
<dt><a class="co" id="callout_access_control_CO1-3" href="#co_access_control_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>My user account.</p></dd>
</dl>

<p>Let’s have a closer look at one of the lines in <em>/etc/passwd</em> to understand the
structure of a user entry in detail:</p>

<pre data-type="programlisting" data-code-language="shell"><code>root:x:0:0:root:/root:/bin/bash</code><code>
</code><code>^</code><code>    </code><code>^</code><code> </code><code>^</code><code> </code><code>^</code><code> </code><code>^</code><code>    </code><code>^</code><code>     </code><code>^</code><code>
</code><code class="p">|</code><code>    </code><code class="p">|</code><code> </code><code class="p">|</code><code> </code><code class="p">|</code><code> </code><code class="p">|</code><code>    </code><code class="p">|</code><code>     </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO2-1" href="#callout_access_control_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="p">|</code><code>    </code><code class="p">|</code><code> </code><code class="p">|</code><code> </code><code class="p">|</code><code> </code><code class="p">|</code><code>    </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO2-2" href="#callout_access_control_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="p">|</code><code>    </code><code class="p">|</code><code> </code><code class="p">|</code><code> </code><code class="p">|</code><code> </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO2-3" href="#callout_access_control_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="p">|</code><code>    </code><code class="p">|</code><code> </code><code class="p">|</code><code> </code><code>└──</code><code> </code><a class="co" id="co_access_control_CO2-4" href="#callout_access_control_CO2-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="p">|</code><code>    </code><code class="p">|</code><code> </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO2-5" href="#callout_access_control_CO2-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code class="p">|</code><code>    </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO2-6" href="#callout_access_control_CO2-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO2-7" href="#callout_access_control_CO2-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_access_control_CO2-1" href="#co_access_control_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The login shell to use. To prevent interactive logins, use <em>/sbin/nologin</em>.</p></dd>
<dt><a class="co" id="callout_access_control_CO2-2" href="#co_access_control_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The user’s home directory; this defaults to <em>/</em>.</p></dd>
<dt><a class="co" id="callout_access_control_CO2-3" href="#co_access_control_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>User information such as full name or contact data like phone number. Often
also known as <a href="https://oreil.ly/ZWQ0f">GECOS</a> field.
Note that GECOS formatting is not used, but rather the field itself is used
typically for the full name of the person associated with the account.</p></dd>
<dt><a class="co" id="callout_access_control_CO2-4" href="#co_access_control_CO2-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>The user’s primary group (GID); see also <em>/etc/group</em>.</p></dd>
<dt><a class="co" id="callout_access_control_CO2-5" href="#co_access_control_CO2-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>The UID. Note that Linux reserves UIDs below 1000 for system usage.</p></dd>
<dt><a class="co" id="callout_access_control_CO2-6" href="#co_access_control_CO2-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>The user’s password, with the <code>x</code> character meaning that the (encrypted)
password is stored in <em>/etc/shadow</em>, which is the default these days.</p></dd>
<dt><a class="co" id="callout_access_control_CO2-7" href="#co_access_control_CO2-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>The username, which must be 32 characters or fewer.</p></dd>
</dl>

<p>One thing we notice is absent in <em>/etc/passwd</em> is the one thing we would expect
to find there, based on its name: the password. Passwords are, for historic
reasons, stored in a file called <em>/etc/shadow</em>. While every user can read
<em>/etc/passwd</em>, you usually need <code>root</code> privileges to read for <em>/etc/shadow</em>.</p>

<p>To add a user, you can use the <a href="https://oreil.ly/HQVZK"><code>adduser</code></a>
command as follows:</p>

<pre data-type="programlisting" data-code-language="shell"><code>$</code><code> </code><code>sudo</code><code> </code><code>adduser</code><code> </code><code>mh9</code><code>
</code><code>Adding</code><code> </code><code>user</code><code> </code><code class="sb">`</code><code>mh9</code><code class="s1">' ...
Adding new group `mh9'</code><code> </code><code class="o">(</code><code class="m">1001</code><code class="o">)</code><code> </code><code>...</code><code>
</code><code>Adding</code><code> </code><code>new</code><code> </code><code>user</code><code> </code><code class="sb">`</code><code>mh9</code><code class="s1">' (1000) with group `mh9'</code><code> </code><code>...</code><code>
</code><code>Creating</code><code> </code><code>home</code><code> </code><code>directory</code><code> </code><code class="sb">`</code><code>/home/mh9</code><code class="s1">' ... </code><a class="co" id="co_access_control_CO3-1" href="#callout_access_control_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="s1">
Copying files from `/etc/skel'</code><code> </code><code>...</code><code> </code><a class="co" id="co_access_control_CO3-2" href="#callout_access_control_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>New</code><code> </code><code>password:</code><code> </code><a class="co" id="co_access_control_CO3-3" href="#callout_access_control_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>Retype</code><code> </code><code>new</code><code> </code><code>password:</code><code>
</code><code>passwd:</code><code> </code><code>password</code><code> </code><code>updated</code><code> </code><code>successfully</code><code>
</code><code>Changing</code><code> </code><code>the</code><code> </code><code>user</code><code> </code><code>information</code><code> </code><code class="k">for</code><code> </code><code>mh9</code><code>
</code><code>Enter</code><code> </code><code>the</code><code> </code><code>new</code><code> </code><code>value,</code><code> </code><code>or</code><code> </code><code>press</code><code> </code><code>ENTER</code><code> </code><code class="k">for</code><code> </code><code>the</code><code> </code><code>default</code><code> </code><a class="co" id="co_access_control_CO3-4" href="#callout_access_control_CO3-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
        </code><code>Full</code><code> </code><code>Name</code><code> </code><code class="o">[</code><code class="o">]</code><code>:</code><code> </code><code>Michael</code><code> </code><code>Hausenblas</code><code>
        </code><code>Room</code><code> </code><code>Number</code><code> </code><code class="o">[</code><code class="o">]</code><code>:</code><code>
        </code><code>Work</code><code> </code><code>Phone</code><code> </code><code class="o">[</code><code class="o">]</code><code>:</code><code>
        </code><code>Home</code><code> </code><code>Phone</code><code> </code><code class="o">[</code><code class="o">]</code><code>:</code><code>
        </code><code>Other</code><code> </code><code class="o">[</code><code class="o">]</code><code>:</code><code>
</code><code>Is</code><code> </code><code>the</code><code> </code><code>information</code><code> </code><code>correct?</code><code> </code><code class="o">[</code><code>Y/n</code><code class="o">]</code><code> </code><code>Y</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_access_control_CO3-1" href="#co_access_control_CO3-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The <code>adduser</code> command creates a home directory.</p></dd>
<dt><a class="co" id="callout_access_control_CO3-2" href="#co_access_control_CO3-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>It also copies a bunch of default config files into the home directory.</p></dd>
<dt><a class="co" id="callout_access_control_CO3-3" href="#co_access_control_CO3-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Need to define a password.</p></dd>
<dt><a class="co" id="callout_access_control_CO3-4" href="#co_access_control_CO3-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Provide optional GECOS information.</p></dd>
</dl>

<p>If you want to create a system account, pass in the <code>-r</code> option. This will
disable the ability to use a login shell and also avoid home directory creation.
For configuration details, see also  <em>/etc/adduser.conf</em>, including options
such as the UID/GID range to be used.</p>

<p>In addition to users, Linux also has the concept of groups, which in a sense
is just a collection of one or more users. Any regular user belongs to one
default group but can be a member of additional groups. You can find out
about groups and mappings via the <em>/etc/group</em> file:</p>

<pre data-type="programlisting" data-code-language="shell"><code>$</code><code> </code><code>cat</code><code> </code><code>/etc/group</code><code> </code><a class="co" id="co_access_control_CO4-1" href="#callout_access_control_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>root:x:0:</code><code>
</code><code>daemon:x:1:</code><code>
</code><code>bin:x:2:</code><code>
</code><code>sys:x:3:</code><code>
</code><code>adm:x:4:syslog</code><code>
</code><code>...</code><code>
</code><code>ssh:x:114:</code><code>
</code><code>landscape:x:115:</code><code>
</code><code>admin:x:116:</code><code>
</code><code>netdev:x:117:</code><code>
</code><code>lxd:x:118:</code><code>
</code><code>systemd-coredump:x:999:</code><code>
</code><code>mh9:x:1001:</code><code> </code><a class="co" id="co_access_control_CO4-2" href="#callout_access_control_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_access_control_CO4-1" href="#co_access_control_CO4-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Display the content of the group mapping file.</p></dd>
<dt><a class="co" id="callout_access_control_CO4-2" href="#co_access_control_CO4-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>An example group of my user with the GID 1001. Note that you can add a
comma-separated list of user names after the last colon to allow multiple
users to have that group permission.</p></dd>
</dl>

<p>With this basic user concept and management under our belt, we move on to
a potentially better way to manage users in a professional setup, allowing
for scale.<a data-type="indexterm" data-startref="ix_ch04-asciidoc6" id="idm45805436519392"/><a data-type="indexterm" data-startref="ix_ch04-asciidoc5" id="idm45805436518688"/><a data-type="indexterm" data-startref="ix_ch04-asciidoc4" id="idm45805436518016"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Centralized User Management"><div class="sect2" id="idm45805436900592">
<h2>Centralized User Management</h2>

<p><a data-type="indexterm" data-primary="access control" data-secondary="centralized user management" id="idm45805436494432"/><a data-type="indexterm" data-primary="users" data-secondary="centralized user management" id="idm45805436493392"/>If you have more than one machine or server for which you have to
manage users—say, in a professional setup—then managing users locally
quickly becomes old. You want a centralized way to manage users that you can
apply locally, to one specific machine. There are a few approaches
available to you, depending on your requirements and (time) budget:</p>
<dl>
<dt>Directory based</dt>
<dd>
<p><a data-type="indexterm" data-primary="Lightweight Directory Access Protocol (LDAP)" id="idm45805436490608"/><a data-type="indexterm" data-primary="user directory" id="idm45805436489936"/><a href="https://oreil.ly/Ll5AU">Lightweight
Directory Access Protocol (LDAP)</a>, a decades-old suite of protocols now
formalized by IETF, defines how to access and maintain a distributed directory
over Internet Protocol (IP). You can run an LDAP server yourself—for example,
using projects like <a href="https://oreil.ly/j6qm2">Keycloak</a>—or outsource this to
a cloud provider, such as Azure Active Directory.</p>
</dd>
<dt>Via a network</dt>
<dd>
<p>Users can be authenticated in this manner with Kerberos. We’ll look at Kerberos in detail in <a data-type="xref" href="ch09.xhtml#kerberos">“Kerberos”</a>.</p>
</dd>
<dt>Using config management systems</dt>
<dd>
<p>These systems, which include Ansible, Chef, Puppet, or SaltStack, can be used to consistently create users across machines.</p>
</dd>
</dl>

<p>The actual implementation is often dictated by the environment. That is, a
company might already be using LDAP, and hence the choices might be limited.
The details of the different approaches and pros and cons are, however,
beyond the scope of this book.<a data-type="indexterm" data-startref="ix_ch04-asciidoc3" id="idm45805436483632"/><a data-type="indexterm" data-startref="ix_ch04-asciidoc2" id="idm45805436482896"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Permissions"><div class="sect1" id="permissions">
<h1>Permissions</h1>

<p><a data-type="indexterm" data-primary="access control" data-secondary="permissions" id="ix_ch04-asciidoc7"/><a data-type="indexterm" data-primary="permissions" id="ix_ch04-asciidoc8"/>In this section, we first go into detail concerning Linux file permissions,
which are central to how access control works, and then we look at permissions
around processes. That is, we review runtime permissions and how they are
derived from file permissions.</p>








<section data-type="sect2" data-pdf-bookmark="File Permissions"><div class="sect2" id="file-permissions">
<h2>File Permissions</h2>

<p><a data-type="indexterm" data-primary="file permissions" id="ix_ch04-asciidoc9"/><a data-type="indexterm" data-primary="permissions" data-secondary="file permissions" id="ix_ch04-asciidoc10"/>File permissions are core to Linux’s concept of access to resources,
since everything is a file in Linux, more or less. Let’s first review some
terminology and then discuss the representation of the metadata around
file access and permissions in detail.</p>

<p>There are three types or scopes of permissions, from narrow to wide:</p>
<dl>
<dt>User</dt>
<dd>
<p>The owner of the file</p>
</dd>
<dt>Group</dt>
<dd>
<p>Has one or more members</p>
</dd>
<dt>Other</dt>
<dd>
<p>The category for everyone else</p>
</dd>
</dl>

<p>Further, there are three types of access:</p>
<dl>
<dt>Read (<code>r</code>)</dt>
<dd>
<p>For a normal file, this allows a user to view the contents of the file. For a
  directory, it allows a user to view the names of files in the directory.</p>
</dd>
<dt>Write (<code>w</code>)</dt>
<dd>
<p>For a normal file, this allows a user to modify and delete the file.
  For a directory, it allows a user to create, rename, and delete files in the directory.</p>
</dd>
<dt>Execute (<code>x</code>)</dt>
<dd>
<p>For a normal file, this allows a user to execute the file if the user
  also has read permissions on it. For a directory, it allows a user to access file information in the directory, effectively permitting them to change into
  it (<code>cd</code>) or list its content (<code>ls</code>).</p>
</dd>
</dl>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45805436460544">
<h5>Other File Access Bits</h5>
<p>I listed <code>r</code>/<code>w</code>/<code>x</code> as the three file access types, but in practice you will
find others as well when you do an <code>ls</code>:</p>

<ul>
<li>
<p><code>s</code> is the setuid/setgid permission applied to an executable file. A user
running it inherits the effective privileges of the owner or group of the file.</p>
</li>
<li>
<p><code>t</code> is the sticky bit, which is only relevant for directories. If set, it
prevents nonroot users from deleting files in it, unless said user owns the directory/file.</p>
</li>
</ul>

<p>There are also special settings in Linux available via the <code>chattr</code> (change attribute)
command, but this is beyond the scope of this chapter.</p>
</div></aside>

<p>Let’s see file permissions in action (note that the spaces you see here in the output of the
<code>ls</code> command have been expanded for better readability):</p>

<pre data-type="programlisting" data-code-language="shell"><code>$</code><code> </code><code>ls</code><code> </code><code>-al</code><code>
</code><code>total</code><code> </code><code class="m">0</code><code>
</code><code>-rw-r--r--</code><code>  </code><code class="m">1</code><code>  </code><code>mh9</code><code>  </code><code>devs</code><code>  </code><code class="m">9</code><code>  </code><code>Apr</code><code> </code><code class="m">12</code><code> </code><code class="m">11</code><code>:42</code><code>  </code><code class="nb">test</code><code>
</code><code>^</code><code>           </code><code>^</code><code>  </code><code>^</code><code>    </code><code>^</code><code>     </code><code>^</code><code>  </code><code>^</code><code>             </code><code>^</code><code>
</code><code class="p">|</code><code>           </code><code class="p">|</code><code>  </code><code class="p">|</code><code>    </code><code class="p">|</code><code>     </code><code class="p">|</code><code>  </code><code class="p">|</code><code>             </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO5-1" href="#callout_access_control_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="p">|</code><code>           </code><code class="p">|</code><code>  </code><code class="p">|</code><code>    </code><code class="p">|</code><code>     </code><code class="p">|</code><code>  </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO5-2" href="#callout_access_control_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="p">|</code><code>           </code><code class="p">|</code><code>  </code><code class="p">|</code><code>    </code><code class="p">|</code><code>     </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO5-3" href="#callout_access_control_CO5-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="p">|</code><code>           </code><code class="p">|</code><code>  </code><code class="p">|</code><code>    </code><code>└──</code><code> </code><a class="co" id="co_access_control_CO5-4" href="#callout_access_control_CO5-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="p">|</code><code>           </code><code class="p">|</code><code>  </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO5-5" href="#callout_access_control_CO5-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
</code><code class="p">|</code><code>           </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO5-6" href="#callout_access_control_CO5-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO5-7" href="#callout_access_control_CO5-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_access_control_CO5-1" href="#co_access_control_CO5-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>File name</p></dd>
<dt><a class="co" id="callout_access_control_CO5-2" href="#co_access_control_CO5-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Last modified time stamp</p></dd>
<dt><a class="co" id="callout_access_control_CO5-3" href="#co_access_control_CO5-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>File size in bytes</p></dd>
<dt><a class="co" id="callout_access_control_CO5-4" href="#co_access_control_CO5-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Group the file belongs to</p></dd>
<dt><a class="co" id="callout_access_control_CO5-5" href="#co_access_control_CO5-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>File owner</p></dd>
<dt><a class="co" id="callout_access_control_CO5-6" href="#co_access_control_CO5-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Number of <a href="https://oreil.ly/9Gfzu">hard links</a></p></dd>
<dt><a class="co" id="callout_access_control_CO5-7" href="#co_access_control_CO5-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>File mode</p></dd>
</dl>

<p>When zooming in on the <em>file mode</em>—that is, the file type and permissions
referred to as <a class="co" href="#co_access_control_CO5-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a> in the preceding snippet—we have fields with the following
meaning:</p>

<pre data-type="programlisting" data-code-language="shell"><code>.</code><code> </code><code>rwx</code><code> </code><code>rwx</code><code> </code><code>rwx</code><code>
</code><code>^</code><code> </code><code>^</code><code>   </code><code>^</code><code>   </code><code>^</code><code>
</code><code class="p">|</code><code> </code><code class="p">|</code><code>   </code><code class="p">|</code><code>   </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO6-1" href="#callout_access_control_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="p">|</code><code> </code><code class="p">|</code><code>   </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO6-2" href="#callout_access_control_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="p">|</code><code> </code><code>└──</code><code>  </code><a class="co" id="co_access_control_CO6-3" href="#callout_access_control_CO6-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
</code><code>└──</code><code> </code><a class="co" id="co_access_control_CO6-4" href="#callout_access_control_CO6-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_access_control_CO6-1" href="#co_access_control_CO6-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Permissions for others</p></dd>
<dt><a class="co" id="callout_access_control_CO6-2" href="#co_access_control_CO6-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Permissions for the group</p></dd>
<dt><a class="co" id="callout_access_control_CO6-3" href="#co_access_control_CO6-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Permissions for the file owner</p></dd>
<dt><a class="co" id="callout_access_control_CO6-4" href="#co_access_control_CO6-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>The file type (<a data-type="xref" href="#tab-file-types">Table 4-2</a>)</p></dd>
</dl>

<p>The first field in the file mode represents the file type; see <a data-type="xref" href="#tab-file-types">Table 4-2</a>
for details. The remainder of the file mode encodes the permissions set
for various targets, from owner to everyone, as listed in <a data-type="xref" href="#tab-file-permissions">Table 4-3</a>.</p>
<table id="tab-file-types">
<caption><span class="label">Table 4-2. </span>File types used in mode</caption>
<thead>
<tr>
<th>Symbol</th>
<th>Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>-</code></p></td>
<td><p>A regular file (such as when you do <code>touch abc</code>)</p></td>
</tr>
<tr>
<td><p><code>b</code></p></td>
<td><p>Block special file</p></td>
</tr>
<tr>
<td><p><code>c</code></p></td>
<td><p>Character special file</p></td>
</tr>
<tr>
<td><p><code>C</code></p></td>
<td><p>High-performance (contiguous data) file</p></td>
</tr>
<tr>
<td><p><code>d</code></p></td>
<td><p>A directory</p></td>
</tr>
<tr>
<td><p><code>l</code></p></td>
<td><p>A symbolic link</p></td>
</tr>
<tr>
<td><p><code>p</code></p></td>
<td><p>A named pipe (create with <code>mkfifo</code>)</p></td>
</tr>
<tr>
<td><p><code>s</code></p></td>
<td><p>A socket</p></td>
</tr>
<tr>
<td><p><code>?</code></p></td>
<td><p>Some other (unknown) file type</p></td>
</tr>
</tbody>
</table>

<p>There are some other (older or obsolete) characters such as <code>M</code> or
<code>P</code> used in the position <code>0</code>, which you can by and large ignore. If you’re
interested in what they mean, run <code>info ls -n "What information is listed"</code>.</p>

<p>In combination, these permissions in the file mode define what is allowed
for each element of the target set (user, group, everyone else), as shown in
<a data-type="xref" href="#tab-file-permissions">Table 4-3</a>, checked and enforced through
<a href="https://oreil.ly/wwLsV">access</a>.</p>
<table id="tab-file-permissions">
<caption><span class="label">Table 4-3. </span>File permissions</caption>
<thead>
<tr>
<th>Pattern</th>
<th>Effective permission</th>
<th>Decimal representation</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>---</code></p></td>
<td><p>None</p></td>
<td><p>0</p></td>
</tr>
<tr>
<td><p><code>--x</code></p></td>
<td><p>Execute</p></td>
<td><p>1</p></td>
</tr>
<tr>
<td><p><code>-w-</code></p></td>
<td><p>Write</p></td>
<td><p>2</p></td>
</tr>
<tr>
<td><p><code>-wx</code></p></td>
<td><p>Write and execute</p></td>
<td><p>3</p></td>
</tr>
<tr>
<td><p><code>r--</code></p></td>
<td><p>Read</p></td>
<td><p>4</p></td>
</tr>
<tr>
<td><p><code>r-x</code></p></td>
<td><p>Read and execute</p></td>
<td><p>5</p></td>
</tr>
<tr>
<td><p><code>rw-</code></p></td>
<td><p>Read and write</p></td>
<td><p>6</p></td>
</tr>
<tr>
<td><p><code>rwx</code></p></td>
<td><p>Read, write, execute</p></td>
<td><p>7</p></td>
</tr>
</tbody>
</table>

<p class="pagebreak-after">Let’s have a look at a few examples:</p>
<dl>
<dt class="less_space"><code>755</code></dt>
<dd>
<p>Full access for its owner; read and execute for everyone else</p>
</dd>
<dt><code>700</code></dt>
<dd>
<p>Full access by its owner; none for everyone else</p>
</dd>
<dt><code>664</code></dt>
<dd>
<p>Read/write access for owner and group; read-only for others</p>
</dd>
<dt><code>644</code></dt>
<dd>
<p>Read/write for owner; read-only for everyone else</p>
</dd>
<dt><code>400</code></dt>
<dd>
<p>Read-only by its owner</p>
</dd>
</dl>

<p>The <code>664</code> has a special meaning on my system. When I create a file, that’s
the default permission it gets assigned. You can check that with the
<a href="https://oreil.ly/H9ksX"><code>umask</code> command</a>, which in my
case gives me <code>0002</code>.</p>

<p>The <code>setuid</code> permissions are used to tell the system to run an executable as
the owner, with the owner’s permissions. If a file is owned by <code>root</code>, that can cause issues.</p>

<p>You can change the permissions of a file using <code>chmod</code>. Either you specify the
desired permission settings explicitly (such as <code>644</code>) or you use shortcuts (for
example, <code>+x</code> to make it executable). But how does that look in practice?</p>

<p>Let’s make a file executable with <code>chmod</code>:</p>

<pre data-type="programlisting" data-code-language="shell"><code>$</code><code> </code><code>ls</code><code> </code><code>-al</code><code> </code><code>/tmp/masktest</code><code>
</code><code>-rw-r--r--</code><code> </code><code class="m">1</code><code> </code><code>mh9</code><code> </code><code>dev</code><code> </code><code class="m">0</code><code> </code><code>Aug</code><code> </code><code class="m">28</code><code> </code><code class="m">13</code><code>:07</code><code> </code><code>/tmp/masktest</code><code> </code><a class="co" id="co_access_control_CO7-1" href="#callout_access_control_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>

</code><code>$</code><code> </code><code>chmod</code><code> </code><code>+x</code><code> </code><code>/tmp/masktest</code><code> </code><a class="co" id="co_access_control_CO7-2" href="#callout_access_control_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>

</code><code>$</code><code> </code><code>ls</code><code> </code><code>-al</code><code> </code><code>/tmp/masktest</code><code>
</code><code>-rwxr-xr-x</code><code> </code><code class="m">1</code><code> </code><code>mh9</code><code> </code><code>dev</code><code> </code><code class="m">0</code><code> </code><code>Aug</code><code> </code><code class="m">28</code><code> </code><code class="m">13</code><code>:07</code><code> </code><code>/tmp/masktest</code><code> </code><a class="co" id="co_access_control_CO7-3" href="#callout_access_control_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_access_control_CO7-1" href="#co_access_control_CO7-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Initially the file permissions are <code>r/w</code> for the owner and read-only for
everyone else, aka <code>644</code>.</p></dd>
<dt><a class="co" id="callout_access_control_CO7-2" href="#co_access_control_CO7-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Make the file executable.</p></dd>
<dt><a class="co" id="callout_access_control_CO7-3" href="#co_access_control_CO7-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Now the file permissions are <code>r/w/x</code> for the owner and <code>r/x</code> for everyone
else, aka <code>755</code>.</p></dd>
</dl>

<p>In <a data-type="xref" href="#fig-file-perm-example">Figure 4-2</a> you see what is going on under the hood. Note
that you might not want to give everyone the right to execute the file,
so a <code>chmod 744</code> might have been better here, giving only the owner the
correct permissions while not changing it for the rest. We will
discuss this topic further in <a data-type="xref" href="#sec-good-practices">“Good Practices”</a>.</p>

<figure><div id="fig-file-perm-example" class="figure">
<img src="Images/lmlx_0402.png" alt="lmlx 0402" width="600" height="425"/>
<h6><span class="label">Figure 4-2. </span>Making a file executable and how the file permissions change with it</h6>
</div></figure>

<p>You can also change the ownership using <code>chown</code> (and <code>chgrp</code> for the group):</p>

<pre data-type="programlisting" data-code-language="shell"><code>$</code><code> </code><code>touch</code><code> </code><code>myfile</code><code>
</code><code>$</code><code> </code><code>ls</code><code> </code><code>-al</code><code> </code><code>myfile</code><code>
</code><code>-rw-rw-r--</code><code> </code><code class="m">1</code><code> </code><code>mh9</code><code> </code><code>mh9</code><code> </code><code class="m">0</code><code> </code><code>Sep</code><code> </code><code class="m">4</code><code> </code><code class="m">09</code><code>:26</code><code> </code><code>myfile</code><code> </code><a class="co" id="co_access_control_CO8-1" href="#callout_access_control_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>

</code><code>$</code><code> </code><code>sudo</code><code> </code><code>chown</code><code> </code><code>root</code><code> </code><code>myfile</code><code> </code><a class="co" id="co_access_control_CO8-2" href="#callout_access_control_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>-rw-rw-r--</code><code> </code><code class="m">1</code><code> </code><code>root</code><code> </code><code>mh9</code><code> </code><code class="m">0</code><code> </code><code>Sep</code><code> </code><code class="m">4</code><code> </code><code class="m">09</code><code>:26</code><code> </code><code>myfile</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_access_control_CO8-1" href="#co_access_control_CO8-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The file <em>myfile</em>, which I created and own.</p></dd>
<dt><a class="co" id="callout_access_control_CO8-2" href="#co_access_control_CO8-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>After <code>chown</code>, <code>root</code> owns that file.</p></dd>
</dl>

<p>Having discussed basic permission management, let’s take a look at some more
advanced techniques in this space.<a data-type="indexterm" data-startref="ix_ch04-asciidoc10" id="idm45805436054096"/><a data-type="indexterm" data-startref="ix_ch04-asciidoc9" id="idm45805436053392"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Process Permissions"><div class="sect2" id="process-permissions">
<h2>Process Permissions</h2>

<p><a data-type="indexterm" data-primary="permissions" data-secondary="process permissions" id="ix_ch04-asciidoc11"/><a data-type="indexterm" data-primary="process permissions" id="ix_ch04-asciidoc12"/>So far we’ve focused on how human users access files and what the respective
permissions in play are. Now we shift the focus to processes. In <a data-type="xref" href="#resources-ownership">“Resources and Ownership”</a>,
we talked about how users own files as well as how processes use files. This raises
the question: what are the relevant permissions, from a process point of view?</p>

<p>As documented on the <a href="https://oreil.ly/o7gf6"><code>credentials(7)</code> manual page</a>,
there are different user IDs relevant in the context of runtime permissions:</p>
<dl>
<dt>Real UID</dt>
<dd>
<p><a data-type="indexterm" data-primary="real UID" id="idm45805436019952"/>The <em>real</em> UID is the UID of the user that launched the process. It
represents process ownership in terms of human user. The process itself can obtain its real UID via
<a href="https://oreil.ly/Efi4H"><code>getuid(2)</code></a>, and you can
query it via the shell using <code>stat -c "%u %g" /proc/$pid/</code>.</p>
</dd>
<dt>Effective UID</dt>
<dd>
<p><a data-type="indexterm" data-primary="effective UID" id="idm45805436016192"/>The Linux kernel uses the <em>effective</em> UID to determine permissions the process
has when accessing shared resources such as message queues. On traditional
UNIX systems, they are also used for file access. Linux, however, previously
used a dedicated filesystem UID (see the following discussion) for file access permissions.
This is still supported for compatibility reasons. A process can obtain its effective UID
via <a href="https://oreil.ly/b69OQ"><code>geteuid(2)</code></a>.</p>
</dd>
<dt>Saved set-user-ID</dt>
<dd>
<p><a data-type="indexterm" data-primary="saved set-user-ID" id="idm45805436012944"/>Saved set-user-IDs are used in <code>suid</code> cases where a process can
assume privileges by switching its effective UID between the real UID and the saved set-user-ID.
For example, in order for a process to be allowed to use certain network ports
(see <a data-type="xref" href="ch07.xhtml#transport-ports">“Ports”</a>), it needs elevated privileges, such as being run as <code>root</code>.
A process can get its
saved set-user-IDs via <a href="https://oreil.ly/01QVp"><code>getresuid(2)</code></a>.</p>
</dd>
<dt>Filesystem UID</dt>
<dd>
<p><a data-type="indexterm" data-primary="filesystem UID" id="idm45805436008144"/>These Linux-specific IDs are used to determine permissions for file access.
This UID was initially introduced to support use cases where a file server would act
on behalf of a regular user while isolating the process from signals by said
user. Programs don’t usually directly manipulate this UID. The kernel keeps
track of when the effective UID is changed and automatically
changes the filesystem UID with it. This means that usually the filesystem
UID is the same as the effective UID but can be changed via
<a href="https://oreil.ly/NhhNr"><code>setfsuid(2)</code></a>. Note that
technically this UID is no longer necessary since kernel v2.0 but is still
supported, for 
<span class="keep-together">compatibility.</span></p>
</dd>
</dl>

<p>Initially, when a child process is created via <code>fork(2)</code>, it inherits copies of its
parent’s UIDs, and during an <code>execve(2)</code> syscall, the process’s real UID is preserved,
whereas the effective UID and saved set-user-ID may change.</p>

<p>For example, when you run the <code>passwd</code> command, your effective UID is your UID,
let’s say 1000. Now, <code>passwd</code> has <code>suid</code> set enabled, which means when you run it,
your effective UID is 0 (aka <code>root</code>). There are also other ways to influence
the effective UID—for example, using <code>chroot</code> and other sandboxing techniques.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="indexterm" data-primary="POSIX (Portable Operating System Interface)" id="idm45805436000608"/><a href="https://oreil.ly/kJFaJ">POSIX threads</a> require that credentials
are shared by all threads in a process. However, at the kernel level, Linux maintains
separate user and group credentials for each thread.</p>
</div>

<p>In addition to file access permissions, the kernel uses process UIDs
for other things, including but not limited to the following:</p>

<ul>
<li>
<p>Establishing permissions for sending signals—for example, to determine what
happens when you do a <code>kill -9</code> for a certain process ID. We’ll get back to
this in <a data-type="xref" href="ch06.xhtml#running-apps">Chapter 6</a>.</p>
</li>
<li>
<p>Permission handling for scheduling and priorities (for example, <code>nice</code>).</p>
</li>
<li>
<p>Checking resource limits, which we’ll discuss in detail in the context
of containers in <a data-type="xref" href="ch09.xhtml#advanced">Chapter 9</a>.</p>
</li>
</ul>

<p>While it can be straightforward to reason with effective UID in the
context of <code>suid</code>, once capabilities come into play it can be more challenging<a data-type="indexterm" data-startref="ix_ch04-asciidoc12" id="idm45805435991792"/><a data-type="indexterm" data-startref="ix_ch04-asciidoc11" id="idm45805435991088"/>.<a data-type="indexterm" data-startref="ix_ch04-asciidoc8" id="idm45805435990288"/><a data-type="indexterm" data-startref="ix_ch04-asciidoc7" id="idm45805435989584"/></p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Advanced Permission Management"><div class="sect1" id="advanced-permissions">
<h1>Advanced Permission Management</h1>

<p><a data-type="indexterm" data-primary="permissions" data-secondary="advanced permission management" id="ix_ch04-asciidoc13"/>While so far we’ve focused on widely used mechanisms, the topics in this
section are in a sense advanced and not necessarily something you would
consider in a casual or hobby setup. For professional usage—that is, production
use cases where business critical workloads are deployed—you should definitely
be at least aware of the following advanced permission management approaches.</p>








<section data-type="sect2" data-pdf-bookmark="Capabilities"><div class="sect2" id="capabilities">
<h2>Capabilities</h2>

<p><a data-type="indexterm" data-primary="capabilities" id="idm45805435983936"/><a data-type="indexterm" data-primary="permissions" data-secondary="capabilities" id="idm45805435983232"/>In Linux, as is traditionally the case in UNIX systems, the <code>root</code> user has
no restrictions when running processes. In other words, the kernel only
distinguishes between two cases:</p>

<ul>
<li>
<p>Privileged processes, bypassing the kernel permission checks, with an
effective UID of 0 (aka <code>root</code>)</p>
</li>
<li>
<p>Unprivileged processes, with a nonzero effective UID, for which the kernel
does permission checks, as discussed in <a data-type="xref" href="#process-permissions">“Process Permissions”</a></p>
</li>
</ul>

<p>With the introduction of the
<a href="https://oreil.ly/1Fma7">capabilities syscall</a> in
kernel v2.2, this binary worldview has changed: the privileges traditionally
associated with <code>root</code> are now broken down into distinct units that can be
independently assigned on a per-thread level.</p>

<p>In practice, the idea is that a normal process has zero capabilities, controlled
by the permissions discussed in the previous section. You can assign
capabilities to executables (binaries and shell scripts) as well as processes to
gradually add privileges necessary to carry out a task  (see the discussion
in <a data-type="xref" href="#sec-good-practices">“Good Practices”</a>).</p>

<p>Now, a word of caution: capabilities are generally relevant only for system-level
tasks. In other words: most of the time you won’t necessarily depend on them.</p>

<p>In <a data-type="xref" href="#tab-cap">Table 4-4</a> you can see some of the more widely used capabilities.</p>
<table id="tab-cap">
<caption><span class="label">Table 4-4. </span>Examples of useful capabilities</caption>
<thead>
<tr>
<th>Capability</th>
<th>Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>CAP_CHOWN</code></p></td>
<td><p>Allows user to make arbitrary changes to files’ UIDs/GIDs</p></td>
</tr>
<tr>
<td><p><code>CAP_KILL</code></p></td>
<td><p>Allows sending of signals to processes belonging to other users</p></td>
</tr>
<tr>
<td><p><code>CAP_SETUID</code></p></td>
<td><p>Allows changing the UID</p></td>
</tr>
<tr>
<td><p><code>CAP_SETPCAP</code></p></td>
<td><p>Allows setting the capabilities of a running process</p></td>
</tr>
<tr>
<td><p><code>CAP_NET_ADMIN</code></p></td>
<td><p>Allows various network-related actions, such as interface config</p></td>
</tr>
<tr>
<td><p><code>CAP_NET_RAW</code></p></td>
<td><p>Allows using RAW and PACKET sockets</p></td>
</tr>
<tr>
<td><p><code>CAP_SYS_CHROOT</code></p></td>
<td><p>Allows calling <code>chroot</code></p></td>
</tr>
<tr>
<td><p><code>CAP_SYS_ADMIN</code></p></td>
<td><p>Allows system admin operations, including mounting filesystems</p></td>
</tr>
<tr>
<td><p><code>CAP_SYS_PTRACE</code></p></td>
<td><p>Allows using <code>strace</code> to debug processes</p></td>
</tr>
<tr>
<td><p><code>CAP_SYS_MODULE</code></p></td>
<td><p>Allows loading kernel modules</p></td>
</tr>
</tbody>
</table>

<p>Let’s now see the capabilities in action. For starters, to view the capabilities, you can
use commands as shown in the following (output edited to fit):</p>

<pre data-type="programlisting" data-code-language="shell"><code>$</code><code> </code><code>capsh</code><code> </code><code>--print</code><code> </code><a class="co" id="co_access_control_CO9-1" href="#callout_access_control_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
</code><code>Current:</code><code> </code><code class="o">=</code><code>
</code><code>Bounding</code><code> </code><code class="nb">set</code><code> </code><code class="o">=</code><code>cap_chown,cap_dac_override,cap_dac_read_search,</code><code>
</code><code>cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,</code><code>
</code><code>...</code><code>

</code><code>$</code><code> </code><code>grep</code><code> </code><code>Cap</code><code> </code><code>/proc/</code><code class="nv">$$</code><code>/status</code><code> </code><a class="co" id="co_access_control_CO9-2" href="#callout_access_control_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
</code><code>CapInh:</code><code> </code><code class="m">0000000000000000</code><code>
</code><code>CapPrm:</code><code> </code><code class="m">0000000000000000</code><code>
</code><code>CapEff:</code><code> </code><code class="m">0000000000000000</code><code>
</code><code>CapBnd:</code><code> </code><code>000001ffffffffff</code><code>
</code><code>CapAmb:</code><code> </code><code class="m">0000000000000000</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_access_control_CO9-1" href="#co_access_control_CO9-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Overview of all capabilities on the system</p></dd>
<dt><a class="co" id="callout_access_control_CO9-2" href="#co_access_control_CO9-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Capabilities for the current process (the shell)</p></dd>
</dl>

<p>You can manage capabilities in a fine-grained manner—that is, on a per-file
basis—with
<a href="https://oreil.ly/03bkF">getcap</a> and
<a href="https://oreil.ly/cuBwc">setcap</a> (the details
and good practices are beyond the scope of this chapter).</p>

<p>Capabilities help to transition from an all-or-nothing approach to
finer-grained privileges on a file basis. Let’s now move on to a different
advanced access control topic: the sandboxing technique of seccomp.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="seccomp Profiles"><div class="sect2" id="seccomp">
<h2>seccomp Profiles</h2>

<p><a data-type="indexterm" data-primary="permissions" data-secondary="seccomp profiles" id="idm45805435881840"/><a data-type="indexterm" data-primary="sandboxing" data-secondary="seccomp" id="idm45805435880864"/><a data-type="indexterm" data-primary="seccomp" id="idm45805435879920"/><a href="https://oreil.ly/p5iuR">Secure computing mode (seccomp)</a>
is a Linux kernel feature available since 2005. The basic idea behind this
sandboxing technique is that, using a dedicated syscall called <code>seccomp(2)</code>,
you can restrict the syscalls a process can use.</p>

<p>While you might find it inconvenient to manage seccomp yourself directly, there
are ways to use it without too much hassle. For example, in the context of containers
(see <a data-type="xref" href="ch06.xhtml#containers">“Containers”</a>), both
<a href="https://oreil.ly/A78pm">Docker</a> and
<a href="https://oreil.ly/oYFsK">Kubernetes</a> support seccomp.</p>

<p>Let’s now have a look at an extension of the traditional, granular file permission.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Access Control Lists"><div class="sect2" id="idm45805435874624">
<h2>Access Control Lists</h2>

<p><a data-type="indexterm" data-primary="ACLs (access control lists)" id="idm45805435873072"/><a data-type="indexterm" data-primary="permissions" data-secondary="ACLs" id="idm45805435872352"/>With access control lists (ACLs), we have a flexible permission mechanism in Linux
that you can use on top of or in addition to the more “traditional” permissions
discussed in <a data-type="xref" href="#file-permissions">“File Permissions”</a>. ACLs address a shortcoming of
traditional permissions in that they allow you to grant permissions for a user or
a group not in the group list of a user.</p>

<p>To check if your distribution supports ACLs, you can use
<code>grep -i acl /boot/config*</code> where you’d hope to find a <code>POSIX_ACL=Y</code> somewhere
in the output to confirm it. In order to use ACL for a filesystem, it must be enabled
at mount time, using the <code>acl</code> option. The docs reference on
<a href="https://oreil.ly/Ngr0m">acl</a> has a lot of useful
details.</p>

<p>We won’t go into greater detail here on ACLs since they’re slightly outside
the scope of this book; however, being aware of them and knowing where to start
can be beneficial, should you come across them in the wild.<a data-type="indexterm" data-startref="ix_ch04-asciidoc13" id="idm45805435867392"/></p>

<p>With that, let’s review some good practices for access control.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Good Practices"><div class="sect1" id="sec-good-practices">
<h1>Good Practices</h1>

<p><a data-type="indexterm" data-primary="access control" data-secondary="good practices" id="idm45805435864576"/>Here are some security “good practices” in the wider context of access control.
While some of them might be more applicable in professional environments,
everyone should at least be aware of them.</p>
<dl>
<dt>Least privileges</dt>
<dd>
<p><a data-type="indexterm" data-primary="least privileges principle" id="idm45805435861680"/>The least privileges principle says, in a nutshell, that a person or
process should only have the necessary permissions to achieve a given task.
For example, if an app doesn’t write to a file, then it only needs read access.
In the context of access control, you can practice least privileges in two
ways:</p>

<ul>
<li>
<p>In <a data-type="xref" href="#file-permissions">“File Permissions”</a>, we saw what happens when using <code>chmod +x</code>. In
addition to the permissions you intended, it also assigns some additional
permissions to other users.
Using explicit permissions via the numeral mode is better than symbolic
mode. In other words: while the latter is more convenient, it’s less strict.</p>
</li>
<li>
<p>Avoid running as root as much as you can. <a data-type="indexterm" data-primary="sudo" id="idm45805435856800"/>For example, when you need to
install something, you should be using <code>sudo</code> rather than logging in as
<code>root</code>.</p>
</li>
</ul>

<p><a data-type="indexterm" data-primary="SELinux" id="idm45805435854544"/>Note that if you’re writing an application, you can use an SELinux policy to
restrict access to only selected files, directories, and other features.
In contrast, the default Linux model could potentially give the application
access to any files left open on the system.</p>
</dd>
<dt>Avoid setuid</dt>
<dd>
<p><a data-type="indexterm" data-primary="setuid" id="idm45805435852272"/>Take advantage of capabilities rather than relying on <code>setuid</code>, which is like
a sledgehammer and offers attackers a great way to take over your system.</p>
</dd>
<dt>Auditing</dt>
<dd>
<p><a data-type="indexterm" data-primary="auditing" id="idm45805435849696"/>Auditing is the idea that you record actions (along with who carried them out)
in a way that the resulting log can’t be tampered with. You can then use this
read-only log to verify who did what, when. We’ll dive into
this topic in <a data-type="xref" href="ch08.xhtml#observability">Chapter 8</a>.</p>
</dd>
</dl>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Conclusion"><div class="sect1" id="idm45805435847424">
<h1>Conclusion</h1>

<p>Now that you know how Linux manages users, files, and
access to resources, you have everything at your disposal to carry out
routine tasks safely and securely.</p>

<p>For any practical work with Linux, remember the relationship between users,
processes, and files. This is crucial, in the context of the multiuser operating
system that Linux is, for a safe and secure operation and to avoid damages.</p>

<p>We reviewed access control types, defined what users in Linux are,
what they can do, and how to manage them both locally and centrally. The topic of
file permissions and how to manage them can be tricky, and mastering it is mostly a matter of
practice.</p>

<p>Advanced permissions techniques including capabilities and seccomp profiles
are super relevant in the context of containers.</p>

<p>In the last section, we discussed good practices around access control–related
security, especially applying least privileges.</p>

<p>If you want to dive deeper into the topics discussed in this chapter, here are some
resources:</p>
<dl class="pagebreak-before">
<dt class="less_space">General</dt>
<dd>

<ul>
<li>
<p><a href="https://oreil.ly/0PpnS">“A Survey of Access Control Policies”</a> by Amanda Crowell</p>
</li>
<li>
<p><a href="https://oreil.ly/SXSkp">Lynis</a>, an auditing and compliance testing tool</p>
</li>
</ul>
</dd>
<dt>Capabilities</dt>
<dd>

<ul>
<li>
<p><a href="https://oreil.ly/NIdPu">“Linux Capabilities in Practice”</a></p>
</li>
<li>
<p><a href="https://oreil.ly/qsYJN">“Linux Capabilities: Making Them Work”</a></p>
</li>
</ul>
</dd>
<dt>seccomp</dt>
<dd>

<ul>
<li>
<p><a href="https://oreil.ly/2cKGI">“A seccomp Overview”</a></p>
</li>
<li>
<p><a href="https://oreil.ly/U5bYG">“Sandboxing in Linux with Zero Lines of Code”</a></p>
</li>
</ul>
</dd>
<dt>Access Control Lists</dt>
<dd>

<ul>
<li>
<p><a href="https://oreil.ly/gbc4A">“POSIX Access Control Lists on Linux”</a></p>
</li>
<li>
<p><a href="https://oreil.ly/owpYE">“Access Control Lists”</a> via ArchLinux</p>
</li>
<li>
<p><a href="https://oreil.ly/WCjpN">“An Introduction to Linux Access Control Lists (ACLs)”</a> via Red Hat</p>
</li>
</ul>
</dd>
</dl>

<p>Remember that security is an ongoing process, so you want to make sure to
keep an eye on users and files, something we’ll go into greater detail on in
Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch08.xhtml#observability">8</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch09.xhtml#advanced">9</a>, but for now let’s move on to the topic
of filesystems.<a data-type="indexterm" data-startref="ix_ch04-asciidoc0" id="idm45805435820896"/></p>
</div></section>







</div></section></div></body></html>