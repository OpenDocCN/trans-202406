<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:epub="http://www.idpf.org/2007/ops" lang="en" xml:lang="en" xsi:schemaLocation="http://www.w3.org/2002/06/xhtml2/ http://www.w3.org/MarkUp/SCHEMA/xhtml2.xsd">
  <head>
    <title>Unknown</title>
    <link rel="stylesheet" type="text/css" href="../stylesheet.css"/>
    <link rel="stylesheet" type="text/css" href="../page_styles.css"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  </head>
  <body class="calibre"><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 13. API Deprecations" class="praise"><div class="dedication" id="api_deprecations">
<h1 class="calibre14"><span class="keep-together">Chapter 13. </span>API Deprecations</h1>


<p class="author1">The Kubernetes project periodically releases new versions. Every release adds new features and bug fixes but may also introduce deprecations to existing APIs. An API is the interface that application developers interact with when defining Kubernetes objects.</p>

<p class="author1">Deprecations may come into effect if the Kubernetes team plans to change, replace, or completely remove support for an API. You need to understand how to handle API deprecations to avoid issues before updating nodes to a newer Kubernetes version.</p>
<aside data-type="sidebar" epub:type="sidebar" class="calibre48"><div class="sidebar" id="id482">
<h1 class="calibre49">Coverage of Curriculum Objectives</h1>
<p class="author1">This chapter addresses the following curriculum objective:</p>

<ul class="printings">
<li class="calibre13">
<p class="author1">Understand API deprecations</p>
</li>
</ul>
</div></aside>






<section data-type="sect1" data-pdf-bookmark="Understanding the Deprecation Policy" class="praise"><div class="dedication" id="id295">
<h1 class="calibre17">Understanding the Deprecation Policy</h1>

<p class="author1">The Kubernetes project releases <a href="https://kubernetes.io/blog/2021/07/20/new-kubernetes-release-cadence/" class="calibre10">three versions per calendar year</a>. Optimally, the administrator of a Kubernetes cluster upgrades to the latest version as early as possible to incorporate enhancements and security fixes. However, upgrading a cluster doesn’t come without potential cost and risk. You need to ensure that existing objects running in the cluster will still be compatible with the version you are upgrading to.</p>

<p class="author1">A Kubernetes release can deprecate an API, which means that it is scheduled for removal or replacement. The rules for introducing a deprecation follow the <a href="https://kubernetes.io/docs/reference/using-api/deprecation-policy/" class="calibre10">deprecation policy</a> explained in the Kubernetes documentation.</p>

<p class="author1">The value you assign to the <code class="calibre15">version</code> attribute in a manifest specifies the API version. The use of a deprecated API renders a warning message when creating or updating the object. While you can still create or modify the object, a warning message informs the user about the action to take to ensure its future compatibility with newer Kubernetes versions. The <a href="https://kubernetes.io/docs/reference/using-api/deprecation-guide/" class="calibre10">deprecated API migration guide</a> shows a list of deprecated APIs and the scheduled versions that will remove support for the API.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Listing Available API Versions" class="praise"><div class="dedication" id="id296">
<h1 class="calibre17">Listing Available API Versions</h1>

<p class="author1"><code class="calibre15">Kubectl</code> provides a command for discovering available API versions. The <code class="calibre15">api-versions</code> command lists all API versions in the format group/version:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl api-versions</strong>
admissionregistration.k8s.io/v1
apiextensions.k8s.io/v1
apiregistration.k8s.io/v1
apps/v1
authentication.k8s.io/v1
authorization.k8s.io/v1
autoscaling/v1
autoscaling/v2
batch/v1
certificates.k8s.io/v1
coordination.k8s.io/v1
discovery.k8s.io/v1
events.k8s.io/v1
flowcontrol.apiserver.k8s.io/v1beta2
flowcontrol.apiserver.k8s.io/v1beta3
networking.k8s.io/v1
node.k8s.io/v1
policy/v1
rbac.authorization.k8s.io/v1
scheduling.k8s.io/v1
storage.k8s.io/v1
v1
</pre>

<p class="author1">Certain APIs, like the API for the group <code class="calibre15">autoscaling</code>, exist with different versions, <code class="calibre15">v1</code> and <code class="calibre15">v2</code>. Generally speaking, you can make your manifests more future-proof by choosing a higher major version. At the time of writing, the deprecation status of any of those APIs is not included in the output of the <code class="calibre15">api-versions</code> command. You will need to look up the status in the Kubernetes documentation.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Handling Deprecation Warnings" class="praise"><div class="dedication" id="id297">
<h1 class="calibre17">Handling Deprecation Warnings</h1>

<p class="author1">Let’s demonstrate the effects of using a deprecated API. The following example assumes that you are running a Kubernetes cluster with a version between 1.23 and 1.25. <a data-type="xref" href="#deprecated_hpa" class="calibre10">Example 13-1</a> shows a manifest for a Horizontal Pod Autoscaler that uses a beta API version for the group <code class="calibre15">autoscaling</code>.</p>
<div id="deprecated_hpa" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 13-1. </span>A Horizontal Pod Autoscaler definition using a deprecated API</h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">autoscaling/v2beta2</code><code class="w"></code>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">HorizontalPodAutoscaler</code><code class="w"></code>
<code class="nt">metadata</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">php-apache</code><code class="w"></code>
<code class="nt">spec</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">scaleTargetRef</code><code class="p">:</code><code class="w"></code>
<code class="w">    </code><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">apps/v1</code><code class="w"></code>
<code class="w">    </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">Deployment</code><code class="w"></code>
<code class="w">    </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">php-apache</code><code class="w"></code>
<code class="w">  </code><code class="nt">minReplicas</code><code class="p">:</code><code class="w"> </code><code class="calibre15">1</code><code class="w"></code>
<code class="w">  </code><code class="nt">maxReplicas</code><code class="p">:</code><code class="w"> </code><code class="calibre15">10</code><code class="w"></code></pre></div>

<p class="author1">Creating a new object from the YAML manifest will not result in an error. Kubernetes will happily create the object, but the command will let you know what will happen with the API in a future Kubernetes version. As shown in the following output, it is suggested that you replace the use of the API with <code class="calibre15">autoscaling/v2</code>:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl create -f hpa.yaml</strong>
Warning: autoscaling/v2beta2 HorizontalPodAutoscaler is deprecated in v1.23+, \
unavailable in v1.26+; use autoscaling/v2 HorizontalPodAutoscaler
</pre>

<p class="author1">In addition to the warning message, you may also want to look at the deprecated API migration guide. An easy way to find information about the deprecated API is to search the deprecation guide for it. For example, you will find the <a href="https://kubernetes.io/docs/reference/using-api/deprecation-guide/#horizontalpodautoscaler-v126" class="calibre10">following passage</a> about the API <code class="calibre15">autoscaling/v2beta2</code>:</p>
<blockquote class="pcalibre pcalibre1 calibre4">
<p class="calibre5">The <code class="calibre15">autoscaling/v2beta2</code> API version of HorizontalPodAutoscaler is no longer served as of v1.26.</p>

<ul class="printings">
<li class="calibre13">
<p class="calibre5">Migrate manifests and API clients to use the <code class="calibre15">autoscaling/v2</code> API version, available since v1.23.</p>
</li>
<li class="calibre13">
<p class="calibre5">All existing persisted objects are accessible via the new API</p>
</li>
</ul>
<p data-type="attribution" class="pcalibre2 calibre6">Deprecated API Migration Guide</p>
</blockquote>

<p class="author1">All you need to do to future-proof your manifest is to assign the new API version.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Handling a Removed or Replaced API" class="praise"><div class="dedication" id="id298">
<h1 class="calibre17">Handling a Removed or Replaced API</h1>

<p class="author1">The administrator of a Kubernetes cluster may decide to jump up multiple minor versions at once when upgrading. It is possible that you won’t catch that an API you are currently using has already been removed. It’s important to verify the compatibility of existing Kubernetes objects before upgrading the production cluster to avoid any 
<span class="keep-together">disruptions.</span></p>

<p class="author1">Say you have been using the definition of a ClusterRole shown in <a data-type="xref" href="#removed_clusterrole_api" class="calibre10">Example 13-2</a>. Managing the object worked fine with Kubernetes 1.8; however, the administrator upgraded the cluster nodes all the way to 1.22.</p>
<div id="removed_clusterrole_api" data-type="example" class="calibre45">
<h5 class="calibre46"><span class="keep-together">Example 13-2. </span>A ClusterRole using the API version <code class="calibre15">rbac.authorization.k8s.io/v1beta1</code></h5>

<pre data-type="programlisting" data-code-language="yaml" class="calibre47"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="calibre15">rbac.authorization.k8s.io/v1beta1</code><code class="w"></code>
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="calibre15">ClusterRole</code><code class="w"></code>
<code class="nt">metadata</code><code class="p">:</code><code class="w"></code>
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="calibre15">pod-reader</code><code class="w"></code>
<code class="nt">rules</code><code class="p">:</code><code class="w"></code>
<code class="calibre15">-</code><code class="w"> </code><code class="nt">apiGroups</code><code class="p">:</code><code class="w"> </code><code class="calibre15">[</code><code class="s">""</code><code class="calibre15">]</code><code class="w"></code>
<code class="w">  </code><code class="nt">resources</code><code class="p">:</code><code class="w"> </code><code class="calibre15">[</code><code class="s">"pods"</code><code class="calibre15">]</code><code class="w"></code>
<code class="w">  </code><code class="nt">verbs</code><code class="p">:</code><code class="w"> </code><code class="calibre15">[</code><code class="s">"get"</code><code class="calibre15">,</code><code class="w"> </code><code class="s">"watch"</code><code class="calibre15">,</code><code class="w"> </code><code class="s">"list"</code><code class="calibre15">]</code><code class="w"></code></pre></div>

<p class="author1">Trying to create the object from the ClusterRole manifest file will not render a deprecation message. Instead, <code class="calibre15">kubectl</code> will return an error message. Consequently, the command did not create the object:</p>
<pre data-type="programlisting" class="calibre37">
<strong class="calibre38">$ kubectl apply -f clusterrole.yaml</strong>
error: resource mapping not found for name: "pod-reader" namespace: "" from \
"clusterrole.yaml": no matches for kind "ClusterRole" in version \
"rbac.authorization.k8s.io/v1beta1"
</pre>

<p class="author1">You will not have a clear idea why the command failed just looking at the error message. It’s a good idea to check with the deprecated API migration guide. Searching the page for the API version <code class="calibre15">rbac.authorization.k8s.io/v1beta1</code> will give you the <a href="https://kubernetes.io/docs/reference/using-api/deprecation-guide/#rbac-resources-v122" class="calibre10">following information</a>. The solution here is to assign the replacement API <code class="calibre15">rbac.authorization.k8s.io/v1</code> instead:</p>
<blockquote class="pcalibre pcalibre1 calibre4">
<p class="calibre5">The <code class="calibre15">rbac.authorization.k8s.io/v1beta1</code> API version of ClusterRole, ClusterRoleBinding, Role, and RoleBinding is no longer served as of v1.22.</p>

<ul class="printings">
<li class="calibre13">
<p class="calibre5">Migrate manifests and API clients to use the <code class="calibre15">rbac.authorization.k8s.io/v1</code> API version, available since v1.8.</p>
</li>
<li class="calibre13">
<p class="calibre5">All existing persisted objects are accessible via the new APIs</p>
</li>
<li class="calibre13">
<p class="calibre5">No notable changes</p>
</li>
</ul>
<p data-type="attribution" class="pcalibre2 calibre6">Deprecated API Migration Guide</p>
</blockquote>

<p class="author1">Under certain conditions, a Kubernetes primitive may not provide a replacement API. As a representative use case I want to mention the PodSecurityPolicy primitive here. The feature has been replaced by a new Kubernetes-internal concept, the <a href="https://kubernetes.io/docs/reference/using-api/deprecation-guide/#psp-v125" class="calibre10">Pod Security Admission</a>. You should follow the release notes of upcoming Kubernetes releases to stay aware of more radical changes.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Summary" class="praise"><div class="dedication" id="id299">
<h1 class="calibre17">Summary</h1>

<p class="author1">Inevitably, you will run into API deprecations when using Kubernetes long term. As a developer, you need to know how to interpret deprecation warning messages. The Kubernetes documentation provides all the information you need to identify an alternative API or feature. It’s advisable to test all available YAML manifests for objects currently in use in production clusters before upgrading nodes to a newer Kubernetes version.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Exam Essentials" class="praise"><div class="dedication" id="id300">
<h1 class="calibre17">Exam Essentials</h1>
<dl class="calibre18">
<dt class="calibre19">Keep the API deprecation documentation handy</dt>
<dd class="calibre20">
<p class="calibre21">The exam will likely expose you to an object that uses a deprecated API. You will need to keep the <a href="https://kubernetes.io/docs/reference/using-api/deprecation-guide/" class="calibre10">Deprecated API Migration Guide</a> documentation page handy to tackle such scenarios. The page describes deprecated, removed, and replaced APIs categorized by Kubernetes version. Use the browser’s search capability to quickly find relevant information about an API. The quick reference links on the right side of the page let you quickly navigate to a specific Kubernetes version.</p>
</dd>
</dl>
</div></section>






<section data-type="sect1" data-pdf-bookmark="Sample Exercises" class="praise"><div class="dedication" id="id301">
<h1 class="calibre17">Sample Exercises</h1>

<p class="author1">Solutions to these exercises are available in <a href="app01_split_009.xhtml#appendix_a_api_deprecations" class="calibre10">Appendix A</a>.</p>
<ol class="calibre55">
<li class="calibre56">
<p class="author1">The Kubernetes administrator in charge of the cluster is planning to upgrade all nodes from Kubernetes 1.8 to 1.28. You defined multiple Kubernetes YAML manifests that operate an application stack. The administrator provided you with a Kubernetes 1.28 test environment. Make sure that all YAML manifests are compatible with Kubernetes version 1.28.</p>

<p class="author1">Navigate to the directory <em class="calibre3">app-a/ch13/deprecated</em> of the checked-out GitHub repository <a href="https://github.com/bmuschko/ckad-study-guide" class="calibre10"><em class="calibre3">bmuschko/ckad-study-guide</em></a>. Inspect the files <em class="calibre3">deployment.yaml</em> and <em class="calibre3">configmap.yaml</em> in the current directory.</p>

<p class="author1">Create the objects from the YAML manifests. Modify the definitions as needed.</p>

<p class="author1">Verify that the objects can be instantiated with Kubernetes 1.28.</p>
</li>

</ol>
</div></section>
</div></section></div></body>
</html>