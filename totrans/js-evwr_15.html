<html><head></head><body><section data-pdf-bookmark="Chapter 14. Working with Apollo Client" data-type="chapter" epub:type="chapter"><div class="chapter" id="web-apollo">&#13;
<h1><span class="label">Chapter 14. </span>Working with Apollo Client</h1>&#13;
&#13;
&#13;
<p><a data-primary="Apollo Client" data-type="indexterm" id="ix_ch14-asciidoc0"/>I<a data-primary="Apollo Client" data-secondary="about" data-type="indexterm" id="idm45339498158936"/> remember my first internet connection vividly. My computer’s modem would dial in to a local number connected to my internet service provider (ISP), setting me free on the web. As magical as this felt at the time, it is a far cry from the instant, always-on connections that we use today. Here’s what the process looked like:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Sit down at my computer and open the ISP software.</p>&#13;
</li>&#13;
<li>&#13;
<p>Click Connect, and wait for the modem to dial the number.</p>&#13;
</li>&#13;
<li>&#13;
<p>If the connection is successful, hear the glorious “modem sounds.” If not, such as during peak hours when the lines may be overloaded and busy, try again.</p>&#13;
</li>&#13;
<li>&#13;
<p>Once connected, receive a success notification and browse the web in all of its GIF-filled 90s glory.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>This cycle may seem arduous, but it still represents the way in which services speak to each other: they request a connection, make that connection, send a request, and get something back in return. Our client applications will work in the same manner. We will first make a connection to our server API application and, if successful, make requests to that server.</p>&#13;
&#13;
<p>In this chapter, we’ll use Apollo Client to connect to our API. Once we’ve connected, we’ll write a GraphQL query, which will be used to display data on a page. We’ll also introduce pagination, both within an API query and in our interface components.</p>&#13;
<div data-type="note" epub:type="note"><h1>Running the API Locally</h1>&#13;
<p><a data-primary="application programming interface (API)" data-secondary="running locally" data-type="indexterm" id="idm45339498150568"/>The development of our web client application will require access to a local instance of our API. If you’ve been following along with the book, you may already have the Notedly API and its database up and running on your machine. If not, I’ve added instructions to <a data-type="xref" href="app01.html#appendix-api">Appendix A</a> on how to get a copy of the API up and running along with some sample data. If you already have the API running, but would like some additional data to work with, run <code>npm run seed</code> from the root of the API project directory.</p>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Setting Up Apollo Client" data-type="sect1"><div class="sect1" id="idm45339498147576">&#13;
<h1>Setting Up Apollo Client</h1>&#13;
&#13;
<p><a data-primary="Apollo Client" data-secondary="setting up" data-type="indexterm" id="idm45339498146008"/>Much like Apollo Server, Apollo Client offers a number of helpful features to simplify working with GraphQL within JavaScript UI applications. Apollo Client provides libraries for connecting a web client to an API, local caching, GraphQL syntax, local state management, and more. We’ll also be using Apollo Client with a React application, but Apollo also offers libraries for Vue, Angular, Meteor, Ember, and Web <span class="keep-together">Components.</span></p>&#13;
&#13;
<p>First, we’ll want to ensure that our <em>.env</em> file contains a reference to our local API URI. This will allow us to use our local API instance in development, while pointing to our product API when we release our application to a public web server. In our <em>.env</em> file, we should have a <code>API_URI</code> variable with our local API server’s address:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="nv">API_URI</code><code class="o">=</code>http://localhost:4000/api</pre>&#13;
&#13;
<p>Our code bundler, <a data-primary="Parcel" data-type="indexterm" id="idm45339498115720"/>Parcel, is configured to automatically work with <em>.env</em> files. Any time we want to reference an <em>.env</em> variable in our code, we can use <span class="keep-together"><code>process.</code></span><code>env.</code><span class="keep-together"><em><code>VARIABLE_NAME</code></em></span>. This will allow us to use unique values in local development, production, and any other environment that we may need (such as staging or continuous integration).</p>&#13;
&#13;
<p>With the address stored in an environment variable, we are ready to connect our web client to our API server. Working in our <em>src/App.js</em> file, first we need to import the Apollo packages that we’ll be using:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// import Apollo Client libraries</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">ApolloClient</code><code class="p">,</code> <code class="nx">ApolloProvider</code><code class="p">,</code> <code class="nx">InMemoryCache</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code></pre>&#13;
&#13;
<p>With these imported, we can configure a new Apollo Client instance, passing it the API URI, initiating the cache, and enabling the use of the local Apollo developer tools:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// configure our API URI &amp; cache</code>&#13;
<code class="kr">const</code> <code class="nx">uri</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">API_URI</code><code class="p">;</code>&#13;
<code class="kr">const</code> <code class="nx">cache</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">InMemoryCache</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// configure Apollo Client</code>&#13;
<code class="kr">const</code> <code class="nx">client</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ApolloClient</code><code class="p">({</code>&#13;
  <code class="nx">uri</code><code class="p">,</code>&#13;
  <code class="nx">cache</code><code class="p">,</code>&#13;
  <code class="nx">connectToDevTools</code><code class="o">:</code> <code class="kc">true</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>Finally, we can connect our React application to our Apollo Client by wrapping it in an <a data-primary="ApolloProvider" data-type="indexterm" id="idm45339498055768"/><code>ApolloProvider</code>. We’ll replace our empty <code>&lt;div&gt;</code> tags with <code>&lt;ApolloProvider&gt;</code> and include our client as a connection:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">const</code> <code class="nx">App</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">ApolloProvider</code> <code class="nx">client</code><code class="o">=</code><code class="p">{</code><code class="nx">client</code><code class="p">}</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">GlobalStyle</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">Pages</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/ApolloProvider&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code></pre>&#13;
&#13;
<p>Overall, our <em>src/App.js</em> file will now look as follows:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">ReactDOM</code> <code class="nx">from</code> <code class="s1">'react-dom'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// import Apollo Client libraries</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">ApolloClient</code><code class="p">,</code> <code class="nx">ApolloProvider</code><code class="p">,</code> <code class="nx">InMemoryCache</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// global styles</code>&#13;
<code class="kr">import</code> <code class="nx">GlobalStyle</code> <code class="nx">from</code> <code class="s1">'/components/GlobalStyle'</code><code class="p">;</code>&#13;
<code class="c1">// import our routes</code>&#13;
<code class="kr">import</code> <code class="nx">Pages</code> <code class="nx">from</code> <code class="s1">'/pages'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// configure our API URI &amp; cache</code>&#13;
<code class="kr">const</code> <code class="nx">uri</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">API_URI</code><code class="p">;</code>&#13;
<code class="kr">const</code> <code class="nx">cache</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">InMemoryCache</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// configure Apollo Client</code>&#13;
<code class="kr">const</code> <code class="nx">client</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ApolloClient</code><code class="p">({</code>&#13;
  <code class="nx">uri</code><code class="p">,</code>&#13;
  <code class="nx">cache</code><code class="p">,</code>&#13;
  <code class="nx">connectToDevTools</code><code class="o">:</code> <code class="kc">true</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">App</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
  <code class="o">&lt;</code><code class="nx">ApolloProvider</code> <code class="nx">client</code><code class="o">=</code><code class="p">{</code><code class="nx">client</code><code class="p">}</code><code class="o">&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">GlobalStyle</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">Pages</code> <code class="o">/&gt;</code>&#13;
  <code class="o">&lt;</code><code class="err">/ApolloProvider&gt;</code>&#13;
<code class="p">);</code>&#13;
&#13;
<code class="nx">ReactDOM</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="o">&lt;</code><code class="nx">App</code> <code class="o">/&gt;</code><code class="p">,</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'root'</code><code class="p">));</code></pre>&#13;
&#13;
<p>With our client connected to our API server, we can now integrate GraphQL queries and mutations into our application.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Querying an API" data-type="sect1"><div class="sect1" id="idm45339498146952">&#13;
<h1>Querying an API</h1>&#13;
&#13;
<p><a data-primary="Apollo Client" data-secondary="querying an API" data-type="indexterm" id="ix_ch14-asciidoc1"/><a data-primary="application programming interface (API)" data-secondary="querying an" data-type="indexterm" id="ix_ch14-asciidoc2"/>When we query an API, we are requesting data. In a UI client, we want to be able to query that data and display it to the user. Apollo enables us to compose queries to fetch data. We can then update React components to display the data to the end user. We can explore the use of queries by writing a <code>noteFeed</code> query, which will return a feed of the latest notes to the user and display it on the application’s home page.</p>&#13;
&#13;
<p>When I am first writing a query, I find the following process useful:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Consider what data the query needs to return.</p>&#13;
</li>&#13;
<li>&#13;
<p>Write the query in the GraphQL Playground.</p>&#13;
</li>&#13;
<li>&#13;
<p>Integrate the query into the client application.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Let’s follow this process in drafting our query. If you followed along in the API portion of the book, you may recall that the <code>noteFeed</code> query returns a list of 10 notes along with a <code>cursor</code>, which indicates the position of the last note returned, and a <code>hasNextPage</code> boolean, which allows us to determine if there are additional notes to load. We can view our schema within the GraphQL Playground, allowing us to see all of the data options available. For our query, we’ll most likely require the following <span class="keep-together">information:</span></p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="nx">cursor</code>&#13;
  <code class="nx">hasNextPage</code>&#13;
  <code class="nx">notes</code> <code class="p">{</code>&#13;
    <code class="nx">id</code>&#13;
    <code class="nx">createdAt</code>&#13;
    <code class="nx">content</code>&#13;
    <code class="nx">favoriteCount</code>&#13;
    <code class="nx">author</code> <code class="p">{</code>&#13;
      <code class="nx">id</code>&#13;
      <code class="nx">username</code>&#13;
      <code class="nx">avatar</code>&#13;
      <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code></pre>&#13;
&#13;
<p>Now, in our GraphQL Playground we can flesh this out into a GraphQL query. We’ll be writing this a bit more verbosely than the queries from a server chapter, by naming the query and providing an optional variable named <code>cursor</code>. To use the GraphQL Playground, first ensure that the API server is running, and then visit <em>http://localhost:4000/api</em>. In the GraphQL Playground, add the following query:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="nx">query</code> <code class="nx">noteFeed</code><code class="p">(</code><code class="nx">$cursor</code><code class="o">:</code> <code class="nb">String</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">noteFeed</code><code class="p">(</code><code class="nx">cursor</code><code class="o">:</code> <code class="nx">$cursor</code><code class="p">)</code> <code class="p">{</code>&#13;
      <code class="nx">cursor</code>&#13;
      <code class="nx">hasNextPage</code>&#13;
      <code class="nx">notes</code> <code class="p">{</code>&#13;
        <code class="nx">id</code>&#13;
        <code class="nx">createdAt</code>&#13;
        <code class="nx">content</code>&#13;
        <code class="nx">favoriteCount</code>&#13;
        <code class="nx">author</code> <code class="p">{</code>&#13;
          <code class="nx">username</code>&#13;
          <code class="nx">id</code>&#13;
          <code class="nx">avatar</code>&#13;
        <code class="p">}</code>&#13;
      <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
  <code class="p">}</code></pre>&#13;
&#13;
<p>In the GraphQL Playground, also add a “query variable” to test out the use of the <span class="keep-together">variable:</span></p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="p">{</code>&#13;
  <code class="s2">"cursor"</code><code class="o">:</code> <code class="s2">""</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>To test out this variable, replace the empty string with the ID value of any of the notes in our database (<a data-type="xref" href="#web-first-query">Figure 14-1</a>).</p>&#13;
&#13;
<figure><div class="figure" id="web-first-query">&#13;
<img alt="A screenshot of the noteFeed query in GraphQL Playground" src="assets/jsev_1401.png"/>&#13;
<h6><span class="label">Figure 14-1. </span>Our noteFeed query in the GraphQL Playground</h6>&#13;
</div></figure>&#13;
&#13;
<p>Now that we know that our query is properly written, we can confidently integrate it into our web application. In the <em>src/pages/home.js</em> file, import the <code>useQuery</code> library as well as the GraphQL syntax via the <code>gql</code> library from <code>@apollo/client</code>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// import the required libraries</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useQuery</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// our GraphQL query, stored as a variable</code>&#13;
<code class="kr">const</code> <code class="nx">GET_NOTES</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  query NoteFeed($cursor: String) {</code>&#13;
<code class="sb">    noteFeed(cursor: $cursor) {</code>&#13;
<code class="sb">      cursor</code>&#13;
<code class="sb">      hasNextPage</code>&#13;
<code class="sb">      notes {</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">        createdAt</code>&#13;
<code class="sb">        content</code>&#13;
<code class="sb">        favoriteCount</code>&#13;
<code class="sb">        author {</code>&#13;
<code class="sb">          username</code>&#13;
<code class="sb">          id</code>&#13;
<code class="sb">          avatar</code>&#13;
<code class="sb">        }</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code></pre>&#13;
&#13;
<p>Now we can integrate the query into our React application. To do this, we’ll pass our GraphQL query string to Apollo’s <code>useQuery</code> React hook. Our hook will return an object containing one of the following values:</p>&#13;
<dl>&#13;
<dt><code>data</code></dt>&#13;
<dd>&#13;
<p>The data returned by the query, if successful.</p>&#13;
</dd>&#13;
<dt><code>loading</code></dt>&#13;
<dd>&#13;
<p>The loading state, which is set to <code>true</code> when the data is being fetched. This allows us to display a loading indicator to our users.</p>&#13;
</dd>&#13;
<dt><code>error</code></dt>&#13;
<dd>&#13;
<p>If our data fails to fetch, an error is returned to our application.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>We can update our <code>Home</code> component to include our query:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">const</code> <code class="nx">Home</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// query hook</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">data</code><code class="p">,</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">fetchMore</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_NOTES</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// if the data is loading, display a loading message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code><code class="o">!&lt;</code><code class="err">/p&gt;;</code>&#13;
&#13;
  <code class="c1">// if the data is successful, display the data in our UI</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
      <code class="p">{</code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">)}</code>&#13;
      <code class="nx">The</code> <code class="nx">data</code> <code class="nx">loaded</code><code class="o">!</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">Home</code><code class="p">;</code></pre>&#13;
&#13;
<p>If you’ve done everything successfully, you should see a “The data loaded!” message on the home page of our application (<a data-type="xref" href="#web-data-loaded">Figure 14-2</a>). We’ve also included a <span class="keep-together"><code>console.log</code></span> statement, which will print our data to the browser console. Taking a look at the structure of data results can be a helpful guidepost when integrating the data into the application.</p>&#13;
&#13;
<figure><div class="figure" id="web-data-loaded">&#13;
<img alt="A screenshot of the application, successfully connected to the data set" src="assets/jsev_1402.png"/>&#13;
<h6><span class="label">Figure 14-2. </span>If our data has been successfully fetched, our component will display a “The data loaded!” message and the data will print to the console</h6>&#13;
</div></figure>&#13;
&#13;
<p>Now, let’s integrate the data we receive into the application. To do this, we will <code>map</code> over the array of notes returned within our data. React requires that each result be assigned a unique key, for which we’ll use the individual note’s ID. To begin, we’ll display the username of the author for each note:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">const</code> <code class="nx">Home</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// query hook</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">data</code><code class="p">,</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">fetchMore</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_NOTES</code><code class="p">);</code>&#13;
&#13;
  <code class="c1">// if the data is loading, display a loading message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code><code class="o">!&lt;</code><code class="err">/p&gt;;</code>&#13;
&#13;
  <code class="c1">// if the data is successful, display the data in our UI</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
      <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">noteFeed</code><code class="p">.</code><code class="nx">notes</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">note</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="p">}</code><code class="o">&gt;</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">username</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
      <code class="p">))}</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code></pre>&#13;
<div data-type="tip"><h1>Using JavaScript’s map() Method</h1>&#13;
<p><a data-primary="map()" data-type="indexterm" id="idm45339497456792"/>If you haven’t worked with JavaScript’s <code>map()</code> method before, the syntax can seem a bit intimidating at first. The <code>map()</code> method allows you to perform an action for items within an array. This can be incredibly useful when you’re working with data returned from an API, allowing you to perform actions such as displaying each item in a certain way within the template. To learn more about <code>map()</code>, I recommend reading the <a href="https://oreil.ly/Oca3y">MDN Web Docs guide</a>.</p>&#13;
</div>&#13;
&#13;
<p>If there is data in our database, you should now see a list of usernames on the page (<a data-type="xref" href="#web-username-data">Figure 14-3</a>).</p>&#13;
&#13;
<figure><div class="figure" id="web-username-data">&#13;
<img alt="Usernames from our data, printed to the screen" src="assets/jsev_1403.png"/>&#13;
<h6><span class="label">Figure 14-3. </span>Usernames from our data, printed to the screen</h6>&#13;
</div></figure>&#13;
&#13;
<p>Now that we have successfully mapped over our data, we can write the rest of our component. Since our notes are written in Markdown, let’s import a library that will allow us to render Markdown to the page.</p>&#13;
&#13;
<p>In <em>src/pages/home.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">ReactMarkdown</code> <code class="nx">from</code> <code class="s1">'react-markdown'</code><code class="p">;</code></pre>&#13;
&#13;
<p>Now we can update our UI to include the author’s avatar, the author’s username, the date the note was created, the number of favorites that a note has, and finally the content of the note itself. In <em>src/pages/home.js</em>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// if the data is successful, display the data in our UI</code>&#13;
<code class="k">return</code> <code class="p">(</code>&#13;
  <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
    <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">noteFeed</code><code class="p">.</code><code class="nx">notes</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">note</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
      <code class="o">&lt;</code><code class="nx">article</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="p">}</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">img</code>&#13;
          <code class="nx">src</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">avatar</code><code class="p">}</code>&#13;
          <code class="nx">alt</code><code class="o">=</code><code class="p">{</code><code class="sb">`</code><code class="si">${</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">username</code><code class="si">}</code><code class="sb"> avatar`</code><code class="p">}</code>&#13;
          <code class="nx">height</code><code class="o">=</code><code class="s2">"50px"</code>&#13;
        <code class="o">/&gt;</code><code class="p">{</code><code class="s1">' '</code><code class="p">}</code>&#13;
        <code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">username</code><code class="p">}</code> <code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">createdAt</code><code class="p">}</code> <code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">favoriteCount</code><code class="p">}{</code><code class="s1">' '</code><code class="p">}</code>&#13;
        <code class="o">&lt;</code><code class="nx">ReactMarkdown</code> <code class="nx">source</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">content</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/article&gt;</code>&#13;
    <code class="p">))}</code>&#13;
  <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
<code class="p">);</code></pre>&#13;
<div data-type="note" epub:type="note"><h1>Whitespace in React</h1>&#13;
<p><a data-primary="whitespace" data-type="indexterm" id="idm45339497300424"/>React strips the whitespace between elements on new lines. Using <code>{' '}</code> in our markup is a way of manually adding whitespace.</p>&#13;
</div>&#13;
&#13;
<p>You should now see a complete list of notes in your browser. Before we move on to styling them, however, there is an opportunity for a small refactor. This is our first page displaying notes, but we know that we will be making several more. On other pages we will need to display individual notes, as well as feeds of other note types (such as “my notes” and “favorites”). Let’s go ahead and create two new components: <em>src/components/Note.js</em> and <em>src/components/NoteFeed.js</em>.</p>&#13;
&#13;
<p>In <em>src/components/Note.js</em>, we’ll include the markup for an individual note. To accomplish this, we’ll pass each of our component functions a property containing the appropriate content.</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">ReactMarkdown</code> <code class="nx">from</code> <code class="s1">'react-markdown'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">Note</code> <code class="o">=</code> <code class="p">({</code> <code class="nx">note</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">article</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">img</code>&#13;
        <code class="nx">src</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">avatar</code><code class="p">}</code>&#13;
        <code class="nx">alt</code><code class="o">=</code><code class="s2">"{note.author.username} avatar"</code>&#13;
        <code class="nx">height</code><code class="o">=</code><code class="s2">"50px"</code>&#13;
      <code class="o">/&gt;</code><code class="p">{</code><code class="s1">' '</code><code class="p">}</code>&#13;
      <code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">username</code><code class="p">}</code> <code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">createdAt</code><code class="p">}</code> <code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">favoriteCount</code><code class="p">}{</code><code class="s1">' '</code><code class="p">}</code>&#13;
      <code class="o">&lt;</code><code class="nx">ReactMarkdown</code> <code class="nx">source</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">content</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/article&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">Note</code><code class="p">;</code></pre>&#13;
&#13;
<p>Now for the <em>src/components/NoteFeed.js</em> component:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">Note</code> <code class="nx">from</code> <code class="s1">'./Note'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NoteFeed</code> <code class="o">=</code> <code class="p">({</code> <code class="nx">notes</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
      <code class="p">{</code><code class="nx">notes</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">note</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">div</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="p">}</code><code class="o">&gt;</code>&#13;
          <code class="o">&lt;</code><code class="nx">Note</code> <code class="nx">note</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
        <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
      <code class="p">))}</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">NoteFeed</code><code class="p">;</code></pre>&#13;
&#13;
<p>Finally, we can update the <em>src/pages/home.js</em> component to reference our <code>NoteFeed</code>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useQuery</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="nx">Button</code> <code class="nx">from</code> <code class="s1">'../components/Button'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">NoteFeed</code> <code class="nx">from</code> <code class="s1">'../components/NoteFeed'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">GET_NOTES</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  query NoteFeed($cursor: String) {</code>&#13;
<code class="sb">    noteFeed(cursor: $cursor) {</code>&#13;
<code class="sb">      cursor</code>&#13;
<code class="sb">      hasNextPage</code>&#13;
<code class="sb">      notes {</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">        createdAt</code>&#13;
<code class="sb">        content</code>&#13;
<code class="sb">        favoriteCount</code>&#13;
<code class="sb">        author {</code>&#13;
<code class="sb">          username</code>&#13;
<code class="sb">          id</code>&#13;
<code class="sb">          avatar</code>&#13;
<code class="sb">        }</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">Home</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// query hook</code>&#13;
 <code class="kr">const</code> <code class="p">{</code> <code class="nx">data</code><code class="p">,</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">fetchMore</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_NOTES</code><code class="p">);</code>&#13;
&#13;
 <code class="c1">// if the data is loading, display a loading message</code>&#13;
 <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
 <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
 <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code><code class="o">!&lt;</code><code class="err">/p&gt;;</code>&#13;
&#13;
 <code class="c1">// if the data is successful, display the data in our UI</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">NoteFeed</code> <code class="nx">notes</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">noteFeed</code><code class="p">.</code><code class="nx">notes</code><code class="p">}</code> <code class="o">/&gt;</code><code class="p">;</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">Home</code><code class="p">;</code></pre>&#13;
&#13;
<p>With this refactor, we’ll now be able to easily re-create note and note feed instances across our application.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Some Style" data-type="sect2"><div class="sect2" id="idm45339496889848">&#13;
<h2>Some Style</h2>&#13;
&#13;
<p>Now that we have written our components and can view our data, we can add some style. One of the most obvious opportunities for improvement is in the way that our “created at” date displays. To address this, we’ll use the <a href="https://date-fns.org"><code>date-fns</code> library</a>, which provides small components for working with dates in JavaScript. In <em>src/components/Note.js</em>, import the library and update the date markups to apply the conversion as follows:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// import the format utility from `date-fns`</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">format</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'date-fns'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// update the date markup to format it as Month, Day, and Year</code>&#13;
<code class="p">{</code><code class="nx">format</code><code class="p">(</code><code class="nx">note</code><code class="p">.</code><code class="nx">createdAt</code><code class="p">,</code> <code class="s1">'MMM Do YYYY'</code><code class="p">)}</code> <code class="nx">Favorites</code><code class="o">:</code><code class="p">{</code><code class="s1">' '</code><code class="p">}</code></pre>&#13;
&#13;
<p>With our date formatted, we can use the Styled Components library to update the note layout:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">ReactMarkdown</code> <code class="nx">from</code> <code class="s1">'react-markdown'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">format</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'date-fns'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">styled</code> <code class="nx">from</code> <code class="s1">'styled-components'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// Keep notes from extending wider than 800px</code>&#13;
<code class="kr">const</code> <code class="nx">StyledNote</code> <code class="o">=</code> <code class="nx">styled</code><code class="p">.</code><code class="nx">article</code><code class="sb">`</code>&#13;
<code class="sb">  max-width: 800px;</code>&#13;
<code class="sb">  margin: 0 auto;</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// Style the note metadata</code>&#13;
<code class="kr">const</code> <code class="nx">MetaData</code> <code class="o">=</code> <code class="nx">styled</code><code class="p">.</code><code class="nx">div</code><code class="sb">`</code>&#13;
<code class="sb">  @media (min-width: 500px) {</code>&#13;
<code class="sb">    display: flex;</code>&#13;
<code class="sb">    align-items: top;</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// add some space between the avatar and meta info</code>&#13;
<code class="kr">const</code> <code class="nx">MetaInfo</code> <code class="o">=</code> <code class="nx">styled</code><code class="p">.</code><code class="nx">div</code><code class="sb">`</code>&#13;
<code class="sb">  padding-right: 1em;</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// align 'UserActions' to the right on large screens</code>&#13;
<code class="kr">const</code> <code class="nx">UserActions</code> <code class="o">=</code> <code class="nx">styled</code><code class="p">.</code><code class="nx">div</code><code class="sb">`</code>&#13;
<code class="sb">  margin-left: auto;</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">Note</code> <code class="o">=</code> <code class="p">({</code> <code class="nx">note</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">StyledNote</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">MetaData</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">MetaInfo</code><code class="o">&gt;</code>&#13;
          <code class="o">&lt;</code><code class="nx">img</code>&#13;
            <code class="nx">src</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">author</code><code class="p">.</code><code class="nx">avatar</code><code class="p">}</code>&#13;
            <code class="nx">alt</code><code class="o">=</code><code class="s2">"{note.author.username} avatar"</code>&#13;
            <code class="nx">height</code><code class="o">=</code><code class="s2">"50px"</code>&#13;
          <code class="o">/&gt;</code>&#13;
        <code class="o">&lt;</code><code class="err">/MetaInfo&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">MetaInfo</code><code class="o">&gt;</code>&#13;
          <code class="o">&lt;</code><code class="nx">em</code><code class="o">&gt;</code><code class="nx">by</code><code class="o">&lt;</code><code class="sr">/em&gt; {note.author.username} &lt;br /</code><code class="o">&gt;</code>&#13;
          <code class="p">{</code><code class="nx">format</code><code class="p">(</code><code class="nx">note</code><code class="p">.</code><code class="nx">createdAt</code><code class="p">,</code> <code class="s1">'MMM Do YYYY'</code><code class="p">)}</code>&#13;
        <code class="o">&lt;</code><code class="err">/MetaInfo&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">UserActions</code><code class="o">&gt;</code>&#13;
          <code class="o">&lt;</code><code class="nx">em</code><code class="o">&gt;</code><code class="nx">Favorites</code><code class="o">:&lt;</code><code class="err">/em&gt; {note.favoriteCount}</code>&#13;
        <code class="o">&lt;</code><code class="err">/UserActions&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/MetaData&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">ReactMarkdown</code> <code class="nx">source</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">content</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/StyledNote&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">Note</code><code class="p">;</code></pre>&#13;
&#13;
<p>We would also be well served to add some space and a light border between the notes in our <em>NoteFeed.js</em> component:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">styled</code> <code class="nx">from</code> <code class="s1">'styled-components'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NoteWrapper</code> <code class="o">=</code> <code class="nx">styled</code><code class="p">.</code><code class="nx">div</code><code class="sb">`</code>&#13;
<code class="sb">  max-width: 800px;</code>&#13;
<code class="sb">  margin: 0 auto;</code>&#13;
<code class="sb">  margin-bottom: 2em;</code>&#13;
<code class="sb">  padding-bottom: 2em;</code>&#13;
<code class="sb">  border-bottom: 1px solid #f5f4f0;</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">import</code> <code class="nx">Note</code> <code class="nx">from</code> <code class="s1">'./Note'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NoteFeed</code> <code class="o">=</code> <code class="p">({</code> <code class="nx">notes</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
      <code class="p">{</code><code class="nx">notes</code><code class="p">.</code><code class="nx">map</code><code class="p">(</code><code class="nx">note</code> <code class="o">=&gt;</code> <code class="p">(</code>&#13;
        <code class="o">&lt;</code><code class="nx">NoteWrapper</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="p">}</code><code class="o">&gt;</code>&#13;
          <code class="o">&lt;</code><code class="nx">Note</code> <code class="nx">note</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
        <code class="o">&lt;</code><code class="err">/NoteWrapper&gt;</code>&#13;
      <code class="p">))}</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">NoteFeed</code><code class="p">;</code></pre>&#13;
&#13;
<p>With these updates, we’ve introduced layout styles to our application.<a data-startref="ix_ch14-asciidoc2" data-type="indexterm" id="idm45339496456760"/><a data-startref="ix_ch14-asciidoc1" data-type="indexterm" id="idm45339496456152"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Dynamic Queries" data-type="sect1"><div class="sect1" id="idm45339497781800">&#13;
<h1>Dynamic Queries</h1>&#13;
&#13;
<p><a data-primary="Apollo Client" data-secondary="dynamic queries" data-type="indexterm" id="ix_ch14-asciidoc3"/><a data-primary="dynamic queries" data-type="indexterm" id="ix_ch14-asciidoc4"/>Currently our application consists of three routes, each of which is static. These routes are located at a static URL and will always make the same data request. However, applications commonly need dynamic routes and queries based upon those routes. As an example, every tweet on Twitter.com is assigned a unique URL at <em>twitter.com/&lt;username&gt;/status/&lt;tweet_id&gt;</em>. This allows users to link and share individual tweets both within the Twitter ecosystem as well as anywhere on the web.</p>&#13;
&#13;
<p>Currently, in our application notes can only be accessed within a feed, but we want to allow users to view and link to individual notes. To accomplish this we’ll set up dynamic routing in our React application as well as an individual note GraphQL query. Our goal is for users to be able to access routes at <em>/note/&lt;note_id&gt;</em>.</p>&#13;
&#13;
<p>To begin, we’ll create a new page component at <em>src/pages/note.js</em>. We will pass our <code>props</code> (property) object to the component, which includes the <code>match</code> property via React Router. This property contains information about how the route path matches the URL. This will give us access to the URL parameters through <a data-primary="match.params" data-type="indexterm" id="idm45339496414424"/><code>match.params</code>.</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NotePage</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">div</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">ID</code><code class="o">:</code> <code class="p">{</code><code class="nx">props</code><code class="p">.</code><code class="nx">match</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">}</code><code class="o">&lt;</code><code class="err">/p&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/div&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">NotePage</code><code class="p">;</code></pre>&#13;
&#13;
<p>Now we can add a corresponding route to our <em>src/pages/index.js</em> file. This route will include an ID parameter indicated with <code>:id</code>:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// import React and routing dependencies</code>&#13;
<code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">BrowserRouter</code> <code class="nx">as</code> <code class="nx">Router</code><code class="p">,</code> <code class="nx">Route</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react-router-dom'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// import shared layout component</code>&#13;
<code class="kr">import</code> <code class="nx">Layout</code> <code class="nx">from</code> <code class="s1">'../components/Layout'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// import routes</code>&#13;
<code class="kr">import</code> <code class="nx">Home</code> <code class="nx">from</code> <code class="s1">'./home'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">MyNotes</code> <code class="nx">from</code> <code class="s1">'./mynotes'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">Favorites</code> <code class="nx">from</code> <code class="s1">'./favorites'</code><code class="p">;</code>&#13;
<code class="kr">import</code> <code class="nx">NotePage</code> <code class="nx">from</code> <code class="s1">'./note'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// define routes</code>&#13;
<code class="kr">const</code> <code class="nx">Pages</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="k">return</code> <code class="p">(</code>&#13;
    <code class="o">&lt;</code><code class="nx">Router</code><code class="o">&gt;</code>&#13;
      <code class="o">&lt;</code><code class="nx">Layout</code><code class="o">&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">Route</code> <code class="nx">exact</code> <code class="nx">path</code><code class="o">=</code><code class="s2">"/"</code> <code class="nx">component</code><code class="o">=</code><code class="p">{</code><code class="nx">Home</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">Route</code> <code class="nx">path</code><code class="o">=</code><code class="s2">"/mynotes"</code> <code class="nx">component</code><code class="o">=</code><code class="p">{</code><code class="nx">MyNotes</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">Route</code> <code class="nx">path</code><code class="o">=</code><code class="s2">"/favorites"</code> <code class="nx">component</code><code class="o">=</code><code class="p">{</code><code class="nx">Favorites</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
        <code class="o">&lt;</code><code class="nx">Route</code> <code class="nx">path</code><code class="o">=</code><code class="s2">"/note/:id"</code> <code class="nx">component</code><code class="o">=</code><code class="p">{</code><code class="nx">NotePage</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
      <code class="o">&lt;</code><code class="err">/Layout&gt;</code>&#13;
    <code class="o">&lt;</code><code class="err">/Router&gt;</code>&#13;
  <code class="p">);</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">Pages</code><code class="p">;</code></pre>&#13;
&#13;
<p>Now, visiting <em>http://localhost:1234/note/123</em> will print <code>ID: 123</code> to our page. To test it out, replace the ID parameter with anything of your choosing, such as <em>/note/pizza</em> or <span class="keep-together"><em>/note</em></span><em>/GONNAPARTYLIKE1999</em>. This is pretty cool, but not very useful. Let’s update our <em>src/pages/note.js</em> component to make a GraphQL query for the note with the ID found in the URL. To do this, we’ll use the <code>note</code> query from our API as well as our <code>Note</code> React component:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="nx">React</code> <code class="nx">from</code> <code class="s1">'react'</code><code class="p">;</code>&#13;
<code class="c1">// import GraphQL dependencies</code>&#13;
<code class="kr">import</code> <code class="p">{</code> <code class="nx">useQuery</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'@apollo/client'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// import the Note component</code>&#13;
<code class="kr">import</code> <code class="nx">Note</code> <code class="nx">from</code> <code class="s1">'../components/Note'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// the note query, which accepts an ID variable</code>&#13;
<code class="kr">const</code> <code class="nx">GET_NOTE</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>&#13;
<code class="sb">  query note($id: ID!) {</code>&#13;
<code class="sb">    note(id: $id) {</code>&#13;
<code class="sb">      id</code>&#13;
<code class="sb">      createdAt</code>&#13;
<code class="sb">      content</code>&#13;
<code class="sb">      favoriteCount</code>&#13;
<code class="sb">      author {</code>&#13;
<code class="sb">        username</code>&#13;
<code class="sb">        id</code>&#13;
<code class="sb">        avatar</code>&#13;
<code class="sb">      }</code>&#13;
<code class="sb">    }</code>&#13;
<code class="sb">  }</code>&#13;
<code class="sb">`</code><code class="p">;</code>&#13;
&#13;
<code class="kr">const</code> <code class="nx">NotePage</code> <code class="o">=</code> <code class="nx">props</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
  <code class="c1">// store the id found in the url as a variable</code>&#13;
  <code class="kr">const</code> <code class="nx">id</code> <code class="o">=</code> <code class="nx">props</code><code class="p">.</code><code class="nx">match</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code>&#13;
&#13;
  <code class="c1">// query hook, passing the id value as a variable</code>&#13;
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">loading</code><code class="p">,</code> <code class="nx">error</code><code class="p">,</code> <code class="nx">data</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">useQuery</code><code class="p">(</code><code class="nx">GET_NOTE</code><code class="p">,</code> <code class="p">{</code> <code class="nx">variables</code><code class="o">:</code> <code class="p">{</code> <code class="nx">id</code> <code class="p">}</code> <code class="p">});</code>&#13;
&#13;
  <code class="c1">// if the data is loading, display a loading message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">loading</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Loading</code><code class="p">...</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
  <code class="c1">// if there is an error fetching the data, display an error message</code>&#13;
  <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="k">return</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nb">Error</code><code class="o">!</code> <code class="nx">Note</code> <code class="nx">not</code> <code class="nx">found</code><code class="o">&lt;</code><code class="err">/p&gt;;</code>&#13;
&#13;
  <code class="c1">// if the data is successful, display the data in our UI</code>&#13;
  <code class="k">return</code> <code class="o">&lt;</code><code class="nx">Note</code> <code class="nx">note</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">note</code><code class="p">}</code> <code class="o">/&gt;</code><code class="p">;</code>&#13;
<code class="p">};</code>&#13;
&#13;
<code class="kr">export</code> <code class="k">default</code> <code class="nx">NotePage</code><code class="p">;</code></pre>&#13;
&#13;
<p>Now, navigating to a URL with an ID parameter will render either the corresponding note or an error message. Finally, let’s update our <em>src/components/NoteFeed.js</em> component to display a link to the individual note in the UI.</p>&#13;
&#13;
<p>First, at the top of the file, import <code>{Link}</code> from React Router:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="kr">import</code> <code class="p">{</code> <code class="nx">Link</code> <code class="p">}</code> <code class="nx">from</code> <code class="s1">'react-router-dom'</code><code class="p">;</code></pre>&#13;
&#13;
<p>Then, update the JSX to include a link to the note page as follows:</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="o">&lt;</code><code class="nx">NoteWrapper</code> <code class="nx">key</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="p">}</code><code class="o">&gt;</code>&#13;
  <code class="o">&lt;</code><code class="nx">Note</code> <code class="nx">note</code><code class="o">=</code><code class="p">{</code><code class="nx">note</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
  <code class="o">&lt;</code><code class="nx">Link</code> <code class="nx">to</code><code class="o">=</code><code class="p">{</code><code class="sb">`note/</code><code class="si">${</code><code class="nx">note</code><code class="p">.</code><code class="nx">id</code><code class="si">}</code><code class="sb">`</code><code class="p">}</code><code class="o">&gt;</code><code class="nx">Permalink</code><code class="o">&lt;</code><code class="err">/Link&gt;</code>&#13;
<code class="o">&lt;</code><code class="err">/NoteWrapper&gt;</code></pre>&#13;
&#13;
<p>With this, we are using dynamic routes in our application and enabling users to view individual notes.<a data-startref="ix_ch14-asciidoc4" data-type="indexterm" id="idm45339495822616"/><a data-startref="ix_ch14-asciidoc3" data-type="indexterm" id="idm45339495864552"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Pagination" data-type="sect1"><div class="sect1" id="idm45339497781208">&#13;
<h1>Pagination</h1>&#13;
&#13;
<p><a data-primary="Apollo Client" data-secondary="pagination" data-type="indexterm" id="ix_ch14-asciidoc5"/><a data-primary="pagination" data-type="indexterm" id="ix_ch14-asciidoc6"/>Currently we are only retrieving the 10 most recent notes within our application’s home page. If we want to display additional notes, we need to enable pagination. You may recall from the beginning of this chapter and the development of our API server that our API returns a <code>cursor</code>, which is the ID of the last note returned in a page of results. Additionally, the API returns the <code>hasNextPage</code> boolean, which is <code>true</code> if there are additional notes found in our database. When making a request to our API, we can pass it a cursor argument, which will return the next 10 items.</p>&#13;
&#13;
<p>In other words, if we have a list of 25 objects (with corresponding IDs of 1–25), when we make an initial request it will return items 1–10 as well as a <code>cursor</code> value of <code>10</code> and a <code>hasNextPage</code> value of <code>true</code>. If we make a request, passing a <code>cursor</code> value of 10, we will receive items 11–20, with a <code>cursor</code> value of <code>20</code> and a <code>hasNextPage</code> value of <code>true</code>. Finally, if we make a third request, passing it a <code>cursor</code> of <code>20</code>, we will receive items <span class="keep-together">21–25</span>, with a <code>cursor</code> value of <code>25</code> and a <code>hasNextPage</code> value of <code>false</code>. This is exactly the logic we’ll be implementing within our <code>noteFeed</code> query.</p>&#13;
&#13;
<p>To do this, let’s update our <em>src/pages/home.js</em> file to make paginated queries. In our UI, when a user clicks a See More button, the next 10 notes should load on the page. We’ll want this to happen without any page refreshes. To do this we need to include the <a data-primary="fetchMore" data-type="indexterm" id="idm45339495848456"/><code>fetchMore</code> argument within our query component and display the <code>Button</code> component only when <code>hasNextPage</code> is <code>true</code>. For now we’ll write this directly into our home page component, but it could easily be isolated into its own component or become part of the <code>NoteFeed</code> component.</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="c1">// if the data is successful, display the data in our UI</code>&#13;
<code class="k">return</code> <code class="p">(</code>&#13;
  <code class="c1">// add a &lt;React.Fragment&gt; element to provide a parent element</code>&#13;
  <code class="o">&lt;</code><code class="nx">React</code><code class="p">.</code><code class="nx">Fragment</code><code class="o">&gt;</code>&#13;
    <code class="o">&lt;</code><code class="nx">NoteFeed</code> <code class="nx">notes</code><code class="o">=</code><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">noteFeed</code><code class="p">.</code><code class="nx">notes</code><code class="p">}</code> <code class="o">/&gt;</code>&#13;
    <code class="p">{</code><code class="cm">/* Only display the Load More button if hasNextPage is true */</code><code class="p">}</code>&#13;
    <code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">noteFeed</code><code class="p">.</code><code class="nx">hasNextPage</code> <code class="o">&amp;&amp;</code> <code class="p">(</code>&#13;
      <code class="o">&lt;</code><code class="nx">Button</code><code class="o">&gt;</code><code class="nx">Load</code> <code class="nx">more</code><code class="o">&lt;</code><code class="err">/Button&gt;</code>&#13;
    <code class="p">)}</code>&#13;
  <code class="o">&lt;</code><code class="err">/React.Fragment&gt;</code>&#13;
<code class="p">);</code></pre>&#13;
<div data-type="note" epub:type="note"><h1>Conditionals in React</h1>&#13;
<p><a data-primary="conditional rendering" data-type="indexterm" id="idm45339495675848"/>In the previous example we are conditionally displaying the “Load more” button using an inline <code>if</code> statement with the <code>&amp;&amp;</code> operator. If <code>hasNextPage</code> is true, the button is displayed. You can read more about conditional rendering in the <a href="https://oreil.ly/a_F5s">official React documentation</a>.</p>&#13;
</div>&#13;
&#13;
<p>Now we can update the <code>&lt;Button&gt;</code> component to use an <a data-primary="onClick handler" data-type="indexterm" id="idm45339495671864"/><code>onClick</code> handler. When a user clicks the button, we’ll want to use the <code>fetchMore</code> method to make an additional query and append the returned data to our page.</p>&#13;
&#13;
<pre data-code-language="js" data-type="programlisting"><code class="p">{</code><code class="nx">data</code><code class="p">.</code><code class="nx">noteFeed</code><code class="p">.</code><code class="nx">hasNextPage</code> <code class="o">&amp;&amp;</code> <code class="p">(</code>&#13;
  <code class="c1">//  onClick peform a query, passing the current cursor as a variable</code>&#13;
  <code class="o">&lt;</code><code class="nx">Button</code>&#13;
    <code class="nx">onClick</code><code class="o">=</code><code class="p">{()</code> <code class="o">=&gt;</code>&#13;
      <code class="nx">fetchMore</code><code class="p">({</code>&#13;
        <code class="nx">variables</code><code class="o">:</code> <code class="p">{</code>&#13;
          <code class="nx">cursor</code><code class="o">:</code> <code class="nx">data</code><code class="p">.</code><code class="nx">noteFeed</code><code class="p">.</code><code class="nx">cursor</code>&#13;
        <code class="p">},</code>&#13;
        <code class="nx">updateQuery</code><code class="o">:</code> <code class="p">(</code><code class="nx">previousResult</code><code class="p">,</code> <code class="p">{</code> <code class="nx">fetchMoreResult</code> <code class="p">})</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
          <code class="k">return</code> <code class="p">{</code>&#13;
            <code class="nx">noteFeed</code><code class="o">:</code> <code class="p">{</code>&#13;
              <code class="nx">cursor</code><code class="o">:</code> <code class="nx">fetchMoreResult</code><code class="p">.</code><code class="nx">noteFeed</code><code class="p">.</code><code class="nx">cursor</code><code class="p">,</code>&#13;
              <code class="nx">hasNextPage</code><code class="o">:</code> <code class="nx">fetchMoreResult</code><code class="p">.</code><code class="nx">noteFeed</code><code class="p">.</code><code class="nx">hasNextPage</code><code class="p">,</code>&#13;
              <code class="c1">// combine the new results and the old</code>&#13;
              <code class="nx">notes</code><code class="o">:</code> <code class="p">[</code>&#13;
                <code class="p">...</code><code class="nx">previousResult</code><code class="p">.</code><code class="nx">noteFeed</code><code class="p">.</code><code class="nx">notes</code><code class="p">,</code>&#13;
                <code class="p">...</code><code class="nx">fetchMoreResult</code><code class="p">.</code><code class="nx">noteFeed</code><code class="p">.</code><code class="nx">notes</code>&#13;
              <code class="p">],</code>&#13;
              <code class="nx">__typename</code><code class="o">:</code> <code class="s1">'noteFeed'</code>&#13;
            <code class="p">}</code>&#13;
          <code class="p">};</code>&#13;
        <code class="p">}</code>&#13;
      <code class="p">})</code>&#13;
    <code class="p">}</code>&#13;
  <code class="o">&gt;</code>&#13;
    <code class="nx">Load</code> <code class="nx">more</code>&#13;
  <code class="o">&lt;</code><code class="err">/Button&gt;</code>&#13;
<code class="p">)}</code></pre>&#13;
&#13;
<p>The previous code might look a little gnarly, so let’s break it down. Our <code>&lt;Button&gt;</code> component includes an <code>onClick</code> handler. When the button is clicked, a new query is executed using the <code>fetchMore</code> method, passing the <code>cursor</code> value returned in the previous query. Once returned, <a data-primary="updateQuery" data-type="indexterm" id="idm45339495560984"/><code>updateQuery</code> is executed, which updates our <code>cursor</code> and <code>hasNextPage</code> values and combines the results into a single array. The <code>__typename</code> is the name of the query, which is included in Apollo’s results.</p>&#13;
&#13;
<p>With this change, we are able to view all of the notes from our note feed. Try it out yourself by scrolling to the bottom of your note feed. If your database contains more than 10 notes, the button will be visible. Clicking “Load more” will add the next <code>noteFeed</code> result to the page.<a data-startref="ix_ch14-asciidoc6" data-type="indexterm" id="idm45339495557640"/><a data-startref="ix_ch14-asciidoc5" data-type="indexterm" id="idm45339495556904"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conclusion" data-type="sect1"><div class="sect1" id="idm45339495863352">&#13;
<h1>Conclusion</h1>&#13;
&#13;
<p>We’ve covered a lot of ground in this chapter. We’ve set up Apollo Client to work with our React application and integrated multiple GraphQL queries into our UI. The power of GraphQL is demonstrated in the ability to write single queries that return precisely the data that a UI requires. In the next chapter we’ll integrate user authentication into our application, allowing users to log in and view their notes and <span class="keep-together">favorites.</span><a data-startref="ix_ch14-asciidoc0" data-type="indexterm" id="idm45339495553944"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>