<html><head></head><body>
<div id="sbo-rt-content"><section data-pdf-bookmark="Chapter 4. System Hardening" data-type="chapter" epub:type="chapter"><div class="chapter" id="system_hardening">
<h1><span class="label">Chapter 4. </span>System Hardening</h1>
<p><a data-primary="system hardening" data-secondary="about" data-type="indexterm" id="idm46394759449600"/><a data-primary="system hardening" data-type="indexterm" id="sh_ch"/>The domain “system hardening” deals with security aspects relevant to the underlying host system running the Kubernetes cluster nodes. Topics discussed here touch on techniques and configuration options that are fundamentally Linux core functionality. This includes disabling services and removing packages, managing users and groups, disabling ports, and setting up firewall rules. Finally, this chapter discusses Linux kernel hardening tools that can restrict what operations a process running in a container can perform on a host level.</p>
<p>At a high level, this chapter covers the following concepts:</p>
<ul>
<li>
<p>Minimizing the host OS footprint</p>
</li>
<li>
<p>Minimizing IAM roles</p>
</li>
<li>
<p>Minimizing external access to the network</p>
</li>
<li>
<p>Using kernel hardening tools like AppArmor and seccomp</p>
</li>
</ul>
<section class="less_space" data-pdf-bookmark="Minimizing the Host OS Footprint" data-type="sect1"><div class="sect1" id="idm46394759442896">
<h1>Minimizing the Host OS Footprint</h1>
<p><a data-primary="host OS footprint, minimizing" data-type="indexterm" id="hos_min"/><a data-primary="system hardening" data-secondary="minimizing host OS footprint" data-type="indexterm" id="sh_min"/>Cluster nodes run on physical or virtual machines. In most cases, the operating system on those machines is a Linux distribution. Evidently, the operating system can expose security vulnerabilities.</p>
<p>Over time, you need to keep the version of the operating system up to date with the latest security fixes. This process could entail upgrading a node’s operating system from Ubuntu 18 to 22, for example. Upgrading the operating system is out of scope for this book; for more information, check the relevant Linux documentation.</p>
<p>Many Linux distributions, such as Ubuntu, come with additional tools, applications, and services that are not necessarily required for operating the Kubernetes cluster. It is your job as an administrator to identify security risks, disable or remove any operating system-specific functionality that may expose vulnerabilities, and keep the operating system patched to incorporate the latest security fixes. The less functionality an operating system has, the smaller the risk.</p>
<div data-type="tip"><h1>CIS benchmark for Ubuntu Linux</h1>
<p><a data-primary="Ubuntu Linux, CIS benchmark for" data-type="indexterm" id="idm46394759437040"/><a data-primary="CIS benchmark, for Ubuntu Linux" data-type="indexterm" id="idm46394759436272"/>As a reference guide, you may want to compare your operating system’s configuration with the <a href="https://oreil.ly/AeAAE">CIS benchmark for Ubuntu Linux</a>.</p>
</div>
<section data-pdf-bookmark="Scenario: An Attacker Exploits a Package Vulnerability" data-type="sect2"><div class="sect2" id="idm46394759434432">
<h2>Scenario: An Attacker Exploits a Package Vulnerability</h2>
<p><a data-type="xref" href="#os-package-attacker">Figure 4-1</a> illustrates an attacker exploiting a vulnerability of a package installed on the system. For example, the application could be the package manager <a href="https://oreil.ly/ZOFTj">snapd</a>. Assume that the attacker takes advantage of the known vulnerability <a href="https://oreil.ly/lw_MV">USN-5292-1</a> that has the potential of exposing sensitive information to an attacker<a data-primary="snapd package manager" data-type="indexterm" id="idm46394759430784"/><a data-primary="scenarios" data-secondary="attacker exploits package vulnerabilities" data-type="indexterm" id="idm46394759430080"/>.</p>
<figure><div class="figure" id="os-package-attacker">
<img alt="ckss 0401" height="391" src="assets/ckss_0401.png" width="1127"/>
<h6><span class="label">Figure 4-1. </span>An attacker exploits an OS-level vulnerability</h6>
</div></figure>
<p>The following section will explain how to minimize security risks for services and packages that are not really needed for operating Kubernetes by simply disabling or removing them.</p>
</div></section>
<section data-pdf-bookmark="Disabling Services" data-type="sect2"><div class="sect2" id="idm46394759426272">
<h2>Disabling Services</h2>
<p><a data-primary="systemctl command" data-type="indexterm" id="idm46394759424736"/><a data-primary="commands" data-secondary="systemctl" data-type="indexterm" id="idm46394759424032"/><a data-primary="services, disabling" data-type="indexterm" id="idm46394759423088"/>On Linux, many applications run as services in the background. Services can be managed using the command line tool <code>systemctl</code>. The following <code>systemctl</code> command lists all running services:</p>
<pre data-type="programlisting"><strong>$ systemctl | grep running</strong>
...
snapd.service   loaded active running   Snap Daemon</pre>
<p><a data-primary="status command" data-type="indexterm" id="idm46394759419920"/><a data-primary="commands" data-secondary="status" data-type="indexterm" id="idm46394759419216"/>One of the services we will not need for operating a cluster node is the package manager snapd. For more details on the service, retrieve the status for it with the <code>status</code> subcommand:</p>
<pre data-type="programlisting"><strong>$ systemctl status snapd</strong>
● snapd.service - Snap Daemon
     Loaded: loaded (/lib/systemd/system/snapd.service; enabled; vendor \
     preset: enabled)
     Active: active (running) since Mon 2022-09-19 22:49:56 UTC; 30min ago
TriggeredBy: ● snapd.socket
   Main PID: 704 (snapd)
      Tasks: 12 (limit: 2339)
     Memory: 45.9M
     CGroup: /system.slice/snapd.service
             └─704 /usr/lib/snapd/snapd</pre>
<p>You can stop service using the <code>systemctl</code> subcommand <code>stop</code>:</p>
<pre data-type="programlisting"><strong>$ sudo systemctl stop snapd</strong>
Warning: Stopping snapd.service, but it can still be activated by:
  snapd.socket</pre>
<p><a data-primary="disable command" data-type="indexterm" id="idm46394759414096"/><a data-primary="commands" data-secondary="disable" data-type="indexterm" id="idm46394759413392"/>Execute the <code>disable</code> subcommand to prevent the service from being started again upon a system restart:</p>
<pre data-type="programlisting"><strong>$ sudo systemctl disable snapd</strong>
Removed /etc/systemd/system/multi-user.target.wants/snapd.service.</pre>
<p>The service has now been stopped and disabled:</p>
<pre data-type="programlisting"><strong>$ systemctl status snapd</strong>
● snapd.service - Snap Daemon
     Loaded: loaded (/lib/systemd/system/snapd.service; disabled; vendor \
     preset: enabled)
     Active: inactive (dead) since Mon 2022-09-19 23:22:22 UTC; 4min 4s ago
TriggeredBy: ● snapd.socket
   Main PID: 704 (code=exited, status=0/SUCCESS)</pre>
</div></section>
<section data-pdf-bookmark="Removing Unwanted Packages" data-type="sect2"><div class="sect2" id="idm46394759425648">
<h2>Removing Unwanted Packages</h2>
<p><a data-primary="packages, removing unwanted" data-type="indexterm" id="idm46394759407728"/><a data-primary="apt purge command" data-type="indexterm" id="idm46394759407008"/><a data-primary="commands" data-secondary="apt purge" data-type="indexterm" id="idm46394759406336"/>Now that the service has been disabled, there’s no more point in keeping the package around. You can remove the package to free up additional disk space and memory. You can use the <code>apt purge</code> command to remove a package and its transitive packages, as demonstrated in the following:</p>
<pre data-type="programlisting"><strong>$ sudo apt purge --auto-remove snapd</strong>
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages will be REMOVED:
  snapd* squashfs-tools*
0 upgraded, 0 newly installed, 2 to remove and 116 not upgraded.
After this operation, 147 MB disk space will be freed.
Do you want to continue? [Y/n] y
...</pre>
<p>You can use the same command even if the package isn’t controlled by a service. Identify the packages you don’t need and simply remove them. You should end up with a much slimmer footprint of your system.</p>
<p><a data-primary="" data-startref="hos_min" data-type="indexterm" id="idm46394759403120"/><a data-primary="" data-startref="sh_min" data-type="indexterm" id="idm46394759402144"/>A potential attacker cannot use the snapd service anymore to exploit the system. You should repeat the process for any unwanted services. As a result, the snapd service ceases to exist on the system:</p>
<pre data-type="programlisting"><strong>$ systemctl status snapd</strong>
Unit snapd.service could not be found.</pre>
</div></section>
</div></section>
<section data-pdf-bookmark="Minimizing IAM Roles" data-type="sect1"><div class="sect1" id="idm46394759399904">
<h1>Minimizing IAM Roles</h1>
<p><a data-primary="identity and access management (IAM) roles, minimizing" data-type="indexterm" id="iam_min"/><a data-primary="roles" data-secondary="identity and access management (IAM)" data-type="indexterm" id="rol_min"/><a data-primary="system hardening" data-secondary="minimizing IAM roles" data-type="indexterm" id="sh_rol"/>Identity and access management (IAM) on the system level involves management of Linux users, the groups they belong to, and the permissions granted to them. Any directory and file will have file permissions assigned to a user.</p>
<p>Proper user and access management is a classic responsibility of every system administrator. While your role as a Kubernetes administrator may not directly involve system-level IAM, it’s important to understand the implications to security. You will likely have to work with a peer to harden the system running the Kubernetes cluster.</p>
<p>This section will provide a short introduction on how to manage users and groups. We will also discuss how to set file permissions and ownership to minimize access as much as possible. We will only scratch the surface of the topic in this book. For more information, refer to the Linux documentation of your choice.</p>
<section data-pdf-bookmark="Scenario: An Attacker Uses Credentials to Gain File Access" data-type="sect2"><div class="sect2" id="idm46394759394016">
<h2>Scenario: An Attacker Uses Credentials to Gain File Access</h2>
<p><a data-primary="scenarios" data-secondary="attacker uses credentials to gain file access" data-type="indexterm" id="idm46394759392768"/>A security breach can lead to stolen user credentials. Gaining access to valid user credentials opens the door for additional attack vectors. <a data-type="xref" href="#iam-attacker">Figure 4-2</a> shows an attacker who could log into a cluster node with stolen user credentials and can now interact with all files and directories with the permissions granted to the user.</p>
<figure><div class="figure" id="iam-attacker">
<img alt="ckss 0402" height="375" src="assets/ckss_0402.png" width="975"/>
<h6><span class="label">Figure 4-2. </span>An attacker uses stolen credentials to access files</h6>
</div></figure>
<p>It’s recommended to follow the principle of least privilege. Only grant administrative permissions to a limited group of users. All other users should only be allowed to perform operations necessary to perform their jobs.</p>
</div></section>
<section data-pdf-bookmark="Understanding User Management" data-type="sect2"><div class="sect2" id="idm46394759387968">
<h2>Understanding User Management</h2>
<p><a data-primary="user management" data-type="indexterm" id="idm46394759386624"/>Every user must authenticate to a system to use it. The authenticated user has access to resources based on the assigned permissions. This section will walk you through the primary operations required to manage users.</p>
<section data-pdf-bookmark="Listing users" data-type="sect3"><div class="sect3" id="idm46394759385664">
<h3>Listing users</h3>
<p><a data-primary="users" data-secondary="listing" data-type="indexterm" id="idm46394759384320"/><a data-primary="listing users" data-type="indexterm" id="idm46394759383344"/>To list all users on the system, render the contents of the file <code>/etc/passwd</code>. Every entry follows the general pattern <code>username:password:UID:GID:com⁠ment:​home:shell</code>. Some of the fields within the pattern may be empty:</p>
<pre data-type="programlisting"><strong>$ cat /etc/passwd</strong>
root:x:0:0:root:/root:/bin/bash
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
...</pre>
<p>The command output renders the user root in the first position of the output. The last portion of the string for the <code>root</code> user, <code>/bin/bash</code>, indicates that the user is allowed to log into the system with a <code>bash</code> shell. Other users might not be allowed to log in at all. For those users, you will find the string <code>/usr/sbin/nologin</code> assigned to the <code>shell</code> field.</p>
<p>At any given point of time, you can see which processes have been started by users. The following command shows all <code>bash</code> processes, including the corresponding user that started it:</p>
<pre data-type="programlisting"><strong>$ ps aux | grep bash</strong>
root         956  0.0  0.4  22512 19200 pts/0    Ss   17:57   0:00 -bash
root        7064  0.0  0.0   6608  2296 pts/0    S+   18:08   0:00 grep \
--color=auto bash</pre>
</div></section>
<section data-pdf-bookmark="Adding a user" data-type="sect3"><div class="sect3" id="idm46394759375136">
<h3>Adding a user</h3>
<p><a data-primary="users" data-secondary="adding" data-type="indexterm" id="idm46394759373760"/><a data-primary="adduser command" data-type="indexterm" id="idm46394759372784"/><a data-primary="commands" data-secondary="adduser" data-type="indexterm" id="idm46394759372112"/>At some point, you may want to give team members access to the machines running the cluster nodes, with limited permissions. You can add new users to the system with the <code>adduser</code> command. Add the flag <code>--shell /sbin/nologin</code> to disable shell access for the user. The following command creates the user <code>ben</code>:</p>
<pre data-type="programlisting"><strong>$ sudo adduser ben</strong>
Adding user ‘ben’ ...
Adding new group ‘ben’ (1001) ...
Adding new user ‘ben’ (1001) with group ‘ben’ ...
Creating home directory ‘/home/ben’ ...
Copying files from ‘/etc/skel’ ...
New password:
Retype new password:
...</pre>
<p>The user entry has been added to the file <code>/etc/passwd</code>:</p>
<pre data-type="programlisting"><strong>$ cat /etc/passwd</strong>
...
ben:x:1001:1001:,,,:/home/ben:/bin/bash</pre>
</div></section>
<section data-pdf-bookmark="Switching to a user" data-type="sect3"><div class="sect3" id="idm46394759366688">
<h3>Switching to a user</h3>
<p><a data-primary="users" data-secondary="switching to" data-type="indexterm" id="idm46394759365312"/><a data-primary="su command" data-type="indexterm" id="idm46394759364336"/><a data-primary="commands" data-secondary="su" data-type="indexterm" id="idm46394759363664"/>You can change the user in a shell by using the <code>su</code> command. The following command switches to the user <code>ben</code> we created earlier. You will be asked to enter the user’s password:</p>
<pre data-type="programlisting"><strong>$ su ben</strong>
Password:
ben@controlplane:/root$ pwd
/root</pre>
<p>The shell will indicate the current user by its prompt. You will inherit the environment variables from the account you used when running the <code>su</code> command. To create a new environment, add the hyphen with the <code>su</code> command:</p>
<pre data-type="programlisting"><strong>$ su - ben</strong>
ben@controlplane:~$ pwd
/home/ben</pre>
<p><a data-primary="sudo command" data-type="indexterm" id="idm46394759357760"/><a data-primary="commands" data-secondary="sudo" data-type="indexterm" id="idm46394759357056"/>Another way to temporarily switch the user is by using the <code>sudo</code> command. You will need to have elevated privileges to execute the command. Therefore, the <code>sudo</code> command is equivalent to “run this command as administrator”:</p>
<pre data-type="programlisting"><strong>$ sudo -u ben pwd</strong>
/root</pre>
</div></section>
<section data-pdf-bookmark="Deleting a user" data-type="sect3"><div class="sect3" id="idm46394759353808">
<h3>Deleting a user</h3>
<p><a data-primary="users" data-secondary="deleting" data-type="indexterm" id="idm46394759352608"/>Team members, represented by users in the system, transition to other teams or may simply leave the company. You will want to revoke access to the user to prevent unauthorized use of the credentials. The following command deletes the user, including the user’s home directory:</p>
<pre data-type="programlisting"><strong>$ sudo userdel -r ben</strong></pre>
</div></section>
</div></section>
<section data-pdf-bookmark="Understanding Group Management" data-type="sect2"><div class="sect2" id="idm46394759350336">
<h2>Understanding Group Management</h2>
<p><a data-primary="group management" data-type="indexterm" id="idm46394759348992"/>It’s more convenient for a system administrator to group users with similar access requirements to control permissions on an individual user level. Linux systems offer the concept of a group as a way to organize users based on teams, or specific organizational roles. We’ll briefly touch on the most important aspects of group management.</p>
<section data-pdf-bookmark="Listing groups" data-type="sect3"><div class="sect3" id="idm46394759348032">
<h3>Listing groups</h3>
<p><a data-primary="listing groups" data-type="indexterm" id="idm46394759346864"/><a data-primary="groups" data-type="indexterm" id="idm46394759346160"/>Groups can be listed by inspecting the contents of the file <code>/etc/group</code>. Every entry follows the general pattern <code>groupname:password:GID:group members</code>:</p>
<pre data-type="programlisting"><strong>$ cat /etc/group</strong>
root:x:0:
plugdev:x:46:packer
nogroup:x:65534:
...</pre>
<p>As you can see in the output, some of the fields may be empty. The only group with an assigned member is <code>plugdev</code>, whose name is <code>packer</code>.</p>
</div></section>
<section data-pdf-bookmark="Adding a group" data-type="sect3"><div class="sect3" id="idm46394759341712">
<h3>Adding a group</h3>
<p><a data-primary="groupadd command" data-type="indexterm" id="idm46394759340304"/><a data-primary="commands" data-secondary="groupadd" data-type="indexterm" id="idm46394759339600"/>Use the command <code>groupadd</code> to add a new group. The following example adds the group <code>kube-developers</code>:</p>
<pre data-type="programlisting"><strong>$ sudo groupadd kube-developers</strong></pre>
<p>The group will now be listed in the file <code>/etc/group</code>. Notice that the group identifier is 1004:</p>
<pre data-type="programlisting"><strong>$ cat /etc/group</strong>
...
kube-developers:x:1004:</pre>
</div></section>
<section data-pdf-bookmark="Assigning a user to a group" data-type="sect3"><div class="sect3" id="idm46394759334656">
<h3>Assigning a user to a group</h3>
<p><a data-primary="users" data-secondary="adding to groups" data-type="indexterm" id="idm46394759333312"/>To assign a group to a user, use the <code>usermod</code> command. The following command adds the user <code>ben</code> to the group <code>kube-developers</code>:</p>
<pre data-type="programlisting"><strong>$ sudo usermod -g kube-developers ben</strong></pre>
<p>The group identifier 1004 acts as a stand-in for the group <code>kube-developers</code>:</p>
<pre data-type="programlisting"><strong>$ cat /etc/passwd | grep ben</strong>
ben:x:1001:1004:,,,:/home/ben:/bin/bash</pre>
</div></section>
<section data-pdf-bookmark="Deleting a group" data-type="sect3"><div class="sect3" id="idm46394759327792">
<h3>Deleting a group</h3>
<p><a data-primary="groupdel command" data-type="indexterm" id="idm46394759326480"/><a data-primary="commands" data-secondary="groupdel" data-type="indexterm" id="idm46394759325776"/>Sometimes you want to get rid of a group entirely. Maybe the organizational role referring to a Linux group that does not exist anymore. Use the <code>groupdel</code> command to delete a group. You will receive an error message if the members are still part of the group:</p>
<pre data-type="programlisting"><strong>$ sudo groupdel kube-developers</strong>
groupdel: cannot remove the primary group of user <em>ben</em></pre>
<p><a data-primary="usermod command" data-type="indexterm" id="idm46394759322400"/><a data-primary="commands" data-secondary="usermod" data-type="indexterm" id="idm46394759321472"/>Before deleting a group, you should reassign group members to a different group using the <code>usermod</code> command. The following command changes the group from <code>kube-developers</code> to <code>kube-admins</code>. Assume that the group <code>kube-admins</code> has been created before:</p>
<pre data-type="programlisting"><strong>$ sudo usermod -g kube-admins ben</strong>
<strong>$ sudo groupdel kube-developers</strong></pre>
</div></section>
</div></section>
<section data-pdf-bookmark="Understanding File Permissions and Ownership" data-type="sect2"><div class="sect2" id="idm46394759317200">
<h2>Understanding File Permissions and Ownership</h2>
<p><a data-primary="file permissions" data-type="indexterm" id="idm46394759315792"/><a data-primary="file ownership" data-type="indexterm" id="idm46394759315088"/>Assigning the file permissions with as minimal access as possible is crucial to maximizing security. This is where Linux file permissions and ownership come into play. I am only going to discuss the relevant operations on a high level. Refer to the <a href="https://oreil.ly/3IpRT">Linux Foundation’s blog post about Linux file permissions</a> for more details.</p>
<section data-pdf-bookmark="Viewing file permissions and ownership" data-type="sect3"><div class="sect3" id="idm46394759313504">
<h3>Viewing file permissions and ownership</h3>
<p><a data-primary="touch command" data-type="indexterm" id="idm46394759312080"/><a data-primary="commands" data-secondary="touch" data-type="indexterm" id="idm46394759311376"/>Every user can create new directories and files. For example, you could use the <code>touch</code> command to create an empty file. The following command creates a file with the name <code>my-file</code> in the current directory:</p>
<pre data-type="programlisting"><strong>$ touch my-file</strong></pre>
<p><a data-primary="ls command" data-type="indexterm" id="idm46394759308272"/><a data-primary="commands" data-secondary="ls" data-type="indexterm" id="idm46394759307568"/>To see the contents of a directory in the “long” format, use the <code>ls</code> command. The long format of the output requested by the <code>-l</code> command line parameter renders the file permissions and the file ownership:</p>
<pre data-type="programlisting"><strong>$ ls -l</strong>
total 0
-rw-r--r-- 1 root root 0 Sep 26 17:53 my-file</pre>
<p>The important portion of the output is <code>-rw-r--r--</code>. The first character is a special permission character that can vary per system, followed by three groupings with the notation <code>rwx</code>. The first three characters stand for the owner permissions, the second set of three characters is for the group permissions, and the last three characters represent the permissions for all users. The symbol <code>r</code> means read permissions, <code>w</code> stands for write permissions, and <code>x</code> refers to execution permissions. In the previous example, the user <code>root</code> can read and write the file, whereas the group and all other users can only read the file.</p>
</div></section>
<section data-pdf-bookmark="Changing file ownership" data-type="sect3"><div class="sect3" id="idm46394759301024">
<h3>Changing file ownership</h3>
<p><a data-primary="chown command" data-type="indexterm" id="idm46394759299824"/><a data-primary="commands" data-secondary="chown" data-type="indexterm" id="idm46394759298896"/>Use the <code>chown</code> command to change the user and group assignment for a file or directory. The syntax of the command follows the pattern <code>chown owner:group filename</code>. The following command changes the ownership of the file to the user <code>ben</code> but does not reassign a group. The user executing the <code>chown</code> command needs to have write permissions:</p>
<pre data-type="programlisting"><strong>$ chown ben my-file</strong>
<strong>$ ls -l</strong>
total 0
-rw-r--r-- 1 ben  root 0 Sep 26 17:53 my-file</pre>
</div></section>
<section data-pdf-bookmark="Changing file permissions" data-type="sect3"><div class="sect3" id="idm46394759294272">
<h3>Changing file permissions</h3>
<p><a data-primary="chmod command" data-type="indexterm" id="idm46394759293104"/><a data-primary="commands" data-secondary="chmod" data-type="indexterm" id="idm46394759292400"/><a data-primary="file permissions" data-type="indexterm" id="idm46394759291456"/><a data-primary="" data-startref="iam_min" data-type="indexterm" id="idm46394759290784"/><a data-primary="" data-startref="rol_min" data-type="indexterm" id="idm46394759289840"/><a data-primary="" data-startref="sh_rol" data-type="indexterm" id="idm46394759288896"/>You can add or remove permissions with the <code>chmod</code> command in a variety of notations. For example, use the following command to remove write permissions for the file owner:</p>
<pre data-type="programlisting"><strong>$ chmod -w file1</strong>
<strong>$ ls -l</strong>
total 0
-r--r--r-- 1 ben  root 0 Sep 26 17:53 my-file</pre>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="Minimizing External Access to the Network" data-type="sect1"><div class="sect1" id="idm46394759285632">
<h1>Minimizing External Access to the Network</h1>
<p><a data-primary="system hardening" data-secondary="minimizing external access to networks" data-type="indexterm" id="idm46394759284400"/><a data-primary="external access, minimizing to network" data-type="indexterm" id="idm46394759283456"/><a data-primary="networks, minimizing external access to" data-type="indexterm" id="idm46394759282816"/>External access to your cluster nodes should only be allowed for the ports necessary to operate Kubernetes. We already discussed the standard Kubernetes ports in <a data-type="xref" href="ch02.xhtml#node-metadata-endpoints">“Protecting Node Metadata and Endpoints”</a>. Access to all other ports should be blocked.</p>
<section data-pdf-bookmark="Identifying and Disabling Open Ports" data-type="sect2"><div class="sect2" id="idm46394759281040">
<h2>Identifying and Disabling Open Ports</h2>
<p><a data-primary="FTP servers" data-type="indexterm" id="idm46394759279232"/><a data-primary="disabling" data-secondary="open ports" data-type="indexterm" id="idm46394759278528"/><a data-primary="ports" data-secondary="disabling open" data-type="indexterm" id="idm46394759277584"/><a data-primary="ports" data-secondary="identifying open" data-type="indexterm" id="idm46394759276640"/><a data-primary="ports" data-secondary="open" data-type="indexterm" id="idm46394759275696"/>Applications like FTP servers, web servers, and file and print services such as Samba open ports as a means to expose a communication endpoint to clients. Running applications that open network communication can expose a security risk. You can eliminate the risk by simply disabling the service and deinstalling the application.</p>
<p>Let’s say we <a href="https://oreil.ly/t-np3">installed the Apache 2 HTTP web server</a> on a control plane node with the following commands:</p>
<pre data-type="programlisting"><strong>$ sudo apt update
$ sudo apt install apache2</strong></pre>
<div data-type="note" epub:type="note"><h1>Update about netstat command</h1>
<p><a data-primary="netstat command" data-type="indexterm" id="idm46394759271376"/><a data-primary="commands" data-secondary="netstat" data-type="indexterm" id="idm46394759270672"/><a data-primary="ss command" data-type="indexterm" id="idm46394759269728"/><a data-primary="commands" data-secondary="ss" data-type="indexterm" id="idm46394759269056"/>The <code>netstat</code> command has been deprecated in favor of the faster, more human-readable <code>ss</code> command. For more information, refer to the documentation of the operating system you are using.</p>
</div>
<p class="pagebreak-before">We can inspect all open ports using the command line tool <code>ss</code>, a utility with similar functionality to <code>netstat</code>. The following command renders all of the open ports, including their processes. Among them is port 80, exposed by Apache 2:</p>
<pre data-type="programlisting">
<strong>$ sudo ss -ltpn</strong>
State    Recv-Q   Send-Q   Local Address:Port   Peer Address:Port   Process
...
LISTEN   0        511      *:80                 *:*                 users: \
(("apache2",pid=18435,fd=4),("apache2",pid=18434,fd=4),("apache2", ]\
pid=18432,fd=4))
</pre>
<p><a data-primary="systemctl status command" data-type="indexterm" id="idm46394759263632"/><a data-primary="commands" data-secondary="systemctl status" data-type="indexterm" id="idm46394759262864"/>You may have only needed the web server temporarily and may have simply forgotten about installing it. The process is currently managed by a server. You can review the status of a service with the <code>systemctl status</code> command:</p>
<pre data-type="programlisting"><strong>$ sudo systemctl status apache2</strong>
● apache2.service - The Apache HTTP Server
     Loaded: loaded (/lib/systemd/system/apache2.service; enabled; vendor \
     preset: enabled)
     Active: active (running) since Tue 2022-09-20 22:25:25 UTC; 39s ago
       Docs: https://httpd.apache.org/docs/2.4/
   Main PID: 18432 (apache2)
      Tasks: 55 (limit: 2339)
     Memory: 5.6M
     CGroup: /system.slice/apache2.service
             ├─18432 /usr/sbin/apache2 -k start
             ├─18434 /usr/sbin/apache2 -k start
             └─18435 /usr/sbin/apache2 -k start</pre>
<p>Apache 2 is not needed by Kubernetes. We decide to shut down the service and deinstall the package:</p>
<pre data-type="programlisting"><strong>$ sudo systemctl stop apache2
$ sudo systemctl disable apache2</strong>
Synchronizing state of apache2.service with SysV service script with \
/lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install disable apache2
Removed /etc/systemd/system/multi-user.target.wants/apache2.service.
<strong>$ sudo apt purge --auto-remove apache2</strong></pre>
<p>Verify that the port isn’t used anymore. The <code>ss</code> command doesn’t find an application exposing port 80 anymore:</p>
<pre data-type="programlisting"><strong>$ sudo ss -ltpn | grep :80</strong></pre>
</div></section>
<section data-pdf-bookmark="Setting Up Firewall Rules" data-type="sect2"><div class="sect2" id="idm46394759280448">
<h2>Setting Up Firewall Rules</h2>
<p><a data-primary="firewalls, setting up rules for" data-type="indexterm" id="idm46394759255200"/><a data-primary="rules" data-secondary="for firewalls" data-type="indexterm" id="idm46394759254480"/><a data-primary="UFW (Uncomplicated Firewall)" data-type="indexterm" id="idm46394759253536"/>Another way to control ports is with the help of an operating-system-level firewall. On Linux, you could use the <a href="https://oreil.ly/iqiwv">Uncomplicated Firewall (UFW)</a>. This section will give you a very brief introduction on how to enable UFW and how to configure firewall rules.</p>
<p>Following the principle of least privilege, it’s a good idea to start by enabling the firewall and setting up deny rules for <em>any</em> incoming and outgoing network traffic. The following commands demonstrate the steps to achieve that:</p>
<pre data-type="programlisting"><strong>$ sudo ufw allow ssh</strong>
Rules updated
Rules updated (v6)
<strong>$ sudo ufw default deny outgoing</strong>
Default outgoing policy changed to <em>deny</em>
(be sure to update your rules accordingly)
<strong>$ sudo ufw default deny incoming</strong>
Default incoming policy changed to <em>deny</em>
(be sure to update your rules accordingly)
<strong>$ sudo ufw enable</strong>
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
Firewall is active and enabled on system startup</pre>
<p>You will want to allow external tools like <code>kubectl</code> to connect to the API server running on port 6443. On the control plane node, execute the following command to allow access to the API server port:</p>
<pre data-type="programlisting"><strong>$ sudo ufw allow 6443</strong>
Rule added
Rule added (v6)</pre>
<p>You will have to repeat the same process to open up other ports on control plane and worker nodes. Ensure that all other ports not needed to operate Kubernetes are blocked.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Using Kernel Hardening Tools" data-type="sect1"><div class="sect1" id="idm46394759244304">
<h1>Using Kernel Hardening Tools</h1>
<p><a data-primary="kernel hardening tools" data-type="indexterm" id="kht_ab"/><a data-primary="system hardening" data-secondary="using kernel hardening tools" data-type="indexterm" id="sh_kht"/><a data-primary="tools" data-secondary="kernel hardening" data-type="indexterm" id="t_kht"/>Applications or processes running inside of a container can make system calls. A typical example could be the <code>curl</code> command performing an HTTP request. A system call is a programmatic abstraction running in the user space for requesting a service from the kernel. We can restrict which system calls are allowed to be made with the help of kernel hardening tools. The CKS exam explicitly mentions two tools in this space, AppArmor and seccomp. We’ll discuss both tools and the mechanics to integrate them with Kubernetes.</p>
<section data-pdf-bookmark="Using AppArmor" data-type="sect2"><div class="sect2" id="idm46394759238480">
<h2>Using AppArmor</h2>
<p><a data-primary="SELinux (Security-Enhanced Linux)" data-type="indexterm" id="idm46394759237104"/><a data-primary="AppArmor" data-type="indexterm" id="aa_ab"/><a href="https://apparmor.net">AppArmor</a> provides access control to programs running on a Linux system. The tool implements an additional security layer between the applications invoked in the user space and the underlying system functionality. For example, we can restrict network calls or filesystem interaction. Many Linux distributions (e.g., Debian, Ubuntu, openSUSE) already ship with AppArmor. Therefore, 
<span class="keep-together">AppArmor</span> doesn’t have to be installed manually. Linux distributions that do not support 
<span class="keep-together">AppArmor</span> use <a href="https://oreil.ly/CKBr7">
<span class="keep-together">Security-Enhanced</span> Linux (SELinux)</a> instead, which takes a similar approach to AppArmor. Understanding SELinux is out of scope for the CKS exam.</p>
<section data-pdf-bookmark="Understanding profiles" data-type="sect3"><div class="sect3" id="idm46394759231616">
<h3>Understanding profiles</h3>
<p><a data-primary="profiles" data-secondary="AppArmor" data-type="indexterm" id="idm46394759230240"/><a data-primary="aa-status command" data-type="indexterm" id="idm46394759229264"/><a data-primary="commands" data-secondary="aa-status" data-type="indexterm" id="idm46394759228592"/>The rules that define what a program can or cannot do are defined in an AppArmor profile. Every profile needs to be loaded into AppArmor before it can take effect. AppArmor provides a command line tool for checking the profiles that have been loaded. Execute the command <code>aa-status</code> to see a summary of all loaded profiles. You will see that AppArmor already comes with a set of default application profiles to protect Linux services:</p>
<pre data-type="programlisting"><strong>$ sudo aa-status</strong>
apparmor module is loaded.
31 profiles are loaded.
31 profiles are in enforce mode.
   /snap/snapd/15177/usr/lib/snapd/snap-confine
   ...
0 profiles are in complain mode.
14 processes have profiles defined.
14 processes are in enforce mode.
   /pause (11934) docker-default
   ...
0 processes are in complain mode.
0 processes are unconfined but have a profile defined.</pre>
<p>The profile mode determines the treatment of rules at runtime should a matching event happen. AppArmor distinguishes two types of profile modes:</p>
<dl>
<dt>Enforce</dt>
<dd>
<p><a data-primary="Enforce profile mode" data-type="indexterm" id="idm46394759224208"/>The system enforces the rules, reports the violation, and writes it to the syslog. You will want to use this mode to prevent a program from making specific calls.</p>
</dd>
<dt>Complain</dt>
<dd>
<p><a data-primary="Complain profile mode" data-type="indexterm" id="idm46394759222224"/>The system does not enforce the rules but will write violations to the log. This mode is helpful if you want to discover the calls a program makes.</p>
</dd>
</dl>
<p><a data-type="xref" href="#apparmor-profile">Example 4-1</a> defines a custom profile in the file <code>k8s-deny-write</code> for restricting file write access. The file should be placed in the directory <code>/etc/apparmor.d</code> of every worker node that executes workload. It is out of scope of this book to explain all the rules in detail. For more information, have a look at the 
<span class="keep-together"><a href="https://oreil.ly/mNuWB">AppArmor wiki</a>.</span></p>
<div data-type="example" id="apparmor-profile">
<h5><span class="label">Example 4-1. </span>An AppArmor profile for restricting file write access</h5>
<pre data-type="programlisting">#include &lt;tunables/global&gt;

profile k8s-deny-write flags=(attach_disconnected) { <a class="co" href="#callout_system_hardening_CO1-1" id="co_system_hardening_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a>
  #include &lt;abstractions/base&gt;

  file, <a class="co" href="#callout_system_hardening_CO1-2" id="co_system_hardening_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a>

  deny /** w, <a class="co" href="#callout_system_hardening_CO1-3" id="co_system_hardening_CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a>
}</pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_system_hardening_CO1-1" id="callout_system_hardening_CO1-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>The identifier after the <code>profile</code> keyword is the name of the profile.</p></dd>
<dt><a class="co" href="#co_system_hardening_CO1-2" id="callout_system_hardening_CO1-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Apply to file operations.</p></dd>
<dt><a class="co" href="#co_system_hardening_CO1-3" id="callout_system_hardening_CO1-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>Deny all file writes.</p></dd>
</dl>
</div></section>
<section data-pdf-bookmark="Setting a custom profile" data-type="sect3"><div class="sect3" id="idm46394759200912">
<h3>Setting a custom profile</h3>
<p><a data-primary="profiles" data-secondary="custom" data-type="indexterm" id="idm46394759199568"/><a data-primary="custom profiles" data-secondary="setting" data-type="indexterm" id="idm46394759198592"/>To load the profile into AppArmor, run the following command on the worker node:</p>
<pre data-type="programlisting"><strong>$ sudo apparmor_parser /etc/apparmor.d/k8s-deny-write</strong></pre>
<p>The command uses the enforce mode by default. To load the profile in complain mode, use the <code>-C</code> option. The <code>aa-status</code> command will now list the profile in addition to the default profiles. As you can see in the output, the profile is listed in enforce mode:</p>
<pre data-type="programlisting"><strong>$ sudo aa-status</strong>
apparmor module is loaded.
32 profiles are loaded.
32 profiles are in enforce mode.
   k8s-deny-write
   ...</pre>
<p>AppArmor supports additional convenience commands as part of a utilities package. You can manually install the package using the following commands if you want to use them:</p>
<pre data-type="programlisting"><strong>$ sudo apt-get update
$ sudo apt-get install apparmor-utils</strong></pre>
<p><a data-primary="aa-enforce command" data-type="indexterm" id="idm46394759192304"/><a data-primary="commands" data-secondary="aa-enforce" data-type="indexterm" id="idm46394759191296"/><a data-primary="aa-complain command" data-type="indexterm" id="idm46394759190352"/><a data-primary="commands" data-secondary="aa-complain" data-type="indexterm" id="idm46394759189680"/>Once installed, you can use the command <code>aa-enforce</code> to load a profile in enforce mode, and <code>aa-complain</code> to load a profile in complain mode. For the exam, it’s likely easier to just go with the standard <code>apparmor_parser</code> command.</p>
</div></section>
<section data-pdf-bookmark="Applying a profile to a container" data-type="sect3"><div class="sect3" id="idm46394759187152">
<h3>Applying a profile to a container</h3>
<p><a data-primary="containers" data-secondary="applying profiles to" data-type="indexterm" id="idm46394759185648"/><a data-primary="profiles" data-secondary="applying to containers" data-type="indexterm" id="idm46394759184672"/>You need to ensure a couple of prerequisites before using AppArmor rules in a Pod definition. First, the container runtime needs to support AppArmor to let rules take effect. In addition, AppArmor needs to be installed on the worker node that runs the Pod. Last, make sure you loaded the profile, as described in the previous section.</p>
<p><a data-type="xref" href="#apparmor-pod">Example 4-2</a> shows a YAML manifest for a Pod defined in the file <code>pod.yaml</code>. To apply a profile to the container, you will need to set a specific annotation. The annotation key needs to use the key in the format <code>container.apparmor.security.beta.​kuber⁠netes.io/&lt;container-name&gt;</code>. In our case, the container name is <code>hello</code>. The full key is <code>container.apparmor.security.beta.kubernetes.io/hello</code>. The value of the annotation follows the pattern <code>localhost/&lt;profile-name&gt;</code>. The custom profile we want to use here is <code>k8s-deny-write</code>. For more information on the configuration options, see the <a href="https://oreil.ly/1o3zO">Kubernetes 
<span class="keep-together">documentation</span></a>.</p>
<div data-type="example" id="apparmor-pod">
<h5><span class="label">Example 4-2. </span>A Pod applying an AppArmor profile to a container</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">hello-apparmor</code><code class="w">
</code><code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">container.apparmor.security.beta.kubernetes.io/hello</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">\</code><code class="w"> </code><a class="co" href="#callout_system_hardening_CO2-1" id="co_system_hardening_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="l-Scalar-Plain">localhost/k8s-deny-write</code><code class="w"> </code><a class="co" href="#callout_system_hardening_CO2-2" id="co_system_hardening_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">hello</code><code class="w"> </code><a class="co" href="#callout_system_hardening_CO2-3" id="co_system_hardening_CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
</code><code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">busybox:1.28</code><code class="w">
</code><code class="w">    </code><code class="nt">command</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="s">"</code><code class="s">sh</code><code class="s">"</code><code class="p-Indicator">,</code><code class="w"> </code><code class="s">"</code><code class="s">-c</code><code class="s">"</code><code class="p-Indicator">,</code><code class="w"> </code><code class="s">"</code><code class="s">echo</code><code class="nv"> </code><code class="s">'Hello</code><code class="nv"> </code><code class="s">AppArmor!'</code><code class="nv"> </code><code class="s">&amp;&amp;</code><code class="nv"> </code><code class="s">sleep</code><code class="nv"> </code><code class="s">1h</code><code class="s">"</code><code class="p-Indicator">]</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_system_hardening_CO2-1" id="callout_system_hardening_CO2-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>The annotation key that consists of a hard-coded prefix and the container name separated by a slash character.</p></dd>
<dt><a class="co" href="#co_system_hardening_CO2-2" id="callout_system_hardening_CO2-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>The profile name available on the current node indicated by <code>localhost</code>.</p></dd>
<dt><a class="co" href="#co_system_hardening_CO2-3" id="callout_system_hardening_CO2-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>The container name.</p></dd>
</dl>
<p>We are ready to create the Pod. Run the <code>apply</code> command and point it to the YAML manifest. Wait until the Pod transitions into the “Running” status:</p>
<pre data-type="programlisting"><strong>$ kubectl apply -f pod.yaml</strong>
pod/hello-apparmor created
<strong>$ kubectl get pod hello-apparmor</strong>
NAME             READY   STATUS    RESTARTS   AGE
hello-apparmor   1/1     Running   0          4s</pre>
<p>You can now shell into the container and perform a file write operation:</p>
<pre data-type="programlisting"><strong>$ kubectl exec -it hello-apparmor -- /bin/sh</strong>
/ # touch test.txt
touch: test.txt: Permission denied</pre>
<p><a data-primary="" data-startref="aa_ab" data-type="indexterm" id="idm46394759033872"/>AppArmor will prevent writing a file to the container’s filesystem. The message “Permission denied” will be rendered if you try to perform the operation.</p>
</div></section>
</div></section>
<section data-pdf-bookmark="Using seccomp" data-type="sect2"><div class="sect2" id="idm46394759032640">
<h2>Using seccomp</h2>
<p><a data-primary="documentation" data-secondary="Kubernetes" data-type="indexterm" id="idm46394759031328"/><a data-primary="seccomp" data-type="indexterm" id="se_ab"/>Seccomp, short for “Secure Computing Mode,” is another Linux kernel feature that can restrict the calls made from the userspace into the kernel. A seccomp profile is the mechanism for defining the rules for restricting syscalls and their arguments. Using seccomp can reduce the risk of exploiting a Linux kernel vulnerability. For more information on seccomp on Kubernetes, see the 
<span class="keep-together"><a href="https://oreil.ly/B8I5L">documentation</a>.</span></p>
<section data-pdf-bookmark="Applying the default container runtime profile to a container" data-type="sect3"><div class="sect3" id="idm46394759028064">
<h3>Applying the default container runtime profile to a container</h3>
<p><a data-primary="containerd" data-type="indexterm" id="idm46394759026560"/><a data-primary="Docker Engine" data-type="indexterm" id="idm46394759025856"/><a data-primary="default container runtime profile, applying to containers" data-type="indexterm" id="idm46394759025184"/>Container runtimes, such as Docker Engine or containerd, ship with a default seccomp profile. The default seccomp profile allows the most commonly used syscalls used by applications while at the same time forbidding the use of syscalls considered dangerous.</p>
<p><a data-primary="feature gate" data-type="indexterm" id="idm46394759024160"/>Kubernetes does not apply the default container runtime profile to containers when creating a Pod, but you can enable it using the <code>SeccompDefault</code> <a href="https://oreil.ly/m9g0G">feature gate</a>. Alternatively, you can opt into the feature on a Pod-by-Pod basis by setting the seccomp profile type to <code>RuntimeDefault</code> with the help of the security context attribute <code>seccompProfile</code>. <a data-type="xref" href="#seccomp-default-profile-pod">Example 4-3</a> demonstrates its use.</p>
<div data-type="example" id="seccomp-default-profile-pod">
<h5><span class="label">Example 4-3. </span>A Pod applying the default seccomp profile provided by the container runtime profile</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">hello-seccomp</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">securityContext</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">seccompProfile</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">RuntimeDefault</code><code class="w"> </code><a class="co" href="#callout_system_hardening_CO3-1" id="co_system_hardening_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">hello</code><code class="w">
</code><code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">busybox:1.28</code><code class="w">
</code><code class="w">    </code><code class="nt">command</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="s">"</code><code class="s">sh</code><code class="s">"</code><code class="p-Indicator">,</code><code class="w"> </code><code class="s">"</code><code class="s">-c</code><code class="s">"</code><code class="p-Indicator">,</code><code class="w"> </code><code class="s">"</code><code class="s">echo</code><code class="nv"> </code><code class="s">'Hello</code><code class="nv"> </code><code class="s">seccomp!'</code><code class="nv"> </code><code class="s">&amp;&amp;</code><code class="nv"> </code><code class="s">sleep</code><code class="nv"> </code><code class="s">1h</code><code class="s">"</code><code class="p-Indicator">]</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_system_hardening_CO3-1" id="callout_system_hardening_CO3-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Applies the default container runtime profile.</p></dd>
</dl>
<p><a data-primary="apply command" data-type="indexterm" id="idm46394758942608"/><a data-primary="commands" data-secondary="apply" data-type="indexterm" id="idm46394758941904"/>You can start the Pod using the <code>apply</code> command and point to the YAML manifest. The Pod should transition into the “Running” status:</p>
<pre data-type="programlisting"><strong>$ kubectl apply -f pod.yaml</strong>
pod/hello-seccomp created
<strong>$ kubectl get pod hello-seccomp</strong>
NAME            READY   STATUS    RESTARTS   AGE
hello-seccomp   1/1     Running   0          4s</pre>
<p><a data-primary="echo command" data-type="indexterm" id="idm46394758938464"/><a data-primary="commands" data-secondary="echo" data-type="indexterm" id="idm46394758937760"/>The <code>echo</code> command executed in the container is considered unproblematic from a security perspective by the default seccomp profile. The following command inspects the logs of the container:</p>
<pre data-type="programlisting"><strong>$ kubectl logs hello-seccomp</strong>
Hello seccomp!</pre>
<p>The call was permitted and resulted in writing the message “Hello seccomp!” to standard output.</p>
</div></section>
<section data-pdf-bookmark="Setting a custom profile" data-type="sect3"><div class="sect3" id="idm46394759027440">
<h3>Setting a custom profile</h3>
<p><a data-primary="profiles" data-secondary="custom" data-type="indexterm" id="idm46394758890656"/><a data-primary="custom profiles" data-secondary="setting" data-type="indexterm" id="idm46394758889680"/>You can create and set your own custom profile in addition to the default container runtime profile. The standard directory for those files is <code>/var/lib/kubelet/seccomp</code>. We’ll organize our custom profiles in the subdirectory <code>profiles</code>. Create the directory if it doesn’t exist yet:</p>
<pre data-type="programlisting"><strong>$ sudo mkdir -p /var/lib/kubelet/seccomp/profiles</strong></pre>
<p>We decide to create our custom profile in the file <code>mkdir-violation.json</code> in the profile directory. <a data-type="xref" href="#seccomp-mkdir-violation-profile">Example 4-4</a> shows the details of the profile definition. In a nutshell, the rule set disallows the use of the <code>mkdir</code> syscall.</p>
<div data-type="example" id="seccomp-mkdir-violation-profile">
<h5><span class="label">Example 4-4. </span>A seccomp profile that prevents executing a <code>mkdir</code> syscall</h5>
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w">
    </code><code class="nt">"defaultAction"</code><code class="p">:</code><code class="w"> </code><code class="s2">"SCMP_ACT_ALLOW"</code><code class="p">,</code><code class="w"> </code><a class="co" href="#callout_system_hardening_CO4-1" id="co_system_hardening_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
    </code><code class="nt">"architectures"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"> </code><a class="co" href="#callout_system_hardening_CO4-2" id="co_system_hardening_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
        </code><code class="s2">"SCMP_ARCH_X86_64"</code><code class="p">,</code><code class="w">
        </code><code class="s2">"SCMP_ARCH_X86"</code><code class="p">,</code><code class="w">
        </code><code class="s2">"SCMP_ARCH_X32"</code><code class="w">
    </code><code class="p">],</code><code class="w">
    </code><code class="nt">"syscalls"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w">
        </code><code class="p">{</code><code class="w">
            </code><code class="nt">"names"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w">
                </code><code class="s2">"mkdir"</code><code class="w">
            </code><code class="p">],</code><code class="w">
            </code><code class="nt">"action"</code><code class="p">:</code><code class="w"> </code><code class="s2">"SCMP_ACT_ERRNO"</code><code class="w"> </code><a class="co" href="#callout_system_hardening_CO4-3" id="co_system_hardening_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a><code class="w">
        </code><code class="p">}</code><code class="w">
    </code><code class="p">]</code><code class="w">
</code><code class="p">}</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_system_hardening_CO4-1" id="callout_system_hardening_CO4-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>The default action applies to all system calls. Here we’ll allow all syscalls using <code>SCMP_ACT_ALLOW</code>.</p></dd>
<dt><a class="co" href="#co_system_hardening_CO4-2" id="callout_system_hardening_CO4-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>You can filter for specific architectures the default action should apply to. The definition of the field is optional.</p></dd>
<dt><a class="co" href="#co_system_hardening_CO4-3" id="callout_system_hardening_CO4-3"><img alt="3" height="12" src="assets/3.png" width="12"/></a></dt>
<dd><p>The default action can be overwritten by declaring more fine-grained rules. The <code>SCMP_ACT_ERRNO</code> action will prevent the execution of the <code>mkdir</code> syscall.</p></dd>
</dl>
<p>Placing a custom profile into the directory <code>/var/lib/kubelet/seccomp</code> doesn’t automatically apply the rules to a Pod. You still need to configure a Pod to use it.</p>
</div></section>
<section data-pdf-bookmark="Applying the custom profile to a container" data-type="sect3"><div class="sect3" id="idm46394758891632">
<h3>Applying the custom profile to a container</h3>
<p><a data-primary="containers" data-secondary="applying custom profiles to" data-type="indexterm" id="idm46394756393776"/><a data-primary="custom profiles" data-secondary="applying to containers" data-type="indexterm" id="idm46394754189312"/><a data-primary="profiles" data-secondary="custom" data-type="indexterm" id="idm46394755778816"/>Applying a custom profile follows a similar pattern to applying the default container runtime profile, with minor differences. As you can see in <a data-type="xref" href="#seccomp-custom-profile-pod">Example 4-5</a>, we point the <code>seccompProfile</code> attribute of the security profile to the file <code>mkdir-violation.json</code> and set the type to <code>Localhost</code>.</p>
<div data-type="example" id="seccomp-custom-profile-pod">
<h5><span class="label">Example 4-5. </span>A Pod applying a custom seccomp profile prevents a <code>mkdir</code> syscall</h5>
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w">
</code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w">
</code><code class="nt">metadata</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">hello-seccomp</code><code class="w">
</code><code class="nt">spec</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="nt">securityContext</code><code class="p">:</code><code class="w">
</code><code class="w">    </code><code class="nt">seccompProfile</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">type</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Localhost</code><code class="w"> </code><a class="co" href="#callout_system_hardening_CO5-1" id="co_system_hardening_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a><code class="w">
</code><code class="w">      </code><code class="nt">localhostProfile</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">profiles/mkdir-violation.json</code><code class="w"> </code><a class="co" href="#callout_system_hardening_CO5-2" id="co_system_hardening_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a><code class="w">
</code><code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w">
</code><code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">hello</code><code class="w">
</code><code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">busybox:1.28</code><code class="w">
</code><code class="w">    </code><code class="nt">command</code><code class="p">:</code><code class="w"> </code><code class="p-Indicator">[</code><code class="s">"</code><code class="s">sh</code><code class="s">"</code><code class="p-Indicator">,</code><code class="w"> </code><code class="s">"</code><code class="s">-c</code><code class="s">"</code><code class="p-Indicator">,</code><code class="w"> </code><code class="s">"</code><code class="s">echo</code><code class="nv"> </code><code class="s">'Hello</code><code class="nv"> </code><code class="s">seccomp!'</code><code class="nv"> </code><code class="s">&amp;&amp;</code><code class="nv"> </code><code class="s">sleep</code><code class="nv"> </code><code class="s">1h</code><code class="s">"</code><code class="p-Indicator">]</code><code class="w">
</code><code class="w">    </code><code class="nt">securityContext</code><code class="p">:</code><code class="w">
</code><code class="w">      </code><code class="nt">allowPrivilegeEscalation</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">false</code></pre></div>
<dl class="calloutlist">
<dt><a class="co" href="#co_system_hardening_CO5-1" id="callout_system_hardening_CO5-1"><img alt="1" height="12" src="assets/1.png" width="12"/></a></dt>
<dd><p>Refers to a profile on the current node.</p></dd>
<dt><a class="co" href="#co_system_hardening_CO5-2" id="callout_system_hardening_CO5-2"><img alt="2" height="12" src="assets/2.png" width="12"/></a></dt>
<dd><p>Applies the profile with the name <code>mkdir-violation.json</code> in the subdirectory <code>profiles</code>.</p></dd>
</dl>
<p>Create the Pod using the declarative <code>apply</code> command. Wait until the Pod transitions into the “Running” status:</p>
<pre data-type="programlisting"><strong>$ kubectl apply -f pod.yaml</strong>
pod/hello-seccomp created
<strong>$ kubectl get pod hello-seccomp</strong>
NAME            READY   STATUS    RESTARTS   AGE
hello-seccomp   1/1     Running   0          4s</pre>
<p class="pagebreak-before">Shell into the container to verify that seccomp properly enforced the applied rules:</p>
<pre data-type="programlisting"><strong>$ kubectl exec -it hello-seccomp -- /bin/sh</strong>
/ # mkdir test
mkdir: can't create directory <em>test</em>: Operation not permitted</pre>
<p><a data-primary="commands" data-secondary="mkdir" data-type="indexterm" id="idm46394753550432"/><a data-primary="mkdir command" data-type="indexterm" id="idm46394753498736"/><a data-primary="" data-startref="kht_ab" data-type="indexterm" id="idm46394753498128"/><a data-primary="" data-startref="sh_kht" data-type="indexterm" id="idm46394753497280"/><a data-primary="" data-startref="t_kht" data-type="indexterm" id="idm46394753496432"/><a data-primary="" data-startref="se_ab" data-type="indexterm" id="idm46394753495584"/>As you can see in output, the operation renders an error message when trying to execute the <code>mkdir</code> command. The rule in the custom profile has been violated.</p>
</div></section>
</div></section>
</div></section>
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm46394753493856">
<h1>Summary</h1>
<p>Addressing security aspects isn’t limited to Kubernetes cluster components or workload. There’s plenty you can do on the host system level. We discussed different OS capabilities and how to use them to minimize potential security vulnerabilities.</p>
<p>Many operating systems come with a wealth of packages and services to offer a more feature-rich experience to end users. It’s important to identify functionality not required to operate a Kubernetes cluster. Purge unnecessary packages and services rigorously and close ports you don’t need. You will also want to limited which users are allowed to have access to specific directories, files, and applications. Use Linux’s user management to restrict permissions.</p>
<p>It’s very common for applications and processes running in containers to make system calls. You can use Linux kernel hardening tools like AppArmor and seccomp to restrict those calls. Only allow system calls crucial to fulfill the needs of your application running the container.</p>
</div></section>
<section data-pdf-bookmark="Exam Essentials" data-type="sect1"><div class="sect1" id="idm46394753491696">
<h1>Exam Essentials</h1>
<dl>
<dt>Have a basic understanding of Linux OS tooling.</dt>
<dd>
<p>The CKS exam primarily focuses on security functionality in Kubernetes. This domain crosses the boundary to Linux OS security features. It won’t hurt to explore Linux-specific tools and security aspects independent from the content covered in this chapter. On a high level, familiarize yourself with service, package, user, and network management on Linux.</p>
</dd>
<dt>Know how to integrate Linux kernel hardening tools with Kubernetes.</dt>
<dd>
<p>AppArmor and seccomp are just some kernel hardening tools that can be integrated with Kubernetes to restrict system calls made from a container. Practice the process of loading a profile and applying it to a container. In order to expand your horizons, you may also want to explore other kernel functionality that works alongside Kubernetes, such as <a href="https://oreil.ly/DrGbB">SELinux</a> or <a href="https://oreil.ly/GyUoc">sysctl</a>.</p>
</dd>
</dl>
</div></section>
<section data-pdf-bookmark="Sample Exercises" data-type="sect1"><div class="sect1" id="idm46394753486752">
<h1>Sample Exercises</h1>
<p><a data-primary="" data-startref="sh_ch" data-type="indexterm" id="idm46394753485744"/><a data-primary="sample exercises" data-secondary="system hardening" data-type="indexterm" id="idm46394753484896"/><a data-primary="system hardening" data-secondary="sample exercises" data-type="indexterm" id="idm46394753484048"/>Solutions to these exercises are available in the <a data-type="xref" href="app01.xhtml#appendix-a">Appendix</a>.</p>
<ol>
<li>
<p>Navigate to the directory <em>app-a/ch04/close-ports</em> of the checked-out GitHub repository <a href="https://oreil.ly/sImXZ"><em>bmuschko/cks-study-guide</em></a>. Start up the VMs running the cluster using the command <code>vagrant up</code>. The cluster consists of a single control plane node named <code>kube-control-plane</code> and one worker node named <code>kube-worker-1</code>. Once done, shut down the cluster using <code>vagrant destroy -f</code>.</p>
<p>Identify the process listening on port 21 in the VM <code>kube-worker-1</code>. You decided not to expose this port to reduce the risk of attackers exploiting the port. Close the port by shutting down the corresponding process.</p>
<p><em>Prerequisite:</em> This exercise requires the installation of the tools <a href="https://oreil.ly/FiyeH">Vagrant</a> and <a href="https://oreil.ly/WW8IK">
<span class="keep-together">VirtualBox</span></a>.</p>
</li>
<li>
<p>Navigate to the directory <em>app-a/ch04/apparmor</em> of the checked-out GitHub repository <a href="https://oreil.ly/sImXZ"><em>bmuschko/cks-study-guide</em></a>. Start up the VMs running the cluster using the command <code>vagrant up</code>. The cluster consists of a single control plane node named <code>kube-control-plane</code>, and one worker node named <code>kube-worker-1</code>. Once done, shut down the cluster using <code>vagrant destroy -f</code>.</p>
<p>Create  an  AppArmor  profile  named  <code>network-deny</code>.  The  profile  should  prevent  any  incoming  and  outgoing  network  traffic.  Add  the  profile  to  the  set  of  AppArmor  rules  in  enforce  mode.  Apply  the  profile  to  the  Pod  named <code>network-call</code> running in the <code>default</code> namespace. Check the logs of the Pod to ensure that network calls cannot be made anymore.</p>
<p><em>Prerequisite:</em> This exercise requires the installation of the tools <a href="https://oreil.ly/FiyeH">Vagrant</a> and <a href="https://oreil.ly/WW8IK">
<span class="keep-together">VirtualBox</span></a>.</p>
</li>
<li>
<p>Navigate to the directory <em>app-a/ch04/seccomp</em> of the checked-out GitHub repository <a href="https://oreil.ly/sImXZ"><em>bmuschko/cks-study-guide</em></a>. Start up the VMs running the cluster using the command <code>vagrant up</code>. The cluster consists of a single control plane node named <code>kube-control-plane</code>, and one worker node named <code>kube-worker-1</code>. Once done, shut down the cluster using <code>vagrant destroy -f</code>.</p>
<p>Create a seccomp profile file named <code>audit.json</code> that logs all syscalls in the standard seccomp directory. Apply the profile to the Pod named <code>network-call</code> running in the <code>default</code> namespace. Check the log file <code>/var/log/syslog</code> for log entries.</p>
<p><em>Prerequisite:</em> This exercise requires the installation of the tools <a href="https://oreil.ly/FiyeH">Vagrant</a> and <a href="https://oreil.ly/WW8IK">
<span class="keep-together">VirtualBox</span></a>.</p>
</li>
<li>
<p>Create a new Pod named <code>sysctl-pod</code> with the image <code>nginx:1.23.1</code>. Set the sysctl parameters <code>net.core.somaxconn</code> to 1024 and <code>debug.iotrace</code> to <code>1</code>. Check on the status of the Pod.</p>
</li>
</ol>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm46394753457008">
<h1>Interactive Exam Practice</h1>
<p>Get more hands-on training and test your CKS exam readiness by working through our interactive CKS labs. Each step of the lab must be completed correctly before you can move to the next step. If you get stuck, you can view the solution and learn how to complete the step.</p>
<p>The following labs cover material from this chapter:</p>
<ul>
<li>
<p><a href="https://learning.oreilly.com/scenarios/shutting-down-an/9781098149796/">Shutting Down an Unnecessary Process</a></p>
</li>
<li>
<p><a href="https://learning.oreilly.com/scenarios/identifying-and-disabling/9781098149802/">Identifying and Disabling Open Ports</a></p>
</li>
<li>
<p><a href="https://learning.oreilly.com/scenarios/using-apparmor-to/9781098149819/">Using AppArmor to Prevent Any Incoming and Outgoing Network Traffic</a></p>
</li>
<li>
<p><a href="https://learning.oreilly.com/scenarios/logging-syscalls-with/9781098149826/">Logging syscalls with seccomp</a></p>
</li>
<li>
<p><a href="https://learning.oreilly.com/scenarios/evaluating-the-use/9781098149833/">Evaluating the Use of sysctl Commands</a></p>
</li>
</ul>
</div></aside>
</div></section>
</div></section></div></body></html>