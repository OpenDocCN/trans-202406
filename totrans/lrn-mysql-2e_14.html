<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. MySQL in the Cloud"><div class="chapter" id="CH14_MYSQL_CLOUD">
<h1><span class="label">Chapter 14. </span>MySQL in the Cloud</h1>


<p>“No need to worry, it’s in the cloud” is a phrase we often hear. It reminds<a data-type="indexterm" data-primary="cloud databases" data-secondary="about" id="idm46177446890968"/> us of a story about a woman who was worried that, after her iPhone drowned in the toilet, she’d lost all her years’ worth of family and travel photos. To her surprise, when she bought a new phone, the device “recovered” all the photos. She was using the iCloud backup solution from Apple to back up her device content to the cloud. (The other surprise may have been the service subscription bill she hadn’t realized she was paying.)</p>

<p>As computer engineers, we don’t have the luxury of taking risks with regard to whether our data will be recovered or not. Cloud storage is a scalable and reliable solution. In this chapter, we will look at a few options that companies have for using MySQL in the cloud. These range from database-as-a-service (DBaaS) options that are easily scalable and provide automatic backup and high availability features to more traditional choices like EC2 instances, which provide more fine-grained control. In general, startup companies, where the core business is not technology, prefer to use DBaaS options since they are easier to implement and work with. On the other hand, companies that need more strict control over their data might prefer to use an EC2 instance or their own cloud infrastructure.</p>






<section data-type="sect1" data-pdf-bookmark="Database-as-a-Service (DBaaS)"><div class="sect1" id="idm46177446868216">
<h1>Database-as-a-Service (DBaaS)</h1>

<p>DBaaS is an outsourcing option where companies pay a cloud<a data-type="indexterm" data-primary="DBaaS (database-as-a-service)" data-secondary="about" id="idm46177446866840"/><a data-type="indexterm" data-primary="database-as-a-service" data-see="DBaaS" id="idm46177446865992"/><a data-type="indexterm" data-primary="cloud databases" data-secondary="DBaaS (database-as-a-service)" data-tertiary="about" id="idm46177446865144"/> provider to launch and maintain a cloud database for them. Payment is usually per-usage, and the data owners can access their application data as they please. A DBaaS provides the same functionalities as a standard relational or non-relational database. It’s often a good solution for companies trying to avoid configuring, maintaining, and upgrading their databases and servers (although this is not always true). DBaaS lives in the realm of software-as-a-service (SaaS), like platform-as-a-service (PaaS) and infrastructure-as-a-service (IaaS), where products like databases become services.</p>








<section data-type="sect2" data-pdf-bookmark="Amazon RDS for MySQL/MariaDB"><div class="sect2" id="idm46177446863192">
<h2>Amazon RDS for MySQL/MariaDB</h2>

<p>The most popular DBaaS is Amazon RDS for MySQL. Getting<a data-type="indexterm" data-primary="DBaaS (database-as-a-service)" data-secondary="Amazon RDS for MySQL/MariaDB" id="ch14-amz"/><a data-type="indexterm" data-primary="cloud databases" data-secondary="DBaaS (database-as-a-service)" data-tertiary="Amazon RDS for MySQL/MariaDB" id="ch14-amz2"/><a data-type="indexterm" data-primary="MariaDB" data-secondary="Amazon RDS for MySQL/MariaDB" id="ch14-amz3"/> started with RDS is almost like configuring a new car on a website. You choose the main product and add the options you want until it looks the way you like and then launch. <a data-type="xref" href="#FIG-RDS-PRODUCT">Figure 14-1</a> shows the products available. In this case, we will go for MySQL (the MariaDB version has similar settings for deployment).</p>

<figure><div id="FIG-RDS-PRODUCT" class="figure">
<img src="Images/lm2e_1401.png" alt="lm2e 1401" width="1497" height="1297"/>
<h6><span class="label">Figure 14-1. </span>Choosing the product</h6>
</div></figure>

<p class="pagebreak-before">We can also choose the version—here, we’ve selected 8.0.21. Next, we need to set the master user (similar to <code>root</code>) and its password. Make sure to pick a strong password, especially if you will expose your database to the world. <a data-type="xref" href="#FIG-RDS-ROOT">Figure 14-2</a> shows how to define the username and the password for the master user.</p>

<figure><div id="FIG-RDS-ROOT" class="figure">
<img src="Images/lm2e_1402.png" alt="lm2e 1402" width="1503" height="1209"/>
<h6><span class="label">Figure 14-2. </span>Configuring the master user’s username and password</h6>
</div></figure>

<p class="pagebreak-before">Next is the instance size, which will impact directly on the final price. We will pick a top-level configuration to give you an idea of how costly using a DBaaS can be. <a data-type="xref" href="#FIG-RDS-INSTACE-SIZE">Figure 14-3</a> shows the instance classes that are available; there are several options, with varying costs.</p>

<figure><div id="FIG-RDS-INSTACE-SIZE" class="figure">
<img src="Images/lm2e_1403.png" alt="lm2e 1403" width="1452" height="724"/>
<h6><span class="label">Figure 14-3. </span>Choosing an instance class</h6>
</div></figure>

<p>Another option that can directly affect the billing is the storage options. Naturally, higher performance (more IOPS) and more storage lead to a higher cost. <a data-type="xref" href="#FIG-RDS-STORAGE">Figure 14-4</a> illustrates the choices. You can also select whether to enable autoscaling.</p>

<p>The next option is an important choice: do you want to use multi-AZ deployment or not? <a data-type="indexterm" data-primary="Availability Zones (AZs)" id="idm46177446845224"/><a data-type="indexterm" data-primary="synchronous replication" data-secondary="Availability Zones" id="idm46177446844456"/><a data-type="indexterm" data-primary="high availability" data-secondary="synchronous replication" data-tertiary="Availability Zones" id="idm46177446843512"/>The multi-AZ option is all about high availability. When you provision a multi-AZ DB instance, Amazon RDS automatically creates a primary DB instance and synchronously replicates the data to a standby instance in a different Availability Zone (AZ). The AZs are physically distinct and have independent infrastructure, which increases overall availability.</p>

<p>If you don’t want to use multi-AZ deployment, RDS will install a single instance. In the event of failure, it will spin up a new one and remount its data volume. This process takes some time, during which your database will not be available. Even big cloud providers are not bulletproof, and disasters can happen, so having a standby server is always recommended. <a data-type="xref" href="#FIG-RDS-AZ">Figure 14-5</a> shows how to configure the replica.</p>

<figure><div id="FIG-RDS-STORAGE" class="figure">
<img src="Images/lm2e_1404.png" alt="lm2e 1404" width="1479" height="1320"/>
<h6><span class="label">Figure 14-4. </span>Configuring storage size and its IOPS performance</h6>
</div></figure>

<figure><div id="FIG-RDS-AZ" class="figure">
<img src="Images/lm2e_1405.png" alt="lm2e 1405" width="1506" height="413"/>
<h6><span class="label">Figure 14-5. </span>Configuring a standby replica</h6>
</div></figure>

<p class="pagebreak-before">The next part is setting up a general networking configuration. We recommend configuring RDS to use a private network, which only the application servers and developers’ IPs can access. <a data-type="xref" href="#FIG-RDS-NETWORK">Figure 14-6</a> shows the network options.</p>

<figure class="width-90"><div id="FIG-RDS-NETWORK" class="figure">
<img src="Images/lm2e_1406.png" alt="lm2e 1406" width="1510" height="1627"/>
<h6><span class="label">Figure 14-6. </span>Configuring the network settings</h6>
</div></figure>

<p>Finally, alas, come the estimated costs. <a data-type="xref" href="#FIG-RDS-COSTS">Figure 14-7</a> shows how much you will pay per month for your configured choices.<a data-type="indexterm" data-startref="ch14-amz" id="idm46177446830840"/><a data-type="indexterm" data-startref="ch14-amz2" id="idm46177446830168"/><a data-type="indexterm" data-startref="ch14-amz3" id="idm46177446829496"/></p>

<figure class="width-90"><div id="FIG-RDS-COSTS" class="figure">
<img src="Images/lm2e_1407.png" alt="lm2e 1407" width="1516" height="581"/>
<h6><span class="label">Figure 14-7. </span>The bill can reach the stars under certain configurations!</h6>
</div></figure>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Google Cloud SQL for MySQL"><div class="sect2" id="idm46177446862600">
<h2>Google Cloud SQL for MySQL</h2>

<p>Google Cloud SQL offers managed database services<a data-type="indexterm" data-primary="cloud databases" data-secondary="DBaaS (database-as-a-service)" data-tertiary="Google Cloud for MySQL" id="ch14-goo"/><a data-type="indexterm" data-primary="DBaaS (database-as-a-service)" data-secondary="Google Cloud for MySQL" id="ch14-goo2"/><a data-type="indexterm" data-primary="Google Cloud for MySQL" id="ch14-goo3"/> comparable to Amazon RDS (and Azure), but with slight differences. The Google Cloud options for MySQL are more straightforward because there are fewer options to choose from. For example, you cannot choose between MySQL and MariaDB, or choose the MySQL minor version (only the major version). As shown in Figure 14-8, you can get started by either creating a new instance or migrating an existing database to Google Cloud.</p>

<figure><div id="FIG-GOOGLE-INTRO" class="figure">
<img src="Images/lm2e_1408.png" alt="lm2e 1408" width="2434" height="1128"/>
<h6><span class="label">Figure 14-8. </span>Google Cloud SQL</h6>
</div></figure>

<p class="pagebreak-before">When creating a new instance, you have to fill in a few options. The first step is to choose the product. <a data-type="xref" href="#FIG-GOOGLE-PRODUCT">Figure 14-9</a> show the options available for MySQL.</p>

<figure><div id="FIG-GOOGLE-PRODUCT" class="figure">
<img src="Images/lm2e_1409.png" alt="lm2e 1409" width="1082" height="778"/>
<h6><span class="label">Figure 14-9. </span>Choosing the product</h6>
</div></figure>

<p>After picking MySQL, you’ll need to specify the instance name, <code>root</code> password, database version, and location. <a data-type="xref" href="#FIG-GOOGLE-SQL-OPTION1">Figure 14-10</a> shows how to configure these settings.</p>

<figure class="width-90"><div id="FIG-GOOGLE-SQL-OPTION1" class="figure">
<img src="Images/lm2e_1410.png" alt="lm2e 1410" width="1050" height="1110"/>
<h6><span class="label">Figure 14-10. </span>Setting basic configuration</h6>
</div></figure>

<p>Next are the settings that can impact the performance, and of course, the cost—it’s crucial to find the right balance here. <a data-type="xref" href="#FIG-GOOGLE-SQL-OPTION2">Figure 14-11</a> shows the storage, memory, and CPU options available.</p>

<figure class="width-90"><div id="FIG-GOOGLE-SQL-OPTION2" class="figure">
<img src="Images/lm2e_1411.png" alt="lm2e 1411" width="976" height="1479"/>
<h6><span class="label">Figure 14-11. </span>Configuring the machine type and storage</h6>
</div></figure>

<p>Now the instance is ready to launch in the Google Cloud.<a data-type="indexterm" data-startref="ch14-goo" id="idm46177446806872"/><a data-type="indexterm" data-startref="ch14-goo2" id="idm46177446806088"/><a data-type="indexterm" data-startref="ch14-goo3" id="idm46177446805416"/></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Azure SQL"><div class="sect2" id="idm46177446826024">
<h2>Azure SQL</h2>

<p>The last of the top three cloud service providers is Azure SQL. <a data-type="xref" href="#FIG-AZURE-INTRO">Figure 14-12</a> shows the database products available in Azure.<a data-type="indexterm" data-primary="cloud databases" data-secondary="DBaaS (database-as-a-service)" data-tertiary="Azure SQL" id="ch14-az"/><a data-type="indexterm" data-primary="DBaaS (database-as-a-service)" data-secondary="Azure SQL" id="ch14-az2"/><a data-type="indexterm" data-primary="Azure SQL" id="ch14-az3"/> You’ll want to select “Azure Database for MySQL servers.”</p>

<figure><div id="FIG-AZURE-INTRO" class="figure">
<img src="Images/lm2e_1412.png" alt="lm2e 1412" width="1396" height="1032"/>
<h6><span class="label">Figure 14-12. </span>Choosing MySQL in Azure</h6>
</div></figure>

<p class="pagebreak-before">Azure offers two options, to go with a simple server or a more robust solution with high availability in the setup. <a data-type="xref" href="#FIG-AZURE-OPTION">Figure 14-13</a> shows the difference between the two options.</p>

<figure class="width-90"><div id="FIG-AZURE-OPTION" class="figure">
<img src="Images/lm2e_1413.png" alt="lm2e 1413" width="1602" height="916"/>
<h6><span class="label">Figure 14-13. </span>Choosing a single server or a flexible server</h6>
</div></figure>

<p>Those choices are followed by similar configurations regarding the service performance and costs. <a data-type="xref" href="#FIG-AZURE-MYSQLCONFIG">Figure 14-14</a> shows the MySQL managed services options.<a data-type="indexterm" data-startref="ch14-az" id="idm46177446791016"/><a data-type="indexterm" data-startref="ch14-az2" id="idm46177446790536"/><a data-type="indexterm" data-startref="ch14-az3" id="idm46177446789832"/></p>

<figure class="width-90"><div id="FIG-AZURE-MYSQLCONFIG" class="figure">
<img src="Images/lm2e_1414.png" alt="lm2e 1414" width="1474" height="1762"/>
<h6><span class="label">Figure 14-14. </span>Configuring our MySQL managed service instance</h6>
</div></figure>
</div></section>





</div></section>













<section data-type="sect1" class="less_space pagebreak-before" data-pdf-bookmark="Amazon Aurora"><div class="sect1" id="idm46177446786664">
<h1>Amazon Aurora</h1>

<p>Amazon Aurora is a MySQL- and PostgreSQL-compatible<a data-type="indexterm" data-primary="cloud databases" data-secondary="DBaaS (database-as-a-service)" data-tertiary="Amazon Aurora" id="idm46177446784856"/><a data-type="indexterm" data-primary="DBaaS (database-as-a-service)" data-secondary="Amazon Aurora" id="idm46177446783592"/><a data-type="indexterm" data-primary="Amazon Aurora" id="idm46177446782632"/><a data-type="indexterm" data-primary="relational databases" data-secondary="Amazon Aurora" id="idm46177446781960"/> relational database solution provided by Amazon under a commercial license. It offers similar features to MySQL, plus a few extra features developed by Amazon.</p>

<p>Two of these features are worth mentioning. <a data-type="indexterm" data-primary="queries" data-secondary="Amazon Aurora Parallel Query" id="idm46177446780264"/>First is Aurora Parallel Query (PQ), a feature that parallelizes some of the I/O and computation involved in processing data-intensive queries.</p>

<p>Aurora PQ works by doing a full table scan (the storage level performs the parallel reads). When we use a parallel query, the query does not use the InnoDB buffer pool. Instead, it pushes query processing down to the storage layer and parallelizes it.</p>

<p>The advantage is that moving the processing closer to the data reduces network traffic and latency. However, the feature is not a silver bullet and does not work well for all cases—it works best for analytical queries that need to run over large portions of data.</p>

<p>The PQ feature is not available for all AWS instances. For instances that support this feature, their instance class determines the number of parallel queries that can be active at a given time. The following instances are the ones that support the PQ 
<span class="keep-together">feature:</span></p>

<ul>
<li>
<p><code>db.r*.large</code>: 1 concurrent parallel query session</p>
</li>
<li>
<p><code>db.r*.xlarge</code>: 2 concurrent parallel query sessions</p>
</li>
<li>
<p><code>db.r*.2xlarge</code>: 4 concurrent parallel query sessions</p>
</li>
<li>
<p><code>db.r*.4xlarge</code>: 8 concurrent parallel query sessions</p>
</li>
<li>
<p><code>db.r*.8xlarge</code>: 16 concurrent parallel query sessions</p>
</li>
<li>
<p><code>db.r4.16xlarge</code>: 16 concurrent parallel query sessions</p>
</li>
</ul>

<p>The other notable feature is the Amazon Aurora Global Database, designed for applications with a global footprint. It allows a single Aurora database to span multiple AWS regions, with fast replication to enable low-latency global reads and disaster recovery from region-wide outages. The Aurora Global Database uses storage-based replication using the dedicated Amazon infrastructure across its data centers 
<span class="keep-together">worldwide.</span></p>
</div></section>













<section data-type="sect1" class="less_space pagebreak-before" data-pdf-bookmark="MySQL Cloud Instances"><div class="sect1" id="idm46177446767096">
<h1>MySQL Cloud Instances</h1>

<p>A <em>cloud instance</em> is nothing but a virtual server. The different<a data-type="indexterm" data-primary="cloud databases" data-secondary="cloud instances" id="idm46177446764840"/><a data-type="indexterm" data-primary="MySQL" data-secondary="cloud instances" data-seealso="cloud databases" id="idm46177446763864"/> cloud providers have different names for these: Amazon Elastic Compute Cloud (EC2) instances, Google Compute Engine instances, and Azure Virtual Machines.</p>

<p>All of them offer different instance types according to the user’s business needs, varying from shallow, basic configurations to astounding limits. For example, the Compute Engine <code>m2-megamem-416</code> machine type is a monster that has 416 CPUs and 5,888 GB of RAM.</p>

<p>The MySQL installation process for these instances is the standard one described in  <a data-type="xref" href="ch01.xhtml#CH1_INSTALL">Chapter 1</a>. In this case, the most significant advantage of using cloud instances compared to DBaaS solutions is the freedom of customizing MySQL and the operating system according to your needs without the limitations that managed databases have.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="MySQL in Kubernetes"><div class="sect1" id="idm46177446759640">
<h1>MySQL in Kubernetes</h1>

<p>The most recent option available to deploy MySQL instances is Kubernetes.<a data-type="indexterm" data-primary="cloud databases" data-secondary="cloud instances" data-tertiary="Kubernetes" id="ch14-kub"/><a data-type="indexterm" data-primary="MySQL" data-secondary="cloud instances" data-tertiary="Kubernetes" id="ch14-kub2"/><a data-type="indexterm" data-primary="Kubernetes" id="ch14-kub3"/><a data-type="indexterm" data-primary="containerizing with Kubernetes" id="ch14-kub4"/><a data-type="indexterm" data-primary="Percona Kubernetes Operator" id="ch14-kub5"/><a data-type="indexterm" data-primary="Percona XtraDB Cluster" data-secondary="Percona Kubernetes Operator" id="ch14-kub6"/> Kubernetes and the OpenShift platform have added a way to manage containerized systems, including database clusters. The management is achieved by controllers declared in configuration files. <a data-type="indexterm" data-primary="pods" id="idm46177446750584"/>These controllers provide automation to create objects, such as a container or a group of containers called a <em>pod</em>, to listen for a specific event and perform a task.</p>

<p>This automation adds complexity to the container-based architecture and stateful applications, such as databases. <a data-type="indexterm" data-primary="operator in Kubernetes" id="idm46177446748824"/>A Kubernetes <em>operator</em> is a particular type of controller introduced to simplify complex deployments. The operator extends the Kubernetes API with custom resources.</p>

<p>There are many good books written on how Kubernetes works. To keep this section as concise as possible, we will discuss the significant components relevant to the Percona Kubernetes Operator. <a data-type="indexterm" data-primary="Kubernetes" data-secondary="documentation online" id="idm46177446746664"/><a data-type="indexterm" data-primary="web links in book" data-secondary="Kubernetes documentation" id="idm46177446745688"/>For a quick introduction to Kubernetes, you can check out the <a href="https://oreil.ly/WdWsD">documentation</a> from the Linux Foundation. <a data-type="xref" href="#FIG-PXB-COMPONENT">Figure 14-15</a> shows the Percona XtraDB Cluster components in Kubernetes.</p>

<figure><div id="FIG-PXB-COMPONENT" class="figure">
<img src="Images/lm2e_1415.png" alt="lm2e 1415" width="1421" height="1109"/>
<h6><span class="label">Figure 14-15. </span>The Percona XtraDB Cluster components in Kubernetes</h6>
</div></figure>

<p>The following section describes how to deploy the Percona Kubernetes Operator for Percona XtraDB Cluster, which is considered production-ready. Other operators are also available. For example:</p>

<ul>
<li>
<p><a href="https://oreil.ly/wOjgy">Oracle</a> provides a Kubernetes Operator for MySQL InnoDB Cluster. At the time of this writing, the operator is in a preview state, so it is not recommended for production.</p>
</li>
<li>
<p><a href="https://oreil.ly/BkCF9">MariaDB</a> has an operator, but at the time of writing it is in the alpha stage, so please check its maturity before using it in production.</p>
</li>
<li>
<p><a href="https://oreil.ly/pgAdN">Presslabs</a> has released an operator that deploys MySQL instances along with orchestrator and backup functionalities. This operator is production-ready.</p>
</li>
</ul>








<section data-type="sect2" class="less_space pagebreak-before" data-pdf-bookmark="Deploying Percona XtraDB Cluster in Kubernetes"><div class="sect2" id="idm46177446734856">
<h2>Deploying Percona XtraDB Cluster in Kubernetes</h2>

<p>This section will walk you through the steps of deploying a<a data-type="indexterm" data-primary="Google Cloud for Kubernetes cluster" id="ch14-clus"/> Kubernetes cluster in the Google Cloud using the Google Cloud SDK and the <a href="https://oreil.ly/olzY9">Percona Kubernetes Operator for PXC</a>:</p>
<ol>
<li>
<p>Install the Google Cloud SDK.</p>
<div class="openblock">
<p>The SDK provides tools and libraries for interacting with Google Cloud products and services. <a href="https://oreil.ly/czdsU">Download the binary appropriate for your platform</a> and install it. Here’s an example for macOS:</p>

<pre data-type="programlisting">$ <strong>wget https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/</strong> \
     <strong>google-cloud-sdk-341.0.0-darwin-x86_64.tar.gz</strong>
$ <strong>tar -xvf google-cloud-sdk-341.0.0-darwin-x86_64.tar.gz</strong>
$ <strong>cd google-cloud-sdk/</strong>
$ <strong>./install.sh</strong></pre>
</div>

</li>
<li>
<p>Install <code>kubectl</code> with <code>gcloud</code>.</p>
<div class="openblock">
<p>With <code>gcloud</code> installed, install the <code>kubectl</code> component using the following 
<span class="keep-together">command:</span></p>

<pre data-type="programlisting">$ <strong>gcloud components install kubectl</strong></pre>
</div>

</li>
<li>
<p>Create the Kubernetes cluster.</p>
<div class="openblock">
<p>To create the Kubernetes cluster, first you need to authenticate in the Google Cloud service:</p>

<pre data-type="programlisting">$ <strong>gcloud auth login</strong></pre>

<p>Once authenticated, create the cluster. The command accepts a lot of parameters, but in this case, we will go with the basics to create a Kubernetes cluster:</p>

<pre data-type="programlisting">$ <strong>gcloud container clusters create --machine-type n1-standard-4</strong> \
    <strong>--num-nodes 3 --zone us-central1-b --project support-211414</strong> \
    <strong>--cluster-version latest vinnie-k8</strong></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The account needs to have the necessary privileges to create the cluster. Also, you need to replace the project and cluster names used here with your own names. You may also be required to edit the zone location, set to <code>us-central1-b</code> in this example.</p>
</div>

<p class="pagebreak-before">The parameters used here are just a small subset of everything available—you can see all the options by running <code>gcloud container clusters --help</code>. For this case, we’ve just requested a cluster with three nodes of <code><em>n1-standard-4</em></code> type instances.</p>

<p>This process may take a while, especially if there are a lot of nodes. The output will look like this:</p>

<pre data-type="programlisting">Creating cluster vinnie-k8 in us-central1-b... Cluster is being
health-checked (master is healthy)...done.
Created [https://container.googleapis.com/v1/projects/support-211414/
zones/us-central1-b/clusters/vinnie-k8].
To inspect the contents of your cluster, go to:
https://console.cloud.google.com/kubernetes/workload_/gcloud/
us-central1-b/vinnie-k8?project=support-211414
kubeconfig entry generated for vinnie-k8.
+-----------+---------------+------------------+---------------+...
| NAME      | LOCATION      | MASTER_VERSION   | MASTER_IP     |...
+-----------+---------------+------------------+---------------+...
| vinnie-k8 | us-central1-b | 1.19.10-gke.1000 | 34.134.67.128 |...
+-----------+---------------+------------------+---------------+...
...+---------------------------------+-----------+---------+
...| MACHINE_TYPE NODE_VERSION       | NUM_NODES | STATUS  |
...+---------------------------------+-----------+---------+
...| n1-standard-4  1.19.10-gke.1000 | 3         | RUNNING |
...+---------------------------------+-----------+---------+</pre>

<p>And we can check the pods of our Kubernetes cluster in the Google Cloud:</p>

<pre data-type="programlisting">$ <strong>kubectl get nodes</strong></pre>

<pre data-type="programlisting">NAME                                       STATUS   ROLES    AGE
VERSION
gke-vinnie-k8-default-pool-376c2051-5xgz   Ready    &lt;none&gt;   62s
v1.19.10-gke.1000
gke-vinnie-k8-default-pool-376c2051-w2tk   Ready    &lt;none&gt;   61s
v1.19.10-gke.1000
gke-vinnie-k8-default-pool-376c2051-wxd7   Ready    &lt;none&gt;   62s
v1.19.10-gke.1000</pre>

<p>It is also possible to use the Google Cloud interface to deploy the cluster, as shown in <a data-type="xref" href="#GCLOUD-INTERFACE">Figure 14-16</a>.</p>

<figure class="width-90"><div id="GCLOUD-INTERFACE" class="figure">
<img src="Images/lm2e_1416.png" alt="lm2e 1416" width="982" height="1514"/>
<h6><span class="label">Figure 14-16. </span>From the main menu, select Kubernetes Engine, then Clusters</h6>
</div></figure>

<p>To create a new cluster, choose the CREATE option shown at the top of <a data-type="xref" href="#GCLOUD-CREATE-K8">Figure 14-17</a>.<br/></p>

<figure><div id="GCLOUD-CREATE-K8" class="figure">
<img src="Images/lm2e_1417.png" alt="lm2e 1417" width="1940" height="846"/>
<h6><span class="label">Figure 14-17. </span>Create the Kubernetes cluster by clicking CREATE</h6>
</div></figure>
</div>

</li>

</ol>

<p>The final step is to install the PXC operator. The <a href="https://oreil.ly/fBJq3">documentation</a> for deploying the operator has very detailed instructions. We’ll follow the recommended steps here.</p>

<p>First, configure Cloud Identity and Access Management (Cloud IAM) to control access to the cluster. The following command will give you the ability to create Roles and RoleBindings:</p>

<pre data-type="programlisting">$ <strong>kubectl create clusterrolebinding cluster-admin-binding --clusterrole</strong> \
    <strong>cluster-admin --user $(gcloud config get-value core/account)</strong></pre>

<p>The return statement confirms the creation:</p>

<pre data-type="programlisting">clusterrolebinding.rbac.authorization.k8s.io/cluster-admin-binding created</pre>

<p>Next, create a namespace and set the context for the namespace:</p>

<pre data-type="programlisting">$ <strong>kubectl create namespace learning-mysql</strong>
$ <strong>kubectl config set-context $(kubectl config current-context)</strong> \
   <strong>--namespace=learning-mysql</strong></pre>

<p>Now, clone the repository and change to the directory:</p>

<pre data-type="programlisting">$ <strong>git clone -b v1.8.0</strong> \
    <strong>https://github.com/percona/percona-xtradb-cluster-operator</strong>
$ <strong>cd percona-xtradb-cluster-operator</strong></pre>

<p>Deploy the operator with the following command:</p>

<pre data-type="programlisting">$ <strong>kubectl apply -f deploy/bundle.yaml</strong></pre>

<p class="pagebreak-before">This should return the following confirmation:</p>

<pre data-type="programlisting">customresourcedefinition.apiextensions.k8s.io/perconaxtradbclusters.pxc.
percona.com created
customresourcedefinition.apiextensions.k8s.io/perconaxtradbclusterbackups.
pxc.percona.com created
customresourcedefinition.apiextensions.k8s.io/perconaxtradbclusterrestores.
pxc.percona.com created
customresourcedefinition.apiextensions.k8s.io/perconaxtradbbackups.pxc.
percona.com created
role.rbac.authorization.k8s.io/percona-xtradb-cluster-operator created
serviceaccount/percona-xtradb-cluster-operator created
rolebinding.rbac.authorization.k8s.io/service-account-percona-xtradb-
cluster-operator created
deployment.apps/percona-xtradb-cluster-operator created</pre>

<p>The operator has been started, and you can confirm this by running:</p>

<pre data-type="programlisting">$ <strong>kubectl get pods</strong></pre>

<p>Now, create the Percona XtraDB Cluster:</p>

<pre data-type="programlisting">$ <strong>kubectl apply -f deploy/cr.yaml</strong></pre>

<p>This step can take some time. After that, you will see all the pods running:</p>

<pre data-type="programlisting">$ <strong>kubectl get pods</strong>
NAME                               READY   STATUS    RESTARTS   AGE
cluster1-haproxy-0                 2/2     Running   0          4m54s
cluster1-haproxy-1                 2/2     Running   0          3m15s
cluster1-haproxy-2                 2/2     Running   0          2m52s
cluster1-pxc-0                     3/3     Running   0          4m54s
cluster1-pxc-1                     3/3     Running   0          3m16s
cluster1-pxc-2                     3/3     Running   0          105s
percona-xtradb-cluster-operator-   1/1     Running   0          7m18s
77bfd8cdc5-d7zll</pre>

<p>During the previous steps, the operator has generated several secrets, including the password for the <code>root</code> user, which you will need to access the cluster. To get the generated secrets, run the following command:</p>

<pre data-type="programlisting">$ <strong>kubectl get secret my-cluster-secrets -o yaml</strong></pre>

<p>You will see output like this:</p>

<pre data-type="programlisting">apiVersion: v1
data:
  clustercheck: UFZjdjk0SU4xWGtBSTR2VlVJ
  monitor: ZWZja01mOWhBTXZ4bTB0bUZ4eQ==
  operator: Vm10R0IxbHA4cVVZTkxqVVI4Mg==
  proxyadmin: VXVFbkx1S3RmUTEzVlNOd1c=
  root: eU53aWlKT3ZXaXJaeG16OXJK
  xtrabackup: V3VNNWRnWUdIblVWaU1OWGY=
...
secrets/my-cluster-secrets
  uid: 9d78c4a8-1926-4b7a-84a0-43087a601066
type: Opaque</pre>

<p>The actual password is base64-encoded, so you’ll need to run the following command to get the <code>root</code> password:</p>

<pre data-type="programlisting">$ <strong>echo 'eU53aWlKT3ZXaXJaeG16OXJK' | base64 --decode</strong>
yNwiiJOvWirZxmz9rJ</pre>

<p>Now that you have the password, to check connectivity with the cluster you can create a client pod:</p>

<pre data-type="programlisting">$ <strong>kubectl run -i --rm --tty percona-client --image=percona:8.0</strong> \
    <strong>--restart=Never -- bash -il</strong></pre>

<p>Then connect to MySQL:</p>

<pre data-type="programlisting">$ <strong>mysql -h cluster1-haproxy -uroot -pyNwiiJOvWirZxmz9rJ</strong></pre>

<p>Note that the operator comes with HAProxy, which is a load balancer (we will discuss load balancing in the next chapter).<a data-type="indexterm" data-startref="ch14-kub" id="idm46177446669176"/><a data-type="indexterm" data-startref="ch14-kub2" id="idm46177446668472"/><a data-type="indexterm" data-startref="ch14-kub3" id="idm46177446667800"/><a data-type="indexterm" data-startref="ch14-kub4" id="idm46177446667128"/><a data-type="indexterm" data-startref="ch14-kub5" id="idm46177446666456"/><a data-type="indexterm" data-startref="ch14-kub6" id="idm46177446665784"/><a data-type="indexterm" data-startref="ch14-clus" id="idm46177446665112"/></p>
</div></section>





</div></section>







</div></section></div></body></html>