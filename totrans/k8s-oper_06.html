<html><head></head><body><section data-pdf-bookmark="Chapter 6. Adapter Operators" data-type="chapter" epub:type="chapter"><div class="chapter" id="adapter_operators">&#13;
<h1><span class="label">Chapter 6. </span>Adapter Operators</h1>&#13;
&#13;
&#13;
<p>Consider the numerous steps it would take to write an Operator from scratch.<a data-primary="Adapter Operators" data-type="indexterm" id="ix_adapOp"/> You would have to create CRDs to specify the interface for end users. Kubernetes controllers would not only need to be written with the Operator’s domain-specific logic, but also be correctly hooked into a running cluster to receive the proper notifications. Roles and service accounts would need to be created to permit the Operator to function in the capacity it needs. An Operator is run as a pod inside of a cluster, so an image would need to be built, along with its accompanying deployment manifest.</p>&#13;
&#13;
<p>Many projects have already invested in application deployment and configuration technologies.<a data-primary="Helm project" data-type="indexterm" id="idm45261333449272"/><a data-primary="Ansible" data-type="indexterm" id="idm45261333448664"/> The Helm project allows users to define their cluster resources in a formatted text file and deploy them through the Helm command-line tools. Ansible is a popular automation engine for creating reusable scripts for provisioning and configuring a group of resources. Both projects have devoted followings of developers who may lack the resources to migrate to using Operators for their applications.</p>&#13;
&#13;
<p>The Operator SDK provides a solution to both these problems through its <em>Adapter Operators</em>. <a data-primary="Operator SDK" data-secondary="Adapter Operators" data-type="indexterm" id="idm45261333446744"/>Through the command-line tool, the SDK generates the code necessary to run technologies such as Helm and Ansible in an Operator. This allows you to rapidly migrate your infrastructure to an Operator model without needing to write the necessary supporting Operator code. The advantages of doing this include:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Provides a consistent interface through CRDs, regardless of whether the underlying technology is Helm, Ansible, or Go.</p>&#13;
</li>&#13;
<li>&#13;
<p>Allows the Helm and Ansible solutions to leverage the Operator deployment and lifecycle benefits that Operator Lifecycle Manager provides (see <a data-type="xref" href="ch08.html#operator_lifecyle_manager">Chapter 8</a> for more information).</p>&#13;
</li>&#13;
<li>&#13;
<p>Enables hosting of those solutions<a data-primary="Operator repositories" data-type="indexterm" id="idm45261333441992"/><a data-primary="OperatorHub.io" data-type="indexterm" id="idm45261333441384"/> on Operator repositories like OperatorHub.io (see <a data-type="xref" href="ch10.html#getting_involved">Chapter 10</a> for more information).</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In this chapter we demonstrate how to use the SDK to build and test Adapter Operators using the Visitors Site application introduced in the previous chapter.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="custom_resource_defs">&#13;
<h5>Custom Resource Definitions</h5>&#13;
<p>Before we explain how to implement an Operator (in both this chapter and the next), it’s important for you to understand the role of CRDs.</p>&#13;
&#13;
<p>As discussed in <a data-type="xref" href="ch03.html#operators_at_the_kubernetes_interface">Chapter 3</a>, CRDs allow you to create domain-specific resources that correspond to your application. Using the standard Kubernetes APIs, end users interact with these resources to deploy and configure applications.<a data-primary="watches" data-type="indexterm" id="idm45261333435688"/> Operators make heavy use of CRs and use <em>watches</em> on these objects to react to changes as they are made.</p>&#13;
&#13;
<p>A CRD is the specification of what constitutes a CR. In particular, the CRD defines the allowed configuration values and the expected output that describes the current state of the resource.</p>&#13;
&#13;
<p>In each of the following examples, both in this chapter and the next, a CRD is created when a new Operator project is generated by the SDK.<a data-primary="custom resource definitions (CRDs)" data-secondary="creating with Operator SDK, information required" data-type="indexterm" id="idm45261333433432"/> The SDK prompts the user for two pieces of information about the CRD during project creation:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The <code>kind</code> is the name of the CR type defined by the CRD. When creating new instances<a data-primary="kind, for custom resource definitions" data-secondary-sortas="custom" data-type="indexterm" id="idm45261333431064"/> of this resource type, this value is used as the resource’s <code>kind</code> field, similar to when creating a pod or service.</p>&#13;
</li>&#13;
<li>&#13;
<p>The <code>api-version</code> contains information about the group and version of the CRD, which is specified when creating CRs according to that CRD schema.<a data-primary="api-version" data-type="indexterm" id="idm45261333428408"/> The value for this argument is specified in the format <code>&lt;group&gt;/&lt;version&gt;</code>, with the following recommendations:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The group should identify the organization that wrote and maintains the CRD. For example, the group for the EtcdCluster CR is <code>etcd.database.coreos.com</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>The version should follow the <a href="https://oreil.ly/tk1hc">Kubernetes API versioning conventions</a>. For example, at the time of<a data-primary="Kubernetes" data-secondary="API versioning conventions" data-type="indexterm" id="idm45261333424472"/> writing, the EtcdCluster version is <code>v1beta2</code>.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>To recreate the EtcdCluster example, this <code>api-version</code> value is valid for the SDK:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">--api-version<code class="o">=</code>etcd.database.coreos.com/v1beta2</pre>&#13;
&#13;
<p>The <code>kind</code> and <code>api-version</code> of a CR are used when creating Operators of all types.</p>&#13;
</div></aside>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Helm Operator" data-type="sect1"><div class="sect1" id="idm45261333438536">&#13;
<h1>Helm Operator</h1>&#13;
&#13;
<p><a href="https://helm.sh/">Helm</a> is a package manager for Kubernetes.<a data-primary="Adapter Operators" data-secondary="Helm Operator" data-type="indexterm" id="ix_adapOpHe"/><a data-primary="Helm Operator" data-type="indexterm" id="ix_HlmOp"/> It makes it easier to deploy applications with multiple components, but each deployment is still a manual process. If you’re deploying many instances of a Helm-packaged app, it would be convenient to automate those deployments with an Operator.</p>&#13;
&#13;
<p>Helm’s intricacies are outside the scope of this book—you can consult the <a href="https://helm.sh/docs/">documentation</a> for more details—but a little background will help you understand the Helm Operator. Helm defines the Kubernetes resources that constitute an application, such as deployments and services, in a file called a <em>chart</em>. <a data-primary="Helm charts" data-type="indexterm" id="idm45261333414616"/><a data-primary="charts (Helm)" data-type="indexterm" id="idm45261333413880"/>Charts support configuration variables, so you can customize application instances without needing to edit the chart itself. These configuration values are specified in a file named <em>values.yaml</em>. A Helm Operator can deploy each instance of an application with a different version of <em>values.yaml</em>.</p>&#13;
&#13;
<p>The Operator<a data-primary="controllers" data-secondary="Operator SDK generating code for Helm Operator controller" data-type="indexterm" id="idm45261333411656"/> SDK generates Kubernetes controller code for a Helm Operator when it is passed the <code>--type=helm</code> argument. You supply a Helm chart for your application, and the resulting Helm Operator watches for new CRs of its given type. When it finds one of these CRs, it constructs a Helm <em>values.yaml</em> file from the values defined in the resource. The Operator then creates the application resources specified in its Helm chart according to the settings in <em>values.yaml</em>. To configure another instance of the application, you create a new CR containing appropriate values for the instance.</p>&#13;
&#13;
<p>The SDK provides <a data-primary="building Operators" data-secondary="Helm-based Operators" data-type="indexterm" id="ix_bldOpsHe"/>two variations on how to build Helm-based Operators:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The project generation process builds a blank Helm chart structure within the Operator project code.</p>&#13;
</li>&#13;
<li>&#13;
<p>An existing chart is specified at Operator creation time, which the creation process uses to populate the generated Operator.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>In the following sections we discuss each of these approaches. As a prerequisite, be sure to install the Helm command-line tools on your machine. You can find information on doing this in <a href="https://oreil.ly/qpZX0">Helm’s install documentation</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Building the Operator" data-type="sect2"><div class="sect2" id="idm45261333403176">&#13;
<h2>Building the Operator</h2>&#13;
&#13;
<p>The SDK’s <code>new</code> command creates the skeleton project files for a new Operator. These files <a data-primary="Adapter Operators" data-secondary="Helm Operator" data-tertiary="building" data-type="indexterm" id="ix_adapOpHebld"/><a data-primary="Helm Operator" data-secondary="building the Operator" data-type="indexterm" id="ix_HlmOPbld"/>include all of the code necessary for a Kubernetes controller that invokes the appropriate Helm chart to field requests for CRs. We’ll discuss these files in greater detail later in this section.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a new chart" data-type="sect3"><div class="sect3" id="idm45261333377832">&#13;
<h3>Creating a new chart</h3>&#13;
&#13;
<p>To create an Operator with the skeleton for a new Helm chart, use the <span class="keep-together"><code>--type=helm</code></span> argument. The<a data-primary="Helm charts" data-secondary="creating new for Helm Operator" data-type="indexterm" id="idm45261333375704"/> following example creates the basis of a Helm Operator for the Visitors Site application (see <a data-type="xref" href="ch05.html#sample_application_visitors_site">Chapter 5</a>):</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code class="nv">OPERATOR_NAME</code><code class="o">=</code><code>visitors-helm-operator</code></strong><code>&#13;
</code><code class="nv">$ </code><strong><code>operator-sdk</code><code> </code><code>new</code><code> </code><code class="nv">$OPERATOR_NAME</code><code> </code><code>--api-version</code><code class="o">=</code><code>example.com/v1</code><code> </code><code class="o">\&#13;
</code><code>  </code><code>--kind</code><code class="o">=</code><code>VisitorsApp</code><code> </code><code>--type</code><code class="o">=</code><code>helm</code></strong><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Creating</code><code> </code><code>new</code><code> </code><code>Helm</code><code> </code><code>operator</code><code> </code><code>'visitors-helm-operator'</code><code>.</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>helm-charts/visitorsapp</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Generating</code><code> </code><code>RBAC</code><code> </code><code>rules</code><code>&#13;
</code><code>WARN</code><code>[</code><code>0000</code><code>]</code><code> </code><code>The</code><code> </code><code>RBAC</code><code> </code><code>rules</code><code> </code><code>generated</code><code> </code><code>in</code><code> </code><code>deploy/role.yaml</code><code> </code><code>are</code><code> </code><code>based</code><code> </code><code>on</code><code>&#13;
</code><code>the</code><code> </code><code>chart</code><code>'s default manifest. Some rules may be missing for resources&#13;
that are only enabled with custom values, and some existing rules may&#13;
be overly broad. Double check the rules generated in deploy/role.yaml&#13;
to ensure they meet the operator'</code><code>s</code><code> </code><code>permission</code><code> </code><code>requirements.</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>build/Dockerfile</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>watches.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/service_account.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/role.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/role_binding.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/operator.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/crds/example_v1_visitorsapp_crd.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/crds/example_v1_visitorsapp_cr.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Project</code><code> </code><code>creation</code><code> </code><code>complete.</code><code>&#13;
</code></pre>&#13;
&#13;
<p><code>visitors-helm-operator</code> is the name of the generated Operator. The other two arguments, <code>--api-version</code> and <code>--kind</code>, describe the CR this Operator manages. These arguments result in the creation of a basic CRD for the new type.</p>&#13;
&#13;
<p>The SDK creates a new directory with the same name as <code>$OPERATOR_NAME</code>, which contains all of the Operator’s files. There are a few files and directories to note:</p>&#13;
<dl>&#13;
<dt><em>deploy/</em></dt>&#13;
<dd>&#13;
<p>This directory contains Kubernetes template files that are used to deploy and configure the Operator, including the CRD, the Operator deployment resource itself, and the necessary RBAC resources for the Operator to run.</p>&#13;
</dd>&#13;
<dt><em>helm-charts/</em></dt>&#13;
<dd>&#13;
<p>This directory contains a skeleton directory structure for a Helm chart with the same name as the CR kind. The files within are similar to those the Helm CLI creates when it initializes a new chart, including a <em>values.yaml</em> file.<a data-primary="values.yaml file (Helm Operator)" data-type="indexterm" id="idm45261333317912"/> A new chart is added to this directory for each new CR type the Operator manages.</p>&#13;
</dd>&#13;
<dt><em>watches.yaml</em></dt>&#13;
<dd>&#13;
<p>This file maps each CR type to the specific Helm chart that is used to handle it.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>At this point, everything is in place to begin to implement your chart. However, if you already have a chart written, there is an easier approach.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Use an existing chart" data-type="sect3"><div class="sect3" id="idm45261333315096">&#13;
<h3>Use an existing chart</h3>&#13;
&#13;
<p>The process for building an Operator from an existing Helm chart is similar to that for creating an Operator with a new chart.<a data-primary="Helm charts" data-secondary="existing chart, building Operator from" data-type="indexterm" id="idm45261333313384"/><a data-primary="type field" data-secondary="for Helm Operator" data-type="indexterm" id="idm45261333312536"/> In addition to the <code>--type=helm</code> argument, there are a few additional arguments to take into consideration:</p>&#13;
<dl>&#13;
<dt>--helm-chart</dt>&#13;
<dd>&#13;
<p>Tells the SDK to initialize the Operator with an existing chart. The value can be:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A URL to a chart archive</p>&#13;
</li>&#13;
<li>&#13;
<p>The repository and name of a remote chart</p>&#13;
</li>&#13;
<li>&#13;
<p>The location of a local directory</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt>--helm-chart-repo</dt>&#13;
<dd>&#13;
<p>Specifies a remote repository URL for the chart (unless a local directory is otherwise specified).</p>&#13;
</dd>&#13;
<dt>--helm-chart-version</dt>&#13;
<dd>&#13;
<p>Tells the SDK to fetch a specific version of the chart. If this is omitted, the latest available version is used.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>When using the <code>--helm-chart</code> argument, the <code>--api-version</code> and <code>--kind</code> arguments become optional. The <code>api-version</code> is defaulted to <code>charts.helm.k8s.io/v1alpha1</code> and the <code>kind</code> name will be derived from the name of the chart. However, as the <code>api-version</code> carries information about the CR creator, we recommend that you explicitly populate these values appropriately. You can find an example Helm chart for deploying the Visitors Site application in this book’s <a href="https://github.com/kubernetes-operators-book/chapters/tree/master/ch06/visitors-helm">GitHub repository</a>.</p>&#13;
&#13;
<p>The following example demonstrates how to build an Operator and initialize it using an archive of the Visitors Site Helm chart:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code class="nv">OPERATOR_NAME</code><code class="o">=</code><code>visitors-helm-operator</code></strong><code>&#13;
</code><code class="nv">$ </code><strong><code>wget</code><code> </code><code>https://github.com/kubernetes-operators-book/</code><code class="o">\&#13;
</code><code>  </code><code>chapters/releases/download/1.0.0/visitors-helm.tgz</code></strong><code>  </code><a class="co" href="#c01-01a" id="comarker1-01a"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nv">$ </code><strong><code>operator-sdk</code><code> </code><code>new</code><code> </code><code class="nv">$OPERATOR_NAME</code><code> </code><code>--api-version</code><code class="o">=</code><code>example.com/v1</code><code> </code><code class="o">\&#13;
</code><code>  </code><code>--kind</code><code class="o">=</code><code>VisitorsApp</code><code> </code><code>--type</code><code class="o">=</code><code>helm</code><code> </code><code>--helm-chart</code><code class="o">=</code><code>./visitors-helm.tgz</code></strong><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Creating</code><code> </code><code>new</code><code> </code><code>Helm</code><code> </code><code>operator</code><code> </code><code>'visitors-helm-operator'</code><code>.</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>helm-charts/visitors-helm</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Generating</code><code> </code><code>RBAC</code><code> </code><code>rules</code><code>&#13;
</code><code>WARN</code><code>[</code><code>0000</code><code>]</code><code> </code><code>The</code><code> </code><code>RBAC</code><code> </code><code>rules</code><code> </code><code>generated</code><code> </code><code>in</code><code> </code><code>deploy/role.yaml</code><code> </code><code>are</code><code> </code><code>based</code><code> </code><code>on</code><code>&#13;
</code><code>the</code><code> </code><code>chart</code><code>'s default manifest. Some rules may be missing for resources&#13;
that are only enabled with custom values, and some existing rules may&#13;
be overly broad. Double check the rules generated in deploy/role.yaml&#13;
to ensure they meet the operator'</code><code>s</code><code> </code><code>permission</code><code> </code><code>requirements.</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>build/Dockerfile</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>watches.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/service_account.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/role.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/role_binding.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/operator.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/crds/example_v1_visitorsapp_crd.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/crds/example_v1_visitorsapp_cr.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Project</code><code> </code><code>creation</code><code> </code><code>complete.</code><code>&#13;
</code></pre>&#13;
<dl class="calloutlist">&#13;
 <dt><a class="co" href="#comarker1-01a" id="c01-01a"><img alt="1" src="assets/1.png"/></a></dt>&#13;
  <dd><p>Due to an issue with how the Operator SDK handles redirects, you must manually download the chart tarball and pass it as a local reference.</p></dd>&#13;
</dl>&#13;
&#13;
<p>The preceding example generates the same files as in the case of creating an Operator with a new Helm chart, with the notable exception that the chart files are populated from the specified archive:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>ls</code><code> </code><code>-l</code><code> </code><code class="nv">$OPERATOR_NAME</code><code>/helm-charts/visitors-helm/templates</code></strong><code>&#13;
</code><code>_helpers.tpl</code><code>&#13;
</code><code>auth.yaml</code><code>&#13;
</code><code>backend-deployment.yaml</code><code>&#13;
</code><code>backend-service.yaml</code><code>&#13;
</code><code>frontend-deployment.yaml</code><code>&#13;
</code><code>frontend-service.yaml</code><code>&#13;
</code><code>mysql-deployment.yaml</code><code>&#13;
</code><code>mysql-service.yaml</code><code>&#13;
</code><code>tests</code><code>&#13;
</code></pre>&#13;
&#13;
<p>The SDK uses the values in the chart’s <em>values.yaml</em> file to populate the example <a data-primary="custom resources (CRs)" data-secondary="generation by SDK for Helm Operator" data-type="indexterm" id="idm45261333224280"/>CR template.<a data-primary="values.yaml file (Helm Operator)" data-secondary="using to populate custom resource template" data-type="indexterm" id="idm45261333223576"/> For example, the Visitors Site Helm chart has the following <em>values.yaml</em> file:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>cat</code><code> </code><code class="nv">$OPERATOR_NAME</code><code>/helm-charts/visitors-helm/values.yaml</code></strong><code>&#13;
</code><code>backend:</code><code>&#13;
  </code><code>size:</code><code> </code><code>1</code><code>&#13;
&#13;
</code><code>frontend:</code><code>&#13;
  </code><code>title:</code><code> </code><code>Helm</code><code> </code><code>Installed</code><code> </code><code>Visitors</code><code> </code><code>Site</code><code>&#13;
</code></pre>&#13;
&#13;
<p>The example CR generated by the SDK, found in the <em>deploy/crds</em> directory in<a data-primary="spec field" data-secondary="generated by SDK for custom resource" data-type="indexterm" id="idm45261333177688"/> the Operator project root directory, includes these same values in its <code>spec</code> section:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>cat</code><code> </code><code class="nv">$OPERATOR_NAME</code><code>/deploy/crds/example_v1_visitorsapp_cr.yaml</code></strong><code>&#13;
</code><code>apiVersion:</code><code> </code><code>example.com/v1</code><code>&#13;
</code><code>kind:</code><code> </code><code>VisitorsApp</code><code>&#13;
</code><code>metadata:</code><code>&#13;
  </code><code>name:</code><code> </code><code>example-visitorsapp</code><code>&#13;
</code><code>spec:</code><code>&#13;
  </code><code class="c"># Default values copied from &lt;proj_dir&gt;/helm-charts/visitors-helm/values.yaml&#13;
</code><code>&#13;
  </code><code>backend:</code><code>&#13;
    </code><code>size:</code><code> </code><code>1</code><code>&#13;
&#13;
  </code><code>frontend:</code><code>&#13;
    </code><code>title:</code><code> </code><code>Helm</code><code> </code><code>Installed</code><code> </code><code>Visitors</code><code> </code><code>Site</code><code>&#13;
</code></pre>&#13;
&#13;
<p>Before running the chart, the Operator will map the values found in the custom resource’s <code>spec</code> field to the <em>values.yaml</em> file.<a data-primary="Adapter Operators" data-secondary="Helm Operator" data-startref="ix_adapOpHebld" data-tertiary="building" data-type="indexterm" id="idm45261333128472"/><a data-primary="Helm Operator" data-secondary="building the Operator" data-startref="ix_HlmOPbld" data-type="indexterm" id="idm45261333132152"/><a data-primary="building Operators" data-secondary="Helm-based Operators" data-startref="ix_bldOpsHe" data-type="indexterm" id="idm45261333134840"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Fleshing Out the CRD" data-type="sect2"><div class="sect2" id="idm45261333314632">&#13;
<h2>Fleshing Out the CRD</h2>&#13;
&#13;
<p>The <a data-primary="Adapter Operators" data-secondary="Helm Operator" data-tertiary="custom resource definition for" data-type="indexterm" id="idm45261333139112"/><a data-primary="Helm Operator" data-secondary="fleshing out the CRD for" data-type="indexterm" id="idm45261333137464"/><a data-primary="custom resource definitions (CRDs)" data-secondary="fleshing out for Helm Operator" data-type="indexterm" id="idm45261333140952"/>generated CRD does not include specific details of the value input and state values of the CR type. <a data-type="xref" href="app02.html#appendix_crd_validation">Appendix B</a> describes the steps you should take to finish defining the CR.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Reviewing Operator Permissions" data-type="sect2"><div class="sect2" id="idm45261333146168">&#13;
<h2>Reviewing Operator Permissions</h2>&#13;
&#13;
<p>The generated deployment files include the role the Operator will use to connect to the Kubernetes API. <a data-primary="Adapter Operators" data-secondary="Helm Operator" data-tertiary="permissions for" data-type="indexterm" id="idm45261333144520"/><a data-primary="permissions" data-secondary="reviewing for Helm Operator" data-type="indexterm" id="idm45261333147976"/><a data-primary="role-based access control (RBAC)" data-secondary="reviewing permissions for Helm Operator" data-type="indexterm" id="idm45261333147064"/><a data-primary="Helm Operator" data-secondary="reviewing permissions for" data-type="indexterm" id="idm45261333149704"/>By default, this role is extremely permissive. <a data-type="xref" href="app03.html#appendix_rbac">Appendix C</a> talks about how to fine-tune the role definition to limit the Operator’s permissions.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running the Helm Operator" data-type="sect2"><div class="sect2" id="idm45261333112296">&#13;
<h2>Running the Helm Operator</h2>&#13;
&#13;
<p>An Operator is delivered as a normal container image.<a data-primary="Helm Operator" data-secondary="running" data-type="indexterm" id="idm45261333111032"/><a data-primary="Adapter Operators" data-secondary="Helm Operator" data-tertiary="running" data-type="indexterm" id="idm45261333110056"/> However, during the development and testing cycle, it is often easier to skip the image creation process and simply run the Operator outside of the cluster. In this section we describe those steps (see <a data-type="xref" href="app01.html#appendix_operator_as_deployment">Appendix A</a> for information about running the Operator as a deployment inside the cluster). Run all the commands here from within the Operator project root directory:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Create a local watches file.<a data-primary="watches" data-secondary="creating for Helm Operator" data-type="indexterm" id="idm45261333106520"/> The generated <em>watches.yaml</em> file refers to a specific path where the Helm chart is found. This path makes sense in the deployed Operator scenario; the image creation process takes care of copying the chart to the necessary location. This <em>watches.yaml</em> file is still required when running the Operator outside of the cluster, so you need to manually make sure your chart can be found at that location.</p>&#13;
&#13;
<p>The simplest approach is to copy the existing <em>watches.yaml</em> file, which is located in the root of the Operator project:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>cp</code><code> </code><code>watches.yaml</code><code> </code><code class="nb">local</code><code>-watches.yaml</code></strong><code>&#13;
</code></pre>&#13;
&#13;
<p>In the <em>local-watches.yaml</em> file, edit the <code>chart</code> field to contain the full path of the chart on your machine. Remember the name of the local watches file; you will need it later when you start the Operator process.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create the CRDs in the cluster using the <code>kubectl</code> command:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>deploy/crds/*_crd.yaml</code></strong><code>&#13;
</code></pre>&#13;
</li>&#13;
<li>&#13;
<p>Once you have finished creating the CRDs, start the Operator using the following SDK command:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>operator-sdk</code><code> </code><code>up</code><code> </code><code class="nb">local</code><code> </code><code>--watches-file</code><code> </code><code>./local-watches.yaml</code></strong><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Running</code><code> </code><code>the</code><code> </code><code>operator</code><code> </code><code>locally.</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Using</code><code> </code><code>namespace</code><code> </code><code>default.</code><code>  </code><a class="co" href="#c01-02a" id="comarker1-02a"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code></pre>&#13;
<dl class="calloutlist">&#13;
 <dt><a class="co" href="#comarker1-02a" id="c01-02a"><img alt="1" src="assets/1.png"/></a></dt>&#13;
 <dd><p>The Operator log messages will appear in this running process as it starts up and fields CR requests.</p></dd>&#13;
</dl>&#13;
&#13;
<p>This command starts a running process that behaves in the same way the Operator would if you had deployed it as a pod inside the cluster. (We’ll cover testing <a data-primary="Adapter Operators" data-secondary="Helm Operator" data-startref="ix_adapOpHe" data-type="indexterm" id="idm45261332997816"/><a data-primary="Helm Operator" data-startref="ix_HlmOp" data-type="indexterm" id="idm45261332996568"/> in more detail in <a data-type="xref" href="#test_operator">“Testing an Operator”</a>.)</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Ansible Operator" data-type="sect1"><div class="sect1" id="idm45261333397080">&#13;
<h1>Ansible Operator</h1>&#13;
&#13;
<p><a href="https://www.ansible.com/">Ansible</a> is a popular management tool for automating the provisioning and configuration of commonly run tasks.<a data-primary="Adapter Operators" data-secondary="Ansible Operator" data-type="indexterm" id="ix_adapOPAns"/><a data-primary="Ansible Operator" data-type="indexterm" id="ix_AnsOp"/> Similar to a Helm chart, an Ansible <em>playbook</em> defines a series of <em>tasks</em> that are run on a set of servers.<a data-primary="Ansible playbooks" data-secondary="tasks and reusable roles" data-type="indexterm" id="idm45261332976488"/><a data-primary="roles" data-secondary="reusable roles in Ansible" data-type="indexterm" id="idm45261332975640"/> Reusable <em>roles</em>, which extend Ansible through custom functionality, may be used to enhance the set of tasks in a playbook.</p>&#13;
&#13;
<p>One useful collection of roles is <a href="https://oreil.ly/1ckgw">k8s</a>, which provides tasks for interacting with a Kubernetes cluster. Using this module, you can write playbooks to handle the deployment of applications, including all of the necessary supporting Kubernetes resources.</p>&#13;
&#13;
<p>The Operator SDK provides a way to build an Operator that will run Ansible playbooks to react to CR changes. The SDK supplies the code for the Kubernetes pieces, such as the controller, allowing you to focus on writing the playbooks themselves.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Building the Operator" data-type="sect2"><div class="sect2" id="idm45261332972280">&#13;
<h2>Building the Operator</h2>&#13;
&#13;
<p>As with its Helm support, the Operator SDK generates a project skeleton. When run with<a data-primary="Adapter Operators" data-secondary="Ansible Operator" data-tertiary="building" data-type="indexterm" id="idm45261332970712"/><a data-primary="type field" data-secondary="for Ansible Operator" data-type="indexterm" id="idm45261332969560"/><a data-primary="Ansible Operator" data-secondary="building" data-type="indexterm" id="idm45261332968616"/><a data-primary="building Operators" data-secondary="Ansible Operator" data-type="indexterm" id="idm45261332967672"/> the <code>--type=ansible</code> argument, the project skeleton contains the structure for a blank Ansible role. The name of the role is derived from the specified CR type name.</p>&#13;
&#13;
<p>The following<a data-primary="custom resources (CRs)" data-secondary="defining for Ansible Operator" data-type="indexterm" id="idm45261332965608"/> example demonstrates creating an Ansible Operator that defines a CR for the Visitors Site application:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code class="nv">OPERATOR_NAME</code><code class="o">=</code><code>visitors-ansible-operator</code></strong><code>&#13;
</code><code class="nv">$ </code><strong><code>operator-sdk</code><code> </code><code>new</code><code> </code><code class="nv">$OPERATOR_NAME</code><code> </code><code>--api-version</code><code class="o">=</code><code>example.com/v1</code><code> </code><code class="o">\&#13;
</code><code>  </code><code>--kind</code><code class="o">=</code><code>VisitorsApp</code><code> </code><code>--type</code><code class="o">=</code><code>ansible</code></strong><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Creating</code><code> </code><code>new</code><code> </code><code>Ansible</code><code> </code><code>operator</code><code> </code><code>'visitors-ansible-operator'</code><code>.</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/service_account.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/role.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/role_binding.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/crds/example_v1_visitorsapp_crd.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/crds/example_v1_visitorsapp_cr.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>build/Dockerfile</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>roles/visitorsapp/README.md</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>roles/visitorsapp/meta/main.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>roles/visitorsapp/files/.placeholder</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>roles/visitorsapp/templates/.placeholder</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>roles/visitorsapp/vars/main.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>molecule/test-local/playbook.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>roles/visitorsapp/defaults/main.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>roles/visitorsapp/tasks/main.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>molecule/default/molecule.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>build/test-framework/Dockerfile</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>molecule/test-cluster/molecule.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>molecule/default/prepare.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>molecule/default/playbook.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>build/test-framework/ansible-test.sh</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>molecule/default/asserts.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>molecule/test-cluster/playbook.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>roles/visitorsapp/handlers/main.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>watches.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>deploy/operator.yaml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>.travis.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>molecule/test-local/molecule.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Created</code><code> </code><code>molecule/test-local/prepare.yml</code><code>&#13;
</code><code>INFO</code><code>[</code><code>0000</code><code>]</code><code> </code><code>Project</code><code> </code><code>creation</code><code> </code><code>complete.</code><code>&#13;
</code></pre>&#13;
&#13;
<p>This command produces a similar directory structure to the Helm Operator example. The SDK creates a <em>deploy</em> directory that contains the same set of files, including the CRD and deployment template.</p>&#13;
&#13;
<p>There are a few notable differences<a data-primary="Helm Operator" data-secondary="differences from Ansible Operator" data-type="indexterm" id="idm45261332960040"/><a data-primary="Ansible Operator" data-secondary="differences from Helm Operator" data-type="indexterm" id="idm45261332870968"/> from the Helm Operator:</p>&#13;
<dl>&#13;
<dt><em>watches.yaml</em></dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The <a data-primary="watches" data-secondary="defining for Ansible Operator" data-type="indexterm" id="idm45261332867352"/>purpose of this is the same as for the Helm Operator: it maps a CR type to the location of a file that is executed during its resolution. The Ansible Operator, however, supports two different types of files (these fields are mutually exclusive):</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>If the <code>role</code> field is included, it must point to the directory of an Ansible <em>role</em> that is executed during resource reconciliation.<a data-primary="roles" data-secondary="for Ansible Operator" data-type="indexterm" id="idm45261332863576"/></p>&#13;
</li>&#13;
<li>&#13;
<p>If the <code>playbook</code> field is included, it must point to a <em>playbook</em> file that is run.</p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p>The SDK defaults this file to point to the role it created during generation.</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt><em>roles/</em></dt>&#13;
<dd>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>This directory contains all of the Ansible roles that may be run by the Operator. The SDK generates the base files for a new role when the project is created.</p>&#13;
</li>&#13;
<li>&#13;
<p>If the Operator manages multiple CR types, multiple roles are added to this directory. Additionally, an entry for each type, and its associated role, is added to the watches file.</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Next, you’ll implement the Ansible role for the CR. The details of what the role does will vary depending on the application: some common tasks include the creation of <span class="keep-together">deployments</span> and services to run the application’s containers. For more on writing Ansible roles, see the <a href="https://oreil.ly/bLd5g">Ansible documentation</a>.</p>&#13;
&#13;
<p>You can find the Ansible role for deploying the Visitors Site in the book’s <a href="https://github.com/kubernetes-operators-book/chapters/tree/master/ch06/ansible/visitors">GitHub repository</a>. For simplicity while following along with the example application, the role files are available as a release there. Similar to the previous Operator creation command, you can add the Visitors Site role with the following:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code class="nb">cd</code><code> </code><code class="nv">$OPERATOR_NAME</code><code>/roles/visitorsapp</code></strong><code>&#13;
</code><code class="nv">$ </code><strong><code>wget</code><code> </code><code>https://github.com/kubernetes-operators-book/</code><code class="se">\&#13;
</code><code>  </code><code>chapters/releases/download/1.0.0/visitors-ansible.tgz</code></strong><code>&#13;
</code><code class="nv">$ </code><strong><code>tar</code><code> </code><code>-zxvf</code><code> </code><code>visitors-ansible.tgz</code></strong><code> </code><a class="co" href="#c01-03a" id="comarker1-03a"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code><code class="nv">$ </code><strong><code>rm</code><code> </code><code>visitors-ansible.tgz</code></strong><code>&#13;
</code></pre>&#13;
<dl class="calloutlist">&#13;
 <dt><a class="co" href="#comarker1-03a" id="c01-03a"><img alt="1" src="assets/1.png"/></a></dt>&#13;
  <dd><p>This command overwrites the default generated role files with the files necessary to run the Visitors Site role.</p></dd>&#13;
</dl>&#13;
&#13;
<p>We don’t cover writing Ansible roles in this book, but it’s important for you to understand how user-entered configuration values are propagated into an Ansible role.</p>&#13;
&#13;
<p>As with the Helm Operator, configuration values come from the CR’s <code>spec</code> section.<a data-primary="spec field" data-secondary="for Ansible Operator" data-type="indexterm" id="idm45261332816792"/> However, within the playbooks and roles, Ansible’s standard <code>{{ <code>variable_name</code> }}</code> syntax is used. Field names in Kubernetes typically use camel case (e.g., <span class="keep-together">camelCase</span>), so the Ansible Operator will convert the name of each field to snake case (e.g., snake_case) before passing the parameter to the Ansible role.<a data-primary="snake case in Ansible" data-type="indexterm" id="idm45261332813976"/> That is, the field name <code>serviceAccount</code> would be converted to <code>service_account</code>. This allows the reuse of existing roles using the standard Ansible convention while also honoring the Kubernetes resource conventions. You can find the source for an Ansible role that deploys the Visitors Site in the book’s <a href="https://github.com/kubernetes-operators-book/chapters/tree/master/ch06/ansible">GitHub repository</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Fleshing Out the CRD" data-type="sect2"><div class="sect2" id="idm45261332971688">&#13;
<h2>Fleshing Out the CRD</h2>&#13;
&#13;
<p>As with the Helm Operator, you’ll need to expand on the generated CRD to include the specifics of your CR.<a data-primary="custom resource definitions (CRDs)" data-secondary="fleshing out for Ansible Operator" data-type="indexterm" id="idm45261332797912"/><a data-primary="Ansible Operator" data-secondary="fleshing out the CRD for" data-type="indexterm" id="idm45261332797064"/><a data-primary="Adapter Operators" data-secondary="Ansible Operator" data-tertiary="fleshing out the CRD for" data-type="indexterm" id="idm45261332796216"/> Consult <a data-type="xref" href="app02.html#appendix_crd_validation">Appendix B</a> for more information.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Reviewing Operator Permissions" data-type="sect2"><div class="sect2" id="idm45261332794008">&#13;
<h2>Reviewing Operator Permissions</h2>&#13;
&#13;
<p>The Ansible Operator also includes a generated role the Operator uses to connect to the Kubernetes API.<a data-primary="Ansible Operator" data-secondary="reviewing permissions for" data-type="indexterm" id="idm45261332792760"/><a data-primary="Adapter Operators" data-secondary="Ansible Operator" data-tertiary="reviewing permissions for" data-type="indexterm" id="idm45261332791816"/><a data-primary="permissions" data-secondary="reviewing for Ansible Operator" data-type="indexterm" id="idm45261332790632"/> Check <a data-type="xref" href="app03.html#appendix_rbac">Appendix C</a> for more on refining the default permissions.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running the Ansible Operator" data-type="sect2"><div class="sect2" id="idm45261332788504">&#13;
<h2>Running the Ansible Operator</h2>&#13;
&#13;
<p>As with the <a data-primary="Adapter Operators" data-secondary="Ansible Operator" data-tertiary="running" data-type="indexterm" id="idm45261332787064"/><a data-primary="Ansible Operator" data-secondary="running" data-type="indexterm" id="idm45261332785784"/>Helm Operator, the easiest way to test and debug an Ansible Operator is to run it outside a cluster, avoiding the steps of building and pushing an image.</p>&#13;
&#13;
<p>Before you can do this, however, there are a few extra steps you need to take:</p>&#13;
<ol>&#13;
<li>&#13;
<p>First, install Ansible on the machine running the Operator. Consult the <a href="https://oreil.ly/9yZRC">Ansible documentation</a> for specifics on how to install Ansible on your local OS.</p>&#13;
</li>&#13;
<li>&#13;
<p>Additional Ansible-related packages must be installed as well, including the following (consult the documentation for details on installation):</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/lHDCe">Ansible Runner</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/N6ebi">Ansible Runner HTTP Event Emitter</a></p>&#13;
</li>&#13;
</ul>&#13;
</li>&#13;
<li>&#13;
<p>As with the Helm Operator, the <em>watches.yaml</em> file generated by the SDK refers to a specific directory for the Ansible role. <a data-primary="watches" data-secondary="defining for Ansible Operator" data-type="indexterm" id="idm45261332776344"/>So you’ll copy the watches file and modify it as necessary. Again, run these commands from within the Operator project root directory:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>cp</code><code> </code><code>watches.yaml</code><code> </code><code class="nb">local</code><code>-watches.yaml</code></strong><code>&#13;
</code></pre>&#13;
&#13;
<p>In the <em>local-watches.yaml</em> file, change the <code>role</code> field to reflect the directory structure on your machine.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create the CRDs in <a data-primary="custom resource definitions (CRDs)" data-secondary="creating and deploying for Ansible Operator cluster" data-type="indexterm" id="idm45261332765832"/>the cluster using the <code>kubectl</code> command:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>deploy/crds/*_crd.yaml</code></strong><code>&#13;
</code></pre>&#13;
</li>&#13;
<li>&#13;
<p>Once the CRDs are deployed in the cluster, run the Operator using the SDK:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>operator-sdk</code><code> </code><code>up</code><code> </code><code class="nb">local</code><code> </code><code>--watches-file</code><code> </code><code>./local-watches.yaml</code></strong><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Running</code><code> </code><code>the</code><code> </code><code>operator</code><code> </code><code>locally.</code><code>&#13;
</code><code>INFO</code><code class="o">[</code><code>0000</code><code class="o">]</code><code> </code><code>Using</code><code> </code><code>namespace</code><code> </code><code>default.</code><code>  </code><a class="co" href="#c01-04a" id="comarker1-04a"><img alt="1" src="assets/1.png"/></a><code>&#13;
</code></pre>&#13;
<dl class="calloutlist">&#13;
 <dt><a class="co" href="#comarker1-04a" id="c01-04a"><img alt="1" src="assets/1.png"/></a></dt>&#13;
 <dd><p>The Operator log messages will appear in this running process as it starts up and fields CR requests.</p></dd>&#13;
</dl>&#13;
&#13;
<p>This command starts a running process that behaves as the Operator would if it was deployed as a pod inside the cluster.</p>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>Now let’s walk through the steps of how to test an Operator.<a data-primary="Ansible Operator" data-startref="ix_AnsOp" data-type="indexterm" id="idm45261332683448"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing an Operator" data-type="sect1"><div class="sect1" id="test_operator">&#13;
<h1>Testing an Operator</h1>&#13;
&#13;
<p>You can test both of the Adapter Operators using the same approach: by deploying a CR.<a data-primary="Adapter Operators" data-secondary="testing" data-type="indexterm" id="idm45261332680536"/><a data-primary="testing" data-secondary="for Adapter Operators" data-type="indexterm" id="idm45261332679560"/> Kubernetes notifies the Operator of the CR, which then executes the underlying files (either Helm charts or Ansible roles). The SDK generates a sample CR template in the <em>deploy/crds</em> directory that you can use, or you can create one manually.</p>&#13;
&#13;
<p>Follow these steps to test both types of Operators discussed in this chapter:</p>&#13;
<ol>&#13;
<li>&#13;
<p>Edit the <code>spec</code> section of the example CR template (in the Visitors Site example, this is named <em>example_v1_visitorsapp_cr.yaml</em>) with whatever values are relevant to your CR.</p>&#13;
</li>&#13;
<li>&#13;
<p>Create the resource (in the Operator project root directory) using the Kubernetes CLI:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>apply</code><code> </code><code>-f</code><code> </code><code>deploy/crds/*_cr.yaml</code></strong><code>&#13;
</code></pre>&#13;
&#13;
<p>The output for the Operator will appear in the same terminal where you ran the <code>operator-sdk up local</code> command. Once the test is complete, end the running process by pressing <code>Ctrl-C</code>.</p>&#13;
</li>&#13;
<li>&#13;
<p>Navigate to the Visitors Site as described in <a data-type="xref" href="ch05.html#sample_application_visitors_site">Chapter 5</a> to verify the application works as expected.</p>&#13;
</li>&#13;
<li>&#13;
<p>Once the test is complete, delete the CR using the <code>kubectl delete</code> command:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<code class="nv">$ </code><strong><code>kubectl</code><code> </code><code>delete</code><code> </code><code>-f</code><code> </code><code>deploy/crds/*_cr.yaml</code></strong><code>&#13;
</code></pre>&#13;
</li>&#13;
&#13;
</ol>&#13;
&#13;
<p>During development, repeat this process to test changes. On each iteration, be sure to restart the Operator process to pick up any changes to the Helm or Ansible files.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Summary" data-type="sect1"><div class="sect1" id="idm45261332625688">&#13;
<h1>Summary</h1>&#13;
&#13;
<p>You don’t need to be a programmer to write an Operator. The Operator SDK facilitates the packaging of two existing provisioning and configuration technologies, Helm and Ansible, as Operators. The SDK also provides a way to rapidly test and debug changes by running an Operator outside of the cluster, skipping the time-consuming image building and hosting steps.</p>&#13;
&#13;
<p>In the next chapter, we’ll look at a more powerful and flexible way of implementing Operators by using the Go language.<a data-primary="Adapter Operators" data-secondary="Ansible Operator" data-startref="ix_adapOPAns" data-type="indexterm" id="idm45261332623512"/><a data-primary="Adapter Operators" data-startref="ix_adapOp" data-type="indexterm" id="idm45261332622264"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Resources" data-type="sect1"><div class="sect1" id="idm45261332621064">&#13;
<h1>Resources</h1>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://helm.sh/">Helm</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://www.ansible.com/">Ansible</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/KbPFs">Example Operators</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
</div></section></body></html>