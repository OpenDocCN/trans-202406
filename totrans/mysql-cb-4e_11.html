<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Using Stored Routines, Triggers, and Scheduled Events"><div class="chapter" id="nch-routines"><h1><span class="label">Chapter 11. </span>Using Stored Routines, Triggers, and Scheduled Events</h1><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45820367352272"><h5>A note for Early Release readers</h5><p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p></div></aside><section data-type="sect1" data-pdf-bookmark="11.0 Introduction"><div class="sect1" id="nch-routines-routines-intro"><h1>11.0 Introduction</h1><p>In this book, the term <q>stored
      program</q> refers collectively to stored routines, triggers, and
      events, and <q>stored routine</q> refers
      collectively to stored functions and procedures.</p><p>This chapter discusses stored programs, which come in
    several varieties:</p><dl><dt>Stored functions and procedures</dt><dd><p>A stored function or procedure object encapsulates the code
          for performing an operation, enabling you to invoke the object
          easily by name rather than repeat all its code each time it’s
          needed. A stored function performs a calculation and returns a value that can be
          used in expressions just like a built-in function such as <code>RAND()</code>, <code>NOW()</code>, or <code>LEFT()</code>. A stored procedure performs operations for which no
          return value is needed. Procedures are invoked with the <code>CALL</code> statement, not used in expressions. A
          procedure might update rows in a table or produce a result set that
          is sent to the client program.</p></dd><dt>Triggers</dt><dd><p>A trigger is an object that activates when a table is modified by an
          <code>INSERT</code>, <code>UPDATE</code>, or <code>DELETE</code> statement. For example, you can check values before they are
          inserted into a table, or specify that any row deleted from a table
          should be logged to another table that serves as a journal of data
          changes. Triggers automate these actions.</p></dd><dt>Scheduled events</dt><dd><p>An event is an object that executes SQL statements at a scheduled
          time or times. Think of a scheduled event as something like a Unix
          <span class="command"><em>cron</em></span> job that runs within MySQL.
          For example, events can help you perform administrative tasks such
          as deleting old table rows periodically or creating nightly
          summaries.</p></dd></dl><p>Stored programs are database objects that are user-defined but stored on the
    server side for later execution. This differs from sending an SQL
    statement from the client to the server for immediate execution. Each
    object also has the property that it is defined in terms of other SQL statements
    to be executed when the object is invoked. The object body is a single SQL
    statement, but that statement can use compound-statement syntax (a
    <code>BEGIN</code> … <code>END</code> block) that contains multiple statements.
    Thus, the body can range from very simple to extremely complex. The
    following stored procedure is a trivial routine that does nothing but
    display the current MySQL version, using a body that consists of a single
    <code>SELECT</code> statement:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">PROCEDURE</code> <code class="n">show_version</code><code class="p">()</code>
<code class="k">SELECT</code> <code class="k">VERSION</code><code class="p">()</code> <code class="k">AS</code> <code class="s1">'MySQL Version'</code><code class="p">;</code></pre><p>More complex operations use a <code>BEGIN</code> … <code>END</code> compound statement:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">PROCEDURE</code> <code class="n">show_part_of_day</code><code class="p">()</code>
<code class="k">BEGIN</code>
  <code class="k">DECLARE</code> <code class="n">cur_time</code><code class="p">,</code> <code class="n">day_part</code> <code class="nb">TEXT</code><code class="p">;</code>
  <code class="k">SET</code> <code class="n">cur_time</code> <code class="o">=</code> <code class="n">CURTIME</code><code class="p">();</code>
  <code class="n">IF</code> <code class="n">cur_time</code> <code class="o">&lt;</code> <code class="s1">'12:00:00'</code> <code class="k">THEN</code>
    <code class="k">SET</code> <code class="n">day_part</code> <code class="o">=</code> <code class="s1">'morning'</code><code class="p">;</code>
  <code class="n">ELSEIF</code> <code class="n">cur_time</code> <code class="o">=</code> <code class="s1">'12:00:00'</code> <code class="k">THEN</code>
    <code class="k">SET</code> <code class="n">day_part</code> <code class="o">=</code> <code class="s1">'noon'</code><code class="p">;</code>
  <code class="k">ELSE</code>
    <code class="k">SET</code> <code class="n">day_part</code> <code class="o">=</code> <code class="s1">'afternoon or night'</code><code class="p">;</code>
  <code class="k">END</code> <code class="n">IF</code><code class="p">;</code>
  <code class="k">SELECT</code> <code class="n">cur_time</code><code class="p">,</code> <code class="n">day_part</code><code class="p">;</code>
<code class="k">END</code><code class="p">;</code></pre><p>Here, the <code>BEGIN</code> … <code>END</code> block contains multiple statements, but is
    itself considered to constitute a single statement. Compound statements
    enable you to declare local variables and to use conditional logic and
    looping constructs. These capabilities provide considerably more
    flexibility for algorithmic expression than when you write inline
    expressions in noncompound statements such as <code>SELECT</code> or <code>UPDATE</code>.</p><p>Each statement within a compound statement must be terminated by a
    <code>;</code> character. That requirement causes a
    problem if you use the <span class="command"><em>mysql</em></span> client to
    define an object that uses compound statements because
    <span class="command"><em>mysql</em></span> itself interprets <code>;</code> to determine statement boundaries. The
    solution is to redefine <span class="command"><em>mysql</em></span>’s
    statement delimiter while you define a compound-statement object. <a data-type="xref" href="#nch-routines-routines-compound-statement">Recipe 11.1</a> covers how to do
    this; be sure to read that recipe before proceeding to those that follow
    it.</p><p>This chapter illustrates stored routines, triggers, and events by
    example, but due to space limitations does not otherwise go into much
    detail about their extensive syntax. For complete syntax descriptions, see
    the <em>MySQL Reference Manual</em>.</p><p>Scripts for the examples shown in this chapter are located in the
    <em class="filename">routines</em>, <em class="filename">triggers</em>, and <em class="filename">events</em> directories of the <code>recipes</code> distribution. Scripts to create example
    tables are located in the <em class="filename">tables</em>
    directory.</p><p>In addition to the stored programs shown in this chapter, others can
    be found elsewhere in this book. See, for example, <a data-type="xref" href="ch07.xhtml#nch-strings-strings-lettercase-changing">Recipe 7.6</a>, <a data-type="xref" href="ch08.xhtml#nch-dates-dates-format">Recipe 8.3</a>, <a data-type="xref" href="ch16.xhtml#nch-multi-multi-fill-hole">Recipe 16.8</a>, and <a data-type="xref" href="ch24.xhtml#nch-security-account-management">Recipe 24.2</a>.</p><p>Stored programs used here are created and invoked under the
    assumption that <code>cookbook</code> is the default
    database. To invoke a program from another database, qualify its name with
    the database name:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CALL</code> <code class="n">cookbook</code><code class="p">.</code><code class="n">show_version</code><code class="p">();</code></pre><p>Alternatively, create a database specifically for your stored
    programs, create them in that database, and always invoke them qualified
    with that name. Remember to grant users who will use them the <code>EXECUTE</code> privilege for that database.</p><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45820366969456"><h5>Privileges for Stored Programs</h5><p>When you create a stored routine (function or procedure), the following
      privilege requirements must be satisfied or you will have
      problems:</p><ul><li><p>To create or execute the routine, you must have the <code>CREATE</code>
          <code>ROUTINE</code> or <code>EXECUTE</code> privilege, respectively.</p></li><li><p>If binary logging is enabled for your MySQL server, as is default since version 8.0,
          there are additional requirements for creating stored functions (but
          not stored procedures). These requirements are necessary to ensure
          that if you use the binary log for replication or for restoring
          backups, function invocations cause the same effect when re-executed
          as they do when originally executed:</p><ul><li><p>You must have the <code>SUPER</code> or, since version 8.0, <code>SET_USER_ID</code>
              privilege, and you must declare either that the function is
              deterministic or does not modify data by using one of the
              <code>DETERMINISTIC</code>, <code>NO</code> <code>SQL</code>, or <code>READS</code> <code>SQL</code> <code>DATA</code> characteristics. (It’s possible
              to create functions that are not deterministic or that modify
              data, but they might not be safe for replication or for use in
              backups.)</p></li><li><p>Alternatively, if you enable the <code>log_bin_trust_function_creators</code> system
              variable, the server waives both of the preceding requirements.
              You can do this at server startup, or at runtime if you have the
              <code>SUPER</code> privilege.</p></li></ul></li></ul><p>To create a trigger, you must have the <code>TRIGGER</code> privilege
      for the table associated with the trigger.</p><p>To create a scheduled event, you must have the <code>EVENT</code> privilege for
      the database in which the event is created.</p><p>For information about granting privileges, see <a data-type="xref" href="ch24.xhtml#nch-security-account-management">Recipe 24.2</a>.</p></div></aside></div></section><section data-type="sect1" data-pdf-bookmark="11.1 Creating Compound-Statement Objects"><div class="sect1" id="nch-routines-routines-compound-statement"><h1>11.1 Creating Compound-Statement Objects</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820366990736"><h2>Problem</h2><p>You want to define a stored program, but its body contains instances of the <code>;</code> statement terminator. The <span class="command"><em>mysql</em></span> client program uses the same terminator
      by default, so <span class="command"><em>mysql</em></span> misinterprets
      the definition and produces an error.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820366987632"><h2>Solution</h2><p>Redefine the <span class="command"><em>mysql</em></span> statement
      terminator with the <code>delimiter</code>
      command.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820366985408"><h2>Discussion</h2><p>Each stored program is an object with a body that must be a single
      SQL statement. However, these objects often perform complex operations
      that require several statements. To handle this, write the statements
      within a <code>BEGIN</code> … <code>END</code> block that forms a compound statement. That is, the block is
      itself a single statement but can contain multiple statements, each
      terminated by a <code>;</code> character. The
      <code>BEGIN</code> … <code>END</code> block can contain statements such
      as <code>SELECT</code> or <code>INSERT</code>, but compound statements also permit
      conditional statements such as <code>IF</code> or <code>CASE</code>, looping constructs such as <code>WHILE</code> or <code>REPEAT</code>, or other <code>BEGIN</code> … <code>END</code> blocks.</p><p>Compound-statement syntax provides flexibility, but if you define
      compound-statement objects within the <span class="command"><em>mysql</em></span> client, you quickly encounter a problem:
      each statement within a compound statement must be terminated by a
      <code>;</code> character, but <span class="command"><em>mysql</em></span> itself interprets <code>;</code> to figure out where statements end so that
      it can send them one at a time to the server to be executed.
      Consequently, <span class="command"><em>mysql</em></span> stops reading the
      compound statement when it sees the first <code>;</code> character, which is too early. To handle
      this, tell <span class="command"><em>mysql</em></span> to recognize a
      different statement delimiter so that it ignores <code>;</code> characters within the object body. Terminate
      the object itself with the new delimiter, which <span class="command"><em>mysql</em></span> recognizes and then sends the entire
      object definition to the server. You can restore the <span class="command"><em>mysql</em></span> delimiter to its original value after
      defining the compound-statement object.</p><p>The following example uses a stored function to illustrate how to change the delimiter, but
      the principles apply to defining any type of stored program.</p><p>Suppose that you want to create a stored function that calculates
      and returns the average size in bytes of mail messages listed in the
      <code>mail</code> table. The function can be
      defined like this, where the body consists of a single SQL
      statement:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">FUNCTION</code> <code class="n">avg_mail_size</code><code class="p">()</code>
<code class="k">RETURNS</code> <code class="nb">FLOAT</code> <code class="k">READS</code> <code class="k">SQL</code> <code class="k">DATA</code>
<code class="k">RETURN</code> <code class="p">(</code><code class="k">SELECT</code> <code class="k">AVG</code><code class="p">(</code><code class="k">size</code><code class="p">)</code> <code class="k">FROM</code> <code class="n">mail</code><code class="p">);</code></pre><p>The <code>RETURNS</code> <code>FLOAT</code> clause indicates the type of the function’s return value, and
      <code>READS</code> <code>SQL</code> <code>DATA</code>
      indicates that the function reads but does not modify data. The function
      body follows those clauses: a single <code>RETURN</code> statement that executes a subquery and
      returns the resulting value to the caller. (Every stored function must
      have at least one <code>RETURN</code>
      statement.)</p><p>In <span class="command"><em>mysql</em></span>, you can enter that
      statement as shown and there is no problem. The definition requires just
      the single terminator at the end and none internally, so no ambiguity
      arises. But suppose instead that you want the function to take an
      argument naming a user that it interprets as follows:</p><ul><li><p>If the argument is <code>NULL</code>,
          the function returns the average size for all messages (as
          before).</p></li><li><p>If the argument is non-<code>NULL</code>, the function returns the average
          size for messages sent by that user.</p></li></ul><p>To accomplish this, the function has a more complex body that uses
      a <code>BEGIN</code> … <code>END</code> block:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">FUNCTION</code> <code class="n">avg_mail_size</code><code class="p">(</code><code class="k">user</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">8</code><code class="p">))</code>
<code class="k">RETURNS</code> <code class="nb">FLOAT</code> <code class="k">READS</code> <code class="k">SQL</code> <code class="k">DATA</code>
<code class="k">BEGIN</code>
  <code class="k">DECLARE</code> <code class="k">avg</code> <code class="nb">FLOAT</code><code class="p">;</code>
  <code class="n">IF</code> <code class="k">user</code> <code class="k">IS</code> <code class="k">NULL</code>
  <code class="k">THEN</code> <code class="o">#</code> <code class="n">average</code> <code class="n">message</code> <code class="k">size</code> <code class="n">over</code> <code class="k">all</code> <code class="n">users</code>
    <code class="k">SET</code> <code class="k">avg</code> <code class="o">=</code> <code class="p">(</code><code class="k">SELECT</code> <code class="k">AVG</code><code class="p">(</code><code class="k">size</code><code class="p">)</code> <code class="k">FROM</code> <code class="n">mail</code><code class="p">);</code>
  <code class="k">ELSE</code> <code class="o">#</code> <code class="n">average</code> <code class="n">message</code> <code class="k">size</code> <code class="k">for</code> <code class="n">given</code> <code class="k">user</code>
    <code class="k">SET</code> <code class="k">avg</code> <code class="o">=</code> <code class="p">(</code><code class="k">SELECT</code> <code class="k">AVG</code><code class="p">(</code><code class="k">size</code><code class="p">)</code> <code class="k">FROM</code> <code class="n">mail</code> <code class="k">WHERE</code> <code class="n">srcuser</code> <code class="o">=</code> <code class="k">user</code><code class="p">);</code>
  <code class="k">END</code> <code class="n">IF</code><code class="p">;</code>
  <code class="k">RETURN</code> <code class="k">avg</code><code class="p">;</code>
<code class="k">END</code><code class="p">;</code></pre><p>If you try to define the function within <span class="command"><em>mysql</em></span> by entering that definition as just
      shown, <span class="command"><em>mysql</em></span> improperly interprets
      the first semicolon in the function body as ending the definition.
      Instead, use the <code>delimiter</code> command to
      change the <span class="command"><em>mysql</em></span> delimiter, then
      restore the delimiter to its default value:</p><pre data-type="programlisting">mysql&gt; <strong><code>delimiter $$</code></strong>
mysql&gt; <strong><code>CREATE FUNCTION avg_mail_size(user VARCHAR(8))</code></strong>
    -&gt; <strong><code>RETURNS FLOAT READS SQL DATA</code></strong>
    -&gt; <strong><code>BEGIN</code></strong>
    -&gt;   <strong><code>DECLARE avg FLOAT;</code></strong>
    -&gt;   <strong><code>IF user IS NULL</code></strong>
    -&gt;   <strong><code>THEN # average message size over all users</code></strong>
    -&gt;     <strong><code>SET avg = (SELECT AVG(size) FROM mail);</code></strong>
    -&gt;   <strong><code>ELSE # average message size for given user</code></strong>
    -&gt;     <strong><code>SET avg = (SELECT AVG(size) FROM mail WHERE srcuser = user);</code></strong>
    -&gt;   <strong><code>END IF;</code></strong>
    -&gt;   <strong><code>RETURN avg;</code></strong>
    -&gt; <strong><code>END;</code></strong>
    -&gt; <strong><code>$$</code></strong>
Query OK, 0 rows affected (0.02 sec)
mysql&gt; <strong><code>delimiter ;</code></strong></pre><p>After defining the stored function, invoke it the same way as a
      built-in function:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT avg_mail_size(NULL), avg_mail_size('barb');</code></strong>
+---------------------+-----------------------+
| avg_mail_size(NULL) | avg_mail_size('barb') |
+---------------------+-----------------------+
|         237386.5625 |                 52232 |
+---------------------+-----------------------+</pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="11.2 Using Stored Functions to Simplify Calculations"><div class="sect1" id="nch-routines-routines-encapsulation"><h1>11.2 Using Stored Functions to Simplify Calculations</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820366741168"><h2>Problem</h2><p>A particular calculation to produce a value must be performed
      frequently by different applications, but you don’t want to write the
      expression for it each time it’s needed. Or a calculation is difficult
      to perform inline within an expression because it requires conditional
      or looping logic. Or, if a calculation logic changes, you do not want to perform changes in each applications that uses it.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820366740288"><h2>Solution</h2><p>Use a stored function to have these details defined in the single place and make the
      calculation easy to perform.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820366739184"><h2>Discussion</h2><p>Stored functions enable you to simplify your applications. Write
      the code that produces a calculation result once in a function
      definition, then simply invoke the function whenever you need to perform
      the calculation. Stored functions also enable you to use more complex
      algorithmic constructs than are available when you write a calculation
      inline within an expression. This section illustrates how stored
      functions can be useful in these ways. (Granted, the example is not
      <em>that</em> complex, but the principles used here apply to
      writing much more elaborate functions.)</p><p>Different states in the US charge different rates for sales tax.
      If you sell goods to people from different states, you must charge tax
      using the rate appropriate for customer state of residence. To handle
      tax computations, use a table that lists the sales tax rate for each
      state, and a stored function that looks up the tax rate given a
      state.</p><p>To set up the <code>sales_tax_rate</code>
      table, use the <em class="filename">sales_tax_rate.sql</em>
      script in the <em class="filename">tables</em> directory of
      the <code>recipes</code> distribution. The table
      has two columns: <code>state</code> (a two-letter
      abbreviation), and <code>tax_rate</code> (a
      <code>DECIMAL</code> value rather than a <code>FLOAT</code>, to preserve accuracy).</p><p>Define the rate-lookup function, <code>sales_tax_rate()</code>, as follows:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">FUNCTION</code> <code class="n">sales_tax_rate</code><code class="p">(</code><code class="n">state_code</code> <code class="nb">CHAR</code><code class="p">(</code><code class="mi">2</code><code class="p">))</code>
<code class="k">RETURNS</code> <code class="nb">DECIMAL</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code> <code class="k">READS</code> <code class="k">SQL</code> <code class="k">DATA</code>
<code class="k">BEGIN</code>
  <code class="k">DECLARE</code> <code class="n">rate</code> <code class="nb">DECIMAL</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code><code class="mi">2</code><code class="p">);</code>
  <code class="k">DECLARE</code> <code class="k">CONTINUE</code> <code class="k">HANDLER</code> <code class="k">FOR</code> <code class="k">NOT</code> <code class="k">FOUND</code> <code class="k">SET</code> <code class="n">rate</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="k">SELECT</code> <code class="n">tax_rate</code> <code class="k">INTO</code> <code class="n">rate</code> <code class="k">FROM</code> <code class="n">sales_tax_rate</code> <code class="k">WHERE</code> <code class="n">state</code> <code class="o">=</code> <code class="n">state_code</code><code class="p">;</code>
  <code class="k">RETURN</code> <code class="n">rate</code><code class="p">;</code>
<code class="k">END</code><code class="p">;</code></pre><p>Suppose that the tax rates for Vermont and New York are 1 and 9
      percent, respectively. Try the function to check whether the tax rate is
      returned correctly:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT sales_tax_rate('VT'), sales_tax_rate('NY');</code></strong>
+----------------------+----------------------+
| sales_tax_rate('VT') | sales_tax_rate('NY') |
+----------------------+----------------------+
|                 0.01 |                 0.09 |
+----------------------+----------------------+</pre><p>If you take sales from a location not listed in the table, the
      function cannot determine the rate for it. In this case, the function
      assumes a tax rate of 0 percent:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT sales_tax_rate('ZZ');</code></strong>
+----------------------+
| sales_tax_rate('ZZ') |
+----------------------+
|                 0.00 |
+----------------------+</pre><p>The function handles states not listed using a <code>CONTINUE</code>
      handler for <code>NOT</code> <code>FOUND</code>, which executes if a “No Data” condition
      occurs: if there is no row for the given <code>state_param</code> value, the <code>SELECT</code> statement fails to find a sales tax
      rate, the <code>CONTINUE</code> handler sets the
      rate to 0, and continues execution with the next statement after the
      <code>SELECT</code>. (This handler is an example
      of stored routine logic not available in inline expressions. <a data-type="xref" href="#nch-routines-routines-handlers">“Handling Errors Within Stored Programs”</a> discusses handlers
      further.)</p><p>To compute sales tax for a purchase, multiply the purchase price
      by the tax rate. For example, for Vermont and New York, tax on a $150
      purchase is:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT 150*sales_tax_rate('VT'), 150*sales_tax_rate('NY');</code></strong>
+--------------------------+--------------------------+
| 150*sales_tax_rate('VT') | 150*sales_tax_rate('NY') |
+--------------------------+--------------------------+
|                     1.50 |                    13.50 |
+--------------------------+--------------------------+</pre><p>Or write another function that computes the tax for you:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">FUNCTION</code> <code class="n">sales_tax</code><code class="p">(</code><code class="n">state_code</code> <code class="nb">CHAR</code><code class="p">(</code><code class="mi">2</code><code class="p">),</code> <code class="n">sales_amount</code> <code class="nb">DECIMAL</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code class="mi">2</code><code class="p">))</code>
<code class="k">RETURNS</code> <code class="nb">DECIMAL</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code> <code class="k">READS</code> <code class="k">SQL</code> <code class="k">DATA</code>
<code class="k">RETURN</code> <code class="n">sales_amount</code> <code class="o">*</code> <code class="n">sales_tax_rate</code><code class="p">(</code><code class="n">state_code</code><code class="p">);</code></pre><p>And use it like this:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT sales_tax('VT',150), sales_tax('NY',150);</code></strong>
+---------------------+---------------------+
| sales_tax('VT',150) | sales_tax('NY',150) |
+---------------------+---------------------+
|                1.50 |               13.50 |
+---------------------+---------------------+</pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="11.3 Using Stored Procedures to Produce Multiple&#10;    Values"><div class="sect1" id="nch-routines-routines-multi-return-values"><h1>11.3 Using Stored Procedures to Produce Multiple
    Values</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820366600800"><h2>Problem</h2><p>You want to produce multiple values for an operation, but a stored function can only return a single value.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820366599792"><h2>Solution</h2><p>Use a stored procedure that has <code>OUT</code> or <code>INOUT</code> parameters, and pass user-defined variables for those parameters when
      you invoke the procedure. A procedure does not <q>return</q> a
      value the way a function does, but it can assign values to those
      parameters so that the user-defined variables have the desired values
      when the procedure returns.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820366560656"><h2>Discussion</h2><p>Unlike stored function parameters, which are input values only, a
      stored procedure parameter can be any of three types:</p><ul><li><p>An <code>IN</code> parameter is for
          input only. This is the default if you specify no type.</p></li><li><p>An <code>INOUT</code> parameter is used
          to pass a value in, and can also pass a value out.</p></li><li><p>An <code>OUT</code> parameter is used to
          pass a value out.</p></li></ul><p>Thus, to produce multiple values from an operation, you can use
      <code>INOUT</code> or <code>OUT</code> parameters. The following example
      illustrates this, using an <code>IN</code>
      parameter for input, and passing back three values via <code>OUT</code> parameters.</p><p><a data-type="xref" href="#nch-routines-routines-compound-statement">Recipe 11.1</a> shows
      an <code>avg_mail_size()</code> function that
      returns the average mail message size for a given sender. The function
      returns a single value. To produce additional information, such as the
      number of messages and total message size, a function will not work. You
      could write three separate functions, but that is cumbersome. Instead,
      use a single procedure that retrieves multiple values about a given mail
      sender. The following procedure, <code>mail_sender_stats()</code>, runs a query on the
      <code>mail</code> table to retrieve mail-sending
      statistics about a given username, which is the input value. The
      procedure determines how many messages that user sent, and the total and
      average sizes of the messages in bytes, which it returns through three
      <code>OUT</code> parameters:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">PROCEDURE</code> <code class="n">mail_sender_stats</code><code class="p">(</code><code class="k">IN</code> <code class="k">user</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">8</code><code class="p">),</code>
                                   <code class="k">OUT</code> <code class="n">messages</code> <code class="nb">INT</code><code class="p">,</code>
                                   <code class="k">OUT</code> <code class="n">total_size</code> <code class="nb">INT</code><code class="p">,</code>
                                   <code class="k">OUT</code> <code class="n">avg_size</code> <code class="nb">INT</code><code class="p">)</code>
<code class="k">BEGIN</code>
  <code class="o">#</code> <code class="n">Use</code> <code class="n">IFNULL</code><code class="p">()</code> <code class="k">to</code> <code class="k">return</code> <code class="mi">0</code> <code class="k">for</code> <code class="k">SUM</code><code class="p">()</code> <code class="k">and</code> <code class="k">AVG</code><code class="p">()</code> <code class="k">in</code> <code class="k">case</code> <code class="n">there</code> <code class="k">are</code>
  <code class="o">#</code> <code class="k">no</code> <code class="k">rows</code> <code class="k">for</code> <code class="n">the</code> <code class="k">user</code> <code class="p">(</code><code class="n">those</code> <code class="n">functions</code> <code class="k">return</code> <code class="k">NULL</code> <code class="k">in</code> <code class="n">that</code> <code class="k">case</code><code class="p">).</code>
  <code class="k">SELECT</code> <code class="k">COUNT</code><code class="p">(</code><code class="o">*</code><code class="p">),</code> <code class="n">IFNULL</code><code class="p">(</code><code class="k">SUM</code><code class="p">(</code><code class="k">size</code><code class="p">),</code><code class="mi">0</code><code class="p">),</code> <code class="n">IFNULL</code><code class="p">(</code><code class="k">AVG</code><code class="p">(</code><code class="k">size</code><code class="p">),</code><code class="mi">0</code><code class="p">)</code>
  <code class="k">INTO</code> <code class="n">messages</code><code class="p">,</code> <code class="n">total_size</code><code class="p">,</code> <code class="n">avg_size</code>
  <code class="k">FROM</code> <code class="n">mail</code> <code class="k">WHERE</code> <code class="n">srcuser</code> <code class="o">=</code> <code class="k">user</code><code class="p">;</code>
<code class="k">END</code><code class="p">;</code></pre><p>To use the procedure, pass a string containing the username, and
      three user-defined variables to receive the <code>OUT</code> values. After the procedure returns,
      access the variable values:</p><pre data-type="programlisting">mysql&gt; <strong><code>CALL mail_sender_stats('barb',@messages,@total_size,@avg_size);</code></strong>
mysql&gt; <strong><code>SELECT @messages, @total_size, @avg_size;</code></strong>
+-----------+-------------+-----------+
| @messages | @total_size | @avg_size |
+-----------+-------------+-----------+
|         3 |      156696 |     52232 |
+-----------+-------------+-----------+</pre><p>This routine passes back calculation results. It’s also common to
      use <code>OUT</code> parameters for diagnostic
      purposes such as status or error indicators.</p><p>If you call <code>mail_sender_stats()</code>
      from within a stored program, you can pass variables to it using routine
      parameters or program local variables, not just user-defined
      variables.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="11.4 Using Triggers to Log Changes to a Table"><div class="sect1" id="nch-routines-routines-trigger-log"><h1>11.4 Using Triggers to Log Changes to a Table</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820366438128"><h2>Problem</h2><p>You have a table that maintains current values of items that you track
      (such as auctions being bid on), but you’d also like to maintain a
      journal (history) of changes to the table.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820366437152"><h2>Solution</h2><p>Use triggers to <q>catch</q> table changes and write them
      to a separate log table.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820366402032"><h2>Discussion</h2><p>Suppose that you conduct online auctions, and that you maintain
      information about each currently active auction in a table that looks
      like this:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">auction</code>
<code class="p">(</code>
  <code class="n">id</code>   <code class="nb">INT</code> <code class="n">UNSIGNED</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="n">AUTO_INCREMENT</code><code class="p">,</code>
  <code class="n">ts</code>   <code class="k">TIMESTAMP</code> <code class="k">DEFAULT</code> <code class="k">CURRENT_TIMESTAMP</code> <code class="k">ON</code> <code class="k">UPDATE</code> <code class="k">CURRENT_TIMESTAMP</code><code class="p">,</code>
  <code class="n">item</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="n">bid</code>  <code class="nb">DECIMAL</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="n">id</code><code class="p">)</code>
<code class="p">);</code></pre><p>The <code>auction</code> table contains
      information about the currently active auctions (items being bid on and
      the current bid for each auction). When an auction begins, insert a row
      into the table. For each bid on an item, update its <code>bid</code> column so that as the auction proceeds,
      the <code>ts</code> column updates to reflect the
      most recent bid time. When the auction ends, the <code>bid</code> value is the final price and the row can
      be removed from the table.</p><p>To maintain a journal that shows all changes to auctions as they
      progress from creation to removal, set up another table that serves to
      record a history of changes to the auctions. This strategy can be
      implemented with triggers.</p><p>To maintain a history of how each auction progresses, use an
      <code>auction_log</code> table with the following
      columns:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">auction_log</code>
<code class="p">(</code>
  <code class="n">action</code> <code class="n">ENUM</code><code class="p">(</code><code class="s1">'create'</code><code class="p">,</code><code class="s1">'update'</code><code class="p">,</code><code class="s1">'delete'</code><code class="p">),</code>
  <code class="n">id</code>    <code class="nb">INT</code> <code class="n">UNSIGNED</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="n">ts</code>    <code class="k">TIMESTAMP</code> <code class="k">DEFAULT</code> <code class="k">CURRENT_TIMESTAMP</code> <code class="k">ON</code> <code class="k">UPDATE</code> <code class="k">CURRENT_TIMESTAMP</code><code class="p">,</code>
  <code class="n">item</code>  <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="n">bid</code>   <code class="nb">DECIMAL</code><code class="p">(</code><code class="mi">10</code><code class="p">,</code><code class="mi">2</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="k">INDEX</code> <code class="p">(</code><code class="n">id</code><code class="p">)</code>
<code class="p">);</code></pre><p>The <code>auction_log</code> table differs
      from the <code>auction</code> table in two
      ways:</p><ul><li><p>It contains an <code>action</code>
          column to indicate for each row what kind of change was made.</p></li><li><p>The <code>id</code> column has a
          nonunique index (rather than a primary key, which requires unique
          values). This permits multiple rows per <code>id</code> value because a given auction can
          generate many rows in the log table.</p></li></ul><p>To ensure that changes to the <code>auction</code> table are logged to the <code>auction_log</code> table, create a set of triggers.
      The triggers write information to the <code>auction_log</code> table as follows:</p><ul><li><p>For inserts, log a row-creation operation showing the values
          in the new row.</p></li><li><p>For updates, log a row-update operation showing the new values
          in the updated row.</p></li><li><p>For deletes, log a row-removal operation showing the values in
          the deleted row.</p></li></ul><p>For this application, <code>AFTER</code>
      triggers are used because they activate only after successful changes to
      the <code>auction</code> table. (<code>BEFORE</code> triggers might activate even if the
      row-change operation fails for some reason.) The trigger definitions
      look like this:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TRIGGER</code> <code class="n">ai_auction</code> <code class="k">AFTER</code> <code class="k">INSERT</code> <code class="k">ON</code> <code class="n">auction</code>
<code class="k">FOR</code> <code class="k">EACH</code> <code class="k">ROW</code>
<code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">auction_log</code> <code class="p">(</code><code class="n">action</code><code class="p">,</code><code class="n">id</code><code class="p">,</code><code class="n">ts</code><code class="p">,</code><code class="n">item</code><code class="p">,</code><code class="n">bid</code><code class="p">)</code>
<code class="k">VALUES</code><code class="p">(</code><code class="s1">'create'</code><code class="p">,</code><code class="k">NEW</code><code class="p">.</code><code class="n">id</code><code class="p">,</code><code class="n">NOW</code><code class="p">(),</code><code class="k">NEW</code><code class="p">.</code><code class="n">item</code><code class="p">,</code><code class="k">NEW</code><code class="p">.</code><code class="n">bid</code><code class="p">);</code>

<code class="k">CREATE</code> <code class="k">TRIGGER</code> <code class="n">au_auction</code> <code class="k">AFTER</code> <code class="k">UPDATE</code> <code class="k">ON</code> <code class="n">auction</code>
<code class="k">FOR</code> <code class="k">EACH</code> <code class="k">ROW</code>
<code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">auction_log</code> <code class="p">(</code><code class="n">action</code><code class="p">,</code><code class="n">id</code><code class="p">,</code><code class="n">ts</code><code class="p">,</code><code class="n">item</code><code class="p">,</code><code class="n">bid</code><code class="p">)</code>
<code class="k">VALUES</code><code class="p">(</code><code class="s1">'update'</code><code class="p">,</code><code class="k">NEW</code><code class="p">.</code><code class="n">id</code><code class="p">,</code><code class="n">NOW</code><code class="p">(),</code><code class="k">NEW</code><code class="p">.</code><code class="n">item</code><code class="p">,</code><code class="k">NEW</code><code class="p">.</code><code class="n">bid</code><code class="p">);</code>

<code class="k">CREATE</code> <code class="k">TRIGGER</code> <code class="n">ad_auction</code> <code class="k">AFTER</code> <code class="k">DELETE</code> <code class="k">ON</code> <code class="n">auction</code>
<code class="k">FOR</code> <code class="k">EACH</code> <code class="k">ROW</code>
<code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">auction_log</code> <code class="p">(</code><code class="n">action</code><code class="p">,</code><code class="n">id</code><code class="p">,</code><code class="n">ts</code><code class="p">,</code><code class="n">item</code><code class="p">,</code><code class="n">bid</code><code class="p">)</code>
<code class="k">VALUES</code><code class="p">(</code><code class="s1">'delete'</code><code class="p">,</code><code class="k">OLD</code><code class="p">.</code><code class="n">id</code><code class="p">,</code><code class="k">OLD</code><code class="p">.</code><code class="n">ts</code><code class="p">,</code><code class="k">OLD</code><code class="p">.</code><code class="n">item</code><code class="p">,</code><code class="k">OLD</code><code class="p">.</code><code class="n">bid</code><code class="p">);</code></pre><p>The <code>INSERT</code> and <code>UPDATE</code> triggers use <code>NEW.</code><em><code>col_name</code></em> to
      access the new values being stored in rows. The <code>DELETE</code> trigger uses
      <code>OLD.</code><em><code>col_name</code></em> to
      access the existing values from the deleted row. The <code>INSERT</code> and <code>UPDATE</code> triggers use <code>NOW()</code> to get the row-modification times; the
      <code>ts</code> column is initialized
      automatically to the current date and time, but <code>NEW.ts</code> will not contain that value.</p><p>Suppose that an auction is created with an initial bid of five
      dollars:</p><pre data-type="programlisting">mysql&gt; <strong><code>INSERT INTO auction (item,bid) VALUES('chintz pillows',5.00);</code></strong>
mysql&gt; <strong><code>SELECT LAST_INSERT_ID();</code></strong>
+------------------+
| LAST_INSERT_ID() |
+------------------+
|              792 |
+------------------+</pre><p>The <code>SELECT</code> statement fetches the auction ID value to use for subsequent actions
      on the auction. Then the item receives three more bids before the
      auction ends and is removed:</p><pre data-type="programlisting">mysql&gt; <strong><code>UPDATE auction SET bid = 7.50 WHERE id = 792;</code></strong>
<em><code>... time passes ...</code></em>
mysql&gt; <strong><code>UPDATE auction SET bid = 9.00 WHERE id = 792;</code></strong>
<em><code>... time passes ...</code></em>
mysql&gt; <strong><code>UPDATE auction SET bid = 10.00 WHERE id = 792;</code></strong>
<em><code>... time passes ...</code></em>
mysql&gt; <strong><code>DELETE FROM auction WHERE id = 792;</code></strong></pre><p>At this point, no trace of the auction remains in the <code>auction</code> table, but the <code>auction_log</code> table contains a complete history
      of what occurred:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * FROM auction_log WHERE id = 792 ORDER BY ts;</code></strong>
+--------+-----+---------------------+----------------+-------+
| action | id  | ts                  | item           | bid   |
+--------+-----+---------------------+----------------+-------+
| create | 792 | 2014-01-09 14:57:41 | chintz pillows |  5.00 |
| update | 792 | 2014-01-09 14:57:50 | chintz pillows |  7.50 |
| update | 792 | 2014-01-09 14:57:57 | chintz pillows |  9.00 |
| update | 792 | 2014-01-09 14:58:03 | chintz pillows | 10.00 |
| delete | 792 | 2014-01-09 14:58:03 | chintz pillows | 10.00 |
+--------+-----+---------------------+----------------+-------+</pre><p>With the strategy just outlined, the <code>auction</code> table remains relatively small, and
      you can always find information about auction histories as necessary by
      looking in the <code>auction_log</code> table.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="11.5 Using Events to Schedule Database Actions"><div class="sect1" id="nch-routines-routines-events"><h1>11.5 Using Events to Schedule Database Actions</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820366027344"><h2>Problem</h2><p>You want to set up a database operation that runs periodically without user
      intervention.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820366026352"><h2>Solution</h2><p>MySQL provides an event scheduler that enables you to set up
      database operations that run at times that you define. Create an event that executes according to a schedule.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820366025280"><h2>Discussion</h2><p>This section
      describes what you must do to use events, beginning with a simple event
      that writes a row to a table at regular intervals. 
      </p><p>Begin with a table to hold the mark rows. It contains a <code>TIMESTAMP</code> column
      (which MySQL will initialize automatically) and a column to store a
      message:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">mark_log</code>
<code class="p">(</code>
  <code class="n">id</code> <code class="nb">INT</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="n">AUTO_INCREMENT</code> <code class="k">PRIMARY</code> <code class="k">KEY</code><code class="p">,</code>
  <code class="n">ts</code>      <code class="k">TIMESTAMP</code> <code class="k">DEFAULT</code> <code class="k">CURRENT_TIMESTAMP</code> <code class="k">ON</code> <code class="k">UPDATE</code> <code class="k">CURRENT_TIMESTAMP</code><code class="p">,</code>
  <code class="n">message</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">100</code><code class="p">)</code>
<code class="p">);</code></pre><p>Our logging event will write a string to a new row. To set it up,
      use a <code>CREATE</code> <code>EVENT</code> statement:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="n">EVENT</code> <code class="n">mark_insert</code>
<code class="k">ON</code> <code class="n">SCHEDULE</code> <code class="k">EVERY</code> <code class="mi">5</code> <code class="k">MINUTE</code>
<code class="k">DO</code> <code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">mark_log</code> <code class="p">(</code><code class="n">message</code><code class="p">)</code> <code class="k">VALUES</code><code class="p">(</code><code class="s1">'-- MARK --'</code><code class="p">);</code></pre><p>The <code>mark_insert</code> event causes
      the message <code>'-- MARK --'</code> to be logged
      to the <code>mark_log</code> table every five
      minutes. Use a different interval for more or less frequent
      logging.</p><p>This event is simple and its body contains only a single SQL
      statement. For an event body that executes multiple statements, use
      <code>BEGIN</code> … <code>END</code> compound-statement syntax. In that case, if you use <span class="command"><em>mysql</em></span> to create the event, change the
      statement delimiter while you define the event, as discussed in <a data-type="xref" href="#nch-routines-routines-compound-statement">Recipe 11.1</a>.</p><p>At this point, you should wait a few minutes and then select the
      contents of the <code>mark_log</code> table to
      verify that new rows are being written on schedule. However, if this is
      the first event that you’ve set up, you might find that the table
      remains empty no matter how long you wait:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * FROM mark_log;</code></strong>
Empty set (0.00 sec)</pre><p>If that’s the case, very likely the event scheduler isn’t running
      (which was its default state until version 8.0). Check the scheduler
      status by examining the value of the <code>event_scheduler</code> system variable:</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW VARIABLES LIKE 'event_scheduler';</code></strong>
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| event_scheduler | OFF   |
+-----------------+-------+</pre><p>To enable the scheduler interactively if it’s not running, execute
      the following statement (which requires the <code>SYSTEM_VARIABLES_ADMIN</code> or, before version 8.0, <code>SUPER</code>
      privilege):</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SET</code> <code class="k">GLOBAL</code> <code class="n">event_scheduler</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code></pre><p>That statement enables the scheduler, but only until the server
      shuts down. To start the scheduler each time the server starts, enable
      the system variable in your <em class="filename">my.cnf</em> option
      file:</p><pre data-type="programlisting">[mysqld]
event_scheduler=1</pre><p>
        Or use <code>SET PERSIST</code> statement to store the modified value of the variable:
      </p><pre data-type="programlisting" data-code-language="sql"><code class="k">SET</code> <code class="n">PERSIST</code> <code class="n">event_scheduler</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code></pre><p>When the event scheduler is enabled, the <code>mark_insert</code> event eventually creates many rows
      in the table. There are several ways that you can affect event execution
      to prevent the table from growing forever:</p><ul><li><p>Drop the event:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">DROP</code> <code class="n">EVENT</code> <code class="n">mark_insert</code><code class="p">;</code></pre><p>This is the simplest way to stop an event from occurring. But
          if you want it to resume later, you must re-create it.</p></li><li><p>Disable event execution:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">ALTER</code> <code class="n">EVENT</code> <code class="n">mark_insert</code> <code class="n">DISABLE</code><code class="p">;</code></pre><p>That leaves the event in place but causes it not to run until
          you reactivate it:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">ALTER</code> <code class="n">EVENT</code> <code class="n">mark_insert</code> <code class="n">ENABLE</code><code class="p">;</code></pre></li><li><p>Let the event continue to run, but set up another event that
          <q>expires</q> old <code>mark_log</code> rows. This second event need not
          run so frequently (perhaps once a day). Its body should remove rows
          older than a given threshold. The following definition creates an event that
          deletes rows that are more than two days old:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="n">EVENT</code> <code class="n">mark_expire</code>
<code class="k">ON</code> <code class="n">SCHEDULE</code> <code class="k">EVERY</code> <code class="mi">1</code> <code class="k">DAY</code>
<code class="k">DO</code> <code class="k">DELETE</code> <code class="k">FROM</code> <code class="n">mark_log</code> <code class="k">WHERE</code> <code class="n">ts</code> <code class="o">&lt;</code> <code class="n">NOW</code><code class="p">()</code> <code class="o">-</code> <code class="nb">INTERVAL</code> <code class="mi">2</code> <code class="k">DAY</code><code class="p">;</code></pre><p>If you adopt this strategy, you have cooperating events: one
          event that adds rows to the <code>mark_log</code> table, and another that removes
          them. They act together to maintain a log that contains recent rows
          but does not become too large.</p></li></ul></div></section></div></section><section data-type="sect1" data-pdf-bookmark="11.6 Writing Helper Routines for Executing Dynamic SQL"><div class="sect1" id="nch-routines-dynamic-sql-helpers"><h1>11.6 Writing Helper Routines for Executing Dynamic SQL</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820365727088"><h2>Problem</h2><p>Prepared SQL statements enable you to construct and execute SQL statements on the
      fly, but you want to run them in one step instead of executing three commands: <code>PREPARE</code>, <code>EXECUTE</code> and <code>DEALLOCATE PREPARE</code>.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820365725056"><h2>Solution</h2><p>Write a helper procedure that handles the drudgery.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820365724176"><h2>Discussion</h2><p>Using a prepared SQL statement involves three steps: preparation,
      execution, and deallocation. For example, if the <code>@tbl_name</code> and <code>@val</code> variables hold a table name and a value
      to insert into the table, you can create the table and insert the value
      like this:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SET</code> <code class="o">@</code><code class="n">stmt</code> <code class="o">=</code> <code class="n">CONCAT</code><code class="p">(</code><code class="s1">'CREATE TABLE '</code><code class="p">,</code><code class="o">@</code><code class="n">tbl_name</code><code class="p">,</code><code class="s1">' (i INT)'</code><code class="p">);</code>
<code class="k">PREPARE</code> <code class="n">stmt</code> <code class="k">FROM</code> <code class="o">@</code><code class="n">stmt</code><code class="p">;</code>
<code class="k">EXECUTE</code> <code class="n">stmt</code><code class="p">;</code>
<code class="k">DEALLOCATE</code> <code class="k">PREPARE</code> <code class="n">stmt</code><code class="p">;</code>
<code class="k">SET</code> <code class="o">@</code><code class="n">stmt</code> <code class="o">=</code> <code class="n">CONCAT</code><code class="p">(</code><code class="s1">'INSERT INTO '</code><code class="p">,</code><code class="o">@</code><code class="n">tbl_name</code><code class="p">,</code><code class="s1">' (i) VALUES('</code><code class="p">,</code><code class="o">@</code><code class="n">val</code><code class="p">,</code><code class="s1">')'</code><code class="p">);</code>
<code class="k">PREPARE</code> <code class="n">stmt</code> <code class="k">FROM</code> <code class="o">@</code><code class="n">stmt</code><code class="p">;</code>
<code class="k">EXECUTE</code> <code class="n">stmt</code><code class="p">;</code>
<code class="k">DEALLOCATE</code> <code class="k">PREPARE</code> <code class="n">stmt</code><code class="p">;</code></pre><p>To ease the burden of going through those steps for each
      dynamically created statement, use a helper routine that, given a
      statement string, prepares, executes, and deallocates it:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">PROCEDURE</code> <code class="n">exec_stmt</code><code class="p">(</code><code class="n">stmt_str</code> <code class="nb">TEXT</code><code class="p">)</code>
<code class="k">BEGIN</code>
  <code class="k">SET</code> <code class="o">@</code><code class="n">_stmt_str</code> <code class="o">=</code> <code class="n">stmt_str</code><code class="p">;</code>
  <code class="k">PREPARE</code> <code class="n">stmt</code> <code class="k">FROM</code> <code class="o">@</code><code class="n">_stmt_str</code><code class="p">;</code>
  <code class="k">EXECUTE</code> <code class="n">stmt</code><code class="p">;</code>
  <code class="k">DEALLOCATE</code> <code class="k">PREPARE</code> <code class="n">stmt</code><code class="p">;</code>
<code class="k">END</code><code class="p">;</code></pre><p>The <code>exec_stmt()</code> routine enables
      the same statements to be executed much more <span class="keep-together">simply:</span></p><pre data-type="programlisting" data-code-language="sql"><code class="k">CALL</code> <code class="n">exec_stmt</code><code class="p">(</code><code class="n">CONCAT</code><code class="p">(</code><code class="s1">'CREATE TABLE '</code><code class="p">,</code><code class="o">@</code><code class="n">tbl_name</code><code class="p">,</code><code class="s1">' (i INT)'</code><code class="p">));</code>
<code class="k">CALL</code> <code class="n">exec_stmt</code><code class="p">(</code><code class="n">CONCAT</code><code class="p">(</code><code class="s1">'INSERT INTO '</code><code class="p">,</code><code class="o">@</code><code class="n">tbl_name</code><code class="p">,</code><code class="s1">' (i) VALUES('</code><code class="p">,</code><code class="o">@</code><code class="n">val</code><code class="p">,</code><code class="s1">')'</code><code class="p">));</code></pre><p><code>exec_stmt()</code> uses an
      intermediary user-defined variable, <code>@_stmt_str</code>, because <code>PREPARE</code> accepts a statement only when
      specified using either a literal string or a user-defined variable. A
      statement stored in a routine parameter does not work. (Avoid using
      <code>@_stmt_str</code> for your own purposes, at
      least if you expect its value to persist across <code>exec_stmt()</code> invocations.)</p><p>Now, how about making it safer to construct statement strings that
      incorporate values that might come from external sources, such as
      web-form input or command-line arguments? Such information cannot be
      trusted and should be treated as a potential SQL injection attack
      vector:</p><ul><li><p>The <code>QUOTE()</code> function is
          available for quoting data values.</p></li><li><p>There is no corresponding function for identifiers, but it’s
          easy to write one that doubles internal backticks and adds a backtick at the
          beginning and end:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">FUNCTION</code> <code class="n">quote_identifier</code><code class="p">(</code><code class="n">id</code> <code class="nb">TEXT</code><code class="p">)</code>
<code class="k">RETURNS</code> <code class="nb">TEXT</code> <code class="k">DETERMINISTIC</code>
<code class="k">RETURN</code> <code class="n">CONCAT</code><code class="p">(</code><code class="s1">'`'</code><code class="p">,</code><code class="k">REPLACE</code><code class="p">(</code><code class="n">id</code><code class="p">,</code><code class="s1">'`'</code><code class="p">,</code><code class="s1">'``'</code><code class="p">),</code><code class="s1">'`'</code><code class="p">);</code></pre></li></ul><p>Revising the preceding example to ensure the safety of data values
      and identifiers, we have:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SET</code> <code class="o">@</code><code class="n">tbl_name</code> <code class="o">=</code> <code class="n">quote_identifier</code><code class="p">(</code><code class="o">@</code><code class="n">tbl_name</code><code class="p">);</code>
<code class="k">SET</code> <code class="o">@</code><code class="n">val</code> <code class="o">=</code> <code class="n">QUOTE</code><code class="p">(</code><code class="o">@</code><code class="n">val</code><code class="p">);</code>
<code class="k">CALL</code> <code class="n">exec_stmt</code><code class="p">(</code><code class="n">CONCAT</code><code class="p">(</code><code class="s1">'CREATE TABLE '</code><code class="p">,</code><code class="o">@</code><code class="n">tbl_name</code><code class="p">,</code><code class="s1">' (i INT)'</code><code class="p">));</code>
<code class="k">CALL</code> <code class="n">exec_stmt</code><code class="p">(</code><code class="n">CONCAT</code><code class="p">(</code><code class="s1">'INSERT INTO '</code><code class="p">,</code><code class="o">@</code><code class="n">tbl_name</code><code class="p">,</code><code class="s1">' (i) VALUES('</code><code class="p">,</code><code class="o">@</code><code class="n">val</code><code class="p">,</code><code class="s1">')'</code><code class="p">));</code></pre><p>A constraint on use of <code>exec_stmt()</code> is that not all SQL statements are
      eligible for execution as prepared statements. See the <em>MySQL
      Reference Manual</em> for the limitations.</p><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="nch-routines-routines-handlers"><h5>Handling Errors Within Stored Programs</h5><p>Within stored programs, you can catch errors or exceptional conditions
    using condition handlers. A handler activates under specific
    circumstances, causing the code associated with it to execute. The code
    takes suitable action such as performing cleanup processing or setting a
    variable that can be tested elsewhere in the program to determine whether
    the condition occurred. A handler might even ignore an error if it occurs
    under certain permitted conditions and you want to catch it rather than
    have it terminate your program.</p><p>Stored programs can also produce their own errors or warnings to
    signal that something has gone wrong.</p><p><a data-type="xref" href="#nch-routines-routines-end-of-data">Recipe 11.7</a>, <a data-type="xref" href="#nch-routines-routines-catching-errors">Recipe 11.8</a>, and <a data-type="xref" href="#nch-routines-routines-raising-errors">Recipe 11.9</a> illustrate these techniques. For complete
    lists of available condition names, SQLSTATE values, and error codes,
    consult the <em>MySQL Reference Manual.</em></p></div></aside></div></section></div></section><section data-type="sect1" data-pdf-bookmark="11.7 Detecting No More Rows Conditions Using Condition Handlers"><div class="sect1" id="nch-routines-routines-end-of-data"><h1>11.7 Detecting <q>No More Rows</q> Conditions Using Condition Handlers</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820365411920"><h2>Problem</h2><p>You want to detect <q>no more rows</q> conditions and gracefully handle them instead of interrupting the stored program execution.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820365410384"><h2>Solution</h2><p>One common use of condition handlers is to detect <q>no more
      rows</q> conditions. To process a query result one row at a time,
      use a cursor-based fetch loop in conjunction with a condition handler
      that catches the end-of-data condition. The technique has these
      essential elements:</p><ul><li><p>A cursor associated with a <code>SELECT</code> statement that reads rows. Open the cursor to start reading, and
          close it to stop.</p></li><li><p>A condition handler that activates when the cursor reaches the
          end of the result set and raises an end-of-data condition (<code>NOT</code> <code>FOUND</code>). We used a similar handler in <a data-type="xref" href="#nch-routines-routines-encapsulation">Recipe 11.2</a>.</p></li><li><p>A variable that indicates loop termination. Initialize the
          variable to <code>FALSE</code>, then set it to
          <code>TRUE</code> within the condition handler
          when the end-of-data condition occurs.</p></li><li><p>A loop that uses the cursor to fetch each row and exits when
          the loop-termination variable becomes <code>TRUE</code>.</p></li></ul></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820365366304"><h2>Discussion</h2><p>The following example implements a fetch loop that processes the                                                           _ch
      <code>states</code> table row by row to calculate
      the total US population:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code><code> </code><code class="k">PROCEDURE</code><code> </code><code class="n">us_population</code><code class="p">(</code><code class="p">)</code><code>
</code><code class="k">BEGIN</code><code>
  </code><code class="k">DECLARE</code><code> </code><code class="n">done</code><code> </code><code class="nb">BOOLEAN</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="k">FALSE</code><code class="p">;</code><code> </code><a class="co" id="co_nch-routines-routines-end-of-data_done_co" href="#callout_nch-routines-routines-end-of-data_done_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
  </code><code class="k">DECLARE</code><code> </code><code class="n">state_pop</code><code class="p">,</code><code> </code><code class="n">total_pop</code><code> </code><code class="nb">BIGINT</code><code> </code><code class="k">DEFAULT</code><code> </code><code class="mi">0</code><code class="p">;</code><code>
  </code><code class="k">DECLARE</code><code> </code><code class="n">cur</code><code> </code><code class="k">CURSOR</code><code> </code><code class="k">FOR</code><code> </code><code class="k">SELECT</code><code> </code><code class="n">pop</code><code> </code><code class="k">FROM</code><code> </code><code class="n">states</code><code class="p">;</code><code> </code><a class="co" id="co_nch-routines-routines-end-of-data_query_co" href="#callout_nch-routines-routines-end-of-data_query_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
  </code><code class="k">DECLARE</code><code> </code><code class="k">CONTINUE</code><code> </code><code class="k">HANDLER</code><code> </code><code class="k">FOR</code><code> </code><code class="k">NOT</code><code> </code><code class="k">FOUND</code><code> </code><code class="k">SET</code><code> </code><code class="n">done</code><code> </code><code class="o">=</code><code> </code><code class="k">TRUE</code><code class="p">;</code><code> </code><a class="co" id="co_nch-routines-routines-end-of-data_ch_co" href="#callout_nch-routines-routines-end-of-data_ch_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>

  </code><code class="k">OPEN</code><code> </code><code class="n">cur</code><code class="p">;</code><code>
  </code><code class="n">fetch_loop</code><code class="p">:</code><code> </code><code class="n">LOOP</code><code>
    </code><code class="k">FETCH</code><code> </code><code class="n">cur</code><code> </code><code class="k">INTO</code><code> </code><code class="n">state_pop</code><code class="p">;</code><code> </code><a class="co" id="co_nch-routines-routines-end-of-data_fetch_co" href="#callout_nch-routines-routines-end-of-data_fetch_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
    </code><code class="n">IF</code><code> </code><code class="n">done</code><code> </code><code class="k">THEN</code><code> </code><a class="co" id="co_nch-routines-routines-end-of-data_leave_co" href="#callout_nch-routines-routines-end-of-data_leave_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
      </code><code class="n">LEAVE</code><code> </code><code class="n">fetch_loop</code><code class="p">;</code><code>
    </code><code class="k">END</code><code> </code><code class="n">IF</code><code class="p">;</code><code>
    </code><code class="k">SET</code><code> </code><code class="n">total_pop</code><code> </code><code class="o">=</code><code> </code><code class="n">total_pop</code><code> </code><code class="o">+</code><code> </code><code class="n">state_pop</code><code class="p">;</code><code> </code><a class="co" id="co_nch-routines-routines-end-of-data_total_co" href="#callout_nch-routines-routines-end-of-data_total_co"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
  </code><code class="k">END</code><code> </code><code class="n">LOOP</code><code class="p">;</code><code>
  </code><code class="k">CLOSE</code><code> </code><code class="n">cur</code><code class="p">;</code><code>
  </code><code class="k">SELECT</code><code> </code><code class="n">total_pop</code><code> </code><code class="k">AS</code><code> </code><code class="s1">'Total U.S. Population'</code><code class="p">;</code><code> </code><a class="co" id="co_nch-routines-routines-end-of-data_result_co" href="#callout_nch-routines-routines-end-of-data_result_co"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code>
</code><code class="k">END</code><code class="p">;</code></pre><dl class="calloutlist"><dt><a class="co" id="callout_nch-routines-routines-end-of-data_done_co" href="#co_nch-routines-routines-end-of-data_done_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>Variable <code>done</code> is used as a flag that checked when the procedure decides if it needs to continue executing or stop.</p></dd><dt><a class="co" id="callout_nch-routines-routines-end-of-data_query_co" href="#co_nch-routines-routines-end-of-data_query_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>The cursor for the query that fetching each state population.</p></dd><dt><a class="co" id="callout_nch-routines-routines-end-of-data_ch_co" href="#co_nch-routines-routines-end-of-data_ch_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>When MySQL encounters not found error it stops execution. To prevent this we declared a <code>CONTINUE</code> handler that sets value of the variable <code>done</code> to value <code>TRUE</code>.</p></dd><dt><a class="co" id="callout_nch-routines-routines-end-of-data_fetch_co" href="#co_nch-routines-routines-end-of-data_fetch_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt><dd><p>We fetch each state population into variable <code>state_pop</code>.</p></dd><dt><a class="co" id="callout_nch-routines-routines-end-of-data_leave_co" href="#co_nch-routines-routines-end-of-data_leave_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt><dd><p>If variable <code>done</code> is not true we continue the loop, otherwise leaving it.</p></dd><dt><a class="co" id="callout_nch-routines-routines-end-of-data_total_co" href="#co_nch-routines-routines-end-of-data_total_co"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt><dd><p>We add value of the variable <code>state_pop</code> to the variable <code>total_pop</code> that represents population of the United States.</p></dd><dt><a class="co" id="callout_nch-routines-routines-end-of-data_result_co" href="#co_nch-routines-routines-end-of-data_result_co"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt><dd><p>After leaving the loop we print value of the variable <code>total_pop</code>.</p></dd></dl><p>While this example is mostly for the illustration because in any
      real application you’d use an aggregate function to calculate the total.
      But that also gives us an independent check on whether the fetch loop
      calculates the correct value:</p><pre data-type="programlisting">mysql&gt; <strong><code>CALL us_population();</code></strong>
+-----------------------+
| Total U.S. Population |
+-----------------------+
|             331223695 |
+-----------------------+
mysql&gt; <strong><code>SELECT SUM(pop) AS 'Total U.S. Population' FROM states;</code></strong>
+-----------------------+
| Total U.S. Population |
+-----------------------+
|             331223695 |
+-----------------------+</pre><p><code>NOT</code> <code>FOUND</code> handlers are also useful for checking
      whether <code>SELECT</code> … <code>INTO</code> <em><code>var_name</code></em>
      statements return any results. <a data-type="xref" href="#nch-routines-routines-encapsulation">Recipe 11.2</a> shows an
      example.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="11.8 Catching and Ignoring Errors with Condition Handlers"><div class="sect1" id="nch-routines-routines-catching-errors"><h1>11.8 Catching and Ignoring Errors with Condition Handlers</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820365173120"><h2>Problem</h2><p>
          You want to ignore benign errors or prevent errors from nonexistent users.
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820365172064"><h2>Solution</h2><p>
          Use a condition handler to catch and handle the error you want to ignore.
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820365171008"><h2>Discussion</h2><p>If you consider an error benign, you can use a handler to ignore
      it. For example, many <code>DROP</code> statements
      in MySQL have an <code>IF</code> <code>EXISTS</code> clause to suppress errors if objects to be dropped do not exist.
      But some <code>DROP</code> statements have no such
      clause and thus no way to suppress errors. <code>DROP</code> <code>INDEX</code> is one of these:</p><pre data-type="programlisting">mysql&gt; <strong><code>DROP INDEX bad_index ON limbs;</code></strong>
ERROR 1091 (42000): Can't DROP 'bad_index'; check that column/key exists</pre><p>To prevent errors from occurring for nonexistent users, invoke
      <code>DROP</code> <code>INDEX</code> within a stored procedure that catches
      code 1091 and ignores it:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">PROCEDURE</code> <code class="n">drop_index</code><code class="p">(</code><code class="n">index_name</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">64</code><code class="p">),</code> <code class="k">table_name</code> <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">64</code><code class="p">))</code>
<code class="k">BEGIN</code>
  <code class="k">DECLARE</code> <code class="k">CONTINUE</code> <code class="k">HANDLER</code> <code class="k">FOR</code> <code class="mi">1091</code>
    <code class="k">SELECT</code> <code class="n">CONCAT</code><code class="p">(</code><code class="s1">'Unknown index: '</code><code class="p">,</code> <code class="n">index_name</code><code class="p">)</code> <code class="k">AS</code> <code class="n">Message</code><code class="p">;</code>
  <code class="k">CALL</code> <code class="n">exec_stmt</code><code class="p">(</code><code class="n">CONCAT</code><code class="p">(</code><code class="s1">'DROP INDEX '</code><code class="p">,</code> <code class="n">index_name</code><code class="p">,</code> <code class="s1">' ON '</code><code class="p">,</code> <code class="k">table_name</code><code class="p">));</code>
<code class="k">END</code><code class="p">;</code></pre><p>If the index does not exist, <code>drop_index()</code> writes a message within the
      condition handler, but no error occurs:</p><pre data-type="programlisting">mysql&gt; <strong><code>CALL drop_index('bad_index', 'limbs');</code></strong>
+--------------------------+
| Message                  |
+--------------------------+
| Unknown index: bad_index |
+--------------------------+</pre><p>To ignore the error completely, write the handler using an
      empty <code>BEGIN</code> … <code>END</code> block:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">DECLARE</code> <code class="k">CONTINUE</code> <code class="k">HANDLER</code> <code class="k">FOR</code> <code class="mi">1091</code> <code class="k">BEGIN</code> <code class="k">END</code><code class="p">;</code></pre><p>Another approach is to generate a warning, as demonstrated in the
      next recipe.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="11.9 Raising Errors and Warnings"><div class="sect1" id="nch-routines-routines-raising-errors"><h1>11.9 Raising Errors and Warnings</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820365067216"><h2>Problem</h2><p>
          You want to raise error for statements, valid for MySQL but not valid for the application you are working on.
        </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820365066336"><h2>Solution</h2><p>To produce your own errors within a stored program when you detect something awry,
      use the <code>SIGNAL</code> statement. </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820365064960"><h2>Discussion</h2><p>This
      recipe shows some examples, and <a data-type="xref" href="#nch-routines-preprocess-reject">Recipe 11.11</a> demonstrates use of <code>SIGNAL</code> within a trigger to reject bad
      data.</p><p>Suppose that an application performs a division operation for
      which you expect that the divisor will never be zero, and that you want
      to produce an error otherwise. You might expect that since version 5.7.4 SQL Mode <code>ERROR_FOR_DIVISION_BY_ZERO</code> is enabled by default you will get this behavior automatically. But that works only within the
      context of data-modification operations such as <code>INSERT</code>. In other contexts, division by zero
      produces only a warning:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT @@sql_mode\G</code></strong>
*************************** 1. row ***************************
@@sql_mode: ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,↩
            ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION
1 row in set (0,00 sec)
	
mysql&gt; <strong><code>SELECT 1/0;</code></strong>
+------+
| 1/0  |
+------+
| NULL |
+------+
1 row in set, 1 warning (0.00 sec)
mysql&gt; <strong><code>SHOW WARNINGS;</code></strong>
+---------+------+---------------+
| Level   | Code | Message       |
+---------+------+---------------+
| Warning | 1365 | Division by 0 |
+---------+------+---------------+</pre><p>To ensure a divide-by-zero error in any context, write a function
      that performs the division but checks the divisor first and uses
      <code>SIGNAL</code> to raise an error if the
      <q>can’t happen</q> condition occurs:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">FUNCTION</code> <code class="n">divide</code><code class="p">(</code><code class="n">numerator</code> <code class="nb">FLOAT</code><code class="p">,</code> <code class="n">divisor</code> <code class="nb">FLOAT</code><code class="p">)</code>
<code class="k">RETURNS</code> <code class="nb">FLOAT</code> <code class="k">DETERMINISTIC</code>
<code class="k">BEGIN</code>
  <code class="n">IF</code> <code class="n">divisor</code> <code class="o">=</code> <code class="mi">0</code> <code class="k">THEN</code>
    <code class="n">SIGNAL</code> <code class="k">SQLSTATE</code> <code class="s1">'22012'</code>
           <code class="k">SET</code> <code class="n">MYSQL_ERRNO</code> <code class="o">=</code> <code class="mi">1365</code><code class="p">,</code> <code class="k">MESSAGE_TEXT</code> <code class="o">=</code> <code class="s1">'unexpected 0 divisor'</code><code class="p">;</code>
  <code class="k">END</code> <code class="n">IF</code><code class="p">;</code>
  <code class="k">RETURN</code> <code class="n">numerator</code> <code class="o">/</code> <code class="n">divisor</code><code class="p">;</code>
<code class="k">END</code><code class="p">;</code></pre><p>Test the function in a nonmodification context to verify that it
      produces an error:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT divide(1,0);</code></strong>
ERROR 1365 (22012): unexpected 0 divisor</pre><p>The <code>SIGNAL</code> statement specifies
      a SQLSTATE value plus an optional <code>SET</code>
      clause you can use to assign values to error attributes. <code>MYSQL_ERRNO</code> corresponds to the MySQL-specific
      error code, and <code>MESSAGE_TEXT</code> is a
      string of your choice.</p><p><code>SIGNAL</code> can also raise warning
      conditions, not just errors. The following routine, <code>drop_user_warn()</code>, is similar to the <code>drop_user()</code> routine shown earlier, but instead
      of printing a message for nonexistent users, it generates a warning that
      can be displayed with <code>SHOW</code> <code>WARNINGS</code>. SQLSTATE value <code>01000</code> and error 1642 indicate a user-defined
      unhandled exception, which the routine signals along with an appropriate
      message:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">PROCEDURE</code> <code class="n">drop_user_warn</code><code class="p">(</code><code class="k">user</code> <code class="nb">TEXT</code><code class="p">,</code> <code class="k">host</code> <code class="nb">TEXT</code><code class="p">)</code>
<code class="k">BEGIN</code>
  <code class="k">DECLARE</code> <code class="n">account</code> <code class="nb">TEXT</code><code class="p">;</code>
  <code class="k">DECLARE</code> <code class="k">CONTINUE</code> <code class="k">HANDLER</code> <code class="k">FOR</code> <code class="mi">1396</code>
  <code class="k">BEGIN</code>
    <code class="k">DECLARE</code> <code class="n">msg</code> <code class="nb">TEXT</code><code class="p">;</code>
    <code class="k">SET</code> <code class="n">msg</code> <code class="o">=</code> <code class="n">CONCAT</code><code class="p">(</code><code class="s1">'Unknown user: '</code><code class="p">,</code> <code class="n">account</code><code class="p">);</code>
    <code class="n">SIGNAL</code> <code class="k">SQLSTATE</code> <code class="s1">'01000'</code> <code class="k">SET</code> <code class="n">MYSQL_ERRNO</code> <code class="o">=</code> <code class="mi">1642</code><code class="p">,</code> <code class="k">MESSAGE_TEXT</code> <code class="o">=</code> <code class="n">msg</code><code class="p">;</code>
  <code class="k">END</code><code class="p">;</code>
  <code class="k">SET</code> <code class="n">account</code> <code class="o">=</code> <code class="n">CONCAT</code><code class="p">(</code><code class="n">QUOTE</code><code class="p">(</code><code class="k">user</code><code class="p">),</code><code class="s1">'@'</code><code class="p">,</code><code class="n">QUOTE</code><code class="p">(</code><code class="k">host</code><code class="p">));</code>
  <code class="k">CALL</code> <code class="n">exec_stmt</code><code class="p">(</code><code class="n">CONCAT</code><code class="p">(</code><code class="s1">'DROP USER '</code><code class="p">,</code><code class="n">account</code><code class="p">));</code>
<code class="k">END</code><code class="p">;</code></pre><p>Give it a test:</p><pre data-type="programlisting">mysql&gt; <strong><code>CALL drop_user_warn('bad-user','localhost');</code></strong>
Query OK, 0 rows affected, 1 warning (0.00 sec)
mysql&gt; <strong><code>SHOW WARNINGS;</code></strong>
+---------+------+--------------------------------------+
| Level   | Code | Message                              |
+---------+------+--------------------------------------+
| Warning | 1642 | Unknown user: 'bad-user'@'localhost' |
+---------+------+--------------------------------------+</pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="11.10 Logging Errors by Accessing the Diagnostic Area"><div class="sect1" id="nch-routines-routines-diagnostic-area"><h1>11.10 Logging Errors by Accessing the Diagnostic Area</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820364838496"><h2>Problem</h2><p>
        You want to log all errors that your stored routine hits.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820364837504"><h2>Solution</h2><p>
        Access the diagnostic area using the <span class="command"><em>GET DIAGNOSTICS</em></span>statement. Then, save the error information into variables, and use them to log errors..
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820364835760"><h2>Discussion</h2><p>
        You may not only gracefully handle errors inside the stored routine but also log them, so you can examine them and fix your application to prevent similar ones in the future.
      </p><p>
        Table <code>movies_actors_link</code> is used in the recipe <a data-type="xref" href="ch16.xhtml#nch-multi-multi-many-to-many">Recipe 16.6</a> to demonstrate many-to-many relationship. It contains <code>id</code> of the movies and movie actors that are stored in tables <code>movies</code> and <code>movies_actors</code>. Both columns are defined with the property <code>NOT NULL</code>. Each combination of <code>movie_id</code> and <code>actor_id</code> should be unique. While <a data-type="xref" href="ch16.xhtml#nch-multi-multi-many-to-many">Recipe 16.6</a> does not define foreign keys (<a data-type="xref" href="ch16.xhtml#nch-multi-multi-fks">“Using Foreign Keys to Enforce Referential Integrity and Prevent Mismatches”</a>) we may define them, so MySQL will reject values that do not have corresponding entries in the referenced tables.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="k">ALTER</code> <code class="k">TABLE</code> <code class="n">movies_actors_link</code> <code class="k">ADD</code> <code class="k">FOREIGN</code> <code class="k">KEY</code><code class="p">(</code><code class="n">movie_id</code><code class="p">)</code> <code class="k">REFERENCES</code> <code class="n">movies</code><code class="p">(</code><code class="n">id</code><code class="p">);</code>
<code class="k">ALTER</code> <code class="k">TABLE</code> <code class="n">movies_actors_link</code> <code class="k">ADD</code> <code class="k">FOREIGN</code> <code class="k">KEY</code><code class="p">(</code><code class="n">actor_id</code><code class="p">)</code> <code class="k">REFERENCES</code> <code class="n">actors</code><code class="p">(</code><code class="n">id</code><code class="p">);</code></pre><p>
        When we execute a statement in the <span class="command"><em>mysql</em></span> client.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">movies_actors_link</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="mi">7</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">ERROR</code><code> </code><code class="mi">1452</code><code> </code><code class="p">(</code><code class="mi">23000</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">Cannot</code><code> </code><code class="k">add</code><code> </code><code class="k">or</code><code> </code><code class="k">update</code><code> </code><code class="n">a</code><code> </code><code class="n">child</code><code> </code><code class="k">row</code><code class="p">:</code><code> </code><code class="n">a</code><code> </code><code class="k">foreign</code><code> </code><code class="k">key</code><code> </code><code class="k">constraint</code><code> 
</code><code class="n">fails</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">cookbook</code><code class="o">`</code><code class="p">.</code><code class="o">`</code><code class="n">movies_actors_link</code><code class="o">`</code><code class="p">,</code><code> </code><code class="k">CONSTRAINT</code><code> </code><code class="o">`</code><code class="n">movies_actors_link_ibfk_1</code><code class="o">`</code><code> 
</code><code class="k">FOREIGN</code><code> </code><code class="k">KEY</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">movie_id</code><code class="o">`</code><code class="p">)</code><code> </code><code class="k">REFERENCES</code><code> </code><code class="o">`</code><code class="n">movies</code><code class="o">`</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">id</code><code class="o">`</code><code class="p">)</code><code class="p">)</code></pre><p>
        Additionally, MySQL provides access to the diagnostic area, so you can store values from it in the user-defined variables. Use command <span class="command"><em>GET DIAGNOSTICS</em></span> to access the diagnostic area.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">GET</code><code> </code><code class="k">DIAGNOSTICS</code><code> </code><code class="n">CONDITION</code><code> </code><code class="mi">1</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="o">@</code><code class="n">err_number</code><code> </code><code class="o">=</code><code> </code><code class="n">MYSQL_ERRNO</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="o">@</code><code class="n">err_sqlstate</code><code> </code><code class="o">=</code><code> </code><code class="k">RETURNED_SQLSTATE</code><code class="p">,</code></strong><code>
    </code><code class="o">-</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="o">@</code><code class="n">err_message</code><code> </code><code class="o">=</code><code> </code><code class="k">MESSAGE_TEXT</code><code class="p">;</code></strong><code>
</code><code class="n">Query</code><code> </code><code class="n">OK</code><code class="p">,</code><code> </code><code class="mi">0</code><code> </code><code class="k">rows</code><code> </code><code class="n">affected</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">01</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        Clause <code>CONDITION</code> specifies the condition number. Our query returned only one condition, therefore we used number 1. If a query returns multiple conditions diagnostic area would contain data for each of conditions. It could happen, for example, if a query produces multiple warnings.
      </p><p>
        To access data, retrieved by the <span class="command"><em>GET DIAGNOSTICS</em></span>, simply select values of the user-defined variables.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">@</code><code class="n">err_number</code><code class="p">,</code><code> </code><code class="o">@</code><code class="n">err_sqlstate</code><code class="p">,</code><code> </code><code class="o">@</code><code class="n">err_message</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
  </code><code class="o">@</code><code class="n">err_number</code><code class="p">:</code><code> </code><code class="mi">1452</code><code>
</code><code class="o">@</code><code class="n">err_sqlstate</code><code class="p">:</code><code> </code><code class="mi">23000</code><code>
 </code><code class="o">@</code><code class="n">err_message</code><code class="p">:</code><code> </code><code class="n">Cannot</code><code> </code><code class="k">add</code><code> </code><code class="k">or</code><code> </code><code class="k">update</code><code> </code><code class="n">a</code><code> </code><code class="n">child</code><code> </code><code class="k">row</code><code class="p">:</code><code> </code><code class="n">a</code><code> </code><code class="k">foreign</code><code> </code><code class="k">key</code><code> </code><code class="k">constraint</code><code> 
               </code><code class="n">fails</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">cookbook</code><code class="o">`</code><code class="p">.</code><code class="o">`</code><code class="n">movies_actors_link</code><code class="o">`</code><code class="p">,</code><code> 
               </code><code class="k">CONSTRAINT</code><code> </code><code class="o">`</code><code class="n">movies_actors_link_ibfk_1</code><code class="o">`</code><code> 
               </code><code class="k">FOREIGN</code><code> </code><code class="k">KEY</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">movie_id</code><code class="o">`</code><code class="p">)</code><code> </code><code class="k">REFERENCES</code><code> </code><code class="o">`</code><code class="n">movies</code><code class="o">`</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">id</code><code class="o">`</code><code class="p">)</code><code class="p">)</code><code>
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
        To record all such errors that users make when insert data into the table <code>movies_actors_link</code> create a procedure that takes two arguments: <code>movie_id</code> and <code>actor_id</code> and store error information in the log table.
      </p><p>
        First create the table that will store information about errors.
        </p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="o">`</code><code class="n">movies_actors_log</code><code class="o">`</code> <code class="p">(</code>
  <code class="o">`</code><code class="n">err_ts</code><code class="o">`</code> <code class="k">timestamp</code> <code class="k">NULL</code> <code class="k">DEFAULT</code> <code class="k">CURRENT_TIMESTAMP</code> <code class="k">ON</code> <code class="k">UPDATE</code> <code class="k">CURRENT_TIMESTAMP</code><code class="p">,</code>
  <code class="o">`</code><code class="n">err_number</code><code class="o">`</code> <code class="nb">int</code> <code class="k">DEFAULT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="o">`</code><code class="n">err_sqlstate</code><code class="o">`</code> <code class="nb">char</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code> <code class="k">DEFAULT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="o">`</code><code class="n">err_message</code><code class="o">`</code> <code class="nb">TEXT</code> <code class="k">DEFAULT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="o">`</code><code class="n">movie_id</code><code class="o">`</code> <code class="nb">int</code> <code class="n">unsigned</code> <code class="k">DEFAULT</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="o">`</code><code class="n">actor_id</code><code class="o">`</code> <code class="nb">int</code> <code class="n">unsigned</code> <code class="k">DEFAULT</code> <code class="k">NULL</code>
<code class="p">);</code></pre><p>
      </p><p>
        Then define the procedure that will insert a row into the table <code>movies_actors_link</code> and in case of an error will log details into the table <code>movies_actors_log</code>.
      </p><p>
      </p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code><code> </code><code class="k">PROCEDURE</code><code> </code><code class="n">insert_movies_actors_link</code><code class="p">(</code><code class="n">movie</code><code> </code><code class="nb">INT</code><code class="p">,</code><code> </code><code class="n">actor</code><code> </code><code class="nb">INT</code><code class="p">)</code><code>
</code><code class="k">BEGIN</code><code>
  </code><code class="k">DECLARE</code><code> </code><code class="n">e_number</code><code> </code><code class="nb">INT</code><code class="p">;</code><code> </code><a class="co" id="co_nch-routines-routines-diagnostic-area-gd_declare_co" href="#callout_nch-routines-routines-diagnostic-area-gd_declare_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
  </code><code class="k">DECLARE</code><code> </code><code class="n">e_sqlstate</code><code> </code><code class="nb">CHAR</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code><code class="p">;</code><code>
  </code><code class="k">DECLARE</code><code> </code><code class="n">e_message</code><code> </code><code class="nb">TEXT</code><code class="p">;</code><code>

  </code><code class="k">DECLARE</code><code> </code><code class="k">CONTINUE</code><code> </code><code class="k">HANDLER</code><code> </code><code class="k">FOR</code><code> </code><code class="k">SQLEXCEPTION</code><code> </code><a class="co" id="co_nch-routines-routines-diagnostic-area-gd_handler_co" href="#callout_nch-routines-routines-diagnostic-area-gd_handler_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>
    </code><code class="k">BEGIN</code><code>
      </code><code class="k">GET</code><code> </code><code class="k">DIAGNOSTICS</code><code> </code><code class="n">CONDITION</code><code> </code><code class="mi">1</code><code>
        </code><code class="n">e_number</code><code> </code><code class="o">=</code><code> </code><code class="n">MYSQL_ERRNO</code><code class="p">,</code><code> </code><a class="co" id="co_nch-routines-routines-diagnostic-area-gd_store_co" href="#callout_nch-routines-routines-diagnostic-area-gd_store_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
        </code><code class="n">e_sqlstate</code><code> </code><code class="o">=</code><code> </code><code class="k">RETURNED_SQLSTATE</code><code class="p">,</code><code>
        </code><code class="n">e_message</code><code> </code><code class="o">=</code><code> </code><code class="k">MESSAGE_TEXT</code><code class="p">;</code><code>
      </code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">movies_actors_log</code><code class="p">(</code><code class="n">err_number</code><code class="p">,</code><code> </code><code class="n">err_sqlstate</code><code class="p">,</code><code> </code><code class="n">err_message</code><code class="p">,</code><code>  </code><a class="co" id="co_nch-routines-routines-diagnostic-area-gd_log_co" href="#callout_nch-routines-routines-diagnostic-area-gd_log_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
                                    </code><code class="n">movie_id</code><code class="p">,</code><code> </code><code class="n">actor_id</code><code class="p">)</code><code>
        </code><code class="k">VALUES</code><code class="p">(</code><code class="n">e_number</code><code class="p">,</code><code> </code><code class="n">e_sqlstate</code><code class="p">,</code><code> </code><code class="n">e_message</code><code class="p">,</code><code> </code><code class="n">movie</code><code class="p">,</code><code> </code><code class="n">actor</code><code class="p">)</code><code class="p">;</code><code>
      </code><code class="n">RESIGNAL</code><code class="p">;</code><code> </code><a class="co" id="co_nch-routines-routines-diagnostic-area-gd_resignal_co" href="#callout_nch-routines-routines-diagnostic-area-gd_resignal_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
    </code><code class="k">END</code><code class="p">;</code><code>

  </code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">movies_actors_link</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="n">movie</code><code class="p">,</code><code> </code><code class="n">actor</code><code class="p">)</code><code class="p">;</code><code> </code><a class="co" id="co_nch-routines-routines-diagnostic-area-gd_insert_co" href="#callout_nch-routines-routines-diagnostic-area-gd_insert_co"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
</code><code class="k">END</code></pre><p>

       </p><dl class="calloutlist"><dt><a class="co" id="callout_nch-routines-routines-diagnostic-area-gd_declare_co" href="#co_nch-routines-routines-diagnostic-area-gd_declare_co"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt><dd><p>Declare variables that will store error number, SQLSTATE and the error message.</p></dd><dt><a class="co" id="callout_nch-routines-routines-diagnostic-area-gd_handler_co" href="#co_nch-routines-routines-diagnostic-area-gd_handler_co"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt><dd><p>Create a <code>CONTINUE HANDLER</code> for <code>SQLEXCEPTION</code>, so the procedure will first log the error, then continue executing.</p></dd><dt><a class="co" id="callout_nch-routines-routines-diagnostic-area-gd_store_co" href="#co_nch-routines-routines-diagnostic-area-gd_store_co"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt><dd><p>Store diagnostic information in the variables.</p></dd><dt><a class="co" id="callout_nch-routines-routines-diagnostic-area-gd_log_co" href="#co_nch-routines-routines-diagnostic-area-gd_log_co"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt><dd><p>Log details about the error into the table <code>movies_actors_log</code>.</p></dd><dt><a class="co" id="callout_nch-routines-routines-diagnostic-area-gd_resignal_co" href="#co_nch-routines-routines-diagnostic-area-gd_resignal_co"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt><dd><p>Use command <span class="command"><em>RESIGNAL</em></span> to raise the error for the client that called the procedure.</p></dd><dt><a class="co" id="callout_nch-routines-routines-diagnostic-area-gd_insert_co" href="#co_nch-routines-routines-diagnostic-area-gd_insert_co"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt><dd><p>The <span class="command"><em>INSERT</em></span> into the table <code>movies_actors_link</code> that will either succeeds or raise an error.</p></dd></dl><p>
      </p><p>
        To test the procedure call it few times with different parameters.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">CALL</code><code> </code><code class="n">insert_movies_actors_link</code><code class="p">(</code><code class="mi">7</code><code class="p">,</code><code> </code><code class="mi">11</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">ERROR</code><code> </code><code class="mi">1452</code><code> </code><code class="p">(</code><code class="mi">23000</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">Cannot</code><code> </code><code class="k">add</code><code> </code><code class="k">or</code><code> </code><code class="k">update</code><code> </code><code class="n">a</code><code> </code><code class="n">child</code><code> </code><code class="k">row</code><code class="p">:</code><code> </code><code class="n">a</code><code> </code><code class="k">foreign</code><code> </code><code class="k">key</code><code> </code><code class="k">constraint</code><code> 
</code><code class="n">fails</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">cookbook</code><code class="o">`</code><code class="p">.</code><code class="o">`</code><code class="n">movies_actors_link</code><code class="o">`</code><code class="p">,</code><code> </code><code class="k">CONSTRAINT</code><code> </code><code class="o">`</code><code class="n">movies_actors_link_ibfk_1</code><code class="o">`</code><code> 
</code><code class="k">FOREIGN</code><code> </code><code class="k">KEY</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">movie_id</code><code class="o">`</code><code class="p">)</code><code> </code><code class="k">REFERENCES</code><code> </code><code class="o">`</code><code class="n">movies</code><code class="o">`</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">id</code><code class="o">`</code><code class="p">)</code><code class="p">)</code><code>
</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">CALL</code><code> </code><code class="n">insert_movies_actors_link</code><code class="p">(</code><code class="mi">6</code><code class="p">,</code><code> </code><code class="mi">11</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">ERROR</code><code> </code><code class="mi">1452</code><code> </code><code class="p">(</code><code class="mi">23000</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">Cannot</code><code> </code><code class="k">add</code><code> </code><code class="k">or</code><code> </code><code class="k">update</code><code> </code><code class="n">a</code><code> </code><code class="n">child</code><code> </code><code class="k">row</code><code class="p">:</code><code> </code><code class="n">a</code><code> </code><code class="k">foreign</code><code> </code><code class="k">key</code><code> </code><code class="k">constraint</code><code> 
</code><code class="n">fails</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">cookbook</code><code class="o">`</code><code class="p">.</code><code class="o">`</code><code class="n">movies_actors_link</code><code class="o">`</code><code class="p">,</code><code> </code><code class="k">CONSTRAINT</code><code> </code><code class="o">`</code><code class="n">movies_actors_link_ibfk_2</code><code class="o">`</code><code> 
</code><code class="k">FOREIGN</code><code> </code><code class="k">KEY</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">actor_id</code><code class="o">`</code><code class="p">)</code><code> </code><code class="k">REFERENCES</code><code> </code><code class="o">`</code><code class="n">actors</code><code class="o">`</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">id</code><code class="o">`</code><code class="p">)</code><code class="p">)</code><code>
</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">CALL</code><code> </code><code class="n">insert_movies_actors_link</code><code class="p">(</code><code class="k">null</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">ERROR</code><code> </code><code class="mi">1048</code><code> </code><code class="p">(</code><code class="mi">23000</code><code class="p">)</code><code class="p">:</code><code> </code><code class="k">Column</code><code> </code><code class="s1">'movie_id'</code><code> </code><code class="n">cannot</code><code> </code><code class="n">be</code><code> </code><code class="k">null</code><code>
</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">CALL</code><code> </code><code class="n">insert_movies_actors_link</code><code class="p">(</code><code class="mi">6</code><code class="p">,</code><code> </code><code class="k">null</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">ERROR</code><code> </code><code class="mi">1048</code><code> </code><code class="p">(</code><code class="mi">23000</code><code class="p">)</code><code class="p">:</code><code> </code><code class="k">Column</code><code> </code><code class="s1">'actor_id'</code><code> </code><code class="n">cannot</code><code> </code><code class="n">be</code><code> </code><code class="k">null</code><code>
</code><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code> </code><code class="k">CALL</code><code> </code><code class="n">insert_movies_actors_link</code><code class="p">(</code><code class="mi">6</code><code class="p">,</code><code> </code><code class="mi">9</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="n">ERROR</code><code> </code><code class="mi">1062</code><code> </code><code class="p">(</code><code class="mi">23000</code><code class="p">)</code><code class="p">:</code><code> </code><code class="n">Duplicate</code><code> </code><code class="n">entry</code><code> </code><code class="s1">'6-9'</code><code> </code><code class="k">for</code><code> </code><code class="k">key</code><code> </code><code class="s1">'movies_actors_link.movie_id'</code></pre><p>
        As expected, because we used <code>RESIGNAL</code>, the procedure failed with errors. Still all the errors were logged into the table <code>movies_actors_log</code> together with the values that we tried and failed to insert and a timestamp when such a try happened.
      </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">movies_actors_log</code><code class="err">\</code><code class="k">G</code></strong><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">1</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
      </code><code class="n">err_ts</code><code class="p">:</code><code> </code><code class="mi">2021</code><code class="o">-</code><code class="mi">03</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">21</code><code class="p">:</code><code class="mi">11</code><code class="p">:</code><code class="mi">30</code><code>
  </code><code class="n">err_number</code><code class="p">:</code><code> </code><code class="mi">1452</code><code>
</code><code class="n">err_sqlstate</code><code class="p">:</code><code> </code><code class="mi">23000</code><code>
 </code><code class="n">err_message</code><code class="p">:</code><code> </code><code class="n">Cannot</code><code> </code><code class="k">add</code><code> </code><code class="k">or</code><code> </code><code class="k">update</code><code> </code><code class="n">a</code><code> </code><code class="n">child</code><code> </code><code class="k">row</code><code class="p">:</code><code> </code><code class="n">a</code><code> </code><code class="k">foreign</code><code> </code><code class="k">key</code><code> </code><code class="k">constraint</code><code> </code><code class="n">fails</code><code> 
              </code><code class="p">(</code><code class="o">`</code><code class="n">cookbook</code><code class="o">`</code><code class="p">.</code><code class="o">`</code><code class="n">movies_actors_link</code><code class="o">`</code><code class="p">,</code><code> 
              </code><code class="k">CONSTRAINT</code><code> </code><code class="o">`</code><code class="n">movies_actors_link_ibfk_1</code><code class="o">`</code><code> 
              </code><code class="k">FOREIGN</code><code> </code><code class="k">KEY</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">movie_id</code><code class="o">`</code><code class="p">)</code><code> </code><code class="k">REFERENCES</code><code> </code><code class="o">`</code><code class="n">movies</code><code class="o">`</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">id</code><code class="o">`</code><code class="p">)</code><code class="p">)</code><code>
    </code><code class="n">movie_id</code><code class="p">:</code><code> </code><code class="mi">7</code><code>
    </code><code class="n">actor_id</code><code class="p">:</code><code> </code><code class="mi">11</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">2</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
      </code><code class="n">err_ts</code><code class="p">:</code><code> </code><code class="mi">2021</code><code class="o">-</code><code class="mi">03</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">21</code><code class="p">:</code><code class="mi">11</code><code class="p">:</code><code class="mi">38</code><code>
  </code><code class="n">err_number</code><code class="p">:</code><code> </code><code class="mi">1452</code><code>
</code><code class="n">err_sqlstate</code><code class="p">:</code><code> </code><code class="mi">23000</code><code>
 </code><code class="n">err_message</code><code class="p">:</code><code> </code><code class="n">Cannot</code><code> </code><code class="k">add</code><code> </code><code class="k">or</code><code> </code><code class="k">update</code><code> </code><code class="n">a</code><code> </code><code class="n">child</code><code> </code><code class="k">row</code><code class="p">:</code><code> </code><code class="n">a</code><code> </code><code class="k">foreign</code><code> </code><code class="k">key</code><code> </code><code class="k">constraint</code><code> </code><code class="n">fails</code><code> 
              </code><code class="p">(</code><code class="o">`</code><code class="n">cookbook</code><code class="o">`</code><code class="p">.</code><code class="o">`</code><code class="n">movies_actors_link</code><code class="o">`</code><code class="p">,</code><code> 
              </code><code class="k">CONSTRAINT</code><code> </code><code class="o">`</code><code class="n">movies_actors_link_ibfk_2</code><code class="o">`</code><code> 
              </code><code class="k">FOREIGN</code><code> </code><code class="k">KEY</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">actor_id</code><code class="o">`</code><code class="p">)</code><code> </code><code class="k">REFERENCES</code><code> </code><code class="o">`</code><code class="n">actors</code><code class="o">`</code><code> </code><code class="p">(</code><code class="o">`</code><code class="n">id</code><code class="o">`</code><code class="p">)</code><code class="p">)</code><code>
    </code><code class="n">movie_id</code><code class="p">:</code><code> </code><code class="mi">6</code><code>
    </code><code class="n">actor_id</code><code class="p">:</code><code> </code><code class="mi">11</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">3</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
      </code><code class="n">err_ts</code><code class="p">:</code><code> </code><code class="mi">2021</code><code class="o">-</code><code class="mi">03</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">21</code><code class="p">:</code><code class="mi">11</code><code class="p">:</code><code class="mi">49</code><code>
  </code><code class="n">err_number</code><code class="p">:</code><code> </code><code class="mi">1048</code><code>
</code><code class="n">err_sqlstate</code><code class="p">:</code><code> </code><code class="mi">23000</code><code>
 </code><code class="n">err_message</code><code class="p">:</code><code> </code><code class="k">Column</code><code> </code><code class="s1">'movie_id'</code><code> </code><code class="n">cannot</code><code> </code><code class="n">be</code><code> </code><code class="k">null</code><code>
    </code><code class="n">movie_id</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
    </code><code class="n">actor_id</code><code class="p">:</code><code> </code><code class="mi">10</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">4</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
      </code><code class="n">err_ts</code><code class="p">:</code><code> </code><code class="mi">2021</code><code class="o">-</code><code class="mi">03</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">21</code><code class="p">:</code><code class="mi">11</code><code class="p">:</code><code class="mi">56</code><code>
  </code><code class="n">err_number</code><code class="p">:</code><code> </code><code class="mi">1048</code><code>
</code><code class="n">err_sqlstate</code><code class="p">:</code><code> </code><code class="mi">23000</code><code>
 </code><code class="n">err_message</code><code class="p">:</code><code> </code><code class="k">Column</code><code> </code><code class="s1">'actor_id'</code><code> </code><code class="n">cannot</code><code> </code><code class="n">be</code><code> </code><code class="k">null</code><code>
    </code><code class="n">movie_id</code><code class="p">:</code><code> </code><code class="mi">6</code><code>
    </code><code class="n">actor_id</code><code class="p">:</code><code> </code><code class="k">NULL</code><code>
</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code> </code><code class="mi">5</code><code class="p">.</code><code> </code><code class="k">row</code><code> </code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code class="o">*</code><code>
      </code><code class="n">err_ts</code><code class="p">:</code><code> </code><code class="mi">2021</code><code class="o">-</code><code class="mi">03</code><code class="o">-</code><code class="mi">12</code><code> </code><code class="mi">21</code><code class="p">:</code><code class="mi">12</code><code class="p">:</code><code class="mi">00</code><code>
  </code><code class="n">err_number</code><code class="p">:</code><code> </code><code class="mi">1062</code><code>
</code><code class="n">err_sqlstate</code><code class="p">:</code><code> </code><code class="mi">23000</code><code>
 </code><code class="n">err_message</code><code class="p">:</code><code> </code><code class="n">Duplicate</code><code> </code><code class="n">entry</code><code> </code><code class="s1">'6-9'</code><code> </code><code class="k">for</code><code> </code><code class="k">key</code><code> </code><code class="s1">'movies_actors_link.movie_id'</code><code>
    </code><code class="n">movie_id</code><code class="p">:</code><code> </code><code class="mi">6</code><code>
    </code><code class="n">actor_id</code><code class="p">:</code><code> </code><code class="mi">9</code><code>
</code><code class="mi">5</code><code> </code><code class="k">rows</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820364835296"><h2>See Also</h2><p>For additional information about diagnostic area,
      see <a href="https://dev.mysql.com/doc/refman/8.0/en/get-diagnostics.html">GET DIAGNOSTICS Statement</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="11.11 Using Triggers to Preprocess or Reject Data"><div class="sect1" id="nch-routines-preprocess-reject"><h1>11.11 Using Triggers to Preprocess or Reject Data</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820363758464"><h2>Problem</h2><p>There are conditions you want to check for data entered into a table, but you
      don’t want to write the validation logic for every <code>INSERT</code>.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820363757104"><h2>Solution</h2><p>Centralize the input-testing logic into a <code>BEFORE</code>
      <code>INSERT</code> trigger.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820361789952"><h2>Discussion</h2><p>You can use triggers to perform several types of input
      checks:</p><ul><li><p>Reject bad data by raising a signal. This gives you access to
          stored program logic for more latitude in checking values than is
          possible with static constraints such as <code>NOT</code> <code>NULL</code>.</p></li><li><p>Preprocess values and modify them, if you won’t want to reject
          them outright. For example, map out-of-range values to be in range
          or sanitize values to put them in canonical form, if you permit
          entry of close variants.</p></li></ul><p>Suppose that you have a table of contact information such as name,
      state of residence, email address, and website URL:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">contact_info</code>
<code class="p">(</code>
  <code class="n">id</code>     <code class="nb">INT</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="n">AUTO_INCREMENT</code><code class="p">,</code>
  <code class="n">name</code>   <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">30</code><code class="p">),</code>   <code class="o">#</code> <code class="n">name</code> <code class="k">of</code> <code class="n">person</code>
  <code class="n">state</code>  <code class="nb">CHAR</code><code class="p">(</code><code class="mi">2</code><code class="p">),</code>       <code class="o">#</code> <code class="n">state</code> <code class="k">of</code> <code class="n">residence</code>
  <code class="n">email</code>  <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">50</code><code class="p">),</code>   <code class="o">#</code> <code class="n">email</code> <code class="n">address</code>
  <code class="n">url</code>    <code class="nb">VARCHAR</code><code class="p">(</code><code class="mi">255</code><code class="p">),</code>  <code class="o">#</code> <code class="n">web</code> <code class="n">address</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code> <code class="p">(</code><code class="n">id</code><code class="p">)</code>
<code class="p">);</code></pre><p>For entry of new rows, you want to enforce constraints or perform
      preprocessing as follows:</p><ul><li><p>State of residence values are two-letter US state codes, valid
          only if present in the <code>states</code>
          table. (In this case, you could declare the column as an <code>ENUM</code> with 50 members, so it’s more likely
          you’d use this lookup-table technique with columns for which the set
          of valid values is arbitrarily large or changes over time.)</p></li><li><p>Email address values must contain an <code>@</code> character to be valid.</p></li><li><p>For website URLs, strip any leading <code>http://</code> or <code>https://</code> to save space.</p></li></ul><p>To handle these requirements, create a <code>BEFORE</code> <code>INSERT</code> trigger:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">TRIGGER</code> <code class="n">bi_contact_info</code> <code class="k">BEFORE</code> <code class="k">INSERT</code> <code class="k">ON</code> <code class="n">contact_info</code>
<code class="k">FOR</code> <code class="k">EACH</code> <code class="k">ROW</code>
<code class="k">BEGIN</code>
  <code class="n">IF</code> <code class="p">(</code><code class="k">SELECT</code> <code class="k">COUNT</code><code class="p">(</code><code class="o">*</code><code class="p">)</code> <code class="k">FROM</code> <code class="n">states</code> <code class="k">WHERE</code> <code class="n">abbrev</code> <code class="o">=</code> <code class="k">NEW</code><code class="p">.</code><code class="n">state</code><code class="p">)</code> <code class="o">=</code> <code class="mi">0</code> <code class="k">THEN</code>
    <code class="n">SIGNAL</code> <code class="k">SQLSTATE</code> <code class="s1">'HY000'</code>
           <code class="k">SET</code> <code class="n">MYSQL_ERRNO</code> <code class="o">=</code> <code class="mi">1525</code><code class="p">,</code> <code class="k">MESSAGE_TEXT</code> <code class="o">=</code> <code class="s1">'invalid state code'</code><code class="p">;</code>
  <code class="k">END</code> <code class="n">IF</code><code class="p">;</code>
  <code class="n">IF</code> <code class="n">INSTR</code><code class="p">(</code><code class="k">NEW</code><code class="p">.</code><code class="n">email</code><code class="p">,</code><code class="s1">'@'</code><code class="p">)</code> <code class="o">=</code> <code class="mi">0</code> <code class="k">THEN</code>
    <code class="n">SIGNAL</code> <code class="k">SQLSTATE</code> <code class="s1">'HY000'</code>
           <code class="k">SET</code> <code class="n">MYSQL_ERRNO</code> <code class="o">=</code> <code class="mi">1525</code><code class="p">,</code> <code class="k">MESSAGE_TEXT</code> <code class="o">=</code> <code class="s1">'invalid email address'</code><code class="p">;</code>
  <code class="k">END</code> <code class="n">IF</code><code class="p">;</code>
  <code class="k">SET</code> <code class="k">NEW</code><code class="p">.</code><code class="n">url</code> <code class="o">=</code> <code class="k">TRIM</code><code class="p">(</code><code class="k">LEADING</code> <code class="s1">'http://'</code> <code class="k">FROM</code> <code class="k">NEW</code><code class="p">.</code><code class="n">url</code><code class="p">);</code>
  <code class="k">SET</code> <code class="k">NEW</code><code class="p">.</code><code class="n">url</code> <code class="o">=</code> <code class="k">TRIM</code><code class="p">(</code><code class="k">LEADING</code> <code class="s1">'https://'</code> <code class="k">FROM</code> <code class="k">NEW</code><code class="p">.</code><code class="n">url</code><code class="p">);</code>
<code class="k">END</code><code class="p">;</code></pre><p>To also handle updates, define a <code>BEFORE</code> <code>UPDATE</code> trigger with the same body as <code>bi_contact_info</code>.</p><p>Test the trigger by executing some <code>INSERT</code> statements to verify that it accepts
      valid values, rejects bad ones, and trims URLs:</p><pre data-type="programlisting">mysql&gt; <strong><code>INSERT INTO contact_info (name,state,email,url)</code></strong>
    -&gt; <strong><code>VALUES('Jen','NY','jen@example.com','http://www.example.com');</code></strong>
mysql&gt; <strong><code>INSERT INTO contact_info (name,state,email,url)</code></strong>
    -&gt; <strong><code>VALUES('Jen','XX','jen@example.com','http://www.example.com');</code></strong>
ERROR 1525 (HY000): invalid state code
mysql&gt; <strong><code>INSERT INTO contact_info (name,state,email,url)</code></strong>
    -&gt; <strong><code>VALUES('Jen','NY','jen','http://www.example.com');</code></strong>
ERROR 1525 (HY000): invalid email address
mysql&gt; <strong><code>SELECT * FROM contact_info;</code></strong>
+----+------+-------+-----------------+-----------------+
| id | name | state | email           | url             |
+----+------+-------+-----------------+-----------------+
|  1 | Jen  | NY    | jen@example.com | www.example.com |
+----+------+-------+-----------------+-----------------+</pre></div></section></div></section></div></section></div></body></html>