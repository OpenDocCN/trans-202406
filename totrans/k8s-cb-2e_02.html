<html><head></head><body><section data-pdf-bookmark="Chapter 2. Creating a Kubernetes Cluster" data-type="chapter" epub:type="chapter"><div class="chapter" id="ch_creating_cluster">&#13;
<h1><span class="label">Chapter 2. </span>Creating a Kubernetes Cluster</h1>&#13;
&#13;
&#13;
<p>In this chapter we discuss multiple ways to set up a full-blown Kubernetes cluster. We cover low-level, standardized tooling (<code>kubeadm</code>) that also serves as the basis for other installers and show you where to find the relevant binaries for the control plane, as well as for worker nodes. We demonstrate how to write systemd unit files to supervise Kubernetes components and finally show how to set up clusters on Google Cloud Platform and Azure.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.1 Preparing a New Node for a Kubernetes Cluster" data-type="sect1"><div class="sect1" id="kubeadm_install">&#13;
<h1>2.1 Preparing a New Node for a Kubernetes Cluster</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id160">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You want to prepare a new node with all the required tooling to create a new Kubernetes cluster or add to an existing cluster.<a data-primary="clusters" data-secondary="creating" data-tertiary="preparing new node for a cluster" data-type="indexterm" id="ix_clstcrnd"/><a data-primary="nodes" data-secondary="preparing new node for cluster" data-type="indexterm" id="ix_ndprp"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id6">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>To prepare <a data-primary="Ubuntu-based host for Kubernetes cluster, preparing" data-type="indexterm" id="id505"/>an Ubuntu-based host for a Kubernetes cluster, you first need to turn on IPv4 forwarding and enable iptables to see bridged traffic:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf&#13;
overlay&#13;
br_netfilter&#13;
EOF</strong>&#13;
&#13;
$ <strong>sudo modprobe overlay</strong>&#13;
$ <strong>sudo modprobe br_netfilter</strong>&#13;
&#13;
$ <strong>cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf&#13;
net.bridge.bridge-nf-call-iptables  = 1&#13;
net.bridge.bridge-nf-call-ip6tables = 1&#13;
net.ipv4.ip_forward = 1&#13;
EOF</strong>&#13;
&#13;
$ <strong>sudo sysctl --system</strong></pre>&#13;
&#13;
<p>For <a data-primary="swap, turning off" data-type="indexterm" id="id506"/>compatibility with the <code>kubeadm</code> tool, the swap needs to be turned off on the node:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>sudo apt install cron -y</strong>&#13;
$ <strong>sudo swapoff -a</strong>&#13;
$ <strong>(sudo crontab -l 2&gt;/dev/null; echo "@reboot /sbin/swapoff -a") | sudo crontab -&#13;
|| true</strong></pre>&#13;
&#13;
<p>Cluster nodes require an implementation of the Kubernetes Container Runtime Interface (CRI). <a href="https://cri-o.io">cri-o</a> is one such implementation. <a data-primary="Kubernetes Container Runtime Interface (CRI)" data-type="indexterm" id="id507"/><a data-primary="Container Runtime Interface (CRI)" data-type="indexterm" id="id508"/><a data-primary="CRI (Container Runtime Interface)" data-type="indexterm" id="id509"/>The cri-o version should match the Kubernetes version. For example, if you are bootstrapping a Kubernetes 1.27 cluster, configure the <code>VERSION</code> variable accordingly:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>VERSION="1.27"</strong>&#13;
$ <strong>OS="xUbuntu_22.04"</strong>&#13;
&#13;
$ <strong>cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:&#13;
stable.list&#13;
deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:&#13;
/stable/$OS/ /&#13;
EOF</strong>&#13;
&#13;
$ <strong>cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:&#13;
stable:cri-o:$VERSION.list&#13;
deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:&#13;
/stable:/cri-o:/$VERSION/$OS/ /&#13;
EOF</strong>&#13;
&#13;
$ <strong>curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:&#13;
/stable:/cri-o:/$VERSION/$OS/Release.key | \&#13;
    sudo apt-key add -</strong>&#13;
$ <strong>curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:&#13;
/stable/$OS/Release.key | \&#13;
    sudo apt-key add -</strong>&#13;
&#13;
$ <strong>sudo apt-get update</strong>&#13;
&#13;
$ <strong>sudo apt-get install cri-o cri-o-runc cri-tools -y</strong></pre>&#13;
&#13;
<p>Then reload <a data-primary="systemd" data-type="indexterm" id="id510"/>the systemd configurations and enable cri-o:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>sudo systemctl daemon-reload</strong>&#13;
$ <strong>sudo systemctl enable crio --now</strong></pre>&#13;
&#13;
<p>The <code>kubeadm</code> tool is required to bootstrap a Kubernetes cluster from scratch as well as to join an existing cluster.<a data-primary="kubeadm" data-type="indexterm" id="id511"/> Enable its software repository with this:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list&#13;
deb [signed-by=/etc/apt/keyrings/k8s-archive-keyring.gpg]&#13;
https://apt.kubernetes.io/&#13;
kubernetes-xenial main&#13;
EOF</strong>&#13;
&#13;
$ <strong>sudo apt-get install -y apt-transport-https ca-certificates curl</strong>&#13;
$ <strong>sudo curl -fsSLo /etc/apt/keyrings/k8s-archive-keyring.gpg \&#13;
    https://dl.k8s.io/apt/doc/apt-key.gpg</strong>&#13;
&#13;
$ <strong>sudo apt-get update</strong></pre>&#13;
&#13;
<p>Now you can install all the tools required to bootstrap a Kubernetes cluster node. <a data-primary="kubelet" data-secondary="installing" data-type="indexterm" id="id512"/><a data-primary="kubectl" data-secondary="installing" data-type="indexterm" id="id513"/><a data-primary="CLI (command-line interface)" data-secondary="kubeadm CLI, installing" data-type="indexterm" id="id514"/>You will need the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>The <code>kubelet</code> binary</p>&#13;
</li>&#13;
<li>&#13;
<p>The <code>kubeadm</code> CLI</p>&#13;
</li>&#13;
<li>&#13;
<p>The <code>kubectl</code> client</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Run this command to install them:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>sudo apt-get install -y kubelet kubeadm kubectl</strong></pre>&#13;
&#13;
<p>Then mark these packages as held back, which will prevent them from being automatically upgraded:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>sudo apt-mark hold kubelet kubeadm kubectl</strong></pre>&#13;
&#13;
<p>Your Ubuntu host is now ready to be part of a Kubernetes cluster.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id7">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p><code>kubeadm</code> is a setup tool that provides <code>kubeadm init</code> and <code>kubeadm join</code>. <code>kubeadm init</code> is used to bootstrap a Kubernetes control-plane node, while <code>kubeadm join</code> is used to bootstrap a worker node and join it to the cluster. In essence, <code>kubeadm</code> provides the actions necessary to get a minimum viable cluster up and running. <code>kubelet</code> is the <em>node agent</em> that runs on each node.<a data-primary="kubeadm join command" data-type="indexterm" id="id515"/><a data-primary="kubeadm init command" data-type="indexterm" id="id516"/><a data-primary="node agent" data-type="indexterm" id="id517"/><a data-primary="container runtimes" data-type="indexterm" id="id518"/><a data-primary="Docker Engine" data-type="indexterm" id="id519"/></p>&#13;
&#13;
<p>In addition to cri-o, other container runtimes worth investigating are <a href="https://oreil.ly/M1kDx">containerd</a>, <a href="https://oreil.ly/P5_l_">Docker Engine</a>, and <a href="https://oreil.ly/BEWaG">Mirantis Container Runtime</a>.<a data-primary="clusters" data-secondary="creating" data-startref="ix_clstcrnd" data-tertiary="preparing new node for a cluster" data-type="indexterm" id="id520"/><a data-primary="nodes" data-secondary="preparing new node for a cluster" data-startref="ix_ndprp" data-type="indexterm" id="id521"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.2 Bootstrapping a Kubernetes Control-Plane Node" data-type="sect1"><div class="sect1" id="kube_control_plane">&#13;
<h1>2.2 Bootstrapping a Kubernetes Control-Plane Node</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id161">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You have initialized an Ubuntu host for Kubernetes (see <a data-type="xref" href="#kubeadm_install">Recipe 2.1</a>) and now need to bootstrap a new Kubernetes control-plane node.<a data-primary="clusters" data-secondary="creating" data-tertiary="bootstrapping new control-plane node" data-type="indexterm" id="ix_clscrbootnd"/><a data-primary="nodes" data-secondary="bootstrapping new control-plane node" data-type="indexterm" id="ix_ndboot"/><a data-primary="control plane" data-secondary="bootstrapping new control-plane node" data-type="indexterm" id="ix_ctrlplnd"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id162">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>With the <code>kubeadm</code> binary installed, you are ready to start bootstrapping your Kubernetes cluster. Initialize the control plane on the node with the following:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>NODENAME=$(hostname -s)</strong>&#13;
$ <strong>IPADDR=$(ip route get 8.8.8.8 | sed -n 's/.*src \([^\ ]*\).*/\1/p')</strong>&#13;
$ <strong>POD_CIDR=192.168.0.0/16</strong></pre>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>The control-plane node should have a minimum of two vCPUs and 2 GB RAM.</p>&#13;
</div>&#13;
&#13;
<p>Now initialize <a data-primary="kubeadm" data-secondary="initializing new control-plane node" data-type="indexterm" id="id522"/>the control-plane node using <code>kubeadm</code>:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>sudo kubeadm init --apiserver-advertise-address=$IPADDR \&#13;
    --apiserver-cert-extra-sans=$IPADDR  \&#13;
    --pod-network-cidr=$POD_CIDR \&#13;
    --node-name $NODENAME \&#13;
    --ignore-preflight-errors Swap</strong>&#13;
[init] Using Kubernetes version: v1.27.2&#13;
[preflight] Running pre-flight checks&#13;
[preflight] Pulling images required for setting up a Kubernetes cluster&#13;
...</pre>&#13;
&#13;
<p>The output of the <code>init</code> command contains the configuration for setting up <code>kubectl</code> to talk to your cluster. <a data-primary="kubectl" data-secondary="configuration and health check of new cluster component" data-type="indexterm" id="id523"/>Once <code>kubectl</code> has been configured, you can verify the cluster component health status using the following command:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl get --raw='/readyz?verbose'</strong></pre>&#13;
&#13;
<p>To get the cluster information, use:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl cluster-info</strong></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id8">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>User workloads are not scheduled to execute on the control-plane node.<a data-primary="user workloads on control-plane node" data-type="indexterm" id="id524"/><a data-primary="tainting control-plane node" data-type="indexterm" id="id525"/> If you are creating an experimental single-node cluster, then you would need to taint the control-plane node to schedule user workloads on the control-plane node:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl taint nodes --all node-role.kubernetes.io/control-plane-</strong></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="id526">&#13;
<h2>See Also</h2>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/q9nwI">Creating a cluster with <code>kubeadm</code></a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.3 Installing a Container Network Add-on for &#10;Cluster Networking" data-type="sect1"><div class="sect1" id="kube_cni">&#13;
<h1>2.3 Installing a Container Network Add-on for &#13;
<span class="keep-together">Cluster Networking</span></h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id9">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You have bootstrapped a Kubernetes control-plane node (see <a data-type="xref" href="#kube_control_plane">Recipe 2.2</a>) and now need to install a pod network add-on so that pods can communicate with each other.<a data-primary="clusters" data-secondary="creating" data-startref="ix_clscrbootnd" data-tertiary="bootstrapping new control-plane node" data-type="indexterm" id="id527"/><a data-primary="nodes" data-secondary="bootstrapping new control-plane node" data-startref="ix_ndboot" data-type="indexterm" id="id528"/><a data-primary="control plane" data-secondary="bootstrapping new control-plane node" data-startref="ix_ctrlplnd" data-type="indexterm" id="id529"/><a data-primary="networking, cluster, installing network add-on for" data-type="indexterm" id="id530"/><a data-primary="clusters" data-secondary="creating" data-tertiary="installing container network add-on plugin" data-type="indexterm" id="id531"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id10">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>You can <a data-primary="Calico network add-on" data-type="indexterm" id="id532"/>install the Calico network add-on with the following command on the control-plane node:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/&#13;
v3.26.1/manifests/calico.yaml</strong></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id11">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>You must use a Container Network Interface (CNI) add-on that is compatible with your cluster and that suits your needs. There are a number of add-ons that implement the CNI. <a data-primary="add-ons implementing CNI" data-type="indexterm" id="id533"/><a data-primary="Container Network Interface (CNI)" data-type="indexterm" id="id534"/><a data-primary="CNI (Container Network Interface)" data-type="indexterm" id="id535"/>Take a look at the nonexhaustive list of <a href="https://oreil.ly/HosU6">available add-ons in the Kubernetes documentation</a>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.4 Adding Worker Nodes to a Kubernetes Cluster" data-type="sect1"><div class="sect1" id="kube_worker">&#13;
<h1>2.4 Adding Worker Nodes to a Kubernetes Cluster</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id163">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You have initialized your Kubernetes control-plane node (see <a data-type="xref" href="#kube_control_plane">Recipe 2.2</a>) and installed a CNI add-on (see <a data-type="xref" href="#kube_cni">Recipe 2.3</a>), and now you want to add worker nodes to your cluster.<a data-primary="worker nodes" data-secondary="adding to a cluster" data-type="indexterm" id="id536"/><a data-primary="clusters" data-secondary="creating" data-tertiary="adding worker nodes" data-type="indexterm" id="id537"/><a data-primary="nodes" data-secondary="adding worker nodes to a cluster" data-type="indexterm" id="id538"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id12">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>With the Ubuntu host initialized for Kubernetes, as<a data-primary="kubeadm join command" data-type="indexterm" id="id539"/> shown in <a data-type="xref" href="#kubeadm_install">Recipe 2.1</a>, execute the following command on the control-plane node to display the cluster <code>join</code> command:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubeadm token create --print-join-command</strong></pre>&#13;
&#13;
<p>Now, execute the <code>join</code> command on the worker node:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>sudo kubeadm join --token <em>&lt;token&gt;</em></strong></pre>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>The worker node should have a minimum of one vCPU and 2 GB RAM.</p>&#13;
</div>&#13;
&#13;
<p>Head back to your control-plane node terminal session and you will see your  &#13;
<span class="keep-together">nodes join:</span></p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl get nodes</strong>&#13;
NAME     STATUS   ROLES           AGE   VERSION&#13;
master   Ready    control-plane   28m   v1.27.2&#13;
worker   Ready    &lt;none&gt;          10s   v1.27.2&#13;
</pre>&#13;
&#13;
<p>You can repeat these steps to add more worker nodes to the Kubernetes cluster.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id164">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>Worker nodes are where your workloads run. When your cluster starts running out of resources, you will begin noticing the <em>Pending</em> status of new pods. At this point you should consider adding more resources to the cluster by adding more worker nodes.<a data-primary="pods" data-secondary="Pending status of new pods" data-type="indexterm" id="id540"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.5 Deploying the Kubernetes Dashboard" data-type="sect1"><div class="sect1" id="kubernetes_dashboard">&#13;
<h1>2.5 Deploying the Kubernetes Dashboard</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id165">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You have created a Kubernetes cluster, and now you want to create, view, and manage containerized workloads on the cluster using a user interface.<a data-primary="deployments" data-secondary="deploying Kubernetes dashboard" data-type="indexterm" id="id541"/><a data-primary="clusters" data-secondary="creating" data-tertiary="deploying Kubernetes dashboard" data-type="indexterm" id="id542"/><a data-primary="dashboard" data-secondary="deploying Kubernetes dashboard on cluster" data-type="indexterm" id="id543"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id166">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>Use the <a href="https://oreil.ly/n7WQw">Kubernetes dashboard</a>, which is a web-based user interface to deploy containerized applications to a Kubernetes cluster and to manage the cluster resources.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>If you’re using Minikube, you can install the Kubernetes <a data-primary="Minikube" data-secondary="enabling dashboard add-on" data-type="indexterm" id="id544"/>dashboard simply by enabling the <code>dashboard</code> add-on:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>minikube addons enable dashboard</strong>&#13;
</pre>&#13;
</div>&#13;
&#13;
<p>To deploy the v2.7.0 Kubernetes dashboard, do this:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/&#13;
v2.7.0/aio/deploy/recommended.yaml</strong>&#13;
</pre>&#13;
&#13;
<p>Then verify that the deployment is ready:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl get deployment kubernetes-dashboard -n kubernetes-dashboard</strong>&#13;
NAME                   READY   UP-TO-DATE   AVAILABLE   AGE&#13;
kubernetes-dashboard   1/1     1            1           44s&#13;
</pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.6 Accessing the Kubernetes Dashboard" data-type="sect1"><div class="sect1" id="accessing_kubernetes_dashboard">&#13;
<h1>2.6 Accessing the Kubernetes Dashboard</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id167">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You have installed the Kubernetes dashboard (see <a data-type="xref" href="#kubernetes_dashboard">Recipe 2.5</a>) on your cluster, and you want to access the dashboard from a web browser.<a data-primary="clusters" data-secondary="creating" data-tertiary="accessing Kubernetes dashboard" data-type="indexterm" id="ix_clscrdshbacc"/><a data-primary="dashboard" data-secondary="accessing Kubernetes dashboard" data-type="indexterm" id="ix_dshbdacc"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id168">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>You need to create a <a href="https://oreil.ly/pXErB"><code>ServiceAccount</code></a> with privileges to administer the cluster. <a data-primary="service accounts" data-secondary="creating ServiceAccount object for Kubernetes dashboard" data-type="indexterm" id="id545"/>Create a file named <em>sa.yaml</em> with the following contents:</p>&#13;
&#13;
<pre data-code-language="yaml" data-type="programlisting"><code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ServiceAccount</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">admin-user</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kubernetes-dashboard</code><code class="w"/>&#13;
<code class="nn">---</code><code class="w"/>&#13;
<code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">rbac.authorization.k8s.io/v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ClusterRoleBinding</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">admin-user</code><code class="w"/>&#13;
<code class="nt">roleRef</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">apiGroup</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">rbac.authorization.k8s.io</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ClusterRole</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">cluster-admin</code><code class="w"/>&#13;
<code class="nt">subjects</code><code class="p">:</code><code class="w"/>&#13;
<code class="p-Indicator">-</code><code class="w"> </code><code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">ServiceAccount</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">admin-user</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kubernetes-dashboard</code><code class="w"/></pre>&#13;
&#13;
<p>Create the <code>ServiceAccount</code> with this:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl apply -f sa.yaml</strong>&#13;
</pre>&#13;
&#13;
<p>To access the Kubernetes dashboard, you need to create an authentication token associated with this account. <a data-primary="authentication" data-secondary="creating authentication token for dashboard ServiceAccount" data-type="indexterm" id="id546"/>Save the token printed in the output of the following command:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl -n kubernetes-dashboard create token admin-user</strong>&#13;
eyJhbGciOiJSUzI1NiIsImtpZCI6...&#13;
</pre>&#13;
&#13;
<p>Since the Kubernetes dashboard is a cluster-local service, you need to set up a proxy connection to the cluster:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl proxy</strong>&#13;
</pre>&#13;
&#13;
<p>By visiting the site <a class="bare" href="http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/workloads?namespace=_all"><em class="hyperlink">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/workloads?namespace=_all</em></a> you are now able to open the Kubernetes dashboard and authenticate yourself using the authentication token created earlier.</p>&#13;
&#13;
<p>In the UI that opens in your browser, you will see the page depicted in <a data-type="xref" href="#dashboard_create">Figure 2-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="dashboard_create">&#13;
<img alt="Snapshot of the dashboard application create view" src="assets/kcb2_0201.png"/>&#13;
<h6><span class="label">Figure 2-1. </span>Snapshot of the dashboard application create view</h6>&#13;
</div></figure>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>If you are<a data-primary="Minikube" data-secondary="accessing Kubernetes dashboard" data-type="indexterm" id="id547"/> using Minikube, all you need to do is:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>minikube dashboard</strong>&#13;
</pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id13">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>To create an application, click the plus sign (+) at the top-right corner, select the “Create from form” tab, give the application a name, and specify the container image you want to use. <a data-primary="container images" data-secondary="specifying for application creation" data-type="indexterm" id="id548"/><a data-primary="deployments" data-type="indexterm" id="id549"/>Then click the Deploy button and you will be presented with a new view that shows deployments, pods, and replica sets.  <a data-primary="resources" data-secondary="resource types in Kubernetes" data-type="indexterm" id="id550"/>In Kubernetes there are dozens of important resource types, such as deployments, pods, replica sets, services, and so on, that we will explore in greater detail in the rest of the book.<a data-primary="Redis" data-secondary="dashboard overview with Redis application" data-type="indexterm" id="id551"/><a data-primary="pods" data-type="indexterm" id="id552"/><a data-primary="replica sets" data-type="indexterm" id="id553"/><a data-primary="services" data-type="indexterm" id="id554"/></p>&#13;
&#13;
<p>The snapshot in <a data-type="xref" href="#redis-dashboard">Figure 2-2</a> presents a typical dashboard view after having created a single application using the Redis container.</p>&#13;
&#13;
<figure><div class="figure" id="redis-dashboard">&#13;
<img alt="A dashboard overview with a Redis application" src="assets/kcb2_0202.png"/>&#13;
<h6><span class="label">Figure 2-2. </span>A dashboard overview with a Redis application</h6>&#13;
</div></figure>&#13;
&#13;
<p>If you go back to a terminal session and use the command-line client, you will see the same thing:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl get all</strong>&#13;
NAME                         READY   STATUS    RESTARTS   AGE&#13;
pod/redis-584fd7c758-vwl52   1/1     Running   0          5m9s&#13;
&#13;
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE&#13;
service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   19m&#13;
&#13;
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE&#13;
deployment.apps/redis   1/1     1            1           5m9s&#13;
&#13;
NAME                               DESIRED   CURRENT   READY   AGE&#13;
replicaset.apps/redis-584fd7c758   1         1         1       5m9s&#13;
</pre>&#13;
&#13;
<p>Your Redis pod will be running the Redis server, as the following logs show:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl logs redis-3215927958-4x88v</strong>&#13;
...&#13;
1:C 25 Aug 2023 06:17:23.934 * oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo&#13;
1:C 25 Aug 2023 06:17:23.934 * Redis version=7.2.0, bits=64, commit=00000000,&#13;
modified=0, pid=1, just started&#13;
1:C 25 Aug 2023 06:17:23.934 # Warning: no config file specified, using the&#13;
default config. In order to specify a config file use redis-server&#13;
/path/to/redis.conf&#13;
1:M 25 Aug 2023 06:17:23.934 * monotonic clock: POSIX clock_gettime&#13;
1:M 25 Aug 2023 06:17:23.934 * Running mode=standalone, port=6379.&#13;
1:M 25 Aug 2023 06:17:23.935 * Server initialized&#13;
1:M 25 Aug 2023 06:17:23.935 * Ready to accept connections tcp</pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.7 Deploying the Kubernetes Metrics Server" data-type="sect1"><div class="sect1" id="metrics_server">&#13;
<h1>2.7 Deploying the Kubernetes Metrics Server</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id169">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You have deployed the Kubernetes dashboard (see <a data-type="xref" href="#kubernetes_dashboard">Recipe 2.5</a>) but don’t see the CPU and memory usage information in the dashboard.<a data-primary="clusters" data-secondary="creating" data-startref="ix_clscrdshbacc" data-tertiary="accessing Kubernetes dashboard" data-type="indexterm" id="id555"/><a data-primary="dashboard" data-secondary="accessing Kubernetes dashboard" data-startref="ix_dshbdacc" data-type="indexterm" id="id556"/><a data-primary="clusters" data-secondary="creating" data-tertiary="deploying Kubernetes Metrics Server" data-type="indexterm" id="ix_clscrMtrcSer"/><a data-primary="deployments" data-secondary="deploying Kubernetes Metrics Server" data-type="indexterm" id="ix_dplymtrser"/><a data-primary="Metrics Server" data-secondary="deploying" data-type="indexterm" id="ix_MtrcSer"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id170">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>The Kubernetes dashboard requires the <a href="https://oreil.ly/BEHwR">Kubernetes Metrics Server</a> to visualize the CPU and memory usage.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>If you are<a data-primary="Minikube" data-secondary="enabling metrics-server add-on" data-type="indexterm" id="id557"/> using Minikube, you can install the Kubernetes Metrics Server simply by enabling the <code>metrics-server</code> add-on:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>minikube addons enable metrics-server</strong>&#13;
</pre>&#13;
</div>&#13;
&#13;
<p>To deploy the latest release of the Kubernetes Metrics Server, do this:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/&#13;
latest/download/components.yaml</strong>&#13;
</pre>&#13;
&#13;
<p>Then verify that the deployment is ready:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl get deployment metrics-server -n kube-system</strong>&#13;
NAME             READY   UP-TO-DATE   AVAILABLE   AGE&#13;
metrics-server   1/1     1            1           7m27s&#13;
</pre>&#13;
&#13;
<p>If you see that the deployment is not entering the ready state, check the pod logs:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl logs -f deployment/metrics-server -n kube-system</strong>&#13;
I0707 05:06:19.537981   1 server.go:187] "Failed probe"&#13;
probe="metric-storage-ready" err="no metrics to serve"&#13;
E0707 05:06:26.395852   1 scraper.go:140] "Failed to scrape node" err="Get&#13;
\"https://192.168.64.50:10250/metrics/resource\": x509: <strong>cannot validate&#13;
certificate</strong> for 192.168.64.50 because it doesn't contain any IP SANs"&#13;
node="minikube"&#13;
</pre>&#13;
&#13;
<p>If you see the error message “cannot validate certificate,” you need to append the flag <code>--kubelet-insecure-tls</code> to the Metrics Server deployment:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl patch deployment metrics-server -n kube-system --type='json'&#13;
-p='[{"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value":&#13;
"--kubelet-insecure-tls"}]'</strong>&#13;
</pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>It can take several minutes for the Metrics Server to become available after having started it. If it is not yet in the ready state, then requests for metrics might produce errors.</p>&#13;
</div>&#13;
&#13;
<p>Once the <a data-primary="dashboard" data-secondary="nodes view" data-type="indexterm" id="id558"/>Metrics Server has started, the Kubernetes dashboard will display the CPU and memory usage statistics, as shown in <a data-type="xref" href="#dashboard_nodes">Figure 2-3</a>.</p>&#13;
&#13;
<figure><div class="figure" id="dashboard_nodes">&#13;
<img alt="Snapshot of the dashboard nodes view" src="assets/kcb2_0203.png"/>&#13;
<h6><span class="label">Figure 2-3. </span>Dashboard cluster nodes view</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id14">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The node and pod metrics <a data-primary="nodes" data-secondary="viewing metrics for" data-type="indexterm" id="id559"/><a data-primary="pods" data-secondary="viewing metrics for" data-type="indexterm" id="id560"/><a data-primary="kubectl" data-secondary="top command" data-type="indexterm" id="id561"/><a data-primary="metrics" data-secondary="viewing for nodes and pods with top command" data-type="indexterm" id="id562"/><a data-primary="top command  (kubectl)" data-type="indexterm" id="id563"/>can also be viewed in the command line using the <code>kubectl top</code> command:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl top pods -A</strong>&#13;
NAMESPACE     NAME                               CPU(cores)   MEMORY(bytes)&#13;
kube-system   coredns-5d78c9869d-5fh78           9m           9Mi&#13;
kube-system   etcd-minikube                      164m         36Mi&#13;
kube-system   kube-apiserver-minikube            322m         254Mi&#13;
kube-system   kube-controller-manager-minikube   123m         35Mi&#13;
kube-system   kube-proxy-rvl8v                   13m          12Mi&#13;
kube-system   kube-scheduler-minikube            62m          15Mi&#13;
kube-system   storage-provisioner                22m          7Mi&#13;
</pre>&#13;
&#13;
<p>Similarly, to view the node metrics, do this:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl top nodes</strong>&#13;
NAME       CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%&#13;
minikube   415m         10%    1457Mi          18%&#13;
</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="id564">&#13;
<h2>See Also</h2>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/C_O6W">Kubernetes Metrics Server GitHub repository</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/ODZCr">Resource metrics pipeline documentation</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.8 Downloading a Kubernetes Release from GitHub" data-type="sect1"><div class="sect1" id="release_download">&#13;
<h1>2.8 Downloading a Kubernetes Release from GitHub</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id171">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You want to download an official Kubernetes release instead of compiling from source.<a data-primary="clusters" data-secondary="creating" data-startref="ix_clscrMtrcSer" data-tertiary="deploying Kubernetes Metrics Server" data-type="indexterm" id="id565"/><a data-primary="Metrics Server" data-secondary="deploying" data-startref="ix_MtrcSer" data-type="indexterm" id="id566"/><a data-primary="deployments" data-secondary="deploying Kubernetes metrics server" data-startref="ix_dplymtrser" data-type="indexterm" id="id567"/><a data-primary="clusters" data-secondary="creating" data-tertiary="downloading Kubernetes release from GitHub" data-type="indexterm" id="id568"/><a data-primary="GitHub" data-secondary="downloading Kubernetes release from" data-type="indexterm" id="id569"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id15">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>The Kubernetes project publishes an archive for every release. The link to the archive can be found in the CHANGELOG file of the particular release.<a data-primary="CHANGELOG file" data-type="indexterm" id="id570"/> Go to the <em>CHANGELOG</em> folder of the <a href="https://oreil.ly/MMwRs">project page</a> and open the CHANGELOG file for the release of your choice. Within the file you will find a link to download the <em>kubernetes.tar.gz</em> file of that release.<a data-primary="kubernetes.tar.gz file" data-type="indexterm" id="id571"/></p>&#13;
&#13;
<p>For example, if you want to download the v1.28.0 release, go ahead and open <em>CHANGELOG-1.28.md</em>, and in the section titled “Downloads for v1.28.0” you will find the link to <em>kubernetes.tar.gz</em> (<em><a class="bare" href="https://dl.k8s.io/v1.28.0/kubernetes.tar.gz"><em class="hyperlink">https://dl.k8s.io/v1.28.0/kubernetes.tar.gz</em></a></em>).</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>wget https://dl.k8s.io/v1.28.0/kubernetes.tar.gz</strong></pre>&#13;
&#13;
<p>If you want to compile Kubernetes from source, see <a data-type="xref" href="ch15.html#compiling_source">Recipe 15.1</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id16">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>The CHANGELOG file also lists the <code>sha512 hash</code> of the <em>kubernetes.tar.gz</em> archive. <a data-primary="sha512 hash of kubernetes.tar.gz archive" data-type="indexterm" id="id572"/>It is recommended that you verify the integrity of the <em>kubernetes.tar.gz</em> archive to ensure that it has not been tampered with in any way. To do this, generate the <code>sha512</code> hash of the downloaded archive locally and compare it with that of the one listed in the CHANGELOG:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>sha512sum kubernetes.tar.gz</strong>&#13;
9aaf7cc004d09297dc7bbc1f0149....  kubernetes.tar.gz&#13;
</pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.9 Downloading Client and Server Binaries" data-type="sect1"><div class="sect1" id="get_binaries">&#13;
<h1>2.9 Downloading Client and Server Binaries</h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id172">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You have downloaded a release archive (see <a data-type="xref" href="#release_download">Recipe 2.8</a>), but it does not contain the actual binaries.<a data-primary="clients" data-secondary="downloading client binaries for Kubernetes release" data-type="indexterm" id="id573"/><a data-primary="servers" data-secondary="downloading server binaries for Kubernetes release" data-type="indexterm" id="id574"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id17">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>The release archive does not contain the release binaries (for the purpose of keeping the release archive small). Thus, you need to download the binaries separately.<a data-primary="get-kube-binaries.sh" data-type="indexterm" id="id575"/><a data-primary="binaries, client and server, downloading" data-type="indexterm" id="id576"/><a data-primary="clusters" data-secondary="creating" data-tertiary="downloading client and server binaries" data-type="indexterm" id="id577"/> To do so, run the <em>get-kube-binaries.sh</em> script, as shown here:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>tar -xvf kubernetes.tar.gz</strong>&#13;
$ <strong>cd kubernetes/cluster</strong>&#13;
$ <strong>./get-kube-binaries.sh</strong></pre>&#13;
&#13;
<p>Once complete, you will have the client binaries in <em>client/bin</em>:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>ls ../client/bin</strong>&#13;
kubectl		kubectl-convert</pre>&#13;
&#13;
<p>and an archive containing the server binaries in <em>server/kubernetes</em>:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>ls ../server/kubernetes</strong>&#13;
kubernetes-server-linux-amd64.tar.gz   kubernetes-manifests.tar.gz	  README&#13;
...</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id173">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>If you want to skip downloading the entire release archive and quickly download the client and server binaries, you can get them directly from <a href="https://oreil.ly/tdN0P">Download Kubernetes</a>. <a data-primary="operating systems" data-secondary="listing of Kubernetes release binaries for" data-type="indexterm" id="id578"/>On this page you will find direct links to binaries for various operating system and architecture combinations, as shown in <a data-type="xref" href="#download-k8s-com">Figure 2-4</a>.</p>&#13;
&#13;
<figure><div class="figure" id="download-k8s-com">&#13;
<img alt="Screenshot of the downloadkubernetes.com, listing binaries of the k8s v1.28.0 release for the darwin operating system" src="assets/kcb2_0204.png"/>&#13;
<h6><span class="label">Figure 2-4. </span>downloadkubernetes.com, listing binaries of the Kubernetes v1.28.0 release for the Darwin operating system</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.10 Using systemd Unit Files for Running &#10;Kubernetes Components" data-type="sect1"><div class="sect1" id="systemd_unit">&#13;
<h1>2.10 Using systemd Unit Files for Running &#13;
<span class="keep-together">Kubernetes Components</span></h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id174">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You have used Minikube (see <a data-type="xref" href="ch01.html#minikube_install">Recipe 1.2</a>) for learning and know how to bootstrap a Kubernetes cluster using <code>kubeadm</code> (see <a data-type="xref" href="#kube_control_plane">Recipe 2.2</a>), but you want to install a cluster from scratch.<a data-primary="clusters" data-secondary="creating" data-tertiary="using systemd unit files to run Kubernetes components" data-type="indexterm" id="ix_clscrsysd"/><a data-primary="systemd" data-secondary="using unit files to run Kubernetes components" data-type="indexterm" id="ix_sysd"/><a data-primary="kubelet" data-secondary="running via systemd unit files" data-type="indexterm" id="ix_kubltsysd"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id579">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>To do so, you need to run the Kubernetes components using systemd unit files. You are looking only for basic examples to run the <code>kubelet</code> via <code class="keep-together">systemd</code>.</p>&#13;
&#13;
<p>Inspecting how <code>kubeadm</code> configures the Kubernetes daemons to launch using systemd unit files helps you understand how to do it on your own. If you look closely at the <code>kubeadm</code> configuration, you will see that the <code>kubelet</code> is running on every node in your cluster, including the control-plane node.</p>&#13;
&#13;
<p>Here is an example, which you can reproduce by logging in to any node of a cluster built with <code>kubeadm</code> (see <a data-type="xref" href="#kube_control_plane">Recipe 2.2</a>):</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>systemctl status kubelet</strong>&#13;
● kubelet.service - kubelet: The Kubernetes Node Agent&#13;
     Loaded: loaded (/lib/systemd/system/kubelet.service; enabled;&#13;
     vendor preset: enabled)&#13;
    Drop-In: /etc/systemd/system/kubelet.service.d&#13;
             └─10-kubeadm.conf&#13;
     Active: active (running) since Tue 2023-05-30 04:21:29 UTC; 2h 49min ago&#13;
       Docs: https://kubernetes.io/docs/home/&#13;
   Main PID: 797 (kubelet)&#13;
      Tasks: 11 (limit: 2234)&#13;
     Memory: 40.2M&#13;
        CPU: 5min 14.792s&#13;
     CGroup: /system.slice/kubelet.service&#13;
             └─797 /usr/bin/kubelet \&#13;
                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf \&#13;
                --kubeconfig=/etc/kubernetes/kubelet.conf \&#13;
                --config=/var/lib/kubelet/config.yaml \&#13;
                --container-runtime-endpoint=unix:///var/run/crio/crio.sock \&#13;
                --pod-infra-container-image=registry.k8s.io/pause:3.9</pre>&#13;
&#13;
<p>This gives you a link to the systemd unit file in <em>/lib/systemd/system/kubelet.service</em> and its configuration in <em>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</em>.</p>&#13;
&#13;
<p>The unit file is straightforward—​it points to the <code>kubelet</code> binary installed in <em>/usr/bin</em>:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="o">[</code>Unit<code class="o">]</code><code class="w"/>&#13;
<code class="nv">Description</code><code class="o">=</code>kubelet:<code class="w"> </code>The<code class="w"> </code>Kubernetes<code class="w"> </code>Node<code class="w"> </code>Agent<code class="w"/>&#13;
<code class="nv">Documentation</code><code class="o">=</code>https://kubernetes.io/docs/home/<code class="w"/>&#13;
<code class="nv">Wants</code><code class="o">=</code>network-online.target<code class="w"/>&#13;
<code class="nv">After</code><code class="o">=</code>network-online.target<code class="w"/>&#13;
&#13;
<code class="o">[</code>Service<code class="o">]</code><code class="w"/>&#13;
<code class="nv">ExecStart</code><code class="o">=</code>/usr/bin/kubelet<code class="w"/>&#13;
<code class="nv">Restart</code><code class="o">=</code>always<code class="w"/>&#13;
<code class="nv">StartLimitInterval</code><code class="o">=</code><code class="m">0</code><code class="w"/>&#13;
<code class="nv">RestartSec</code><code class="o">=</code><code class="m">10</code><code class="w"/>&#13;
&#13;
<code class="o">[</code>Install<code class="o">]</code><code class="w"/>&#13;
<code class="nv">WantedBy</code><code class="o">=</code>multi-user.target<code class="w"/></pre>&#13;
&#13;
<p>The configuration file tells you how the <code>kubelet</code> binary is started:</p>&#13;
&#13;
<pre data-code-language="shell" data-type="programlisting"><code class="o">[</code>Service<code class="o">]</code><code class="w"/>&#13;
<code class="nv">Environment</code><code class="o">=</code><code class="s2">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/</code>&#13;
<code class="s2">bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"</code><code class="w"/>&#13;
<code class="nv">Environment</code><code class="o">=</code><code class="s2">"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"</code><code class="w"/>&#13;
<code class="nv">EnvironmentFile</code><code class="o">=</code>-/var/lib/kubelet/kubeadm-flags.env<code class="w"/>&#13;
<code class="nv">EnvironmentFile</code><code class="o">=</code>-/etc/default/kubelet<code class="w"/>&#13;
&#13;
<code class="nv">ExecStart</code><code class="o">=</code><code class="w"/>&#13;
<code class="nv">ExecStart</code><code class="o">=</code>/usr/bin/kubelet<code class="w"> </code><code class="nv">$KUBELET_KUBECONFIG_ARGS</code><code class="w"> </code><code class="nv">$KUBELET_CONFIG_ARGS</code><code class="w"/>&#13;
<code class="nv">$KUBELET_KUBEADM_ARGS</code><code class="w"> </code><code class="nv">$KUBELET_EXTRA_ARGS</code><code class="w"/></pre>&#13;
&#13;
<p>All the options specified, such as <code>--kubeconfig</code>, defined by the environment variable <code>$KUBELET_CONFIG_ARGS</code>, are start-up <a href="https://oreil.ly/quccc">options</a> of the <code>kubelet</code> binary.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id18">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p><a href="https://oreil.ly/RmuZp">systemd</a> is a system and services manager, sometimes referred to as an <em>init system</em>. It is now the default services manager on Ubuntu and CentOS.<a data-primary="init system" data-type="indexterm" id="id580"/><a data-primary="services" data-secondary="systemd manager" data-type="indexterm" id="id581"/></p>&#13;
&#13;
<p>The unit file just shown deals only with the <code>kubelet</code>. You can write your own unit files for all the other components of a Kubernetes cluster (i.e., API server, controller manager, scheduler, proxy). <a href="https://oreil.ly/AWnxD">Kubernetes the Hard Way</a> has examples of unit files for each component.</p>&#13;
&#13;
<p>However, you only need to run the <code>kubelet</code>. Indeed, note that the configuration option <code>--pod-manifest-path</code> allows you to pass a directory where the <code>kubelet</code> will look for manifests that it will automatically start. <a data-primary="manifests" data-secondary="for services" data-secondary-sortas="services" data-type="indexterm" id="id582"/>With <code>kubeadm</code>, this directory is used to pass the manifests of the API server, scheduler, etcd, and controller manager. Hence, Kubernetes manages itself, and the only thing managed by systemd is the <code>kubelet</code> process.</p>&#13;
&#13;
<p>To illustrate this, you can list the contents of the <em>/etc/kubernetes/manifests</em> directory in your <code>kubeadm</code>-based cluster:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>ls -l /etc/kubernetes/manifests</strong>&#13;
total 16&#13;
-rw------- 1 root root 2393 May 29 11:04 etcd.yaml&#13;
-rw------- 1 root root 3882 May 29 11:04 kube-apiserver.yaml&#13;
-rw------- 1 root root 3394 May 29 11:04 kube-controller-manager.yaml&#13;
-rw------- 1 root root 1463 May 29 11:04 kube-scheduler.yaml</pre>&#13;
&#13;
<p>Looking at the details of the <em>etcd.yaml</em> manifest, you can <a data-primary="etcd" data-type="indexterm" id="id583"/>see that it is a <code>Pod</code> with a single container that runs etcd:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>cat /etc/kubernetes/manifests/etcd.yaml</strong></pre>&#13;
<pre class="yaml" data-code-language="yaml" data-type="programlisting">&#13;
<code class="nt">apiVersion</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">v1</code><code class="w"/>&#13;
<code class="nt">kind</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">Pod</code><code class="w"/>&#13;
<code class="nt">metadata</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">annotations</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">kubeadm.kubernetes.io/etcd.advertise-client-urls</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">https://10.10.100.30:2379</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">creationTimestamp</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">null</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">labels</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">component</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">etcd</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">tier</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">control-plane</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">name</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">etcd</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">namespace</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">kube-system</code><code class="w"/>&#13;
<code class="nt">spec</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">containers</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">  </code><code class="p-Indicator">-</code><code class="w"> </code><code class="nt">command</code><code class="p">:</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">etcd</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--advertise-client-urls=https://10.10.100.30:2379</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--cert-file=/etc/kubernetes/pki/etcd/server.crt</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--client-cert-auth=true</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--data-dir=/var/lib/etcd</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--experimental-initial-corrupt-check=true</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--experimental-watch-progress-notify-interval=5s</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--initial-advertise-peer-urls=https://10.10.100.30:2380</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--initial-cluster=master=https://10.10.100.30:2380</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--key-file=/etc/kubernetes/pki/etcd/server.key</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--listen-client-urls=https://127.0.0.1:2379,https://10.10.100.30:2379</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--listen-metrics-urls=http://127.0.0.1:2381</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--listen-peer-urls=https://10.10.100.30:2380</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--name=master</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--peer-client-cert-auth=true</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--peer-key-file=/etc/kubernetes/pki/etcd/peer.key</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--snapshot-count=10000</code><code class="w"/>&#13;
<code class="w">    </code><code class="p-Indicator">-</code><code class="w"> </code><code class="l-Scalar-Plain">--trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">image</code><code class="p">:</code><code class="w"> </code><code class="l-Scalar-Plain">registry.k8s.io/etcd:3.5.7-0</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">...</code><code class="w"/>&#13;
</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="id584">&#13;
<h2>See Also</h2>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/E95yp"><code>kubelet</code> configuration options</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.11 Creating a Kubernetes Cluster on Google &#10;Kubernetes Engine" data-type="sect1"><div class="sect1" id="gke_start">&#13;
<h1>2.11 Creating a Kubernetes Cluster on Google &#13;
<span class="keep-together">Kubernetes Engine</span></h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id175">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You want to create a Kubernetes cluster on Google Kubernetes Engine (GKE).<a data-primary="kubelet" data-secondary="running via systemd unit files" data-startref="ix_kubltsysd" data-type="indexterm" id="id585"/><a data-primary="clusters" data-secondary="creating" data-startref="ix_clscrsysd" data-tertiary="using systemd unit files to run Kubernetes components" data-type="indexterm" id="id586"/><a data-primary="systemd" data-secondary="using unit files to run Kubernetes components" data-startref="ix_sysd" data-type="indexterm" id="id587"/><a data-primary="clusters" data-secondary="creating" data-tertiary="on Google Kubernetes Engine" data-tertiary-sortas="Google" data-type="indexterm" id="ix_clscrGKE"/><a data-primary="Google Kubernetes Engine (GKE)" data-secondary="creating a cluster on" data-type="indexterm" id="ix_GKE"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id19">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>To use GKE, you first need a few things:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A <a href="https://oreil.ly/CAiDf">Google Cloud Platform (GCP)</a> account with billing enabled</p>&#13;
</li>&#13;
<li>&#13;
<p>A GCP project with <a href="https://oreil.ly/eGX2n">GKE</a> enabled</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/Y00rC">Google Cloud SDK</a> installed</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The Google Cloud SDK contains the <code>gcloud</code> CLI tool for interacting with GCP services from the command line. <a data-primary="Google Cloud SDK" data-type="indexterm" id="id588"/><a data-primary="gcloud CLI" data-secondary="creating Kubernetes cluster" data-type="indexterm" id="id589"/>After the SDK has been installed, authenticate <code>gcloud</code> to access your GCP project:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>gcloud auth login</strong></pre>&#13;
&#13;
<p>Using the <code>gcloud</code> command-line interface, create a Kubernetes cluster with the <code><span class="keep-together">container</span> clusters create</code> command, like so:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>gcloud container clusters create oreilly --zone us-east1-b</strong></pre>&#13;
&#13;
<p>By default this will create a Kubernetes cluster with three worker nodes in the zone or region specified. The master node is being managed by the GKE service and cannot be accessed.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>If you’re unsure what <a href="https://oreil.ly/4Bvua">zone or region</a> to use for the <code>--zone</code> or &#13;
<span class="keep-together"><code>--region</code></span> argument, execute <code>gcloud compute zones list</code> or <code>gcloud compute regions list</code> and pick one near you. Zones are typically less resource hungry than regions.<a data-primary="regions" data-type="indexterm" id="id590"/><a data-primary="zones" data-type="indexterm" id="id591"/></p>&#13;
</div>&#13;
&#13;
<p>Once you are done using your cluster, do not forget to delete it to avoid being charged:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>gcloud container clusters delete oreilly --zone us-east1-b</strong></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Discussion" data-type="sect2"><div class="sect2" id="id20">&#13;
<h2>Discussion</h2>&#13;
&#13;
<p>You can skip the <code>gcloud</code> CLI installation by using the <a href="https://oreil.ly/E-Qcr">Google Cloud Shell</a>, a pure online browser-based solution.<a data-primary="Google Cloud Shell" data-type="indexterm" id="id592"/></p>&#13;
&#13;
<p>You can list your existing GKE clusters using this command:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>gcloud container clusters list --zone us-east1-b</strong>&#13;
NAME     ZONE        MASTER_VERSION     MASTER_IP     ...  STATUS&#13;
oreilly  us-east1-b  1.24.9-gke.2000    35.187.80.94  ...  RUNNING</pre>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>The <code>gcloud</code> CLI allows you to resize your <a data-primary="gcloud CLI" data-secondary="resizing, updating, and upgrading clusters" data-type="indexterm" id="id593"/>cluster, update it, and upgrade it:</p>&#13;
&#13;
<pre data-type="programlisting">...&#13;
COMMANDS&#13;
...&#13;
     resize&#13;
        Resizes an existing cluster for running&#13;
        containers.&#13;
     update&#13;
        Update cluster settings for an existing container&#13;
        cluster.&#13;
     upgrade&#13;
        Upgrade the Kubernetes version of an existing&#13;
        container cluster.</pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="id594">&#13;
<h2>See Also</h2>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>GKE <a href="https://oreil.ly/WMDSx">quickstart</a></p>&#13;
</li>&#13;
<li>&#13;
<p>Google Cloud Shell <a href="https://oreil.ly/_w0va">quickstart</a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.12 Creating a Kubernetes Cluster on Azure &#10;Kubernetes Service" data-type="sect1"><div class="sect1" id="acs_start">&#13;
<h1>2.12 Creating a Kubernetes Cluster on Azure &#13;
<span class="keep-together">Kubernetes Service</span></h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id21">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You want to create a Kubernetes cluster on Azure Kubernetes Service (AKS).<a data-primary="clusters" data-secondary="creating" data-startref="ix_clscrGKE" data-tertiary="on Google Kubernetes Engine" data-tertiary-sortas="Google" data-type="indexterm" id="id595"/><a data-primary="Google Kubernetes Engine (GKE)" data-secondary="creating a cluster on" data-startref="ix_GKE" data-type="indexterm" id="id596"/><a data-primary="clusters" data-secondary="creating" data-tertiary="on Azure Kubernetes Service" data-tertiary-sortas="Azure" data-type="indexterm" id="ix_clscrAKS"/><a data-primary="Azure Kubernetes Service (AKS), creating a cluster on" data-type="indexterm" id="ix_AKS"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id22">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>To create an AKS cluster, you will need the following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>A <a href="https://oreil.ly/PyUA0">Microsoft Azure portal account</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://oreil.ly/An7xM">Azure CLI</a> installed</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p class="pagebreak-before">First, make sure that you have Azure CLI version 2.0 or higher installed and then log in <a data-primary="az CLI" data-type="indexterm" id="id597"/><a data-primary="CLI (command-line interface)" data-secondary="Azure CLI" data-type="indexterm" id="id598"/>to Azure:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>az --version | grep "^azure-cli"</strong>&#13;
azure-cli                         2.50.0 *&#13;
&#13;
$ <strong>az login</strong>&#13;
To sign in, use a web browser to open the page https://aka.ms/devicelogin and&#13;
enter the code XXXXXXXXX to authenticate.&#13;
[&#13;
  {&#13;
    "cloudName": "AzureCloud",&#13;
    "id": "****************************",&#13;
    "isDefault": true,&#13;
    "name": "Free Trial",&#13;
    "state": "Enabled",&#13;
    "tenantId": "*****************************",&#13;
    "user": {&#13;
      "name": "******@hotmail.com",&#13;
      "type": "user"&#13;
    }&#13;
  }&#13;
]</pre>&#13;
&#13;
<p>Create an Azure resource group named <code>k8s</code> to hold all your AKS resources, such as VMs and networking components, and to make it easy<a data-primary="resource groups" data-secondary="creating Azure resource group" data-type="indexterm" id="id599"/> to clean up and tear down later:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>az group create --name k8s --location northeurope</strong>&#13;
{&#13;
  "id": "/subscriptions/************************/resourceGroups/k8s",&#13;
  "location": "northeurope",&#13;
  "managedBy": null,&#13;
  "name": "k8s",&#13;
  "properties": {&#13;
    "provisioningState": "Succeeded"&#13;
  },&#13;
  "tags": null,&#13;
  "type": "Microsoft.Resources/resourceGroups"&#13;
}</pre>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>If you’re unsure what <a href="https://oreil.ly/fdGdc">region</a> to use for the <code>--location</code> argument, execute <code>az account list-locations</code> and pick one near you.<a data-primary="regions" data-type="indexterm" id="id600"/></p>&#13;
</div>&#13;
&#13;
<p>Now that you have the resource group <code>k8s</code> set up, you can create the cluster with one <a data-primary="agents (Azure)" data-type="indexterm" id="id601"/><a data-primary="worker nodes" data-secondary="agents in Azure" data-type="indexterm" id="id602"/>worker node (<em>agent</em> in Azure terminology), like so:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>az aks create -g k8s -n myAKSCluster --node-count 1 --generate-ssh-keys</strong>&#13;
{&#13;
  "aadProfile": null,&#13;
  "addonProfiles": null,&#13;
  "agentPoolProfiles": [&#13;
    {&#13;
      "availabilityZones": null,&#13;
      "count": 1,&#13;
      "creationData": null,&#13;
      "currentOrchestratorVersion": "1.26.6",&#13;
</pre>&#13;
&#13;
<p>Note that the <code>az aks create</code> command might take several minutes to complete. Once completed, the command returns a JSON object with information about the created cluster.</p>&#13;
&#13;
<p>As a result, in the Azure portal you should see something like <a data-type="xref" href="#azure-portal">Figure 2-5</a>. Start by finding the <code>k8s</code> resource group and then navigate your way to the Deployments tab.<a data-primary="Azure portal" data-type="indexterm" id="id603"/></p>&#13;
&#13;
<figure><div class="figure" id="azure-portal">&#13;
<img alt="Screen shot of the Azure Portal, showing an AKS cluster in the k8s resource group" src="assets/kcb2_0205.png"/>&#13;
<h6><span class="label">Figure 2-5. </span>Azure portal, showing an AKS cluster in the k8s resource group</h6>&#13;
</div></figure>&#13;
&#13;
<p>You’re now in a position to connect to the cluster:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>az aks get-credentials --resource-group k8s --name myAKSCluster</strong></pre>&#13;
&#13;
<p>You can now poke around in the environment and verify the setup:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>kubectl cluster-info</strong>&#13;
Kubernetes master is running at https://k8scb-k8s-143f1emgmt.northeurope.cloudapp&#13;
  .azure.com&#13;
Heapster is running at https://k8scb-k8s-143f1emgmt.northeurope.cloudapp.azure&#13;
  .com/api/v1/namespaces/kube-system/services/heapster/proxy&#13;
KubeDNS is running at https://k8scb-k8s-143f1emgmt.northeurope.cloudapp.azure&#13;
  .com/api/v1/namespaces/kube-system/services/kube-dns/proxy&#13;
kubernetes-dashboard is running at https://k8scb-k8s-143f1emgmt.northeurope&#13;
  .cloudapp.azure.com/api/v1/namespaces/kube-system/services/kubernetes-dashboard&#13;
  /proxy&#13;
tiller-deploy is running at https://k8scb-k8s-143f1emgmt.northeurope.cloudapp&#13;
  .azure.com/api/v1/namespaces/kube-system/services/tiller-deploy/proxy&#13;
&#13;
To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.&#13;
&#13;
$ <strong>kubectl get nodes</strong>&#13;
NAME                                STATUS   ROLES   AGE   VERSION&#13;
aks-nodepool1-78916010-vmss000000   Ready    agent   26m   v1.24.9</pre>&#13;
&#13;
<p>Indeed, as you can see from the output, we have created a single-node cluster.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>If you don’t want to or cannot install the Azure CLI, an alternative is to use the <a href="https://oreil.ly/IUFJQ">Azure Cloud Shell</a> from your browser.<a data-primary="Azure Cloud Shell" data-type="indexterm" id="id604"/></p>&#13;
</div>&#13;
&#13;
<p>When you’re done discovering AKS, don’t forget to shut down the cluster and remove all the resources by deleting<a data-primary="resource groups" data-secondary="deleting Azure resource group" data-type="indexterm" id="id605"/> the resource group <code>k8s</code>:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>az group delete --name k8s --yes --no-wait</strong></pre>&#13;
&#13;
<p>Although the <code>az group delete</code> command returns immediately, due to the presence of the <code>--no-wait</code> flag, it can take up to 10 minutes for all the resources to be removed and the resource group to actually be destroyed. You might want to check in the Azure portal to make sure everything went according to plan.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="id606">&#13;
<h2>See Also</h2>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><a href="https://oreil.ly/YXv3B">“Quickstart: Deploy an Azure Kubernetes Service cluster using Azure CLI”</a> in the Microsoft Azure documentation</p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="2.13 Creating a Kubernetes Cluster on Amazon  &#10;Elastic Kubernetes Service" data-type="sect1"><div class="sect1" id="eks_start">&#13;
<h1>2.13 Creating a Kubernetes Cluster on Amazon  &#13;
<span class="keep-together">Elastic Kubernetes Service</span></h1>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Problem" data-type="sect2"><div class="sect2" id="id23">&#13;
<h2>Problem</h2>&#13;
&#13;
<p>You want to create a Kubernetes cluster on Amazon Elastic Kubernetes Service (EKS).<a data-primary="clusters" data-secondary="creating" data-startref="ix_clscrAKS" data-tertiary="on Azure Kubernetes Service" data-tertiary-sortas="Azure" data-type="indexterm" id="id607"/><a data-primary="Azure Kubernetes Service (AKS), creating a cluster on" data-startref="ix_AKS" data-type="indexterm" id="id608"/><a data-primary="clusters" data-secondary="creating" data-tertiary="on Amazon Elastic Kubernetes Service" data-tertiary-sortas="Amazon" data-type="indexterm" id="ix_clscrAEKS"/><a data-primary="AWS (Amazon Web Services)" data-secondary="Elastic Kubernetes Service (EKS), creating cluster on" data-type="indexterm" id="ix_AmzEKS"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="less_space pagebreak-before" data-pdf-bookmark="Solution" data-type="sect2"><div class="sect2" id="id24">&#13;
<h2>Solution</h2>&#13;
&#13;
<p>To create a cluster in Amazon EKS, you need the <a data-primary="AWS CLI" data-type="indexterm" id="id609"/><a data-primary="AWS (Amazon Web Services)" data-type="indexterm" id="id610"/><a data-primary="CLI (command-line interface)" data-secondary="AWS CLI" data-type="indexterm" id="id611"/>following:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>An <a href="https://aws.amazon.com">Amazon Web Services</a> account</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://aws.amazon.com/cli">AWS CLI</a> installed</p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://eksctl.io">eksctl</a> CLI tool installed</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>After you’ve installed the AWS CLI, <a href="https://oreil.ly/_6VMv">authenticate the client</a> to access your AWS account:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>aws configure</strong>&#13;
AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE&#13;
AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&#13;
Default region name [None]: eu-central-1&#13;
Default output format [None]:&#13;
</pre>&#13;
&#13;
<p>The eksctl tool is the official CLI for Amazon EKS. <a data-primary="eksctl CLI" data-type="indexterm" id="id612"/>It uses the AWS credentials you’ve configured to authenticate with AWS. Using eksctl, create the cluster:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>eksctl create cluster --name oreilly --region eu-central-1</strong>&#13;
2023-08-29 13:21:12 [i]  eksctl version 0.153.0-dev+a79b3826a.2023-08-18T...&#13;
2023-08-29 13:21:12 [i]  using region eu-central-1&#13;
...&#13;
2023-08-29 13:36:52 [✔]  EKS cluster "oreilly" in "eu-central-1" region is ready&#13;
</pre>&#13;
&#13;
<p>By default, eksctl creates a cluster with two worker nodes in the specified region. You can adjust this paramater by specifying the <code>--nodes</code> flag.</p>&#13;
<div data-type="tip"><h6>Tip</h6>&#13;
<p>For the lowest latency, choose the <a href="https://oreil.ly/Kc9GZ">AWS region</a> that’s nearest to you.<a data-primary="regions" data-type="indexterm" id="id613"/></p>&#13;
</div>&#13;
&#13;
<p>When you no longer need the EKS cluster, delete it to avoid being charged for unused <a data-primary="clusters" data-secondary="creating" data-startref="ix_clscrAEKS" data-tertiary="on Amazon Elastic Kubernetes Service" data-tertiary-sortas="Amazon" data-type="indexterm" id="id614"/><a data-primary="AWS (Amazon Web Services)" data-secondary="Elastic Kubernetes Service (EKS), creating cluster on" data-startref="ix_AmzEKS" data-type="indexterm" id="id615"/>resources:</p>&#13;
<pre data-type="programlisting">&#13;
$ <strong>eksctl delete cluster oreilly --region eu-central-1</strong></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="See Also" data-type="sect2"><div class="sect2" id="id616">&#13;
<h2>See Also</h2>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>eksctl <a href="https://eksctl.io/getting-started">Introduction</a></p>&#13;
</li>&#13;
<li>&#13;
<p><a href="https://aws.amazon.com/eks">Amazon Elastic Kubernetes Service </a></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section></body></html>