<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 24. Security"><div class="chapter" id="nch-security"><h1><span class="label">Chapter 24. </span>Security</h1><aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45820312183616"><h5>A note for Early Release readers</h5><p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p></div></aside><section data-type="sect1" data-pdf-bookmark="24.0 Introduction"><div class="sect1" id="nch-security-security-intro"><h1>24.0 Introduction</h1><p>This chapter covers security-related topics:</p><ul><li><p>The <code>mysql.user</code> table that
        contains MySQL account information</p></li><li><p>Statements for managing MySQL user accounts</p></li><li><p>Password strength checking and policy</p></li><li><p>Password expiration</p></li><li><p>Finding and removing anonymous accounts and accounts that permit
        connections from many hosts</p></li></ul><p>If you like, you can skip over the initial section that describes
    the <code>mysql.user</code> table, but I think
    you’ll find that reading it will help you better understand later
    sections, which often discuss how SQL operations map onto underlying
    changes in that table.</p><p>Scripts shown in this chapter are located in the <em class="filename">routines</em> directory of the <code>recipes</code> distribution.</p><div data-type="note" epub:type="note"><h6>Note</h6><p>Whether you use the MySQL 5.7 or 8.0 release series, it is
      best to use a recent version within the series. Changes to the
      authentication system occur in early development versions that may
      produce results that differ from the descriptions here.</p></div><div data-type="tip"><h6>Tip</h6><p>Many of the techniques shown here require administrative access,
      such as the ability to modify tables in the <code>mysql</code> system database or use statements that
      require the privileges that allow to administer MySQL server. For this
      reason, to carry out the operations described here, connect to the
      server as <code>root</code> rather than as
      <code>cbuser</code>.</p></div></div></section><section data-type="sect1" data-pdf-bookmark="24.1 Understanding the mysql.user Table"><div class="sect1" id="nch-security-user-table"><h1>24.1 Understanding the mysql.user Table</h1><p>MySQL stores user account information in tables in the <code>mysql</code>
    system database. The <code>user</code> table is the
    most important because it contains account names and credentials. To see
    its structure, use this statement:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">SHOW</code> <code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">mysql</code><code class="p">.</code><code class="k">user</code><code class="p">;</code></pre><p>The <code>user</code> table columns that
    concern us here specify account names and authentication
    information:</p><ul><li><p>The <code>User</code> and <code>Host</code> columns identify the account. MySQL
        account names comprise a combination of username and hostname values.
        For example, in the <code>user</code> table row
        for a <code>'cbuser'@'localhost'</code> account,
        the <code>User</code> and <code>Host</code> column values are <code>cbuser</code> and <code>localhost</code>, respectively. For a <code>'myuser'@'myhost.example.com'</code> account, those
        columns are <code>myuser</code> and <code>myhost.example.com</code>.</p></li><li><p>The <code>plugin</code>, and <code>authentication_string</code> columns store
        authentication credentials. MySQL does not store literal passwords in
        the <code>user</code> sytem table because that
        is insecure. Instead, the server computes a hash value from the
        password and stores the hash string.</p><ul><li><p>The <code>plugin</code> column
            indicates which authentication plugin the server uses to check
            credentials for clients that attempt to use the account. Different
            plug-ins implement password hashing methods of varying encryption
            strength. The <a data-type="xref" href="#nch-security-user-table-auth-methods">Table 24-1</a> shows the plug-ins this chapter
            discusses.</p><table id="nch-security-user-table-auth-methods"><caption><span class="label">Table 24-1. </span>Authentication Plugins</caption><thead><tr><th>Plug-in</th><th>Authentication method</th></tr></thead><tbody><tr><td><code>mysql_native_password </code></td><td>Native password
                    hashing</td></tr><tr><td><code>sha256_password </code></td><td>SHA-256 password hashing (from MySQL 5.6.6 to
                    MySQL 8.0)</td></tr><tr><td>
                      <code>caching_sha2_password </code>
                    </td><td>
                      SHA-256 password hashing with server-side caching (MySQL 5.7 or later)
                    </td></tr></tbody></table><p>MySQL Enterprise, the commercial version of MySQL, includes
            additional plug-ins for authenticating using PAM or Windows
            credentials. These enable use of passwords external to MySQL, such
            as Unix login passwords or native Windows services.</p></li><li><p>The <code>authentication_string</code>
            column represents a hashed password
            in the format required by the respective plug-in. For example, <code>sha256_password</code> uses <code>authentication_string</code> to store SHA-256
            password hash values, which are cryptographically superior to
            native hashing, used by the <code>mysql_native_password</code> plugin.
            An empty <code>authentication_string</code> value means “no password”, which is insecure.
            </p></li></ul></li></ul><p>Before MySQL 5.7.2, the server permits the <code>plugin</code> value to be empty. As of MySQL 5.7.2, the
    <code>plugin</code> column <em>must</em>
    be nonempty and the server disables any empty-plug-in account until a
    nonempty plug-in is assigned.</p></div></section><section data-type="sect1" data-pdf-bookmark="24.2 Managing User Accounts"><div class="sect1" id="nch-security-account-management"><h1>24.2 Managing User Accounts</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820312112384"><h2>Problem</h2><p>You are responsible for setting up accounts on your MySQL server.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820312097200"><h2>Solution</h2><p>Learn to use the account-management SQL statements.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820312096432"><h2>Discussion</h2><p>It’s possible to modify the grant tables in the <code>mysql</code> database directly with SQL statements
      such as <code>INSERT</code> or <code>UPDATE</code>, but the MySQL account-management
      statements are more convenient. This section describes their use and
      covers these topics:</p><ul><li><p>Creating accounts (<code>CREATE</code>
          <code>USER</code>, <code>SET</code> <code>PASSWORD</code>  <code>ALTER USER</code>)</p></li><li><p>Assigning and checking privileges (<code>GRANT</code>, <code>REVOKE</code>, <code>SHOW</code> <code>GRANTS</code>)</p></li><li><p>Removing and renaming accounts (<code>DROP</code> <code>USER</code>, <code>RENAME</code> <code>USER</code>)</p></li></ul><section data-type="sect3" data-pdf-bookmark="Creating accounts"><div class="sect3" id="idm45820312086752"><h3>Creating accounts</h3><p>To create an account, use the <code>CREATE</code> <code>USER</code> statement, which creates a row in the
        <code>mysql.user</code> table. But before you do
        so, decide these three things:</p><ul><li><p>The account name, expressed in <code>'</code><em><code>user_name</code></em><code>'@'</code><em><code>host_name</code></em><code>'</code> format naming the user and the host
            from which the user will connect</p></li><li><p>The account password</p></li><li><p>The authentication plug-in the server should execute when
            clients attempt to use the account</p></li></ul><p>Authentication plug-ins use hashing to encrypt passwords for
        storage and transmission. MySQL has several built-in plug-ins from
        which to choose:</p><ul><li><p><code>mysql_native_password</code>
            implements the default password hashing method before version 8.0.</p></li><li><p><code>sha256_password</code>
            authenticates using SHA-256 password hash values, which are
            cryptographically more secure than hashes generated by <code>mysql_native_password</code>. This plug-in is
            available as of MySQL 5.6.6 and deprecated in version 8.0 in favor to its improved version <code>caching_sha2_password</code>. It provides security beyond that
            afforded by <code>mysql_native_password</code>, but additional
            setup is required to use it. (Clients must connect using SSL or
            provide an RSA certificate.)</p></li><li><p>
              <code>caching_sha2_password</code> is similar to <code>sha256_password</code> but uses caching on the server side for better performance. This is default authentication plugin since MySQL 8.0.
            </p></li></ul><p>The <code>CREATE</code> <code>USER</code> statement is commonly used in one of these forms:</p><pre data-type="programlisting" data-code-language="sql">CREATE USER '<em><code>user_name</code></em>'@'<em><code>host_name</code></em>' IDENTIFIED BY '<em><code>password</code></em>';
CREATE USER '<em><code>user_name</code></em>'@'<em><code>host_name</code></em>' IDENTIFIED WITH '<em><code>auth_plugin</code></em>' BY '<em><code>auth_string</code></em>';</pre><p>The first syntax creates the account and sets its password with
        a single statement. It also assigns an authentication plug-in
        implicitly to the plug-in named by the
            <code class="option">--default-authentication-plugin</code> setting (which is
            <code>caching_sha2_password</code>, unless
            you change it at server startup).
        </p><p>To assign privileges to the new account, which has none
        initially, use the <code>GRANT</code> statement
        described later in this section.</p><p><code>CREATE</code> <code>USER</code> fails if the account already exists.</p></div></section><section data-type="sect3" data-pdf-bookmark="Assigning and checking privileges"><div class="sect3" id="idm45820312086624"><h3>Assigning and checking privileges</h3><p>Suppose that you have just created an account named <code>'user1'@'localhost'</code>. You can assign
        privileges to it with <code>GRANT</code>, remove
        privileges from it with <code>REVOKE</code>, and
        check its privileges with <code>SHOW</code>
        <code>GRANTS</code>.</p><p><code>GRANT</code> has this syntax:</p><pre data-type="programlisting" data-code-language="sql">GRANT <em><code>privileges</code></em> ON <em><code>scope</code></em> TO <em><code>account</code></em>;</pre><p>Here, <em><code>account</code></em> names the account to be
        granted the privileges, <em><code>privileges</code></em>
        indicates what they are, and <em><code>scope</code></em>
        indicates the privilege scope, or level at which they apply. The
        <em><code>privileges</code></em> value can be <code>ALL</code> (or <code>ALL</code> <code>PRIVILEGES</code>) to specify all privileges
        available at the given level, or a comma-separated list of one or more
        privilege names such as <code>SELECT</code> or
        <code>CREATE</code>. (For a full discussion of
        available privileges and <code>GRANT</code>
        syntax not shown here, see the <em>MySQL Reference
        Manual.</em>)</p><p>The following examples illustrate the syntax for granting
        privileges at each level.</p><ul><li><p>Granting privileges globally enables the account to perform
            administrative operations or operations on any database:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">GRANT</code> <code class="n">FILE</code> <code class="k">ON</code> <code class="o">*</code><code class="p">.</code><code class="o">*</code> <code class="k">TO</code> <code class="s1">'user1'</code><code class="o">@</code><code class="s1">'localhost'</code><code class="p">;</code>
<code class="k">GRANT</code> <code class="k">CREATE</code> <code class="k">TEMPORARY</code> <code class="n">TABLES</code><code class="p">,</code> <code class="k">LOCK</code> <code class="n">TABLES</code> <code class="k">ON</code> <code class="o">*</code><code class="p">.</code><code class="o">*</code> <code class="k">TO</code> <code class="s1">'user1'</code><code class="o">@</code><code class="s1">'localhost'</code><code class="p">;</code></pre></li><li><p>Granting privileges at the database level enables the
            account to perform operations on objects within the named
            database:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">GRANT</code> <code class="k">ALL</code> <code class="k">ON</code> <code class="n">cookbook</code><code class="p">.</code><code class="o">*</code> <code class="k">TO</code> <code class="s1">'user1'</code><code class="o">@</code><code class="s1">'localhost'</code><code class="p">;</code></pre></li><li><p>Granting privileges at the table level enables the account
            to perform operations on the named table:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">GRANT</code> <code class="k">SELECT</code> <code class="k">ON</code> <code class="n">mysql</code><code class="p">.</code><code class="k">user</code> <code class="k">TO</code> <code class="s1">'user1'</code><code class="o">@</code><code class="s1">'localhost'</code><code class="p">;</code></pre></li><li><p>Granting privileges at the column level enables the account
            to perform operations on the named table column:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">GRANT</code> <code class="k">SELECT</code><code class="p">(</code><code class="k">User</code><code class="p">,</code><code class="k">Host</code><code class="p">),</code> <code class="k">UPDATE</code><code class="p">(</code><code class="n">password_expired</code><code class="p">)</code>
<code class="k">ON</code> <code class="n">mysql</code><code class="p">.</code><code class="k">user</code> <code class="k">TO</code> <code class="s1">'user1'</code><code class="o">@</code><code class="s1">'localhost'</code><code class="p">;</code></pre></li><li><p>Granting privileges at the procedure level enables the
            account to perform operations on the named stored
            procedure:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">GRANT</code> <code class="k">EXECUTE</code> <code class="k">ON</code> <code class="k">PROCEDURE</code> <code class="n">cookbook</code><code class="p">.</code><code class="n">exec_stmt</code> <code class="k">TO</code> <code class="s1">'user1'</code><code class="o">@</code><code class="s1">'localhost'</code><code class="p">;</code></pre><p>Use <code>FUNCTION</code> rather than
            <code>PROCEDURE</code> if the routine is a
            stored function.</p></li></ul><p>To verify the privilege assignments, use <code>SHOW</code> <code>GRANTS</code>:</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GRANTS FOR 'user1'@'localhost';</code></strong>
+--------------------------------------------------------------------------+
| Grants for user1@localhost                                               |
+--------------------------------------------------------------------------+
| GRANT FILE, CREATE TEMPORARY TABLES, LOCK TABLES                         |
| ON *.* TO 'user1'@'localhost'                                            |
| GRANT ALL PRIVILEGES ON `cookbook`.* TO 'user1'@'localhost'              |
| GRANT SELECT, SELECT (User, Host), UPDATE (password_expired)             |
| ON `mysql`.`user` TO 'user1'@'localhost'                                 |
| GRANT EXECUTE ON PROCEDURE `cookbook`.`exec_stmt` TO 'user1'@'localhost' |
+--------------------------------------------------------------------------+</pre><p>To see your own privileges, omit the <code>FOR</code> clause.</p><p><code>REVOKE</code> syntax is generally
        similar to <code>GRANT</code> but uses <code>FROM</code> rather than <code>TO</code>:</p><pre data-type="programlisting" data-code-language="sql">REVOKE <em><code>privileges</code></em> ON <em><code>scope</code></em> FROM <em><code>account</code></em>;</pre><p>Thus, to remove the privileges just granted to <code>'user1'@'localhost'</code>, use these <code>REVOKE</code>
        statements (and <code>SHOW</code> <code>GRANTS</code> to verify that they were
        removed):</p><pre data-type="programlisting">mysql&gt; <strong><code>REVOKE FILE ON *.* FROM 'user1'@'localhost';</code></strong>
mysql&gt; <strong><code>REVOKE CREATE TEMPORARY TABLES, LOCK TABLES</code></strong>
    -&gt; <strong><code>ON *.* FROM 'user1'@'localhost';</code></strong>
mysql&gt; <strong><code>REVOKE ALL ON cookbook.* FROM 'user1'@'localhost';</code></strong>
mysql&gt; <strong><code>REVOKE SELECT ON mysql.user FROM 'user1'@'localhost';</code></strong>
mysql&gt; <strong><code>REVOKE SELECT(User,Host), UPDATE(password_expired)</code></strong>
    -&gt; <strong><code>ON mysql.user FROM 'user1'@'localhost';</code></strong>
mysql&gt; <strong><code>REVOKE EXECUTE ON PROCEDURE cookbook.exec_stmt</code></strong>
    -&gt; <strong><code>FROM 'user1'@'localhost';</code></strong>
mysql&gt; <strong><code>SHOW GRANTS FOR 'user1'@'localhost';</code></strong>
+-------------------------------------------+
| Grants for user1@localhost                |
+-------------------------------------------+
| GRANT USAGE ON *.* TO 'user1'@'localhost' |
+-------------------------------------------+</pre></div></section><section data-type="sect3" data-pdf-bookmark="Removing accounts"><div class="sect3" id="idm45820312066544"><h3>Removing accounts</h3><p>To get rid of an account, use the <code>DROP</code> <code>USER</code> statement:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">DROP</code> <code class="k">USER</code> <code class="s1">'user1'</code><code class="o">@</code><code class="s1">'localhost'</code><code class="p">;</code></pre><p>The statement removes all rows associated with the account in
        all grant tables; you need not use <code>REVOKE</code> to remove its privileges first. An
        error occurs if the account does not exist.</p></div></section><section data-type="sect3" data-pdf-bookmark="Renaming accounts"><div class="sect3" id="idm45820311814720"><h3>Renaming accounts</h3><p>To change an account name, use <code>RENAME</code> <code>USER</code>, specifying the current and new
        names:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">RENAME</code> <code class="k">USER</code> <code class="s1">'currentuser'</code><code class="o">@</code><code class="s1">'localhost'</code> <code class="k">TO</code> <code class="s1">'newuser'</code><code class="o">@</code><code class="s1">'localhost'</code><code class="p">;</code></pre><p>An error occurs if the current account does not exist or the new
        account already exists.</p></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="24.3 Implementing a Password Policy"><div class="sect1" id="nch-security-password-policy"><h1>24.3 Implementing a Password Policy</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820311806576"><h2>Problem</h2><p>You want to ensure that MySQL accounts do not use weak passwords.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820311805696"><h2>Solution</h2><p>Use the <code>validate_password</code>
      plug-in to implement a password policy. New passwords must satisfy
      the policy, whether those chosen by the DBA for new accounts or by
      existing users changing their password.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820311804432"><h2>Discussion</h2><p>This technique requires the <code>validate_password</code> plug-in to be enabled. For
      plug-in installation instructions, see <a data-type="xref" href="ch22.xhtml#nch-admin-plugin-interface">Recipe 22.2</a>.</p><p>When <code>validate_password</code> is
      enabled, it exposes a set of system variables that enable you to
      configure it. These are the default values:</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW VARIABLES LIKE 'validate_password%';</code></strong>
+--------------------------------------+--------+
| Variable_name                        | Value  |
+--------------------------------------+--------+
| validate_password_dictionary_file    |        |
| validate_password_length             | 8      |
| validate_password_mixed_case_count   | 1      |
| validate_password_number_count       | 1      |
| validate_password_policy             | MEDIUM |
| validate_password_special_char_count | 1      |
+--------------------------------------+--------+</pre><p>Suppose that you want to implement a policy that enforces these
      requirements for passwords:</p><ul><li><p>At least 10 characters long</p></li><li><p>Contains uppercase and lowercase characters</p></li><li><p>Contains at least two digits</p></li><li><p>Contains at least one special (nonalphanumeric)
          character</p></li></ul><p>To put that policy in place, start the server with options that
      enable the plug-in and set the values of the system variables that
      configure the policy requirements. For example, put these lines in your
      server option file:</p><pre data-type="programlisting">[mysqld]
plugin-load-add=validate_password.so
validate_password_length=10
validate_password_mixed_case_count=1
validate_password_number_count=2
validate_password_special_char_count=1</pre><p>After starting the server, verify the settings:</p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW VARIABLES LIKE 'validate_password%';</code></strong>
+--------------------------------------+--------+
| Variable_name                        | Value  |
+--------------------------------------+--------+
| validate_password_dictionary_file    |        |
| validate_password_length             | 10     |
| validate_password_mixed_case_count   | 1      |
| validate_password_number_count       | 2      |
| validate_password_policy             | MEDIUM |
| validate_password_special_char_count | 1      |
+--------------------------------------+--------+</pre><p>Now the <code>validate_password</code>
      plug-in prevents assigning passwords too weak for the policy:</p><pre data-type="programlisting">mysql&gt; <strong><code>SET PASSWORD = 'weak-password';</code></strong>
ERROR 1819 (HY000): Your password does not satisfy the current
policy requirements
mysql&gt; <strong><code>SET PASSWORD = 'Str0ng-Pa33w@rd';</code></strong>
Query OK, 0 rows affected (0.00 sec)</pre><p>The preceding instructions leave the <code>validate_password_policy</code> system variable set
      to its default value (<code>MEDIUM</code>), but
      you can change it to control how the server tests passwords:</p><ul><li><p><code>MEDIUM</code> enables tests for
          password length and the number of numeric, uppercase/lowercase, and
          special characters.</p></li><li><p>To be less rigorous, set the policy to <code>LOW</code>, which enables only the length test.
          To also permit shorter passwords, decrease the required length
          (<code>validate_password_length</code>).</p></li><li><p>To be more rigorous, set the policy to <code>STRONG</code>, which is like <code>MEDIUM</code> but also enables you to have
          passwords checked against a dictionary file, to prevent use of
          passwords that match any word in the file. Comparisons are not case
          sensitive.</p><p>To use a dictionary file, set the value of <code>validate_password_dictionary_file</code> to the
          filename at server startup. The file should contain lowercase words,
          one per line. MySQL distributions include a <em class="filename">dictionary.txt</em> file in the <em class="filename">share</em> directory that you can use, and
          Unix systems often have a <em class="filename">/usr/share/dict/words</em> file.</p></li></ul><p>Putting a password policy in place has no effect on existing
      passwords. To require users to choose a new password that satisfies the
      policy, expire their current password (see <a data-type="xref" href="#nch-security-password-expiration">Recipe 24.5</a>).</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="24.4 Checking Password Strength"><div class="sect1" id="nch-security-password-strength"><h1>24.4 Checking Password Strength</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820311744288"><h2>Problem</h2><p>You want to assign or change a password but verify first that it’s not
      weak.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820311743312"><h2>Solution</h2><p>Use the <code>VALIDATE_PASSWORD_STRENGTH()</code> function.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820311741872"><h2>Discussion</h2><p>The <code>validate_password</code> plug-in
      not only implements policy for new passwords, it also provides a SQL
      function, <code>VALIDATE_PASSWORD_STRENGTH()</code>, that enables
      strength testing of prospective passwords. Uses for this function
      include:</p><ul><li><p>An administrator wants to check passwords to be assigned to
          new accounts.</p></li><li><p>An individual user wants to choose a new password but seeks
          assurance in advance how strong it is.</p></li></ul><p>To use <code>VALIDATE_PASSWORD_STRENGTH()</code>, the <code>validate_password</code> plug-in must be enabled. For
      plug-in installation instructions, see <a data-type="xref" href="ch22.xhtml#nch-admin-plugin-interface">Recipe 22.2</a>.</p><p><code>VALIDATE_PASSWORD_STRENGTH()</code>
      returns a value from 0 (weak) to 100 (strong):</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT VALIDATE_PASSWORD_STRENGTH('abc') ;</code></strong>
+-----------------------------------+
| VALIDATE_PASSWORD_STRENGTH('abc') |
+-----------------------------------+
|                                 0 |
+-----------------------------------+
mysql&gt; <strong><code>SELECT VALIDATE_PASSWORD_STRENGTH('weak-password');</code></strong>
+---------------------------------------------+
| VALIDATE_PASSWORD_STRENGTH('weak-password') |
+---------------------------------------------+
|                                          50 |
+---------------------------------------------+
mysql&gt; <strong><code>SELECT VALIDATE_PASSWORD_STRENGTH('Str0ng-Pa33w@rd');</code></strong>
+-----------------------------------------------+
| VALIDATE_PASSWORD_STRENGTH('Str0ng-Pa33w@rd') |
+-----------------------------------------------+
|                                           100 |
+-----------------------------------------------+</pre></div></section></div></section><section data-type="sect1" data-pdf-bookmark="24.5 Expiring Passwords"><div class="sect1" id="nch-security-password-expiration"><h1>24.5 Expiring Passwords</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820311732128"><h2>Problem</h2><p>You want users to pick a new MySQL password.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820311731120"><h2>Solution</h2><p>The <code>ALTER</code> <code>USER</code> statement expires passwords.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820311729280"><h2>Discussion</h2><p>MySQL 5.6.7 and up provides an <code>ALTER</code> <code>USER</code>
      statement that enables an administrator to expire an account’s
      password:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">ALTER</code> <code class="k">USER</code> <code class="s1">'cbuser'</code><code class="o">@</code><code class="s1">'localhost'</code> <code class="n">PASSWORD</code> <code class="n">EXPIRE</code><code class="p">;</code></pre><p>Here are some uses for password expiration:</p><ul><li><p>You can implement a policy that new users must select a new
          password when first connecting: immediately expire the password for
          each new account you create.</p></li><li><p>If you impose a stricter policy on acceptable passwords (see
          <a data-type="xref" href="#nch-security-password-policy">Recipe 24.3</a>), you can expire all
          existing passwords to require each user to choose a new one that
          meets the more stringent requirements.</p></li></ul><p><code>ALTER</code> <code>USER</code> affects a single account. It works by
      setting the <code>password_expired</code> column
      to <code>Y</code> for the appropriate <code>mysql.user</code> row. To <q>cheat</q> and
      expire passwords for all nonanonymous accounts at once, do this
      (anonymous users cannot reset their password, so expiring those would have the same effect as removing these accounts from):
      </p><pre data-type="programlisting" data-code-language="sql"><code class="k">UPDATE</code> <code class="n">mysql</code><code class="p">.</code><code class="k">user</code> <code class="k">SET</code> <code class="n">password_expired</code> <code class="o">=</code> <code class="s1">'Y'</code> <code class="k">WHERE</code> <code class="k">User</code> <code class="o">&lt;&gt;</code> <code class="s1">''</code><code class="p">;</code>
<code class="n">FLUSH</code> <code class="k">PRIVILEGES</code><code class="p">;</code></pre><p>Alternatively, to affect all accounts but avoid modifying the
      grant tables directly, use a stored procedure that loops through all
      accounts and executes <code>ALTER</code> <code>USER</code> for each:</p><pre data-type="programlisting" data-code-language="sql"><code class="k">CREATE</code> <code class="k">PROCEDURE</code> <code class="n">expire_all_passwords</code><code class="p">()</code>
<code class="k">BEGIN</code>
  <code class="k">DECLARE</code> <code class="n">done</code> <code class="nb">BOOLEAN</code> <code class="k">DEFAULT</code> <code class="k">FALSE</code><code class="p">;</code>
  <code class="k">DECLARE</code> <code class="n">account</code> <code class="nb">TEXT</code><code class="p">;</code>
  <code class="k">DECLARE</code> <code class="n">cur</code> <code class="k">CURSOR</code> <code class="k">FOR</code>
    <code class="k">SELECT</code> <code class="n">CONCAT</code><code class="p">(</code><code class="n">QUOTE</code><code class="p">(</code><code class="k">User</code><code class="p">),</code><code class="s1">'@'</code><code class="p">,</code><code class="n">QUOTE</code><code class="p">(</code><code class="k">Host</code><code class="p">))</code> <code class="k">AS</code> <code class="n">account</code>
    <code class="k">FROM</code> <code class="n">mysql</code><code class="p">.</code><code class="k">user</code> <code class="k">WHERE</code> <code class="k">User</code> <code class="o">&lt;&gt;</code> <code class="s1">''</code><code class="p">;</code>
  <code class="k">DECLARE</code> <code class="k">CONTINUE</code> <code class="k">HANDLER</code> <code class="k">FOR</code> <code class="k">NOT</code> <code class="k">FOUND</code> <code class="k">SET</code> <code class="n">done</code> <code class="o">=</code> <code class="k">TRUE</code><code class="p">;</code>

  <code class="k">OPEN</code> <code class="n">cur</code><code class="p">;</code>
  <code class="n">expire_loop</code><code class="p">:</code> <code class="n">LOOP</code>
    <code class="k">FETCH</code> <code class="n">cur</code> <code class="k">INTO</code> <code class="n">account</code><code class="p">;</code>
    <code class="n">IF</code> <code class="n">done</code> <code class="k">THEN</code>
      <code class="n">LEAVE</code> <code class="n">expire_loop</code><code class="p">;</code>
    <code class="k">END</code> <code class="n">IF</code><code class="p">;</code>
    <code class="k">CALL</code> <code class="n">exec_stmt</code><code class="p">(</code><code class="n">CONCAT</code><code class="p">(</code><code class="s1">'ALTER USER '</code><code class="p">,</code><code class="n">account</code><code class="p">,</code><code class="s1">' PASSWORD EXPIRE'</code><code class="p">));</code>
  <code class="k">END</code> <code class="n">LOOP</code><code class="p">;</code>
  <code class="k">CLOSE</code> <code class="n">cur</code><code class="p">;</code>
<code class="k">END</code><code class="p">;</code></pre><p>The procedure requires the <code>exec_stmt()</code>
      helper routine (see <a data-type="xref" href="ch11.xhtml#nch-routines-dynamic-sql-helpers">Recipe 11.6</a>). Scripts to create these
      routines are located in the <em class="filename">routines</em> directory of the <code>recipes</code> distribution.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="24.6 Assigning Yourself a New Password"><div class="sect1" id="nch-security-assigning-password"><h1>24.6 Assigning Yourself a New Password</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820311498640"><h2>Problem</h2><p>You want to change your password.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820311497760"><h2>Solution</h2><p>Use <code>ALTER USER</code> or <code>SET PASSWORD</code> statements.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820311496048"><h2>Discussion</h2><p>To assign yourself a new password, use the <code>SET PASSWORD</code> statement:</p><pre data-type="programlisting" data-code-language="sql">SET PASSWORD = '<em><code>my-new-password</code></em>';</pre><p><code>SET</code> <code>PASSWORD</code> permits a <code>FOR</code> clause that enables you to specify which
      account gets the new password:</p><pre data-type="programlisting" data-code-language="sql">SET PASSWORD FOR '<em><code>user_name</code></em>'@'<em><code>host_name</code></em>' = '<em><code>my-new-password</code></em>';</pre><p>This latter syntax is primarily for DBAs because it requires
      the <code>UPDATE</code> privilege
      for the <code>mysql</code> database.</p><p>
        Alternatively, use <code>ALTER USER</code> statement:
        
        </p><pre data-type="programlisting" data-code-language="sql">ALTER USER '<em><code>user_name</code></em>'@'<em><code>host_name</code></em>' IDENTIFIED BY '<em><code>my-new-password</code></em>';</pre><p>
        
      </p><p>
        If you want to use <code>ALTER USER</code> statement to assign yourself a password you can check your account name first by running function <span class="command"><em>CURRENT_USER</em></span>:
        
        </p><pre data-type="programlisting" data-code-language="sql"><code class="n">mysql</code><code class="o">&gt;</code><code> </code><strong><code class="k">SELECT</code><code> </code><code class="k">CURRENT_USER</code><code class="p">(</code><code class="p">)</code><code class="p">;</code></strong><code>
</code><code class="o">+</code><code class="c1">----------------+
</code><code class="o">|</code><code> </code><code class="k">CURRENT_USER</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------+
</code><code class="o">|</code><code> </code><code class="n">cbuser</code><code class="o">@</code><code class="o">%</code><code>       </code><code class="o">|</code><code>
</code><code class="o">+</code><code class="c1">----------------+
</code><code class="mi">1</code><code> </code><code class="k">row</code><code> </code><code class="k">in</code><code> </code><code class="k">set</code><code> </code><code class="p">(</code><code class="mi">0</code><code class="p">.</code><code class="mi">00</code><code> </code><code class="n">sec</code><code class="p">)</code></pre><p>
      </p><p>To check the strength of a password you’re considering, use the <code>VALIDATE_PASSWORD_STRENGTH()</code> function (see
      <a data-type="xref" href="#nch-security-password-strength">Recipe 24.4</a>).</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="24.7 Resetting an Expired Password"><div class="sect1" id="nch-security-reset-expired-password"><h1>24.7 Resetting an Expired Password</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820311445056"><h2>Problem</h2><p>You cannot use MySQL because your DBA expired your password.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820311444112"><h2>Solution</h2><p>Assign yourself a new password.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820311443120"><h2>Discussion</h2><p>If the MySQL administrator has expired your password, MySQL will
      let you connect, but not do much of anything else:</p><pre data-type="programlisting">$ <strong><code>mysql --user=cbuser --password</code></strong>
Enter password: <strong><code>******</code></strong>
mysql&gt; <strong><code>SELECT CURRENT_USER();</code></strong>
ERROR 1820 (HY000): You must SET PASSWORD before executing this statement</pre><p>If you see that message, reset your password so that you can work
      normally again:</p><pre data-type="programlisting">mysql&gt; <strong><code>SET PASSWORD = 'my-new-password';</code></strong>
Query OK, 0 rows affected (0.00 sec)

mysql&gt; <strong><code>SELECT CURRENT_USER();</code></strong> -- now you can work again
+------------------+
| CURRENT_USER()   |
+------------------+
| cbuser@localhost |
+------------------+
1 row in set (0.00 sec)</pre><p>Technically, MySQL does not require a <em>new</em>
      password to replace an expired password, so you can assign yourself your
      current password to unexpire it. The exception is that if the password
      policy has become more restrictive and your current password no longer
      satisfies it, a stronger password must be chosen.</p><p>For more information about changing your password, see <a data-type="xref" href="#nch-security-assigning-password">Recipe 24.6</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="24.8 Finding and Removing Anonymous Accounts"><div class="sect1" id="nch-security-anonymous-accounts"><h1>24.8 Finding and Removing Anonymous Accounts</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820311406464"><h2>Problem</h2><p>You want to ensure that your MySQL server can be used only by accounts associated with
      specific usernames.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820311405360"><h2>Solution</h2><p>Identify and remove anonymous accounts.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820311404368"><h2>Discussion</h2><p>An <q>anonymous</q> account is one that has an empty user
      part in the account name, such as <code>''@'localhost'</code>. An empty user matches any name
      because the purpose of an anonymous account is to permit anyone who
      knows its password to connect from the named host (<code>localhost</code> in this case). This is a convenience
      because the DBA need not set up individual accounts for separate users.
      But there are security implications as well:</p><ul><li><p>Such accounts often are given no password, enabling their use
          with no authentication at all.</p></li><li><p>You cannot associate database activity with specific users
          (for example, by checking the server query log or examining <code>SHOW</code>
          <code>PROCESSLIST</code> output), making it
          more difficult to tell who is doing what.</p></li></ul><p>If the preceding points persuade you that anonymous accounts are
      not a good thing, use the following instructions to identify and remove
      them:</p><ol><li><p>The <code>User</code> column is empty in
          the <code>mysql.user</code> rows for anonymous
          accounts, so you can identify them like this:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT User, Host FROM mysql.user WHERE User = '';</code></strong>
+------+---------------+
| User | Host          |
+------+---------------+
|      | %.example.com |
|      | localhost     |
+------+---------------+</pre></li><li><p>The <code>SELECT</code> output shows two
          anonymous accounts. Remove each using a <code>DROP</code>
          <code>USER</code> statement with the
          corresponding account name:</p><pre data-type="programlisting">mysql&gt; <strong><code>DROP USER ''@'localhost';</code></strong>
mysql&gt; <strong><code>DROP USER ''@'%.example.com';</code></strong></pre></li></ol></div></section></div></section><section data-type="sect1" data-pdf-bookmark="24.9 Modifying Any Host and Many Host&#10;    Accounts"><div class="sect1" id="nch-security-any-host-accounts"><h1>24.9 Modifying <q>Any Host</q> and <q>Many Host</q>
    Accounts</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820311391776"><h2>Problem</h2><p>You want to ensure that MySQL accounts cannot be used from an overly broad set of
      hosts.</p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820311390656"><h2>Solution</h2><p>Find and fix accounts containing <code>%</code> or <code>_</code> in
      the host part.</p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820311388800"><h2>Discussion</h2><p>The host part of MySQL account names can contain the SQL pattern
      characters <code>%</code> and <code>_</code> (see <a data-type="xref" href="ch07.xhtml#nch-strings-strings-pat-sql">Recipe 7.10</a>). These names match client
      connection attempts from any host that matches the pattern. For example,
      the account <code>'user1'@'%'</code> permits
      <code>user1</code> to connect from any host
      whatsoever, and <code>'user2'@'%.example.com'</code> permits <code>user2</code> to connect from any host in the <code>example.com</code> domain.</p><p>Patterns in the host part of account names provide a convenience
      that enables a DBA to create an account that permits connections from
      multiple hosts. They correspondingly increase security risks by
      increasing the number of hosts from which intruders can attempt to
      connect. If you consider this a concern, identify the accounts and
      either remove them or change the host part to be more specific.</p><p>There are several ways to find accounts with <code>%</code> or <code>_</code> in
      the host part. Here are two:</p><pre data-type="programlisting">WHERE Host LIKE '%\%%' OR Host LIKE '%\_%';
WHERE Host REGEXP '[%_]';</pre><p>The <code>LIKE</code> expression is more
      complex because we must look for each pattern character separately and
      escape it to search for literal instances. The <code>REGEXP</code> expression requires no escaping because those characters are not
      special in regular expressions, and a character class permits both to be
      found with a single pattern. So let’s use that expression:</p><ol><li><p>Identify pattern-host accounts in the <code>mysql.user</code> table like this:</p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT User, Host FROM mysql.user WHERE Host REGEXP '[%_]';</code></strong>
+-------+---------------+
| User  | Host          |
+-------+---------------+
| user1 | %             |
| user2 | %.example.com |
| user3 | _.example.com |
+-------+---------------+</pre></li><li><p>To remove an identified account, use <code>DROP</code> <code>USER</code>:</p><pre data-type="programlisting">mysql&gt; <strong><code>DROP USER 'user1'@'%';</code></strong>
mysql&gt; <strong><code>DROP USER 'user3'@'_.example.com';</code></strong></pre><p>Alternatively, rename an account to make the host part more
          specific:</p><pre data-type="programlisting">mysql&gt; <strong><code>RENAME USER 'user2'@'%.example.com' TO 'user2'@'host17.example.com';</code></strong></pre></li></ol></div></section></div></section><section data-type="sect1" data-pdf-bookmark="24.10 Using TLS (SSL)"><div class="sect1" id="nch-security-security-ssl"><h1>24.10 Using TLS (SSL)</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820311372192"><h2>Problem</h2><p>
        You want to encrypt traffic between MySQL client and the server.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820311371312"><h2>Solution</h2><p>
        Use TLS (Transport Layer Security) protocol.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820311370368"><h2>Discussion</h2><p>
        MySQL does not use anything additional to the standard TCP protocol to encrypt traffic between the client and the server. Therefore, if someone wants to read data, sent in either direction, they can easily do it with help of <span class="command"><em>tcpdump</em></span> and similar tools. Any sensitive information, such as user passwords, or stored credit card numbers, could be exposed. To prevent this, MySQL supports TLS protocol to secure communications.
      </p><div data-type="note" epub:type="note"><h6>Note</h6><p>
          Modern versions of MySQL use TLS protocol to encrypt traffic between the client and the server. However, due to historical reasons, configuration options and User Reference Manual often refer to TLS as SSL (Secure Socket Layer) even having that the latter is not used anymore, because its encryption is weak. In this book we will use the term TLS in the text whenever is possible.
        </p></div><p>
        To secure traffic between the MySQL client and the server you need:
        </p><dl><dt>On the server</dt><dd><ul><li><p>
                    Enable <code>ssl</code> option. This is the default value and you only need to ensure that it is not disabled in the configuraiton file.
                  </p></li><li><p>
                    The Certificate Authority (CA) file that could be used to verify certificates. It could be a single file, specified by the option <code>ssl_ca</code> or a path to a directory, containing multiple such files, specified by the option <code>ssl_capath</code>.
                  </p></li><li><p>
                    The public key certificate file, specified by the option <code>ssl_cert</code>. This certificate will be sent to the client to authenticate against the client’s Certificate Authority.
                  </p></li><li><p>
                    The private key, specified by the option <code>ssl_key</code>.
                  </p></li></ul></dd><dt>On the client</dt><dd><ul><li><p>
                    Specify for the option <code>ssl-mode</code> one of the following values:
                    </p><dl><dt><code>PREFERRED</code></dt><dd><p>To establish an encrypted connection if the server supports TLS and fail back to the unencrypted if it does not. This is the default value.</p></dd><dt><code>REQUIRED</code></dt><dd><p>To establish an encrypted connection if the server supports TLS and fail connection attempt if it does not.</p></dd><dt><code>VERIFY_CA</code></dt><dd><p>Performs the same check as <code>REQUIRED</code> and additionally verifies the server CA file against the configured CA certificates.</p></dd><dt><code>VERIFY_IDENTITY</code></dt><dd><p>Performs the same check as <code>VERIFY_CA</code> and additionally performs host name verification. That’s said the server certificate should have client’s host name either in the <code>"Subject Alternative Name"</code> or the <code>"Common Name"</code> fields.</p></dd></dl><p>
                    Value <code>DISABLED</code> disables TLS connections and should not be used if you want to encrypt client-server traffic.
                  </p></li><li><p>
                    The Certificate Authority (CA) file that could be used to verify certificates. It could be a single file, specified by the option <code>ssl_ca</code> or a path to a directory, containing multiple such files, specified by the option <code>ssl_capath</code>.
                  </p></li><li><p>
                    The public key certificate file, specified by the option <code>ssl_cert</code>. This certificate will be sent to the server to authenticate against the server’s Certificate Authority.
                  </p></li><li><p>
                    The private key, specified by the option <code>ssl_key</code>.
                  </p></li></ul></dd></dl><p>
      </p><div data-type="note" epub:type="note"><h6>Note</h6><p>
          All the Certificate Authority, certificate and key files should be in <code>PEM</code> format.
        </p></div><p>
        If MySQL Server started with the option <code>ssl</code> enabled, but with empty values for other encryption-related options, if will search for the TLS keys and certificates in the data directory. If found, they will be used. Otherwise TLS support will be disabled.
      </p><p>
        Once you have all these pre-requisites you may test the TLS connection:
        </p><pre data-type="programlisting">$ <strong><code>mysql</code></strong>
mysql&gt; <strong><code>\s</code></strong>
--------------
../bin/mysql  Ver 8.0.21 for Linux on x86_64 (Source distribution)

Connection id:		534
Current database:	
Current user:		root@localhost
SSL:			Cipher in use is TLS_AES_256_GCM_SHA384
...
mysql&gt; <strong><code>SHOW VARIABLES LIKE 'have_ssl';</code></strong>
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| have_ssl      | YES   |
+---------------+-------+
1 row in set (0.01 sec)</pre><p>
      </p><p>
        MySQL supports options to further restrict TLS connections, such as <code>ssl-cipher</code>, requiring to use only specified ciphers. Consult <a href="https://dev.mysql.com/doc/refman/8.0/en/using-encrypted-connections.html">“Configuring MySQL to Use Encrypted Connections”</a> in the MySQL User Reference Manual for further details.
      </p><section data-type="sect3" data-pdf-bookmark="Creating Self-Signed Certificates"><div class="sect3" id="idm45820311343712"><h3>Creating Self-Signed Certificates</h3><p>
          MySQL distribution includes <span class="command"><em>mysql_ssl_rsa_setup</em></span> command that can create self-signed keys and certificates. It invokes <span class="command"><em>openssl</em></span> command and can be used as:
          </p><pre data-type="programlisting">$ <strong><code>mysql_ssl_rsa_setup --datadir=./data</code></strong>
Ignoring -days; not generating a certificate
Generating a RSA private key
..............................................................................+++++
..............+++++
writing new private key to 'ca-key.pem'
-----
Ignoring -days; not generating a certificate
Generating a RSA private key
....................................+++++
...........................................+++++
writing new private key to 'server-key.pem'
-----
Ignoring -days; not generating a certificate
Generating a RSA private key
..............................................................................+++++
.....................................+++++
writing new private key to 'client-key.pem'
-----</pre><p>
          Upon completetion it creates in the data directory files as listed in the <a data-type="xref" href="#nch-security-security-ssl-files">Table 24-2</a>
          </p><table id="nch-security-security-ssl-files"><caption><span class="label">Table 24-2. </span>Files, created by <span class="command"><em>mysql_ssl_rsa_setup</em></span></caption><thead><tr><th>File</th><th>Description</th></tr></thead><tbody><tr><td><code>ca.pem</code></td><td>Self-signed Certificate Authority (CA)</td></tr><tr><td><code>ca-key.pem</code></td><td>CA private key</td></tr><tr><td><code>server-cert.pem</code></td><td>Server certificate</td></tr><tr><td><code>server-key.pem</code></td><td>Server key</td></tr><tr><td><code>client-cert.pem</code></td><td>Client certificate</td></tr><tr><td><code>client-key.pem</code></td><td>Client key</td></tr><tr><td><code>private_key.pem</code></td><td>RSA private key to use over unencrypted connection for accounts, authenticated by either <code>sha256_password</code> or <code>caching_sha2_password</code> plugins</td></tr><tr><td><code>public_key.pem</code></td><td>RSA public key to use over unencrypted connection for accounts, authenticated by either <code>sha256_password</code> or <code>caching_sha2_password</code> plugins</td></tr></tbody></table><p>
        </p><p>
          Keys and certificates, created by the <span class="command"><em>mysql_ssl_rsa_setup</em></span>, are very basic and do not contain such fields as <code>"Common Name"</code>. If you want to add these custom values to your TLS files you need to create them manually. We will not include instructions on how to do so in the book, because there are plenty of documentation, available online, including <a href="https://dev.mysql.com/doc/refman/8.0/en/creating-ssl-rsa-files.html">Creating SSL and RSA Certificates and Keys</a> in the MySQL User Reference Manual. Alternatively you may perform a test run of the <span class="command"><em>mysql_ssl_rsa_setup</em></span> command with option <code>--verbose</code> that will print <span class="command"><em>openssl</em></span> commands it executes. You will only need to repeat them with custom options.
        </p><div data-type="tip"><h6>Tip</h6><p>
            If you simply want to test how MySQL TLS connections work and do not want to create any new keys and certificates, you may use standard keys and certificates from the <a href="https://dev.mysql.com/doc/extending-mysql/8.0/en/mysql-test-suite.html">MySQL Test Suite</a>, located inside the <code>mysql-test/std_data</code> directory of your MySQL installation.
          </p></div></div></section></div></section></div></section><section data-type="sect1" data-pdf-bookmark="24.11 Using Roles"><div class="sect1" id="nch-security-security-roles"><h1>24.11 Using Roles</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820311319248"><h2>Problem</h2><p>
        You want to grant the same set of privileges to different users, but do not want them to share the same user account.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820311318160"><h2>Solution</h2><p>
        Use roles.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820311317216"><h2>Discussion</h2><p>
        When MySQL installation is used by multiple people you may need to give similar privileges to some of them. For example, application users may need access to tables in their application database while administrators may need to execute administrative commands. While you have a single application user or single database administrator you can simply create two user accounts. But when your organization and MySQL usage grows you may need to allow different people to perform the same tasks.
      </p><p>
        You may resolve such a problem by sharing single user account between different people. But this is insecure  for various reasons, including situation when a user leaves the company, and should lose access to the database. Or, if someone from the group leaks their access credentials all the database users are compromised.
      </p><p>
        Another solution is to duplicate privilege lists for individual user accounts. While it is more secure it becomes error-prone when you need to add or remove a privilege. Doing it manually for dozens of users may easily lead to mistakes.
      </p><p>
        To resolve these drawbacks, MySQL 8.0 introduced roles that are, practically, are the named collections of privileges.
      </p><p>
        You can create a role like any other user account. You just do not need to specify access credentials for it.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>CREATE ROLE cookbook, admin;</code></strong>
Query OK, 0 rows affected (0.00 sec)</pre><p>
        In the listing above we created a role <code>cookbook</code> that will have access to the cookbook database and a role <code>admin</code> that will be used for the database administration.
      </p><p>
        Next step is to assign privileges to our new roles.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>GRANT SELECT, INSERT, UPDATE, DELETE, EXECUTE ON cookbook.* TO 'cookbook';</code></strong>
Query OK, 0 rows affected (0.00 sec)

mysql&gt; <strong><code>GRANT GROUP_REPLICATION_ADMIN, PERSIST_RO_VARIABLES_ADMIN, </code></strong>
    -&gt; <strong><code>REPLICATION_SLAVE_ADMIN, RESOURCE_GROUP_ADMIN, </code></strong>
    -&gt; <strong><code>ROLE_ADMIN, SYSTEM_VARIABLES_ADMIN, SYSTEM_USER,</code></strong>
    -&gt; <strong><code>RELOAD, SHUTDOWN ON *.* to 'admin';</code></strong>
Query OK, 0 rows affected (0.01 sec)</pre><p>
      </p><p>
        Once roles are set up, we can assign them to different users. For example, to give access to the <code>cookbook</code> database to users <code>cbuser</code>, <code>sveta</code> and <code>alkin</code> use these commands:
        </p><pre data-type="programlisting">mysql&gt; <strong><code>GRANT cookbook TO cbuser;</code></strong>
Query OK, 0 rows affected (0.01 sec)

mysql&gt; <strong><code>GRANT cookbook TO sveta;</code></strong>
Query OK, 0 rows affected (0.00 sec)

mysql&gt; <strong><code>GRANT cookbook TO alkin;</code></strong>
Query OK, 0 rows affected (0.00 sec)</pre><p>
     To grant administrator access to users <code>paul</code> and <code>amelia</code> use commands:
     </p><pre data-type="programlisting">mysql&gt; <strong><code>GRANT admin TO paul;</code></strong>
Query OK, 0 rows affected (0.00 sec)

mysql&gt; <strong><code>GRANT admin TO amelia;</code></strong>
Query OK, 0 rows affected (0.01 sec)</pre><p>
    </p><p>
      Revoking role access is as easy as granting:
      </p><pre data-type="programlisting">mysql&gt; <strong><code>REVOKE cookbook FROM sveta;</code></strong>
Query OK, 0 rows affected (0.01 sec)</pre><p>
    </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820311316912"><h2>See Also</h2><p>MySQL supports other operations with roles, such as setting default role for the newly added users or activating and de-activating roles. For additional information about roles in MySQL,
      see <a href="https://dev.mysql.com/doc/refman/8.0/en/roles.html">Using Roles in the MySQL User Reference Manual</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="24.12 Using Views to Secure Data Access"><div class="sect1" id="nch-security-security-views"><h1>24.12 Using Views to Secure Data Access</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820311295920"><h2>Problem</h2><p>
        You want to give users access only to certain query results, but do not want them to see the actual data, stored in the tables.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820311294784"><h2>Solution</h2><p>
        Use views.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820311293792"><h2>Discussion</h2><p>
        You may want certain users to be able to get access to the query results, but want to cover real data, stored in the tables. For example, the statistical department may want to know the number of patients in the hospital, their gender and age distribution, and how this data correlates to the recovery rate, but should not have access to actual data of the patients, such as their names, ID numbers or be able to correlate their identity and diagnosis.
      </p><p>
        To achieve this goal you may create a view, querying for certain data and grant specific users access only to this view.
      </p><p>
        Consider a <code>patients</code> table:
        </p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW CREATE TABLE patients\G</code></strong>
*************************** 1. row ***************************
       Table: patients
Create Table: CREATE TABLE `patients` (
  `id` int NOT NULL AUTO_INCREMENT,
  `national_id` char(32) DEFAULT NULL,
  `name` varchar(255) DEFAULT NULL,
  `surname` varchar(255) DEFAULT NULL,
  `gender` enum('F','M') DEFAULT NULL,
  `age` tinyint unsigned DEFAULT NULL,
  `additional_data` json DEFAULT NULL,
  `diagnosis` varchar(255) DEFAULT NULL,
  `result` enum('R','N','D') DEFAULT NULL ↩
    COMMENT 'R=Recovered, N=Not Recovered, D=Dead',
  `date_arrived` date NOT NULL,
  `date_departed` date DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=21 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.00 sec)</pre><p>
      </p><p>
        If you want to give access for this data to statistical department you may want to expose access to the <code>gender</code>, <code>age</code>, <code>diagnosis</code>, <code>result</code> columns, but want to restrict access to <code>national_id</code>, <code>name</code>, <code>surname</code> and  <code>additional_data</code>. You also may want to let them know how many days a patient spent in the hospital and in which month and year they arrived, but do not want let them explore actual arriving and departing dates. In other words, restrict access to <code>date_arrived</code> and <code>date_departed</code> still providing data that could be calculated based on values, stored in these columns.
      </p><p>
        You can do this by creating a view:
        </p><pre data-type="programlisting">mysql&gt; <strong><code>CREATE VIEW patients_statistics AS </code></strong>
    -&gt; <strong><code>  SELECT age, gender, diagnosis, result, </code></strong>
    -&gt; <strong><code>         datediff(date_departed, date_arrived) as recovered_time,</code></strong>
    -&gt; <strong><code>         MONTH(date_arrived) AS month_arrived, </code></strong>
    -&gt; <strong><code>         YEAR(date_arrived) AS year_arrived</code></strong>
    -&gt; <strong><code>  FROM patients;</code></strong>
Query OK, 0 rows affected (0.03 sec)</pre><p>
      </p><p>
        Then create a user for the statistics department that has read-only access to this view and does not have access to the underlying table.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>CREATE USER statistics;</code></strong>
Query OK, 0 rows affected (0.03 sec)

mysql&gt; <strong><code>GRANT SELECT ON cookbook.patients_statistics TO statistics;</code></strong>
Query OK, 0 rows affected (0.02 sec)</pre><p>
      </p><p>
        Now statistics department can login and run analytical queries, such as finding a most frequent diagnosis, or how many patients with such a diagnosis arrived per month.
        </p><pre data-type="programlisting"># <strong><code>mysql cookbook -A -ustatistics</code></strong>
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 17
...
mysql&gt; <strong><code>SELECT diagnosis, AVG(recovered_time) AS recovered_time_avg, COUNT(*) AS cases</code></strong>
    -&gt; <strong><code>FROM patients_statistics WHERE year_arrived='2020'</code></strong>
    -&gt; <strong><code>GROUP BY diagnosis ORDER BY cases DESC;</code></strong>
+---------------+--------------------+-------+
| diagnosis     | recovered_time_avg | cases |
+---------------+--------------------+-------+
| Data Phobia   |            24.8333 |     6 |
| Diabetes      |            10.0000 |     4 |
| Asthma        |            10.3333 |     3 |
| Arthritis     |            22.0000 |     3 |
| Appendicitis  |             5.5000 |     2 |
| Breast Cancer |            75.0000 |     2 |
+---------------+--------------------+-------+
6 rows in set (0.00 sec)

mysql&gt; <strong><code>SELECT diagnosis, month_arrived, COUNT(*) AS month_cases</code></strong>
    -&gt; <strong><code>FROM patients_statistics WHERE diagnosis='Data Phobia' AND year_arrived='2020'</code></strong>
    -&gt; <strong><code>GROUP BY diagnosis, month_arrived ORDER BY month_arrived;</code></strong>
+--------------+---------------+-------------+
| diagnosis    | month_arrived | month_cases |
+--------------+---------------+-------------+
| Data Phobia  |             4 |           1 |
| Data Phobia  |             9 |           2 |
| Data Phobia  |            10 |           2 |
| Data Phobia  |            11 |           1 |
+--------------+---------------+-------------+
4 rows in set (0.00 sec)</pre><p>
      </p><p>
        But they would not be able to access the table data directly:
        </p><pre data-type="programlisting">mysql&gt; <strong><code>SELECT * FROM patients;</code></strong>
ERROR 1142 (42000): SELECT command denied to user 'statistics'@'localhost' ↩
                                          for table 'patients'

mysql&gt; <strong><code>SELECT diagnosis, result, date_arrived FROM patients;</code></strong>
ERROR 1142 (42000): SELECT command denied to user 'statistics'@'localhost' ↩
                                          for table 'patients'</pre><p>
      </p><div data-type="note" epub:type="note"><h6>Note</h6><p>
        Views support <code>SQL SECURITY</code> clause, allowing to specify security context when executing a view. This clause discussed in detail in <a data-type="xref" href="#nch-security-security-routines">Recipe 24.13</a>.
      </p></div></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820311293488"><h2>See Also</h2><p>For additional information about using views,
      see <a data-type="xref" href="ch05.xhtml#nch-select-select-view">Recipe 5.7</a>.</p></div></section></div></section><section data-type="sect1" data-pdf-bookmark="24.13 Using Stored Routines to Secure Data Modifications"><div class="sect1" id="nch-security-security-routines"><h1>24.13 Using Stored Routines to Secure Data Modifications</h1><section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45820311264608"><h2>Problem</h2><p>
        You want to let users to modify their personal data, but want to prevent them from accessing similar data for others.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45820311263488"><h2>Solution</h2><p>
        Use stored routines.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45820311262544"><h2>Discussion</h2><p>
        You may want to let users to view and change their own personal information. For example, patients can marry and change surname or decide to add new additional information about themselves, such as address, weight and so on. But you do not want them to see similar information for other patients. In this case restricting access only on the column level would not work.
      </p><p>
        Stored routines support <code>SQL SECURITY</code> clause that allows you to specify if you want to execute the routine with access privileges of the <code>DEFINER</code>: user that created the procedure or <code>INVOKER</code>: user that is currently executing the procedure.
      </p><p>
        In our case we do not want to grant <code>INVOKER</code> any privilege that allows them to access data, stored in the sensitive columns. Therefore we need to grant such privileges to the <code>DEFINER</code> of the procedure and specify argument <code>SQL SECURITY DEFINER</code>.
      </p><div data-type="tip"><h6>Tip</h6><p>
          The default value for <code>SQL SECURITY</code> is  <code>DEFINER</code>, therefore this clause could be omitted.
        </p></div><p>
        To illustrate this let’s take <code>patients</code> table from the previous recipe. But now we will access only columns, containing sensitive data.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW CREATE TABLE patients\G</code></strong>
*************************** 1. row ***************************
       Table: patients
Create Table: CREATE TABLE `patients` (
  ...
  `national_id` char(32) DEFAULT NULL,
  `name` varchar(255) DEFAULT NULL,
  `surname` varchar(255) DEFAULT NULL,
  ...
  `additional_data` json DEFAULT NULL,
  ...</pre><p>
      </p><p>
        First, let’s prepare a user that will be a  <code>DEFINER</code> for our procedure. We do not want this account to be used by anyone, except the stored routine, so first let’s install  <code>mysql_no_login</code> authentication plugin.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>INSTALL PLUGIN mysql_no_login SONAME 'mysql_no_login.so';</code></strong>
Query OK, 0 rows affected (0.01 sec)</pre><p>
      </p><p>
        Then let’s create the user account and grant it access on the table  <code>patients</code>.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>CREATE USER sp_access IDENTIFIED WITH mysql_no_login;</code></strong>
Query OK, 0 rows affected (0.00 sec)

mysql&gt; <strong><code>GRANT SELECT, UPDATE ON cookbook.patients TO sp_access;</code></strong>
Query OK, 0 rows affected (0.01 sec)</pre><p>
      </p><p>
        Now let’s create a procedure that will return sensitive data for a patient, identified by  <code>national_id</code>.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>delimiter $$</code></strong>
mysql&gt; <strong><code>CREATE DEFINER='sp_access'@'%' PROCEDURE get_patient_data(IN nat_id CHAR(32)) </code></strong>
    -&gt; <strong><code>  SQL SECURITY DEFINER</code></strong>
    -&gt; <strong><code>  BEGIN</code></strong>
    -&gt; <strong><code>    SELECT name, surname, gender, age, additional_data </code></strong>
    -&gt; <strong><code>    FROM patients WHERE national_id=nat_id;</code></strong>
    -&gt; <strong><code>  END</code></strong>
    -&gt; <strong><code>$$</code></strong>
Query OK, 0 rows affected (0.01 sec)

mysql&gt; <strong><code>delimiter ;</code></strong></pre><p>
      </p><p>
        And a procedure that will update the record.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>delimiter $$</code></strong>
mysql&gt; <strong><code>CREATE DEFINER='sp_access'@'%' PROCEDURE update_patient_data(</code></strong>
    -&gt; <strong><code>                                           IN nat_id CHAR(32),</code></strong>
    -&gt; <strong><code>                                           IN new_name varchar(255),</code></strong>
    -&gt; <strong><code>                                           IN new_surname varchar(255),</code></strong>
    -&gt; <strong><code>                                           IN new_additional_data JSON)</code></strong>
    -&gt; <strong><code>  SQL SECURITY DEFINER</code></strong>
    -&gt; <strong><code>  BEGIN</code></strong>
    -&gt; <strong><code>    UPDATE patients </code></strong>
    -&gt; <strong><code>      SET name=COALESCE(new_name, name),</code></strong>
    -&gt; <strong><code>          surname=COALESCE(new_surname, surname),</code></strong>
    -&gt; <strong><code>          additional_data=JSON_MERGE_PATCH(COALESCE(additional_data, '{}'),</code></strong>
    -&gt; <strong><code>                                           COALESCE(new_additional_data, '{}'))</code></strong>
    -&gt; <strong><code>      WHERE national_id=nat_id;</code></strong>
    -&gt; <strong><code>  END</code></strong>
    -&gt; <strong><code>$$</code></strong>
Query OK, 0 rows affected (0.01 sec)

mysql&gt; <strong><code>delimiter ;</code></strong></pre><p>
      </p><p>
        Then, add privileges to execute these procedures to our  <code>DEFINER</code>.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>GRANT EXECUTE ON PROCEDURE cookbook.get_patient_data TO sp_access;</code></strong>
Query OK, 0 rows affected (0.01 sec)

mysql&gt; <strong><code>GRANT EXECUTE ON PROCEDURE cookbook.update_patient_data TO sp_access;</code></strong>
Query OK, 0 rows affected (0.00 sec)</pre><p>
      </p><p>
        Finally, let’s create a user that will use these procedures without any additional privileges.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>CREATE USER patient;</code></strong>
Query OK, 0 rows affected (0.01 sec)

mysql&gt; <strong><code>GRANT EXECUTE ON PROCEDURE cookbook.get_patient_data TO patient;</code></strong>
Query OK, 0 rows affected (0.02 sec)

mysql&gt; <strong><code>GRANT EXECUTE ON PROCEDURE cookbook.update_patient_data TO patient;</code></strong>
Query OK, 0 rows affected (0.01 sec)</pre><p>
      </p><p>
        Now let’s login as this user and check how our procedures work.
        </p><pre data-type="programlisting">mysql&gt; <strong><code>SHOW GRANTS;</code></strong>
+------------------------------------------------------------------------------+
| Grants for patient@%                                                         |
+------------------------------------------------------------------------------+
| GRANT USAGE ON *.* TO `patient`@`%`                                          |
| GRANT EXECUTE ON PROCEDURE `cookbook`.`get_patient_data` TO `patient`@`%`    |
| GRANT EXECUTE ON PROCEDURE `cookbook`.`update_patient_data` TO `patient`@`%` |
+------------------------------------------------------------------------------+
3 rows in set (0.00 sec)

mysql&gt; <strong><code>CALL update_patient_data('89AR642465', NULL, 'Johnson',</code></strong>
    -&gt; <strong><code>' {"Height": 165, "Weight": 55, "Hair color": "Blonde"}');</code></strong>
Query OK, 1 row affected (0.00 sec)

mysql&gt; <strong><code>CALL get_patient_data('89AR642465')\G</code></strong>
*************************** 1. row ***************************
           name: Mary
        surname: Johnson
         gender: F
            age: 24
additional_data: {"Height": 165, "Weight": 55, "Hair color": "Blonde"}
1 row in set (0.00 sec)

Query OK, 0 rows affected (0.00 sec)</pre><p>
      </p><p>
        As you see we can change details for the specific patient, identifying them by a national ID while having no access to the data of other patients.
      </p></div></section><section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45820311262080"><h2>See Also</h2><p>For additional information about stored routines,
      see <a data-type="xref" href="ch11.xhtml#nch-routines">Chapter 11</a>.</p></div></section></div></section></div></section></div></body></html>