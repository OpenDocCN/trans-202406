<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 3. Node.js" class="calibre4"><div class="preface" id="ch_nodejs">
<h1 class="calibre12"><span class="keep-together">Chapter 3. </span>Node.js</h1>


<p class="author1">Outside browsers, there’s only one JavaScript runtime of note, and that’s <em class="calibre7">Node.js</em>.<sup class="calibre39"><a data-type="noteref" id="idm45995923445880-marker" href="ch03.xhtml#idm45995923445880" class="calibre40">1</a></sup> Although it started as a platform emphasizing single-threaded concurrency in servers with continuation-passing style callbacks, a lot of effort went into making it a general-purpose programming platform.</p>

<p class="author1">Many tasks performed by Node.js programs don’t fit into its traditional use case of serving web requests or handling network connections. Instead, a lot of newer Node.js programs are command-line tools acting as build systems, or parts of them, for JavaScript. Such programs are typically heavy on I/O operations, just like servers are, but they also typically do a lot of data processing.</p>

<p class="author1">For example, tools like <a href="https://babeljs.io" class="calibre6">Babel</a> and <a href="https://typescriptlang.org" class="calibre6">TypeScript</a> will transform your code from one language (or language version) to another. Tools like <a href="https://webpack.js.org" class="calibre6">Webpack</a>, <a href="https://rollupjs.org" class="calibre6">Rollup</a>, and <a href="https://parceljs.org" class="calibre6">Parcel</a> will bundle and minify your code for distribution to your web frontend or to other environments where load times are crucial, like serverless environments. In situations like these, while there’s a lot of filesystem I/O going on, there’s also a lot of data processing, which is generally done synchronously. These are the sorts of situations where parallelism is handy and might get the job done quicker.</p>

<p class="author1">Parallelism can also be useful in the <a data-type="indexterm" data-primary="parallelism" data-secondary="Node.js and" id="idm45995923374968" class="calibre6"/><a data-type="indexterm" data-primary="Node.js" data-secondary="parallelism" id="idm45995923757080" class="calibre6"/>original Node.js use case, which is servers. Data processing may happen a lot, <a data-type="indexterm" data-primary="data processing, Node.js" id="idm45995923756008" class="calibre6"/><a data-type="indexterm" data-primary="Node.js" data-secondary="data processing" id="idm45995923755320" class="calibre6"/><a data-type="indexterm" data-primary="SSR (server side rendering)" id="idm45995923754376" class="calibre6"/><a data-type="indexterm" data-primary="Node.js" data-secondary="server side rendering" id="idm45995923753688" class="calibre6"/>depending on your application. For example, <em class="calibre7">server side rendering (SSR)</em> involves a lot of string manipulation where the source data is already known. This is one of many examples where we might want to add parallelism to 
<span class="keep-together">our solutions</span>. <a data-type="xref" href="ch08.xhtml#ch_benchmarks_sec_usage" class="calibre6">“When to Use”</a> examines a situation where parallelism improves template rendering time.</p>

<p class="author1">Today, we have <code class="calibre18">worker_threads</code> for parallelizing <a data-type="indexterm" data-primary="worker threads" data-secondary="parallelism and" id="idm45995923512376" class="calibre6"/><a data-type="indexterm" data-primary="parallelism" data-secondary="worker threads" id="idm45995923511368" class="calibre6"/>our code. This wasn’t always the case, but that didn’t mean we were limited to single-threaded concurrency.</p>






<section data-type="sect1" data-pdf-bookmark="Before We Had Threads" class="calibre4"><div class="preface" id="idm45995923510040">
<h1 class="calibre13">Before We Had Threads</h1>

<p class="author1">Prior to threads being available in Node.js, if you wanted to take advantage of CPU cores, you needed to use <a data-type="indexterm" data-primary="processes" id="idm45995923508216" class="calibre6"/>processes. As discussed in <a data-type="xref" href="ch01.xhtml#ch_intro" class="calibre6">Chapter 1</a>, we don’t get some of the benefits we’d get from threads if we use processes. That being said, if shared memory isn’t important (and in many cases it isn’t!) then processes are perfectly able to solve these kinds of problems for you.</p>

<p class="author1">Consider <a data-type="xref" href="ch01.xhtml#fig_http_worker_threads_sequence" class="calibre6">Figure 1-1</a> from <a data-type="xref" href="ch01.xhtml#ch_intro" class="calibre6">Chapter 1</a>. In that scenario, we have threads responding to HTTP requests sent to them from a main thread, which is listening on a port. While this concept is great for handling traffic from several CPU cores, we can also use processes to achieve a similar effect. It might look something like <a data-type="xref" href="#fig_http_processes_sequence" class="calibre6">Figure 3-1</a>.</p>

<figure class="calibre29"><div id="fig_http_processes_sequence" class="figure">
<img src="Images/mtjs_0301.png" alt="A web server system might offload work to processes on a round-robin basis." class="calibre57"/>
<h6 class="calibre30"><span class="keep-together">Figure 3-1. </span>Processes as they might be used in an HTTP server</h6>
</div></figure>

<p class="author1">Although we could do <a data-type="indexterm" data-primary="cluster process" id="idm45995923745928" class="calibre6"/><a data-type="indexterm" data-primary="processes" data-secondary="cluster" id="idm45995923745192" class="calibre6"/>something like this using the <code class="calibre18">child_process</code> API in Node.js, we’re better off using <code class="calibre18">cluster</code>, which was purpose-built for this use case. This module’s purpose is to spread network traffic across several worker processes. Let’s go ahead and use it in a simple “Hello, World” example.</p>

<p class="author1">The code in <a data-type="xref" href="#ex_nodejs_hello_world" class="calibre6">Example 3-1</a> is a standard HTTP server in Node.js. It simply responds to any request, regardless of path or method, with “Hello, World!” followed by a new line character.</p>
<div id="ex_nodejs_hello_world" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-1. </span>A “Hello, World” server in Node.js</h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code> <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s">'http'</code><code class="p">);</code>

<code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s">'Hello, World!\n'</code><code class="p">);</code>
<code class="p">}).</code><code class="nx">listen</code><code class="p">(</code><code class="mi">3000</code><code class="p">);</code></pre></div>

<p class="author1">Now, let’s add four processes with <code class="calibre18">cluster</code>. With the <code class="calibre18">cluster</code> module, the common approach is <a data-type="indexterm" data-primary="cluster module" data-secondary="if block" id="idm45995923305512" class="calibre6"/><a data-type="indexterm" data-primary="processes" data-secondary="cluster module, if block" id="idm45995923304632" class="calibre6"/><a data-type="indexterm" data-primary="if block" id="idm45995923303720" class="calibre6"/><a data-type="indexterm" data-primary="blocks, if block" id="idm45995923303048" class="calibre6"/>to use an <code class="calibre18">if</code> block to detect whether we’re in the main listening process or one of the worker processes. If we’re in the main process, then we have to do the work of spawning the worker processes. Otherwise, we just set up an ordinary web server as before in each of the workers. This should look something like <a data-type="xref" href="#ex_nodejs_hello_world_cluster" class="calibre6">Example 3-2</a>.</p>
<div id="ex_nodejs_hello_world_cluster" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-2. </span>A “Hello, World” server in Node.js using <code class="calibre18">cluster</code></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code><code class="calibre18"> </code><code class="nx">http</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">require</code><code class="p">(</code><code class="s">'http'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">cluster</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">require</code><code class="p">(</code><code class="s">'cluster'</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO1-1" href="#callout_node_js_CO1-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">

</code><code class="kr">if</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">cluster</code><code class="p">.</code><code class="nx">isPrimary</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO1-2" href="#callout_node_js_CO1-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">
  </code><code class="nx">cluster</code><code class="p">.</code><code class="nx">fork</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO1-3" href="#callout_node_js_CO1-3"><img src="Images/3.png" alt="3" class="calibre32"/></a><code class="calibre18">
  </code><code class="nx">cluster</code><code class="p">.</code><code class="nx">fork</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="nx">cluster</code><code class="p">.</code><code class="nx">fork</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="nx">cluster</code><code class="p">.</code><code class="nx">fork</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code><code class="calibre18"> </code><code class="kr">else</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
  </code><code class="nx">http</code><code class="p">.</code><code class="nx">createServer</code><code class="p">(</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">res</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
    </code><code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s">'Hello, World!\n'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="p">}</code><code class="p">)</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="mi">3000</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO1-4" href="#callout_node_js_CO1-4"><img src="Images/4.png" alt="4" class="calibre32"/></a><code class="calibre18">
</code><code class="p">}</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO1-1" href="#co_node_js_CO1-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Require the <code class="calibre18">cluster</code> module.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO1-2" href="#co_node_js_CO1-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Change code paths depending on whether we’re in the primary process.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO1-3" href="#co_node_js_CO1-3"><img src="Images/3.png" alt="3" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">In the primary process, create four worker processes.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO1-4" href="#co_node_js_CO1-4"><img src="Images/4.png" alt="4" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">In the worker processes, create a web server and listen, like in <a data-type="xref" href="#ex_nodejs_hello_world" class="calibre6">Example 3-1</a>.</p></dd>
</dl></div>

<p class="author1">You may notice that we’re creating web servers that listen on the same port in four difference processes. It seems like a mistake. After all, if we try to bind a server to a port that’s already <a data-type="indexterm" data-primary="ports, listening on" id="idm45995922979912" class="calibre6"/>being used, we usually get an error. Don’t worry! We’re not actually listening on the same port four times. It turns out Node.js does some magic for us in <code class="calibre18">cluster</code>.</p>

<p class="author1">When worker processes are set up <a data-type="indexterm" data-primary="listen() function" id="idm45995922978344" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="listen()" id="idm45995922977736" class="calibre6"/>in a cluster, any call to <code class="calibre18">listen()</code> will actually cause Node.js to listen on the primary process rather than on the worker. Then, once a connection is received in the primary process, it’s handed off to a worker process via IPC. On most systems, this happens on a round-robin basis. This somewhat convoluted system is how each worker can <em class="calibre7">appear</em> to be listening on the same port, when in fact it’s just the primary process listening on that port and passing connections off to all the workers.</p>
<div data-type="note" epub:type="note" class="calibre22"><h6 class="calibre23">Note</h6>
<p class="author1">Historically, the <code class="calibre18">isPrimary</code> property on <code class="calibre18">cluster</code> used to be called <code class="calibre18">isMaster</code>, and for <a data-type="indexterm" data-primary="cluster module" data-secondary="isPrimary property" id="idm45995922973480" class="calibre6"/><a data-type="indexterm" data-primary="cluster module" data-secondary="isMaster property" id="idm45995922972632" class="calibre6"/>compatibility reasons, it’s still there as an alias at time of writing. The change was introduced in Node.js v16.0.0.</p>

<p class="author1">This change was made in an effort to reduce the amount of potentially harmful language in Node.js. The project aims to be a welcoming community, and words with a given usage that are rooted in a history of slavery are antithetical to that goal.</p>
</div>

<p class="author1">Processes incur some extra overhead that threads don’t, and we also don’t get shared memory, which helps with faster transfer of data. For that, we need the <code class="calibre18">worker_threads</code> module.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="The worker_threads Module" class="calibre4"><div class="preface" id="ch_nodejs_sec_workermodule">
<h1 class="calibre13">The worker_threads Module</h1>

<p class="author1">Node.js’s support for threads <a data-type="indexterm" data-primary="modules" data-secondary="worker_threads" id="modworkthr" class="calibre6"/><a data-type="indexterm" data-primary="worker_threads module" id="idm45995922966920" class="calibre6"/>is in a built-in module called <code class="calibre18">worker_threads</code>. It provides an interface to threads that mimics a lot of what you’d find in web browsers for web workers. Since Node.js is not a web browser, not all the APIs are the same, and the environment inside these worker threads isn’t the same as what you’d find inside web workers.</p>

<p class="author1">Instead, inside Node.js worker threads you’ll find <a data-type="indexterm" data-primary="Node.js API" id="idm45995922965112" class="calibre6"/><a data-type="indexterm" data-primary="API (application programming interface)" data-secondary="Node.js" id="idm45995922964504" class="calibre6"/>the usual Node.js API available via <code class="calibre18">require</code>, or <code class="calibre18">import</code> if you’re using ESM. There are a few differences in the API compared to the main thread though:</p>

<ul class="printings">
<li class="calibre10">
<p class="author1">You can’t exit the program with <code class="calibre18">process.exit()</code>. Instead this will just exit the thread.</p>
</li>
<li class="calibre10">
<p class="author1">You can’t change working directories with <code class="calibre18">process.chdir()</code>. In fact, this function is not even available.</p>
</li>
<li class="calibre10">
<p class="author1">You can’t handle signals with <code class="calibre18">process.on()</code>.</p>
</li>
</ul>

<p class="author1">Another important thing <a data-type="indexterm" data-primary="libuv worker pool" id="idm45995922958424" class="calibre6"/><a data-type="indexterm" data-primary="worker threads" data-secondary="libuv worker pool" id="idm45995922957400" class="calibre6"/><a data-type="indexterm" data-primary="worker_threads module" data-secondary="libuv worker pool" id="idm45995922956552" class="calibre6"/>to note is that the <code class="calibre18">libuv</code> worker pool is shared across worker threads. Recall <a data-type="xref" href="ch01.xhtml#sec_hidden_threads" class="calibre6">“Hidden Threads”</a>, where it was noted that the <code class="calibre18">libuv</code> thread pool consists of a default of four threads to create nonblocking interfaces to low-level blocking APIs. If you’re finding yourself bound by that thread pool’s size (due to, for example, a lot of filesystem I/O), you’ll find that adding more threads 
<span class="keep-together">via <code class="calibre18">worker_threads</code> won’t</span> lighten the load. Instead, apart from considering various 
<span class="keep-together">caching</span> solutions and other optimizations, consider increasing your <code class="calibre18">UV_THREADPOOL_SIZE</code>. Likewise, you might find that you have little choice but to increase this when adding JavaScript threads via the <code class="calibre18">worker_threads</code> module, due to their usage of the <code class="calibre18">libuv</code> thread pool.</p>

<p class="author1">There are other caveats too, so you’re encouraged to have a look at the <a href="https://oreil.ly/CYxtz" class="calibre6">Node.js documentation</a> for a full list of differences for your particular 
<span class="keep-together">version</span> of Node.js.</p>

<p class="author1">You can create a new worker thread by <a data-type="indexterm" data-primary="Worker constructor" id="idm45995922949112" class="calibre6"/><a data-type="indexterm" data-primary="constructors" data-secondary="Worker" id="idm45995922948504" class="calibre6"/>using the <code class="calibre18">Worker</code> constructor, like in <a data-type="xref" href="#ex_nodejs_new_worker" class="calibre6">Example 3-3</a>.</p>
<div id="ex_nodejs_new_worker" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-3. </span>Spawning a new worker thread in Node.js</h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><code class="nx">Worker</code><code class="calibre18"> </code><code class="p">}</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">require</code><code class="p">(</code><code class="s">'worker_threads'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">

</code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">worker</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="kr">new</code><code class="calibre18"> </code><code class="nx">Worker</code><code class="p">(</code><code class="s">'/path/to/worker-file-name.js'</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO2-1" href="#callout_node_js_CO2-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO2-1" href="#co_node_js_CO2-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">The filename here is the entrypoint file that we want to run inside the worker thread. This is similar to the entrypoint in the main file that we’d specify as an argument to <code class="calibre18">node</code> on the command line.</p></dd>
</dl></div>








<section data-type="sect2" data-pdf-bookmark="workerData" class="calibre4"><div class="preface" id="idm45995922908584">
<h2 class="calibre37">workerData</h2>

<p class="author1">It’s not sufficient to just be able to create a worker thread. We need to interact with it! The <code class="calibre18">Worker</code> constructor <a data-type="indexterm" data-primary="Worker constructor" data-secondary="workerData object" id="idm45995922906536" class="calibre6"/><a data-type="indexterm" data-primary="worker_threads module" data-secondary="Worker constructor" id="idm45995922905528" class="calibre6"/>takes a second argument, an <code class="calibre18">options</code> object, that among other things allows us to specify a set of data to be passed immediately to the worker thread. The <code class="calibre18">options</code> object property is called <code class="calibre18">workerData</code>, and its contents will be copied into the worker thread via the means described in the <a data-type="xref" data-xrefstyle="appendix" href="app01.xhtml#app_sca" class="calibre6">Appendix</a>. Inside the thread, we can access the cloned data via the <code class="calibre18">workerData</code> property of the <code class="calibre18">worker_threads</code> module. You can see how this works in <a data-type="xref" href="#ex_nodejs_worker_data" class="calibre6">Example 3-4</a>.</p>
<div id="ex_nodejs_worker_data" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-4. </span>Passing data to a worker thread via <code class="calibre18">workerData</code></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
  </code><code class="nx">Worker</code><code class="p">,</code><code class="calibre18">
  </code><code class="nx">isMainThread</code><code class="p">,</code><code class="calibre18">
  </code><code class="nx">workerData</code><code class="calibre18">
</code><code class="p">}</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">require</code><code class="p">(</code><code class="s">'worker_threads'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">assert</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">require</code><code class="p">(</code><code class="s">'assert'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">

</code><code class="kr">if</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">isMainThread</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO3-1" href="#callout_node_js_CO3-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">
  </code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">worker</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="kr">new</code><code class="calibre18"> </code><code class="nx">Worker</code><code class="p">(</code><code class="nx">__filename</code><code class="p">,</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><code class="nx">workerData</code><code class="o">:</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><code class="nx">num</code><code class="o">:</code><code class="calibre18"> </code><code class="mi">42</code><code class="calibre18"> </code><code class="p">}</code><code class="calibre18"> </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code><code class="calibre18"> </code><code class="kr">else</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
  </code><code class="nx">assert</code><code class="p">.</code><code class="nx">strictEqual</code><code class="p">(</code><code class="nx">workerData</code><code class="p">.</code><code class="nx">num</code><code class="p">,</code><code class="calibre18"> </code><code class="mi">42</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO3-1" href="#co_node_js_CO3-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Rather than using a separate file for the worker thread, we can use the current file with <code class="calibre18">__filename</code> and switch the behavior based on <code class="calibre18">isMainThread</code>.</p></dd>
</dl></div>

<p class="author1">It’s important to note that the <a data-type="indexterm" data-primary="Worker constructor" data-secondary="workerData object" data-tertiary="properties" id="idm45995922801224" class="calibre6"/><a data-type="indexterm" data-primary="property cloning" id="idm45995922799976" class="calibre6"/>properties of the <code class="calibre18">workerData</code> object are <em class="calibre7">cloned</em> rather than shared between threads. Unlike in C, shared memory in JavaScript threads does not mean all the variables are visible. This means any changes you make in that object will not be visible in the other thread. They are separate objects. That being said, 
<span class="keep-together">you can</span> have memory that’s shared between threads via <code class="calibre18">SharedArrayBuffer</code>. These can be shared via <code class="calibre18">workerData</code> or by being sent through a <code class="calibre18">MessagePort</code>, which is covered in the next section. Additionally, <code class="calibre18">SharedArrayBuffer</code> is covered in depth in 
<span class="keep-together"><a data-type="xref" href="ch04.xhtml#ch_shared_mem" class="calibre6">Chapter 4</a>.</span></p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="MessagePort" class="calibre4"><div class="preface" id="idm45995922765896">
<h2 class="calibre37">MessagePort</h2>

<p class="author1">A <code class="calibre18">MessagePort</code> is one end of a <a data-type="indexterm" data-primary="data streams" data-secondary="MessagePort" id="dataMess" class="calibre6"/><a data-type="indexterm" data-primary="MessagePort" id="mesport" class="calibre6"/>two-way data stream. By default, one is provided to every worker thread to provide a communication channel to and from the main thread. It’s available in the worker thread as the <code class="calibre18">parentPort</code> property of the <code class="calibre18">worker_threads</code> module.</p>

<p class="author1">To send a message via the port, <a data-type="indexterm" data-primary="postMessage() method" id="idm45995922760504" class="calibre6"/><a data-type="indexterm" data-primary="methods" data-secondary="postMessage()" id="idm45995922759896" class="calibre6"/><a data-type="indexterm" data-primary="MessagePort" data-secondary="postMessage()" id="idm45995922759048" class="calibre6"/>the <code class="calibre18">postMesage()</code> method is called on it. The first argument is any object that can be passed, as described in the <a data-type="xref" data-xrefstyle="appendix" href="app01.xhtml#app_sca" class="calibre6">Appendix</a>, which will end up being the message data being passed to the other end of the port. When a message is received on the port, the <code class="calibre18">message</code> event is fired, with the message data being the first argument to the event handler function. In the main thread, the event and the <code class="calibre18">postMessage()</code> method are on the worker instance itself, rather than having to get them from a <code class="calibre18">MessagePort</code> instance. <a data-type="xref" href="#ex_nodejs_message_port" class="calibre6">Example 3-5</a> shows a simple example where messages sent to the main thread are echoed back to a worker thread.</p>
<div id="ex_nodejs_message_port" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-5. </span>Bidirectional communication via the default MessagePorts</h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code> <code class="p">{</code>
  <code class="nx">Worker</code><code class="p">,</code>
  <code class="nx">isMainThread</code><code class="p">,</code>
  <code class="nx">parentPort</code>
<code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s">'worker_threads'</code><code class="p">);</code>

<code class="kr">if</code> <code class="p">(</code><code class="nx">isMainThread</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">worker</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Worker</code><code class="p">(</code><code class="nx">__filename</code><code class="p">);</code>
  <code class="nx">worker</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s">'message'</code><code class="p">,</code> <code class="nx">msg</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">worker</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="nx">msg</code><code class="p">);</code>
  <code class="p">});</code>
<code class="p">}</code> <code class="kr">else</code> <code class="p">{</code>
  <code class="nx">parentPort</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s">'message'</code><code class="p">,</code> <code class="nx">msg</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'We got a message from the main thread:'</code><code class="p">,</code> <code class="nx">msg</code><code class="p">);</code>
  <code class="p">});</code>
  <code class="nx">parentPort</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="s">'Hello, World!'</code><code class="p">);</code>
<code class="p">}</code></pre></div>

<p class="author1">You can also create a pair of <code class="calibre18">MessagePort</code> instances <a data-type="indexterm" data-primary="MessagePort" data-secondary="instances" id="idm45995922751320" class="calibre6"/><a data-type="indexterm" data-primary="MessagePort" data-secondary="MessageChannel constructor" id="idm45995922681448" class="calibre6"/><a data-type="indexterm" data-primary="MessageChannel constructor" id="idm45995922680536" class="calibre6"/><a data-type="indexterm" data-primary="constructors" data-secondary="MessageChannel" id="idm45995922679896" class="calibre6"/>connected to each other via the <code class="calibre18">MessageChannel</code> constructor. You can then pass one of the ports via an existing message port (like the default one) or via <code class="calibre18">workerData</code>. You might want to do this in situations where neither of two threads that need to communicate are the main thread, or even just for organizational purposes. <a data-type="xref" href="#ex_nodejs_message_channel" class="calibre6">Example 3-6</a> is the same as the previous example, except using ports created via <code class="calibre18">MessageChannel</code> and passed via <code class="calibre18">workerData</code>.</p>
<div id="ex_nodejs_message_channel" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-6. </span>Bidirectional communication via <code class="calibre18">MessagePort</code> created with 
<span class="keep-together"><code class="calibre18">MessageChannel</code></span></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code> <code class="p">{</code>
  <code class="nx">Worker</code><code class="p">,</code>
  <code class="nx">isMainThread</code><code class="p">,</code>
  <code class="nx">MessageChannel</code><code class="p">,</code>
  <code class="nx">workerData</code>
<code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s">'worker_threads'</code><code class="p">);</code>

<code class="kr">if</code> <code class="p">(</code><code class="nx">isMainThread</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">port1</code><code class="p">,</code> <code class="nx">port2</code> <code class="p">}</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">MessageChannel</code><code class="p">();</code>
  <code class="kr">const</code> <code class="nx">worker</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Worker</code><code class="p">(</code><code class="nx">__filename</code><code class="p">,</code> <code class="p">{</code>
    <code class="nx">workerData</code><code class="o">:</code> <code class="p">{</code>
      <code class="nx">port</code><code class="o">:</code> <code class="nx">port2</code>
    <code class="p">},</code>
    <code class="nx">transferList</code><code class="o">:</code> <code class="p">[</code><code class="nx">port2</code><code class="p">]</code>
  <code class="p">});</code>
  <code class="nx">port1</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s">'message'</code><code class="p">,</code> <code class="nx">msg</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">port1</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="nx">msg</code><code class="p">);</code>
  <code class="p">});</code>
<code class="p">}</code> <code class="kr">else</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="p">{</code> <code class="nx">port</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">workerData</code><code class="p">;</code>
  <code class="nx">port</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s">'message'</code><code class="p">,</code> <code class="nx">msg</code> <code class="o">=&gt;</code> <code class="p">{</code>
    <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'We got a message from the main thread:'</code><code class="p">,</code> <code class="nx">msg</code><code class="p">);</code>
  <code class="p">});</code>
  <code class="nx">port</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="s">'Hello, World!'</code><code class="p">);</code>
<code class="p">}</code></pre></div>

<p class="author1">You’ll notice we used the <code class="calibre18">transferList</code> option when <a data-type="indexterm" data-primary="Worker constructor" data-secondary="transferList option" id="idm45995922671048" class="calibre6"/><a data-type="indexterm" data-primary="threads" data-secondary="objects, ownership transfer" id="idm45995922548280" class="calibre6"/>instantiating the <code class="calibre18">Worker</code>. This is a way of transferring ownership of objects from one thread to another. This is required when sending any <code class="calibre18">MessagePort</code>, <code class="calibre18">ArrayBuffer</code>, or <code class="calibre18">FileHandle</code> objects via <code class="calibre18">workerData</code> or <code class="calibre18">postMessage</code>. Once these objects are transferred, they can no longer be used on the sending side.</p>
<div data-type="tip" class="calibre22"><h6 class="calibre23">Tip</h6>
<p class="author1">In more recent <a data-type="indexterm" data-primary="WHATWG (Web Hypertext Application Technology Working Group)" id="idm45995922543736" class="calibre6"/><a data-type="indexterm" data-primary="data streams" data-secondary="ReadableStream" id="idm45995922542696" class="calibre6"/><a data-type="indexterm" data-primary="data streams" data-secondary="WritableStream" id="idm45995922541752" class="calibre6"/><a data-type="indexterm" data-primary="ReadableStream" id="idm45995922540808" class="calibre6"/><a data-type="indexterm" data-primary="Writeable Stream" id="idm45995922540136" class="calibre6"/>versions of Node.js, Web Hypertext Application Technology Working Group (WHATWG) <code class="calibre18">ReadableStream</code> and <code class="calibre18">WritableStream</code> are available. You can learn more about them in the <a href="https://oreil.ly/TRJf0" class="calibre6">Node.js documentation</a> and in use by some APIs. They can be transferred via <code class="calibre18">transferList</code> over <code class="calibre18">MessagePorts</code> to enable another way of communicating across threads. Under the hood, these are implemented <a data-type="indexterm" data-primary="modules" data-secondary="worker_threads" data-startref="modworkthr" id="idm45995922536776" class="calibre6"/><a data-type="indexterm" data-primary="data streams" data-secondary="MessagePort" data-startref="dataMess" id="idm45995922535528" class="calibre6"/><a data-type="indexterm" data-primary="MessagePort" data-startref="mesport" id="idm45995922534312" class="calibre6"/>using a <code class="calibre18">MessagePort</code> to send data across.</p>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Happycoin: Revisited" class="calibre4"><div class="preface" id="sec_happycoin_revisited">
<h1 class="calibre13">Happycoin: Revisited</h1>

<p class="author1">Now that we’ve seen the basics of <a data-type="indexterm" data-primary="Happycoin" id="idm45995922531112" class="calibre6"/>spawning threads in Node.js and having them communicate with each other, we have enough to rebuild our example from <a data-type="xref" href="ch01.xhtml#ch_intro_sec_happycoin" class="calibre6">“Threads in C: Get Rich with Happycoin”</a> in Node.js.</p>

<p class="author1">Recall that Happycoin is our imaginary cryptocurrency, with a completely ridiculous proof-of-work algorithm that goes as follows:</p>
<ol class="calibre35">
<li class="calibre36">
<p class="author1">Generate a random unsigned 64-bit integer.</p>
</li>
<li class="calibre36">
<p class="author1">Determine whether or not the integer is happy.</p>
</li>
<li class="calibre36">
<p class="author1">If it’s not happy, it’s not a Happycoin.</p>
</li>
<li class="calibre36">
<p class="author1">If it’s not divisible by 10,000, it’s not a Happycoin.</p>
</li>
<li class="calibre36">
<p class="author1">Otherwise, it’s a Happycoin.</p>
</li>

</ol>

<p class="author1">Much like we did in C, we’ll make a single-threaded version first, and then adapt the code to run on multiple threads.</p>








<section data-type="sect2" data-pdf-bookmark="With Only the Main Thread" class="calibre4"><div class="preface" id="idm45995922523112">
<h2 class="calibre37">With Only the Main Thread</h2>

<p class="author1">Let’s start with generating <a data-type="indexterm" data-primary="Happycoin" data-secondary="random number generation" id="idm45995922521192" class="calibre6"/><a data-type="indexterm" data-primary="random number generator" data-secondary="Happycoin" id="idm45995922520248" class="calibre6"/>random <a data-type="indexterm" data-primary="happycoin.js" id="idm45995922519176" class="calibre6"/><a data-type="indexterm" data-primary="code samples" data-secondary="ch3-happycoin" id="idm45995922518472" class="calibre6"/>numbers. First, let’s create a file called <em class="calibre7">happycoin.js</em>, in a directory called <em class="calibre7">ch3-happycoin/</em>. Fill it with the contents of <a data-type="xref" href="#ex_happycoin_js_1" class="calibre6">Example 3-7</a>.</p>
<div id="ex_happycoin_js_1" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-7. </span><em class="calibre7">ch3-happycoin/happycoin.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code> <code class="nx">crypto</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s">'crypto'</code><code class="p">);</code>

<code class="kr">const</code> <code class="nx">big64arr</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">BigUint64Array</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code>
<code class="kr">function</code> <code class="nx">random64</code><code class="p">()</code> <code class="p">{</code>
  <code class="nx">crypto</code><code class="p">.</code><code class="nx">randomFillSync</code><code class="p">(</code><code class="nx">big64arr</code><code class="p">);</code>
  <code class="kr">return</code> <code class="nx">big64arr</code><code class="p">[</code><code class="mi">0</code><code class="p">];</code>
<code class="p">}</code></pre></div>

<p class="author1">They <code class="calibre18">crypto</code> module in Node.js gives <a data-type="indexterm" data-primary="crypto module" id="idm45995922479560" class="calibre6"/><a data-type="indexterm" data-primary="modules" data-secondary="crypto" id="idm45995922478952" class="calibre6"/>us some handy functions for getting cryptographically secure random numbers. We’ll definitely want this since we’re building a cryptocurrency after all! Luckily, it’s less of an ordeal than it is in C.</p>

<p class="author1">The <code class="calibre18">randomFillSync</code> function <a data-type="indexterm" data-primary="randomFillSync function" id="idm45995922476472" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="randomFillSync" id="idm45995922475736" class="calibre6"/><a data-type="indexterm" data-primary="crypto module" data-secondary="randomFillSync" id="idm45995922474792" class="calibre6"/>fills a given <code class="calibre18">TypedArray</code> with random data. Since we’re looking for only a single 64-bit unsigned integer, we <a data-type="indexterm" data-primary="BigUint64Array" id="idm45995922396056" class="calibre6"/><a data-type="indexterm" data-primary="arrays" data-secondary="BigUint64Array" id="idm45995922395352" class="calibre6"/><a data-type="indexterm" data-primary="TypedArray class" id="idm45995922394408" class="calibre6"/><a data-type="indexterm" data-primary="arrays" data-secondary="TypedArray" id="idm45995922393736" class="calibre6"/>can use a <code class="calibre18">BigUint64Array</code>. This particular <code class="calibre18">TypedArray</code>, along with its cousin <code class="calibre18">BigInt64Array</code>, are recent additions to JavaScript that were made possible by the new <code class="calibre18">bigint</code> type, which <a data-type="indexterm" data-primary="bigint type" id="idm45995922390968" class="calibre6"/><a data-type="indexterm" data-primary="integers" data-secondary="bigint" id="idm45995922390232" class="calibre6"/>stores arbitrarily large integers. Returning the first (and only) element of this array after we’ve filled it with random data gives us the random 64-bit unsigned integer that we’re looking for.</p>

<p class="author1">Now let’s add our happy number calculation. Add the contents of <a data-type="xref" href="#ex_happycoin_js_2" class="calibre6">Example 3-8</a> to your file.</p>
<div id="ex_happycoin_js_2" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-8. </span><em class="calibre7">ch3-happycoin/happycoin.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">function</code> <code class="nx">sumDigitsSquared</code><code class="p">(</code><code class="nx">num</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">let</code> <code class="nx">total</code> <code class="o">=</code> <code class="mi">0</code><code class="nx">n</code><code class="p">;</code>
  <code class="kr">while</code> <code class="p">(</code><code class="nx">num</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">numModBase</code> <code class="o">=</code> <code class="nx">num</code> <code class="o">%</code> <code class="mi">10</code><code class="nx">n</code><code class="p">;</code>
    <code class="nx">total</code> <code class="o">+=</code> <code class="nx">numModBase</code> <code class="o">**</code> <code class="mi">2</code><code class="nx">n</code><code class="p">;</code>
    <code class="nx">num</code> <code class="o">=</code> <code class="nx">num</code> <code class="o">/</code> <code class="mi">10</code><code class="nx">n</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="kr">return</code> <code class="nx">total</code><code class="p">;</code>
<code class="p">}</code>

<code class="kr">function</code> <code class="nx">isHappy</code><code class="p">(</code><code class="nx">num</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">while</code> <code class="p">(</code><code class="nx">num</code> <code class="o">!=</code> <code class="mi">1</code><code class="nx">n</code> <code class="o">&amp;&amp;</code> <code class="nx">num</code> <code class="o">!=</code> <code class="mi">4</code><code class="nx">n</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">num</code> <code class="o">=</code> <code class="nx">sumDigitsSquared</code><code class="p">(</code><code class="nx">num</code><code class="p">);</code>
  <code class="p">}</code>
  <code class="kr">return</code> <code class="nx">num</code> <code class="o">===</code> <code class="mi">1</code><code class="nx">n</code><code class="p">;</code>
<code class="p">}</code>

<code class="kr">function</code> <code class="nx">isHappycoin</code><code class="p">(</code><code class="nx">num</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">return</code> <code class="nx">isHappy</code><code class="p">(</code><code class="nx">num</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="nx">num</code> <code class="o">%</code> <code class="mi">10000</code><code class="nx">n</code> <code class="o">===</code> <code class="mi">0</code><code class="nx">n</code><code class="p">;</code>
<code class="p">}</code></pre></div>

<p class="author1">These three <a data-type="indexterm" data-primary="sumDigitsSquared function" id="idm45995922381656" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="sumDigitsSquared" id="idm45995922380744" class="calibre6"/><a data-type="indexterm" data-primary="isHappy function" id="idm45995922379896" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="isHappy" id="idm45995922261896" class="calibre6"/><a data-type="indexterm" data-primary="isHappycoin function" id="idm45995922260952" class="calibre6"/><a data-type="indexterm" data-primary="functions" data-secondary="isHappycoin" id="idm45995922260280" class="calibre6"/>functions, <code class="calibre18">sumDigitsSquared</code>, <code class="calibre18">isHappy</code>, and <code class="calibre18">isHappycoin</code>, are direct translations from their C counterparts in <a data-type="xref" href="ch01.xhtml#ch_intro_sec_happycoin" class="calibre6">“Threads in C: Get Rich with Happycoin”</a>. One thing you might notice if you’re not familiar with <code class="calibre18">bigint</code> is the <code class="calibre18">n</code> suffix on all the number literals in this code. This suffix tells JavaScript that these numbers are to be treated as <code class="calibre18">bigint</code> values, rather than values of type <code class="calibre18">number</code>. This is important because, while both types support mathematical operators like <code class="calibre18">+</code>, <code class="calibre18">-</code>, <code class="calibre18">**</code>, and so on, they cannot interoperate without doing an explicit conversion. For example, 
<span class="keep-together"><code class="calibre18">1 + 1n</code></span> would be invalid because it’s an attempt to add the <code class="calibre18">number</code> 1 to the <code class="calibre18">bigint</code> 1.</p>

<p class="author1">Let’s finish off the file by <a data-type="indexterm" data-primary="Happycoin" data-secondary="mining loop" id="idm45995922252040" class="calibre6"/>implementing our Happycoin mining loop and outputting the count of found Happycoins. Add <a data-type="xref" href="#ex_happycoin_js_3" class="calibre6">Example 3-9</a> to your file.</p>
<div id="ex_happycoin_js_3" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-9. </span><em class="calibre7">ch3-happycoin/happycoin.js</em></h5>
<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">let</code> <code class="nx">count</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="kr">for</code> <code class="p">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">10_000_000</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">randomNum</code> <code class="o">=</code> <code class="nx">random64</code><code class="p">();</code>
  <code class="kr">if</code> <code class="p">(</code><code class="nx">isHappycoin</code><code class="p">(</code><code class="nx">randomNum</code><code class="p">))</code> <code class="p">{</code>
    <code class="nx">process</code><code class="p">.</code><code class="nx">stdout</code><code class="p">.</code><code class="nx">write</code><code class="p">(</code><code class="nx">randomNum</code><code class="p">.</code><code class="nx">toString</code><code class="p">()</code> <code class="o">+</code> <code class="s">' '</code><code class="p">);</code>
    <code class="nx">count</code><code class="o">++</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="nx">process</code><code class="p">.</code><code class="nx">stdout</code><code class="p">.</code><code class="nx">write</code><code class="p">(</code><code class="s">'\ncount '</code> <code class="o">+</code> <code class="nx">count</code> <code class="o">+</code> <code class="s">'\n'</code><code class="p">);</code></pre></div>

<p class="author1">The code here is very similar to what we did in C. We loop 10,000,000 times, getting a random number and checking if it’s a Happycoin. If it is, we print it out. Note that we’re <a data-type="indexterm" data-primary="console.log()" id="idm45995922246520" class="calibre6"/>not using <code class="calibre18">console.log()</code> here because we don’t want to insert a newline character after each number found. Instead we want spaces, so we’re writing to the output stream directly. When we output the count after the loop, we need an additional newline character at the beginning of the output to separate it from the numbers above.</p>

<p class="author1">To run this program, use the following command in your <em class="calibre7">ch3-happycoin</em> directory:</p>

<pre data-type="programlisting" class="calibre38">$ node happycoin.js</pre>

<p class="author1">Your output should be exactly the same as it was in C. That is, it should look something like this:</p>

<pre data-type="programlisting" class="calibre38">5503819098300300000 ...  [ 125 more entries ] ... 5273033273820010000
count 127</pre>

<p class="author1">This takes quite a bit longer than the C example. On a run-of-the-mill machine, this took about 1 minute and 45 seconds with Node.js v16.0.0.</p>

<p class="author1">There are a variety of reasons why this takes so much longer. When building applications and optimizing for performance, it’s important to figure out what the sources of performance overhead are. Yes, in general, JavaScript is often “slower than C,” but this enormous difference can’t be explained by that alone. Yes, we’ll get better performance in the next section when we split this into multiple threads of work, but as you’ll see, it’s not nearly enough to make this implementation compelling when compared to the C example.</p>

<p class="author1">And on that note, let’s see what this looks like when we use <code class="calibre18">worker_threads</code> to split out the load.</p>
</div></section>













<section data-type="sect2" class="calibre4" data-pdf-bookmark="With Four Worker Threads"><div class="preface" id="idm45995922522488">
<h2 class="calibre37">With Four Worker Threads</h2>

<p class="author1">To add worker threads, we will start from <a data-type="indexterm" data-primary="Happycoin" data-secondary="worker threads, adding" id="idm45995922198696" class="calibre6"/><a data-type="indexterm" data-primary="worker threads" data-secondary="Happycoin" id="idm45995922197720" class="calibre6"/>the code we had. Copy the contents of <em class="calibre7">happycoin.js</em> to <em class="calibre7">happycoin-threads.js</em>. Then insert the contents of <a data-type="xref" href="#ex_happycoin_threads_js_1" class="calibre6">Example 3-10</a> at the very beginning of the file, before the existing content.</p>
<div id="ex_happycoin_threads_js_1" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-10. </span><em class="calibre7">ch3-happycoin/happycoin-threads.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code> <code class="p">{</code>
  <code class="nx">Worker</code><code class="p">,</code>
  <code class="nx">isMainThread</code><code class="p">,</code>
  <code class="nx">parentPort</code>
<code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s">'worker_threads'</code><code class="p">);</code></pre></div>

<p class="author1">We’ll need these parts <a data-type="indexterm" data-primary="worker_threads module" id="idm45995922186472" class="calibre6"/><a data-type="indexterm" data-primary="modules" data-secondary="worker_threads" id="idm45995922185864" class="calibre6"/>of the <code class="calibre18">worker_threads</code> module, so we <code class="calibre18">require</code> them at the beginning.
Now, replace everything from <code class="calibre18">let count = 0;</code> to the end of the file with <a data-type="xref" href="#ex_happycoin_threads_js_2" class="calibre6">Example 3-11</a>.</p>
<div id="ex_happycoin_threads_js_2" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-11. </span><em class="calibre7">ch3-happycoin/happycoin-threads.js</em></h5>
<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code> <code class="nx">THREAD_COUNT</code> <code class="o">=</code> <code class="mi">4</code><code class="p">;</code>

<code class="kr">if</code> <code class="p">(</code><code class="nx">isMainThread</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">let</code> <code class="nx">inFlight</code> <code class="o">=</code> <code class="nx">THREAD_COUNT</code><code class="p">;</code>
  <code class="kr">let</code> <code class="nx">count</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="kr">for</code> <code class="p">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">THREAD_COUNT</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">worker</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Worker</code><code class="p">(</code><code class="nx">__filename</code><code class="p">);</code>
    <code class="nx">worker</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s">'message'</code><code class="p">,</code> <code class="nx">msg</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="kr">if</code> <code class="p">(</code><code class="nx">msg</code> <code class="o">===</code> <code class="s">'done'</code><code class="p">)</code> <code class="p">{</code>
        <code class="kr">if</code> <code class="p">(</code><code class="o">--</code><code class="nx">inFlight</code> <code class="o">===</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
          <code class="nx">process</code><code class="p">.</code><code class="nx">stdout</code><code class="p">.</code><code class="nx">write</code><code class="p">(</code><code class="s">'\ncount '</code> <code class="o">+</code> <code class="nx">count</code> <code class="o">+</code> <code class="s">'\n'</code><code class="p">);</code>
        <code class="p">}</code>
      <code class="p">}</code> <code class="kr">else</code> <code class="kr">if</code> <code class="p">(</code><code class="kr">typeof</code> <code class="nx">msg</code> <code class="o">===</code> <code class="s">'bigint'</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">process</code><code class="p">.</code><code class="nx">stdout</code><code class="p">.</code><code class="nx">write</code><code class="p">(</code><code class="nx">msg</code><code class="p">.</code><code class="nx">toString</code><code class="p">()</code> <code class="o">+</code> <code class="s">' '</code><code class="p">);</code>
        <code class="nx">count</code><code class="o">++</code><code class="p">;</code>
      <code class="p">}</code>
    <code class="p">})</code>
  <code class="p">}</code>
<code class="p">}</code> <code class="kr">else</code> <code class="p">{</code>
  <code class="kr">for</code> <code class="p">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">10_000_000</code><code class="o">/</code><code class="nx">THREAD_COUNT</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="kr">const</code> <code class="nx">randomNum</code> <code class="o">=</code> <code class="nx">random64</code><code class="p">();</code>
    <code class="kr">if</code> <code class="p">(</code><code class="nx">isHappycoin</code><code class="p">(</code><code class="nx">randomNum</code><code class="p">))</code> <code class="p">{</code>
      <code class="nx">parentPort</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="nx">randomNum</code><code class="p">);</code>
    <code class="p">}</code>
  <code class="p">}</code>
  <code class="nx">parentPort</code><code class="p">.</code><code class="nx">postMessage</code><code class="p">(</code><code class="s">'done'</code><code class="p">);</code>
<code class="p">}</code></pre></div>

<p class="author1">We’re splitting behavior here <a data-type="indexterm" data-primary="if block" id="idm45995922117656" class="calibre6"/><a data-type="indexterm" data-primary="blocks, if block" id="idm45995922116952" class="calibre6"/>with an <code class="calibre18">if</code> block. If we’re on the main thread, we start four worker threads using the current file. Remember, <code class="calibre18">__filename</code> is a string containing the path and name of the current file. We then add a message handler for that worker. In the message handler, if the message is simply <code class="calibre18">done</code>, then the worker has completed its work, and if all other workers are done, we’ll output the count. If 
<span class="keep-together">the message</span> is a number, or more correctly, a <code class="calibre18">bigint</code>, then we assume it’s a Happycoin, and we’ll print it out and add it to the count like we did in the single-threaded 
<span class="keep-together">example</span>.</p>

<p class="author1">On the <code class="calibre18">else</code> side of the <code class="calibre18">if</code> block, we’re running in one of the worker threads. In here, we’ll do the same sort of loop as we did in the single-threaded example, except we’re only looping 1/4 of the number of times we did before, since we’re doing the same work across four threads. Also, rather than writing directly to the output stream, we’re sending found Happycoins back to the main thread via the <code class="calibre18">MessagePort</code> given to us, called <code class="calibre18">parentPort</code>. We’ve already set up the handler on the main thread for this. When the loop exits, we send a <code class="calibre18">done</code> on the <code class="calibre18">parentPort</code> to indicate to the main thread that we won’t be finding any more Happycoins on this thread.</p>

<p class="author1">We could have simply printed <a data-type="indexterm" data-primary="Happycoin" data-secondary="output" id="idm45995921991240" class="calibre6"/>the Happycoins to the output immediately, but just like with the C example, we don’t want the different threads to clobber each other in the output, so we need to <em class="calibre7">synchronize</em>. Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch04.xhtml#ch_shared_mem" class="calibre6">4</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch05.xhtml#ch_adv_shared_mem" class="calibre6">5</a> go over more advanced techniques for <a data-type="indexterm" data-primary="synchronization" id="idm45995921987048" class="calibre6"/>synchronization, but for now it’s enough to just send the data back to the main thread through the <code class="calibre18">parentPort</code> and let the main thread handle output.</p>

<p class="author1">Now that we’re done adding threads to this example, you can run it with the following command in your <em class="calibre7">ch3-happycoin</em> directory:</p>

<pre data-type="programlisting" class="calibre38">$ node happycoin-threads.js</pre>

<p class="author1">You should see output that looks something like this:</p>
<pre data-type="programlisting" class="calibre38">
17241719184686550000 ... [ 137 more entries ] ... 17618203841507830000
count 139
</pre>

<p class="author1">Like with the C example, this code runs quite a bit faster. In a test on the same computer and Node.js version as the single-threaded example, it ran in about 33 seconds. This is a huge improvement over <a data-type="indexterm" data-primary="Happycoin" data-startref="happycoin" id="idm45995921982328" class="calibre6"/>the single-threaded example, so another big win for threads!</p>
<div data-type="note" epub:type="note" class="calibre22"><h6 class="calibre23">Note</h6>
<p class="author1">This is not the only way to split this kind of problem up for thread-based computation. For example, other synchronization techniques could be used to avoid passing data between threads, or the messages could be batched. Always be sure to test and compare to find out whether threads are an ideal solution and which thread techniques are most applicable to your problem, and the most efficient.</p>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Worker Pools with Piscina" class="calibre4"><div class="preface" id="idm45995922200040">
<h1 class="calibre13">Worker Pools with Piscina</h1>

<p class="author1">Many types of workloads will naturally <a data-type="indexterm" data-primary="worker pools, Piscina" id="idm45995921978008" class="calibre6"/><a data-type="indexterm" data-primary="Piscina" id="idm45995921977304" class="calibre6"/>lend themselves to using threads. In Node.js, most workloads involve processing an HTTP request. If within that code you find yourself doing a lot of math or synchronous data processing, it may make sense to offload that work to one or more threads. These types of operations involve submitting a single task to a thread and waiting for a result from it. In much the same way a threaded web server often works, it makes sense to maintain a pool of workers that can be sent various tasks from the main thread.</p>

<p class="author1">This section only takes a shallow look at thread pools, adapting the familiar Happycoins application and abstracting the pooling mechanism using a package. <a data-type="xref" href="ch06.xhtml#ch_patterns_sec_threadpool" class="calibre6">“Thread Pool”</a> covers thread pools extensively, building out an implementation from scratch.</p>
<div data-type="note" epub:type="note" class="calibre22"><h6 class="calibre23">Note</h6>
<p class="author1">The concept of pooled resources <a data-type="indexterm" data-primary="pooled resources" id="idm45995921973272" class="calibre6"/>isn’t unique to threads. For example, web browsers typically create pools of socket connections to web servers so that they can multiplex all the various HTTP requests required to render a web page across those connections. Database client libraries often do a similar thing with sockets connected to the database server.</p>

<p class="author1">There’s a handy module available for Node.js called <a href="https://oreil.ly/2a6ua" class="calibre6"><em class="calibre7">generic-pool</em></a>, which is a helper module for dealing with arbitrary pooled resources. These resources could be anything, like database connections, other sockets, local caches, threads, or pretty much anything else that might require having multiple instances of something but only accessing one at a time, without caring which one it is.</p>
</div>

<p class="author1">For the use case of discrete tasks sent to a pool of worker threads, we have the <a href="https://oreil.ly/0p8zi" class="calibre6"><em class="calibre7">piscina</em></a> module at our disposal. This module encapsulates the work of setting up a bunch of worker threads and allocating tasks to them. The name of the module comes from the Italian word for “pool.”</p>

<p class="author1">The basic usage is straightforward. You create <a data-type="indexterm" data-primary="worker pools, Piscina" data-secondary="instantiaion" id="idm45995921968040" class="calibre6"/><a data-type="indexterm" data-primary="Piscina" data-secondary="instantiation" id="idm45995921967064" class="calibre6"/>an instance of the <code class="calibre18">Piscina</code> class, passing in a <code class="calibre18">filename</code>, which will be used in the worker thread. Behind the scenes, a pool of worker threads is created, and a queue is set up to handle incoming tasks. You can enqueue a task by calling <code class="calibre18">.run()</code>, passing in a value containing all the data necessary to complete this task, and noting that the values will be cloned as they would be with <code class="calibre18">postMessage()</code>. This returns a promise that resolves once the tasks have been completed by a worker, giving a result value. In the file to be run in the worker, a function must be exported that takes in whatever is passed to <code class="calibre18">.run()</code> and returns the result value. This function can also be an <code class="calibre18">async</code> function, so that you can do asynchronous tasks in a worker thread if you need to. A basic example calculating square roots in worker threads is found in <a data-type="xref" href="#ex_piscina_square_roots" class="calibre6">Example 3-12</a>.</p>
<div id="ex_piscina_square_roots" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-12. </span>Computing square roots with <code class="calibre18">piscina</code></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code><code class="calibre18"> </code><code class="nx">Piscina</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">require</code><code class="p">(</code><code class="s">'piscina'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">

</code><code class="kr">if</code><code class="calibre18"> </code><code class="p">(</code><code class="o">!</code><code class="nx">Piscina</code><code class="p">.</code><code class="nx">isWorkerThread</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO4-1" href="#callout_node_js_CO4-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">
  </code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">piscina</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="kr">new</code><code class="calibre18"> </code><code class="nx">Piscina</code><code class="p">(</code><code class="p">{</code><code class="calibre18"> </code><code class="nx">filename</code><code class="o">:</code><code class="calibre18"> </code><code class="nx">__filename</code><code class="calibre18"> </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO4-2" href="#callout_node_js_CO4-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">
  </code><code class="nx">piscina</code><code class="p">.</code><code class="nx">run</code><code class="p">(</code><code class="mi">9</code><code class="p">)</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">squareRootOfNine</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO4-3" href="#callout_node_js_CO4-3"><img src="Images/3.png" alt="3" class="calibre32"/></a><code class="calibre18">
    </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'The square root of nine is'</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">squareRootOfNine</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code><code class="calibre18">

</code><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">num</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nx">num</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO4-4" href="#callout_node_js_CO4-4"><img src="Images/4.png" alt="4" class="calibre32"/></a></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO4-1" href="#co_node_js_CO4-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Much like <code class="calibre18">cluster</code> and <code class="calibre18">worker_threads</code>, <code class="calibre18">piscina</code> provides a handy boolean for determining whether we’re in the main thread or a worker thread.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO4-2" href="#co_node_js_CO4-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">We’ll use the same technique for using the same file as we did with the Happycoin example.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO4-3" href="#co_node_js_CO4-3"><img src="Images/3.png" alt="3" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Since <code class="calibre18">.run()</code> returns a promise, we can just call <code class="calibre18">.then()</code> on it.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO4-4" href="#co_node_js_CO4-4"><img src="Images/4.png" alt="4" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">The exported function is used in the worker thread to perform the actual work. In this case, it’s just calculating a square root.</p></dd>
</dl></div>

<p class="author1">While it’s all fine and good to run one task <a data-type="indexterm" data-primary="worker pools, Piscina" data-secondary="tasks, multiple" id="idm45995921824248" class="calibre6"/><a data-type="indexterm" data-primary="Piscina" data-secondary="tasks, multiple" id="idm45995921823400" class="calibre6"/>on the pool, we need to be able to run <em class="calibre7">many</em> tasks on the pool. Let’s say we want to calculate the square roots of every number less than ten million. Let’s go ahead and loop ten million times. We’ll also replace the logging with an assertion that we’ve gotten a numeric result, since logging will be quite noisy. Have a look at <a data-type="xref" href="#ex_piscina_10m_square_roots" class="calibre6">Example 3-13</a>.</p>
<div id="ex_piscina_10m_square_roots" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-13. </span>Computing ten million square roots with <code class="calibre18">piscina</code></h5>
<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code> <code class="nx">Piscina</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s">'piscina'</code><code class="p">);</code>
<code class="kr">const</code> <code class="nx">assert</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s">'assert'</code><code class="p">);</code>

<code class="kr">if</code> <code class="p">(</code><code class="o">!</code><code class="nx">Piscina</code><code class="p">.</code><code class="nx">isWorkerThread</code><code class="p">)</code> <code class="p">{</code>
  <code class="kr">const</code> <code class="nx">piscina</code> <code class="o">=</code> <code class="kr">new</code> <code class="nx">Piscina</code><code class="p">({</code> <code class="nx">filename</code><code class="o">:</code> <code class="nx">__filename</code> <code class="p">});</code>
  <code class="kr">for</code> <code class="p">(</code><code class="kr">let</code> <code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="mi">10_000_000</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">piscina</code><code class="p">.</code><code class="nx">run</code><code class="p">(</code><code class="nx">i</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="nx">squareRootOfI</code> <code class="o">=&gt;</code> <code class="p">{</code>
      <code class="nx">assert</code><code class="p">.</code><code class="nx">ok</code><code class="p">(</code><code class="kr">typeof</code> <code class="nx">squareRootOfI</code> <code class="o">===</code> <code class="s">'number'</code><code class="p">);</code>
    <code class="p">});</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">num</code> <code class="o">=&gt;</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nx">num</code><code class="p">);</code></pre></div>

<p class="author1">This seems like it ought to work. We’re submitting ten million numbers to be processed by the worker pool. However, if you run this code, you’ll get a nonrecoverable JavaScript memory allocation error. On one trial of this with Node.js v16.0.0, the following output was observed.</p>

<pre data-type="programlisting" class="calibre38">FATAL ERROR: Reached heap limit Allocation failed
    - JavaScript heap out of memory
 1: 0xb12b00 node::Abort() [node]
 2: 0xa2fe25 node::FatalError(char const*, char const*) [node]
 3: 0xcf8a9e v8::Utils::ReportOOMFailure(v8::internal::Isolate*,
    char const*, bool) [node]
 4: 0xcf8e17 v8::internal::V8::FatalProcessOutOfMemory(v8::internal::Isolate*,
    char const*, bool) [node]
 5: 0xee2d65  [node]
[ ... 13 more lines of a not-particularly-useful C++ stacktrace ... ]
Aborted (core dumped)</pre>

<p class="author1">What’s going on here? It turns out the underlying task queue is not infinite. By default, the task queue will keep growing and growing until we run into an allocation error like this one. To avoid having this happen, we need to set a reasonable limit. The <code class="calibre18">piscina</code> module lets you <a data-type="indexterm" data-primary="worker pools, Piscina" data-secondary="queue size" id="idm45995921765608" class="calibre6"/><a data-type="indexterm" data-primary="Piscina" data-secondary="queue size" id="idm45995921764600" class="calibre6"/>set a limit by using a <code class="calibre18">maxQueue</code> option in its constructor, which can be set to any positive integer. Through experimentation, the maintainers of <code class="calibre18">piscina</code> have found that an ideal <code class="calibre18">maxQueue</code> value is the square of the number of worker threads it’s using. Handily, you can use this number without even knowing it by setting <code class="calibre18">maxQueue</code> to <code class="calibre18">auto</code>.</p>

<p class="author1">Once we’ve established a bound for the queue size, we need to be able to handle it when the queue is full. There are two ways to detect that the queue is full:</p>
<ol class="calibre35">
<li class="calibre36">
<p class="author1">Compare the values of <code class="calibre18">piscina.queueSize</code> and <code class="calibre18">piscina.options.maxQueue</code>. 
<span class="keep-together">If they’re</span> equal, then the queue is full. This can be done prior to calling 
<span class="keep-together"><code class="calibre18">piscina.run()</code></span> to avoid attempting to enqueue when it’s full. This is the recommended way to check.</p>
</li>
<li class="calibre36">
<p class="author1">If <code class="calibre18">piscina.run()</code> is called when the queue is full, the returned promise will reject with an error indicating that the queue is full. This isn’t ideal because by this point we’re already in a further tick of the event loop and many other attempts to enqueue may already have happened.</p>
</li>

</ol>

<p class="author1">When we know that the queue is full, we need a way of knowing when it’ll be ready for new tasks again. Fortunately, <code class="calibre18">piscina</code> pools emit a <code class="calibre18">drain</code> event once the queue is empty, which is certainly an ideal time to start adding new tasks. In <a data-type="xref" href="#ex_piscina_better_10m_square_roots" class="calibre6">Example 3-14</a>, we put this all together with an <code class="calibre18">async</code> function around the loop that submits the tasks.</p>
<div id="ex_piscina_better_10m_square_roots" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-14. </span>Computing ten million square roots with <code class="calibre18">piscina</code>, without crashing</h5>
<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code><code class="calibre18"> </code><code class="nx">Piscina</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">require</code><code class="p">(</code><code class="s">'piscina'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">assert</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">require</code><code class="p">(</code><code class="s">'assert'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="kr">const</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><code class="nx">once</code><code class="calibre18"> </code><code class="p">}</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">require</code><code class="p">(</code><code class="s">'events'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">

</code><code class="kr">if</code><code class="calibre18"> </code><code class="p">(</code><code class="o">!</code><code class="nx">Piscina</code><code class="p">.</code><code class="nx">isWorkerThread</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
  </code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">piscina</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="kr">new</code><code class="calibre18"> </code><code class="nx">Piscina</code><code class="p">(</code><code class="p">{</code><code class="calibre18">
    </code><code class="nx">filename</code><code class="o">:</code><code class="calibre18"> </code><code class="nx">__filename</code><code class="p">,</code><code class="calibre18">
    </code><code class="nx">maxQueue</code><code class="o">:</code><code class="calibre18"> </code><code class="s">'auto'</code><code class="calibre18"> </code><a class="calibre6" id="manual_co_node_js_CO5-1" href="#manual_callout_node_js_CO5-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">
  </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="p">(</code><code class="nx">async</code><code class="calibre18"> </code><code class="p">(</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="manual_co_node_js_CO5-2" href="#manual_callout_node_js_CO5-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">
    </code><code class="kr">for</code><code class="calibre18"> </code><code class="p">(</code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">i</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">i</code><code class="calibre18"> </code><code class="o">&lt;</code><code class="calibre18"> </code><code class="mi">10_000_000</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">i</code><code class="o">++</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
      </code><code class="kr">if</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">piscina</code><code class="p">.</code><code class="nx">queueSize</code><code class="calibre18"> </code><code class="o">===</code><code class="calibre18"> </code><code class="nx">piscina</code><code class="p">.</code><code class="nx">options</code><code class="p">.</code><code class="nx">maxQueue</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="manual_co_node_js_CO5-3" href="#manual_callout_node_js_CO5-3"><img src="Images/3.png" alt="3" class="calibre32"/></a><code class="calibre18">
        </code><code class="nx">await</code><code class="calibre18"> </code><code class="nx">once</code><code class="p">(</code><code class="nx">piscina</code><code class="p">,</code><code class="calibre18"> </code><code class="s">'drain'</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="manual_co_node_js_CO5-4" href="#manual_callout_node_js_CO5-4"><img src="Images/4.png" alt="4" class="calibre32"/></a><code class="calibre18">
      </code><code class="p">}</code><code class="calibre18">
      </code><code class="nx">piscina</code><code class="p">.</code><code class="nx">run</code><code class="p">(</code><code class="nx">i</code><code class="p">)</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="nx">squareRootOfI</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
        </code><code class="nx">assert</code><code class="p">.</code><code class="nx">ok</code><code class="p">(</code><code class="kr">typeof</code><code class="calibre18"> </code><code class="nx">squareRootOfI</code><code class="calibre18"> </code><code class="o">===</code><code class="calibre18"> </code><code class="s">'number'</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
      </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
    </code><code class="p">}</code><code class="calibre18">
  </code><code class="p">}</code><code class="p">)</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
</code><code class="p">}</code><code class="calibre18">

</code><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">num</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="nb">Math</code><code class="p">.</code><code class="nx">sqrt</code><code class="p">(</code><code class="nx">num</code><code class="p">)</code><code class="p">;</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="manual_callout_node_js_CO5-1" href="#manual_co_node_js_CO5-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">The <code class="calibre18">maxQueue</code> option is set to <code class="calibre18">auto</code>, which limits the queue size to the square of the number of threads that <code class="calibre18">piscina</code> is using.</p></dd>
<dt class="calibre15"><a class="calibre6" id="manual_callout_node_js_CO5-2" href="#manual_co_node_js_CO5-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">The <code class="calibre18">for</code> loop is wrapped in an <code class="calibre18">async</code> immediately invoked function expression (IIFE) in order to use an <code class="calibre18">await</code> within it.</p></dd>
<dt class="calibre15"><a class="calibre6" id="manual_callout_node_js_CO5-3" href="#manual_co_node_js_CO5-3"><img src="Images/3.png" alt="3" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">When this check is true, the queue is full.</p></dd>
<dt class="calibre15"><a class="calibre6" id="manual_callout_node_js_CO5-4" href="#manual_co_node_js_CO5-4"><img src="Images/4.png" alt="4" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">We then wait for the <code class="calibre18">drain</code> event before submitting any new tasks to the queue.</p></dd>
</dl></div>

<p class="author1">Running this code does <em class="calibre7">not</em> result in an out-of-memory crash like it did before. It takes a fairly long time to complete, but it does finally exit without issue.</p>

<p class="author1">As seen here, it’s easy to fall into a trap where using a tool in what seems like the most sensible way isn’t the best approach. It’s important to fully understand tools like 
<span class="keep-together"><code class="calibre18">piscina</code></span> when building out your multithreaded applications.</p>

<p class="author1">On that note, let’s see what happens when we try to use <code class="calibre18">piscina</code> to mine Happycoins.</p>
</div></section>













<section data-type="sect1" class="calibre4" data-pdf-bookmark="A Pool Full of Happycoins"><div class="preface" id="idm45995921979016">
<h1 class="calibre13">A Pool Full of Happycoins</h1>

<p class="author1">To use <code class="calibre18">piscina</code> to produce Happycoins, we’ll use a slightly <a data-type="indexterm" data-primary="Piscina" data-secondary="Happycoins, producing" id="PisHapp" class="calibre6"/><a data-type="indexterm" data-primary="Happycoin" data-secondary="Piscina" id="HapPisc" class="calibre6"/>different approach from what we did in the original <code class="calibre18">worker_threads</code> implementation. Instead of getting a message back every time we have a Happycoin, we’ll batch them together and send them all at once when we’re done. This trade-off saves us the effort of setting up a <code class="calibre18">MessageChannel</code> to send data back to the main thread with; the side effect is that we’ll only get our results in batches, rather than as soon as they’re ready. The main thread will still do the job of spawning the appropriate threads and retrieving all the results.</p>
<aside data-type="sidebar" epub:type="sidebar" class="calibre54"><div class="sidebar" id="idm45995921621560">
<h5 class="calibre55">Trade-offs</h5>
<p class="author1">All programming is about <a data-type="indexterm" data-primary="trade-offs" id="idm45995921620232" class="calibre6"/>trade-offs. Multithreaded programming is no exception. In fact, you’ll find trade-offs at every turn. Sacrificing convenience in one place will often give you performance gains elsewhere, or vice versa. Sometimes if one operation is slightly slower, another will be significantly faster.</p>

<p class="author1">As with all things, <em class="calibre7">measure</em>. You can think as hard as you want about the problem, but the surest way to know whether your trade-off is going to be worth it is to measure. Check your code in a variety <a data-type="indexterm" data-primary="measuring, trade-offs and" id="idm45995921618072" class="calibre6"/>of conditions and see if it behaves in a way that’s actually beneficial in all the ways that matter. Crucially, the ways that matter are determined by the problem at hand, your interpretation of it, and the needs of your stakeholders.</p>

<p class="author1">In addition to measuring, documentation can save you hours, days, or even weeks of frustration in the future. It’s a pain to make a trade-off and then months down the road being unsure what led to that decision and starting to question everything.</p>
</div></aside>

<p class="author1">To start off, copy your <em class="calibre7">happycoin-threads.js</em> file to a new <a data-type="indexterm" data-primary="happycoin-piscina.js file" id="idm45995921615080" class="calibre6"/>one called <em class="calibre7">happycoin-piscina.js</em>. We’ll build off our old <code class="calibre18">worker_threads</code> example here. Now replace everything before the <code class="calibre18">require('crypto')</code> line with <a data-type="xref" href="#ex_happycoin_piscina_1" class="calibre6">Example 3-15</a>.</p>
<div id="ex_happycoin_piscina_1" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-15. </span><em class="calibre7">ch3-happycoin/happycoin-piscina.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code> <code class="nx">Piscina</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s">'piscina'</code><code class="p">);</code></pre></div>

<p class="author1">Yep, that’s it! Now we’ll get to the more substantial stuff. Replace everything after the <code class="calibre18">isHappycoin()</code> function declaration with the contents of <a data-type="xref" href="#ex_happycoin_piscina_2" class="calibre6">Example 3-16</a>.</p>
<div id="ex_happycoin_piscina_2" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-16. </span><em class="calibre7">ch3-happycoin/happycoin-piscina.js</em></h5>

<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="kr">const</code><code class="calibre18"> </code><code class="nx">THREAD_COUNT</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">4</code><code class="p">;</code><code class="calibre18">

</code><code class="kr">if</code><code class="calibre18"> </code><code class="p">(</code><code class="o">!</code><code class="nx">Piscina</code><code class="p">.</code><code class="nx">isWorkerThread</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO5-1" href="#callout_node_js_CO5-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">
  </code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">piscina</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="kr">new</code><code class="calibre18"> </code><code class="nx">Piscina</code><code class="p">(</code><code class="p">{</code><code class="calibre18">
    </code><code class="nx">filename</code><code class="o">:</code><code class="calibre18"> </code><code class="nx">__filename</code><code class="p">,</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO5-2" href="#callout_node_js_CO5-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">
    </code><code class="nx">minThreads</code><code class="o">:</code><code class="calibre18"> </code><code class="nx">THREAD_COUNT</code><code class="p">,</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO5-3" href="#callout_node_js_CO5-3"><img src="Images/3.png" alt="3" class="calibre32"/></a><code class="calibre18">
    </code><code class="nx">maxThreads</code><code class="o">:</code><code class="calibre18"> </code><code class="nx">THREAD_COUNT</code><code class="calibre18">
  </code><code class="p">}</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">done</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="p">;</code><code class="calibre18">
  </code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">count</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="p">;</code><code class="calibre18">
  </code><code class="kr">for</code><code class="calibre18"> </code><code class="p">(</code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">i</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">i</code><code class="calibre18"> </code><code class="o">&lt;</code><code class="calibre18"> </code><code class="nx">THREAD_COUNT</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">i</code><code class="o">++</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO5-4" href="#callout_node_js_CO5-4"><img src="Images/4.png" alt="4" class="calibre32"/></a><code class="calibre18">
    </code><code class="p">(</code><code class="nx">async</code><code class="calibre18"> </code><code class="p">(</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
      </code><code class="kr">const</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><code class="nx">total</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">happycoins</code><code class="calibre18"> </code><code class="p">}</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">await</code><code class="calibre18"> </code><code class="nx">piscina</code><code class="p">.</code><code class="nx">run</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO5-5" href="#callout_node_js_CO5-5"><img src="Images/5.png" alt="5" class="calibre32"/></a><code class="calibre18">
      </code><code class="nx">process</code><code class="p">.</code><code class="nx">stdout</code><code class="p">.</code><code class="nx">write</code><code class="p">(</code><code class="nx">happycoins</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
      </code><code class="nx">count</code><code class="calibre18"> </code><code class="o">+=</code><code class="calibre18"> </code><code class="nx">total</code><code class="p">;</code><code class="calibre18">
      </code><code class="kr">if</code><code class="calibre18"> </code><code class="p">(</code><code class="o">++</code><code class="nx">done</code><code class="calibre18"> </code><code class="o">===</code><code class="calibre18"> </code><code class="nx">THREAD_COUNT</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="co_node_js_CO5-6" href="#callout_node_js_CO5-6"><img src="Images/6.png" alt="6" class="calibre32"/></a><code class="calibre18">
        </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s">'\ncount'</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">count</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
      </code><code class="p">}</code><code class="calibre18">
    </code><code class="p">}</code><code class="p">)</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
  </code><code class="p">}</code><code class="calibre18">
</code><code class="p">}</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO5-1" href="#co_node_js_CO5-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">We’ll use the <code class="calibre18">isWorkerThread</code> property to <a data-type="indexterm" data-primary="isWorkerThread property" id="idm45995921402520" class="calibre6"/>check that we’re in the main thread.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO5-2" href="#co_node_js_CO5-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">We’re using the same technique as earlier to create worker threads using this same file.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO5-3" href="#co_node_js_CO5-3"><img src="Images/3.png" alt="3" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">We want to restrict the number of threads to be exactly four, to match our previous examples. We’ll want to time this and see what happens, so sticking with four threads reduces the number of variables here.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO5-4" href="#co_node_js_CO5-4"><img src="Images/4.png" alt="4" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">We know we have four threads, so we’ll enqueue our task four times. Each one will complete once it has checked its chunk of random numbers for Happycoins.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO5-5" href="#co_node_js_CO5-5"><img src="Images/5.png" alt="5" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">We submit the task to the queue in this <code class="calibre18">async</code> IIFE, so that they all get queued in the same event loop iteration. Don’t worry, we won’t get out-of-memory errors like we did before because we know we have exactly four threads and we’re only enqueueing four tasks. As we’ll see later, the task returns both the output string and the total count of Happycoins that the thread has found.</p></dd>
<dt class="calibre15"><a class="calibre6" id="callout_node_js_CO5-6" href="#co_node_js_CO5-6"><img src="Images/6.png" alt="6" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">Much like we’ve done in previous Happycoin implementations, we’ll check that all threads have completed their tasks before outputting the grand total count of Happycoins that we’ve found.</p></dd>
</dl></div>

<p class="author1">Next we’ll add the code from <a data-type="xref" href="#ex_happycoin_piscina_3" class="calibre6">Example 3-17</a>, which adds the exported function that’s used in <code class="calibre18">piscina</code>’s worker threads.</p>
<div id="ex_happycoin_piscina_3" data-type="example" class="calibre26">
<h5 class="calibre27"><span class="keep-together">Example 3-17. </span><em class="calibre7">ch3-happycoin/happycoin-piscina.js</em></h5>
<pre data-type="programlisting" data-code-language="javascript" class="calibre28"><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="p">(</code><code class="p">)</code><code class="calibre18"> </code><code class="o">=&gt;</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
  </code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">happycoins</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="s">''</code><code class="p">;</code><code class="calibre18">
  </code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">total</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="p">;</code><code class="calibre18">
  </code><code class="kr">for</code><code class="calibre18"> </code><code class="p">(</code><code class="kr">let</code><code class="calibre18"> </code><code class="nx">i</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="mi">0</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">i</code><code class="calibre18"> </code><code class="o">&lt;</code><code class="calibre18"> </code><code class="mi">10_000_000</code><code class="o">/</code><code class="nx">THREAD_COUNT</code><code class="p">;</code><code class="calibre18"> </code><code class="nx">i</code><code class="o">++</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><a class="calibre6" id="manual_co_node_js_CO7-1" href="#manual_callout_node_js_CO7-1"><img src="Images/1.png" alt="1" class="calibre32"/></a><code class="calibre18">
    </code><code class="kr">const</code><code class="calibre18"> </code><code class="nx">randomNum</code><code class="calibre18"> </code><code class="o">=</code><code class="calibre18"> </code><code class="nx">random64</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code class="calibre18">
    </code><code class="kr">if</code><code class="calibre18"> </code><code class="p">(</code><code class="nx">isHappycoin</code><code class="p">(</code><code class="nx">randomNum</code><code class="p">)</code><code class="p">)</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18">
      </code><code class="nx">happycoins</code><code class="calibre18"> </code><code class="o">+=</code><code class="calibre18"> </code><code class="nx">randomNum</code><code class="p">.</code><code class="nx">toString</code><code class="p">(</code><code class="p">)</code><code class="calibre18"> </code><code class="o">+</code><code class="calibre18"> </code><code class="s">' '</code><code class="p">;</code><code class="calibre18">
      </code><code class="nx">total</code><code class="o">++</code><code class="p">;</code><code class="calibre18">
    </code><code class="p">}</code><code class="calibre18">
  </code><code class="p">}</code><code class="calibre18">
  </code><code class="kr">return</code><code class="calibre18"> </code><code class="p">{</code><code class="calibre18"> </code><code class="nx">total</code><code class="p">,</code><code class="calibre18"> </code><code class="nx">happycoins</code><code class="calibre18"> </code><code class="p">}</code><code class="p">;</code><code class="calibre18"> </code><a class="calibre6" id="manual_co_node_js_CO7-2" href="#manual_callout_node_js_CO7-2"><img src="Images/2.png" alt="2" class="calibre32"/></a><code class="calibre18">
</code><code class="p">}</code></pre>
<dl class="calibre14">
<dt class="calibre15"><a class="calibre6" id="manual_callout_node_js_CO7-1" href="#manual_co_node_js_CO7-1"><img src="Images/1.png" alt="1" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">We’re doing our typical Happycoin-hunting loop here, but as in other parallelism examples, we’re dividing our total search space by the number of threads.</p></dd>
<dt class="calibre15"><a class="calibre6" id="manual_callout_node_js_CO7-2" href="#manual_co_node_js_CO7-2"><img src="Images/2.png" alt="2" class="calibre32"/></a></dt>
<dd class="calibre33"><p class="calibre34">We’re passing the string of found Happycoins and the total count of them back to the main thread by returning a value from this function.</p></dd>
</dl></div>

<p class="author1">To run this, you’ll have to install <code class="calibre18">piscina</code> if you haven’t done so yet for the earlier examples. You can <a data-type="indexterm" data-primary="Piscina" data-secondary="installation" id="idm45995921293272" class="calibre6"/>use the following two commands in your <em class="calibre7">ch3-happycoin</em> directory to set up a Node.js project and add the <code class="calibre18">piscina</code> dependency. The third line can then be used to run the code:</p>

<pre data-type="programlisting" class="calibre38">$ npm init -y
$ npm install piscina
$ node happycoin-piscina.js</pre>

<p class="author1">You should see output the same as earlier examples, with a slight twist. Rather than seeing each Happycoin come in one by one, you’ll see them either roughly all at once, or in four large groupings of them. This is the trade-off we made by returning the whole strings rather than the Happycoins one by one. This code should run in roughly the same time as <em class="calibre7">happycoin-threads.js</em>, since it uses the same principle, but with the abstraction layer that <code class="calibre18">piscina</code> provides us.</p>

<p class="author1">You can see that we’re not using <code class="calibre18">piscina</code> in the typical manner. We’re not passing it a multitude of discrete tasks that end up requiring careful queueing. The primary reason for this is performance.</p>

<p class="author1">If, for example, we had a loop iterating ten million times in the main thread, each time adding another task to the queue and <code class="calibre18">await</code>-ing its response, it would end up being just as slow as running all the code synchronously on the main thread. We could <em class="calibre7">not</em> await the reply and just add things to the queue as soon as we can, but it turns out the overhead of passing messages 20 million times is a lot greater than simply passing eight messages.</p>

<p class="author1">When dealing with raw data, like numbers or <a data-type="indexterm" data-primary="Piscina" data-secondary="Happycoins, producing" data-startref="PisHapp" id="idm45995921285576" class="calibre6"/><a data-type="indexterm" data-primary="Happycoin" data-secondary="Piscina" data-startref="HapPisc" id="idm45995921284328" class="calibre6"/>byte streams, there are usually faster ways of transferring data between threads using <code class="calibre18">SharedArrayBuffers</code>, and we’ll see more about those in the next chapter.</p>
</div></section>







<div data-type="footnotes" class="calibre41"><p data-type="footnote" id="idm45995923445880" class="calibre42"><sup class="calibre43"><a href="ch03.xhtml#idm45995923445880-marker" class="calibre40">1</a></sup> Yes, other nonbrowser JavaScript runtimes exist, like Deno, but Node.js has such a massive amount of popularity and market share at time of writing that it’s the only one worth talking about here. This may change by the time you’re reading this, and that’s great for the world of JavaScript! Hopefully, there’s a newer edition of this book that covers your nonbrowser JavaScript runtime of choice.</p></div></div></section></div></body></html>